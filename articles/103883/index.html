<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Replication in PostgreSQL 8.x: simplify working with Slony</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Good day. Historically, out of the Postgresql box, the 8th branch (and the bright future with the 9th in the stable has not yet arrived) do...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Replication in PostgreSQL 8.x: simplify working with Slony</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  Good day.  Historically, out of the Postgresql box, the 8th branch (and the bright future with the 9th in the stable has not yet arrived) does not have a replication system.  Therefore, for these purposes, written external tool - Slony1. <a name="habracut"></a><br><br><h4>  How it works </h4>  . <br>  It works quite simply: the slon daemon connects to the Postgresql server, clings to the triggers, and waits for any event that changes the contents of the database to occur.  There is also a slonik - a configuration utility that uses configs in STDIN and several other control utilities for various purposes. <br>  As part of replication, when it comes to Postgresql, the following terms are commonly used: <br><ul><li>  A node (node) is a server-base pair.  That is, for example, if you have several replication databases on one server, this is not one node, but several. </li><li>  Cluster (cluster) - a group of nodes.  Everything is simple, I suppose: master and slave (s). </li><li>  Tables (tables) - everything is still easier here.  :) </li><li>  Sequences (sequences) - counters for tables. </li><li>  Sets (sets) - a set of tables and counters.  For each base, a separate set is created. </li></ul><br>  After a successful configuration, Slony creates the _cluster scheme in the database to be replicated (where ‚Äúcluster‚Äù is the name of the cluster specified in the config), and there are several of its tables in it.  The appointment of the tables can be found <a href="http://www.slony.info/documentation/">off.</a>  <a href="http://www.slony.info/documentation/">documentation</a> , well, or using psql.  So if you suddenly encounter difficulties during the setup process, and after restarting, you received a message like ‚Äúthis node / cluster / table is already in the list‚Äù - perhaps the circuit drops you. <br>  Also, you need to know that only those tables that have a primary key are subject to replication. <br>  The main unpleasant feature of elephants, for me was the fact that it does not know how to make a replica of all the tables in the database - be sure to list one after another.  When you have&gt; 50 tables in your database, writing configs becomes extremely tedious.  For these purposes, I wrote a script, laid out below. <br>  The most inquisitive of you have probably seen such mana and may believe that this post is another take.  No, it is not.  All the mana I saw suggested feeding the config directly to slonik via STDIN.  With this approach, the system will work, but (at least in the case of Debian / Ubuntu) there will be two problems: <br><ol><li>  The init script will not work. </li><li>  Auxiliary utilities of elephants will not work. </li></ol><br>  The correct approach is to store the perl-ovid config in /etc/slony1/slon_tools.conf (for example, you can find in ls /usr/share/doc/slony1-bin/examples/slon_tools.conf-sample.gz) , and in / etc / default / slony1, the node numbers that live on this machine will be run by the init script.  As I said, the first config is a perl-script and is included in the slon_start script.  In general - the configuration of the hands in this post is not considered - only tells where you can find examples. <br><h4>  Training. </h4><br>  We assume that the base, as well as the configured Postgresql, you already have, it has tables with the primary key and you are ready to begin the configuration.  I will make a reservation in advance that everything was done on different versions of the server Ubuntu, in Debian there will be about the same thing, but I don‚Äôt know what will happen in other distros. <br>  So we need the postgresql-8.3-slony1 and slony1-bin packages.  It is desirable that both packages be the second branch (it is more stable). <br><br><h4>  Server setup </h4><br>  First, in postgresql.conf, you need to uncomment the line containing ‚Äúlisten_addresses‚Äù and put in place of localhost, specify the ip-address of the interface, looking in the direction of the slave.  You can also put '*' instead of the address - then the server will wait for connections through all interfaces. <br>  Next, in pg_hba.conf (also in / etc / postgresql lies) you need to add a line like <br> <code>host all all 192.168.1.0/24 md5</code> <br>  , where instead of 192.168.0.0/24, you need to specify a network or ip slave.  Then we do the same on the slave, indicating the ip master. <br>  Then restart Postgresql on the master and the slave, so that it picked up the new settings. <br>  We will also need to create pg superuser on both machines: <br> <code>createuser -sP slony</code> <br> <br><h4>  Script </h4><br>  In order not to increase the size of the post several times, the script is <a href="http://pastebin.com/7rX3dPYe">here</a> .  I will say in advance that I do not claim a prize for the beauty of the code - on the contrary, it was written on my knee in my free time.  The important thing is that it works.  Now I will talk about what he does. <br>  For normal operation, you will need to run it as root `a or via sudo (because there, su is used by the postgres user, as well as being written to / etc and the init scripts are executed) is also desirable (for the last two stages) ), so that the slave would let root  ªa via ssh (better with the key, since it will quickly get tired of entering the password).  The libdbd-pg-perl package is also required. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The current version does not eat parameters from the command line (although it should), so after launching you enter into a dialogue with the script.  So, the algorithm works step by step: <br><br><h5>  1. Poll user for cluster name and details to the master / slave. </h5><br>  If you make a mistake - it doesn't matter, in case of problems with connecting to the database, the script will offer to enter data again.  The name of the cluster is arbitrary. <br><h5>  2. Dialogue of the choice of bases. </h5><br>  Everything is simple.  The script polls the server for available databases and offers to select those that need to be replicated.  To select (or deselect) a database, enter its number.  You can select everything with an asterisk.  At the end you need to press Enter. <br><h5>  3. Adding tables / sequences. </h5><br>  Having a list of selected databases, the script collects a list of tables from them.  <i>All tables and sequences in selected databases are added to the list.</i> <br><h5>  4. Transferring the base structure from master to slave </h5><br>  The createdb, createlang deleted is executed sequentially.  Next, the local pg_dump -s after which the structure is transmitted via ssh to the slave. <br><h5>  5. Immediate generation of the config and its forwarding. </h5><br>  All the necessary data is there, now the config is generated and, if you are root, put in / etc / slony1 (including the slave), edit / etc / default / slony1 (indicating which nodes should be started). <br><h5>  6. Run the daemon </h5><br>  Well, that's all.  It remains to run.  :) <br><br>  PS <br>  I hope it will be useful to someone if you have questions or suddenly something works wrong - well in the comments. </div><p>Source: <a href="https://habr.com/ru/post/103883/">https://habr.com/ru/post/103883/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../103870/index.html">Microsoft got control over a large botnet</a></li>
<li><a href="../103871/index.html">The first photos and characteristics of Acer Liquid Metal</a></li>
<li><a href="../103877/index.html">Viktor Pleschuk, involved in the hacking of the payment system RBS WorldPay, sentenced conditionally</a></li>
<li><a href="../103881/index.html">Reader Amazon Kindle 3 - a review from the point of view of the Russian user</a></li>
<li><a href="../103882/index.html">lists in Q & A comments</a></li>
<li><a href="../103884/index.html">Peace botnet</a></li>
<li><a href="../103885/index.html">Five best ways to fill up an IT startup. Bad advice</a></li>
<li><a href="../103886/index.html">Recommendations for content management on Twitter and Facebook</a></li>
<li><a href="../103890/index.html">Clouds are becoming more accessible.</a></li>
<li><a href="../103891/index.html">Dinosaurs vs. Cockroaches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>