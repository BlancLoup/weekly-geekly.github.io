<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recursive zip archive</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many habra users are probably familiar with quinees - programs that display their own source code. Today I want to show how to make an interesting ver...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recursive zip archive</h1><div class="post__text post__text-html js-mediator-article">  Many habra users are probably familiar with <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D1%2583%25D0%25B0%25D0%25B9%25D0%25BD_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">quinees</a> - programs that <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D1%2583%25D0%25B0%25D0%25B9%25D0%25BD_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">display</a> their own source code.  Today I want to show how to make an interesting version of Quine - ZIP-archive, which is unpacked <a href="">into itself</a> . <br><br><a name="habracut"></a><br><br><h2>  Lempel-Ziv algorithm </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The algorithm used in ZIP files ( <a href="http://en.wikipedia.org/wiki/Lempel%25E2%2580%2593Ziv">Lempel-Ziv</a> ) is actually quite simple.  There are two types of instructions in it: <code>literal(n)</code> , followed by a stream of data that should be output as is, and <code>repeat(d, n)</code> , which returns back to <code>d</code> bytes and outputs <code>n</code> bytes from this position. <br><br>  Accordingly, our task is as follows: using this algorithm to write a program that displays its code at startup.  In other words, write a compressed data stream that unfolds into itself.  Maximum program: write a stream that unfolds into itself with arbitrary data at the beginning and end (so that it can be used as a real zip or gzip file, with a header and other necessary data). <br><br>  Let's agree to use <code>Ln</code> and <code>Rn</code> as abbreviations for <code>literal(n)</code> and <code>repeat(n, n)</code> , and the program assumes that each code is one byte.  L0, respectively, is an analogue of NOP in Lempel-Ziv, <code>L5 hello</code> will output <code>hello</code> ;  the same will output <code>L3 hel R1 L1 o</code> . <br><br>  A simple quine will look like this: <br><br><table><tbody><tr><th></th><th width="30"></th><th>  Code </th><th width="30"></th><th>  Conclusion </th></tr><tr><td align="right">  <i>no-op</i> </td><td></td><td> <code>L0</code> </td> <td></td><td></td></tr><tr><td align="right">  <i>no-op</i> </td><td></td><td> <code>L0</code> </td> <td></td><td></td></tr><tr><td align="right">  <i>no-op</i> </td><td></td><td> <code>L0</code> </td> <td></td><td></td></tr><tr><td align="right">  <i>print 4 bytes</i> </td><td></td><td> <code>L4 L0 L0 L0 L4</code> </td> <td></td><td> <code>L0 L0 L0 L4</code> </td> </tr><tr><td align="right">  <i>repeat 4 last bytes</i> </td><td></td><td> <code>R4</code> </td> <td></td><td> <code>L0 L0 L0 L4</code> </td> </tr><tr><td align="right">  <i>print 4 bytes</i> </td><td></td><td> <code>L4 R4 L4 R4 L4</code> </td> <td></td><td> <code>R4 L4 R4 L4</code> </td> </tr><tr><td align="right">  <i>repeat 4 last bytes</i> </td><td></td><td> <code>R4</code> </td> <td></td><td> <code>R4 L4 R4 L4</code> </td> </tr><tr><td align="right">  <i>print 4 bytes</i> </td><td></td><td> <code>L4 L0 L0 L0 L0</code> </td> <td></td><td> <code>L0 L0 L0 L0</code> </td> </tr></tbody></table><br><br>  (It can be seen that the contents of the ‚ÄúCode‚Äù and ‚ÄúOutput‚Äù columns are the same) <br><br>  The interesting part of the program is a sequence of 6 bytes <code>L4 R4 L4 R4 L4 R4</code> , which outputs 8 bytes: <code>R4 L4 R4 L4 R4 L4 R4</code> .  That is, it outputs itself with one byte before and one after. <br><br>  If we write quine on Python, usually the problem is that the <code>print</code> statement is always longer than what it prints.  We solve this problem with recursion, substituting a line for printing into itself.  Here we can use a different approach.  The program on Lempel-Ziv is partially repeated, so that the repeated substring contains the entire original fragment.  The recursion is here in the very presentation of the program, and not in execution.  In any case, this fragment is crucial.  Before the final R4, the output of the program is behind the input.  After execution, output by one byte is ahead of input. <br><br>  <code>L0</code> dummy operators can also be used in a more general version of the program, which can complement itself with an arbitrary three-byte prefix and suffix: <br><br><table><tbody><tr><th></th><th width="30"></th><th>  Code </th><th width="30"></th><th>  Conclusion </th></tr><tr><td align="right">  <i>print 4 bytes</i> </td><td></td><td> <code>L4 <i>aa bb cc</i> L4</code> </td> <td></td><td> <code><i>aa bb cc</i> L4</code> </td> </tr><tr><td align="right">  <i>repeat 4 last bytes</i> </td><td></td><td> <code>R4</code> </td> <td></td><td> <code><i>aa bb cc</i> L4</code> </td> </tr><tr><td align="right">  <i>print 4 bytes</i> </td><td></td><td> <code>L4 R4 L4 R4 L4</code> </td> <td></td><td> <code>R4 L4 R4 L4</code> </td> </tr><tr><td align="right">  <i>repeat 4 last bytes</i> </td><td></td><td> <code>R4</code> </td> <td></td><td> <code>R4 L4 R4 L4</code> </td> </tr><tr><td align="right">  <i>print 4 bytes</i> </td><td></td><td> <code>L4 R4 <i>xx yy zz</i></code> </td> <td></td><td> <code>R4 <i>xx yy zz</i></code> </td> </tr><tr><td align="right">  <i>repeat 4 last bytes</i> </td><td></td><td> <code>R4</code> </td> <td></td><td> <code>R4 <i>xx yy zz</i></code> </td> </tr></tbody></table><br><br>  (The output is the code plus <code>aa bb cc</code> added to the beginning and <code>xx yy zz</code> added to the end) <br><br>  I had to spend most of Sunday to get to this point, but when I did it, I already knew that I had won.  From my experiments, I found out that it is quite easy to create a program that outputs itself without several instructions, or even one that displays itself with a prefix, minus several instructions.  The extra bytes <code>aa bb cc</code> in the output allow you to add the necessary fragment to the program.  It's also easy to write code that outputs itself, plus an extra three bytes <code>xx yy zz</code> .  These two techniques can be used to add a header and additional data to the archive at the end. <br><br>  This is how a program with arbitrary prefix and suffix looks like: <br><br><table><tbody><tr><th></th><th width="30"></th><th>  Code </th><th width="30"></th><th>  Conclusion </th></tr><tr><td align="right">  <i>print the prefix</i> </td><td></td><td> <code>[P]</code> </td> <td></td><td> <code>P</code> </td> </tr><tr><td align="right">  <i>output</i> p <i>+1 bytes</i> </td><td></td><td>  <code>L</code> <i>p</i> +1 <code>[P] L</code> <i>p</i> +1 </td><td></td><td>  <code>[P] L</code> <i>p</i> +1 </td></tr><tr><td align="right">  <i>repeat last</i> p <i>+1 bytes</i> </td><td></td><td>  <code>R</code> <i>p</i> +1 </td><td></td><td>  <code>[P] L</code> <i>p</i> +1 </td></tr><tr><td align="right">  <i>output 1 byte</i> </td><td></td><td>  <code>L1 R</code> <i>p</i> +1 </td><td></td><td>  <code>R</code> <i>p</i> +1 </td></tr><tr><td align="right">  <i>output 1 byte</i> </td><td></td><td> <code>L1 L1</code> </td> <td></td><td> <code>L1</code> </td> </tr><tr><td align="right">  <i>output 4 bytes</i> </td><td></td><td>  <code>L4 R</code> <i>p</i> +1 <code>L1 L1 L4</code> </td><td></td><td>  <code>R</code> <i>p</i> +1 <code>L1 L1 L4</code> </td></tr><tr><td align="right">  <i>repeat 4 last bytes</i> </td><td></td><td> <code>R4</code> </td> <td></td><td>  <code>R</code> <i>p</i> +1 <code>L1 L1 L4</code> </td></tr><tr><td align="right">  <i>output 4 bytes</i> </td><td></td><td> <code>L4 R4 L4 R4 L4</code> </td> <td></td><td> <code>R4 L4 R4 L4</code> </td> </tr><tr><td align="right">  <i>repeat 4 last bytes</i> </td><td></td><td> <code>R4</code> </td> <td></td><td> <code>R4 L4 R4 L4</code> </td> </tr><tr><td align="right">  <i>output 4 bytes</i> </td><td></td><td>  <code>L4 R4 L0 L0 L</code> <i>s</i> +1 </td><td></td><td>  <code>R4 L0 L0 L</code> <i>s</i> +1 </td></tr><tr><td align="right">  <i>repeat 4 last bytes</i> </td><td></td><td> <code>R4</code> </td> <td></td><td>  <code>R4 L0 L0 L</code> <i>s</i> +1 </td></tr><tr><td align="right">  <i>no-op</i> </td><td></td><td> <code>L0</code> </td> <td></td><td></td></tr><tr><td align="right">  <i>no-op</i> </td><td></td><td> <code>L0</code> </td> <td></td><td></td></tr><tr><td align="right">  <i>output</i> s <i>+1 bytes</i> </td><td></td><td>  <code>L</code> <i>s</i> +1 <code>R</code> <i>s</i> +1 <code>[S]</code> </td><td></td><td>  <code>R</code> <i>s</i> +1 <code>[S]</code> </td></tr><tr><td align="right">  <i>repeat last</i> s <i>+1 bytes</i> </td><td></td><td>  <code>R</code> <i>s</i> +1 </td><td></td><td>  <code>R</code> <i>s</i> +1 <code>[S]</code> </td></tr><tr><td align="right">  <i>print suffix</i> </td><td></td><td> <code>[S]</code> </td> <td></td><td> <code>S</code> </td> </tr></tbody></table><br><br>  (The output is P, then the bytes from the ‚ÄúCode‚Äù column, then S.) <br><br><h2>  Unzip zip file </h2><br><br>  Now go to the real action.  We solved the main technological problem of creating a recursive zip file, but there are still a few details left. <br><br>  The first problem: to translate our quine, recorded in the simplified opcodes, into real Lempel-Ziv opcodes.  <a href="http://www.faqs.org/rfcs/rfc1951.html">RFC 1951</a> defines the DEFLATE format used in gzip and zip;  a sequence of blocks, each of which contains a sequence of opcodes encoded by Huffman coding.  Huffman coding assigns strings of different lengths to different opcodes, which does not coincide with our assumption that opcodes have the same length.  But wait!  We can, if we try, find a fixed length coding that can be used. <br><br>  There are literal blocks and opcode blocks in DEFLATE.  The header of the literal block is 5 bytes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c3/2d6/4c4/5c32d64c402ab48ebacf566fdf4aaad8.png"><br><br>  If our opcodes L occupy 5 bytes each, opcodes R must also occupy 5 bytes, and each byte above will be repeated five times (for example, the argument for L4 now takes 20 bytes and R4 repeats the last 20 bytes of output).  The block of opcodes with one <code>repeat(20,20)</code> takes a little less than 5 bytes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/192/079/166/192079166f996df494ee32d7902ba078.png"><br><br>  Fortunately, the opcode block containing two instructions <code>repeat(20,10)</code> does the same and takes exactly 5 bytes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/04e/6b7/399/04e6b7399a8b52a7bf67a2f22c300b08.png"><br><br>  Coding a <code>repeat</code> with a different argument length requires a few more complex tricks, but it seems that we can develop 5-byte codes that repeat a string between 9 and 64 bytes in length.  For example, here are blocks repeating 10 and 40 bytes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/44d/ef7/e12/44def7e125199352d8c7f850e9429bad.png" title="Repeat 10 bytes"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b8d/d04/5fb/b8dd045fbdbeef28810b2877a155980b.png" title="Repeat 40 bytes"><br><br>  A block that repeats the last 10 bytes is 2 bits less than needed, but each block of repetition is followed by a block of literals that starts with three zero bits and is added to the border of the nearest byte.  If the repeat block ends 2 bits before the boundary and a literal block follows, the fill-in will insert the missing two bits.  In the same way, a block repeating 40 bytes goes out over the border by 5 bits, but these bits are zero.  Starting block 5 bits later, we subtract these bits from the dobivka.  Both of these tricks work because the last 7 bits of any repeat block are zero, and the bits in the first byte of the block of literals are also zero, so the border is not visible.  If the literal block began with one bit, this cunning device would not have worked. <br><br>  The second obstacle is that the zip archives (and gzip too) store the checksum of uncompressed data.  Since uncompressed data is the same zip archive, the checksum is also involved in the calculation.  So, we need to find such a value of <code>x</code> , at which the checksum becomes equal to <code>x</code> .  Recursion strikes back. <br><br>  The CRC32 command interprets the entire file as one large number and calculates the remainder when this number is divided by a specific constant using a special division method.  We could write the corresponding equations and solve them for <code>x</code> , but I‚Äôll have enough recursive riddles for today.  For <code>x</code> there are only a little more than 4 billion acceptable values, and we can easily find the necessary brute force. <br><br>  If you want to repeat all this on your own, a couple of simple problems await you, for example, make the length of the tar file share without a balance by 512 and compress the zip header to 59 bytes so that <code>Rs+1</code> no more than <code>R64</code> .  But this is just a programming issue. <br><br>  So, I got the files <a href="">r.gz</a> (gzip-archive), <a href="">r.tar.gz</a> (tar-file, compressed gzip), and <a href="">r.zip</a> (zip-archive).  It is a pity, but I could not find a program that would recursively unpack these files to infinity.  It would be fun to watch, but it looks like much less complicated <a href="http://en.wikipedia.org/wiki/Zip_bomb">zip-bombs</a> have already spoiled us all the fun. <br><br>  If you feel fit, here is <a href="">rgzip.go</a> , a <a href="http://golang.org/">Go</a> program that generates these files.  I wonder if you can create a zip file containing a gzip file containing the original zip file in turn).  Ken Thompson suggested trying to create a zip-archive, unpacking his copy but slightly larger in size, so that when recursively unzipping the archive size grew indefinitely (if you succeed in one or the other, please leave a comment). </div><p>Source: <a href="https://habr.com/ru/post/119676/">https://habr.com/ru/post/119676/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119669/index.html">About the advance payment system and the minus on the personal account</a></li>
<li><a href="../119672/index.html">Expired Domains - Google Apps Security Hole</a></li>
<li><a href="../119673/index.html">Authorization is now required for search.</a></li>
<li><a href="../119674/index.html">Road test</a></li>
<li><a href="../119675/index.html">Creating applications for BlackBerry smartphones using WebWorks SDK</a></li>
<li><a href="../119677/index.html">Conference system administrators "Steel Tambourine 3" (trailer)</a></li>
<li><a href="../119679/index.html">VS + ReSharper promotion</a></li>
<li><a href="../119680/index.html">Saving time and energy - HDD AC230 with USB 3.0 interface</a></li>
<li><a href="../119681/index.html">IC 555</a></li>
<li><a href="../119682/index.html">Mobile development: Which platform to choose a novice developer from the countries of the former USSR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>