<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Does your site also allow you to upload everything?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One French ‚Äúsecurity researcher‚Äù this summer published unprecedentedly many vulnerabilities found by him such as arbitrary file upload in various ‚Äúwri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Does your site also allow you to upload everything?</h1><div class="post__text post__text-html js-mediator-article">  One French ‚Äúsecurity researcher‚Äù this summer published unprecedentedly many vulnerabilities found by him such as arbitrary file upload in various ‚Äúwritten on the knees‚Äù, but popular CMS and plugins for them.  It's amazing how careless are the creators and administrators of small forums, blogs and online stores.  As a rule, in the directory where avatars are loaded, resumes, emoticons and other resources that the user can upload to the site - PHP code execution is allowed;  therefore, downloading a PHP script in the guise of a picture will allow an attacker to execute arbitrary code on the server. <br><br>  Execution of code with apache rights is, of course, not full control over the server, but do not underestimate the possibilities opened up for an attacker: he gets full access to all the scripts and configuration files of the site and, through them, to the databases used;  he can send spam on your behalf, harass any illegal content from you, thereby substituting abuses;  may, having found the parameters of binding to the payment system, otrefandit all orders and leave you without income for the entire last month.  It's a shame, right? <br><br><a name="habracut"></a>  How can he do it? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  You do not check the downloadable files at all? </h4><br>  Clinical case: you copied a line from the PHP manual <br> <code>move_uploaded_file($_FILES["file"]["tmp_name"], "upload/" . $_FILES["file"]["name"]);</code> <br>  and so it was left in the production code. <br><br>  So I can upload any files at all, and not only in the upload directory, but anywhere I can specify as the file name ../index.html and replace your main page with my own.  It's a shame, right? <br><br>  Add at least a <b>basename ()</b> call for <code>$_FILES["file"]["name"]</code> .  In the latest version of PHP, judging by my experiments, <code>$_FILES["file"]["name"]</code> and so returns only the basename of the filename given in the HTTP request;  but caution here will not be superfluous. <br><br><h4>  Are you checking if the file is a picture? </h4><br>  Before saving the uploaded file to upload /, you call <b>getimagesize ()</b> to make sure that the image is uploaded.  Much to the delight of "security researchers", PHP allows you to insert executable code anywhere in any file, ignoring everything that is not enclosed in &lt;?  ?&gt;.  I can take a photo of my favorite cat, add something like <code>&lt;?php passthru($_GET['c']); ?&gt;</code> to its end <code>&lt;?php passthru($_GET['c']); ?&gt;</code>  <code>&lt;?php passthru($_GET['c']); ?&gt;</code> and fill in as pwn.php.  Then <b>getimagesize () will</b> confirm that the JPEG file is in the file, because it analyzes only the headers;  and my "photo with postscript" will be checked. <br><br><h4>  Are you checking mime-type? </h4><br>  Why you can't trust the ‚Äúmime‚Äù field returned by <b>getimagesize ()</b> is understandable: it is taken based on the file header.  Moreover, you cannot trust <code>$_FILES["file"]["type"]</code> - nothing prevents me from transmitting in the HTTP Content-Type: image / jpeg request before the PHP script.  It seems commonplace, but <a href="http://cd34.com/blog/web-security/when-mimetype-validation-isnt-enough/">people really rely on it</a> .  So I just saw the <code>if(substr($_FILES["file"]["type"], 0, 6)=="image/") {/*   */}</code> check <code>if(substr($_FILES["file"]["type"], 0, 6)=="image/") {/*   */}</code> in one self-confident project.  They, it seems, consider it elegant and ingenious that they could cover all possible types of pictures with one test!  But do not borrow from them this "best practice". <br><br><h4>  Do you check the extension? </h4><br>  In another confident project, I just saw a check. <br> <code>if(substr($_FILES["file"]["name"], -3)=="jpg" || substr($_FILES["file"]["name"], -3)=="gif" || substr($_FILES["file"]["name"], -3)=="png") {/*   */}</code> <br>  <a href="httpd.apache.org/docs/2.2/mod/mod_mime.html">The Apache feature</a> is that when it encounters files with unfamiliar extensions, it ‚Äúbites off‚Äù these extensions and searches for familiar extensions in front of them.  Therefore, if I fill in the pwn.php.omgif file, it will be checked, but Apache will see a PHP script in it, because neither mime-type nor a handler module is registered for the omgif extension. <br><br><h4>  Are you checking for bad extensions? </h4><br>  In the third self-confident project, I saw a check <code>if(strpos($_FILES["file"]["name"], ".php")===FALSE) {/*   */}</code> - they say that if somewhere met the extension. php, then the file is no good.  But do not forget that by default the PHP interpreter is also called for extensions .phtml and .php3, and <a href="http://www.sitepoint.com/forums/showthread.php%3F625287-How-are-gif-files-being-executed-as-PHP">some hosters include it for other extensions</a> - sometimes even for .html, .js, .jpg, and so on, to embed in static resources any SEO code, or track hit statistics.  (Can you check for yourself how many Google finds the questions ‚Äúhow do I get the PHP code to run in JPEG files?‚Äù) Also, if an attacker manages to <a href="http://www.justanotherhacker.com/2011/05/htaccess-based-attacks.html">upload his .htaccess</a> file, he can execute the PHP code in files with any extensions - even in this .htaccess file itself.  In general, beware. <br><br><h4>  Are you testing the extension correctly? </h4><br>  Suppose you make sure that the file name ends in .jpg (along with a dot!) Can you be sure that the PHP code will not run in it?  Considering the previous point - most likely it is possible, but there is no guarantee.  It may happen that the attacker (or Krivoruk administrator) somehow damaged /etc/mime.types, so that the .jpg extension will be unregistered, and Apache will analyze the extension in front of it.  It may happen that /etc/mime.types <a href="http://www.webhostingtalk.com/showthread.php%3Ft%3D588997">became unavailable due to chroot</a> .  It may happen that an attacker (or Krivoruk administrator) has thrown into the upload / directory. Htaccess, which allows you to run PHP-code in all files in a row. <br><br>  In addition, until recent versions of PHP, it was possible to download a file called ‚Äúpwn.php \ 0.jpg‚Äù, which, if saved to disk, would turn into ‚Äúpwn.php‚Äù, because for system calls the string with the file name ends with \ 0 , and for PHP functions, this is the usual valid character in a string.  In this case, checking the extension would also not guarantee anything. <br><br><h4>  And what to do? </h4><br>  An exhaustive checklist was attempted <a href="http://stackoverflow.com/questions/4166762/php-image-upload-security-check-list">on stackoverflow</a> .  In short: a) explicitly prohibit the execution of PHP in the directory where user files are saved;  b) rename user files to user names that are not controlled by users;  c) if possible, resave images with GD to remove unnecessary metadata and unsolicited postscripts at the end of the file. </div><p>Source: <a href="https://habr.com/ru/post/148999/">https://habr.com/ru/post/148999/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148989/index.html">The first open source powder 3D printer</a></li>
<li><a href="../148990/index.html">What happens with Oracle?</a></li>
<li><a href="../148991/index.html">"Hola, apple gadgets!"</a></li>
<li><a href="../148993/index.html">In court for "Like"</a></li>
<li><a href="../148996/index.html">Creating a plugin for Intellij Platform (IntelliJ IDEA, RubyMine, WebStorm, PhpStorm, PyCharm and AppCode)</a></li>
<li><a href="../149001/index.html">Selective logging of SQL queries in Hibernate</a></li>
<li><a href="../149004/index.html">Hot summer build Opera 12.50</a></li>
<li><a href="../149006/index.html">We do it yourself Single-Side Arduino with a COM port on board</a></li>
<li><a href="../149007/index.html">Destructive printers for the healthcare modernization program</a></li>
<li><a href="../149010/index.html">Masking numeric values ‚Äã‚Äãusing autoNumeric and Knockout</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>