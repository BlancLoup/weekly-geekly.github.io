<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Encrypt and re-encrypt LUKS without data loss</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction  If you have ever thought about encrypting data on disks already after you had accumulated a decent amount of them, you were probably ups...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Encrypt and re-encrypt LUKS without data loss</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3>  If you have ever thought about encrypting data on disks already after you had accumulated a decent amount of them, you were probably upset by reading about the need to transfer data before creating an encrypted partition and after.  Transferring 500 GB back and forth does not present any particular difficulty, such a volume can be temporarily downloaded even into the cloud, but if we are talking about encrypting 6 hard drives of 4 TB each, the task becomes much more complicated.  For some reason, the ability to encrypt and re-encrypt LUKS volumes without data loss (in-place re-encryption) is poorly lit on the Internet, although there are two utilities for this: <b>cryptsetup-reencrypt</b> , part of <b>cryptsetup</b> since 2012, and third-party <a href="http://www.johannes-bauer.com/linux/luksipc/"><b>luksipc</b></a> which appeared a year earlier.  In fact, both utilities do the same thing ‚Äî they encrypt a partition if it has not been encrypted, or re-encrypt an existing one with other parameters.  For my needs I used the first official one. <br><br><h3>  How it works? </h3>  Suppose you have a typical disk layout: one partition, starts with 1 MiB (alignment for 4KiB sectors), ends at the end of the disk. <br><img src="https://habrastorage.org/getpro/habr/post_images/1ca/871/2c0/1ca8712c0b653dc4095a2c8337b35539.png" alt="image"><br><br>  The LUKS header is located at the beginning, in front of the encrypted data.  A header requires a minimum of 2056 512-byte sectors, i.e.  slightly more than 1Mb.  The space before the beginning of the partition is obviously not enough for us, so first you need to reduce the size of the file system from its end, so that <b>cryptsetup-reencrypt</b> transfers blocks to the right to the end of the disk, thus freeing up space at the beginning of the partition for the LUKS header.  The final size of the header depends on the key length, the number of slots for passphrases and other parameters, so I recommend being careful and take 4 MiB under the heading. <br><img src="https://habrastorage.org/getpro/habr/post_images/6ff/27b/df7/6ff27bdf7cabfd97d0275b88ad75fc29.png" alt="image"><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Encrypt! </h3>  First, reduce the size of the file system.  In the case of ext4, this is done as follows: <br><pre><code class="hljs pgsql"># e2fsck -f /dev/sdc1 e2fsck <span class="hljs-number"><span class="hljs-number">1.42</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> (<span class="hljs-number"><span class="hljs-number">29</span></span>-Aug<span class="hljs-number"><span class="hljs-number">-2014</span></span>) Pass <span class="hljs-number"><span class="hljs-number">1</span></span>: Checking inodes, blocks, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sizes Pass <span class="hljs-number"><span class="hljs-number">2</span></span>: Checking directory structure Pass <span class="hljs-number"><span class="hljs-number">3</span></span>: Checking directory connectivity Pass <span class="hljs-number"><span class="hljs-number">4</span></span>: Checking reference counts Pass <span class="hljs-number"><span class="hljs-number">5</span></span>: Checking <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">summary</span></span> information SAMS15TB: <span class="hljs-number"><span class="hljs-number">17086</span></span>/<span class="hljs-number"><span class="hljs-number">536592</span></span> files (<span class="hljs-number"><span class="hljs-number">0.4</span></span>% non-contiguous), <span class="hljs-number"><span class="hljs-number">341465037</span></span>/<span class="hljs-number"><span class="hljs-number">366284385</span></span> blocks # dumpe2fs /dev/sdc1|grep <span class="hljs-string"><span class="hljs-string">'Block count'</span></span> dumpe2fs <span class="hljs-number"><span class="hljs-number">1.42</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> (<span class="hljs-number"><span class="hljs-number">29</span></span>-Aug<span class="hljs-number"><span class="hljs-number">-2014</span></span>) Block count: <span class="hljs-number"><span class="hljs-number">366284385</span></span> # resize2fs /dev/sdc1 <span class="hljs-number"><span class="hljs-number">366283361</span></span> resize2fs <span class="hljs-number"><span class="hljs-number">1.42</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> (<span class="hljs-number"><span class="hljs-number">29</span></span>-Aug<span class="hljs-number"><span class="hljs-number">-2014</span></span>) Resizing the filesystem <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> /dev/sdc1 <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">366283361</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>k) blocks. The filesystem <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> /dev/sdc1 <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> now <span class="hljs-number"><span class="hljs-number">366283361</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>k) blocks long.</code> </pre> <br>  where 366283361 = 366284385-1024 (blocks of 4k), i.e.  decrease by 4 MiB <br>  It should be noted that this will not reduce the size of the partition itself, and it does not need to be reduced! <br><br>  It makes sense to run the <b>cryptsetup benchmark</b> .  Most likely, AES will be the fastest on your computer, since  modern processors accelerate it in hardware.  On my computer, serpent turned out to be the fastest algorithm. <br><br>  Getting to the encryption process itself.  <b>Attention!</b>  According to the developers, <b>cryptsetup-reencrypt</b> is an experimental software, and can kill your data, so better backup. <br><pre> <code class="hljs kotlin"># cryptsetup-reencrypt -c serpent-xts-plain64 -s <span class="hljs-number"><span class="hljs-number">256</span></span> -N --reduce-device-size <span class="hljs-number"><span class="hljs-number">4</span></span>M /dev/sdc1 WARNING: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> experimental code, it can completely <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> your <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>. Enter new passphrase: Progress: <span class="hljs-number"><span class="hljs-number">0.0</span></span>%, ETA <span class="hljs-number"><span class="hljs-number">1107</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">168</span></span> MiB written, speed <span class="hljs-number"><span class="hljs-number">21.5</span></span> MiB/s ‚Ä¶</code> </pre> <br>  The <code>-N</code> tells you to create a LUKS partition, and the <code>--reduce-device-size</code> indicates an empty space after the file system. <br><br>  The encryption process is not fast, you have to wait, it took me about 3 days for everything about everything.  Make sure you start <b>cryptsetup-reencrypt</b> from the directory to which you have write access, so you can stop the encryption process via CTRL + C and continue it after if something went wrong. <br><br>  After the encryption is completed, we connect the disk to the device mapper and mount it: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># cryptsetup luksOpen /dev/sdc1 crypt # mount /dev/mapper/crypt /media/hdd</span></span></code> </pre> <br><br>  That's all.  We received an encrypted disk that did not require data transfer. </div><p>Source: <a href="https://habr.com/ru/post/169983/">https://habr.com/ru/post/169983/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../169969/index.html">Facebook as an important tool for promoting mobile applications</a></li>
<li><a href="../169975/index.html">Dell's All-Russian IT Solutions Forum: registration is open!</a></li>
<li><a href="../169977/index.html">I invented Erlang because it did not exist.</a></li>
<li><a href="../169979/index.html">Sony Xperia Tablet Z</a></li>
<li><a href="../169981/index.html">Kolobok on a visit at Windows 8: development diaries (part 1)</a></li>
<li><a href="../169985/index.html">How to kill Lenovo G580 with one blow</a></li>
<li><a href="../169987/index.html">Managing traffic in the network hosting provider</a></li>
<li><a href="../169989/index.html">Firefox 19 release</a></li>
<li><a href="../169991/index.html">Step over the bench</a></li>
<li><a href="../169993/index.html">Inevitability of nodocalypse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>