<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>User Authentication for Arduino with RFID</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In the previous article, I was just starting to work with the Arduino, as a result of which the weather station naturally turned out. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>User Authentication for Arduino with RFID</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/intersystems/blog/279893/"><img height="200" alt="Arduino" title="Arduino" src="https://habrastorage.org/files/8f7/b06/a6e/8f7b06a6e43640d99569c80c3e0496fb.jpg" align="left"></a> <h2>  Introduction </h2><br>  In the <a href="https://habrahabr.ru/company/intersystems/blog/273749/">previous article,</a> I was just starting to work with the Arduino, as a result of which the weather station naturally turned out.  In this article let's go further - we will do authentication using RFID cards and Arduino in the InterSystems Cach√© application. <br><a name="habracut"></a><br><h2>  Authentication transfer </h2><br>  Cach√© has a mechanism for <a href="">delegating authentication</a> ‚Äî passing the authentication process to a custom code.  To enable it, do the following: <br><br><ol><li>  Write the user authentication code in the ZAUTHENTICATE routine.  It has 4 entry points: getting a login / password, checking them and assigning rights, changing the password, creating a token.  More on this below. <br><br></li><li>  Enable authentication to Cach√© (SMP ‚Üí System Administration ‚Üí Security ‚Üí System Security ‚Üí Authentication / CSP Session Options, set the Allow Delegated authentication flag and save the settings). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li><li>  Enable authentication for required services (SMP ‚Üí Menu ‚Üí Manage Services ‚Üí Service ‚Üí Allowed Authentication Methods ‚Üí select Delegated ‚Üí Save) and / or applications (SMP ‚Üí Menu ‚Üí Manage Web Applications ‚Üí Application ‚Üí Allowed Authentication Methods ‚Üí select Delegated ‚Üí Save). </li></ol><br><h2>  How it works </h2><br>  Here is what happens when a user is authenticated in a service or web application for which authentication transfer is enabled: <br><br><ol><li>  Called the routine ZAUTHENTICATE.  The code for this routine is written by the user and can be any Cach√© ObjectScript code, including <a href="">$ ZF</a> calls. <br><br></li><li>  The next step depends on whether the ZAUTHENTICATE call was successful: <br><br><ul><li>  If the call to ZAUTHENTICATE is successful and this is the first time this user is authenticated with ZAUTHENTICATE, then a user record of the type ‚ÄúDelegated user‚Äù is created for him.  If ZAUTHENTICATE assigns rights or other properties to the user, they become the corresponding user properties. <br><br></li><li>  If the call to ZAUTHENTICATE is successful and it is not the first time this user is authenticated with ZAUTHENTICATE, then his user record is updated. <br><br></li><li>  If the call to ZAUTHENTICATE is not successful, the user is given an access error. <br><br></li></ul></li><li>  If two-factor authentication is enabled for the instance and service, the user and operator phone numbers are searched.  If they are set, two-factor authentication occurs; if not, the user is not authenticated. <br><br></li><li>  The delegated user is displayed in the user table. </li></ol><br><h2>  Where are the users from? </h2><br>  There are two authentication methods depending on which authentication methods are enabled for the application / service: <br><br><ul><li>  Delegated - the name / password is taken from GetCredentials, verified by means of ZAUTHENTICATE (user type - delegated). <br><br></li><li>  Delegated and Password - the name / password is taken from GetCredentials, checked by standard Cach√© mechanisms (user type is Cach√©). </li></ul><br>  We now turn to the consideration of the ZAUTHENTICATE routine and its entry points. <br><br><h2>  ZAUTHENTICATE </h2><br>  This main routine contains 4 entry points. <br><br><h4>  ‚ñçGetCredentials </h4><br>  This entry point is called when authentication transfer is enabled for the service, and it is called instead of requesting a username / password from the user.  The code of this routine sets the login and password (in any way).  Subsequently (outside of this routine), the received login and password are authenticated, as if the user entered them as usual.  The method of obtaining a login and password can be any - input from the keyboard, API, reading external device - in this article we will use authentication using an RFID card. <br><br>  This entry point returns the status, and if this is an error, it will be recorded in the audit, and the authentication attempt will be rejected.  The exception is the error $ SYSTEM.Status.Error ($$$ GetCredentialsFailed), in which case the user will be prompted to enter a login / password using the standard Cach√© method.  The signature is as follows: <br><br><pre><code class="hljs pgsql">GetCredentials(ServiceName, Namespace, Username, <span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>, Credentials) <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> { }</code> </pre> <br>  Where: <br><br><ul><li>  ServiceName - the name of the service through which the connection goes </li><li>  Namespace - area if specified during connection </li><li>  Username - username </li><li>  Password - password </li><li>  Credentials - currently not used </li></ul><br>  I will note an important feature of this entry point.  If the service / application includes both authentication and password authentication (Password Authentication), the login and password obtained through GetCredentials will be used for standard password authentication. <br><br><h4>  ‚ñçZAUTHENTICATE </h4><br>  In case the initial authentication succeeds, ZAUTHENTICATE sets the roles and other properties of the user.  In case this is not the first authentication, the properties can be changed.  To do this, the properties of the Properties array are set in the routine code.  Signature: <br><br><pre> <code class="hljs pgsql">ZAUTHENTICATE(ServiceName, Namespace, Username, <span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>, Credentials, Properties) <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> { }</code> </pre><br>  Properties array: <br><br><ul><li>  Properties ("Comment") - comment </li><li>  Properties ("FullName") - first and last name </li><li>  Properties ("NameSpace") - starting area </li><li>  Properties ("Roles") - comma-separated list of roles </li><li>  Properties ("Routine") - starting routine </li><li>  Properties ("Password") - password </li><li>  Properties ("Username") - username </li><li>  Properties ("PhoneNumber") - user phone number </li><li>  Properties ("PhoneProvider") - telephone operator </li><li>  Properties ("AutheEnabled") - enable standard two-factor authentication (to do this, set the value to $$$ AutheTwoFactorSMS) </li></ul><br><h4>  ‚ñçChangePassword </h4><br>  Entry point to change user password.  The signature is as follows: <br><br><pre> <code class="hljs pgsql">ChangePassword(Username, NewPassword, OldPassword, Status) <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> { }</code> </pre> <br>  Where: <br><br><ul><li>  NewPassword - new password </li><li>  OldPassword - old password </li><li>  Status - the result of the password change operation </li></ul><br><h4>  ‚ñçSendTwoFactorToken </h4><br>  For use in standard two-factor authentication.  Defines the request format and authentication token.  Signature: <br><br><pre> <code class="hljs pgsql">SendTwoFactorToken(Username, ServiceName,Namespace,Application,Credentials,SecurityToken,TwoFactorTimeout,UserPhoneNumber) <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> { }</code> </pre> <br>  Where: <br><br><ul><li>  Application - CSP application or routine to which the user connects. </li><li>  SecurityToken - a token that will be sent to the user </li><li>  TwoFactorTimeout - time token </li><li>  UserPhoneNumber - user phone number </li></ul><br><h2>  Example </h2><br>  To begin with, I'll show you the simplest example for a Cach√© terminal on Windows ‚Äî the% Service_Console service, which will ask the user for the username and password.  Enable the transfer of authentication in the system for this service.  After that we will write the ZAUTHENTICATE routine (in the% SYS area): <br><br><pre> <code class="hljs mel">ZAUTHENTICATE(ServiceName, Namespace, Username, Password, Credentials, Properties) PUBLIC { #Include %occErrors #Include %occStatus Quit $$$OK } GetCredentials(ServiceName, Namespace, Username, Password, Credentials) Public { #Include %occErrors #Include %occStatus Do ##class(%Prompt).GetString(<span class="hljs-string"><span class="hljs-string">"USER:"</span></span>,.Username) Do ##class(%Prompt).GetString(<span class="hljs-string"><span class="hljs-string">"PASS:"</span></span>,.Password) Quit $$$OK }</code> </pre> <br>  In the terminal, it will look like a normal login. <br><br><pre> <code class="hljs pgsql">&gt;<span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>: _SYSTEM &gt;PASS: SYS</code> </pre> <br><h2>  RFID </h2><br>  Let's go to RFID authentication.  The idea is as follows - from Cach√© we will make it possible to write information in an encrypted form onto a card, and during authentication we will read it, decrypt it and return it for verification. <br><br>  To begin with, we will assemble a circuit from Arduino Uno and the RFID-RC522 module: <br><br><img src="https://habrastorage.org/files/67e/468/4b4/67e4684b41e641d691257e363d941e94.png"><br><br>  Here is the C code that uses the <a href="https://github.com/miguelbalboa/rfid">MF522</a> library (there is also a pinout for other Arduino models).  It accepts 2 commands via COM port: <br><br><ul><li>  Get - the content of RFID card blocks 2, 4, 5, 6 is transmitted to the com port </li><li>  Set @ bloc2 @ bloc4 @ bloc5 @ bloc6 - according to it, the contents of blocks 2, 4, 5, 6 on the card are overwritten by incoming data </li></ul><br><div class="spoiler">  <b class="spoiler_title">C code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SPI.h&gt; //include the SPI bus library #include &lt;MFRC522.h&gt; //include the RFID reader library #define SS_PIN 10 //slave select pin #define RST_PIN 9 //reset pin #define u1b 2 //Block on a card for user1 byte array #define u2b 4 //Block on a card for user2 byte array #define p1b 5 //Block on a card for pass1 byte array #define p2b 6 //Block on a card for pass2 byte array MFRC522 mfrc522(SS_PIN, RST_PIN); // instatiate a MFRC522 reader object. MFRC522::MIFARE_Key key; //create a MIFARE_Key struct named 'key', which will hold the card information byte readbackblock[18]; //This array is used for reading out a block. The MIFARE_Read method requires a buffer that is at least 18 String inString = ""; // COM port incoming data buffer void setup() { Serial.begin(9600); // Initialize serial communications with the PC SPI.begin(); // Init SPI bus mfrc522.PCD_Init(); // Init MFRC522 card (in case you wonder what PCD means: proximity coupling device) // Serial.println("Scan a MIFARE Classic card"); // Prepare the security key for the read and write functions - all six key bytes are set to 0xFF at chip delivery from the factory // Since the cards in the kit are new and the keys were never defined, they are 0xFF // if we had a card that was programmed by someone else, we would need to know the key to be able to access it. // This key would then need to be stored in 'key' instead. for (byte i = 0; i &lt; 6; i++) { key.keyByte[i] = 0xFF; // keyByte is defined in the "MIFARE_Key" 'struct' definition in the .h file of the library } } void loop() { // put your main code here, to run repeatedly: // Receive data from com port while (Serial.available() &gt; 0) { int inChar = Serial.read(); if (inChar != '\n') { inString += (char)inChar; } else { // New line while (!initCard()); // connect to an RFID card String Action = inString.substring(0, 3); if (Action == "Set") { // Write login and pass into the card setUserAndPassToCard(inString); } else if (Action == "Get") { // Read login and pass from the card readUserAndPassToCom(); } else { Serial.println(Action); } disconnectCard(); // disconnect RFID card inString = ""; } } } /// Read blocks with user/pass info and output the to COM port: /// user1user2@pass1pass2 void readUserAndPassToCom() { readBlockToCom(u1b); readBlockToCom(u2b); Serial.write("@"); readBlockToCom(p1b); readBlockToCom(p2b); Serial.println(""); } /// Set user/pass info into a card /// Data: Set@user1@user2@pass1@pass2 /// Data sample: Set@1234567890123456@1234567890123456@1234567890123456@1234567890123456 void setUserAndPassToCard(String Data) { // Serial.println(Data); byte user1[16], user2[16], pass1[16], pass2[16]; String user1str = inString.substring(4, 20); String user2str = inString.substring(21, 37); String pass1str = inString.substring(38, 54); String pass2str = inString.substring(55, 71); stringToArray(user1str, user1, sizeof(user1)); stringToArray(user2str, user2, sizeof(user2)); stringToArray(pass1str, pass1, sizeof(pass1)); stringToArray(pass2str, pass2, sizeof(pass2)); writeBlock(u1b, user1); // u1b is the block number, user1 is the block content writeBlock(u2b, user2); writeBlock(p1b, pass1); writeBlock(p2b, pass2); Serial.println("Done"); } void stringToArray(String str, byte array[], int arrlength) { for (int j = 0 ; j &lt; arrlength ; j++) { array[j] = str.charAt(j); } } bool initCard() { // Look for new cards (in case you wonder what PICC means: proximity integrated circuit card) if ( ! mfrc522.PICC_IsNewCardPresent()) {//if PICC_IsNewCardPresent returns 1, a new card has been found and we continue return false; //if it did not find a new card is returns a '0' and we return to the start of the loop } // Select one of the cards if ( ! mfrc522.PICC_ReadCardSerial()) {//if PICC_ReadCardSerial returns 1, the "uid" struct (see MFRC522.h lines 238-45)) contains the ID of the read card. return false; //if it returns a '0' something went wrong and we return to the start of the loop } return true; } void disconnectCard() { // Halt PICC mfrc522.PICC_HaltA(); // Stop encryption on PCD mfrc522.PCD_StopCrypto1(); } void readBlockToCom(int number) { readBlock(number, readbackblock);//read the block back for (int j = 0 ; j &lt; 16 ; j++) //print the block contents { Serial.write (readbackblock[j]);//Serial.write() transmits the ASCII numbers as human readable characters to serial monitor } } int writeBlock(int blockNumber, byte arrayAddress[]) { // this makes sure that we only write into data blocks. Every 4th block is a trailer block for the access/security info. int largestModulo4Number = blockNumber / 4 * 4; int trailerBlock = largestModulo4Number + 3; //determine trailer block for the sector if (blockNumber &gt; 2 &amp;&amp; (blockNumber + 1) % 4 == 0) { Serial.print(blockNumber); //block number is a trailer block (modulo 4); quit and send error code 2 Serial.println(" is a trailer block:"); return 2; } //Serial.print(blockNumber); //Serial.println(" is a data block:"); /*****************************************authentication of the desired block for access***********************************/ byte status = mfrc522.PCD_Authenticate(MFRC522::PICC_CMD_MF_AUTH_KEY_A, trailerBlock, &amp;key, &amp;(mfrc522.uid)); // byte PCD_Authenticate(byte command, byte blockAddr, MIFARE_Key *key, Uid *uid); // this method is used to authenticate a certain block for writing or reading // command: See enumerations above -&gt; PICC_CMD_MF_AUTH_KEY_A = 0x60 (=1100000), // this command performs authentication with Key A // blockAddr is the number of the block from 0 to 15. // MIFARE_Key *key is a pointer to the MIFARE_Key struct defined above, this struct needs to be defined for each block. // New cards have all A/B= FF FF FF FF FF FF // Uid *uid is a pointer to the UID struct that contains the user ID of the card. if (status != MFRC522::STATUS_OK) { Serial.print("PCD_Authenticate() failed: "); Serial.println(mfrc522.GetStatusCodeName(status)); return 3;//return "3" as error message } // it appears the authentication needs to be made before every block read/write within a specific sector. // If a different sector is being authenticated access to the previous one is lost. /*****************************************writing the block***********************************************************/ status = mfrc522.MIFARE_Write(blockNumber, arrayAddress, 16); //valueBlockA is the block number, MIFARE_Write(block number (0-15), byte array containing 16 values, number of bytes in block (=16)) // status = mfrc522.MIFARE_Write(9, value1Block, 16); if (status != MFRC522::STATUS_OK) { Serial.print("MIFARE_Write() failed: "); Serial.println(mfrc522.GetStatusCodeName(status)); return 4;//return "4" as error message } //Serial.println("block was written"); } int readBlock(int blockNumber, byte arrayAddress[]) { int largestModulo4Number = blockNumber / 4 * 4; int trailerBlock = largestModulo4Number + 3; //determine trailer block for the sector /*****************************************authentication of the desired block for access********************************************/ byte status = mfrc522.PCD_Authenticate(MFRC522::PICC_CMD_MF_AUTH_KEY_A, trailerBlock, &amp;key, &amp;(mfrc522.uid)); // byte PCD_Authenticate(byte command, byte blockAddr, MIFARE_Key *key, Uid *uid); // this method is used to authenticate a certain block for writing or reading // command: See enumerations above -&gt; PICC_CMD_MF_AUTH_KEY_A = 0x60 (=1100000), // this command performs authentication with Key A // blockAddr is the number of the block from 0 to 15. // MIFARE_Key *key is a pointer to the MIFARE_Key struct defined above, this struct needs to be defined for each block. // New cards have all A/B= FF FF FF FF FF FF // Uid *uid is a pointer to the UID struct that contains the user ID of the card. if (status != MFRC522::STATUS_OK) { Serial.print("PCD_Authenticate() failed (read): "); Serial.println(mfrc522.GetStatusCodeName(status)); return 3;//return "3" as error message } // it appears the authentication needs to be made before every block read/write within a specific sector. // If a different sector is being authenticated access to the previous one is lost. /*****************************************reading a block***********************************************************/ byte buffersize = 18;//we need to define a variable with the read buffer size, since the MIFARE_Read method below needs a pointer to the variable that contains the size... status = mfrc522.MIFARE_Read(blockNumber, arrayAddress, &amp;buffersize);//&amp;buffersize is a pointer to the buffersize variable; MIFARE_Read requires a pointer instead of just a number if (status != MFRC522::STATUS_OK) { Serial.print("MIFARE_read() failed: "); Serial.println(mfrc522.GetStatusCodeName(status)); return 4;//return "4" as error message } }</span></span></span></span></code> </pre> </div></div><br>  Arduino.Delegate class, which has 2 entry points: <br><br><ul><li>  SetCredentials - accepts login and password as input, encrypts them with AES encryption using the key stored in the system and writes to the RFID card. <br><br></li><li>  GetCredentials - receives the ciphertext from the card and decrypts it, returning the login, password and status of the operation. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Arduino.Delegate</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">/// <span class="hljs-type"><span class="hljs-type">Delegated</span></span> <span class="hljs-type"><span class="hljs-type">Authentication</span></span> with <span class="hljs-type"><span class="hljs-type">Arduino</span></span>. /// <span class="hljs-type"><span class="hljs-type">Installation</span></span> steps:&lt;br&gt; /// <span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-type"><span class="hljs-type">Connect</span></span> arduino (and upload <span class="hljs-type"><span class="hljs-type">C</span></span> code from <span class="hljs-type"><span class="hljs-type">Delegated</span></span>.ino there)&lt;br&gt; /// <span class="hljs-number"><span class="hljs-number">2.</span></span> <span class="hljs-type"><span class="hljs-type">Make</span></span> this class visible in %<span class="hljs-type"><span class="hljs-type">SYS</span></span> namespace (import there or map pckage)&lt;br&gt; /// <span class="hljs-number"><span class="hljs-number">3.</span></span> <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">SerialPort</span></span> parameter to a correct value and recompile the class&lt;br&gt; /// <span class="hljs-number"><span class="hljs-number">4.</span></span> <span class="hljs-type"><span class="hljs-type">Run</span></span> &lt;example&gt;<span class="hljs-type"><span class="hljs-type">Do</span></span> #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.<span class="hljs-type"><span class="hljs-type">Delegated</span></span>).<span class="hljs-type"><span class="hljs-type">InitEncryption</span></span>(<span class="hljs-type"><span class="hljs-type">Key</span></span>, <span class="hljs-type"><span class="hljs-type">IV</span></span>)&lt;/example&gt; /// <span class="hljs-number"><span class="hljs-number">5.</span></span> <span class="hljs-type"><span class="hljs-type">Write</span></span> encrypted user credentials to <span class="hljs-type"><span class="hljs-type">RFID</span></span> card with <span class="hljs-type"><span class="hljs-type">SetCredentials</span></span>&lt;br&gt; /// <span class="hljs-number"><span class="hljs-number">6.</span></span> <span class="hljs-type"><span class="hljs-type">Import</span></span> <span class="hljs-type"><span class="hljs-type">ZAUTHENTICATE</span></span> into %<span class="hljs-type"><span class="hljs-type">SYS</span></span>&lt;br&gt; /// <span class="hljs-number"><span class="hljs-number">7.</span></span> <span class="hljs-type"><span class="hljs-type">Enable</span></span> <span class="hljs-type"><span class="hljs-type">Delegated</span></span> and password auth for relevant services and/or apps <span class="hljs-type"><span class="hljs-type">Class</span></span> <span class="hljs-type"><span class="hljs-type">Arduino</span></span>.<span class="hljs-type"><span class="hljs-type">Delegated</span></span> [ <span class="hljs-type"><span class="hljs-type">Abstract</span></span> ] { <span class="hljs-type"><span class="hljs-type">Parameter</span></span> <span class="hljs-type"><span class="hljs-type">SerialPort</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-comment"><span class="hljs-comment">"com3"</span></span>; /// <span class="hljs-type"><span class="hljs-type">Creates</span></span> managed encryption key.&lt;br&gt; /// key - <span class="hljs-type"><span class="hljs-type">Input</span></span> key material. /// <span class="hljs-type"><span class="hljs-type">Key</span></span> material <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, or <span class="hljs-number"><span class="hljs-number">32</span></span> characters long (on <span class="hljs-type"><span class="hljs-type">Unicode</span></span> systems, with all character values &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>) is used directly. /// <span class="hljs-type"><span class="hljs-type">Otherwise</span></span>, <span class="hljs-type"><span class="hljs-type">Password</span></span>-<span class="hljs-type"><span class="hljs-type">Based</span></span> <span class="hljs-type"><span class="hljs-type">Key</span></span> <span class="hljs-type"><span class="hljs-type">Derivation</span></span> <span class="hljs-type"><span class="hljs-type">Function</span></span> #<span class="hljs-number"><span class="hljs-number">2</span></span> (<span class="hljs-type"><span class="hljs-type">PBKDF2</span></span>) /// is used with <span class="hljs-type"><span class="hljs-type">HMAC</span></span>-<span class="hljs-type"><span class="hljs-type">SHA</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>, /// no salt, and one iteration /// to generate an <span class="hljs-type"><span class="hljs-type">AES</span></span> key of the next larger valid size (up to <span class="hljs-number"><span class="hljs-number">32</span></span> bytes). /// (<span class="hljs-type"><span class="hljs-type">See</span></span> <span class="hljs-type"><span class="hljs-type">RSA</span></span> <span class="hljs-type"><span class="hljs-type">Laboratories</span></span> <span class="hljs-type"><span class="hljs-type">Public</span></span>-<span class="hljs-type"><span class="hljs-type">Key</span></span> <span class="hljs-type"><span class="hljs-type">Cryptography</span></span> <span class="hljs-type"><span class="hljs-type">Standards</span></span> #<span class="hljs-number"><span class="hljs-number">5</span></span> for more information.) /// &lt;br&gt;&lt;br&gt; /// <span class="hljs-type"><span class="hljs-type">IV</span></span> - <span class="hljs-type"><span class="hljs-type">Initialization</span></span> vector (optional). /// <span class="hljs-type"><span class="hljs-type">If</span></span> this argument is present it must be <span class="hljs-number"><span class="hljs-number">16</span></span> characters long (on <span class="hljs-type"><span class="hljs-type">Unicode</span></span> systems, with all character values &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>). /// <span class="hljs-type"><span class="hljs-type">If</span></span> this argument is omitted (or is an empty string), a null initialization vector is used. /// &lt;br&gt; /// &lt;example&gt;<span class="hljs-type"><span class="hljs-type">Do</span></span> #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.<span class="hljs-type"><span class="hljs-type">Delegated</span></span>).<span class="hljs-type"><span class="hljs-type">Init</span></span>(<span class="hljs-comment"><span class="hljs-comment">""</span></span>, <span class="hljs-comment"><span class="hljs-comment">""</span></span>)&lt;/example&gt; <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">Init</span></span>(<span class="hljs-type"><span class="hljs-type">Key</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">IV</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-type"><span class="hljs-type">New</span></span> <span class="hljs-string"><span class="hljs-string">$N</span></span>amespace <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-string"><span class="hljs-string">$N</span></span>amespace = <span class="hljs-comment"><span class="hljs-comment">"%SYS"</span></span> <span class="hljs-type"><span class="hljs-type">Set</span></span> ^<span class="hljs-type"><span class="hljs-type">Arduino</span></span>(<span class="hljs-comment"><span class="hljs-comment">"Key"</span></span>)= <span class="hljs-type"><span class="hljs-type">Key</span></span> <span class="hljs-type"><span class="hljs-type">Set</span></span> ^<span class="hljs-type"><span class="hljs-type">Arduino</span></span>(<span class="hljs-comment"><span class="hljs-comment">"IV"</span></span>)= <span class="hljs-type"><span class="hljs-type">IV</span></span> } /// <span class="hljs-type"><span class="hljs-type">Send</span></span> <span class="hljs-type"><span class="hljs-type">Arduino</span></span> the command to set credentials on a card to <span class="hljs-type"><span class="hljs-type">Username</span></span>/<span class="hljs-type"><span class="hljs-type">Password</span></span> (encrypted) /// &lt;example&gt;<span class="hljs-type"><span class="hljs-type">Do</span></span> #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.<span class="hljs-type"><span class="hljs-type">Delegated</span></span>).<span class="hljs-type"><span class="hljs-type">SetCredentials</span></span>(<span class="hljs-comment"><span class="hljs-comment">"_SYSTEM"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"SYS"</span></span>)&lt;/example&gt; <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">SetCredentials</span></span>(<span class="hljs-type"><span class="hljs-type">Username</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>(<span class="hljs-type"><span class="hljs-type">MAXLEN</span></span>=<span class="hljs-number"><span class="hljs-number">15</span></span>), <span class="hljs-type"><span class="hljs-type">Password</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>(<span class="hljs-type"><span class="hljs-type">MAXLEN</span></span>=<span class="hljs-number"><span class="hljs-number">15</span></span>)) <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Status</span></span> { <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Status</span></span> = <span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$O</span></span>K <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">CipherUsername</span></span> = ..<span class="hljs-type"><span class="hljs-type">EncryptText</span></span>(<span class="hljs-type"><span class="hljs-type">Username</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">CipherPassword</span></span> = ..<span class="hljs-type"><span class="hljs-type">EncryptText</span></span>(<span class="hljs-type"><span class="hljs-type">Password</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">User1</span></span> = <span class="hljs-string"><span class="hljs-string">$E</span></span>xtract(<span class="hljs-type"><span class="hljs-type">CipherUsername</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">User2</span></span> = <span class="hljs-string"><span class="hljs-string">$E</span></span>xtract(<span class="hljs-type"><span class="hljs-type">CipherUsername</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">User2</span></span> = ..<span class="hljs-type"><span class="hljs-type">AppendToString</span></span>(<span class="hljs-type"><span class="hljs-type">User2</span></span>, , <span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Pass1</span></span> = <span class="hljs-string"><span class="hljs-string">$E</span></span>xtract(<span class="hljs-type"><span class="hljs-type">CipherPassword</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Pass2</span></span> = <span class="hljs-string"><span class="hljs-string">$E</span></span>xtract(<span class="hljs-type"><span class="hljs-type">CipherPassword</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Pass2</span></span> = ..<span class="hljs-type"><span class="hljs-type">AppendToString</span></span>(<span class="hljs-type"><span class="hljs-type">Pass2</span></span>, , <span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">CommandList</span></span> = <span class="hljs-string"><span class="hljs-string">$L</span></span>istBuild(<span class="hljs-comment"><span class="hljs-comment">"Set"</span></span>, <span class="hljs-type"><span class="hljs-type">User1</span></span>, <span class="hljs-type"><span class="hljs-type">User2</span></span>, <span class="hljs-type"><span class="hljs-type">Pass1</span></span>, <span class="hljs-type"><span class="hljs-type">Pass2</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Command</span></span> = <span class="hljs-string"><span class="hljs-string">$L</span></span>istToString(<span class="hljs-type"><span class="hljs-type">CommandList</span></span>, <span class="hljs-comment"><span class="hljs-comment">"@"</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Status</span></span> = ..<span class="hljs-type"><span class="hljs-type">ExecuteCommand</span></span>(.<span class="hljs-type"><span class="hljs-type">Command</span></span>) <span class="hljs-type"><span class="hljs-type">If</span></span> (<span class="hljs-type"><span class="hljs-type">Status</span></span> = <span class="hljs-comment"><span class="hljs-comment">"Done"</span></span>) { <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Status</span></span> = <span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$O</span></span>K } <span class="hljs-type"><span class="hljs-type">Else</span></span> { <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Status</span></span> = <span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$E</span></span>RROR(<span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$G</span></span>eneralError, <span class="hljs-comment"><span class="hljs-comment">"SetCredentials failure, received: "</span></span> _ <span class="hljs-type"><span class="hljs-type">Status</span></span>) } <span class="hljs-type"><span class="hljs-type">Return</span></span> <span class="hljs-type"><span class="hljs-type">Status</span></span> } /// <span class="hljs-type"><span class="hljs-type">Connect</span></span> to an <span class="hljs-type"><span class="hljs-type">Arduino</span></span> device, receive credentials, decode them and set to <span class="hljs-type"><span class="hljs-type">Username</span></span>/<span class="hljs-type"><span class="hljs-type">Password</span></span> variables. /// &lt;example&gt;do #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.<span class="hljs-type"><span class="hljs-type">Delegated</span></span>).<span class="hljs-type"><span class="hljs-type">GetCredentials</span></span>(.<span class="hljs-type"><span class="hljs-type">Username</span></span>, .<span class="hljs-type"><span class="hljs-type">Password</span></span>)&lt;/example&gt; <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">GetCredentials</span></span>(<span class="hljs-type"><span class="hljs-type">Output</span></span> <span class="hljs-type"><span class="hljs-type">Username</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> <span class="hljs-type"><span class="hljs-type">Password</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Status</span></span> { <span class="hljs-type"><span class="hljs-type">Kill</span></span> <span class="hljs-type"><span class="hljs-type">Username</span></span>, <span class="hljs-type"><span class="hljs-type">Password</span></span> <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Username</span></span> = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Password</span></span> = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Status</span></span> = <span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$O</span></span>K <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Credentials</span></span> = ..<span class="hljs-type"><span class="hljs-type">ExecuteCommand</span></span>(<span class="hljs-comment"><span class="hljs-comment">"Get"</span></span>) <span class="hljs-type"><span class="hljs-type">If</span></span> ((<span class="hljs-string"><span class="hljs-string">$L</span></span>(<span class="hljs-type"><span class="hljs-type">Credentials</span></span>) =<span class="hljs-number"><span class="hljs-number">65</span></span>) &amp;&amp; (<span class="hljs-string"><span class="hljs-string">$L</span></span>(<span class="hljs-type"><span class="hljs-type">Credentials</span></span>,<span class="hljs-comment"><span class="hljs-comment">"@"</span></span>) = <span class="hljs-number"><span class="hljs-number">2</span></span>)) { <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">CipherUsername</span></span> = <span class="hljs-string"><span class="hljs-string">$P</span></span>iece(<span class="hljs-type"><span class="hljs-type">Credentials</span></span>, <span class="hljs-comment"><span class="hljs-comment">"@"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">CipherPassword</span></span> = <span class="hljs-string"><span class="hljs-string">$P</span></span>iece(<span class="hljs-type"><span class="hljs-type">Credentials</span></span>, <span class="hljs-comment"><span class="hljs-comment">"@"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">CipherUsername</span></span> = <span class="hljs-string"><span class="hljs-string">$E</span></span>xtract(<span class="hljs-type"><span class="hljs-type">CipherUsername</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>) // we need only first <span class="hljs-number"><span class="hljs-number">24</span></span> characters <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">CipherPassword</span></span> = <span class="hljs-string"><span class="hljs-string">$E</span></span>xtract(<span class="hljs-type"><span class="hljs-type">CipherPassword</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Username</span></span> = ..<span class="hljs-type"><span class="hljs-type">DecryptText</span></span>(<span class="hljs-type"><span class="hljs-type">CipherUsername</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Password</span></span> = ..<span class="hljs-type"><span class="hljs-type">DecryptText</span></span>(<span class="hljs-type"><span class="hljs-type">CipherPassword</span></span>) } <span class="hljs-type"><span class="hljs-type">Else</span></span> { <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Status</span></span> = <span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$E</span></span>RROR(<span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$G</span></span>eneralError, <span class="hljs-comment"><span class="hljs-comment">"GetCredentials failure, received: "</span></span> _ <span class="hljs-type"><span class="hljs-type">Credentials</span></span>) } <span class="hljs-type"><span class="hljs-type">Return</span></span> <span class="hljs-type"><span class="hljs-type">Status</span></span> } /// <span class="hljs-type"><span class="hljs-type">Send</span></span> one line at a time, using common terminating characters (ie, <span class="hljs-type"><span class="hljs-type">CR</span></span>) and receive output /// <span class="hljs-type"><span class="hljs-type">Possible</span></span> comands:&lt;br&gt; /// &lt;b&gt;<span class="hljs-type"><span class="hljs-type">Get</span></span>&lt;/b&gt; - reads an <span class="hljs-type"><span class="hljs-type">RFID</span></span> card and returns information in a format: user@pass&lt;br&gt; /// &lt;b&gt;<span class="hljs-type"><span class="hljs-type">Set</span></span>@user1@user2@pass1@pass2&lt;/b&gt; - sets information on a <span class="hljs-type"><span class="hljs-type">RFID</span></span> card /// in a format: user@pass (where user = user1@user2)&lt;br&gt; /// <span class="hljs-type"><span class="hljs-type">Returns</span></span> output, produced by <span class="hljs-type"><span class="hljs-type">Arduino</span></span> /// &lt;example&gt;w #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.<span class="hljs-type"><span class="hljs-type">Delegated</span></span>).<span class="hljs-type"><span class="hljs-type">ExecuteCommand</span></span>(<span class="hljs-comment"><span class="hljs-comment">"Get"</span></span>)&lt;/example&gt; <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">ExecuteCommand</span></span>(<span class="hljs-type"><span class="hljs-type">ByRef</span></span> <span class="hljs-type"><span class="hljs-type">Command</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">SerialPort</span></span> = {..<span class="hljs-symbol"><span class="hljs-symbol">#SerialPort</span></span>}) <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> { set x=<span class="hljs-comment"><span class="hljs-comment">""</span></span> try { //<span class="hljs-type"><span class="hljs-type">Parameters</span></span> used to open the serial device: // portstate = <span class="hljs-comment"><span class="hljs-comment">" 0801n0"</span></span> - by byte position: // <span class="hljs-number"><span class="hljs-number">1</span></span>: space indicates <span class="hljs-comment"><span class="hljs-comment">"don't disconnect the port"</span></span> // <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> indicates <span class="hljs-comment"><span class="hljs-comment">"don't use modem control"</span></span> // <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> indicates <span class="hljs-number"><span class="hljs-number">8</span></span> data bits // <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> indicates no parity // <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> indicates one stop bit // <span class="hljs-number"><span class="hljs-number">6</span></span>: n indicates that flow control is disabled // <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> indicates disable <span class="hljs-type"><span class="hljs-type">DTR</span></span> // /<span class="hljs-type"><span class="hljs-type">BAUD</span></span>=<span class="hljs-number"><span class="hljs-number">9600</span></span> determines the baud rate, of course. open <span class="hljs-type"><span class="hljs-type">SerialPort</span></span>:(:::<span class="hljs-comment"><span class="hljs-comment">" 0801n0"</span></span>:/<span class="hljs-type"><span class="hljs-type">BAUD</span></span>=<span class="hljs-number"><span class="hljs-number">9600</span></span>) set old = <span class="hljs-string"><span class="hljs-string">$i</span></span>o //<span class="hljs-type"><span class="hljs-type">Keep</span></span> track of the original device use <span class="hljs-type"><span class="hljs-type">SerialPort</span></span> write <span class="hljs-string"><span class="hljs-string">$c</span></span>har(<span class="hljs-number"><span class="hljs-number">10</span></span>) hang <span class="hljs-number"><span class="hljs-number">1</span></span> write <span class="hljs-type"><span class="hljs-type">Command</span></span> _ <span class="hljs-string"><span class="hljs-string">$C</span></span>har(<span class="hljs-number"><span class="hljs-number">10</span></span>) read x //<span class="hljs-type"><span class="hljs-type">Read</span></span> until a termination character is reached use old close <span class="hljs-type"><span class="hljs-type">SerialPort</span></span> } catch ex { close <span class="hljs-type"><span class="hljs-type">SerialPort</span></span> w <span class="hljs-string"><span class="hljs-string">$S</span></span>ystem.<span class="hljs-type"><span class="hljs-type">Status</span></span>.<span class="hljs-type"><span class="hljs-type">GetErrorText</span></span>(ex.<span class="hljs-type"><span class="hljs-type">AsStatus</span></span>()) } return x } /// <span class="hljs-type"><span class="hljs-type">Get</span></span> key to encode/decode via <span class="hljs-type"><span class="hljs-type">EncryptText</span></span>/<span class="hljs-type"><span class="hljs-type">DecryptText</span></span> <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">GetKey</span></span>() [ <span class="hljs-type"><span class="hljs-type">CodeMode</span></span> = expression ] { <span class="hljs-string"><span class="hljs-string">$G</span></span>et(^<span class="hljs-type"><span class="hljs-type">Arduino</span></span>(<span class="hljs-comment"><span class="hljs-comment">"Key"</span></span>)) } /// <span class="hljs-type"><span class="hljs-type">Get</span></span> <span class="hljs-type"><span class="hljs-type">IV</span></span> to encode/decode via <span class="hljs-type"><span class="hljs-type">EncryptText</span></span>/<span class="hljs-type"><span class="hljs-type">DecryptText</span></span> <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">GetIV</span></span>() [ <span class="hljs-type"><span class="hljs-type">CodeMode</span></span> = expression ] { <span class="hljs-string"><span class="hljs-string">$G</span></span>et(^<span class="hljs-type"><span class="hljs-type">Arduino</span></span>(<span class="hljs-comment"><span class="hljs-comment">"IV"</span></span>)) } /// <span class="hljs-type"><span class="hljs-type">Encrypt</span></span> <span class="hljs-type"><span class="hljs-type">PlainText</span></span> with <span class="hljs-type"><span class="hljs-type">AESCBCEncrypt</span></span> /// &lt;example&gt;<span class="hljs-type"><span class="hljs-type">Write</span></span> #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.<span class="hljs-type"><span class="hljs-type">Delegated</span></span>).<span class="hljs-type"><span class="hljs-type">EncryptText</span></span>(<span class="hljs-comment"><span class="hljs-comment">"string"</span></span>)&lt;/example&gt; <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">EncryptText</span></span>(<span class="hljs-type"><span class="hljs-type">PlainText</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> { <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>=<span class="hljs-string"><span class="hljs-string">$Z</span></span>Convert(<span class="hljs-type"><span class="hljs-type">PlainText</span></span>,<span class="hljs-comment"><span class="hljs-comment">"O"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"UTF8"</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>=<span class="hljs-string"><span class="hljs-string">$S</span></span>ystem.<span class="hljs-type"><span class="hljs-type">Encryption</span></span>.<span class="hljs-type"><span class="hljs-type">AESCBCEncrypt</span></span>(<span class="hljs-type"><span class="hljs-type">Text</span></span>, ..<span class="hljs-type"><span class="hljs-type">GetKey</span></span>(), ..<span class="hljs-type"><span class="hljs-type">GetIV</span></span>()) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Ciphertext</span></span>=<span class="hljs-string"><span class="hljs-string">$S</span></span>ystem.<span class="hljs-type"><span class="hljs-type">Encryption</span></span>.<span class="hljs-type"><span class="hljs-type">Base64Encode</span></span>(<span class="hljs-type"><span class="hljs-type">Text</span></span>) <span class="hljs-type"><span class="hljs-type">Return</span></span> <span class="hljs-type"><span class="hljs-type">Ciphertext</span></span> } /// <span class="hljs-type"><span class="hljs-type">Decrypt</span></span> <span class="hljs-type"><span class="hljs-type">PlainText</span></span> with <span class="hljs-type"><span class="hljs-type">AESCBCEncrypt</span></span> /// &lt;example&gt;<span class="hljs-type"><span class="hljs-type">Write</span></span> #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.<span class="hljs-type"><span class="hljs-type">Delegated</span></span>).<span class="hljs-type"><span class="hljs-type">DecryptText</span></span>(<span class="hljs-comment"><span class="hljs-comment">"sFgKzZVle187N4OqhhcXPw=="</span></span>)&lt;/example&gt; <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">DecryptText</span></span>(<span class="hljs-type"><span class="hljs-type">CipherText</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> { <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>=<span class="hljs-string"><span class="hljs-string">$S</span></span>ystem.<span class="hljs-type"><span class="hljs-type">Encryption</span></span>.<span class="hljs-type"><span class="hljs-type">Base64Decode</span></span>(<span class="hljs-type"><span class="hljs-type">CipherText</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>=<span class="hljs-string"><span class="hljs-string">$S</span></span>ystem.<span class="hljs-type"><span class="hljs-type">Encryption</span></span>.<span class="hljs-type"><span class="hljs-type">AESCBCDecrypt</span></span>(<span class="hljs-type"><span class="hljs-type">Text</span></span>, ..<span class="hljs-type"><span class="hljs-type">GetKey</span></span>(), ..<span class="hljs-type"><span class="hljs-type">GetIV</span></span>()) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">PlainText</span></span>=<span class="hljs-string"><span class="hljs-string">$Z</span></span>Convert(<span class="hljs-type"><span class="hljs-type">Text</span></span>,<span class="hljs-comment"><span class="hljs-comment">"I"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"UTF8"</span></span>) <span class="hljs-type"><span class="hljs-type">Return</span></span> <span class="hljs-type"><span class="hljs-type">PlainText</span></span> } /// <span class="hljs-type"><span class="hljs-type">Extends</span></span> right side of a <span class="hljs-type"><span class="hljs-type">String</span></span> by <span class="hljs-type"><span class="hljs-type">Character</span></span> up to <span class="hljs-type"><span class="hljs-type">Length</span></span> chars /// &lt;example&gt;<span class="hljs-type"><span class="hljs-type">Write</span></span> #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.<span class="hljs-type"><span class="hljs-type">Delegated</span></span>).<span class="hljs-type"><span class="hljs-type">AppendToString</span></span>(<span class="hljs-comment"><span class="hljs-comment">""</span></span>)&lt;/example&gt; <span class="hljs-type"><span class="hljs-type">ClassMethod</span></span> <span class="hljs-type"><span class="hljs-type">AppendToString</span></span>(<span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Character</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span>(<span class="hljs-type"><span class="hljs-type">MAXLEN</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>) = <span class="hljs-comment"><span class="hljs-comment">"_"</span></span>, <span class="hljs-type"><span class="hljs-type">Length</span></span> <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">Integer</span></span> = {<span class="hljs-string"><span class="hljs-string">$L</span></span>ength(<span class="hljs-type"><span class="hljs-type">String</span></span>)}) <span class="hljs-type"><span class="hljs-type">As</span></span> %<span class="hljs-type"><span class="hljs-type">String</span></span> { <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Difference</span></span> = <span class="hljs-type"><span class="hljs-type">Length</span></span> - <span class="hljs-string"><span class="hljs-string">$L</span></span>ength(<span class="hljs-type"><span class="hljs-type">String</span></span>) <span class="hljs-type"><span class="hljs-type">Return</span></span>:<span class="hljs-type"><span class="hljs-type">Difference</span></span>&lt;=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Tail</span></span> = <span class="hljs-string"><span class="hljs-string">$J</span></span>ustify(<span class="hljs-comment"><span class="hljs-comment">""</span></span>, <span class="hljs-type"><span class="hljs-type">Difference</span></span>) <span class="hljs-type"><span class="hljs-type">Set</span></span> <span class="hljs-type"><span class="hljs-type">Tail</span></span> = <span class="hljs-string"><span class="hljs-string">$T</span></span>ranslate(<span class="hljs-type"><span class="hljs-type">Tail</span></span>, <span class="hljs-comment"><span class="hljs-comment">" "</span></span>, <span class="hljs-type"><span class="hljs-type">Character</span></span>) <span class="hljs-type"><span class="hljs-type">Return</span></span> <span class="hljs-type"><span class="hljs-type">String</span></span> _ <span class="hljs-type"><span class="hljs-type">Tail</span></span> } }</code> </pre> </div></div><br>  The ZAUTHENTICATE routine that calls the Arduino.Delegated class, the GetCredentials method: <br><br><pre> <code class="hljs smalltalk"><span class="hljs-type"><span class="hljs-type">ZAUTHENTICATE</span></span>(<span class="hljs-type"><span class="hljs-type">ServiceName</span></span>, <span class="hljs-type"><span class="hljs-type">Namespace</span></span>, <span class="hljs-type"><span class="hljs-type">Username</span></span>, <span class="hljs-type"><span class="hljs-type">Password</span></span>, <span class="hljs-type"><span class="hljs-type">Credentials</span></span>, <span class="hljs-type"><span class="hljs-type">Properties</span></span>) <span class="hljs-type"><span class="hljs-type">PUBLIC</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#Include</span></span> %occStatus <span class="hljs-type"><span class="hljs-type">Quit</span></span> <span class="hljs-string"><span class="hljs-string">$$</span></span><span class="hljs-string"><span class="hljs-string">$O</span></span>K } <span class="hljs-type"><span class="hljs-type">GetCredentials</span></span>(<span class="hljs-type"><span class="hljs-type">ServiceName</span></span>, <span class="hljs-type"><span class="hljs-type">Namespace</span></span>, <span class="hljs-type"><span class="hljs-type">Username</span></span>, <span class="hljs-type"><span class="hljs-type">Password</span></span>, <span class="hljs-type"><span class="hljs-type">Credentials</span></span>) <span class="hljs-type"><span class="hljs-type">Public</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#Include</span></span> %occErrors <span class="hljs-symbol"><span class="hljs-symbol">#Include</span></span> %occStatus <span class="hljs-type"><span class="hljs-type">Quit</span></span> #<span class="hljs-symbol"><span class="hljs-symbol">#class</span></span>(<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.<span class="hljs-type"><span class="hljs-type">Delegated</span></span>).<span class="hljs-type"><span class="hljs-type">GetCredentials</span></span>(.<span class="hljs-type"><span class="hljs-type">Username</span></span>, .<span class="hljs-type"><span class="hljs-type">Password</span></span>) }</code> </pre> <br>  Done!  The assembled device looks like this: <br><br><img src="https://habrastorage.org/files/8f7/b06/a6e/8f7b06a6e43640d99569c80c3e0496fb.jpg"><br><br>  Install encryption keys in the terminal,% SYS area (the Arduino.Delegated class should be available there): <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Do</span></span> #<span class="hljs-selector-id"><span class="hljs-selector-id">#class</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">Arduino</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Delegated</span></span>)<span class="hljs-selector-class"><span class="hljs-selector-class">.InitEncryption</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">Key</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">IV</span></span>)</code> </pre> <br>  Where Key is the encryption key, IV is the initialization vector.  They will be used to encrypt username and password.  We connect Arduino to Cach√© and write the authentication information to the card with the command: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(Arduino.Delegated).SetCredentials("_SYSTEM", "SYS")</code> </pre> <br>  We enable Delegated and Password authentication in the necessary services / web applications and you can authenticate (for example, in a terminal or a system management portal) by bringing the card to the RFID card reader. <br><br><h2>  Possible improvements </h2><br><ul><li>  Enhance security by using <a href="">managed encryption keys</a> to encrypt username and password. <br><br></li><li>  Enhancing security through the use of two-factor authentication - first get a login / password pair, and then read the card on which the key is stored, unique to the user.  Then you need to verify the received key with that stored in the system for this user.  Storage options for arbitrary user data were <a href="https://community.intersystems.com/post/best-practices-store-user-informationsettings-cach%25C3%25A9">discussed</a> on the InterSystems Community Portal. <br><br></li><li>  Add the ability to store username and password longer than 15 characters each. </li></ul><br><h2>  findings </h2><br>  Cach√©'s flexible authentication system allows the implementation of arbitrary user authentication logic. <br><br><h2>  Links </h2><br>  ¬ª <a href="">Documentation</a> <br>  ¬ª <a href="https://github.com/intersystems-ru/ArduinoSnippets">GitHub repository with code</a> (in the SAMPLES area there is an example of the ZAUTHENTICATE routine) </div><p>Source: <a href="https://habr.com/ru/post/279893/">https://habr.com/ru/post/279893/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279881/index.html">Microsoft DevCon 2016 - Introducing the First Wave of Community Track Speakers</a></li>
<li><a href="../279883/index.html">#FailOverConf April 8th! Free, without SMS, but with registration</a></li>
<li><a href="../279887/index.html">The first hakkaton, from idea to implementation</a></li>
<li><a href="../279889/index.html">Gestures in design and design</a></li>
<li><a href="../279891/index.html">NetApp ONTAP with Veeam Backup & Replication</a></li>
<li><a href="../279895/index.html">Many-sided GOST R 34.11-94</a></li>
<li><a href="../279897/index.html">Moving from Windows to Linux Ubuntu 14.04 LTS with Jetbrains IntelliJ Idea 14.1.5</a></li>
<li><a href="../279903/index.html">Scaling Wix to 100 million users. Start</a></li>
<li><a href="../279905/index.html">Percona Server Upgrade to 5.7 on Ubuntu 14.04</a></li>
<li><a href="../279907/index.html">NetApp ONTAP Cloud: Amazon & Azure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>