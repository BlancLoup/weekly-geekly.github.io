<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How 64k intro is created today: immersion immersion</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last December, we finally completed our project. This video shows our latest work - the four-minute animation "Immersion" . More precisely, this is a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How 64k intro is created today: immersion immersion</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/800/930/0e6/8009300e6e2f05118a0ff9a8fdee3bfc.jpg" alt="image"></div><br><br>  Last December, we finally completed our project.  This video shows our latest work - the four-minute animation <em>"Immersion"</em> .  More precisely, this is a record of what is usually called a <a href="https://en.wikipedia.org/wiki/64K_intro">64k intro</a> .  But more on this later. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/27PN1SsXbjM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Work on the project took the best available hours of the last two years of life.  It all started during <a href="http://2015.revision-party.net/">Revision 2015</a> , a large event held every year in Germany during the Easter holidays.  The two of us chatted on the way from the hotel to the venue of the event.  The previous evening, the level of competition in the 64kB intro turned out to be high.  Very high.  The experienced and well-known Hungarian group <em>Conspiracy has</em> finally returned with a serious, <a href="https://www.youtube.com/watch%3Fv%3DPaNYOzwlVC8">awesome job</a> .  Our best enemy, <em>Approximate, was</em> ideally on time with the completion of the release cycle and showed significant <a href="https://www.youtube.com/watch%3Fv%3DfoYcHp40HTg">improvements in storytelling</a> .  The productive group <em>Mercury</em> has found its own <a href="https://www.youtube.com/watch%3Fv%3DXF4SEVbxUdE">mature design style</a> in the intro, which left no doubt in its victory. <br><a name="habracut"></a><br>  That year we came empty-handed and did not participate in competitions, but of course we wanted to return as soon as possible.  However, after the demonstration of these high-quality intro, we wondered: beautiful graphics, excellent plot, wonderful design - how can we get to this level?  I could not come up with a concept that, even with perfect implementation, would be able to defeat all these three competitors.  Not to mention that our technical skills were lower than those of each group.  And so we walked along the Hohenzollernshtrasse, exchanging ideas, until one of them ‚Äúshot‚Äù.  <em>City growing out of the sea.</em>  This concept, if correctly implemented, could possibly compete at the level reached by the intro subculture.  <a href="http://2016.revision-party.net/">Revision 2016</a> , get ready, we go! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Revision 2016 rushed past us;  Will we be able to get to <a href="http://2017.revision-party.net/">Revision 2017</a> ?  Alas, we did not cope with this new deadline.  When we were asked at the event, how things were going, we answered evasively: <em>‚ÄúThe first part took us a year.</em>  <em>I am sure that we will be able to do the second part in 24 hours</em> . <em>‚Äù</em>  But we did not have time.  Nevertheless, we released a release, but the second part was done in a hurry, and <a href="https://www.youtube.com/watch%3Fv%3DHpAMtE4i8zg">it was noticeable</a> .  So much so that we could not even get close to the scene with the winners.  We continued to work, and invested all the necessary love, and then, finally, we released the final version shown above. <br><br><h1>  What is a 64k intro? </h1><br>  Demo - this is the creation of digital art, standing at the intersection of short films, music videos and video games.  Although they are non-interactive and often depend on music, like video clips, they are rendered in real time like video games. <br><br>  64-kilobyte intro, or 64k for brevity, looks like a demo, but they add a size limit: <strong>intro should completely fit into one binary file of no more than 65536 bytes</strong> .  No additional resources, no network, no extra libraries: the usual requirement is that it can be run on a PC with just installed Windows and the latest drivers. <br><br>  How big is this volume?  Here are your reference points for comparison. <br><br>  In a file of 64KB size you can store: <br><br><ul><li>  400 milliseconds WAV sound with CD-quality, or </li><li>  3 seconds mp3 with 192 Kbps, or </li><li>  RGB image 200 √ó 100 in .bmp format, or </li><li>  JPEG image of medium size and medium quality, for example, such as this 800 √ó 450 screenshot from the intro: </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/781/713/708/7817137089fe55c7cb9af7a97cd33f5d.jpg" alt="64kB screenshot"></div><br>  <i>JPEG image is 65595 bytes in size, 59 bytes more than the 64K limit.</i> <br><br>  Yes, that's right: <em>this video, shown at the beginning of the post, fully fits into one file, which takes up less space than the screenshot of the video itself</em> . <br><br>  When you see such numbers, it seems difficult to fit into a binary file all the images and sounds that should be exactly necessary.  We have already talked about <a href="http://www.ctrl-alt-test.fr/%3Fp%3D494">some of the compromises</a> that we had to make, and about <a href="http://www.ctrl-alt-test.fr/%3Fp%3D535">some of the tricks</a> we used to fit everything into such a small size.  But this is not enough. <br><br>  In fact, due to such extreme restrictions it is impossible to use conventional techniques and tools.  We wrote our own toolchain - this task is interesting in itself: we created textures, 3D models, animations, camera paths, music, etc.  thanks to algorithms, procedural generation and compression.  Soon we will tell about it. <br><br><h1>  Some of the numbers </h1><br>  This is what we spent 64KB available for us: <br><br><ul><li>  Music: 12.4KB </li><li>  3D meshes: 12.5KB </li><li>  Textures: 4.8KB </li><li>  Camera data: 1.3KB </li><li>  Shaders: 6.2KB, out of 5 thousand lines of code </li><li>  Engine: 12.9KB, out of 20 thousand lines of code </li><li>  Intro itself: 12 thousand lines of code </li><li>  Time spent: long hours, perhaps even a thousand hours </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4bd/a5c/7e6/4bda5c7e69d556b0b1a056ae5357d5d2.png"></div><br>  <i>This graph shows how 64KB is occupied by different types of content after compression.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6a2/e32/3f2/6a2e323f28584f1760d8abfe15e96734.png"></div><br>  <i>This graph shows the change in binary size (not including about 2KB of the unpacker) before the final release.</i> <br><br><h1>  Design and inspiration </h1><br>  Having agreed that the submerged city would be the central theme, we asked ourselves the first question: what should this city look like?  Where is it located, why is it flooded, what is its architecture?  One simple answer to all these questions: it could be the legendary lost city of <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D1%2582%25D0%25BB%25D0%25B0%25D0%25BD%25D1%2582%25D0%25B8%25D0%25B4%25D0%25B0">Atlandida</a> .  This will also explain his appearance: at the behest of the gods (literally deus ex machina).  At this we decided. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aed/409/ff7/aed409ff7be3273cc8aefb91035117a5.jpg"></div><br>  <i>Early concept of flooded city.</i>  <i>The artwork shown in the article was created by Beno√Æt Molenda.</i> <br><br>  When making design decisions, we were guided by two books: <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B8%25D0%25BC%25D0%25B5%25D0%25B9_(%25D0%259F%25D0%25BB%25D0%25B0%25D1%2582%25D0%25BE%25D0%25BD)"><em>Timaeus</em></a> and <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B8%25D1%2582%25D0%25B8%25D0%25B9_(%25D0%259F%25D0%25BB%25D0%25B0%25D1%2582%25D0%25BE%25D0%25BD)"><em>Critias</em></a> , in which Plato described Atlantis and her fate.  In particular, in <em>‚ÄúKritii‚Äù</em> , he describes in detail the details of the structure of the city, its colors, the abundance of the precious Orihalka (which has become an essential element of the scene with the temple), the general form of the city and the main temple dedicated to Poseidon and Clayto.  Since Plato apparently bases his descriptions on countries he knows, that is, a mixture of Greek, Egyptian and Babylonian styles, we decided to stick with this. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7da/557/fab/7da557fab7e3055e1e752545593ac936.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/152/52b/527/15252b527a0bdf6b1ebd5256e7ca044a.jpg"></div><br>  However, without sufficient knowledge of the subject matter, the creation of a convincing ancient architecture seemed difficult.  Therefore, we decided to recreate the existing buildings: <br><br><ul><li>  One of them is a reproduction of the Athenian <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B0%25D1%2580%25D1%2584%25D0%25B5%25D0%25BD%25D0%25BE%25D0%25BD">Parthenon</a> . </li><li>  The other is a simplified version of the <a href="http://www.penhook.org/tholos_at_epidaurus.htm">Tolos</a> Delphi. </li><li>  When building the viaduct, we built on the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D0%25BD-%25D0%25B4%25D1%258E-%25D0%2593%25D0%25B0%25D1%2580">Pont du Gard</a> and the <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25BA%25D0%25B2%25D0%25B5%25D0%25B4%25D1%2583%25D0%25BA_%25D0%25B2_%25D0%25A1%25D0%25B5%25D0%25B3%25D0%25BE%25D0%25B2%25D0%25B8%25D0%25B8">aqueduct in Segovia</a> . </li><li>  The temple is essentially the <a href="https://ru.wikipedia.org/wiki/%25D0%25A5%25D1%2580%25D0%25B0%25D0%25BC_%25D0%2590%25D1%2580%25D1%2582%25D0%25B5%25D0%25BC%25D0%25B8%25D0%25B4%25D1%258B_%25D0%25AD%25D1%2584%25D0%25B5%25D1%2581%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B9">temple of Artemis</a> at Ephesus, one of the Seven Wonders of the Ancient World. </li></ul><br>  The search for reference materials on the temple of Artemis (Artemision) turned out to be unexpected, enriching us with experience.  At first we looked only for photos, charts or maps.  But when we learned the name of <a href="https://en.wikipedia.org/wiki/John_Turtle_Wood">John Turtle-Wood</a> , everything gained more depth.  Wood was the very person who was looking for the location of the temple and as a result found it.  Hoping that a search by his name would give us more results than just Artemision, we immediately came across his book, written in 1877, in which he not only gives descriptions and sketches of the temple, but also describes his eleven-year journey to the lost monument, negotiations with the British Museum on financing, relations with local workers and diplomatic negotiations, without which it was impossible to carry out excavations in arbitrary locations. <br><br>  These books were very important for us to make design decisions, but above all, their reading made us, as individuals, much more appreciate the work on the project. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e2f/df5/8e7/e2fdf58e79626a997c3beff2dfbf95c3.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/528/9cd/5f2/5289cd5f2ffacea89380c70df73fdbe9.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/067/f1b/123/067f1b1239fd5b81ab4c6274b5123a0c.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b27/add/498/b27add4980efd413e845027f79271530.jpg"></div><br>  And by the way, what should the roof look like?  In some sketches, including Wood, there was a hole in it, in others it was missing;  there is obviously some contradiction here.  We decided to choose a model with an open roof, which will allow us to illuminate the interior of the castle with a beam of light.  The illustrations shown above show the architectural plan and cross-sections of the building from the book <a href="https://archive.org/details/discoveriesateph00wood"><em>Discoveries at Ephesus</em></a> , which can be compared with our working model of the temple. <br><br><h1>  How to achieve the desired appearance </h1><br>  From the very beginning, we knew that the appearance of water would be crucial in this intro.  Therefore, we spent a lot of time on it, starting with viewing reference materials to understand the essential elements of underwater graphics.  As you can guess, we were inspired by James Cameron's <a href="http://www.imdb.com/title/tt0096754/"><em>The Abyss</em></a> and <a href="http://www.imdb.com/title/tt0120338/"><em>Titanic</em></a> , <a href="https://www.futuremark.com/benchmarks/3dmark11">3DMark 11</a> , and the lighting was studied in Ridley Scott <a href="http://www.imdb.com/title/tt0083658/"><em>'s Blade Runner</em></a> . <br><br>  To achieve the right feeling of being under water, it was not enough to implement and enable some epic function <em><strong>MakeBeautifulWater ()</strong></em> .  It was a combination of many effects that, if properly tuned, could convince us, the audience, of an illusion and make us feel that we were under water.  But one mistake is enough to destroy the illusion;  We learned this lesson too late, when in the comments after the initial release we were shown where the illusion disappears. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2bd/f01/058/2bdf01058c0ecafdd925354d370d83b4.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7a6/6c5/500/7a66c5500935cf123bc823c386ee33b3.jpg"></div><br>  As can be seen in the illustrations, we also explored various unrealistic and sometimes excessive palettes, but did not know how to achieve such an appearance, so that we returned to the classical color scheme. <br><br><h2>  Water surface </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/800/930/0e6/8009300e6e2f05118a0ff9a8fdee3bfc.jpg"></div><br>  Rendering the surface of the water involves reflection from a flat surface.  Reflection and refraction are first rendered on separate textures using one camera located at the side, and the second located above the water plane.  In the main pass, the surface of the water is rendered as a mesh with a material that combines reflection and refraction based on the normal vector and the view vector.  The trick is to offset the coordinates of the textures based on the normal to the surface of the water in the screen space.  This technique is classic and well documented. <br><br>  On a medium scale, this works well, for example, during a scene with a boat, but on a large scale, for example, in the final scene with the appearance of a temple out of the water, the result looks artificial.  To make it convincing, we used an artistic trick of applying Gaussian noise to intermediate textures.  Blurring the texture of the refraction gives the water a gloomy look and a greater sense of depth.  Blurring the reflection texture helps the sea look more agitated.  In addition, the use of a larger blur in the vertical direction simulates the vertical traces that can be expected from the surface of the water. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b06/69f/aad/b0669faadf55cd7b49f3d8bcf1548ee0.jpg"></div><br>  <i>Blurred image of the temple is reflected in the water surface.</i> <br><br>  Animation is performed using simple <a href="http://developer.download.nvidia.com/books/HTML/gpugems/gpugems_ch01.html">Gerstner waves</a> in the vertex shader by adding eight waves with random directions and amplitude (in the specified range).  Smaller details are performed in a fragment shader containing another 16 wave functions.  An artificial backscatter effect based on the normal and height makes the wave tops brighter, visible in the image above as small turquoise spots.  During the startup scene, several additional effects have been added, for example, a raindrop shader. <br><br><div style="text-align:center;"> <a href="https://www.shadertoy.com/view/ldfyzl"><img src="https://habrastorage.org/webt/cs/-v/yl/cs-vylztwafoquaygf_q-npntuc.png"></a> </div><br>  <i>Shader illustration.</i>  <i>Click on the image to go to the shader in Shadertoy.</i> <br><br><h2>  Volumetric lighting </h2><br>  One of the first technical questions was <em>‚ÄúHow to make the pillars of light immersed in water?‚Äù</em> .  Perhaps a translucent billboard with a beautiful shader?  Once we started experimenting with naive ray marching through a medium.  We were happy to see that even in the early rough rendering test, despite the poorly chosen colors and the lack of a decent phase function, the volumetric lighting immediately became convincing.  At this point, we abandoned the original idea with a billboard and never returned to it. <br><br>  Thanks to this simple technique, we got effects that we didn‚Äôt even dare to think about.  When we added phase function and experimented with it, the <em>sensations</em> began to look like real ones.  From a cinematic point of view, this opened up many possibilities.  But the problem was speed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c47/546/8d5/c475468d56253fb8f1b04a00fd643000.jpg"></div><br>  <i>The pillars of light give this scene a look that was inspired by Blade Runner.</i> <br><br>  It is time to turn this prototype into a real effect, so we read the <a href="http://sebastien.hillaire.free.fr/index.php%3Foption%3Dcom_content%26amp%3Bview%3Darticle%26amp%3Bid%3D72%26amp%3BItemid%3D106">tutorial of Sebastian Hillar</a> , his <a href="https://www.slideshare.net/DICEStudio/physically-based-and-unified-volumetric-rendering-in-frostbite">presentation DICE</a> and explored other approaches, for example, with <a href="https://software.intel.com/en-us/articles/ivb-atmospheric-light-scattering">epipolar coordinates</a> .  As a result, we settled on a simpler technique, similar to that used in the <a href="https://www.guerrilla-games.com/read/taking-killzone-shadow-fall-image-quality-into-the-next-generation-1">Killzone Shadow Fall</a> ( <a href="https://www.youtube.com/watch%3Fv%3D0MilN7jKK9c">video</a> ) with some differences.  The effect is performed by one full-screen shader at half resolution: <br><br><ol><li>  For each pixel, a beam is emitted and its interactions with each cone of light are solved anatilically. <br><br>  Mathematical calculations are <a href="http://lousodrome.net/blog/light/2017/01/03/intersection-of-a-ray-and-a-cone/">described here</a> .  From the point of view of performance, it will probably be more efficient to use the limiting mesh of the volume of light, but for 64KB we found it easier to apply an analytical approach.  Obviously, the rays do not propagate further than the depth in the depth buffer. </li><li>  In the case of intersection of the beam for the volume inside the cone, ray marching is performed. <br><br>  The number of steps is limited by speed considerations, and random offsets are added to them to avoid stripes.  This is a typical case of eliminating noise bands, less visually objectionable. </li><li>  At each step, a shadow map is obtained corresponding to the light, and the effect of the light is accumulated in accordance with the simple <a href="http://www.oceanopticsbook.info/view/scattering/the_henyeygreenstein_phase_function"><em>Henie-Greenstein</em> phase function</a> . <br><br>  In contrast to the approach based on epipolar coordinates, using this technique it is possible to have a heterogeneous density of the medium, which adds variability, but we did not realize this effect. </li><li>  The resolution of the resulting image is increased by using a two-pass <a href="https://computergraphics.stackexchange.com/questions/3652/what-is-bilateral-upsampling">bidirectional</a> Gaussian filter and is added on top of the main rendering buffer.  Unlike the technique from the Sebastian tutorial, we do not use temporary re-projection;  we only use a sufficiently large number of steps to reduce visible artifacts (8 steps at low quality settings, 32 steps at high quality settings). </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/462/69c/cbe/46269ccbeb328b2597be2e18306c7c93.jpg"></div><br>  <i>Volumetric lighting allows you to give the right mood and distinct cinematic appearance, which is difficult to implement in another way.</i> <br><br><h2>  Light absorption </h2><br>  The instantly recognizable aspect of the underwater image is absorption.  When the object is removed, it becomes less and less visible, its colors merge with the background until it disappears completely.  Similarly, the volume affected by light sources also decreases, because the light is quickly absorbed by the aquatic environment. <br><br>  This effect has great potential for creating a cinematic sensation, and it is very easy to model it.  It is created in two stages in the shader.  The first stage applies a simple absorption function to the brightness of light when light sources that affect an object are accumulated, thereby changing the color and brightness of the light when it reaches surfaces.  The second stage applies the same absorption function to the final color of the object itself, thus changing the perceived color depending on the distance from the camera. <br><br>  The code has approximately the following logic: <br><br><pre><code class="hljs lisp">vec3 lightAbsorption = pow(<span class="hljs-name"><span class="hljs-name">mediumColor</span></span>, vec3(<span class="hljs-name"><span class="hljs-name">mediumDensity</span></span> * lightDistance)); vec3 lightIntensity = distanceAttenuation * lightColor * lightAbsorption; vec3 surfaceAbsorption = pow(mediumColor, vec3(mediumDensity * surfaceDistance))<span class="hljs-comment"><span class="hljs-comment">; vec3 surfaceColor = LightEquation(E, N, material) * lightIntensity * surfaceAbsorption;</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13b/742/ced/13b742ced8b0dd578a98eaa2006ad1e1.jpg" alt="Light absorption test"></div><br>  <i>Test the absorption of light in the aquatic environment.</i>  <i>Notice how color affects the distance to the camera and the distance from light sources.</i> <br><br><h2>  Adding vegetation </h2><br>  We definitely wanted to use algae.  In the list of desirable typical elements of the underwater scenes, they were one of the first places, but their implementation seemed risky.  Such organic elements can be difficult to implement, and incorrect implementation can destroy the feeling of immersion in the illusion.  They should have a convincing form, be well integrated into the environment, and possibly require an additional model of subsurface scattering. <br><br>  However, one day we felt that we were ready for the experiment.  We started with a cube, scaled it and placed a random number of cubes in a spiral around an imaginary stem: from a sufficiently long distance, this could pass for a long plant with many small branches.  After adding a lot of noise to deform the model, the algae began to look almost dignified. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dd4/5eb/d9d/dd45ebd9d5f6b9efb37fc682456d5ca9.jpg"></div><br>  <i>Test frame with several rare plants.</i> <br><br>  However, when we tried to add these plants to the scene, we realized that with an increase in the number of objects, the speed quickly decreases.  Therefore, we could add too few of them to make it look convincing.  It seems that our new non-optimized engine has already stumbled upon the first ‚Äúbottleneck‚Äù.  Therefore, at the last minute we implemented a rough <a href="https://fgiesen.wordpress.com/2010/10/17/view-frustum-culling/">clipping along the visibility pyramid</a> (the final version uses the correct clipping), which allowed us to show dense bushes in the demo. <br><br>  With a suitable density and size (areas with a normal distribution), and when the details are hidden by dim lighting, the picture begins to look interesting.  In further experiments, we tried to animate the algae: the noise function to modulate the power of an imaginary underwater flow, the inverse exponential function for the plants to bend, and the sinusoid for their tips to spin in the flow.  In the process of experiments, we came across a real treasure: the <a href="https://www.youtube.com/watch%3Fv%3D27PN1SsXbjM%26amp%3Bt%3D1m20s">emission of underwater light through the bushes</a> , drawing shadow patterns on the seabed that disappear when away from the camera. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/544/288/cfb/544288cfb88c5dbcb3d57306d378d74c.jpg"></div><br>  <i>Vegetation casting shadow patterns onto the seabed.</i> <br><br><h2>  Giving volume with particles </h2><br>  The final light touch is particles.  Take a close look at any underwater survey, and you will notice all sorts of suspended particles.  Stop paying attention to them, and they will be gone.  We set up the particles so that they are barely visible and do not come across on the way.  Nevertheless, they give a sense of volume, filled with a tangible medium, and help strengthen the illusion. <br><br>  From a technical point of view, everything is quite simple: in the Immersion intro, particles are just copies of quadrangles with translucent material.  We simply avoided the rendering order problem caused by translucency by setting the position along one axis according to the instance identifier.  Because of this, all instances are always drawn along this axis in the correct order.  For each frame, then you need to correctly orient the volume of particles.  In fact, for many shots of this, we did not do this at all, because the size of the particles and the darkness of the scene made noticeable artifacts quite rare. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b6d/a7e/09f/b6da7e09fc4e1465ad03dfb3194730e3.jpg"></div><br>  <i>In this frame, the particles give an idea of ‚Äã‚Äãdepth and a sense of density with increasing depth of immersion.</i> <br><br><h1>  Music </h1><br>  How to fit high-quality music at about 16KB?  This task is not new, and most 64k-intros written after the <a href="http://www.pouet.net/prod.php%3Fwhich%3D1221">.the .product of</a> 2000 use similar concepts.  The original series of articles is quite old, but does not lose relevance: <a href="https://conspiracy.hu/articles/">The Workings of FR-08's Sound System</a> . <br><br>  In short, the idea is that we need a musical score and a list of instruments.  Each of the instruments is a function that generates sound procedurally (see, for example, <a href="https://en.wikipedia.org/wiki/Subtractive_synthesis">subtractive synthesis</a> and <a href="https://en.wikipedia.org/wiki/Physical_modelling_synthesis">synthesis of physical modeling</a> ).  A musical score is a list of notes and effects used.  It is stored in a format similar to midi, with some changes to reduce the size.  Music generation takes place during program execution. <br><br>  The synthesizer also has a plug-in version ( <a href="https://ru.wikipedia.org/wiki/Virtual_Studio_Technology">VSTi</a> ) that a musician can use in their favorite music writing program.  Having written music, the composer presses a button that exports all data to a file.  We embed data in the demo. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/MPVNZr_PgUc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  When you run the demo, it starts the stream to generate music in a huge buffer.  The synthesizer actively consumes CPU resources and is not necessarily executed in real time.  Therefore, we run the stream before the demo starts, when textures and other data are generated. <br><br>  <a href="https://twitter.com/dropkickmonk3y">Daniel Lindholm</a> composed music with the help of a 64klang synthesizer created by Dominic Ries. <br><br><h1>  The working process </h1><br>  When creating a demo, one of the most critical aspects is the iteration time.  In fact, this applies to many creative processes.  The iteration time is the most important.  <strong>The faster you can perform the iterations, the more you can experiment, the more variations you can explore, the more you can improve your vision and improve the quality as a whole.</strong>  Therefore, we want to get rid of all obstacles, pauses and small friction in the process of creativity.  Ideally, we want to be able to change anything at any time, instantly seeing the result and receiving continuous feedback in the process of making changes. <br><br>  A possible solution <a href="http://peisik.untergrund.net/engines/">used by many demo groups</a> is to assemble the editor and create all the content inside it.  We did not.  Initially, we wanted to write code in C ++ and do everything inside Visual C ++.  Over time, we developed several techniques that improved our workflow and reduced the iteration time. <br><br><h2>  Hot reload all data </h2><br>  <strong>If we could give only one piece of advice in this article, it would be like this:</strong> have all your data support a hot reboot.  <i>All data</i> .  Make it so that you can detect changes in data, load new data when this happens, and change the state of the program accordingly. <br><br>  Little by little, we provided the possibility of a hot reload of all data: shaders, cameras, editing, all time-dependent curves, etc.  In practice, we usually had an editor and an additional demo.  When the file was modified, the changes instantly became visible in the demo. <br><br>  In such a small project as a demo, it is quite simple to implement.  Our engine keeps track of where the data comes from, and a small function regularly checks for changes in the time stamps of the corresponding files.  When they change, it launches a reload of the corresponding data. <br><br>  Such a system can be much more complex in large projects in which such changes are hampered by dependencies and a legacy structure.  But the influence of this mechanism on the production process is difficult to overestimate, so it is completely worth the effort. <br><br><h2>  Custom values </h2><br>  Reloading the data is, of course, good, but what about the code itself?  It is more and more difficult with him, so we had to solve this problem in stages. <br><br>  The first step was a clever trick that allowed us to change the literals of the constants.  Joel Davis described this <a href="https://www.gamedev.net/articles/programming/general-and-gameplay-programming/tweakable-constants-r2731/">in his post</a> : a short macro that turns a constant into a variable with a code fragment that recognizes a change event in the source file and updates the variable accordingly.  Obviously, this auxiliary code is missing from the final binary file and only a constant is left.  Due to this, the compiler is able to perform all optimizations (for example, when the constant is set to 0). <br><br>  This trick can not be used in all cases, but it is very simple and can be integrated into the code in a matter of minutes.  Moreover, although it is meant that it should only change constants, it can also be used for debugging: to change code branches or enable / disable parameters with conditions like <em><strong>if (_TV (1))</strong></em> . <br><br><h2>  C ++ Recompilation </h2><br>  Finally, the most recent step to ensure the flexibility of the code was the inclusion in the code base of the <a href="https://github.com/RuntimeCompiledCPlusPlus/RuntimeCompiledCPlusPlus"><em>Runtime Compiled C ++</em></a> tool.  It compiles the code as a dynamic library and loads it, and also performs serialization, which allows you to make changes to this code and monitor the results during execution, without the need to restart the program (in our case, the demo). <br><br>  This tool is not perfect yet: its API is too embedded in the code and limits its structure (classes must be derived from the interface), and compiling and reloading the code still takes a few seconds.  However, the ability to make changes to the logic of the code inside the demo and see the result provides wide creative freedom.  At the moment, the advantages of the tool are used only for texture and mesh generators, but in the future we want to expand its work to the entire set of code dealing with content. <br><br><h1>  To be continued </h1><br>  Here ends the first part of what is intended as a series of articles devoted to the techniques used in the development of H - Immersion.  We would like to thank <a href="https://twitter.com/Atrix256">Alan Wolf</a> for reading the article;  There are many interesting <a href="https://blog.demofox.org/">technical articles</a> on his blog.  In the following sections, we will discuss in more detail how textures and meshes are created. </div><p>Source: <a href="https://habr.com/ru/post/352970/">https://habr.com/ru/post/352970/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352958/index.html">MBO, OKR, PPR: mix but not shake</a></li>
<li><a href="../352962/index.html">Learn OpenGL. Lesson 4.10 - Instancing</a></li>
<li><a href="../352964/index.html">Issue # 17: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../352966/index.html">Program less, think more ... incrementally</a></li>
<li><a href="../352968/index.html">Conference DEFCON 22. ‚ÄúArming Your Pets. Fighting Kitty and Dog for denial of service. " Jen Brensfield</a></li>
<li><a href="../352972/index.html">From the Baltic Sea to the Indian Ocean</a></li>
<li><a href="../352974/index.html">Cryptocurrency for beginners. How to start using Bitcoin</a></li>
<li><a href="../352976/index.html">Manipulating Google search results</a></li>
<li><a href="../352978/index.html">Apache Kafka Review</a></li>
<li><a href="../352980/index.html">Never Fail Twice, or how to build a monitoring system from scratch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>