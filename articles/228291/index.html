<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development and testing of the ASCAE module</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ASCAE - Automated Energy Monitoring and Accounting Systems. The tasks of such systems include the collection of data from energy meters (gas, water, h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development and testing of the ASCAE module</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/11c/3b4/127/11c3b412717e33c59fc8ab8c43d6f6e8.png"><br><br>  ASCAE - Automated Energy Monitoring and Accounting Systems.  The tasks of such systems include the collection of data from energy meters (gas, water, heating, electricity) and the provision of these data in a convenient form for analysis and control. <br><br>  Since such systems are forced to deal with a variety of very different devices and controllers, most often they are built on a modular basis.  Not so long ago, I was asked to write a module for a similar system that communicates with one of the metering devices (a three-phase electronic energy meter <a href="http://yandex.ru/yandsearch%3Flr%3D10839%26text%3D%25D0%25A6%25D0%25AD2753">TsE2753</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  <i>In the course of the narrative, you will see comments highlighted in a similar way.</i>  <i>Their sole purpose is for you not to fall asleep in the process of getting acquainted with the article.</i> </blockquote><br><br>  I have long wanted to use automated testing.  I felt that now is an opportunity.  Why did I decide that? <br><a name="habracut"></a><br><h4>  Why is this case convenient for trying testing? </h4><br><ul><li>  The module had no user interface - only a strictly defined API, which is very convenient to test. </li><li>  The timing of the project was not too tight, so I had time to experiment. </li><li>  The system of automated power supply monitoring and measuring systems belongs to the class of industrial systems and excess reliability will not prevent it. </li></ul><br><br>  Having relied on automated testing, I actually doubled the amount of code I needed to write.  Looking ahead to say that I had to write a device emulator.  But in the end, I think it was worth it. <br><br><blockquote>  <i>One of the interesting implications was that I could lead the development without a live instrument - having only a description of its protocol.</i>  <i>The living device, of course, appeared, but after the main volume of the code was created.</i> <br></blockquote><br><br><img src="https://habrastorage.org/getpro/habr/post_images/98a/93c/cb2/98a93ccb24e47424e744f4a699a689b8.png"><br><br>  The development was carried out in the Delphi 7 environment. For automated testing, the DUnit library was used.  Version control system - Mercurial.  Repository - BitBucket. <br><br><h4>  A little more detail about the location of the module in the system. </h4><br>  The main objective of the module is to communicate with the metering device using a low-level protocol, and to provide the results of this communication in a form understandable to the AMR system.  The physical communication channel, as a rule, is a COM port with various kinds of devices that extend its functionality - modems, interface converters.  The RS-232 / RS-485 bundle is very common.  Sometimes TCP / IP is possible.  For the nuances of organizing a communication channel, special ASKUE modules ‚Äî channel drivers ‚Äî are responsible. <br><br>  As for the protocol itself, in general, it is a sequence of requests and responses in the form of a set of bytes.  Almost always requests and responses are accompanied by a checksum.  Something more definite is hard to say.  The most characteristic representative of this type of communication is the MODBUS specification. <br><br><blockquote>  <i>The MODBUS protocol is a lot of gray and dull people.</i>  <i>If you are a bright and creative person, you, of course, do not use a reliable and proven solution, but come up with your own version of the protocol.</i>  <i>And in this case, the marketing department will cautiously write in the advertising brochure so as not to scare away future buyers of the device, that the device communicates using a MODBUS-like protocol.</i>  <i>Although of course - there can be no talk of any compatibility with MODBUS.</i> </blockquote><br><br><h4>  The internal structure of the module </h4><br>  I cite the internal structure of the module, which was the result of several iterations of development and refactoring.  It can be noted that it is no different from original originality. <br><br>  The main Device object contains the code that is responsible for general actions with the device, as well as for returning the AMR data in the required format. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f09/5bd/8d5/f095bd8d59ce325a59a61d8aa7991476.png"><br><br>  The Device object owns several Onliner objects.  Each Onliner is responsible for a fully completed communication session with the device.  Different types of onlayers are responsible for various typical actions with the device.  The most common is polling a group of parameters.  In the case of my device there were six groups of parameters, each of them had its own Onliner. <br><br>  In its work, Onliner uses Query objects.  The Query object is responsible for the single request-response cycle.  The result of the Query object is a specific piece of information received from the device, reduced to a convenient form for use.  In addition, the Query object recognizes incorrect and broken instrument responses, and, if necessary, repeats the query.  This logic is hidden at the level of Query and Onliner does not worry about this. <br><br>  The lowest level are Struct objects.  They are responsible for converting various low-level byte formats to values ‚Äã‚Äãused in a programming language.  The input of the Struct object is a stream of bytes - on output - values ‚Äã‚Äãof type Integer, Float, String.  Sometimes (almost always), the Struct object has to do nontrivial things.  Thus, at the Struct level, all mathematical work on data serialization and deserialization is encapsulated.  He hides all the nuances of this hard work from higher levels. <br><br>  The diagram also highlights the CrcProcessor object.  According to his name, he is responsible for calculating the checksum.  The case is not as simple as it seems at first glance. <br><br>  Below I will dwell a little bit more on transforming data (Struct) and calculating checksums (CrcProcessor), since the topic is interesting and there is something to talk about. <br><br><h4>  Data formats in metering devices </h4><br>  It is difficult to name any method of coding information that you will not meet in the requests and responses of metering devices. <br><br>  The most innocuous is the whole type.  The whole type encodes all sorts of addresses, pointers, counters, sometimes target parameters can also be of integer type.  A specific integer type differs in length in bytes and the sequence of transmission of these bytes over the channel. <br><br><blockquote>  <i>Mathematics, or rather its carefully developed section - combinatorics, sets a strict limit on the number of permutations of objects (n!).</i>  <i>For example, three bytes can be arranged in order in just 6 ways.</i>  <i>This irresistible (if they do not turn to quantum computing) the theoretical limit is very distressing for the creators of metering protocols.</i>  <i>If 3-bytes could be sent in 20 different ways, I think sooner or later you would encounter each of them.</i> </blockquote><br><br>  Type with a fixed point - in my opinion the most successful for metering devices.  The idea is to pass an integer value through the channel, with the proviso that then the decimal point must be shifted a few bits to the left.  Very good and correctly behaving at various type conversions.  So good that it is used as a standard in banking calculations.  (If anyone knows, there is a type of Currency in VisualBasic - it is structured just this way). <br><br><blockquote>  <i>Since the basic type is a whole, one cannot relax and forget about combinatorics and the order of bytes.</i> </blockquote><br><br>  Of course, in all respects, delivering a lot of problems is a floating point type.  There is one recipe - to thoroughly understand what it means, where it is located, and what options there may be.  And again - remember about the byte order. <br><br><blockquote>  <i>Hoping that the floating-point type coincides randomly in the internal representation with one of the standard types of your platform is the height of disorder.</i>  <i>If you are visited by such thoughts, you should be engaged not in programming, but in a less risky craft - playing roulette, buying lottery tickets, betting on the World Cup.</i> </blockquote><br><br>  The most interesting options arise when trying to transmit timestamps via a communication channel.  Different parts of the date and time are transmitted in the most arbitrary formats. <br><br><blockquote>  <i>The order of the year, month, day, hour, minute, second confidently tends all to the same theoretical limit (n!).</i>  <i>You can still say a few words about the year.</i>  <i>Since the problem of 2000 has not taught anyone anything, in most cases the year is transmitted in two numbers.</i> <br></blockquote><br><br>  Very often, the stream of bytes transmitted by the protocol is a direct dump of the internal memory of various chips (timers, ADCs, ports, registers). <br><br><blockquote>  <i>The guys who create microchips know a lot about the careful use of every bit.</i>  <i>So be prepared for the fact that you have to cut and paste individual bits and sets of bits from arbitrary places, glue them together, put masks on, move in different directions and do a lot of things, without which the work of a real programmer would be a series of faceless days like Each other.</i> <i><br></i> </blockquote><br><br>  I noted most of the formats, but this is not all the details.  At any, most unexpected moment, special moves can be applied, bringing the protocol communication to a completely new level.  For example, it can be applied such exotic as BCD (binary decimal format) or the transfer of numbers by ASCII-characters.  There are cases when parts of one value are sent in different requests (for example, to get the integer part of a value, you need to send one request to the device, to get a fractional one - another). <br><br><blockquote>  <i>The only thing I didn‚Äôt meet was transfer of national symbols in UTF format.</i>  <i>But I think this is not a matter of goodwill, but of the fact that working with UTF is a resource-intensive business, and the resources of microcontrollers are limited.</i> <i><br></i> </blockquote><br><br>  If you think that all of the above is the result of my vast experience of working with several hundred instruments, you have to refute it.  Almost all of this happened to me in the metering device for which I wrote the module.  Those who do not believe, I can send a passport to the device and a description of the protocol.  You make sure that everything I wrote is true. <br><br><h4>  Checksum calculation </h4><br>  With the checksum, as I said above, is also not so simple as it might seem at first glance.  Despite the fact that there are quite well-established terms CRC8, CRC16, CRC32, they do not give a clear understanding of how the checksum should be considered.  And so there are always nuances.  The creators of communication protocols themselves know this and do not indicate a reference to the standard in the protocol description, but give a piece of code (!!!), usually to C, which shows how the checksum should be considered. <br><br>  I would not recommend making CRC calculations into shared libraries.  Even if for several cases the algorithms match, someday you will come up with an option that will completely change your understanding of the CRC count.  I advise you to make your own algorithm for each device, even if you have to go for a small Copy-Paste. <br><br><blockquote>  <i>In the case of my device, for some reason the first byte of the request should not be included in the sequence for CRC counting.</i>  <i>By great luck, I believe that I paid attention to a short note in the protocol description.</i>  <i>Because otherwise I would not have been able to establish a connection with the device.</i>  <i>Apparently, I was confronted with the activity of a sect of witnesses of an infallible first byte.</i>  <i>In another way, I can not explain all this.</i> <i><br></i> </blockquote><br><br><h4>  Module test circuit </h4><br>  I described the internal structure of the module and some features of its development; now I present a test circuit for the module.  The scheme does not repeat the structure of objects, but reflects the logical flow of information and its verification.  I think that this is the most important figure in the article and will focus on it in more detail. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a5c/98b/c86/a5c98bc866d88713e3457cb3ee39f621.png"><br><br><blockquote>  <i>At first it seemed to me that this was a rather original scheme, but then I realized that it emerged from my old institute knowledge (there were some courses in information theory).</i> <i><br></i> </blockquote><br><br>  The generator produces and remembers the reference values, the instrument pseudo-emulator accepts them and translates it into a low-level protocol.  The protocol is perceived by our module and the reference values ‚Äã‚Äãare restored from it.  Values ‚Äã‚Äãare returned to the test environment (which for the module of the device tries to look like AMR).  Then the test environment compares the values ‚Äã‚Äãobtained from the module with the reference ones.  Based on the comparison, a conclusion is made about the module's operability <br><br>  The two modules highlighted in red are for stress testing.  In particular, situations of lack of communication, interruption of communication, packet distortion can be reproduced.  The main task is to check the mechanisms of repeated requests to the device, as well as the correct allocation and freeing of memory in case of unexpected situations (this is controlled by the memory leakage control unit). <br><br><h4>  Reference Generator </h4><br>  Not very complicated, but the responsible unit - the generator of reference values.  The essence of the generator is to get the value of some parameter measured by the metering system.  This value should, on the one hand, be diverse and unpredictable (have a good distribution), and on the other hand, be deterministic (that is, reproducible, from test to test, to enable us to effectively look for errors). <br><br>  Without even thinking too much, it becomes clear that this should be a certain hash function.  After experimenting a bit with the bikes of my own models, I eventually screwed the Md5.  Claims to work, I have not arisen.  Below is the code in Delphi. <br><br><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TFECoreEmulator</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenNormalValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pTag:</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span>double; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> A,B,C,D:longint; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> TFECoreMD5Computer.Compute(A,B,C,D,pTag+FE_CORE_EMULATOR_SECURE_MIX); result:=<span class="hljs-number"><span class="hljs-number">0</span></span>; result:=result+Abs(A <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span>)/<span class="hljs-number"><span class="hljs-number">1</span></span>E3; result:=result+Abs(B <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span>)/<span class="hljs-number"><span class="hljs-number">1</span></span>E6; result:=result+Abs(C <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span>)/<span class="hljs-number"><span class="hljs-number">1</span></span>E9; result:=result+Abs(D <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span>)/<span class="hljs-number"><span class="hljs-number">1</span></span>E12; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TFECoreEmulator</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ModelValueTag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pGroupNotation, pParamNotation: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pStartTime, pFinishTime: TDateTime)</span></span></span><span class="hljs-function">:</span></span><span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> result:=pGroupNotation+<span class="hljs-string"><span class="hljs-string">'@'</span></span>+pParamNotation+<span class="hljs-string"><span class="hljs-string">'@'</span></span>+DateTimeToStr(pStartTime)+<span class="hljs-string"><span class="hljs-string">'@'</span></span>+DateTimeToStr(pFinishTime); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><br>  As a result of simple transformations, we get a normal value (0..1), which leads to the required range, and with a light heart we send to the emulator.  At any time, the value can be reproduced with absolute precision. <br><br><h4>  Pseudo emulator device </h4><br>  The main purpose of a pseudo-emulator is to generate responses to requests from the communication module with the device.  ‚ÄúPseudo‚Äù is because there is no real emulation (it would be ungrateful and useless work).  All he has to do is form concrete answers to specific requests.  In this case, if you need the values ‚Äã‚Äãof the parameters - it refers to the generator of reference values. <br><br>  There is nothing unusual in it, I will note only a special pattern of forming an answer.  The first thing that comes to mind is a kind of procedure (usually with the name Parse) of parsing the request and forming the answer.  But in practical implementation, this procedure grows to incredible sizes, with fasting case and if strongly embedded into each other. <br><br>  So I did a little differently. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6a6/211/22d/6a621122d1989be9aa556c1a77a73741.png"><br><br>  I supplied the emulator with a set of auxiliary objects ‚Äî I called them replicas.  Each replica tries to separate the request separately from the others.  As soon as she realizes that the request does not apply to her, she throws an exception, and the emulator sends the request to parse the next replica.  Thus it was possible to localize the code for each variant of the request in a separate object.  If none of the replicas worked, then there was an error somewhere, either in the instrument module or in the emulator. <br><br>  You can also see that I reused Struct objects (I taught structures how to encode and decode information) and CrcProcessor.  Of course, from the point of view of reliability, this should not be done.  But I think you will forgive me for this compromise. <br><br><blockquote>  <i>From the point of view of reliability, the common code should not be used in the tested object and test infrastructure (as the error can be mutually compensated).</i>  <i>It is desirable that different people write objects and their tests in general.</i>  <i>And it is desirable that they do not know anything about each other, and at the meeting did not greet the hand.</i>  <i>As you understand, I wrote all this alone and this methodology was not available to me.</i> </blockquote><br><br><h4>  Stress generator </h4><br>  A stress generator is included in the gap between the module and the device emulator.  He can do the following things: <br><ul><li>  Completely block emulator response </li><li>  Break the answer somewhere in the middle </li><li>  Distort any byte of response </li></ul><br>  In the event of a response breakdown, a problem arose in which place the response was interrupted.  I made the answer terminate in the most critical place - when all the headers and preambles are sent and the module waits for real data.  He should already create all auxiliary objects.  If you interrupt the transfer in this place, then there is a maximum likelihood of memory leaks. <br><br>  In the process of working with a live device, I encountered a very interesting error: the response of the device formally meets all the rules, even the checksum is the same.  But the data itself does not match the requested.  Especially for this case, I introduced another mode, which I called the internal error of the device. <br><br><blockquote>  <i>After much deliberation, how can this be, I came to the conclusion that the device simply does not control the integrity of the request.</i>  <i>And the checksum, about which so much is written in the manual, is not considered the device itself.</i>  <i>Therefore, when the request is distorted (for example, the address of the requested memory changes), the device with a pure heart forms a normal but erroneous response.</i> <i><br></i> </blockquote><br><br><h4>  Memory allocation control </h4><br>  I'll tell you a little how I tested the module for proper memory allocation.  Many things are obvious and known to everyone, but I will tell you anyway.  Maybe some of this will seem interesting. <br><br><blockquote>  <i>For a long time programmers have nightmares about memory allocation at night.</i>  <i>The invention of Java and DotNet with garbage collectors somewhat improved the situation.</i>  <i>But I think that nightmares still remain.</i>  <i>Simply, they have become more refined and sophisticated.</i> </blockquote><br><br>  Modern error handling systems that are based on the exception mechanism are an extremely useful thing.  But they greatly complicate the process of allocating and freeing resources.  This is because when an exception occurs, it interrupts the procedure.  An exception easily overcomes the boundaries of conditions, cycles, subroutines, and modules.  And, of course, the code for the release of resources, which is at the end of the procedure, will not be executed unless special measures are taken. <br><br>  The best minds of mankind were thrown to solve this problem.  As a result, the try..finally design was invented.  This construction also takes place in systems with garbage collectors, because a resource can be not only memory, but also, for example, an open file. <br><br>  The classical scheme of application in the case of - if the resource - the object looks like. <br><br><pre> <code class="delphi hljs">myObject:=TVeryUsefulClass.Create; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> ... VeryEmergenceProcedure; ... <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> myObject.Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  But I like this method more (it allows you to process all the objects involved in the code at once, and you can also create objects where and when). <br><br><pre> <code class="delphi hljs">myObject1:=<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>; myObject2:=<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> ... myObject1:=TVeryUsefulClass.Create; ... VeryEmergenceProcedure; ... myObject2:=TVeryUsefulClass.Create; ... VeryVeryEmergenceProcedure; ... <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> myObject1.Free; myObject2.Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  The recipe for proper memory management is simple - everywhere where resources are allocated and there is the possibility of exceptions - apply the try..finally scheme.  But due to inattention, it is easy to forget or do something wrong.  Therefore, it would be nice to test. <br><br>  I did as follows.  He made a common ancestor for all his objects and, when created, made them register on the general list, and when destroyed, remove himself from the list.  At the end the list is checked for undestructed objects.  This not very complicated scheme is also supplemented with some elements that help identify the object and find the place in the code where it is created.  For this, a unique label is assigned to the object, and the moments of creation and deletion are output to the trace file. <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ObjectCounter:integer; ObjectList:TObjectList; ... <span class="hljs-title"><span class="hljs-title">TFECoreObject</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> (TObject) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ObjectLabel:<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AfterConstruction</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeforeDestruction</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TFECoreObject</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AfterConstruction</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> inc(ObjectCounter); ObjectLabel:=ClassName+<span class="hljs-string"><span class="hljs-string">'('</span></span>+IntToStr(ObjectCounter)+<span class="hljs-string"><span class="hljs-string">')'</span></span> ObjectList.Add(self); Trace(<span class="hljs-string"><span class="hljs-string">'Create object '</span></span>+ObjectLabel) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TFECoreObject</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeforeDestruction</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ObjectList.Delete(self); Trace(<span class="hljs-string"><span class="hljs-string">'Free object '</span></span>+ObjectLabel) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckObjects</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i:integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i:=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ObjectList.Count-<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Trace(<span class="hljs-string"><span class="hljs-string">'Bad object '</span></span>+(ObjectList[i] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TFECoreObject).ObjectLabel); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br><blockquote>  <i>The most astute readers will say that this is already some rudimentary mechanism of the garbage collector.</i>  <i>Of course, the garbage collector is far away.</i>  <i>I think this is a good compromise.</i>  <i>I did not notice any slowdown of the code.</i>  <i>In addition, with the help of conditional compilation directives in the working assembly, this mechanism can be disabled.</i> <i><br></i> </blockquote><br><br>  The mechanism has a flaw - it does not allow to follow the creation of objects not generated by my common ancestor.  As a rule, these are standard library objects TStringList, TObjectList, etc.  I developed a rule according to which I create them only in the constructors of my objects, and I destroy them in destructors.  And the test is already monitoring its objects.  If you do everything carefully - the probability of error is minimized. <br><br>  Somewhere in 3 hours of stress testing I was able to identify all the critical places and arrange try..finally as necessary. <br><br><h4>  Accuracy of reproduction of reference values </h4><br>  I don‚Äôt know how at the time of computers, and at the time of logarithmic lines, it was considered a bad tone to throw 14 characters after a comma per person, if there are only 3 reliable ones. Therefore, in the ASKUE system, accuracy can be set for each parameter.  For all parameters it is different and is determined by the communication module with the device.  Only he knows how values ‚Äã‚Äãare formed and what acceptable accuracy can be achieved.  After the main work was completed, I decided to experiment and find out the limits of the module in terms of accuracy. <br><br><blockquote>  <i>Why did I do this?</i>  <i>Probably all a matter of natural curiosity.</i>  <i>I have seen magical things happen before my eyes.</i>  <i>The standard values ‚Äã‚Äãare packed into cunning formats unseen by anyone, and then, with a wave of a magic wand, are restored almost from the ashes.</i>  <i>And if you have a magic wand you always want to wave a little.</i>  <i>I think curiosity will ruin me someday.</i> <i><br></i> </blockquote><br><br>  So for each type of value, I began to change the allowable accuracy.  I will not describe in detail, I will tell only about one case.  I noticed that the tests began to fall, when according to my sense of stock accuracy was still enough. <br><br>  After a little investigation, I found that in several places I used Trunc to round off the simplicity of my soul.  I replaced it with Round and the marginal accuracy immediately increased by an order of magnitude. <br><br><blockquote>  <i>Friends, for rounding numbers, of course you need to use Round and RoundTo.</i>  <i>From the mathematical point of view, the Trunc function is a ridiculous, misbehaving transformation.</i>  <i>Trunc should be used only in one case, for which it was invented - separation of the whole part from the fractional.</i>  <i>In all other cases - Round.</i>  <i>Otherwise, Vos is waiting for small and sometimes big trouble.</i> <i><br></i> </blockquote><br><br><h4>  Connect to a live device </h4><br>  As I said above, I connected to the device when the main part of the work was done.  Having learned that the device needs to be connected via RS-485, I was very happy.  After all, there are only two wires.  Having a pioneer circle of radio electronics behind me, I thought that I could manage with two wires somehow.  When I tried to connect the interface converter and the device, after reading the contact designations, I found a picture that put me into a long stupor: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c82/0c3/8a9/c820c38a91a9a2282fa31a32701dff44.png"><br><br>  Realizing that from the point of view of formal logic, the situation has no solution, I decided to look into the Internet. <br><br><blockquote>  <i>I am a naive and artless person.</i>  <i>I begin each new project with faith in the triumph of good and the inviolability of standards.</i>  <i>And always comprehend me cruel disappointment.</i>  <i>The worst thing is that it repeats from time to time.</i>  <i>Life teaches me nothing.</i> <i><br></i> </blockquote><br><br>  On the Internet, it was said that A can connect both minus and plus.  It all depends on the manufacturer.  I decided that if there was such confusion, then at the wrong connection, at least nothing should burn.  I tried and so and so.  It all worked. <br><br>  Of course, the real device brought a lot of improvements to the project.  Real communication sessions put a lot in their places.  Major changes affected error handling and stress testing.  Especially when I connected to the device via wireless modems (almost every third answer came distorted). <br><br><h4>  Conclusion </h4><br><img align="right" src="https://habrastorage.org/getpro/habr/post_images/839/04e/2bc/83904e2bc1dccaf3bbdbb808db02fe7b.png" alt="Serious test"><br>  I hope you were interested in my short story about the development and testing of the metering system.  I think the most important is testing.  The quality of the product directly depends on it.  All changes made to the project and not confirmed by testing are a waste of time and effort.  After all, at the slightest code change, the untested problem will come back again and again. <br><br>  My work was inspired by the TDD (Test-Driven-Development Development through Testing) methodology.  But, of course, pure TDD did not work for me.  Here is what I did not do: <br><ul><li>  Did not write tests ahead </li><li>  Did not write tests for each class </li><li>  Did not write short tests </li></ul><br><br>  I do not know to what type of testing to relate what happened in the project - to a modular or integration.  I would say that this is the acceptance testing of the subsystem. <br><br><blockquote>  <i>I do not want to read the comments you thought I was complaining about life.</i>  <i>On the contrary, this is exactly what makes programming the most interesting thing in the world.</i>  <i>I also ask that the creators of metering devices do not take everything to heart.</i>  <i>I know that life on the other side of the interface is also interesting.</i>  <i>All my irony is directed mainly at myself.</i> </blockquote><br>  I wish you all a pleasant programming. </div><p>Source: <a href="https://habr.com/ru/post/228291/">https://habr.com/ru/post/228291/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228281/index.html">Electronic passports from 2016 throughout Russia</a></li>
<li><a href="../228283/index.html">Hydrointegrator Lukyanova</a></li>
<li><a href="../228285/index.html">IoT example: Making a bitcoin monitor from a Nokia screen, a Netduino board and a cloud</a></li>
<li><a href="../228287/index.html">Google plans to lay its own fiber optic cable across the Pacific Ocean.</a></li>
<li><a href="../228289/index.html">We distinguish the bus from the car by GPS tracks</a></li>
<li><a href="../228293/index.html">Now Bitcoin in Ukraine can be bought for cash at any of the 4000 terminals</a></li>
<li><a href="../228295/index.html">Radioisotope thermoelectric generator for Cassini: 10 years on plutonium batteries</a></li>
<li><a href="../228297/index.html">Apple has released a set of updates for its products.</a></li>
<li><a href="../228301/index.html">Console Audio Tools - a package of utilities for checking and converting audio files</a></li>
<li><a href="../228305/index.html">The determinant of the type of blocking sites at the provider</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>