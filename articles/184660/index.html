<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Images: formats and compression (2/3)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello again! After the break in the month, we continue the tour of image formats and compression algorithms. Where are we staying? Oh yes, the eightie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Images: formats and compression (2/3)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/b2a/0c1/914/b2a0c19144bca497ecab755b8e5017a3.png"><br><br>  Hello again!  After the break in the month, we <a href="http://habrahabr.ru/company/tradingview/blog/180381/">continue the</a> tour of image formats and compression algorithms.  Where are we staying?  Oh yes, the eighties. <br><a name="habracut"></a><br><h2>  TIFF: Collect yourself </h2><br>  In the yard in 1986.  PCX and TGA formats are beginning to provide spectacular lucky owners of ordinary desktops.  But the matter is not limited to home computers; there are also enterprises and universities.  And they already have powerful machines and scanners, and in the environment of scanners ... a mess and disgrace.  The task of the scanner is to convert the image to paper into a digital format, and each manufacturer had this format. <br><br>  Imagine for a moment, you are doing a scan of some Important Drawing, carry it to the printing house, and there they say that they cannot read it.  We'll have to overtake it in a different format, but it is better to just bring a photocopy for reliability.  It's a shame. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Aldus took up the solution to this problem, eventually presenting the TIFF format.  All scans were now in the same format, and even out of the box could contain several pages of a document in one file.  Plus, together with the raster data it became possible to store meta information: the name of the document, the author, the date of the scan, the model of the scanner - and almost everything. <br><br>  The format turned out to be so expandable that it is alive and well today.  And all because of the fact that Aldus rethought the very concept of a graphic format.  Instead of a fixed layer of information, relatively small structures are used from which a file can be assembled.  The author is known - insert the structure, unknown - just delete.  The use of such ‚Äútags‚Äù, in fact, was played up in the very name of the format: ‚ÄúTagged Image File Format‚Äù. <br><br>  <em>The downside of such extensibility, however, has become the exorbitant swelling of the specification.</em>  <em>Attempts by Aldus (and then Adobe, which bought it) to embrace the immense, have affected the enthusiasm of other developers not for the better.</em> <br><br><h2>  Format for sharing images </h2><br>  The new TIFF format, possessing elegant advantages, was only suitable for printing: the first revision provided for only black and white images without semitones.  And in 1987, VGA graphics cards with a palette of up to 256 colors appeared.  TGA and PCX (with dopilivanii) allowed to store the notorious 256 colors, but the file size doubled, and even more - a simple RLE on the large palette worked much worse. <br><br>  To estimate the scale, take a full-screen VGA image (320 √ó 200 @ 256) in PCX format - about 50 <abbr title="kibibayt, see wikipedia for details">KiB</abbr> , plus or minus.  Now we will try to transmit it using a fast, 9600 baud, dayl-up modem, and we‚Äôll get loading time in about a minute.  Not cool.  CompuServe seemed to be doing just that, making money by giving access to its BBS in sunny Columbus, Ohio. <br><br>  But how can you get out of this situation?  You can technically, cut out the extra fields, not put unnecessary, and use a powerful compression algorithm.  You can use humanitarian savvy, and show something similar to the picture before it is fully loaded, and then it will be subjective to the user to think that everything is loading faster. <br><br>  Both of these approaches and combined in the format of GIF ("Graphics Interchange Format").  And now more. <br><br><h2>  GIF: Structure </h2><br>  To find out what a GIF can do and how it works, crawl into the documentation.  Previously, the format was patented, but these patents expired a dozen years ago, and everything is kept in open access. <br><br><img src="https://habrastorage.org/storage2/cdc/af7/493/cdcaf74936b08c402789874e4d61bf92.png"><br><br><h3>  Headline </h3><br>  The first six bytes of the file are the header.  It consists of the signature ‚Äú <code>GIF</code> ‚Äù and the version: ‚Äú <code>87a</code> ‚Äù or ‚Äú <code>89a</code> ‚Äù, where 87 and 89 are the years in which they were developed.  Version 89a extends 87a and is fully backward compatible with it.  The specification requires 87a to be used whenever possible, but personally I would not advise it - browsers work crookedly with 87a.  As a demonstration, run a bit ahead and show the focus: <br><br><img src="https://habrastorage.org/storage2/847/69e/245/84769e245e5fae27776569d3a7bb112b.gif"><br><br>  What is shown in the picture?  If one square, then you have Firefox or Chrome.  If two, then IE.  If three, then Opera (which is still on Presto). <br><br><h3>  Logical screen description block </h3><br>  The logical screen is just a rectangular area, selected for displaying graphics, within the meaning of something like a <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2580%25D1%2582_%25D0%25BF%25D1%2580%25D0%25BE%25D1%2581%25D0%25BC%25D0%25BE%25D1%2582%25D1%2580%25D0%25B0">viewing port</a> .  GIF can contain several images, and they can be smaller in size than the logical screen.  Moreover, in GIF87a, these images are not animation frames, but rather layers. <br><br>  In other words, if you need to draw 800 √ó 600 in the middle of the kitten in the middle, and a flower in the corner, then instead of one huge ‚Äúflattened‚Äù image, you can store the kitten and the flower with their shifts relative to the logical screen. <br><br>  <em>A small disclaimer.</em>  <em>Despite the fact that at the intuitive level the gif itself (arrgh ... well, ‚Äújiffy‚Äù) is a picture that is shown on the screen, we will adhere to the terminology specified in the specification: ‚Äúlogical screen‚Äù is the size of the entire GIF'k, and the ‚Äúimage‚Äù is a layer / frame.</em> <br><br>  So, the block of the description of the logical screen always takes 7 bytes.  The first dimensions are two bytes in width and two bytes in height (UInt16LE).  It turns out, the maximum size is 65535 √ó 65535 pixels.  The specification does not indicate that the width or height must be greater than zero, but the realization of this does not give us anything, except perhaps curiosity. <br><br>  Here you should make an important note: if the GIF file is version 87a, Firefox and Chrome always ignore this field and use the size of the first image as the logical screen size.  Opera and IE do the same only if the coordinates of the first image are zero. <br><div class="spoiler">  <b class="spoiler_title">Demo:</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/974/327/74e/97432774e9a3e72793c2b7b9ffb8dbc4.gif"><img src="https://habrastorage.org/storage2/10b/734/77b/10b73477b3f86d2eb14728009edda4ff.gif"><br>  Files are identical, except for the version - on the left 87a, on the right 89a.  They are the same in Opera and IE, not in Firefox and Chrome.  Because of the vertical alignment on Habr√©, this is not very noticeable; the sizes of these pictures are different. <br></div></div><br>  This is followed by a single byte containing several fields.  The seventh bit (most significant) indicates whether there is a global palette, and bits 0 through 2 define its size (from 2 <sup>1</sup> to 2 <sup>8</sup> ).  The remaining 4 bits after years of age have lost their meaning. <br><br>  The next field is one byte, indicating the background color in the global palette (if used).  This color should be filled with all areas of the logical screen that are not occupied by any of the images.  In theory.  In practice, this requirement is fulfilled only by Photoshop and IrfanView.  Common browsers leave unallocated space transparent.  And Opera 12 has an interesting label: if the GIF is version 87a, and it contains more than one image, this empty space is filled with black. <br><br>  The last byte of the description of the logical screen contains information about the proportions of pixels.  Browsers ignore this parameter, and all pixels are considered square. <br><div class="spoiler">  <b class="spoiler_title">Demo:</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/a34/811/eba/a34811ebaa537e98349d6905cc36a2c2.gif"><br>  There should be a circle, but instead an ellipse is displayed.  So that you do not think that I am cheating, try opening this file in Photoshop. <br></div></div><br><h3>  Global palette </h3><br>  If the global palette checkbox is set to 0, it simply does not exist.  And if there is, then the size of the entire block in bytes is equal to the number of colors in the palette multiplied by three.  Filling principle: RGB RGB RGB ..., just like in PCX. <br><br>  A global palette is applied to each image in the file, if it does not have a local palette.  And if there is neither one nor the other?  Speke on this occasion says "uh ... well, I don‚Äôt know, figure it out somehow," and suggests using the standard palette of the device, but it is desirable that the first color in it be black and the second white.  In 2013, everyone has already forgotten what a standard device palette is, and this trick most often fails. <br><div class="spoiler">  <b class="spoiler_title">Demo:</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/4eb/729/591/4eb729591c7348472d37df68d1f2532e.gif"><br>  File without palette.  In Firefox, Chrome and old IE, we see a black rectangle, in Opera - a transparent one.  Photoshop believes that the palette is 256-color greyscale.  And here, IE10 and IrfanView follow the recommendations of the specs, and the image is easy to read. <br></div></div><br>  At this point, the mandatory, fixed format fields end, and the optional fields begin. <br><br><h3>  Picture </h3><br>  Here the raster data itself and its location relative to the logical screen are stored.  The file can be any number of images - from zero to infinity. <br><br>  It is from scratch!  Speke quite admits that there are no images in the file at all.  For example, if you just need to initialize the global palette on the device.  But the current browsers do not understand these subtleties, and consider in such cases that the file is ‚Äúbroken.‚Äù <br><br>  The image begins with a marker, an ASCII character " <code>,</code> " (comma).  This marker is needed in order to understand which structure has now begun: an image (‚Äú <code>,</code> ‚Äù), an extension block (‚Äú <code>!</code> ‚Äù), Or a file end block (‚Äú <code>;</code> ‚Äù). <br><br>  This is followed by four two-byte integers: two coordinates of the position of the left upper edge of the image relative to the logical screen and the width / height of the image itself.  According to the specification, the lower right edge of the image should not go beyond the logical screen. <br><br>  Next, bytes with packed fields.  The most significant bit: does the image have a local palette, three low ones: what size, approximately the same as in the description of the logical screen.  The 6th bit is responsible for the scanning order: line by line (progressive) or interlaced (interlaced).  I think it‚Äôs not necessary to describe how the download of an interlaced image looks like, I‚Äôve seen it a thousand times, but just in case, here‚Äôs a <a href="http://nuwen.net/png.html">smart article with pictures</a> . <br><br>  After that, as in the description of the logical screen, a local palette should immediately follow if there is one. <br><br>  <em>By the way, since we were talking, you guessed it, how can you display more than 256 colors on one logical screen of GIF?</em> <br><br>  The next byte is the size of the LZW codes.  In the LZW compressed data stream, the length of the initial dictionary is not specified, and it must be specified separately.  But we will come back to this. <br><br><h3>  Packing data of arbitrary length </h3><br>  Then in the image are directly compressed LZW data.  But they are not stored by simple data bursts with the specified length, but are packed into blocks.  (Apparently, to avoid arbitrary IO and excessive memory consumption when encoding.) Packing principle: one byte of block length, n data bytes, one byte of block length, n data bytes, and so on, until the data runs out.  And at the end of the data indicates a block of length 0. <br><br>  For example, a well-known pangram about a quick fox can be packaged like this: <br><br>  <b><u><code>\x2B</code></u></b> <code>The quick brown fox jumps over the lazy dog</code> <b><u><code>\x00</code></u></b> <br><br>  And it is possible and in another way, we will spend for one byte more, but it will not be considered as an error: <br><br>  <b><u><code>\x20</code></u></b> <code>The quick brown fox jumps over t</code> <b><u><code>\x0B</code></u></b> <code>he lazy dog</code> <b><u><code>\x00</code></u></b> <br><br>  In general, it is generally possible to use at least one byte per block, then the packed data will be twice as large as the original.  And from the loaf of white (or black) bread you can make a trolley bus. <br><br><h3>  Extensions </h3><br>  The attentive reader has probably noticed that neither in the image description, nor in the description of the logical screen, has there been a GIF ‚Äúbuns‚Äù proper: transparency and animation.  This is because they were introduced in version 89a as an extension block. <br><br>  There are four types of extension blocks: graphics control extension, text extension, comment and application extension.  All blocks are optional, making the GIF89a format backward compatible with 87a. <br><br><h4>  Graphics management extension </h4><br>  This extension is essentially a set of additional fields for the image that immediately follows it.  In fact, it turns the vaguely described concept of ‚Äúimage‚Äù into a very specific ‚Äúframe‚Äù.  Of the fixed fields, only two byte markers: <code>0x21</code> , ‚Äúthis is an extension‚Äù and <code>0xF9</code> , ‚Äúthis is an extension of the graphics control‚Äù. <br><br>  Further fields are packed in the same way as raw image data - block length, n bytes, block length, n bytes.  It is a different matter that, according to the specification, it is always one block 4 bytes long.  Why in general it was necessary to break into blocks - I didn‚Äôt even want to figure it out, apparently, it was easier. <br><br>  Anyway, the first of these four bytes is a set of bit fields.  The three bits are reserved.  Then three bits, forming a whole from 0 to 7, indicate what should be done with the frame before showing the next one.  0: nothing (not defined);  1: nothing (leave everything as it is);  2: clear the screen;  3: to return what was before this frame;  values ‚Äã‚Äã4-7 are reserved. <br><br>  Bit 1 - the most interesting from a historical point of view.  Whether to wait from the user ‚Äúany key‚Äù in order to show the frame following this.  Yes, yes, on the basis of GIF it was possible to make not only a slideshow, but also quite a presentation.  Now this feature is not actually supported. <br><div class="spoiler">  <b class="spoiler_title">But if you still want to check</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/781/ce1/307/781ce130722e703b9dff3c378040f7f2.gif"></div></div><br>  The lower bit indicates whether any of the colors in the palette is considered transparent. <br><br>  The next two bytes form UInt16, indicating how many hundredths of a second you need to wait before showing the next frame.  Thus, the delay can be in the range from 0 to 655.35 seconds. <br><br>  Finally, the last byte is the index of the ‚Äútransparent‚Äù color in the palette (if it was indicated above that it exists). <br><br><h4>  Application extension </h4><br>  This extension is designed to allow applications to write their proprietary metadata to the GIF.  The format is already familiar: two bytes of a marker-signature, <code>0x21 0xFF</code> , the rest is blocks with an indication of the length in front of them.  And again the length of the first block is strictly fixed: 11 bytes, which identify the application.  Subsequent blocks can be of any length and contain anything. <br><br>  One such extension was invented by the Netscape Navigator browser.  The fact is that the GIF format itself does not provide for the animation cycle, and with the help of the proprietary extension " <code>NETSCAPE2.0</code> " you can specify how many times the animation is scrolled: from 1 to 65535 times or infinitely. <br><br>  Now all browsers understand this construction, and if it is not there, it is considered that the animation is not looped. <br><br>  The rest of the application extensions in order to reduce the file size can safely mow. <br><br><h4>  Text extension </h4><br>  This extension is necessary in order to draw any text on the logical screen.  Specify the size of the glyphs in pixels, the size of the text field, the position relative to the logical screen, and voila!  You can not just a slideshow or a presentation, but generally make a visual novel. <br><br>  But alas, there is no real support for this expansion.  In nature, this species does not occur, crossed out of the red book.  And we go further. <br><br><h4>  Comment </h4><br>  The last extension is the simplest.  Two byte markers <code>0x21 0xFE</code> , and then arbitrary content, packed in blocks. <br><br><h3>  Closing block </h3><br>  The trailing unit (‚Äútrailer‚Äù) consists of a single byte <code>0x3B</code> (‚Äú <code>;</code> ‚Äù).  It is located at the end of the file and means that in this place, in fact, the end of the file.  Everything after it is considered garbage and is ignored. <br><br>  This construction according to the specification is obligatory, do not forget about it. <br><br>  <em>Whew!</em>  <em>It seems that everything is structured.</em>  <em>Honestly, I myself expected it to be easier.</em>  <em>If you suddenly have any misunderstandings, due to the style of the presentation or the translation of the terms, you can familiarize yourself with the <a href="http://www.w3.org/Graphics/GIF/spec-gif89a.txt">official specification GIF89a</a> .</em>  <em>I also strongly recommend the <a href="http://progland.org/gif_opener.php">GIF opener</a> program, it‚Äôs a hundred years old at lunchtime, but I‚Äôve never seen anything better for low-level gif editing.</em> <br><br><h2>  Lempel-Ziva-Welch Algorithm </h2><br>  Now that we‚Äôve seen the neighborhood, we‚Äôll go to the very heart of GIF ‚Äî the Lempel-Ziv-Welch algorithm, aka LZW.  First of all, it is worth noting that this algorithm is <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4_%25D1%2581%25D0%25B6%25D0%25B0%25D1%2582%25D0%25B8%25D1%258F_%25D1%2581_%25D0%25B8%25D1%2581%25D0%25BF%25D0%25BE%25D0%25BB%25D1%258C%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5%25D0%25BC_%25D1%2581%25D0%25BB%25D0%25BE%25D0%25B2%25D0%25B0%25D1%2580%25D1%258F">vocabulary</a> .  Let's see what that means. <br><br><h3>  Compression with a dictionary, a simple example </h3><br>  Dictionary compression is a direct development of the idea of ‚Äã‚ÄãRLE.  In general, the principle is as follows: we look for duplicate values ‚Äã‚Äãand enter them into the dictionary, and then in the right place make an indication of the element of the dictionary.  Thus, not only the same values ‚Äã‚Äãin a row are compressed, but also groups of different values, between which there can be a certain distance. <br><br>  For example, take the following line: <br><br> <code>  </code> <br> <br>  It can be seen that it is directly stuffed with repetitive " <code></code> ".  Choose some unused symbol, for example, ‚Äú <code>1</code> ‚Äù and say that any such encountered symbol should be replaced with ‚Äú <code></code> ‚Äù.  As a result, we get the string ‚Äú <code>11  11</code> ‚Äù, half as much.  And so that someone other than us could understand what this encryption will read, you need to remember to write the dictionary itself, that is, what exactly you need to replace " <code>1</code> "  The result will be something like: <br><br> <b><code>1=;</code></b> <code>11  11</code> <br><br>  You can go a little further, and replace ‚Äú <code>1</code> ‚Äù with ‚Äú <code>2</code> ‚Äù: <br><br> <b><code>1=,2=1;</code></b> <code>11  22</code> <br><br>  Hmm ... it seems that we replaced more duplicate values, and the string was longer.  Alas, the dictionary also needs to be stored, and the more it is, the greater the overhead. <br><br>  Of course, they are trying to fight this somehow.  For example, the LZ77 algorithm is formally considered to be a dictionary, but the decoded data itself acts as a dictionary - the decoder is given the command to go back n bytes and copy m bytes from there.  You can read more about LZ77 in <a href="http://habrahabr.ru/post/141827/">this article</a> by the author of the respected <a href="https://habrahabr.ru/users/horror_x/" class="user_link">horror_x</a> . <br><br>  In LZW, the ‚Äúdescendant‚Äù LZ77, dictionary entries also appear as they are decoded, but this is no longer just copying with offset, but a full-fledged dictionary. <br><br><h3>  LZW: General Coding Principle </h3><br>  For example, take the same line, " <code>  </code> ." <br><br>  Now you need to choose the encoding of this line.  The use of multibyte encoding will greatly complicate the example, so who will lay down UTF-8 on the spot.  The dust of seven-bit encodings, such as KOI-7 H1 (GOST 13052-74), will not be disturbed.  Choose some eight-bit, for example, everyone's favorite CP866. <br><br>  Thus, the original dictionary will be identical to the CP866: <br><br><pre>  00000000 &lt;nul&gt;
 00000001 &lt;SOH&gt;
 ...
 10,000,000 A
 10000001 B
 ...
 10011111 I
 ...
 11111111 &lt;nbsp&gt; </pre><br>  This dictionary is already full, and nothing will be added to it.  But in LZW, the dictionary should always be able to add a new entry.  As soon as the previous code length begins to be missed for this, it needs to be increased: <br><br><pre>  000000000 &lt;nul&gt;
 ...
 011111111 &lt;nbsp&gt; </pre><br>  Now, seven bits are used to indicate the index of the dictionary (this is the ‚Äúcode length‚Äù).<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, when they say something like ‚ÄúLZW with a code length of 8‚Äù, we mean the length of the codes of the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initial</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dictionary, and we start coding with the length of the codes one unit longer. </font><font style="vertical-align: inherit;">A little confusing, but so it is. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The line begins with the capital "A". </font><font style="vertical-align: inherit;">It corresponds to the binary value in the dictionary </font></font><code>010000000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We write out the bits directly, LZW works directly with the bits, and the fact that a byte is usually 8 bits does not matter for this algorithm.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And 010000000 (we add nothing to the dictionary) </font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next letter is ‚ÄúB‚Äù. </font><font style="vertical-align: inherit;">Similarly, we enter it, but now along with this we add a new entry to the dictionary: the previous encoded string plus the first character of this one. </font><font style="vertical-align: inherit;">The last line was ‚ÄúA‚Äù, this one is ‚ÄúB‚Äù, and its first character, respectively, ‚ÄúB‚Äù.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B 010000001 | </font><font style="vertical-align: inherit;">add to the dictionary AB = 100000000</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We continue further: </font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 010010000 | </font><font style="vertical-align: inherit;">Br = 100000001</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And 010000000 | </font><font style="vertical-align: inherit;">RA = 100000010</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K 010001010 | </font><font style="vertical-align: inherit;">AK = 1,000,00011</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And 010000000 | </font><font style="vertical-align: inherit;">KA = 100000100</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D 010000100 | </font><font style="vertical-align: inherit;">BP = 100000101</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then it would be possible to write down ‚ÄúA‚Äù in the same way, but we already have ‚ÄúAB‚Äù in the dictionary! </font><font style="vertical-align: inherit;">We use it. </font><font style="vertical-align: inherit;">And do not forget that only the first letter goes to the new dictionary entry.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AB 100000000 | </font><font style="vertical-align: inherit;">YES = 100000111</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RA 100000010 | </font><font style="vertical-align: inherit;">ADB = 100001000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;SP&gt; 000100000 | </font><font style="vertical-align: inherit;">RA &lt;SP&gt; = 100001001</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From 010010001 | </font><font style="vertical-align: inherit;">&lt;SP&gt; C = 100001010</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;SP&gt; 000100000 | </font><font style="vertical-align: inherit;">C &lt;SP&gt; = 100001010</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
X 010010101 | </font><font style="vertical-align: inherit;">&lt;SP&gt; X = 100001011</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now the jackpot! </font><font style="vertical-align: inherit;">We already have ‚ÄúADB‚Äù in the dictionary, and we can insert three letters at once in one letter. </font><font style="vertical-align: inherit;">Choosing the longest matching line from the dictionary seems like a damn good idea.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADB 100001000 | </font><font style="vertical-align: inherit;">HA = 100001100</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And 010000000 | </font><font style="vertical-align: inherit;">ABRA = 100001101</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HA 100001100 | </font><font style="vertical-align: inherit;">AH = 100001110</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BR 100000001 | </font><font style="vertical-align: inherit;">HUB = 100001111</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And 010000000 | </font><font style="vertical-align: inherit;">ARB = 100010000</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now all received bits (from the second column) are written out in a line, grouped by 8 bytes and ready. </font><font style="vertical-align: inherit;">Instead of 24 √ó 8 = 192 bits, we got 18 √ó 9 = 162 bits. </font><font style="vertical-align: inherit;">15% of the savings, despite the fact that RLE would not remove a single bit here.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Greed is bad </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the description of the algorithm, it is indicated that when encoding, a string of the greatest length should be selected from the dictionary. </font><font style="vertical-align: inherit;">But as the song about the boy Billy from Treasure Island teaches, greed is not the best option. </font><font style="vertical-align: inherit;">Take the previous example and roll back a little bit:</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A 010000000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B 010000001 | </font><font style="vertical-align: inherit;">AB = 100000000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 010010000 | </font><font style="vertical-align: inherit;">Br = 100000001</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And 010000000 | </font><font style="vertical-align: inherit;">RA = 100000010</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K 010001010 | </font><font style="vertical-align: inherit;">AK = 1,000,00011</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And 010000000 | </font><font style="vertical-align: inherit;">KA = 100000100</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D 010000100 | </font><font style="vertical-align: inherit;">BP = 100000101</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AB 100000000 | </font><font style="vertical-align: inherit;">YES = 100000111</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RA 100000010 | </font><font style="vertical-align: inherit;">ADB = 100001000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;SP&gt; 000100000 | </font><font style="vertical-align: inherit;">RA &lt;SP&gt; = 100001001</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From 010010001 | </font><font style="vertical-align: inherit;">&lt;SP&gt; C = 100001010</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;SP&gt; 000100000 | </font><font style="vertical-align: inherit;">C &lt;SP&gt; = 100001010</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
X 010010101 | </font><font style="vertical-align: inherit;">&lt;SP&gt; X = 100001011</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ADB 100001000 | </font><font style="vertical-align: inherit;">HA = 100001100</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And 010000000 | </font><font style="vertical-align: inherit;">ABRA = 100001101</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this place, we are going to go against greed and choose from the dictionary not ‚Äú </font></font><code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äù a shorter string, ‚Äú </font></font><code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äù:</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X 010010101 | </font><font style="vertical-align: inherit;">AH = 100001110</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ABRA 100001101 | </font><font style="vertical-align: inherit;">HA = 100001111</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now the length of the encoded message is 17 √ó 9 = 153 bits, the difference is about 5%. </font><font style="vertical-align: inherit;">But we manually collected the file, but how to determine algorithmically, not to be led by greed? </font><font style="vertical-align: inherit;">In the forehead will not work: the complexity of brute force exponential. </font><font style="vertical-align: inherit;">So, as they say in all sorts of smart books, I will leave this to the reader for consideration. </font><font style="vertical-align: inherit;">Maybe another Turing award.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Compression of the same values </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let us now try to compress a primitive string consisting only of the letters "A". </font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A | </font><font style="vertical-align: inherit;">AA</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AA | </font><font style="vertical-align: inherit;">AA</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AA | </font></font> AAA<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AAA | </font></font> AAA
 ... </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Somehow not very efficient, the dictionary is clogged with duplicates. </font><font style="vertical-align: inherit;">But in this case, a cunning device is provided in LZW. </font><font style="vertical-align: inherit;">In the second line, we add to the dictionary " </font></font><code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">", although this entry would be useful to us right on the spot. </font><font style="vertical-align: inherit;">Actually, this is how we can do:</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AA | </font><font style="vertical-align: inherit;">AA</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AAA | </font></font> AAA
 ... </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the definition of a new record, only the first character to be encoded is relevant. </font><font style="vertical-align: inherit;">We know him for sure, this is " </font></font><code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">". </font><font style="vertical-align: inherit;">Therefore, we </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> add a new entry to the dictionary, and </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">then</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> look for the string with the longest length in it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This approach works not only with the same letters, but also with longer sequences:</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B | </font><font style="vertical-align: inherit;">AB</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AB | </font><font style="vertical-align: inherit;">BA</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ABA | </font><font style="vertical-align: inherit;">ABA</font></font><font></font>
 ... </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You may wonder how the decoder will behave if they say to him: ‚Äúnow insert the seventh entry‚Äù, and he has only six of them in the dictionary. </font><font style="vertical-align: inherit;">It's okay, he is trained in such things and will understand without problems.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LZW to GIF </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, on cats have trained, now turn to real action. Create a GIF with such a simple image. </font></font><br><br><img src="https://habrastorage.org/storage2/842/3d1/a01/8423d1a01259a2939e2c6b18c9718fa9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For convenience, increased by 8 times, these sizes: 11 √ó 6 pixels, the height of each strip is 2 pixels. </font></font><br><br> <em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Whose flag is it? No one's Just three horizontal stripes. But if it‚Äôs more convenient, you can consider this as the flag of the RGB Sovereign Color Model.</font></font></em> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The size of the palette is chosen exactly the same as in PCX - as small as possible. In the image there are only three colors, so we will use a palette of 4 colors. Let me remind you that for LZW the order of colors in the palette does not matter, only the length of the codes. The image in the file will be one, so it doesn‚Äôt matter to us whether this is a local palette or a global one. Let it be global.</font></font><br><br><img src="https://habrastorage.org/storage2/e82/894/267/e82894267f6e07ccd1aaf618c3aa4297.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will not use interlace, we will choose the pixels simply from left to right, top to bottom. </font><font style="vertical-align: inherit;">The size of the logical screen is 11 √ó 6, the image size is the same, the size of the codes is 2 bits, let's go! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compiled dictionary:</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 00 R (palette index 0)</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
01 G (palette index 1)</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10 B (palette index 2)</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
11 (palette index 3) </font></font></pre><br> <em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, of course, LZW has no idea about a particular color, and encodes only its number in the palette. </font><font style="vertical-align: inherit;">But then there will be so many numbers in the listing that we risk confusing them, so I‚Äôll mark them as ‚ÄúR‚Äù, ‚ÄúG‚Äù and ‚ÄúB‚Äù. </font></font></em> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's not all. </font><font style="vertical-align: inherit;">We add the special value ‚ÄúClear Code‚Äù to the dictionary. </font><font style="vertical-align: inherit;">It does not encode anything, only instructs the decoder to reset the dictionary to the initial state. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The dictionary also has another special meaning ‚ÄúEnd of Information‚Äù, which indicates that the compressed stream has ended. </font><font style="vertical-align: inherit;">Why is it needed? </font><font style="vertical-align: inherit;">Suppose that a single dictionary entry takes 4 bits, and there is an encoded value " </font></font><code>00010010 00110000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">". </font><font style="vertical-align: inherit;">It is not clear whether this is decoded as </font></font><code>1 2 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, or as </font></font><code>1 2 3 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the EoI code indicates the end of the stream with bit accuracy, and the problem disappears.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> So, the initial dictionary here looks like this: </font></font><br><br><pre> 000 R (  0)<font></font>
001 G (  1)<font></font>
010 B (  2)<font></font>
011 (  3)<font></font>
100 &lt;CC&gt;<font></font>
101 &lt;EoI&gt;<font></font>
</pre><br>     <code>CC</code> .   .     -  ,  , ,        . <br><br><pre> 100 &lt;CC&gt; | </pre><br> <em>      , .     -     ,     .           ( -    ).    .</em> <br><br>    .   PCX        0  3    ,   GIF    . <br><br><pre> 000 R | </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Further, the technique described above: use the dictionary entry at the same time as adding it. </font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">110 RR | </font><font style="vertical-align: inherit;">RR = 110</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
111 RRR | </font><font style="vertical-align: inherit;">RRR = 111</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The dictionary is full, and it needs to be increased by one bit. </font><font style="vertical-align: inherit;">The next entry will occupy 4 bits.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000 RRRR | </font><font style="vertical-align: inherit;">RRRR = 1000</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 pixels are coded, and in one scanline 11. But in GIF there are no limitations associated with scanlines - all pixels are ‚Äústretched to the line‚Äù, and are encoded as one big sequence. </font><font style="vertical-align: inherit;">If we used interlace, then the next one would take the blue band, which, of course, would not have a positive effect on compression.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1001 RRRRR | </font><font style="vertical-align: inherit;">RRRRR = 1001</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1010 RRRRRR | </font><font style="vertical-align: inherit;">RRRRRR = 1010</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21 red pixel encoded, left alone. </font><font style="vertical-align: inherit;">This time the pixel is encoded with four bits. </font><font style="vertical-align: inherit;">Despite the fact that the entry " </font></font><code>RR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" in the dictionary already exists, we add it again.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0000 R | </font><font style="vertical-align: inherit;">RRRRRRR = 1011</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We continue the same way with green pixels. </font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0001 G | </font><font style="vertical-align: inherit;">RG = 1100</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1101 GG | </font><font style="vertical-align: inherit;">GG = 1101</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1110 GGG | </font><font style="vertical-align: inherit;">GGG = 1110</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1111 GGGG | </font><font style="vertical-align: inherit;">GGGG = 1111</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Again, increase the length of the codes. </font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10,000 GGGGG | </font><font style="vertical-align: inherit;">GGGGG = 10,000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10001 GGGGGG | </font><font style="vertical-align: inherit;">GGGGGG = 10001</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
00001 G | </font><font style="vertical-align: inherit;">GGGGGGG = 10010</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
00010 B | </font><font style="vertical-align: inherit;">GB = 10011</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10100 BB | </font><font style="vertical-align: inherit;">BB = 10100</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10101 BBB | </font><font style="vertical-align: inherit;">BBB = 10101</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10110 BBBB | </font><font style="vertical-align: inherit;">BBBB = 10110</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10111 BBBBB | </font><font style="vertical-align: inherit;">BBBBB = 10111</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
11000 BBBBBB | </font><font style="vertical-align: inherit;">BBBBBB = 11000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
00010 B | </font><font style="vertical-align: inherit;">BBBBBBB = 11001</font></font><font></font>
</pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Finally, specify the end of data marker. </font></font><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 00101 &lt;EoI&gt; | </font></font></pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, the received bits are packed in eight pieces per byte, from the youngest to the oldest. </font><font style="vertical-align: inherit;">From the sequence </font></font><code>(100) (000) (110) (111) (1000) ‚Ä¶</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we get:</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10) (000) (100) = 0x84</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(1000) (111) (1 = 0x8F</font></font><font></font>
 ... </pre><br>    13         ( <code>0x0D</code> = 13)  <code>0x00</code>  ,  ,   . <br><br>  , ,  : <img src="https://habrastorage.org/storage2/663/0eb/0ad/6630eb0ad0521e971eded1242c56956f.gif">  . , . <br><br><h3>   </h3><br><br>  ,  ,           25 ,   ‚Äî 31,     35.   ,    ,     . <br><br>   ,      ,   ¬´¬ª    ‚Äî    .          ,      ,      . <br><br>     : <br><br><pre> 100 &lt;CC&gt; |<font></font>
000 R |<font></font>
110 RR | RR = 110<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
111 RRR | </font><font style="vertical-align: inherit;">RRR = 111</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1000 RRRR | </font><font style="vertical-align: inherit;">RRRR = 1000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1001 RRRRR | </font><font style="vertical-align: inherit;">RRRRR = 1001</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1010 RRRRRR | </font><font style="vertical-align: inherit;">RRRRRR = 1010</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0000 R | </font><font style="vertical-align: inherit;">RRRRRRR = 1011</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We reset the dictionary, and continue coding. </font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0100 &lt;CC&gt; | </font><font style="vertical-align: inherit;">(dictionary reset)</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
001 G |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
110 GG | </font><font style="vertical-align: inherit;">GG = 110</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
111 GGG | </font><font style="vertical-align: inherit;">GGG = 111</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1000 GGGG | </font><font style="vertical-align: inherit;">GGGG = 1000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1001 GGGGG | </font><font style="vertical-align: inherit;">GGGGG = 1001</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1010 GGGGGG | </font><font style="vertical-align: inherit;">GGGGGG = 1010</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0001 G | </font><font style="vertical-align: inherit;">GGGGGGG = 1011</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Once again. </font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0100 &lt;CC&gt; | </font><font style="vertical-align: inherit;">(dictionary reset)</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
010 B |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
110 BB | </font><font style="vertical-align: inherit;">BB = 110</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
111 BBB | </font><font style="vertical-align: inherit;">BBB = 111</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1000 BBBB | </font><font style="vertical-align: inherit;">BBBB = 1000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1001 BBBBB | </font><font style="vertical-align: inherit;">BBBBB = 1001</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1010 BBBBBB | </font><font style="vertical-align: inherit;">BBBBBB = 1010</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0010 B | </font><font style="vertical-align: inherit;">BBBBBBB = 1011</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0101 &lt;EoI&gt; | </font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It turned out 90 bits, and the total file size was reduced from 52 to 51 bytes, despite the fact that it remained readable: </font></font><img src="https://habrastorage.org/storage2/90e/00e/3e2/90e00e3e24f8def027d47e6115756585.gif">  .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And, by the way, gifsicle, the number one tool for compressing GIF, cannot be compressed anymore. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, you can see that all three bands were coded almost the same. </font><font style="vertical-align: inherit;">For LZW, there is no difference between ‚Äú </font></font><code>0x00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22 times‚Äù and ‚Äú </font></font><code>0x02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22 times‚Äù, and you can choose any arrangement of colors in the palette.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Non-standard </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A little bit of freaking. </font><font style="vertical-align: inherit;">The dictionary reset code (‚ÄúCC‚Äù) at the very beginning of the stream does not affect anything. </font><font style="vertical-align: inherit;">And the end-of-stream code (‚ÄúEoI‚Äù) is, in general, not needed - if there is any data left in the tail of a byte, they will already be outside the image. </font><font style="vertical-align: inherit;">Cutting them out, we can shrink the image even more, up to 50 bytes, and it will be displayed normally in browsers:</font></font><img src="https://habrastorage.org/storage2/f33/bbe/f12/f33bbef128d1c2162fbe6ee1965f6853.gif">  . <br><br> <em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are a happy owner of a browser in which it is not shown, please write in the comments. </font></font></em> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But there is one thing, and this ‚Äúbut‚Äù is fundamental: it is a violation of the specification. </font><font style="vertical-align: inherit;">Is it worth the savings of one byte - decide for yourself.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Animated gif </font></font></h2><br>   , ,    GIF.      PNG  . ,  ,      PNG ¬´ ¬ª: APNG    W3C,     ;   W3C' MNG  .     GIF   . <br><br>  .      <abbr title="0.01 s.  The second is a SI unit, so I have every right"></abbr> ,         .   .       ,    . <br><br><h3>  Composition </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here you should start with the main thing: if on the 800 √ó 600 logical screen with a new frame only a 2 √ó 2 square has changed, then it makes sense to make a 2 √ó 2 frame, and not 800 √ó 600. I think this is logical. But, alas, not all image processing programs are bothered by such an analysis, and the lion‚Äôs share of GIF optimization comes from correcting this trivial error. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now to the details, namely to the Disposal Method field of image expansion, which indicates what to do with the frame before showing a new one. I repeat a little: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Values ‚Äã‚Äã0 and 1 with different formulations indicate to the renderer to do nothing. Ie, draw the pixels of the next frame directly on top (except for transparent ones, of course).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Value 2 - before displaying a new frame, delete everything from the logical screen. </font><font style="vertical-align: inherit;">According to the specification, the logical screen should be filled with a background color, in practice it becomes completely transparent. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Value 3 is the most interesting - before displaying the next frame, return everything as it was before the current frame was displayed. </font><font style="vertical-align: inherit;">So, when coding, say, the fifth frame, it is worth making a difference not only with the fourth, but also with the third - it will suddenly shrink better.</font></font><br><br><h3>  Transparent color </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that a transparent color is indicated for each image, even if a global palette is used. </font><font style="vertical-align: inherit;">What can it give us? </font><font style="vertical-align: inherit;">Look at the picture:</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The picture is removed under the spoiler, not everyone loves animation in the middle of the text.</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/1e0/487/4c7/1e04874c72a6cbe81cdfc7b11dbd8581.gif"></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How many colors are there? </font><font style="vertical-align: inherit;">Red, green, blue, yellow and transparent - five. </font><font style="vertical-align: inherit;">That is what GIMP and Photoshop think. </font><font style="vertical-align: inherit;">But they are wrong - there are only four colors. </font><font style="vertical-align: inherit;">All four frame images are exactly the same, and use a global palette. </font><font style="vertical-align: inherit;">The difference is only in the extensions of the image that stand in front of them; each color is alternately declared transparent.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Palette and code size </font></font></h3><br>    LZW     (  ) ,     .           ,     24-  ,    . <br><br> ,     ,        .   ,  - ,      . <br><br>    ‚Ä¶ ‚Ä¶    !    ,   . <br><br><img src="https://habrastorage.org/storage2/7d9/0f6/99c/7d90f699c88d0228fdcadc1bb295b9e9.png"><br><br>    8 : <br><br><img src="https://habrastorage.org/storage2/76d/b22/dfe/76db22dfebdb78287762e506d4049d20.png"><br><br>      ,   ,     0 (-)  . <br><br><img src="https://habrastorage.org/storage2/ac1/8f3/f09/ac18f3f099ed0fa82ebdfa30de70dec3.gif"><br><br>            : -  .         (  1).   -      LZW   .   ,           0  3,   -    .      ,       ‚Äî 2. <br><br> ,  ? <br><br><img src="https://habrastorage.org/storage2/72c/437/e4f/72c437e4f80d934e7a42f0ca3a5c2592.gif"><br><br> . ,   GIF'    ! <br><div class="spoiler"> <b class="spoiler_title">.</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/cbb/1f9/13f/cbb1f913f5efd3ffaafc89d6352a0485.gif"></div></div><br>  ¬´¬ª 437 .      ,      6  , 443 .      ,   Photoshop,   469 ,     7% . <br><br><h2>  Total </h2><br>  We summarize.   GIF: <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Removal of unnecessary blocks, including image extensions; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The choice of the minimum possible color depth (palette size); </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Minimizing the size of image frames; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Use local palette; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A departure from the greed of the LZW; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Reset LZW dictionary; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Choose between progressive or interlaced scanning (if valid); </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Using frame cleaning methods: ‚Äúleave‚Äù, ‚Äúclear‚Äù, ‚Äúundo‚Äù (only for animation); </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "Reuse" transparent colors (only for animation); </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimizing the palette to reduce the size of the codes (only for animation). </font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Works, but is not encouraged: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Delete the end of the LZW stream marker and the dictionary reset code at the beginning. </font></font></li></ul><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To be continued </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's all for today. </font><font style="vertical-align: inherit;">And the next, final part is the graphic format PNG and its derivatives.</font></font></div><p>Source: <a href="https://habr.com/ru/post/184660/">https://habr.com/ru/post/184660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184642/index.html">On the nature of thinking. Private opinion</a></li>
<li><a href="../184644/index.html">Video review Sony Xperia Z Ultra. Buy stalks separately</a></li>
<li><a href="../184648/index.html">Salaries of Ukrainian developers - May-June 2013</a></li>
<li><a href="../184650/index.html">Review of iOS 7 Beta 2 on iPad</a></li>
<li><a href="../184652/index.html">Photo storage Topface now open source</a></li>
<li><a href="../184662/index.html">Radioastron - the telescope of the future</a></li>
<li><a href="../184666/index.html">Create a game using canvas and sprites.</a></li>
<li><a href="../184672/index.html">Muzz car tuner</a></li>
<li><a href="../184674/index.html">Java programming training</a></li>
<li><a href="../184678/index.html">Apple Online Store is now in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>