<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to declaratively describe a collapsing toolbar</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to present a solution to how to describe CollapsingToolbar, with an emphasis on code readability. The article will not explain what it is and h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to declaratively describe a collapsing toolbar</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/8g/0f/wn/8g0fwn_juqzn2hdlqfsnpxncz1w.gif"><br><br>  I want to present a solution to how to describe CollapsingToolbar, with an emphasis on code readability.  The article will not explain what it is and how to write your CoordinatorLayout.Behavior.  If the reader is interested in understanding this, there are many articles, including <a href="https://habr.com/post/270121/">on Habr√©</a> .  If you do not want to understand - do not worry: I tried to make the writing of CollapsingToolbar so that you can abstract from the CoordinatorLayout.Behavior and OnOffsetChangedListener. <br><a name="habracut"></a><br><h4>  Terms </h4><br><ul><li>  Toolbar - a set of views that we want to display at the top of the screen (not android.widget.Toolbar). </li><li>  NestedScroll - any scrolling view that can be associated with AppBarLayout (RecyclerView, NestedScrollView). </li></ul><br><h3>  Why did you need to write your decision </h3><br>  I looked at several approaches on the Internet, and almost all were built as follows: <br><br><ol><li>  Sets a fixed height for AppBarLayout. </li><li>  It is written by CoordinatorLayout.Behavior, in which by some calculations (cached height of the view is added from the bottom of another view and minus the margin multiplied by the scroll calculated here) change some twist. </li><li>  Others swap in OnOffsetChangedListener AppBarLayout. </li></ol><br>  Here is <a href="https://github.com/saulmm/CoordinatorBehaviorExample">an example of Behavior</a> with the described approach, 2.5k stars on Github. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Expectation</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/7q/vv/7e/7qvv7emfjzhrkn_shib-a0pivxu.gif"></div></div><br><div class="spoiler">  <b class="spoiler_title">Reality: put on your oneplus</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/wn/aa/4b/wnaa4b5bdkbta85lg71cegvwdoa.png"></div></div><br>  It is possible to correct the layout for this solution, but I am confused by something else.  Some view can be controlled through OnOffsetChangedListener, some through Behavior, something works out of the box.  The developer, in order to understand the whole picture, will have to go over a variety of classes, and if for a new view you have to add behavior that depends on other Behaviors and on the view that changes in OnOffsetChangedListener, crutches and bugs can grow on level ground <br><br>  In addition, this example does not show how to be if additional elements will be added to the toolbar that affect the height of this tulabar. <br><br>  In the gif at the beginning of the article you can see how TextView is hidden by clicking on the button - and NestedScroll is pulled higher so that empty space does not occur). <br><br><div class="spoiler">  <b class="spoiler_title">gif one more time</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/8g/0f/wn/8g0fwn_juqzn2hdlqfsnpxncz1w.gif"></div></div><br>  How to do it?  The solutions that first come to mind are to write another CoordinatorLayout.Behavior for NestedScroll (keeping the logic of the base AppBarLayout.Behavior) or stick the toolbar in AppBarLayout and change it to OnOffsetChangedListener.  I tried both solutions, and I got code tied to the implementation details, which would be quite difficult for someone else to figure out and could not be reused. <br><br>  I would be happy if someone shares an example where such logic is implemented ‚Äúpurely‚Äù, but for now I will show my decision.  The idea is to be able to <b>declaratively describe in one place</b> which views and how you should behave. <br><br><h3>  What does api look like </h3><br>  So, to create a CoordinatorLayout.Behavior you need: <br><br><ul><li>  inherit BehaviorByRules; </li><li>  override the methods that return AppBarLayout, CollapsingToolbarLayout and the length of the scroll (the height of the AppBarLayout). </li><li>  override the setUpViews method - describe the rules how the view will behave when the appBar changes. </li></ul><br>  TopInfoBehavior for the GIF toolbar at the beginning of the article will look like this (I will explain how it works later in the article): <br><br><div class="spoiler">  <b class="spoiler_title">Layout</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/_z/f1/yz/_zf1yzlonsivwsvfevlillcopc0.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">TopInfoBehavior.kt</b> <div class="spoiler_text"><pre><code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TopInfoBehavior</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Context</span></span></span><span class="hljs-class">?, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AttributeSet</span></span></span><span class="hljs-class">? ) : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BehaviorByRules</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">) { override fun calcAppbarHeight(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">child</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class">): </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> = with(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">child</span></span></span><span class="hljs-class">) { return (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pixels</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toolbar_height</span></span></span><span class="hljs-class">)).toInt() } override fun </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class">.provideAppbar(): </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppBarLayout</span></span></span><span class="hljs-class"> = ablAppbar override fun </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class">.provideCollapsingToolbar(): </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CollapsingToolbarLayout</span></span></span><span class="hljs-class"> = ctlToolbar override fun </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class">.setUpViews(): </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">List</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">&gt; = listOf( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">viewGroupTopDetails</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleYOffset</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pixels</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zero</span></span></span><span class="hljs-class">), max = pixels(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toolbar_height</span></span></span><span class="hljs-class">) ) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textViewTopDetails</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleAlpha</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = 0.6</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class"> = 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">) .workInRange(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">appearedUntil</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> = 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleXOffset</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pixels</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">big_margin</span></span></span><span class="hljs-class">), interpolator = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReverseInterpolator</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccelerateInterpolator</span></span></span><span class="hljs-class">()) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleYOffset</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pixels</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zero</span></span></span><span class="hljs-class">), max = pixels(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pad</span></span></span><span class="hljs-class">), interpolator = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReverseInterpolator</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LinearInterpolator</span></span></span><span class="hljs-class">()) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleAppear</span></span></span><span class="hljs-class">(0.1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleScale</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = 0.8</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class"> = 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textViewPainIsTheArse</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleAppear</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">isAppearedUntil</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GONE_VIEW_THRESHOLD</span></span></span><span class="hljs-class">) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textViewCollapsedTop</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleAppear</span></span></span><span class="hljs-class">(0.1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textViewTop</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleAppear</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">isAppearedUntil</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GONE_VIEW_THRESHOLD</span></span></span><span class="hljs-class">) ), buildRuleForIcon(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ivTop</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LinearInterpolator</span></span></span><span class="hljs-class">()), buildRuleForIcon(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ivTop2</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccelerateInterpolator</span></span></span><span class="hljs-class">(0.7</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">)), buildRuleForIcon(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ivTop3</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccelerateInterpolator</span></span></span><span class="hljs-class">()) ) private fun </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class">.buildRuleForIcon( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ImageView</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpolator</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Interpolator</span></span></span><span class="hljs-class"> ) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleYOffset</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ivTop3</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tvCollapsedTop</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">), max = 0f, interpolator = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DecelerateInterpolator</span></span></span><span class="hljs-class">(1.5</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleXOffset</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tvCollapsedTop</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toFloat</span></span></span><span class="hljs-class">() + pixels(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">huge_margin</span></span></span><span class="hljs-class">), interpolator = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReverseInterpolator</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpolator</span></span></span><span class="hljs-class">) ) ) companion object { const val </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GONE_VIEW_THRESHOLD</span></span></span><span class="hljs-class"> = 0.8f } }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Xml layout (removed obvious attributes for readability)</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.CoordinatorLayout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.AppBarLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.CollapsingToolbarLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_scrollFlags</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"scroll|exitUntilCollapsed"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.v7.widget.Toolbar</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@dimen/toolbar_height"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_collapseMode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pin"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.CollapsingToolbarLayout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.AppBarLayout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RelativeLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:translationZ</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5dp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_behavior</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TopInfoBehavior"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.v4.widget.NestedScrollView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_behavior</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/appbar_scrolling_view_behavior"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.v4.widget.NestedScrollView</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.FloatingActionButton</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_anchor</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@id/nesteScroll"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_anchorGravity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"right"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.CoordinatorLayout</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><h3>  How it works </h3><br>  The task is to write the rules: <br><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BehaviorRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> view to be changed * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> details view's data when first attached * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ratio in range [0, 1]; 0 when toolbar is collapsed */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">manage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ratio: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">, details: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">InitialViewDetails</span></span></span></span><span class="hljs-function"><span class="hljs-params">, view: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> }</code> </pre><br>  Everything is clear here - a float value from 0 to 1 comes in, reflecting the percentage of ActionBar, and I get the view and its initial state.  BaseBehaviorRule looks more interesting - a rule from which other basic rules are inherited. <br><br><pre> <code class="hljs pgsql">abstract <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BaseBehaviorRule : BehaviorRule { abstract val interpolator: Interpolator abstract val min: <span class="hljs-type"><span class="hljs-type">Float</span></span> abstract val max: <span class="hljs-type"><span class="hljs-type">Float</span></span> final override fun manage( ratio: <span class="hljs-type"><span class="hljs-type">Float</span></span>, details: InitialViewDetails, <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">View</span></span> ) { val interpolation = interpolator.getInterpolation(ratio) val <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = normalize( oldValue = interpolation, newMin = min, newMax = max ) <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, details, <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>) } <span class="hljs-comment"><span class="hljs-comment">/** * @param offset normalized with range from [min] to [max] with [interpolator] */</span></span> abstract fun <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>: <span class="hljs-type"><span class="hljs-type">Float</span></span>, details: InitialViewDetails, <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>) } <span class="hljs-comment"><span class="hljs-comment">/** * Affine transform value form one range into another */</span></span> fun normalize( oldValue: <span class="hljs-type"><span class="hljs-type">Float</span></span>, newMin: <span class="hljs-type"><span class="hljs-type">Float</span></span>, newMax: <span class="hljs-type"><span class="hljs-type">Float</span></span>, oldMin: <span class="hljs-type"><span class="hljs-type">Float</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>f, oldMax: <span class="hljs-type"><span class="hljs-type">Float</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>f ): <span class="hljs-type"><span class="hljs-type">Float</span></span> = newMin + ((oldValue - oldMin) * (newMax - newMin)) / (oldMax - oldMin)</code> </pre><br>  For basic rules, the range of the (min, max) and interpolator values ‚Äã‚Äãis determined.  This is enough to describe almost any behavior. <br><br>  Suppose we want to set an alpha for our twist in the range 0.5 to 0.9.  We also want the scroll to quickly become transparent at first, and then the rate of change will fall. <br>  The rule will look like this: <br><br><pre> <code class="hljs lisp">BRuleAlpha(<span class="hljs-name"><span class="hljs-name">min</span></span> = <span class="hljs-number"><span class="hljs-number">0.5</span></span>f, max = <span class="hljs-number"><span class="hljs-number">0.9</span></span>f, interpolator = DecelerateInterpolator())</code> </pre> <br>  But the implementation of BRuleAlpha: <br><br><div class="spoiler">  <b class="spoiler_title">BRuleAlpha.kt</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/** * [min], [max] ‚Äî values in range [0, 1] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BRuleAlpha( override val min: <span class="hljs-type"><span class="hljs-type">Float</span></span>, override val max: <span class="hljs-type"><span class="hljs-type">Float</span></span>, override val interpolator: Interpolator = LinearInterpolator() ) : BaseBehaviorRule() { override fun <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>: <span class="hljs-type"><span class="hljs-type">Float</span></span>, details: InitialViewDetails, <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.alpha = <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> } }</code> </pre><br></div></div><br>  And finally, the BehaviorByRules code.  For those who wrote their Behavior, everything should be obvious (except that inside onMeasureChild, I‚Äôll tell you about it below): <br><br><div class="spoiler">  <b class="spoiler_title">BehaviorByRules.kt</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BehaviorByRules</span></span></span></span>( context: Context?, attrs: AttributeSet? ) : CoordinatorLayout.Behavior&lt;View&gt;(context, attrs) { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> views: List&lt;RuledView&gt; = emptyList() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastChildHeight = -<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> needToUpdateHeight: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">layoutDependsOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoordinatorLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dependency: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dependency <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> AppBarLayout } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDependentViewChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoordinatorLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dependency: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (views.isEmpty()) views = child.setUpViews() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> progress = calcProgress(parent) views.forEach { performRules(offsetView = it, percent = progress) } tryToInitHeight(child, dependency, progress) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMeasureChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoordinatorLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, parentWidthMeasureSpec: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, widthUsed: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, parentHeightMeasureSpec: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, heightUsed: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> canUpdateHeight = canUpdateHeight(calcProgress(parent)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (canUpdateHeight) { parent.post { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newChildHeight = child.height <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newChildHeight != lastChildHeight) { lastChildHeight = newChildHeight setUpAppbarHeight(child, parent) } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { needToUpdateHeight = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onMeasureChild( parent, child, parentWidthMeasureSpec, widthUsed, parentHeightMeasureSpec, heightUsed ) } <span class="hljs-comment"><span class="hljs-comment">/** * If you use fitsSystemWindows=true in your coordinator layout, * you will have to include statusBar height in the appbarHeight */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calcAppbarHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> View.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUpViews</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: List&lt;RuledView&gt; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> View.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideAppbar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: AppBarLayout <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> View.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideCollapsingToolbar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: CollapsingToolbarLayout <span class="hljs-comment"><span class="hljs-comment">/** * You man not want to update height, if height depends on views, that are currently invisible */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canUpdateHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(progress: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calcProgress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoordinatorLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Float</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> appBar = parent.provideAppbar() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> scrollRange = appBar.totalScrollRange.toFloat() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> scrollY = Math.abs(appBar.y) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> scroll = <span class="hljs-number"><span class="hljs-number">1</span></span> - scrollY / scrollRange <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> { scroll.isNaN() -&gt; <span class="hljs-number"><span class="hljs-number">1f</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; scroll } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUpAppbarHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ViewGroup</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { parent.provideCollapsingToolbar().setHeight(calcAppbarHeight(child)) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryToInitHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dependency: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, scrollPercent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (needToUpdateHeight &amp;&amp; canUpdateHeight(scrollPercent)) { setUpAppbarHeight(child, dependency <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ViewGroup) needToUpdateHeight = <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">performRules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(offsetView: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">RuledView</span></span></span></span><span class="hljs-function"><span class="hljs-params">, percent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> view = offsetView.view <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> details = offsetView.details offsetView.rules.forEach { rule -&gt; rule.manage(percent, details, view) } } }</code> </pre><br></div></div><br>  So what's up with onMeasureChild? <br><br>  This is needed to solve the problem I wrote about above: if some part of the toolbar disappears, NestedScroll should move higher.  To make it higher, you need to reduce the height of the CollapsingToolbarLayout. <br><br>  There is another non-obvious method - canUpdateHeight.  It is needed so that the heir could be allowed to set a rule when heights cannot be changed.  For example, if the view on which the height depends is currently hidden.  I'm not sure that this will cover all cases, but if anyone has any ideas on how to do better, please write down in the comments or in a personal note. <br><br><h3>  Rakes that can be stepped on when working with CollapsingToolbarLayout </h3><br><ul><li>  Changing the view should avoid onLayout.  For example, you should not change the layoutParams or textSize inside the BehaviorRule, otherwise it will greatly increase performance. </li><li>  If you want to work with the toolbar through OnOffsetChangedListener, onLayout is even more dangerous - the onOffsetChanged method will be triggered endlessly. </li><li>  CoordinatorLayout.Behavior should not depend on the layoutDependsOn, which can go into visibility GONE.  When this view returns to View.VISIBLE, Behavior will not respond. </li><li>  If the toolbar is outside the AppBarLayout, then in order not to overlap the toolbar, you need to add the android attribute: translationZ = "5dp" to the parent ViewGroup of the toolbar. </li></ul><br><h3>  Finally </h3><br>  We have a solution that allows you to quickly outline your CollapsingToolbarLayout with logic that will be relatively easy to read and modify.  All rules and dependencies are formed within one class - CoordinatorLayout.Behavior.  The code can be viewed on the <a href="https://github.com/Liverm0r/BehavioRule">githaba</a> . </div><p>Source: <a href="https://habr.com/ru/post/426369/">https://habr.com/ru/post/426369/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426359/index.html">Yandex anti-piracy initiative not approved by copyright holders</a></li>
<li><a href="../426361/index.html">About the awesomeness of the bee, and how we kill it</a></li>
<li><a href="../426363/index.html">Facts and hypotheses about the accident "Union MS-10"</a></li>
<li><a href="../426365/index.html">Do not trust Facebook is too late</a></li>
<li><a href="../426367/index.html">Microsoft transferred two thirds of its patents to the Open Invention Network (OIN)</a></li>
<li><a href="../426371/index.html">Audio Digest: 17 materials and practical guides on professional acoustics</a></li>
<li><a href="../426373/index.html">Build functions in the console. Part 1</a></li>
<li><a href="../426375/index.html">Technology analysis: where to start work on the patent landscape</a></li>
<li><a href="../426377/index.html">Play using math graphs instead of graphs</a></li>
<li><a href="../426379/index.html">Deliverance from illusions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>