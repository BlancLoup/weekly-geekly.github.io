<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing the infrastructure as a code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone, we recently started a series of articles on testing in Chef , but today I will talk about more introductory and universal things: why ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing the infrastructure as a code</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8d7/549/5ce/8d75495ce9684ca3895ecae54b43db07.jpg" align="left"><br>  Hello everyone, we recently started a <a href="http://habrahabr.ru/company/express42/blog/253139/">series of articles on testing in Chef</a> , but today I will talk about more introductory and universal things: why test the infrastructure, what tools are there for this, and how to automate it all.  I will also touch upon the topic of publishing open source infrastructure code.  The article will be of interest to users of any of the popular configuration management systems - Chef, Puppet, Ansible or SaltStack. <br><a name="habracut"></a><br>  The article is based on my speech at the Ulyanovsk <a href="http://nastachku.ru/">Strike</a> conference; slides are available <a href="http://www.slideshare.net/ikurochkin/ss-46998701">here</a> .  After reading, write about your experience in testing infrastructure, I think everyone will be interested. <br><br>  Go. <br><br><h4>  Tests? </h4><br>  If the infrastructure becomes code, good code should be covered with tests.  Tests help to not be afraid to make changes, improve the quality and speed of writing code, give feedback.  The code covered with tests is easier to maintain, it is easier to operate and easier for beginners.  In the concept of ‚Äúinfrastructure as a code,‚Äù tests allow to automate manual actions and save a lot of time, as well as documentation, they show how to work with your code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  When is it relevant? </h4><br>  Tests are especially relevant when the code is changed, when several people are working on it, and the changes affect complex logic or third-party code.  There is no way out of changes, new versions of operating systems and programs come out, APIs change and your infrastructure code becomes outdated and requires changes.  When several people make changes to the code, you can no longer be sure that your changes will not affect others, and if you change complicated logic or third-party code, the probability of error is even higher.  The standard approach of checking the infrastructure code in Vagrant is no longer working here, since it takes a lot of time and requires manual checking of changes and the final state. <br><br><h4>  What to do? </h4><br>  Therefore, in the configuration management systems, there appeared their own tools for testing the infrastructure code.  I will review the most popular and versatile tools that are suitable for any of the configuration management systems, be it Chef, Puppet, Ansible or SaltStack. <br><img src="https://habrastorage.org/files/aff/bd5/407/affbd5407d974454a47d0260d944f29b.png"><br><br><h4>  What to test? </h4><br>  But first you need to decide on which parts we will test and what to check. <br>  We will test the main parts of which the infrastructure code consists, that is, kukbuki, modules, roles or formulas, depending on what system you use. <br><br><h4>  What are we checking? </h4><br>  We will check the following things: <br><ul><li>  syntax and coding style </li><li>  functional </li><li>  the result of the configuration management system </li></ul><br><br><h4>  Language style </h4><br><img src="https://habrastorage.org/files/00d/44b/80d/00d44b80df3d4b4dbf8e5df2ec1cae2f.png" align="right" height="150"><br>  Popular configuration management systems are written in two languages, Ruby and Python.  For them, their own style guides for writing code have been created and it is advisable to follow them so that your infrastructure code is easier to read and maintain.  To test the language style, standard code analyzers are used, such as <a href="https://github.com/bbatsov/rubocop">rubocop</a> for Ruby and <a href="https://github.com/jcrocholl/pep8">pep8</a> for Python.  They can be run manually or they can be embedded in your editor or IDE. <br><br><h4>  Code style </h4><br>  Over time, the configuration management systems developed their own recommendations; there appeared style guides and special tools - linters.  They need to be considered to identify known problems.  They work on the basis of a set of rules.  A list of system linters is provided below: <br><ul><li>  <a href="http://www.foodcritic.io/">Chef foodcritic</a> </li><li>  <a href="http://puppet-lint.com/">Puppet-lint</a> </li><li>  <a href="https://github.com/willthames/ansible-lint">Ansible-lint</a> </li><li>  <a href="https://github.com/lukaszraczylo/salt-lint">Salt-lint</a> </li></ul><br><br><h4>  Functional </h4><br>  The functionality is checked on the test data sets, they are also called fixtures.  Fixtures include input data sets to test various uses of the infrastructure code.  In the simple case, it is a kukbook, module, role, or formula with default parameters; in a complex case, calls to modules or providers with different parameters.  The more different options in fixtures, the more result you can check.  Fixtures are also an example of working with your infrastructure code. <br><br><h4>  Result </h4><br><img src="https://habrastorage.org/files/3c1/b25/884/3c1b258840fb4f9bbf48eb42614e5078.png" align="right" height="50">  To check the result of the configuration management system, use the <a href="http://serverspec.org/">Serverspec</a> tool.  This is a special framework for testing infrastructure.  It checks the final state of the virtual machine or server.  Written in Ruby and is an RSpec extension, it supports all popular Linux and BSD distributions, as well as Windows.  Serverspec contains about 40 built-in resources with which you can verify that the package is installed in the system, the necessary parameters are specified in the config, the service is running, or the port is listening.  If this is not enough, then you can call any shell command and check its output.  Serverspec is an excellent alternative to shell scripts and allows you to perform checks both locally and remotely.  Serverspec is actively used in the infrastructure code community, and Chef recently <a href="https://www.chef.io/blog/2015/05/06/chef-audit-mode-introduction/">announced</a> support for Serverspec and recipes. <br><br><h4>  How to test? </h4><br>  Infrastructure tests can be run manually, locally or remotely, they can be embedded in the editor or IDE, run at any event, such as changing files on the file system or in the repository. <br><br><h4>  Automating </h4><br>  For automation, we will use a continuous integration system (CI system).  Automation eliminates the human factor, improves the quality and speed of testing.  Consider the following systems: <br><ul><li>  <a href="http://kitchen.ci/">Kitchen ci</a> </li><li>  <a href="https://travis-ci.org/">Travis ci</a> </li><li>  Other CI systems </li></ul><br><br><h4>  Test kitchen </h4><br>  This is a tool for running infrastructure code and testing it. <img src="https://habrastorage.org/files/12d/815/73d/12d81573dccf42fe8fbaff25662cb5a9.png" align="right" height="130">  Test Kitchen starts the virtual machine, it runs your infrastructure code and tests to check the result.  Test Kitchen allows you to run virtual machines both locally and remotely.  It is an excellent alternative to Vagrant for running infrastructure code, as it introduces the concepts test suite (suites), supports all configuration management systems, Chef in the database, the rest through plugins ( <a href="https://github.com/neillturner/kitchen-puppet">Puppet</a> , <a href="https://github.com/neillturner/kitchen-ansible">Ansible</a> , <a href="https://github.com/simonmcc/kitchen-salt">SaltStack</a> ), and supports the Serverspec test framework. <br><br><h4>  Travis ci </h4><br>  This is a continuous integration SaaS system for GitHub projects.  Free for public repositories.  Suitable for testing infrastructure code.  There is an integration with Chef Supermarket and Puppet Forge, I will tell about them later. <br><img src="https://habrastorage.org/files/727/4fb/387/7274fb3871e4480489712fa8d66ce2e0.jpeg" align="right" height="100"><br>  But there are limitations, the test environment in Travis CI is based on Ubuntu 12.04 LTS, so if you use another distribution kit or write cross-platform code, you will not be able to test it.  Plus, the test environment comes with pre-installed packages and environment variables that can cause conflicts. <br><br><h4>  Test Kitchen + Travis CI </h4><br>  To circumvent these limitations, you can use two systems Test Kitchen and Travis CI together and run virtual machines in the cloud, for example, Amazon or DigitalOcean. <br><br><h4>  Other CI systems </h4><br>  If you already use any CI system, then the process of testing the infrastructure can be built on it, also using Test Kitchen to run the code and test suite. <br><br><h4>  Sharing with the community </h4><br>  In total, the infrastructure code will be in the same style, convenient for support, modification and training.  Do not be ashamed to show others.  Therefore, we share with the community and lay out in open source.  With the help of the community, you can improve the testing and functionality of the infrastructure code.  Due to the expertise and view from the development does not stop. <br><br><h4>  Share </h4><br>  The developers of configuration management systems have released special platforms for the exchange of infrastructure code: <br><img src="https://habrastorage.org/files/4b5/c1a/912/4b5c1a9125ab492f812bc7e1bbdfffac.png" align="right" height="200"><br><ul><li>  <a href="https://supermarket.chef.io/">Chef supermarket</a> </li><li>  <a href="https://forge.puppetlabs.com/">Puppet forge</a> </li><li>  <a href="https://galaxy.ansible.com/">Ansible galaxy</a> </li><li>  <a href="https://github.com/saltstack-formulas">Salt Stack Formulas</a> </li></ul><br><br><h4>  Do not forget </h4><br>  Laying out the code in open source, do not forget about the following points: <br><ul><li>  Delete private information (keys, passwords, internal components) </li><li>  Add tests and build status, it increases the credibility of the code </li><li>  Keep a history of changes and documentation, you can create them automatically </li><li>  Think about compatibility, dependencies and conflicts. </li><li>  Sync code with community platform </li><li>  Add license </li></ul><br><br><h4>  How we do it </h4><br>  How we do it, using the <a href="">example of</a> our chef kukbuka postgresql_lwrp: <br><ul><li> The code is in the repository on github </li><li>  Each change starts a build in Travis CI </li><li>  Checks language and code style with Rubocop and Foodcritic </li><li>  Next, Test Kitchen launches a virtual machine in the Digital Ocean cloud and runs the code and Serverspec tests. </li><li>  If all the tests have passed and there was a release, then the kookbook will be loaded into the Chef Supermarket. </li><li>  And we receive notification in the Slack chat and update the status of the assembly on the page kukbuk </li></ul><br><br><h4>  findings </h4><br>  Test changes, automate and share with the community. <br><br><h4>  Links </h4><br><img src="https://habrastorage.org/files/5bc/a6d/c04/5bca6dc04bb34480942a38ea64eb47c7.png" align="right" height="130"><br>  On GitHub, we have <a href="https://github.com/express42-cookbooks">testing examples</a> for Chef, the most popular is the <a href="https://github.com/express42-cookbooks/postgresql_lwrp">postgresql dollbook</a> .  In the near future we will post some more cool kukbuk.  We also continue the <a href="http://habrahabr.ru/company/express42/blog/">cycle of articles</a> on Habrahabr about Chef testing, listen to our podcast <a href="http://devopsdeflope.ru/">Devops Deflop</a> and come to <a href="http://www.meetup.com/DevOps-Moscow-in-Russian/">DevOps meetings</a> in Moscow. </div><p>Source: <a href="https://habr.com/ru/post/256725/">https://habr.com/ru/post/256725/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256711/index.html">How to know the effectiveness of the page in the App Store or Google Play?</a></li>
<li><a href="../256713/index.html">Testing math algorithms</a></li>
<li><a href="../256717/index.html">The best phone for games, game market development forecasts, Telegram competition - and other news of the week for a mobile developer</a></li>
<li><a href="../256719/index.html">Analysis of tasks of the 2nd qualifying round of the Russian Code Cup 2015</a></li>
<li><a href="../256723/index.html">Atom X. Intel's New Atomic Index</a></li>
<li><a href="../256727/index.html">Complete energy autonomy or how to survive with solar panels in the outback (part 6. Summer Resident Edition)</a></li>
<li><a href="../256729/index.html">HP StormRunner Load. A practical guide. Part I</a></li>
<li><a href="../256733/index.html">vCloud Director for the smallest (part 1): network setup</a></li>
<li><a href="../256735/index.html">How to catch what is not. Part Five, Fraction Two: What you need to know to purchase a certified product. FAQ</a></li>
<li><a href="../256737/index.html">IBM invests $ 3 billion in Internet of Things</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>