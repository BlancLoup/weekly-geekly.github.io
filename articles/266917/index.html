<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search for periodic security elements of the RF Passport using the Fourier transform: part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many documents contain security features such as holograms, watermarks, guilloches, etc. In the process of scanning such documents there is a problem ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search for periodic security elements of the RF Passport using the Fourier transform: part two</h1><div class="post__text post__text-html js-mediator-article">  Many documents contain security features such as holograms, watermarks, guilloches, etc.  In the process of scanning such documents there is a problem - the security elements interfere with the recognition systems (OCR).  In developing <a href="http://habrahabr.ru/company/smartengines/blog/252703/">Smart PassportReader,</a> we conducted a study aimed at finding and eliminating similar security elements from document images. <br><br><img src="https://habrastorage.org/files/15a/505/f46/15a505f46c604b48a3e1b085d8232f17.jpg" height="250"><img src="https://habrastorage.org/files/7fc/5bc/224/7fc5bc224a06449ca6b596949ffa9cb6.png" height="250"><br><br>  In our <a href="http://habrahabr.ru/company/smartengines/blog/259251/">previous article</a> on this topic, we talked about the first half of the search problem solution ‚Äî detection, i.e.  determining the presence of periodic elements in the image.  Today we will tell how to find the immediate position of the periodic elements in the image, provided that the detection was successful: we are sure that the elements in the image are present.  The second part depends heavily on the first, so it is strongly recommended that you first get acquainted with the first, if you have not already done so. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Like last time, the Fourier transform will be used for this. <br><a name="habracut"></a><br><h2>  Image model </h2><br>  Like last time, many arguments will be shown for the one-dimensional case, which is then easily transferred to the two-dimensional one. <br><br>  Recall that <img src="http://tex.s2cms.ru/svg/I(x)" alt="I (x)">  - original image length <img src="http://tex.s2cms.ru/svg/N" alt="N">  consisting of two others: background image <img src="http://tex.s2cms.ru/svg/h(x)" alt="h (x)">  and images <img src="http://tex.s2cms.ru/svg/g(x)" alt="g (x)">  containing a periodic pattern.  Picture <img src="http://tex.s2cms.ru/svg/g(x)" alt="g (x)">  in turn, we presented a single instance of the template convolution <img src="http://tex.s2cms.ru/svg/f(x)" alt="f (x)">  with Dirac's crest <img src="http://tex.s2cms.ru/svg/c(x)" alt="c (x)">  : <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/I(x)%20%3D%20h(x)%20%2B%20g(x)%20%3D%20h(x)%20%2B%20f(x)%20%5Cast%20c(x)" alt="I (x) = h (x) + g (x) = h (x) + f (x) \ ast c (x)"></div><br>  Since we know in advance the structure of the periodic pattern (in the case of the RF passport, the size and period of the holograms), to restore the position of the elements, it is enough to know only the horizontal and vertical shift of the entire template, which is the same as the shift of one of the ‚Äúeagles‚Äù. <br><br><h2>  Discrete Fourier transform of a shifted periodic pattern </h2><br>  Shift signal pattern <img src="http://tex.s2cms.ru/svg/g(x)" alt="g (x)">  equivalent to impulse shift <img src="http://tex.s2cms.ru/svg/c(x)" alt="c (x)">  which leads to a modified form <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20c(x)" alt="\ mathcal {F} c (x)">  .  The spectrum of the Fourier transform of the shifted signal changes only in phase, leaving the amplitude unchanged, thereby allowing the periodic patterns to be detected independently of their initial shift.  As an important consequence, all the useful phase information is concentrated in the same DFT positions (frequencies) as the amplitudes of the pulsed signal. <br><br>  Let's pretend that <img src="http://tex.s2cms.ru/svg/c(x)" alt="c (x)">  shifted to the right by <img src="http://tex.s2cms.ru/svg/S" alt="S">  , then: <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D_k%20c(x%20-%20S)%20%3D%20%5Cmathcal%7BF%7D_k%20c(x)%20%5Ccdot%20e%5E%7Bi%20%5CPhi_k%7D%2C" alt="\ mathcal {F} _k c (x - S) = \ mathcal {F} _k c (x) \ cdot e ^ {i \ Phi_k},"></div><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%5CPhi_k%20%3D%20%5CPhi%20%5Ccdot%20k%2C%20%20%5CPhi%3D-%5Cfrac%7B2%5Cpi%7D%7BN%7DS" alt="\ Phi_k = \ Phi \ cdot k, \ Phi = - \ frac {2 \ pi} {N} S"></div><br>  Since the phase angle <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D_k%20c(x)" alt="\ mathcal {F} _k c (x)">  for unbiased <img src="http://tex.s2cms.ru/svg/c(x)" alt="c (x)">  equals zero for offset <img src="http://tex.s2cms.ru/svg/c(x-S)" alt="c (x-s)">  he becomes equal <img src="http://tex.s2cms.ru/svg/%5CPhi_k" alt="\ Phi_k">  .  To obtain a phase shift <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D_k%20g(x)" alt="\ mathcal {F} _k g (x)">  we need to add each member <img src="http://tex.s2cms.ru/svg/%5CPhi_k" alt="\ Phi_k">  to the corresponding phase angle in <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D_k%20f(x)" alt="\ mathcal {F} _k f (x)">  for each <img src="http://tex.s2cms.ru/svg/k" alt="k">  .  Note that any phase angle is always taken modulo <img src="http://tex.s2cms.ru/svg/2%5Cpi" alt="2 \ pi">  and is limited by the interval <img src="http://tex.s2cms.ru/svg/%5B-%5Cpi%3B%5Cpi)" alt="[- \ pi; \ pi)">  . <br><br>  Phase shift on <img src="http://tex.s2cms.ru/svg/2%5Cpi" alt="2 \ pi">  in the frequency domain represents the shift <img src="http://tex.s2cms.ru/svg/N" alt="N">  in the time domain but <img src="http://tex.s2cms.ru/svg/c(x)" alt="c (x)">  has a period <img src="http://tex.s2cms.ru/svg/T%3D%5Cfrac%7BN%7D%7BM%7D" alt="T = \ frac {N} {M}">  , so we can avoid redundancy by considering only <img src="http://tex.s2cms.ru/svg/%7Bs%3DS%20%5Ctext%7B%20mod%20%7D%20T%7D" alt="{s = S \ text {mod} T}">  thus ensuring <img src="http://tex.s2cms.ru/svg/0%5Cle%20s%20%3C%20T" alt="0 \ le s &amp; lt; T">  .  For convenience, let <img src="http://tex.s2cms.ru/svg/%5Cphi" alt="\ phi">  Is a phase shift in which <img src="http://tex.s2cms.ru/svg/2%5Cpi" alt="2 \ pi">  corresponds to the time shift by <img src="http://tex.s2cms.ru/svg/s" alt="s">  and also let <img src="http://tex.s2cms.ru/svg/%5Cphi_m" alt="\ phi_m">  Is the phase angle on <img src="http://tex.s2cms.ru/svg/m" alt="m">  Amplitude peak: <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%20%5Cphi_m%20%3D%20%5Cphi%20%5Ccdot%20m%2C%20%20%5Cphi%20%3D%20-%5Cfrac%7B2%5Cpi%7D%7BT%7Ds%20%3D%20%5CPhi%20%5Ccdot%20M%20" alt="\ phi_m = \ phi \ cdot m, \ phi = - \ frac {2 \ pi} {T} s = \ Phi \ cdot M"></div><br>  The figure shows an example of the DFT phase of a shifted pulsed signal with values <img src="http://tex.s2cms.ru/svg/%7BN%3D256%7D" alt="{N = 256}">  period <img src="http://tex.s2cms.ru/svg/T%3D32" alt="T = 32">  and shift <img src="http://tex.s2cms.ru/svg/s%20%3D%207" alt="s = 7">  .  For example, <img src="http://tex.s2cms.ru/svg/%5Cphi_0%20%3D%200" alt="\ phi_0 = 0">  and <img src="http://tex.s2cms.ru/svg/%5Cphi_6%20%3D%20(-%5Cfrac%7B2%5Cpi%7D%7B32%7D%5Ccdot%207)%20%5Ccdot%206%20%5Capprox%20-1%2C963" alt="\ phi_6 = (- \ frac {2 \ pi} {32} \ cdot 7) \ cdot 6 \ approx -1.963">  . <br><div style="text-align:center;"><img src="https://habrastorage.org/files/bb0/1ae/445/bb01ae445f39451fb4c373eaa0bbf7d5.png" width="50%"></div><br>  And this is how the amplitude and phase of the DFT looks like for a Gaussian grid like a chessboard: <br><br><img src="https://habrastorage.org/files/42b/7c8/6a7/42b7c86a7b954aadbe9b40098a954418.png" height="200">  - DFT -&gt; <img src="https://habrastorage.org/files/373/607/49a/37360749ad79453397f56153bd916ae0.png" height="200"><img src="https://habrastorage.org/files/ebc/9a5/a82/ebc9a5a821424d3f9f6e390060eab6ae.png" height="200"><br><br>  For a two-dimensional image, the phase shift <img src="http://tex.s2cms.ru/svg/%5Cphi" alt="\ phi">  now consists of two components <img src="http://tex.s2cms.ru/svg/(%5Cphi_x%2C%20%5Cphi_y)" alt="(\ phi_x, \ phi_y)">  .  We introduce a coordinate grid for the DFT of a chess-like system of peaks shown in the second and third figures above, such that the central peak has coordinates <img src="http://tex.s2cms.ru/svg/(0%2C%200)" alt="(0, 0)">  peaks right above <img src="http://tex.s2cms.ru/svg/(2%2C%200)" alt="(20)">  , <img src="http://tex.s2cms.ru/svg/(0%2C%202)" alt="(0, 2)">  and so on;  the nearest diagonal peak has coordinates <img src="http://tex.s2cms.ru/svg/(1%2C%201)" alt="(eleven)">  .  In general, the peak <img src="http://tex.s2cms.ru/svg/(i%2C%20j)" alt="(i, j)">  present if and only if <img src="http://tex.s2cms.ru/svg/(i%20%2B%20j)" alt="(i + j)">  - even. <br><br>  Applying again the theorem on the DFT of a shifted signal, one can extend the shift equation and show that the phase angle <img src="http://tex.s2cms.ru/svg/%5Cphi_%7Bi%2C%20j%7D" alt="\ phi_ {i, j}">  on <img src="http://tex.s2cms.ru/svg/(i%2C%20j)" alt="(i, j)">  The peak for a two-dimensional pulse signal is: <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%20%5Cphi_%7Bi%2C%20j%7D%20%3D%20i%20%5Ccdot%20%5Cphi_x%20%2B%20j%20%5Ccdot%20%5Cphi_y%20" alt="\ phi_ {i, j} = i \ cdot \ phi_x + j \ cdot \ phi_y"></div><br>  As for the one-dimensional case, to obtain a shifted phase <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D_%7Bi%2C%20j%7D%20g(x)" alt="\ mathcal {F} _ {i, j} g (x)">  need to add <img src="http://tex.s2cms.ru/svg/%5Cphi_%7Bi%2C%20j%7D" alt="\ phi_ {i, j}">  to the appropriate phase <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D_%7Bi%2C%20j%7Df(x)" alt="\ mathcal {F} _ {i, j} f (x)">  . <br><br><h2>  Search for a periodic template </h2><br>  To determine the exact location of the periodic pattern, it is sufficient to estimate its phase shift. <img src="http://tex.s2cms.ru/svg/%5Cphi%20%3D%20(%5Cphi_x%2C%20%5Cphi_y)" alt="\ phi = (\ phi_x, \ phi_y)">  since its pixel periodic structure is known in advance.  Pixel shift <img src="http://tex.s2cms.ru/svg/s%20%3D%20(s_x%2C%20s_y)" alt="s = (s_x, s_y)">  , subsequently, it is not difficult to recover from the information on the phase shift. <br><br><h4>  Cutting, scaling and image preprocessing </h4><br>  In the first article, we described the different stages of preprocessing the original image of a passport.  First, an area containing a 2x2 grid (similar to a chessboard) and containing 2 patterns horizontally and vertically is cut out of the image.  This can be done (with an error of less than 5%), since the physical dimensions of the document, the size and period of the periodic patterns are fixed and known in advance.  The position of the region can be set by combining the physical coordinates of the document with its coordinates in the image. <br><br>  Next, a significant compression and smoothing of the image is performed to suppress the background and to level the differences between the periodic patterns.  The figure below shows an image of a cut-out region of a Russian passport, the results of its preprocessing and the amplitude of its DFT. <br><br><img src="https://habrastorage.org/files/d6b/1bb/bd0/d6b1bbbd0c3c41799f267d316692bab3.jpg" height="190">  - processing -&gt; <img src="https://habrastorage.org/files/ff5/809/a67/ff5809a67bb643069aeeb3d7c5153772.png" height="190">  - DFT -&gt; <img src="https://habrastorage.org/files/ab9/285/2cf/ab92852cfa304e4fb78e303281c7a80b.png" height="190"><br><br>  As expected, the DFT amplitude has noticeable peaks with a distribution similar to a chessboard. <br><br><h3>  Spectrum preprocessing </h3><br>  According to the image model, the original image consists of three independent signals: the background image <img src="http://tex.s2cms.ru/svg/h(x)" alt="h (x)">  and single sample periodic pattern <img src="http://tex.s2cms.ru/svg/f(x)" alt="f (x)">  that rolls up with a shifted pulse signal <img src="http://tex.s2cms.ru/svg/c(x)" alt="c (x)">  to get a periodic pattern <img src="http://tex.s2cms.ru/svg/g(x)" alt="g (x)">  : <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%0A%20%20I(x)%20%3D%20h(x)%20%2B%20f(x)%20*%20c(x)%0A" alt="I (x) = h (x) + f (x) * c (x)"></div><br>  After performing the DFT on <img src="http://tex.s2cms.ru/svg/I(x)" alt="I (x)">  , we have: <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%5Clabel%7Beq%3Aimmodel_dft_base%7D%0A%20%20%5Cmathcal%7BF%7D%20I(x)%20%3D%20%5Cmathcal%7BF%7D%20h(x)%20%2B%20%5Cmathcal%7BF%7D%20f(x)%20%5Ccdot%20%5Cmathcal%7BF%7D%20c(x)%0A" alt="\ label {eq: immodel_dft_base} \ mathcal {F} I (x) = \ mathcal {F} h (x) + \ mathcal {F} f (x) \ cdot \ mathcal {F} c (x)"></div><br>  To obtain a phase shift <img src="http://tex.s2cms.ru/svg/%5Cphi" alt="\ phi">  stored in <img src="http://tex.s2cms.ru/svg/c(x)" alt="c (x)">  from <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20I(x)" alt="\ mathcal {F} I (x)">  , which we calculated for this image, we need to gradually suppress the other components of the equation. <br><br><h4>  Background Spectrum Suppression </h4><br>  If the background <img src="http://tex.s2cms.ru/svg/h(x)" alt="h (x)">  after preprocessing is fairly homogeneous on the documents being processed, simple calculation of the averaged spectrum is possible <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20h(x)" alt="\ mathcal {F} h (x)">  on images of documents on which there is no desired periodic pattern, with its subsequent subtraction from <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20I(x)" alt="\ mathcal {F} I (x)">  . <br><br>  However, the background image <img src="http://tex.s2cms.ru/svg/h(x)" alt="h (x)">  in our model, in fact, it is not a background in terms of the structure of a Russian passport: it contains personal data, which, by definition, differ on the set to be processed. <br><br>  We have previously mentioned the fact that the DFT positions (frequencies) without peaks do not contain useful information regarding periodic patterns, since they represent the background.  Assuming that <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20h(x)" alt="\ mathcal {F} h (x)">  is smooth, we can interpolate its contribution to each peak <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20I(x%2C%20y)" alt="\ mathcal {F} I (x, y)">  based on values ‚Äã‚Äãadjacent to peak positions.  Average value <img src="http://tex.s2cms.ru/svg/%5Coverline%7B%5Cmathcal%7BF%7D%20I(x'%2C%20y')%7D" alt="\ overline {\ mathcal {F} I (x ', y')}">  by <img src="http://tex.s2cms.ru/svg/(x%2C%20y)" alt="(x, y)">  on the nearest neighbors peak <img src="http://tex.s2cms.ru/svg/%5C%7B%5Cmathcal%7BF%7D%20I(x'%2C%20y')%5C%7D" alt="\ {\ mathcal {F} I (x ', y') \}">  3x3 window is an acceptable estimate <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20h(x%2C%20y)" alt="\ mathcal {F} h (x, y)">  to subtract from <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20I(x%2C%20y)" alt="\ mathcal {F} I (x, y)">  To clear out the background: <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%0A%20%20%5Cmathcal%7BF%7D%20I(x%2C%20y)%20%5Cleftarrow%20%5Cmathcal%7BF%7D%20I(x%2C%20y)%20-%20%5Coverline%7B%5Cmathcal%7BF%7D%20I(x'%2C%20y')%7D%0A" alt="\ mathcal {F} I (x, y) \ leftarrow \ mathcal {F} I (x, y) - \ overline {\ mathcal {F} I (x ', y')}"></div><br>  The following figure contains a compressed image and an image obtained as a result of the inverse DFT after subtracting the interpolated background spectrum and resetting the DFT at all off-peak frequencies. <br><br><img src="https://habrastorage.org/files/530/af8/faf/530af8faf2e24bbe9f830b4ee1dc7464.png" height="190">  - DFT, subtraction of the background spectrum, inverse DFT ----&gt; <img src="https://habrastorage.org/files/069/890/058/06989005890f4567b7acba1e654efe21.png" height="190"><br><br>  As expected, only the periodic pattern remained on a plain monotone background, and instances of the periodic pattern became more similar to each other.  Note that the background is not black because the DFT value on <img src="http://tex.s2cms.ru/svg/(0%2C%200)" alt="(0, 0)">  The value averaged over the image has not been reset. <br><br><h4>  Suppressing the spectrum of pattern instances </h4><br>  After removing the background spectrum, we have left <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20f(x)%20%5Ccdot%20%5Cmathcal%7BF%7D%20c(x)" alt="\ mathcal {F} f (x) \ cdot \ mathcal {F} c (x)">  .  When multiplying two complex numbers, their phases are added.  Then, to reach the phase angle <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20c(i%2C%20j)" alt="\ mathcal {F} c (i, j)">  at peak <img src="http://tex.s2cms.ru/svg/(i%2C%20j)" alt="(i, j)">  corresponding to the phase angle of the spectrum of a single instance of a periodic pattern <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20f(i%2C%20j)" alt="\ mathcal {F} f (i, j)">  must be deducted. <br><br>  The problem is that the spectrum of the periodic pattern is usually unknown.  One of the possible solutions is the experimental calculation of the phase of the presented pattern of the pattern and its subsequent subtraction.  In our experiments, we used a different path, assuming that the phase contribution <img src="http://tex.s2cms.ru/svg/%5Cmathcal%7BF%7D%20f(i%2C%20j)" alt="\ mathcal {F} f (i, j)">  constant means to resultant shift <img src="http://tex.s2cms.ru/svg/%5Cphi" alt="\ phi">  one more constant shift is added.  This shift constant can be estimated experimentally as a systematic error on a test dataset. <br><br><h3>  Phase Shift Recovery </h3><br>  At the end of the spectrum preprocessing, we have the phase angle of the pulsed signal <img src="http://tex.s2cms.ru/svg/c(x)" alt="c (x)">  which presumably contains all the necessary information about the phase shift <img src="http://tex.s2cms.ru/svg/%7B%5Cphi%3D(%5Cphi_x%2C%20%5Cphi_y)%5ET%7D" alt="{\ phi = (\ phi_x, \ phi_y) ^ T}">  . <br>  We can build a system of equations (each equation corresponds to <img src="http://tex.s2cms.ru/svg/(i%2C%20j)" alt="(i, j)">  peak) modulo <img src="http://tex.s2cms.ru/svg/2%5Cpi" alt="2 \ pi">  : <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%0A%20%20%5Cbegin%7Bcases%7D%0A%20%20%20%20%5Cdots%20%5C%5C%0A%20%20%20%20i%5Ccdot%5Cphi_x%20%2B%20j%5Ccdot%5Cphi_y%20%3D%20%5Cphi_%7Bi%2C%20j%7D%20%5Cpmod%7B2%5Cpi%7D%20%5C%5C%0A%20%20%20%20%5Cdots%20%5C%5C%0A%20%20%5Cend%7Bcases%7D%0A" alt="\ begin {cases} \ dots \\ i \ cdot \ phi_x + j \ cdot \ phi_y = \ phi_ {i, j} \ pmod {2 \ pi} \\ \ dots \\ \ end {cases}"></div><br>  Or, in matrix form: <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%0A%20%20A%5Cphi%20%3D%20b%20%5Cpmod%7B2%5Cpi%7D%0A" alt="A \ phi = b \ pmod {2 \ pi}"></div><br>  The left part of the system contains the ‚Äúideal‚Äù phase values ‚Äã‚Äãcorresponding to the peaks, and the right part contains the actual value of the DFT phase for this image at the peak positions. <br><br>  This system is redefined, because  she has <img src="http://tex.s2cms.ru/svg/n" alt="n">  equations (by the number of peaks considered) and only 2 variables: <img src="http://tex.s2cms.ru/svg/%5Cphi_x" alt="\ phi_x">  and <img src="http://tex.s2cms.ru/svg/%5Cphi_y" alt="\ phi_y">  .  Overdetermined systems of equations can be approximately solved by the least squares (OLS) method by finding a solution that minimizes the sum of squared residuals.  However, this system is a modular system. <img src="http://tex.s2cms.ru/svg/2%5Cpi" alt="2 \ pi">  therefore, MNCs cannot be directly applied, but we can calculate the initial solution and correct it with a sequential solution of the system. <br><br><h4>  Calculation of the initial solution </h4><br>  Let's look at two equations for peaks numbered <img src="http://tex.s2cms.ru/svg/(2%2C%200)" alt="(20)">  and <img src="http://tex.s2cms.ru/svg/(0%2C%202)" alt="(0, 2)">  : <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%0A%20%20%5Cbegin%7Bcases%7D%0A%20%20%20%202%5Ccdot%5Cphi_x%20%2B%200%5Ccdot%5Cphi_y%20%3D%20%5Cphi_%7B2%2C%200%7D%20%5Cpmod%7B2%5Cpi%7D%20%5C%5C%0A%20%20%20%200%5Ccdot%5Cphi_x%20%2B%202%5Ccdot%5Cphi_y%20%3D%20%5Cphi_%7B0%2C%202%7D%20%5Cpmod%7B2%5Cpi%7D%0A%20%20%5Cend%7Bcases%7D%0A" alt="\ begin {cases} 2 \ cdot \ phi_x + 0 \ cdot \ phi_y = \ phi_ {2, 0} \ pmod {2 \ pi} \\ 0 \ cdot \ phi_x + 2 \ cdot \ phi_y = \ phi_ {0, 2} \ pmod {2 \ pi} \ end {cases}"></div><br>  This system has 4 valid solutions: <img src="http://tex.s2cms.ru/svg/(%5Cfrac%7B%5Cphi_%7B2%2C%200%7D%7D%7B2%7D%2C%5Cfrac%7B%5Cphi_%7B0%2C%202%7D%7D%7B2%7D)" alt="(\ frac {\ phi_ {2, 0}} {2}, \ frac {\ phi_ {0, 2}} {2})">  , <img src="http://tex.s2cms.ru/svg/(%5Cfrac%7B%5Cphi_%7B2%2C%200%7D%7D%7B2%7D%2B%5Cpi%2C%5Cfrac%7B%5Cphi_%7B0%2C%202%7D%7D%7B2%7D)" alt="(\ frac {\ phi_ {2, 0}} {2} + \ pi, \ frac {\ phi_ {0, 2}} {2})">  , <img src="http://tex.s2cms.ru/svg/(%5Cfrac%7B%5Cphi_%7B2%2C%200%7D%7D%7B2%7D%2C%5Cfrac%7B%5Cphi_%7B0%2C%202%7D%7D%7B2%7D%2B%5Cpi)" alt="(\ frac {\ phi_ {2, 0}} {2}, \ frac {\ phi_ {0, 2}} {2} + \ pi)">  and <img src="http://tex.s2cms.ru/svg/(%5Cfrac%7B%5Cphi_%7B2%2C%200%7D%7D%7B2%7D%2B%5Cpi%2C%5Cfrac%7B%5Cphi_%7B0%2C%202%7D%7D%7B2%7D%2B%5Cpi)" alt="(\ frac {\ phi_ {2, 0}} {2} + \ pi, \ frac {\ phi_ {0, 2}} {2} + \ pi)">  .  Because of the chessboard-like structure of peak patterns in our case, and also because <img src="http://tex.s2cms.ru/svg/2%5Cpi" alt="2 \ pi">  represents a shift by a unit period, the first with the fourth solution are identical, as well as the second with the third.  Two potential solutions remain: <img src="http://tex.s2cms.ru/svg/%5Cphi%5E*_1%20%3D%20(%5Cfrac%7B%5Cphi_%7B2%2C%200%7D%7D%7B2%7D%2C%5Cfrac%7B%5Cphi_%7B0%2C%202%7D%7D%7B2%7D)%5ET" alt="\ phi ^ * _ 1 = (\ frac {\ phi_ {2, 0}} {2}, \ frac {\ phi_ {0, 2}} {2}) ^ T">  and <img src="http://tex.s2cms.ru/svg/%5Cphi%5E*_2%20%3D%20(%5Cfrac%7B%5Cphi_%7B2%2C%200%7D%7D%7B2%7D%2B%5Cpi%2C%5Cfrac%7B%5Cphi_%7B0%2C%202%7D%7D%7B2%7D)%5ET" alt="\ phi ^ * _ 2 = (\ frac {\ phi_ {2, 0}} {2} + \ pi, \ frac {\ phi_ {0, 2}} {2}) ^ T">  . <br><br>  To choose the right solution, we can add to the system the two remaining equations for the peaks <img src="http://tex.s2cms.ru/svg/(1%2C%201)" alt="(eleven)">  and <img src="http://tex.s2cms.ru/svg/(1%2C%20-1)" alt="(eleven)">  by making the system redefined again.  Then, the value of the residual <img src="http://tex.s2cms.ru/svg/%5Cdelta_k" alt="\ delta_k">  calculated for <img src="http://tex.s2cms.ru/svg/k" alt="k">  th decision <img src="http://tex.s2cms.ru/svg/%5Cphi%5E*_k" alt="\ phi ^ * _ k">  with all <img src="http://tex.s2cms.ru/svg/n%3D4" alt="n = 4">  equations: <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%20%5Cdelta_k%20%3D%20%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi%2C%20j%7D%7B%5Cleft(%5Cbegin%7Bpmatrix%7Di%20%26%20j%5Cend%7Bpmatrix%7D%20%5Ccdot%5Cphi%5E*_k%20-%20%5Cphi_%7Bi%2C%20j%7D%5Cright)%5E2%7D%0A%20%20%20%20%20%20%20%20%20%20%20%3D%20%5Cfrac%7B1%7D%7Bn%7D%7CA%5Cphi%5E*_k-b%7C%5E2%20" alt="\ delta_k = \ frac {1} {n} \ sum_ {i, j} {\ left (\ begin {pmatrix} i &amp; amp; j \ end {pmatrix} \ cdot \ phi ^ * _ k - \ phi_ {i, j } \ right) ^ 2} = \ frac {1} {n} | A \ phi ^ * _ k-b | ^ 2"></div><br>  Note that intermediate calculations involving phase angles (difference calculation) are performed in <img src="http://tex.s2cms.ru/svg/%5B-%5Cpi%3B%20%5Cpi)" alt="[- \ pi; \ pi)">  . <br><br>  Finally, the solution <img src="http://tex.s2cms.ru/svg/%5Cphi%5E*_k" alt="\ phi ^ * _ k">  the lowest value <img src="http://tex.s2cms.ru/svg/%5Cdelta_k" alt="\ delta_k">  selected as <img src="http://tex.s2cms.ru/svg/%5Cphi%5E*" alt="\ phi ^ *">  Because the other solution will have much larger residual values.  Great importance <img src="http://tex.s2cms.ru/svg/%5Cdelta_k" alt="\ delta_k">  for <img src="http://tex.s2cms.ru/svg/%5Cphi%5E*_k" alt="\ phi ^ * _ k">  may mean false peak detection. <br><br><h4>  Solution adjustment </h4><br>  The initial solution found above could be good if the remaining spectrum contained only information about <img src="http://tex.s2cms.ru/svg/c(x)" alt="c (x)">  and nothing more.  Unfortunately, it is distorted by spectral components from the background and from samples of periodic patterns that were not completely removed during the preprocessing. <br><br>  At this stage, the selected solution <img src="http://tex.s2cms.ru/svg/%5Cphi%5E*" alt="\ phi ^ *">  is still true, but can be refined using phase information at different peaks, and not just for the first two.  Subtract <img src="http://tex.s2cms.ru/svg/A%5Cphi%5E*" alt="A \ phi ^ *">  (using <img src="http://tex.s2cms.ru/svg/n%3D4" alt="n = 4">  equations) from both sides of the system of equations, thus moving the solution space along <img src="http://tex.s2cms.ru/svg/%5Cphi%5E*" alt="\ phi ^ *">  and getting the following overdetermined system of equations for the corrective solution <img src="http://tex.s2cms.ru/svg/%5Ctheta" alt="\ theta">  : <br><br><div style="text-align:center;"><img src="http://tex.s2cms.ru/svg/%5Clabel%7Beq%3Acorrection_phase%7D%0A%20%20A%5Ctheta%20%3D%20b%20-%20A%5Cphi%5E*%0A" alt="\ label {eq: correction_phase} A \ theta = b - A \ phi ^ *"></div><br>  Assuming that, in the first approximation of the solution, we were no more mistaken than <img src="http://tex.s2cms.ru/svg/%5Cpi" alt="\ pi">  , we can not take the system modulo <img src="http://tex.s2cms.ru/svg/2%5Cpi" alt="2 \ pi">  because  after shifting the system, every equation will be inside <img src="http://tex.s2cms.ru/svg/2%5Cpi" alt="2 \ pi">  , which means that we can approximately solve the system using the least squares method.  After deciding <img src="http://tex.s2cms.ru/svg/%5Ctheta%5E*" alt="\ theta ^ *">  found, it should be added to the previously found initial solution <img src="http://tex.s2cms.ru/svg/%5Cphi%5E*" alt="\ phi ^ *">  as a correction value. <br><br>  So far, we have considered equations for the first 4 peaks. <img src="http://tex.s2cms.ru/svg/(i%2C%20j)" alt="(i, j)">  having <img src="http://tex.s2cms.ru/svg/(%7Ci%7C%20%2B%20%7Cj%7C)" alt="(| i | + | j |)">  an amount of 2 (and <img src="http://tex.s2cms.ru/svg/i%20%5Cge%200" alt="i \ ge 0">  because of the symmetry of the DFT), but there are other peaks with sums equal to 4, 6, and so on.  The reason why they were not added earlier is that when you increase <img src="http://tex.s2cms.ru/svg/(%7Ci%7C%20%2B%20%7Cj%7C)" alt="(| i | + | j |)">  the number of suitable system solutions is also increasing, and the closer they become to each other modulo <img src="http://tex.s2cms.ru/svg/2%5Cpi" alt="2 \ pi">  . <br><br>  To use the information about the phase shift contained in the remaining peaks, we can repeat the above process of adjusting the initial solution, replacing <img src="http://tex.s2cms.ru/svg/%5Cphi%5E*" alt="\ phi ^ *">  the adjusted solution obtained for an amount equal to 4 and using all equations having an amount equal to 6 and so on, until the required accuracy is achieved.  Assuming that the error decreases with increasing iteration, each equation will be within <img src="http://tex.s2cms.ru/svg/2%5Cpi" alt="2 \ pi">  That allows you to use OLS to solve the system. <br><br><h3>  Restoring the location of periodic patterns </h3><br>  Now having a phase shift <img src="http://tex.s2cms.ru/svg/%5Cphi%20%3D%20(%5Cphi_x%2C%20%5Cphi_y)" alt="\ phi = (\ phi_x, \ phi_y)">  , we can easily convert it back to pixel shift <img src="http://tex.s2cms.ru/svg/s%20%3D%20(s_x%2C%20s_y)" alt="s = (s_x, s_y)">  .  Knowing the period and size of the patterns, we can restore the position of each grid pattern.  The size and position of the excised region that we used in the process are also known, so we can get the position of the patterns on the original document image. <br><br>  The following picture, which you have already seen at the very beginning of the article, presents an example of finding a holographic periodic pattern on a Russian passport. <br><br><img src="https://habrastorage.org/files/15a/505/f46/15a505f46c604b48a3e1b085d8232f17.jpg" height="250"><img src="https://habrastorage.org/files/7fc/5bc/224/7fc5bc224a06449ca6b596949ffa9cb6.png" height="250"><br><br>  A box with a circle inside indicates the result found after solving the system of equations.  The other boxes indicate the extrapolated positions of the other patterns. <br><br><h2>  Experimental Results </h2><br>  We used a data set of 484 images of scanned Russian passports with holographic content.  For each image in the set, we prepared the true value of the pixel shift of its periodic pattern.  The table below contains the experimental results for this data set with the average value of the bias residual as a measure of accuracy. <br>  The error is given as a percentage of the side of a single pattern.  The preprocessing consisted of compression to size 56x58 and morphological closure operation;  when solving the system for obtaining the phase shift were considered <img src="http://tex.s2cms.ru/svg/n%3D4" alt="n = 4">  peak equations. <br><table><tbody><tr><th>  Background suppression </th><th>  Adjustment with OLS </th><th>  x error </th><th>  y mistake </th><th>  General error </th></tr><tr><td>  Missing </td><td>  Missing </td><td>  2.13 </td><td>  6.40 </td><td>  6.75 </td></tr><tr><td>  Present </td><td>  Missing </td><td>  2.09 </td><td>  6.04 </td><td>  6.40 </td></tr><tr><td>  Missing </td><td>  Present </td><td>  2.19 </td><td>  5.05 </td><td>  5.50 </td></tr><tr><td>  Present </td><td>  Present </td><td>  2.20 </td><td>  4.77 </td><td>  5.25 </td></tr></tbody></table><br>  The following figure shows the distribution <img src="http://tex.s2cms.ru/svg/x" alt="x">  and <img src="http://tex.s2cms.ru/svg/y" alt="y">  errors for the worst (left) and best (right) method.  Black cells represent error by <img src="http://tex.s2cms.ru/svg/x" alt="x">  , and white - by <img src="http://tex.s2cms.ru/svg/y" alt="y">  . <br><br><img src="https://habrastorage.org/files/431/cb1/71c/431cb171c5ac4409a1d0c6b20b1dd7aa.png" width="40%"><img src="https://habrastorage.org/files/b6f/111/680/b6f11168078e4cc98e044d5735f7691e.png" width="40%"><br><br>  In these histograms, the Y axis indicates how many percent of the images (out of 484) have an error close to the corresponding value along the X axis (as a percentage of the size of the side of the periodic pattern).  It can be seen that the distribution <img src="http://tex.s2cms.ru/svg/y" alt="y">  errors for a better method are less scattered than for a worse one. <br><br><h2>  Conclusion </h2><br>  We have proposed a method for searching for periodic patterns on document images, which uses a discrete Fourier transform and showed an average search error in <img src="http://tex.s2cms.ru/svg/6%5C%25" alt="6 \%">  (from the side of the periodic element) on a set of 484 images. <br>  We will describe the details of our application of this method in one of the following articles. </div><p>Source: <a href="https://habr.com/ru/post/266917/">https://habr.com/ru/post/266917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266905/index.html">FP on Scala: What is a functor?</a></li>
<li><a href="../266907/index.html">HP TippingPoint ATA Network and HP TippingPoint ATA Mail</a></li>
<li><a href="../266909/index.html">PHP and realpath_cache</a></li>
<li><a href="../266911/index.html">Crisis Junior System Administrator</a></li>
<li><a href="../266915/index.html">Technical website audit with Screaming Frog SEO Spider</a></li>
<li><a href="../266919/index.html">VI Hi-Tech Tour Inoventica Cloud Center: ‚ÄúIndian Summer in the Clouds‚Äù</a></li>
<li><a href="../266921/index.html">Sipuni: development path from a virtual PBX to a SaaS-service for receiving phone calls</a></li>
<li><a href="../266923/index.html">HostGator vs. GoDaddy - Hosting Review</a></li>
<li><a href="../266925/index.html">A collection of practical PHP tasks to prepare for an interview</a></li>
<li><a href="../266927/index.html">A story about making friends with the Nexus Player (FUGU) and the Intel Mobile Development Kit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>