<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using the Mikrotik log database to suppress brute force</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 In a previous publication, I explained how, easily and naturally, you can configure the collection of network traffic metadata on Mikroti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using the Mikrotik log database to suppress brute force</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br><br>  In a previous <a href="https://habr.com/post/427159/">publication,</a> I explained how, easily and naturally, you can configure the collection of network traffic metadata on Mikrotik routers into a database. <br><br>  Now it is time to teach our server to do elementary analysis of the received data and send commands back. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Purpose:</b> Dynamic management of Mikrotik firewall rules to suppress network attacks with brute force password. <br><br>  <b>Tools:</b> Fresh Linux distribution with rsyslogd v8, crond, mariadb, and the Mikrotik router itself. <br><br>  <b>Mechanics:</b> Using a scheduled task, executes a SQL query in the database with accumulated and replenished traffic data and returns a list of outgoing ip-addresses, the script launched by the bash cron creates Mikrotik commands and using the ssh connection replenishes the list of addresses for existing blocking rules. <br><a name="habracut"></a><br>  It's about protecting open TCP ports.  These can be ports on Mikrotik and forwarded to a local network. <br><br>  To begin with, we denote where there may be weak points: <br><br><ul><li>  Control protocols for router ssh, telnet, web, winbox </li><li>  Mail services smtp, pop, imap </li><li>  Any web services provided outside </li><li>  Remote Desktop MS RDP, VNC, etc. </li><li>  Anything else, at your discretion </li></ul><br>  <b>Writing SQL query to search for brute forcer</b> <br><br>  In our organization, there are terminal servers open to the outside through non-priority ports. <br>  In DNAT Mikrotik, I enabled the logging of the necessary rules by adding the prefix RDP_DNAT.  By this prefix we will search: <br><br><pre><code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,dport,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime&gt;<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'RDP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">having</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport)&gt;<span class="hljs-number"><span class="hljs-number">50</span></span>; +<span class="hljs-comment"><span class="hljs-comment">-----------------+-------+---------------------------------------+ | src | dport |   | +-----------------+-------+---------------------------------------+ | 185.156.177.58 | 12345 | 118 | | 185.156.177.59 | 12345 | 267 | | 193.238.46.12 | 12345 | 318 | | 193.238.46.13 | 12345 | 319 | | 193.238.46.99 | 12345 | 342 | | 194.113.106.150 | 12345 | 67 | | 194.113.106.152 | 12345 | 167 | | 194.113.106.153 | 12345 | 190 | | 194.113.106.154 | 12345 | 192 | | 194.113.106.155 | 12345 | 190 | | 194.113.106.156 | 12345 | 216 | | 194.113.106.158 | 12345 | 124 | +-----------------+-------+---------------------------------------+ 12 rows in set (0.06 sec)</span></span></code> </pre> <br>  This request shows the ip address (from which the attack is coming), the port to which the connection is made (the port number is changed) and the number of connection attempts, with preliminary grouping by src and a sample of lines, with more than 50 attempts in the past, from the current moment. <br><br>  In my case, these addresses can be safely banned, since the number of connections from ‚Äúgood‚Äù clients is less, not more than 5-10 per day from one ip. <br><br>  The request works fine, fast, but it is long.  For further use, I propose to make a view (view) that would be less copy-paste in the future: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> rdp_brute_day <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src, dport, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime&gt;<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'RDP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">having</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport)&gt;<span class="hljs-number"><span class="hljs-number">50</span></span>; Query OK, 0 rows affected (0.23 sec)</code> </pre><br>  Check how the view works: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rdp_brute_day; +<span class="hljs-comment"><span class="hljs-comment">----------------+--------------+ | src | count(dport) | +----------------+--------------+ | 185.156.177.58 | 11 | +----------------+--------------+ 1 row in set (0.09 sec)</span></span></code> </pre> <br>  Fine. <br><br>  <b>Add user Mikrotik with dsa key authorization</b> <br><br>  In the linux console, we generate the dsa key, under the user on whose behalf the scheduled task will be launched, I did from as root: <br><br><pre> <code class="bash hljs">root@monix:~<span class="hljs-comment"><span class="hljs-comment"># ssh-keygen -t dsa Generating public/private dsa key pair. Enter file in which to save the key (/root/.ssh/id_dsa): Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /root/.ssh/id_dsa. Your public key has been saved in /root/.ssh/id_dsa.pub. ...</span></span></code> </pre> <br>  Passphrase no need to appoint.  The public key /root/.ssh/id_dsa.pub is copied to Mikrotik in any available way.  I brought it with the cat command, copied the text from the putty window into a text file, saved it and dragged it into the winbox files window. <br><br>  I do not know why, but when performing the following operations through the winbox interface, something went wrong.  When connecting from the server via ssh, Mikrotik also asked me for a password.  After deleting the created user and performing all operations through the console, the dsa connection worked.  Did about how described <a href="https://14bytes.ru/ssh-mikrotik-dsa-no-password/">here</a> . <br><br>  In general, I received the desired entry without a password using the dsa key and ran the verification command: <br><br><pre> <code class="bash hljs">root@monix:/<span class="hljs-comment"><span class="hljs-comment"># ssh rsyslogger@192.168.0.230 /system resource print uptime: 2w1d5h22m43s version: 6.43.2 (stable) ...</span></span></code> </pre> <br>  Good. <br><br>  <b>Writing bash script</b> <br><br>  The script was not complicated: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mikrotik_cmd_list</span></span></span></span>(){ brute_src_list=$(mysql --skip-column-names traflog -e <span class="hljs-string"><span class="hljs-string">'select src from rdp_brute_day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$brute_src_list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"ip firewall address-list add address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$src</span></span></span><span class="hljs-string"> list=rdp_banlist timeout=1d"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> } mikrotik_cmd_list | ssh -T rsyslogger@192.168.0.230</code> </pre> <br>  In order to transfer all the commands within one ssh connection, I needed to describe the mikrotik_cmd_list () function, in which the request is first executed with ip addresses stored in the brute_src_list variable, then in the loop this variable sequentially generates commands for Mikrotik.  After calling the function, the output is routed through pipe to ssh. <br><br>  Do not forget to close the access rights to the script to everyone except root and make the file executable. <br>  The command that the script generates will add the ip address to rdp_banlist for 1 day, after that time it will be removed from the list.  If you want to leave it forever, remove the timeout option. <br><br>  <b>Add a rule to the firewall</b> <br><br>  I came up with two options for how to use the rdp_banlist list: <br><br>  <b>Option one:</b> add an rdp_banlist with an exclamation mark to the NAT rules with the prefix RDP_DNAT. <br><br><pre> <code class="bash hljs">add action=dst-nat chain=dstnat comment=<span class="hljs-string"><span class="hljs-string">"..."</span></span> dst-address=1.2.3.4 dst-port=12345 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=yes <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix=RDP_DNAT protocol=tcp src-address-list=\ !rdp_banlist to-addresses=192.168.200.181 to-ports=3389</code> </pre> <br>  Like that.  That is, dnaty everything except what is in rdp_banlist. <br><br>  In this embodiment, there are plus and minus. <br><br>  Plus, the connections will stop right there. <br><br>  The downside is that this ip will not get into the traflog database anymore and after a day, when the storage time in the blacklist passes, it will again begin to spoil. <br><br>  <b>Option two:</b> add the rdp_banlist list with an exclamation mark to the forward firewall rule where we allow traffic to pass on TCP 3389, similar to how it was done in the first method. <br><br><pre> <code class="bash hljs">add action=accept chain=forward comment=<span class="hljs-string"><span class="hljs-string">"..."</span></span> dst-port=3389 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=yes <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix=ACCEPT_RDP protocol=tcp src-address-list=\ !rdp_banlist to-ports=3389</code> </pre> <br>  Like that.  We allow everything except that in a banlist. <br><br>  Here, too, plus and minus. <br><br>  A plus.  Logs with the RDP_DNAT prefix will continue to be added to the traflog database, by which we determine the sign of the attack.  As a result, when the timeout of the ban of a specific host that continues to attempt a brute force ends, it will be added to the banlist again after the next launch of the scheduled task. <br><br>  The downside is that it continues to spoil the DSTNAT table, creating a new entry for each of its connections, even if it is temporary. <br><br>  In general, the decision is yours, I chose both :) (in fact, in this case only the first one works), since the second one was included before and the mechanics were different there, based on the sequential entry in the lists stage1, stage2, stage3, banlist ... well, you understand.  Old and not very reliable focus, can easily ban "good" clients and at the same time skip the "bad" politely timed stage1. <br><br>  <b>Crontab scheduled task</b> <br><br>  It remains to add the assigned task to the crontab: <br><br><pre> <code class="bash hljs">root@monix:/root<span class="hljs-comment"><span class="hljs-comment"># echo '12 * * * * root /usr/share/traflog/scripts/rdp_brute.sh &gt;/dev/null 2&gt;&amp;1' &gt;&gt; /etc/crontab</span></span></code> </pre><br>  Such a record will run the script every hour at 12 minutes. <br><br>  Admittedly, I just finished work on this mechanics today and with a high degree of probability something might go wrong.  As circumstances will supplement and correct errors.  I want to <s>drink to</s> sleep peacefully on New Year's holidays, therefore I am in a hurry to finish. <br>  That's probably all. <br><br>  Thank you all for your attention and Happy New Year! <br><br>  Bibliography: <br><br>  <a href="https://mariadb.com/kb/en/library/documentation/">Mysql documentation</a> <br>  <a href="https://wiki.mikrotik.com/wiki/Firewall">Mikrotik firewall documentation</a> <br>  Thanks to Andrei Smirnov for the <a href="https://14bytes.ru/ssh-mikrotik-dsa-no-password/">article</a> about connecting using the dsa key. </div><p>Source: <a href="https://habr.com/ru/post/434736/">https://habr.com/ru/post/434736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434726/index.html">Android device identification pitfalls</a></li>
<li><a href="../434728/index.html">People and processes: why is it not suitable for every company?</a></li>
<li><a href="../434730/index.html">In-memory databases: application, scaling and important additions</a></li>
<li><a href="../434732/index.html">Life at 6200 DPI. HyperX Pulsefire Core Review</a></li>
<li><a href="../434734/index.html">Fourier transform. The fast and the furious</a></li>
<li><a href="../434738/index.html">Learning with reinforcement in Python</a></li>
<li><a href="../434740/index.html">The neural network was taught to detect solar panels on satellite images and predict their level of distribution.</a></li>
<li><a href="../434742/index.html">Part 2: Using Cypress UDB PSoC Controllers to Reduce the Number of Interrupts in a 3D Printer</a></li>
<li><a href="../434744/index.html">Samsung SSD 860 QVO 1 TB and 4 TB: the first consumer SATA QLC (part 2)</a></li>
<li><a href="../434746/index.html">BLE under the microscope 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>