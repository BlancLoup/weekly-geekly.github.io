<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backup a large number of small files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sooner or later, setting up a backup of work files is puzzling any self-respecting modern IT specialist. After a number of programmer typos / errors, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backup a large number of small files</h1><div class="post__text post__text-html js-mediator-article">  Sooner or later, setting up a backup of work files is puzzling any self-respecting modern IT specialist.  After a number of programmer typos / errors, I found time for that. <br>  The specificity of a web application is such that the working directory occupies more than 50GB on hard disks, including about 900 thousand small files (pictures, thumbnails, ...).  Therefore, to solve the problem in the forehead with the help of tar and analogues did not work.  Yes, and I would like to have some variability of the stored data, and in the case of a full backup, the implementation required a large amount of storage costs for essentially the same data with little changes.  Plus, it would be nice to duplicate copies on a remote backup server to reduce the risk of losing critical information as a result of an iron crash.  After a rigorous analysis of search results and discarding methods that were obviously unsuitable to me, I stopped at a couple of options that were most often imposed in the comments on self-written shell bicycles of enthusiasts. <br><a name="habracut"></a><br><br><h5>  rdiff-backup </h5><br>  Rdiff-backup seemed to be more suitable and convenient.  Written in python, it stores data incrementally, allowing you to get the status of a file or directory at any time (in the foreseeable past, taking into account the storage time of images).  Flexible control from the console gives complete freedom of action and provides complete control over the situation.  The automatic creation of backups requires adding a couple of commands to the scheduler (the second to clean up old images that do not carry any value due to old changes). <br>  But testing has shown that the utility is very gluttonous and copes with my task extremely reluctantly.  The fact is that a small amount of data changes every day (300MB), but the changes affect about 30 thousand files.  To identify the modified files, apparently, spent most of the time the program.  After an hour of observations on the iowait increased to indecent 20% during the next run of the script, it was decided to try another software and compare them with each other. <br><br><h5>  rsnapshot </h5><br>  rsnapshot, written in Perl, is based on rsync.  In the working directory of the program (let's call it the place where the backups are added), a series of folders with an index is created, which increases each time the program starts to the value specified in the configuration.  Then the outdated copy is deleted.  If you go to any of the created folders, then inside you can find a complete copy of the backup data.  The total size of the folder also indicates this (when viewed using standard Midnight Commander tools, for example) - it is equal to the sum of all folders.  In fact, it is not.  The program creates hard links between identical data within the working directory.  Thus, the last actual copy is the ‚Äúheaviest‚Äù, and the size of all the others makes up the difference in the changed data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Testing </h5><br>  Since both options use approximately the same size for storage, it's time to check the speed of the backup tasks. <br><br>  For tests, a random project folder of 11 GB size was taken, containing 593 subdirectories of different nesting levels and 230911 files.  File size floats from 4 to 800KB, as stated above, this is in graphic material.  Both utilities were tested in turn, external factors were almost completely absent (no other users, workload and heavy processes).  Using the time utility, we calculated the execution time of each of the test tasks, as well as for comparison, copying the entire directory using cp tools: <br><br>  The first backup is a full copy to the place of backup 11090 <br><table><tbody><tr><td></td><td>  real </td><td>  user </td><td>  sys </td></tr><tr><td>  cp </td><td>  6m30.885s </td><td>  0m1.068s </td><td>  0m24.554s </td></tr><tr><td>  rsnapshot </td><td>  7m53.879s </td><td>  1m57.299s </td><td>  1m22.441s </td></tr><tr><td>  rdiff-backup </td><td>  10m50.314s </td><td>  3m26.073s </td><td>  1m0.928s </td></tr></tbody></table><br><br>  Restart (there were no changes in the folder) <br><table><tbody><tr><td></td><td>  real </td><td>  user </td><td>  sys </td></tr><tr><td>  rsnapshot </td><td>  0m10.129s </td><td>  0m4.936s </td><td>  0m6.708s </td></tr><tr><td>  rdiff-backup </td><td>  1m3.969s </td><td>  1m0.616s </td><td>  0m2.048s </td></tr></tbody></table><br><br>  Inside the directory one random folder is duplicated (the total size increases to 13267MB) <br><table><tbody><tr><td></td><td>  real </td><td>  user </td><td>  sys </td></tr><tr><td>  rsnapshot </td><td>  0m31.175s </td><td>  0m22.001s </td><td>  0m17.365s </td></tr><tr><td>  rdiff-backup </td><td>  <b>27m53.517s</b> </td><td>  1m58.819s </td><td>  0m19.005s </td></tr></tbody></table><br><br>  Restart after increasing the size of the directory (since the last change there are no changes) <br><table><tbody><tr><td></td><td>  real </td><td>  user </td><td>  sys </td></tr><tr><td>  rsnapshot </td><td>  0m11.477s </td><td>  0m5.748s </td><td>  0m7.368s </td></tr><tr><td>  rdiff-backup </td><td>  1m16.366s </td><td>  1m13.713s </td><td>  0m1.912s </td></tr></tbody></table><br><br>  Delete the duplicated folder, reducing the size of the directory to the original <br><table><tbody><tr><td></td><td>  real </td><td>  user </td><td>  sys </td></tr><tr><td>  rsnapshot </td><td>  0m13.885s </td><td>  0m6.388s </td><td>  0m9.077s </td></tr><tr><td>  rdiff-backup </td><td>  <b>52m55.794s</b> </td><td>  2m1.560s </td><td>  0m21.941s </td></tr></tbody></table><br><br>  Control restart without making changes <br><table><tbody><tr><td></td><td>  real </td><td>  user </td><td>  sys </td></tr><tr><td>  rsnapshot </td><td>  0m11.250s </td><td>  0m5.132s </td><td>  0m7.068s </td></tr><tr><td>  rdiff-backup </td><td>  1m2.380s </td><td>  1m0.088s </td><td>  0m1.792s </td></tr></tbody></table><br><br><h5>  Results </h5><br>  As can be seen from the comparative testing tables, rdiff-backup hardly digests the change of a large number of small files, therefore, it is more profitable to use rsnapshot in order not to waste most of the server time on picking up the file system. <br>  It may be useful for someone to see the test result and save time I spent on finding the best for the backup files described in the article. </div><p>Source: <a href="https://habr.com/ru/post/143383/">https://habr.com/ru/post/143383/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143375/index.html">Fight WordPress worm GetMama</a></li>
<li><a href="../143378/index.html">Taist: upgrade your internet</a></li>
<li><a href="../143379/index.html">Photos, videos and presentations from ZFConf 2012</a></li>
<li><a href="../143380/index.html">Kerbal Space Program</a></li>
<li><a href="../143382/index.html">Report from the conference Front Trends 2012</a></li>
<li><a href="../143384/index.html">Hojoki.com - organizing information flows for developers and not only ...</a></li>
<li><a href="../143386/index.html">Web technology vs Development speed and performance</a></li>
<li><a href="../143388/index.html">Correct implementation of the PID regulator difference scheme</a></li>
<li><a href="../143389/index.html">Devbar: news from the fields</a></li>
<li><a href="../143391/index.html">Domestic Qt-projects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>