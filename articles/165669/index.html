<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simulate dark-eye adaptation in 3D, or HDR for dummies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Everybody knows the effect of temporary blindness when you enter a dark room from a light one. According to a common misconception, the sensitivity of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simulate dark-eye adaptation in 3D, or HDR for dummies</h1><div class="post__text post__text-html js-mediator-article">  Everybody knows the effect of temporary blindness when you enter a dark room from a light one.  According to a common misconception, the sensitivity of vision is governed by the size of the pupil.  In fact, the change in the area of ‚Äã‚Äãthe pupil regulates the amount of incoming light by only 25 times, and the retinal cells themselves play the main role in adaptation. <br><br> <a href=""><img alt="title" src="http://ajenti.org/me/wp-content/uploads/2013/01/title.png" width="970" height="866"></a> <br><br>  To imitate this effect in games, a mechanism called <em>tonemapping is used</em> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      tonemapping - the process of projecting the entire infinite interval of brightness ( <strong>HDR</strong> , high dynamic range, from 0 to infinity) to the final interval of perception of the eye / camera / monitor ( <strong>LDR</strong> , low dynamic range, limited on both sides). <br><br>  In order to work with HDR, we need an appropriate screen buffer that supports values ‚Äã‚Äãgreater than one.  Our task will be to correctly convert these values ‚Äã‚Äãinto the range [0..1]. <br><br><a name="habracut"></a><br><br>  First of all, we must somehow find out the overall brightness of the scene.  To do this, calculate the geometric average brightness value of all pixels. <br><br>  However, for our night scene, this is slightly unreasonable, since most of the image area is dark, even if there is a bright light source, and therefore the average brightness is almost unchanged.  So take the maximum brightness, and divide it in half. <br><br>  Let's press our picture to the nearest square with a side equal to two and discolor it.  Then we will double it each time until one pixel remains: <br><br> <a href=""><img alt="Downsampling" src="http://ajenti.org/me/wp-content/uploads/2013/01/Downsampling.jpg" width="2048" height="788"></a> <br><br>  To compress the image, we will take four neighboring pixels and choose the middle one of them (for our case - the maximum one instead).  For the accelerated calculation of the geometric mean, we use the formula <br><br> <a href=""><img alt="6c1baa17500174ff1745d50bdabc1399" src="http://ajenti.org/me/wp-content/uploads/2013/01/6c1baa17500174ff1745d50bdabc1399.png" width="166" height="48"></a> <br><br><blockquote>  Why geometric?  Because the geometric mean <a href="http://wolfr.am/W2tuca">"to" higher values</a> , which means that brighter pixels will be selected (which we need, because we are interested in the light sources in the picture). </blockquote><br><br><pre><code class="cs hljs">RenderTextureFormat rtFormat = RenderTextureFormat.ARGBFloat; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lumBuffer == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { lumBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RenderTexture (LuminanceGridSize, LuminanceGridSize, <span class="hljs-number"><span class="hljs-number">0</span></span>, rtFormat, RenderTextureReadWrite.Default); } RenderTexture currentTex = RenderTexture.GetTemporary (InitialSampling, InitialSampling, <span class="hljs-number"><span class="hljs-number">0</span></span>, rtFormat, RenderTextureReadWrite.Default); Graphics.Blit (source, currentTex, material, PASS_PREPARE); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentSize = InitialSampling; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (currentSize &gt; LuminanceGridSize) { RenderTexture next = RenderTexture.GetTemporary (currentSize / <span class="hljs-number"><span class="hljs-number">2</span></span>, currentSize / <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, rtFormat, RenderTextureReadWrite.Default); Graphics.Blit (currentTex, next, material, PASS_DOWNSAMPLE); RenderTexture.ReleaseTemporary (currentTex); currentTex = next; currentSize /= <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Downsample pass Pass { CGPROGRAM #pragma vertex vert #pragma fragment fragDownsample float4 fragDownsample(v2f i) : COLOR { float4 v1 = tex2D(_MainTex, i.uv + _MainTex_TexelSize.xy * float2(-1,-1)); float4 v2 = tex2D(_MainTex, i.uv + _MainTex_TexelSize.xy * float2(1,1)); float4 v3 = tex2D(_MainTex, i.uv + _MainTex_TexelSize.xy * float2(-1,1)); float4 v4 = tex2D(_MainTex, i.uv + _MainTex_TexelSize.xy * float2(1,-1)); float mn = min(min(v1.x,v2.x), min(v3.x,v4.x)); float mx = max(max(v1.y,v2.y), max(v3.y,v4.y)); float avg = (v1.z+v2.z+v3.z+v4.z) / 4; return float4(mn, mx, avg, 1); } ENDCG } // Prepare pass Pass { CGPROGRAM #pragma vertex vert #pragma fragment fragPrepare float4 fragPrepare(v2f i) : COLOR { float v = tex2D(_MainTex, i.uv); float l = log(v + 0.001); return half4(l, l, l, 1); } ENDCG }</span></span></code> </pre> <br><br>  Note that when you log the source image, we add a small constant to avoid the collapse of the universe in the case of a completely black (0) pixel. <br><br>  At each step of reduction, the minimum (R), maximum (G), and log-average (B) brightness values ‚Äã‚Äãare stored in our texture. <br><br>  This is followed by a small trick that will avoid reading the texture and ‚Äúadapting‚Äù the eye completely to the GPU: we will get a permanent texture of 1 pixel size and on each frame we will impose on it a new brightness value (also 1 pixel) with a small alpha (transparency).  Thus, the stored brightness value will gradually come to the current, as required. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lumBuffer.IsCreated ()) { Debug.Log (<span class="hljs-string"><span class="hljs-string">"Luminance map recreated"</span></span>); lumBuffer.Create (); <span class="hljs-comment"><span class="hljs-comment">//     ,     Graphics.Blit (currentTex, lumBuffer); } else { material.SetFloat ("_Adaptation", AdaptationCoefficient); Graphics.Blit (currentTex, lumBuffer, material, PASS_UPDATE); }</span></span></code> </pre> <br><br>  AdaptationCoefficient - a coefficient of the order of 0.005, which determines the speed of adaptation to the brightness. <br><br>  It remains to take our two textures (the original image and brightness) and ‚Äútwist‚Äù the exposure in the first, using the value from the second. <br><br><pre> <code class="cs hljs">material.SetTexture (<span class="hljs-string"><span class="hljs-string">"_LumTex"</span></span>, lumBuffer); material.SetFloat (<span class="hljs-string"><span class="hljs-string">"_Key"</span></span>, Key); material.SetFloat (<span class="hljs-string"><span class="hljs-string">"_White"</span></span>, White); material.SetFloat (<span class="hljs-string"><span class="hljs-string">"_Limit"</span></span>, Limit); Graphics.Blit (source, destination, material, PASS_MAIN);</code> </pre> <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Main pass Pass { CGPROGRAM #pragma vertex vert #pragma fragment frag float4 frag(v2f i) : COLOR { half4 cColor = tex2D(_MainTex, i.uv); float4 cLum = tex2D(_LumTex, i.uv); float lMin = exp(cLum.x); float lMax = exp(cLum.y); float lAvg = exp(cLum.z); lAvg = max(lMax / 2, _Limit); // force override for dark scene float lum = max(0.000001, Luminance(cColor.rgb)); float scaled = _Key / lAvg * lum; scaled *= (1 + scaled / _White / _White) / (1+scaled); return scaled * cColor; } ENDCG }</span></span></code> </pre> <br><br>  Here we restore the brightness value from the logarithm, calculate the scaling factor (scaled), and make a correction for the white level (_White). <br><br>  Parameters used: <br><ul><li>  Key - adjusts the overall brightness of the scene, which is considered "normal" </li><li>  Limit - limits the maximum photosensitivity of the eye, not allowing to see how the Predator </li><li>  White - adjusts the width of the range, indicating which brightness will be considered "white" in the image </li></ul><br>  Result: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/kPK1sepLzVs%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253&amp;usg=ALkJrhiICmGbeHBGCq1p0OfqtKaAHSXZ-A" frameborder="0" allowfullscreen=""></iframe><br><br>  You can get an interesting result by reducing the texture of the brightness not to one pixel, but stopping in a few steps (increasing LuminanceGridSize).  Then separate areas of the screen will ‚Äúget used‚Äù independently.  In addition, there will be a ‚Äúdark spot‚Äù effect, when one area of ‚Äã‚Äãthe mesh is lit up, if you look directly at the lamp.  However, in most cases, the brain automatically hides the effect of light, and on the monitor it looks unnatural and unusual. <br><br>  Read more about daytime tonemapping'e read <a href="http://www.cs.utah.edu/~reinhard/cdrom/tonemap.pdf">at Reinhard</a> <br>  <a href="https://gist.github.com/4524914">Code</a> <br>  <a href="https://gist.github.com/4524912">Shader</a> </div><p>Source: <a href="https://habr.com/ru/post/165669/">https://habr.com/ru/post/165669/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165657/index.html">The new Samsung refrigerator offers recipes based on its contents.</a></li>
<li><a href="../165659/index.html">Procrastination New tasks. Part 2</a></li>
<li><a href="../165661/index.html">Quipu is an esoteric programming language based on the Incas nodular script</a></li>
<li><a href="../165663/index.html">Optimization of LIKE expression when using Sqlite in iOS application</a></li>
<li><a href="../165667/index.html">Little Brave Arkanoid (Part 1 - IwGl)</a></li>
<li><a href="../165671/index.html">Mass publication of online journal articles in memory of Aaron Schwarz</a></li>
<li><a href="../165675/index.html">Results 24pullrequests</a></li>
<li><a href="../165677/index.html">ViBe - background subtraction algorithm</a></li>
<li><a href="../165681/index.html">Flyme 2.0 Review</a></li>
<li><a href="../165683/index.html">Where the hashCode legs grow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>