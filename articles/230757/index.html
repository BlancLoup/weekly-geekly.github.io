<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Free up hard disk space: WIMBoot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, stationary computers are beginning to slowly recede into the background. Their place is firmly occupied by laptops, and then go and tablet comp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Free up hard disk space: WIMBoot</h1><div class="post__text post__text-html js-mediator-article">  Today, stationary computers are beginning to slowly recede into the background.  Their place is firmly occupied by laptops, and then go and tablet computers.  The combination of mobility, high performance and high speed of obtaining information - all this is an undoubted advantage of tablets.  However, the tablets have their own fly in the ointment: this is the small size of hard drives.  If the disk is 16, 32 or even 64 GB, I don‚Äôt want to throw away valuable files on the installation files.  With the release of Windows 8.1 Update, a solution to this problem appeared - WIMBoot is a new way to install the OS, providing more free space for the user. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/10f/da9/354/10fda9354c6f123c2a0ed32f03c9fc6c.jpg"><br><a name="habracut"></a><br><h4>  Technology Overview </h4><br>  So, what is WIMBoot (Windows Image Boot)?  This technology is designed for devices with a small amount of hard drives, with which it provides more space for user data and applications after installing the operating system.  Immediately list the limitations when using WIMBoot: <br><ul><li>  WIMBoot can only be used on UEFI computers running in UEFI mode.  BIOS compatibility mode is not supported. </li><li>  WIMBoot is designed for devices with a small amount of SSD or eMMC hard drives. </li><li>  WIMBoot is only available for Windows 8.1 Update and is not supported for server operating systems.  WIMBoot is available for all processor architectures (amd64, x86, and ARM). </li></ul><br>  What is the difference between WIMBoot and the usual Windows installation?  In a typical Windows installation, each installation file is written to the disk twice: in compressed form in case of recovery and in unzipped form for use.  Thus, the size of the space available to the user is reduced. <br><img src="https://habrastorage.org/getpro/habr/post_images/1c7/a06/373/1c7a06373730f9ea3d78bba75b9da1f8.jpg" alt="image"><br><h6>  Standard partitioning scheme (without WIMBoot) </h6><br><br>  When installing Windows using WIMBoot, files are written to the hard disk only once and in compressed format.  Next, the Pointer files, which refer to the compressed files in the image section, are applied to the Windows partition. <br><img src="https://habrastorage.org/getpro/habr/post_images/34c/1ea/8d1/34c1ea8d1fcfd2c0400ef3d2bb7fb5b1.jpg"><br><h6>  Partition diagram when using WIMBoot </h6>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What are the advantages of WIMBoot?  From a technical point of view, the user will not notice the difference in the operation of the system.  All user files will be visible and accessible without any transformations.  At the same time, the place on the device will be much more.  For example, with a typical installation of Windows 8.1 on a 16 GB hard disk, approximately 7 GB will be available to the user.  In the case of installing the system from the WIMBoot image, the free space will increase, and about 12 GB will be available to the user. <br>  Now we will try to create the WIMBoot image ourselves and deploy it.  To do this, you need a Windows 8.1 Update image, Windows Assessment and Deployment Kit for Windows 8.1 and a Windows PE 5.1 ‚Äã‚Äãboot disk.  To check the version of Windows PE in the <b>wpeinit</b> environment, <b>you</b> must run the registry editor ( <b>regedit</b> ) and check the following registration key: <br><pre><code class="actionscript hljs">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\WinPE</code> </pre> <br>  If the WinPE version is 5.1, Windows PE may not be updated. <br>  Start by installing the Windows ADK. To begin, install the following components from the Windows ADK for Windows 8.1: this is Deployment Image and Management and PE Environment ( <a href="http://www.microsoft.com/ru-ru/download/details.aspx%3Fid%3D39982">download</a> ).  You can create a WIMBoot image both on a computer running Windows 8 and Windows 8.1, and on Windows Server 2012. <br>  After the Windows ADK is installed, you need to run <b>Deployment Image and Management</b> as an administrator.  It is with her and we have to work.  Also, for convenience, we will use the following directory system: <br><pre> <code class="actionscript hljs">C:\Images ‚Äì ,     C:\mount ‚Äì ,      C:\MSU ‚Äì ,      </code> </pre><br>  Copy the <b>install.wim</b> file from the Windows 8.1 installation image to the <b>C: \ Images</b> directory. <br>  Before describing in detail the process of creating a WIMBoot image, I will list the main steps that need to be done. <br><ol><li>  Creating a WIMBoot image <br><ol><li>  Creating a temporary copy of the Windows installation image </li><li>  Separate recovery image from main Windows image </li><li>  Image Optimization for WIMBoot </li></ol></li><li>  Creating a WinPE 5.1 ‚Äã‚ÄãBoot Disk </li><li>  Adding WIMBoot to the boot disk </li><li>  WIMBoot Deployment <br><ol><li>  Formatting a hard disk using a WIMBoot partition scheme </li><li>  Adding Windows and Recovery Files </li><li>  WIMBoot folder protection </li></ol></li></ol><br>  Further we will consider each of these steps in detail.  At the end of the article as additional materials are detailed descriptions of the processes of updating the Windows image, the WinPE image, as well as instructions for checking the final WIMBoot image. <br><br><h4>  1. Creating a WIMBoot Image </h4><br>  Using updated Windows files, create a WIMBoot image. <br><h5>  1.1 Creating a temporary copy of the image for installing Windows </h5><br>  Copy the updated <b>install.wim</b> file to a new temporary file.  This file will be used to install WIMBoot. <br><pre> <code class="actionscript hljs">Copy C:\Images\install.wim C:\Images\install_temp.wim</code> </pre><br>  Create a directory and mount the image there. <br><pre> <code class="actionscript hljs">md C:\mount\Windows Dism /Mount-Image /ImageFile:<span class="hljs-string"><span class="hljs-string">"C:\Images\install_temp.wim"</span></span> /Index:<span class="hljs-number"><span class="hljs-number">1</span></span> /MountDir:C:\mount\Windows</code> </pre><br><h5>  1.2 Separating the recovery image from the main Windows image </h5><br>  Move the Windows RE image ( <b>winre.wim</b> ) from the mounted directory.  Add a few words about Windows RE.  Windows Recovery Environment is an extensible recovery platform based on Windows PE.  In the process of creating a WIMBoot image, the Windows RE image is recommended to separate from the main Windows image.  Otherwise, the image will require approximately 200 MB of free hard disk space that will not be used.  I also want to note that the <b>winre.wim</b> file <b>is</b> usually hidden, so it needs to be made visible. <br><pre> <code class="actionscript hljs">attrib ‚Äìs -h C:\mount\Windows\Windows\System32\Recovery\winre.wim move C:\mount\Windows\Windows\System32\Recovery\winre.wim C:\images\winre.wim</code> </pre><br><h5>  1.3 Image Optimization for WIMBoot </h5><br>  We optimize the image WIMBoot. <br><pre> <code class="actionscript hljs">Dism /Optimize-Image /Image:C:\mount\Windows /WIMBoot</code> </pre><br>  Unmount the image <br><pre> <code class="actionscript hljs">Dism /Unmount-Image /MountDir:C:\mount\Windows /Commit</code> </pre><br><br><h4>  2. Creating a WinPE 5.1 ‚Äã‚ÄãBoot Disk </h4><br>  Create a working copy of Windows PE files.  Two versions of <b>x86</b> or <b>amd64 are available</b> . <br><pre> <code class="actionscript hljs">copype amd64 C:\WinPE_amd64</code> </pre><br>  If necessary, update WinPE 5.0 to WinPE 5.1.  A detailed description of the update process, see the appendix. <br>  The next step is to create a WinPE 5.1 ‚Äã‚Äãboot disk.  There are several possible options.  In the simplest version, you can write files to a regular USB flash drive.  The size of the flash card is better to choose 16 GB or more, because  It will be necessary to do some further manipulations with the image, for which additional space will be needed.  You can create a bootable USB flash drive using the command: <br><pre> <code class="actionscript hljs">MakeWinPEMedia /UFD C:\WinPE_amd64 F:</code> </pre><br>  In my case, WIMBoot was tested on a Hyper-V virtual machine.  To simulate the standard installation process of WIMBoot on a tablet from a flash drive, I will use a virtual hard disk and describe the process of creating it.  To write a Windows PE image to VHD, we use the <b>diskpart</b> tool and enter the following commands: <br><pre> <code class="actionscript hljs">Diskpart create vdisk file=‚ÄùC:\WinPE.vhdx‚Äù maximum=<span class="hljs-number"><span class="hljs-number">16000</span></span> attach vdisk create partition primary assign letter=V format fs=ntfs quick exit</code> </pre><br>  Next, write the WinPE files to the virtual disk we created. <br><pre> <code class="actionscript hljs">MakeWinPEMedia /UFD C:\WinPE_amd64 V:</code> </pre><br>  Run <b>diskpart</b> again and finish creating the disk. <br><pre> <code class="actionscript hljs">Diskpart select vdisk file=‚ÄùC:\WinPE.vhdx‚Äù detach vdisk exit</code> </pre><br><br><h4>  3. Adding WIMBoot to the boot disk </h4><br>  After the WinPE 5.1 ‚Äã‚Äãimage has been created and the WIMBoot image has been prepared, you can close Deployment Image and Management.  We will continue to work without it.  Now you need to add the WIMBoot image files to the WinPE 5.1 ‚Äã‚Äãdisk (copy the entire <b>Images</b> folder).  Also, I recommend adding some <b>diskpart</b> scripts to the <b>bootdisk</b> , which will save us time when creating and deploying a WIMBoot image.  These scripts are optional, you can add them later or not add to the image at all. <br>  You can add WIMBoot to a boot disk on absolutely any computer or virtual machine, as long as they comply with the restrictions imposed by WIMBoot technology.  I will continue to work with the virtual machine and create a second-generation virtual machine ( <b>Generation 2</b> ) in Hyper-V, which supports UEFI technology.  As an image for installing the operating system, I will point to the <b>WinPE.vhdx</b> virtual disk created earlier.  I created a WinPE image with WIMBoot on a virtual machine with a hard disk size of 32 GB.  And installing the system using WIMBoot already on a virtual machine with a hard disk size for the virtual machine being created will be 16 GB to simulate installation on a tablet with a small hard disk size.  <b>We load the</b> virtual machine from the <b>WinPE.vhdx</b> disk and wait for the <b>wpeinit utility</b> to start (it may take a few minutes). <br>  Use the <b>diskpart</b> utility to create hard disk partitions.  You can run the script below with the command <br><pre> <code class="actionscript hljs">diskpart /s C:\Createpartition.txt</code> </pre><br>  You can check the location of the script file by running the <b>diskpart</b> utility and the <b>list volume</b> command.  You must specify the path to the <b>WinPE</b> drive. <br><pre> <code class="actionscript hljs">rem == CreatePartitions.txt == select disk <span class="hljs-number"><span class="hljs-number">0</span></span> clean convert gpt rem ==      == create partition primary size=<span class="hljs-number"><span class="hljs-number">300</span></span> format quick fs=ntfs label=‚ÄùWindows RE tools‚Äù assign letter=‚ÄùT‚Äù <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> id=‚Äùde94bba4<span class="hljs-number"><span class="hljs-number">-06</span></span>d1<span class="hljs-number"><span class="hljs-number">-4</span></span>d40-a16a-bfd50179d6ac‚Äù gpt attributes=<span class="hljs-number"><span class="hljs-number">0x8000000000000001</span></span> rem ==    == create partition efi size=<span class="hljs-number"><span class="hljs-number">100</span></span> format quick fs=fat32 label=‚ÄùSystem‚Äù assign letter=‚ÄùS‚Äù rem ==   MSR == create partition msr size=<span class="hljs-number"><span class="hljs-number">128</span></span> rem ==   Windows == create partition primary shrink minimum=<span class="hljs-number"><span class="hljs-number">10000</span></span> format quick fs=ntfs label=‚ÄùWindows‚Äù assign letter=‚ÄùW‚Äù rem ==     == create partition primary format quik fs=ntfs label=‚ÄùRecovery image‚Äù assign letter=‚ÄùR‚Äù <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> id=‚Äùde94bba4<span class="hljs-number"><span class="hljs-number">-06</span></span>d1<span class="hljs-number"><span class="hljs-number">-4</span></span>d40-a16a-bfd50179d6ac‚Äù gpt attributes=<span class="hljs-number"><span class="hljs-number">0x8000000000000001</span></span> list volume exit</code> </pre><br>  A small comment about the team <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> id=‚Äùde94bba4<span class="hljs-number"><span class="hljs-number">-06</span></span>d1<span class="hljs-number"><span class="hljs-number">-4</span></span>d40-a16a-bfd50179d6ac‚Äù gpt attributes=<span class="hljs-number"><span class="hljs-number">0x8000000000000001</span></span></code> </pre><br>  Using the above script does not allow the user to see recovery partitions through explorer, however, through the Disk Management Tools, the user can delete these partitions.  To prevent the deletion of recovery partitions and use the above command. <br>  After executing this script, you should see something like the following. <br><img src="https://habrastorage.org/getpro/habr/post_images/1b6/def/215/1b6def21587d2873990a02c138288216.jpg"><br>  As a result, we got the following sections (MSR is a Microsoft backup section and is not displayed in the output of this command): <br><img src="https://habrastorage.org/getpro/habr/post_images/cf6/a53/299/cf6a53299d4a3a4abd51dc4abbadb781.jpg"><br>  Next, perform the installation image.  First, create a directory on the R drive and copy the installation image there. <br><pre> <code class="actionscript hljs">md R:\RI copy C:\Images\install.wim R:\RI\install.wim</code> </pre><br>  Apply the <b>install.wim</b> image to the Windows partition. <br><pre> <code class="actionscript hljs">dism /Apply-Image /ImageFile:R:\RI\install.wim /Index:<span class="hljs-number"><span class="hljs-number">1</span></span> /ApplyDir:W:\</code> </pre><br>  Copy the recovery tools to the Windows RE partition. <br><pre> <code class="actionscript hljs">md T:\Recovery\WindowsRE attrib ‚Äìs ‚Äìh W:\windows\system32\recovery\winre.wim copy W:\windows\system32\recovery\winre.wim T:\Recovery\WindowsRE\winre.wim</code> </pre><br>  Copy the boot files from the Windows partition to the System partition.  This step is needed in order to download a deployed image. <br><pre> <code class="actionscript hljs">bcdboot W:\Windows</code> </pre><br>  Register a Windows partition and a recovery partition <br><pre> <code class="actionscript hljs">W:\Windows\System32\reagentc /setosimage /path R:\RI /target W:\Windows /index <span class="hljs-number"><span class="hljs-number">1</span></span> W:\Windows\System32\reagentc /setreimage /path T:\Recovery\WindowsRE /target W:\Windows</code> </pre><br>  Restart the computer.  With a new boot, wait for the screen to start setting. <br><img src="https://habrastorage.org/getpro/habr/post_images/a96/1a4/8c2/a961a48c299156bb037e9bc5f29cfd2a.jpg" width="250" height="250"><br>  When it appears, you must press the <b>CTRL + SHIFT + F3</b> combination to restart the computer in audit mode.  After that, the computer will start the system under the account of the local administrator.  In a Windows 8.1 environment, you will need to run a command prompt with Administrator rights and clean up the image.  Cleaning the image will free up additional disk space. <br><pre> <code class="actionscript hljs">dism /Cleanup-Image /Online /StartComponentCleanup</code> </pre><br>  After that, using the <b>Sysprep</b> command, we will prepare the computer for use and complete the work. <br><pre> <code class="actionscript hljs">C:\Windows\System32\Sysprep\sysprep /generalize /shutdown /oobe</code> </pre><br>  Start the computer again in WinPE mode.  I recommend running the <b>diskpart</b> utility and the <b>list volume</b> command.  You must have letters assigned to the Windows disk and to the WinPE disk.  All other sections are hidden. <br><img src="https://habrastorage.org/getpro/habr/post_images/536/b94/a82/536b94a82a8192f3d3266bd24c247fd2.jpg"><br>  Create a directory for temporary files <b>C: \ Recycler \ Scratch</b> and re-capture the image, but with the option WIMBoot. <br><pre> <code class="actionscript hljs">DISM /Capture-Image /WIMBoot /ImageFile:<span class="hljs-string"><span class="hljs-string">"D:\Images\install_wimboot.wim"</span></span> /CaptureDir:C: /Name:<span class="hljs-string"><span class="hljs-string">"WIMBoot Enterprise_x64 with 8.1 Updates"</span></span> /ScratchDir:C:\Recycler\Scratch</code> </pre><br>  After the command is completed, we can turn off the computer.  Now on our virtual disk or on a flash drive there is a WIMBoot installation image. <br><br><h4>  4. Deploy WIMBoot </h4><br>  Now it remains only to test the WIMBoot image and make sure that the size of the files occupied by Windows will decrease.  As mentioned earlier, the installation will use a second-generation virtual machine that supports UEFI technology with a hard disk capacity of 16 GB.  As the installation disk, use the <b>WinPE.vhdx</b> virtual disk and start the virtual machine. <br><h5>  4.1 Formatting a hard disk according to the WIMBoot partition scheme </h5><br>  <b>Let's wait for the wpeinit</b> environment to <b>start</b> , run the <b>diskpart</b> utility and the <b>list volume</b> command.  If the letter C is assigned to the WinPE partition, I recommend reassigning it with the following commands. <br><pre> <code class="actionscript hljs">select volume=<span class="hljs-number"><span class="hljs-number">0</span></span> assign letter=‚ÄùD‚Äù exit</code> </pre><br>  Now, using the <b>diskpart</b> utility and the script below, we create partitions for installation.  Run the script with the command <br><pre> <code class="actionscript hljs">diskpart /s D:\WimCreatePartition.txt</code> </pre><br><br><pre> <code class="actionscript hljs">rem == WimCreatePartition.txt == select disk <span class="hljs-number"><span class="hljs-number">0</span></span> clean convert gpt rem ==    == create partition efi size=<span class="hljs-number"><span class="hljs-number">100</span></span> format quick fs=fat32 label=‚ÄùSystem‚Äù rem ==   MSR == create partition msr size=<span class="hljs-number"><span class="hljs-number">128</span></span> rem ==   Windows == create partition primary shrink minimum=<span class="hljs-number"><span class="hljs-number">5000</span></span> format quick fs=ntfs label=‚ÄùWindows‚Äù assign letter=‚Äù‚Äù rem ==     == create partition primary format quick fs=ntfs label=‚ÄùImages‚Äù assign letter=‚ÄùM‚Äù <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> id=‚Äùde94bba4<span class="hljs-number"><span class="hljs-number">-06</span></span>d1<span class="hljs-number"><span class="hljs-number">-4</span></span>d40-a16a-bfd50179d6ac‚Äù gpt attributes=<span class="hljs-number"><span class="hljs-number">0x8000000000000001</span></span> list volume exit</code> </pre><br>  As a result, we should get the following result: <br><img src="https://habrastorage.org/getpro/habr/post_images/79c/d03/e95/79cd03e95f380e6d272e6fe8155129ad.jpg"><br><h5>  4.2 Adding Windows and Recovery Files </h5><br>  Create a folder <b>‚ÄúWindows Images‚Äù</b> in the Images section.  The folder name must be ‚ÄúWindows Images‚Äù. <br><pre> <code class="actionscript hljs">md <span class="hljs-string"><span class="hljs-string">"M:\ Windows Images \"</span></span></code> </pre><br>  Copy the Windows image from the WinPE disk to the Windows Images folder and rename it to <b>install.wim</b> , if necessary. <br><pre> <code class="actionscript hljs">copy D:\Images\install_update1.wim <span class="hljs-string"><span class="hljs-string">"M:\Windows Images\install.wim"</span></span></code> </pre><br>  Apply a Windows image to a Windows partition using the <b>/ WIMBoot command</b> .  Before this, we create a directory for temporary files to avoid problems with short file names. <br><pre> <code class="actionscript hljs">md C:\Recycler\Scratch DISM /Apply-Image /ImageFile:<span class="hljs-string"><span class="hljs-string">"M:\Windows Images\install.wim"</span></span> /ApplyDir:C: /Index:<span class="hljs-number"><span class="hljs-number">1</span></span> /WIMBoot /ScratchDir:C:\Recycler\Scratch</code> </pre><br>  Create download files and configure them to work in the Windows partition. <br><pre> <code class="actionscript hljs">C:\Windows\System32\bcdboot C:\Windows</code> </pre><br>  Copy the Windows Recovery Environment Image to the Images folder <br><pre> <code class="actionscript hljs">md M:\Recovery\WindowsRE echo f | xcopy D:\Images\winre.wim M:\Recovery\WindowsRE\winre.wim /h</code> </pre><br>  Register a Windows recovery environment partition. <br><pre> <code class="actionscript hljs">C:\Windows\System32\Reagentc /SetREImage /Path M:\Recovery\WindowsRE /Target C:\Windows</code> </pre><br><h5>  4.3 WIMBoot folder protection </h5><br>  It remains to protect the sections of Windows images and verify the results.  To set the attribute <i>"read only"</i> in the environment <b>wpeinit</b> run the following commands <br><pre> <code class="actionscript hljs">icacls <span class="hljs-string"><span class="hljs-string">"M:\Windows Images"</span></span> /inheritance:r /T icacls <span class="hljs-string"><span class="hljs-string">"M:\Windows Images"</span></span> /grant:r SYSTEM:(R) /T icacls <span class="hljs-string"><span class="hljs-string">"M:\Windows Images"</span></span> /grant:r *S<span class="hljs-number"><span class="hljs-number">-1</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span><span class="hljs-number"><span class="hljs-number">-32</span></span><span class="hljs-number"><span class="hljs-number">-544</span></span>:(R) /T</code> </pre><br>  Now you just have to start the computer and see a nice picture: <br><img src="https://habrastorage.org/getpro/habr/post_images/81d/ecf/dae/81decfdaed0b2fde987d9ff132485612.jpg"><br>  What happened?  Now the free disk on the Windows partition has become more.  This is due to the fact that the Windows partition now contains pointer files that refer to Windows images.  In this case, the user does not feel the difference in the work: all his files are working normally. <br><img src="https://habrastorage.org/getpro/habr/post_images/10f/da9/354/10fda9354c6f123c2a0ed32f03c9fc6c.jpg"><br>  In conclusion, I want to additionally note that if there is a need to add any additional settings to the WIMBoot image, this can be done before the WIMBoot folders are protected.  Further information on <a href="http://technet.microsoft.com/ru-ru/library/dn621983.aspx">WIMBoot can be found on TechNet</a> . <br><br>  I hope the information will be useful! <br><br><h3>  application </h3><br><div class="spoiler">  <b class="spoiler_title">Install Update: WinPE 5.0 -&gt; WinPE 5.1</b> <div class="spoiler_text">  Let's move on to creating WinPE and updating it.  Basically, you can first simply create WinPE, try to download the target computer with it and check its version.  However, here I will give the whole process of creating an image. <br>  A working copy of the Windows PE files must first be created. <br>  Mount the Windows PE image <br><pre> <code class="actionscript hljs">Dism /Mount-Image /ImageFile:<span class="hljs-string"><span class="hljs-string">"C:\WinPE_amd64\media\sources\boot.wim"</span></span> /index:<span class="hljs-number"><span class="hljs-number">1</span></span> /MountDir:<span class="hljs-string"><span class="hljs-string">"C:\WinPE_amd64\mount"</span></span></code> </pre><br>  Add service packs to your Windows PE image.  The set of service packs is the same as was used to update the Windows 8.1 image can be downloaded <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D42335">here</a> .  It is important when downloading the package <b>KB2919355</b> also download packages <b>KB2919355</b> , <b>KB2932046</b> , <b>KB2934018</b> , <b>KB2937592</b> , <b>KB2938439</b> , and <b>KB2959977</b> .  Packages must be installed in order and separately. <br><pre> <code class="actionscript hljs">Dism /Add-Package /PackagePath:C:\MSU\Windows8<span class="hljs-number"><span class="hljs-number">.1</span></span>-&lt;Package&gt;-&lt;arch&gt;.msu /Image:C:\mount\Windows /LogPath:AddPackage.log</code> </pre><br>  We optimize the image <br><pre> <code class="actionscript hljs">Dism /Image::\WinPE_amd64\mount /Cleanup-Image /StartComponentCleanup /ResetBase</code> </pre><br>  Unmount the Windows PE image <br><pre> <code class="actionscript hljs">Dism /Unmount-Image /MountDir:<span class="hljs-string"><span class="hljs-string">"C:\WinPE_amd64\mount"</span></span> /commit</code> </pre><br>  Export and convert a Windows PE image to a new wim file <br><pre> <code class="actionscript hljs">Dism /Export-Image /SourceImageFile:C:\WinPE_amd64\media\sources\boot.wim /SourceIndex:<span class="hljs-number"><span class="hljs-number">1</span></span> /DestinationImageFile:C:\WinPE_amd64\media\sources\boot2.wim</code> </pre><br>  Replace the <b>boot.wim</b> file <b>with the</b> new <b>boot2.wim</b> file <br><pre> <code class="actionscript hljs">del C:\WinPE_amd64\media\sources\boot.wim rename C:\WinPE_amd64\media\sources\boot2.wim boot.wim</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">WIMBoot Image Verification</b> <div class="spoiler_text">  And now I will give the commands to check the WIMBoot image that must be run in the wpeinit environment. <br><ul><li>  Check for System, MSR, Windows, and Images </li></ul><br><pre> <code class="actionscript hljs">diskpart select disk <span class="hljs-number"><span class="hljs-number">0</span></span> select partition <span class="hljs-number"><span class="hljs-number">3</span></span> assign letter C select partition <span class="hljs-number"><span class="hljs-number">4</span></span> assign letter M list partition exit</code> </pre><br>  Expected Result: <br><img src="https://habrastorage.org/getpro/habr/post_images/400/f34/98b/400f3498b9f8fffb68a5bb28d7a94389.jpg"><br><ul><li>  Checking the attributes of the Images section </li></ul><br><pre> <code class="actionscript hljs">diskpart select disk <span class="hljs-number"><span class="hljs-number">0</span></span> select partition <span class="hljs-number"><span class="hljs-number">4</span></span> detail partition exit</code> </pre><br>  Expected Result: <br><img src="https://habrastorage.org/getpro/habr/post_images/5c6/846/1ad/5c68461ad905b011724c015b7cfb6cb9.jpg"><br><ul><li>  Scanning files in the Images section and recovery files </li></ul><br><pre> <code class="actionscript hljs">dir <span class="hljs-string"><span class="hljs-string">"M:\Windows Images"</span></span> dir M:\Recovery\WindowsRE</code> </pre><br>  Expected Result: <br><img src="https://habrastorage.org/getpro/habr/post_images/7d5/5b1/337/7d55b1337d1098bd4c0aa72ebfc28bfa.jpg"><br><img src="https://habrastorage.org/getpro/habr/post_images/88a/ee6/923/88aee692305de30ee3f4a4a33bcddb86.jpg"><br><ul><li>  In a Windows Recovery Environment, the location of a valid recovery image must be correctly specified. </li></ul><br><pre> <code class="actionscript hljs">C:\Windows\System32\Reagentc /Info /Target C:\Windows</code> </pre><br>  Expected Result: <br><img src="https://habrastorage.org/getpro/habr/post_images/7cc/df8/3c7/7ccdf83c7c86f6bb80d568be4a421a96.jpg"><br><img src="https://habrastorage.org/getpro/habr/post_images/2ac/92e/2fb/2ac92e2fb5f0f95346d0b9c20bdc89b6.jpg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Installing updates on a Windows 8.1 image</b> <div class="spoiler_text">  Mount the Windows Image <br><pre> <code class="actionscript hljs">md C:\mount\Windows Dism /Mount-Image /ImageFile:<span class="hljs-string"><span class="hljs-string">"C:\Images\install.wim"</span></span> /Index:<span class="hljs-number"><span class="hljs-number">1</span></span> /MountDir:C:\mount\Windows</code> </pre><br>  Install updates <b>KB2919442</b> and <b>KB2919355</b> .  These packages are available for various processor architectures: <b>x86</b> , <b>x64</b> and <b>arm</b> .  Download packages <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D42335">here</a> .  Update packages must be installed in order and separately. <br><pre> <code class="actionscript hljs">Dism /Add-Package /PackagePath:C:\MSU\Windows8<span class="hljs-number"><span class="hljs-number">.1</span></span>-&lt;Package&gt;-&lt;arch&gt;.msu /Image:C:\mount\Windows /LogPath:AddPackage.log</code> </pre><br>  Hereinafter <b>- the name of the package, and <b>- the processor architecture.</b></b> <b><b><br></b></b>  <b><b>Mount the image of Windows RE</b></b> <b><b><br></b></b> <pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">md</span></span> C:\mount\WinRE Dism /Mount-Image /ImageFile:<span class="hljs-string"><span class="hljs-string">"C:\mount\Windows\Windows\System32\Recovery\winre.wim"</span></span> /Index:1 /MountDir:C:\mount\WinRE</code> </pre><br>  Update the WinRE image using the same packages that were used when updating the Windows image <br><pre> <code class="actionscript hljs">Dism /Add-Package /PackagePath:C:\MSU\Windows8<span class="hljs-number"><span class="hljs-number">.1</span></span>-&lt;Package&gt;-&lt;arch&gt;.msu /Image:C:\mount\WinRE /LogPath:AddPackage.log</code> </pre><br>  Additionally, we perform a cleanup of the image in order to remove some elements and reduce the final size of the image.  This step is optional, but it can be performed only at this stage: after launch, it will be impossible to clean the image. <br><pre> <code class="actionscript hljs">Dism /Cleanup-Image /Image:C:\mount\WinRE /StartComponentCleanup /ResetBase</code> </pre><br>  Now you can unmount the Windows RE image. <br><pre> <code class="actionscript hljs">Dism /Unmount-Image /MountDir:C:\mount\WinRE /Commit</code> </pre><br>  To see the changes in the file size, the image must be exported. <br><pre> <code class="actionscript hljs">Dism /Export-Image /SourceImageFile:C:\mount\Windows\Windows\System32\Recovery\winre.wim /SourceIndex:<span class="hljs-number"><span class="hljs-number">1</span></span> /DestinationImageFile:C:\Images\winre_updated.wim</code> </pre><br>  After export, you need to replace <b>winre.wim with a</b> new version. <br><pre> <code class="actionscript hljs">attrib ‚Äìs -h C:\mount\Windows\Windows\System32\Recovery\winre.wim Del C:\mount\Windows\Windows\System32\Recovery\winre.wim copy C:\Images\winre_updated.wim C:\mount\Windows\Windows\System32\Recovery\winre.wim</code> </pre><br>  After the updates are installed, you can unmount the Windows image <br><pre> <code class="actionscript hljs">Dism /Unmount-Image /MountDir:C:\mount\Windows /Commit</code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/230757/">https://habr.com/ru/post/230757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230747/index.html">Implementation of the Kutter-Jordan-Bossen method in MATLAB</a></li>
<li><a href="../230749/index.html">One-page IDE in the browser [AngularJS / Ace]</a></li>
<li><a href="../230751/index.html">What is HTML import and how does it work?</a></li>
<li><a href="../230753/index.html">How does Grunt work: see the source</a></li>
<li><a href="../230755/index.html">Juniper SRX: Upgrading JunOS Version</a></li>
<li><a href="../230759/index.html">I guess this tune by three notes!</a></li>
<li><a href="../230761/index.html">With great strength comes a big responsibility - the safety technique in AngularJS</a></li>
<li><a href="../230763/index.html">Implementing bundles of goods in online stores ReadyScript</a></li>
<li><a href="../230769/index.html">Mailing lists as part of customer service</a></li>
<li><a href="../230771/index.html">Information Security Books (Part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>