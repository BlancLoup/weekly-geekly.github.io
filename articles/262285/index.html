<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using configurable logic cells PIC microcontrollers to control WS2812</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is about controlling the WS2812b LEDs, a little about the synthesis of logic circuits and their implementation inside the microcontroller...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using configurable logic cells PIC microcontrollers to control WS2812</h1><div class="post__text post__text-html js-mediator-article">  This article is about controlling the WS2812b LEDs, a little about the synthesis of logic circuits and their implementation inside the microcontroller.  Article with small digressions and two bonuses.  The first bonus is based on the fact that when we write, we read at the same time (isn‚Äôt it?).  The second bonus will help you start programming microcontrollers and in 10 minutes you can repeat the implementation described in the article. <br><a name="habracut"></a><br>  Three-color ‚ÄúSPI LEDs‚Äù WS2812b (Fig. 1) with a driver and their predecessors WS2811 / WS2812 are connected in series and controlled via a single-wire (serial) bus (hence sometimes mistakenly called ‚ÄúSPI LEDs‚Äù, although in the described case, especially for ‚Äúbonus # 1 "SPI plays a key role).  Each RGB color bit (24 bits, 8 bits per channel) is encoded by a PWM signal (see Figure 2), with a period of about 1.25 Œºs.  WS2812 LEDs are often used in controlled LED strips and screens, as they have a fast and simple interface, and the number of LEDs is easily increased.  So, for example, at a frequency of 25 frames per second, a video screen can contain one line of (40ms - 50 ¬µs) / (0.125 ¬µs x 24) ~ = 1300 RGB LEDs.  It is not so much, but for advertising signs, a board or a running line can be quite enough. <br><br><img src="https://habrastorage.org/files/a89/967/27f/a8996727fea344f48dadd1c28b75a02c.jpg"><br>  <i>Fig.</i>  <i>1. LED strip with digital serial interface</i> <br><br><img src="https://habrastorage.org/files/4f0/4e5/ac8/4f04e5ac879a43299e59f2e611e5915c.png"><br>  <i>Fig.</i>  <i>2. Bit sequence coding parameters</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The use of cheap microcontrollers for the formation of such short signals (see Fig. 2) presents certain difficulties.  So, for example, for a PIC16 controller with a clock frequency of 16 MHz, one command is executed for 250 ns.  Thus, for software control of the WS2812 driver, it is necessary to spend almost 100% of the kernel speed. <br><br><h5>  Interface synthesis </h5><br>  To solve the problem, one could use the hardware capabilities of the microcontroller, for example, the SPI interface.  Often use such a trick, when for the transfer of "zero" transmit the sequence "11100000", and for the "unit" - "11111000", i.e.  one bit is encoded byte (or nibble). <br><br>  Another way is to use the SPI interface and logic elements.  In the application notes [1] and [2], examples are published on which the described implementation is mainly based. <br><br>  So, if we take the SPI interface signals and invert the SCK signal (synchronization signal) and combine it with the SDO (output) logical AND function, we will get the coded ‚ÄúUnits‚Äù (Fig. 3). <br><br><img src="https://habrastorage.org/files/fd2/39d/174/fd239d1744e8449babddcc5cd4d00aef.png"><br>  <i>Fig.</i>  <i>3. Coding "units"</i> <br><br>  To encode "Zeros" need another signal with a shorter duration.  To do this, you can use the PWM microcontroller.  The ‚Äúzeros‚Äù are encoded by the signal described by the logical expression n (SDO) * n (SCK) * PWM (n is the inverse).  It is this expression that is given in [1] and [2], but, as can be seen from the final diagram (Figure 5), or derived from the synthesis of a logic circuit using the truth table and Carnot maps, the expression can be written as nSCK * PWM. <br><br><img src="https://habrastorage.org/files/bcb/895/e81/bcb895e8112e46c4a3760104f3a108d7.png"><br>  <i>Fig.</i>  <i>4. Coding "zeros"</i> <br><br>  It remains to combine the ‚ÄúZero‚Äù and ‚ÄúUnits‚Äù streams with the OR function, and obtain the PWM sequence required for controlling the WS2811 / WS2812 driver. <br><br><img src="https://habrastorage.org/files/a65/df2/476/a65df247632b4e4384d20b719d083a3f.png"><br>  <i>Fig.</i>  <i>5. Result of stream coding</i> <br><br>  In the form of a logical expression, the control signal is written as: <br>  <b>(nSCK * SDO) + ‚Äã‚Äã(nSDO * nSCK * PWM)</b> {1} <br><br>  Using the theorems of Boolean algebra (see, for example, the remarkable textbook [3]) it can be shown that the expression {1} is converted to equivalent expressions: <br>  <b>n (SCK + nSDO) + ‚Äã‚Äãn (SDO + SCK + nPWM)</b> {2} <br>  <b>(nSCK * PWM) + (nSCK * SDO)</b> {3} <br>  <b>n (SCK + nPWM) + n (SCK + nSDO)</b> {4} <br>  <b>nSCK * (PWM + SDO)</b> {5} <br><br>  Many younger Microchip microcontrollers, such as the PIC16F1508, PIC16F1509, have built-in Configurable Logic Cell (CLC). <br><br>  Configurable logic cells are core-independent peripherals, which can help in the implementation of the microcontroller's logic-related operation and external signals.  Asynchrony from the kernel and independence from the program allows you to implement functions that are difficult to implement only programmatically. <br><br>  Input signals for the CLC can be the input signals of the microcontroller, the outputs of the CLC, other embedded peripheral modules and internal generators.  CLC outputs can be output to ports and shared with other peripherals of controllers. <br><br>  Given the above, a bunch of SPI interface and CLC looks like an ideal option for solving the problem of generating the control signal of the WS2812 LED driver (WS2811). <br><br>  The CLC Designer utility is used to visually configure the CLC and generate the code. You can also configure the microcontroller peripherals through the Mplab Code Configurator (MCC) plugin to the MPLAB X development environment. <br><br>  Not all combinations of input signals are present at the inputs of logic cells.  Therefore, it is necessary to find such a combination of signals and cells that are needed to perform a specific task.  To encode data on CLC cells, we need SCK, SDO and PWM signals.  The logic cell CLC4 at its inputs can have signals from SCK, SDO, but does not have a signal from PWM, and CLC2 can have PWM at its inputs.  The CLC2 output can be connected to the CLC4 input.  Therefore, CLC2 will act as a repeater and transmit PWM to the input of CLC4, and CLC4 will perform the logical function of the expressions {1}, {2}, ... {5}. <br><br><img src="https://habrastorage.org/files/55a/9a9/15d/55a9a915df03429ea934c12dd071c19b.png"><br>  <i>Fig.6.</i>  <i>CLC2 transmits PWM to output.</i>  <i>Gate2 - 4 have log.1 output and do not affect the final result</i> <br><br>  In fact, the function {1} in the above form cannot be implemented on a single CLC cell, but its equivalent forms {2} ... {5} are easy.  (see fig. 7). <br><br><img src="https://habrastorage.org/files/33a/f0b/bda/33af0bbda3c74b51a3e8da7d1ac1ab3f.png"><br>  <i>Fig.</i>  <i>7. CLC4 generates PWM coding of SPI signal through the function n (SCK + SDA + nPWM) + n (SCK + SDA)</i> <br><br>  In this case, an additional D-trigger is applied, which allows the input signals to be out of sync with respect to the clock frequency of the controller and to avoid false switching of the output.  In general, for a specific case, a D-flip-flop may not be necessary, but such a configuration gives more predictable output timings (synchronization from the FOSC clock frequency). <br><br><div class="spoiler">  <b class="spoiler_title">Retreat # 1.</b>  <b class="spoiler_title">Five ways to solve one problem</b> <div class="spoiler_text"> The implementation of logic functions {2} ... {5} is shown in fig.  7a ... 7g.  All expressions are equivalent and give the expected result (see Fig. 5). <br><br><img src="https://habrastorage.org/files/255/530/025/255530025f6b4bf98f88361b3c11d494.PNG"><br>  <i>Fig.</i>  <i>7a.</i>  <i>(nSCK * PWM) + (nSCK * SDO)</i> <br><br><img src="https://habrastorage.org/files/b50/393/c1a/b50393c1a19849ea9d7e174db4efc77a.PNG"><br>  <i>Fig.</i>  <i>7b.</i>  <i>n (SCK + nPWM) + n (SCK + nSDO)</i> <br><br><img src="https://habrastorage.org/files/6bd/8c4/f34/6bd8c4f34ef14a30a83ea120c1005524.PNG"><br>  <i>Fig.</i>  <i>7c.</i>  <i>nSCK * (PWM + SDO)</i> <br><br><img src="https://habrastorage.org/files/9f5/0cf/ba7/9f50cfba7c114b128ef925b8c1fda29d.PNG"><br>  Fig.  7g.  n (SCK + SDA + nPWM) + n (SCK + SDA) <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Retreat # 2.</b>  <b class="spoiler_title">Parasitic pulses in combinational logic circuits</b> <div class="spoiler_text">  There are situations when a change in the input signal leads to several changes in the output, resulting in the formation of a parasitic pulse (glitch).  This can happen if the changing input signal passes to the output in several ways and the number of passable logic gates in different ways is different.  Then, due to the delay of each of the logical elements and the difference in travel time along the ‚Äúshortest‚Äù and ‚Äúcritical‚Äù paths, the formation of a parasitic pulse is possible.  This process is well described in [3]. <br>  For our specific example, when implementing the functions {1} ... {5}, such situations do not arise, but even if it did, the problem can be solved using the OR-D configuration of the configured cells.  Then the scheme with fig.7g can be redrawn as in fig.  7 (d), where the additional D-trigger captures the value at the output on the front of the clock frequency signal of the FOSC controller. <br><br><img src="https://habrastorage.org/files/33a/f0b/bda/33af0bbda3c74b51a3e8da7d1ac1ab3f.png"><br>  <i>Fig.</i>  <i>7e.</i>  <i>The same function as in fig.</i>  <i>7d., But with a latch on the way out</i> <br></div></div><br><br>  So, after the configuration of the CLC, PWM and SPI is done, the preparatory part is over.  Now, if we write a byte to the SSP1BUF register, then at the output of the CLC4 we will get an encoded PWM signal in accordance with the WS2812 format.  While the SPI module is transmitting data, the microcontroller can perform some other tasks.  For each LED, you need to transfer three bytes.  Connection diagram is shown in Fig.  eight. <br><br><img src="https://habrastorage.org/files/f03/894/246/f03894246aa84dd09b3c474b55a1a087.png"><br>  <i>Fig.</i>  <i>8. Connecting a WS2812b tape to a microcontroller</i> <br><br><h5>  Bonus # 1.  Memory increase </h5><br>  In the described method, the configurable logic and its joint operation with the microcontroller's periphery ensures the formation of protocol time parameters in the WS2812 format, the program is only required to write a byte to the SPI buffer, the configurable logic cells assume further ‚Äúmagic‚Äù.  Since in the described example SPI is used only for recording, and the input SDI line remains free, there is an excellent opportunity to use SPI not only to control the LEDs, but also to simultaneously receive external data.  Consider how simultaneously with the management of LEDs to read data from the memory chip with SPI interface. <br><br>  The SPI port of the PIC microcontroller has two shift registers (one for transmission, one for receiving) with one address.  Writing to SSPBUF will start byte transmission and shifts bitiki to the SDO line, but at the same time the data from the input SDI line is shifted to the same register.  That is, by transferring a byte to SPI (SDO), we simultaneously receive data from SPI (SDI). <br><br><img src="https://habrastorage.org/files/459/9ac/a9c/4599aca9cae243a3b3a7804ddcd65afa.png"><br><br>  Thus, if WS2812 LEDs and, for example, SPI memory (SRAM 23LC512 or EEPROM 25LCxxx) are connected to the SPI module of the microcontroller, then the program needs only to transfer the data from the SSPBUF to the SSPBUF, i.e.  read the byte from the external memory and the next command to send the data back to the SPI (to the LEDs) and simultaneously read the next byte, etc. <br><br><img src="https://habrastorage.org/files/ced/6b6/d4f/ced6b6d4fb174ae5bac606f668695cd3.png"><br><img src="https://habrastorage.org/files/8c4/3fb/2db/8c43fb2db7b649b09176a01cb2c464c7.png"><br>  <i>Fig.</i>  <i>9. Connecting external memory</i> <br><br>  When writing a dataset to external SPI memory or reading the first byte from memory, you need to disable the output of the CLC4 in order not to give out ‚Äúgarbage‚Äù to the LEDs. <br><br>  Depending on how often you need to update the array of LEDs, the number of LEDs can be very large - it is limited by the update rate and the size of external memory.  From the lines of LEDs, you can create LED screens and displays.  The data in the display buffer can be changed while the image is not updated, it also gives time for more complex calculations, table searches, etc., which is necessary to build the displayed image. <br><br>  The presence of a buffered image in external memory allows you to display moving images by shifting the starting address of the read memory.  With SPI EEPROM memory, you can display pre-recorded images.  The SPI interface allows you to connect multiple memory chips, for example, one EEPROM for storing character generator, static images, and in the second SRAM create a display buffer for subsequent output to the LED screen. <br><br><h5>  Bonus # 2.  Do it yourself </h5><br>  To study the sources, you can go to the Microchip website (source code for the example <a href="http://www.microchip.com//wwwAppNotes/AppNotes.aspx%3Fappnote%3Den573380">AN1890 is available on the website</a> <br><br>  But I propose to watch a short video where in five minutes it is shown how to create all the above described magic with your own hands. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/aV-n96SrxVs%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhQ_WG2Y7FbZ9bkaPtvt72s0j7_3Q" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Sources </h4><br>  1. AN1606.  Using the Configurable Logic Cell (CLC) to Interface a PIC16F1509 and WS2811.  LED Driver <a href="http://www.microchip.com/">www.microchip.com</a> <br>  2. AN1890.  Simple SRAM Buffering for Large LED Arrays.  <a href="http://www.microchip.com/">www.microchip.com</a> <br>  3. D. Harris, S. Harris.  ‚ÄúDigital circuit design and computer architecture‚Äù (http://habrahabr.ru/post/259505/) </div><p>Source: <a href="https://habr.com/ru/post/262285/">https://habr.com/ru/post/262285/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262275/index.html">Non-PKI or social packages for employees</a></li>
<li><a href="../262277/index.html">Selection of interesting materials of the week for iOS developers</a></li>
<li><a href="../262279/index.html">Generating LINQ to SQL Code for SQLite in .NET (C #)</a></li>
<li><a href="../262281/index.html">Tekla Structure API (c #): connecting and retrieving a tree of objects</a></li>
<li><a href="../262283/index.html">From AutoCAD yes to nanoCAD: change of the main CAD system in the design institute</a></li>
<li><a href="../262287/index.html">Computer algebra systems for working with tensors</a></li>
<li><a href="../262289/index.html">The best reports of the DevCon 2015 conference - Top 10</a></li>
<li><a href="../262295/index.html">Evolution go</a></li>
<li><a href="../262299/index.html">WPF pitfalls</a></li>
<li><a href="../262301/index.html">Iron unlock iCloud on Apple iPad Air 2 Cellular A1567</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>