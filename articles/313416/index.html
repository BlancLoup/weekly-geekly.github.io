<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android In-app Billing: from a mobile application to server validation and testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Recently, I faced the task of integrating billing into our service, and although the task initially seemed quite simple, as a result, this resu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android In-app Billing: from a mobile application to server validation and testing</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/02d/303/1d1/02d3031d13f54b0caf3fb40ca273dbad.jpg" alt="image"><br><br>  Hello!  Recently, I faced the task of integrating billing into our service, and although the task initially seemed quite simple, as a result, this resulted in a month-long research, a lot of nerves and discoveries.  The result was an understanding that, despite the huge amount of documentation, not everything can be found by a simple query on Google (and in some places the documentation offers frank nonsense, which I will discuss further below). <br><br>  As a result, Google Play billing was successfully integrated into our service, and validation of purchases and subscriptions on the server side works.  To whom it became interesting - welcome under the cat: there will be a complete description of everything, starting from the registration of purchases in the Google Play management console, and ending with the work with subscriptions on your backend. <br><a name="habracut"></a><br>  To begin, briefly about the patient.  I will analyze <a href="https://developer.android.com/google/play/billing/billing_reference.html">Google Play In-App Billing V3</a> by bit, as well as the cloud-based <a href="https://developers.google.com/android-publisher/api-ref/">Android Publisher API</a> , which will help us both with the validation of purchases and when working with subscriptions.  Also, do not ignore <a href="https://play.google.com/apps/publish/">the Google Play Management Console</a> - we also need it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Why do you need it at all? </h2><br>  If you have a client-server application, then without validation on the server, you will not be provided with protection against piracy.  And although you can simply validate the digital signature of the purchase on the server, the request for the Android Publisher API method has some additional features.  First, you can get information about the purchase or subscription at any time without being tied to the user's device, and, secondly, you can get more detailed information about the subscriptions and manage them (cancel, postpone, etc.).  For example, if you want to display the date of the next payment as in Google Play Music: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/85f/728/968/85f72896853547ea8aab44d5b59b4bb3.png"></div><br>  Then you can get it only by querying the Android Publisher API. <br><br>  Full flow with billing integration is as follows: <br><br>  1. Register the application in the Google Play console and create a shopping list. <br>  2. Android in-app billing integration in a mobile application. <br>  3. Validation of purchases and subscriptions on the server. <br><br><h2>  Part 1: Register an application in the Google Play console and create a shopping list </h2><br><br>  Go to <a href="https://play.google.com/apps/publish/">the Google Play Management Console</a> (if you do not have an account, register it for $ 25) and create your first application.  Let's start with the moment when your application is already registered. <br><br>  <b>1.</b> Have your application not been previously downloaded - sign your application with your release-certificate and load it into a closed alpha or beta test. <br>  <u>All Applications / Your Application / APK / Alpha (Beta) Testing</u> <br><br>  <b>2.</b> Create a testing list and activate it for the type of testing you choose (Alpha or Beta). <br><br>  <b>3.</b> Add Google accounts to this list that will test billing.  For example, your personal email, with which you logged into Google Play on your device. <br><br><img src="https://habrastorage.org/files/820/aa1/1be/820aa11be2234c788c7a15d8e2f4a237.png"><br><br>  Below is the link Opt-in URL: this link should go to all users who will test the billing (and most, too), and agree to testing.  Without this, you will not be able to make purchases in alpha / beta versions. <br><br>  <b>4.</b> Go to the <i>Settings / Account Details</i> tab, find the <i>LICENSE TESTING</i> section and in the <i>Gmail accounts with testing access</i> field add the same <i>emails</i> as in the last step.  Now with these accounts you can test purchases - they will not be charged for. <br>  You still have to add the payment method - the purchase dialog itself will require this, however, when you do not see the buy button in the application, it will be indicated that this is a test purchase. <br><br>  <b>5.</b> Add test purchases to your app.  To do this, go to <u>All Applications / Your Application / In-app Products</u> and click <i>Add new product</i> .  You can add one purchase (Managed product) and one subscription (Subscription).  As a product id, you can use something in the style of <i>com.example.myapp_testing_inapp1</i> and <i>com.example.myapp_testing_subs1</i> for buying and subscribing, respectively. At least you need to add a name and description, set a price for the product, select the countries where it is available (you can select all ), for the subscription also select the period, and activate the product.  After that, it will be available after some time. <br><br>  <b>IMPORTANT:</b> you must publish the application (at least in alpha / beta), otherwise the purchases <b>will not</b> work. <br><br>  <b>Briefly about the types of purchases</b> <br><br>  <i>1. Managed product (inapp) - one-time purchase.</i>  <i>After the purchase, the user becomes the owner of the purchase forever, but such a purchase can also be ‚Äúconsumed‚Äù (for example, for charging some bonuses).</i>  <i>After use, the purchase disappears and you can make it again.</i> <i><br><br></i>  <i>2. Subscription (subs) - subscription.</i>  <i>After activation, the user withdraws a certain amount once a certain period.</i>  <i>While the user pays, the subscription is active.</i> <br><br>  When our purchases are activated - we will be able to get information about them directly in the mobile application (name, description, price in local currency) and also make a purchase. <br><br><h2>  Part 2: Android in-app billing integration in a mobile application </h2><br>  <b><a href="https://developer.android.com/google/play/billing/billing_integrate.html">Official</a> <a href="https://developer.android.com/google/play/billing/billing_reference.html">documentation</a></b> <br><br>  First, let's perform some manipulations in order to work with the billing service in our application. <br><br>  Copy the file IInAppBillingService.aidl into our project: <br><br><div class="spoiler">  <b class="spoiler_title">Free translation of official documentation</b> <div class="spoiler_text">  IInAppBillingService.aidl is an Android Interface Definition Language (AIDL) file that defines the interface for interacting with the In-app Billing Version 3 service. You will use this interface to make billing requests using <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D0%25B6%25D0%25BF%25D1%2580%25D0%25BE%25D1%2586%25D0%25B5%25D1%2581%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25B2%25D0%25B7%25D0%25B0%25D0%25B8%25D0%25BC%25D0%25BE%25D0%25B4%25D0%25B5%25D0%25B9%25D1%2581%25D1%2582%25D0%25B2%25D0%25B8%25D0%25B5">IPC</a> calls. <br><br>  To get an AIDL file: <br>  Open <i>Android SDK Manager</i> . <br>  In the <i>SDK Manager,</i> find and expand the <i>Extras</i> section. <br>  Select <i>Google Play Billing Library</i> . <br>  Click <i>Install packages</i> to complete the installation. <br>  Navigate to your project's <i>src / main</i> folder and create a folder named <i>aidl</i> . <br>  Inside this folder, create the <i>com.android.vending.billing</i> package. <br>  Copy the <i>IInAppBillingService.aidl</i> file from the <i>% anroid-sdk% / extras / google / play_billing / folder</i> into the newly created <i>src / main / aidl / com.android.vending.billing</i> package <br></div></div><br>  Add permission to the manifest: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.android.vending.BILLING"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  And in the place where we are going to make purchases, we connect to the service: <br><br><pre> <code class="java hljs"> IInAppBillingService inAppBillingService; ServiceConnection serviceConnection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceConnection() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onServiceConnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ComponentName name, IBinder service)</span></span></span><span class="hljs-function"> </span></span>{ inAppBillingService = IInAppBillingService.Stub.asInterface(service); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onServiceDisconnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ComponentName name)</span></span></span><span class="hljs-function"> </span></span>{ inAppBillingService = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); Intent serviceIntent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"com.android.vending.billing.InAppBillingService.BIND"</span></span>); serviceIntent.setPackage(<span class="hljs-string"><span class="hljs-string">"com.android.vending"</span></span>); bindService(serviceIntent, serviceConnection, Context.BIND_AUTO_CREATE); ... } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroy(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serviceConnection != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { unbindService(serviceConnection); } }</code> </pre><br>  Now you can start working with shopping.  We will receive a list of our purchases from the service with a description and prices: <br><br><pre> <code class="java hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InAppProduct</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String productId; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String storeName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String storeDescription; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String price; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isSubscription; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> priceAmountMicros; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String currencyIsoCode; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSku</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> productId; } <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isSubscription ? <span class="hljs-string"><span class="hljs-string">"subs"</span></span> : <span class="hljs-string"><span class="hljs-string">"inapp"</span></span>; } } <span class="hljs-function"><span class="hljs-function">List&lt;InAppProduct&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInAppPurchases</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String type, String... productIds)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ArrayList&lt;String&gt; skuList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(Arrays.asList(productIds)); Bundle query = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bundle(); query.putStringArrayList(<span class="hljs-string"><span class="hljs-string">"ITEM_ID_LIST"</span></span>, skuList); Bundle skuDetails = inAppBillingService.getSkuDetails( <span class="hljs-number"><span class="hljs-number">3</span></span>, context.getPackageName(), type, query); ArrayList&lt;String&gt; responseList = skuDetails.getStringArrayList(<span class="hljs-string"><span class="hljs-string">"DETAILS_LIST"</span></span>); List&lt;InAppProduct&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String responseItem : responseList) { JSONObject jsonObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONObject(responseItem); InAppProduct product = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InAppProduct(); <span class="hljs-comment"><span class="hljs-comment">// "com.example.myapp_testing_inapp1" product.productId = jsonObject.getString("productId"); //  product.storeName = jsonObject.getString("title"); //   product.storeDescription = jsonObject.getString("description"); // "0.99USD" product.price = jsonObject.getString("price"); // "true/false" product.isSubscription = jsonObject.getString("type").equals("subs"); // "990000" =  x 1000000 product.priceAmountMicros = Integer.parseInt(jsonObject.getString("price_amount_micros")); // USD product.currencyIsoCode = jsonObject.getString("price_currency_code"); result.add(product); } return result; }</span></span></code> </pre><br>  With this method we can download data about available purchases. <br><br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">//   List&lt;InAppProduct&gt; purchases = getInAppPurchases("inapp", "com.example.myapp_testing_inapp1"); //   List&lt;InAppProduct&gt; subscriptions = getInAppPurchases("subs", "com.example.myapp_testing_subs1");</span></span></code> </pre><br>  Now we can get a shopping list and information about them directly from the application.  The price will be indicated in the currency in which the user will pay.  These methods should be called in the background thread, as the service in the process can download data from Google servers.  How to use this data is at your discretion.  You can display prices and product names from the resulting list, or you can specify the names and prices in the application resources. <br><br>  It's time to buy something now! <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> REQUEST_CODE_BUY = <span class="hljs-number"><span class="hljs-number">1234</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BILLING_RESPONSE_RESULT_OK = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BILLING_RESPONSE_RESULT_USER_CANCELED = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BILLING_RESPONSE_RESULT_SERVICE_UNAVAILABLE = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BILLING_RESPONSE_RESULT_BILLING_UNAVAILABLE = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BILLING_RESPONSE_RESULT_ITEM_UNAVAILABLE = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BILLING_RESPONSE_RESULT_DEVELOPER_ERROR = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BILLING_RESPONSE_RESULT_ERROR = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BILLING_RESPONSE_RESULT_ITEM_ALREADY_OWNED = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BILLING_RESPONSE_RESULT_ITEM_NOT_OWNED = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PURCHASE_STATUS_PURCHASED = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PURCHASE_STATUS_CANCELLED = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PURCHASE_STATUS_REFUNDED = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">purchaseProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InAppProduct product)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String sku = product.getSku(); String type = product.getType(); <span class="hljs-comment"><span class="hljs-comment">//       //         String developerPayload = "12345"; Bundle buyIntentBundle = inAppBillingService.getBuyIntent( 3, context.getPackageName(), sku, type, developerPayload); PendingIntent pendingIntent = buyIntentBundle.getParcelable("BUY_INTENT"); startIntentSenderForResult(pendingIntent.getIntentSender(), REQUEST_CODE_BUY, new Intent(), Integer.valueOf(0), Integer.valueOf(0), Integer.valueOf(0), null); } @Override public void onActivityResult(int requestCode, int resultCode, Intent data) { super.onActivityResult(requestCode, resultCode, data); if (requestCode == REQUEST_CODE_BUY) { int responseCode = data.getIntExtra("RESPONSE_CODE", -1); if (responseCode == BILLING_RESPONSE_RESULT_OK) { String purchaseData = data.getStringExtra("INAPP_PURCHASE_DATA"); String dataSignature = data.getStringExtra("INAPP_DATA_SIGNATURE"); //     readPurchase(purchaseData); } else { //   } } } private void readPurchase(String purchaseData) { try { JSONObject jsonObject = new JSONObject(purchaseData); //  ,     null String orderId = jsonObject.optString("orderId"); // "com.example.myapp" String packageName = jsonObject.getString("packageName"); // "com.example.myapp_testing_inapp1" String productId = jsonObject.getString("productId"); // unix-timestamp   long purchaseTime = jsonObject.getLong("purchaseTime"); // PURCHASE_STATUS_PURCHASED // PURCHASE_STATUS_CANCELLED // PURCHASE_STATUS_REFUNDED int purchaseState = jsonObject.getInt("purchaseState"); // "12345" String developerPayload = jsonObject.optString("developerPayload"); //  ,      //      String purchaseToken = jsonObject.getString("purchaseToken"); //     ... } catch (Exception e) { ... } }</span></span></code> </pre><br>  Separately, I want to say about dataSignature.  An example of its verification is <a href="">here</a> , but if your purchase is validated on the server, then this is an extra step. <br><br>  It may also be useful to get information on purchases already made: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readMyPurchases</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ readMyPurchases(<span class="hljs-string"><span class="hljs-string">"inapp"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   readMyPurchases("subs"); //   } private void readMyPurchases(String type) throws Exception { String continuationToken = null; do { Bundle result = inAppBillingService.getPurchases( 3, context.getPackageName(), type, continuationToken); if (result.getInt("RESPONSE_CODE", -1) != 0) { throw new Exception("Invalid response code"); } List&lt;String&gt; responseList = result.getStringArrayList("INAPP_PURCHASE_DATA_LIST"); for (String purchaseData : responseList) { readPurchase(purchaseData); } continuationToken = result.getString("INAPP_CONTINUATION_TOKEN"); } while (continuationToken != null); }</span></span></code> </pre><br>  This also needs to be done from the background thread.  This will return the list of purchases that we made earlier.  You can also get a list of active subscriptions. <br><br>  The next step is to use the purchase.  It means that you charge the user something for the purchase, and the purchase itself disappears, giving such an opportunity to make a purchase again. <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">consumePurchase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String purchaseToken)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = inAppBillingService.consumePurchase(GooglePlayBillingConstants.API_VERSION, context.getPackageName(), purchaseToken); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == GooglePlayBillingConstants.BILLING_RESPONSE_RESULT_OK) { <span class="hljs-comment"><span class="hljs-comment">//   ... } else { //   ... } }</span></span></code> </pre><br><br>  After that, you will not be able to read the purchase data - it will not be available through <i>getPurchases ()</i> . <br><br>  Here, our ability to use billing directly on the device ends. <br><br><h2>  Part 3: Validation of purchases and subscriptions on the server </h2><br><br>  This is the most interesting part, which I fought the longest.  All examples will be on java, for which Google provides a <a href="https://developers.google.com/api-client-library/java/apis/androidpublisher/v2">ready-made library</a> for working with its services. <br><br>  Libraries and for other languages <a href="https://developers.google.com/api-client-library/">can be searched here</a> .  The Google Publisher API documentation <a href="https://developers.google.com/android-publisher/api-ref/">is here</a> , in the context of the current task, we are interested in <a href="https://developers.google.com/android-publisher/api-ref/purchases/products">Purchases.products</a> and <a href="https://developers.google.com/android-publisher/api-ref/purchases/subscriptions">Purchases.subscriptions</a> . <br><br>  In fact, the main problem I encountered is the <a href="https://developers.google.com/android-publisher/authorization">description of the authorization method</a> .  Even by the description it looks like the fifth leg of a horse, but the problem is not that it does not work, but that it <u>is fundamentally wrong</u> for our task.  Request to experts not to throw stones at me: OAuth is designed to work with client resources, but in our case, the backend service requests billing data from our own application. <br><br>  And this is where IAM (Identy Access Management) comes to the rescue.  We need to create a project in the <a href="https://console.cloud.google.com/">Google Cloud Console</a> and go to the <i>Credentials</i> tab, select <i>Create credentials ‚Üí Service account key</i> . <br><br><img src="https://habrastorage.org/files/cba/2a4/978/cba2a49786d24adab007ea4b36f15350.png" alt="image"><br><br>  Fill in the data as shown in the picture: <br><img src="https://habrastorage.org/files/e38/343/5a1/e383435a1d3d48a682a9e7ee60371138.png" alt="image"><br><blockquote>  Service account: New service account <br>  Service account name: a name to choose from <br>  Role: do not choose, it is not needed now <br>  Key type: JSON </blockquote><br>  Click <i>Create</i> .  A window will pop up with a warning <i>Service account has no role</i> .  Agrees, choose <i>CREATE WITHOUT ROLE</i> .  You will automatically download the JSON file with the data to authorize your account.  Save this file - in the future you will need it in order to log in to Google services. <br><br><div class="spoiler">  <b class="spoiler_title">Sample file</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"service_account"</span></span>, <span class="hljs-string"><span class="hljs-string">"project_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"project-name"</span></span>, <span class="hljs-string"><span class="hljs-string">"private_key_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"1234567890abcdef1234567890abcdef"</span></span>, <span class="hljs-string"><span class="hljs-string">"private_key"</span></span>: <span class="hljs-string"><span class="hljs-string">"-----BEGIN PRIVATE KEY-----\XXXXX.....XXXXX\n-----END PRIVATE KEY-----\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"client_email"</span></span>: <span class="hljs-string"><span class="hljs-string">"myaccount@project-name.iam.gserviceaccount.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"client_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"12345678901234567890"</span></span>, <span class="hljs-string"><span class="hljs-string">"auth_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://accounts.google.com/o/oauth2/auth"</span></span>, <span class="hljs-string"><span class="hljs-string">"token_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://accounts.google.com/o/oauth2/token"</span></span>, <span class="hljs-string"><span class="hljs-string">"auth_provider_x509_cert_url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/oauth2/v1/certs"</span></span>, <span class="hljs-string"><span class="hljs-string">"client_x509_cert_url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/robot/v1/metadata/x509/myaccount%40project-name.iam.gserviceaccount.com"</span></span> }</code> </pre><br></div></div><br>  Now we return to the <i>Credentials</i> tab of our project and see below the list of <i>Service account keys</i> .  On the right is the <i>Manage service accounts</i> button - click on it and see: <br><br><img src="https://habrastorage.org/files/db3/d7e/3d6/db3d7e3d6f5f4787aeb0007c9f6dd078.png" alt="image"><br><br>  <i>myaccount@project-name.iam.gserviceaccount.com</i> - this is the id of our account.  Copy it and go to the <i>Google Play Developer Console ‚Üí Settings ‚Üí User Accounts &amp; Rights</i> and select <i>Invite New user</i> . <br><br>  Fill in the data. <br><br><img src="https://habrastorage.org/files/fb1/b91/9c5/fb1b919c5dd045eaacbccb73391242ac.png" alt="image"><br><br>  Insert the account id in the <i>Email</i> field, add our application and tick the <i>View financial reports</i> . <br><br>  Click Send Invitation.  Now we can use our JSON file for authorization and Google API and access to the data of purchases and subscriptions of our application. <br><br>  The next step is to activate the <i>Google Play Developer API</i> for our project.  Go to the <i>Google Developer Console ‚Üí Library</i> and look for the <i>Google Play Developer API</i> .  Open it and click <i>Enable</i> . <br><br><img src="https://habrastorage.org/files/098/57d/9b9/09857d9b92474c388025b23b31875b64.png"><br><br>  The last step is to go to the <i>Google Play Developer Console ‚Üí Settings ‚Üí API Access</i> . <br><br><img src="https://habrastorage.org/files/802/673/dec/802673dece974d529233a50121547876.png"><br><br>  In the list we find our project (in the picture above it is Google Play Android Developer, but there should be the name of your project) and click <i>Link</i> . <br><br><img src="https://habrastorage.org/files/61f/a0f/421/61fa0f42195c48dfaccf061baf295293.png"><br><br>  <b>We now turn to the development of the server part</b> <br><br>  We will leave it at your discretion as to how you will store the JSON-file with the private data of the IAM-account.  Import the Google Play Developer API into your project ( <a href="">mavencentral</a> ) and implement the check. <br><br>  Purchase data must be sent from our application to the server.  The implementation of the check on the server itself looks like this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.client.googleapis.auth.oauth2.GoogleCredential; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.client.googleapis.javanet.GoogleNetHttpTransport; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.client.http.HttpTransport; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.client.json.jackson2.JacksonFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.services.androidpublisher.AndroidPublisher; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.services.androidpublisher.AndroidPublisherScopes; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.services.androidpublisher.model.ProductPurchase; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.services.androidpublisher.model.SubscriptionPurchase; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GooglePlayService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, AndroidPublisher&gt; androidPublishers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readCredentialsJson</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String packageName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      JSON-    ... } private AndroidPublisher getPublisher(String packageName) throws Exception { if (!androidPublishers.containsKey(packageName)) { String credentialsJson = readCredentialsJson(packageName); InputStream inputStream = new ByteArrayInputStream( credentialsJson.getBytes(StandardCharsets.UTF_8)); HttpTransport transport = GoogleNetHttpTransport.newTrustedTransport(); GoogleCredential credential = GoogleCredential.fromStream(inputStream) .createScoped(Collections.singleton( AndroidPublisherScopes.ANDROIDPUBLISHER)); AndroidPublisher.Builder builder = new AndroidPublisher.Builder( transport, JacksonFactory.getDefaultInstance(), credential); AndroidPublisher androidPublisher = builder.build(); androidPublishers.put(packageName, androidPublisher); } return androidPublishers.get(packageName); } public ProductPurchase getPurchase(String packageName, String productId, String token) throws Exception { AndroidPublisher publisher = getPublisher(packageName); AndroidPublisher.Purchases.Products.Get get = publisher .purchases().products().get(packageName, productId, token); return get.execute(); } public SubscriptionPurchase getSubscription(String packageName, String productId, String token) throws Exception { AndroidPublisher publisher = getPublisher(packageName); AndroidPublisher.Purchases.Subscriptions.Get get = publisher .purchases().subscriptions().get(packageName, productId, token); return get.execute(); } }</span></span></code> </pre><br>  Thus, we get the opportunity to obtain data about our purchase directly from Google, because there is no need to verify the signature.  Moreover, for subscriptions, you can get a lot more information than directly through IInAppBilligService in a mobile application. <br><br>  As query parameters we need: <br><br><ul><li>  packageName - application package name (com.example.myapp) </li><li>  productId - product identifier (com.example.myapp_testing_inapp1) </li><li>  token is a unique purchase token that you received in the mobile application: <br><br><pre> <code class="java hljs">String purchaseToken = jsonObject.getString(<span class="hljs-string"><span class="hljs-string">"purchaseToken"</span></span>);</code> </pre> </li></ul><br>  Details on <a href="https://developers.google.com/android-publisher/api-ref/purchases/products">ProductPurchase</a> and <a href="https://developers.google.com/android-publisher/api-ref/purchases/subscriptions">SubscriptionPurchase are</a> described in the documentation, we will not dwell on them. <br><br><h2>  Instead of conclusion </h2><br>  First, the seemingly simple task of integrating billing into our service turned into a journey through documentation, googling and impotence (OAuth, <a href="https://developers.google.com/android-publisher/authorization">you are fine</a> ), since there is not a word about using IAM for access to documentation.  Seriously, they propose to drive a concocted URL in your browser with some hands, add origin to the redirect in the project management console, all to get a one-time token that you need to pass to the server with your hands, then use the entire OAuth flow for access to billing data.  This is not to say that if you do not have time to use the refresh-token, then you will have to get a new token - by hand.  Agree - it sounds like complete nonsense for a backend service that should work without human intervention. <br><br>  I hope that this article will help someone save some time and nerves. </div><p>Source: <a href="https://habr.com/ru/post/313416/">https://habr.com/ru/post/313416/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313400/index.html">Hacker dossier: Boris Florikik aka Tron, creator of the first Cryptophone</a></li>
<li><a href="../313402/index.html">The digest of fresh materials from the world of the frontend for the last week No. 233 (October 17‚Äì23, 2016)</a></li>
<li><a href="../313410/index.html">How to explain to granny what Agile is in 15 minutes with pictures</a></li>
<li><a href="../313412/index.html">Architecture and programming Philips Videopac (Magnavox Odyssey 2)</a></li>
<li><a href="../313414/index.html">Synergistic organizations. Part 0</a></li>
<li><a href="../313418/index.html">Preparing to migrate vCenter Server to vSphere 6.0 Update 2m. Part 2</a></li>
<li><a href="../313420/index.html">Procedural generation of planetary maps</a></li>
<li><a href="../313422/index.html">42 lines of code to exit the limb</a></li>
<li><a href="../313426/index.html">Home hosting sites with dynamic IP</a></li>
<li><a href="../313428/index.html">Donald Knut on the first steps in programming: How I spent the summer with a computer, not with girls (19,20,21,22 / 97)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>