<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JVM options. How it works</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every day the word java is more and more perceived not as a language, but as a platform thanks to the notorious invokeDynamic . That is why today I wo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JVM options. How it works</h1><div class="post__text post__text-html js-mediator-article">  Every day the word java is more and more perceived not as a language, but as a platform thanks to the notorious <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/vm/multiple-language-support.html">invokeDynamic</a> .  That is why today I would like to talk about a virtual java machine, namely about the so-called Performance options in Oracle HotSpot JVM version 1.6 and higher (server).  Because today there are almost no people who know something more than -Xmx, -Xms and -Xss.  At one time, when I began to delve into the topic, I discovered a huge amount of interesting information, which I want to share.  The starting point, of course, was the <a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">official documentation</a> from Oracle.  And then - google, experiments and communication: <br><br><h4>  -XX: + DoEscapeAnalysis </h4><br>  I will begin, perhaps, with the most interesting option - DoEscapeAnalysis.  As many of you know, primitives and object references are not created on the heap, but are allocated on the thread stack (256KB by default for Hotspot).  It is quite obvious that the java language does not allow you to create objects on the stack on a straight line.  But your JVM 1.6 can do this quite well starting from the 14th update. <br><br>  About how the algorithm itself can be read <a href="http%253A%252F%252Fciteseerx.ist.psu.edu%252Fviewdoc%252Fdownload%253Fdoi%253D10.1.1.224.353%2526rep%253Drep1%2526type%253Dpdf%26ei%3D4kC7UIfxJezb4QSxnIDoDg%26usg%3DAFQjCNHm7TEmXj8fPZoJ4hXXZufGH4KRVQ">here (PDF)</a> .  In short, then: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  If the scope of an object does not go beyond the scope of the method in which it is created, then such an object can be created on the stack frame instead of the heap (in fact, not the object itself, but its fields, the totality of which is replaced by the object); </li><li>  If an object does not leave the scope of the stream, then other objects do not have access to such an object, and therefore all synchronization operations on the object can be deleted. </li></ul><br><br>  To implement this algorithm, a so-called connection graph is constructed and used, according to which at the analysis stage (several analysis algorithms) a passage is made to find intersections with other flows and methods. <br>  Thus, after passing the connection graph for any object, one of the following states is possible: <br><br><ul><li>  GlobalEscape - the object is accessible from other threads and from other methods, for example, a static field. </li><li>  ArgEscape - the object was passed as an argument or there is a link to it from the argument object, but it does not go out of the scope of the thread in which it was created. </li><li>  NoEscape - the object does not leave the scope of the method and its creation can be moved onto the stack. </li></ul><br><br>  After the analysis stage, the JVM itself performs a possible optimization: in the case of a NoEscape object, then it can be created on the stack;  if the object is NoEscape or ArgEscape, then synchronization operations on it can be deleted. <br><br>  It should be clarified that it is not the object itself that is created on the stack, but its fields.  Since the JVM replaces the entire object with a collection of its fields (thanks to <a href="http://habrahabr.ru/users/walrus/" class="user_link">Walrus</a> for the clarification). <br><br>  It is quite obvious that due to this kind of analysis, the performance of individual parts of the program can increase significantly.  In synthetic tests, like this: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1000</span></span>*<span class="hljs-number"><span class="hljs-number">1000</span></span>*<span class="hljs-number"><span class="hljs-number">1000</span></span>; i++) { Foo foo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Foo(); }</code> </pre> <br>  execution speed may increase by 8-15 times.  Although, on the seemingly obvious cases from practice about which recently was written ( <a href="http://habrahabr.ru/post/147552/">here</a> and <a href="http://habrahabr.ru/post/164177/">here</a> ) EscapeAnalys does not work.  I suspect that this is due to the size of the stack. <br><br>  By the way, EscapeAnalysis is partly responsible for the well-known argument about StringBuilder and StringBuffer.  That is, if you suddenly used a StringBuffer instead of a StringBuilder in the method, then EscapeAnalysis (if triggered) will remove the locks for the StringBuffer, after which the StringBuffer turns into a StringBuilder. <br><a name="habracut"></a><br><h4>  -XX: + AggressiveOpts </h4><br>  The AggressiveOpts option is a super option.  Not in the sense that it dramatically increases the performance of your application, but in the sense that it only changes the values ‚Äã‚Äãof other options (in fact, this is not quite so - there are quite a few places in the JDK source code where AggressiveOpts change the behavior of JVM besides the options mentioned, one of the examples <a href="http://habrahabr.ru/post/172295/">here</a> ).  We will check the modified flags with the help of two commands: <br><br><pre> <code class="java hljs">java -server -XX:-AggressiveOpts -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal &gt; no_aggr java -server -XX:+AggressiveOpts -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal &gt; aggr</code> </pre><br>  After the execution, the difference in the results of the command execution looked like this: <br><table><tbody><tr><th></th><th>  -AggressiveOpts <br></th><th>  + AggressiveOpts <br></th></tr><tr><td>  AutoBoxCacheMax <br></td><td>  128 <br></td><td>  20,000 <br></td></tr><tr><td>  BiasedLockingStartupDelay <br></td><td>  4,000 <br></td><td>  500 <br></td></tr><tr><td>  EliminateAutoBox <br></td><td>  false <br></td><td>  true <br></td></tr><tr><td>  Optimizefill <br></td><td>  false <br></td><td>  true <br></td></tr><tr><td>  OptimizeStringConcat <br></td><td>  false <br></td><td>  true <br></td></tr></tbody></table><br>  In other words, all that this option does is change 5 virtual machine parameter data.  Moreover, for versions 1.6 update 35 and 1.7 update 7 no differences were noticed.  This option is disabled by default and changes nothing in the client mode. <br>  Let's figure out what java means by aggressive optimization: <br><br><h4>  -XX: AutoBoxCacheMax = size </h4><br>  Allows you to extend the range of cached values ‚Äã‚Äãfor integer types when starting a virtual machine.  I already mentioned this option <a href="http://habrahabr.ru/post/132241/">here (second paragraph)</a> . <br><br><h4>  -XX: BiasedLockingStartupDelay = delay </h4><br>  As you know, a synchronized block in java can be represented by one of 3 types of locks: <br><br><ul><li>  biased </li><li>  thin </li><li>  fat </li></ul><br>  You can read more about it <a href="https://blogs.oracle.com/dave/entry/biased_locking_in_hotspot">here</a> , <a href="https://wikis.oracle.com/display/HotSpotInternals/Synchronization">here</a> and <a href="http://www.javaspecialist.ru/2011/04/java.html">here</a> . <br><br>  Since most objects (synchronized) are blocked by up to 1 single stream, such objects can be tied (biased) to this stream and synchronization operations on this object inside the stream are greatly reduced in price.  If another thread tries to access the biased object, the lock for this object is switched to the thin lock. <br><br>  Switching itself is relatively expensive, so there is a delay at the start of the JVM, which by default creates all locks as thin and if no competition is detected and the code is used by the same thread, then such locks become biased after the delay expires.  That is, the JVM tries to determine locking usage scenarios at the start and accordingly uses fewer switches between them.  Accordingly, setting BiasedLockingStartupDelay to zero, we expect that the main pieces of the synchronization code will be used only by the same thread. <br><br><h4>  -XX: + OptimizeStringConcat </h4><br>  Also quite an interesting option.  Recognizes pattern of similarity. <br><br><pre> <code class="java hljs">StringBuilder().append(...).toString() <span class="hljs-comment"><span class="hljs-comment">//   StringBuilder().append(new StringBuiler().append(...).toString()).toString()</span></span></code> </pre><br>  and instead of constantly allocating memory for a new concatenation operation, an attempt is made to calculate the total number of characters of each concatenation object to allocate memory only 1 time. <br>  In other words, if we call the append () operation 20 times on a string 20 characters long.  That creation of an array of char will occur once and is 400 characters long. <br><br><h4>  XX: + OptimizeFill </h4><br>  Array fill / copy cycles are replaced with direct machine instructions to speed up the work. <br>  For example, the following block (taken from Arrays.fill ()): <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=fromIndex; i&lt;toIndex; i++) a[i] = val;</code> </pre><br>  There will be completely replaced with the appropriate processor instructions like sishnyh memset, memcpy only lower-level ones. <br><br><h4>  XX: + EliminateAutoBox </h4><br>  Based on the name, the flag should somehow reduce the number of autoboxing operations.  Unfortunately, I still could not figure out what this flag does.  The only thing that has been clarified is that this applies only to Integer shells. <br><br><h4>  -XX: + UseCompressedStrings </h4><br>  A rather controversial option in my opinion ... If, in the distant 90s, java developers did not regret 2 bytes per symbol, then today such optimization looks rather ridiculous.  If anyone has not guessed, then the option replaces the character arrays in the strings with byte arrays, where possible (ASCII).  In fact: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] -&gt; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]</code> </pre><br>  Thus, significant memory savings are possible.  But in view of the fact that the type changes, overhead costs for type control appear during certain operations.  That is, with this option, JVM performance degradation is possible.  Actually, therefore, the option is disabled by default. <br><br><h4>  -XX: + UseStringCache </h4><br>  Quite a mysterious option, judging by the name, it should somehow cache lines.  How?  Unclear.  There is no information.  Yes, and <a href="">the code</a> does not seem to do anything.  I would be glad if someone could clarify. <br><br><h4>  -XX: + UseCompressedOops </h4><br>  First, a few facts: <br><br><ul><li>  The size of a pointer to an object in a 32-bit JVM is 32 bits.  In the 64-bit - 64 bits.  Therefore, in the first case you can use an address space of 2 ^ 32 bytes (4 GB), and in the second case 2 ^ 64 bytes. </li><li>  The size of objects in java is multiple to 8 bytes, regardless of the bit width of the virtual machine (this is not true for all virtual machines, but it's about Hotspot).  That is, when using 32-bit pointers, the last 3 bits will always be zeros, in fact, the virtual machine actually uses only 29 bits. </li></ul><br><br>  This option allows you to reduce the pointer size for 64-bit JVMs to 32 bits, but in this case the heap size is limited to 4 GB, therefore, in addition to the shortened pointer, the multiplicity property of 8 bytes is used.  As a result, we are able to use an address space of 2 ^ 35 bytes (32 GB) having pointers of 32 bits. <br>  In fact, inside the virtual machine, we have pointers to objects, not specific bytes in memory.  It is clear that due to such assumptions (of multiplicity) there are additional costs for converting pointers.  But in essence, this is just one shift and sum operation. <br><br>  In addition to reducing the size of the pointers themselves, this option also reduces the headers of objects and various alignments and shifts inside the created objects, which allows, on average, to reduce memory consumption by 20-60% depending on the application model. <br><br>  That is, of the disadvantages we only have: <br><br><ul><li>  The maximum heap size is limited to 32 GB (64GB for JRockit with a multiplicity of objects of 16 bytes); </li><li>  Appear add.  the cost of converting JVM links to native and back. </li></ul><br><br>  Since for most applications the option carries some advantages, then starting from JDK 6 update 23 it is enabled by default, as well as in JDK 7. More detailed <a href="https://wikis.oracle.com/display/HotSpotInternals/CompressedOops">here</a> and <a href="https://blogs.oracle.com/jrockit/entry/understanding_compressed_refer">here</a> . <br><br><h4>  -XX: + EliminateLocks </h4><br>  An option that eliminates unnecessary locks by combining them.  For example, the following blocks: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//doSomething1 } synchronized (object) { //doSomething2 }</span></span></code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//doSomething3 } //doSomething4 synchronized (object) { //doSomething5 }</span></span></code> </pre><br>  will be converted accordingly to <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//doSomething1 //doSomething2 }</span></span></code> </pre><br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (object) { <span class="hljs-comment"><span class="hljs-comment">//doSomething3 //doSomething4 //doSomething5 }</span></span></code> </pre><br><br>  This reduces the number of attempts to capture the monitor. <br><br><h5>  Conclusion </h5><br>  There are quite a few interesting options left overboard, since it is rather difficult to put all ~ 700 flags into one article.  I did not specifically touch upon the options for tuning the collector, as this is a rather extensive and complex topic and it deserves several posts.  I hope the article was useful to you. </div><p>Source: <a href="https://habr.com/ru/post/160049/">https://habr.com/ru/post/160049/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160033/index.html">New search in Gmail</a></li>
<li><a href="../160035/index.html">Behind the Scenes of Android: Something You May Not Know</a></li>
<li><a href="../160037/index.html">Plugins for ReSharper 7.1</a></li>
<li><a href="../160039/index.html">20 years to the first smartphone in history</a></li>
<li><a href="../160043/index.html">"Lyapi" when using photos for website design</a></li>
<li><a href="../160051/index.html">Room maps appear on Google Maps</a></li>
<li><a href="../160053/index.html">I do not want to be part of your (damn) ecosystem</a></li>
<li><a href="../160057/index.html">Hayaku - write CSS faster</a></li>
<li><a href="../160059/index.html">IIS - resize images on the fly</a></li>
<li><a href="../160061/index.html">Munich has saved 10 million euros due to the transition to Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>