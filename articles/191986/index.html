<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unit tests in practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, quite a lot of publications on the topic of development through testing have appeared and continue to appear. The topic is quite interesting...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unit tests in practice</h1><div class="post__text post__text-html js-mediator-article">  Recently, quite a lot of publications on the topic of development through testing have appeared and continue to appear.  The topic is quite interesting and worth it to devote to researching some of its time.  We have been using unit testing in our team for the past year.  In this article I want to talk about what happened and what kind of experience we have gained in the end. <br><br>  At once I will make a reservation that examples are given with reference to the C # language and the .NET platform.  Accordingly, in other languages ‚Äã‚Äã/ platforms, approaches and implementations may differ. <br><br>  So‚Ä¶ <br><a name="habracut"></a><br>  <b>What should be the unit tests?</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Apart from the fact that unit tests must comply with the functionality of the software product, the main requirement is the speed of operation.  If after the start of the test suite, the developer can take a break (in my case for a smoke break), then such launches will occur less and less (again, in my case, because of the fear of an overdose of nicotine).  As a result, it may happen that the unit tests will not run at all and, as a result, the meaning of their writing will be lost.  The programmer must be able to run the entire test suite at any time.  And this set should execute as quickly as possible. <br><br>  <b>What requirements need to be met in order to ensure the speed of execution of unit tests?</b> <br><br>  <i>Tests should be small</i> <br><br>  In the ideal case - one statement (assert) per test.  The smaller the piece of functionality covered by the unit test, the faster the test will be performed. <br><br>  By the way, on the theme of design.  I really like the approach, which is formulated as ‚Äúarrange-act-assert‚Äù. <br>  Its essence is to clearly define preconditions in the unit test (initialization of test data, <br>  presets), action (actually what is being tested) and postconditions (what should be in <br>  the result of the action).  This design improves the readability of the test and makes it easier. <br>  use as documentation for the tested functionality. <br><br>  If the development is using ReSharper from JetBrains, then it is very convenient to set up a template with which the blank for the test case will be created.  For example, a template might look like this: <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Test_$METHOD_NAME$() { <span class="hljs-comment"><span class="hljs-comment">//arrange $END$ //act //assert Assert.Fail("Not implemented"); }</span></span></code> </pre> <br><br>  And then a test designed in this way may look something like this (all names are fictional, coincidences are random): <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_ForbiddenForPackageChunkWhenPackageNotFound</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//arrange var packagesRepositoryMock = _mocks.Create&lt;IPackagesRepository&gt;(); packagesRepositoryMock .Setup(r =&gt; r.FindPackageAsync(_packageId)) .Returns(Task&lt;DatabasePackage&gt;.Factory.StartNew(() =&gt; null)); Register(packagesRepositoryMock.Object); //act var message = PostChunkToServer(new byte[] { 1, 2, 3 }); //assert _mocks.VerifyAll(); Assert.That(message.StatusCode, Is.EqualTo(HttpStatusCode.Forbidden)); }</span></span></code> </pre><br><br>  <i>Tests must be isolated from the environment (database, network, file system)</i> <br><br>  This item is probably the most controversial of all.  Often in the literature examples of using TDD in such tasks as the development of a calculator or telephone directory are considered.  It is clear that these tasks are divorced from reality and the developer, returning to his project, does not know how to apply his knowledge and skills in his daily work.  The simplest cases, similar to the notorious calculator, are covered by unit tests, and the rest of the functionality is developed on former rails.  As a result, there is no understanding of why to spend time on unit tests, if simple code can be debugged and so, but complex still is not covered with tests. <br><br>  In fact, there is nothing to worry about if a database or a file system is used in the unit tests.  So, at least, you can be confident in the functionality of the functionality, which by and large is the core of the system.  The only question is how to use the external environment in the most efficient way, keeping a balance between the isolation of tests and the speed of their execution? <br><br>  <b>Case 1. Data access layer (MS SQL Server)</b> <br><br>  If a MS SQL server is used in the development of a project, then the answer to this question may be to use an installed instance of MS SQL server (Express, Enterprise or Developer Edition) to deploy the test database.  Such a database can be created using the standard mechanisms used in MS SQL Management Studio and put it into a project with unit tests.  The general approach to using such a database is to deploy a test database before performing a test (for example, in the method marked with the SetUp attribute when using NUnit), filling the database with test data and checking the functionality of the repositories or gateways on these obviously known test data.  Moreover, the test database can unfold both on a hard disk and in memory, using applications that create and manage a RAM disk.  For example, in the project I'm working on at this time, the <a href="http://www.softperfect.com/products/ramdisk/">SoftPerfect RAM Disk</a> application is used.  The use of a RAM disk in unit tests allows to reduce the delays arising from I / O operations that would arise when a test database was deployed on a hard disk.  Of course, this approach is not ideal, since it requires the introduction of third-party software into the developer‚Äôs environment.  On the other hand, if we consider that the development environment is deployed, as a rule, once (well, or quite rarely), then this requirement does not seem to be so burdensome.  And the gain from using this approach is quite tempting, because it is possible to monitor the correctness of one of the most important layers of the system. <br><br>  By the way, if it is possible to use LINQ2SQL and SMO for MS SQL Server in module tests, then you can use the following base class to test the data access layer: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DatabaseUnitTest</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TContext</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TContext</span></span> : <span class="hljs-title"><span class="hljs-title">DataContext</span></span> { [TestFixtureSetUp] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FixtureSetUp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { CreateFolderForTempDatabase(); } [SetUp] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeforeTestExecuting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { RestoreDatabaseFromOriginal(); RecreateContext(); } [TestFixtureTearDown] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FixtureTearDown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { KillDatabase(); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionString { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Format(<span class="hljs-string"><span class="hljs-string">@"Data Source={0};Initial Catalog={1};Integrated Security=True"</span></span>, TestServerName, TestDatabaseName); } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> TContext Context { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TestDatabaseOriginalName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Database"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ProjectName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"CoolProject"</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RecreateContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Context = (TContext) Activator.CreateInstance(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TContext), ConnectionString); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FolderForTempDatabase { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Format(<span class="hljs-string"><span class="hljs-string">@"R:\{0}.DatabaseTests\"</span></span>, ProjectName); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TestDatabaseName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FolderForTempDatabase + ProjectName + <span class="hljs-string"><span class="hljs-string">".Tests"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TestDatabaseOriginalFileName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Path.Combine(TestDatabaseDirectory, TestDatabaseOriginalName + <span class="hljs-string"><span class="hljs-string">".mdf"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TestDatabaseFileName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Path.Combine(TestDatabaseDirectory, TestDatabaseName + <span class="hljs-string"><span class="hljs-string">".mdf"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateFolderForTempDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> directory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectoryInfo(FolderForTempDatabase); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!directory.Exists) { directory.Create(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RestoreDatabaseFromOriginal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { KillDatabase(); CopyFiles(); AttachDatabase(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KillDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Server server = Server; SqlConnection.ClearAllPools(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(server.Databases.Contains(TestDatabaseName)) { server.KillDatabase(TestDatabaseName); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyFiles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInfo(TestDatabaseOriginalFileName).CopyTo(TestDatabaseFileName, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> logFileName = GetLogFileName(TestDatabaseFileName); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInfo(GetLogFileName(TestDatabaseOriginalFileName)).CopyTo(logFileName, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInfo(TestDatabaseFileName).Attributes = FileAttributes.Normal; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInfo(logFileName).Attributes = FileAttributes.Normal; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AttachDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Server server = Server; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!server.Databases.Contains(TestDatabaseName)) { server.AttachDatabase(TestDatabaseName, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringCollection {TestDatabaseFileName, GetLogFileName(TestDatabaseFileName)}); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLogFileName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> databaseFileName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex(<span class="hljs-string"><span class="hljs-string">".mdf$"</span></span>, RegexOptions.IgnoreCase).Replace(databaseFileName, <span class="hljs-string"><span class="hljs-string">"_log.ldf"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Server Server { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Server(TestServerName); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TestServerName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"."</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TestDatabaseDirectory { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> debugDirectory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectoryInfo(AppDomain.CurrentDomain.BaseDirectory); DirectoryInfo binDirectory = debugDirectory.Parent; DirectoryInfo testProjectDirectory; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(binDirectory == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || (testProjectDirectory = binDirectory.Parent) == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">""</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Path.Combine(testProjectDirectory.FullName, <span class="hljs-string"><span class="hljs-string">"Database"</span></span>); } } }</code> </pre><br></div></div><br>  After using which tests for interaction with the database will look like this: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestFixture</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ObjectFinderTest</span></span> : <span class="hljs-title"><span class="hljs-title">DatabaseUnitTest</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DatabaseDataContext</span></span>&gt; { [Test] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_NullWhenObjectNotExists</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//arrange var fakeIdentifier = 0; var finder = new ObjectFinder(fakeIdentifier, ConnectionString); //act var foundObject = finder.Find(); //assert Assert.That(foundObject, Is.Null); } [Test] public void Test_SuccessfullyFound() { //arrange var insertedObject = ObjectsFactory.Create(); Context.Objects.InsertOnSubmit(insertedObject); Context.SubmitChanges(); var finder = new ObjectFinder(insertedObject.Id, ConnectionString); //act var foundObject = finder.Find(); //assert Assert.That(foundObject.Id, Is.EqualTo(insertedObject.Id)); Assert.That(foundObject.Property, Is.EqualTo(insertedObject.Property)); } }</span></span></code> </pre><br><br>  Voila!  We got the opportunity to test the database access layer. <br><br>  <b>Case 2. ASP.NET MVC WebAPI</b> <br><br>  When testing WebAPI, one of the questions is how to build unit tests so that you can test calling the right methods of the desired controllers with the right arguments when sending a request to a specific url.  If we assume that the controller‚Äôs responsibility is only to redirect the call to the appropriate class or component of the system, then the answer to the question about testing the controller will be to dynamically build some environment in which to start the necessary HTTP requests to the controller before running the tests. and, using mock'i, check the correctness of the configured routing.  At the same time, I absolutely do not want to use it to deploy the IIS test environment.  Ideally, a test environment should be created before running each test.  This will help the unit tests to be fairly isolated from each other.  With IIS in this regard, it would be quite difficult. <br><br>  Fortunately, with the release of the .NET Framework 4.5, the opportunity to solve the problem of testing routing is quite simple.  For example, using the following classes (Unity is used as the DI container): <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AbstractControllerTest</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TController</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HttpServer _server; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HttpClient _client; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UnityContainer _unityContainer; [SetUp] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeforeTestExecuting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _unityContainer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnityContainer(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpConfiguration(); WebApiConfig.Register(configuration, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IoCContainer(_unityContainer)); _server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpServer(configuration); _client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(_server); Register&lt;TController&gt;(); RegisterConstructorDependenciesAndInjectionProperties(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TController)); } [TearDown] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AfterTestExecuted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _client.Dispose(); _server.Dispose(); _unityContainer.Dispose(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> TestHttpRequest </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestHttpRequest(_client, url); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Register&lt;T&gt;(T instance) { Register(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T), instance); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> instance</span></span></span><span class="hljs-function">)</span></span> { _unityContainer.RegisterInstance(type, instance); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Register&lt;T&gt;() { _unityContainer.RegisterType&lt;T&gt;(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterConstructorDependenciesAndInjectionProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type controllerType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constructors = controllerType.GetConstructors(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constructorParameters = constructors .Select(constructor =&gt; constructor.GetParameters()) .SelectMany(constructorParameters =&gt; constructorParameters); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constructorParameter <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> constructorParameters) { RegisterMockType(constructorParameter.ParameterType); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> injectionProperties = controllerType.GetProperties() .Where(info =&gt; info.GetCustomAttributes(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DependencyAttribute), <span class="hljs-literal"><span class="hljs-literal">false</span></span>) .Any()); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> property <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> injectionProperties) { RegisterMockType(property.PropertyType); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterMockType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type parameterType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> mock = Activator.CreateInstance(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Mock&lt;&gt;).MakeGenericType(parameterType), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] { MockBehavior.Default }); Register(parameterType, mock.Object); } }</code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestHttpRequest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HttpClient _client; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Uri _uri; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestHttpRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpClient client, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url</span></span></span><span class="hljs-function">)</span></span> { _client = client; _uri = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"http://can.be.anything/"</span></span>), url); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddHeader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> header, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { _client.DefaultRequestHeaders.Add(header, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.ToString()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponseMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _client.GetAsync(_uri).Result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponseMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] content</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _client.PostAsync(_uri, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayContent(content)).Result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponseMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Put</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] content</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _client.PutAsync(_uri, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayContent(content)).Result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponseMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Head</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpRequestMessage(HttpMethod.Head, _uri); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _client.SendAsync(message).Result; } }</code> </pre><br></div></div><br>  Now you can use these classes to test a fictional controller that returns serialized dates and objects of a certain Platform class. <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestFixture</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyControllerTest</span></span> : <span class="hljs-title"><span class="hljs-title">AbstractControllerTest</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MyController</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MockRepository _mocks; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSetup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _mocks = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockRepository(MockBehavior.Strict); } [Test] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test_GetDates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//arrange var january = new DateTime(2013, 1, 1); var february = new DateTime(2013, 2, 1); var repositoryMock = _mocks.Create&lt;IRepository&gt;(); repositoryMock .Setup(r =&gt; r.GetDates()) .Returns(new[] {january, february}); Register(repositoryMock.Object); //act var dates = ExecuteGetRequest&lt;DateTime[]&gt;("/api/build-dates"); //assert _mocks.VerifyAll(); Assert.That(dates, Is.EquivalentTo(new[] { january, february })); } [Test] public void Test_GetPlatforms() { //arrange var platform1 = new Platform {Id=1, Name = "1"}; var platform2 = new Platform {Id=2, Name = "2"}; var repositoryMock = _mocks.Create&lt;IRepository&gt;(); repositoryMock .Setup(r =&gt; r.GetPlatforms()) .Returns(new[] { platform1, platform2 }); Register(repositoryMock.Object); //act var platforms = ExecuteGetRequest&lt;Platform[]&gt;("/api/platforms"); //assert _mocks.VerifyAll(); Assert.That(platforms, Is.EquivalentTo(new[] { platform1, platform2 })); } private T ExecuteGetRequest&lt;T&gt;(string uri) { var request = CreateRequest(url); var response = request.Get(); T result; response.TryGetContentValue(out result); return result; } }</span></span></code> </pre><br><br>  That's all.  Our controllers are covered with unit tests. <br><br>  <b>Case 3. Everything else</b> <br><br>  And with all the rest is quite simple.  Examples of unit tests for classes that contain pure logic, without interacting with any external environment, are practically the same as those proposed in popular literature such as <a href="http://www.amazon.com/Test-Driven-Development-By-Example/dp/0321146530">"TDD by Example" by</a> Kent Beck.  Therefore, there are no special tricks here. <br><br>  I will add that in addition to reducing the number of errors in the program logic, you can also get the following benefits from the use of unit tests: <br><br><ul><li>  <i>Simplify application architecture.</i>  The basic rule here is formulated as follows: "Only what is really needed is realized."  If the test describes all the scenarios and no longer manages to figure out how to break the logic, then you need to stop, bring the code to a more or less decent view (perform refactoring) and go to bed with a clear conscience. </li><li>  <i>Documenting code.</i>  What could be better than compiled and run examples of use?  A well-written test is excellent documentation, which, unlike comments, will not lose its relevance.  Unless, of course, successful passing of tests will be monitored when the implementation of the program logic changes. </li><li>  <i>"Safety bag".</i>  This, in my opinion, is the most important advantage that can be gained from using TDD in a project.  Tests will guarantee that a programmer unfamiliar with the code will immediately be able to see if any changes have violated the work of the program when making changes.  Actual and complete unit tests provide excellent feedback.  By the way, in the context of the "airbag", you can answer the question about the expediency of writing unit tests for seemingly obvious code.  In the case of team development, what is obvious to one developer may not be obvious to another.  For different reasons.  Including due to differences in the professional level of developers (we remember the team, right?).  And there may be a situation when this other person will have to make changes to the unobvious or just unfamiliar code.  And in this case, unit tests can save the system from malfunction and allow developers to perform their tasks more confidently and efficiently. </li></ul><br>  It is probably worth noting that the listed "buns" will always be fresh and tasty, while respecting the principle of "test first".  Have the requirements changed?  Add a test, change the code.  Correct the error?  Add a test, change the code.  The most difficult thing is to change the perception of tests.  Often, unit tests are perceived as something outsider, alien to the "main" code.  This is, in my opinion, the main obstacle to using TDD in full.  And it needs to be overcome, to realize that the unit tests and the programmed functionality are parts of one whole. <br><br>  To date, the project, which our team is working on, has about 1000 unit tests.  The build time and run all the tests on TeamCity is a little more than 4 minutes.  The approaches described in the article allow us to test almost all layers of the system, controlling the change and development of the code.  I hope that our experience will be useful for someone. <br></div><p>Source: <a href="https://habr.com/ru/post/191986/">https://habr.com/ru/post/191986/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191976/index.html">Video calls between Aastra 8000i terminals via IP-PBX Asterisk</a></li>
<li><a href="../191978/index.html">XenApp: transfer of servers to a new domain</a></li>
<li><a href="../191980/index.html">How to stop dragging diskettes on a DOS machine</a></li>
<li><a href="../191982/index.html">We repair the USB cable on the knee</a></li>
<li><a href="../191984/index.html">DebiGger for Yii 1.1 ported from Yii 2</a></li>
<li><a href="../191988/index.html">How not to overpay for Arduino and modules for it</a></li>
<li><a href="../191990/index.html">OpenWRT, or What else can you do with your router?</a></li>
<li><a href="../191994/index.html">Basics of Irrlicht Engine for newbies</a></li>
<li><a href="../191996/index.html">We draw electronic money</a></li>
<li><a href="../191998/index.html">Zaovnil, stuck, gash: dictionary IT-Schnick</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>