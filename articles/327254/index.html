<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A prototype of a simple service for healthy eating.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the context of the article, the picture acquires a double meaning. 
 Disclaimer 


 In society, in principle, a lot of "superficial" regarding the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A prototype of a simple service for healthy eating.</h1><div class="post__text post__text-html js-mediator-article"><p><img src="http://pics.spark-in.me/upload/a0bcb2b0ca36d55029508a88e360eeb5.jpg" alt="image"></p><br><p>  <em>In the context of the article, the picture acquires a double meaning.</em> </p><br><h2 id="-diskleymer">  <strong>Disclaimer</strong> </h2><br><p>  In society, in principle, a lot of "superficial" regarding the "right" food, "diets", "lifestyle" and others.  As a rule, these are simply manifestations of a relatively high level of wages in a particular region and a low level of literacy of people.  My girlfriend and I set a very simple task for ourselves - to eat tasty, simple, cheap, correct and fast. </p><br><p>  And it so happened that when choosing a tool for planning such a power, the eyes fell on PostgreSQL, which is on the home server.  Similarly, you can easily do it in Excel or Google-tables, but in our case SQL turned out to be faster + there are open databases with ready data.  This article can be considered by you as a ‚Äústock‚Äù for a similar SQL service or simply as an idea that you can take and apply for yourself. <br>  Also pay attention - in order to use this to the full, you should at least be able to use a tabular processor (Excel). </p><a name="habracut"></a><br><h5 id="-gruppy-lyudey-kotorym-zaydet-statya">  <strong>Groups of people to whom the article ‚Äúwill enter‚Äù:</strong> </h5><br><ul><li>  People who know SQL at least at the level of the simplest queries (if you are a DBA - some simplifications are made here to save time, and not for the reason you thought about); </li><li>  People who want to control what they eat; </li><li>  People who want to eat are tasty, inexpensive, simple and healthy; </li><li>  People who want to try to dig into a SQL server or are simply confident in using this tool; </li></ul><br><h5 id="-gruppy-lyudey-kotorym-ne-zaydet-statya">  <strong>Groups of people who will not be "entered" article:</strong> </h5><br><ul><li>  Why does the function simply return a query?  It should be 100 times harder! </li><li>  So the schemes only do ... / I eat everything that is horrible / why SQL - let's do it in general / who formats queries and so on; </li><li>  Cooking is not a lordly affair! </li><li>  It is necessary to normalize everything for another 10 rows! </li></ul><br><h2 id="-vstuplenie">  <strong>Introduction:</strong> </h2><br><p>  It so happened that for some time I lived in Moscow.  Moscow (in my world), as a rule, is characterized by: </p><br><p>  The low quality of the available food or the high price of a little less affordable; <br>  The total rubberiness of the products from the store (if you have been to Cyprus at least once - you will understand); <br>  Lack of ways to eat at the same time correctly and cheaply and tasty without any efforts (I‚Äôm not talking about marketing services with a margin of 50-60%, where you still need to prepare); <br>  The presence of markets where, in principle, everything is available at normal prices, but in the "raw" form; </p><br><h2 id="-tldr-dlya-neterpelivyh-i-prodvinutyh">  <strong>TLDR for the impatient and advanced:</strong> </h2><br><ul><li>  Download a <a href="https://goo.gl/UxNgmx">dump of</a> the PostgreSQL database (9.5+) of the database by reference and <a href="http://stackoverflow.com/questions/6842393/import-sql-dump-into-postgresql-database">unpack</a> ; </li><li>  If you arrange presets that are there, then just type in the query: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> get_random_menu()</code> </pre> </li><li>  The request will give you json (if you‚Äôve read it up here, you can easily change it to the format you need or pull the request with some driver) from the menu for a week (7 days) from the calculation: </li><li>  2 adults - a man and a woman (recommended_daily_intake); </li><li>  Calculating the amount of food is simply an extrapolation through calorie content (why is described below); </li><li><ul><li>  Food 4 times a day </li></ul><br></li><li><ul><li>  Multi-course breakfast; </li></ul><br></li><li><ul><li>  Dinner; </li></ul><br></li><li><ul><li>  Dinner; </li></ul><br></li><li><ul><li>  Snack in the evening; </li></ul><br></li><li>  The menu is selected randomly with each request; </li><li>  If you are not satisfied with the presets or you need to change the number of people (here it is set for a man and a woman with average needs): </li><li>  The function get_random_menu () will tell you what to change; </li><li>  Basic tables that are worth adjusting to themselves </li><li><ul><li>  recommended_daily_intake; </li></ul><br></li><li><ul><li>  All tables containing the word dish; </li></ul><br></li><li><ul><li>  The structure is a little complicated, but it will become clear if you read requests; </li></ul><br></li></ul><br><h2 id="-rezultat">  <strong>Result:</strong> </h2><br><p>  For this reason, we decided to make a mini-service for ourselves, where we brought simple dishes that we like.  In general, we tried to work with the USDA base - but it turned out to be excessively complex.  For this service, we tried to buy food for ~ <a href="https://goo.gl/1XPHvD">10 weeks</a> , <strong>and found out from experience that</strong> : </p><br><ul><li>  The algorithm had different bugs with proportions that we corrected (15 kilograms of sauerkraut a week is strong); </li><li>  On average, a week for 2 people takes about 4,000 rubles (!) + 1.5-2 hours to buy + 30-40 minutes for two people to cook daily.  In a month it turns out around 8 000-10 000 rubles per person; </li><li>  The girl also significantly lost weight (a nice bonus); </li><li>  Both stopped spending money on food in general.  And for lunch too; </li><li>  The most convenient format for working with the database - unloaded through any available program to the table, made a pivot table, uploaded to the phone; </li><li>  The easiest way to mark cooking is from the phone / computer in the table; </li><li>  Simple and tasty food and huge time savings on planning (10 hours max. On the development of this allows you to live almost 3 months without thinking about food); </li></ul><br><p>  In general, it may sometime reach the hands of <a href="https://goo.gl/dyog1B">such</a> (a <strong>description of how to turn an algorithm into an application and a product</strong> ), but for now communication with colleagues and the market suggest that the "rich" will not cook (they will rather pay a margin of 50-80% to services) and the "poor" in Russia will not pay for the application. </p><br><h2 id="pochemu-naivnaya-optimizaciya-po-kaloriyam-pochemu-ne-po-belkam">  <strong>Why "naive" calorie optimization?</strong>  <strong>Why not squirrels?</strong> </h2><br><p>  Because it works, but there is still no mechanism for an ideal measurement of needs (or we do not know it). </p><br><p>  The get_random_menu () function also gives perfect intake of calories, protein and carbohydrates - you can compare with your hands.  I tried to apply linear and non-linear optimization algorithms in Python (I generated 10,000 menus randomly, tried to improve the weights for the ‚Äúperfect‚Äù fit, didn‚Äôt achieve results in an hour or two, left), but most likely because of our set of dishes there is not it is possible to have a 100% hit - on average, proteins and carbohydrates are 15-20% less than the "ideal". </p><br><h2 id="opisanie-tehnicheskoy-sostavlyayuschey-bazy-i-funkciy">  <strong>Description of the technical component, the base and functions:</strong> </h2><br><p>  In general, filling in the data structure and writing functions took about 3-4 hours on tables and 2-3 hours on functions and is well expressed by the ER scheme: </p><br><p><img src="http://pics.spark-in.me/upload/69d4474cd80bd264c97dd434129520f9.png" alt="image"></p><br><p>  <strong>Note that:</strong> </p><br><ul><li>  It is better to use PostgreSQL 9.5+, since  uses several functions for working with json, which not so long ago appeared; </li><li>  There is the notion of a dish (dish), there is a notion of what meals it can be taken in (dish_serving_choice, dish_serving); </li><li>  dish_menu - an example of the log of purchased food, then it turned out to be easier to collect in Excel </li><li>  Not every dish can be eaten, for example, for breakfast there is dish_type; </li><li>  Meals consist of ingredients (dish_ingredient), but do not contain water (there are no calories in it - optimization will not work) - all proportions are calculated taking into account this fact; </li><li>  In fact, we made several assumptions: </li><li>  Calorie intake ratios for meals (dish_serving_choice); </li><li>  Calorie required (below); </li><li>  The composition of dishes (dish_contents); </li></ul><br><p>  There are also 2 tables describing people's needs, their modification is required to change the number of people. </p><br><p><img src="http://pics.spark-in.me/upload/165598ecc597505d0a59f39b43fc285f.png" alt="image"></p><br><h4 id="prosche-vsego-ponyat-esli-vy-znaete-sql-kak-eto-vse-rabotaet-posmotrev-na-paru-osnovnyh-funkciy">  <strong>The easiest way to understand (if you know SQL) is how it all works by looking at a couple of basic functions.</strong> </h4><br><p>  <strong>getPrimitiveMenu</strong> </p><br><ul><li>  Basic function  which simply creates a random menu; </li><li>  Creates a random menu for 7 days; </li><li>  Randomization is essentially done through ORDER BY random (); </li><li>  We create a week with a simple unnest construction (ARRAY [1,2,3,4,5,6,7]); </li><li>  The rest is trivial; </li></ul><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-string"><span class="hljs-string">"usda28"</span></span>.<span class="hljs-string"><span class="hljs-string">"getPrimitiveMenu"</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> SETOF <span class="hljs-string"><span class="hljs-string">"pg_catalog"</span></span>.<span class="hljs-string"><span class="hljs-string">"record"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> raw_data1.week_day ::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> week_day, raw_data1.meal_order :: <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> meal_id, raw_data1.meal :: <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> meal, raw_data1.balance ::<span class="hljs-built_in"><span class="hljs-built_in">NUMERIC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_share, raw_data1.dish_type :: <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_type, d.title :: <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_title, d.deliciousness :: <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_taste, dc.portion :: <span class="hljs-built_in"><span class="hljs-built_in">NUMERIC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> proportion, di.id::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_ingredient_id, di.title ::<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> di_title, di.calories :: <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> calories_per_100, di.carbs :: <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> carbs_per_100, di.fat :: <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fat_per_100, di.protein :: <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> protein_per_100 <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dsc.calorie_balance <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> balance, ds.title <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> meal, dsc.dish_serving_id, dsc.choice_id, ds.id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> meal_order, dt.title <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_type, presets.week_day <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> week_day, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d.<span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> usda28.dish d <span class="hljs-comment"><span class="hljs-comment">/* Checking that the dish has actual ingredients, otherwise errors are possible */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> usda28.dish_contents dc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dc.dish_id = d.<span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d.dish_type_id = dsc.dish_type_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> random() <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> servings_count.dsc_id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dsc_id, trunc(servings_count.choice_count * random() + <span class="hljs-number"><span class="hljs-number">1</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> preset_choice, <span class="hljs-keyword"><span class="hljs-keyword">unnest</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> week_day <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> dsc.dish_serving_id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dsc_id, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> dsc.choice_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> choice_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> usda28.dish_serving_choice dsc <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> dsc.dish_serving_id ) servings_count <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unnest</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>]) ) presets <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> usda28.dish_serving_choice dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dsc.choice_id = presets.preset_choice <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.dish_serving_id = presets.dsc_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> usda28.dish_serving ds <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ds.<span class="hljs-string"><span class="hljs-string">"id"</span></span> = dsc.dish_serving_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> usda28.dish_type dt <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dt.<span class="hljs-string"><span class="hljs-string">"id"</span></span> = dsc.dish_type_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> presets.week_day <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, dsc.dish_serving_id <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) raw_data1 <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> usda28.dish d <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.<span class="hljs-string"><span class="hljs-string">"id"</span></span> = raw_data1.dish_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> usda28.dish_contents dc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dc.dish_id = d.<span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> usda28.dish_ingredient di <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> di.<span class="hljs-string"><span class="hljs-string">"id"</span></span> = dc.ingredient_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> raw_data1.week_day <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, raw_data1.meal_order <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, d.title <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'plpgsql'</span></span> VOLATILE <span class="hljs-keyword"><span class="hljs-keyword">COST</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROWS</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> ;</code> </pre> <br><p>  <strong>get_random_menu</strong> </p><br><ul><li>  A function that weighs the menu by calories and gives a random menu; </li><li>  If you do not know about the window functions - read; </li><li>  In essence, the function takes what the previous function did + considers the number of calories as a subquery (...) nut; </li><li>  The conventionally complex formula is essentially just a school proportion; </li></ul><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-string"><span class="hljs-string">"usda28"</span></span>.<span class="hljs-string"><span class="hljs-string">"get_random_menu"</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-string"><span class="hljs-string">"pg_catalog"</span></span>.<span class="hljs-string"><span class="hljs-string">"json"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> to_json(array_agg(a)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">md5</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>||<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>()::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>||random()::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> menu_uuid), raw_data.week_day <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> week_day, raw_data.meal_id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> meal_id, raw_data.meal <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> meal, raw_data.dish_type <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_type, raw_data.dish_title <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_title, raw_data.dish_ingredient_id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_ingredient_id, raw_data.ingredient_title <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ingredient_title, raw_data.dish_share, raw_data.proportion, raw_data.calories_per_100, raw_data.carbs_per_100, raw_data.fat_per_100, raw_data.protein_per_100, trunc( raw_data.proportion * raw_data.dish_share * raw_data.calories * <span class="hljs-number"><span class="hljs-number">100</span></span> / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(raw_data.stat_weight) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> raw_data.week_day, raw_data.meal_id, raw_data.meal, raw_data.dish_type, raw_data.dish_title ) )<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> grams_guesstimate <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> menu.week_day <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> week_day, menu.meal_id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> meal_id, menu.meal <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> meal, menu.dish_type <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_type, menu.dish_title <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_title, menu.dish_ingredient_id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dish_ingredient_id, menu.di_title <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ingredient_title, menu.dish_share, menu.proportion, menu.calories_per_100, menu.carbs_per_100, menu.fat_per_100, menu.protein_per_100, nut.calories, menu.proportion * menu.calories_per_100 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> stat_weight <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> week_day, meal_id, meal, dish_share, dish_type, dish_title, dish_taste, proportion, dish_ingredient_id, di_title, calories_per_100, carbs_per_100, fat_per_100, protein_per_100 <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> usda28.<span class="hljs-string"><span class="hljs-string">"getPrimitiveMenu"</span></span>() ) menu <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span> (rdi.carbs) * mlp.proportion <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> carbs, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span> (rdi.fat) * mlp.proportion <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fat, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span> (rdi.protein) * mlp.proportion <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> protein, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span> (rdi.calories) * mlp.proportion <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> calories, ml.title <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> meal_title, ml.<span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> meal_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> usda28.recommended_daily_intake rdi <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> usda28.activity_types atp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> atp.<span class="hljs-string"><span class="hljs-string">"id"</span></span> = rdi.activity_type_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> atp.<span class="hljs-string"><span class="hljs-string">"id"</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> usda28.meal_proportions mlp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> usda28.dish_serving ml <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ml.id = mlp.meal_id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ml.title, mlp.proportion, ml.<span class="hljs-string"><span class="hljs-string">"id"</span></span> ) nut <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> nut.meal_id = menu.meal_id ) raw_data <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> raw_data.meal_id <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, raw_data.week_day <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, raw_data.dish_type <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) a $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'sql'</span></span> VOLATILE <span class="hljs-keyword"><span class="hljs-keyword">COST</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> ;</code> </pre> <br><p>  If you like it - write in a personal. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/327254/">https://habr.com/ru/post/327254/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327244/index.html">How to make life Redux developer easier?</a></li>
<li><a href="../327246/index.html">Carousel on Vanilla.JS</a></li>
<li><a href="../327248/index.html">Bash scripts, part 6: functions and library development</a></li>
<li><a href="../327250/index.html">Open machine learning course. Theme 10. Gradient boosting</a></li>
<li><a href="../327252/index.html">Go meetup report April 14</a></li>
<li><a href="../327256/index.html">How DDos-attacks are ‚Äúordered‚Äù: life story</a></li>
<li><a href="../327258/index.html">Why do we need chat bots, or the story of Bitrix24</a></li>
<li><a href="../327260/index.html">How Google Cloud protects its data centers from cybercriminals and internal errors</a></li>
<li><a href="../327262/index.html">UIKit + Viper or MVC healthy person</a></li>
<li><a href="../327264/index.html">Everything is bad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>