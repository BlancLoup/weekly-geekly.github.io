<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL query optimization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In everyday work, one encounters rather similar mistakes when writing queries. 

 In this article I would like to give examples of how NOT to write qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL query optimization</h1><div class="post__text post__text-html js-mediator-article">  In everyday work, one encounters rather similar mistakes when writing queries. <br><br>  In this article I would like to give examples of how NOT to write queries. <br><a name="habracut"></a><ul><li>  Selection of all fields <br>  SELECT * FROM table <br><br>  When writing queries do not use a selection of all fields - "*".  List only the fields that you really need.  This will reduce the number of selectable and forwarding data.  In addition, do not forget about covering indexes.  Even if you actually need all the fields in the table, it is better to list them.  First, it improves the readability of the code.  When using an asterisk, it is impossible to know which fields are in the table without looking into it.  Secondly, over time, the number of columns in your table can change, and if today there are five INT columns, then in a month TEXT and BLOB fields can be added, which will slow down the selection. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li><li>  Requests in a loop. <br>  You need to be clear about the fact that SQL is a language that operates on sets.  Sometimes programmers who are accustomed to thinking in terms of procedural languages ‚Äã‚Äãfind it difficult to restructure thinking into the language of sets.  This can be done quite simply by adopting a simple rule - ‚Äúnever execute queries in a loop‚Äù.  Examples of how this can be done: <br><br>  1. Samples <br>  $ news_ids = get_list ('SELECT news_id FROM today_news'); <br>  while ($ news_id = get_next ($ news_ids)) <br>  $ news [] = get_row ('SELECT title, body FROM news WHERE news_id ='. $ news_id); <br><br>  The rule is very simple - the fewer requests, the better (although there are exceptions to this, as well as from any rule).  Do not forget about the design of IN ().  The following code can be written in one query: <br>  SELECT title, body FROM today_news INNER JOIN news USING (news_id) <br><br>  2. Inserts <br>  $ log = parse_log (); <br>  while ($ record = next ($ log)) <br>  query ('INSERT INTO logs SET value ='. $ log ['value']); <br><br>  It is much more efficient to glue and execute one query: <br>  INSERT INTO logs (value) VALUES (...), (...) <br><br>  3. Updates <br>  Sometimes you need to update multiple rows in a single table.  If the updated value is the same, then everything is simple: <br>  UPDATE news SET title = 'test' WHERE id IN (1, 2, 3). <br><br>  If the changeable value for each record is different, then this can be done with such a query: <br>  UPDATE news SET <br>  title = CASE <br>  WHEN news_id = 1 THEN 'aa' <br>  WHEN news_id = 2 THEN 'bb' END <br>  WHERE news_id IN (1, 2) <br><br>  Our tests show that such a query is performed 2-3 times faster than several separate queries. <br><br></li><li>  Performing operations on indexed fields <br>  SELECT user_id FROM users WHERE blogs_count * 2 = $ value <br><br>  In such a query, the index will not be used, even if the blogs_count column is indexed.  In order for the index to be used, no transformations should be performed on the indexed field in the query.  For such queries, take out the conversion functions to another part: <br>  SELECT user_id FROM users WHERE blogs_count = $ value / 2; <br><br>  Similar example: <br>  SELECT user_id FROM users WHERE TO_DAYS (CURRENT_DATE) - TO_DAYS (registered) &lt;= 10; <br><br>  will not use the index across the registered field, whereas <br>  SELECT user_id FROM users WHERE registered&gt; = DATE_SUB (CURRENT_DATE, INTERVAL 10 DAY); <br>  will be. <br><br></li><li>  Fetching rows for counting only <br>  $ result = mysql_query ("SELECT * FROM table", $ link); <br>  $ num_rows = mysql_num_rows ($ result); <br>  If you need to select the number of rows that satisfy a specific condition, use the SELECT COUNT (*) FROM table query, and do not select all the rows to count them. <br><br></li><li>  Fetching extra lines <br>  $ result = mysql_query ("SELECT * FROM table1", $ link); <br>  while ($ row = mysql_fetch_assoc ($ result) &amp;&amp; $ i &lt;20) { <br>  ... <br>  } <br>  If you need only n sample lines, use LIMIT instead of discarding extra lines in the application. <br><br></li><li>  Using ORDER BY RAND () <br>  SELECT * FROM table ORDER BY RAND () LIMIT 1; <br><br>  If the table has more than 4-5 thousand rows, then ORDER BY RAND () will work very slowly.  It will be much more efficient to perform two requests: <br><br>  If the auto_increment table has a primary key and there are no gaps: <br>  $ rnd = rand (1, query ('SELECT MAX (id) FROM table')); <br>  $ row = query ('SELECT * FROM table WHERE id ='. $ rnd); <br><br>  or: <br>  $ cnt = query ('SELECT COUNT (*) FROM table'); <br>  $ row = query ('SELECT * FROM table LIMIT'. $ cnt. ', 1'); <br>  which, however, can also be slow with a very large number of rows in the table. <br><br></li><li>  Using a large number of JOINs <br>  SELECT <br>  v.video_id <br>  a.name, <br>  g.genre <br>  FROM <br>  videos AS v <br>  LEFT JOIN <br>  link_actors_videos AS la ON la.video_id = v.video_id <br>  LEFT JOIN <br>  actors AS a ON a.actor_id = la.actor_id <br>  LEFT JOIN <br>  link_genre_video AS lg ON lg.video_id = v.video_id <br>  LEFT JOIN <br>  genres AS g ON g.genre_id = lg.genre_id <br><br>  It must be remembered that when one-to-many tables are connected, the number of rows in the sample will grow with each successive JOIN.  For such cases, it is faster to break such a request into a few simple ones. <br><br></li><li>  Use LIMIT <br>  SELECT ... FROM table LIMIT $ start, $ per_page <br><br>  Many people think that such a query will return $ per_page records (usually 10-20) and therefore will work quickly.  It will work quickly for the first few pages.  But if the number of records is large, and you need to perform a SELECT query ... FROM table LIMIT 1000000, 1000020, then to execute such a query, MySQL will first select 1000020 records, discard the first million and return 20. This may not be very fast.  There are no trivial solutions to the problem.  Many simply limit the number of available pages to a reasonable number.  You can also speed up such queries using cover indexes or third-party solutions (for example, sphinx). <br><br></li><li>  Failure to use ON DUPLICATE KEY UPDATE <br>  $ row = query ('SELECT * FROM table WHERE id = 1'); <br><br>  if ($ row) <br>  query ('UPDATE table SET column column = column + 1 WHERE id = 1') <br>  else <br>  query ('INSERT INTO table SET column = 1, id = 1'); <br><br>  Such a construction can be replaced by a single request, provided that there is a primary or unique key by the id field: <br>  INSERT INTO table SET column = 1, id = 1 ON DUPLICATE KEY UPDATE column = column + 1 <br></li></ul><br>  Read the <a href="http://mysqlconsulting.ru/articles/3/query-optimizing/">original article</a> at MySQL Consulting. <br><br>  PS write in lichku topics on MySQL articles that you would like to read. <br><br></div><p>Source: <a href="https://habr.com/ru/post/41968/">https://habr.com/ru/post/41968/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419671/index.html">Restrictions that need to be violated or how we accelerated the functional tests three times</a></li>
<li><a href="../419673/index.html">Early Universe 6. The Dynamics of a Homogeneous Expanding Universe, Part 2</a></li>
<li><a href="../419675/index.html">Review of per minute rental of electric scooters in Moscow, summer 2018</a></li>
<li><a href="../419677/index.html">How to sniff HTTPS traffic on an iOS device</a></li>
<li><a href="../419679/index.html">Implementing the Spring Framework API from scratch. Step-by-step guide for beginners. Part 1</a></li>
<li><a href="../419683/index.html">What do the metrics mean for Agile teams?</a></li>
<li><a href="../419685/index.html">Key data structures you should know about your programming interview.</a></li>
<li><a href="../419687/index.html">Mystery Keyboard Level 3 or how to type a long dash</a></li>
<li><a href="../419689/index.html">I. Disadaptation. Ii. ADHD or lazy moron?</a></li>
<li><a href="../41969/index.html">Download files in the background</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>