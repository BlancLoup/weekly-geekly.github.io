<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The fundamental HTML vulnerability when embedding scripts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To describe the essence of the problem, I need to tell you what HTML is all about. You probably in general imagined, but I still briefly go over the m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The fundamental HTML vulnerability when embedding scripts</h1><div class="post__text post__text-html js-mediator-article"><p>  To describe the essence of the problem, I need to tell you what HTML is all about.  You probably in general imagined, but I still briefly go over the main points that will be needed to understand.  If someone can not wait, immediately <a href="https://habrahabr.ru/post/348558/">go to the point</a> . </p><br><p>  HTML is a hypertext markup language.  To speak this language, you must comply with its format, otherwise the one who reads the written, can not understand you.  For example, in HTML tags have attributes: </p><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"value"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Here <code>[name]</code> is the name of the attribute, and <code>[value]</code> is its value.  In the article, I will use square brackets around the code to make it clear where it begins and ends.  After the name is an equal sign, and after it - the value enclosed in quotes.  The attribute value begins immediately after the first quotation mark and ends immediately before the next quotation mark, wherever it is.  This means that if instead of <code>[value]</code> you write <code>[OOO "  ".]</code> , Then the value of the <code>name</code> attribute will be <code>[OOO ]</code> , and your element will also have three other attributes with names: <code>[]</code> , <code>[]</code> and <code>["."]</code> , but without values. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"OOO "</span></span></span><span class="hljs-tag">  "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">"&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  If this is not what you expected, you need to somehow change the value of the attribute so that it does not contain a quotation mark.  The simplest thing you can think of is to just cut the quotes. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"OOO   ."</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <a name="habracut"></a><br><p>  Then the HTML parser will correctly read the value, but the trouble is that it will be a <strong>different</strong> value.  You wanted <code>[OOO "  "]</code> , and you got <code>[OOO   .]</code> .  In some cases, this distinction may be critical. </p><br><p>  So that you can specify any string as a value, the HTML format offers the possibility to escape attribute values.  Instead of quotation marks in the string value, you can write a sequence of characters <code>[&amp;quot;]</code> and the parser will understand that in this place there was a quotation mark in the source string you want to use as the attribute value.  Such sequences are called HTML entities. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"OOO &amp;quot;  &amp;quot;."</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  At the same time, if in your source line there really was a sequence of characters <code>[&amp;quot;]</code> , you still have the opportunity to write it in such a way that the parser does not turn it into a quotation mark ‚Äî to do this, replace the <code>[&amp;]</code> sign with the sequence of characters <code>[&amp;amp;]</code> , that is, instead of <code>[&amp;quot;]</code> you will need to write in the raw text <code>[&amp;amp;quot;]</code> . </p><br><p>  It turns out that the conversion from the source string to the one that we write between two quotation marks is <strong>unambiguous and reversible</strong> .  Thanks to these transformations, <strong>you can write and read any string</strong> as an attribute of an HTML tag, without going into the essence of its contents.  You just keep the format, and everything works. </p><br><p>  Actually, this is the way most of the formats we come across: there is a syntax, there is a way of shielding content from this syntax and a way of shielding shielding characters, if suddenly such a sequence occurs in the source line.  Most, but not ... </p><br><h2 id="teg-ltscriptgt">  &lt;Script&gt; tag </h2><br><p>  The &lt;script&gt; tag is used to embed in HTML fragments written in other languages.  Today, in 99% of cases, this is Javascript.  The script begins immediately after the opening &lt;script&gt; tag and ends immediately before the closing &lt;/ script&gt; tag.  The HTML parser does not look inside the tag, for it is just some kind of text that it then gives to the Javascript parser. </p><br><p>  In turn, Javascript is an independent language with its own syntax, it, generally speaking, is not designed in any special way for what will be embedded in HTML.  In it, as in any other language, there are string literals in which there can be anything.  And, as you should have guessed, there may be a sequence of characters that means the closing &lt;/ script&gt; tag. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> s = </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"surprise!</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript">alert(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">'whoops!'</span></span></span><span class="actionscript">)</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span>"; <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  What should happen here: a harmless string must be assigned to the variable <code>s</code> . </p><br><p>  What actually happens here: The script in which the variable <code>s</code> declared ends with the following: <code>[var s = "surprise!]</code> , Which leads to a syntax error. All text after it is interpreted as pure HTML and any text can be embedded into it markup. In this case, the new &lt;script&gt; tag opens and the malicious code is executed. </p><br><p>  We get the same effect as when the quote value is present in the attribute value.  But unlike attribute values, there is no way for the &lt;script&gt; tag to escape the source content.  HTML entities inside the &lt;script&gt; tag do not work, they will be transferred to the Javascript parser without changes, that is, they either lead to an error or change its meaning.  <a href="https://html.spec.whatwg.org/multipage/scripting.html">The HTML standard</a> explicitly states that the content of the &lt;script&gt; tag cannot contain a sequence of characters &lt;/ script&gt; in any form.  And the Javascript standard does not prohibit such a sequence to be anywhere in string literals. </p><br><p>  A paradoxical situation turns out: <strong>after embedding a valid Javascript into a valid HTML document using absolutely valid means, we can get an invalid result</strong> . </p><br><p>  In my opinion, this is a HTML markup vulnerability, leading to vulnerabilities in real applications. </p><br><h2 id="kak-ekspluatiruetsya-uyazvimost">  How vulnerability is exploited </h2><br><p>  Of course, when you just write some code, it‚Äôs hard to imagine that you will write in the &lt;/ script&gt; line and you will not notice any problems.  At a minimum, syntax highlighting will let you know that the tag has closed ahead of time, as a maximum, the code you write will not start and you will search for a long time what happened.  But this is not the main problem with this vulnerability.  The problem arises where you insert some content into Javascript when you generate HTML.  Here is a frequent piece of application code on a server-side rendering server: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.__INITIAL_STATE__ = </span><span class="xml"><span class="hljs-tag"><span class="javascript"><span class="xml"><span class="hljs-tag">&lt;</span></span></span><span class="hljs-name"><span class="javascript"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%-</span></span></span></span></span><span class="javascript"><span class="xml"><span class="hljs-tag"> </span></span></span><span class="hljs-attr"><span class="javascript"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">JSON.stringify</span></span></span></span></span><span class="javascript"><span class="xml"><span class="hljs-tag">(</span></span></span><span class="hljs-attr"><span class="javascript"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initialState</span></span></span></span></span><span class="javascript"><span class="xml"><span class="hljs-tag">) %&gt;</span></span></span></span><span class="javascript"><span class="xml">; </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  The <code>initialState</code> &lt;/ script&gt; may appear anywhere where data comes from the user or from other systems.  <code>JSON.stringify</code> will not change such strings during serialization, because they fully comply with the JSON and Javascript formats, so they will simply go to the page and allow the attacker to execute arbitrary Javascript in the user's browser. </p><br><p>  Another example: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> analytics.identify( </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">'&lt;%- user.id.replace(/(\'|\\)/g, "\\$1") %&gt;'</span></span></span><span class="actionscript">, </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">'&lt;%- request.HTTP_REFERER.replace(/(\'|\\)/g, "\\$1") %&gt;'</span></span></span><span class="actionscript">, ... ); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Here, the user <code>id</code> and the <code>referer</code> that came to the server are written into the lines with the corresponding screening.  And, if the <code>user.id</code> unlikely to be anything other than numbers, then in the <code>referer</code> attacker can cram anything. </p><br><p>  But on the closing tag &lt;/ script&gt; the jokes don't end.  The danger is also represented by the opening &lt;script&gt; tag, if in front of it in any place there are symbols <code>[&lt;!--]</code> , which in normal HTML mark the beginning of a multi-line comment.  And in this case, the syntax highlighting of most editors will not help you. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> a = </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">'Consider this string: &lt;!--'</span></span></span><span class="actionscript">; </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> b = </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">'&lt;script&gt;'</span></span></span><span class="actionscript">; </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Any text<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> s = </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">'another script'</span></span></span><span class="actionscript">; </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  What does a healthy person and most syntax highlights in this code see?  Two &lt;script&gt; tags between which there is a paragraph. </p><br><p>  What does the sick HTML5 parser see?  He sees one (!) Unclosed (!) &lt;Script&gt; tag containing all the text from the second line to the last. </p><br><p>  I don‚Äôt understand why it works like this, I only understand that when I encounter the characters <code>[&lt;!--]</code> somewhere, the HTML parser begins to read the opening and closing &lt;script&gt; tags and does not consider the script to be complete until all are closed. public tags &lt;script&gt;.  That is, in most cases, this script will go to the bottom of the page (unless someone could inject another extra closing tag &lt;/ script&gt; below, hehe).  If you haven‚Äôt come across this before, you might think that I'm joking now.  Unfortunately not.  Here is a screenshot of the DOM tree of the example above: </p><br><p><img src="https://habrastorage.org/webt/te/sl/iy/tesliyt9wv1h62hmtmsreyovg3g.png"></p><br><p>  The most annoying thing is that, unlike the closing &lt;/ script&gt; tag, which in Javascript can occur only inside string literals, sequences of characters <code>&lt;!--</code> and <code>&lt;script</code> can also occur in the code itself!  And will have exactly the same effect. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">if</span></span></span><span class="actionscript"> (x&lt;!--y) { ... } </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">if</span></span></span><span class="actionscript"> ( player&lt;script ) { ... } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h2 id="a-vy-tochno-specifikaciya">  Are you sure the specification? </h2><br><p>  The HTML specification, besides the fact that it prohibits the use of legal sequences of characters inside the &lt;script&gt; tag and does not provide any way of escaping them within HTML, also advises the following: </p><br><blockquote>  "&lt;! -" as "&lt;\! -", "&lt;script" as "&lt;\ script", and "&lt;! -" as "as" &lt;\ / script "when you use these constructs in expressions. </blockquote><p>  What can be translated as ‚ÄúAlways escape the sequences" <code>&lt;!--</code> "as" <code>&lt;\!--</code> "," <code>&lt;script</code> "as" <code>&lt;\script</code> ", and" <code>&lt;/script</code> "as" <code>&lt;\/script</code> "when occur in <strong>string literals</strong> in your <strong>scripts</strong> and avoid these expressions in the code itself. "  This recommendation touches me.  Several naive assumptions are made at once: </p><br><ol><li>  In an embedded script (and this is not necessarily Javascript), the above sequences of characters can either be inside string literals, or they can be easily avoided in the syntax of the language. </li><li>  In an embedded script, non-special characters can be escaped in string literals, and this does not change the values ‚Äã‚Äãof the literals. </li><li>  Anyone who embeds a script knows what the script is, deeply understands its syntax and is able to make changes in its structure. </li></ol><br><p>  And, if the first two items are executed at least for Javascript, then the last one is not executed even for it.  Not always the script is inserted into HTML by a qualified person, it could be some kind of HTML generator.  Here is an example of how the browser itself does not cope with this: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> script = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'script'</span></span>) script.innerText = <span class="hljs-string"><span class="hljs-string">'var s = "&lt;/script&gt;&lt;script&gt;alert(\'whoops!\')&lt;/script&gt;"'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(script.outerHTML); &gt;&gt;&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="actionscript"><span class="hljs-keyword"><span class="xml"><span class="actionscript"><span class="hljs-keyword">var</span></span></span></span><span class="xml"><span class="actionscript"> s = </span></span><span class="hljs-string"><span class="xml"><span class="actionscript"><span class="hljs-string">"</span></span></span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="actionscript"><span class="xml"><span class="actionscript">alert(</span></span><span class="hljs-string"><span class="xml"><span class="actionscript"><span class="hljs-string">'whoops!'</span></span></span></span><span class="xml"><span class="actionscript">)</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-string"><span class="hljs-string">"&lt;/script&gt;</span></span></code> </pre> <br><p>  As you can see, the string with the serialized element will not be parsed into an element similar to the original one.  Transformation DOM-tree ‚Üí HTML-text in general is not unambiguous and reversible.  Some DOM trees simply cannot be represented as HTML source text. </p><br><h2 id="kak-izbezhat-problem">  How to avoid problems? </h2><br><p>  As you already understood, there is no way to safely insert Javascript into HTML.  But there are ways to make Javascript safe for insertion into HTML (feel the difference).  However, for this you need to be extremely attentive all the time while you are writing something inside the &lt;script&gt; tag, especially if you insert any data using the template engine. </p><br><p>  Firstly, the probability that you will encounter characters in the source text (even after minification) not in string literals <code>[&lt;!-- &lt;script&gt;]</code> extremely small.  You yourself are unlikely to write something like that, and if an attacker can write something directly in the &lt;script&gt; tag, then the introduction of these characters will bother you last. </p><br><p>  There remains the problem of embedding characters into strings.  In this case, as written in the specification, all you need is to replace everything " <code>&lt;!--</code> " with " <code>&lt;\!--</code> ", " <code>&lt;script</code> " with " <code>&lt;\script</code> ", and " <code>&lt;/script</code> " with " <code>&lt;\/script</code> ".  But the trouble is that if you output some structure using <code>JSON.stringify()</code> , you are unlikely to want to parse it again to find all the string literals and screen something in them.  I also do not want to advise using other packages for serialization, where this problem has already been taken into account, because situations are different, but I always want to defend myself and the solution should be universal.  Therefore, I would advise to escape the characters / and!  using the backslash after serialization.  These characters can not be found in JSON anywhere except within strings, so a simple replacement will be absolutely safe.  This does not change the sequence of characters " <code>&lt;script</code> ", but it does not pose a danger if it occurs by itself. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.__INITIAL_STATE__ = </span><span class="xml"><span class="hljs-tag"><span class="javascript"><span class="xml"><span class="hljs-tag">&lt;</span></span></span><span class="hljs-name"><span class="javascript"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%-</span></span></span></span></span><span class="javascript"><span class="xml"><span class="hljs-tag"> </span></span></span><span class="hljs-attr"><span class="javascript"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">JSON.stringify</span></span></span></span></span><span class="javascript"><span class="xml"><span class="hljs-tag">(</span></span></span><span class="hljs-attr"><span class="javascript"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initialState</span></span></span></span></span><span class="javascript"><span class="xml"><span class="hljs-tag">)</span></span></span><span class="hljs-attr"><span class="javascript"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.replace</span></span></span></span></span><span class="javascript"><span class="xml"><span class="hljs-tag">(/(\/|\!)/</span></span></span><span class="hljs-attr"><span class="javascript"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">g</span></span></span></span></span><span class="javascript"><span class="xml"><span class="hljs-tag">, "\\$</span></span></span><span class="hljs-attr"><span class="javascript"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span></span><span class="javascript"><span class="xml"><span class="hljs-tag">") %&gt;</span></span></span></span><span class="javascript"><span class="xml">; </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Similarly, individual lines can be escaped. </p><br><p>  Another tip is to not embed anything in the &lt;script&gt; tag.  Store data in places where transformations to insert data are unambiguous and reversible.  For example, in the attributes of other elements.  The truth is it looks pretty dirty and works only with strings, JSON will have to parse separately. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">var</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"s"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"surprise!&lt;/script&gt;&lt;script&gt;alert(&amp;quot;whoops!&amp;quot;)&lt;/script&gt;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">var</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> s = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'s'</span></span></span><span class="javascript">).getAttribute(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'data'</span></span></span><span class="javascript">); </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(s); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  But, in an amicable way, of course, if you want to develop applications normally, and not walk neatly through a minefield, you need a reliable way to embed scripts in HTML.  Therefore, I consider it to be the right decision to completely abandon the &lt;script&gt; tag as not safe. </p><br><h2 id="teg-ltsafescriptgt">  &lt;Safescript&gt; tag </h2><br><p>  If you do not use embedded scripts, then what?  Of course, connecting all the scripts from the outside is not an option, sometimes having some kind of Javascript with the data inside the HTML document is very convenient: there are no extra HTTP requests, no need to make additional routes on the server side. </p><br><p>  Therefore, I propose to introduce a new tag - &lt;safescript&gt;, the contents of which will completely obey the usual rules of HTML - HTML entities will work to screen content - and therefore embedding any script into it will be absolutely safe. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">safescript</span></span></span><span class="hljs-tag">&gt;</span></span> var s = "surprise!&amp;lt;/script&amp;gt;&amp;lt;script&amp;gt;alert('whoops!')&amp;lt;/script&amp;gt;"; <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">safescript</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">safescript</span></span></span><span class="hljs-tag">&gt;</span></span> var a = 'Consider this string: &amp;lt;!--'; var b = '&amp;lt;script&amp;gt;'; <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">safescript</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  There is no need to wait for the implementation of this tag in browsers.  I wrote a very simple <a href="https://www.npmjs.com/package/safescript">polyfil safescript</a> that allows you to use it right now.  Here is all that is needed for this: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/static/safescript.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">safescript</span></span></span><span class="css"> {</span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">display</span></span></span><span class="css">: none </span><span class="hljs-meta"><span class="css"><span class="hljs-meta">!important</span></span></span><span class="css">}</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  The code inside the &lt;safescript&gt; looks awful and unusual.  But this is the code that goes into the HTML itself.  In the template engine that you use, you can make a simple filter that will insert the tag and screen all its contents.  This is how the code in the Django template engine might look like: </p><br><pre> <code class="javascript hljs">{% safescript %} <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = <span class="hljs-string"><span class="hljs-string">"surprise!&lt;/script&gt;&lt;script&gt;alert('whoops!')&lt;/script&gt;"</span></span>; {% endsafescript %} {% safescript %} <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-string"><span class="hljs-string">'Consider this string: &lt;!--'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = <span class="hljs-string"><span class="hljs-string">'&lt;script&gt;'</span></span>; {% endsafescript %}</code> </pre> <br><p>  This approach allows you to forget about escaping Javascript and avoid many vulnerabilities.  And it would be very nice if the guys developing the HTML specification added such a script to the base set or came up with some other way to solve the problem of unsafe embedding of scripts in HTML. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348558/">https://habr.com/ru/post/348558/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348546/index.html">Why is it so hard to attract money in the open source?</a></li>
<li><a href="../348548/index.html">Selection: 7 Chrome extensions to bypass locks</a></li>
<li><a href="../348550/index.html">SLA philosophy: about query priorities</a></li>
<li><a href="../348552/index.html">Extending and using the Linux Crypto API</a></li>
<li><a href="../348554/index.html">Welcome to Cradle: Rave. And no, this is not a disco</a></li>
<li><a href="../348560/index.html">Relationship functionality</a></li>
<li><a href="../348562/index.html">BI & Blockchain is a collective intelligence based solution. Part 2</a></li>
<li><a href="../348564/index.html">We write scalable and supported servers on Node.js and TypeScript</a></li>
<li><a href="../348566/index.html">Flask Mega-Tutorial, Part X: Email Support (Edition 2018)</a></li>
<li><a href="../348570/index.html">7 Free Data Science Courses for Beginners</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>