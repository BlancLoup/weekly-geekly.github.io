<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Security programming</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of my readers, Barry Giles, recently wrote to me and asked a rather interesting question, which, in my opinion, is worthy of discussion: 

 ‚ÄúRecen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Security programming</h1><div class="post__text post__text-html js-mediator-article">  One of my readers, Barry Giles, recently wrote to me and asked a rather interesting question, which, in my opinion, is worthy of discussion: <br><br><blockquote>  ‚ÄúRecently, I ran into one interesting situation at work: I did a review of the code and inserted security checks ‚Äî one to check the constructor argument to null, one to check the null value returned from the property.  I also had statements for closed methods, which I used to explicitly state my assumptions. <br>  ‚ÄúIt seems that the prevailing practice among my teammates is to omit checks and allow falls.  To be honest, I‚Äôm struggling with this concept, as I‚Äôm used to developing through defensive programming and considered it a good practice.  I am pretty sure that this is also the case for most of the manuals and blog entries. <br>  ‚ÄúCould you give advice on why it is better to program in a defensive style, instead of letting the code fail and then checking the stack trace?‚Äù </blockquote><a name="habracut"></a><br>  Generally speaking, I do not think that defensive programming is <i>worse</i> or <i>better than</i> another approach.  As usual, various factors influence the solution of a problem, so the short answer will be this: <i>it all depends on the circumstances.</i> <br>  Such an answer is certainly useless as long as we cannot answer the question: <i>from what circumstances does this dependence arise?</i>  In this article, I will consider some factors.  However, I am not going to state that this article is a comprehensive statement of the topic. <br><br><h5>  Letting the code fall. </h5><br>  What is the value of defensive programming, if all you are going to do is to immediately throw an exception?  Wouldn't it be a good decision to just let the code fall?  Let's look at sample code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductDetailsController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IUserRepository userRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IProductRepository productRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICurrencyExchange exchange; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductDetailsController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IUserRepository userRepository, IProductRepository productRepository, ICurrencyExchange exchange</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository = userRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository = productRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange = exchange; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ProductDetailsViewModel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProductDetails</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository.Get(userId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetCurrency = user.PreferredCurrency; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> product = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository.Get(productId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> convertedPrice = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange.Convert(product.UnitPrice, targetCurrency); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductDetailsViewModel { Name = product.Name, Price = convertedPrice.ToString() }; } }</code> </pre> <br>  In this simple <code>ProductDetailsController</code> class, the <code>GetProductDetails</code> method creates an instance of <code>ProductDetailsViewModel</code> , getting user and product information through repository injections, converting the price of the product into the user's preferred currency and returning the product data that is supposed to be displayed on the screen.  In order to achieve the goal of the article, let's concentrate only on the problems of checking for <code>null</code> .  How many calls can go through a <code>GetProductDetails</code> script in the <code>GetProductDetails</code> method?  How many objects can be null links? <br>  Quite a lot, as it turns out.  Even separated from its dependencies, this small piece of code can throw a <code>NullReferenceException</code> , at least in six cases.  Imagine that you get an error report from your in-use system.  The stack trace indicates the <code>GetProductDetails</code> method and the type of exception thrown is <code>NullReferenceException</code> .  Which of the six possible objects with a zero reference caused an error? <br>  Letting the system simply fall, it will be difficult for us to answer this question.  And do not forget that this is just a learning example.  Most of the code I‚Äôve exploited had more than 5 or 6 lines of code, so finding out the cause of the error could quickly become something like a needle search in a haystack. <br>  Just letting the code fall is not very useful.  Obviously, if you write very short methods (a practice that I strongly recommend), the problem that arises is not so urgent, but the longer your methods are, the less professional, in my opinion, the phrase ‚Äújust let the code fall‚Äù sounds. <br><br><h5>  Protective rescue programming? </h5><br>  By adding explicit gatekeys to <code>null</code> , you can throw out more descriptive error messages: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductDetailsController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IUserRepository userRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IProductRepository productRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICurrencyExchange exchange; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductDetailsController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IUserRepository userRepository, IProductRepository productRepository, ICurrencyExchange exchange</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userRepository == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"userRepository"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (productRepository == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"productRepository"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exchange == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"exchange"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository = userRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository = productRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange = exchange; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ProductDetailsViewModel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProductDetails</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository.Get(userId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"User was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetCurrency = user.PreferredCurrency; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> product = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository.Get(productId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (product == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Product was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> convertedPrice = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange.Convert(product.UnitPrice, targetCurrency); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (convertedPrice == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Converted price was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductDetailsViewModel { Name = product.Name, Price = convertedPrice.ToString() }; } }</code> </pre><br>  Is this code better?  In terms of analyzing the causes of errors, yes.  In this version of the code, if you receive an error message from your operating system, the message in the exception will tell you which of the six possible situations with the <code>null</code> link your program encountered.  If I were in support mode, I would know which version of the two presented I would prefer. <br>  However, in terms of readability, everything has greatly deteriorated.  The <code>GetProductDetails</code> method <code>GetProductDetails</code> extended from five to eleven lines of code.  Security programming has more than doubled the number of lines!  Passing through the body of the method is drowning in protective structures, so the method has become worse read.  If you are a typical programmer, then you read the code significantly more than you write it, so the practice that makes your code more difficult to read should make you feel plowed.  There is no doubt that many programmers consider defensive programming a bad practice. <br><br><h5>  Sustainability. </h5><br>  Is it possible to balance the factors influencing the problem and its solution?  Yes, it is possible, but in order to understand how, you must understand the root cause of the problem.  The initial code sample is not particularly complicated, but even so, there are many cases in which this code fails.  As for null references, the reason is a <a href="http://en.wikipedia.org/wiki/Tony_Hoare">mistake in the design of the language</a> , but in general, the question is whether you can trust the input data or not.  Returning values ‚Äã‚Äãvia a call to <code>IUserRepository.Get</code> this <a href="http://xunitpatterns.com/indirect%2520input.html">(indirectly) is also input.</a> <br>  Depending on the environment in which your program operates, you either have the opportunity to trust the input data, or you do not have such an opportunity.  Imagine, for a moment, the situation in which your software is operated in the <a href="http://blog.ploeh.dk/2012/12/18/RangersandZookeepers/">"wilderness</a> . <a href="http://blog.ploeh.dk/2012/12/18/RangersandZookeepers/">"</a>  Your software can be a reusable library or framework.  In this case, you can‚Äôt trust the input at all.  If this is the case, then you may want to apply the <a href="http://en.wikipedia.org/wiki/Robustness_principle">principle of stability</a> and remain convinced that you are acting in a protective style not only with respect to the input, but also the output.  In other words, you do not want to pass null references (or other devilish values) to another interacting code. <br>  The sample code given earlier may pass null links to its dependencies, for example, if <code>userId = null,</code> or (more sophisticated), if <code>user.PreferredCurrency = null.</code>  Thus, following the principle of sustainability, you would have to add even more protective expressions: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductDetailsController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IUserRepository userRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IProductRepository productRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICurrencyExchange exchange; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductDetailsController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IUserRepository userRepository, IProductRepository productRepository, ICurrencyExchange exchange</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userRepository == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"userRepository"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (productRepository == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"productRepository"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exchange == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"exchange"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository = userRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository = productRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange = exchange; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ProductDetailsViewModel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProductDetails</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"userId"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (productId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"productId"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository.Get(userId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"User was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.PreferredCurrency == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Preferred currency was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetCurrency = user.PreferredCurrency; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> product = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository.Get(productId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (product == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Product was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (product.Name == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Product name was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (product.UnitPrice == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Unit price was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> convertedPrice = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange.Convert(product.UnitPrice, targetCurrency); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (convertedPrice == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Converted price was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductDetailsViewModel { Name = product.Name, Price = convertedPrice.ToString() }; } }</code> </pre><br>  This obviously looks even more awful than the previous example using the defensive style.  Now you are protecting not only yourself, but also interacting code.  Commendable, but completely unreadable. <br>  Until now, when I write code that lives in the "wilderness", such defensive programming is exactly what I do, although I still tend to refactor in such a way that, first, I would collect and I checked all the input data and then I would transfer this data to another class that implements all the logic. <br><br><h5>  Protected area. </h5><br>  What if your code lives in a <a href="http://blog.ploeh.dk/2012/12/18/RangersandZookeepers/">protected area</a> ?  What if your code works in an environment, all interacting code is part of the same code base written by you and your colleagues?  If you can trust each other by following certain sequential rules, you can omit most of the protective structures. <br>  In most of the teams in which I worked, I always assumed that we use the principle of sustainability.  In practice, this means that <code>null</code> never a valid return value.  If the class member returns <code>null</code> , then the bug is in this class, not in the consumer of this class.  Taking into account the following of this rule, the previous code can be shortened to this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductDetailsController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IUserRepository userRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IProductRepository productRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICurrencyExchange exchange; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductDetailsController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IUserRepository userRepository, IProductRepository productRepository, ICurrencyExchange exchange</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userRepository == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"userRepository"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (productRepository == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"productRepository"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exchange == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"exchange"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository = userRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository = productRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange = exchange; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ProductDetailsViewModel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProductDetails</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"userId"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (productId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"productId"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository.Get(userId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.PreferredCurrency == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Preferred currency was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetCurrency = user.PreferredCurrency; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> product = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository.Get(productId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (product.Name == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Product name was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (product.UnitPrice == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Unit price was null."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> convertedPrice = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange.Convert(product.UnitPrice, targetCurrency); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductDetailsViewModel { Name = product.Name, Price = convertedPrice.ToString() }; } }</code> </pre><br>  This is better, but still not good enough ... but wait: the properties for reading are also returned values, so we can not check them either: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductDetailsController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IUserRepository userRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IProductRepository productRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICurrencyExchange exchange; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductDetailsController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IUserRepository userRepository, IProductRepository productRepository, ICurrencyExchange exchange</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userRepository == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"userRepository"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (productRepository == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"productRepository"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (exchange == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"exchange"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository = userRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository = productRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange = exchange; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ProductDetailsViewModel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProductDetails</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"userId"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (productId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"productId"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository.Get(userId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetCurrency = user.PreferredCurrency; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> product = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productRepository.Get(productId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> convertedPrice = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange.Convert(product.UnitPrice, targetCurrency); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductDetailsViewModel { Name = product.Name, Price = convertedPrice.ToString() }; } }</code> </pre><br>  Now it's quite good, since now we are almost back to the original state of the code.  The only difference is the presence of the <a href="http://c2.com/cgi/wiki%3FGuardClause">gatehouse</a> at the very beginning of each member.  When you follow the principle of sustainability, most of the members begin to look about the same.  A little later, after you get used to it, you stop noticing them.  I consider them a preamble for each member.  As a reader of the code, you can skip the gatelines and concentrate on the flow of logic, without interrupting you security checks that interfere with the reading of the code. <br><br><h5>  Encapsulation. </h5><br>  If returning a <code>null</code> link is an error, then how can the <code>User</code> class or the <code>Product</code> class follow the sustainability principle?  In the same way: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> preferredCurrency; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.preferredCurrency = <span class="hljs-string"><span class="hljs-string">"DKK"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PreferredCurrency { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.preferredCurrency; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"value"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.preferredCurrency = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } }</code> </pre><br>  Notice how the <code>User</code> class <a href="http://blog.ploeh.dk/2011/05/26/CodeSmellAutomaticProperty/">protects its invariants</a> .  The <code>PreferredCurrency</code> property can never be <code>null</code> .  This principle is also known by another name: <a href="http://blog.ploeh.dk/2011/05/24/Poka-yokeDesignFromSmelltoFragrance/">encapsulation</a> . <br><br><h5>  Conclusion </h5><br>  As always, understanding the factors underlying the problem or understanding your codebase helps.  You should write significantly more defensive constructions in case your code lives in the ‚Äúwilderness‚Äù than when it lives in a protected environment.  To this day, I consider it a delusion to believe that you can get away with writing a sloppy code;  we must all be <a href="http://blog.ploeh.dk/2012/12/18/ZookeepersmustbecomeRangers/">rangers programmers.</a> <br>  A structureless security code harms readability.  The security code is just another excuse for writing spaghetti code.  In contrast, structured defensive programming is encapsulation.  I know what I prefer. </div><p>Source: <a href="https://habr.com/ru/post/191548/">https://habr.com/ru/post/191548/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191536/index.html">Selecting reports in the UX section on # 404fest</a></li>
<li><a href="../191540/index.html">Germany generated 5.1 TWh of solar energy per month</a></li>
<li><a href="../191542/index.html">About NFC, SMS Payments and the Future</a></li>
<li><a href="../191544/index.html">Ministry of Communications will shake up the operators market</a></li>
<li><a href="../191546/index.html">E-government, hands off my sites</a></li>
<li><a href="../191552/index.html">The Division - a full game on all platforms, from PC to Android</a></li>
<li><a href="../191554/index.html">We measure the quality of search in the Mail</a></li>
<li><a href="../191558/index.html">Testing 10 Gb / s servers in the Netherlands, now servers are available in the US! From $ 2999 / month!</a></li>
<li><a href="../191560/index.html">Extortionist Win32 / Nymaim - Obfuscation Chronicles</a></li>
<li><a href="../191564/index.html">Planning horizon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>