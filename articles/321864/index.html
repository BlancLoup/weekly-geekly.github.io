<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenResty: we turn NGINX into a full-fledged application server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We again publish the transcript of the report from the HighLoad ++ 2016 conference, which was held in Skolkovo near Moscow on November 7‚Äî8 last year. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenResty: we turn NGINX into a full-fledged application server</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/594/12e/54c/59412e54c5234d478c1d6a1c65981ddf.jpg" align="left" width="400">  <em>We again publish the transcript of the report from the <a href="http://www.highload.ru/">HighLoad ++</a> 2016 conference, which was held in Skolkovo near Moscow on November 7‚Äî8 last year.</em>  <em><a href="https://habrahabr.ru/post/315726/">Vladimir Protasov</a> tells how to extend the functionality of NGINX using OpenResty and Lua.</em> <br><br>  Hello everyone, my name is Vladimir Protasov, I work in Parallels.  I'll tell you a little about myself.  Three quarters of my life I write code.  I became a programmer to the core in the literal sense: I sometimes see code in my dreams.  A quarter of life - industrial development, writing code that goes straight into production.  The code that some of you use, but do not know about it. <br><br>  So that you understand how bad everything was.  When I was a little junior, I came, and they gave me such a double-byte database.  It is now here at all highload.  I went to the conference, asked: ‚ÄúGuys, tell me, do you have big data, is everything cool?  How many bases do you have there? ‚ÄùThey answered me:‚Äú We have 100 gigabytes! ‚ÄùI said:‚Äú Cool, 100 gigabytes! ‚ÄùAnd I thought to myself how to keep the poker interface neatly.  You think, yes, guys are cool, and then you come back and pick around with these multi-terabyte databases.  And this is being a junior.  Imagine what a blow it is? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I know more than 20 programming languages.  This is what I had to figure out in the process of work.  You get code on Erlang, C, C ++, Lua, Python, Ruby, something else, and you need to cut it all.  In general, I had to.  The exact number could not be calculated, but somewhere in the 20 the number was lost. <br><a name="habracut"></a><br>  Since everyone present knows what Parallels is and what we do, I will not talk about how cool we are and what we do.  I will tell you only that we have 13 offices around the world, more than 300 employees, development in Moscow, Tallinn and Malta.  If you wish, you can take and move to Malta if it is cold in winter and you need to warm the backrest. <br><br>  Specifically, our department writes in Python 2. We are engaged in business and we have no time to introduce modern technologies, so we suffer.  We have Django, because everything is in it, and we took the excess and threw it out.  Also MySQL, Redis and NGINX.  We also have a lot of other cool stuff.  We have MongoDB, we have bunnies running, we have nothing, but this is not mine, and I don‚Äôt do it. <br><br><h1>  Openresty </h1><br>  I told about myself.  Let's see what I'm talking about today: <br><br><ul><li>  What is OpenResty and what is it eaten with? </li><li>  Why invent another bike when we have Python, NodeJS, PHP, Go and other cool stuff that everyone is happy with? </li><li>  And a few examples from life.  I had to cut down the report, because I got it for 3.5 hours, so there will be few examples. </li></ul><br>  OpenResty is NGINX.  Thanks to him, we have a full-fledged web server, which is written well, it works quickly.  I think most of us use NGINX in production.  You all know that he is fast and cool.  It made cool synchronous I / O, so we don‚Äôt need to do anything, just like in Python we did a bicycle or gevent.  Gevent is cool, awesome, but if you write a shared code and something goes wrong there, then you will go crazy with this gevent.  I had experience: it took two whole days to figure out what went wrong there.  If someone had not rummaged for several weeks before, had not found the problem, had not written on the Internet, and Google would not have found it, then we would have gone astray. <br><br>  NGINX already has caching and static content.  You do not need to bathe, how to do it humanly, so that you have somewhere not slowed down, so that you do not lose your descriptors somewhere.  Nginx is very convenient to deploy, you do not need to think about what to take - WSGI, PHP-FPM, Gunicorn, Unicorn.  Nginx set, admin given, they know how to work with it.  Nginx processes requests in a structured way.  I'll talk about this a little bit later.  In short, he has a phase when he only accepted the request, when he processed and when he gave the content to the user. <br><br>  Nginx is cool, but there is one problem: it is not flexible enough, even with all those cool chips that the guys crammed into the config, despite what you can configure.  This power is not enough.  Therefore, the guys from Taobao once, a long time ago, it seems, about eight years ago, they built Lua there.  What does he give? <br><br><ul><li>  <strong>Size</strong>  It is small.  LuaJIT gives somewhere 100-200 kilobytes of overhead memory and minimum overhead performance. </li><li>  <strong>Speed</strong>  The LuaJIT interpreter is close to C in many situations, in some situations it loses Java, in some it overtakes it.  For a while, he was considered the state of art, the coolest JIT compiler.  Now there are more cool, but they are very heavy, for example, the same V8.  Some JS interpreters and Java HotSpot are faster at some points, but still lose at some places. </li><li>  <strong>Easy to learn</strong> .  If you have, say, a Perl codebase, and you are not Booking, you will not find pearl barrels.  Because they are not there, they were all taken away, but teaching them is long and difficult.  If you want programmers on something else, you may have to retrain them too, or find them.  In the case of Lua, everything is simple.  Lua learns any junior for three days.  It took me about two hours to figure it out.  Two hours later, I already wrote the code in production.  Somewhere in a week, he went straight into production and left. </li></ul><br>  As a result, it looks like this: <br><br><img src="https://habrastorage.org/files/c69/e55/e9d/c69e55e9d0b446e8b2c91d62ad1b26dc.png"><br><br>  There are a lot of things.  In OpenResty, they collected a bunch of modules, both Luash and Engin.  And everything is ready for you - it works well. <br><br><h1>  Examples </h1><br>  Enough lyrics, go to the code.  Here is a little Hello World: <br><br><img src="https://habrastorage.org/files/7e3/a01/b77/7e3a01b770fe4ab0856c019d64987c5e.png"><br><br>  What is there?  this is an angling location.  We are not steaming, do not write our routing, do not take some ready - we already have in NGINX, we live well and lazily. <br><br>  <code>content_by_lua_block</code> is a block that says that we are giving content using a Lua script.  Take the variable <code>remote_addr</code> and <code>string.format</code> it in <code>string.format</code> .  This is the same as <code>sprintf</code> , only on Lua, only correct.  And we give to the client. <br><br>  As a result, it will look like this: <br><br><img src="https://habrastorage.org/files/eaf/a28/698/eafa2869865746588a93b554b09d8510.png"><br><br>  But back in the real world.  In production, no one deploit Hello World.  Our application usually goes to the database or somewhere else and most of the time is waiting for a response. <br><br><img src="https://habrastorage.org/files/b18/d81/a3c/b18d81a3c2d747de9714cef2fdca556d.jpg"><br><br>  Just sitting and waiting.  It's not very good.  When 100.000 users arrive, it is very hard for us.  Therefore, as an example, let's assign a simple application.  We will look for pictures, for example, cats.  Only we will not search just like that, we will expand the keywords and, if the user has searched for ‚Äúkittens‚Äù, we will find cats, fluffies and so on.  First we need to get the request data on the backend.  It looks like this: <br><br><img src="https://habrastorage.org/files/52a/905/641/52a9056413f94eb7b26bd1d8c42bf3d3.png"><br><br>  Two lines allow you to take GET parameters, no difficulty.  Then, let's say, from the database with a label for the keyword and extension, we receive this information using a normal SQL query.  It's simple.  It looks like this: <br><br><img src="https://habrastorage.org/files/d9c/a25/ee5/d9ca25ee5f1e46dab71b69ff80a5e195.png"><br><br>  We connect the <code>resty.mysql</code> library, which we already have in the kit.  We do not need to put anything, everything is ready.  Specify how to connect, and make a SQL query: <br><br><img src="https://habrastorage.org/files/27c/696/9b3/27c6969b3e704fcf9ccc0426184f6d3b.png"><br><br>  It's a little scary here, but it works.  Here 10 is the limit.  We pull out 10 records, we are lazy, we don‚Äôt want to show anymore.  In SQL, I forgot about the limit. <br><br>  Next we find pictures for all requests.  We collect a batch of requests and fill in a Lua table called <code>reqs</code> , and we do <code>ngx.location.capture_multi</code> . <br><br><img src="https://habrastorage.org/files/69c/c39/892/69cc3989288c47c59f5d856ad24bfba1.png"><br><br>  All these requests go in parallel, and we return the answers.  The running time is equal to the slowest response time.  If we all shoot back in 50 milliseconds, and we sent a hundred requests, then the answer will come in 50 milliseconds. <br><br>  Since we are lazy and do not want to write HTTP processing and caching, we will force NGINX to do everything for us.  As you saw, there was a <code>url/fetch</code> request, here it is: <br><br><img src="https://habrastorage.org/files/50f/4e0/4bb/50f4e04bb0654336be714b62c8a83e52.png"><br><br>  We make a simple <code>proxy_pass</code> , specify where to cache, how to do it, and everything works for us. <br><br>  But this is not enough, we still need to give the data to the user.  The simplest idea is to serialize everything in JSON, easily, in two lines.  We give Content-Type, we give JSON. <br><br>  But there is one difficulty: the user does not want to read JSON.  It is necessary to attract front-tenders.  Sometimes we don't want to do this at first.  Yes, and SEOs will say that if we are looking for pictures, they do not care.  And if we give them some content, they will say that our search engines do not index anything. <br><br>  What to do with it?  Of course, we will give the user HTML.  To generate handles - not comme il faut, therefore we want to use templates.  For this there is a library <code>lua-resty-template</code> . <br><br><img src="https://habrastorage.org/files/fec/7e0/0a7/fec7e00a7714430ca53fcb01cf48282d.png"><br><br>  You probably saw three scary letters OPM.  OpenResty comes with its package manager, through which you can put a bunch of different modules, in particular, <code>lua-resty-template</code> .  This is a simple template engine, close to Django templates.  There you can write code and substitute variables. <br><br>  As a result, everything will look something like this: <br><br><img src="https://habrastorage.org/files/1f0/5da/fdb/1f05dafdbeec4958a53d4587d07b150e.jpg"><br><br>  We took the data and rendered the template again in two lines.  User is happy, got seals.  As we expanded the request, he also received a fur seal for kittens.  Who knows, maybe he was looking for him, but he could not formulate his request correctly. <br><br>  Everything is cool, but we are in development, and so far we don‚Äôt want to show users.  Let's do the authorization.  To do this, let's look at how NGINX processes the request in terms of OpenResty: <br><br><ul><li>  The first phase is <strong>access</strong> , when the user just arrived, and we looked at it by headlines, by IP address, by other data.  You can immediately cut it off if we did not like it.  This can be used for authorization, or if a lot of requests come to us, we can easily chop them up in this phase. </li><li>  <strong>rewrite</strong> .  We rewrite some query data. </li><li>  <strong>content</strong> .  We give content to the user. </li><li>  <strong>headers filter</strong> .  Substitute response headers.  If we used <code>proxy_pass</code> , we can rewrite some headers before giving to the user. </li><li>  <strong>body filter</strong> .  We can replace the body. </li><li>  <strong>log</strong> - logging.  You can write logs in elasticsearch without an additional layer. </li></ul><br>  Our authorization will look something like this: <br><br><img src="https://habrastorage.org/files/50d/209/35f/50d20935f5c5409d956e442d5e9703a7.png"><br><br>  We‚Äôll add this to the <code>location</code> we‚Äôve described before, and stick this code in there: <br><br><img src="https://habrastorage.org/files/7af/761/a4e/7af761a4ef3c4a5cb60fdbadd7315d9d.png"><br><br>  We see if we have a cookie token.  If not, then throw the authorization.  Users are tricky and can guess that you need to put a cookie token.  Therefore, we still put it in Redis: <br><br><img src="https://habrastorage.org/files/0bf/100/cad/0bf100cad2014e7b8f5af570417c1fe9.png"><br><br>  The code for working with Redis is very simple and is no different from other languages.  In this case, all the input / output that there, that here, it is not blocking.  If you are writing synchronous code, it works asynchronously.  Just like with gevent, just done well. <br><br><img src="https://habrastorage.org/files/7e7/43f/c36/7e743fc36cdc46a5a2e010937ea44567.png"><br><br>  Let's do the authorization itself: <br><br><img src="https://habrastorage.org/files/cd0/d78/9d8/cd0d789d873841cbb6740cda9f76acc2.png"><br><br>  We say that we need to read the request body.  We get POST-arguments, check that the login and password are correct.  If wrong, then throw the authorization.  And if correct, then write the token to Redis: <br><br><img src="https://habrastorage.org/files/992/b4a/4a4/992b4a4a4a0c41378ba7e87c4dfd76da.png"><br><br>  Do not forget to put a cookie, this is also done in two lines: <br><br><img src="https://habrastorage.org/files/2a0/bbe/1f0/2a0bbe1f00724535ad91cc74d8f7473e.png"><br><br>  An example is simple, speculative.  We certainly will not do a service that shows people seals.  Although who knows us.  So let's go over what can be done in production. <br><br><ul><li>  <strong>Minimalistic backend</strong> .  Sometimes we need to give quite a bit of data into the backend: somewhere we need to substitute a date, somewhere we need to output some list, say how many users are on the site now, fasten a counter or statistics.  Something so small.  Minimal any pieces can be made very easily.  This will be quick, easy and great. <br><br></li><li>  <strong>Preprocessing data</strong> .  Sometimes we want to embed advertising on our page, and we take this ad by API-requests.  This is very easy to do right here.  We do not load our backend, which already works hard.  You can take and collect here.  We can blind some JS or, on the contrary, unplug, preprocess something before giving it to the user. <br><br></li><li>  <strong>Facade for microservice</strong> .  This is also a very good case, I implemented it.  Before that, I worked at Tenzor, which deals with electronic reporting, which provides reporting for about half of the legal entities in the country.  We have made a service, many things have been done there using the same mechanism: routing, authorization, and more. <br>  OpenResty can be used as glue for your microservices, which will provide a single access to everything and a single interface.  Since microservices can be written in such a way that here you have Node.js, here you have PHP, here is Python, there is some kind of thing on Erlang, we understand that we don‚Äôt want to rewrite the same code everywhere.  Therefore, OpenResty can stick to the front. <br><br></li><li>  <strong>Statistics and analytics</strong> .  Usually NGINX is at the entrance, and all requests go through it.  It is in this place very convenient to assemble.  You can immediately calculate something and throw somewhere, for example, the same Elasticsearch, Logstash, or simply write to the log and then send it somewhere. <br><br></li><li>  <strong>Multi-user systems</strong> .  For example, online games are also very good to do.  Today in Cape Town, Alexander Gladysh will talk about how to quickly prototype a multiplayer game using OpenResty. <br><br></li><li>  <strong>Request Filtering (WAF)</strong> .  Now it is fashionable to do all sorts of web application firewall, there are many services that provide them.  With the help of OpenResty, you can make yourself a web application firewall, which will simply and easily filter requests according to your requirements.  If you have Python, then you understand that PHP will definitely don‚Äôt get you right, unless of course you‚Äôre using it from the console.  You know that you have MySQL and Python.  Probably, some directory traversal may try to do something and boot into the database.  Therefore, you can filter dumb requests quickly and cheaply right at the front. <br><br></li><li>  <strong>Community.</strong>  Since OpenResty is built on the basis of NGINX, it has a bonus - this is the <strong>NGINX community</strong> .  It is very large, and a decent part of the questions that you will have at first is already solved by the NGINX community. <br><br>  <strong>Lua-developers</strong> .  Yesterday I talked to the guys who came on the HighLoad ++ school day and heard that only Tarantool was written in Lua.  This is not true, a lot of things are written on Lua.  Examples: OpenResty, XMPP-server Prosody, game engine Love2D, Lua is scripted in Warcraft and in other places.  There are a lot of Lua-developers, they have a large and responsive community.  All my questions on Lua were resolved within a few hours.  When you write to the mailing list, literally in a few minutes already a bunch of answers, paint what and how, what's what.  It's great.  Unfortunately, not everywhere is such a good spiritual community. <br>  According to OpenResty there is a GitHub, there you can get an issue if something is broken.  There is a mailing list on Google Groups, where you can discuss general issues, there is a newsletter in Chinese - you never know, maybe you don‚Äôt speak English, but you know Chinese. </li></ul><br><h1>  Results </h1><br><ul><li>  I hope I was able to convey that OpenResty is a very convenient framework, sharpened by the web. </li><li>  It has a low entry threshold, since the code is similar to what we are writing, the language is quite simple and minimalist. </li><li>  It provides asynchronous I / O without callbacks, we will have no noodles, as we can sometimes write in NodeJS. </li><li>  It has easy deployment, since we only need NGINX with the necessary module and our code, and everything works right away. </li><li>  Large and responsive community. </li></ul><br>  I did not tell in details how the routing is done, it was a very long story. <br><br>  Thanks for attention! <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/silrEB0Brvo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <em><a href="http://www.highload.ru/2016/abstracts/2432.html">Vladimir Protasov - OpenResty: Turning NGINX into a Full-fledged Application Server</a></em> </div><p>Source: <a href="https://habr.com/ru/post/321864/">https://habr.com/ru/post/321864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321852/index.html">The practice of collecting customer feedback is a bad thing.</a></li>
<li><a href="../321856/index.html">New GC Epsilon. Java may not have garbage collection. Shock. Sensation</a></li>
<li><a href="../321858/index.html">Climate change and data center: good enough</a></li>
<li><a href="../321860/index.html">How the experience of creating bits can help you understand HTML and CSS</a></li>
<li><a href="../321862/index.html">Distracted about input / output arguments</a></li>
<li><a href="../321868/index.html">Exceptions in Windows x64. How it works. Part 1</a></li>
<li><a href="../321870/index.html">"Neuromorphic chips": a different look at machine learning</a></li>
<li><a href="../321872/index.html">GameDev from scratch: From the hackathon to your own game development studio. Part 1</a></li>
<li><a href="../321874/index.html">Noise functions and map generation</a></li>
<li><a href="../321876/index.html">Terminal Server User Authentication on FirePOWER</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>