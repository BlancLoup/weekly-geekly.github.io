<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bandwidth limitation by time of day using ipfw</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article describes how to change the speed of users under NAT, according to the time of day using the scheduler daemon. 

 The FreeBSD 8.1 system ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bandwidth limitation by time of day using ipfw</h1><div class="post__text post__text-html js-mediator-article"> This article describes how to change the speed of users under NAT, according to the time of day using the scheduler daemon. <br><br>  The FreeBSD 8.1 system is used, but this option for changing the speed is also available on all other versions where <a href="http://ru.wikipedia.org/wiki/Ipfw">ipfw</a> and <a href="http://ru.wikipedia.org/wiki/Cron">cron</a> exist, which means on almost all FreeBSD branches and releases. <a name="habracut"></a><br><br>  I will not discuss how to compile the kernel in detail, I will only say that it should contain the following instructions activating the use of the firewall and the DUMMYNET shaper: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>options IPFIREWALL <br> options IPFIREWALL_VERBOSE <br> options IPFIREWALL_VERBOSE_LIMIT=50 <br> options IPFIREWALL_FORWARD <br> options IPFIREWALL_DEFAULT_TO_ACCEPT <br> options IPDIVERT <br> options DUMMYNET <br> options HZ=1000</code> <br> <br>  There are many ways to change the speed over time, but I will describe only 2 that I use myself.  They are not perfect, but for a local network of 10-20 people, without a white external IP address and with a total bandwidth of 20 Mbps, the channel will work fine. <br><br><h5>  <b>So the first way</b> </h5><br>  Here we use the method of replacing the working config with cron. <br>  So suppose we have 2 files for different time periods: <br>  <b>firewall.conf-01-09</b> - firewall for the time from 01:00 to 09:00 <br>  <b>firewall.conf-09-01</b> - firewall for the time from 09:00 to 01:00 <br>  from 01:00 to 09:00, we will give users high speed, and at all other times, it is from 09:00 to 01:00, the declared speed. <br><br>  We put these 2 files in for example in / home / admin / firewall. <br>  Next, we create the sh script, just in case, which will lower and raise all the interfaces through which ipfw works, and do / etc / netstart (this can not be done, but you can immediately execute the firewall script, but personally for me and for some there were all kinds of unusual errors, no buffer space available, etc., which was solved by a simple / etc / netstart).  It will look like this in the script: <br><br> <code>#!/bin/sh <br> cp /home/admin/firewall/firewall.conf-01-09 /etc/firewall.conf <br> sh /etc/firewall.conf <br> <br> ifconfig rl0 down <br> ifconfig rl1 down <br> <br> ifconfig rl0 up <br> ifconfig rl1 up <br> /etc/netstart</code> <br> <br>  Save this script with the name firesh-01-09.sh, make a similar script for daytime from 09:00 to 01:00 and finally open cron (/ etc / crontab) in which we write what, when and from what user run: <br><br> <code>SHELL=/bin/sh <br> PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin <br> <br> #minute hour mday month wday who command <br> # Firewalls <br> 0 1 * * * root sh /home/admin/firewall/firesh-01-09.sh <br> 0 9 * * * root sh /home/admin/firewall/firesh-09-01.sh</code> <br> <br>  Now at 01:00 and at 09:00 your rules will be copied to /etc/firewall.conf, new interfaces will be re-read and interfaces re-elevated. <br><br><h5>  <b>Second way</b> </h5><br>  This method is certainly much simpler, <s>but somehow I didn‚Äôt get accustomed to it very well,</s> but I love the good old proven and therefore use the first method. <br><br>  The second method consists of a simple sh script, in which a specific pipe is given a speed, and then re-read by time, it looks like this: <br><br> <code># Day firewall, 09:00 - 01:00 <br> <br> # Admins <br> ipfw pipe 230 config bw 0Mbit/s <br> ipfw pipe 130 config bw 0Mbit/s <br> <br> # Users <br> ipfw pipe 107 config bw 5Mbit/s <br> ipfw add pipe 1107 ip from 192.168.0.107 to any out <br> ipfw pipe 1107 config bw 5Mbit/s <br> <br> # VPN Users <br> ipfw pipe 246 config bw 1Mbit/s <br> <br> ipfw pipe 128 config bw 5Mbit/s <br> ipfw add pipe 1128 ip from 192.168.0.128 to any out <br> ipfw pipe 1128 config bw 5Mbit/s <br> <br> ipfw pipe 102 config bw 0Mbit/s <br> <br> # Test users <br> ipfw pipe 35 config bw 0Mbit/s <br> ipfw pipe 36 config bw 0Mbit/s <br> ipfw pipe 37 config bw 0Mbit/s <br> ipfw pipe 38 config bw 0Mbit/s <br> <br> ifconfig rl0 down <br> ifconfig rl1 down <br> <br> ifconfig rl0 up <br> ifconfig rl1 up</code> <br> <br>  The actual procedure for running the config in time from cron remains the same as in the first method, only the / etc / netstart command is not allowed here, since we are working with one config file firewall.conf, which is already loaded into memory, and using this command will be read again config from /etc/firewall.conf, in which you have described the standard rules. <br><br>  <a href="http://www.lissyara.su/articles/freebsd/tuning/dummynet/">Information for DUMMYNET</a> <br>  <a href="http://sys.dmitrow.com/node/28">Manual on how to compile the kernel</a> <br>  <a href="http://ru.wikipedia.org/wiki/Ipfw">IPFW</a> <br>  <a href="http://ipfw.ism.kiev.ua/dummynet.html">Detailed manual for DUMMYNET</a> </div><p>Source: <a href="https://habr.com/ru/post/129439/">https://habr.com/ru/post/129439/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129428/index.html">Development details for GPUs in Visual Studio and C ++ AMP</a></li>
<li><a href="../129430/index.html">Using PromoDJ for Equity</a></li>
<li><a href="../129431/index.html">Presented budget smartphone HTC Explorer</a></li>
<li><a href="../129434/index.html">Hacby'11 web & mobile October 8-9, 2011 in Minsk</a></li>
<li><a href="../129437/index.html">The Foundry Nuke. Introduction</a></li>
<li><a href="../129440/index.html">Mail.Ru Agent + ICQ = interoperability</a></li>
<li><a href="../129441/index.html">Bootstrap Fund launched - a new type of incubator / fund / business club</a></li>
<li><a href="../129442/index.html">New version of ABBYY TextGrabber: two in one</a></li>
<li><a href="../129443/index.html">The secrets of numerology in the invitation of Apple</a></li>
<li><a href="../129445/index.html">FreeRTOS: mutexes and critical sections</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>