<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ExpvarMon - console monitoring of services on Go</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For Go-programs, there is a convenient standard expvar package, allowing one line to connect the output of debag information in JSON format. And in or...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ExpvarMon - console monitoring of services on Go</h1><div class="post__text post__text-html js-mediator-article">  For Go-programs, there is a convenient standard <a href="http://golang.org/pkg/expvar/">expvar</a> package, allowing one line to connect the output of debag information in JSON format.  And in order to monitor the current state as quickly and clearly as possible, the Expvarmon console program was written, requiring a minimum of configuration for displaying metrics and debugging information for your Go-services. <br><br>  Functions: <br><ul><li>  single- and multi-services modes </li><li>  monitoring local and remote programs </li><li>  arbitrary number of services and variables </li><li>  support for memory, time intervals, bool and arbitrary numbers / strings </li><li>  sparkline graphics </li><li>  display of maximum values </li><li>  display fallen / restarted services </li><li>  auto-resize when changing font or window sizes </li></ul><br><br><img src="https://habrastorage.org/files/31b/b20/fdd/31bb20fddf734c2b9bf6e1959339b0b8.png"><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Introduction </h4><br>  In the standard Go library there is a very useful package <a href="http://golang.org/pkg/expvar/">expvar</a> , which allows you to add a single output line of debug information in json-format to the address / debug / vars.  By default, memory usage and garbage collector (GC) data are displayed, and any of their own metrics / counters / variables are easily added.  Usually, this data is collected by a separate process, which puts into some time-series database, and then it turns into convenient and beautiful dashboards. <br><br>  But often, even during development or debugging sessions, you just want to monitor the status of the program, be sure that resources are used adequately to the load, there are no memory leaks or gorutin, and so on.  Raising a whole monitoring infrastructure for this is often costly and unreasonable, and raw json is not very presentable. <br><br>  For such cases, a program was written over the weekend for monitoring expvar variables right in the terminal, which requires almost zero configuration and does not use any third-party databases and resources.  The program uses the excellent <a href="https://github.com/gizak/termui">TermUI</a> package from the terminal <a href="http://gizak.github.io/">gizak lover</a> (see its <a href="http://gizak.github.io/">homepage</a> !). <br><br><h4>  Installation </h4><br>  Installing a program like any other program on Go is extremely simple: <br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get github.com/divan/expvarmon</code> </pre> <br>  I hope you have $ GOPATH / bin registered in $ PATH. <br><br><h4>  Using </h4><br><h5>  expvar </h5><br><h6>  Short explanation </h6><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-string"><span class="hljs-string">"expvar"</span></span></code> </pre> <br><h6>  Long explanation </h6><br>  If you are not familiar with the <a href="http://golang.org/pkg/expvar/">expvar</a> package, then a brief explanation and instruction. <br>  The <a href="">init ()</a> function of this package says the following: <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/debug/vars"</span></span>, expvarHandler) Publish(<span class="hljs-string"><span class="hljs-string">"cmdline"</span></span>, Func(cmdline)) Publish(<span class="hljs-string"><span class="hljs-string">"memstats"</span></span>, Func(memstats)) }</code> </pre> <br>  The first line registers the handler for handling the URL "/ debug / vars" for the standard http.DefaultServeMux from the standard net / http package.  If you don‚Äôt know how net / http works, this may be a separate article, but now you only need to know that if your program starts a standard http-server (say, <i>http.ListenAndServe (": 1234", nil)</i> ), then it will automatically have a GET request handler at / debug / vars.  And the response of this request will by default contain approximately the following JSON: <br><pre> <code class="bash hljs">$ curl -s http://localhost:1234/debug/vars | json_pp | head { <span class="hljs-string"><span class="hljs-string">"cmdline"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"./expvar.demo"</span></span>, <span class="hljs-string"><span class="hljs-string">"-bind=:1234"</span></span>, ], <span class="hljs-string"><span class="hljs-string">"memstats"</span></span> : { <span class="hljs-string"><span class="hljs-string">"NumGC"</span></span> : 5, <span class="hljs-string"><span class="hljs-string">"Alloc"</span></span> : 114016, <span class="hljs-string"><span class="hljs-string">"DebugGC"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"HeapObjects"</span></span> : 519, <span class="hljs-string"><span class="hljs-string">"HeapSys"</span></span> : 868352, <span class="hljs-string"><span class="hljs-string">"StackInuse"</span></span> : 180224,</code> </pre><br>  This is the JSON representation of the two variables defined by the next two lines ‚Äî the command line and the current <a href="http://golang.org/pkg/runtime/">runtime.Memstats</a> values.  The latter contains a lot of details about the current memory usage and the work of the garbage collector, most of which are too detailed.  Typically, the values ‚Äã‚Äãused for monitoring are Alloc, Sys, HeapAlloc ‚Äî actually used memory requested from the OS, used memory in the heap, respectively. <br><br>  Since init () calls automatically when importing a package, it‚Äôs enough to add one line in the program: <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-string"><span class="hljs-string">"expvar"</span></span></code> </pre> <br><h5>  expvarmon </h5><br>  This program is extremely simple - it reads this JSON for the specified service or services at a specified interval, and displays it in a convenient form for monitoring, while showing sparkline-graphs for numerical values.  All it needs to run is the port or ‚Äúhost: port‚Äù of the service (s) you want to monitor.  For example: <br><pre> <code class="bash hljs">expvarmon -ports=<span class="hljs-string"><span class="hljs-string">"80"</span></span> expvarmon -ports=<span class="hljs-string"><span class="hljs-string">"23000-23010,80"</span></span> expvarmon -ports=<span class="hljs-string"><span class="hljs-string">"80,remoteapp.corp.local:80-82"</span></span></code> </pre><br>  You can specify both one and 30+ ports / services - how long do you have the size of the terminal. <br>  The program can also monitor itself: <br><pre> <code class="bash hljs">expvarmon -self</code> </pre> <br>  The default interval is 5 seconds, but you can specify less or more.  Keep in mind that a too short interval is not recommended, since even the memstats update affects the garbage collector and increases the pauses.  If your application runs under a heavy load, a very short interval (100ms) can affect productivity. <br><pre> <code class="bash hljs">expvarmon -self -i 5m expvarmon -self -i 30s</code> </pre> <br>  By default, the following variables are monitored: <br><ul><li>  mem: memstats.Alloc </li><li>  mem: memstats.Sys </li><li>  mem: memstats.HeapAlloc </li><li>  mem: memstats.HeapInuse </li><li>  memstats.EnableGC </li><li>  memstats.NumGC </li><li>  duration: memstats.PauseTotalNs </li></ul><br>  The values ‚Äã‚Äãof variables are taken in the form in which they are in JSON, with a record through the dot.  The ‚Äúmem:‚Äù, ‚Äúduration:‚Äù, ‚Äústr:‚Äù modifiers are optional, and affect the formatting / display.  If you specify variables without a modifier, they will be displayed as is.  The modifier ‚Äúmem:‚Äù will convert the values ‚Äã‚Äãto the ‚ÄúKB, MB, etc‚Äù representation, and the ‚Äúduration:‚Äù will convert the int64 value to time.Duration (‚Äúns, ms, s, m, etc‚Äù).  The ‚Äústr:‚Äù modifier simply says that the value is not digital, and there is no need to draw a sparkline graph for this variable. <br><br>  For example: <br><pre> <code class="bash hljs">expvarmon -ports=<span class="hljs-string"><span class="hljs-string">"80"</span></span> -vars=<span class="hljs-string"><span class="hljs-string">"mem:memstats.Alloc,duration:Response.Mean,Goroutines,str:Uptime"</span></span></code> </pre> <br>  Again, you can specify as one variable, and a couple of dozen, as far as you have the size of the terminal. <br><br>  The program has two modes - for one service and for several services.  In the first case, the graphs are displayed for all variables, in the second - only for the first two, in the order in which they are indicated.  For graphs, the maximum values ‚Äã‚Äãthat were observed during the monitoring session are displayed. <br><br><h4>  Additionally </h4><br>  Expvarmon displays icons with services that have fallen and that are currently lying.  Unfortunately, if the polling interval is longer than the service crash / restart time, the program will not catch the service crash. <br><br>  It is also important to understand that the data is not recorded or stored anywhere.  The graphs show the latest values ‚Äã‚Äã- and the scale of the graphs depends on the interval and the size of the terminal.  There is no zoom, no history, no time search.  This solution is for a simpler task - instant monitoring of current values. <br><br>  Thanks to the capabilities of TermUI, the program dynamically changes the size of all widgets when changing the font size or the terminal window. <br><br><h4>  Additional variables </h4><br>  Personally, in the standard variable list, expvar lacks two things - the number of running gorutin and service uptime.  Here is a demo wrapper that will export three additional variables.  Just connect it to your program, one import. <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> myexpvars <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"expvar"</span></span> <span class="hljs-string"><span class="hljs-string">"math/rand"</span></span> <span class="hljs-string"><span class="hljs-string">"runtime"</span></span> <span class="hljs-string"><span class="hljs-string">"time"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( startTime = time.Now().UTC() ) <span class="hljs-comment"><span class="hljs-comment">// goroutines is an expvar.Func compliant wrapper for runtime.NumGoroutine function. func goroutines() interface{} { return runtime.NumGoroutine() } // uptime is an expvar.Func compliant wrapper for uptime info. func uptime() interface{} { uptime := time.Since(startTime) return int64(uptime) } // responseTime fake var. func responseTime() interface{} { resp := time.Duration(rand.Intn(1000)) * time.Millisecond return int64(resp) } func init() { expvar.Publish("Goroutines", expvar.Func(goroutines)) expvar.Publish("Uptime", expvar.Func(uptime)) expvar.Publish("MeanResponse", expvar.Func(responseTime)) }</span></span></code> </pre><br><h4>  What to do if you use a third-party http-router, instead of the standard </h4><br>  Many web services on Go are written using additional web frameworks or more advanced http routers.  expvar out of the box will not work with them.  For it, you will need to start the standard http.ListenAndServer () on another port.  And this is even better, since opening out / debug / vars is highly discouraged when it comes to public web services. <br><br>  If you are using standard net / http, but you want expvar to be on a different port, the easiest way is to do so.  "Main" ServeMux run as follows: <br><pre> <code class="go hljs">mux := http.NewServerMux() server := &amp;http.Server{Addr: ‚Äú:<span class="hljs-number"><span class="hljs-number">80</span></span>‚Äù, Handler: mux} server.ListenAndServe()</code> </pre> <br>  a / debug / vars hang on standard <br><pre> <code class="go hljs">http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":1234"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>)</code> </pre> <br><br><h4>  Screenshots </h4><br> <a href=""><img src="https://habrastorage.org/files/050/acc/a2c/050acca2ca19472eabd30283683a5276.png" width="300"></a> <a href=""><img src="https://habrastorage.org/files/232/a2c/d13/232a2cd13fed4f9c82ee6572765933a5.png" width="300"></a> <br><br> <a href=""><img src="https://habrastorage.org/files/fcb/1c2/623/fcb1c262373846ceb562259b6c0822bb.png" width="300"></a> <a href=""><img src="https://habrastorage.org/files/c4f/12a/443/c4f12a4437754ed89512b92e23c3bc29.png" width="300"></a> <br><br><h4>  Links </h4><br>  Github: <a href="https://github.com/divan/expvarmon">github.com/divan/expvarmon</a> <br>  Expvar docs: <a href="http://golang.org/pkg/expvar/">golang.org/pkg/expvar</a> <br>  runtime.Memstats: <a href="http://golang.org/pkg/runtime/">golang.org/pkg/runtime/#MemStats</a> </div><p>Source: <a href="https://habr.com/ru/post/257593/">https://habr.com/ru/post/257593/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257583/index.html">Ways to Improve Reference Profile Performance</a></li>
<li><a href="../257585/index.html">PushAll - platform for sending instant notifications</a></li>
<li><a href="../257587/index.html">Simple quadcopter repair (with microscope)</a></li>
<li><a href="../257589/index.html">User videos: MacOS inside ReactOS</a></li>
<li><a href="../257591/index.html">We rule bug without source codes</a></li>
<li><a href="../257603/index.html">Dizdok, or writing project documentation</a></li>
<li><a href="../257605/index.html">EMCSSL - WWW user identification system based on the NVS cryptocurrency subsystem EmerCoin and decentralized client SSL certificates</a></li>
<li><a href="../257607/index.html">Layered menu for Arduino and not only</a></li>
<li><a href="../257609/index.html">How to translate an entire site to permanent HTTPS for all</a></li>
<li><a href="../257611/index.html">Unknown Smalltalk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>