<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Static analysis of PHP code on the example of Symfony2 (part 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="annotation 
 The second part of this article was not planned, but the topic found a response, so you can continue. 

 So, static code analysis in larg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Static analysis of PHP code on the example of Symfony2 (part 2)</h1><div class="post__text post__text-html js-mediator-article"><h1>  annotation </h1><br>  The second part of <a href="http://habrahabr.ru/post/248971/">this article was</a> not planned, but the topic found a response, so you can continue. <br><br>  So, static code analysis in large projects is necessary, and PHP projects are no exception.  In essence, the problems and methodology of implementing static analysis tools will be the same as, say, <a href="http://habrahabr.ru/company/pvs-studio/blog/254855/">in C ++</a> . <br><br>  With everyday use of static analysis tools, you can achieve not only a noticeable reduction in the number of errors, but also an improvement in the quality of the code as a whole - to show this in practice is the goal of this article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      That can be found and corrected with the minimum investment of time (and the maximum return) I will tell under a cat. <br><a name="habracut"></a><br><h2>  Instruments </h2><br>  From the tools I use the <a href="https://plugins.jetbrains.com/plugin/7622%3Fpr%3DphpStorm">Php Inspections</a> analyzer <a href="https://plugins.jetbrains.com/plugin/7622%3Fpr%3DphpStorm">(EA Extended)</a> , which is set as an extension to PhpStorm. <br><br>  In order to automate the routine to fix the source code, you can use the <a href="http://cs.sensiolabs.org/">PHP CS Fixer</a> , especially since some of the Php Inspections (EA Extended) will be added to the CS Fixer (for example).  It is worth looking at this utility - it automatically corrects the code, frees up a lot of time, and reduces the chance of introducing errors, correcting the code manually. <br><br>  And, of course, one should not blindly believe analyzers: the semantics of projects is not a trivial thing.  Make sure that the code is covered with tests before making changes - working with static analyzers requires some safety precautions. <br><br><h1>  Defect examples </h1><br><h2>  Reference mismatch and memory problems </h2><br>  The likelihood of finding this type of problem without long profiling is very small, but a static analysis makes it possible to identify such places.  The problem is present in large systems and frameworks in which the optimization of memory consumption was carried out. <br><br>  Ideally, of course, the developer will notice a diagnostic message, and we will not see such a code.  I will make a reservation that the inspection will be only in the next release of the plugin. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">Session</span></span>\<span class="hljs-title"><span class="hljs-title">Attribute</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NamespacedAttributeBag</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AttributeBag</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name, $default = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* * protected function &amp;resolveAttributePath($name, $writeContext = false); * reference mismatch,        */</span></span> $attributes = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;resolveAttributePath($name); ... } ... }</code> </pre> <br>  It should be: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name, $default = null)</span></span></span><span class="hljs-function"> </span></span>{ $attributes = &amp;<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;resolveAttributePath($name); ... }</code> </pre><br><h2>  Foreach, reference values ‚Äã‚Äãand non-obvious errors </h2><br>  The foreach feature is that it does not create its own scope, and the variables remain in the parent area.  Therefore, declaring the value as a reference, you can add a very unpleasant bug, when the last value of the array changes for no apparent reason. <br><br>  Static analysis will reveal such places already on the first pass. <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Descriptor</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationDescription</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sortCommands</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $commands)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($namespacedCommands <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> &amp;$commands) { ksort($commands); } <span class="hljs-comment"><span class="hljs-comment">/* *   -   $commands, *    $namespacedCommands   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $namespacedCommands; } ... }</code> </pre><br>  It should be: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sortCommands</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $commands)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($namespacedCommands <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> &amp;$commands) { ksort($commands); } <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($commands); ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $namespacedCommands; }</code> </pre><br><h2>  Micro optimizations </h2><br>  Here I just give examples of code that are not optimal, but perform their task. <br>  According to my observations, such code appears in the systems when the team members change periodically with the inclusion of novice developers in the team. <br><br>  You can laugh and discuss the competence of developers, but it is better for the architect or team leader to fix such places on his own and without unnecessary criticism - the team will appreciate and focus on the main tasks. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// if (false !== strpos($lang, '-')) -   if (strstr($lang, '-')) { ... } // $cast = (int) $value -   $cast = intval($value); // return (float) $value -   return floatval($value); // $this-&gt;ignore |= static::IGNORE_DOT_FILES -   $this-&gt;ignore = $this-&gt;ignore | static::IGNORE_DOT_FILES; // if (!in_array(static::$availableOptions[$option], $this-&gt;options)) -   if (false === array_search(static::$availableOptions[$option], $this-&gt;options)) { ... } // ++$calls[$id] -   $calls[$id] += 1; // if ('root' === get_current_user()) -   if (in_array(get_current_user(), array('root'))) { ... } // if (array_key_exists($id, $container-&gt;getAliases())) -   if (in_array($id, array_keys($container-&gt;getAliases()))) { ... } // return '' === $relativePath ? './' : $relativePath -   return (strlen($relativePath) === 0) ? './' : $relativePath;</span></span></code> </pre><br><h2>  Dead code </h2><br>  Sometimes you can find refactoring artifacts, unnoticed by simple analyzers. <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Acl</span></span>\<span class="hljs-title"><span class="hljs-title">Dbal</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MutableAclProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AclProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MutableAclProviderInterface</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PropertyChangedListener</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateNewFieldAceProperty</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name, array $changes)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">//   $currentIds = array(); foreach ($changes[1] as $field =&gt; $new) { for ($i = 0, $c = count($new); $i &lt; $c; $i++) { ... if (null === $ace-&gt;getId()) { ... } else { //   $currentIds[$ace-&gt;getId()] = true; } } } } ... }</span></span></code> </pre><br><h1>  Instead of conclusion </h1><br>  I hope that the examples from the article (and they are all part of the PRs in Symfony2) motivate you to check your projects again and implement the static analysis tools in your daily work. <br><br>  In large commercial systems, which at the age of 5-10 years require a lot of resources to restore order and eliminate "strange" errors, Php Inspections (EA Extended) and PHP CS Fixer will become your indispensable tool for every day. <br><br>  For open source, I‚Äôll remind you about <a href="http://scrutinizer-ci.com/">Scrutinizer CI</a> and <a href="http://insight.sensiolabs.com/">Sensio Labs Insights</a> - very useful tools that can be used along with the previous two. </div><p>Source: <a href="https://habr.com/ru/post/254949/">https://habr.com/ru/post/254949/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254937/index.html">Secrets of exporting from Blender to Unity</a></li>
<li><a href="../254939/index.html">A detailed look at the legacy of Leibniz</a></li>
<li><a href="../254941/index.html">Code Quality Visualization with PhpMetrics</a></li>
<li><a href="../254945/index.html">The digest of interesting materials for the mobile developer # 97 (March 30 - April 5)</a></li>
<li><a href="../254947/index.html">"Kings of the North" - the battle for gameplay</a></li>
<li><a href="../254951/index.html">Thorns around gold</a></li>
<li><a href="../254955/index.html">Morphological image processing. Lectures from Yandex</a></li>
<li><a href="../254957/index.html">Risks and metrics in test automation</a></li>
<li><a href="../254959/index.html">Ansible - let's try</a></li>
<li><a href="../254961/index.html">Release Rust 1.0 Beta</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>