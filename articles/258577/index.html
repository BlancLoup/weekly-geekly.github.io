<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proper performance evaluation for diagnosing and fixing issues with .Net serialization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dear readers! I present to you the translation of the article by Scott Hanselman entitled " Proper benchmarking to solve and. A serial serial bottle b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proper performance evaluation for diagnosing and fixing issues with .Net serialization</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/332/51f/58e/33251f58e3504ade9dba5757ef38311a.png" align="right">  <i>Dear readers!</i>  <i>I present to you the translation of the article by <a href="http://www.hanselman.com/">Scott Hanselman</a> entitled " <a href="http://www.hanselman.com/blog/ProperBenchmarkingToDiagnoseAndSolveANETSerializationBottleneck.aspx">Proper benchmarking to solve and. A</a> <a href="http://www.hanselman.com/">serial serial bottle bottle</a> ".</i> <br><br>  For starters, a few reservations and comments.  First, the process of evaluating performance is complicated.  Difficult to measure.  But the real problem is that we often forget, FOR WHAT we evaluate the performance of something.  We take a complex multi-machine financial system and suddenly we are extremely focused on a piece of code that performs serialization, which we believe is the IS.  "If I can optimize this serialization by writing a for-loop from 10,000 iterations and reducing its execution time by x milliseconds, everything will be the way." <br><a name="habracut"></a><br>  Secondly, it is not a post with performance comparison results.  Do not link to it and do not say ‚Äúsee!  The X library is better than the Y library. Or .Net is better than Java! ‚ÄùInstead, consider it as an instructive story, as well as a set of general recommendations.  I simply use this story to emphasize the following: <br><br><ul><li>  Do you understand 100% what you measure? </li><li>  Did you run a profiler like Visual Studio profiler, ANTS or .dotTrace? </li><li>  Do you consider warming up time?  Do you drop sharply different measurement values?  Are your results statistically significant? </li><li>  Are the libraries you use optimized for your usage scenario?  Are you sure you know what your usage scenario is? </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  One bad performance score </h2><br>  One reader recently sent me an e-mail with questions about serialization in .Net.  The guys read <a href="http://blogs.msdn.com/b/youssefm/archive/2009/07/10/comparing-the-performance-of-net-serializers.aspx">one very old post of</a> 2009 about performance, which included graphs and charts, and independently conducted some tests.  They recorded that the serialization time (tens of thousands of elements) is more than 700 milliseconds, and the volume is about 2 megabytes.  The test serialized their typical data structures, both in C # and Java, using a set of different libraries.  Among the libraries was their company's own serializer, binary .Net DataContract, as well as JSON.NET.  In one case, serialization gave a small amount of data (1.8 MB for a large structure), in the other - it worked quickly (94 ms.), But there was no obvious winner.  The reader was on the verge of loss of reason and decided, in a sense, that .Net should not be used to solve their problem. <br><br>  In my opinion, there is something wrong with such a performance evaluation.  It is not clear what was measured.  It is not clear whether the measurements were reliable, and more specifically, the universal conclusion that ‚Äú.Net is slow‚Äù was not reasonable, given the data presented. <br><br>  Hmm ... So .Net cannot serialize tens of thousands of data structures quickly?  I know what I can. <br><br><blockquote>  <b>See also:</b> <a href="http://kellabyte.com/2014/02/12/create-benchmarks-and-results-that-have-value/">Create benchmarks and Results that</a> <a href="http://kellabyte.com/2013/11/29/responsible-benchmarking/">Responsible benchmarking</a> by <a href="https://twitter.com/kellabyte">@Kellabyte</a> <br></blockquote><br>  I'm not an expert, but I still played a little with this code. <br><br><h2>  First, are we measuring correctly? </h2><br>  The tests used DateTime.UtcNow, which is not advised to use in such cases. <br><pre><code class="cs hljs">startTime = DateTime.UtcNow; resultData = TestSerialization(foo); endTime = DateTime.UtcNow;</code> </pre> <br>  Do not use DateTime.Now or DateTime.Utc to measure where any accuracy is needed.  <a href="http://jaychapman.blogspot.com/2007/11/datetimenow-precision.html">DateTime does not have sufficient accuracy</a> and <a href="http://stackoverflow.com/questions/2072361/what-is-the-best-way-to-measure-how-long-code-takes-to-execute">returns the time with an error of up to 30ms</a> . <br><br>  DateTime represents the date and time.  This is not a high-precision timer or stopwatch. <br><br>  As <a href="http://stackoverflow.com/a/2143784/6380">Eric Lippert says</a> : <br><blockquote>  In short, ‚Äúhow much time?‚Äù And ‚Äúhow long did it last?‚Äù Are completely different questions;  Do not use a tool designed to answer one question to answer another. </blockquote><br>  And as <a href="http://blogs.msdn.com/b/oldnewthing/archive/2005/09/02/459952.aspx">Raymond Chen says</a> : <br><blockquote>  Accuracy (precision) is not the same as accuracy.  Reliability is how close you are to the right answer;  accuracy - how high the resolution of the response is. </blockquote><br>  So, we will use Stopwatch where we need a stopwatch.  Before I transferred the example to Stopwatch, I received values ‚Äã‚Äãin milliseconds like 90,106,103,165,94, and after transferring to Stopwatch the results were 99.94.95.95.94.  Fluctuations of values ‚Äã‚Äãhave become significantly less. <br><pre> <code class="cs hljs">Stopwatch sw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); sw.Start(); <span class="hljs-comment"><span class="hljs-comment">// stuff sw.Stop();</span></span></code> </pre><br>  Also, you may need to bind a process to a single processor core if you are trying to get a reliable estimate of performance.  While it shouldn't matter and Stopwatch uses Win32 QueryPerformanceCounter (the source code for Stopwatch in .Net is <a href="http://referencesource.microsoft.com/">here</a> ), <a href="http://www.virtualdub.org/blog/pivot/entry.php%3Fid%3D106">some problems</a> occurred on older systems <a href="http://www.virtualdub.org/blog/pivot/entry.php%3Fid%3D106">if the test started on one processor and ended on another</a> . <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// One Core var p = Process.GetCurrentProcess(); p.ProcessorAffinity = (IntPtr)1;</span></span></code> </pre><br>  If you are not using Stopwatch, look for a simple and well-suited library for assessing performance. <br><br><h2>  Second: we count the results </h2><br>  In the sample code that was given to me, about 10 lines contained the actual measurements, and 735 lines - the ‚Äúinfrastructure‚Äù, which was responsible for collecting and displaying the obtained data.  Perhaps you have already seen this?  It is fair to say that the performance evaluation may be lost in the ‚Äúinfrastructure‚Äù. <br><br>  Listen to my recent podcast with Matt Warren on " <a href="http://hanselminutes.com/458">Performance as a Feature</a> " and take a look at the <a href="http://mattwarren.org/">Matt's performance blog</a> , and be sure to use the <a href="https://twitter.com/benmwatson">Ben Watson</a> book called " <a href="http://www.writinghighperf.net/">Writing High Performance .NET Code</a> ". <br><br>  Also keep in mind that Matt is currently <a href="https://github.com/mattwarren/MiniBench-WIP">experimenting with creating a compact infrastructure for evaluating performance</a> on GitHub.  This system is quite promising <a href="">and could reduce the evaluation process to applying the [Benchmark] attribute directly inside the unit tests</a> . <br><br>  Consider using existing infrastructures for simple performance evaluations.  One of them is <a href="https://github.com/theburningmonk/SimpleSpeedTester">SimpleSpeedTester</a> by <a href="http://theburningmonk.com/tags/SimpleSpeedTester/">Yan Cui</a> .  She makes nice signs and does a lot of tedious work for you.  Here are the screenshots I <s>stole</s> lent on the Yan blog. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/85a/171/429/85a1714293be429788f2779f4630af62.png"></div><br><br>  A slightly more advanced tool worth looking at is the <a href="http://hdrhistogram.org/">HdrHistogram</a> , a library ‚Äúdesigned to record histograms of measured values ‚Äã‚Äãin applications that are sensitive to latency and performance.‚Äù  It is also <a href="https://github.com/HdrHistogram/HdrHistogram">on GitHub</a> and includes implementations in Java, C, and C #. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/a10/e6d/f33/a10e6df334234918998552c8524c16da.png"></div><br><br>  And seriously.  Use a profiler. <br><br><h2>  Third: did you run the profiler? </h2><br>  Use the Visual Studio Profiler, or download the <a href="http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/">Redgate ANTS Performance Profiler</a> trial or <a href="https://www.jetbrains.com/profiler/">JetBrains dotTrace profiler</a> . <br><br>  What does our application spend time on?  I think we all met people who did complex tests and studied the work of the black box instead of just running the profiler. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e48/7fc/955/e487fc9553f647f490f7b7bde52ab88e.png"></div><br><br><h2>  By the way: are there any newer / suitable / studied ways to solve the problem? </h2><br>  This is my opinion, but I think it deserves attention and there are numbers that prove it.  Part of the code that performs serialization in .Net is quite old, written in 2003 or 2005, and may not take advantage of new technologies and knowledge.  In addition, it is a rather flexible, ‚Äúsuitable for all‚Äù code, unlike very highly specialized code. <br><br>  People have different needs associated with serialization.  You cannot serialize something in XML and expect the result to be small and compact.  Similarly, you cannot serialize a structure in JSON and wait for it to be as fast as with binary serialization. <br><br>  Measure your code, analyze your requirements, take a step back and consider all the options. <br><br><h2>  Fourth: New .Net serializers worth considering </h2><br>  Now that I have an understanding of what is happening and how to measure elapsed time, it became clear that all those serializers did not meet the goals of our reader.  Some, as I said, were written long ago.  So what are the more advanced and modern options? <br><br>  There are two really good serializers to watch out for.  This is <a href="https://github.com/kevin-montrose/Jil"><b>Jil</b> from Kevin Montrose</a> , and <a href="https://code.google.com/p/protobuf-net/"><b>protobuf-net</b> from Marc Gravell</a> .  Both are awesome, and the breadth of the frameworks supported and the protobuf-net building system are just lovely.  There are also other impressive serializers that are included in <a href="https://github.com/ServiceStack/ServiceStack.Text">ServiceStack.NET</a> and include support not only for JSON, but also for JSV and CSV. <br><br><h3>  Protobuf-net - protocol buffers for .NET </h3><br>  Protocol buffers is a <a href="https://developers.google.com/protocol-buffers/docs/overview">format for describing data structures from Google</a> , and protobuf-net is a high-performance implementation of protocol buffers under .NET.  Imagine that it is XML, only more compact and faster.  In addition, with the possibility of cross-language serialization.  Here is what is indicated on their website: <br><br><blockquote>  Protocol buffers have many advantages when serializing structured data compared to XML.  They: <br><ul><li>  simpler </li><li>  from 3 to 10 times less </li><li>  20 to 100 times faster </li><li>  more unambiguous </li><li>  generate data access classes (data access classes) that are easier to use in the program code </li></ul></blockquote><br>  It was easy to add.  There are many ways to decorate your data structures, but essentially: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = ProtoBuf.Serializer.Deserialize&lt;List&lt;DataItem&gt;&gt;(memInStream);</code> </pre><br>  The numbers I received with protobuf-net were exceptional, and in this case the data was packed tightly and quickly, taking only 49ms. <br><br><h3>  JIL - JSON serializer for .NET using Sigil </h3><br>  Jil is a Json-serializer, less flexible than Json.net, but this little sacrifice is offered to them in the name of speed.  Here is what they say: <br><blockquote>  Flexibility and cool features are explicitly ignored in pursuit of speed. </blockquote>  It is also worth noting that some serializers work with a string in memory, while others, such as Json.NET and DataContractSerializer, work with the stream.  This means that you should take into account the size of what you are going to serialize when you choose a library. <br><br>  Jil is impressive to many, but especially because he dynamically emits a custom serializer (as XmlSerializers used to do). <br><br>  Jil is extremely easy to use.  It just works.  I added it to the example and it serialized in 84ms. <br><pre> <code class="cs hljs">result = Jil.JSON.Deserialize&lt;Foo&gt;(jsonData);</code> </pre><br><br><h2>  Conclusion: Comparing Performance Is Not So Easy </h2><br>  What do you measure?  Why do you measure it?  Do your methods match your use cases?  Do you serialize one large object or thousands of small ones? <br><br>  James Newton-King brought me one beautiful thought: <br><blockquote>  "[There is] a meta-problem related to performance comparison. Micro-optimization and performance care when it doesn‚Äôt matter, this is what many developers sin. Documentation, developer productivity and flexibility are more important than a hundredth of a millisecond. " </blockquote><br>  James pointed out the <a href="https://aspnetwebstack.codeplex.com/workitem/2092">old (but recently corrected) ASP.NET error</a> on Twitter.  This is an important error affecting performance, but it nevertheless fades in the light of the time it takes to transfer data over the network. <br><blockquote>  This error confirms the idea that many developers care about performance when it does not matter <br>  - <a href="https://twitter.com/JamesNK/status/566051682946019328">James Newton-King (@JamesNK) February 13, 2015</a> <br></blockquote><br>  Thanks to <a href="https://twitter.com/marcgravell">Marc Gravell</a> and <a href="https://twitter.com/JamesNK">James Newton-King</a> for their help in preparing this post. <br><br>  <i>The original article is available at <a href="http://www.hanselman.com/blog/ProperBenchmarkingToDiagnoseAndSolveANETSerializationBottleneck.aspx">this link.</a></i> </div><p>Source: <a href="https://habr.com/ru/post/258577/">https://habr.com/ru/post/258577/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258567/index.html">Are you a mammoth? (Friday test; which is a lie, but a hint in it)</a></li>
<li><a href="../258569/index.html">Results of the project competition with the Aviasales API</a></li>
<li><a href="../258571/index.html">Optical compensation</a></li>
<li><a href="../258573/index.html">Image and video analysis. Detection of text on images</a></li>
<li><a href="../258575/index.html">Why Windows Phone has become the best platform to launch the game "Torque"</a></li>
<li><a href="../258579/index.html">Post reinforced retro</a></li>
<li><a href="../258581/index.html">My experience with Apache Cassandra</a></li>
<li><a href="../258583/index.html">Convert conversations to mp3 - Elastix 2.5 (FreePBX 2.11)</a></li>
<li><a href="../258585/index.html">Smart quest in reality: demons and wiring</a></li>
<li><a href="../258587/index.html">Animation of characters in Blender 3D is just</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>