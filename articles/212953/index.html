<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple monitoring of DFS Replication in Zabbix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 With a sufficiently large and distributed infrastructure that uses DFS as a single data access point and DFSR for data replication betw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple monitoring of DFS Replication in Zabbix</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  With a sufficiently large and distributed infrastructure that uses DFS as a single data access point and DFSR for data replication between data centers and branch office servers, the question arises of monitoring the status of this replication. <br>  Coincidentally, almost immediately after using DFSR, we began to implement Zabbix in order to replace the existing zoo with various tools and bring the monitoring of the infrastructure to a more informative, complete and logical look.  The use of Zabbix to monitor the replication of DFS will be discussed. <br><br>  First of all, we need to decide what kind of DFS replication data needs to be obtained to monitor its condition.  The most relevant indicator is the backlog.  It includes files that were not synchronized with other members of the replication group.  You can view its size with the <b>dfsrdiag</b> utility, which is installed along with the DFSR role.  In the normal state of replication, the size of the backlog should tend to zero.  Accordingly, large values ‚Äã‚Äãof the number of files in the backlog indicate problems with replication. <br><br>  Now about the practical side of the issue. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order to monitor the size of the backlog via the Zabbix Agent, we will need: <br><br><ul><li>  Script that will <b>parse the</b> output of <b>dfsrdiag</b> to provide the final values ‚Äã‚Äãof the backlog size to Zabbix, </li><li>  The script that will determine how many replication groups are on the server, which folders they replicate and which other servers belong to them (we don‚Äôt want to drive all this into Zabbix with our hands for each server, right?), </li><li>  Entering these scripts as UserParameter in the configuration of Zabbix agent for the subsequent call from the monitoring server, </li><li>  Starting the Zabbix agent service on behalf of a user who has rights to read the backlog, </li><li>  A template for Zabbix, which will be configured to detect groups, process the received data and issue alerts for them. </li></ul><br><br><h4>  Script parser </h4><br>  To write the parser, I chose VBS as the most universal language present in all versions of Windows Server.  The logic of the script is simple: it receives from the command line the name of the replication group, the replicated folder, and the names of the sending and receiving servers.  Further, these parameters are transferred to <b>dfsrdiag</b> , and depending on its output, it is issued: <br>  Number of files - if there is a message about the presence of files in the backlog <br>  0 - if there is a message about the absence of files in the backlog ("No Backlog"), <br>  -1 - if <b>dfsrdiag</b> error message is <b>received</b> while executing the query ("[ERROR]"). <br><br><div class="spoiler">  <b class="spoiler_title">get-backlog.vbs</b> <div class="spoiler_text"><pre><code class="vbscript hljs">strReplicationGroup=WScript.Arguments.Item(<span class="hljs-number"><span class="hljs-number">0</span></span>) strReplicatedFolder=WScript.Arguments.Item(<span class="hljs-number"><span class="hljs-number">1</span></span>) strSending=WScript.Arguments.Item(<span class="hljs-number"><span class="hljs-number">2</span></span>) strReceiving=WScript.Arguments.Item(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> WshShell = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span> (<span class="hljs-string"><span class="hljs-string">"Wscript.shell"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objExec = WSHshell.Exec(<span class="hljs-string"><span class="hljs-string">"dfsrdiag.exe Backlog /RGName:"""</span></span> &amp; strReplicationGroup &amp; <span class="hljs-string"><span class="hljs-string">""" /RFName:"""</span></span> &amp; strReplicatedFolder &amp; <span class="hljs-string"><span class="hljs-string">""" /SendingMember:"</span></span> &amp; strSending &amp; <span class="hljs-string"><span class="hljs-string">" /ReceivingMember:"</span></span> &amp; strReceiving) strResult = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">While</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> objExec.StdOut.AtEndOfStream strResult = strResult &amp; objExec.StdOut.ReadLine() &amp; <span class="hljs-string"><span class="hljs-string">"\\"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-built_in"><span class="hljs-built_in">InStr</span></span>(strResult, <span class="hljs-string"><span class="hljs-string">"No Backlog"</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> intBackLog = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ElseIf</span></span> <span class="hljs-built_in"><span class="hljs-built_in">InStr</span></span>(strResult, <span class="hljs-string"><span class="hljs-string">"[ERROR]"</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> intBackLog = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> arrLines = <span class="hljs-built_in"><span class="hljs-built_in">Split</span></span>(strResult, <span class="hljs-string"><span class="hljs-string">"\\"</span></span>) arrResult = <span class="hljs-built_in"><span class="hljs-built_in">Split</span></span>(arrLines(<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">":"</span></span>) intBackLog = arrResult(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> WScript.echo intBackLog</code> </pre> </div></div><br><br><h4>  Detection script </h4><br>  In order for Zabbix itself to determine all the replication groups present on the server, and to figure out all the parameters required for the request (folder name, names of the servers-neighbors), we need this information, first, to get, and second, submit it in a format that Zabbix can understand.  A format that the discovery tool understands looks like this: <br><br><pre> <code class="hljs objectivec"> <span class="hljs-string"><span class="hljs-string">"data"</span></span>:[ { <span class="hljs-string"><span class="hljs-string">"{#GROUP}"</span></span>:<span class="hljs-string"><span class="hljs-string">"Share1"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#FOLDER}"</span></span>:<span class="hljs-string"><span class="hljs-string">"Folder1"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#SENDING}"</span></span>:<span class="hljs-string"><span class="hljs-string">"Server1"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#RECEIVING}"</span></span>:<span class="hljs-string"><span class="hljs-string">"Server2"</span></span>} ... <span class="hljs-string"><span class="hljs-string">"{#GROUP}"</span></span>:<span class="hljs-string"><span class="hljs-string">"ShareN"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#FOLDER}"</span></span>:<span class="hljs-string"><span class="hljs-string">"FolderN"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#SENDING}"</span></span>:<span class="hljs-string"><span class="hljs-string">"Server1"</span></span>, <span class="hljs-string"><span class="hljs-string">"{#RECEIVING}"</span></span>:<span class="hljs-string"><span class="hljs-string">"ServerN"</span></span>}]}</code> </pre> <br><br>  The information we are interested in is easiest to get through WMI by pulling it out of the appropriate DfsrReplicationGroupConfig sections.  As a result, a script was born that makes a request to WMI and, at the output, produces a list of groups, their folders and servers in the required format. <br><br><div class="spoiler">  <b class="spoiler_title">DFSRDiscovery.vbs</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> strComputer, strLine, n, k, i <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> wshNetwork = WScript.<span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>( <span class="hljs-string"><span class="hljs-string">"WScript.Network"</span></span> ) strComputer = wshNetwork.ComputerName <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> oWMIService = <span class="hljs-built_in"><span class="hljs-built_in">GetObject</span></span>(<span class="hljs-string"><span class="hljs-string">"winmgmts:\\"</span></span> &amp; strComputer &amp; <span class="hljs-string"><span class="hljs-string">"\root\MicrosoftDFS"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> colRGroups = oWMIService.ExecQuery(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM DfsrReplicationGroupConfig"</span></span>) wscript.echo <span class="hljs-string"><span class="hljs-string">"{"</span></span> wscript.echo <span class="hljs-string"><span class="hljs-string">" ""data"":["</span></span> n=<span class="hljs-number"><span class="hljs-number">0</span></span> k=<span class="hljs-number"><span class="hljs-number">0</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> oGroup <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> colRGroups n=n+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> colRGFolders = oWMIService.ExecQuery(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM DfsrReplicatedFolderConfig WHERE ReplicationGroupGUID='"</span></span> &amp; oGroup.ReplicationGroupGUID &amp; <span class="hljs-string"><span class="hljs-string">"'"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> oFolder <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> colRGFolders k=k+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> colRGConnections = oWMIService.ExecQuery(<span class="hljs-string"><span class="hljs-string">"SELECT * FROM DfsrConnectionConfig WHERE ReplicationGroupGUID='"</span></span> &amp; oGroup.ReplicationGroupGUID &amp; <span class="hljs-string"><span class="hljs-string">"'"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> oConnection <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> colRGConnections i=i+<span class="hljs-number"><span class="hljs-number">1</span></span> binInbound = oConnection.Inbound strPartner = oConnection.PartnerName strRGName = oGroup.ReplicationGroupName strRFName = oFolder.ReplicatedFolderName <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> oConnection.Enabled = <span class="hljs-literal"><span class="hljs-literal">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> binInbound = <span class="hljs-literal"><span class="hljs-literal">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> strSendingComputer = strComputer strReceivingComputer = strPartner strLine1=<span class="hljs-string"><span class="hljs-string">" {"</span></span> strLine2=<span class="hljs-string"><span class="hljs-string">" ""{#GROUP}"":"""</span></span> &amp; strRGName &amp; <span class="hljs-string"><span class="hljs-string">""","</span></span> strLine3=<span class="hljs-string"><span class="hljs-string">" ""{#FOLDER}"":"""</span></span> &amp; strRFName &amp; <span class="hljs-string"><span class="hljs-string">""","</span></span> strLine4=<span class="hljs-string"><span class="hljs-string">" ""{#SENDING}"":"""</span></span> &amp; strSendingComputer &amp; <span class="hljs-string"><span class="hljs-string">""","</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; colRGroups.Count) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (k &lt; colRGFolders.count) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (i &lt; colRGConnections.Count) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> strLine5=<span class="hljs-string"><span class="hljs-string">" ""{#RECEIVING}"":"""</span></span> &amp; strReceivingComputer &amp; <span class="hljs-string"><span class="hljs-string">"""},"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> strLine5=<span class="hljs-string"><span class="hljs-string">" ""{#RECEIVING}"":"""</span></span> &amp; strReceivingComputer &amp; <span class="hljs-string"><span class="hljs-string">"""}]}"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> wscript.echo strLine1 wscript.echo strLine2 wscript.echo strLine3 wscript.echo strLine4 wscript.echo strLine5 <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span></code> </pre><br><br>  I agree, the script may not shine with the elegance of the code and something in it can certainly be simplified, but its main function is to give information about the parameters of replication groups in a format understandable to Zabbix - it performs successfully. <br></div></div><br><br><h4>  Scripting the Zabbix agent configuration </h4><br>  Everything is very simple here.  Add the following lines to the end of the agent configuration file: <br><br><pre> <code class="hljs pgsql">UserParameter=check_dfsr[*],cscript /nologo "C:\Program Files\Zabbix Agent\get-Backlog.vbs" <span class="hljs-meta"><span class="hljs-meta">$1</span></span> <span class="hljs-meta"><span class="hljs-meta">$2</span></span> <span class="hljs-meta"><span class="hljs-meta">$3</span></span> <span class="hljs-meta"><span class="hljs-meta">$4</span></span> UserParameter=discovery_dfsr[*],cscript /nologo "C:\Program Files\Zabbix Agent\DFSRDiscovery.vbs"</code> </pre><br>  Of course, we reign the paths to those where we have scripts.  I put them in the same folder where the agent is installed. <br><br>  After making changes, we restart the Zabbix agent service. <br><br><h4>  Change of the user from whom the Zabbix Agent service is running </h4><br>  In order to receive information through <b>dfsrdiag</b> , the utility must be run on behalf of an account that has administrative rights to both sending and receiving replication group members.  The Zabbix agent service, running by default under the system account, will not be able to perform such a request.  I created a separate account in the domain, gave it administrative rights on the necessary servers and set up on these servers to start the service from under it. <br><br>  You can go another way: since <b>dfsrdiag</b> , in fact, works through the same WMI, you can use the <a href="http://zenshaze.com/wp/%3Fp%3D101">description of</a> how to give a domain account rights to use it without issuing administrative rights, but if we have many replication groups, then issue rights to each group will be difficult.  However, in case we want to monitor the replication of the Domain System Volume on domain controllers, this may be the only acceptable option, since it is not a good idea to give domain administrator rights to the accounting service account. <br><br><h4>  Monitoring template </h4><br>  Based on the data, I created a template that: <br><ul><li>  Once per hour starts automatic detection of replication groups, </li><li>  Every 5 minutes checks the backlog size for each group, </li><li>  It contains a trigger that gives an alert when the size of the backlog for any group is more than 100 within 30 minutes.  The trigger is described as a prototype, which is automatically added to the detected groups, </li><li>  Builds graphs for backlog size for each replication group. </li></ul><br>  Download the template for Zabbix 2.2 <a href="http://rghost.ru/52498334">here</a> . <br><br><h4>  Total </h4><br>  After importing the template into Zabbix and creating an account with the necessary permissions, we will only need to copy the scripts to the file servers that we want to monitor for DFSR, add two lines to the agent configuration on them and restart the Zabbix agent service by setting it to run on behalf of required account.  No other manual settings for monitoring DFSR are required. </div><p>Source: <a href="https://habr.com/ru/post/212953/">https://habr.com/ru/post/212953/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212937/index.html">CMS prevalence study in RuNet, Bynet and Uanete</a></li>
<li><a href="../212939/index.html">Why is the mouse cursor tilted at 45 ¬∞?</a></li>
<li><a href="../212941/index.html">Octodon: going deeper underground</a></li>
<li><a href="../212943/index.html">Jacques Arsac. 1929-2014</a></li>
<li><a href="../212947/index.html">Briefly about the perfect 7-port USB 3.0 hub ORICO</a></li>
<li><a href="../212955/index.html">Why do we need all these functors and monads?</a></li>
<li><a href="../212957/index.html">Whatsapp came out on the warpath</a></li>
<li><a href="../212959/index.html">How we: hover on iOS won ...</a></li>
<li><a href="../212963/index.html">Our IT market in pictures by segment</a></li>
<li><a href="../212965/index.html">Free codecs won the Wikipedia vote</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>