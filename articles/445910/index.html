<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How do we make EF 6 with MSSQL and PostgresSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once upon a time there was a project on EF 6 with MSSQL DBMS. And there was a need to add the ability to work with PostgreSQL. We did not expect probl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How do we make EF 6 with MSSQL and PostgresSQL</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/_a/jr/dp/_ajrdpk_rrdrsqmckt71xkfceve.jpeg" alt="image"><br><br>  Once upon a time there was a project on EF 6 with MSSQL DBMS.  And there was a need to add the ability to work with PostgreSQL.  We did not expect problems here, because there are a large number of articles on this topic, and on the forums you can find a discussion of similar problems.  However, in reality, not everything turned out to be so simple, and in this article we will tell about this experience, about the problems that we encountered during the integration of the new provider, and about our chosen solution. <br><a name="habracut"></a><br><h3>  Introductory </h3><br>  We have a boxed product, and it has an established structure.  Initially, it was configured to work with one DBMS - MSSQL.  The project has a data access layer with EF 6 implementation (Code First approach).  We work with migrations through EF 6 Migrations.  Migrations are created in manual mode.  The initial installation of the database occurs from the console application with context initialization by the connection string passed as an argument: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.Length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"No arguments in command line"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Initializing dbcontext via </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{connectionString}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = MyDbContext(connectionString)) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Database created"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Console.WriteLine(e.Message); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  At the same time, the EF infrastructure and domain domain are described in another project that is connected to the console application as a library.  The context constructor in the infrastructure project looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDbContext</span></span> : <span class="hljs-title"><span class="hljs-title">IdentityDbContext</span></span>&lt;<span class="hljs-title"><span class="hljs-title">User</span></span>, <span class="hljs-title"><span class="hljs-title">Role</span></span>, <span class="hljs-title"><span class="hljs-title">Key</span></span>, <span class="hljs-title"><span class="hljs-title">UserLogin</span></span>, <span class="hljs-title"><span class="hljs-title">UserRole</span></span>, <span class="hljs-title"><span class="hljs-title">UserClaim</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IUnitOfWork</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDbContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectionString</span></span></span><span class="hljs-function">)</span></span> { Database.SetInitializer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbInitializer()); Database.Initialize(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } }</code> </pre><br><h3>  First start </h3><br>  The first thing we did was connect two packages to the project via nuget: Npgsql and EntityFramework6.Npgsql. <br><br>  And also registered in the App.config of our console application settings for Postgres. <br><br>  In the entityFramework section, you specified the postgres factory as the default connection factory: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">entityFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--&lt;defaultConnectionFactory type="System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework" /&gt;--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">defaultConnectionFactory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql.NpgsqlConnectionFactory, EntityFramework6.Npgsql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">providers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">provider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invariantName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.SqlClient"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">provider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invariantName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql.NpgsqlServices, EntityFramework6.Npgsql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">providers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">entityFramework</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  In the section DbProviderFactories have registered a factory of a new provider: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DbProviderFactories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql Data Provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invariant</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">support</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FF"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".Net Framework Data Provider for Postgresql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql.NpgsqlFactory, Npgsql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DbProviderFactories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.data</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  And immediately we tried to initialize the database, specifying the address of the Postgres server and the credentials of the server admin in the connection string.  It turned out this line: <br><blockquote>  ‚ÄúServer = localhost;  DataBase = TestPostgresDB;  Integrated Security = false;  User Id = postgres;  password = pa $$ w0rd ‚Äù </blockquote>  As expected, thanks to the EF Migrations manual mode, initialization failed, and an inconsistency error occurred in the database snapshot of the current model.  To circumvent the creation of a primary migration with a new provider and test the database initialization on Postgres, we adjusted our infrastructure a bit. <br><br>  First, we enabled ‚Äúauto-migration‚Äù - a useful option if changes in the domain models and EF infrastructure in a team are led by one developer: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Configuration</span></span> : <span class="hljs-title"><span class="hljs-title">DbMigrationsConfiguration</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MyDbContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AutomaticMigrationsEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; ContextKey = <span class="hljs-string"><span class="hljs-string">"Project.Infrastructure.MyDbContext"</span></span>; } }</code> </pre><br>  Secondly, we specified a new provider in the redefined InitializeDatabase method of the inherited CreateDatabaseIfNotExists class, where we run migrations: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbInitializer</span></span> : <span class="hljs-title"><span class="hljs-title">CreateDatabaseIfNotExists</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MyDbContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MyDbContext context</span></span></span><span class="hljs-function">)</span></span> { DbMigrator dbMigrator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbMigrator(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration { <span class="hljs-comment"><span class="hljs-comment">//TargetDatabase = new DbConnectionInfo(context.Database.Connection.ConnectionString, "System.Data.SqlClient") TargetDatabase = new DbConnectionInfo(context.Database.Connection.ConnectionString, "Npgsql") }); // There some code for run migrations } }</span></span></code> </pre><br>  Next, we again launched our console application with the same connection string as an argument.  This time, the initialization of the context passed without errors, and our domain models successfully formed a new database on Postgres.  In the new database, a ‚Äú__MigrationHistory‚Äù sign appeared, in which there was a single record of the first automatically created migration. <br><br>  Let us sum up the subtotal: we were able to connect the new provider to the existing project without any problems, but at the same time we changed the settings of the migration mechanism. <br><br><h3>  Enable manual migration mode </h3><br>  As already mentioned above, when automatic migrations is enabled, you are depriving your parallel development team in the domain and data access areas.  For us, this option was unacceptable.  Therefore, we needed to configure the manual mode of migrations in the project. <br><br>  We first returned the AutomaticMigrationsEnabled field to false.  Then it was necessary to deal with the creation of new migrations.  We understood that migrations for different DBMSs, as a minimum, should be stored in different project folders.  Therefore, we decided to create a new folder under Postgres migration in the infrastructure project called PostgresMigrations (the MsSql migration folder, for clarity, we renamed MsSqlMigrations), and copied the MsSql migration configuration file into it.  At the same time, we did not copy all existing MsSql migrations into PostgresSql.  Firstly, because all of them contain a snapshot of the configuration under the MsSql provider and, accordingly, we cannot use them on the new DBMS.  Secondly, for a new DBMS, the history of changes is not important to us, and we can get by with the last snapshot of the state of domain models. <br><br>  We thought that everything was ready for the formation of the first migration to Postgres.  The database created during context initialization with the automatic migration mode enabled was deleted.  And, guided by the fact that for the first migration, you need to create a physical database based on the current state of domain models, we happily beat the Update-Database command in the Package Manager Console, specifying only the connection string parameter.  As a result, we received an error related to connecting to the DBMS. <br><br>  Additionally, having studied the principle of the Update-Database command, we did the following: <br><br><ul><li>  added the following code to the migration configuration settings: <br><br>  for MsSql: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AutomaticMigrationsEnabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; ContextKey = <span class="hljs-string"><span class="hljs-string">"Project.Infrastructure.MyDbContext"</span></span>; MigrationsDirectory = <span class="hljs-string"><span class="hljs-string">@"MsSqlMigrations"</span></span>; }</code> </pre><br>  for postgres: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AutomaticMigrationsEnabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; ContextKey = <span class="hljs-string"><span class="hljs-string">"Project.Infrastructure.MyDbContext"</span></span>; MigrationsDirectory = <span class="hljs-string"><span class="hljs-string">@"PostgresMigrations"</span></span>; }</code> </pre></li><li>  indicated the necessary parameter of the Update-Database command, which provides the name of the provider </li><li>  added parameters that indicate the project containing the description of the ef infrastructure and the folder with the configuration of the migrations of the new provider </li></ul><br>  As a result, we got the following command: <br><blockquote>  Update-Database -ProjectName "Project.Infrastructure" -ConfigurationTypeName Project.Infrastructure.PostgresMigrations.Configuration -ConnectionString "Server = localhost;  DataBase = TestPostgresDB;  Integrated Security = false;  User Id = postgres;  password = pa $$ w0rd "-ConnectionProviderName" Npgsql " </blockquote>  After executing this command, we were able to execute the Add-Migration command with the same parameters, calling the first migration InitialCreate: <br><blockquote>  Add-Migration -Name "InitialCreate" -ProjectName "CrossTech.DSS.Infrastructure" -ConfigurationTypeName CrossTech.DSS.Infrastructure.PostgresMigrations.Configuration -ConnectionString "Server = localhost;  DataBase = TestPostgresDB;  Integrated Security = false;  User Id = postgres;  password = pa $$ w0rd "-ConnectionProviderName" Npgsql " </blockquote>  A new file has appeared in the PostgresMigrations folder: 2017010120705068_InitialCreate.cs <br><br>  Then we deleted the database created after the Update-Database command was executed and launched our console application with the connection string specified above as an argument.  And here we have a database already on the basis of a manually created migration. <br><br>  Let us sum up the subtotal: we were able with minimal effort to add the first migration for the Postgres provider and initialize the context through the console application, receiving the output of the new database, into which changes were made from our first manual migration. <br><br><h3>  Switching between providers </h3><br>  We still have one unanswered question: how to set up the initialization of the context so that you can access a specific DBMS at runtime? <br><br>  The task was to make it possible to select one or another target database of the required provider at the stage of context initialization.  As a result of repeated attempts to customize this switch, we came to a solution that looks like this. <br><br>  In the console application of the project in app.config (and if you do not use app.config, then machine.config) we add a new connection string indicating the provider and the name of the connection, and in the context designer we ‚Äúthrow‚Äù the name of the connection instead of the connection string.  In this case, the connection string itself is associated with the context via the singleton instance DbConfiguration.  As a parameter, we pass the instance of the inherited class from DbConfiguration. <br><br>  The resulting inherited DbConfiguration class is: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbConfig</span></span> : <span class="hljs-title"><span class="hljs-title">DbConfiguration</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DbConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> provideName</span></span></span><span class="hljs-function">)</span></span> { ConfigurationManager.ConnectionStrings.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConnectionStringSettings(connectionName, connectionString, provideName)); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (connectionName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"PostgresDbConnection"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetDefaultConnectionFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NpgsqlConnectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderServices(provideName, NpgsqlServices.Instance); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderFactory(provideName, NpgsqlFactory.Instance); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"MsSqlDbConnection"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetDefaultConnectionFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderServices(provideName, SqlProviderServices.Instance); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderFactory(provideName, SqlClientFactory.Instance); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetDefaultConnectionFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br>  And the context initialization itself now looks like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionName = args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = args[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> provideName = args[<span class="hljs-number"><span class="hljs-number">2</span></span>]; DbConfiguration.SetConfiguration(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbConfig(connectionName, connectionString, provideName)); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = MyDbContext(connectionName)) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Database created"</span></span>); }</code> </pre><br>  And who watched carefully, he probably noticed that we had to make another change in the code.  This is the definition of the target database during database initialization, which occurs in the InitializeDatabase method described earlier. <br><br>  We added a simple switch to define the configuration of the migrations of a particular provider: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbInitializer</span></span> : <span class="hljs-title"><span class="hljs-title">CreateDatabaseIfNotExists</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MyDbContext</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _connectionName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DbInitializer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionName</span></span></span><span class="hljs-function">)</span></span> { _connectionName = connectionName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MyDbContext context</span></span></span><span class="hljs-function">)</span></span> { DbMigrationsConfiguration&lt;MyDbContext&gt; config; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (_connectionName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"PostgresDbConnection"</span></span>: config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PostgresMigrations.Configuration(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"MsSqlDbConnection"</span></span>: config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MsSqlMigrations.Configuration(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: config = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (config == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; config.TargetDatabase = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbConnectionInfo(_connectionName); DbMigrator dbMigrator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbMigrator(config); <span class="hljs-comment"><span class="hljs-comment">// There some code for run migrations } }</span></span></code> </pre><br>  And the context constructor itself looked like this: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDbContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionNameParam</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectionString</span></span></span><span class="hljs-function">)</span></span> { Database.SetInitializer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbInitializer(connectionName = connectionNameParam)); Database.Initialize(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre><br>  Next, we launched the console application and specified the MsSql application as a DBMS provider.  We set the following application arguments: <blockquote>  ‚ÄúMsSqlDbConnection‚Äù ‚ÄúServer = localhost \ SQLEXPRESS;  Database = TestMsSqlDB;  User Id = sa;  password = pa $$ w0rd ¬ª¬´ System.Data.SqlClient ¬ª </blockquote><br>  The MsSql database was created without errors. <br><br>  Then we specified the application arguments: <br><blockquote>  ‚ÄúPostgresDbConnection‚Äù ‚ÄúServer = localhost;  DataBase = TestPostgresDB;  Integrated Security = false;  User Id = postgres;  password = pa $$ w0rd "" Npgsql " </blockquote>  The Postgres database was also created without errors. <br><br>  So, another subtotal - in order for EF to initialize the database context for a particular provider, at runtime it is necessary: <br><br><ul><li>  ‚ÄúPoint‚Äù to the migration mechanism on this provider </li><li>  configure the database connection strings before context initialization </li></ul><br><h3>  We work with migrations of two DBMS in a team </h3><br>  As we have seen, the most interesting begins after the appearance of new changes in the domain.  It is necessary for you for two DBMS to generate migrations taking into account the specific provider. <br><br>  So, for MSSQL Server, you need to execute sequential commands (for Postgres, the commands described above, when creating the first migration): <br><br><ul><li>  update the database according to the last snapshot <br><blockquote>  Update-Database -ProjectName "Project.Infrastructure" -ConfigurationTypeName Project.Infrastructure.MsSqlMigrations.Configuration -ConnectionString "Server = localhost;  DataBase = TestMsSqlDB;  Integrated Security = false;  User Id = sa;  password = pa $$ w0rd "-ConnectionProviderName" System.Data.SqlClient " </blockquote></li><li>  add new migration <br><blockquote>  Add-Migration -Name "SomeMigrationName" -ProjectName "Project.Infrastructure" -ConfigurationTypeName Project.Infrastructure.MsSqlMigrations.Configuration -ConnectionString "Server = localhost;  DataBase = TestMsSqlDB;  Integrated Security = false;  User Id = sa;  password = pa $$ w0rd "-ConnectionProviderName" System.Data.SqlClient " </blockquote></li></ul><br>  When developers make changes to the domain in parallel, we get multiple conflicts when merging these changes into the version control system (for simplicity, we'll call git).  This is due to the fact that migrations to EF follow one after another.  And if one developer creates a migration, then another developer simply adds the migration successively.  Each subsequent migration stores information about the previous one.  Thus, it is necessary to update the so-called snapshots of models in the migration to the last one created. <br><br>  At the same time, resolving conflicts over EF migrations in a team is reduced to prioritizing the significance of changes of a particular developer.  And whose changes are higher in priority, they should be the first to flood them into git, and the rest of the developers, according to the agreed hierarchy, should do the following: <br><br><ol><li>  delete created local migrations </li><li>  pull up changes from the repository where other high-priority colleagues have already poured their migrations </li><li>  create a local migration and upload the resulting changes back to git </li></ol><br>  As far as we are closely acquainted with the EF migration mechanism, we can judge that the described team development approach is the only one at the moment.  We do not consider this solution ideal, but it has the right to life.  And for us the question of finding an alternative to the EF Migrations mechanism has become urgent. <br><br><h3>  Finally </h3><br>  Working with several DBMS using EF6 in conjunction with EF Migrations is real, but in this version the guys from Microsoft did not take into account the possibility of the team working in parallel using version control systems. <br><br>  There are many alternative EF Migrations solutions on the market (both paid and free): DbUp, RoundhousE, ThinkingHome.Migrator, FluentMigrator, etc.  And judging by the reviews, they are more to the developers than the EF Migrations. <br><br>  Fortunately, we have the opportunity to do some upgrade in our project.  And in the near future we will be switching to EF Core.  We weighed the pros and cons of the EF Core Migrations mechanism and concluded that it would be more convenient for us to work with a third-party solution, namely Fluent Migrator. <br><br>  We hope you were interested in our experience.  We are ready to accept comments and answer questions, well! </div><p>Source: <a href="https://habr.com/ru/post/445910/">https://habr.com/ru/post/445910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445898/index.html">About new ideas, narrow views and a word of mouth</a></li>
<li><a href="../445900/index.html">How to withstand the increased load on the system: talk about large-scale preparations for Black Friday</a></li>
<li><a href="../445904/index.html">Types of infinity and brain removal</a></li>
<li><a href="../445906/index.html">Do not eat aspirin</a></li>
<li><a href="../445908/index.html">Golang and the evolution of database interaction</a></li>
<li><a href="../445912/index.html">Hi, Habr, we are Advantech</a></li>
<li><a href="../445914/index.html">Is a docker a toy or not? Or still yes?</a></li>
<li><a href="../445918/index.html">20 years of RollerCoaster Tycoon: an interview with the creator of the game</a></li>
<li><a href="../445920/index.html">LIVE: How to curb iOS development in large teams</a></li>
<li><a href="../445922/index.html">Why watch online broadcasts if you can read Habr</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>