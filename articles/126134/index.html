<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Database mirroring on MS SQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. I decided to describe here my experience in setting database mirroring. Not having, until recently, a similar profit, I began to surf the In...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Database mirroring on MS SQL</h1><div class="post__text post__text-html js-mediator-article"> Good day.  I decided to describe here my experience in setting database mirroring.  Not having, until recently, a similar profit, I began to surf the Internet in search of information on this subject.  And I will try to arrange the post as a step-by-step instruction to tell about the main points, in general, what would be nothing superfluous. <br><a name="habracut"></a><br>  <u><b>Intro</b></u> <br>  To reserve a database, we considered 2 options: <br>  - replication <br>  - mirroring <br>  <i>Replications have</i> disappeared, because some tables cannot be replicated and, in general, a database structure should be immediately provided specifically for this case. <br>  <i>Mirroring</i> works with a bang!  As a result of tests, he put the main base, translated the mirror into the main one.  After raising the main thing - that machine became a mirror, changed their places.  Everything went without a hitch, without a hitch.  (God grant her long health!) <br><br>  In general, there are 3 modes of mirroring: <br>  - protected with automatic recovery <br>  - protected with manual recovery <br>  - not secure / asynchronous <br>  <i>Protected</i> are different from <i>asynchronous</i> in that they do not wait for confirmation of the acceptance of a transaction on a mirror server, but continue to work and throw new and new transactions into the queue. <br>  <i>Protected with automatic recovery</i> requires automatic recovery to use the 3rd server (witness) and, in principle, is useful only if you can specify a backup server in your application to switch in case the primary server is not working.  Since I was sorry, the information space and applications working with the database could not be switched by the monitoring servers either. <br>  I set up the base to work in <i>protected mode with manual recovery</i> . <br><br>  Here is a good instruction on <a href="http://technet.microsoft.com/ru-ru/library/ms175059(SQL.90).aspx">TechNet</a> . <br>  And <a href="http://www.codeproject.com/Articles/109236/Mirroring-a-SQL-Server-Database-is-not-as-hard-as-.aspx">here</a> in the pictures shows how to do it through the GUI. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <u><b>Part 1. Setting up a server connection.</b></u> <br>  To connect servers with each other, <i>checkpoints</i> are created on both machines, ports for connections are opened, users, certificates, etc. are created. <br>  We will create checkpoints, for authorization we will use a certificate generated by MS SQL server (other certificates can also be used). <br><br>  <u>1. Create a certificate on the main server and save it in the <i>D: \ Certs package</i></u> <br> <code>USE MASTER <br> GO <br> IF NOT EXISTS(SELECT 1 FROM sys.symmetric_keys where name = '##MS_DatabaseMasterKey##') <br> CREATE MASTER KEY ENCRYPTION BY PASSWORD = ' ' <br> GO <br> IF NOT EXISTS (select 1 from sys.databases where [is_master_key_encrypted_by_server] = 1) <br> ALTER MASTER KEY ADD ENCRYPTION BY SERVICE MASTER KEY <br> GO <br> IF NOT EXISTS (SELECT 1 FROM sys.certificates WHERE name = 'PrincipalServerCert') <br> CREATE CERTIFICATE PrincipalServerCert <br> WITH SUBJECT = 'Principal Server Certificate', <br> START_DATE = '08/15/2011', <br> EXPIRY_DATE = '08/15/2021'; <br> GO <br> BACKUP CERTIFICATE PrincipalServerCert TO FILE = 'D:\Certs\PrincipalServerCert.cer' <br></code> <br><br>  <u>2. Create a <i>DBMirrorEndPoint checkpoint</i> on the core server.</u> <br> <code>USE MASTER <br> GO <br> IF NOT EXISTS(SELECT * FROM sys.endpoints WHERE type = 4) <br> CREATE ENDPOINT DBMirrorEndPoint <br> STATE = STARTED AS TCP (LISTENER_PORT = 5022) <br> FOR DATABASE_MIRRORING ( AUTHENTICATION = CERTIFICATE PrincipalServerCert, ENCRYPTION = REQUIRED <br> ,ROLE = ALL <br> )</code> <br> <br>  <u>3. Create a certificate and control point <i>DBMirrorEndPoint</i> on the mirror, by analogy with the main one.</u> <br> <code>USE MASTER <br> GO <br> IF NOT EXISTS(SELECT 1 FROM sys.symmetric_keys where name = '##MS_DatabaseMasterKey##') <br> CREATE MASTER KEY ENCRYPTION BY PASSWORD = ' ' <br> GO <br> IF NOT EXISTS (select 1 from sys.databases where [is_master_key_encrypted_by_server] = 1) <br> ALTER MASTER KEY ADD ENCRYPTION BY SERVICE MASTER KEY <br> GO <br> IF NOT EXISTS (SELECT 1 FROM sys.certificates WHERE name = 'MirrorServerCert') <br> CREATE CERTIFICATE MirrorServerCert <br> WITH SUBJECT = 'Mirror Server Certificate', <br> START_DATE = '08/15/2011', <br> EXPIRY_DATE = '08/15/2021'; <br> GO <br> BACKUP CERTIFICATE MirrorServerCert TO FILE = 'D:\Certs\MirrorServerCert.cer' <br> <br> IF NOT EXISTS(SELECT * FROM sys.endpoints WHERE type = 4) <br> CREATE ENDPOINT DBMirrorEndPoint <br> STATE=STARTED AS TCP (LISTENER_PORT = 5023) <br> FOR DATABASE_MIRRORING ( AUTHENTICATION = CERTIFICATE MirrorServerCert, ENCRYPTION = REQUIRED <br> ,ROLE = ALL <br> ) <br></code> <br><br>  Certificates and checkpoints we created.  Now so that the servers can communicate with each other, on each server you need to create accounts and bind them to certificates. <br><br>  <u>4. Copy certificates from one server to another, so that the <i>D: \ Certs</i> folder <i>contains</i> 2 certificates each.</u> <u><br></u> <br><br>  <u>5. Create <i>MirrorServerUser</i> on the main server of the user, this user is tied to the <i>MirrorDBCertPub</i> certificate generated and copied from the mirror server</u> <br> <code>USE MASTER <br> GO <br> IF NOT EXISTS(SELECT 1 FROM sys.syslogins WHERE name = 'MirrorServerUser') <br> CREATE LOGIN MirrorServerUser WITH PASSWORD = '2' <br> IF NOT EXISTS(SELECT 1 FROM sys.sysusers WHERE name = 'MirrorServerUser') <br> CREATE USER MirrorServerUser; <br> IF NOT EXISTS(SELECT 1 FROM sys.certificates WHERE name = 'MirrorDBCertPub') <br> CREATE CERTIFICATE MirrorDBCertPub AUTHORIZATION MirrorServerUser <br> FROM FILE = 'D:\Certs\MirrorServerCert.cer' <br> GRANT CONNECT ON ENDPOINT::DBMirrorEndPoint TO MirrorServerUser <br> GO <br></code> <br><br>  <u>6. Let's create on the backup server of the user <i>PrincipalServerUser</i> , this user is tied to the <i>PrincipalDBCertPub</i> certificate generated and copied from the main server</u> <br> <code>USE MASTER <br> GO <br> IF NOT EXISTS(SELECT 1 FROM sys.syslogins WHERE name = 'PrincipalServerUser') <br> CREATE LOGIN PrincipalServerUser WITH PASSWORD = '2' <br> IF NOT EXISTS(SELECT 1 FROM sys.sysusers WHERE name = 'PrincipalServerUser') <br> CREATE USER PrincipalServerUser; <br> IF NOT EXISTS(SELECT 1 FROM sys.certificates WHERE name = 'PrincipalDBCertPub') <br> CREATE CERTIFICATE PrincipalDBCertPub AUTHORIZATION PrincipalServerUser <br> FROM FILE = 'D:\Certs\PrincipalServerCert.cer' <br> GRANT CONNECT ON ENDPOINT::DBMirrorEndPoint TO PrincipalServerUser <br> GO</code> <br> <br>  Communication between servers is configured! <br><br>  <b><u>Part 2. Setting up databases.</u></b> <br>  Here we will need to remove the backup from the working database, raise it on the mirror server in the <i>NORECOVERY</i> mode and turn on the mirroring mode. <br>  The mirrored database must have a <i>FULL</i> recovery model. <br><br>  <u>1. Remove the backup database.</u> <br> <code>BACKUP DATABASE [MIRROR_TEST] TO DISK = N'D:\MIRROR_TEST.bak' <br> WITH FORMAT, INIT, NAME = N'MIRROR_TEST-Full Database Backup',STATS = 10</code> <br> <br>  <u>2. Raise it on the mirror (the script implies that the backup file is transferred to the mirror server on disk D)</u> <br> <code>RESTORE DATABASE [MIRROR_TEST] <br> FROM DISK = 'D:\MIRROR_TEST.bak' WITH NORECOVERY <br> ,MOVE N'MIRROR_TEST' TO N'D:\MSSQL_DB\MIRROR_TEST.mdf' <br> ,MOVE N'MIRROR_TEST_log' TO N'D:\MSSQL_DB\MIRROR_TEST_log.ldf' <br></code> <br><br>  <u>3. To start mirroring on a mirror server, do the following:</u> <br> <code>ALTER DATABASE MIRROR_TEST SET PARTNER = 'TCP://MSSQLMAINSERV:5022'</code> <br> <br>  <u>4. Then on the main point:</u> <br> <code>ALTER DATABASE MIRROR_TEST SET PARTNER = 'TCP://MSSQLMIRRORSERV:5023'</code> <br> <br>  <b>If you get an error like:</b> <br><br> <code>The mirror database, ‚ÄúMIRROR_TEST‚Äù, has insufficient transaction log data to preserve the log backup chain of the principal database. This may happen if a log backup from the principal database has not been taken or has not been restored on the mirror database. (Microsoft SQL Server, Error: 1478)</code> <br> <br>  or <br><br> <code>The remote copy of database "DBmirrorTest" has not been rolled forward to a point in time that is encompassed in the local copy of the database log.</code> <br> <br>  Make a backup of the log from the base on the main server and restore it on the mirror (again in the NORECOVERY mode). <br>  Backup: <br> <code>BACKUP LOG MIRROR_TEST TO DISK = 'D:\MIRROR_TEST.trn'</code> <br> <br>  Recovery: <br> <code>RESTORE LOG MIRROR_TEST <br> FROM DISK = 'D:\MIRROR_TEST.trn' WITH NORECOVERY</code> <br> <br>  <b><u>Part 3. Disaster recovery.</u></b>  <b><u>Changing roles.</u></b> <br>  You can change the roles of the server so that the mirror becomes the main one and look at the species through the GUI by clicking the right button on the database - <b>Task</b> - <b>Mirror</b> - <b>Failover</b> or through the T-SQL command <br> <code>ALTER DATABASE MIRROR_TEST SET PARTNER FAILOVER</code> <br> <br>  If the mirror base crashed down, the main one continues to work in an unprotected mode (this is not reflected on the clients).  After the mirror is resumed, the backup database automatically connects and overtakes the main one. <br><br>  If the main base crashed, then to revive the backup, you need to perform a forced recovery. <br> <code>ALTER DATABASE MIRROR_TEST SET PARTNER FORCE_SERVICE_ALLOW_DATA_LOSS</code> <br> <br>  however, in this case there is a risk of losing some data (much is written about it <a href="http://technet.microsoft.com/ru-ru/library/ms189977%2528SQL.90%2529.aspx">here</a> ) <br><br>  When performing a forced restoration, the mirror base becomes the main one, and the former main one will automatically become a mirror one after restoration, awaiting permission to continue the mirroring session.  What you need to do <br> <code>ALTER DATABASE MIRROR_TEST SET PARTNER RESUME</code> <br>  That's all!  While working 8-) </div><p>Source: <a href="https://habr.com/ru/post/126134/">https://habr.com/ru/post/126134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126123/index.html">Open set for courses on bioinformatics (St. Petersburg)</a></li>
<li><a href="../126125/index.html">3 in 1: Discussions, tasks, documentation</a></li>
<li><a href="../126131/index.html">First National Photo Award Lumix National Awards</a></li>
<li><a href="../126132/index.html">How to raise your level in the art of programming. Six step plan</a></li>
<li><a href="../126133/index.html">Zend_Form_Element: creating your item</a></li>
<li><a href="../126136/index.html">Search in images - Google and not only</a></li>
<li><a href="../126137/index.html">The founder of photo hosting TwitPic launched a Twitter clone</a></li>
<li><a href="../126140/index.html">Adventures with Clodo: about the earth and transcendental approach to work</a></li>
<li><a href="../126141/index.html">Summary 3.0</a></li>
<li><a href="../126142/index.html">Switch from Mac OS X to Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>