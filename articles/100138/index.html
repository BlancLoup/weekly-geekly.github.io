<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Slow password hashing. What for?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, habraraparanik! Today we will talk about a slightly unusual way to increase security, namely, slowing down password hashing . It would seem ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Slow password hashing. What for?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/77/f1/77f173388daa5e07b39819b98787708f.png" align="left">  Good day, habraraparanik!  Today we will talk about a slightly unusual way to increase security, namely, <b>slowing down password hashing</b> .  It would seem that when everyone is trying to optimize everything, why should we slow down something? <br>  At least then, that even in the super-duper itself, the protected system remains the weakest link.  Namely, his password. <br><br>  Have you ever tried to hack an encrypted rar archive?  And how many passwords per second did it go through?  50-100-200?  Even on a good GPU, using the notorious cRARk, the search speed is <a href="http://www.password-crackers.com/en/category_99/program_13.html">only</a> about 2400 options / sec.  And this is in comparison with tens (hundreds) of millions of passwords / sec for zip / md5 / SHA1. <br><br>  Under the cut is my free interpretation of this process. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The meaning of the whole action is as follows: <br><ul><li>  The encryption key is not the password, but the (slow) hash of it. </li><li>  The user does not cost anything to wait a second / half a second while the password is cached </li><li>  But homo brutforsus will have to be patient </li></ul><br>  Yes, I almost forgot about all your favorite <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D0%25B4%25D1%2583%25D0%25B6%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2582%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25B8%25D1%2586%25D0%25B0">rainbow tables</a> , which are quite successfully generated even for systems that use <s>sugar and</s> <a href="http://en.wikipedia.org/wiki/Salt_(cryptography)">salt</a> .  Their generation will also become if not useless, then very labor-intensive. <br><br>  I'm not saying that the systems with salt are bad, they just can be <b>further</b> strengthened. <br><br>  And so, there is salt, there is a password.  What's next? <br><br>  And then everything is pretty simple: <br><ol><li>  Concatenate salt and password </li><li>  Hash, remember the result </li><li>  while (many many times) do { </li><li>  generate round salt </li><li>  Combine it and hash </li><li>  Cache, remember the result} </li></ol><br>  In Winrar (thanks to him, by the way, for inspiration), if my memory serves me, the round salt is the iteration number.  I went a <i>little</i> further. <br><br>  So the code.  Everything is written in java using the <a href="http://www.bouncycastle.org/">BouncyCastle</a> library, but for the thoughtful habrandaranik, it will not be difficult to transfer this (and maybe add your own) to any programming language that is full of turing.  In addition, BouncyCastle is for C #. <br><br>  1. I use 2 hash algorithms (SHA-256 and SHA-512), so for starters, a small interface that will help us more or less universalize the whole thing. <br><blockquote>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">interface</font> IDigest</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">byte</font> [] process ( <font color="#0000ff">byte</font> [] data);</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">int</font> getSize ();</font> <font color="black"><br></font>  <font color="black">}</font> <br><br></blockquote><br><br>  2. An example of the implementation of this interface for the SHA-256 algorithm (using the <b>SHA256Digest</b> class from the <a href="http://www.bouncycastle.org/">BouncyCastle</a> library): <br><blockquote>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> SHA256 implements IDigest</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">private</font> SHA256Digest m_SHA256 = <font color="#0000ff">new</font> SHA256Digest ();</font> <font color="black"><br><br></font>  <font color="black">@Override</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">byte</font> [] process ( <font color="#0000ff">byte</font> [] data)</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black">m_SHA256.reset ();</font> <font color="black"><br></font>  <font color="black">m_SHA256.update (data, 0, data.length);</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">byte</font> [] result = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [m_SHA256.getDigestSize ()];</font> <font color="black"><br></font>  <font color="black">m_SHA256.doFinal (result, 0);</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> result;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">@Override</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">int</font> getSize ()</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> m_SHA256.getDigestSize ();</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">}</font> <br><br></blockquote><br><br>  3. The most delicious.  I will explain it in detail. <br><blockquote> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> SlowHasher</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">private</font> final <font color="#0000ff">static</font> <font color="#0000ff">int</font> BITS_IN_BYTE = 8;</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">int</font> [] s_primeIndices = <font color="#0000ff">new</font> <font color="#0000ff">int</font> [] {7, 11, 17, 23, 31, 41, 47, 53, 61};</font> <font color="black"><br><br></font>  <font color="black"><font color="#008000">/ **</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* this method hashes password 0x50000 times adding round salt each round</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">*</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* <a href="https://habrahabr.ru/users/param/" class="user_link">param</a> digest</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* <a href="https://habrahabr.ru/users/param/" class="user_link">param</a> password</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* <a href="https://habrahabr.ru/users/return/" class="user_link">return</a></font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* /</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">byte</font> [] calculateSlowHash (IDigest digest, <font color="#2B91AF">String</font> password, <font color="#0000ff">byte</font> [] salt)</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">int</font> roundSaltSize = digest.getSize () / BITS_IN_BYTE;</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">byte</font> [] bPasswd = password.getBytes ();</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">byte</font> [] toHash = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [bPasswd.length + salt.length];</font> <font color="black"><br><br></font>  <font color="black"><font color="#008000">/ *</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* composing array of bytes that will be hashed</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* /</font></font> <font color="black"><br></font>  <font color="black">System.arraycopy (salt, 0, toHash, 0, salt.length);</font> <font color="black"><br></font>  <font color="black">System.arraycopy (bPasswd, 0, toHash, salt.length, bPasswd.length);</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">byte</font> [] res = digest.process (toHash);</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">byte</font> [] temp = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [res.length + roundSaltSize];</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt;0x50000; i ++)</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black">System.arraycopy (res, 0, temp, 0, res.length);</font> <font color="black"><br><br></font>  <font color="black"><font color="#008000">/ ***</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* calculating salt</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* /</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> j = 0; j &lt;roundSaltSize; j ++)</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">int</font> btmp = res [s_primeIndices [j]] &amp; 0xFF;</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> k = 1; k &lt;BITS_IN_BYTE; k ++)</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black">btmp = ror ((btmp + (res [ror (btmp, k)% res.length] &amp; 0xFF))% 256, BITS_IN_BYTE-k);</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">temp [res.length + j] = ( <font color="#0000ff">byte</font> ) btmp;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">res = digest.process (temp);</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> res;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black"><font color="#008000">/ **</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* rotate bits right treating input as byte</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* <a href="https://habrahabr.ru/users/param/" class="user_link">param</a> value 0 &lt;= value &lt;= 255</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* <a href="https://habrahabr.ru/users/param/" class="user_link">param</a> n number of bits to shift</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* <a href="https://habrahabr.ru/users/return/" class="user_link">return</a></font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">* /</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">int</font> ror ( <font color="#0000ff">int</font> <font color="#0000ff">value</font> , <font color="#0000ff">int</font> n)</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> (( <font color="#0000ff">value</font> &gt;&gt; (n% BITS_IN_BYTE)) | (( <font color="#0000ff">value</font> &lt;&lt; (8 - (n% BITS_IN_BYTE))) &amp; 0xFF));</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">}</font> <br><br>  People who are not familiar with java I will say right away that you should not be afraid of the many inserts <code>&amp; 0xFF</code> .  This is just converting signed byte to unsigned by converting it to an int and applying such a bitmask.  And all because <b>there are no unsigned types in java!</b>  <b>Totally!</b>  Well, okay, this is not deadly. <br><br>  All the beauty here is the formation of round salt, so the focus will be on it. <br><br>  A little bit about variables: <br><ul><li>  <b>res</b> is an array of 32 bytes for SHA-256 or 64 bytes for SHA-512.  It stores the hash result. </li><li>  <b>roundSaltSize</b> is the size of the round salt.  4 bytes for SHA-256 and 8 bytes for SHA-512 </li><li>  <b>temp</b> is an array of res array size elements plus the size of the round salt roundSaltSize </li><li>  <b>s_primeIndices</b> is an array of indices of elements in the res array, starting from which we will calculate the corresponding byte of the round salt.  That is, we will start the computation of the first byte of the round salt for SHA-256 with res [7], the second with res [11], etc.  All indexes will be used for SHA-512 </li><li>  <b>btemp</b> - byte, which after a series of clever transformations will take its place in the round salt </li></ul><br>  Another remark before we proceed to the explanation of the formation of the algorithm of the round salt.  The whole algorithm is not the result of any scientific research and tests.  It was created to generate a value that would be dependent on some bytes of the resulting hash and would help to slow down and complicate it.  Well, now the description: <br><br><ol><li>  At the beginning, the main salt and password are collected in the toHash array. </li><li>  The toHash array is hashed and the result is stored in the res array.  Everything, about the main salt and password forgot </li><li>  Run a long loop at 0x50000 iterations </li><li>  Next we work with the temp array, into which we copy the res array.  At the end of the temp array, there are still 4 or 8 bytes for salt.  We have to fill them </li><li>  For each of the round salt bytes: </li><li>  We remember in btmp an element that is located in one of the indices (7, 11, 17 ...) depending on the number of the current byte (j) </li><li>  Then 7 (k) times we do the following: </li><li>  Take the remainder of the btmp division, in which the bits are shifted to the right by k positions, by the length of the res array </li><li>  the previous number is used as an index for the array res, we pull out the number at this index </li><li>  btmp assign this number folded with btmp modulo 256 and scrolled to the right by 8-k bits </li><li>  We place btmp in its place after the hash in the temp array </li><li>  Hash temp </li></ol><br>  The call to this method is as follows: <br><br><blockquote>  <font color="black"><font color="#0000ff">byte</font> [] salt = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [16];</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">new</font> SecureRandom (). nextBytes (salt);</font>  <font color="black"><font color="#008000">// generate random 16byte salt</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">byte</font> [] hashedPassword = <font color="#0000ff">new</font> SlowHasher (). calculateSlowHash ( <font color="#0000ff">new</font> SHA256 (), password, salt);</font> <br><br></blockquote><br><br>  The result is a hash (hash (hash + ranoid salt) + round salt) ... which can be used as a 256-bit key to encrypt important information for AES-256, for example. <br><br>  On my machine (C2D 2.6) the generation of one hash accounts for about 0.25 seconds, which I consider acceptable for use.  in their projects.  You can increase the number of rounds and then the time will grow accordingly. <br><br>  If it‚Äôs interesting for a respected public, I can tell you about other applied aspects of working with the BouncyCastle library like symmetric / asymmetric encryption, certificate generation, etc. <br><br>  <b>UPD:</b> <br>  In the comments <a href="http://people.redhat.com/drepper/SHA-crypt.txt">indicated a</a> link to the dock, in which this kind of scheme takes even greater scope </blockquote></div><p>Source: <a href="https://habr.com/ru/post/100138/">https://habr.com/ru/post/100138/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../100125/index.html">New game?</a></li>
<li><a href="../100128/index.html">Disable network Yota in St. Petersburg</a></li>
<li><a href="../100131/index.html">Eh, Google, Google ...</a></li>
<li><a href="../100134/index.html">Sevastopol is not exactly where it is in the opinion of Google Maps</a></li>
<li><a href="../100137/index.html">Correct work with exceptions in PHP</a></li>
<li><a href="../100139/index.html">Install Android 2.2 on Highscreen Zeus</a></li>
<li><a href="../100140/index.html">Starcraft II: A Tale of How to Abuse Ladder</a></li>
<li><a href="../100141/index.html">Nothing to eat? Type it in!</a></li>
<li><a href="../100142/index.html">Free hosting from Makhost</a></li>
<li><a href="../100143/index.html">Double click on items that can be dragged</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>