<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing Business Logic in MySQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! I want to tell in the article my experience in implementing business logic (BL) in MySQL . 

 There are different opinions about the question...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing Business Logic in MySQL</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr!  I want to tell in the article my experience in implementing business logic (BL) in <b>MySQL</b> . <br><img src="https://habrastorage.org/getpro/habr/post_images/023/0ea/a93/0230eaa931e7ba2baae87f6a522ddfb3.jpg"><br>  There are different opinions about the question of whether to keep the database in the database.  I have been working with <b>Oracle for</b> many years and the <b>Oracle</b> philosophy implies that BL in the database is Best Practices.  Let me give you a couple of tom kite quotes: <br><br><blockquote>  <b>Tom Kyte.</b>  <b>Effective Oracle by Design</b> <br>  If you want it to <br></blockquote><blockquote>  <b>Tom Kite.</b>  <b>Oracle for professionals.</b> <br>  Before you begin, I would like to explain to you my approach to development.  I prefer to solve most problems at the DBMS level.  If something can be done in the DBMS, I will do so.  [...] My approach is to do everything possible in a DBMS.  [...] <br>  When developing database applications, I use a very simple mantra: <br><br><ul><li>  if possible, do it with a single SQL statement; </li><li>  if this cannot be done with a single SQL statement, do it in PL / SQL; </li><li>  if this cannot be done in PL / SQL, try using a stored procedure in Java; </li><li>  if this cannot be done in Java, do it in the form of an external C procedure; </li><li>  if it cannot be implemented as an external procedure in the C language, we need to seriously think about why it should be done at all ... </li></ul></blockquote><br>  At the same time, among web-developers, one has to hear opinions that BL in the database is almost an antipattern.  But I will not dwell on the question of whether it is worthwhile to implement the BC in the database.  Let everyone decide for himself.  Those who want to see what I did in the light of the not so extensive (compared to <b>Oracle</b> ) <b>MySQL</b> toolkit, welcome under cat. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The implementation assumes a native call to SQL commands (INSERT / UPDATE / DELETE) on the client with a description of the logic in the triggers.  All further description will be valid for <b>MySQL 5.1.73</b> .  Here are the main points I encountered while developing: <br><br><ul><li>  <b>Row Level Security</b> , <a href="https://habrahabr.ru/post/310832/">see my previous article</a> </li><li>  <b>Error generation in triggers:</b> unfortunately, you cannot generate an error using the native method in MySQL 5.1. </li><li>  <b>Convenient writing of logic in triggers:</b> In MySQL, you cannot create 1 trigger on different SQL commands, as a result, the logic will be spread over 6 subroutines </li><li>  <b>Disable dynamic SQL in triggers</b> </li><li>  <b>Absence of AFTER STATEMENT TRIGGER:</b> in row-level triggers it is forbidden to change the table <b>where</b> changes are made, in Oracle this problem is solved AFTER by expression-level trigger </li></ul><br><h2>  Error generation in triggers </h2><br>  When processing a SQL command, it is required to interrupt its execution with an error.  For example, if the sum of the document exceeds the limit, then abort the INSERT / UPDATE operation and report an error: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> docs_bef_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> max_limit <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> o.max_limit <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> max_limit <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> org o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> o.id = NEW.org_id_client; IF NEW.sum &gt; max_limit THEN <span class="hljs-comment"><span class="hljs-comment">-- ??? --       --    ,   MySQL   --    -- ??? END IF; END $</span></span></code> </pre> <br>  Searching on the Internet and slightly correcting the decision, such code appeared: <br><br><pre> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> raise_error$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> raise_error(msg <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @raise_error_msg := <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(msg, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> mysql_error_generator; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> mysql_error_generator(raise_error <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">engine</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> mysql_error_generator <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(msg, <span class="hljs-string"><span class="hljs-string">''</span></span>)), (<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(msg, <span class="hljs-string"><span class="hljs-string">''</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> raise_error$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> raise_error(msg <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> raise_error(msg); RETURN msg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $</code> </pre> <br>  And so that in PHP, custom SQL errors are with -20000 code and human error text: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExPDOException</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PDOException</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PDOException $e, PDO $connection)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct($e-&gt;getMessage(), <span class="hljs-number"><span class="hljs-number">0</span></span>, $e-&gt;getPrevious()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;code = $e-&gt;getCode(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;errorInfo = $e-&gt;errorInfo; <span class="hljs-comment"><span class="hljs-comment">//   if ($e-&gt;getCode() == 23000 &amp;&amp; strstr($e-&gt;getMessage(), "for key 'raise_error'")) { $this-&gt;code = -20000; $this-&gt;errorInfo[0] = -20000; $this-&gt;errorInfo[1] = -20000; $sql = 'SELECT @raise_error_msg msg'; $q = $connection-&gt;query($sql); $msg = $q-&gt;fetchColumn(); $this-&gt;message = $msg; $this-&gt;errorInfo[2] = $msg; } } }</span></span></code> </pre> <br>  The final trigger code will look like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> docs_bef_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> max_limit <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> o.max_limit, o.name <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> max_limit, client_name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> org o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> o.id = NEW.org_id_client; IF NEW.sum &gt; max_limit THEN <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> raise_error(<span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">' ('</span></span>, NEW.sum , <span class="hljs-string"><span class="hljs-string">')   '</span></span>, client_name , <span class="hljs-string"><span class="hljs-string">'     '</span></span>, max_limit , <span class="hljs-string"><span class="hljs-string">'    ID = '</span></span>, NEW.id)); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre> <br>  Or a more beautiful option using the function: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> docs_bef_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> msg <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> msg := (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> raise_error(<span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">' ('</span></span>, NEW.sum , <span class="hljs-string"><span class="hljs-string">')   '</span></span>, o.name , <span class="hljs-string"><span class="hljs-string">'     '</span></span>, max_limit , <span class="hljs-string"><span class="hljs-string">'    id = '</span></span>, NEW.id)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> org o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> o.id = NEW.org_id_client <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> NEW.sum &gt; o.max_limit ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre> <br><h2>  Convenient writing of logic and prohibition of dynamic SQL in triggers </h2><br>  For example, for the positions of the document we need: <br><br><ul><li>  check if the document is closed </li><li>  when inserting a position, if the price is NULL, then determine the price for the client using the get_price function </li><li>  denormalize the amount of the document in the master table </li></ul><br>  Here is how it could be written: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_bef_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> msg <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> org_id_client <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> msg := (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> raise_error(<span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'  (id = '</span></span> , d.id, <span class="hljs-string"><span class="hljs-string">').  .'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs d <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d.id = NEW.doc_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> d.closed = <span class="hljs-number"><span class="hljs-number">1</span></span> ); IF NEW.price IS NULL THEN <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d.org_id_client <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> org_id_client <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs d <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d.id = NEW.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.price = get_price(NEW.material_id, org_id_client); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_bef_upd_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> msg <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> msg := (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> raise_error(<span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'  (id = '</span></span> , d.id, <span class="hljs-string"><span class="hljs-string">').  .'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs d <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d.closed = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> d.id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (OLD.doc_id, NEW.doc_id) ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_del_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> msg <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> msg := (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> raise_error(<span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'  (id = '</span></span> , d.id, <span class="hljs-string"><span class="hljs-string">').  .'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs d <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d.id = OLD.doc_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> d.closed = <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.kol * NEW.price, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = NEW.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_upd_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) - <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> OLD.doc_id = <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.kol * OLD.price, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> NEW.doc_id = <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.kol * NEW.price, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (OLD.doc_id, NEW.doc_id); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_del_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.kol * OLD.price, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = OLD.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $</code> </pre> <br>  As a result, we have a lot of code, the code is of the same type, duplicated and spread in 6 places.  This code cannot be maintained. <br><br>  How did I solve this problem?  I created triggers that: <br><br><ul><li>  in each <b>BEFORE</b> trigger create <b>MEMORY TEMPORARY TABLE</b> with the predefined name <b>&lt;table_name&gt; _tmp_trg</b> with the same columns and the prefixes <b>new_</b> , <b>old_</b> and the <b>time</b> and <b>type</b> fields </li><li>  <b>time</b> field - trigger execution time <b>B - BEFORE, A - AFTER</b> </li><li>  <b>type</b> field - DML operation, <b>I - INSERT, U - UPDATE, D - DELETE</b> </li><li>  insert the current values ‚Äã‚Äãin the trigger <b>NEW.</b>  and <b>OLD.</b>  in the appropriate fields </li><li>  The procedure <b>&lt;table_name&gt; _trg_proc is called.</b> </li><li>  for <b>BEFORE INSERT / UPDATE</b> triggers, read back to the <b>NEW</b> variables <b>.</b>  values ‚Äã‚Äãfrom the corresponding fields </li><li>  delete data from temporary table in <b>AFTER</b> trigger <b>DROP TEMPORARY TABLE</b> </li></ul><br>  Since  dynamic SQL in triggers is prohibited, then I wrote a trigger generator. <br><br><div class="spoiler">  <b class="spoiler_title">My Trigger Generator</b> <div class="spoiler_text"><pre> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> generate_trigger$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> generate_trigger(table_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>), trigger_time <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>), trigger_type <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> trigger_time_short <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> trigger_type_short <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> group_concat_max_len = <span class="hljs-number"><span class="hljs-number">9000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> trigger_time_short := <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(trigger_time, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> trigger_type_short := <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(trigger_type, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-string"><span class="hljs-string">'DROP TRIGGER IF EXISTS '</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, trigger_time_short, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, trigger_type_short, <span class="hljs-string"><span class="hljs-string">'_trg$\n'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-string"><span class="hljs-string">'CREATE TRIGGER '</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, trigger_time_short, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, trigger_type_short, <span class="hljs-string"><span class="hljs-string">'_trg '</span></span>, trigger_time, <span class="hljs-string"><span class="hljs-string">' '</span></span>, trigger_type, <span class="hljs-string"><span class="hljs-string">' ON '</span></span>, table_name,<span class="hljs-string"><span class="hljs-string">' FOR EACH ROW\n'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-string"><span class="hljs-string">'this_proc:BEGIN\n'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-string"><span class="hljs-string">'IF @disable_'</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'_trg = 1 THEN\n'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-string"><span class="hljs-string">' LEAVE this_proc;\n'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-string"><span class="hljs-string">'END IF;\n'</span></span>); IF trigger_time = 'BEFORE' THEN <span class="hljs-comment"><span class="hljs-comment">--    SET text := CONCAT(text, 'CREATE TEMPORARY TABLE '); --        INSERT INTO ... ON DUPLICATE KEY UPDATE   IF NOT EXISTS --  INSERT IGNORE   AFTER TRIGGER,    IF trigger_type IN ('INSERT', 'UPDATE') THEN SET text := CONCAT(text, 'IF NOT EXISTS '); END IF; SET text := CONCAT(text, table_name, '_tmp_trg (\n'); SET text := CONCAT(text, 'time VARCHAR(1)\n'); SET text := CONCAT(text, ', type VARCHAR(1)\n'); SET text := CONCAT(text, ', col_changed VARCHAR(1000)\n, '); SET text := CONCAT(text, (SELECT GROUP_CONCAT(CONCAT('new_', COLUMN_NAME, ' ', COLUMN_TYPE, '\n, ', 'old_', COLUMN_NAME, ' ', COLUMN_TYPE) SEPARATOR '\n, ') text FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' )); SET text := CONCAT(text, ') ENGINE=MEMORY;\n'); --   SET text := CONCAT(text, (SELECT GROUP_CONCAT(CONCAT('SET @new_', COLUMN_NAME, ' := ', IF(trigger_type = 'DELETE', 'NULL', CONCAT('NEW.', COLUMN_NAME)), ';\n' , 'SET @old_', COLUMN_NAME, ' := ', IF(trigger_type = 'INSERT', 'NULL', CONCAT('OLD.', COLUMN_NAME)), ';') SEPARATOR '\n') text FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' )); SET text := CONCAT(text, '\n'); END IF; SET text := CONCAT(text, 'INSERT INTO ', table_name, '_tmp_trg VALUES ("', SUBSTR(trigger_time, 1, 1), '", "', SUBSTR(trigger_type, 1, 1), '", '); --  col_changed  UPDATE IF trigger_type = 'UPDATE' THEN SET text := CONCAT(text, 'CONCAT(' , (SELECT GROUP_CONCAT(CONCAT('IF(IFNULL(NEW.' , COLUMN_NAME, ', "-") != IFNULL(OLD.', COLUMN_NAME, ', "-"), CONCAT("|', COLUMN_NAME, '|"), "")' ) SEPARATOR ', ') text FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' ), '), '); ELSE SET text := CONCAT(text, 'NULL, '); END IF; SET text := CONCAT(text, (SELECT GROUP_CONCAT(CONCAT( CASE WHEN trigger_time = 'BEFORE' THEN CONCAT('@new_', COLUMN_NAME) WHEN trigger_type = 'DELETE' THEN 'NULL' ELSE CONCAT('NEW.', COLUMN_NAME) END , ', ' , CASE WHEN trigger_time = 'BEFORE' THEN CONCAT('@old_', COLUMN_NAME) WHEN trigger_type = 'INSERT' THEN 'NULL' ELSE CONCAT('OLD.', COLUMN_NAME) END ) SEPARATOR ', ') text FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' )); SET text := CONCAT(text, ');\n'); SET text := CONCAT(text, 'CALL ', table_name, '_trg_proc;\n'); IF trigger_time = 'BEFORE' THEN SET text := CONCAT(text, IF(trigger_type = 'DELETE', '', (SELECT CONCAT('SELECT ' , GROUP_CONCAT(CONCAT('new_', COLUMN_NAME) SEPARATOR ', ') , '\nINTO ', GROUP_CONCAT(CONCAT('@new_', COLUMN_NAME) SEPARATOR ', ') , '\nFROM ', table_name, '_tmp_trg;\n' , CONCAT(GROUP_CONCAT(CONCAT('SET NEW.', COLUMN_NAME, ' := @new_', COLUMN_NAME) SEPARATOR ';\n'), ';\n') ) text FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' ))); SET text := CONCAT(text, 'DELETE FROM ', table_name, '_tmp_trg;\nEND$\n'); ELSE SET text := CONCAT(text, 'DROP TEMPORARY TABLE ', table_name, '_tmp_trg;\nEND$\n'); END IF; RETURN text; END$ DROP FUNCTION IF EXISTS generate_triggers$ CREATE FUNCTION generate_triggers(p_table_name VARCHAR(200)) RETURNS TEXT BEGIN DECLARE table_name VARCHAR(200); DECLARE text TEXT; SET group_concat_max_len = 9000000; SET table_name := p_table_name; SET text := ''; SET text := (SELECT GROUP_CONCAT(generate_trigger(table_name, trigger_time, trigger_type) SEPARATOR '\n') FROM (SELECT 'BEFORE' trigger_time UNION ALL SELECT 'AFTER' trigger_time) trigger_time , (SELECT 'INSERT' trigger_type UNION ALL SELECT 'UPDATE' trigger_type UNION ALL SELECT 'DELETE' trigger_type ) trigger_type); RETURN text; END$</span></span></code> </pre> </div></div><br>  This is what code the generator will give us: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SHOW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> doc_pos; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> generate_triggers(<span class="hljs-string"><span class="hljs-string">'doc_pos'</span></span>);</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Trigger Generator Result</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`doc_pos`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`doc_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`mat_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kol_orig`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kol`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`price`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`delivery_date`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`comment`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`old_mat_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`doc_id`</span></span> (<span class="hljs-string"><span class="hljs-string">`doc_id`</span></span>,<span class="hljs-string"><span class="hljs-string">`mat_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`mat_id`</span></span> (<span class="hljs-string"><span class="hljs-string">`mat_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`doc_pos_ibfk_3`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`mat_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`materials`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`doc_pos_ibfk_1`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`doc_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`docs`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`doc_pos_ibfk_2`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`mat_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`materials`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">3137919</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">' '</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_bef_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_bef_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_tmp_trg ( <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , col_changed <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) , new_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , old_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , new_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , old_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , new_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , old_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , new_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_id := NEW.id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_doc_id := NEW.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_doc_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_mat_id := NEW.mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_mat_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol_orig := NEW.kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol_orig := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol := NEW.kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_price := NEW.price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_price := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_delivery_date := NEW.delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_delivery_date := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_comment := NEW.comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_comment := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_old_mat_id := NEW.old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_old_mat_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"I"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @new_id, @old_id, @new_doc_id, @old_doc_id, @new_mat_id, @old_mat_id, @new_kol_orig, @old_kol_orig, @new_kol, @old_kol, @new_price, @old_price, @new_delivery_date, @old_delivery_date, @new_comment, @old_comment, @new_old_mat_id, @old_old_mat_id); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> new_id, new_doc_id, new_mat_id, new_kol_orig, new_kol, new_price, new_delivery_date, new_comment, new_old_mat_id <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @new_id, @new_doc_id, @new_mat_id, @new_kol_orig, @new_kol, @new_price, @new_delivery_date, @new_comment, @new_old_mat_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.id := @new_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.doc_id := @new_doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.mat_id := @new_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.kol_orig := @new_kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.kol := @new_kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.price := @new_price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.delivery_date := @new_delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.comment := @new_comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.old_mat_id := @new_old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_aft_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"I"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.doc_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.mat_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.kol_orig, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.kol, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.price, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.delivery_date, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.comment, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.old_mat_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_bef_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_bef_upd_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_tmp_trg ( <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , col_changed <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) , new_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , old_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , new_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , old_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , new_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , old_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , new_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_id := NEW.id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_id := OLD.id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_doc_id := NEW.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_doc_id := OLD.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_mat_id := NEW.mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_mat_id := OLD.mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol_orig := NEW.kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol_orig := OLD.kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol := NEW.kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol := OLD.kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_price := NEW.price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_price := OLD.price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_delivery_date := NEW.delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_delivery_date := OLD.delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_comment := NEW.comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_comment := OLD.comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_old_mat_id := NEW.old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_old_mat_id := OLD.old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"U"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.doc_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.doc_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|doc_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|mat_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.kol_orig, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.kol_orig, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|kol_orig|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.kol, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.kol, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|kol|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.price, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.price, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|price|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.delivery_date, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.delivery_date, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|delivery_date|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.comment, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.comment, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|comment|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.old_mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.old_mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|old_mat_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>)), @new_id, @old_id, @new_doc_id, @old_doc_id, @new_mat_id, @old_mat_id, @new_kol_orig, @old_kol_orig, @new_kol, @old_kol, @new_price, @old_price, @new_delivery_date, @old_delivery_date, @new_comment, @old_comment, @new_old_mat_id, @old_old_mat_id); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> new_id, new_doc_id, new_mat_id, new_kol_orig, new_kol, new_price, new_delivery_date, new_comment, new_old_mat_id <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @new_id, @new_doc_id, @new_mat_id, @new_kol_orig, @new_kol, @new_price, @new_delivery_date, @new_comment, @new_old_mat_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.id := @new_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.doc_id := @new_doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.mat_id := @new_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.kol_orig := @new_kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.kol := @new_kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.price := @new_price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.delivery_date := @new_delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.comment := @new_comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.old_mat_id := @new_old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_aft_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_upd_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"U"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.doc_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.doc_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|doc_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|mat_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.kol_orig, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.kol_orig, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|kol_orig|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.kol, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.kol, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|kol|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.price, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.price, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|price|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.delivery_date, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.delivery_date, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|delivery_date|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.comment, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.comment, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|comment|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.old_mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.old_mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|old_mat_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>)), NEW.id, OLD.id, NEW.doc_id, OLD.doc_id, NEW.mat_id, OLD.mat_id, NEW.kol_orig, OLD.kol_orig, NEW.kol, OLD.kol, NEW.price, OLD.price, NEW.delivery_date, OLD.delivery_date, NEW.comment, OLD.comment, NEW.old_mat_id, OLD.old_mat_id); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_bef_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_bef_del_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> doc_pos_tmp_trg ( <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , col_changed <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) , new_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , old_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , new_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , old_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , new_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , old_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , new_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_id := OLD.id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_doc_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_doc_id := OLD.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_mat_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_mat_id := OLD.mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol_orig := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol_orig := OLD.kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol := OLD.kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_price := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_price := OLD.price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_delivery_date := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_delivery_date := OLD.delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_comment := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_comment := OLD.comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_old_mat_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_old_mat_id := OLD.old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"D"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @new_id, @old_id, @new_doc_id, @old_doc_id, @new_mat_id, @old_mat_id, @new_kol_orig, @old_kol_orig, @new_kol, @old_kol, @new_price, @old_price, @new_delivery_date, @old_delivery_date, @new_comment, @old_comment, @new_old_mat_id, @old_old_mat_id); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_aft_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_del_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"D"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.doc_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.mat_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.kol_orig, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.kol, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.price, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.delivery_date, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.comment, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.old_mat_id); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$</code> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"></span> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`doc_pos`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`doc_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`mat_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kol_orig`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kol`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`price`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`delivery_date`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`comment`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`old_mat_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`doc_id`</span></span> (<span class="hljs-string"><span class="hljs-string">`doc_id`</span></span>,<span class="hljs-string"><span class="hljs-string">`mat_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`mat_id`</span></span> (<span class="hljs-string"><span class="hljs-string">`mat_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`doc_pos_ibfk_3`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`mat_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`materials`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`doc_pos_ibfk_1`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`doc_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`docs`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`doc_pos_ibfk_2`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`mat_id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`materials`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">3137919</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">' '</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_bef_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_bef_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_tmp_trg ( <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , col_changed <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) , new_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , old_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , new_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , old_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , new_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , old_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , new_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_id := NEW.id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_doc_id := NEW.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_doc_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_mat_id := NEW.mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_mat_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol_orig := NEW.kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol_orig := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol := NEW.kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_price := NEW.price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_price := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_delivery_date := NEW.delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_delivery_date := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_comment := NEW.comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_comment := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_old_mat_id := NEW.old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_old_mat_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"I"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @new_id, @old_id, @new_doc_id, @old_doc_id, @new_mat_id, @old_mat_id, @new_kol_orig, @old_kol_orig, @new_kol, @old_kol, @new_price, @old_price, @new_delivery_date, @old_delivery_date, @new_comment, @old_comment, @new_old_mat_id, @old_old_mat_id); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> new_id, new_doc_id, new_mat_id, new_kol_orig, new_kol, new_price, new_delivery_date, new_comment, new_old_mat_id <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @new_id, @new_doc_id, @new_mat_id, @new_kol_orig, @new_kol, @new_price, @new_delivery_date, @new_comment, @new_old_mat_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.id := @new_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.doc_id := @new_doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.mat_id := @new_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.kol_orig := @new_kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.kol := @new_kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.price := @new_price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.delivery_date := @new_delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.comment := @new_comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.old_mat_id := @new_old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_aft_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"I"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.doc_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.mat_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.kol_orig, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.kol, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.price, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.delivery_date, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.comment, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, NEW.old_mat_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_bef_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_bef_upd_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_tmp_trg ( <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , col_changed <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) , new_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , old_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , new_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , old_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , new_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , old_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , new_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_id := NEW.id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_id := OLD.id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_doc_id := NEW.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_doc_id := OLD.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_mat_id := NEW.mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_mat_id := OLD.mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol_orig := NEW.kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol_orig := OLD.kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol := NEW.kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol := OLD.kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_price := NEW.price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_price := OLD.price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_delivery_date := NEW.delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_delivery_date := OLD.delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_comment := NEW.comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_comment := OLD.comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_old_mat_id := NEW.old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_old_mat_id := OLD.old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"U"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.doc_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.doc_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|doc_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|mat_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.kol_orig, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.kol_orig, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|kol_orig|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.kol, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.kol, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|kol|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.price, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.price, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|price|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.delivery_date, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.delivery_date, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|delivery_date|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.comment, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.comment, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|comment|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.old_mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.old_mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|old_mat_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>)), @new_id, @old_id, @new_doc_id, @old_doc_id, @new_mat_id, @old_mat_id, @new_kol_orig, @old_kol_orig, @new_kol, @old_kol, @new_price, @old_price, @new_delivery_date, @old_delivery_date, @new_comment, @old_comment, @new_old_mat_id, @old_old_mat_id); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> new_id, new_doc_id, new_mat_id, new_kol_orig, new_kol, new_price, new_delivery_date, new_comment, new_old_mat_id <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @new_id, @new_doc_id, @new_mat_id, @new_kol_orig, @new_kol, @new_price, @new_delivery_date, @new_comment, @new_old_mat_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.id := @new_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.doc_id := @new_doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.mat_id := @new_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.kol_orig := @new_kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.kol := @new_kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.price := @new_price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.delivery_date := @new_delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.comment := @new_comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NEW.old_mat_id := @new_old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_aft_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_upd_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"U"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.doc_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.doc_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|doc_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|mat_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.kol_orig, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.kol_orig, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|kol_orig|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.kol, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.kol, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|kol|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.price, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.price, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|price|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.delivery_date, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.delivery_date, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|delivery_date|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.comment, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.comment, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|comment|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.old_mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.old_mat_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">"|old_mat_id|"</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>)), NEW.id, OLD.id, NEW.doc_id, OLD.doc_id, NEW.mat_id, OLD.mat_id, NEW.kol_orig, OLD.kol_orig, NEW.kol, OLD.kol, NEW.price, OLD.price, NEW.delivery_date, OLD.delivery_date, NEW.comment, OLD.comment, NEW.old_mat_id, OLD.old_mat_id); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_bef_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_bef_del_trg <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> doc_pos_tmp_trg ( <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) , col_changed <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) , new_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_doc_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , new_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol_orig <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , old_kol <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) , new_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , old_price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) , new_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , old_delivery_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , new_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , old_comment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) , new_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) , old_old_mat_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_id := OLD.id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_doc_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_doc_id := OLD.doc_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_mat_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_mat_id := OLD.mat_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol_orig := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol_orig := OLD.kol_orig; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_kol := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_kol := OLD.kol; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_price := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_price := OLD.price; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_delivery_date := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_delivery_date := OLD.delivery_date; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_comment := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_comment := OLD.comment; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @new_old_mat_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @old_old_mat_id := OLD.old_mat_id; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"B"</span></span>, <span class="hljs-string"><span class="hljs-string">"D"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @new_id, @old_id, @new_doc_id, @old_doc_id, @new_mat_id, @old_mat_id, @new_kol_orig, @old_kol_orig, @new_kol, @old_kol, @new_price, @old_price, @new_delivery_date, @old_delivery_date, @new_comment, @old_comment, @new_old_mat_id, @old_old_mat_id); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_aft_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_del_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> this_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE this_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos_tmp_trg <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"D"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.doc_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.mat_id, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.kol_orig, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.kol, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.price, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.delivery_date, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.comment, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, OLD.old_mat_id); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> doc_pos_trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> doc_pos_tmp_trg; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$</code> </pre> </div></div><br>  And here‚Äôs a convenient query that checks that the trigger version is the most relevant and after adding the column we did not forget to regenerate the triggers, it can be inserted into the unit tests or even regenerate all the triggers automatically when building the application <br><br><div class="spoiler">  <b class="spoiler_title">Request to check for triggers</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(EVENT_OBJECT_TABLE, <span class="hljs-string"><span class="hljs-string">''</span></span>) msg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> EVENT_OBJECT_TABLE , <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(SUBSTRING_INDEX(gen_trg, <span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">'\n'</span></span>, T.ACTION_STATEMENT, <span class="hljs-string"><span class="hljs-string">'$'</span></span>, <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) ACTION_STATEMENT , gen_trg gen_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.ACTION_STATEMENT ACTION_STATEMENT , generate_trigger(T.EVENT_OBJECT_TABLE, T.ACTION_TIMING, T.EVENT_MANIPULATION) gen_trg , T.EVENT_OBJECT_TABLE <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> INFORMATION_SCHEMA.TRIGGERS T <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> T.TRIGGER_SCHEMA = <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span>() ) T ) T <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> T.ACTION_STATEMENT != T.gen_trg</code> </pre></div></div><br>  What do we get in the end?  The single entry point for all changes that make triggers - <b>&lt;table_name&gt; _trg_proc</b> <br><br>  Now we will rewrite our code for the new system: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   doc_pos DROP PROCEDURE IF EXISTS doc_pos_trg_proc$ CREATE PROCEDURE doc_pos_trg_proc() BEGIN DECLARE msg TEXT; --  .  . SET msg := (SELECT raise_error(CONCAT('  (id = ' , d.id, ').  .')) FROM doc_pos_tmp_trg dp INNER JOIN docs d ON d.id IN (dp.new_doc_id, dp.old_doc_id) WHERE d.closed = 1 AND dp.time = 'B' ); --   UPDATE doc_pos_tmp_trg INNER JOIN docs ON doc_pos_tmp_trg.new_doc_id = docs.id SET dp.new_price = get_price(dp.new_material_id, d.org_id_client) WHERE dp.time = 'B' AND dp.type = 'I'; --   UPDATE docs INNER JOIN doc_pos_tmp_trg ON docs.id IN (doc_pos_tmp_trg.new_doc_id, doc_pos_tmp_trg.old_doc_id) SET sum = IFNULL(docs.sum, 0) - CASE WHEN doc_pos_tmp_trg.old_doc_id = id THEN IFNULL(doc_pos_tmp_trg.old_kol * doc_pos_tmp_trg.old_price, 0) ELSE 0 END + CASE WHEN doc_pos_tmp_trg.new_doc_id = id THEN IFNULL(doc_pos_tmp_trg.new_kol * doc_pos_tmp_trg.new_price, 0) ELSE 0 END WHERE doc_pos_tmp_trg.time = 'A'; END$</span></span></code> </pre> <br>  There is less code, it is all in one place and it is not duplicated!  This code is very easy to maintain. <br><br>  I want to clarify a few points on implementation: <br><br><ul><li>  such an approach instead of native triggers, as in the first embodiment, gives some overhead. <br><br>  On the test data, almost without a ‚Äúuseful‚Äù load of 5000 lines, ~ 1.8s is inserted, <br>  in my case 5000 lines ~ 5.9s.  If you take out the creation of TEMPORARY TABLE and create <br>  Permanent table and slightly optimize the trigger was able to achieve the result of 5000 for 3.6c. <br><br>  But again, it is idle.  In real code, the share of costs for creating and inserting data in TEMPORARY TABLE will not exceed 20% <br><br><div class="spoiler">  <b class="spoiler_title">Many test queries</b> <div class="spoiler_text"><pre> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> test_doc_pos$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> test_doc_pos ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`doc_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`mat_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kol_orig`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kol`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`price`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`delivery_date`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`comment`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`old_mat_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`doc_id`</span></span> (<span class="hljs-string"><span class="hljs-string">`doc_id`</span></span>,<span class="hljs-string"><span class="hljs-string">`mat_id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`mat_id`</span></span> (<span class="hljs-string"><span class="hljs-string">`mat_id`</span></span>) ) $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> speed_test_doc_pos$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> speed_test_doc_pos(n <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> i <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; WHILE i &lt; n <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> test_doc_pos (doc_id, mat_id, kol, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (i, i, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'This is comment #'</span></span>, i)); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> i := i + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-comment"><span class="hljs-comment">--    5000 - 0.28c CALL speed_test_doc_pos(5000)$ -- Query OK, 1 row affected (0.28 sec) --  1    5000 - 1.8: DROP TRIGGER IF EXISTS test_doc_pos_bef_ins_trg$ CREATE TRIGGER `test_doc_pos_bef_ins_trg` BEFORE INSERT ON `test_doc_pos` FOR EACH ROW this_proc:BEGIN IF @disable_test_doc_pos_trg = 1 THEN LEAVE this_proc; END IF; SET @db_mode = 'edit'; SET NEW.price := (SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = DATABASE()); END $ DROP TRIGGER IF EXISTS test_doc_pos_aft_ins_trg$ CREATE TRIGGER `test_doc_pos_aft_ins_trg` AFTER INSERT ON `test_doc_pos` FOR EACH ROW this_proc:BEGIN IF @disable_test_doc_pos_trg = 1 THEN LEAVE this_proc; END IF; SET @db_mode = 'show'; END $ CALL speed_test_doc_pos(5000)$ -- Query OK, 1 row affected (1.88 sec) --  2 -    - 5000 - 5.9: DROP PROCEDURE IF EXISTS test_doc_pos_trg_proc$ CREATE PROCEDURE test_doc_pos_trg_proc() BEGIN SET @db_mode = (SELECT IF(time = 'B', 'edit', 'show') FROM test_doc_pos_tmp_trg); UPDATE test_doc_pos_tmp_trg SET new_price = (SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = DATABASE()); END$ -- SELECT generate_triggers('test_doc_pos')$ DROP TABLE IF EXISTS test_doc_pos_tmp_trg$ DROP TRIGGER IF EXISTS test_doc_pos_bef_ins_trg$ CREATE TRIGGER test_doc_pos_bef_ins_trg BEFORE INSERT ON test_doc_pos FOR EACH ROW this_proc:BEGIN IF @disable_test_doc_pos_trg = 1 THEN LEAVE this_proc; END IF; CREATE TEMPORARY TABLE IF NOT EXISTS test_doc_pos_tmp_trg ( time VARCHAR(1) , type VARCHAR(1) , col_changed VARCHAR(1000) , new_id int(11) , old_id int(11) , new_doc_id int(11) , old_doc_id int(11) , new_mat_id int(11) , old_mat_id int(11) , new_kol_orig decimal(10,3) , old_kol_orig decimal(10,3) , new_kol decimal(10,3) , old_kol decimal(10,3) , new_price decimal(17,7) , old_price decimal(17,7) , new_delivery_date date , old_delivery_date date , new_comment varchar(255) , old_comment varchar(255) , new_old_mat_id int(11) , old_old_mat_id int(11)) ENGINE=MEMORY; SET @new_id := NEW.id; SET @old_id := NULL; SET @new_doc_id := NEW.doc_id; SET @old_doc_id := NULL; SET @new_mat_id := NEW.mat_id; SET @old_mat_id := NULL; SET @new_kol_orig := NEW.kol_orig; SET @old_kol_orig := NULL; SET @new_kol := NEW.kol; SET @old_kol := NULL; SET @new_price := NEW.price; SET @old_price := NULL; SET @new_delivery_date := NEW.delivery_date; SET @old_delivery_date := NULL; SET @new_comment := NEW.comment; SET @old_comment := NULL; SET @new_old_mat_id := NEW.old_mat_id; SET @old_old_mat_id := NULL; INSERT INTO test_doc_pos_tmp_trg VALUES ("B", "I", NULL, @new_id, @old_id, @new_doc_id, @old_doc_id, @new_mat_id, @old_mat_id, @new_kol_orig, @old_kol_orig, @new_kol, @old_kol, @new_price, @old_price, @new_delivery_date, @old_delivery_date, @new_comment, @old_comment, @new_old_mat_id, @old_old_mat_id); CALL test_doc_pos_trg_proc; SELECT new_id, new_doc_id, new_mat_id, new_kol_orig, new_kol, new_price, new_delivery_date, new_comment, new_old_mat_id INTO @new_id, @new_doc_id, @new_mat_id, @new_kol_orig, @new_kol, @new_price, @new_delivery_date, @new_comment, @new_old_mat_id FROM test_doc_pos_tmp_trg; SET NEW.id := @new_id; SET NEW.doc_id := @new_doc_id; SET NEW.mat_id := @new_mat_id; SET NEW.kol_orig := @new_kol_orig; SET NEW.kol := @new_kol; SET NEW.price := @new_price; SET NEW.delivery_date := @new_delivery_date; SET NEW.comment := @new_comment; SET NEW.old_mat_id := @new_old_mat_id; DELETE FROM test_doc_pos_tmp_trg; END$ DROP TRIGGER IF EXISTS test_doc_pos_aft_ins_trg$ CREATE TRIGGER test_doc_pos_aft_ins_trg AFTER INSERT ON test_doc_pos FOR EACH ROW this_proc:BEGIN IF @disable_test_doc_pos_trg = 1 THEN LEAVE this_proc; END IF; INSERT INTO test_doc_pos_tmp_trg VALUES ("A", "I", NULL, NEW.id, NULL, NEW.doc_id, NULL, NEW.mat_id, NULL, NEW.kol_orig, NULL, NEW.kol, NULL, NEW.price, NULL, NEW.delivery_date, NULL, NEW.comment, NULL, NEW.old_mat_id, NULL); CALL test_doc_pos_trg_proc; DROP TEMPORARY TABLE test_doc_pos_tmp_trg; END$ CALL speed_test_doc_pos(5000)$ -- Query OK, 1 row affected (5.91 sec) --  3 -  - 5000 - 3.6c: DROP PROCEDURE IF EXISTS test_doc_pos_trg_proc$ CREATE PROCEDURE test_doc_pos_trg_proc() BEGIN SET @db_mode = (SELECT IF(time = 'B', 'edit', 'show') FROM test_doc_pos_tmp_trg); UPDATE test_doc_pos_tmp_trg SET new_price = (SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = DATABASE()); END$ SELECT generate_triggers('test_doc_pos')$ DROP TABLE IF EXISTS test_doc_pos_tmp_trg$ CREATE TABLE IF NOT EXISTS test_doc_pos_tmp_trg ( time VARCHAR(1) , type VARCHAR(1) , col_changed VARCHAR(1000) , new_id int(11) , old_id int(11) , new_doc_id int(11) , old_doc_id int(11) , new_mat_id int(11) , old_mat_id int(11) , new_kol_orig decimal(10,3) , old_kol_orig decimal(10,3) , new_kol decimal(10,3) , old_kol decimal(10,3) , new_price decimal(17,7) , old_price decimal(17,7) , new_delivery_date date , old_delivery_date date , new_comment varchar(255) , old_comment varchar(255) , new_old_mat_id int(11) , old_old_mat_id int(11)) ENGINE=MEMORY $ DROP TRIGGER IF EXISTS test_doc_pos_bef_ins_trg$ CREATE TRIGGER test_doc_pos_bef_ins_trg BEFORE INSERT ON test_doc_pos FOR EACH ROW this_proc:BEGIN IF @disable_test_doc_pos_trg = 1 THEN LEAVE this_proc; END IF; DELETE FROM test_doc_pos_tmp_trg; INSERT INTO test_doc_pos_tmp_trg VALUES ("B", "I", NULL, @new_id, NULL , NEW.doc_id, NULL , NEW.mat_id, NULL , NEW.kol_orig, NULL , NEW.kol, NULL , NEW.price, NULL , NEW.delivery_date, NULL , NEW.comment, NULL , NEW.old_mat_id, NULL ); CALL test_doc_pos_trg_proc; SELECT new_id, new_doc_id, new_mat_id, new_kol_orig, new_kol, new_price, new_delivery_date, new_comment, new_old_mat_id INTO @new_id, @new_doc_id, @new_mat_id, @new_kol_orig, @new_kol, @new_price, @new_delivery_date, @new_comment, @new_old_mat_id FROM test_doc_pos_tmp_trg; SET NEW.id := @new_id , NEW.doc_id := @new_doc_id , NEW.mat_id := @new_mat_id , NEW.kol_orig := @new_kol_orig , NEW.kol := @new_kol , NEW.price := @new_price , NEW.delivery_date := @new_delivery_date , NEW.comment := @new_comment , NEW.old_mat_id := @new_old_mat_id; DELETE FROM test_doc_pos_tmp_trg; END$ DROP TRIGGER IF EXISTS test_doc_pos_aft_ins_trg$ CREATE TRIGGER test_doc_pos_aft_ins_trg AFTER INSERT ON test_doc_pos FOR EACH ROW this_proc:BEGIN IF @disable_test_doc_pos_trg = 1 THEN LEAVE this_proc; END IF; INSERT INTO test_doc_pos_tmp_trg VALUES ("A", "I", NULL, NEW.id, NULL, NEW.doc_id, NULL, NEW.mat_id, NULL, NEW.kol_orig, NULL, NEW.kol, NULL, NEW.price, NULL, NEW.delivery_date, NULL, NEW.comment, NULL, NEW.old_mat_id, NULL); CALL test_doc_pos_trg_proc; DELETE FROM test_doc_pos_tmp_trg; -- DROP TEMPORARY TABLE test_doc_pos_tmp_trg; END$ CALL speed_test_doc_pos(5000)$ -- Query OK, 1 row affected (3.63 sec) --    DROP TABLE IF EXISTS test_doc_pos$ DROP PROCEDURE IF EXISTS speed_test_doc_pos$</span></span></code> </pre></div></div></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The table should be exactly MEMORY, with non-MEMORY tables, the losses will be quite noticeable. </font></font> And since<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table MEMORY, in it we do not process fields of type TEXT. </font></font><br><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you need to disable the trigger, for example, when importing data, you can raise the flag </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@disable_ &lt;table_name&gt; _trg</font></font></b> <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @disable_test_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </li></ul><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lack of AFTER STATEMENT TRIGGER </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The need to change the table at an event in the same table may arise in many cases. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, when changing the status (attribute) of a document, you need to create one or a chain of child documents. </font><font style="vertical-align: inherit;">When changing a branch of nested sets of trees, it is necessary to recalculate the left and right.</font></font><br><br>  I will give an example.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The task is, if there is a child document and the child document has a position change, then it is necessary to reduce the amount of relevant material at the main document. </font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a Production Plan in which there are many commodity items, when Write-off into production, a document is attached to the Plan and the plan is reduced by the corresponding amount. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ideally, I would like to write this code:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> doc_pos_trg_proc() <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-comment"><span class="hljs-comment">-- ... UPDATE doc_pos_tmp_trg INNER JOIN docs ON docs.id = doc_pos_tmp_trg.doc_id INNER JOIN doc_pos ON doc_pos.doc_id = docs.parent_doc_id AND doc_pos.material_id = doc_pos_tmp_trg.material_id SET doc_pos.kol = doc_pos.kol - IFNULL(doc_pos_tmp_trg.new_kol, 0) + IFNULL(doc_pos_tmp_trg.old_kol, 0) WHERE doc_pos_tmp_trg.time = 'A' ; END$</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But in the trigger it is forbidden to change the same table. </font><font style="vertical-align: inherit;">I solved this problem like this:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Created a table: </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`recursive_sql`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`sql_text`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`pid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`pid`</span></span> (<span class="hljs-string"><span class="hljs-string">`pid`</span></span>) )</code> </pre> <br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Created a procedure: </font></font><br><br><pre> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> recursive_sql$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> recursive_sql() <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> p_sql_text <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> p_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> p_cn <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> CONTINUE <span class="hljs-keyword"><span class="hljs-keyword">HANDLER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @no_data_found = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @no_data_found = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; cursor_loop: LOOP <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @reursive_sql_sql_text := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, p_id := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, p_sql_text := <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, sql_text <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> p_id, p_sql_text <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> recursive_sql <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span>; IF @no_data_found = 1 OR p_id IS NULL THEN LEAVE cursor_loop; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> recursive_sql <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = p_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @reursive_sql_sql_text := p_sql_text; <span class="hljs-keyword"><span class="hljs-keyword">PREPARE</span></span> c_sql <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> @reursive_sql_sql_text; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> c_sql; <span class="hljs-keyword"><span class="hljs-keyword">DEALLOCATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PREPARE</span></span> c_sql; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; <span class="hljs-comment"><span class="hljs-comment">--    SELECT COUNT(*) INTO p_cn FROM recursive_sql; IF p_cn &gt; 0 THEN CALL recursive_sql(); END IF; END$</span></span></code> </pre> <br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> At the PDO level, after each DML request, I call </font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> recursive_sql()</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Extra calls do not give almost any additional burden. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here are the tests recursive_sql</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> recursive_sql_speed_test$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> recursive_sql_speed_test() <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> x <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; WHILE x &lt;= 100000 <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> recursive_sql(); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> x = x + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> recursive_sql_speed_test()$ <span class="hljs-comment"><span class="hljs-comment">-- Query OK, 0 rows affected (9.24 sec) DROP PROCEDURE IF EXISTS recursive_sql_speed_test$</span></span></code> </pre> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Each call is ~ 0.1 ms. </font></font><br><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the trigger, if necessary, change the current table, form the SQL command and insert it into the recursive_sql table. </font><font style="vertical-align: inherit;">Ie our code will look like this:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_trg_proc$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> doc_pos_trg_proc() <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-comment"><span class="hljs-comment">-- ... INSERT INTO recursive_sql (sql_text) SELECT CONCAT('UPDATE doc_pos SET kol = ' , (doc_pos.kol - IFNULL(doc_pos_tmp_trg.new_kol, 0) + IFNULL(doc_pos_tmp_trg.old_kol, 0)) , ' WHERE id = ', doc_pos.id) sql_text FROM doc_pos_tmp_trg INNER JOIN docs ON docs.id = doc_pos_tmp_trg.doc_id INNER JOIN doc_pos ON doc_pos.doc_id = docs.parent_doc_id AND doc_pos.material_id = doc_pos_tmp_trg.material_id WHERE doc_pos_tmp_trg.time = 'A' ; END$</span></span></code> </pre> </li></ul><br><h2>  Total </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The resulting toolkit allows you to describe BL at the database level with the least amount of code, with maximum performance and efficiency. </font></font></div><p>Source: <a href="https://habr.com/ru/post/312134/">https://habr.com/ru/post/312134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312124/index.html">The benefits of using software-defined storage in a corporate environment</a></li>
<li><a href="../312126/index.html">How to optimize the memorization of foreign words</a></li>
<li><a href="../312128/index.html">Tender friendship of agents and exceptions in SObjectizer</a></li>
<li><a href="../312130/index.html">Success on autopilot. How to find a hobby, earn a lot of money on it and buy happiness</a></li>
<li><a href="../312132/index.html">"Everywhere at Home": What technologies does Airbnb use?</a></li>
<li><a href="../312136/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ231 (October 3 - 9, 2016)</a></li>
<li><a href="../312140/index.html">Cybersecurity games in Rio: how it was</a></li>
<li><a href="../312144/index.html">PHP Digest number 94 - interesting news, materials and tools (September 25 - October 9, 2016)</a></li>
<li><a href="../312146/index.html">Monitor client PCs in Microsoft AD with Zabbix. Part 2 - Template, Scripts and LLD</a></li>
<li><a href="../312148/index.html">We separate the interface and implementation in the functional style in C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>