<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connect and conquer. Unusual view of keep-alive</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most modern servers support keep-alive connections. If there is a lot of media content on the pages, then such a connection will significantly speed u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connect and conquer. Unusual view of keep-alive</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d41/331/52d/d4133152dbca4e528969995d3e2fa1c1.png"><br><br>  Most modern servers support keep-alive connections.  If there is a lot of media content on the pages, then such a connection will significantly speed up their loading.  But we will try to use keep-alive for less obvious tasks. <br><a name="habracut"></a><br><h4>  How it works </h4><br>  Before turning to non-standard methods of application, I will tell you how keep-alive works.  The process is really utterly simple - instead of a single request, several are sent in the connection, and several answers come from the server.  The advantages are obvious: less time is spent on establishing the connection, less load on the CPU and memory.  The number of requests in one connection is usually limited by the server settings (in most cases there are at least several dozen).  The connection setup is universal: <br><br>  1. In the case of the HTTP / 1.0 protocol, the first request should contain the ** Connection: keep-alive ** header. <br>  If HTTP / 1.1 is used, then this header may not exist at all, but some servers will automatically close connections that are not declared permanent.  Also, for example, the ** Expect: 100-continue ** header may interfere.  So it is recommended to force keep-alive to each request - this will help to avoid mistakes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/597/f0b/89a/597f0b89a77f4fad93f5a995eec26d6b.png"><br>  Expect forcibly closes connection <br><br>  2. When the keep-alive connection is specified, the server will search for the end of the first request.  If the request does not contain data, then the end is considered to be a double CRLF (these are the control characters \ r \ n, but often just two \ n will work).  The request is considered empty if it does not have Content-Length, Transfer-Encoding headers, and also if these headers have zero or incorrect content.  If they are and have the correct value, then the end of the request is the last byte of the content of the declared length. <br><br><img src="https://habrastorage.org/files/a9d/bc8/66f/a9dbc866f73b4c0f8f1756d4a930213e.png"><br>  For the last byte of the announced content can immediately go next request <br><br>  3. If after the first request there are additional data, then the corresponding steps 1 and 2 are repeated for them, and so on, until well-formed queries end. <br><br>  Sometimes even after the correct completion of the request, the keep-alive scheme does not work out due to the undefined magic features of the server and the script the request is addressed to.  In such a case, forced initialization of the connection can help by sending the first HEAD request. <br><br><img src="https://habrastorage.org/files/23e/013/3af/23e0133af3874d978108ec784f74cad8.png"><br>  The HEAD request starts the keep-alive sequence. <br><br><h4>  Thirty one or one thirty? </h4><br>  No matter how funny it sounds, but the first and most obvious profit is the ability to accelerate with some types of web application scanning.  Let us examine a simple example: we need to check a specific XSS vector in an application consisting of ten scenarios.  Each script takes three parameters. <br><br>  I nakodil a small script in Python, which runs through all the pages and checks all the parameters one by one, and then displays the vulnerable scripts or parameters (let's make four vulnerable points) and the time spent on scanning. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket, time, re print(<span class="hljs-string"><span class="hljs-string">"\n\nScan is started...\n"</span></span>) s_time = time.time() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pg_n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> prm_n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>): s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.connect((<span class="hljs-string"><span class="hljs-string">"host.test"</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>)) req = <span class="hljs-string"><span class="hljs-string">"GET /page"</span></span>+str(pg_n)+<span class="hljs-string"><span class="hljs-string">".php?param"</span></span>+str(prm_n)+<span class="hljs-string"><span class="hljs-string">"=&lt;script&gt;alert('xzxzx:page"</span></span>+str(pg_n)+<span class="hljs-string"><span class="hljs-string">":param"</span></span>+str(prm_n)+<span class="hljs-string"><span class="hljs-string">":yzyzy')&lt;/script&gt; HTTP/1.1\r\nHost: host.test\r\nConnection: close\r\n\r\n"</span></span> s.send(req) res = s.recv(<span class="hljs-number"><span class="hljs-number">64000</span></span>) pattern = <span class="hljs-string"><span class="hljs-string">"&lt;script&gt;alert('xzxzx"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> res.find(pattern)!=<span class="hljs-number"><span class="hljs-number">-1</span></span>: print(<span class="hljs-string"><span class="hljs-string">"Vulnerable page"</span></span>+str(pg_n)+<span class="hljs-string"><span class="hljs-string">":param"</span></span>+str(prm_n)) s.close() print(<span class="hljs-string"><span class="hljs-string">"\nTime: %s"</span></span> % (time.time() - s_time))</code> </pre> <br>  We try.  As a result, the execution time was 0.690999984741. <br><br><img src="https://habrastorage.org/files/7ab/630/c18/7ab630c188e94542b1247500ebb5ab90.png"><br>  Local test without keep-alive <br><br>  And now we try the same, but with a remote resource, the result is 3.0490000248. <br><br>  Not bad, but we try to use keep-alive - we rewrite our script so that it will send all thirty requests in one connection, and then parse the answer to pull out the necessary values. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket, time, re print(<span class="hljs-string"><span class="hljs-string">"\n\nScan is started...\n"</span></span>) s_time = time.time() req = <span class="hljs-string"><span class="hljs-string">""</span></span> s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.connect((<span class="hljs-string"><span class="hljs-string">"host.test"</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pg_n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> prm_n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>): req += <span class="hljs-string"><span class="hljs-string">"GET /page"</span></span>+str(pg_n)+<span class="hljs-string"><span class="hljs-string">".php?param"</span></span>+str(prm_n)+<span class="hljs-string"><span class="hljs-string">"=&lt;script&gt;alert('xzxzx:page"</span></span>+str(pg_n)+<span class="hljs-string"><span class="hljs-string">":param"</span></span>+str(prm_n)+<span class="hljs-string"><span class="hljs-string">":yzyzy')&lt;/script&gt; HTTP/1.1\r\nHost: host.test\r\nConnection: keep-alive\r\n\r\n"</span></span> req += <span class="hljs-string"><span class="hljs-string">"HEAD /page0.php HTTP/1.1\r\nHost: host.test\r\nConnection: close\r\n\r\n"</span></span> s.send(req) <span class="hljs-comment"><span class="hljs-comment"># Timeout for correct keep-alive time.sleep(0.15) res = s.recv(640000000) pattern = "&lt;script&gt;alert('xzxzx" strpos = 0 if res.find(pattern)!=-1: for z in range(0,res.count(pattern)): strpos = res.find(pattern, strpos+1) print("Vulnerable "+res[strpos+21:strpos+33]) s.close() print("\nTime: %s" % (time.time() - s_time))</span></span></code> </pre><br>  We try to run locally: the result is 0.167000055313.  We launch keep-alive for a remote resource, leaves 0,393999814987. <br><br>  And this despite the fact that I had to add 0.15 seconds to avoid problems with sending the request to Python.  Very tangible difference, is not it?  And when thousands of such pages? <br><br>  Of course, advanced products do not scan into one stream, but server settings may limit the number of allowed threads.  And in general, if you distribute requests correctly, then with a constant connection, the load will be less and the result will be obtained faster.  In addition, tasks Penterster are different, and often for them have to write custom scripts. <br><br><h4>  Injection shot </h4><br>  Perhaps one of such frequent routine tasks can be ranked character-by-character promotion of blind SQL injections.  If we are not afraid of the server - and it is unlikely to be worse than if we twist character-by-character or binary search in several streams - then you can use keep-alive and here - to get maximum results with the minimum number of connections. <br><br>  The principle is simple: we collect requests with all characters in one package and send.  If the answer is found to match the condition true, then it will only be true to parse it to get the number of the desired character by the number of a successful answer. <br><br><img src="https://habrastorage.org/files/80b/237/c60/80b237c602a340be879f21cadbe20b6f.png"><br>  We collect one package with all symbols and look for the fulfilled condition in the answer. <br><br>  This may again be useful if the number of threads is limited or it is not possible to use other methods that speed up the process of sorting characters. <br><br><h4>  Unseen circumstances </h4><br>  Since the server in the case of a keep-alive connection does not wake up additional threads for processing requests, but methodically executes requests in the order of a queue, we can achieve the least delay between two requests.  In certain circumstances, this could be useful for the operation of logical errors such as Race Condition.  Although that this can not be done with multiple parallel threads?  Nevertheless, here is an example of an exceptional situation, possible only through keep-alive. <br>  Let's try to change the file in Tomcat via java script: <br><br><img src="https://habrastorage.org/files/4c6/9c5/3d6/4c69c53d6f4449af83f9a6d839a44160.png"><br>  File changed, no problems <br><br>  All OK, and the script, and the server see that the file has changed.  And now we add to our sequence a keep-alive request to the contents of the file before a change request ‚Äî the server does not want to put up with the change. <br><br><img src="https://habrastorage.org/files/4c9/099/846/4c9099846ce2487da37cdf8c94268e74.png"><br>  The server does not want to put up with treason <br><br>  The script (it should be noted that the OS also) perfectly sees that the file has changed.  But the server ... Tomcat will give out the same file value for another five seconds before replacing it with the current one. <br><br>  In a complex web application, this allows you to achieve a ‚Äúrace‚Äù: one part refers to not yet updated information from the server, and the other has already received new values.  In general, now you know what to look for. <br><br><h4>  How to stop time </h4><br>  Finally, I will give a curious example of using this technique - stopping time.  More precisely, its slowdown. <br><br>  Let's take a look at the principle of operation of the Apache_httpd mod_auth_basic module.  Authorization of the Basic type is as follows: first it is checked whether an account exists with the user name given in the request.  Then, if such an entry exists, the server calculates a hash for the transmitted password and verifies it with the hash in the account.  Hash calculation requires a certain amount of system resources, so the answer comes with a delay of a couple of milliseconds more than if the user name did not find a match (in fact, the result very much depends on the server configuration, its capacity, and sometimes the location of stars in the sky).  If there is an opportunity to see the difference between requests, then it would be possible to sort through logins in the hope of getting those that are exactly in the system.  However, in the case of ordinary requests, it is almost impossible to track the difference even in the local network. <br><br>  To increase the delay, you can send a password of greater length, in my case, when transferring a password of 500 characters, the difference between the timeouts increased to 25 ms.  In terms of direct connection, it is possible that it is already possible to operate, but it is not suitable for access via the Internet at all. <br><br><img src="https://habrastorage.org/files/951/853/775/9518537759c94653b16db4d6142a36c2.png"><br>  The difference is too small <br><br>  And here our favorite keep-alive mode comes to the rescue, in which all requests are executed sequentially one after the other, which means that the total delay is multiplied by the number of requests in the connection.  In other words, if we can send 100 requests in one packet, then with a password of 500 characters, the delay increases to 2.5 seconds.  This is quite enough for an error-free selection of logins via remote access, not to mention the local network. <br><br><img src="https://habrastorage.org/files/5e6/3dc/e7b/5e63dce7b8034376be977a76cd10ef19.png"><br>  Kraftim sequence of identical requests <br><br>  The last request in keep-alive is better to close the connection using ** Connection: close **.  So we will get rid of unnecessary time-out in 5 seconds (depending on settings), during which the server waits for the sequence to continue.  I sketched a small script for this. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket, base64, time print(<span class="hljs-string"><span class="hljs-string">"BASIC Login Bruteforce\n"</span></span>) logins = (<span class="hljs-string"><span class="hljs-string">"abc"</span></span>,<span class="hljs-string"><span class="hljs-string">"test"</span></span>,<span class="hljs-string"><span class="hljs-string">"adm"</span></span>,<span class="hljs-string"><span class="hljs-string">"root"</span></span>,<span class="hljs-string"><span class="hljs-string">"zzzzz"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> login <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> logins: s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.connect((<span class="hljs-string"><span class="hljs-string">"host.test"</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>)) cred = base64.b64encode(login+<span class="hljs-string"><span class="hljs-string">":"</span></span>+(<span class="hljs-string"><span class="hljs-string">"a"</span></span>*<span class="hljs-number"><span class="hljs-number">500</span></span>)) payload = <span class="hljs-string"><span class="hljs-string">"HEAD /prvt/ HTTP/1.1\r\nHost: host.test\r\nAuthorization: Basic "</span></span>+str(cred)+<span class="hljs-string"><span class="hljs-string">"\r\n\r\n"</span></span> multipayload = payload * <span class="hljs-number"><span class="hljs-number">100</span></span> start_time = time.time() s.send(multipayload) r = s.recv(<span class="hljs-number"><span class="hljs-number">640000</span></span>) print(<span class="hljs-string"><span class="hljs-string">"For "</span></span>+login+<span class="hljs-string"><span class="hljs-string">" = %s sec"</span></span> % (time.time() - start_time)) s.close()</code> </pre><br>  Even in this case, it makes sense to use HEAD everywhere to ensure the passage of the entire sequence. <br><br>  Run! <br><br><img src="https://habrastorage.org/files/063/17d/8f7/06317d8f7a8344d6bc6fe459a2fecdeb.png"><br>  Now we can get logins <br><br>  What was required to prove - keep-alive can be useful not only to speed up, but also to slow down the response.  It is also possible that a similar trick will fail when comparing strings or characters in web applications or simply to better track the time-outs of any operations. <br><br><h4>  Fin </h4><br>  In fact, the range of applications of permanent compounds is much broader.  With such connections, some servers begin to behave differently than usual, and you may stumble upon curious logical errors in architecture or catch funny bugs.  In general, it is a useful tool that can be kept in the arsenal and periodically used.  Stay tuned! <br><br><blockquote><h4>  From the author </h4><br>  In my daily work, I most often used BurpSuite, but for actual operation it would be much easier to sketch a simple script in any convenient language.  It is also worth noting that the mechanisms for establishing connections in different languages ‚Äã‚Äãproduce unexpectedly different results for different servers - for example, Python sockets were not able to properly run Apache httpd version 2.4, but they work fine on branch 2.2.  So if something does not work, you should try another client. </blockquote><br><img src="https://habrastorage.org/getpro/habr/post_images/f7b/153/c18/f7b153c18e47620075b1db37ae011fce.jpg" alt="image"><br><br>  <i>First published in Hacker Magazine # 196.</i> <i><br></i>  <i>Posted by: Simon Rozhkov, <a href="https://twitter.com/sam_in_cube">@sam_in_cube</a> (Positive Technologies)</i> <br><br>  Subscribe to "Hacker" <br><ul><li>  <a href="https://xakep.ru/wp-admin/profile.php%3Fpage%3Dpaywall_subscribes">Site materials</a> </li><li>  <a href="http://bit.ly/habr_subscribe_paper">Paper version</a> </li><li>  <a href="http://bit.ly/xakep_on_ipad">Hacker on iOS / iPad</a> </li><li>  <a href="http://bit.ly/habr_android">"Hacker" on Android</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/259845/">https://habr.com/ru/post/259845/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259833/index.html">Spatial navigation and not only in the assembly Vivaldi 1.0.196.2</a></li>
<li><a href="../259835/index.html">Work with texture compression in Unity3D + NGUI</a></li>
<li><a href="../259839/index.html">OS Development on Go + asm Part 0x01</a></li>
<li><a href="../259841/index.html">How I found the best programming language in the world. Part 2</a></li>
<li><a href="../259843/index.html">Under the press. Break and protect Wordpress with your own hands</a></li>
<li><a href="../259847/index.html">Model rover MSL Curiosity</a></li>
<li><a href="../259849/index.html">The crash of the satellite Express-MD1 (July 4, 2013)</a></li>
<li><a href="../259853/index.html">Swift 2.0 will be open source at the end of the year.</a></li>
<li><a href="../259855/index.html">Multidimensional Mtree Tree</a></li>
<li><a href="../259857/index.html">Development of a large scalable web 2.0 project from scratch (social network for 100 million users) - an interview with the leading master class at DevConf 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>