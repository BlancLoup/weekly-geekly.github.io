<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dynamic call queues in Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear readers of this site. 
 Today I would like to tell you about the strange way queue management in asterisk. 
 So. 

 Given: 
 1. a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dynamic call queues in Asterisk</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear readers of this site. <br>  Today I would like to tell you about the strange way queue management in asterisk. <br>  So. <br><br>  Given: <br>  1. asterisk1.8.32.3 server <br>  2. sip clients (35 numbers).  Two-digit numbering.  The first number is 11, the last is 46. <br>  3. Call queues.  When you receive a call to a landline number, the menu is pronounced and you are prompted to click on the numbers from 1 to 4. When you click, the call is transferred to the queue 1, 2, 3 or 4, respectively. <br><a name="habracut"></a><br>  What queues.conf looks like now: <br>  [queue-1] <br>  music = default <br>  strategy = linear <br>  timeout = 10 <br>  wrapuptime = 0 <br>  ringinuse = yes <br>  periodic-announce-frequency = 30 <br>  joinempty = no <br>  leavewhenempty = no <br>  announce-position = no <br>  announce-holdtime = no <br>  announce-frequency = 0 <br>  member =&gt; SIP / 24 <br>  member =&gt; SIP / 25 <br>  member =&gt; SIP / 17 <br>  member =&gt; SIP / 23 <br>  member =&gt; SIP / 21 <br>  member =&gt; SIP / 18 <br><br>  [queue-2] <br>  music = default <br>  strategy = linear <br>  timeout = 10 <br>  wrapuptime = 0 <br>  ringinuse = yes <br>  periodic-announce-frequency = 30 <br>  joinempty = no <br>  leavewhenempty = no <br>  announce-position = no <br>  announce-holdtime = no <br>  announce-frequency = 0 <br>  member =&gt; SIP / 18 <br>  member =&gt; SIP / 21 <br>  member =&gt; SIP / 23 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      [queue-3] <br>  music = default <br>  strategy = linear <br>  timeout = 10 <br>  wrapuptime = 0 <br>  ringinuse = yes <br>  periodic-announce-frequency = 30 <br>  joinempty = no <br>  leavewhenempty = no <br>  announce-position = no <br>  announce-holdtime = no <br>  announce-frequency = 0 <br>  member =&gt; SIP / 37 <br>  member =&gt; SIP / 35 <br>  member =&gt; SIP / 31 <br>  member =&gt; SIP / 33 <br>  member =&gt; SIP / 34 <br>  member =&gt; SIP / 32 <br><br>  [queue-4] <br>  music = default <br>  strategy = linear <br>  timeout = 10 <br>  wrapuptime = 0 <br>  ringinuse = yes <br>  periodic-announce-frequency = 30 <br>  joinempty = no <br>  leavewhenempty = no <br>  announce-position = no <br>  announce-holdtime = no <br>  announce-frequency = 0 <br>  member =&gt; SIP / 24 <br>  member =&gt; SIP / 25 <br>  member =&gt; SIP / 37 <br>  member =&gt; SIP / 18 <br>  member =&gt; SIP / 32 <br><br>  That is, we see that the queue file is set statically.  Numbers are added / removed manually and after each change of the file it is necessary to do queue reload all.  That is, you need to go to the asterisk server in the console, say, then asterisk -vvvvvvvvvvvr and type this command. <br><br>  Task: <br><br>  Make members add to the queue dynamically.  And the composition of the queue would be determined by the contents of the corresponding table in mysql. <br>  I.e.  The composition of the queue is determined by mysql. <br>  Accordingly, the data in the mysql table can be entered via the mysql console or through any other muscle access program.  For example, I wrote my ‚Äúprogram‚Äù using LAMP to read and modify the corresponding table with queues. <br><br>  Decision: <br><br>  1. Create a table in some kind of mysql database.  I will not describe the process of creating a table, just give an example of my worksheet. <br>  mysql&gt; desc queue; <br>  + ------------ + -------------- + ------ + ----- + -------- - + ---------------- + <br>  |  Field |  Type |  Null |  Key |  Default |  Extra | <br>  + ------------ + -------------- + ------ + ----- + -------- - + ---------------- + <br>  |  id |  int (11) |  NO |  PRI |  NULL |  auto_increment | <br>  |  priznak |  int (1) |  YES |  |  NULL |  | <br>  |  queue |  varchar (100) |  YES |  |  NULL |  | <br>  |  sip |  varchar (100) |  YES |  |  NULL |  | <br>  |  sort_queue |  int (2) |  YES |  |  NULL |  | <br>  + ------------ + -------------- + ------ + ----- + -------- - + ---------------- + <br><br>  and the data of the table itself: <br>  mysql&gt; select * from queue; <br>  + ---- + --------- + --------- + -------- + ------------ + <br>  |  id |  priznak |  queue |  sip |  sort_queue | <br>  + ---- + --------- + --------- + -------- + ------------ + <br>  |  1 |  1 |  queue-1 |  SIP / 24 |  4 | <br>  |  2 |  1 |  queue-1 |  SIP / 17 |  2 | <br>  |  3 |  1 |  queue-1 |  SIP / 23 |  3 | <br>  |  4 |  0 |  queue-1 |  SIP / 21 |  4 | <br>  |  5 |  1 |  queue-1 |  SIP / 25 |  1 | <br>  |  6 |  1 |  queue-1 |  SIP / 18 |  6 | <br>  |  7 |  1 |  queue-2 |  SIP / 18 |  1 | <br>  |  8 |  0 |  queue-2 |  SIP / 21 |  2 | <br>  |  9 |  1 |  queue-2 |  SIP / 23 |  2 | <br>  |  10 |  1 |  queue-3 |  SIP / 37 |  1 | <br>  |  11 |  1 |  queue-3 |  SIP / 35 |  2 | <br>  |  12 |  1 |  queue-3 |  SIP / 31 |  3 | <br>  |  13 |  1 |  queue-3 |  SIP / 33 |  4 | <br>  |  14 |  1 |  queue-3 |  SIP / 34 |  5 | <br><br>  I will explain the table fields. <br>  Id - key. <br>  Priznak - 0/1.  Accordingly, if 0, then this number does not participate in the queue <br>  queue - the name of the queue <br>  sip - sip account. <br>  sort_queue is the order in which SIP accounts will participate in dialing.  Let's say in the queue queue it is necessary that the SIP / 25 number be the first to call, then SIP / 17, etc. <br><br>  2. Now we configure asterisk itself to work with queues in this form. <br>  I want to warn you that here I am using a dial plan written in AEL.  Mostly because the AEL syntax is close to C ++.  And the cycles on AEL are much more convenient to write and they are better read. <br><br>  Create file extensions.ael <br>  I will not write "specifics" about how an incoming call goes to asterisk and what happens next with it, I will just say that when you click on the 1,2,3 or 4 button, the context described in extensions.ael is called. <br><br>  Now the contents of the file itself with comments: <br>  push-1 =&gt; { <br>  // answer the call <br>  answer (); <br>  // connect to mysql <br>  MYSQL (Connect connid 192.168.1.1 server user passwd); <br>  // in the loop, remove all membes from the queue.  Rooms remember from 11 to 46 inclusive. <br>  for (x = 11; $ {x} &lt;= 46; x = $ {x} +1) { <br>  // deletion itself.  Team asterisk'a. <br>  RemoveQueueMember (queue-1, SIP / $ {x}); <br>  }; <br><br>  // then make a query from the table.  We are looking for how many positions will be found in our request.  We are looking for how many members have the sign "1", that is, participating in the queue. <br>  MYSQL (Query resultid $ {connid} select count (*) as co from queue where queue = 'queue-1' and priznak = 1 order by sort_queue); <br>  MYSQL (fetch fetchid $ {resultid} co); <br><br>  // it may happen that there is only one number in the queue at the moment.  We cannot know in advance how many numbers will be in the queue and the process of sampling data from the table by an asterisk will be different.  That is, if one match is found, then the sample will be described as follows, and if it is somewhat different.  Therefore, we check how many matches are found. <br>  // if there are more than one matches, then we make a request (we need a sip field) with the ‚Äú1‚Äù sign and sorting by the ‚Äúsort_queue‚Äù field. <br>  if ($ {co}&gt; 1) { <br><br>  MYSQL (Query resultid $ {connid} select sip from queue where queue = 'queue-1' and priznak = 1 order by sort_queue); <br>  MYSQL (fetch fetchid $ {resultid} sip); <br>  // add the first found number by the AddQueueMember command. <br><br>  // for general development.  If the values ‚Äã‚Äãfound in the table are more than one, then first we do something with the first (MYSQL (fetch fetchid $ {resultid} sip);), and then all the others in a loop (MYSQL (NextResult resultid $ {connid}); <br>  MYSQL (fetch fetchid $ {resultid} sip_next);) <br><br>  AddQueueMember (queue-1, $ {sip}); <br><br>  // then do a search in the loop for the remaining results and add them to the queue accordingly using the AddQueueMember command <br>  for (x = 1; $ {x} &lt;$ {co}; x = $ {x} +1) { <br><br>  MYSQL (NextResult resultid $ {connid}); <br>  MYSQL (fetch fetchid $ {resultid} sip_next); <br>  AddQueueMember (queue-1, $ {sip_next}); <br>  }; <br>  } <br>  // if the result is one thing, then we make a request and add the found number to the queue with the command AddQueueMember (queue-1, $ {sip}); <br>  else { <br><br>  MYSQL (Query resultid $ {connid} select sip from queue where queue = 'queue-1' order by sort_queue); <br>  MYSQL (fetch fetchid $ {resultid} sip); <br>  AddQueueMember (queue-1, $ {sip}); <br>  }; <br><br>  // then clear the result of the query and disconnect. <br>  MYSQL (Clear $ {resultid}); <br>  MYSQL (Disconnect $ {connid}); <br><br>  // actually here we run the queue. <br>  queue (queue-1, Ct ,,, 300); <br>  }; <br><br>  We make changes to the table and the PBX on the next call of the queue considers those numbers that are needed.  Let's say that some number would not participate in the telephone call you have to put it a sign "0". <br><br>  For other queues all the same, only the name of the queue changes. <br><br>  Look like that's it. <br><br>  Just want to say that the deletion / addition cycle is completed in 1-2 seconds, which is normal in my case (no delays) <br><br>  I also tried working with queues using extconfig.conf.  This file describes what we can work with through mysql.  That is, all the parameters of the queue will not be in the file, but in mysql.  For me personally, the file is much easier and easier to read, so I did not use this option. <br><br>  Now the queues.conf file looks like this: <br>  [queue-1] <br>  music = default <br>  strategy = linear <br>  timeout = 10 <br>  wrapuptime = 0 <br>  ringinuse = yes <br>  periodic-announce-frequency = 30 <br>  joinempty = no <br>  leavewhenempty = no <br>  announce-position = no <br>  announce-holdtime = no <br>  announce-frequency = 0 <br><br>  [queue-2] <br>  music = default <br>  strategy = linear <br>  timeout = 10 <br>  wrapuptime = 0 <br>  ringinuse = yes <br>  periodic-announce-frequency = 30 <br>  joinempty = no <br>  leavewhenempty = no <br>  announce-position = no <br>  announce-holdtime = no <br>  announce-frequency = 0 <br><br>  [queue-3] <br>  music = default <br>  strategy = linear <br>  timeout = 10 <br>  wrapuptime = 0 <br>  ringinuse = yes <br>  periodic-announce-frequency = 30 <br>  joinempty = no <br>  leavewhenempty = no <br>  announce-position = no <br>  announce-holdtime = no <br>  announce-frequency = 0 <br><br>  [queue-4] <br>  music = default <br>  strategy = linear <br>  timeout = 10 <br>  wrapuptime = 0 <br>  ringinuse = yes <br>  periodic-announce-frequency = 30 <br>  joinempty = no <br>  leavewhenempty = no <br>  announce-position = no <br>  announce-holdtime = no <br>  announce-frequency = 0 <br>  All settings of the queue itself are stored in a file, and members are added dynamically. <br><br>  That's all.  Thank. </div><p>Source: <a href="https://habr.com/ru/post/258565/">https://habr.com/ru/post/258565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258553/index.html">Hewlett-Packard Webinars</a></li>
<li><a href="../258555/index.html">How I left the university to develop my own game. Part 1</a></li>
<li><a href="../258557/index.html">Video conferencing: the future is here</a></li>
<li><a href="../258559/index.html">Where is the paradise or funny cases from Apple Review Team</a></li>
<li><a href="../258561/index.html">Rip out sms from GOIP for PHP</a></li>
<li><a href="../258567/index.html">Are you a mammoth? (Friday test; which is a lie, but a hint in it)</a></li>
<li><a href="../258569/index.html">Results of the project competition with the Aviasales API</a></li>
<li><a href="../258571/index.html">Optical compensation</a></li>
<li><a href="../258573/index.html">Image and video analysis. Detection of text on images</a></li>
<li><a href="../258575/index.html">Why Windows Phone has become the best platform to launch the game "Torque"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>