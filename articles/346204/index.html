<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oracle upgrade experience 11.2.0.4 to 12c</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All welcome. I am a representative of the billing systems development department in the regional telecoms operator. I want to share the experience of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oracle upgrade experience 11.2.0.4 to 12c</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/zm/gs/tp/zmgstpkwujxe18yjp8y3luhsx3y.jpeg"><br><br>  All welcome.  I am a representative of the billing systems development department in the regional telecoms operator.  I want to share the experience of upgrading Oracle to version 12c (12.2.0.1) <br>  (For some reason, many people confuse the upgrade process with migration, it <a href="https://habrahabr.ru/company/oracle/blog/268089/">is</a> clearly written <a href="https://habrahabr.ru/company/oracle/blog/268089/">here</a> when and in what cases to use this or that value).  All events took place last year. <br><br><h3>  Organizational events </h3><br>  From the beginning of the year, we began organizational preparatory work, first of all it was necessary to deploy a test zone.  No, we had a test zone, only Oracle was deployed in it under SUSE.  And in the Oracle industrial environment, we are installed on servers with the IA-64 platform, and HP-UX as an OS, while the deployment of HP-UX in a virtual environment turned out to be another quest ‚Äî HP-UX as a guest OS is supported only by one VM ‚Äî Integrity Virtual Machines, which should be installed on a server with the same architecture.  As a result, we decided to carry out work on the production standby-db-server. <br><a name="habracut"></a><br>  The second step was to configure the HP-UX OS ( <a href="https://docs.oracle.com/database/121/HIDQI/toc.htm">as recommended by Oracle</a> ).  Taking into account that we have neither a ‚Äútest zone‚Äù nor a TP on HP-UX, we began to look for an HP-UX specialist who would undertake this work with regard to risks.  There were no such specialists among the familiar ones, they started calling HP managers.  Of course, the dialogue with the manager was reduced to the acquisition of technical support, otherwise there is nothing to talk about. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The last time we spent the calculation of the cost of technical support for HP (hardware and software) about 5 years ago.  For the sake of interest, I requested an assessment of the cost of TP  For the cost that was provided to us, you can deploy a small data center, and plus technical support for all for 3 years, so the issue of its acquisition has disappeared. <br><br>  We tried to consider options with technical support only for software, with limited TP for the period of work, we were looking for a system integrator, a stale second-hand Itanium server, as a test zone, but all to no avail. <br><br>  As a result, a specialist from the supplier of billing responded, for which he thanks a lot. <br>  The OS settings were made, as stated above, on a standby-db-server.  Oracle itself was updated on the test zone under SUSE.  There were no problems.  Encouraged by the result, we planned an upgrade in the industrial zone on the night of October 24 to 25, taking into account that by the beginning of the next working day everything had to work (according to our ideal plan). <br><br><h3>  Preparing for the upgrade process </h3><br>  We started training on the afternoon of October 24, together with the DBA sent to us. <br>  The required parameters were set, extraordinary backups were set up, some ‚Äúheavy‚Äù tables were cleared.  Next stop services, business processes, job-s and so on.  In general, the preparation took almost the whole day, the update process itself began around 12 at night and ended at 4 in the morning.  After we started to start everything in the reverse order, it was about 6 am, we were already mentally at home, ready to go to bed, but it was not there.  All services are running, except for the application server.  We found out that his service refused to start due to the fact that the version of the Oracle Client (10) was lower than the server one, it was necessary to update all the servers where the client part was lower than the acceptable version.  Updated - earned. <br><br>  It turned out it was only a small of problems.  During the validation of business processes.  found that the subscriber profile server functionality is broken.  When accessing certain data, an error ORA-00600 [qmcxdGetQNameInfo2] popped up, which, in fact, was the root of the problem.  We opened the service request (SR) in Oracle support in the status of ‚ÄúSeverity 2‚Äù, in parallel we looked for possible solutions to the problem.  The situation was tense with the fact that we could neither register subscribers, nor maintain: a subscriber service system (SBMS), during subscriber registration could not create a profile, CRM also did not function. <br><br>  By evening, the load subsided, and the situation returned to normal.  In addition, we have a solution to the problem.  We found that errors occur only when referring to fields of type XML TYPE.  At the same time, the XDB component (Oracle XML DB) was valid.  It was decided to try setting the COMPATIBLE parameter to a value of 12.2, which was at that time still in the value of 11.2, since the <a href="https://docs.oracle.com/database/122/UPGRD/what-is-oracle-database-compatibility.htm">Database Upgrade Guide</a> on version 12.2 says: <b>compatibility level is not possible after you raise the COMPATIBLE initialization parameter value</b> .  those.  after setting this parameter to the corresponding value, the return to the previous version becomes impossible.  But in another Oracle document (Doc ID 1292089.1) there is the following remark: <b>... after the upgrade, you must set the database compatibility to at least 12.1.0.1.</b>  <b>If the compatibility is less than 12.1.0.1, it is an error.</b>  So we decided to try to fix the situation by donating the possibility of a downgrade.  But, as it turned out, this decision did not bring results.  After that, we postponed the solution of the problem until the morning, since the lack of sleep affected, and it was more difficult to think with each passing hour.  In addition, it was necessary to wait for a response from the Oracle support. <br><br><h3>  Solving the main problem (BUG 26814058) </h3><br>  On the morning of October 26, we received a response from Oracle, which identified the problem as: <b>unpublished BUG 26814058 - SELECT FROM TABLE WITH XMLTYPE FAILS WITH ORA-600 [QMCXDGETQNAMEINFO2]</b> , which is classified as a ‚ÄúCode / Hardware Bug‚Äù in status 11. Bug is relatively fresh (registered September 16), moreover on the previous version (12.1).  Neither the patch nor the workaround existed for him at that time (possibly for the current one).  Status 11 indicates that work is underway on a patch, but at the same time no precise release dates for the patch can be obtained from Oracle, even if they release it in a couple of days.  They raised the level of our SR to "Severity 1", but there was no hope for a quick solution from Oracle.  It was necessary to make a decision - to return to version 11 or try to fix what is. <br><br>  The second day without subscriber service affected, so we decided to wait for the night and roll back to version 11, using a standby-db-server, because we could not return using the standard downgrade procedure because of the COMPATIBLE parameter.  After consulting and analyzing the tables, it turned out that a significant part of the services did not work, but all of them were tied to the server profiles (GUP).  Moreover, it was possible to localize the problem to two problem tables.  Particularly difficult was one of them, since it was more than 10 million.  records (about 4GB).  The error occurred both when trying to process the data of fields of type XML TYPE, and when trying to export data from tables.  The operation ‚Äúcreate table ... as select ...‚Äù took place, but did not give a result, the data in the new table were also damaged. <br><br>  We decided to try to extract the data from the standby-db-server using the DATA PUMP, which was in the state "BEFORE the update".  But it turned out that the data there is also damaged.  The fact is that in preparation for the upgrade, XDB was reassembled in one of the steps in accordance with the Oracle recommendations.  Presumably, the data in the XML TYPE columns is damaged as a result of this particular operation, which, by the way, occurs directly when upgrading to Oracle 12.2, since starting from version 12 the XDB component becomes mandatory and it is no longer possible to reinstall it.  However, the update instruction requires that all database components be valid at the time of the update, otherwise they should be reinstalled. Thus, by the end of the working day, the problem was reduced to the search for the possibility of extracting intact table data. <br><br><h3>  Conclusion </h3><br>  At the most critical moment, when we tried all the options and nothing helped, we were rescued by a backup from a standby-db-server, which a colleague did before starting the update on October 24th.  It was possible, through RMAN, to partially restore (only the required table spaces) standby DB at the time ‚Äúbefore rebuilding XDB‚Äù and extract the necessary data.  After that, using DATA PUMP, the problem tables were exported from standby to the main-db-server.  This operation was completed at about 2 am on October 27th.  After that, the functionality of the GUP server was restored.  Despite the fact that the data in the restored table is outdated in time, the table was relevant, since all attempts to process the damaged data ended in failure.  Those.  in fact, the database was in the read-only state and the data in it did not change from the moment ‚Äúbefore the update‚Äù. <br><br>  If there is a test zone, perhaps we would identify this problem at the preparatory stage for the upgrade, but since Oracle classified the BUG as a ‚ÄúCode / Hardware Bug‚Äù, a match was required not only by Oracle versions and user data, but also by platform and version OS that was not possible. <br><br>  Do not forget to backup, good luck to all. </div><p>Source: <a href="https://habr.com/ru/post/346204/">https://habr.com/ru/post/346204/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346194/index.html">How to identify and develop talents in IT</a></li>
<li><a href="../346196/index.html">Vim: Search Javascript documentation</a></li>
<li><a href="../346198/index.html">How I Parsil Habr, Part 1: Trends</a></li>
<li><a href="../346200/index.html">What's wrong with Telegram or 5 controversial UX / UI solutions that can be fixed in it</a></li>
<li><a href="../346202/index.html">Tuning toolchain for Arduino for continuing</a></li>
<li><a href="../346206/index.html">Clustering and visualization of textual information</a></li>
<li><a href="../346210/index.html">On-Premise vs. Cloud IaaS - advantages and disadvantages</a></li>
<li><a href="../346214/index.html">First contact with ‚Äúvar‚Äù in Java 10</a></li>
<li><a href="../346216/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ296 (January 1 - 7, 2018)</a></li>
<li><a href="../346218/index.html">11 libraries (sets of components) for Angular, which is worth knowing in 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>