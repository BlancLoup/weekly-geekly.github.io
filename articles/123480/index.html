<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Postsharp. We solve the problem of caching</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes there are situations in which there is no way to speed up the work of some operation. It may depend on some service, which is located on an ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Postsharp. We solve the problem of caching</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/99a4481e/dd743101/9f6f944c/c8829c51.png" align="left">  Sometimes there are situations in which there is no way to speed up the work of some operation.  It may depend on some service, which is located on an external web server, or it may be an operation that gives a high load on the processor.  Or it can be fast operations, however, their parallel work can suck all performance resources out of your computer.  There are many reasons to use caching.  It should be noted that <a href="http://www.sharpcrafters.com/">PostSharp</a> does not initially provide any caching framework for you, it just allows you to do this task orders of magnitude faster, without any tedious actions, such as arranging the code responsible for caching all the program source code.  It allows you to solve this problem elegantly, bringing tasks to classes and allowing them to be reused. <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/49e/3f7/e8a/49e3f7e8a62aff6c154a4aba4953c1be.gif"><br><img src="https://habrastorage.org/getpro/habr/post_images/afa/19d/045/afa19d045b2bce238895a5f2856f9174.gif"><br>  Suppose I want to know on the website of the car dealership how much the cars that are for sale in this car show are worth.  To do this, I will use an application that will download the price list of the cabin from the server, which is designed for cars of a certain brand, model and year of manufacture.  If the values ‚Äã‚Äãof the price list (as part of our example) change too often, I will use the web service to get the values ‚Äã‚Äãof this price list.  Let the web service be too slow, and I want to request too many cars.  As you understand, I cannot make someone else‚Äôs web service faster, but I can cache the returned data from the store, thus reducing the number of requests. <br>  Since one of the main features of PostSharp is to ‚Äúintercept‚Äù a method call, i.e.  introduction to the method in such a way that we can execute our code both before and after the work of the method body, we will use this framework to implement the caching task: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black">[ <font color="#2B91AF">Serializable</font> ] <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> CacheAttribute : MethodInterceptionAspect <br> { <br> [NonSerialized] <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">readonly</font> ICache _cache; <br> <font color="#0000ff">private</font> <font color="#0000ff">string</font> _methodName; <br> <br> <font color="#0000ff">static</font> CacheAttribute() <br> { <br> <font color="#0000ff">if</font> (!PostSharpEnvironment.IsPostSharpRunning) <br> { <br> <font color="#008000">// one minute cache</font> <br> _cache = <font color="#0000ff">new</font> StaticMemoryCache( <font color="#0000ff">new</font> <font color="#2B91AF">TimeSpan</font> (0, 1, 0)); <br> <font color="#008000">// use an IoC container/service locator here in practice</font> <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> CompileTimeInitialize(MethodBase method, AspectInfo aspectInfo) <br> { <br> _methodName = method.Name; <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> OnInvoke(MethodInterceptionArgs args) <br> { <br> <font color="#0000ff">var</font> key = BuildCacheKey(args.Arguments); <br> <font color="#0000ff">if</font> (_cache[key] != <font color="#0000ff">null</font> ) <br> { <br> args.ReturnValue = _cache[key]; <br> } <br> <font color="#0000ff">else</font> <br> { <br> <font color="#0000ff">var</font> returnVal = args.Invoke(args.Arguments); <br> args.ReturnValue = returnVal; <br> _cache[key] = returnVal; <br> } <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">string</font> BuildCacheKey(Arguments arguments) <br> { <br> <font color="#0000ff">var</font> sb = <font color="#0000ff">new</font> <font color="#2B91AF">StringBuilder</font> (); <br> sb.Append(_methodName); <br> <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> argument <font color="#0000ff">in</font> arguments.ToArray()) <br> { <br> sb.Append(argument == <font color="#0000ff">null</font> ? <font color="#A31515">"_"</font> : argument.ToString()); <br> } <br> <font color="#0000ff">return</font> sb.ToString(); <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br><br>  I save the name of the method at compile time and initialize the caching service at run-time.  As a key for caching, I will use the name of the method, as well as the values ‚Äã‚Äãof all method parameters, separated by spaces (see the code for the BuildCacheKey method), which will be unique for each method and each parameter set.  In the OnInvoke method, I check if the received key exists in the cache, and use the value from the cache if the key already exists.  Otherwise, I call the code of the original method to put in the cache the result of the work until the next call. <br>  In my example, there is a GetCarValue method that is designed to simulate a web service call to get information about a car.  This method has parameters that can take very different values, so it can return different results each time it is called (in our example, only in those cases where the cached value is missing): <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black">[Cache] <br> <font color="#0000ff">public</font> <font color="#0000ff">decimal</font> GetCarValue( <font color="#0000ff">int</font> year, CarMakeAndModel carType) <br> { <br> <font color="#008000">// simulate web service time</font> <br> Thread.Sleep(_msToSleep); <br> <br> <font color="#0000ff">int</font> yearsOld = <font color="#2B91AF">Math</font> .Abs( <font color="#2B91AF">DateTime</font> .Now.Year - year); <br> <font color="#0000ff">int</font> randomAmount = ( <font color="#0000ff">new</font> <font color="#2B91AF">Random</font> ()).Next(0, 1000); <br> <font color="#0000ff">int</font> calculatedValue = baselineValue - (yearDiscount*yearsOld) + randomAmount; <br> <font color="#0000ff">return</font> calculatedValue; <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br>  A few notes about this aspect: <br><ul><li>  I could also use OnMethodBoundaryAspect instead of MethodInterceptionAspect: both approaches would be correct.  Just in this case, I chose MethodInterceptionAspect to simplify my choice by covering the program requirements. </li><li>  Remember that since there is no point in loading and initializing the cache while PostSharp is running (not while the application is running), we must check whether PostSharp is running or not.  Another way to load dependencies is to place the code in RuntimeInitialize. </li><li>  This aspect does not make it possible to use the 'out' and 'ref' parameters in caching tasks.  Of course, it is possible to do this, but it seems to me that the 'out' and 'ref' parameters should not be used in such tasks, and if you agree with me, let's not waste time on their implementation. </li></ul><br><h4>  Checks at compile time </h4><br>  There are always options when caching is not a good idea.  For example, when the method returns Stream, IEnumerable, IQueryable, etc. <br>  interfaces.  Therefore, such values ‚Äã‚Äãcannot be cached.  To do such checks, you need to override the CompileTimeValidate method, for example, like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">bool</font> CompileTimeValidate(MethodBase method) <br> { <br> <font color="#0000ff">var</font> methodInfo = method <font color="#0000ff">as</font> MethodInfo; <br> <font color="#0000ff">if</font> (methodInfo != <font color="#0000ff">null</font> ) <br> { <br> <font color="#0000ff">var</font> returnType = methodInfo.ReturnType; <br> <font color="#0000ff">if</font> (IsDisallowedCacheReturnType(returnType)) <br> { <br> Message.Write(SeverityType.Error, <font color="#A31515">"998"</font> , <br> <font color="#A31515">"Methods with return type {0} cannot be cached in {1}.{2}"</font> , <br> returnType.Name, _className, _methodName); <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">readonly</font> IList DisallowedTypes = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> <br> { <br> <font color="#0000ff">typeof</font> ( <font color="#2B91AF">Stream</font> ), <br> <font color="#0000ff">typeof</font> ( <font color="#2B91AF">IEnumerable</font> ), <br> <font color="#0000ff">typeof</font> (IQueryable) <br> }; <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">bool</font> IsDisallowedCacheReturnType(Type returnType) <br> { <br> <font color="#0000ff">return</font> DisallowedTypes.Any(t =&gt; t.IsAssignableFrom(returnType)); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br><br>  Thus, if any developer tries to apply caching to methods that should not be cached, he will receive a compile error message.  By the way, if you use IsAssignableFrom for some type, you also cover the classes and interfaces that come from it.  Those.  in our case, such types as FileStream, IEnumerable, etc. will also be covered. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Multitasking </h4><br>  Great, at this stage we already have a great solution to add caching to all methods that need it.  However, have you thought about one potential problem hidden in this caching aspect?  In multitasking applications (such as a website), caching does an excellent job with its work, because after the first ‚Äúuser‚Äù accesses the cache, each subsequent ‚Äúuser‚Äù extracts all creams from using the cache access speed.  However, what happens when two users try to get the same information at the same time?  In the caching aspect that we just developed, this will mean that both users will at least calculate the same cache value.  For a car shop website this is not very relevant, however, if you have a web server with a load of hundreds or thousands of visitors requesting the same information at the same time, the problem of caching arises very importantly.  If they all make requests at the same time, our cache will constantly calculate the same values. <br><br>  A simple solution to solve this problem is to use ‚Äúlock‚Äù every time the cache is used.  However, blocking is an expensive and slow operation, and it is better if we first check for the existence of a key in the cache, and only then block it.  However, in this case, there is a possibility that several threads will simultaneously be checked for the absence of a key in the cache and go to the calculation of this key, so we must check the existence of the key twice ( <a href="http://en.wikipedia.org/wiki/Double-checked_locking">double-checked locking</a> ), outside the locked code and inside it: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="black">[ <font color="#2B91AF">Serializable</font> ] <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> CacheAttribute : MethodInterceptionAspect <br> { <br> [NonSerialized] <font color="#0000ff">private</font> <font color="#0000ff">object</font> syncRoot; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> RuntimeInitialize(MethodBase method) <br> { <br> syncRoot = <font color="#0000ff">new</font> <font color="#0000ff">object</font> (); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> OnInvoke(MethodInterceptionArgs args) <br> { <br> <font color="#0000ff">var</font> key = BuildCacheKey(args.Arguments); <br> <font color="#0000ff">if</font> (_cache[key] != <font color="#0000ff">null</font> ) <br> { <br> args.ReturnValue = _cache[key]; <br> } <br> <font color="#0000ff">else</font> <br> { <br> <font color="#0000ff">lock</font> (syncRoot) <br> { <br> <font color="#0000ff">if</font> (_cache[key] == <font color="#0000ff">null</font> ) <br> { <br> <font color="#0000ff">var</font> returnVal = args.Invoke(args.Arguments); <br> args.ReturnValue = returnVal; <br> _cache[key] = returnVal; <br> } <br> <font color="#0000ff">else</font> <br> { <br> args.ReturnValue = _cache[key]; <br> } <br> } <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font></font></a> .</code> </blockquote> <br><br>  It looks like a little repetition, but in this case, it is an excellent solution to improve performance for high-load solutions.  Instead of blocking the cache, I block some private object that is specific only to the method to which the aspect is applied.  All this leads to minimizing the number of locks when using the cache. <br>  I hope you are not confused?  Problems of parallel execution of tasks can be confusing to many, but in many applications this is a reality.  Armed with this aspect, you no longer have to worry about your own mistakes or the mistakes of developers with a small amount of experience.  Either about the mistakes of new developers or developers with 30 years of experience in developing on COBOL and seeing C # for the first time :).  In fact, they need to know how to frame methods with the ‚ÄúCache‚Äù aspect, and they do not need to know how this technology should be implemented.  And they do not need to know how to make their methods flow safe.  They will be able to concentrate only on their own piece of code, without being distracted by the implementation of related tasks. <br><br>  References: <br><ul><li>  Product Website: <a href="http://www.sharpcrafters.com/">www.sharpcrafters.com</a> </li><li>  Site of original article: <a href="http://www.sharpcrafters.com/blog/post/5-Ways-That-Postsharp-Can-%250A%2509SOLIDify-Your-Code-Caching.aspx">5 Ways That PostSharp can SOLIDfy Your Code: Caching</a> </li><li>  Full example source code: <a href="https://github.com/mgroves/PostSharp5">GitHub</a> </li><li>  <a href="http://habrahabr.ru/blogs/net/123480/">We solve the problem of caching</a> </li><li>  <a href="http://software.intel.com/ru-ru/blogs/2010/03/09/postsharp-i/">Intel blogs: PostSharp.</a>  <a href="http://software.intel.com/ru-ru/blogs/2010/03/09/postsharp-i/">Part 1</a> </li><li>  <a href="http://software.intel.com/ru-ru/blogs/2010/03/16/postsharp/">Intel blogs: PostSharp.</a>  <a href="http://software.intel.com/ru-ru/blogs/2010/03/16/postsharp/">Alternatives</a> </li><li>  <a href="http://habrahabr.ru/blogs/net/123186/">Aspect-oriented programming vs Dependency Injection</a> </li><li>  <a href="http://habrahabr.ru/blogs/net/124860/">PostSharp.</a>  <a href="http://habrahabr.ru/blogs/net/124860/">Problem solving logging and auditing</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/123480/">https://habr.com/ru/post/123480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123467/index.html">Unlock for iPhone 4</a></li>
<li><a href="../123469/index.html">WaterSpout - web server for asynchronous data transfer</a></li>
<li><a href="../123473/index.html">Estimation of the number of errors in the program. Double evaluation, Historical experience</a></li>
<li><a href="../123474/index.html">SNORT as a service IPS</a></li>
<li><a href="../123477/index.html">Introducing Oracle Siebel CRM</a></li>
<li><a href="../123484/index.html">Testers! All on Ciklum QA Subbotnik (July 16)!</a></li>
<li><a href="../123485/index.html">New efficiency record for solar cells</a></li>
<li><a href="../123489/index.html">DataRetriever - a service for collecting and analyzing data from online media and social networks</a></li>
<li><a href="../123490/index.html">Web interface for iptables</a></li>
<li><a href="../123491/index.html">MS SQL 2011 - New Offset Operator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>