<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a "non-standard" custom object for AutoCAD that works without Object Enabler</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 
 Those who deal with AutoCAD and third-party solutions for it, for sure, faced with the problem of proxy objects, to display or move which ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a "non-standard" custom object for AutoCAD that works without Object Enabler</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br>  Those who deal with AutoCAD and third-party solutions for it, for sure, faced with the problem of proxy objects, to display or move which you want to install the libraries with which these objects were created or the so-called <b>Objects Enablers</b> , from the same developers.  This is quite inconvenient.  For example, you received a document from a customer / subcontractor and you see only squares. <br><br>  I want to share with you my personal experience in creating an ‚Äúunconventional‚Äù object for AutoCAD.  Based on an anonymous block.  Object properties are stored separately in <b>BlockReference :: ExtensionDictionary.</b>  This allows a third-party application or script to access and read them, and, if desired, change them, without the presence of original libraries.  Primitives inside the block are always drawn according to their state.  Anyway, the stability of the work of AutoCAD is much higher.  From the side it looks simple.  But when trying to implement this mechanism, various ‚Äúpitfalls‚Äù were identified.  About this in order. <br><a name="habracut"></a><br><br>  First you need to implement <b>Jig</b> , inherited from <b>EntityJig</b> - to set the order of data entry necessary to create an object.  In it we must determine how many states we need, in my case it looks like this: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> MyJigState { EnteringBasePoint, EnteringEndPoint, Done }</code> </pre> <br>  The main methods of this class will be <b>Update ()</b> and <b>Sampler ()</b> in the end I got this class: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyJig</span></span> : <span class="hljs-title"><span class="hljs-title">EntityJig</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> MyJigState { EnteringBasePoint, EnteringEndPoint, Done } MyJigState _state = MyJigState.EnteringBasePoint; PointSampler _basePoint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PointSampler(AcGe.Point3d.Origin); PointSampler _endPoint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PointSampler(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AcGe.Point3d(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); LevelMark _levelMark; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyJig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LevelMark levelmark, BlockReference reference</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">reference</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._levelMark = levelmark; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Document doc = Autodesk.AutoCAD.ApplicationServices.Application.DocumentManager.MdiActiveDocument; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (DocumentLock dl = doc.LockDocument(DocumentLockMode.ProtectedAutoWrite, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transaction = Acad.TransactionManager.StartTransaction()) { BlockReference reference = (BlockReference)transaction.GetObject(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Entity.Id, OpenMode.ForWrite, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); reference.Erase(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); reference.Position = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._levelMark.InsertionPoint; reference.BlockUnit = Acad.Database.Insunits; transaction.Commit(); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._levelMark.UpdateEntities(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._levelMark.BlockRecord.UpdateAnonymousBlocks(); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (System.Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MyJigState State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._state; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._state = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> SamplerStatus </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sampler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JigPrompts prompts</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (_state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MyJigState.EnteringBasePoint: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _basePoint.Acquire(prompts, <span class="hljs-string"><span class="hljs-string">"\n  :"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> =&gt; { Matrix3d ucs = Acad.Editor.CurrentUserCoordinateSystem; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._levelMark.InsertionPoint = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MyJigState.EnteringEndPoint: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _endPoint.Acquire(prompts, <span class="hljs-string"><span class="hljs-string">"\n  :"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> =&gt; { Matrix3d ucs = Acad.Editor.CurrentUserCoordinateSystem; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._levelMark.EndPoint = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SamplerStatus.NoChange; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SamplerStatus.NoChange; } } }</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I inherited the main object class from EntityOverride and redefined Entities: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Lazy&lt;AcDb.Line&gt; line = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;AcDb.Line&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AcDb.Line(Point3d.Origin, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point3d(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Lazy&lt;AcDb.Polyline&gt; simbolPoly = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;AcDb.Polyline&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AcDb.Polyline()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Lazy&lt;AcDb.Polyline&gt; arrowPoly = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;AcDb.Polyline&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AcDb.Polyline()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Lazy&lt;AcDb.MText&gt; text = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;AcDb.MText&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AcDb.MText()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Lazy&lt;AcDb.MText&gt; note = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;AcDb.MText&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AcDb.MText()); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> IEnumerable&lt;AcDb.Entity&gt; Entities { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> line.Value; <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> simbolPoly.Value; <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arrowPoly.Value; <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text.Value; <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> note.Value; } }</code> </pre><br><br>  What makes it possible not to sweat about drawing objects included in the block.  Also in this class, I implemented a function that, upon request, recalculates the position and distribution of primitives inside the block. <br><br>  After creating an instance of our class, a function is called to create a <b>BlockReference</b> , which is immediately deleted. <b>Erase (true)</b> - this makes it possible, when the input is interrupted, to automatically delete an object while saving the file. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BlockReference </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateBlock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> LevelMark lm, ObjectContextCollection occ, ObjectId layerId</span></span></span><span class="hljs-function">)</span></span> { ObjectId id; BlockReference reference; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (AcAp.Application.DocumentManager.MdiActiveDocument.LockDocument()) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transaction = Acad.TransactionManager.StartTransaction()) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blockTable = Acad.Database.BlockTableId.Write&lt;AcDb.BlockTable&gt;()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blockId = blockTable.Add(lm.BlockRecord); reference = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AcDb.BlockReference(lm.InsertionPoint, blockId); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modelSpace = Acad.Database.CurrentSpaceId<span class="hljs-comment"><span class="hljs-comment">/*modelSpaceId*/</span></span>.Write&lt;AcDb.BlockTableRecord&gt;()) { Matrix3d ucs = Acad.Editor.CurrentUserCoordinateSystem; reference.TransformBy(ucs); id = modelSpace.AppendEntity(reference); ResultBuffer xData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ResultBuffer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypedValue[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypedValue((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)DxfCode.ExtendedDataRegAppName, MyPlugin.CurrentDictionaryName), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypedValue((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)DxfCode.ExtendedDataAsciiString, <span class="hljs-string"><span class="hljs-string">"This is a "</span></span> + MyPlugin.CurrentDictionaryName) }); reference.XData = xData; reference.LayerId = layerId; xData.Dispose(); } transaction.AddNewlyCreatedDBObject(reference, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); reference.Erase(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); transaction.AddNewlyCreatedDBObject(lm.BlockRecord, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } transaction.Commit(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { lm.BlockId = id; lm.UpdateParameters(id); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> reference; }</code> </pre><br><br>  Along the way, this function places in <b>XData the</b> information that this is our object - for later searching among other blocks. <br><br>  It seems that with the creation of the object itself everything is simple (although on the way to this a couple of times I had to change the approach to the implementation).  The first difficulties arose with the addition of their grip to the block (pens) and their management, as well as with the abolition of changes. <br>  Having done everything according to the Autodesk documentation, having inherited the GripOverrule grip class, I had difficulties.  They consisted in the fact that I lost the opportunity to undo the changes made to the object.  Therefore, I had to create a second copy based on the data from the original and carry out changes with it, and if a positive result is achieved, transfer all changes to the parent object.  And also had to use TransientManager.  Everything would be fine, but it turned out that the <b>object</b> instance ( <b>Entity</b> ) is passed as null to the overridden function <b>MoveGripPointsAt</b> , which resulted in the creation of a custom class <b>GripData</b> , which stores the object <b>Id</b> in it. <br><br>  The next stone was the simultaneous change of a large number of objects at the same time.  I guessed it before.  But not on such a scale.  The object property panel is implemented through a standard mechanism, and it assumes work through Com (in AutoCAD 2013, it seemed to have been carried to ARX), plus, closing transactions after changing an object turned out to be insanely long.  Also, the constant challenge of redrawing an object with standard tools turned out to be unsatisfying to needs, in terms of speed.  For these reasons, it was decided to use LISP functions that work much faster.  But this resulted in the work of finding and wrapping them in a normal form.  It is worth noting here that some of them are platform dependent. <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"acad.exe"</span></span></span><span class="hljs-meta">, CallingConvention = CallingConvention.Cdecl)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acedNEntSelP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] name, Point2d p3, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, Matrix3d p4, IntPtr p5</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ResultBuffer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NEntSelP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p1, ObjectId id, Point2d p3, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, Matrix3d p4, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ResultBuffer p5</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] adsName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (acdbGetAdsName(adsName, id) != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IntPtr ip = acedNEntSelP(p1, adsName, p3, p, p4, p5.UnmanagedObject); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ip != IntPtr.Zero) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResultBuffer.Create(ip, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } [DllImport(<span class="hljs-string"><span class="hljs-string">"acad.exe"</span></span>, CallingConvention = CallingConvention.Cdecl)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acdbEntGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] name</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ResultBuffer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EntGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ObjectId id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] adsName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (acdbGetAdsName(adsName, id) != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IntPtr ip = acdbEntGet(adsName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ip != IntPtr.Zero) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResultBuffer.Create(ip, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } [DllImport(<span class="hljs-string"><span class="hljs-string">"acdb18.dll"</span></span>, CallingConvention = CallingConvention.Cdecl)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acdbGetObjectId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ObjectId objId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] name</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"acad.exe"</span></span>, CallingConvention = CallingConvention.Cdecl)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acdbEntMakeX</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr resBuf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] adsName</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ObjectId </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EntMakeX</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ResultBuffer resBuf</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] adsName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ip = acdbEntMakeX(resBuf.UnmanagedObject, adsName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ip == RTNORM) { ObjectId objId = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ObjectId(); acdbGetObjectId(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> objId, adsName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> objId; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ObjectId.Null; } } [DllImport(<span class="hljs-string"><span class="hljs-string">"acad.exe"</span></span>, CallingConvention = CallingConvention.Cdecl)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acdbEntDel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] name</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EntDel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ObjectId id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] adsName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (acdbGetAdsName(adsName, id) != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RTERROR; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acdbEntDel(adsName); } [DllImport(<span class="hljs-string"><span class="hljs-string">"acad.exe"</span></span>, CallingConvention = CallingConvention.Cdecl)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acdbDictAdd</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] dictName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> symName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] objName</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DictAdd</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ObjectId dictNameId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> symName, ObjectId objNameId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] dictName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (acdbGetAdsName(dictName, dictNameId) != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RTERROR; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] objName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (acdbGetAdsName(objName, objNameId) != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RTERROR; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] srcb = System.Text.UnicodeEncoding.Unicode.GetBytes(symName); System.Text.ASCIIEncoding ue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Text.ASCIIEncoding(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> dst = ue.GetString(srcb); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acdbDictAdd(dictName, dst, objName); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> RTNORM = <span class="hljs-number"><span class="hljs-number">5100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> RTERROR = <span class="hljs-number"><span class="hljs-number">-5001</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> WIN32 [DllImport("acdb18.dll", CallingConvention = CallingConvention.Cdecl, EntryPoint = "?acdbGetAdsName@@YA?AW4ErrorStatus@Acad@@AAY01JVAcDbObjectId@@@Z")] public static extern int acdbGetAdsName(long[] objName, ObjectId objId); //public static extern Autodesk.AutoCAD.Runtime.ErrorStatus acdbGetAdsName(out long adsName, ObjectId id); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> [DllImport("acdb18.dll", CallingConvention = CallingConvention.Cdecl, EntryPoint = "?acdbGetAdsName@@YA?AW4ErrorStatus@Acad@@AEAY01_JVAcDbObjectId@@@Z")] public static extern int acdbGetAdsName(long[] objName, ObjectId objId); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> [DllImport("acad.exe", CallingConvention = CallingConvention.Cdecl)] public static extern int acdbEntUpd(long[] ent); public static long[] GetAdsName(ObjectId id) { long[] adsName = new long[1]; acdbGetAdsName(adsName, id); return adsName; } public static bool EntityUpdate(long[] adsName) { return (acdbEntUpd(adsName) == RTNORM); } public static bool EntityUpdate(ObjectId id) { long[] adsName = new long[1]; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (acdbGetAdsName(adsName, id) != 0) return false; return (acdbEntUpd(adsName) == RTNORM); } [DllImport("acad.exe", CallingConvention = CallingConvention.Cdecl)] private static extern int acdbEntMod(System.IntPtr resbuf); public static int EntMod(ResultBuffer resultBuffer) { return acdbEntMod(resultBuffer.UnmanagedObject); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> WIN32 [DllImport("acad.exe", CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl, EntryPoint = "?acedSetStatusBarProgressMeter@@YAHPB_WHH@Z")] public static extern int acedSetStatusBarProgressMeter(string label, int minPos, int maxPos); [DllImport("acad.exe", CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl, EntryPoint = "?acedSetStatusBarProgressMeterPos@@YAHH@Z")] public static extern int acedSetStatusBarProgressMeterPos(int pos); [DllImport("acad.exe", CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl, EntryPoint = "?acedRestoreStatusBar@@YAXXZ")] public static extern int acedRestoreStatusBar(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> [DllImport("acad.exe", CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl, EntryPoint = "?acedSetStatusBarProgressMeter@@YAHPEB_WHH@Z")] public static extern int acedSetStatusBarProgressMeter(string label, int minPos, int maxPos); [DllImport("acad.exe", CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl, EntryPoint = "?acedSetStatusBarProgressMeterPos@@YAHH@Z")] public static extern int acedSetStatusBarProgressMeterPos(int pos); [DllImport("acad.exe", CharSet = CharSet.Auto, CallingConvention = CallingConvention.Cdecl, EntryPoint = "?acedRestoreStatusBar@@YAXXZ")] public static extern int acedRestoreStatusBar(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br><br>  Additionally, I had to implement <b>XRecord</b> reading / editing through these functions. <br>  That greatly improved performance.  At the moment, if you create, for example, 1000 objects, then when you change properties at the same time for all of them, the speed is higher than when working with 1000 custom objects created by standard methods. <br>  The principle is stated very briefly, but if someone is interested, you can contact via Skype: vsegodvadcatsimvolov or here. <br>  I hope someone will be useful. <br><br>  <a href="http://the-void.ru/%3Fp%3D214">An example of a ready-made library that implements the work level mark</a> </div><p>Source: <a href="https://habr.com/ru/post/154591/">https://habr.com/ru/post/154591/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154579/index.html">Tt eSPORTS Level 10 M - just a mouse?</a></li>
<li><a href="../154581/index.html">Yandex Maps: Search for arbitrary objects</a></li>
<li><a href="../154583/index.html">16 ways to choose the perfect name for a startup</a></li>
<li><a href="../154587/index.html">File upload via FileReader</a></li>
<li><a href="../154589/index.html">NewSQL - a new milestone in the evolution of BigData, taking the best from SQL and NoSQL</a></li>
<li><a href="../154593/index.html">Lego will release your designer if 10,000 fans vote for him</a></li>
<li><a href="../154597/index.html">Vulnerability in Oracle 11g Authentication Protocol</a></li>
<li><a href="../154599/index.html">Google Nexus 7 tablet video review</a></li>
<li><a href="../154601/index.html">s02.e06. Robots</a></li>
<li><a href="../154603/index.html">Algorithmization of creativity: the creation of interesting advertising without creativity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>