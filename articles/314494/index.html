<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementation of the performance indicator of queries, stored procedures and triggers in MS SQL Server. Autotrace</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 The database administrator will sooner or later want to have a performance indicator that shows whether everything is good with queries. It...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementation of the performance indicator of queries, stored procedures and triggers in MS SQL Server. Autotrace</h1><div class="post__text post__text-html js-mediator-article"><h3>  Foreword </h3><br>  The database administrator will sooner or later want to have a performance indicator that shows whether everything is good with queries.  It is also known that the launch of Profiler for the whole day significantly loads the system, and therefore cannot be the optimal solution in the database, which is used 24x7. <br><br>  So how to determine the status of requests?  And how to run a trace when it detects problems with queries without human intervention? <br><br>  In this article, I‚Äôll provide an implementation indicator for query performance, stored procedures, and triggers, as well as their use to start tracing. <br><a name="habracut"></a><br><h3>  Decision </h3><br>  First, a general approach to implementing a query performance indicator, stored procedures, and triggers: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1) create the necessary tables for the collection and analysis of information <br>  2) create views to collect information <br>  3) create stored procedures to collect information <br>  4) create views to display information <br><br>  And now the implementation: <br><br>  1) create the necessary tables for the collection and analysis of information: <br><br>  1.1) for requests: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_PADDING <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[SQL_StatementExecStat]( [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertDate] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [QueryHash] [<span class="hljs-built_in"><span class="hljs-built_in">binary</span></span>](<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ExecutionCount] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalWorkerTime] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [StatementText] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalElapsedTime] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_SQL_StatementExecStat] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_PADDING <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br></div></div><br><br>  1.2) for stored procedures: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[SQL_ProcedureExecStat]( [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertDate] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [database_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [object_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ExecutionCount] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalWorkerTime] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalElapsedTime] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalPhysicalReads] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalLogicalReads] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalLogicalWrites] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_SQL_ProcedureExecStat] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br></div></div><br><br>  1.3) for triggers: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[SQL_TriggerExecStat]( [<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertDate] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [database_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [object_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ExecutionCount] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalWorkerTime] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalElapsedTime] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br></div></div><br><br>  2) create views to collect information (here you can also insert filters, that is, remove unnecessary information (for example, queries and procedures with replication triggers, etc.)): <br><br>  2.1) for requests: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [srv].[vStatementExecInfo] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> query_stats.query_hash <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> QueryHash, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.total_worker_time ) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgCPU_Time, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.execution_count ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ExecutionCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.total_worker_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalWorkerTime, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(query_stats.statement_text ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> StatementText, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(query_stats.min_worker_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinWorkerTime, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(query_stats.max_worker_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxWorkerTime, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.total_physical_reads) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(query_stats.min_physical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(query_stats.max_physical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.total_physical_reads) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.total_logical_writes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(query_stats.min_logical_writes ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(query_stats.max_logical_writes ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.total_logical_writes) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.total_logical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(query_stats.min_logical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(query_stats.max_logical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.total_logical_reads ) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.total_elapsed_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(query_stats.min_elapsed_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(query_stats.max_elapsed_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.total_elapsed_time ) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(query_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(query_stats.creation_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinCreationTime, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(query_stats.last_execution_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> LastExecuteTime <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> QS.query_hash ,QS.total_worker_time ,QS.execution_count ,QS.min_worker_time ,QS.max_worker_time ,QS.min_physical_reads ,QS.max_physical_reads ,QS.total_physical_reads ,QS.total_logical_writes ,QS.min_logical_writes ,QS.max_logical_writes ,QS.min_logical_reads ,QS.max_logical_reads ,QS.total_logical_reads ,QS.min_elapsed_time ,QS.max_elapsed_time ,QS.total_elapsed_time ,QS.creation_time ,QS.last_execution_time ,<span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(ST.text, (QS.statement_start_offset/<span class="hljs-number"><span class="hljs-number">2</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>, ((<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> statement_end_offset <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATALENGTH</span></span>(ST.text) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> QS.statement_end_offset <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> - QS.statement_start_offset)/<span class="hljs-number"><span class="hljs-number">2</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> statement_text <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_exec_query_stats <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> QS <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> sys.dm_exec_sql_text(QS.sql_handle) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ST) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> query_stats <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> execution_count &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> last_execution_time &gt;= <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">hour</span></span>,<span class="hljs-number"><span class="hljs-number">-3</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> query_stats.query_hash) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> QueryHash, AvgCPU_Time, ExecutionCount, TotalWorkerTime, StatementText, MinWorkerTime, MaxWorkerTime, TotalPhysicalReads, MinPhysicalReads, MaxPhysicalReads, AvgPhysicalReads, TotalLogicalWrites, MinLogicalWrites, MaxLogicalWrites, AvgLogicalWrites, TotalLogicalReads, MinLogicalReads, MaxLogicalReads, AvgLogicalReads, TotalElapsedTime, MinElapsedTime, MaxElapsedTime, AvgElapsedTime, MinCreationTime, LastExecuteTime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br></div></div><br><br>  It uses two system views <a href="https://msdn.microsoft.com/ru-ru/library/ms189741(v%3Dsql.110).aspx">sys.dm_exec_query_stats</a> and <a href="https://msdn.microsoft.com/ru-ru/library/ms181929(v%3Dsql.110).aspx">sys.dm_exec_sql_text</a> <br><br>  2.2) for stored procedures: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [srv].[vProcedureExecInfo] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> procedure_stats.database_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> database_id, procedure_stats.object_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> object_id, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.type) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_worker_time ) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgCPU_Time, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ExecutionCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_worker_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalWorkerTime, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.ProcedureText ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ProcedureText, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.min_worker_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinWorkerTime, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.max_worker_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxWorkerTime, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_physical_reads) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.min_physical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.max_physical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_physical_reads) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_logical_writes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.min_logical_writes ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.max_logical_writes ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_logical_writes) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_logical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.min_logical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.max_logical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_logical_reads ) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_elapsed_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.min_elapsed_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.max_elapsed_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_elapsed_time ) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.cached_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinCachedTime, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.last_execution_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> LastExecuteTime <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> QS.database_id ,QS.object_id ,QS.type ,QS.total_worker_time ,QS.execution_count ,QS.min_worker_time ,QS.max_worker_time ,QS.min_physical_reads ,QS.max_physical_reads ,QS.total_physical_reads ,QS.total_logical_writes ,QS.min_logical_writes ,QS.max_logical_writes ,QS.min_logical_reads ,QS.max_logical_reads ,QS.total_logical_reads ,QS.min_elapsed_time ,QS.max_elapsed_time ,QS.total_elapsed_time ,QS.cached_time ,QS.last_execution_time ,ST.text <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Proceduretext <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_exec_Procedure_stats <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> QS <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> sys.dm_exec_sql_text(QS.sql_handle) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ST) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> procedure_stats <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> execution_count &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> last_execution_time &gt;= <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">hour</span></span>,<span class="hljs-number"><span class="hljs-number">-3</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> database_id,object_id) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> database_id, object_id, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, AvgCPU_Time, ExecutionCount, TotalWorkerTime, ProcedureText, MinWorkerTime, MaxWorkerTime, TotalPhysicalReads, MinPhysicalReads, MaxPhysicalReads, AvgPhysicalReads, TotalLogicalWrites, MinLogicalWrites, MaxLogicalWrites, AvgLogicalWrites, TotalLogicalReads, MinLogicalReads, MaxLogicalReads, AvgLogicalReads, TotalElapsedTime, MinElapsedTime, MaxElapsedTime, AvgElapsedTime, MinCachedTime, LastExecuteTime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br></div></div><br><br>  It uses two system views <a href="https://msdn.microsoft.com/ru-ru/library/cc280701(v%3Dsql.110).aspx">sys.dm_exec_Procedure_stats</a> and <a href="https://msdn.microsoft.com/ru-ru/library/ms181929(v%3Dsql.110).aspx">sys.dm_exec_sql_text</a> <br><br>  2.3) for triggers: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [srv].[vTriggerExecInfo] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> procedure_stats.database_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> database_id, procedure_stats.object_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> object_id, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.type) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_worker_time ) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgCPU_Time, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ExecutionCount, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_worker_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalWorkerTime, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.ProcedureText ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ProcedureText, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.min_worker_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinWorkerTime, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.max_worker_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxWorkerTime, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_physical_reads) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.min_physical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.max_physical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_physical_reads) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgPhysicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_logical_writes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.min_logical_writes ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.max_logical_writes ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_logical_writes) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgLogicalWrites, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_logical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.min_logical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.max_logical_reads ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_logical_reads ) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgLogicalReads, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_elapsed_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TotalElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.min_elapsed_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.max_elapsed_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MaxElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.total_elapsed_time ) / <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(procedure_stats.execution_count) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AvgElapsedTime, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(procedure_stats.cached_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> MinCachedTime, <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(procedure_stats.last_execution_time ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> LastExecuteTime <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> QS.database_id ,QS.object_id ,QS.type ,QS.total_worker_time ,QS.execution_count ,QS.min_worker_time ,QS.max_worker_time ,QS.min_physical_reads ,QS.max_physical_reads ,QS.total_physical_reads ,QS.total_logical_writes ,QS.min_logical_writes ,QS.max_logical_writes ,QS.min_logical_reads ,QS.max_logical_reads ,QS.total_logical_reads ,QS.min_elapsed_time ,QS.max_elapsed_time ,QS.total_elapsed_time ,QS.cached_time ,QS.last_execution_time ,ST.text <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Proceduretext <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_exec_trigger_stats <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> QS <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">APPLY</span></span> sys.dm_exec_sql_text(QS.sql_handle) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ST) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> procedure_stats <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> execution_count &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> last_execution_time &gt;= <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">hour</span></span>,<span class="hljs-number"><span class="hljs-number">-3</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> database_id,object_id) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> database_id, object_id, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, AvgCPU_Time, ExecutionCount, TotalWorkerTime, ProcedureText, MinWorkerTime, MaxWorkerTime, TotalPhysicalReads, MinPhysicalReads, MaxPhysicalReads, AvgPhysicalReads, TotalLogicalWrites, MinLogicalWrites, MaxLogicalWrites, AvgLogicalWrites, TotalLogicalReads, MinLogicalReads, MaxLogicalReads, AvgLogicalReads, TotalElapsedTime, MinElapsedTime, MaxElapsedTime, AvgElapsedTime, MinCachedTime, LastExecuteTime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br></div></div><br><br>  It uses two system views <a href="https://msdn.microsoft.com/ru-ru/library/cc280646(v%3Dsql.110).aspx">sys.dm_exec_trigger_stats</a> and <a href="https://msdn.microsoft.com/ru-ru/library/ms181929(v%3Dsql.110).aspx">sys.dm_exec_sql_text</a> <br><br>  3) create stored procedures to collect information: <br><br>  3.1) for requests: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[InsertForSQL_StatementExecStat] @koef <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)=<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-comment"><span class="hljs-comment">-- , --      , --     0.0, --       5  --         --   ,      AS BEGIN SET NOCOUNT ON; declare @AvgCPU_Time bigint ,@MaxAvgCPU_Time bigint ,@AvgTotalWorkerTime bigint ,@MaxTotalWorkerTime bigint ,@AvgAvgElapsedTime bigint ,@MaxAvgElapsedTime bigint ,@AvgTotalElapsedTime bigint ,@MaxTotalElapsedTime bigint select @AvgCPU_Time = AVG(AvgCPU_Time), @MaxAvgCPU_Time = max(AvgCPU_Time), @AvgTotalWorkerTime = AVG(TotalWorkerTime), @MaxTotalWorkerTime = max(TotalWorkerTime), @AvgAvgElapsedTime = AVG(AvgElapsedTime), @MaxAvgElapsedTime = max(AvgElapsedTime), @AvgTotalElapsedTime = AVG(TotalElapsedTime), @MaxTotalElapsedTime = max(TotalElapsedTime) from srv.vStatementExecInfo; insert into srv.SQL_StatementExecStat ( [InsertDate] ,[QueryHash] ,[ExecutionCount] ,[TotalWorkerTime] ,[StatementText] ,[TotalElapsedTime]) select getdate() ,[QueryHash] ,[ExecutionCount] ,[TotalWorkerTime] ,[StatementText] ,[TotalElapsedTime] from srv.vStatementExecInfo where(AvgCPU_Time &gt; @AvgCPU_Time + @koef * (@MaxAvgCPU_Time - @AvgCPU_Time)) or (TotalWorkerTime &gt; @AvgTotalWorkerTime + @koef * (@MaxTotalWorkerTime - @AvgTotalWorkerTime)) or (AvgElapsedTime &gt; @AvgAvgElapsedTime + @koef * (@MaxAvgElapsedTime - @AvgAvgElapsedTime)) or (TotalElapsedTime &gt; @AvgTotalElapsedTime + @koef * (@MaxTotalElapsedTime - @AvgTotalElapsedTime)); END GO</span></span></code> </pre><br></div></div><br><br>  3.2) for stored procedures: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[InsertForProcedureExecStat] @koef <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)=<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-comment"><span class="hljs-comment">-- , --      , --     0.0, --       5  --         --   ,      AS BEGIN SET NOCOUNT ON; declare @AvgCPU_Time bigint ,@MaxAvgCPU_Time bigint ,@AvgTotalWorkerTime bigint ,@MaxTotalWorkerTime bigint ,@AvgAvgElapsedTime bigint ,@MaxAvgElapsedTime bigint ,@AvgTotalElapsedTime bigint ,@MaxTotalElapsedTime bigint; select @AvgCPU_Time = AVG(AvgCPU_Time), @MaxAvgCPU_Time = max(AvgCPU_Time), @AvgTotalWorkerTime = AVG(TotalWorkerTime), @MaxTotalWorkerTime = max(TotalWorkerTime), @AvgAvgElapsedTime = AVG(AvgElapsedTime), @MaxAvgElapsedTime = max(AvgElapsedTime), @AvgTotalElapsedTime = AVG(TotalElapsedTime), @MaxTotalElapsedTime = max(TotalElapsedTime) from srv.vProcedureExecInfo; insert into srv.SQL_ProcedureExecStat ( [InsertDate] ,database_id ,object_id ,[ExecutionCount] ,[TotalWorkerTime] ,[TotalElapsedTime] ,[TotalPhysicalReads] ,[TotalLogicalReads] ,[TotalLogicalWrites]) select getdate() ,database_id ,object_id ,[ExecutionCount] ,[TotalWorkerTime] ,[TotalElapsedTime] ,[TotalPhysicalReads] ,[TotalLogicalReads] ,[TotalLogicalWrites] from srv.vProcedureExecInfo where(AvgCPU_Time &gt; @AvgCPU_Time + @koef * (@MaxAvgCPU_Time - @AvgCPU_Time)) or (TotalWorkerTime &gt; @AvgTotalWorkerTime + @koef * (@MaxTotalWorkerTime - @AvgTotalWorkerTime)) or (AvgElapsedTime &gt; @AvgAvgElapsedTime + @koef * (@MaxAvgElapsedTime - @AvgAvgElapsedTime)) or (TotalElapsedTime &gt; @AvgTotalElapsedTime + @koef * (@MaxTotalElapsedTime - @AvgTotalElapsedTime)); END GO</span></span></code> </pre><br></div></div><br><br>  3.3) for triggers: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[InsertForTriggerExecStat] @koef <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)=<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-comment"><span class="hljs-comment">-- , --      , --     0.0, --       5  --         --   ,      AS BEGIN SET NOCOUNT ON; declare @AvgCPU_Time bigint ,@MaxAvgCPU_Time bigint ,@AvgTotalWorkerTime bigint ,@MaxTotalWorkerTime bigint ,@AvgAvgElapsedTime bigint ,@MaxAvgElapsedTime bigint ,@AvgTotalElapsedTime bigint ,@MaxTotalElapsedTime bigint select @AvgCPU_Time = AVG(AvgCPU_Time), @MaxAvgCPU_Time = max(AvgCPU_Time), @AvgTotalWorkerTime = AVG(TotalWorkerTime), @MaxTotalWorkerTime = max(TotalWorkerTime), @AvgAvgElapsedTime = AVG(AvgElapsedTime), @MaxAvgElapsedTime = max(AvgElapsedTime), @AvgTotalElapsedTime = AVG(TotalElapsedTime), @MaxTotalElapsedTime = max(TotalElapsedTime) from srv.vProcedureExecInfo; insert into srv.SQL_TriggerExecStat ( [InsertDate] ,database_id ,object_id ,[ExecutionCount] ,[TotalWorkerTime] ,[TotalElapsedTime]) select getdate() ,database_id ,object_id ,[ExecutionCount] ,[TotalWorkerTime] ,[TotalElapsedTime] from srv.vTriggerExecInfo where(AvgCPU_Time &gt; @AvgCPU_Time + @koef * (@MaxAvgCPU_Time - @AvgCPU_Time)) or (TotalWorkerTime &gt; @AvgTotalWorkerTime + @koef * (@MaxTotalWorkerTime - @AvgTotalWorkerTime)) or (AvgElapsedTime &gt; @AvgAvgElapsedTime + @koef * (@MaxAvgElapsedTime - @AvgAvgElapsedTime)) or (TotalElapsedTime &gt; @AvgTotalElapsedTime + @koef * (@MaxTotalElapsedTime - @AvgTotalElapsedTime)); END GO</span></span></code> </pre><br></div></div><br><br>  4) create views to display information: <br><br>  4.1) for requests: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> [srv].[vStatementExecTotalInfo] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ExecutionCount <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Num</span></span> ,TotalWorkerTime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TotalWorkerTime ,TotalElapsedTime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TotalElapsedTime ,<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>),AvgCPU_Time/<span class="hljs-number"><span class="hljs-number">1000000.</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvgWorkerSec ,<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>),AvgElapsedTime/<span class="hljs-number"><span class="hljs-number">1000000.</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvgElapsedSec ,... ,QueryHash ,StatementText <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [SRV].[srv].[vStatementExecInfo]; GO</code> </pre><br></div></div><br><br>  4.2) for stored procedures: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> [srv].[vProcedureExecTotalInfo] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ExecutionCount <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Num</span></span> ,TotalWorkerTime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TotalWorkerTime ,TotalElapsedTime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TotalElapsedTime ,<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>),AvgCPU_Time/<span class="hljs-number"><span class="hljs-number">1000000.</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvgWorkerSec ,<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>),AvgElapsedTime/<span class="hljs-number"><span class="hljs-number">1000000.</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvgElapsedSec ,... ,database_id ,object_id ,db_name(database_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DB_Name ,OBJECT_SCHEMA_NAME(object_id, database_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Schema_Name ,object_name(object_id, database_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Procedure_Name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [SRV].[srv].[vProcedureExecInfo]; GO</code> </pre><br></div></div><br><br>  4.3) Submissions for triggers are made in a similar way (if necessary).  But in my practice, there is no need to track all the time triggers, and problems with them will affect the execution of stored procedures and queries. <br><br>  In the realized representations two indicators are very important: <br><br>  1) AvgWorkerSec - the query execution time itself in seconds <br>  2) AvgElapsedSec - waiting or waiting time + AvgWorkerSec <br><br>  In the results of representations, an important indicator is the following equality: <br>  AvgWorkerSec = AvgElapsedSec. <br><br>  If this is not the case, then the problem is not in the request itself or in terms of the request.  The reasons may be many.  I will cite only those encountered myself: <br><br>  1) AvgWorkerSec&gt; AvgElapsedSec - here someone heavily loads the processor at the time of the request (as it turned out, the scan of the anti-virus application was started, it could also be the whole fault of the parallelization plan) <br>  2) AvgWorkerSec &lt;AvgElapsedSec - there is too much waiting before executing the query (the optimizer takes a long time to find a plan ‚Äî a problem with the proliferation of a procedural cache or a lack of cache; third-party software loaded disks with many inserts of records into the log file). <br><br>  If the AvgWorkerSec = AvgElapsedSec equality is met, then the long execution time of the query lies in the query itself and in its execution plan. <br><br>  What is the criterion that the request takes a long time? <br>  There is no definitive answer to such a question.  It depends on what the query does, how often and where is it used?  Etc. <br><br>  I have made the following assessment for operational requests, stored procedures: <br><br>  1) up to 0.5 - for stored procedures this is good, there are no problems (no delays in execution) <br>  2) to 0.1 - for requests it is good, there are no problems (no delays in execution) <br>  3) 0.5 - 1.0 - this is not good for stored procedures, there are problems (there are no delays in execution for the user, but they are there, the problem needs to be solved, but not urgent) <br>  4) 0.1 - 0.5 - this is not good for requests, there are problems (there are no delays in execution for the user, but they are there, the problem needs to be solved, but not urgent) <br>  5) more than 1.0 - this is bad for stored procedures, there are problems (it is very likely that there are visible delays in user execution, the problem needs to be solved urgently) <br>  6) more than 0.5 - for requests it is bad, there are problems (it is very likely that there are visible delays in the user‚Äôs execution, the problem must be solved urgently). <br><br>  For non-operational requests and stored procedures (uploading, loading data, etc.), this estimate is selected individually and usually several times higher than the estimates for operational requests and stored procedures. <br><br>  If all the software works through stored procedures, then you can generally track only stored procedures without requests, that is, the work of requests will always affect the operation of stored procedures.  Therefore, we will focus on the analysis of the implementation of stored procedures in more detail. <br><br>  We will now create a system that will collect information on the heaviest stored procedures for subsequent analysis and start of autotracing, according to the following algorithm: <br><br>  1) create a table in which we will store information: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[SQL_TopProcedureExecStat]( [Row_GUID] [uniqueidentifier] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [DB_ID] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [OBJECT_ID] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ExecutionCount] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalWorkerTime] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalElapsedTime] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Func] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [AvgWorkerSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [AvgElapsedSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [DB_NAME] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [SCHEMA_NAME] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [OBJECT_NAME] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertUTCDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalPhysicalReads] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalLogicalReads] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TotalLogicalWrites] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [AvgPhysicalReads] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [AvgLogicalReads] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [AvgLogicalWrites] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [CategoryName] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_SQL_TopProcedureExecStat] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [Row_GUID] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[SQL_TopProcedureExecStat] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_SQL_TopProcedureExecStat_Row_GUID] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (newid()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [Row_GUID] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[SQL_TopProcedureExecStat] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_SQL_TopProcedureExecStat_SERVER] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (@@servername) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[SQL_TopProcedureExecStat] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_SQL_TopProcedureExecStat_InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br></div></div><br><br>  2) create a stored procedure to collect information: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[InsertTopProcedureExecStat] @top tinyint=<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-comment"><span class="hljs-comment">--   (- ) ,@CategoryName nvarchar(255)='AvgWorkerSec' --,    AS BEGIN SET NOCOUNT ON; INSERT INTO [srv].[SQL_TopProcedureExecStat] ([DB_ID] ,[OBJECT_ID] ,[ExecutionCount] ,[TotalWorkerTime] ,[TotalElapsedTime] ,[AvgWorkerSec] ,[AvgElapsedSec] ,[DB_NAME] ,[SCHEMA_NAME] ,[OBJECT_NAME] ,InsertUTCDate ,CategoryName ,TotalPhysicalReads ,TotalLogicalReads ,TotalLogicalWrites ,AvgPhysicalReads ,AvgLogicalReads ,AvgLogicalWrites) select top(@top) [database_id] ,[object_id] ,[Num] ,[TotalWorkerTime] ,[TotalElapsedTime] ,[AvgWorkerSec] ,[AvgElapsedSec] ,[DB_NAME] ,[SCHEMA_NAME] ,[PROCEDURE_NAME] ,InsertUTCDate ,CategoryName ,TotalPhysicalReads ,TotalLogicalReads ,TotalLogicalWrites ,AvgPhysicalReads ,AvgLogicalReads ,AvgLogicalWrites from( select [database_id] ,[object_id] ,[Num] ,[TotalWorkerTime] ,[TotalElapsedTime] ,[AvgWorkerSec] ,[AvgElapsedSec] ,[DB_NAME] ,[SCHEMA_NAME] ,[PROCEDURE_NAME] ,getUTCDate() as InsertUTCDate ,@CategoryName as CategoryName ,TotalPhysicalReads ,TotalLogicalReads ,TotalLogicalWrites ,AvgPhysicalReads ,AvgLogicalReads ,AvgLogicalWrites FROM [srv].[vProcedureExecTotalInfoHour] ) as t order by case @CategoryName when 'TotalWorkerTime' then TotalWorkerTime when 'TotalElapsedTime' then TotalElapsedTime when 'AvgWorkerSec' then AvgWorkerSec when 'AvgElapsedSec' then AvgElapsedSec when 'TotalPhysicalReads' then TotalPhysicalReads when 'TotalLogicalReads' then TotalLogicalReads when 'TotalLogicalWrites' then TotalLogicalWrites when 'AvgPhysicalReads' then AvgPhysicalReads when 'AvgLogicalReads' then AvgLogicalReads when 'AvgLogicalWrites' then AvgLogicalWrites end desc; declare @count int=(select count(*) from [srv].[SQL_TopProcedureExecStat] where CategoryName=@CategoryName); declare @diff int=@count-@top; ;with tbl_del as( select Row_GUID from [srv].[SQL_TopProcedureExecStat] where InsertUTCDate&lt;DateAdd(hour,-24,getUTCDate()) and CategoryName=@CategoryName ) delete from [srv].[SQL_TopProcedureExecStat] where Row_GUID in (select Row_GUID from tbl_del); --     ,   @top,     set @count = (select count(*) from [srv].[SQL_TopProcedureExecStat] where CategoryName=@CategoryName) set @diff = @count - @Top - 3 if(@diff&gt;0) begin ;with tbl_del as( select top(@diff) Row_GUID from [srv].[SQL_TopProcedureExecStat] where CategoryName=@CategoryName order by case @CategoryName when 'TotalWorkerTime' then TotalWorkerTime when 'TotalElapsedTime' then TotalElapsedTime when 'AvgWorkerSec' then AvgWorkerSec when 'AvgElapsedSec' then AvgElapsedSec when 'TotalPhysicalReads' then TotalPhysicalReads when 'TotalLogicalReads' then TotalLogicalReads when 'TotalLogicalWrites' then TotalLogicalWrites when 'AvgPhysicalReads' then AvgPhysicalReads when 'AvgLogicalReads' then AvgLogicalReads when 'AvgLogicalWrites' then AvgLogicalWrites end ) delete from [srv].[SQL_TopProcedureExecStat] where Row_GUID in (select Row_GUID from tbl_del); end declare @DB_ID int declare @OBJECT_ID int declare @top1 int = 3 declare @diff1 int declare @count1 int --    @top1    select top (1) @count1 = tp.num ,@DB_ID = tp.DB_ID ,@OBJECT_ID = tp.OBJECT_ID from (select count(*) as num, DB_ID, OBJECT_ID from [srv].[SQL_TopProcedureExecStat] where CategoryName=@CategoryName group by DB_ID, OBJECT_ID) as tp order by tp.num desc; set @diff1 = @count1 - @top1; if(@diff1) &gt; 0 begin ;with tbl_del as( select top(@diff1) Row_GUID from [srv].[SQL_TopProcedureExecStat] where DB_ID = @DB_ID and OBJECT_ID = @OBJECT_ID and CategoryName=@CategoryName order by case @CategoryName when 'TotalWorkerTime' then TotalWorkerTime when 'TotalElapsedTime' then TotalElapsedTime when 'AvgWorkerSec' then AvgWorkerSec when 'AvgElapsedSec' then AvgElapsedSec when 'TotalPhysicalReads' then TotalPhysicalReads when 'TotalLogicalReads' then TotalLogicalReads when 'TotalLogicalWrites' then TotalLogicalWrites when 'AvgPhysicalReads' then AvgPhysicalReads when 'AvgLogicalReads' then AvgLogicalReads when 'AvgLogicalWrites' then AvgLogicalWrites end ) delete from [srv].[SQL_TopProcedureExecStat] where Row_GUID in (select Row_GUID from tbl_del); end --    1    AvgWorkerSec    if @CategoryName = 'AvgWorkerSec' begin declare @AvgWorkerSec decimal(8,2) select top (1) @count1 = tp.num ,@DB_ID = tp.DB_ID ,@OBJECT_ID = tp.OBJECT_ID ,@AvgWorkerSec = tp.AvgWorkerSec from (select count(*) as num, DB_ID, OBJECT_ID, AvgWorkerSec from [srv].[SQL_TopProcedureExecStat] where CategoryName=@CategoryName group by DB_ID, OBJECT_ID,AvgWorkerSec) as tp order by tp.num desc; set @diff1 = @count1 - 1; if(@diff1) &gt; 0 begin ;with tbl_del as( select top(@diff1) Row_GUID from [srv].[SQL_TopProcedureExecStat] where DB_ID = @DB_ID and OBJECT_ID = @OBJECT_ID and CategoryName=@CategoryName and AvgWorkerSec = @AvgWorkerSec order by InsertUTCDate desc ) delete from [srv].[SQL_TopProcedureExecStat] where Row_GUID in (select Row_GUID from tbl_del); end end if @CategoryName = 'AvgElapsedSec' begin declare @AvgElapsedSec decimal(8,2) select top (1) @count1 = tp.num ,@DB_ID = tp.DB_ID ,@OBJECT_ID = tp.OBJECT_ID ,@AvgElapsedSec = tp.AvgElapsedSec from (select count(*) as num, DB_ID, OBJECT_ID, AvgElapsedSec from [srv].[SQL_TopProcedureExecStat] where CategoryName=@CategoryName group by DB_ID, OBJECT_ID,AvgElapsedSec) as tp order by tp.num desc; set @diff1 = @count1 - 1; if(@diff1) &gt; 0 begin ;with tbl_del as( select top(@diff1) Row_GUID from [srv].[SQL_TopProcedureExecStat] where DB_ID = @DB_ID and OBJECT_ID = @OBJECT_ID and CategoryName=@CategoryName and AvgElapsedSec = @AvgElapsedSec order by InsertUTCDate desc ) delete from [srv].[SQL_TopProcedureExecStat] where Row_GUID in (select Row_GUID from tbl_del); end end END GO</span></span></code> </pre><br></div></div><br><br>  It is best to start this stored procedure immediately after collecting information about stored procedures (you can configure the task in the Agent to run every 5-10 minutes for requests and stored procedures and triggers): <br><br><pre> <code class="sql hljs">exec [srv].[InsertForSQL_StatementExecStat]; <span class="hljs-comment"><span class="hljs-comment">--     exec [srv].[InsertForTriggerExecStat]; --     exec [srv].[InsertForProcedureExecStat]; --      --          exec [srv].[InsertTopProcedureExecStat] @top=@top, @CategoryName='AvgWorkerSec'; exec [srv].[InsertTopProcedureExecStat] @top=@top, @CategoryName='AvgElapsedSec';</span></span></code> </pre><br>  3) start the trace (via the Agent's tasks ‚Äî every 5-10 minutes, preferably immediately after collecting the information): <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__]; go <span class="hljs-comment"><span class="hljs-comment">--    declare @koef_red numeric(8,3)=1.3; --         --  if(exists( SELECT top(1) 1 FROM [srv].[SQL_TopProcedureExecStat] where CategoryName='AvgElapsedSec' or CategoryName='AvgWorkerSec' group by CategoryName having avg([AvgElapsedSec])&gt;=@koef_red or avg([AvgWorkerSec])&gt;=@koef_red)) begin --  exec .[srv].[AutoTrace]; end</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The stored autotrace procedure is implemented individually. </font></font> I will give an example: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[AutoTrace] @maxfilesize <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>=<span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-comment"><span class="hljs-comment">--     ,@run_minutes int=60 --      ,@file_patch nvarchar(255)=N'  ' --    ,@file_name nvarchar(255)=N'Profiler' --  ,@res_msg nvarchar(255)=NULL output --    AS BEGIN SET NOCOUNT ON; declare @rc int; declare @TraceID int; if(@run_minutes&gt;=1200) set @run_minutes=1200; --  20 ! declare @finish_dt datetime=DateAdd(minute,@run_minutes,GetDate()); --    --   declare @finish_dt_inc nvarchar(255)=N'_'+cast(YEAR(@finish_dt) as nvarchar(255))+'_'+cast(MONTH(@finish_dt) as nvarchar(255))+'_'+cast(DAY(@finish_dt) as nvarchar(255)); declare @File nvarchar(255)=@file_patch+@file_name+@finish_dt_inc; --    DECLARE @result bit; DECLARE @msgerrors nvarchar(255); DECLARE @oldDT datetime; --     if(object_id('__.dbo.TraceTable')&lt;&gt;0) begin select @oldDT=max(StartTime) from __.dbo.TraceTable where StartTime is not null; end --select @oldDT; --           ,   , -      if(@oldDT is null or @oldDT&lt;DATETIMEFROMPARTS(YEAR(@finish_dt), MONTH(@finish_dt), DAY(@finish_dt), 0, 0, 0, 0)) begin --  exec @rc = sp_trace_create @TraceID=@TraceID output, --  @Options=0, --  ( ) @TraceFile=@File, --   @MaxFileSize=@maxfilesize, --    (     ) @StopTime=@finish_dt--, --       --@FileCount=2; --- ,     (     ) --     ( 0),       if (@rc = 0) begin --     declare @on bit set @on = 1 exec sp_trace_setevent @TraceID, 10, 1, @on exec sp_trace_setevent @TraceID, 10, 9, @on exec sp_trace_setevent @TraceID, 10, 2, @on exec sp_trace_setevent @TraceID, 10, 66, @on exec sp_trace_setevent @TraceID, 10, 10, @on exec sp_trace_setevent @TraceID, 10, 3, @on exec sp_trace_setevent @TraceID, 10, 4, @on exec sp_trace_setevent @TraceID, 10, 6, @on exec sp_trace_setevent @TraceID, 10, 7, @on exec sp_trace_setevent @TraceID, 10, 8, @on exec sp_trace_setevent @TraceID, 10, 11, @on exec sp_trace_setevent @TraceID, 10, 12, @on exec sp_trace_setevent @TraceID, 10, 13, @on exec sp_trace_setevent @TraceID, 10, 14, @on exec sp_trace_setevent @TraceID, 10, 15, @on exec sp_trace_setevent @TraceID, 10, 16, @on exec sp_trace_setevent @TraceID, 10, 17, @on exec sp_trace_setevent @TraceID, 10, 18, @on exec sp_trace_setevent @TraceID, 10, 25, @on exec sp_trace_setevent @TraceID, 10, 26, @on exec sp_trace_setevent @TraceID, 10, 31, @on exec sp_trace_setevent @TraceID, 10, 34, @on exec sp_trace_setevent @TraceID, 10, 35, @on exec sp_trace_setevent @TraceID, 10, 41, @on exec sp_trace_setevent @TraceID, 10, 48, @on exec sp_trace_setevent @TraceID, 10, 49, @on exec sp_trace_setevent @TraceID, 10, 50, @on exec sp_trace_setevent @TraceID, 10, 51, @on exec sp_trace_setevent @TraceID, 10, 60, @on exec sp_trace_setevent @TraceID, 10, 64, @on exec sp_trace_setevent @TraceID, 12, 1, @on exec sp_trace_setevent @TraceID, 12, 9, @on exec sp_trace_setevent @TraceID, 12, 3, @on exec sp_trace_setevent @TraceID, 12, 11, @on exec sp_trace_setevent @TraceID, 12, 4, @on exec sp_trace_setevent @TraceID, 12, 6, @on exec sp_trace_setevent @TraceID, 12, 7, @on exec sp_trace_setevent @TraceID, 12, 8, @on exec sp_trace_setevent @TraceID, 12, 10, @on exec sp_trace_setevent @TraceID, 12, 12, @on exec sp_trace_setevent @TraceID, 12, 13, @on exec sp_trace_setevent @TraceID, 12, 14, @on exec sp_trace_setevent @TraceID, 12, 15, @on exec sp_trace_setevent @TraceID, 12, 16, @on exec sp_trace_setevent @TraceID, 12, 17, @on exec sp_trace_setevent @TraceID, 12, 18, @on exec sp_trace_setevent @TraceID, 12, 26, @on exec sp_trace_setevent @TraceID, 12, 31, @on exec sp_trace_setevent @TraceID, 12, 35, @on exec sp_trace_setevent @TraceID, 12, 41, @on exec sp_trace_setevent @TraceID, 12, 48, @on exec sp_trace_setevent @TraceID, 12, 49, @on exec sp_trace_setevent @TraceID, 12, 50, @on exec sp_trace_setevent @TraceID, 12, 51, @on exec sp_trace_setevent @TraceID, 12, 60, @on exec sp_trace_setevent @TraceID, 12, 64, @on exec sp_trace_setevent @TraceID, 12, 66, @on exec sp_trace_setevent @TraceID, 13, 1, @on exec sp_trace_setevent @TraceID, 13, 9, @on exec sp_trace_setevent @TraceID, 13, 3, @on exec sp_trace_setevent @TraceID, 13, 11, @on exec sp_trace_setevent @TraceID, 13, 4, @on exec sp_trace_setevent @TraceID, 13, 6, @on exec sp_trace_setevent @TraceID, 13, 7, @on exec sp_trace_setevent @TraceID, 13, 8, @on exec sp_trace_setevent @TraceID, 13, 10, @on exec sp_trace_setevent @TraceID, 13, 12, @on exec sp_trace_setevent @TraceID, 13, 14, @on exec sp_trace_setevent @TraceID, 13, 26, @on exec sp_trace_setevent @TraceID, 13, 35, @on exec sp_trace_setevent @TraceID, 13, 41, @on exec sp_trace_setevent @TraceID, 13, 49, @on exec sp_trace_setevent @TraceID, 13, 50, @on exec sp_trace_setevent @TraceID, 13, 51, @on exec sp_trace_setevent @TraceID, 13, 60, @on exec sp_trace_setevent @TraceID, 13, 64, @on exec sp_trace_setevent @TraceID, 13, 66, @on --   declare @intfilter int; declare @bigintfilter bigint; exec sp_trace_setfilter @TraceID, 10, 0, 7, N' SQL Server Profiler - fa35966e-e426-4d1a-8753-8f971cf89495'; exec sp_trace_setfilter @TraceID, 35, 0, 6, N'%__%'; exec sp_trace_setfilter @TraceID, 35, 1, 6, N'%__%'; --  exec sp_trace_setstatus @TraceID, 1; --    declare @run_delay int=@run_minutes+1; --   1        declare @run_delay_hour int=@run_delay/60; --   declare @run_delay_minute int=@run_delay-(@run_delay/60)*60; --   declare @run_delay_hour_str nvarchar(2); --   declare @run_delay_minute_str nvarchar(2); --   --       if(@run_delay_hour=0) set @run_delay_hour_str='00'; else if(@run_delay_hour&lt;10) set @run_delay_hour_str='0'+cast(@run_delay_hour as nvarchar(255)); else if(@run_delay_hour&gt;=10) set @run_delay_hour_str=cast(@run_delay_hour as nvarchar(255)); --select @run_delay_hour, @run_delay_hour_str; --       if(@run_delay_minute=0) set @run_delay_minute_str='00'; else if(@run_delay_minute&lt;10) set @run_delay_minute_str='0'+cast(@run_delay_minute as nvarchar(255)); else if(@run_delay_minute&gt;=10) set @run_delay_minute_str=cast(@run_delay_minute as nvarchar(255)); --select @run_delay_minute, @run_delay_minute_str; --  :   declare @run_delay_str nvarchar(255)=@run_delay_hour_str+':'+@run_delay_minute_str; -- WAITFOR DELAY @run_delay_str; --select @run_delay_str; --      if(object_id('__.dbo.TraceTable')&lt;&gt;0) begin drop table __.dbo.TraceTable; end --        SELECT * INTO __.dbo.TraceTable FROM ::fn_trace_gettable(@File+'.trc', default); --      set @File=@File+'.trc'; --   ,     declare @str_title nvarchar(max)='     '+@@servername, @str_pred_mess nvarchar(max)=' '+@@servername+'    .      __.dbo.TraceTable'; --        end --  set @res_msg=N'ErrorCode='+cast(@rc as nvarchar(255))+'\r\n'+coalesce(@msgerrors, ''); end END GO</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can read more about how to set up tracing here. </font></font><a href="https://technet.microsoft.com/ru-ru/library/ms188662(v%3Dsql.105).aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to create a trace (Transact-SQL)</font></font></a> <br><br><h3>  Result </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article has reviewed an example of the implementation of the collection system on the state of the database, which does not load the system. Also, this system, in case of detection of a problem, runs the previously configured trace and stores it in a table. This approach can be extended to multiple servers. Then it is necessary to collect information from all servers for sending the report to administrators. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is also important not to forget to delete old data from used tables. It is quite enough to store data up to a month or even two weeks. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another interesting solution is here </font></font><a href="https://habrahabr.ru/post/310328/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing database performance using tSQLt and SQLQueryStress The</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> following is </font></font><a href="https://habrahabr.ru/post/342794/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an example of the implementation of a general MS SQL Server performance indicator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3>  Sources: </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬ª </font></font><a href="https://msdn.microsoft.com/ru-ru/library/cc280646(v%3Dsql.110).aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sys.dm_exec_trigger_stats</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª </font></font><a href="https://msdn.microsoft.com/ru-ru/library/cc280701(v%3Dsql.110).aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sys.dm_exec_procedure_stats</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª </font></font><a href="https://msdn.microsoft.com/ru-ru/library/ms189741(v%3Dsql.110).aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sys.dm_exec_query_stats</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª </font></font><a href="https://msdn.microsoft.com/ru-ru/library/ms181929(v%3Dsql.110).aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sys.dm_exec_sql_text</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª </font></font><a href="https://technet.microsoft.com/ru-ru/library/ms188662(v%3Dsql.105).aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to create a trace (Transact-SQL)</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª </font></font><a href="https://habrahabr.ru/post/342794/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example of implementation of a general MS SQL Server performance indicator</font></font></a> <br>  ¬ª <a href="https://habrahabr.ru/post/310328/">Database Performance Testing with tSQLt and SQLQueryStress</a> </div><p>Source: <a href="https://habr.com/ru/post/314494/">https://habr.com/ru/post/314494/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314478/index.html">Transfer domain? Get ready for trouble</a></li>
<li><a href="../314484/index.html">Basics of computer networks. Subject number 5. The concept of IP addressing, subnet masks and their calculation</a></li>
<li><a href="../314486/index.html">How enum is available for everyone to do, but write to the meta-type</a></li>
<li><a href="../314490/index.html">Recommendations based on product images</a></li>
<li><a href="../314492/index.html">Problems with the image: image tag in site maps. Bypass misunderstanding Yandex validator</a></li>
<li><a href="../314496/index.html">How important is mathematical training in promising areas of software development</a></li>
<li><a href="../314500/index.html">Comparing objects by value - 2, or Features of the implementation of the Equals method</a></li>
<li><a href="../314502/index.html">A brief history of the development of game engines</a></li>
<li><a href="../314506/index.html">ZFS on Linux: News from the Field 2017</a></li>
<li><a href="../314508/index.html">Synthesis of images using deep neural networks. Lecture in Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>