<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VPN, full coverage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine your company is gaining momentum, sales are growing, many branches are opening, and these branches are actively working with each other. This ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VPN, full coverage</h1><div class="post__text post__text-html js-mediator-article"> Imagine your company is gaining momentum, sales are growing, many branches are opening, and these branches are actively working with each other.  This means that you need to link them all together!  As equipment, we have Cisco routers, which, by the way, cancels only final configuration examples, if you don‚Äôt have Cisco, I found an OpenNHRP project on the network. <br><br>  So, let's begin.  To begin with, we will link the center with the first branch using IPSEC. <br><br><a name="habracut"></a><br>  We introduce addressing ‚Äî the company's internal network is 10.0.0.0/8, the head office network is 10.0.0.0/24, and the network of the first branch is 10.1.0.0/24.  The external address of the head office router is 172.16.0.2/30, and its default route goes, respectively, to 172.16.0.1.  For better distinction, we will issue the branch an ‚Äúexternal‚Äù address 192.168.45.14/30, and the gateway will be the only remaining address from the range - 192.168.45.13. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Head Office Router: <br><pre> <code class="hljs erlang-repl">!   ISAKMP.    ,     !    . ! crypto isakmp policy <span class="hljs-number"><span class="hljs-number">1</span></span> encr aes authentication pre-share group <span class="hljs-number"><span class="hljs-number">2</span></span> lifetime <span class="hljs-number"><span class="hljs-number">3600</span></span> ! !       . ! crypto isakmp key MEGAKEY123 address <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">45.14</span></span> ! crypto ipsec transform-set BIGCOMPANY-TRSET esp-aes esp-sha-hmac ! crypto ipsec profile BIGCOMPANY-profile set transform-set BIGCOMPANY-TRSET ! interface FastEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> ip address <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">0.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span>.<span class="hljs-number"><span class="hljs-number">255.252</span></span> ! !   ,      ‚Ññ<span class="hljs-number"><span class="hljs-number">1</span></span> ! interface Tunnel1 description Tunnel to filial ‚Ññ<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> ip address <span class="hljs-number"><span class="hljs-number">10.55</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span>.<span class="hljs-number"><span class="hljs-number">255.252</span></span> tunnel source FastEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> tunnel destination <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">45.14</span></span> tunnel mode ipsec ipv4 tunnel protection ipsec profile BIGCOMPANY-profile ! ip route <span class="hljs-number"><span class="hljs-number">0.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> !           . ip route <span class="hljs-number"><span class="hljs-number">10.1</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span>.<span class="hljs-number"><span class="hljs-number">255.0</span></span> <span class="hljs-number"><span class="hljs-number">10.55</span></span>.<span class="hljs-number"><span class="hljs-number">0.2</span></span></code> </pre><br><br>  The branch office router is configured by analogy, and the main thing here is to analyze the shortcomings of the solution.  Based on our assumption, the number of branches is growing rapidly, so when you connect the second branch, you will need to configure two more tunnels, when you connect the third - 3, the fourth - 4, and so on.  Can you stop at the 20th for example and think about it - is it really the way it should be? <br><br>  And in such cases, there should be orders of magnitude more dynamics ‚Äî we need routing protocols and multipoint VPN, and Cisco collectively calls DMVPN Dynamic Multipoint VPN.  At the beginning of development, few people understand why he needs OSPF and certificates - after all, it is much easier to register ip route 10.1.0.0 ... and bothering with certificates, when there is an opportunity to just drive a key at two ends, this is generally a perversion.  But to drive one key at all points is unacceptable, and to drive a key pair at all is unrealistic.  Thus, certificates will have to be mastered. <br><br>  However, the topic of certificates in Cisco IPSEC is beyond the scope of <i>this</i> habratopic - here I will show you what DMVPN is and how remarkable it is. <br><br>  So, DMVPN is a combination of NHRP, dynamic routing protocol (EIGRP, OSPF, IS-IS - this is not limited to you) and a multipoint GRE tunnel.  DMVPN allows you to reduce the configuration of additional points to a minimum, clients can have dynamic addresses (the server needs a constant, this is an entry point), tunnels between clients will rise automatically, on demand. <br><br>  The NHRP protocol, the NBMA Next Hop Resolution Protocol, serves to resolve addresses on non-broadcast networks ‚Äî in our case it helps to determine the external address of the router to which the packet is intended.  Permission is carried out by ‚Äúhub‚Äù, the server, to which its addresses are communicated and requested information about other ‚Äúspokes‚Äù, by clients. <br><br>  I used DMVPN when the company began implementing VoIP - so as not to drive voice traffic through the center.  For example, Vasya from Tomsk needed to call Petya from Krasnoyarsk - the tunnel between the routers will be established dynamically.  Each router has an IP address of the ad hoc network (for example, 10.0.1.0/24), and the routers are registered on the center's NHRP server (10.0.1.1).  When Tomsk is required to connect to Krasnoyarsk, it looks at the routing table and sees that the route to this network lies through the 10.0.1.7 point.  Through NHRP, the router learns the public IP address of the router and can begin to establish an IPSEC tunnel.  It doesn't sound very complicated in my opinion. <br><br>  Let's take OSPF as a dynamic routing protocol, based on personal preferences.  It can easily be replaced by any other according to your desire. <br><br>  The example uses a common key, one for all.  But you can‚Äôt do this in the real world - be sure to read the topic of certificates. <br><br>  The configuration of the central router relevant to: <br><pre> <code class="hljs sql">crypto isakmp policy 1 encr aes authentication pre-share group 2 lifetime 3600 ! !  ,    ! crypto isakmp key MEGAKEY123 address 0.0.0.0 0.0.0.0 ! crypto ipsec transform-<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> BIGCOMPANY-TRSET esp-aes esp-<span class="hljs-keyword"><span class="hljs-keyword">sha</span></span>-hmac ! crypto ipsec profile BIGCOMPANY-profile <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> transform-<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> BIGCOMPANY-TRSET ! <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> FastEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> description WAN <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> ip address <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> ! <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> Tunnel101 ip address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> ip redirects ip mtu <span class="hljs-number"><span class="hljs-number">1440</span></span> ip nhrp <span class="hljs-keyword"><span class="hljs-keyword">authentication</span></span> KUKU321 ip nhrp <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> multicast dynamic ip nhrp network-<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ip nhrp holdtime <span class="hljs-number"><span class="hljs-number">3600</span></span> ip nhrp <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> non-authoritative ip tcp adjust-mss <span class="hljs-number"><span class="hljs-number">1360</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> ip mroute-<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> ip ospf network broadcast ip ospf hello-<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> ip ospf <span class="hljs-keyword"><span class="hljs-keyword">priority</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> delay <span class="hljs-number"><span class="hljs-number">1000</span></span> tunnel <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> Vlan1 tunnel <span class="hljs-keyword"><span class="hljs-keyword">mode</span></span> gre multipoint tunnel <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> KUKU tunnel <span class="hljs-keyword"><span class="hljs-keyword">protection</span></span> ipsec profile BIGCOMPANY-TRSET ! ip route <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> !</code> </pre><br><br>  Branch Router: <br><pre> <code class="hljs sql">interface Tunnel7 ip address 10.0.1.2 255.255.255.0 no ip redirects ip nhrp authentication KUKU321 ip nhrp map multicast dynamic ip nhrp map multicast 172.16.0.2 ip nhrp map 10.0.1.1 172.16.0.2 ip nhrp network-id 1 ip nhrp holdtime 3600 ip nhrp nhs 10.0.1.1 no ip route-<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> cef <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> ip route-<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> ip tcp adjust-mss <span class="hljs-number"><span class="hljs-number">1360</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> ip mroute-<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> ip ospf network broadcast ip ospf hello-<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> ip ospf <span class="hljs-keyword"><span class="hljs-keyword">priority</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> delay <span class="hljs-number"><span class="hljs-number">1000</span></span> tunnel <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> FastEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> tunnel <span class="hljs-keyword"><span class="hljs-keyword">mode</span></span> gre multipoint tunnel <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> KUKU tunnel <span class="hljs-keyword"><span class="hljs-keyword">protection</span></span> ipsec profile BIGCOMPANY-TRSET</code> </pre><br><br>  As you can see, the basic settings relate to the Tunnel7 tunnel interface.  The first block is the NHRP settings. <br>  The ip nhrp map commands set the order of address resolution.  Here we set the correspondence of the NHRP server's internal address and its WAN address - ip nhrp map 10.0.1.1 172.16.0.2.  Also by analogy, all multicast requests are addressed to the same.  Well, ip nhrp nhs sets the server address. <br>  Note that the addresses of all DMVPN interfaces are from the same network. <br>  The ip ospf commands set the dynamic routing settings on the interface.  There may be ip eigrp of your choice. <br>  Well, tunnel protection ipsec profile BIGCOMPANY-TRSET includes encryption, as you might guess, the step is optional. <br><br>  Here, the spoke-spoke version is considered, that is, a direct connection between DMVPN clients.  There is an option hub-spoke, which serves to connect clients with the center. <br><br>  I hope someone who is faced with the explosive growth of the business, reading this topic will know what to do in such a situation.  The settings here are just an example, do not use the article as a HOW-TO, read cisco.com. <br><br>  Additionally, I can say that setting up the router took us no more than half an hour - this is generating the certificate, uploading it to the router, generating the config (a simple bash script), editing the config with a file, packing it in a box. <br><br>  Home reading on the <a href="https://www.cisco.com/en/US/products/ps6658/index.html">official site</a> .  From the document you download there, it is clear that the possibilities of using DMVPN are somewhat broader than presented here. </div><p>Source: <a href="https://habr.com/ru/post/51365/">https://habr.com/ru/post/51365/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../51353/index.html">Everything is bad?</a></li>
<li><a href="../51354/index.html">Modern JavaScript debugging</a></li>
<li><a href="../51359/index.html">Write letters</a></li>
<li><a href="../51360/index.html">How life will change after innovations in GK 4</a></li>
<li><a href="../51362/index.html">How to learn to whistle loudly</a></li>
<li><a href="../51366/index.html">ExtJs are increasingly used in the creation of CMS</a></li>
<li><a href="../51368/index.html">Automate writing ajax form handlers</a></li>
<li><a href="../51372/index.html">Unsupervised learning or ‚Äúgo there, I don‚Äôt know where, find it, I don‚Äôt know what‚Äù</a></li>
<li><a href="../51375/index.html">Interesting coincidences. Part Three: Aunt Asya arrived :)</a></li>
<li><a href="../51377/index.html">Google Web Toolkit released - GWT 1.6 M1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>