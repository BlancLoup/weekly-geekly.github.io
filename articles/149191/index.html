<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Through the ports on the equipment to the user machines</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good time of day, Habrazhiteli. 

 This post tells you how with the help of PowerShell we were again able to make our lives a little easier and automa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Through the ports on the equipment to the user machines</h1><div class="post__text post__text-html js-mediator-article">  Good time of day, Habrazhiteli. <br><br>  This post tells you how with the help of PowerShell we were again able to make our lives a little easier and automate the search for equipment and ports on which users' computers sit.  This is necessary at the moment when it is necessary to forward vlans (well, or just for information). <br><img src="https://habrastorage.org/storage2/465/697/e16/465697e16a9de5bc98aa112300c53550.jpg">  " <br><a name="habracut"></a><br><h5>  Prehistory </h5><br>  It all started about a year ago.  Once our senior administrator suggested that I try to write a script on this topic.  Scratching a pumpkin, I agreed to try.  Before that, I had never worked with network equipment (well, the home router does not count), so he threw off an approximate sequence of commands with which all this could be done. <br><br>  Using Putty, I tried to do all this manually, everything worked out and I began to think how to automate all this.  And not just to automate, but to do it with PowerShell.  Why precisely PoSh?  At that time I had a great crush on him (although I am still not getting off of him now), it was possible to do this in something else, but I really wanted to do it through PoSh. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since it was required to connect to the equipment via Telnet and SSH (mainly via Telnet, since at that time SSH was not everywhere, but more on that later) I spent a lot of time on the Internet to find out how PowerShell can work with these protocols. <br>  Then I turned to 2 connection mechanisms: <br><ol><li>  using plink.exe (from Putty) </li><li>  Netcmdlets company / n software </li></ol><br>  Using mostly plink.exe, I got something that was difficult to call a work of art.  It was a huge, cluttered script that absolutely no one wanted to show.  And even more so to write about this article here. <br>  And since it worked (periodically, I even used it), I postponed its optimization indefinitely and did other things. <br><br>  The time has passed, a lot has changed during this time, but I did not forget about my brainchild, periodically trying to rewrite it again and get rid of a bunch of unnecessary things.  Finally I managed it! <br><br><h5>  Vader, rise! </h5><br>  The most important thing that happened was that they updated the firmware on the switches, and now it became possible to connect to them via SSH.  Well, that‚Äôs great, we‚Äôve scored on telnet. <br>  This was followed by another change: since telnet is no longer needed, we can stop using plink.exe (from Putty) and NetCmdlets gets all the glory. <br>  Having talked quite a bit with the technical support of this company, I finally figured out the structure of these tools, and began to work. <br><br>  What I needed: <br><ol><li>  Check the correctness of the IP address of the computer </li><li>  Check whether the computer is online </li><li>  Connect to each equipment sequentially, starting with the most important, and find out on which ports our device hangs </li><li>  Show all this to the user, so that he (ie, I) would be satisfied </li></ol><br><h6>  Netcmdlets </h6><br>  Since I want to say thank you to the people who made them, a small digression and a few words about these cmdlets: <br>  You can read about them and download them <a href="http://www.powershellinside.com/powershell/netcmdlets/">here</a> .  You can download both the trial version (for 30 days) and the full version (for $ 100 per computer).  I used the trial version because  after the expiration date, you can simply reinstall it. <br>  Recently, on the <a href="http://www.powershellmagazine.com/">powershellmagazine.com</a> resource, these cmdlets were heard for free, I managed to grab it.  So be on the alert!  But back to our sheep. <br>  Choosing a set of these cmdlets, I began to study them.  This set is quite large, so I will not describe everything that is there.  I‚Äôll stop at 2: <br><ul><li>  Connect-ssh </li><li>  Invoke-ssh </li></ul><br>  You can only do Invoke-SSh, but then you will not have a permanent session with the device (that is, say, you will not be able to execute commands in ‚Äúconf t‚Äù on the device).  Using this Connect-SSh cmdlet, we create a connection to the device, and the Invoke-SSh cmdlet executes commands.  Everything is quite simple. <br>  The important point is that these cmdlets can work together with the Get-Credential cmdlet, in which you can write credentials to connect to equipment (see examples in the script), i.e.  the credentials are not stored in clear text in the script (as I had with plink.exe).  I'm not paranoid, but love to be safe. <br><br><h6>  Parsing output and regular expressions </h6><br>  I was expecting a very romantic parsing of the output of the Cisco iOS shell, because the Invoke-SSH cmdlet shows the output in the Text column, i.e.  passing the output to a variable, we get a large text. <br>  This is where regular expressions come to the rescue.  But who parsys great texts, knows that getting the right fragment from there is not easy enough, but thanks to PowerShell, we brilliantly got out of this situation. <br>  For now, read PowerShell in Action 2-nd Edition.  To anyone who studies PoSh, I highly recommend this book.  And in it, I read about such a thing as a named regexp.  The bottom line is that when PowerShell contains the $ Mathces variable, in which all matches are entered when using regular expressions: <br><br><pre><code class="php hljs">PS [<span class="hljs-number"><span class="hljs-number">13</span></span>] &gt; $Matches PS [<span class="hljs-number"><span class="hljs-number">14</span></span>] &gt; $a=<span class="hljs-string"><span class="hljs-string">"ass 123 saa"</span></span> PS [<span class="hljs-number"><span class="hljs-number">15</span></span>] &gt; $a -match <span class="hljs-string"><span class="hljs-string">"\d+"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> PS [<span class="hljs-number"><span class="hljs-number">16</span></span>] &gt; $Matches Name Value ---- ----- <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">123</span></span></code> </pre> <br>  But that is not all!  The whole point is that if we add <pre> <code class="hljs mel"><code class="php">?   ,   : <br> PS [<span class="hljs-number"><span class="hljs-number">17</span></span>] &gt; $a -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"(?&lt;Numbers&gt;\d+)"</span></span> True PS [<span class="hljs-number"><span class="hljs-number">18</span></span>] &gt; $Matches Name Value ---- ----- Numbers <span class="hljs-number"><span class="hljs-number">123</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">123</span></span> PS [<span class="hljs-number"><span class="hljs-number">19</span></span>] &gt; $Matches.Numbers <span class="hljs-number"><span class="hljs-number">123</span></span></code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { <span class="hljs-string"><span class="hljs-string">"IP  : {0},  {1}"</span></span> -f $IpSwitch,$Port If ($CiscoPhone) {<span class="hljs-string"><span class="hljs-string">"   Cisco IP Phone"</span></span>} Read-Host <span class="hljs-string"><span class="hljs-string">"Press Enter for continue..."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } ##   For (;;) { $ip=Read-host <span class="hljs-string"><span class="hljs-string">"Enter ip"</span></span> If ($ip -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"(\d{1,3}\.){3}\d{1,3}"</span></span>) {<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {Write-Warning <span class="hljs-string"><span class="hljs-string">"Invalid IP address! Try again..."</span></span>} } ##      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((test-connection $ip -quiet) -ne <span class="hljs-string"><span class="hljs-string">"True"</span></span>) { Write-Warning <span class="hljs-string"><span class="hljs-string">"   !"</span></span> Read-Host <span class="hljs-string"><span class="hljs-string">"Press Enter to continue..."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } $cred = get-credential Admin ##      $IpSwitch = <span class="hljs-string"><span class="hljs-string">"10.138.30.1"</span></span> ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt <span class="hljs-string"><span class="hljs-string">"#"</span></span> -Force Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"terminal length 0"</span></span> | out-null Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"ping $ip"</span></span> | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"sh arp | i $ip "</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">text</span></span> | Where-Object {$_ -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"\w"</span></span>}) -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})"</span></span> | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"sh mac address-table address $MAC"</span></span>).Text | where-object {$_ -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> $mac}) | Select-Object -First <span class="hljs-number"><span class="hljs-number">1</span></span>) -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)"</span></span> | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"show mac address-table interface $port"</span></span>).Text | where-object {$_ -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> $port} If (($portInfo | measure).Count -eq <span class="hljs-number"><span class="hljs-number">1</span></span>) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"sh cdp neighbors $port detail"</span></span> -Force).Text ##        <span class="hljs-string"><span class="hljs-string">"Cisco IP phone"</span></span>,     IP . If ($DetailPortInfo -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"Cisco IP phone"</span></span>) {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"IP address: (\d{1,3}\.){3}\d{1,3}"</span></span>}) | Select-Object -First <span class="hljs-number"><span class="hljs-number">1</span></span>) -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})"</span></span> | out-null <span class="hljs-string"><span class="hljs-string">"IP  : {0},  {1}"</span></span> -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          <span class="hljs-number"><span class="hljs-number">1</span></span>  (..      (  PowerShell: <code>get-<span class="hljs-keyword"><span class="hljs-keyword">help</span></span> | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length <span class="hljs-number"><span class="hljs-number">0</span></span></code> <code>((\D{<span class="hljs-number"><span class="hljs-number">2</span></span>}\d{<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>})/|Po)(\d{<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>})(/\d{<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>})?</code> -  ,     .     : Fa5, Gi0/<span class="hljs-number"><span class="hljs-number">2</span></span>, Te2/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> </pre> <code><code class="php">?   ,   : <br> PS [17] &gt; $a -match "(?&lt;Numbers&gt;\d+)" True PS [18] &gt; $Matches Name Value ---- ----- Numbers 123 0 123 PS [19] &gt; $Matches.Numbers 123</code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { "IP  : {0},  {1}" -f $IpSwitch,$Port If ($CiscoPhone) {"   Cisco IP Phone"} Read-Host "Press Enter for continue..." break } ##   For (;;) { $ip=Read-host "Enter ip" If ($ip -match "(\d{1,3}\.){3}\d{1,3}") {break} else {Write-Warning "Invalid IP address! Try again..."} } ##      if ((test-connection $ip -quiet) -ne "True") { Write-Warning "   !" Read-Host "Press Enter to continue..." break } $cred = get-credential Admin ##      $IpSwitch = "10.138.30.1" ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt "#" -Force Invoke-SSH -Connection $conn -Command "terminal length 0" | out-null Invoke-SSH -Connection $conn -Command "ping $ip" | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command "sh arp | i $ip ").text | Where-Object {$_ -match "\w"}) -match "(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})" | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command "sh mac address-table address $MAC").Text | where-object {$_ -match $mac}) | Select-Object -First 1) -match "(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)" | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command "show mac address-table interface $port").Text | where-object {$_ -match $port} If (($portInfo | measure).Count -eq 1) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command "sh cdp neighbors $port detail" -Force).Text ##        "Cisco IP phone",     IP . If ($DetailPortInfo -match "Cisco IP phone") {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -match "IP address: (\d{1,3}\.){3}\d{1,3}"}) | Select-Object -First 1) -match "(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})" | out-null "IP  : {0},  {1}" -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          1  (..      (  PowerShell: <code>get-help | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length 0</code> <code>((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?</code> -  ,     .     : Fa5, Gi0/2, Te2/0/8, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> <h6> <code><code class="php">?   ,   : <br> PS [17] &gt; $a -match "(?&lt;Numbers&gt;\d+)" True PS [18] &gt; $Matches Name Value ---- ----- Numbers 123 0 123 PS [19] &gt; $Matches.Numbers 123</code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { "IP  : {0},  {1}" -f $IpSwitch,$Port If ($CiscoPhone) {"   Cisco IP Phone"} Read-Host "Press Enter for continue..." break } ##   For (;;) { $ip=Read-host "Enter ip" If ($ip -match "(\d{1,3}\.){3}\d{1,3}") {break} else {Write-Warning "Invalid IP address! Try again..."} } ##      if ((test-connection $ip -quiet) -ne "True") { Write-Warning "   !" Read-Host "Press Enter to continue..." break } $cred = get-credential Admin ##      $IpSwitch = "10.138.30.1" ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt "#" -Force Invoke-SSH -Connection $conn -Command "terminal length 0" | out-null Invoke-SSH -Connection $conn -Command "ping $ip" | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command "sh arp | i $ip ").text | Where-Object {$_ -match "\w"}) -match "(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})" | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command "sh mac address-table address $MAC").Text | where-object {$_ -match $mac}) | Select-Object -First 1) -match "(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)" | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command "show mac address-table interface $port").Text | where-object {$_ -match $port} If (($portInfo | measure).Count -eq 1) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command "sh cdp neighbors $port detail" -Force).Text ##        "Cisco IP phone",     IP . If ($DetailPortInfo -match "Cisco IP phone") {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -match "IP address: (\d{1,3}\.){3}\d{1,3}"}) | Select-Object -First 1) -match "(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})" | out-null "IP  : {0},  {1}" -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          1  (..      (  PowerShell: <code>get-help | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length 0</code> <code>((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?</code> -  ,     .     : Fa5, Gi0/2, Te2/0/8, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> </h6> <code><code class="php">?   ,   : <br> PS [17] &gt; $a -match "(?&lt;Numbers&gt;\d+)" True PS [18] &gt; $Matches Name Value ---- ----- Numbers 123 0 123 PS [19] &gt; $Matches.Numbers 123</code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { "IP  : {0},  {1}" -f $IpSwitch,$Port If ($CiscoPhone) {"   Cisco IP Phone"} Read-Host "Press Enter for continue..." break } ##   For (;;) { $ip=Read-host "Enter ip" If ($ip -match "(\d{1,3}\.){3}\d{1,3}") {break} else {Write-Warning "Invalid IP address! Try again..."} } ##      if ((test-connection $ip -quiet) -ne "True") { Write-Warning "   !" Read-Host "Press Enter to continue..." break } $cred = get-credential Admin ##      $IpSwitch = "10.138.30.1" ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt "#" -Force Invoke-SSH -Connection $conn -Command "terminal length 0" | out-null Invoke-SSH -Connection $conn -Command "ping $ip" | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command "sh arp | i $ip ").text | Where-Object {$_ -match "\w"}) -match "(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})" | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command "sh mac address-table address $MAC").Text | where-object {$_ -match $mac}) | Select-Object -First 1) -match "(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)" | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command "show mac address-table interface $port").Text | where-object {$_ -match $port} If (($portInfo | measure).Count -eq 1) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command "sh cdp neighbors $port detail" -Force).Text ##        "Cisco IP phone",     IP . If ($DetailPortInfo -match "Cisco IP phone") {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -match "IP address: (\d{1,3}\.){3}\d{1,3}"}) | Select-Object -First 1) -match "(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})" | out-null "IP  : {0},  {1}" -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          1  (..      (  PowerShell: <code>get-help | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length 0</code> <code>((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?</code> -  ,     .     : Fa5, Gi0/2, Te2/0/8, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> <pre> <code class="hljs mel"><code class="php">?   ,   : <br> PS [<span class="hljs-number"><span class="hljs-number">17</span></span>] &gt; $a -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"(?&lt;Numbers&gt;\d+)"</span></span> True PS [<span class="hljs-number"><span class="hljs-number">18</span></span>] &gt; $Matches Name Value ---- ----- Numbers <span class="hljs-number"><span class="hljs-number">123</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">123</span></span> PS [<span class="hljs-number"><span class="hljs-number">19</span></span>] &gt; $Matches.Numbers <span class="hljs-number"><span class="hljs-number">123</span></span></code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { <span class="hljs-string"><span class="hljs-string">"IP  : {0},  {1}"</span></span> -f $IpSwitch,$Port If ($CiscoPhone) {<span class="hljs-string"><span class="hljs-string">"   Cisco IP Phone"</span></span>} Read-Host <span class="hljs-string"><span class="hljs-string">"Press Enter for continue..."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } ##   For (;;) { $ip=Read-host <span class="hljs-string"><span class="hljs-string">"Enter ip"</span></span> If ($ip -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"(\d{1,3}\.){3}\d{1,3}"</span></span>) {<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {Write-Warning <span class="hljs-string"><span class="hljs-string">"Invalid IP address! Try again..."</span></span>} } ##      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((test-connection $ip -quiet) -ne <span class="hljs-string"><span class="hljs-string">"True"</span></span>) { Write-Warning <span class="hljs-string"><span class="hljs-string">"   !"</span></span> Read-Host <span class="hljs-string"><span class="hljs-string">"Press Enter to continue..."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } $cred = get-credential Admin ##      $IpSwitch = <span class="hljs-string"><span class="hljs-string">"10.138.30.1"</span></span> ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt <span class="hljs-string"><span class="hljs-string">"#"</span></span> -Force Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"terminal length 0"</span></span> | out-null Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"ping $ip"</span></span> | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"sh arp | i $ip "</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">text</span></span> | Where-Object {$_ -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"\w"</span></span>}) -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})"</span></span> | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"sh mac address-table address $MAC"</span></span>).Text | where-object {$_ -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> $mac}) | Select-Object -First <span class="hljs-number"><span class="hljs-number">1</span></span>) -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)"</span></span> | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"show mac address-table interface $port"</span></span>).Text | where-object {$_ -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> $port} If (($portInfo | measure).Count -eq <span class="hljs-number"><span class="hljs-number">1</span></span>) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command <span class="hljs-string"><span class="hljs-string">"sh cdp neighbors $port detail"</span></span> -Force).Text ##        <span class="hljs-string"><span class="hljs-string">"Cisco IP phone"</span></span>,     IP . If ($DetailPortInfo -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"Cisco IP phone"</span></span>) {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"IP address: (\d{1,3}\.){3}\d{1,3}"</span></span>}) | Select-Object -First <span class="hljs-number"><span class="hljs-number">1</span></span>) -<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})"</span></span> | out-null <span class="hljs-string"><span class="hljs-string">"IP  : {0},  {1}"</span></span> -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          <span class="hljs-number"><span class="hljs-number">1</span></span>  (..      (  PowerShell: <code>get-<span class="hljs-keyword"><span class="hljs-keyword">help</span></span> | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length <span class="hljs-number"><span class="hljs-number">0</span></span></code> <code>((\D{<span class="hljs-number"><span class="hljs-number">2</span></span>}\d{<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>})/|Po)(\d{<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>})(/\d{<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>})?</code> -  ,     .     : Fa5, Gi0/<span class="hljs-number"><span class="hljs-number">2</span></span>, Te2/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> </pre> <code><code class="php">?   ,   : <br> PS [17] &gt; $a -match "(?&lt;Numbers&gt;\d+)" True PS [18] &gt; $Matches Name Value ---- ----- Numbers 123 0 123 PS [19] &gt; $Matches.Numbers 123</code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { "IP  : {0},  {1}" -f $IpSwitch,$Port If ($CiscoPhone) {"   Cisco IP Phone"} Read-Host "Press Enter for continue..." break } ##   For (;;) { $ip=Read-host "Enter ip" If ($ip -match "(\d{1,3}\.){3}\d{1,3}") {break} else {Write-Warning "Invalid IP address! Try again..."} } ##      if ((test-connection $ip -quiet) -ne "True") { Write-Warning "   !" Read-Host "Press Enter to continue..." break } $cred = get-credential Admin ##      $IpSwitch = "10.138.30.1" ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt "#" -Force Invoke-SSH -Connection $conn -Command "terminal length 0" | out-null Invoke-SSH -Connection $conn -Command "ping $ip" | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command "sh arp | i $ip ").text | Where-Object {$_ -match "\w"}) -match "(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})" | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command "sh mac address-table address $MAC").Text | where-object {$_ -match $mac}) | Select-Object -First 1) -match "(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)" | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command "show mac address-table interface $port").Text | where-object {$_ -match $port} If (($portInfo | measure).Count -eq 1) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command "sh cdp neighbors $port detail" -Force).Text ##        "Cisco IP phone",     IP . If ($DetailPortInfo -match "Cisco IP phone") {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -match "IP address: (\d{1,3}\.){3}\d{1,3}"}) | Select-Object -First 1) -match "(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})" | out-null "IP  : {0},  {1}" -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          1  (..      (  PowerShell: <code>get-help | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length 0</code> <code>((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?</code> -  ,     .     : Fa5, Gi0/2, Te2/0/8, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> <ul><li> <code><code class="php">?   ,   : <br> PS [17] &gt; $a -match "(?&lt;Numbers&gt;\d+)" True PS [18] &gt; $Matches Name Value ---- ----- Numbers 123 0 123 PS [19] &gt; $Matches.Numbers 123</code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { "IP  : {0},  {1}" -f $IpSwitch,$Port If ($CiscoPhone) {"   Cisco IP Phone"} Read-Host "Press Enter for continue..." break } ##   For (;;) { $ip=Read-host "Enter ip" If ($ip -match "(\d{1,3}\.){3}\d{1,3}") {break} else {Write-Warning "Invalid IP address! Try again..."} } ##      if ((test-connection $ip -quiet) -ne "True") { Write-Warning "   !" Read-Host "Press Enter to continue..." break } $cred = get-credential Admin ##      $IpSwitch = "10.138.30.1" ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt "#" -Force Invoke-SSH -Connection $conn -Command "terminal length 0" | out-null Invoke-SSH -Connection $conn -Command "ping $ip" | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command "sh arp | i $ip ").text | Where-Object {$_ -match "\w"}) -match "(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})" | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command "sh mac address-table address $MAC").Text | where-object {$_ -match $mac}) | Select-Object -First 1) -match "(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)" | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command "show mac address-table interface $port").Text | where-object {$_ -match $port} If (($portInfo | measure).Count -eq 1) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command "sh cdp neighbors $port detail" -Force).Text ##        "Cisco IP phone",     IP . If ($DetailPortInfo -match "Cisco IP phone") {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -match "IP address: (\d{1,3}\.){3}\d{1,3}"}) | Select-Object -First 1) -match "(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})" | out-null "IP  : {0},  {1}" -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          1  (..      (  PowerShell: <code>get-help | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length 0</code> <code>((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?</code> -  ,     .     : Fa5, Gi0/2, Te2/0/8, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> </li> <li> <code><code class="php">?   ,   : <br> PS [17] &gt; $a -match "(?&lt;Numbers&gt;\d+)" True PS [18] &gt; $Matches Name Value ---- ----- Numbers 123 0 123 PS [19] &gt; $Matches.Numbers 123</code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { "IP  : {0},  {1}" -f $IpSwitch,$Port If ($CiscoPhone) {"   Cisco IP Phone"} Read-Host "Press Enter for continue..." break } ##   For (;;) { $ip=Read-host "Enter ip" If ($ip -match "(\d{1,3}\.){3}\d{1,3}") {break} else {Write-Warning "Invalid IP address! Try again..."} } ##      if ((test-connection $ip -quiet) -ne "True") { Write-Warning "   !" Read-Host "Press Enter to continue..." break } $cred = get-credential Admin ##      $IpSwitch = "10.138.30.1" ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt "#" -Force Invoke-SSH -Connection $conn -Command "terminal length 0" | out-null Invoke-SSH -Connection $conn -Command "ping $ip" | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command "sh arp | i $ip ").text | Where-Object {$_ -match "\w"}) -match "(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})" | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command "sh mac address-table address $MAC").Text | where-object {$_ -match $mac}) | Select-Object -First 1) -match "(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)" | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command "show mac address-table interface $port").Text | where-object {$_ -match $port} If (($portInfo | measure).Count -eq 1) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command "sh cdp neighbors $port detail" -Force).Text ##        "Cisco IP phone",     IP . If ($DetailPortInfo -match "Cisco IP phone") {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -match "IP address: (\d{1,3}\.){3}\d{1,3}"}) | Select-Object -First 1) -match "(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})" | out-null "IP  : {0},  {1}" -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          1  (..      (  PowerShell: <code>get-help | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length 0</code> <code>((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?</code> -  ,     .     : Fa5, Gi0/2, Te2/0/8, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> </li> <li> <code><code class="php">?   ,   : <br> PS [17] &gt; $a -match "(?&lt;Numbers&gt;\d+)" True PS [18] &gt; $Matches Name Value ---- ----- Numbers 123 0 123 PS [19] &gt; $Matches.Numbers 123</code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { "IP  : {0},  {1}" -f $IpSwitch,$Port If ($CiscoPhone) {"   Cisco IP Phone"} Read-Host "Press Enter for continue..." break } ##   For (;;) { $ip=Read-host "Enter ip" If ($ip -match "(\d{1,3}\.){3}\d{1,3}") {break} else {Write-Warning "Invalid IP address! Try again..."} } ##      if ((test-connection $ip -quiet) -ne "True") { Write-Warning "   !" Read-Host "Press Enter to continue..." break } $cred = get-credential Admin ##      $IpSwitch = "10.138.30.1" ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt "#" -Force Invoke-SSH -Connection $conn -Command "terminal length 0" | out-null Invoke-SSH -Connection $conn -Command "ping $ip" | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command "sh arp | i $ip ").text | Where-Object {$_ -match "\w"}) -match "(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})" | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command "sh mac address-table address $MAC").Text | where-object {$_ -match $mac}) | Select-Object -First 1) -match "(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)" | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command "show mac address-table interface $port").Text | where-object {$_ -match $port} If (($portInfo | measure).Count -eq 1) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command "sh cdp neighbors $port detail" -Force).Text ##        "Cisco IP phone",     IP . If ($DetailPortInfo -match "Cisco IP phone") {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -match "IP address: (\d{1,3}\.){3}\d{1,3}"}) | Select-Object -First 1) -match "(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})" | out-null "IP  : {0},  {1}" -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          1  (..      (  PowerShell: <code>get-help | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length 0</code> <code>((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?</code> -  ,     .     : Fa5, Gi0/2, Te2/0/8, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> </li> <li> <code><code class="php">?   ,   : <br> PS [17] &gt; $a -match "(?&lt;Numbers&gt;\d+)" True PS [18] &gt; $Matches Name Value ---- ----- Numbers 123 0 123 PS [19] &gt; $Matches.Numbers 123</code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { "IP  : {0},  {1}" -f $IpSwitch,$Port If ($CiscoPhone) {"   Cisco IP Phone"} Read-Host "Press Enter for continue..." break } ##   For (;;) { $ip=Read-host "Enter ip" If ($ip -match "(\d{1,3}\.){3}\d{1,3}") {break} else {Write-Warning "Invalid IP address! Try again..."} } ##      if ((test-connection $ip -quiet) -ne "True") { Write-Warning "   !" Read-Host "Press Enter to continue..." break } $cred = get-credential Admin ##      $IpSwitch = "10.138.30.1" ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt "#" -Force Invoke-SSH -Connection $conn -Command "terminal length 0" | out-null Invoke-SSH -Connection $conn -Command "ping $ip" | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command "sh arp | i $ip ").text | Where-Object {$_ -match "\w"}) -match "(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})" | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command "sh mac address-table address $MAC").Text | where-object {$_ -match $mac}) | Select-Object -First 1) -match "(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)" | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command "show mac address-table interface $port").Text | where-object {$_ -match $port} If (($portInfo | measure).Count -eq 1) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command "sh cdp neighbors $port detail" -Force).Text ##        "Cisco IP phone",     IP . If ($DetailPortInfo -match "Cisco IP phone") {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -match "IP address: (\d{1,3}\.){3}\d{1,3}"}) | Select-Object -First 1) -match "(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})" | out-null "IP  : {0},  {1}" -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          1  (..      (  PowerShell: <code>get-help | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length 0</code> <code>((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?</code> -  ,     .     : Fa5, Gi0/2, Te2/0/8, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> </li> <li> <code><code class="php">?   ,   : <br> PS [17] &gt; $a -match "(?&lt;Numbers&gt;\d+)" True PS [18] &gt; $Matches Name Value ---- ----- Numbers 123 0 123 PS [19] &gt; $Matches.Numbers 123</code> <br>                (  split!).     ,       (,     PowerShell    ),        . <br> ,     ? <br> <br>   <br> ,  . <br> <code class="php">##       Function LastSwitch { "IP  : {0},  {1}" -f $IpSwitch,$Port If ($CiscoPhone) {"   Cisco IP Phone"} Read-Host "Press Enter for continue..." break } ##   For (;;) { $ip=Read-host "Enter ip" If ($ip -match "(\d{1,3}\.){3}\d{1,3}") {break} else {Write-Warning "Invalid IP address! Try again..."} } ##      if ((test-connection $ip -quiet) -ne "True") { Write-Warning "   !" Read-Host "Press Enter to continue..." break } $cred = get-credential Admin ##      $IpSwitch = "10.138.30.1" ##   $MAC = $null $CiscoPhone = $false For (;;) { $conn = Connect-ssh -Server $IpSwitch -Credential $cred -ShellPrompt "#" -Force Invoke-SSH -Connection $conn -Command "terminal length 0" | out-null Invoke-SSH -Connection $conn -Command "ping $ip" | out-null If (!$MAC) { ##     ((Invoke-SSH -Connection $conn -Command "sh arp | i $ip ").text | Where-Object {$_ -match "\w"}) -match "(?&lt;MAC&gt;\w{4}\.\w{4}\.\w{4})" | out-null $MAC = $Matches.MAC } ##  ,     (((Invoke-SSH -Connection $conn -Command "sh mac address-table address $MAC").Text | where-object {$_ -match $mac}) | Select-Object -First 1) -match "(?&lt;port&gt;((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?)" | out-null $port = $Matches.Port ##       $portInfo = (Invoke-SSH -Connection $conn -Command "show mac address-table interface $port").Text | where-object {$_ -match $port} If (($portInfo | measure).Count -eq 1) {LastSwitch} ##    $DetailPortInfo = (Invoke-SSH -Connection $conn -Command "sh cdp neighbors $port detail" -Force).Text ##        "Cisco IP phone",     IP . If ($DetailPortInfo -match "Cisco IP phone") {$CiscoPhone = $true; LastSwitch} (($DetailPortInfo | where-object {$_ -match "IP address: (\d{1,3}\.){3}\d{1,3}"}) | Select-Object -First 1) -match "(?&lt;ip&gt;(\d{1,3}\.){3}\d{1,3})" | out-null "IP  : {0},  {1}" -f $IpSwitch,$Port $IpSwitch = $Matches.IP Disconnect-SSH $conn }</code> <br>  : <br>        Get-Credential.       ,   ,      .      <a href="http://bsonposh.com/archives/338"></a>          1  (..      (  PowerShell: <code>get-help | more</code> )).    , .. Invoke-SSH   ,       .    ,          <code>terminal length 0</code> <code>((\D{2}\d{1,3})/|Po)(\d{1,3})(/\d{1,3})?</code> -  ,     .     : Fa5, Gi0/2, Te2/0/8, Po255  .. (    , ,  )         Cisco IP phone,       ,             ( Invoke-SSH),        (out-null)</code> </li> </ul></div><p>Source: <a href="https://habr.com/ru/post/149191/">https://habr.com/ru/post/149191/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149181/index.html">Anti-spam module for Kohana</a></li>
<li><a href="../149182/index.html">Subaru and Arduino: SSM1 protocol. Handshake</a></li>
<li><a href="../149184/index.html">Algorithm predicts crime by tracking mobile phones</a></li>
<li><a href="../149187/index.html">HybridAuth - website integration with social networks</a></li>
<li><a href="../149190/index.html">Samsung Galaxy Note 10.1: Digital Canvas</a></li>
<li><a href="../149193/index.html">Optimization</a></li>
<li><a href="../149194/index.html">High Performance Conference - August 9</a></li>
<li><a href="../149196/index.html">How can I start creating my own WMS</a></li>
<li><a href="../149197/index.html">The application is financially successful if it brought me</a></li>
<li><a href="../149198/index.html">John Carmack: Linux is not a competitive platform for selling games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>