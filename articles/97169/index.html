<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development and modification of firmware for Android phones. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part, we learned how to repack official firmware from RUU format into the update package format, which gave us the opportunity to use the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development and modification of firmware for Android phones. Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/blogs/android/96609/">first part,</a> we learned how to repack official firmware from RUU format into the update package format, which gave us the opportunity to use the firmware we created without fear of overwriting the modified <em>recovery rom</em> .  And in the meantime, while HTC is <a href="http://www.engadget.com/2010/06/17/htc-slaps-phone-firmware-site-with-cease-and-desist-letter/">fighting with good resources</a> , we will continue to study and improve the firmware. <br>  In the previous part, even though we created a firmware that loads and works like a clock, we would like to extend the basic functionality of it.  One of the most sought-after extensions is support for working with root privileges ( <em>root</em> ).  Also here is the integration of <a href="http://www.busybox.net/">busybox</a> .  In addition, we will learn how to run arbitrary scripts at system startup and adapt <em>ramdisk to</em> fit our needs. <br><br><h2>  Busybox </h2><br><br>  busybox is a <a href="http://ru.wikipedia.org/wiki/BusyBox">set of console unix utilities</a> , focused on small size and performance, which is so important for mobile systems.  Together with the <em>android</em> system comes its own set of utilities - a <a href="http://android.git.kernel.org/%3Fp%3Dplatform/system/core.git%3Ba%3Dtree%3Bf%3Dtoolbox%3Bhb%3DHEAD">toolbox</a> , which provides the minimum necessary functionality for the system, and as a result, is simpler in terms of quantity and function.  The presence of <em>busybox</em> in the system, on the one hand, will allow us, as developers, to feel more comfortable when working remotely on the device, on the other hand, will allow us to write complex scripts, and, for example, implement a mechanism to run our own scripts at boot time using <em>run-parts</em> .  Also it is worth considering that for some <em>android</em> applications (especially those that use <em>root</em> ) the presence of busybox is mandatory. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order to simplify your life, we will use the already collected by the <em>busybox</em> under our platform.  For example, 1.16.0 from the well-known <em>modaco</em> can be <em>picked</em> <a href="http://www.mediafire.com/%3F1mjkuwymzrz">up here</a> .  Whoever has the courage, and has too much time, can collect the busybox from the <a href="http://git.busybox.net/busybox/tree/%3Fh%3D1_16_stable">official tree</a> (a bit of the adaptation file for the Androids <em>toolchain</em> , and the <em>bionic</em> - android <em>libc</em> implementation), or use <a href="http://forum.androidfan.ru/index.php%3Fshowtopic%3D1307%26view%3Dfindpost%26p%3D13344">the XVilka</a> assembly <a href="http://forum.androidfan.ru/index.php%3Fshowtopic%3D1307%26view%3Dfindpost%26p%3D13344">instructions</a> with <em>crosstool-ng</em> and <a href="http://www.uclibc.org/">uCLibc</a> , or assemble from branches <a href="http://github.com/cyanogen/android_external_busybox">cyanogenmod</a> , where <em>bionic</em> problems have already been solved. <br>  So, before we add <em>busybox</em> , we need to solve a few ideological points in the system: <br><ul><li>  With the general scheme of using <em>busybox</em> / <em>toolbox,</em> we need to put the executable file and create links to it with the names of the <em>applets</em> .  Links must be accessible from the <em>$ PATH</em> variable.  Where to store links for <em>busybox</em> ?  In <em>/ system / bin</em> ?  <em>/ system / xbin</em> ?  separate directory? </li><li>  Use pre-created links, or generate at the stage of installing the firmware? <br>  In the example from the first part, we used the previously created links for the <em>toolbox</em> .  But this option is difficult if firmware development is conducted on a Windows system, where there are certain problems with symbolic links. </li><li>  Depending on the <em>buildbox of busybox,</em> we can <em>override the</em> set of commands that is already available in the <em>toolbox</em> .  Who is more important? <br>  On the one hand, <em>busybox</em> provides a wider functionality (as an example: the letter assignment of permissions for <em>chmod</em> ), but on the other hand, we may want to exclude already implemented utilities from <em>busybox</em> to reduce the size of the set. </li></ul><br>  To find out which <em>applets are</em> supported by <em>busybox</em> , just run it on the device with no parameters: <br><blockquote><ol><li> <code><font color="black">$ adb remount <font color="#000000"><b>&amp;&amp;</b></font> adb push busybox <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> $ adb shell <font color="#c20cb9"><b>chmod</b></font> 0755 <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox $ adb shell <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>tail</b></font> tcpsvd, <font color="#c20cb9"><b>tee</b></font> , telnet, telnetd, <font color="#7a0874"><b>test</b></font> , tftp, tftpd, <font color="#000000"><b>time</b></font> , timeout, top, <font color="#c20cb9"><b>touch</b></font> , <font color="#c20cb9"><b>tr</b></font> , traceroute, <font color="#c20cb9"><b>true</b></font> , tty, ttysize, tunctl, udpsvd, <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>uname</b></font> , uncompress, unexpand, <font color="#c20cb9"><b>uniq</b></font> , unix2dos, unlzma, unlzop, <font color="#c20cb9"><b>unzip</b></font> , <font color="#c20cb9"><b>uptime</b></font> , usleep, uudecode, uuencode, vconfig, <font color="#c20cb9"><b>vi</b></font> , vlock, volname, watch, watchdog, <font color="#c20cb9"><b>wc</b></font> , <font color="#c20cb9"><b>wget</b></font> , <font color="#c20cb9"><b>which</b></font> , <font color="#c20cb9"><b>who</b></font> , <font color="#c20cb9"><b>whoami</b></font> , <font color="#c20cb9"><b>xargs</b></font> , <font color="#c20cb9"><b>yes</b></font> , <font color="#c20cb9"><b>zcat</b></font> , zcip</font></code> </li> <li> <code><font color="black">$ adb remount <font color="#000000"><b>&amp;&amp;</b></font> adb push busybox <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> $ adb shell <font color="#c20cb9"><b>chmod</b></font> 0755 <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox $ adb shell <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>tail</b></font> tcpsvd, <font color="#c20cb9"><b>tee</b></font> , telnet, telnetd, <font color="#7a0874"><b>test</b></font> , tftp, tftpd, <font color="#000000"><b>time</b></font> , timeout, top, <font color="#c20cb9"><b>touch</b></font> , <font color="#c20cb9"><b>tr</b></font> , traceroute, <font color="#c20cb9"><b>true</b></font> , tty, ttysize, tunctl, udpsvd, <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>uname</b></font> , uncompress, unexpand, <font color="#c20cb9"><b>uniq</b></font> , unix2dos, unlzma, unlzop, <font color="#c20cb9"><b>unzip</b></font> , <font color="#c20cb9"><b>uptime</b></font> , usleep, uudecode, uuencode, vconfig, <font color="#c20cb9"><b>vi</b></font> , vlock, volname, watch, watchdog, <font color="#c20cb9"><b>wc</b></font> , <font color="#c20cb9"><b>wget</b></font> , <font color="#c20cb9"><b>which</b></font> , <font color="#c20cb9"><b>who</b></font> , <font color="#c20cb9"><b>whoami</b></font> , <font color="#c20cb9"><b>xargs</b></font> , <font color="#c20cb9"><b>yes</b></font> , <font color="#c20cb9"><b>zcat</b></font> , zcip</font></code> </li> <li> <code><font color="black">$ adb remount <font color="#000000"><b>&amp;&amp;</b></font> adb push busybox <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> $ adb shell <font color="#c20cb9"><b>chmod</b></font> 0755 <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox $ adb shell <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>tail</b></font> tcpsvd, <font color="#c20cb9"><b>tee</b></font> , telnet, telnetd, <font color="#7a0874"><b>test</b></font> , tftp, tftpd, <font color="#000000"><b>time</b></font> , timeout, top, <font color="#c20cb9"><b>touch</b></font> , <font color="#c20cb9"><b>tr</b></font> , traceroute, <font color="#c20cb9"><b>true</b></font> , tty, ttysize, tunctl, udpsvd, <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>uname</b></font> , uncompress, unexpand, <font color="#c20cb9"><b>uniq</b></font> , unix2dos, unlzma, unlzop, <font color="#c20cb9"><b>unzip</b></font> , <font color="#c20cb9"><b>uptime</b></font> , usleep, uudecode, uuencode, vconfig, <font color="#c20cb9"><b>vi</b></font> , vlock, volname, watch, watchdog, <font color="#c20cb9"><b>wc</b></font> , <font color="#c20cb9"><b>wget</b></font> , <font color="#c20cb9"><b>which</b></font> , <font color="#c20cb9"><b>who</b></font> , <font color="#c20cb9"><b>whoami</b></font> , <font color="#c20cb9"><b>xargs</b></font> , <font color="#c20cb9"><b>yes</b></font> , <font color="#c20cb9"><b>zcat</b></font> , zcip</font></code> </li> <li> <code><font color="black">$ adb remount <font color="#000000"><b>&amp;&amp;</b></font> adb push busybox <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> $ adb shell <font color="#c20cb9"><b>chmod</b></font> 0755 <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox $ adb shell <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>tail</b></font> tcpsvd, <font color="#c20cb9"><b>tee</b></font> , telnet, telnetd, <font color="#7a0874"><b>test</b></font> , tftp, tftpd, <font color="#000000"><b>time</b></font> , timeout, top, <font color="#c20cb9"><b>touch</b></font> , <font color="#c20cb9"><b>tr</b></font> , traceroute, <font color="#c20cb9"><b>true</b></font> , tty, ttysize, tunctl, udpsvd, <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>uname</b></font> , uncompress, unexpand, <font color="#c20cb9"><b>uniq</b></font> , unix2dos, unlzma, unlzop, <font color="#c20cb9"><b>unzip</b></font> , <font color="#c20cb9"><b>uptime</b></font> , usleep, uudecode, uuencode, vconfig, <font color="#c20cb9"><b>vi</b></font> , vlock, volname, watch, watchdog, <font color="#c20cb9"><b>wc</b></font> , <font color="#c20cb9"><b>wget</b></font> , <font color="#c20cb9"><b>which</b></font> , <font color="#c20cb9"><b>who</b></font> , <font color="#c20cb9"><b>whoami</b></font> , <font color="#c20cb9"><b>xargs</b></font> , <font color="#c20cb9"><b>yes</b></font> , <font color="#c20cb9"><b>zcat</b></font> , zcip</font></code> </li> <li> <code><font color="black">$ adb remount <font color="#000000"><b>&amp;&amp;</b></font> adb push busybox <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> $ adb shell <font color="#c20cb9"><b>chmod</b></font> 0755 <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox $ adb shell <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>tail</b></font> tcpsvd, <font color="#c20cb9"><b>tee</b></font> , telnet, telnetd, <font color="#7a0874"><b>test</b></font> , tftp, tftpd, <font color="#000000"><b>time</b></font> , timeout, top, <font color="#c20cb9"><b>touch</b></font> , <font color="#c20cb9"><b>tr</b></font> , traceroute, <font color="#c20cb9"><b>true</b></font> , tty, ttysize, tunctl, udpsvd, <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>uname</b></font> , uncompress, unexpand, <font color="#c20cb9"><b>uniq</b></font> , unix2dos, unlzma, unlzop, <font color="#c20cb9"><b>unzip</b></font> , <font color="#c20cb9"><b>uptime</b></font> , usleep, uudecode, uuencode, vconfig, <font color="#c20cb9"><b>vi</b></font> , vlock, volname, watch, watchdog, <font color="#c20cb9"><b>wc</b></font> , <font color="#c20cb9"><b>wget</b></font> , <font color="#c20cb9"><b>which</b></font> , <font color="#c20cb9"><b>who</b></font> , <font color="#c20cb9"><b>whoami</b></font> , <font color="#c20cb9"><b>xargs</b></font> , <font color="#c20cb9"><b>yes</b></font> , <font color="#c20cb9"><b>zcat</b></font> , zcip</font></code> </li> <li> <code><font color="black">$ adb remount <font color="#000000"><b>&amp;&amp;</b></font> adb push busybox <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> $ adb shell <font color="#c20cb9"><b>chmod</b></font> 0755 <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox $ adb shell <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>tail</b></font> tcpsvd, <font color="#c20cb9"><b>tee</b></font> , telnet, telnetd, <font color="#7a0874"><b>test</b></font> , tftp, tftpd, <font color="#000000"><b>time</b></font> , timeout, top, <font color="#c20cb9"><b>touch</b></font> , <font color="#c20cb9"><b>tr</b></font> , traceroute, <font color="#c20cb9"><b>true</b></font> , tty, ttysize, tunctl, udpsvd, <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>uname</b></font> , uncompress, unexpand, <font color="#c20cb9"><b>uniq</b></font> , unix2dos, unlzma, unlzop, <font color="#c20cb9"><b>unzip</b></font> , <font color="#c20cb9"><b>uptime</b></font> , usleep, uudecode, uuencode, vconfig, <font color="#c20cb9"><b>vi</b></font> , vlock, volname, watch, watchdog, <font color="#c20cb9"><b>wc</b></font> , <font color="#c20cb9"><b>wget</b></font> , <font color="#c20cb9"><b>which</b></font> , <font color="#c20cb9"><b>who</b></font> , <font color="#c20cb9"><b>whoami</b></font> , <font color="#c20cb9"><b>xargs</b></font> , <font color="#c20cb9"><b>yes</b></font> , <font color="#c20cb9"><b>zcat</b></font> , zcip</font></code> </li> <li> <code><font color="black">$ adb remount <font color="#000000"><b>&amp;&amp;</b></font> adb push busybox <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> $ adb shell <font color="#c20cb9"><b>chmod</b></font> 0755 <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox $ adb shell <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>tail</b></font> tcpsvd, <font color="#c20cb9"><b>tee</b></font> , telnet, telnetd, <font color="#7a0874"><b>test</b></font> , tftp, tftpd, <font color="#000000"><b>time</b></font> , timeout, top, <font color="#c20cb9"><b>touch</b></font> , <font color="#c20cb9"><b>tr</b></font> , traceroute, <font color="#c20cb9"><b>true</b></font> , tty, ttysize, tunctl, udpsvd, <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>uname</b></font> , uncompress, unexpand, <font color="#c20cb9"><b>uniq</b></font> , unix2dos, unlzma, unlzop, <font color="#c20cb9"><b>unzip</b></font> , <font color="#c20cb9"><b>uptime</b></font> , usleep, uudecode, uuencode, vconfig, <font color="#c20cb9"><b>vi</b></font> , vlock, volname, watch, watchdog, <font color="#c20cb9"><b>wc</b></font> , <font color="#c20cb9"><b>wget</b></font> , <font color="#c20cb9"><b>which</b></font> , <font color="#c20cb9"><b>who</b></font> , <font color="#c20cb9"><b>whoami</b></font> , <font color="#c20cb9"><b>xargs</b></font> , <font color="#c20cb9"><b>yes</b></font> , <font color="#c20cb9"><b>zcat</b></font> , zcip</font></code> </li> <li> <code><font color="black">$ adb remount <font color="#000000"><b>&amp;&amp;</b></font> adb push busybox <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> $ adb shell <font color="#c20cb9"><b>chmod</b></font> 0755 <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox $ adb shell <font color="#000000"><b>/</b></font> cache <font color="#000000"><b>/</b></font> busybox <font color="#000000"><b>|</b></font> <font color="#c20cb9"><b>tail</b></font> tcpsvd, <font color="#c20cb9"><b>tee</b></font> , telnet, telnetd, <font color="#7a0874"><b>test</b></font> , tftp, tftpd, <font color="#000000"><b>time</b></font> , timeout, top, <font color="#c20cb9"><b>touch</b></font> , <font color="#c20cb9"><b>tr</b></font> , traceroute, <font color="#c20cb9"><b>true</b></font> , tty, ttysize, tunctl, udpsvd, <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>uname</b></font> , uncompress, unexpand, <font color="#c20cb9"><b>uniq</b></font> , unix2dos, unlzma, unlzop, <font color="#c20cb9"><b>unzip</b></font> , <font color="#c20cb9"><b>uptime</b></font> , usleep, uudecode, uuencode, vconfig, <font color="#c20cb9"><b>vi</b></font> , vlock, volname, watch, watchdog, <font color="#c20cb9"><b>wc</b></font> , <font color="#c20cb9"><b>wget</b></font> , <font color="#c20cb9"><b>which</b></font> , <font color="#c20cb9"><b>who</b></font> , <font color="#c20cb9"><b>whoami</b></font> , <font color="#c20cb9"><b>xargs</b></font> , <font color="#c20cb9"><b>yes</b></font> , <font color="#c20cb9"><b>zcat</b></font> , zcip</font></code> </li> </ol></blockquote><br>  For a list of available applets for the <em>toolbox,</em> we will focus on those links that were created in the original firmware. <br><blockquote><ol><li>  $ <font color="#c20cb9"><b>find</b></font> habrrom <font color="#000000"><b>/</b></font> system <font color="#000000"><b>/</b></font> bin <font color="#000000"><b>/</b></font> <font color="#660033">-type</font> l <font color="#660033">-printf</font> <font color="#ff0000">'% f,'</font> <font color="#000000"><b>|</b></font>  <font color="#c20cb9"><b>tail</b></font> </li><li>  getprop, insmod, <font color="#c20cb9"><b>ifconfig</b></font> , setprop, wipe, watchprops, log, <font color="#c20cb9"><b>sync</b></font> , schedtop, ioctl, <font color="#c20cb9"><b>rm</b></font> , </li><li>  <font color="#c20cb9"><b>sleep</b></font> , notify, sendevent, <font color="#c20cb9"><b>dmesg</b></font> , <font color="#c20cb9"><b>df</b></font> , route, <font color="#c20cb9"><b>vmstat</b></font> , <font color="#c20cb9"><b>mv</b></font> , iftop, rmmod, </li><li>  <font color="#c20cb9"><b>dd</b></font> , renice, <font color="#c20cb9"><b>kill</b></font> , <font color="#c20cb9"><b>mount</b></font> , start, <font color="#c20cb9"><b>rmdir</b></font> , <font color="#c20cb9"><b>ps</b></font> , <font color="#c20cb9"><b>ln</b></font> , <font color="#c20cb9"><b>cmp</b></font> , dumpcrash, top, getevent, </li><li>  <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>mkdir</b></font> , setconsole, printenv, newfs_msdos, <font color="#c20cb9"><b>chown</b></font> , <font color="#c20cb9"><b>cat</b></font> , hd, <font color="#c20cb9"><b>chmod</b></font> , <font color="#c20cb9"><b>date</b></font> , </li><li>  stop, smd, <font color="#c20cb9"><b>netstat</b></font> , <font color="#c20cb9"><b>ls</b></font> , <font color="#c20cb9"><b>lsmod</b></font> , <font color="#c20cb9"><b>id</b></font> , </li></ol></blockquote><br>  The only link pointing <u>not</u> to the <em>toolbox</em> is <em>dumpcrash</em> : <br><blockquote><ol><li>  $ <font color="#c20cb9"><b>ls</b></font> <font color="#660033">-o</font> habrrom <font color="#000000"><b>/</b></font> system <font color="#000000"><b>/</b></font> bin <font color="#000000"><b>/</b></font> <font color="#000000"><b>|</b></font>  <font color="#c20cb9"><b>grep</b></font> dumpstate </li><li>  lrwxrwxrwx <font color="#000000">1</font> astar <font color="#000000">9</font> <font color="#000000">2010</font> -06- <font color="#000000">16</font> 03: <font color="#000000">59</font> dumpcrash - <font color="#000000"><b>&gt;</b></font> dumpstate </li><li>  <font color="#660033">-rwxr-xr-x</font> <font color="#000000">1</font> astar <font color="#000000">14296</font> <font color="#000000">2010</font> -06- <font color="#000000">16</font> 03: <font color="#000000">55</font> dumpstate </li></ol></blockquote><br>  This is also worth considering when building the update script. <br>  Suppose we decided that the main thing we will have is <em>busybox</em> .  I found that the following <em>toolbox</em> applets <em>are</em> unique: <ol><li> <code><font color="black">getevent, getprop, iftop, ioctl, log, newfs_msdos, notify, schedtop, sendevent, setprop, smd, start, stop, top, <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>vmstat</b></font> , watchprops, wipe</font></code> </li> <li> <code><font color="black">getevent, getprop, iftop, ioctl, log, newfs_msdos, notify, schedtop, sendevent, setprop, smd, start, stop, top, <font color="#c20cb9"><b>umount</b></font> , <font color="#c20cb9"><b>vmstat</b></font> , watchprops, wipe</font></code> </li> </ol>  And suppose that we want to create links during the installation of the firmware, for this we need to add the following lines to the update script: <br><blockquote><ol><li>  symlink dumpstate SYSTEM: bin <font color="#000000"><b>/</b></font> dumpcrash </li><li>  <font color="#666666"><i>#</i></font> </li><li>  symlink toolbox SYSTEM: bin <font color="#000000"><b>/</b></font> getprop </li><li>  <font color="#666666"><i># repeat the procedure for the necessary toolbox applets</i></font> </li><li>  symlink busybox SYSTEM: xbin <font color="#000000"><b>/</b></font> <font color="#7a0874"><b>[</b></font> </li><li>  <font color="#666666"><i># repeat procedure for all busybox applets</i></font> </li></ol></blockquote><br>  Do not forget to remove links from the firmware itself. <ol><li> <code><font color="black">$ <font color="#c20cb9"><b>rm</b></font> <font color="#000000"><b>`</b></font> <font color="#c20cb9"><b>find</b></font> habrrom <font color="#000000"><b>/</b></font> system <font color="#000000"><b>/</b></font> bin <font color="#000000"><b>/</b></font> <font color="#660033">-type</font> l <font color="#000000"><b>`</b></font></font></code> </li> </ol>  Plus, we need to set the correct rights to <em>busybox.</em> <ol><li> <code><font color="black">set_perm 0 0 04755 SYSTEM:xbin/busybox</font></code> </li> </ol>  Let's try to complicate your task.  Let's place links for <em>busybox</em> in a separate directory, for example <em>/ system / xbin / bb</em> .  To do this, we need to add a <u>non-empty</u> folder in the firmware structure (an empty folder, will refuse to copy the update script): <br><blockquote><ol><li>  $ mkdir habrrom / system / xbin / bb </li><li>  $ touch habrrom / system / xbin / bb / placeholder </li></ol></blockquote><br>  Now we can safely place our links to the specified path, for which we will update the update script: <br><blockquote><ol><li>  symlink ../busybox SYSTEM: xbin / bb / [ </li><li>  # and so on </li></ol></blockquote><br><br><h2>  Ramdisk modification </h2><br><br>  However, simply placing the links in a separate folder is not enough.  We need to expand the search path for executable files for the system.  To do this, we need to add the $ PATH variable, which in the case of the android on HTC Hero is defined in <em>/init.rc</em> <br><blockquote><ol><li>  $ adb shell cat /init.rc |  grep "export PATH" </li><li>  export PATH / sbin: / system / sbin: / system / bin: / system / xbin </li></ol></blockquote><br>  All files in the root directory are part of <em>ramdisk</em> (as well as some other subdirectories).  Let's use the knowledge from the <a href="http://habrahabr.ru/blogs/android/96609/">first part</a> : unpack the <em>boot</em> , after which we can change the <em>PATH</em> variable <br><blockquote><ol><li>  $ cat habrrom.boot / ramdisk / init.rc |  grep "export PATH" </li><li>  export PATH / sbin: / system / sbin: / system / bin: / system / xbin: / system / xbin / bb </li></ol></blockquote><br>  Before we collect <em>ramdisk</em> back, let's do some more useful things. <br>  To simplify life, we would like to have the following: <br><ol><li>  The ability to mount the file system with write permissions </li><li>  USB debugging enabled by default.  Otherwise, if something goes wrong, we will not be able to get at least some useful information about the causes, since the <em>adbd</em> service will be disabled and, as a result, <em>adb logcat</em> will be unavailable during the download. </li><li>  Run arbitrary scripts when the system boots (the most popular use cases are: enable <em>app2sd</em> , transfer <em>dalvik-cache</em> to <em>/ cache</em> ) </li></ol><br>  To do this, look at <em>/default.prop</em> , which among other things stores the following settings: <br><ul><li>  <strong>ro.secure</strong> - is used here and there throughout the system, but of the properties of interest to us, it includes <em>adb remount</em> to write a, and also, <em>adb shell</em> is executed with superuser privileges.  Set the value to <strong>0</strong> </li><li>  <strong>persist.service.adb.enable</strong> - is responsible for starting the <em>adbd</em> service, which helps us to perform remote interaction with the phone via the <em>adb</em> tool.  Exhibiting at <strong>1</strong> </li></ul><br><br><h2>  Initialization scripts </h2><br><br>  To implement the third item, we need to modify the initialization script <a href="http://android.git.kernel.org/%3Fp%3Dplatform/system/core.git%3Ba%3Dblob%3Bf%3Drootdir/init.rc">/init.rc</a> .  This script as usual, is a <em><strike>bike of your own android</strike> script on Android Init Language</em> .  I propose <a href="http://android.git.kernel.org/%3Fp%3Dplatform/system/core.git%3Ba%3Dblob_plain%3Bf%3Dinit/readme.txt%3Bhb%3DHEAD">to</a> familiarize with the format <a href="http://android.git.kernel.org/%3Fp%3Dplatform/system/core.git%3Ba%3Dblob_plain%3Bf%3Dinit/readme.txt%3Bhb%3DHEAD">in the source code android</a> .  We are also interested in the ability to add our own <em>service</em> (we cannot add our commands directly to the trigger, because there the command set is strictly limited): <ol><li> <code><font color="black">service sysinit /system/bin/logwrapper /system/xbin/busybox run-parts /system/etc/init.d disabled oneshot</font></code> </li> <li> <code><font color="black">service sysinit /system/bin/logwrapper /system/xbin/busybox run-parts /system/etc/init.d disabled oneshot</font></code> </li> <li> <code><font color="black">service sysinit /system/bin/logwrapper /system/xbin/busybox run-parts /system/etc/init.d disabled oneshot</font></code> </li> </ol>  Those.  we called our service <em>sysinit</em> , which, when it starts, will run run-parts /system/etc/init.d, which in turn will run all the scripts from the corresponding folder in alphabetical order.  we need <em>logwrapper</em> in order to redirect the output instead of <em>/ dev / null</em> (by default) to the logging system (accessible by <em>logcat</em> ). <br>  It remains to start our service (the option is <em>disabled</em> , it says that this service will not start automatically).  To do this, move the last command from the <em>on boot</em> trigger to our own trigger for the end of the scripts and call our service. <br><blockquote><ol><li>  # not now </li><li>  # class_start default </li><li>  start sysinit </li><li></li><li>  on property: habr.sysinit.done = 1 </li><li>  # now </li><li>  class_start default </li></ol></blockquote><br>  We will also create two simple scripts in <em>/system/etc/init.d</em> to demonstrate that this all works.  The first one will do the standard <em>echo</em> ( <em>Hello World!,</em> As without it), and the second will clear the cache, and inform the <em>init</em> script that we have already finished and we can continue to load further. <br><blockquote><ol><li>  $ cat habrrom / system / etc / init.d / 00banner </li><li>  #! / system / bin / sh </li><li>  echo "Hello habrahabr!"; </li><li>  $ cat habrrom / system / etc / init.d / 99complete </li><li>  #! / system / bin / sh </li><li>  sync; </li><li>  setprop habr.sysinit.done 1 </li></ol></blockquote><br>  And the final touch - we will install them the right to run (all the same - in the firmware update script) <ol><li> <code><font color="black">set_perm_recursive 0 2000 0755 0755 SYSTEM:etc/init.d</font></code> </li> </ol><br><h2>  Superuser rights  Root. </h2><br><br>  For many, probably the most pressing question.  For those patient who read it. <br>  Despite the fact that the source <a href="http://android.git.kernel.org/%3Fp%3Dplatform/system/extras.git%3Ba%3Dblob%3Bf%3Dsu/su.c%3Bh%3Db87cece8b023d43895694a89dea4a42a294fef16%3Bhb%3DHEAD">has its own implementation of su</a> , it does not suit us, because its main goal is to launch applications as a superuser (or from <em>adb shell</em> ) with the rights of other <em>user</em> s. <br>  We will use the <a href="http://forum.xda-developers.com/showthread.php%3Ft%3D682828">development of ChainsDD</a> - <strong>Superuser 2.1</strong> application.  The essence of the application is similar to the familiar <em>sudo</em> , or even <em>Admin Approval Mode</em> from the Windows system.  If the application wants to elevate its rights to superuser rights (and not only), permission is requested from the user.  You can also remember the accepted rule and automatically apply to all future calls. <br>  We use the already <a href="http://bit.ly/brI0EV">assembled application</a> for Android 2.1, although there is always the opportunity to study and compile <a href="http://github.com/ChainsDD/android_packages_apps_Superuser">most of the sources</a> . <br>  The application consists of two components: <br><ol><li>  <em>native</em> module <strong>su</strong> .  Which, when requesting a change of rights, redirects the request to its own <em>Activity</em> and waits for the user to respond </li><li>  <strong>Superuser.apk</strong> application - a set of interfaces ( <em>Activity</em> ) responsible for user interaction, storage of settings. </li></ol><br><img src="https://habrastorage.org/getpro/geektimes/post_images/4fb/3bd/032/4fb3bd032eb943b7b061f757e41596bb.png"><img src="https://habrastorage.org/getpro/geektimes/post_images/e69/942/f2c/e69942f2c80b64c681d70bd7a9603f89.png"><br><br>  In order to add the specified functionality to our firmware - we will add modules to the appropriate sections of the system, <br><blockquote><ol><li>  $ cp su habrrom / system / xbin / </li><li>  $ cp Superuser.apk habrrom / system / app / </li></ol></blockquote><br>  and configure permissions for the executable file (plus a link to <em>/ system / bin /</em> , since some applications may call <em>su</em> in an absolute path) <ol><li> <code><font color="black">symlink ../xbin/su SYSTEM:bin/su set_perm 0 0 06755 SYSTEM:xbin/su</font></code> </li> <li> <code><font color="black">symlink ../xbin/su SYSTEM:bin/su set_perm 0 0 06755 SYSTEM:xbin/su</font></code> </li> </ol><br>  That's all. <br>  I am enclosing a <a href="">small archive</a> , as a final summary of what has been done in this article.  Scripts, <em>busybox</em> , <em>Superuser,</em> and more.  For the curious. <br>  This time it turned out to be somehow very Linux-like, and dumb.  But next time we consider the topic more fun - repackaging system applications.  In the meantime, the final point: <br><br><img src="http://img97.imageshack.us/img97/4640/bootxw.jpg"><br><br>  In previous and future series <br><ol><li>  <a href="http://habrahabr.ru/blogs/android/96609/">Part 1. Creating firmware in update.zip format based on RUU.</a>  <a href="http://habrahabr.ru/blogs/android/96609/">Unpacking / packing boot.</a>  <a href="http://habrahabr.ru/blogs/android/96609/">Update script.</a>  <a href="http://habrahabr.ru/blogs/android/96609/">Sign service pack and applications.</a> </li><li>  <a href="http://habrahabr.ru/blogs/android/97169/">Part 2. Adding busybox.</a>  <a href="http://habrahabr.ru/blogs/android/97169/">Adding root.</a>  <a href="http://habrahabr.ru/blogs/android/97169/">Mount to write.</a>  <a href="http://habrahabr.ru/blogs/android/97169/">Initialization script</a>  <a href="http://habrahabr.ru/blogs/android/97169/">Editing ramdisk.</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/97169/">https://habr.com/ru/post/97169/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../97161/index.html">Chrome has a built-in PDF reader.</a></li>
<li><a href="../97163/index.html">Learn to learn?</a></li>
<li><a href="../97164/index.html">Isolating software using OpenVZ</a></li>
<li><a href="../97167/index.html">Happy Birthday, Opera!</a></li>
<li><a href="../97168/index.html">Of the 64 world championship matches, 25 will be shown in 3D.</a></li>
<li><a href="../97173/index.html">OCR appeared in Google Docs</a></li>
<li><a href="../97174/index.html">Google announced the official opening of an office in Kiev</a></li>
<li><a href="../97177/index.html">Flash Player 10.1 for Mobile</a></li>
<li><a href="../97178/index.html">Development of .NET applications for AutoCAD within the framework of MVC architecture</a></li>
<li><a href="../97180/index.html">Time machine for your business</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>