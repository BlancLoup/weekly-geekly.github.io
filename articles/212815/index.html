<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web interface for listening to call recordings Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Search engines give a huge amount of results of different usefulness to the request made in the title. 
 I did not find such an article on Habrahabr, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Web interface for listening to call recordings Asterisk</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/fe7/f4f/9c0/fe7f4f9c05f00d4888e049780e792583.png" align="right" width="300" height="240"><br>  Search engines give a huge amount of results of different usefulness to the request made in the title. <br>  I did not find such an article on Habrahabr, which means you need to write it! <br>  <a href="http://thecall.ru/">I</a> took the <a href="https://code.google.com/p/asterisk-cdr-viewer/">asterisk cdr viewer</a> project as a basis. <br>  Translated the language of the web interface to the great mighty and ‚Äúvoiced‚Äù it, i.e.  added the ability to listen to the recordings of conversations in the browser, as well as download them. <br>  The number of filter fields is reduced to a minimum, leaving only the most necessary. <br>  Screenshots, samples and a detailed description of the installation are comfortably located under the screen. <br><br>  <b>UPDATE_2016</b> <br>  Ready new interface. <br>  A small video guide: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/6vUE8TqxOPA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Read more <a href="https://habrahabr.ru/post/322278/">here.</a> <br><br><a name="habracut"></a><br><h5>  Web interface screenshots </h5><br>  The logo and link to donat developers remained in their places. <br>  All fields are translated, if you need to display any field as in the original, just uncomment it in templates / form.tpl.php <br><img src="https://habrastorage.org/getpro/habr/post_images/b48/4c0/16a/b484c016ade3871da4c7bbda3355fd8d.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And this is the result of the search by filter. <br>  Each conversation can be downloaded, or listen through the flash player. <br><img src="https://habrastorage.org/getpro/habr/post_images/349/84d/367/34984d36766cc1a503566d54ed85d3fc.png"><br><br><h5>  Cooking MySQL </h5><br>  The CDRs of our Asterisk should be written to the MySQL database, how to set it up can be read <a href="http://blog.thecall.ru/page/asterisk-18-cdr-v-mysql-cdr_adaptive_odbc">here</a> for example;). <br>  At the end of the cdr_mysql.conf file, in the [columns] section, add <br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> realdst =&gt; realdst <span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> filename =&gt; filename</code> </pre> <br>  The name of the conversation recording file is written in the file field of the CDR table. <br>  Add it: <br><pre> <code class="bash hljs">mysql -uroot -p -e <span class="hljs-string"><span class="hljs-string">"alter table `cdr` add column `filename` varchar(120) after `userfield`;"</span></span> asterisk</code> </pre><br><br><h5>  Dialplan </h5><br>  To configure Asterisk dialplan, I use extensions.ael. <br><div class="spoiler">  <b class="spoiler_title">extensions.ael</b> <div class="spoiler_text"><pre> <code class="bash hljs">globals { WAV=/records/wav; //   WAV MP3=/records/mp3; //  mp3  RECORDING=1; // , 1 - . }; macro recording (calling,called) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${RECORDING}</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span>){ Set(fname=<span class="hljs-variable"><span class="hljs-variable">${UNIQUEID}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(${EPOCH}</span></span>,,%Y-%m-%d-%H_%M)}-<span class="hljs-variable"><span class="hljs-variable">${calling}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${called}</span></span>); Set(monopt=nice -n 19 /usr/bin/lame -b 32 --silent <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${WAV}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${fname}</span></span></span><span class="hljs-string">.wav"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${MP3}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${fname}</span></span></span><span class="hljs-string">.mp3"</span></span> &amp;&amp; rm -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${WAV}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${fname}</span></span></span><span class="hljs-string">.wav"</span></span> &amp;&amp; chmod o+r <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${MP3}</span></span></span><span class="hljs-string">/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${fname}</span></span></span><span class="hljs-string">.mp3"</span></span>); Set(CDR(filename)=<span class="hljs-variable"><span class="hljs-variable">${fname}</span></span>.mp3); Set(CDR(realdst)=<span class="hljs-variable"><span class="hljs-variable">${called}</span></span>); MixMonitor(<span class="hljs-variable"><span class="hljs-variable">${WAV}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${fname}</span></span>.wav,b,<span class="hljs-variable"><span class="hljs-variable">${monopt}</span></span>); }; }; _XXXXXX =&gt; { &amp;recording(<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>); Dial(SIP/rtk/<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>); Hangup(); }</code> </pre><br></div></div><br>  Global variables define the paths to the files, as well as allow you to turn on / off the recording of the conversation. <br>  The recording macro accepts the caller's number and the number where the call is made as parameters.  If the recording is enabled, a temporary wav file is written, recoded into mp3, and in MySQL the name of the CDR drops the name of the file. <br>  The file name consists of the uniqueid-date_time-FromChodCall-ToCall, for example: <br><pre> <code class="bash hljs">1392597899.17572-2014-02-17-07_44-83843ZZZ-32ZZ.mp3</code> </pre><br>  The current day mp3 files are added to / records / mp3 / <br>  Every night, the script in the crown distributes the recordings of conversations in the appropriate date folders <br><pre> <code class="bash hljs">1 0 * * * /root/sh/mvrecords.sh</code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin y=`date +%Y -d "-1 day"` ym=`date +%Y-%m -d "-1 day"` ymd=`date +%Y-%m-%d -d "-1 day"` mkdir -p /records/$y/$ym/$ymd/ mv /records/mp3/*$ymd* /records/mp3/$y/$ym/$ymd/</span></span></code> </pre><br><br>  In the folder where the web interface files are located, you need to create a symlink to the folder / records / mp3 / <br><pre> <code class="bash hljs">/var/www<span class="hljs-comment"><span class="hljs-comment"># ls -l total 60 -rw-r--r-- 1 fessae fessae 182 Nov 19 2011 callrates.csv drwxr-xr-x 3 fessae fessae 4096 Sep 26 2012 contrib -rw-r--r-- 1 fessae fessae 1986 Dec 22 2012 download.php -rw-r--r-- 1 fessae fessae 246 Sep 6 2013 downloads.php drwxr-xr-x 4 fessae fessae 4096 Apr 15 20:48 include -rw-r--r-- 1 fessae fessae 30384 Dec 2 20:21 index.php lrwxrwxrwx 1 root root 13 Apr 15 20:48 records -&gt; /records/mp3/ drwxr-xr-x 2 fessae fessae 4096 Feb 13 2013 style drwxr-xr-x 3 fessae fessae 4096 Feb 18 21:07 templates</span></span></code> </pre><br>  Screenshots of the folder structure. <br><img src="https://habrastorage.org/getpro/habr/post_images/f30/a74/dbb/f30a74dbbe10b446762b1c74377b0053.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/895/150/386/8951503864a7188c9d5c3fd4b74465ea.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/b78/639/552/b786395525a95ce945434ddd13a26230.png"><br><br><h5>  Php </h5><br>  In the file include / functions.php spelled out the logic of the output buttons "download the file with the conversation" and flash player in the field "File". <br><div class="spoiler">  <b class="spoiler_title">part include / functions.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> $recorded_file = $row[<span class="hljs-string"><span class="hljs-string">'filename'</span></span>]; $mycalldate = substr(<span class="hljs-string"><span class="hljs-string">"$calldate"</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>); $mycalldate_ym = substr(<span class="hljs-string"><span class="hljs-string">"$calldate"</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>); $mydate = date(<span class="hljs-string"><span class="hljs-string">"Ymd"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($mycalldate&lt;$mydate){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_exists(<span class="hljs-string"><span class="hljs-string">"records/$mycalldate_ym/$mycalldate/$recorded_file"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">" &lt;td class=\"record_col\"&gt;&lt;a href=\"downloads.php?audio=records/$mycalldate_ym/$mycalldate/$recorded_file\" title=\"   \"&gt;&lt;img src=\"templates/images/sound.png\"&lt;/a&gt; &lt;object type=\"application/x-shockwave-flash\" data=\"include/player_mp3_maxi.swf\" width=\"150\" height=\"20\"&gt; &lt;param movie=include/player_mp3_maxi.swf/&gt; &lt;param name=FlashVars value=mp3=records/$mycalldate_ym/$mycalldate/$recorded_file /&gt; &lt;/td&gt;\n"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">" &lt;td class=\"record_col\"&gt; &lt;/td&gt;\n"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_exists(<span class="hljs-string"><span class="hljs-string">"records/$recorded_file"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">" &lt;td class=\"record_col\"&gt;&lt;a href=\"downloads.php?audio=records/$recorded_file\" title=\"   \"&gt;&lt;img src=\"templates/images/sound.png\"&lt;/a&gt; &lt;object type=\"application/x-shockwave-flash\" data=\"include/player_mp3_maxi.swf\" width=\"150\" height=\"20\"&gt; &lt;param movie=include/player_mp3_maxi.swf/&gt; &lt;param name=FlashVars value=mp3=records/$recorded_file /&gt; &lt;/td&gt;\n"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">" &lt;td class=\"record_col\"&gt; &lt;/td&gt;\n"</span></span>;} } }</code> </pre><br></div></div><br>  In this code, it is determined in which folder to search for the conversation recording file. <br>  For the current day we search in / records / mp3, and for previous in / records / mp3 / YEAR-MONTH / YEAR-MONTH-DAY / <br>  If the file was not found, we will see "no record" in the "File" field. <br><br>  Just do not forget to specify the connection details to MySQL in <code>include/config.inc.php</code> <br><br><h5>  A curtain </h5><br>  That's all! <br>  I would be glad if my work will be useful. <br><br>  ps <br>  Sorts are available at links <a href="http://sysadminz.ru/index.php%3Faction%3Ddlattach%3Btopic%3D6592.0%3Battach%3D7589">1</a> and <a href="https://drive.google.com/file/d/0B4tx5FFqCxYeTFktc2pHQ0ctWDg/edit%3Fusp%3Dsharing">2</a> <br><br>  <b>UPD</b> <br>  If there is no account on Habr√©, I can help on the forum - <a href="http://sysadminz.ru/index.php%3Ftopic%3D6592.0">sysadminz.ru/index.php?topic=6592.0</a> <br>  <b>UPD 2</b> <br>  A small glitch was found, if the recording in any direction is disabled (that is, the file is not being written and the filename field is not filled in the database), then the flash player is still displayed as if the file is there. <br>  To correct it, you need to make changes to the CDR table, set the default value for the filename field: <br><pre> <code class="bash hljs">mysql -p mysql&gt; alter table cdr alter filename <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> default <span class="hljs-string"><span class="hljs-string">'none'</span></span>; mysql&gt; describe cdr; +-------------+-----------------+------+-----+---------------------+----------------+ | Field | Type | Null | Key | Default | Extra | +-------------+-----------------+------+-----+---------------------+----------------+ | id | int(9) unsigned | NO | PRI | NULL | auto_increment | | calldate | datetime | NO | MUL | 0000-00-00 00:00:00 | | | clid | varchar(80) | NO | | | | | src | varchar(80) | NO | MUL | | | | dst | varchar(80) | NO | MUL | | | | dcontext | varchar(80) | NO | | | | | channel | varchar(80) | NO | | | | | dstchannel | varchar(80) | NO | | | | | lastapp | varchar(80) | NO | | | | | lastdata | varchar(80) | NO | | | | | duration | int(11) | NO | | 0 | | | billsec | int(11) | NO | | 0 | | | disposition | varchar(45) | NO | | | | | amaflags | int(11) | NO | | 0 | | | accountcode | varchar(20) | NO | MUL | | | | uniqueid | varchar(32) | NO | MUL | | | | userfield | varchar(255) | NO | | | | | filename | varchar(120) | YES | | none | | +-------------+-----------------+------+-----+---------------------+----------------+ 18 rows <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> (0.00 sec) mysql&gt; \q Bye</code> </pre><br>  <b>UPD 3 (from the post header)</b> <br>  Comrade <b>profiton (aka prog-it)</b> essentially finished the topic. <br>  Screenshots: <br><img src="https://habrastorage.org/getpro/habr/post_images/9c1/55c/ab5/9c155cab5f904af257947eea85f7d505.jpg" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/7e1/08b/2fc/7e108b2fca888c1a37c3bfc20e9fbfc6.jpg" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/e85/f3a/02c/e85f3a02c3c472602992530c77d9a47d.jpg" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/089/503/31d/08950331d229c28044b37d9950885875.jpg" alt="image"><br><br>  Features: <br><blockquote>  Key Features <br>  Fully Russian interface <br>  Updated design <br>  Tooltips <br>  Correct export of records to a CSV file <br>  The correct calculation of the cost of calls (plugin) <br>  View the cost of each call (plugin) <br>  The ability to specify a non-chargeable interval for the correct calculation of the cost <br>  Ability to specify additional.  rate.  For example: The cost of the first minute is 1 rub., Then 10 kopecks each.  (extra rate) <br>  The file name of the call record is stored in the database <br>  Ability to listen to the recording of the call through the web interface <br>  You can click on the phone number and get information about it. <br>  The player to listen to the call is loaded via javascript, so nothing slows down <br>  If call records are archived, you will be prompted to download a record. <br>  If you receive a fax, you can also download it. <br>  Files for download are given by the script with the ability to resume <br>  The folder for storing records can be located in any directory of your server. <br>  And much more ... </blockquote><br><br>  Link - <a href="http://prog-it.github.io/Asterisk-CDR-Viewer-Mod/">prog-it.github.io/Asterisk-CDR-Viewer-Mod</a> </div><p>Source: <a href="https://habr.com/ru/post/212815/">https://habr.com/ru/post/212815/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212797/index.html">Top 10 Most Breakthrough Technologies of 2013 and Startups Based on Them</a></li>
<li><a href="../212799/index.html">1C confidently enters the mobile development market</a></li>
<li><a href="../212801/index.html">Feedback on the book ‚ÄúIntroverts - how to use the features of your character‚Äù or why you should not watch porn in the workplace</a></li>
<li><a href="../212811/index.html">History of heart rate monitors</a></li>
<li><a href="../212813/index.html">FreeBSD 10.0 RELEASE and problems with ip forwarding</a></li>
<li><a href="../212817/index.html">Definer.js - simple modular system</a></li>
<li><a href="../212821/index.html">Adaptive letters? You are welcome!</a></li>
<li><a href="../212823/index.html">Rusty brains - go over the bridge. The Bridge by Ty Tailor</a></li>
<li><a href="../212825/index.html">Anti-rootkit for Userland-RootKit Azazel "on the knee"</a></li>
<li><a href="../212831/index.html"># 3dprintexpo: Russia's first exhibition of three-dimensional printing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>