<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sphinx - not just for searching! My history</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username%! 

 Today I want to tell how we (I and my partner) decided to abandon MySQL in favor of Sphinx for complex samples and sorts. 

 How was...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sphinx - not just for searching! My history</h1><div class="post__text post__text-html js-mediator-article">  Hi% username%! <br><br>  Today I want to tell how we (I and my partner) decided to abandon MySQL in favor of Sphinx for complex samples and sorts. <br><br><h4>  How was the deal </h4><br>  It all started from that (as you have already guessed) that MySQL was slowly and surely gaining momentum and loading the server more and more.  And the culprit was one table - torrents (yeah, this is a tracker).  The time has come and we started to think how to solve the situation. <a name="habracut"></a>  The bottleneck we knew where, and they were filtering and sorting hands.  Caching disappeared immediately, the number of combinations of samples was very large, moreover, the actual data was always needed (the number of seeders, leechers, downloaded ...).  We didn‚Äôt think about replication either, since already two servers were working in master-master mode, plus we didn‚Äôt want to build trees from replicas.  Our first thought was partitioning, but it gave nothing but brakes.  The second thought was to set the table on a separate server, but even here a bummer was waiting for us ... At that time, we had the <a href="http://xbtt.sourceforge.net/tracker/">XBT Tracker</a> spinning.  The problem was that he knew how to work only with tables located in the same database.  ‚ÄúSo what?‚Äù - we thought, you can rewrite, because it is open source.  Agreeing that the idea is realizable and has the right to life, it was postponed to the side, because neither he nor I were friends with C ++ and she bears costs in the form of financial expenses and rewriting the site's engine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Almost desperate to find a solution, walking around the Internet, I came across a post - <a href="http://habrahabr.ru/blogs/sphinx/64325/">Sphinx - not only for searching!</a>  .  Then I realized this is what we need!  Sphinx worked for us for a long time as a search engine and we were very pleased with it.  Rolling up my sleeves, my partner took up the update and setup of the Sphinx, and I for rewriting the method of filtering hands.  Then, after seeing the post <a href="http://habrahabr.ru/blogs/sphinx/61222/">How to Prepare SphinxQL</a> , I decided to use SphinxQL. <br><br>  In the case of Sphinx, we got one index, which is used both for searching and filtering hands.  Full re-indexing of which occurs every 5 minutes (because you always need up-to-date data).  Reindexing is carried out in less than 1 minute. <br><br>  In the case of PHP, it was just as easy.  The query generator was almost not able to redo it.  The requests themselves were from harmless <br><br> <code>SELECT *, leechers+seeders AS peers FROM torrents WHERE parent_cid=1 ORDER BY ctime DESC LIMIT 0,30 OPTION max_matches=30</code> <br> <br>  to such that forced MySQL hardly moves <br><br> <code>SELECT *, leechers+seeders AS peers FROM torrents WHERE parent_cid=1 ORDER BY ctime DESC LIMIT 40380,30 OPTION max_matches=40410 <br> <br> SELECT *, leechers+seeders AS peers FROM torrents WHERE MATCH('@quality DVDRip') AND cid=6 AND year=2009 ORDER BY peers DESC LIMIT 360,30 OPTION max_matches=390</code> <br> <br>  After referring to the sphinx, we fill the array with information about the distribution.  Since Sphinx does not return string values ‚Äã‚Äã(for example, the name of the distribution), you need to fill another array with the distribution cache keys (one distribution - one cache), and make one multi-request to memcache to get all the information we need.  Well, at the end run through the loop and put everything together to give to the user. <br><br><h4>  Conclusion </h4><br>  We were very pleased with the result.  What did we get in the end?  The main thing - the load on MySQL dropped almost three times, a cloud of indexes was removed from the torrents table, we don‚Äôt pull at all on the MySQL filtering page. <br><br>  In this form, as I have told, this case has been working to this day for a little over a year.  We did not experience any problems due to this decision.  We know that the decision is quite a crutch, but it works with a bang.  Now Sphinx and memcache live on a separate server with a bunch of RAM and grief do not know. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/102749/">https://habr.com/ru/post/102749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../102742/index.html">Celery - distributed task queue</a></li>
<li><a href="../102744/index.html">Korean Galaxy Tab Video Presentation</a></li>
<li><a href="../102745/index.html">Chiefs and how to live with them</a></li>
<li><a href="../102747/index.html">Pros and cons of working from home</a></li>
<li><a href="../102748/index.html">Announced Canon EOS 60D</a></li>
<li><a href="../102750/index.html">Reversing .Net applications. Part 0</a></li>
<li><a href="../102752/index.html">Default search</a></li>
<li><a href="../102753/index.html">The first solar station on molten salt, working around the clock</a></li>
<li><a href="../102754/index.html">Cheap Internet to give and not only</a></li>
<li><a href="../102755/index.html">RusTest Online - Learn the spelling of Russian words for free over the Internet!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>