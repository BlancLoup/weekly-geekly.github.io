<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL 9.5: what's new? Part 2. TABLESAMPLE</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue the review of innovations in PostgreSQL 9.5. 
 Part 1. INSERT ... ON CONFLICT DO NOTHING / UPDATE and ROW LEVEL SECURITY . 
 Part 3. GROUP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL 9.5: what's new? Part 2. TABLESAMPLE</h1><div class="post__text post__text-html js-mediator-article">  We continue the review of innovations in PostgreSQL 9.5. <br>  <a href="http://habrahabr.ru/post/264281/">Part 1. INSERT ... ON CONFLICT DO NOTHING / UPDATE and ROW LEVEL SECURITY</a> . <br>  <a href="http://habrahabr.ru/post/269849/">Part 3. GROUPING SETS, CUBE, ROLLUP</a> <br><div class="spoiler">  <b class="spoiler_title">From the author</b> <div class="spoiler_text">  I apologize for the delay in the release of the second part.  Initially, I planned to release the second part of the article a week after the first, but, due to the large employment, I could not do it.  Therefore, I decided that I would not publish large articles, but in small portions, but more often. </div></div><a name="habracut"></a><br>  Sometimes there are tasks in which you need to select a certain number of random entries from a table; for this, sophisticated queries were written (to get really random data, you need to sweat a lot).  With the release of PostgreSQL 9.5, this task will become easier. <br>  With the help of the keyword <b>TABLESAMPLE,</b> you can not select all the data from the table, but only some part of them, choose a sample. <br>  The syntax will be something like this: <br><br><blockquote>  <font color="#993333">SELECT</font> <font color="#66cc66">...</font> <font color="#993333">FROM</font> <font color="#993333">TABLE_NAME</font> <font color="#66cc66">...</font> TABLESAMPLE sampling_method <font color="#66cc66">(</font> argument <font color="#66cc66">[</font> <font color="#66cc66">,</font> <font color="#66cc66">...</font> <font color="#66cc66">]</font> <font color="#66cc66">)</font> <font color="#66cc66">[</font> REPEATABLE <font color="#66cc66">(</font> seed <font color="#66cc66">)</font> <font color="#66cc66">]</font> </blockquote><br>  <b>sampling_method</b> is the sampling method, the default in PostgreSQL 9.5 is two: <b>SYSTEM</b> and <b>BERNOULLI</b> , as an argument they take a floating point number (or any valid expression that results in a number) that is interpreted as a percentage for the sample: from 0 to 100. <br><br>  Let's look at examples of how sampling in PostgreSQL 9.5 works. <br>  Suppose we have a table with transactions, which stores the transaction id, the amount of the transaction and the date with the time when the transaction was completed.  Add 100000 entries to the table. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  <font color="#993333">CREATE</font> <font color="#993333">TABLE</font> transactions <font color="#66cc66">(</font> <br>  id SERIAL <font color="#993333">PRIMARY</font> <font color="#993333">KEY</font> <font color="#66cc66">,</font> <br>  amount <font color="#993333">NUMERIC</font> <font color="#66cc66">(</font> <font color="#cc66cc">15</font> <font color="#66cc66">,</font> <font color="#cc66cc">2</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  ending_time <font color="#993333">TIMESTAMP</font> <br>  <font color="#66cc66">)</font> ; <br><br>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> transactions <font color="#66cc66">(</font> amount <font color="#66cc66">,</font> ending_time <font color="#66cc66">)</font> <br>  <font color="#993333">SELECT</font> <br>  <font color="#66cc66">(</font> round <font color="#66cc66">(</font> <font color="#993333">CAST</font> <font color="#66cc66">(</font> random <font color="#66cc66">(</font> <font color="#66cc66">)</font> <font color="#66cc66">*</font> <font color="#cc66cc">100000</font> <font color="#993333">AS</font> <font color="#993333">NUMERIC</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <font color="#cc66cc">2</font> <font color="#66cc66">)</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  now <font color="#66cc66">(</font> <font color="#66cc66">)</font> <font color="#66cc66">-</font> random <font color="#66cc66">(</font> <font color="#66cc66">)</font> <font color="#66cc66">*</font> <font color="#993333">CAST</font> <font color="#66cc66">(</font> <font color="#328132">'1 day'</font> <font color="#993333">AS</font> <font color="#993333">INTERVAL</font> <font color="#66cc66">)</font> <br>  <font color="#993333">FROM</font> generate_series <font color="#66cc66">(</font> <font color="#cc66cc">1</font> <font color="#66cc66">,</font> <font color="#cc66cc">100000</font> <font color="#66cc66">)</font> ; <br></blockquote><br>  Let's try to take a sample of records with a size of 0.1% of the source table (100 records): <br><blockquote>  <font color="#993333">SELECT</font> <font color="#66cc66">*</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> <br><br>  Total query runtime: <font color="#cc66cc">213</font> ms <font color="#66cc66">.</font> <br>  <font color="#cc66cc">157</font> rows retrieved <font color="#66cc66">.</font> </blockquote><br>  Why did we not get 100 records, but 157?  The fact is that PostgreSQL <a href="http://www.postgresql.org/docs/9.5/static/storage-page-layout.html">stores the table data as an array of 8 kb pages</a> (by default, this parameter can be changed when building the server from the source code) and using the <b>SYSTEM</b> sampling method, it simply takes the required number of random pages for a given number of percentages and returns them " as it is".  In this case, 157 records fit into one page.  If you request 2 times more records for the sample, then data from 2 pages will be taken: <br><blockquote>  <font color="#993333">SELECT</font> <font color="#66cc66">*</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.2</font> <font color="#66cc66">)</font> <br><br>  Total query runtime: <font color="#cc66cc">21</font> ms <font color="#66cc66">.</font> <br>  <font color="#cc66cc">314</font> rows retrieved <font color="#66cc66">.</font> </blockquote><br>  It should be understood that different pages can store different numbers of records and therefore the number of records returned can vary from request to request. <br>  In order to get the exact number of records, you can use the expression <b>LIMIT</b> , but it is worth understanding that all the same, in this case we will get records from one page.  Therefore, if the values ‚Äã‚Äãin the records depend on the order in which these records are inserted or the nature of the values ‚Äã‚Äãin the records themselves is chronological (as in our case, in the ending_time field), then you will most likely get meaningless results by making samples.  For example, if we want to know through the sample, the maximum date when the transaction was performed, then, doing the same query several times, we will get completely different results: <br><blockquote>  <font color="#993333">SELECT</font> <font color="#993333">MAX</font> <font color="#66cc66">(</font> ending_time <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> </blockquote><br><table border="1"><tbody><tr><th>  max </th></tr><tr><td>  2014-11-08 22: 30: 32.720855 </td></tr></tbody></table><br><blockquote>  <font color="#993333">SELECT</font> <font color="#993333">MAX</font> <font color="#66cc66">(</font> ending_time <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> </blockquote><br><table border="1"><tbody><tr><th>  max </th></tr><tr><td>  2014-12-02 11: 42: 32.720855 </td></tr></tbody></table><br><blockquote>  <font color="#993333">SELECT</font> <font color="#993333">MAX</font> <font color="#66cc66">(</font> ending_time <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> </blockquote><br><table border="1"><tbody><tr><th>  max </th></tr><tr><td>  2014-10-21 09: 40: 32.720855 </td></tr></tbody></table><br>  Whereas the real value will be: <br><blockquote>  <font color="#993333">SELECT</font> <font color="#993333">MAX</font> <font color="#66cc66">(</font> ending_time <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions </blockquote><br><table border="1"><tbody><tr><th>  max </th></tr><tr><td>  2014-12-07 04: 04: 32.720855 </td></tr></tbody></table><br>  In order to get a more distributed sample, you can use the <b>BERNOULLI</b> sampling <b>method</b> , which scans the entire table (in fact, ‚Äúthrows a coin‚Äù for each record) and selects random entries: <br><blockquote>  <font color="#993333">SELECT</font> <font color="#993333">MAX</font> <font color="#66cc66">(</font> ending_time <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE BERNOULLI <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> </blockquote><br><table border="1"><tbody><tr><th>  max </th></tr><tr><td>  2014-12-07 00: 06: 32.720855 </td></tr></tbody></table><br>  Now let's look at the performance, try to analyze the receipt of the average transaction amount in three ways and get the average itself: <br><br>  1) No sample: <br><blockquote>  <font color="#993333">EXPLAIN</font> ANALYZE <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions <br>  <font color="#328132">"Aggregate (cost = 1887.00..1887.01 rows = 1 width = 8) (actual time = 25.795..25.795 rows = 1 loops = 1)"</font> <br>  <font color="#328132">"-&gt; Seq Scan on transactions (cost = 0.00..1637.00 rows = 100000 width = 8) (actual time = 0.005..12.438 rows = 100000 loops = 1)"</font> <br>  <font color="#328132">"Planning time: 0.055 ms"</font> <br>  <font color="#328132">"Execution time: 25.816 ms"</font> <br><br>  <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions <br>  <font color="#cc66cc">50028.8742828</font> </blockquote><br>  2) Sample method <b>SYSTEM</b> : <br><blockquote>  <font color="#993333">EXPLAIN</font> ANALYZE <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> <br>  <font color="#328132">"Aggregate (cost = 1.25..1.26 rows = 1 width = 8) (actual time = 0.088..0.088 rows = 1 loops = 1)"</font> <br>  <font color="#328132">"-&gt; Sample Scan (system) on transactions (cost = 0.00..1.00 rows = 100 width = 8) (actual time = 0.017..0.048 rows = 157 loops = 1)"</font> <br>  <font color="#328132">"Planning time: 0.068 ms"</font> <br>  <font color="#328132">"Execution time: 0.120 ms"</font> <br><br>  <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> <br>  <font color="#cc66cc">53628.223694267516</font> </blockquote><br>  3) Sample according to the <b>BERNOULLI</b> method: <br><blockquote>  <font color="#993333">EXPLAIN</font> ANALYZE <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE BERNOULLI <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> <br>  <font color="#328132">"Aggregate (cost = 638.25..638.26 rows = 1 width = 8) (actual time = 2.847..2.847 rows = 1 loops = 1)"</font> <br>  <font color="#328132">"-&gt; Sample Scan (bernoulli) on transactions (cost = 0.00..638.00 rows = 100 width = 8) (actual time = 0.020..2.780 rows = 104 loops = 1)"</font> <br>  <font color="#328132">"Planning time: 0.145 ms"</font> <br>  <font color="#328132">"Execution time: 2.872 ms"</font> <br><br>  <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE BERNOULLI <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> <br>  <font color="#cc66cc">50285.863240740741</font> </blockquote><br>  We see that the <b>SYSTEM</b> sampling is faster, but its accuracy is lower, while the <b>BERNOULLI sampling</b> is slower, but its accuracy is higher.  You can choose a compromise between speed and accuracy.  Also note that a new type of scan is used for sampling: Sample scan. <br>  Add more records to the table, let it be 20 million records: <br><blockquote>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> transactions <font color="#66cc66">(</font> amount <font color="#66cc66">,</font> ending_time <font color="#66cc66">)</font> <br>  <font color="#993333">SELECT</font> <br>  <font color="#66cc66">(</font> round <font color="#66cc66">(</font> <font color="#993333">CAST</font> <font color="#66cc66">(</font> random <font color="#66cc66">(</font> <font color="#66cc66">)</font> <font color="#66cc66">*</font> <font color="#cc66cc">100000</font> <font color="#993333">AS</font> <font color="#993333">DECIMAL</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <font color="#cc66cc">2</font> <font color="#66cc66">)</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  now <font color="#66cc66">(</font> <font color="#66cc66">)</font> <font color="#66cc66">-</font> <font color="#993333">INTERVAL</font> <font color="#328132">'1 year'</font> <font color="#66cc66">+</font> <font color="#66cc66">(</font> i <font color="#66cc66">*</font> <font color="#993333">INTERVAL</font> <font color="#328132">'1 minute'</font> <font color="#66cc66">)</font> <br>  <font color="#993333">FROM</font> generate_series <font color="#66cc66">(</font> <font color="#cc66cc">100001</font> <font color="#66cc66">,</font> <font color="#cc66cc">20000000</font> <font color="#66cc66">)</font> i; <br><br>  <font color="#993333">EXPLAIN</font> ANALYZE <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions; <br><br>  <font color="#328132">"Aggregate (cost = 377372.70 ..377372.71 rows = 1 width = 8) (actual time = 4604.297..4604.297 rows = 1 loops = 1)"</font> <br>  <font color="#328132">"-&gt; Seq Scan on transactions (cost = 0.00 ..327375.96 rows = 19998696 width = 8) (actual time = 0.027..2043.846 rows = 20000000 loops = 1)"</font> <br>  <font color="#328132">"Planning time: 0.063 ms"</font> <br>  <font color="#328132">"Execution time: 4604.325 ms"</font> <br><br>  <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions; <br>  <font color="#cc66cc">50002.888681451</font> <br><br>  <font color="#993333">EXPLAIN</font> ANALYZE <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> <br>  <font color="#328132">"Aggregate (cost = 757.99..758.00 rows = 1 width = 8) (actual time = 7.309..7.309 rows = 1 loops = 1)"</font> <br>  <font color="#328132">"-&gt; Sample Scan (system) on transactions (cost = 0.00 ..707.99 rows = 19999 width = 8) (actual time = 0.057..4.588 rows = 20096 loops = 1)"</font> <br>  <font color="#328132">"Planning time: 0.073 ms"</font> <br>  <font color="#328132">"Execution time: 7.340 ms"</font> <br>  <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> <br>  <font color="#cc66cc">50323.198322551752</font> <br><br>  <font color="#993333">EXPLAIN</font> ANALYZE <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE BERNOULLI <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> <br>  <font color="#328132">"Aggregate (cost = 127638.99..127639.00 rows = 1 width = 8) (actual time = 751.831..751.832 rows = 1 loops = 1)"</font> <br>  <font color="#328132">"-&gt; Sample Scan (bernoulli) on transactions (cost = 0.00 ..127588.99 rows = 19999 width = 8) (actual time = 0.260..747.682 rows = 19899 loops = 1)"</font> <br>  <font color="#328132">"Planning time: 0.055 ms"</font> <br>  <font color="#328132">"Execution time: 751.879 ms"</font> <br><br>  <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE BERNOULLI <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> <br>  <font color="#cc66cc">50043.386386377336</font> </blockquote><br>  We see that with an increase in the number of records, the <b>BERNOULLI</b> method <b>loses</b> more performance.  This is because it does, in fact, a full scan of the table, while <b>SYSTEM</b> simply returns a few pages. <br><br>  Now let's try to increase the percentage for selecting records: <br><blockquote>  <font color="#993333">EXPLAIN</font> ANALYZE <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">1</font> <font color="#66cc66">)</font> <br>  <font color="#328132">"Aggregate (cost = 7591.84..7591.85 rows = 1 width = 8) (actual time = 65.055..65.055 rows = 1 loops = 1)"</font> <br>  <font color="#328132">"-&gt; Sample Scan (system) on transactions (cost = 0.00 ..7091.87 rows = 199987 width = 8) (actual time = 0.043..37.939 rows = 200018 loops = 1)"</font> <br>  <font color="#328132">"Planning time: 0.053 ms"</font> <br>  <font color="#328132">"Execution time: 65.083 ms"</font> <br><br>  <font color="#993333">EXPLAIN</font> ANALYZE <font color="#993333">SELECT</font> AVG <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE BERNOULLI <font color="#66cc66">(</font> <font color="#cc66cc">1</font> <font color="#66cc66">)</font> <br>  <font color="#328132">"Aggregate (cost = 129888.84..129888.85 rows = 1 width = 8) (actual time = 799.826..799.826 rows = 1 loops = 1)"</font> <br>  <font color="#328132">"-&gt; Sample Scan (bernoulli) on transactions (cost = 0.00 ..129388.87 rows = 199987 width = 8) (actual time = 0.035..769.899 rows = 199682 loops = 1)"</font> <br>  <font color="#328132">"Planning time: 0.063 ms"</font> <br>  <font color="#328132">"Execution time: 799.859 ms"</font> </blockquote><br>  As you can see, the <b>SYSTEM</b> method loses more performance when the percentage of the sample increases.  This is logical, since <b>BERNOULLI</b> both did a full scan and does it, while <b>SYSTEM</b> should return 10 times more pages. <br>  As a result, it can be noted that the <b>SYSTEM</b> method at a small percentage of the sample works much faster than <b>BERNOULLI</b> , but at the same time gives a less random selection of records.  But with the interest of interest, this advantage is lost. <br><br>  With the optional <b>REPEATABLE keyword,</b> we can set the <b>seed</b> for the random variable generator.  If two queries have the same sampling method, sampling percentage and <b>seed</b> , then the same sample will be selected for these two queries: <br><blockquote>  <font color="#993333">SELECT</font> <font color="#993333">MAX</font> <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> REPEATABLE <font color="#66cc66">(</font> <font color="#cc66cc">50</font> <font color="#66cc66">)</font> <br>  <font color="#cc66cc">99997.91</font> <br><br>  <font color="#993333">SELECT</font> <font color="#993333">MAX</font> <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> REPEATABLE <font color="#66cc66">(</font> <font color="#cc66cc">300</font> <font color="#66cc66">)</font> <br>  <font color="#cc66cc">99999.15</font> <br><br>  <font color="#993333">SELECT</font> <font color="#993333">MAX</font> <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE BERNOULLI <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> REPEATABLE <font color="#66cc66">(</font> <font color="#cc66cc">50</font> <font color="#66cc66">)</font> <br>  <font color="#cc66cc">99995.9</font> <br><br>  <font color="#993333">SELECT</font> <font color="#993333">MAX</font> <font color="#66cc66">(</font> amount <font color="#66cc66">)</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">0.1</font> <font color="#66cc66">)</font> REPEATABLE <font color="#66cc66">(</font> <font color="#cc66cc">50</font> <font color="#66cc66">)</font> <br>  <font color="#cc66cc">99997.91</font> </blockquote><br>  As we saw above, if the <b>REPEATABLE</b> keyword is not specified, then each time the sample will be different from the previous one. <br><br>  Separately, it is worth noting that sampling is performed BEFORE the <b>WHERE</b> condition, that is, you cannot select a sample by condition.  In this case, the sample will be selected first, and then the <b>WHERE</b> condition will be applied, but since the probability of getting records with <i>id &lt;100</i> from a table of 20,000,000 records is very small, the sample will be empty in the end: <br><blockquote>  <font color="#993333">SELECT</font> <font color="#66cc66">*</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">1</font> <font color="#66cc66">)</font> <font color="#993333">WHERE</font> id <font color="#66cc66">&lt;</font> <font color="#cc66cc">100</font> <br>  Total query runtime: <font color="#cc66cc">31</font> ms <font color="#66cc66">.</font> <br>  <font color="#cc66cc">0</font> rows retrieved <font color="#66cc66">.</font> </blockquote><br>  <b>SYSTEM</b> and <b>BERNOULLI</b> are not the only possible options for sampling, if you wish, you can write your own method for sampling.  The documentation for this is <a href="http://www.postgresql.org/docs/9.5/static/tablesample-method.html">here</a> .  In this case, custom sampling methods can take more than one argument or not take them at all.  Also, custom methods can ignore the <b>REPEATABLE</b> keyword. <br><br>  This concludes my brief story on postgreSQL 9.5 sampling.  Thanks for attention! <br><br>  PS You can roughly estimate the number of records in the table using the sample :) <br><blockquote>  <font color="#993333">SELECT</font> <font color="#993333">COUNT</font> <font color="#66cc66">(</font> <font color="#66cc66">*</font> <font color="#66cc66">)</font> <font color="#66cc66">*</font> <font color="#cc66cc">100.0</font> <font color="#993333">FROM</font> transactions TABLESAMPLE SYSTEM <font color="#66cc66">(</font> <font color="#cc66cc">1</font> <font color="#66cc66">)</font> ; <br>  <font color="#cc66cc">20001800</font> </blockquote><br>  PPS Do not do as described above, this is a joke and does not always work as it should. <br>  In the next part: <b>GROUPINS SETS, ROLLUP, CUBE</b> . </div><p>Source: <a href="https://habr.com/ru/post/266759/">https://habr.com/ru/post/266759/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266745/index.html">Vim-like control with xmodmap</a></li>
<li><a href="../266747/index.html">Once again about type casting in C ++ or the arrangement of all points above the cast</a></li>
<li><a href="../266749/index.html">Group the same applications from different stores by icon</a></li>
<li><a href="../266753/index.html">Walking across tiles</a></li>
<li><a href="../266757/index.html">With 100,000,000 days a year</a></li>
<li><a href="../266761/index.html">Managing complexity in ruby ‚Äã‚Äãon rails projects. Part 1</a></li>
<li><a href="../266767/index.html">The digest of interesting materials for the mobile # 120 developer (September 7-13)</a></li>
<li><a href="../266773/index.html">MVVM nuances in Ext JS when developing components</a></li>
<li><a href="../266775/index.html">The most outdated infrastructure you can buy for money.</a></li>
<li><a href="../266777/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 176 (September 7 - 13, 2015)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>