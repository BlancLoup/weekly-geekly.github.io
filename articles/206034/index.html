<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proteus and two and a half hello world for UART and USB on the microcontroller</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently I shoveled folders on Dropbox and came across my first crafts. When I took the first steps with microcontrollers, almost immediately I began ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proteus and two and a half hello world for UART and USB on the microcontroller</h1><div class="post__text post__text-html js-mediator-article">  Recently I shoveled folders on Dropbox and came across my first crafts.  When I took the first steps with microcontrollers, almost immediately I began to visit thoughts and ideas about managing my crafts with a PC, or in some way communicate with this PC.  It seemed fascinating and "serious."  Now I try to test everything at once in the gland, but at the beginning I wanted to step on the rake and shoot myself in the foot painlessly and quickly.  Proteus has always helped me in this.  Reassembling projects dozens of times was important so that you could experiment with comfort, if I may say so.  Then I bought the company debugging and that in Proteus, that in the hardware - everything became equally fast. <br>  First of all, I wanted to try UART and USB, and then Ethernet.  Every wish I made up my ‚Äúproject‚Äù.  Many ideas remained in the form of a project for Proteus - the idea got bored immediately after the implementation of the program part. <br>  I hope this post will help everyone who wanted to try to make their USB device or just to see that all this is not so difficult;  Moreover, I wanted to be able to try immediately in the simulator.  Tell as a beginner for a beginner - so that you want to open Google and start reading to do more, learn better. <br>  I will not talk about registers, modes.  I doubt this will help light the fire in my eyes.  Perhaps, someone will want to do something useful for themselves and simple examples have more chances to drag this extremely fascinating work (and for me it's practically a drug).  And before you run on ebay or start counting the days from the moment you send a debug card from China, you can try your hand at a virtual microcontroller. <br>  I would like to try to make two kind of hello world projects, which, however, are not much more complicated than standard LED blinking.  There are a lot of images under the cut. <br><a name="habracut"></a><br>  The description and code examples in the text will be for the PIC18F4550 microcontroller, I beg you to forgive me, I did not work with atmel.  And STM8 / 32 are missing even in version 8. <br>  The code for the microcontrollers was written for the mikroC compiler from <a href="http://mikroe.com/">Mikroelektronika</a> and was written for ease of understanding, I hope it came out at least partially for me. <br><br><h4>  Proteus and MCU strapping </h4><br><br>  Proteus, it seems to me, was created for the prototyping and testing of the software in the first place.  Perhaps that is why he allows multiple simplifications in the creation of schemes.  Below is an absolutely sufficient set for testing communication with a PC via UART / USB.  I want to note again that such a scheme will work only in Proteus. <br>  All projects are attached to the article, so by installing the program, you can immediately try everything. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/aa2/66b/203/aa266b2032c48b09f880ee9a12bf9c38.png"><br><br><h3>  U (S) ART </h3><br><br>  The topic is beaten, but still let me describe it again. <br>  To connect <a href="http://www.putty.org/">putty</a> or any other arbitrary program to our virtual microcontroller, we need to do a few things. <br>  The COMPIM module uses a virtual port, in order to connect to it, you need to create another one and connect them as a <a href="http://ru.wikipedia.org/wiki/%25D0%259D%25D1%2583%25D0%25BB%25D1%258C-%25D0%25BC%25D0%25BE%25D0%25B4%25D0%25B5%25D0%25BC%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2581%25D0%25BE%25D0%25B5%25D0%25B4%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5">null modem</a> . <br>  A good helper here is the <a href="http://com0com.sourceforge.net/">free com0com utility</a> . <br>  There we create two virtual ports, in my case it is COM 3 and 4. We connect one to the Proteus COMPIM, the second is already used ‚Äúoutside‚Äù <br><br>  Program window <br><img src="https://habrastorage.org/getpro/habr/post_images/1db/27c/043/1db27c043d563d332ba8f8127f5a00da.png"><br><br>  This is how it will look in devmgmt.msc (Device Manager) <br><img src="https://habrastorage.org/getpro/habr/post_images/ff3/767/60c/ff376760cd8a71711c8716ee02e714e2.png"><br><br>  Now everything is ready for the test. <br><br><div class="spoiler">  <b class="spoiler_title">Create a program for the test</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> uart_rd; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ UART1_Init(<span class="hljs-number"><span class="hljs-number">9600</span></span>); UART1_Write_Text(<span class="hljs-string"><span class="hljs-string">"Hello Habrahabr"</span></span>); UART1_Write(<span class="hljs-number"><span class="hljs-number">10</span></span>); UART1_Write(<span class="hljs-number"><span class="hljs-number">13</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(;;) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(UART1_Data_Ready()) { uart_rd = UART1_Read( ); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(uart_rd) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xD</span></span>: UART1_Write(<span class="hljs-number"><span class="hljs-number">10</span></span>); UART1_Write(<span class="hljs-number"><span class="hljs-number">13</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: UART1_Write(uart_rd); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } }</code> </pre> <br></div></div><br><br>  Configure the COMPIM device (right click - Edit properties). <br>  Let me remind you that my com0com emulates COM3 / COM4 ports <br><img src="https://habrastorage.org/getpro/habr/post_images/f9c/b38/b96/f9cb38b96a59d1b23e65555cf1e2cd3d.png"><br><br>  Just in case, I will attach a picture with the settings of the microcontroller <br><img src="https://habrastorage.org/getpro/habr/post_images/614/807/011/614807011ad99655cb046871bcad37f7.png"><br><br>  Turn on Putty, convert it to Serial mode and connect to COM4.  Now ... click on the button - you will get the result <br>  We print the text in the terminal window and the microcontroller echo us back.  Pressing enter translates the caret + new line. <br>  Backspace also works.  I immediately remembered how I chatted with friends on the Hyper Terminal, spending hours on the telephone line ... <br><img src="https://habrastorage.org/getpro/habr/post_images/cee/b23/cd8/ceeb23cd8e12c39c0597c602377f9cfa.png"><br><br>  Now you can play with the microcontroller by changing the code. <br><div class="spoiler">  <b class="spoiler_title">For example, you can add a primitive command handler.</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CRLF UART1_Write(10);UART1_Write(13) char uart_rd = 0; char cmd[32] = {0}; int char_counter = 0; void cmd_exec(void) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (strstr(cmd, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"hello"</span></span></span><span class="hljs-meta">)) { UART1_Write_Text(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"EHLO"</span></span></span><span class="hljs-meta">); CRLF; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (strstr(cmd, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"test"</span></span></span><span class="hljs-meta">)) { UART1_Write_Text(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"TSET"</span></span></span><span class="hljs-meta">); CRLF; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { UART1_Write_Text(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Unknown command"</span></span></span><span class="hljs-meta">); CRLF; } char_counter=0; memset(cmd, 0, sizeof cmd); } void main(void) { UART1_Init(9600); UART1_Write_Text(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MCU started"</span></span></span><span class="hljs-meta">); UART1_Write(10); UART1_Write(13); for(;;) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(UART1_Data_Ready()) { uart_rd = UART1_Read( ); switch(uart_rd) { case 0xD: CRLF; cmd_exec(); break; default: UART1_Write(uart_rd); break; } cmd[char_counter++] = uart_rd; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(char_counter == (sizeof cmd - 1)) { CRLF; cmd_exec(); } } } }</span></span></code> </pre><br></div></div><br><br><h3>  USB HID </h3><br><br>  Making my USB device was not easy for me then.  We will test the <a href="http://ru.wikipedia.org/wiki/USB_HID">HID</a> device, that is, in most cases - the input device. <br>  I really wanted to make an automatic password entry, as well as lock the computer when I moved away, and unlock when I approached.  Well, a bunch of something else that could be implemented through a virtual keyboard. <br>  A bunch of useful information on HID can be found <a href="http://www.usb.org/developers/hidpage/">here</a> .  Read - do not reread. <br>  In short: each USB HID device has a special description, a descriptor.  Which describes what kind of device it is, how it can be controlled, how much it consumes from the bus, or whether it has independent power and a lot of other information.  Therefore, we need to make a correct description so that the OS can understand that this is a keyboard and can work with it. <br><br>  But first, in order for Proteus to forward its virtual USB host to our real PC, you need to install a virtual driver, it comes with <br><img src="https://habrastorage.org/getpro/habr/post_images/c19/469/25e/c1946925ef644be7f2f090de355fb853.png"><br><br>  In order for the device to work as a full-fledged FullSpeed ‚Äã‚ÄãUSB 2.0, you need to enable the PLL and configure it accordingly. <br>  In Proteus, it is also necessary to set the processor frequency as 96 MHz. <br><br><div class="spoiler">  <b class="spoiler_title">Under the spoiler, an explanation of how the master oscillator works (in the case of the PIC)</b> <div class="spoiler_text">  Everything is described in detail <a href="http://www.mikroe.com/forum/viewtopic.php%3Ft%3D10646">here.</a> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ca1/bc2/de8/ca1bc2de864839ca184f7656405cec35.jpg" alt="image"><br></div></div><br><br><h5>  Descriptor </h5><br><br>  It was very useful for me to just run through his eyes and experiment.  It immediately became clear where to dig in endless pdf from usb.org <br><br>  In our case, there is a bit of a ‚Äústandard‚Äù change descriptor: <br>  We changed the VID / PID, indicated that we have an I / O buffer of 8 bytes each and, in fact, indicated that we have a keyboard device and it should be used this way. <br>  All variable names speak for themselves. <br><br><div class="spoiler">  <b class="spoiler_title">The code itself is a lot of code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> USB_VENDOR_ID = <span class="hljs-number"><span class="hljs-number">0xdead</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> USB_PRODUCT_ID = <span class="hljs-number"><span class="hljs-number">0xbeaf</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> USB_SELF_POWER = <span class="hljs-number"><span class="hljs-number">0x80</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Self powered 0xC0, 0x80 bus powered const char USB_MAX_POWER = 50; // Bus power required in units of 2 mA const char HID_INPUT_REPORT_BYTES = 8; const char HID_OUTPUT_REPORT_BYTES = 8; const char USB_TRANSFER_TYPE = 0x03; //0x03 Interrupt const char EP_IN_INTERVAL = 1; const char EP_OUT_INTERVAL = 1; const char USB_INTERRUPT = 1; const char USB_HID_EP = 1; const char USB_HID_RPT_SIZE = 63; /* Device Descriptor */ const struct { char bLength; // bLength - Descriptor size in bytes (12h) char bDescriptorType; // bDescriptorType - The constant DEVICE (01h) unsigned int bcdUSB; // bcdUSB - USB specification release number (BCD) char bDeviceClass; // bDeviceClass - Class Code char bDeviceSubClass; // bDeviceSubClass - Subclass code char bDeviceProtocol; // bDeviceProtocol - Protocol code char bMaxPacketSize0; // bMaxPacketSize0 - Maximum packet size for endpoint 0 unsigned int idVendor; // idVendor - Vendor ID unsigned int idProduct; // idProduct - Product ID unsigned int bcdDevice; // bcdDevice - Device release number (BCD) char iManufacturer; // iManufacturer - Index of string descriptor for the manufacturer char iProduct; // iProduct - Index of string descriptor for the product. char iSerialNumber; // iSerialNumber - Index of string descriptor for the serial number. char bNumConfigurations; // bNumConfigurations - Number of possible configurations } device_dsc = { 0x12, // bLength 0x01, // bDescriptorType 0x0200, // bcdUSB 0x00, // bDeviceClass 0x00, // bDeviceSubClass 0x00, // bDeviceProtocol 8, // bMaxPacketSize0 USB_VENDOR_ID, // idVendor USB_PRODUCT_ID, // idProduct 0x0001, // bcdDevice 0x01, // iManufacturer 0x02, // iProduct 0x00, // iSerialNumber 0x01 // bNumConfigurations } ; /* Configuration 1 Descriptor */ const char configDescriptor1[]= { // Configuration Descriptor 0x09, // bLength - Descriptor size in bytes 0x02, // bDescriptorType - The constant CONFIGURATION (02h) 0x29,0x00, // wTotalLength - The number of bytes in the configuration descriptor and all of its subordinate descriptors 1, // bNumInterfaces - Number of interfaces in the configuration 1, // bConfigurationValue - Identifier for Set Configuration and Get Configuration requests 0, // iConfiguration - Index of string descriptor for the configuration USB_SELF_POWER, // bmAttributes - Self/bus power and remote wakeup settings USB_MAX_POWER, // bMaxPower - Bus power required in units of 2 mA // Interface Descriptor 0x09, // bLength - Descriptor size in bytes (09h) 0x04, // bDescriptorType - The constant Interface (04h) 0, // bInterfaceNumber - Number identifying this interface 0, // bAlternateSetting - A number that identifies a descriptor with alternate settings for this bInterfaceNumber. 2, // bNumEndpoint - Number of endpoints supported not counting endpoint zero 0x03, // bInterfaceClass - Class code 0, // bInterfaceSubclass - Subclass code 0, // bInterfaceProtocol - Protocol code 0, // iInterface - Interface string index // HID Class-Specific Descriptor 0x09, // bLength - Descriptor size in bytes. 0x21, // bDescriptorType - This descriptor's type: 21h to indicate the HID class. 0x01,0x01, // bcdHID - HID specification release number (BCD). 0x00, // bCountryCode - Numeric expression identifying the country for localized hardware (BCD) or 00h. 1, // bNumDescriptors - Number of subordinate report and physical descriptors. 0x22, // bDescriptorType - The type of a class-specific descriptor that follows USB_HID_RPT_SIZE,0x00, // wDescriptorLength - Total length of the descriptor identified above. // Endpoint Descriptor 0x07, // bLength - Descriptor size in bytes (07h) 0x05, // bDescriptorType - The constant Endpoint (05h) USB_HID_EP | 0x80, // bEndpointAddress - Endpoint number and direction USB_TRANSFER_TYPE, // bmAttributes - Transfer type and supplementary information 0x40,0x00, // wMaxPacketSize - Maximum packet size supported EP_IN_INTERVAL, // bInterval - Service interval or NAK rate // Endpoint Descriptor 0x07, // bLength - Descriptor size in bytes (07h) 0x05, // bDescriptorType - The constant Endpoint (05h) USB_HID_EP, // bEndpointAddress - Endpoint number and direction USB_TRANSFER_TYPE, // bmAttributes - Transfer type and supplementary information 0x40,0x00, // wMaxPacketSize - Maximum packet size supported EP_OUT_INTERVAL // bInterval - Service interval or NAK rate } ; const struct { char report[]; } hid_rpt_desc = { 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x06, // USAGE (Keyboard) 0xa1, 0x01, // COLLECTION (Application) 0x05, 0x07, // USAGE_PAGE (Keyboard) 0x19, 0xe0, // USAGE_MINIMUM 224(Keyboard LeftControl) 0x29, 0xe7, // USAGE_MAXIMUM 231(Keyboard Right GUI) (left and right: alt, shift, ctrl and win) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x25, 0x01, // LOGICAL_MAXIMUM (1) 0x75, 0x01, // REPORT_SIZE (1) 0x95, 0x08, // REPORT_COUNT (8) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x95, 0x01, // REPORT_COUNT (1) 0x75, 0x08, // REPORT_SIZE (8) 0x81, 0x03, // INPUT (Cnst,Var,Abs) 0x95, 0x05, // REPORT_COUNT (5) 0x75, 0x01, // REPORT_SIZE (1) 0x05, 0x08, // USAGE_PAGE (LEDs) 0x19, 0x01, // USAGE_MINIMUM (Num Lock) 0x29, 0x05, // USAGE_MAXIMUM (Kana) 0x91, 0x02, // OUTPUT (Data,Var,Abs) 0x95, 0x01, // REPORT_COUNT (1) 0x75, 0x03, // REPORT_SIZE (3) 0x91, 0x03, // OUTPUT (Cnst,Var,Abs) 0x95, 0x06, // REPORT_COUNT (6) 0x75, 0x08, // REPORT_SIZE (8) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x25, 0x65, // LOGICAL_MAXIMUM (101) 0x05, 0x07, // USAGE_PAGE (Keyboard) 0x19, 0x00, // USAGE_MINIMUM (Reserved (no event indicated)) 0x29, 0x65, // USAGE_MAXIMUM (Keyboard Application) 0x81, 0x00, // INPUT (Data,Ary,Abs) 0xc0 // END_COLLECTION } ; //Language code string descriptor const struct { char bLength; char bDscType; unsigned int string[1]; } strd1 = { 4, 0x03, { 0x0409 } } ; //Manufacturer string descriptor const struct{ char bLength; char bDscType; unsigned int string[10]; } strd2={ 22, //sizeof this descriptor string 0x03, { 'H','a','b','r','a','h','a','b','r' } } ; //Product string descriptor const struct{ char bLength; char bDscType; unsigned int string[15]; } strd3={ 32, //sizeof this descriptor string 0x03, { 'H','a','b','r','a','K','e','y','b','o','a','r','d' } } ; //Array of configuration descriptors const char* USB_config_dsc_ptr[1]; //Array of string descriptors const char* USB_string_dsc_ptr[3]; void USB_Init_Desc(){ USB_config_dsc_ptr[0] = &amp;configDescriptor1; USB_string_dsc_ptr[0] = (const char*)&amp;strd1; USB_string_dsc_ptr[1] = (const char*)&amp;strd2; USB_string_dsc_ptr[2] = (const char*)&amp;strd3; }</span></span></code> </pre><br></div></div><br><br>  This handle is added to the project, and will be automatically used during assembly. <br><div class="spoiler">  <b class="spoiler_title">The simplest program to type text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> USBResponse[<span class="hljs-number"><span class="hljs-number">8</span></span>] = { <span class="hljs-number"><span class="hljs-number">0</span></span>} absolute <span class="hljs-number"><span class="hljs-number">0x500</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> USBCommand[<span class="hljs-number"><span class="hljs-number">8</span></span>] = {<span class="hljs-number"><span class="hljs-number">0</span></span>} absolute <span class="hljs-number"><span class="hljs-number">0x508</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *text=<span class="hljs-string"><span class="hljs-string">"habrahabr"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interrupt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ USB_Interrupt_Proc( ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clrUSB</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(USBCommand, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> USBCommand); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !HID_Write(&amp;USBCommand, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> USBCommand)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ADCON1 |= <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; CMCON |= <span class="hljs-number"><span class="hljs-number">7</span></span>; HID_Enable(&amp;USBResponse, &amp;USBCommand); delay_ms(<span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(text); i++) { USBCommand[<span class="hljs-number"><span class="hljs-number">2</span></span>] = text[i] - <span class="hljs-number"><span class="hljs-number">93</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !HID_Write(&amp;USBCommand, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span> USBCommand)); clrUSB(); delay_ms(<span class="hljs-number"><span class="hljs-number">200</span></span>); } }</code> </pre><br></div></div><br><br>  In fact, all the work consists in filling the corresponding buffer and sending it to the PC.  No more difficult than with the UART.  All work is done in the interrupt routine.  Included with the IDE are already ready-made libraries to work with HID. <br>  Here it should be clarified that <a href="http://www.mindrunway.ru/IgorPlHex/USBKeyScan.pdf">scan keyboard codes</a> are different from ASCII, but in order not to overload the code (we also have hello world), I avoided this inconvenience in a primitive way.  It will work only for lowercase letters.  Those interested can make the conversion themselves.  I use a similar device for KVM At work, a wireless keyboard extension - our D-Link KVMs don't want to understand USB wireless dongles. <br><br>  Now open the Notepad, launch Proteus (first click on the virtual plug - the USB connector is ‚Äúinserted‚Äù), immediately transfer the focus to Notepad with the mouse and watch how our creation prints the word <b>habrahabr</b> . <br><img src="https://habrastorage.org/getpro/habr/post_images/5bf/f29/79d/5bff2979de418ea05de702985881b457.png"><br>  And in the dispatcher our device appeared <br><img src="https://habrastorage.org/getpro/habr/post_images/1bc/839/59c/1bc83959cb49c0bda64da508ef5e44d0.png"><br><br>  Now you can add something of your own based on this. <br><br>  A few words about how it works. <br>  8 bytes are reserved for keyboard I / O: <br><br>  0 Modifier <br>  1 Not used <br>  2 Key 1 <br>  3 Key 2 <br>  4 Key 3 <br>  5 Key 4 <br>  6 Key 5 <br>  7 Key 6 <br><br>  Modifiers are special Ctrl, Shift, Alt keys.  They can be combined.  For example, for the Ctrl Alt Del combination: <br><br>  Modifier: 0b00000 <b>101</b> <b>Ctrl</b> , Shift, <b>Alt</b> <br>  Key code: 0x4c (Delete key) <br><br>  It should be remembered that immediately after transferring the data, it is necessary to erase the USB buffer, otherwise the effect of a sticky key is obtained.  That is, send eight zero bytes to the PC.  In the example, the clearUSB subroutine does this. <br>  Read more about scancodes described in <a href="http://ww1.microchip.com/downloads/en/AppNotes/01212a.pdf">microchip appnote.</a> <br>  In the same way, you can create a regular HID device and send / receive bytes from a PC, and according to the logic of operation it is almost no different from the same UART.  But this already requires a separate job, for example, from libusb on the PC side. <br><br><h4>  Ethernet </h4><br><br>  Not reflected in the title, but this is also worth mentioning. <br>  Unfortunately, this example will not be complete, as this is a topic for another conversation. <br>  But, at least, I will describe how to set up the simulator itself, and some things will still work. <br>  Here is just an example of what works in the gland, but does not always work in the simulator.  In Proteus, VSM models are implemented for ENC28J60 and RTL8019 microcircuits.  Yes, yes, the same chip that we all knew from budget network cards.  The use of ENC is described quite widely and there should be no problems here.  For example, the distinguished Lifelover aka Redsh described everything for a long time and most elaborately.  Therefore, so as not to be boring, take 8019, the more I write software for it for use with the Z80. <br><br>  As with USB, we need to install drivers, but now WinPCAP.  They lie in the Virtual Network folder, next to the USB drivers.  Or download <a href="http://www.winpcap.org/install/default.htm">the latest version</a> from the <a href="http://www.winpcap.org/install/default.htm">site.</a> <br>  After that, we will have a new virtual network interface with the address 192.168.95.1, which, of course, can be changed. <br><br>  We make a debugging interface on the UART using the scheme we already know. <br>  HINT: If you are annoyed with TEXT inscriptions - put a space in the component Description <br><img src="https://habrastorage.org/getpro/habr/post_images/176/d69/26f/176d6926fb516e3f64d33c637828823d.png"><br><br>  In the properties of the chip, write the number or IP of our virtual network card and you can change some settings. <br>  In my case it is 192.168.50.1 (I changed) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4da/b2a/fdf/4dab2afdf38505e314bff0cd32e2df2b.png"><br><br>  Next thing for the software.  A full-fledged driver for 8019 is not yet ready for me, and this is the topic of a separate large article, although this anachronism is hardly interesting to someone.  But even without setting up the protocols (the IP address is 0.0.0.0 now), since I enabled ICMP / Broadcast in the registers, we can ping some left address in our subnet, and the <s>network card of the</s> microcircuit will happily flash us an LED when it receives a packet.  After each attempt, use the new address, and the ARP table is cached. <br><img src="https://habrastorage.org/getpro/habr/post_images/795/878/7e5/7958787e5fe9f1fbb1e5f52cfe93519f.png"><br><br>  Along with the projects, ready-made HEX is attached, so you can not even download the compiler if you just need to check that everything works. <br>  For the simulation to work, do not forget to tell the microcontroller where your HEX file is located. <br><br>  You can download all the files at this <a href="">link.</a> <br><br>  I hope someone will burn the desire to try and implement in the gland. </div><p>Source: <a href="https://habr.com/ru/post/206034/">https://habr.com/ru/post/206034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206016/index.html">Why and what license is needed?</a></li>
<li><a href="../206018/index.html">Smart Hosting # 3</a></li>
<li><a href="../206020/index.html">Sony has released a universal USB flash drive for PC / mobile devices</a></li>
<li><a href="../206024/index.html">Why I hate virtualenv and pip</a></li>
<li><a href="../206030/index.html">Threads are Goto Parallel Programming</a></li>
<li><a href="../206036/index.html">FT232H, MPSSE and SPI programmer for 15 euros</a></li>
<li><a href="../206038/index.html">SteamOS available for download</a></li>
<li><a href="../206040/index.html">Such authors are needed on TV: an example of Werner Herzog</a></li>
<li><a href="../206048/index.html">Shine - fitness button</a></li>
<li><a href="../206050/index.html">How to compile build of Unity3D project for IOS on Windows?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>