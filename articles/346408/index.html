<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Attention! S in Ethereum stands for Security. Part 2. EVM features</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We present the second part of the cycle devoted to typical vulnerabilities, attacks and problem areas inherent in smart contracts in the Solidity lang...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Attention! S in Ethereum stands for Security. Part 2. EVM features</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/2p/mr/ud/2pmrudjnousyj6oodl0zj3_xxls.png"></p><br><p>  We present the second part of the cycle devoted to typical vulnerabilities, attacks and problem areas inherent in smart contracts in the Solidity language, and the Ethereum platform as a whole.  Here we talk about some of the features of EVM and what vulnerabilities they can turn into. </p><a name="habracut"></a><br><p>  In the <a href="https://habrahabr.ru/company/dsec/blog/345196/">first</a> part, we discussed the front-running attack, various random number generation algorithms and network resiliency with the Proof-of-Authority consensus.  And here the list is all the more extensive, but they all have a direct bearing on smart contracts.  So let's go. </p><br><h2 id="overflowunderflow">  Overflow / underflow </h2><br><p>  Overflows in EVM can be for int and uint types of all digits and with many <a href="https://github.com/ethereum/solidity/issues/796">operations</a> . <br>  It looks like this: </p><br><pre><code class="hljs cs">contract _flow { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> umax = <span class="hljs-number"><span class="hljs-number">2</span></span>**<span class="hljs-number"><span class="hljs-number">256</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> umin = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> max = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(~((<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">255</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> min = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">255</span></span>)); <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">overflow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { umax++; max++; <span class="hljs-comment"><span class="hljs-comment">//  += 1; //  *= 2; } function underflow() { umin--; min--; //  -= 1; } }</span></span></code> </pre> <br><p>  This can very often be found in the open spaces of the repository with smart contracts, because there is always <code>balance</code> , <code>CAP</code> , <code>price</code> , to which something is added, which multiply, divide, etc.  A good practice would be to use the <a href="">SafeMath</a> library for the type of data you are working with.  It should be borne in mind that Zeppelin SafeMath is only implemented for <code>uint</code> ! </p><br><p>  One more thing.  It may not catch the eye, but for <code>array.length</code> also used, which can also be overflowed in the same way.  Consider this example: </p><br><pre> <code class="hljs php">contract <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> { uint[] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>; address <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> owner; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Array</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ owner = msg.sender; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>.push(<span class="hljs-number"><span class="hljs-number">0xaa</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">underflow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>.length--; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">modify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint index, uint value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>[index] = value; } }</code> </pre> <br><p>  As you can see, there are no functions to change the <code>owner</code> , but anyone can become the owner. </p><br><div class="spoiler">  <b class="spoiler_title">Just tell me how</b> <div class="spoiler_text"><p>  To begin with about <a href="http://solidity.readthedocs.io/en/develop/miscellaneous.html">storage</a> .  Storage is an address space of length 2 ** 256 with a cell size of 32 bytes.  Simple types are put in a cell, so you can get them by key.  And for complex types, for example, arrays, hashing is used.  In the first cell responsible for the array, there will be its length, and the data itself will begin sequentially with the key, which is calculated as keccak256 (&lt;cell_ number_s_length&gt;).  Storage is used to store data between transactions (function calls), as a kind of hard drive. </p><br><p>  So, we proceed to the operation: </p><br><ol><li>  Calling underflow until underflow occurs and the length is 2 ** 256 </li><li>  Since Storage is in contract, the address space also has a length of 2 ** 256.  And it turns out that the <code>array</code> now occupies it completely.  But the owner is still in place, it is just now possible to get it with an index index </li><li><p>  Calculate this index: </p><br><pre> <code class="python hljs">hex(<span class="hljs-number"><span class="hljs-number">2</span></span>**<span class="hljs-number"><span class="hljs-number">256</span></span> - <span class="hljs-number"><span class="hljs-number">0xbabecafe</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  where <code>0xbabecafe</code> is the <code>key</code> cell in which the length of the <code>array</code> is stored (in the example it will be a zero cell), and 1 is the number of the cell in which the <code>owner</code> is stored </p><br></li><li>  Call <code>modify</code> : <br><ul><li>  <code>index</code> obtained in step 3. </li><li>  <code>value</code> is the new address for <code>owner</code> .  It's okay that the function accepts uint, - the <code>address</code> is also a number :) </li></ul></li></ol><br><p>  You can read more about this example in <a href="https://github.com/pertsev/solidity_tricks/tree/master/Rewriting">solidity_tricks</a> . </p></div></div><br><h2 id="abi-encodingdecoding">  ABI encoding / decoding </h2><br><p>  To begin with, we note that in order to call a function of a smart contract through a transaction, it is necessary to specify its signature in <code>tx.data</code> .  In the same place, the arguments that the function takes should follow.  Details on how each type is encoded can be found in the <a href="https://github.com/ethereum/wiki/wiki/Ethereum-Contract-ABI">documentation</a> . </p><br><p>  Two points need to be taken into account: </p><br><ul><li>  for dynamic types there is no check that their length is equal to the number of sent elements </li><li>  no type checking (see the Type Confusion example below). </li></ul><br><p>  When calling, the function takes the arguments sent by calling the <code>calldataload</code> instruction and then its main logic is executed.  Consider the behavior of different dynamic types on an <a href="https://github.com/pertsev/solidity_tricks/tree/master/DynamicTypesLengthDependency">example</a> : </p><br><pre> <code class="hljs cs">contract DynamicTypes { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> strLength; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bytsLength; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> arrayLength; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> str; bytes <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> byts; address[] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> array; <span class="hljs-comment"><span class="hljs-comment">//         function callme(string _str, bytes _byts, address[] _array) public { strLength = bytes(_str).length; str = _str; bytsLength = _byts.length; byts = _byts; arrayLength = _array.length; array = _array; } }</span></span></code> </pre> <br><p>  Call the callme function with the following code: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modifiedArgs = [ <span class="hljs-comment"><span class="hljs-comment">//   - bytes4(sha3("callme(string,bytes,address[])")) '0x5fc059fd', //        _str '0000000000000000000000000000000000000000000000000000000000000060', //        _byts '00000000000000000000000000000000000000000000000000000000000000a0', //        _array '00000000000000000000000000000000000000000000000000000000000000e0', //  _str 64 .       ! '0000000000000000000000000000000000000000000000000000000000000040', //   -  *AAAA* .  4 . '4141414100000000000000000000000000000000000000000000000000000000', //  _byts 64 .       ! '0000000000000000000000000000000000000000000000000000000000000040', //   - 3  0x42 0x43 0x44 '4243440000000000000000000000000000000000000000000000000000000000', //  _array 64 .       ! '0000000000000000000000000000000000000000000000000000000000000040', //    '0000000000000000000000000000000000000000000000000000000000000001', //    '0000000000000000000000000000000000000000000000000000000000000002' ]; modifiedData = modifiedArgs.join(""); //        //     var tx = web3.eth.sendTransaction({ "to" : contractAdd, "data" : modifiedData, "gas" : 1185919 }); // PS       .</span></span></code> </pre> <br><p>  After the transaction is processed, we will see the following picture: <br><img src="https://habrastorage.org/webt/ji/5e/4l/ji5e4l5itux87eajv7ltcrckowo.png"></p><br><p>  As you can see, the string is not actually "AAAA" (@ at the end is an interpretation of 0x40 - length _byts), bytes in <code>byts</code> not three, as in the data that was sent (similarly hooked 0x40 in the next argument), well, 64th we can freely receive an element from <code>array</code> .  Thus, to get data, EVM takes its length, cuts off how much is specified from <code>tx.data</code> , and transfers functions.  And it does not matter that the next argument has already gone or that <code>tx.data</code> over, we will add zeros :) </p><br><p>  And in the continuation of the topic we will talk about the <strong>Short address attack</strong> . </p><br><pre> <code class="hljs cs">contract ERC20 { address <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> who; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transfer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address _who, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _value</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span></span> { who = _who; <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = _value; } }</code> </pre> <br><p>  The contract has little to do with the original <a href="https://theethereum.wiki/w/index.php/ERC20_Token_Standard">ERC20</a> token, but most importantly, the <code>transfer</code> function will have the same signature as the original.  The Short address attack script is as follows: </p><br><ul><li>  the attacker <a href="https://github.com/pertsev/web3_utilz/tree/master/address%2520generator%2520for%2520SAA">generates a</a> special address with zero bytes at the end, and asks the victim to transfer tokens to it </li><li>  in the absence of processing the recipient's address, the client application (wallet, exchange) can form an "as is" transaction, and this will lead to unforeseen consequences for the user. </li></ul><br><p>  Call <code>transfer</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// defaultArgs    ,   modifiedArgs var defaultArgs = [ '0xa9059cbb', //    0x00    '0000000000000000000000003a0c7287b9aac3c71ee8b9048c5dfb989f2a4d00', //    1  '0000000000000000000000000000000000000000000000000000000000000001' ]; var modifiedArgs = [ '0xa9059cbb', //         '0000000000000000000000003a0c7287b9aac3c71ee8b9048c5dfb989f2a4d', '0000000000000000000000000000000000000000000000000000000000000001' ]; modifiedData = modifiedArgs.join(""); var tx = web3.eth.sendTransaction({ "to" : contractAdd, "data" : modifiedData, "gas" : 1185919 });</span></span></code> </pre> <br><p>  The missing zero byte at the end of the address will be taken from value (the arguments are parsed on the left), and the <code>value</code> EVM itself will simply add up to 32 bytes (again, a zero byte).  In other words, a byte shift of value <code>value</code> will occur, and it will become equal to 256 tokens (0x100), although the user wanted to translate only 1. In the general case: </p><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>=</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>z</mi><mo>&amp;#x2217;</mo><mn>8</mn></mrow></msup></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.37ex" height="2.539ex" viewBox="0 -987.6 5326.1 1093.4" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/346408/&amp;xid=17259,1500003,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjVEMIZISJw9Y9EKiT_3HPEC0dKyg#MJMATHI-76" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/346408/&amp;xid=17259,1500003,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjVEMIZISJw9Y9EKiT_3HPEC0dKyg#MJMATHI-61" x="485" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/346408/&amp;xid=17259,1500003,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjVEMIZISJw9Y9EKiT_3HPEC0dKyg#MJMATHI-6C" x="1015" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/346408/&amp;xid=17259,1500003,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjVEMIZISJw9Y9EKiT_3HPEC0dKyg#MJMATHI-75" x="1313" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/346408/&amp;xid=17259,1500003,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjVEMIZISJw9Y9EKiT_3HPEC0dKyg#MJMATHI-65" x="1886" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/346408/&amp;xid=17259,1500003,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjVEMIZISJw9Y9EKiT_3HPEC0dKyg#MJMAIN-3D" x="2630" y="0"></use><g transform="translate(3686,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/346408/&amp;xid=17259,1500003,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjVEMIZISJw9Y9EKiT_3HPEC0dKyg#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/346408/&amp;xid=17259,1500003,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjVEMIZISJw9Y9EKiT_3HPEC0dKyg#MJMATHI-7A" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/346408/&amp;xid=17259,1500003,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjVEMIZISJw9Y9EKiT_3HPEC0dKyg#MJMAIN-2217" x="468" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/dsec/blog/346408/&amp;xid=17259,1500003,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjVEMIZISJw9Y9EKiT_3HPEC0dKyg#MJMAIN-38" x="968" y="0"></use></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>=</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mi>z</mi><mo>‚àó</mo><mn>8</mn></mrow></msup></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> value = 2 ^ {z * 8} </script></p><br><p>  where <em>z</em> is the number of zero bytes at the end of the address (that is, there may be 2 and 3 ...). </p><br><p>  It is worth noting that although the attack is called the Short <em>Address</em> attack, in fact this is only a particular example.  It is not necessary to bind to an address or a <code>transfer</code> function, just as it does to the uint type of <code>value</code> .  All three components can be arbitrarily changed, expanding the classic idea of ‚Äã‚Äãa short address attack.  Moreover, the word <em>Short</em> also refers to a particular example.  The attacker can provide the address longer than usual, and the extra bytes will begin the <em>value</em> , and the ending will be cut off - that is, there will be a shift to the right. </p><br><h2 id="uninitialized-storage-pointer">  Uninitialized storage pointer </h2><br><p>  This problem has already been <a href="https://habrahabr.ru/company/neobit/blog/324456/">addressed</a> in Habr√©, so we will mention it briefly.  Here for understanding it is necessary to keep in mind two points: </p><br><ul><li>  According to the <a href="http://solidity.readthedocs.io/en/develop/types.html%3Fhighlight%3Darrays%2520structs">documentation</a> , each complex type has an additional annotation about where it is stored (Storage or Memory) </li><li>  All local variables are stored by default in Storage, and function arguments are stored in Memory. </li></ul><br><p>  Now an example: </p><br><pre> <code class="hljs pgsql">contract Uninitialized { address <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">owner</span></span>; //   <span class="hljs-keyword"><span class="hljs-keyword">Storage</span></span>( ),  <span class="hljs-number"><span class="hljs-number">0x00</span></span> uint <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> balance; //   <span class="hljs-keyword"><span class="hljs-keyword">Storage</span></span>( ),  <span class="hljs-number"><span class="hljs-number">0</span></span> struct Billy { address <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> rewriteOwner(address _where) <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> { Billy tmp; //     <span class="hljs-keyword"><span class="hljs-keyword">Storage</span></span>,   tmp.<span class="hljs-keyword"><span class="hljs-keyword">where</span></span> = _where; } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> rewriteBoth(bytes s) <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> { uint8[<span class="hljs-number"><span class="hljs-number">64</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>; //     <span class="hljs-keyword"><span class="hljs-keyword">Storage</span></span>,   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8 i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">64</span></span>; i++) <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>[i] = uint8(s[i]); } }</code> </pre> <br><p>  With a contract contract, the variables <code>owner</code> and <code>balance</code> initialized to default values, and there is no explicit code to change them.  However, it is possible.  If you call the <code>rewriteOwner</code> function with an address, assigning <code>tmp.where = _where</code> will also overwrite the <code>owner</code> .  This happens because the variable <code>tmp</code> is a reference type, and for it is not explicitly specified where the data is stored, which means (by default) <code>tmp</code> refers to Storage, and to the zero cell. </p><br><p>  The situation is completely similar for the <code>copy</code> array in the <code>rewriteBoth</code> function, but we mention it in order to show that the Storage cells are one after the other, and if 32 bytes of the zero cell are not enough, the next one will be overwritten, etc. </p><br><p>  To prevent this from happening, there are two options: </p><br><ul><li>  place variable in Memory ( <code>memory</code> keyword) </li><li>  use the <code>pure</code> and <code>view</code> identifiers of the function (or <code>constant</code> according to the old style). </li></ul><br><h2 id="type-confusion">  Type confusion </h2><br><p>  The following feature relates to how EVM works with types.  During the execution of type checks there is no, they all occur at the compiler level.  And, as we saw in the examples above, functions are called by signature, and if the signature is not found, the fallback function will be called. </p><br><p>  Consider this on the example of the epic battle from the movie The Matrix.  Suppose the characters in the matrix are represented by smart contracts (Neo and Smith).  And, for convenience, each has defined an abstract class for interacting with another (in its pure form, syntactic sugar): </p><br><pre> <code class="hljs lua">// ,   ,   : /*   Neo,       */ contract Neo { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">obtainDamage</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint256 value)</span></span></span></span>; } //      contract Smith { uint public health = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doDamage</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address who)</span></span></span></span> { Neo(who).obtainDamage(<span class="hljs-number"><span class="hljs-number">100</span></span>); //     Neo } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">obtainDamage</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint256 value)</span></span></span></span> { health -= value; } }</code> </pre> <br><p>  But the contract, which plays the role of Neo: </p><br><pre> <code class="hljs actionscript"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> contract Smith { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">obtainDamage</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint256 value)</span></span></span></span>; } contract Neo { uint8 <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> health = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Smith(msg.sender).obtainDamage(<span class="hljs-number"><span class="hljs-number">100</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">obtainDamage</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint8 value)</span></span></span><span class="hljs-function"> </span></span>{ health -= value; } }</code> </pre> <br><p>  Both deploy their contracts in <del>  matrix </del>  network, learn each other's addresses, and the battle begins: </p><br><ul><li>  Smith attacks first by calling <code>doDamage</code> with the contact address Neo. </li><li>  EVM is looking for a <code>bytes4(sha3("obtainDamage(uint256)")) == 0x7366f929</code> signature <code>bytes4(sha3("obtainDamage(uint256)")) == 0x7366f929</code> and does not find it, so the fallback function is called (as Neo dodged the impact) </li><li>  inside fallback Neo strikes back by calling the exact same function on the Smith contract. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Why did it happen?</b> <div class="spoiler_text"><p>  Let's take a closer look at the function of <code>obtainDamage</code> in the contract Neo.  Its signature is actually equal to <code>bytes4(sha3("obtainDamage(uint8)")) == 0x1f26cd3a</code> , because the <code>value</code> type is different. <br><img src="https://habrastorage.org/webt/yz/q9/kp/yzq9kpppx1hvwwv7r97wyrunk6g.gif"></p></div></div><br>  And now the question of "backfilling."  How to implement backdoor in real ICO, Crypto &lt;put animals here&gt; and others? <br><div class="spoiler">  <b class="spoiler_title">Answer</b> <div class="spoiler_text"><p>  Consider the example of ICO.  ICO usually has two contracts - the ERC20 token and Crowdsale.  Backdoor is placed in the token contract: for example, add the function <code>scoopAndDisappear</code> . </p><br><ul><li>  after deployment, on ethersan you only need the source code of crowdsale, which will also have a token contract, but the backdoor must, of course, be cut </li><li>  for the address of the token, do not submit anything, and if they ask, you can answer something like the following: "there is already a token contract in the crowdsale". </li></ul><br><p>  This will work because etherscan compiles the source file that was provided to it, and checks the byte-code with what was in the transaction when it was created.  If it is the same, then everything is fine.  And it will coincide, because the token contract is needed there only to make the correct signatures for the call (the contract byte-code itself is not there). </p><br><p>  Therefore, it is important that the developers point to the source codes of all contracts that are used in the project to etherscan.io.  The only exception may be the case when one contract creates another (through the construction <code>new</code> ).  Then yes - the current byte code will be in the creation stream. </p><br><p>  And here is another example of a <a href="https://github.com/Arachnid/uscc/tree/master/submissions-2017/darrylmorris">backdoor</a> .  A situation that develops due to the inattention of people. </p></div></div><br><p>  Today, everything, in the next series, we will proceed directly to Solidity, and see how it differs from other programming languages. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346408/">https://habr.com/ru/post/346408/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346394/index.html">How it works: monitoring of power supply of data center Selectel</a></li>
<li><a href="../346396/index.html">We squeeze the maximum out of accounting computer technology. Part 1</a></li>
<li><a href="../346398/index.html">How it works: Merkle trees in the bitcoin network</a></li>
<li><a href="../346404/index.html">Separation of chats and search in Telegram</a></li>
<li><a href="../346406/index.html">AngularJS + Webpack = lazyLoad</a></li>
<li><a href="../346410/index.html">Visual Tcl GUI Designer with theme widget support</a></li>
<li><a href="../346412/index.html">Several books for beginner and continuing developer for Android</a></li>
<li><a href="../346416/index.html">Legal aspects of mining cryptocurrency</a></li>
<li><a href="../346418/index.html">How many developers think Continuous Integration is not needed?</a></li>
<li><a href="../346420/index.html">Wi-Fi Alliance announced the WPA3 protocol with new security features and the development of Wi-Fi standard 802.11ax</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>