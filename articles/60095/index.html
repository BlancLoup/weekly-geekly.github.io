<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Combing Traffic - Dynamic Shaper on Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suppose you have a home network (or not a home network, but a small office network) with Internet access through a not very high-speed channel. And th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Combing Traffic - Dynamic Shaper on Linux</h1><div class="post__text post__text-html js-mediator-article"><img src="http://img.skitch.com/20090521-g6d5412b918gstawegia4muq1i.png" align="left" alt="brushing traffic"><br>  Suppose you have a home network (or not a home network, but a small office network) with Internet access through a not very high-speed channel.  And there are a lot of users, and everyone wants to download something, but with maximum speed.  Here we face the task of how to distribute our Internet channel as efficiently as possible among users so that they do not interfere with each other.  In this article I will describe how this problem can be solved using a Linux server. <br><br>  We formulate what we want to get as a result: <br>  1. To share the channel equally between users. <br>  2. To channel in vain not idle. <br>  3. So that online games, ssh and telnet do not ‚Äúlag‚Äù even when the channel is fully loaded, for example, torrents. <br><a name="habracut"></a><br><br>  If 10 users use the Internet at the same time, each will receive 1/10 of the channel, if only one user is active at the moment, he will use the entire channel himself. <br>  This can be achieved using the <a href="http://luxik.cdi.cz/~devik/qos/htb/">HTB</a> package scheduler, which is included in the linux kernel since version 2.4.20. <br><img src="http://pic.ipicture.ru/uploads/090521/wPVhF1hQiR.png" align="right" alt="image"><br>  You can configure the shaper using the tc command, but for a more convenient and intuitive setup, I recommend downloading the <a href="http://sourceforge.net/projects/htbinit/">htb.init</a> script.  They use a set of configuration files for configuring htb, so that when sorting alphabetically, their names allow you to visually imagine the tree of the shaper classes and conveniently edit it. <br>  Suppose that on our server there is an interface eth0, through which we are connected to the Internet, and eth1, which ‚Äúlooks‚Äù to the local network. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can control only outgoing traffic from the interface, so for eth0 there will be rules for uploading user traffic, and for - eth1 - download traffic. <br><br>  By default, the htb.init configuration files are in / etc / htb /.  To begin with, we will write the rules of shaping for upload traffic, we will have them simple. <br>  Create a file with the name <i>eth0</i> (‚Äúlooking‚Äù on the Internet), we will write the following lines to it: <br> <code>DEFAULT=20 <br> R2Q=1 <br></code> <br>  The DEFAULT parameter specifies the class number to which the ‚Äúdefault‚Äù traffic will be assigned ‚Äî usually the class with the lowest priority.  The R2Q parameter affects the operation of the channel separation algorithm and depends on the channel width.  I selected its value in an empirical way, for my outgoing channel in 2 Mbit. <br><br>  Next, create the file <i>eth0-2.full2MBit</i> , for the class that includes the entire available Internet channel.  The file name consists of the interface name and class id, after the point the semantic name of the class comes, is used as a comment and is ignored by the system. <br> <code>RATE=2Mbit <br> CEIL=2Mbit <br></code> <br>  RATE is our guaranteed band, CEIL is the maximum band.  Since I have a channel with a guaranteed maximum bandwidth of 2 Mbit, these parameters are equal for me. <br><br>  Now we will create one file for each traffic class that we have.  I created separate classes for ssh traffic, as well as the traffic of World of Warcraft and Counter Strike games, although you can make one class for all high-priority traffic. <br><br>  <i>Ssh</i> example - create <i>eth0-2: 10.ssh file</i> .  In the file name, a colon contains the id of the parent class 2 and the id of the current class is 10. You can select arbitrary identifiers for the class. <br> <code># class for outgoing ssh <br> RATE=128Kbit <br> CEIL=2Mbit <br> RULE=*:22 <br> PRIO=1 <br> BURST=100Kb <br></code> <br>  The RATE parameter indicates the guaranteed band for this class, in CEIL - the maximum.  We allocate for ssh 128 KBit (at a minimum) and allow it to download the entire channel (I upload files via sftp).  PRIO sets the priority of the traffic class (1 is the maximum; the higher the number, the lower the priority).  BURST sets the maximum amount of traffic that will be transmitted at maximum speed before going on to transfer data from other classes.  By setting this parameter to a sufficiently high value, we ensure that ssh traffic will be transmitted with minimal delays. <br>  RULE sets the rule by which traffic to this class will be selected. <br>  Format - RULE = [[saddr [/ prefix]] [: port [/ mask]],] [daddr [/ prefix]] [: port [/ mask]] <br>  Pay attention to the comma!  RULE = *: 22 denotes traffic whose destination port is 22, and RULE = *: 22 denotes traffic whose outgoing port is 22. <br><br>  We will also create classes for other types of traffic, and a class for traffic ‚Äúby default‚Äù with id 20 (we indicated first that it is to class number 20 that traffic should be sent ‚Äúby default‚Äù).  In it, we indicate the used discipline of division of the channel LEAF = sfq, in order for the upload to be equally divided between TCP sessions of different users. <br><br>  For eth1, the rules will be almost the same, only taking into account that the total channel width is 100 Mbit, because we want to be able to access local server resources at full speed, a separate class of 2 MBit is allocated for Internet traffic, which added descendants as descendants classes of individual users, the division into classes I did by IP addresses.  For each user, you can specify the maximum and guaranteed speed, as well as priority. <br><br>  After editing the configuration, restart htb.init: <br> <code>/etc/init.d/htb.init restart</code> <br>  And the rules of shaping traffic immediately take effect. <br><br>  In the process of compiling the rules, there is usually a need to somehow visualize traffic for debugging and monitoring purposes, so I decided to write a plugin for the munin server monitoring system, which would visualize the distribution of traffic classes over HTB classes.  I decided to print only the tree leaf classes, since they usually carry the meaning. <br>  You can download the plugin from the munin plugin's official repository, it is called <a href="http://muninexchange.projects.linpro.no/%3Fsearch%3D%26cid%3D10%26os%255B4%255D%3Don%26os%255B7%255D%3Don%26os%255B3%255D%3Don%26os%255B2%255D%3Don%26os%255B5%255D%3Don%26os%255B8%255D%3Don%26os%255B1%255D%3Don%26os%255B6%255D%3Don%26pid%3D168">qos_</a> , just copy it to the munin / usr / share / munin / plugins / plug-ins folder and in the folder of used plug-ins / etc / munin / plugins make a symbolic link like qos_eth1, where eth1 is the name of the interface on which you want to monitor the download. <br>  In the plugin configuration file you can add the following: <br> <code>[qos_eth1] <br> env.ignore_queue1_10 yes <br> env.label_name1_31 Viperet <br> env.label_name1_32 Cornet <br></code> <br>  The env.ignore_queue parameter allows not to display the state of the class with the specified id on the graph, and the env.label_name parameter to set the intelligible label for the class on the graph. <br><br>  In the end, it should be something like this: <br><div style="text-align:center;"><img src="http://admin.podusovka.net/munin/podusovka/podusovka-qos_eth1-day.png" alt="image"></div><br>  I want to note that I have a somewhat atypical situation, two Internet channels for 2 and 1 Mbit, and for each user a limit of 2 Mbit download speeds, so the graph shows that if one user is active, his speed is reduced by 2 Mbit, and if several - the total speed can reach three.  More than 20 people work on such a fairly ‚Äúclose‚Äù channel, and they feel quite comfortable without interfering with each other. <br>  This picture is from a real server, and it is updated every 5 minutes and displays the current picture of the channel load. <br><br>  <b>UPD:</b> posted <a href="">an example config htb.init</a> </div><p>Source: <a href="https://habr.com/ru/post/60095/">https://habr.com/ru/post/60095/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../60085/index.html">Manipulate System.Drawing.Bitmap</a></li>
<li><a href="../60086/index.html">Corruption, tenders and power</a></li>
<li><a href="../60090/index.html">Load on demand and jQuery</a></li>
<li><a href="../60092/index.html">The second day of SEF in Minsk</a></li>
<li><a href="../60094/index.html">HTC Iolite review - part 2 - software-battery</a></li>
<li><a href="../60099/index.html">‚ÄúScrachy‚Äù - Scratch Player Concept</a></li>
<li><a href="../60102/index.html">freebsd current8.0 jail limits</a></li>
<li><a href="../60103/index.html">Google Translate Client</a></li>
<li><a href="../60105/index.html">Data mining in relation to employees online and offline - laughter and tears</a></li>
<li><a href="../60106/index.html">Mantis :: Screenshot Automation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>