<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>When testing through a public method starts to stink (example)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the article about testing public methods, I touched on unit testing of private class logic. I think it would be worthwhile for me to redo the thesi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>When testing through a public method starts to stink (example)</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habr.com/post/419873/">article about testing public methods, I</a> touched on unit testing of private class logic.  I think it would be worthwhile for me to redo the thesis, since the majority, in my opinion, perceived that it was a question of testing private methods, although it was a question of private logic.  In this article I want to illustrate with a practical example the main thesis.  Under a cat an example with the small analysis. <a name="habracut"></a><br><br><h3>  An example with a smell </h3><br>  In order to illustrate the problem, came up with an example.  His idea is taken from one real project.  Ideally, as someone might notice, the class would have to be written differently.  But now no one will rewrite it (or refactor), because  this will lead to a great investment of time in editing and testing what works.  Therefore, it will not be approved.  At the same time, it is necessary to change the code and the changes must be correct.  And so, here is the code.  The important logic is concentrated in the ProcessMessage method.  Objective: to introduce a new flag of business logic in message processing.  This flag has nontrivial logic. <br><br>  How will you implement and test the flag? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Messaging; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">PublicMethodNottrivialSample</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageProcessorService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> _lockObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CancellationTokenSource _cancellationSource; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action _receiveMessage; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _listenerThreads = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (_lockObject) { _cancellationSource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); Task.Factory.StartNew(() =&gt; InitializeReceiveLoop(_cancellationSource.Token), _cancellationSource.Token); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeReceiveLoop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CancellationToken cancellationToken</span></span></span><span class="hljs-function">)</span></span> { _receiveMessage = () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!cancellationToken.IsCancellationRequested) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (MessageQueueTransaction msgTx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageQueueTransaction()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { msgTx.Begin(); <span class="hljs-comment"><span class="hljs-comment">//   MessageQueue queue = new MessageQueue(); Message message = queue.Receive(msgTx); //    ,    if (!cancellationToken.IsCancellationRequested) { ProcessMessage(message); } msgTx.Commit(); } catch (Exception ex) { // some logging } } } }; for (int n = 0; n &lt; _listenerThreads; n++) { StartProcessingLoop(cancellationToken); } } private void ProcessMessage(Message message) { //   ,     } private void StartProcessingLoop(CancellationToken cancellationToken) { Task.Factory.StartNew(_receiveMessage, cancellationToken); } } }</span></span></code> </pre> <br>  In the class, it is clear that the only public method is Start ().  It can be tested if the signature is changed, but in this case the public interface changes.  In addition, you will need to change several methods to return running threads and then wait for them to end in the test. <br><br>  But, as we remember, the requirement concerned only the introduction of the flag in the processing of the message, and did not imply a change in the operation of the mechanism for receiving messages.  Therefore, no matter who makes the changes, I would expect that only one method would be fixed, and the unit test would be related only to the logic being changed.  To achieve this, remaining within the framework of the principle is difficult: the test will turn out to be non-trivial, which will entail either a refusal to write it or complicated code.  This is how it begins to pitch testing through the public method.  And then someone will emotionally write: ‚ÄúTDD is long‚Äù, ‚ÄúCustomer does not pay‚Äù, or ‚ÄúTests do not work well‚Äù. <br><br>  In general, it is necessary to test such code, but not by integration tests, but by integration tests. <br><br><h3>  "You checkers, or go" </h3><br>  Of course, it is necessary to write a unit test for the changed logic.  I believe that the dilemma, in this case, is to choose the least expensive way to write a test, and not a useful code.  Here I mean the fact that whatever you do: refactoring for a public method or another solution - you will do it with the goal of writing a test, and not solving the requirement from the client‚Äôs task.  In this case, it is advisable to evaluate the costs and effects.  In addition to the above solution with refactoring, there are several other alternative solutions.  I cite everything, discuss the pros and cons below: <br><br><ol><li>  you can test private method </li><li>  method can be made public </li><li>  can be made internal </li><li>  can be pulled out in a separate class, as a public method </li></ol><br>  If we compare the first three ways with the solution through the public method, but they all require less labor (it‚Äôs not a private fact).  Also, all of them, in fact, are the same solution, with minor stylistic differences.  Since  the result will be obtained in any way, therefore, in my opinion, the choice in favor of one of these solutions should be based not on the technical capabilities of the language, but on what you want to show other developers: <br><br><ol><li>  if the method can be run from any place in the solution and it is part of the class behavior, then make it public and pull it into the class interface; </li><li>  if the method can be used from any other class, but only inside this assembly, then make it <b>internal</b> ; </li><li>  if the method can be used only inside the main class, where it can be called from any other method, then make it <b>protected internal</b> . </li></ol><br>  Internal methods can be made visible to the assembly with tests using the InternalsVisibleTo attribute and called as usual.  This approach simplifies writing tests, and the result will be the same. <br><br><h3>  Testing ProcessMessage </h3><br>  Let's return to the task.  Guided by the approach above, I would make a few changes: <br><br><ul><li>  would make ProcessMessage public </li><li>  would create a new protected internal method for flag logic (for example, GetFlagValue) </li><li>  would write tests for GetFlagValue for all cases </li><li>  would write a test for ProcessMessage to make sure that GetFlagValue is used correctly: parameters are passed correctly and it is actually used </li></ul><br>  I‚Äôll clarify that I wouldn‚Äôt write unit tests for all use cases of GetFlagValue in the ProcessMessage method with the condition that I tested these cases in GetFlagValue unit tests.  In case of detection of uncovered cases, they must be added.  In this case, the main approach remains przhny: <br><br><ul><li>  all cases are covered by unit tests to getFlagValue </li><li>  ProcessMessage unit tests check for proper use of the flag method </li></ul><br>  I believe that in accordance with this, you can write only one unit test for ProcessMessage and several for GetFlagValue. <br><br>  Something like this.  Your opinions? </div><p>Source: <a href="https://habr.com/ru/post/420567/">https://habr.com/ru/post/420567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420555/index.html">Alan Kay: ‚ÄúComputers are instruments whose music is ideas‚Äù</a></li>
<li><a href="../420559/index.html">How IaaS comes to retail and manufacturing: who and why switched to virtual infrastructure</a></li>
<li><a href="../420561/index.html">Image reconstruction: 1 km of optical fiber, artificial neural network and deep learning</a></li>
<li><a href="../420563/index.html">Analysis of the report by Dmitry Stolyarov on monitoring Kubernetes</a></li>
<li><a href="../420565/index.html">Learn OpenGL. Lesson 5.9 - Deferred Rendering</a></li>
<li><a href="../420571/index.html">Smart Headphones - Trends 2018: Environment Filtering, Audio Trainer, Head Gestures, and Direct Connection to Alexa</a></li>
<li><a href="../420573/index.html">Android Academy: now in Moscow</a></li>
<li><a href="../420575/index.html">What to read about the sound in movies, videos and games</a></li>
<li><a href="../420577/index.html">The digest of interesting materials for the mobile developer # 266 (August 13 ‚Äî August 19)</a></li>
<li><a href="../420579/index.html">24-core CPU, and I can not dial an email</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>