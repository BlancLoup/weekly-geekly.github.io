<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Breaking off UAC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I don‚Äôt know how many times the notorious topic of monitoring user actions has been raised (which is known as UAC since Windows Vista): whether it is ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Breaking off UAC</h1><div class="post__text post__text-html js-mediator-article">  I don‚Äôt know how many times the notorious topic of monitoring user actions has been raised (which is known as UAC since Windows Vista): whether it is needed, how effective ... But we will look at this question again, now from a purely applied, hacker point of view.  Consider the pros and cons of the system, as well as the most important thing - how it can (and can you even be) be circumvented. <br><br><img src="https://habrastorage.org/storage1/ac655033/ace27b4c/4976eeda/f4f60931.jpg"><br><a name="habracut"></a><br>  So, what is UAC in terms of security?  The developers of Windows (apparently taking a lot of concern with dull information from bugtracks, which are regularly updated with new and new vulnerabilities in the most common operating system in the world) decided that if all or almost all users sit under administrator rights, then you need to make some software component seek permission from users. <br>  Let's leave aside the holivar on the topic ‚ÄúDoes a simple user need administrator rights?‚Äù, Because this extremely philosophical question is controversial: on the one hand, the rights of the admin to the simple user are not really needed, and on the other, they are necessary for everyday programs. <br>  So, UAC is designed to provide users with the opportunity to work without recourse to administrative rights.  With administrative rights, the user can view and change any part of the operating system, including the code and data of other users and even Windows itself.  Without administrative rights, users cannot accidentally change system settings, malware cannot change system security settings or disable avver, and users cannot compromise the security of other users' important data on public computers.  Working with ordinary user rights in this way helps reduce the number of urgent help desk calls in corporate environments, mitigate damage from malware, contributes to a clearer performance of home computers and protects sensitive data on publicly accessible wheelbarrows. <br>  UAC divides all executable tasks into two groups - those that can be performed by regular users and those that are performed only by administrators.  UAC imperceptibly for the administrator puts the system into the unprivileged user mode, and when administrator rights are required, a system dialog appears through which you can temporarily upgrade your rights. <br>  And after all, it must be admitted that the introduction of UAC is quite bad for beginners and not-so-coders who earn their living with Malvari development, so that on special boards customers now first of all ask about the possibility of code to work in Vista / 7 and bypass UAC.  They paid and still pay quite adequate money for it. <br><br><h3>  Some educational program, or how to legally get admin rights </h3>  There are many ways to determine the need of a system and applications for administrative rights.  One of them is the context menu command and the ‚ÄúRun as administrator‚Äù shortcut in the explorer user interface.  These elements contain a colored shield icon that must be added to all buttons or menu items, the selection of which leads to elevation of rights.  When selecting the ‚ÄúRun as administrator‚Äù item, the explorer calls the ShellExecute API function with the ‚Äúrunas‚Äù command. <br>  The vast majority of installers require administrative rights, so the image loader, which initiates the launch of an executable file, contains installer detection code to detect outdated versions.  Some of the algorithms used by the heuristic loader are fairly simple: it looks for the words ‚Äúsetup‚Äù, ‚Äúinstall‚Äù or ‚Äúupdate‚Äù in the image file name or internal version information.  More complex algorithms include viewing bytes in an executable file, which are usually used by third-party developers in utility programs - installation shells. <br>  To determine whether the target executable needs administrative privileges, the image loader also calls the application compatibility library (appcompat).  The library accesses the application compatibility database to determine whether the RequireAdministrator or RunAsInvoker compatibility flags are associated with the executable file. <br>  The most common way to request administrative rights for an executable file is to add the requestedElevationLevel tag to its application manifest file.  Manifests are XML files that contain additional information about the image.  They were introduced in Windows XP as a way to determine dependencies for parallel DLLs and Microsoft .NET Framework assemblies.  The presence of the trustInfo element in the manifest (it is shown below in the Firewallsettings.exe dump fragment) means that the executable file was written for Windows Vista and contains the requestedElevationLevel element.  The level attribute of this element can have one of three values: asInvoker, highestAvailable, and requireAdministrator. <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">trustInfo</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:schema-microsoft-com:asm.v3"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestedPrivileges</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestedExecutionLevel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Level</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"requireAdministrator"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uiAccess</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestedPrivileges</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">trustInfo</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  Executable files that do not require administrative rights (for example, Notepad.exe) have the attribute value asInvoker.  Some executable files assume that administrators always want maximum permissions.  Therefore, they use the highestAvailable value.  A user who runs an executable file with this value is offered elevations only if he is working in AAM mode or is considered as an administrator according to previously defined rules, and therefore should be elevated to access his administrative privileges. <br>  Examples of applications for which the value is highestAvailable are Regedit.exe, Mmc.exe, and Eventvwr.exe.  Finally, the value of requireAdministrator always initiates a raise request and is used by all executable files that cannot perform their actions without administrative rights. <br>  In applications with special features, the uiAccess attribute is set to "true" to control the input window in processes with elevated rights.  In addition, they must be signed and in one of several secure placements, including% SystemRoot% and% ProgramFiles%, to provide these capabilities. <br>  The values ‚Äã‚Äãspecified by the executable file can be easily determined by viewing its manifest using the Sigcheck utility from Sysinternals.  For example: sigcheck ‚Äìm.  When you run an image that requests administrative rights, the application information service (also known as AIS, is located in% SystemRoot% \ System32 \ Appinfo.dll), running in the Service Host process (% SystemRoot% \ System32 \ Svchost.exe), is instructed run the program Consent.exe (% SystemRoot% \ System32 \ Consent.exe).  Consent creates a screenshot, applies a fade effect to it, switches to a desktop accessible only by the system account, sets a darkened snapshot as a background, and opens an elevation dialog box containing information about the executable file.  Displaying on a separate desktop prevents this dialog box from being modified by any malware running under a user account. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage1/285e5c6d/81ff188c/2bdc3176/99d4c081.jpeg"><br><h6>  Typical reaction of UAC to incomprehensible actions </h6><br><h3>  Buffer overflow </h3>  It would seem, what is the relationship between buffer overflow and UAC?  It turns out that bugs hidden in Windows allow you to bypass UAC restrictions and enhance your rights.  Today I will show you with a concrete example of how using trivial buffer overflow you can bypass UAC and gain administrative rights. <br>  There is such WinAPI - RtlQueryRegistryValues ‚Äã‚Äã(msdn.microsoft.com), it is used to request multiple values ‚Äã‚Äãfrom the registry with one of its own calls, which is done using the special table RTL_QUERY_REGISTRY_TABLE, which is passed as the __in__out parameter. <br>  The most interesting (and shameful for Microsoft developers) in this API is that there is a specific registry key that can be changed using limited user rights: HKCU \ EUDC \ [Language] \ SystemDefaultEUDCFont.  If you change the type of this key to REG_BINARY, then calling RtlQueryRegistryValues ‚Äã‚Äãwill result in a buffer overflow. <br>  When the Win32k.sys! NtGdiEnableEudc kernel API function queries the HKCU \ EUDC \ [Language] \ SystemDefaultEUDCFont registry key, it honestly assumes that the registry key is of type REG_SZ, so the UNICODE_STRING structure is passed to the buffer, with the first field being ULONG type (where is the string length).  But since we can change the type of this parameter to REG_BINARY, this puts a deep deadlock on the system and it incorrectly interprets the length of the transferred buffer, which leads to a stack overflow. <br><br><pre> <code class="cpp hljs">UINT codepage = GetACP(); TCHAR tmpstr[<span class="hljs-number"><span class="hljs-number">256</span></span>]; _stprintf_s(tmpstr, TEXT(<span class="hljs-string"><span class="hljs-string">"EUDC\\%d"</span></span>), codepage); HKEY hKey; RegCreateKeyEx(HKEY_CURRENT_USER, tmpstr, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, REG_OPTION_NON_VOLATILE, KEY_SET_VALUE | DELETE, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, &amp;hKey, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); RegDeleteValue(hKey, TEXT(<span class="hljs-string"><span class="hljs-string">"SystemDefaultEUDCFont"</span></span>)); RegSetValueEx(hKey, TEXT(<span class="hljs-string"><span class="hljs-string">"SystemDefaultEUDCFont"</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>, REG_BINARY, RegBuf, ExpSize); __try { EnableEUDC(TRUE); } __except(<span class="hljs-number"><span class="hljs-number">1</span></span>) { } RegDeleteValue(hKey, TEXT(<span class="hljs-string"><span class="hljs-string">"SystemDefaultEUDCFont"</span></span>)); RegCloseKey(hKey);</code> </pre><h6>  Exploit key point </h6><img src="https://habrastorage.org/storage1/334ad9c3/c6ac2153/a23500e6/58726a2a.jpg"><br><h6>  Disable UAC through a snap </h6><br><h3>  Conclusion </h3>  You can bypass the UAC.  Not to say that it is easy, because the developers of Windows VIsta / W7 did their best, we must give them their due.  But still loopholes remain.  You can find one or two rabbit holes that are able to negate the efforts of the Windows team.  Success in this case comes to those who can work with debuggers and debuggers such as IDA Pro or WinDBG. <br>  Good luck in your endeavors and may the force be with you! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/936/a9b/126/936a9b1267012f5ed85bd6f28a984597.jpg" alt="image"><br>  <i>Hacker Magazine, <a href="http://www.xakep.ru/articles/magazine/default.asp">June (06) 149</a></i> <i><br></i>  <i><a href="">Alexander Eckert</a></i> <br><br>  Subscribe to "Hacker" <br><ul><li>  <a href="http://bit.ly/habr_subscribe_paper">1 999 .</a>  <a href="http://bit.ly/habr_subscribe_paper">for 12 numbers of paper version</a> </li><li>  <a href="http://bit.ly/digital_xakep">1249r.</a>  <a href="http://bit.ly/digital_xakep">for an annual subscription to iOS / iPad (Android'a release soon!)</a> </li><li>  <a href="http://bit.ly/habr_android">"Hacker" on Android</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/122272/">https://habr.com/ru/post/122272/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122265/index.html">Overview of the new Nokia N9 smartphone</a></li>
<li><a href="../122266/index.html">Rumors: the new Mac Pro and Mac Mini are already in August</a></li>
<li><a href="../122267/index.html">Databases with private information in a legal sale</a></li>
<li><a href="../122269/index.html">CSS properties affecting font rendering</a></li>
<li><a href="../122270/index.html">Introduction to prototype.js</a></li>
<li><a href="../122273/index.html">Slightly different ICA (XenDesktop HDX and XenApp HDX)</a></li>
<li><a href="../122275/index.html">5 tricks for writing a game</a></li>
<li><a href="../122277/index.html">Railswizard - rails application creation service</a></li>
<li><a href="../122278/index.html">ICANN Approved New Top Level Domain Implementation (gTLD) Program</a></li>
<li><a href="../122280/index.html">Introducing Chrome Frame, not requiring administrator rights</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>