<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Your cloud hosting in 5 minutes. Part 2: Service Discovery</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! In the previous article, I explained how to build your cloud hosting in 5 minutes using Ansible , Docker and Docker Swarm . In this part, I w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Your cloud hosting in 5 minutes. Part 2: Service Discovery</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/post/262397/"><img src="https://habrastorage.org/files/0ca/30d/ba4/0ca30dba441f433a84d2863ed81f0ad7.jpg" alt="Cloud hosting"></a> <br><br>  Hi Habr!  In the <a href="http://habrahabr.ru/post/261415/">previous article,</a> I explained how to build your cloud hosting in 5 minutes using <i>Ansible</i> , <i>Docker</i> and <i>Docker Swarm</i> .  In this part, I will talk about how services running in the cloud find each other, how the load balancing between them occurs and their fault tolerance is ensured. <br><br>  This is an introductory article, here we will focus on a review of the tools that will solve the problem of ‚Äúservice discovery‚Äù in our cloud.  <a href="http://habrahabr.ru/post/264269/">In the next part</a> we will begin to practice, so I decided to give you time to get acquainted with them. <br><a name="habracut"></a><br><h4>  <font color="#d62631">Content</font> </h4><br><ul><li>  Part 0: <a href="https://habrahabr.ru/post/277657/">Virtualization</a> </li><li>  Part 1: <a href="https://habrahabr.ru/post/261415/">Ansible, Docker, Docker Swarm</a> </li><li>  Part 2: Service Discovery </li><li>  Part 3: <a href="http://habrahabr.ru/post/264269/">Consul, Registrator, Consul-Template</a> </li><li>  ... </li></ul><br><h4>  <font color="#d62631">Problem</font> </h4><br>  Let's analyze the most typical problem and its common solution - we have a web application and we must ensure load balancing and its fault tolerance. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We can run multiple copies of our web application that <a href="http://supervisord.org/">Supervisor</a> will monitor.  <i>Supervisor</i> will restart our web application if any errors occur, and will also add such events to the log.  The problem of load balancing will solve the installation of <a href="http://nginx.org/">Nginx</a> .  <i>Nginx</i> configuration will look something like this: <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> app { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">192.168.1.2:8080</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">5s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">192.168.1.2:8081</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">5s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">192.168.1.2:8082</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">3</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">5s</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://app; health_check; } }</code> </pre> <br>  This configuration will work as follows - if within 5 seconds the number of unsuccessful attempts to access one of the web applications reaches 3, then such an application will be marked as inoperative for 5 seconds ( <i>if it fell with an error, then Supervisor restarts it</i> ).  Thus, the entire load is evenly distributed between the working copies of the applications. <br><br><h4>  <font color="#d62631">disadvantages</font> </h4><br>  In fact, this is a good configuration and if you have a few applications and the load is more or less even, then it is better to use it. <br><br>  But we are building a cloud where this or that application will be launched - we do not know.  Our load may vary for different sites / web applications in different ways, so it would be nice to be able to change the number of running copies of our applications depending on the situation.  In other words - we cannot configure <i>Nginx / Apache / etc</i> in advance for such a configuration. <br><br>  It would be cool if <i>Nginx</i> and our other services adapted to the dynamic nature of our cloud.  We will deal with the solution of this particular problem in this article. <br><br><h4>  <font color="#d62631">Requirements</font> </h4><br>  We need a place where our services will be able to register themselves and receive information about each other.  <a href="http://docs.docker.com/swarm/">Docker Swarm</a> , which we started using in the <a href="http://habrahabr.ru/post/261415/">previous article</a> , out of the box <a href="http://docs.docker.com/swarm/discovery/">knows how to work</a> with <a href="https://coreos.com/etcd/">etcd</a> , <a href="https://consul.io/">Consul</a> and <a href="http://zookeeper.apache.org/">Zookeeper</a> . <br><br>  We need our services to be automatically registered and removed from the above systems ( <i>we will not teach this for each application</i> ).  For these purposes, we use <a href="https://github.com/gliderlabs/registrator">Registrator</a> ( <i>we will consider it in more detail below</i> ), which works out of the box with <i>Consul</i> , <i>etcd</i> and <a href="https://github.com/skynetservices/skydns/">SkyDNS 2</a> ( <i>Zookeeper support in the plans</i> ). <br><br>  Our services should be able to find each other using DNS queries.  <i>Consul</i> and <a href="https://github.com/skynetservices/skydns/">SkyDNS 2</a> ( <i>which works together with etcd</i> ) can solve this problem. <br><br>  Monitoring the health of the services we also need.  It is available to us at <i>Consul</i> ( <i>which we will use</i> ) out of the box and is <a href="https://github.com/gliderlabs/registrator">supported by the</a> Registrator ( <i>it must transmit information about how this or that service should be monitored</i> ). <br><br>  Last but not least, you need a service to automatically configure our components.  If we run 10 copies of one web application and 20 copies of another, it must understand and immediately react to it ( <i>changing the configuration of Nginx, for example</i> ).  This role will be played by the <a href="https://github.com/hashicorp/consul-template">Consul Template</a> ( <i>we will consider it in more detail below</i> ). <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  As you can see, there are different solutions to our problem.  Before writing this article, I worked on my configuration for a little over a month and did not encounter any problems. <br></div></div><br><h4>  <font color="#d62631">Consul</font> </h4><br> <a href="https://consul.io/"><img src="https://habrastorage.org/files/a74/936/af1/a74936af174542eb9cb82f5d34e670e6.png" alt="Consul"></a> <br><br>  Of the above options ( <i><a href="https://consul.io/">Consul</a> , <a href="http://zookeeper.apache.org/">Zookeeper</a> , <a href="https://coreos.com/etcd/">etcd</a></i> ), <i>Consul</i> is the most independent project able to solve our problem of finding services out of the box. <br><br>  Despite the fact that <i>Consul</i> , <i>Zookeeper</i> and <i>etcd</i> are located here in the same row, I would not compare them with each other.  All 3 projects implement distributed key / value storage, and this is where their common features end. <br><br>  <i>Consul</i> will provide us with a DNS server, which is not in <i>Zookeeper</i> and <i>etcd</i> ( <i>can be added using <a href="https://github.com/skynetservices/skydns/">SkyDNS 2</a></i> ).  Moreover, <i>Consul</i> will give us health monitoring ( <i>which neither etcd nor Zookeeper can boast of</i> ), which is also necessary for a full-fledged Service Discovery. <br><br>  With <i>Consul</i> we get the <i>Web UI</i> (the <i>demo of which can be seen <a href="http://demo.consul.io/">right now</a></i> ) and high-quality <a href="https://consul.io/docs/index.html">official documentation</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  Even if you plan to use the same configuration that I describe and the use of <a href="http://zookeeper.apache.org/">Zookeeper</a> and <a href="https://github.com/skynetservices/skydns/">SkyDNS 2</a> is not in your plans, I would still be familiar with these projects. <br></div></div><br><h4>  <font color="#d62631">Registrator</font> </h4><br> <a href="https://github.com/gliderlabs/registrator"><img src="https://habrastorage.org/files/fec/364/920/fec364920669458fb2c5e56db5463859.jpg" alt="Registrator"></a> <br><br>  <a href="https://github.com/gliderlabs/registrator">Registrator</a> receives information from <i>Docker</i> 's about starting / stopping containers ( <i>through a socket connection using the Docker API</i> ) and adds / deletes them to / from <i>Consul</i> 'a. <br><br>  <i>Registrator</i> automatically obtains information about a particular service based on published ports and from the <i>Docker</i> container environment variables.  In other words - it works with any containers that you have and requires additional configuration only if you need to redefine the parameters obtained automatically. <br><br>  And since all of our services work exclusively in <i>Docker</i> containers ( <i>including the Registrator itself</i> ), then <i>Consul</i> will always have information about all the running services of our cloud. <br><br>  This is all cool, of course, but even better is what <i>Registrator</i> can tell <i>Consul</i> 'how to check the health of our services.  This is done using the same environment variables. <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  Consul can check the health of services if the <i>Consul Service Catalog</i> ( <i>which we use</i> ) is <i>used</i> to save information about them. <br><br>  If <i>Consul Key-value Store is used</i> ( <i>which is also supported by the Registrator and uses, for example, <i>Docker Swarm</i> to save information about <i>Docker</i> nodes</i> ), there is no such function. <br></div></div><br>  Let's look at an example: <br><br><pre> <code class="bash hljs">$ docker run -d --name nginx.0 -p 4443:443 -p 8000:80 \ -e <span class="hljs-string"><span class="hljs-string">"SERVICE_443_NAME=https"</span></span> \ -e <span class="hljs-string"><span class="hljs-string">"SERVICE_443_CHECK_SCRIPT=curl --silent --fail https://our-https-site.com"</span></span> \ -e <span class="hljs-string"><span class="hljs-string">"SERVICE_443_CHECK_INTERVAL=5s"</span></span> \ -e <span class="hljs-string"><span class="hljs-string">"SERVICE_80_NAME=http"</span></span> \ -e <span class="hljs-string"><span class="hljs-string">"SERVICE_80_CHECK_HTTP=/health/endpoint/path"</span></span> \ -e <span class="hljs-string"><span class="hljs-string">"SERVICE_80_CHECK_INTERVAL=15s"</span></span> \ -e <span class="hljs-string"><span class="hljs-string">"SERVICE_80_CHECK_TIMEOUT=3s"</span></span> \ -e <span class="hljs-string"><span class="hljs-string">"SERVICE_TAGS=www"</span></span> nginx</code> </pre><br>  After a similar launch, <i>Consul</i> 's list of our services will look like this: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"services"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"hostname:nginx.0:443"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"https"</span></span>, <span class="hljs-string"><span class="hljs-string">"tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"www"</span></span> ], <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"192.168.1.102"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">4443</span></span>, <span class="hljs-string"><span class="hljs-string">"checks"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"script"</span></span> : <span class="hljs-string"><span class="hljs-string">"curl --silent --fail https://our-https-site.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"interval"</span></span>: <span class="hljs-string"><span class="hljs-string">"5s"</span></span> } ] }, { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"hostname:nginx.0:80"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"http"</span></span>, <span class="hljs-string"><span class="hljs-string">"tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"www"</span></span> ], <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"192.168.1.102"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">8000</span></span>, <span class="hljs-string"><span class="hljs-string">"checks"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"http"</span></span>: <span class="hljs-string"><span class="hljs-string">"/health/endpoint/path"</span></span>, <span class="hljs-string"><span class="hljs-string">"interval"</span></span>: <span class="hljs-string"><span class="hljs-string">"15s"</span></span>, <span class="hljs-string"><span class="hljs-string">"timeout"</span></span>: <span class="hljs-string"><span class="hljs-string">"3s"</span></span> } ] }, ... ] }</code> </pre><br>  As you can see, based on the published ports, <i>Registrator</i> concluded that it is necessary to register 2 services ( <i>http and https</i> ).  Moreover, <i>Consul</i> 'a now has all the necessary information on how to check the health of these services. <br><br>  In the first case, the command " <i>curl --silent --fail <a href="https-site.com/">our-https-site.com</a></i> " will be executed every 5 seconds and the result of the check will depend on the exit code of this command. <br><br>  In the second case - every 15 seconds, Consul will jerk the URL transmitted by us.  If the server's response code is <i>2xx</i> , then our service is ‚Äúhealthy‚Äù, if <i>429 Too Many Requests</i> , then in ‚Äúemergency condition‚Äù, if everything else, then ‚Äúground him in peace‚Äù. <br><br>  More examples and more detailed information can be found in the <a href="https://github.com/gliderlabs/registrator">official documentation</a> . <br><br><h4>  <font color="#d62631">Consul Template</font> </h4><br> <a href="https://github.com/hashicorp/consul-template"><img src="https://habrastorage.org/files/465/c9a/f5a/465c9af5ad7c46d5a815e8d203179bf2.png" alt="Consul Template"></a> <br>  We decided where to store information about all services of our cloud, as well as how it will get there and automatically updated there.  But we have not yet figured out how we will receive information from there and how, in consequence, we will transmit it to our services.  This is what <a href="https://github.com/hashicorp/consul-template">Consul Template</a> will do. <br><br>  To do this, you need to take the configuration file of our application ( <i>which we want to configure</i> ) and make a template out of it, according to the rules of the <a href="https://github.com/hashicorp/hcl">HashiCorp Configuration Language</a> . <br><br>  Let's look at a simple example with the <i>Nginx</i> configuration file: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> app { least_conn; <span class="hljs-comment"><span class="hljs-comment"># list of all healthy services {{range service "tag1.cool-app" "passing"}}server {{.Address}}:{{.Port}} max_fails=3 fail_timeout=60s weight=1; {{else}}server 127.0.0.1:65535; # force a 502{{end}} } ...</span></span></code> </pre><br>  After we explain to the <i>Consul Template</i> where this template is located, where to put the result and what command to execute ( <i>it also knows how</i> ) when it is changed ( <i>in this case, reboot Nginx</i> ), the magic will begin.  In this case, <i>Consul Template</i> will receive the addresses and port numbers of all copies of the " <i>cool-app</i> " application, which are tagged with " <i>tag1</i> " and are in a "healthy" state and add them to the configuration file.  If there are no such applications, then, as you already guessed, everything that is after <i>{{else}}</i> will remain. <br><br>  Each time the <i>cool-app</i> service is added and removed with the <i>tag1</i> tag, the configuration file will be overwritten, and then <i>Nginx</i> will be rebooted.  All this happens automatically and does not require intervention, we just run the required number of copies of our application and do not worry about anything. <br><br>  More examples can be found in the <a href="https://github.com/hashicorp/consul-template">official documentation</a> . <br><br><h4>  <font color="#d62631">Conclusion</font> </h4><br>  To date, there are enough tools to solve the problem of finding services, but not so many tools that could solve this problem out of the box and immediately provide us with everything we need. <br><br>  <a href="http://habrahabr.ru/post/264269/">In the next part,</a> I published a set of scripts for <i>Ansible</i> , which will configure all the above tools for us and we can begin in practice. <br><br>  That's all.  Thank you all for your attention.  Stable clouds and good luck to you! <br><br>  <a href="https://twitter.com/vkozlovski">Follow me on Twitter</a> , I talk about working in a startup, my mistakes and the right decisions, about python and everything related to web development. <br><br>  PS <i>I'm looking for developers to the company, the details in my <a href="http://habrahabr.ru/users/vladkozlovski/">profile</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/262397/">https://habr.com/ru/post/262397/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262383/index.html">Manage ReSharper settings in the team</a></li>
<li><a href="../262387/index.html">Databene Benerator - Benefit from it.</a></li>
<li><a href="../262389/index.html">Accelerate angular.js or how not to shoot yourself in the foot</a></li>
<li><a href="../262393/index.html">Video Switch for TV</a></li>
<li><a href="../262395/index.html">Working environment for "lazy" web developers (Vagrant + Scotchbox)</a></li>
<li><a href="../262401/index.html">PHP Digest number 66 - interesting news, materials and tools (June 28 - July 12, 2015)</a></li>
<li><a href="../262403/index.html">40+ useful tools for the developer of applications for Android</a></li>
<li><a href="../262407/index.html">Entity Framework 6 (7) vs NHibernate 4: a DDD perspective</a></li>
<li><a href="../262409/index.html">Introduction to Octopus Deploy</a></li>
<li><a href="../262411/index.html">Fundamentals of successful implementation of push notifications for mobile applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>