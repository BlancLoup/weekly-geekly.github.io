<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MiTM Mobile Contest: How Mobile Phone Broke on PHDays V</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Although we have repeatedly published studies on the possibilities of interception of mobile communication , interception of SMS, substitution of subs...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MiTM Mobile Contest: How Mobile Phone Broke on PHDays V</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/pt/blog/261035/"><img src="https://habrastorage.org/files/cbd/d8b/72c/cbdd8b72ccee45378589429363cb03b6.png"></a> <br><br>  Although we have repeatedly published studies on the possibilities of <a href="http://habrahabr.ru/company/pt/blog/226977/">interception of</a> <a href="http://habrahabr.ru/company/pt/blog/245113/">mobile communication</a> , <a href="http://habrahabr.ru/company/pt/blog/226977/">interception of SMS, substitution of subscribers</a> and <a href="http://habrahabr.ru/company/pt/blog/243697/">hacking of SIM-cards</a> , for many readers these stories still belong to the field of a certain complex magic, which is owned only by special services.  The <a href="http://www.phdays.ru/program/contests/">MiTM Mobile</a> contest, held for the first time this year at PHDays, allowed any conference participant to see how easy it was to do all the attacks described above, having only a 300-ruble phone in hand with a set of free hacker programs. <a name="habracut"></a><br><br><h4>  Competition conditions and technologies </h4><br><blockquote>  ‚ÄúYou got the corporate phone of the user of the MiTM Mobile network. <br>  Through DarkNet, you received information that may be useful: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Codes for receiving publications are periodically sent to the number of the chief accountant of the corporation - 10,000. </li><li>  The financial director has disappeared somewhere, for several days nobody has been able to reach him, the phone is turned off, but he still has passwords. </li><li>  Important information can be obtained by calling to number 2000, but authorization is set there by the number of the caller.  It was also possible to find out that the telephone number of the director‚Äôs private secretary is 77777, he certainly has access.  The network has other numbers through which employees receive important information, but, unfortunately, they could not be found.  And do not forget, in the corporate network you can always stumble upon private information. " </li></ol></blockquote><br>  Approximately this introductory was presented to the participants of CTF in the framework of the MiTM Mobile competition, held on PHDays V. <br><br>  For the competition, we deployed the real infrastructure of the mobile operator.  It included a base station, mobile phones, landlines, and SIM cards.  The name MiTM Mobile, as you might guess, was not chosen by chance: I wanted to highlight the vulnerability of our network.  Kraken acted as a network logo (or almost all of it) breaking the cellular tower. <br><br>  So, with the external attributes of the cellular operator everything is clear, now consider the implementation of the network.  The device with the simple name UmTRX (manufacturer's website: umtrx.org/hardware) acted as an ‚Äúiron‚Äù solution, on its basis the wireless part of the network was built.  Directly GSM-functionality and functionality of the base station, namely the software part, was implemented by the Osmocom / OpenBTS program stack. <br><br><img src="https://habrastorage.org/files/327/7c1/183/3277c11831c747268c0a1543a64562c3.png"><br><br>  <i>"Heart" MiTM Mobile - UmTRX</i> <br><br>  SIM cards were ordered for quick and easy online registration.  The details of the MiTM Mobile network were written in them, and the data of the ‚Äúsims‚Äù were, respectively, registered in the network.  To simplify listening to the air and to make life easier for players in our cellular network, encryption was turned off (A5 / 0).  Along with SIM cards, Motorola C118 phones and a USB-UART cable (CP2102) were distributed to participants.  All this, together with the osmocombb program stack, allowed CTF participants to listen to the air, intercept SMS destined to other users, and make calls on the network, substituting another user. <br><br>  Each team got a SIM card, cable, phone and virtual machine image with an osmocombb stack collected for experiments. <br><br><img src="https://habrastorage.org/files/840/637/9c0/8406379c072c40f599f821751c7de52b.png"><br><br><h4>  Analysis of tasks </h4><br>  First of all - a bit of theory: <br><br><ul><li>  <a href="https://ru.wikipedia.org/wiki/IMSI">IMSI</a> - International Mobile Subscriber Identity stored in SIM-card. </li><li>  <a href="https://ru.wikipedia.org/wiki/MSISDN">MSISDN</a> - Mobile subscriber ISDN number phone number assigned to IMSI in operator's infrastructure </li><li>  <a href="http://en.wikipedia.org/wiki/Mobility_management">TMSI</a> - Temporary Mobile Subscriber Identity assigned randomly. </li></ul><br><img src="https://habrastorage.org/files/a8a/9ef/85f/a8a9ef85f2a34f949145ec9500d22811.png"><br><br>  IMSI - this particular magic number is registered on the SIM-card.  For example, it looks like 250-01- 250 is the country code (Russia), 01 is the operator code (),  is the unique ID.  The IMSI identifies and authorizes the subscriber in the operator‚Äôs network. <br><br>  In our case, with a sysmocom 901 SIM card, the country code, 70 ‚Äî operator code, 0000005625 ‚Äî subscriber ID within the operator‚Äôs network (see figure). <br><br>  The second thing to remember: MSISDN, your mobile number (for example, +79171234567) is NOT stored on the SIM card.  It is stored in the database of the operator.  During a call, the base station substitutes this number according to the IMSI &lt;-&gt; MSISDN lookup table (in a real network, this is an MSC / VLR function).  Or do not substitute (anonymous call). <br><br>  TMSI is a temporary 4 byte identifier.  It is allocated to the subscriber after authorization. <br><br>  Armed with knowledge, we continue. <br><br>  We start the osmocombb program stack.  It's simple.  Pre-connect our cable to the computer and forward it inside the virtual machine.  The device / dev / ttyUSB0 should appear in the virtual machine.  Next, connect the OFF phone to the cable through the audio jack. <br><br>  Open two consoles.  In the first run the command: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#~/osmocom-bb-master/src/host/osmocon/osmocon -p /dev/ttyUSB0 -m c123xor -c ~/osmocom-bb-master/src/target/firmware/board/compal_e88/layer1.highram.bin</span></span></code> </pre> <br>  And press the red button on the phone.  With this command, we start downloading the firmware to the phone, as well as opening a socket, through which our programs will communicate with the phone.  This is the so-called layer 1 of the OSI model.  Implements physical interaction with the network. <br><br><img src="https://habrastorage.org/files/b34/1d9/ac4/b341d9ac4f6445e49420019321f6ff42.png"><br><br>  This is what roughly produces in the console layer1 after downloading to the phone (however, we are not interested). <br><br>  In the second console, run the command: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#~/osmocom-bb-sylvain/src/host/layer23/src/misc/ccch_scan -a 774 -i 127.0.0.1</span></span></code> </pre><br>  This command implements layer 2-3 of the OSI model.  Namely, listening to the air in search of the Common Control Channel (CCCH) common control packages. <br><br>  -a 774 - denotes the ARFCN on which we broadcast.  Yes, yes, no one needs to look for the channel on which our operator works.  All for you, dear participants :) <br><br>  -i 127.0.0.1 - the interface to which we send our packages. <br><br><img src="https://habrastorage.org/files/0a0/602/84f/0a060284ffde4626aed1e2ae46140e30.png"><br><br>  And run Wireshark.  He will do everything for us, namely, collect the necessary packages in SMS, parse TPDU / PDU-format and show us everything in a readable form. <br><br>  We remember that for the first task we need to intercept the SMS.  For ease of viewing in Wireshark, we put a filter on the gsm_sms-packages so as not to clutter up the screen. <br><br><img src="https://habrastorage.org/files/32e/eb2/b6f/32eeb2b6fef84bba9b0a89e03fae7658.png"><br><br>  We see SMS, which are in the meantime on the air.  Congratulations, you have completed the first task!  And if you were on PHDays V now, you could see an SMS with a code for receiving posts on the air.  The code was broadcast for two days constantly, every 5 minutes, even at night. <br><br>  For the <b>second task, you</b> also need to start layer1 (or you can not turn it off after the last time). <br><br>  In the second console, as layer2-3, we run <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#~/osmocom-bb-master/src/host/layer23/src/mobile/mobile -i 127.0.0.1</span></span></code> </pre><br>  And then everything is simple.  The mobile application implements the functions of a virtual phone.  To access these functions, open the third console and run: <br><br><pre> <code class="bash hljs">$ telnet 127.0.0.1 4247</code> </pre><br>  A Cisco-like interface will open in the console.  Turn on advanced mode: <br><br><pre> <code class="bash hljs">OsmocomBB&gt; <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span></code> </pre><br>  Next, display a list of available commands: <br><br><pre> <code class="bash hljs">OsmocomBB<span class="hljs-comment"><span class="hljs-comment"># list</span></span></code> </pre><br>  I wonder what the clone team does?  Who would have thought, it fully justifies its name!  With this command you can clone the network subscriber.  From the reference to the command, we see that it takes the TMSI as an argument.  If we manage to recognize the victim's TMSI and plug it into our phone, then we can connect to the network instead of the original subscriber. <br><br>  Throughout the conference, we tried to send an SMS to a number that was not online.  And if the participant had guessed to substitute the TMSI requested by the base station as a parameter of the clone command, he would get the following flag with the code for the currency! <br><br><pre> <code class="bash hljs">OsmocomBB<span class="hljs-comment"><span class="hljs-comment"># clone 1 5cce0f7f</span></span></code> </pre><br>  And to see the request of the base station to the subscriber was very simple.  It was possible to look at the Wireshark gsmtap packages with the Paging Requests Type 1 request (the base station request when making a call). <br><br><img src="https://habrastorage.org/files/343/fca/b86/343fcab8681c4a5fbf4aa67c08a29f04.png"><br><br>  Or in the second console, where mobile is running: <br><br><img src="https://habrastorage.org/files/bf7/b8a/ac5/bf7b8aac50544ec58158e57648921c4c.png"><br><br>  We register TMSI and we receive an SMS intended for the source subscriber. <br><br>  For the <b>third assignment</b> , the knowledge already gained is enough.  As in the previous assignment, you must impersonate another subscriber.  We know his number, but do not know his TMSI.  What to do?  It's simple: you just need to send an SMS or initiate a call to this subscriber, namely to the number 77777. And, as in the previous example, we will see requests from the base station to the subscriber 77777. An important point: you need to call and SMS from another phone, otherwise our Motorola will not be able to see base station broadcast requests destined for the target subscriber. <br><br>  Next, we register TMSI into our phone with the help of the clone command - and make a call to the coveted number! <br><br><pre> <code class="bash hljs">OsmocomBB<span class="hljs-comment"><span class="hljs-comment"># call 1 2000</span></span></code> </pre><br>  Now we take into the hands of Motorola and listen to the code.  If the participants did everything correctly, they will hear the code.  Otherwise - hear a joke :) <br><br>  In addition, the network held SMS, which stated that a new voice message had been received.  If the participants were not too lazy and entered the phone book of the device, they would have seen the voice mail number.  By calling this number, one could hear insider information - data on the growth and fall of the MiTM Mobile stock price. <br><br>  The fourth task was not connected directly with GSM-communication, but with vulnerable SIM-cards, which are used to access the network.  In addition to the phone, each team was given a SIM-card with an application installed on it, displaying the invitation ‚ÄúWelcome to PHDays V‚Äù.  To search for vulnerable applets, Lukas Kuzmiak and Karsten Nohl created the SIMTester utility.  A distinctive feature of this utility is the ability to work through osmocom phones.  We insert the SIM card into the phone, connect it to the computer and start the search.  After a couple of minutes, let's analyze the data obtained: <br><br><img src="https://habrastorage.org/files/ce9/42d/23c/ce942d23cab5467db878a4ed263eac7d.png"><br><br>  In addition to many applications that disclose information that is sufficient for <a href="http://habrahabr.ru/company/pt/blog/243697/">brute-force keys</a> , we are carefully highlighted in red by an application that does not require any secret keys to access.  Let's analyze it separately: <br><br><img src="https://habrastorage.org/files/a81/2c9/384/a812c9384a124fc09f2f6c623d64e8bd.png"><br><br>  The last two bytes of a SIM response are status bytes, where, for example, 0x9000 means that the command completed successfully.  In this case, we get 0x9124, which means there are 36 bytes that the map wants us to return.  Let's change the program code a bit and see what the data is: <br><br><img src="https://habrastorage.org/files/a5f/0ff/49c/a5f0ff49cf264dd9a8eeccd75dda03fd.png"><br><br>  We decode and get: <br><br><pre> <code class="bash hljs">&gt;&gt;&gt; <span class="hljs-string"><span class="hljs-string">'D0228103012100820281028D1704596F752061726520636C6F73652C2062616420434C419000'</span></span>.decode(<span class="hljs-string"><span class="hljs-string">'hex'</span></span>) <span class="hljs-string"><span class="hljs-string">'\xd0"\x81\x03\x01!\x00\x82\x02\x81\x02\x8d\x17\x04You are close, bad CLA\x90\x00'</span></span></code> </pre><br>  We iterate over all possible CLA and INS for instructions sent in binary SMS, and we get our flag: <br><br><img src="https://habrastorage.org/files/8dd/313/7d8/8dd3137d8e544c9aabf4d461a4930dc4.png"><br><br><pre> <code class="bash hljs">&gt;&gt;&gt; <span class="hljs-string"><span class="hljs-string">'D0378103012100820281028D2C04596F757220666C61673A2035306634323865623762623163313234323231383333366435306133376239659000'</span></span>.decode(<span class="hljs-string"><span class="hljs-string">'hex'</span></span>) <span class="hljs-string"><span class="hljs-string">'\xd07\x81\x03\x01!\x00\x82\x02\x81\x02\x8d,\x04Your flag: 50f428eb7bb1c1242218336d50a37b9e\x90\x00'</span></span></code> </pre><br>  That's all for assignments. <br><br><h4>  Winners and Surprises </h4><br>  Not only CTF teams, but also all PHDays visitors could try their hand at the MiTM Mobile contest: those who wanted were given all the necessary equipment and a virtual machine.  As a result, more than ten people participated in the competition, not counting the CTF teams. <br><br>  However, the only one who managed to intercept the SMS by the middle of the first day was <b>Gleb Cherbov</b> , who became the winner of the competition. <br><br>  Three tasks completed only the team <b>More Smoked Leet Chicken</b> to the beginning of the second day.  The fourth task was available only to CTF participants, but no one was able to complete it. <br><br>  Visitors to the forum could notice the periodic disappearance of LTE, 3G, and sometimes the network was generally lost when approaching the work zone of GSM jammers, which looked like this: <br><br><img src="https://habrastorage.org/files/7b4/094/864/7b40948643af48a5aae0ec8a2347cbc8.png"><br><br>  Some received messages from the number 74957440144 or from ‚ÄúAnonymous‚Äù with the text ‚ÄúSMS_from_bank‚Äù or another ‚Äúharmless spam‚Äù.  This was due to the work of the MiTM Mobile cellular network. <br><br>  And by the end of the second day, some ‚Äúlucky ones‚Äù received the following message: <br><br><img src="https://habrastorage.org/files/6b3/8a7/26f/6b38a726f4d745b2b15a781b701ba555.png"><br><br>  This joke is not related to the work of MiTM Mobile, but once again reminds everyone of the observance of elementary safety rules.  Watch your <s>pet with a</s> phone that unexpectedly finds the MosMetro_Free network where it cannot be, connects to it, and the crowd of programs fall into the trap.  Some of them use the mobile phone number as an identifier, which the attacker receives, and then via the SMS gateway arranges the distribution to all the ‚Äúlucky ones‚Äù. <br><br><img src="https://habrastorage.org/files/706/b08/2b2/706b082b26d94077a67941fad4e80390.png"><br><br>  PS For those who want to arrange a contest similar to our MiTM Mobile - a little more about the components of the network. <br><br>  UmTRX itself is SDR (Software Defined Radio), that is, ‚Äújust radio‚Äù.  All setup instructions can be found at umtrx.org or osmocom.org.  We can also mention the finished ‚Äúboxed‚Äù solution from UmTRX - UmDESK, everything is already installed in it.  It is enough to fill out configs according to the manual - and start broadcasting <br><br>  The finished image with the collected osmocombb stack can be found here: <a href="">phdays.ru/ctf_mobile.7z</a> (it is very desirable to have VMWare 11).  For experiments, this assembly is enough.  Sims are optional, but you need a phone and any USB-UART cable. <br><br>  Phone can take any of the list: <a href="http://bb.osmocom.org/trac/wiki/Hardware/Phones">bb.osmocom.org/trac/wiki/Hardware/Phones</a> <br>  Cables: <a href="http://bb.osmocom.org/trac/wiki/Hardware/SerialCable">bb.osmocom.org/trac/wiki/Hardware/SerialCable</a> <br><br>  And yes, PL2303, FT232 can be found almost everywhere.  To unsolder the mini-jack 2.5 mm is lighter. <br><br><img src="https://habrastorage.org/files/ed5/ab0/968/ed5ab0968bf04d06b0b8eeae5caeb122.png"><br><br>  Sims and cable can be ordered here: <a href="http://shop.sysmocom.de/">shop.sysmocom.de</a> <br><br>  Namely: <br>  USB-UART (CP2102): <a href="http://shop.sysmocom.de/products/cp2102-25">shop.sysmocom.de/products/cp2102-25</a> <br>  SIM cards: <a href="http://shop.sysmocom.de/t/sim-card-related/sim-cards">shop.sysmocom.de/t/sim-card-related/sim-cards</a> <br><br>  Phones can be found on Avito, in the underpass or ordered in China: the issue price is about 300 rubles per item. <br><br><img src="https://habrastorage.org/files/5d8/fb2/30a/5d8fb230a6c7408096205e59940f72fa.png"><br><br>  The Fairwaves guys (they are the ones who make UmTRX, UmDESK, UmROCKET, etc.) are especially grateful for the advice and for the equipment provided for testing;  they are doing a GREAT thing!  Special thanks to Ivan. </div><p>Source: <a href="https://habr.com/ru/post/261035/">https://habr.com/ru/post/261035/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261023/index.html">Create a simple UI5 ‚Äã‚Äãapplication in a web development environment</a></li>
<li><a href="../261027/index.html">Tail recursion in C ++ using 64-bit variables - Part 1</a></li>
<li><a href="../261029/index.html">Tail recursion in C ++ using 64-bit variables - Part 2</a></li>
<li><a href="../261031/index.html">Reactive extensions</a></li>
<li><a href="../261033/index.html">Turing's Cathedral: the origin of the digital universe</a></li>
<li><a href="../261039/index.html">Inside the antivirus for Virusday sites - Part 1</a></li>
<li><a href="../261041/index.html">Children's camp: Bisectral-Pythagorean triangles, brain reprogramming, radar detector and breaking handcuffs</a></li>
<li><a href="../261043/index.html">D for beginners, part 1</a></li>
<li><a href="../261045/index.html">Is the Internet of Things a Myth or a Reality?</a></li>
<li><a href="../261047/index.html">Updated functionality on VDS.menu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>