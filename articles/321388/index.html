<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Questions about relational subd which are never enough time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 By the will of fate, I have been working in an enterprise for about 5 years, during which time a pool of questions about relational dat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Questions about relational subd which are never enough time</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  By the will of fate, I have been working in an enterprise for about 5 years, during which time a pool of questions about relational databases has accumulated, and these regularly pop up in my head before going to bed. <br><br>  But to find out detailed answers to them is time-consuming, for they send multi-volume manuals, linguistics &amp; statistics and thick books to a wonderful country. <br><br>  I ask for help from the community in eradicating their own and others' ignorance. <br>  <i>Note: Answers to some of the questions were covered in <a href="https://habrahabr.ru/company/mailru/blog/266811/">this article</a> , but not fully disclosed.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will hide my empirical assumptions under cat. <br><a name="habracut"></a><br><h3>  Questions </h3><br><ol><li>  <b>What happens in the subd at the size of the table + cache + indexes &lt;&lt; RAM?</b> <br><br><div class="spoiler">  <b class="spoiler_title">Assumptions and new questions</b> <div class="spoiler_text">  Logic and some experience suggest that if the base in the settings contains a size smaller than the RAM, and the system has enough memory to place it, the base must fit the entire RAM, but since  ACID requires consistency and durability ‚Äî it should be committed to disk, at least through the log subsystem.  Is it really?  If not so, is it possible to configure the subd so that reading is always carried out from RAM? <br></div></div><br></li><li>  <b>If the size of the table &gt;&gt; RAM, but there is no index on it (or we don‚Äôt get into it), how does the memory manager determine how much space can be occupied by the selection from the table?</b> <br><br><div class="spoiler">  <b class="spoiler_title">Assumptions</b> <div class="spoiler_text">  You can try to find the amount of space required statistically, by the distribution of values ‚Äã‚Äãwithin the columns (there is usually such data in the subdist statistics subsystem.). <br>  The amount of available memory - you can count on average load lately, and find the expected amount of free space. <br></div></div><br></li><li>  <b>How and where is the sequential selection of table entries (and from where, memory / disk) for filtering?</b>  <b>What kind of locks will occur (for DB with and with versioning of records)?</b> <br><br><div class="spoiler">  <b class="spoiler_title">Assumptions</b> <div class="spoiler_text"><ul><li>  Most likely, there is a facade of a single memory manager, which is able to pull the value from the cache / index, and if it is not there, take it from the disk. </li><li>  Surely, it has a queue of processing requests for receiving rows.  Surely, the order of the architecture: query optimizer, which determines where to select the value - table / index, manager, which determines where the index / table is in memory or on disk, cache - are there index / table rows with a given identifier, pull up the index memory / tables, running the desired part of the index / table through the RAM with a sample of the desired values. <br></li><li>  Where - most likely, in a separate memory pool of the process, if there is no space - wasps or we map it to disk ourselves </li></ul><br></div></div><br></li><li>  <b>What happens if the size of a suitable sample &gt;&gt; RAM?</b>  <b>Which databases are able to give data in the input sample stream, and which - only on the full readiness of the sample?</b>  <b>Can this behavior be customized?</b> <br><br><div class="spoiler">  <b class="spoiler_title">Assumptions and new questions</b> <div class="spoiler_text"><ul><li>  The locks will, of course, depend on the settings of the required consistency of the database (wiki, Isolation level_transactions). <br></li><li>  The question to which I still have no easy answer - can the lines change when reading a large volume, despite the flow of reading?  Will this fall under the ‚Äúdirty reading‚Äù situation?  What happens if another transaction tries to change the string we are reading now?  Is reading a transaction that can block other transactions?  When versioning lines, everything is easier - we read lines with version = last committed at the time of the start of reading </li><li>  Theoretically, it should be put on the disk by means of bd / os </li></ul><br></div></div><br></li><li>  <b>How does the query optimizer formally prove the equivalence of conditions in the <i>ON</i> clause for the JOIN query and the <i>WHERE clause of</i> this query?</b>  <b>An example under a cat.</b> <br><br><div class="spoiler">  <b class="spoiler_title">Example and Assumptions</b> <div class="spoiler_text"><ul><li>  In pg, I have repeatedly noticed that there is no difference in performance and query plan <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> b <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> a.id = b.id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> an &gt; N <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> bn &lt;N</code> </pre>  and <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> an &gt; N) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> b <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> bn &lt;N ) ab <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> a.id = b.id</code> </pre> <br></li><li>  Even for more complex queries, where the conditions were somewhat ‚Äúhigher‚Äù in the query construction tree, pg somehow proved equivalence and chose not all data for join, but only a suitable one for the sample. </li><li>  Those.  There is a certain mechanism of propagation of the conditions of the sample on the query tree.  MS-SQl 2008 behaved worse and showed a significant difference in the time of request.  Why? <br>  What methods of logic / programming can prove the equivalence of on and where? <br>  When and where does it work? <br></li></ul><br></div></div><br></li><li>  <b>How does the index work for more than one field?</b>  <b>How does the work with the b-tree index occur, if it does not fit entirely into RAM?</b>  <b>Through the virtual memory os?</b>  <b>Or is there a way to partially load the index?</b> <br><br><div class="spoiler">  <b class="spoiler_title">What is the question</b> <div class="spoiler_text">  I can not understand how b-tree is organized when there are&gt; 1 columns in the index and they are of different types.  The logical assumption is that the key of the tree is a certain hash function of the columns, but then it is obviously necessary to observe the condition that <br>  H (a, b)&gt; H (a) &amp; H (a, b)&gt; H (b) &amp; H (a, b) &lt;H (a +1, b) &amp; H (a, b + 1) &lt;H (a + 1) <br>  I guess that a perceptual hash with some ‚Äúbits‚Äù can help with this, where the discharge corresponds to the column, but the length of the hash confuses me. <br>  Another option seems to me not to make a hash, but to explicitly compare the values ‚Äã‚Äãof the index fields when loading / unloading from it.  But then it's not clear how it will work. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> A <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> Ab &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> Ac &lt; <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre>  if the index is declared as <br>  &lt;Aa, Ab, Ac&gt; <br>  How are we going to bypass the tree without having restrictions on the first level? <br>  Will the scheduler use this index? <br>  Related questions - does the order of listing index fields in the WHERE clause matter? <br>  Will we be able to get into the index if some of the fields are listed in the ON clause of the subquery, and some in the WHERE of a more general query, i.e.  Does the redistribution of conditions work together with the assessment hit / do not fall into the index? <br>  How can this be influenced? <br></div></div><br>  More specialized questions that are also hard to answer. <br><br><ol><li>  Under what conditions is it worth doing a partitioned table? </li><li>  When are there too many partitions? </li><li>  What size should I think about sharding? </li><li>  When to normalize, and when to data schema? </li><li>  How long is the string and why it is for so many databases that it is delivered to a separate storage? </li><li>  Why in pg using CTE in queries is much faster than implementing a temporary table?  Is it so?  If so, are there any exceptions? </li></ol><br><h3>  Explanations <br></h3><br>  I would be glad to find such answers myself, but most of the questions are drowned under floods, or hidden deep in the documentation / source of large projects.  Responses from the comments will be attached to the relevant questions.  What I can - I will try to find myself. <br><br>  Thank you for understanding. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/321388/">https://habr.com/ru/post/321388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321378/index.html">How to work with JIT</a></li>
<li><a href="../321380/index.html">RethinkDB: very much alive. Now under the wing of the Linux Foundation</a></li>
<li><a href="../321382/index.html">High-load project support</a></li>
<li><a href="../321384/index.html">VulnHub: Throwing out the disagreeable from the IRC at Wallaby's Nightmare</a></li>
<li><a href="../321386/index.html">How to evaluate the quality of the A / B testing system</a></li>
<li><a href="../321390/index.html">6 non-standard tricks to improve the performance and security of the site</a></li>
<li><a href="../321392/index.html">Feature Folders structure in ASP.NET Core MVC</a></li>
<li><a href="../321394/index.html">Vivaldi 1.7 - Quiet! Shooting ...</a></li>
<li><a href="../321398/index.html">PrestaShop. About the glitch in multi-level navigation</a></li>
<li><a href="../321400/index.html">What's new in CUBA Platform 6.4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>