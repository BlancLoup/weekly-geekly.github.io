<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ReSharper: Analysis on NullReferenceException and Contracts for It</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you use ReSharper, then you are probably familiar with its ‚ÄúPossible 'NullReferenceException'‚Äù highlighting . In this article I will briefly tell y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ReSharper: Analysis on NullReferenceException and Contracts for It</h1><div class="post__text post__text-html js-mediator-article">  If you use ReSharper, then you are probably familiar with its <i>‚ÄúPossible 'NullReferenceException'‚Äù highlighting</i> .  In this article I will briefly tell you about the analyzer, which displays warnings of this kind, and how to help it do better. <br><br>  Immediately consider an example: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">string</font> Bar( <font color="#0000ff">bool</font> condition) <br> { <br> <font color="#0000ff">string</font> iAmNullSometimes = condition ? <font color="#A31515">"Not null value"</font> : <font color="#0000ff">null</font> ; <br> <font color="#0000ff">return</font> iAmNullSometimes.ToUpper(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  ReSharper rightly highlights <i>iAmNullSometimes</i> in the second line of the method with such a warning.  Now select the method: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">string</font> Bar( <font color="#0000ff">bool</font> condition) <br> { <br> <font color="#0000ff">string</font> iAmNullSometimes = GetNullWhenFalse(condition); <br> <font color="#0000ff">return</font> iAmNullSometimes.ToUpper(); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> GetNullWhenFalse( <font color="#0000ff">bool</font> condition) <br> { <br> <font color="#0000ff">return</font> condition ? <font color="#A31515">"Not null value"</font> : <font color="#0000ff">null</font> ; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  After this operation, the warning disappears.  Why it happens? <br><br><a name="habracut"></a><br><h1>  Analyzer </h1><br>  The analyzer attempts to determine what values ‚Äã‚Äãthe variables used may have.  I will specify to what level of abstraction knowledge about the value of a variable has been reduced.  From the point of view of the analyzer, a variable can have one or several states: <br><br>  * <i>NULL</i> , <i>NOT_NULL</i> - indicates that the link has a zero or non-zero value; <br>  * <i>TRUE</i> , <i>FALSE</i> - similarly for the <i>bool</i> type; <br>  * <i>UNKNOWN</i> - the value entered for the optimistic analysis, which reduces the number of false positives. <br><br>  As a result of the operation of the analyzer, for each point of use of variables a set of their possible states is determined. <br><br>  In the first listing, <i>iAmNullSometimes</i> after initialization will have two possible states: <i>NULL</i> and <i>NOT_NULL</i> .  Therefore, the <i>‚ÄúPossible NullReferenceException‚Äù highlighting</i> tells us that there is at least one program execution path in which <i>iAmNullSometimes</i> will be <i>null</i> (in this case, the path in which <i>condition is</i> false). <br><br>  The second case is more complicated.  The analyzer does not know what values <i>GetNullWhenFalse</i> returns.  Of course, you can analyze it and make sure that it can return <i>null</i> .  But with an increase in the number of methods that also cause something, the time spent on such an analysis does not allow the analyzer to be used ‚Äúon the fly‚Äù on modern PCs (so that ReSharper can set the highlighting of possible errors).  Moreover, the called method may be in the library referenced by our project.  We will not decompile and analyze it on the fly. <br><br>  There is another option.  Assume that external methods that are not known about anything return either <i>NULL</i> or <i>NOT_NULL</i> .  This is how pessimistic analysis works. <br><br>  ReSharper uses optimistic analysis by default.  In it, if nothing is known about the method, then the return value will be in the special state <i>UNKNOWN</i> .  The variable that appears in this state at the time of its use is not highlighted (if, of course, there are no other ways on which <i>null</i> was assigned to it explicitly or from the <i>CanBeNull</i> method).  In the second listing, this causes the analyzer to "lose vigilance." <br><br>  The analyzer and its modes of operation require a separate article, so I will write about them separately. <br><br>  As in the case of optimistic and pessimistic analysis, I still want to somehow know what the called method is capable of so that ReSharper finds more potential errors.  Here contracts come to our aid. <br><br><h1>  Contracts </h1><br>  The ReSharper analyzer can use additional knowledge about the methods being called, obtaining it through contracts like ‚Äúmethod never returns <i>null</i> ‚Äù, ‚Äúmethod can return <i>null</i> ‚Äù, ‚Äúyou cannot substitute <i>null</i> in the parameter‚Äù.  In the simplest case, these contracts are specified using the attributes <i>JetBrains.Annotations.CanBeNullAttribute</i> and <i>JetBrains.Annotations.NotNullAttribute</i> .  Applying an attribute to a method will indicate whether it can return <i>null</i> .  To the parameter - about the validity of the substitution of zero value.  They can also be applied to properties and fields.  These attributes are defined in the <i>JetBrains.Annotations.dll</i> library, which lies in <i>&lt;ReSharper install directory&gt; \ Bin</i> . <br><br>  The example in the second listing can be improved by marking the <i>CanBeNull</i> attribute with the <i>GetNullWhenFalse</i> method: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">string</font> Bar( <font color="#0000ff">bool</font> condition) <br> { <br> <font color="#0000ff">string</font> iAmNullSometimes = GetNullWhenFalse(condition); <br> <font color="#0000ff">return</font> iAmNullSometimes.ToUpper(); <br> } <br> <br> [CanBeNull] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> GetNullWhenFalse( <font color="#0000ff">bool</font> condition) <br> { <br> <font color="#0000ff">return</font> condition ? <font color="#A31515">"Not null value"</font> : <font color="#0000ff">null</font> ; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  When using the <i>iAmNullSometimes</i> variable method, the <i>‚ÄúPossible 'NullReferenceException'‚Äù</i> highlight appears in this case. <br><br>  If you do not want in your project to take on an additional assembly, which also does not add functionality in runtime, then you can declare these attributes directly in your project.  The analyzer will use any attributes from any assemblies, as long as their names match those specified in <i>JetBrains.Annotations.dll</i> .  The definitions of these attributes can be easily obtained using the <i>Copy default implementation</i> button <i>to clipboard</i> , located on one of the ReSharper settings pages: <br><br><img src="https://habrastorage.org/storage/bd3eaf18/20d7f403/a9346219/cece5c22.jpg"><br><br><h1>  External Annotations </h1><br>  If you want to use an external library (for example, <i>mscorlib.dll</i> ), <i>assigning</i> contracts to its entities using attributes is not possible.  Here External Annotations come to the rescue.  This ReSharper feature allows you to add already compiled entities with attributes used by the ReSharper analyzer.  External Annotations provide an opportunity to "deceive" the analyzer - to make it so that it sees attributes, methods, and other declarations that were not declared when the library was compiled.  To do this, you need to register the attributes in the XML file located in the <i>&lt;ReSharper install directory&gt; \ Bin \ ExternalAnnotations directory</i> . <br><br>  This defines contracts for standard libraries that fall into this folder when installing ReSharper.  These contracts were derived from source code analysis and Microsoft Contracts.  The contracts obtained as a result of the first approach are located in files with the names <i>* .Generated.xml</i> , as a result of the second approach - in <i>* .Contracts.xml</i> . <br><br>  Files describing additional attributes have a structure similar to the structure of XmlDoc files.  For example, for the XmlReader.Create (Stream input) method from the System.Xml assembly of the fourth framework, the <i>NotNull</i> contracts are defined as follows: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">assembly</font> <font color="#ff0000">name</font> <font color="#0000ff">="System.Xml, Version=4.0.0.0"</font> <font color="#0000ff">&gt;</font> <font>&lt;!--   name   ,    ,              --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">member</font> <font color="#ff0000">name</font> <font color="#0000ff">="M:System.Xml.XmlReader.Create(System.IO.Stream)"</font> <font color="#0000ff">&gt;</font> <font>&lt;!--    ,   ;    ,   XmlDoc- --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">attribute</font> <font color="#ff0000">ctor</font> <font color="#0000ff">="M:JetBrains.Annotations.NotNullAttribute.#ctor"</font> <font color="#0000ff">/&gt;</font> <font>&lt;!--       XmlDoc- --&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">parameter</font> <font color="#ff0000">name</font> <font color="#0000ff">="input"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">attribute</font> <font color="#ff0000">ctor</font> <font color="#0000ff">="M:JetBrains.Annotations.NotNullAttribute.#ctor"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">parameter</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">member</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">assembly</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In order for ReSharper to pick up the file, it must be placed in one of the following ways: <i>&lt;ReSharper install directory&gt; \ Bin \ ExternalAnnotations \ &lt;Assembly name&gt; .xml</i> or <i>&lt;ReSharper install directory&gt; \ Bin \ ExternalAnnotations \ &lt;Assembly name&gt; \ &lt;Any name&gt;. xml</i> , where <i>&lt;Assembly name&gt;</i> is the assembly name without specifying the version.  If you place the files in the second way, then for a single assembly, you can specify multiple sets of contracts.  This may be necessary to differentiate assembly contracts with different versions. <br><br>  Now editing these files is not very convenient and involves a lot of manual work, which also requires administrator rights.  But in the near future we plan to publish a tool that simplifies this work.  Most likely it will be designed as a ReSharper plugin. <br><br><h1>  Application </h1><br>  Several practices of External Annotations that improve life when working with ReSharper. <br><br><h3>  XmlDocument.SelectNodes (string xpath) </h3><br>  The <i>CanBeNull annotation</i> for this method is often a topic for bug reports.  The fact is that <i>SelectNodes</i> is a method of the <i>XmlNode</i> class and, in general, can return <i>null</i> (for example, for <i>XmlDeclaration</i> ).  But most often we use this method when it never returns <i>null</i> - from an <i>XmlDocument</i> .  One solution would be to remove the corresponding annotation from External Annotations or replace it with <i>NotNull</i> .  But you can do it correctly by writing the extension method for the <i>XmlDocument</i> : <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">class</font> XmlUtil <br> { <br> [NotNull] <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#2B91AF">XmlNodeList</font> SelectNodesEx([NotNull] <font color="#0000ff">this</font> <font color="#2B91AF">XmlDocument</font> xmlDocument, [NotNull] <font color="#0000ff">string</font> xpath) <br> { <br> <font color="#008000">// ReSharper disable AssignNullToNotNullAttribute</font> <br> <font color="#0000ff">return</font> xmlDocument.SelectNodes(xpath); <br> <font color="#008000">// ReSharper restore AssignNullToNotNullAttribute</font> <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In this case, of course, it would be nice to still make methods like <i>SelectElements</i> and <i>SelectAttributes</i> , to avoid type conversion every time, but that's another story. <br><br><h3>  Assertion </h3><br>  If you use <i>Assert's</i> own (or third-party) methods in your project, you can mark them with the attributes <i>AssertionMethodAttribute</i> and <i>AssertionConditionAttribute</i> .  Direct candidates for this tagging are <i>Contracts.Assert</i> methods, if you use Microsoft Contracts: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">assembly</font> <font color="#ff0000">name</font> <font color="#0000ff">="Microsoft.Contracts"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">member</font> <font color="#ff0000">name</font> <font color="#0000ff">="M:System.Diagnostics.Contracts.Contract.Assert(System.Boolean)"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">attribute</font> <font color="#ff0000">ctor</font> <font color="#0000ff">="M:JetBrains.Annotations.AssertionMethodAttribute.#ctor"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">parameter</font> <font color="#ff0000">name</font> <font color="#0000ff">="condition"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">attribute</font> <font color="#ff0000">ctor</font> <font color="#0000ff">="M:JetBrains.Annotations.AssertionConditionAttribute.#ctor(JetBrains.Annotations.AssertionConditionType)"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">argument</font> <font color="#0000ff">&gt;</font> 0 <font color="#0000ff">&lt;/</font> <font color="#800000">argument</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">attribute</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">parameter</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">member</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">member</font> <font color="#ff0000">name</font> <font color="#0000ff">="M:System.Diagnostics.Contracts.Contract.Assert(System.Boolean,System.String)"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">attribute</font> <font color="#ff0000">ctor</font> <font color="#0000ff">="M:JetBrains.Annotations.AssertionMethodAttribute.#ctor"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">parameter</font> <font color="#ff0000">name</font> <font color="#0000ff">="condition"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">attribute</font> <font color="#ff0000">ctor</font> <font color="#0000ff">="M:JetBrains.Annotations.AssertionConditionAttribute.#ctor(JetBrains.Annotations.AssertionConditionType)"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">argument</font> <font color="#0000ff">&gt;</font> 0 <font color="#0000ff">&lt;/</font> <font color="#800000">argument</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">attribute</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">parameter</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">member</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">assembly</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  And you can also look in the direction of <i>TerminatesProgramAttribute</i> , if you have methods that always throw an exception. <br><br><h1>  And lastly </h1><br>  In one article just can not fit.  I plan to write a few more articles about the analyzer and its use.  Which way my story will go depends on what is interesting to the habrasoobschestvuu: optimistic and pessimistic analyzers, how to programmatically get annotations from sources, or something else. <br><br>  And yes.  Annotate your code with contracts and you will be welcome! </div><p>Source: <a href="https://habr.com/ru/post/103494/">https://habr.com/ru/post/103494/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../103484/index.html">"Don't be evil" by Eric Schmidt</a></li>
<li><a href="../103488/index.html">September 11 - IT JAM in Kharkov</a></li>
<li><a href="../103489/index.html">Back to the Future</a></li>
<li><a href="../103492/index.html">Fullscreen mode in Google Reader</a></li>
<li><a href="../103493/index.html">Interview with the founder of Habrahabr on radio</a></li>
<li><a href="../103495/index.html">"Quiet" release LoadRunner 11</a></li>
<li><a href="../103498/index.html">Dialogs and text input</a></li>
<li><a href="../103499/index.html">10.62 RC</a></li>
<li><a href="../103500/index.html">Internet Media Player 4</a></li>
<li><a href="../103503/index.html">Can hosting be unlimited</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>