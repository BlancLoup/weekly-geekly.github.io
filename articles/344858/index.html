<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parcel - write plugin</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article I told about the new Parcel bandler, which does not require configuration and is ready for battle immediately after installation. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parcel - write plugin</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/dl/eq/ic/dleqicf-sk-seha4s06qmvgzje4.png"></p><br><p>  In the last article I told about the new <a href="https://habrahabr.ru/post/344486/">Parcel</a> bandler, which does not require configuration and is ready for battle immediately after installation.  But what to do if suddenly there is not enough standard set of assets?  The answer is simple - write your own plugin. </p><a name="habracut"></a><br><p>  Let me remind you that the following assets are available out of the box: </p><br><ul><li>  JavaScript (Babel), CoffeeScript, TypeScript </li><li>  CSS, LESS, SASS, Stylus </li><li>  HTML </li><li>  JSON, YAML </li><li>  Glob, Raw </li></ul><br><p>  To create our asset, we can choose two ways - use the existing one ( <a href="">JSAsset</a> , <a href="">HTMLAsset</a> , etc.), in which we can rewrite or add part of the logic, or write from scratch, using the <a href="">Asset</a> class as a basis. </p><br><p>  As an example, I‚Äôll tell you how the <a href="https://github.com/Ty3uK/parcel-plugin-pug">plugin for Pug</a> was written. </p><br><h1 id="nemnogo-teorii">  Some theory </h1><br><p>  First you need to figure out how Parcel works with plugins and what can they do at all? </p><br><p> When the bundler is initialized ( <a href="">Bundler</a> ), packages are searched in package.json, starting with <code>parcel-plugin-</code> .  Each bundle found by the package connects and calls the exported function, passing its context to it.  In this function, we can register your asset. </p><br><p>  Our asset should implement the following methods: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** *     AST */</span></span> parse(code: string): Ast <span class="hljs-comment"><span class="hljs-comment">/** *         */</span></span> collectDependencies(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-comment"><span class="hljs-comment">/** *   AST   */</span></span> generate(): <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span></code> </pre> <br><p>  You can also implement optional methods: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** *     AST */</span></span> pretransform(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-comment"><span class="hljs-comment">/** *      AST */</span></span> transform(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span></code> </pre> <br><h1 id="kak-rabotat-s-pug-ast">  How to work with Pug AST </h1><br><p>  There are several official packages for working with AST: </p><br><ul><li>  <a href="https://github.com/pugjs/pug-load"><code>pug-load</code></a> - loads the text and gives it to the lexer and the parser </li><li>  <a href="https://github.com/pugjs/pug-lexer"><code>pug-lexer</code></a> - parses text on tokens </li><li>  <a href="https://github.com/pugjs/pug-parser"><code>pug-parser</code></a> - turns an array of tokens into AST </li><li>  <a href="https://github.com/pugjs/pug/tree/master/packages/pug-linker"><code>pug-linker</code></a> - sticks together several ASTs, is needed for <code>include</code> and <code>extends</code> </li><li>  <a href="https://github.com/pugjs/pug/tree/master/packages/pug-walk"><code>pug-walk</code></a> - allows you to walk on AST and modify it </li><li>  <a href="https://github.com/pugjs/pug/tree/master/packages/pug-code-gen"><code>pug-ode-gen</code></a> - generates HTML using a javascript function </li><li>  <a href="https://github.com/pugjs/pug/tree/master/packages/pug-runtime"><code>pug-runtime</code></a> - contains a <code>wrap</code> function that allows you to wrap and execute the function returned from <code>pug-ode-gen</code> </li></ul><br><h1 id="plagin">  Plugin </h1><br><p>  Create the following project structure: </p><br><pre> <code class="bash hljs">parcel-plugin-pug ‚îú‚îÄ‚îÄ package.json ‚îú‚îÄ‚îÄ src ‚îÇ  ‚îú‚îÄ‚îÄ PugAsset.ts ‚îÇ  ‚îú‚îÄ‚îÄ index.ts ‚îÇ  ‚îî‚îÄ‚îÄ modules.d.ts ‚îú‚îÄ‚îÄ tsconfig.json ‚îî‚îÄ‚îÄ tslint.json</code> </pre> <br><p>  The <code>index.ts</code> file will be the entry point to our plugin: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bundler: any</span></span></span><span class="hljs-function">) =&gt;</span></span> { bundler.addAssetType(<span class="hljs-string"><span class="hljs-string">'pug'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.resolve(<span class="hljs-string"><span class="hljs-string">'./PugAsset'</span></span>)); bundler.addAssetType(<span class="hljs-string"><span class="hljs-string">'jade'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.resolve(<span class="hljs-string"><span class="hljs-string">'./PugAsset'</span></span>)); };</code> </pre> <br><p>  To work with an asset, we need the base class <code>Asset</code> .  Let's write a TypeScript binding for the modules we need: </p><br><div class="spoiler">  <b class="spoiler_title">modules.d.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs">declare <span class="hljs-built_in"><span class="hljs-built_in">module</span></span> <span class="hljs-string"><span class="hljs-string">'parcel-bundler/src/Asset'</span></span> { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Asset</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(name: string, pkg: string, options: any); parse(code: string): any; addDependency(path: string, options: Object): any; addURLDependency(url: string): string; name: string; isAstDirty: boolean; contents: string; ast: any; options: any; dependencies: Set&lt;Object&gt;; } export = Asset; } declare module 'parcel-bundler/src/utils/is-url' { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isURL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url: string</span></span></span><span class="hljs-function">): </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">boolean</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">export</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isURL</span></span></span><span class="hljs-function">; } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">declare</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">module</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pug</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-function">' </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> string(str: string, options?: any): any; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> = load; } declare <span class="hljs-built_in"><span class="hljs-built_in">module</span></span> <span class="hljs-string"><span class="hljs-string">'pug-lexer'</span></span> { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lexer</span></span></span><span class="hljs-class"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> = Lexer; } declare <span class="hljs-built_in"><span class="hljs-built_in">module</span></span> <span class="hljs-string"><span class="hljs-string">'pug-parser'</span></span> { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parser</span></span></span><span class="hljs-class"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> = Parser; } declare <span class="hljs-built_in"><span class="hljs-built_in">module</span></span> <span class="hljs-string"><span class="hljs-string">'pug-walk'</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">walkAST</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ast: any, before?: (node: any, replace?: any</span></span></span><span class="hljs-function">) =&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">after</span></span></span><span class="hljs-function">?: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node: any, replace?: any</span></span></span><span class="hljs-function">) =&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">options</span></span></span><span class="hljs-function">?: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">any</span></span></span><span class="hljs-function">): </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">export</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">walkAST</span></span></span><span class="hljs-function">; } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">declare</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">module</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pug</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">linker</span></span></span><span class="hljs-function">' </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">link</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ast: any</span></span></span><span class="hljs-function">): </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">any</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">export</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">link</span></span></span><span class="hljs-function">; } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">declare</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">module</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pug</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">code</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen</span></span></span><span class="hljs-function">' </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ast: any, options: any</span></span></span><span class="hljs-function">): </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">export</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateCode</span></span></span><span class="hljs-function">; } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">declare</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">module</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pug</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runtime</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrap</span></span></span><span class="hljs-function">' </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrap</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">template: string, templateName?: string</span></span></span><span class="hljs-function">): </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Function</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">export</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrap</span></span></span><span class="hljs-function">; }</span></span></code> </pre> </div></div><br><p>  The <code>PugAsset.ts</code> file is our asset for converting template files into HTML. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Asset = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'parcel-bundler/src/Asset'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> = <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PugAsset</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Asset</span></span></span><span class="hljs-class"> </span></span>{ public type = <span class="hljs-string"><span class="hljs-string">'html'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(name: string, pkg: string, options: any) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(name, pkg, options); } public parse(code: string) { } public collectDependencies(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { } public generate() { } };</code> </pre> <br><p>  Start by turning the template text into AST.  As I said before, when a filer comes across a file, it tries to find its asset.  If it was found, the call chain <code>parse -&gt; pretransform -&gt; collectDependencies -&gt; transform -&gt; generate</code> .  Our first step is to implement the <code>parse</code> method: </p><br><pre> <code class="javascript hljs">public parse(code: string) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ast = load.string(code, { <span class="hljs-comment"><span class="hljs-comment">//   lex: lexer, //   parse: parser, //   ,        filename: this.name }); //    AST (    include  extends) ast = linker(ast); return ast; }</span></span></code> </pre> <br><p>  Next, we need to go through the constructed tree and find any elements that may contain links.  The mechanism of operation is quite simple and was <code>HTMLAsset</code> in the standard <code>HTMLAsset</code> .  The bottom line is to create a dictionary with HTML-site attributes that may contain links.  When passing through the tree, you need to find the appropriate nodes and feed the contents of the attribute with a link to the <code>addURLDependency</code> method, which will try to find the necessary asset depending on the file extension.  If the asset is found, the method will return the new file name, simultaneously adding this file to the assembly tree (this is the way the nested conversion of other assets takes place).  This name we need to substitute the old way.  We also need to take into account the fact that we need to add all the included files ( <code>include</code> and <code>extends</code> ) as dependencies of this asset, otherwise if we change the included or base file, we will not have to reassemble the entire template. </p><br><pre> <code class="javascript hljs">interface Dictionary&lt;T&gt; { [key: string]: T; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ATTRS: Dictionary&lt;string[]&gt; = { <span class="hljs-attr"><span class="hljs-attr">src</span></span>: [ <span class="hljs-string"><span class="hljs-string">'script'</span></span>, <span class="hljs-string"><span class="hljs-string">'img'</span></span>, <span class="hljs-string"><span class="hljs-string">'audio'</span></span>, <span class="hljs-string"><span class="hljs-string">'video'</span></span>, <span class="hljs-string"><span class="hljs-string">'source'</span></span>, <span class="hljs-string"><span class="hljs-string">'track'</span></span>, <span class="hljs-string"><span class="hljs-string">'iframe'</span></span>, <span class="hljs-string"><span class="hljs-string">'embed'</span></span> ], <span class="hljs-attr"><span class="hljs-attr">href</span></span>: [<span class="hljs-string"><span class="hljs-string">'link'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>], <span class="hljs-attr"><span class="hljs-attr">poster</span></span>: [<span class="hljs-string"><span class="hljs-string">'video'</span></span>] };</code> </pre> <br><pre> <code class="javascript hljs">public collectDependencies(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { walk(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ast, node =&gt; { <span class="hljs-comment"><span class="hljs-comment">// ,       ,     if (node.filename !== this.name &amp;&amp; !this.dependencies.has(node.filename)) { //     this.addDependency(node.filename, { name: node.filename, //    includedInParent: true //        }); } // ,      if (node.attrs) { //     for (const attr of node.attrs) { const elements = ATTRS[attr.name]; //    -       if (node.type === 'Tag' &amp;&amp; elements &amp;&amp; elements.indexOf(node.name) &gt; -1) { // Pug  URL  ,    let assetPath = attr.val.substring(1, attr.val.length - 1); //       assetPath = this.addURLDependency(assetPath); //       -   if (!isURL(assetPath)) { // Use url.resolve to normalize path for windows // from \path\to\res.js to /path/to/res.js assetPath = url.resolve(path.join(this.options.publicURL, assetPath), ''); } //    attr.val = `'${assetPath}'`; } } } return node; }); }</span></span></code> </pre> <br><p>  The final touch is getting the final HTML.  This is the responsibility of the <code>generate</code> method: </p><br><pre> <code class="javascript hljs">public generate() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = generateCode(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ast, { <span class="hljs-comment"><span class="hljs-comment">//    compileDebug: false, //      pretty: !this.options.minify }); return { html: wrap(result)() }; }</span></span></code> </pre> <br><p>  If you put it all together we get the following: </p><br><div class="spoiler">  <b class="spoiler_title">PugAsset.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Asset = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'parcel-bundler/src/Asset'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> isURL = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'parcel-bundler/src/utils/is-url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> load = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'pug-load'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lexer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'pug-lexer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> parser = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'pug-parser'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> walk = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'pug-walk'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> linker = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'pug-linker'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> generateCode = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'pug-code-gen'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wrap = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'pug-runtime/wrap'</span></span>); interface Dictionary&lt;T&gt; { [key: string]: T; } <span class="hljs-comment"><span class="hljs-comment">// A list of all attributes that should produce a dependency // Based on https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes const ATTRS: Dictionary&lt;string[]&gt; = { src: [ 'script', 'img', 'audio', 'video', 'source', 'track', 'iframe', 'embed' ], href: ['link', 'a'], poster: ['video'] }; export = class PugAsset extends Asset { public type = 'html'; constructor(name: string, pkg: string, options: any) { super(name, pkg, options); } public parse(code: string) { let ast = load.string(code, { lex: lexer, parse: parser, filename: this.name }); ast = linker(ast); return ast; } public collectDependencies(): void { walk(this.ast, node =&gt; { if (node.filename !== this.name &amp;&amp; !this.dependencies.has(node.filename)) { this.addDependency(node.filename, { name: node.filename, includedInParent: true }); } if (node.attrs) { for (const attr of node.attrs) { const elements = ATTRS[attr.name]; if (node.type === 'Tag' &amp;&amp; elements &amp;&amp; elements.indexOf(node.name) &gt; -1) { let assetPath = attr.val.substring(1, attr.val.length - 1); assetPath = this.addURLDependency(assetPath); if (!isURL(assetPath)) { // Use url.resolve to normalize path for windows // from \path\to\res.js to /path/to/res.js assetPath = url.resolve(path.join(this.options.publicURL, assetPath), ''); } attr.val = `'${assetPath}'`; } } } return node; }); } public generate() { const result = generateCode(this.ast, { compileDebug: false, pretty: !this.options.minify }); return { html: wrap(result)() }; } };</span></span></code> </pre> </div></div><br><p>  Our plugin is ready.  He knows how to accept templates as input, convert text into AST, resolve all internal dependencies and output ready HTML at output, correctly recognize embedded and <code>include</code> constructs, as well as reassemble the entire template containing these constructions. </p><br><p>  From minor flaws - when an error occurs, its text is duplicated, which is a feature of the output of Parcel, which wraps function calls in a <code>try catch</code> and prints out errors in a nice way. </p><br><h3 id="ssylki">  Links </h3><br><ul><li>  <a href="">Pug AST specification</a> </li><li>  <a href="https://github.com/Ty3uK/parcel-plugin-pug">parcel-plugin-pug</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/344858/">https://habr.com/ru/post/344858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344842/index.html">Description of business processes. Use caution</a></li>
<li><a href="../344844/index.html">Surrogates</a></li>
<li><a href="../344848/index.html">Irreparable consequences of HolyJS 2017 Moscow</a></li>
<li><a href="../344852/index.html">How to make friends with Skype and proxy</a></li>
<li><a href="../344856/index.html">Two analyst competencies</a></li>
<li><a href="../344860/index.html">Morning Watch, or join Radio Robinhood</a></li>
<li><a href="../344862/index.html">Tests alone are not enough, good architecture is needed.</a></li>
<li><a href="../344864/index.html">Security variables in Kotlin for example Java</a></li>
<li><a href="../344866/index.html">Solving Open Day CrackMe, task Pizza</a></li>
<li><a href="../344868/index.html">Go there, I do not know where: in the wake of the conference SmartData</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>