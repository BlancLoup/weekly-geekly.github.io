<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ScadaPy - using OPC UA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous few articles, I have described the possibilities of using the modbus protocol to create my own Scada system based on python. This time...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ScadaPy - using OPC UA</h1><div class="post__text post__text-html js-mediator-article">  In the previous few articles, I have described the possibilities of using the modbus protocol to create my own Scada system based on python.  This time I would like to share the experience of building a system for polling slave devices using OCR technology. <br>  The disadvantages of OPC servers are that they can only be used in the Microsoft Windows operating systems (as a rule, they are paid), and you could forget about devices using Linux OS. <br><br>  But over time, the OPC Unified Architecture specification (the OPC Unified Architecture) was created, which made it possible to use this data transfer technology on other operating systems other than Windows.  This also applies to embedded systems where full-fledged Linux can be launched. <br><br>  Read more <a href="https://ru.wikipedia.org/wiki/OPC_UA">here.</a> <br><a name="habracut"></a><br>  For example, you can run several different OPC UA servers on the Raspberry Pi single-board computer to poll terminal devices, meters, sensors, etc., while the system will work quite stably. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/07a/12b/039/07a12b039ad618848e65d1ce5516eb8a.jpg" alt="image"><br><br><h2>  Installing Libraries </h2><br>  Xubuntu 17.04 Desktop and Windows 8.1 are used to work with OPC UA and modbus servers.  On Xubuntu 17.04, Python 2.7 and Python 3.5 are already installed by default.  Choosing Python 3.5. <br><br>  If the necessary packages have not been added to the computer after installing the operating system, then you need to run: <br><br><pre><code class="bash hljs">sudo apt-get install python3-pip sudo pip3 install pytz PyQt5 sudo apt-get install python3-opcua, libxml2-dev, python3-lxml</code> </pre> <br>  We solve the problem of dependencies: <br><br><pre> <code class="bash hljs">sudo apt-get ‚Äìf install</code> </pre> <br>  After we put the necessary libraries: <br><br><pre> <code class="bash hljs">sudo pip3 install requests pyserial</code> </pre> <br>  For windows, you can install via pip3.exe, the library and examples are located <a href="https://github.com/FreeOpcUa/python-opcua">here.</a> <br><br>  To start the server, the library must be imported: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> opcua <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ua, Server</code> </pre> <br>  Now we create an OPC UA server. <br><br><pre> <code class="python hljs">server = Server() <span class="hljs-comment"><span class="hljs-comment">#  IP    ,    server.set_endpoint("opc.tcp://0.0.0.0:4840/") #   server.set_server_name("Server") #     #      ,          server.load_certificate("server_cert.der") server.load_private_key("server_private_key.pem") #    uri = "http://server" idx = server.register_namespace(uri) #         objects = server.get_objects_node() #      Object_1 =objects.add_object(idx,'MyFirstObject) Object_2 =objects.add_object(idx,'MySecondObject) Object_3 =objects.add_object(idx,'MyThirdObject) #   Discret_1 = Object_1.add_variable(idx,'Discret_1',[0,0,0,0,0,0,0,0]) Discret_2 = Object_2.add_variable(idx,'Discret_2',[0,0,0,0,0,0,0,0]) Analog_3 = Object_3.add_variable(idx,'Analog_3',[10,20,30,40,50]) #  server.start()</span></span></code> </pre><br>  That's all the python code to run OPC UA.  As it turned out nothing complicated, and if you now connect to the running server using <a href="https://www.unified-automation.com/">UA Expert</a> , you can see a hierarchical list of our objects and variables with values. <br><br>  To modify the values ‚Äã‚Äãof variables, use the <b>set_value</b> function of the type: <br><br><pre> <code class="python hljs">Discret_1.set_value([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>])</code> </pre> <br>  Of course, this is a very primitive example, but the OPC UA library contains many more features that can be found <a href="http://python-opcua.readthedocs.io/en/latest/">here</a> . <br><br>  The only thing that could not be figured out is how to set the login and password on the server, something like through politics, I think I will solve this problem later. <br><br><h2>  Server configurator </h2><br>  In continuation of the above, the task arose of quickly configuring each newly created server. <br><br>  For this purpose, the Server Configurator was written in the PyQt5 library. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ea1/066/8c9/ea10668c97d145d6d6f9a5792931f940.png" alt="image"><br><br>  <b>Principle of operation:</b> <br><br>  - database is created on sqlite3 <br>  - tables are formed for the slave and master parts of the server. <br>  - the tables are filled with the necessary parameters. <br>  - formed startup script. <br><br>  <b>The main idea</b> is that servers should work equally in Windows and Linux. <br>  Download <a href="https://github.com/scadapy/config">here</a> <br><br>  <b>Directory structure:</b> <br>  srvconf.py - Server Configurator program <br>  db - the srvDb.db database file is located. <br>  img - .png files for buttons <br>  source - server template files <br><br><ul><li>  <b>mercury.py</b> - a library to survey the counters mercury 230 </li><li>  <b>modbustcp_master_dcon.py</b> is a <b>modbusTCP</b> slave server, master - polls slave devices using the DCON protocol (Advantech).  Currently only the 4050 module. </li><li>  <b>modbustcp_master_http.py</b> is a <b>modbusTCP</b> slave server, master forms a request using a GET method using a URL or IP, and we receive a list of int or string values ‚Äã‚Äãseparated by commas.  Used for embedded systems with http servers onboard, I used for ESP8266 with wi-fi connection. </li><li>  <b>modbustcp_master_ping.py</b> - a <b>modbusTCP</b> slave server, master - sends an ICMP ping packet to the specified server, in the case of true, forms a discrete 1, in the case of false, 0. </li><li>  <b>modbustcp_master_rtu.py</b> is the <b>modbusTCP</b> slave server, master is modbusRTU.  Used for polling slave devices using the modbusRTU protocol </li><li>  <b>modbustcp_master_tcp.py</b> is the <b>modbusTCP</b> slave server, master is modbusTCP.  Used to poll remote devices using the modbusTCP protocol. </li><li>  <b>opcua_master_dcon.py</b> - OPC-UA slave server, master - polls slave devices using the DCON (Advantech) protocol.  Currently only the 4050 module. </li><li>  <b>opcua_master_http.py</b> - OPC-UA slave-server, master - forms a request using a GET method using a URL or IP, in response we get a list of int or string values ‚Äã‚Äãseparated by commas.  Used for embedded systems with http servers onboard, I used for ESP8266 with wi-fi connection. </li><li>  <b>opcua_master_mercury230.py</b> - OPC-UA slave-server, master - polling commands for counters Mercury 230 are generated. The implementation is exclusively for OPCUA, since not all response parameters for this protocol can be uniquely processed in order to be placed in modbus registers. </li><li>  <b>opcua_master_ping.py</b> - the OPC-UA slave server, master - sends an ICMP ping packet to the specified server, in the case of true, forms a discrete 1, in the case of false, 0. </li><li>  <b>opcua_master_rtu.py</b> - OPC-UA slave server, master - modbusRTU.  Used to interrogate slave devices using the modbusRTU protocol. </li><li>  <b>opcua_master_tcp.py</b> is the OPC-UA slave server, master is modbusTCP.  Used to poll remote devices using the modbusTCP protocol. </li></ul><br>  scr - script files to start the server. <br><br>  For Windows, a file of type start_XX.bat will be created, for Linux, a file of type start_XX.sh, where XX is the server sequence number in the servers table. <br><br>  <b>Contents of the start_XX.bat file:</b> <br><br><pre> <code class="bash hljs">rem     <span class="hljs-string"><span class="hljs-string">'ScadaPy   v.3.11'</span></span> rem   <span class="hljs-string"><span class="hljs-string">'Windows opcua_mercury230 '</span></span> rem Slave  <span class="hljs-string"><span class="hljs-string">'192.168.0.103'</span></span> rem Slave  <span class="hljs-string"><span class="hljs-string">'4840'</span></span> rem  master <span class="hljs-string"><span class="hljs-string">'master_mercury230'</span></span> rem  slave <span class="hljs-string"><span class="hljs-string">'opcUA'</span></span> rem  tty <span class="hljs-string"><span class="hljs-string">'com6'</span></span> rem  tty <span class="hljs-string"><span class="hljs-string">'9600'</span></span> start c:\Python35\python.exe F:\scadapy\config\<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>\opcua_master_mercury230.py 68 F:\scadapy\config\db\srvDb.db</code> </pre><br>  <b>Contents of the start_XX.sh file for Linux:</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     'ScadaPy   v.3.09' #   'Modbus TCP' # Slave  '192.168.0.101' # Slave  '504' #  master 'master_modbusTCP' #  slave 'modbusTCP' #  tty '/dev/ttyUSB0' #  tty '9600' /home/jack/config/source/modbustcp_master_tcp.py 67 /home/jack/config/db/srvDb.db</span></span></code> </pre><br>  Linux startup parameters use xfce4-terminal, since  I work in Xubuntu 17.04, <br>  but you can specify a different type of launch, like gnome-terminal. <br><br><pre> <code class="bash hljs">xfce4-terminal --<span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">'sudo /home/jack/config/scr/start_67.sh'</span></span></code> </pre> <br>  In the examples, the parameters for filling the tables are quite clearly described. <br><br>  It is noteworthy that 4 servers were simultaneously launched on raspberry Pi - mobus_ping, opcua_http, opcua_mercury230 on / dev / ttyUSB0 and modbus_dcon on / dev / ttyUSB1, while it worked quite stably and without failures. <br><br>  The control is currently implemented in part and only in master_dcon, therefore only tele-alarm and tele-measurements are used.  In the future, I think to add and remote control. </div><p>Source: <a href="https://habr.com/ru/post/341728/">https://habr.com/ru/post/341728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341718/index.html">Prediction of connections in social networks: use transition points</a></li>
<li><a href="../341720/index.html">What we will tell on Highload ++ 2017</a></li>
<li><a href="../341722/index.html">Tabs or spaces: solve with Visual Studio</a></li>
<li><a href="../341724/index.html">Self-testing system with alerts on Laravel + Bitbucket + HipChat</a></li>
<li><a href="../341726/index.html">Bitrix24 - CRM or not only?</a></li>
<li><a href="../341730/index.html">Simulation of the planet daisies</a></li>
<li><a href="../341732/index.html">ICO: HYIP will go, and we will stay, or time against tokens</a></li>
<li><a href="../341736/index.html">Overview of the new high-performance RDP codec</a></li>
<li><a href="../341738/index.html">Delegate Adapter - why and how</a></li>
<li><a href="../341740/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ287 (October 30 - November 5, 2017)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>