<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with People Monitoring in Python with Raspberry Pi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Trying to connect my DS18B20 temperature sensor to my smart greenhouse , I found that the Internet does not have full instructions for connecting this...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with People Monitoring in Python with Raspberry Pi</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/files/070/703/162/0707031628c543d68a6fa8928769d2ab.jpg">  Trying to connect my DS18B20 temperature sensor to my <a href="https://geektimes.ru/post/284258/">smart greenhouse</a> , I found that the Internet does not have full instructions for connecting this sensor using the Python programming language.  I use it as I work with the Raspberry Pi platform.  I decided to fix this problem.  It turns out to work with TCP is not so difficult, but you need to understand what we are doing and why.  A two-hour dance with a tambourine obviously pissed me off.  So here, in addition to the program part, I want to tell the whole algorithm from beginning to end.  I think that other sensors work similarly, so a big article will be the same for everyone.  I hope that if you want to connect your sensor, you will not need a tambourine already :) And so, let's get started, I ask you under Habrokat. <a name="habracut"></a><br><br><h3>  Shamanism with a sensor </h3><br><img align="right" src="https://habrastorage.org/files/5e9/a73/80f/5e9a7380fff54065a011b64222fdcf5f.png">  For we need to connect the sensor itself.  I will work with the DS18B20 temperature sensor.  There are lots of articles on this topic, we will not duplicate them.  You can read about the connection <a href="http://www.avislab.com/blog/raspberry-pi-ds18b20_ru/">here</a> .  Then we need to get data from the sensor.  We will do the same as stated in the article above.  There is a great example in Python, of which I am a fan. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os tfile=open(<span class="hljs-string"><span class="hljs-string">"/sys/bus/w1/devices/28-000000d7970b/w1_slave"</span></span>) ttext=tfile.read() tfile.close() temp=ttext.split(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">" "</span></span>)[<span class="hljs-number"><span class="hljs-number">9</span></span>] temperature=float(temp[<span class="hljs-number"><span class="hljs-number">2</span></span>:])/<span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> temperature</code> </pre> <br>  <i>Do not forget to replace the data on your sensor.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As we can see, the temperature takes the variable temperature (who would have thought), and that we will need further. <br><br><h3>  We conjure with monitoring </h3><br>  Well, first you need to register <a href="http://narodmon.ru/">narodmon.ru</a> , those who have not done it yet.  The service API offers us to transfer data over TCP.  So do.  We are asked to transmit the text in the following format: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#MAC</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[#NAME]</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[#LAT]</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[#LNG]</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[#ELE]</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">n</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#mac1</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#value1</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[#time1]</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[#name1]</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">n</span></span> ... <span class="hljs-selector-id"><span class="hljs-selector-id">#macN</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#valueN</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[#timeN]</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[#nameN]</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">n</span></span> ##</code> </pre> <br>  But in fact, we need to transfer only three parameters: the MAC of the device, the name of the sensor and its value.  The rest is not necessary, and not really we need. <br><br>  In the first line, we need to pass the pound, MAC, and line feed character \ n. <br>  In the second and subsequent lines, we again transmit the grid, sensor name, grid again and sensor readings.  We end this with the newline character \ n. <br>  In the last line, you must pass two grids to complete the package. <br><br>  As a result, the format remains as follows: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#MAC</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">n</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#mac1</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#value1</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">n</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#macN</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#valueN</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">n</span></span> ##</code> </pre> <br><h3>  We write the program in Python </h3><br>  We will write the program in Python 2. The algorithm will be like this.  Receive data from the sensor and write to the temperature variable.  Then we form the package and send it to the server of the National Monitoring.  We will run the script every 10 minutes (the minimum allowed interval for sending readings is 5 minutes) via cron. <br><br>  Sending occurs as follows (example shown on the monitoring site): <br><br><div class="spoiler">  <b class="spoiler_title">Send script code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python2 # -*- coding: utf-8 -*- # by Roman Vishnevsky aka.x0x01 @ gmail.com import socket # MAC  .   ! DEVICE_MAC = '0123456789012' #  ,    01 (02)  mac  SENSOR_ID_1 = DEVICE_MAC + '01' SENSOR_ID_2 = DEVICE_MAC + '02' #  ,  float/integer sensor_value_1 = 20 sensor_value_2 = -20.25 #   sock = socket.socket() #   try: #    sock.connect(('narodmon.ru', 8283)) #       sock.send("#{}\n#{}#{}\n##".format(DEVICE_MAC, SENSOR_ID_1, sensor_value_1)) #       # sock.send("#{}\n#{}#{}\n#{}#{}\n##".format(DEVICE_MAC, SENSOR_ID_1, sensor_value_1, SENSOR_ID_2, sensor_value_2)) #   data = sock.recv(1024) sock.close() print data except socket.error, e: print('ERROR! Exception {}'.format(e))</span></span></code> </pre><br></div></div><br>  We connect to the server narodmon.ru:8283 <br><br>  As a result, we get this script: <br><br><div class="spoiler">  <b class="spoiler_title">Ready script code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python2 # -*- coding: utf-8 -*- import socket import os import fnmatch # MAC  .   ! DEVICE_MAC = 'FF:FF:FF:FF:FF:FF' #  SENSOR_ID_1 = 'T1' SENSOR_ID_2 = 'T2' #   temperature = [] IDs = [] for filename in os.listdir("/sys/bus/w1/devices"): if fnmatch.fnmatch(filename, '28-031652ddbdff'): with open("/sys/bus/w1/devices/" + filename + "/w1_slave") as fileobj: lines = fileobj.readlines() if lines[0].find("YES"): pok = lines[1].find('=') temperature.append(float(lines[1][pok+1:pok+7])/1000) IDs.append(filename) else: logger.error("Error reading sensor with ID: %s" % (filename)) temperature2 = [] for filename in os.listdir("/sys/bus/w1/devices"): if fnmatch.fnmatch(filename, '28-011563e8d2ff'): with open("/sys/bus/w1/devices/" + filename + "/w1_slave") as fileobj: lines = fileobj.readlines() if lines[0].find("YES"): pok = lines[1].find('=') temperature2.append(float(lines[1][pok+1:pok+7])/1000) IDs.append(filename) else: logger.error("Error reading sensor with ID: %s" % (filename)) sock = socket.socket() # try: sock.connect(('narodmon.ru', 8283)) # ,        sock.send("#{}\n#{}#{}\n#{}#{}\n##".format(DEVICE_MAC, SENSOR_ID_1, str(temperature)[1:-1], SENSOR_ID_2, str(temperature2)[1:-1])) #  data=sock.recv(1024) sock.close() print data except socket.error, e: print('ERROR! Exception {}'.format(e)) print str(temperature)[1:-1] print str(temperature2)[1:-1]</span></span></code> </pre> <br></div></div><br>  This is how sending data from two sensors looks like.  If you give the sensor a name starting with T, the server itself will determine that it is a temperature sensor. <br><br>  Now we need to add a sensor to cron.  We type: <code>crontab -e</code> and add this line to it: <br><br><pre> <code class="bash hljs">*/10 * * * * sudo python /home/pi/narod.py</code> </pre> <br>  We are waiting for the script to start. <br><br>  Now go here <a href="http://narodmon.ru/ip">narodmon.ru/ip</a> and see if the data was transmitted.  If everything is in order, then click on the ‚ÄúAdd device‚Äù button on the main page in the menu and specify the MAC.  Now we can customize everything to taste (name, type, location, etc.).  The sensor can be made public one day after the start of the transfer of evidence. <br><br>  That's all.  I wish you good luck in connecting sensors.  Do it more often, because it is so convenient from home to see the temperature in advance at the place where you are going. <br><br>  See you soon :) </div><p>Source: <a href="https://habr.com/ru/post/401313/">https://habr.com/ru/post/401313/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../401303/index.html">Gods of war. Something about the artillery games. Part IV</a></li>
<li><a href="../401305/index.html">FRIDAY COWORKOUT</a></li>
<li><a href="../401307/index.html">Ask Ethan: how fast are gravitational waves moving?</a></li>
<li><a href="../401309/index.html">Boston Dynamics is developing a frighteningly fast robot.</a></li>
<li><a href="../401311/index.html">New on lamptest.ru</a></li>
<li><a href="../401315/index.html">Not so simple with a quantum computer</a></li>
<li><a href="../401317/index.html">Telegram audience in Russia grew to 6 million people</a></li>
<li><a href="../401321/index.html">The best short animation films about technology in the history of Oscar</a></li>
<li><a href="../401323/index.html">Rostelecom invests in upgrading copper telephone lines</a></li>
<li><a href="../401325/index.html">Willpower is a harmful and outdated term that must be eliminated.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>