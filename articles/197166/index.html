<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Taming Web Application Configurations with node-convict</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: This is the seventh article in the Node.js series from the Mozilla Identity team that deals with the Persona project. 

  All art...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Taming Web Application Configurations with node-convict</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/1cd/114/dcc/1cd114dccef67edc3ab87f77457332d9.jpg" align="left">  <i><b>From the translator:</b> This is the seventh article in <a href="https://hacks.mozilla.org/category/a-node-js-holiday-season/">the Node.js series</a> from the Mozilla Identity team that deals with the <a href="http://ru.wikipedia.org/wiki/Mozilla_Persona">Persona</a> project.</i> <i><br><br></i> <div class="spoiler">  <b class="spoiler_title">All articles of the cycle:</b> <div class="spoiler_text"><ol><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/195494/">Hunting for memory leaks in Node.js</a> " </li><li>  "We <a href="http://habrahabr.ru/company/nordavind/blog/195686/">load Node to the eyeballs</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196018/">Store the session on the client to simplify application scaling</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196358/">Frontend performance. Part 1 - concatenation, compression, caching</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196518/">We write a server that does not fall under load</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196818/">Frontend performance. Part 2 - we cache dynamic content using etagify</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197166/">Taming Web Application Configurations with node-convict</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197370/">Frontend performance. Part 3 - font optimization</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197566/">Localization of Node.js Applications. Part 1</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198154/">Localization of Node.js Applications. Part 2: Toolkit and Process</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198252/">Localization of Node.js Applications. Part 3: Localization in Action</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198590/">Awsbox - PaaS infrastructure for deploying Node.js applications in the Amazon cloud</a> " </li></ol><br></div></div><br><br><hr><br>  In this article in the loop on Node.js, we will look at the node-convict module, which helps manage the configurations of Node.js applications.  It provides transparent default settings and built-in typing to make it easier to find and fix errors. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Formulation of the problem </h4><br>  There are two main problems that create the need for application configuration: <br><br><ul><li>  Most applications can work in several environments with different configuration options. </li><li>  Inclusion of credentials and other confidential information in the application code can create problems. </li></ul><br>  These problems can be solved by initializing some variables depending on the current environment and using environment variables to store sensitive data.  A common pattern in Node.js for implementing this approach is to create a module that exports the configuration: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conf = { <span class="hljs-comment"><span class="hljs-comment">//   - // "production", "development",  "test env: process.env.NODE_ENV || "development", // IP  ip: process.env.IP_ADDRESS || "127.0.0.1", //  port: process.env.PORT || 0, //   database: { host: process.env.DB_HOST || "localhost:8091" } }; module.exports = conf;</span></span></code> </pre> <br>  This works well, but there are a couple more problems: <br><br><ul><li>  What if the configuration contains incorrect data?  We can save time and nerves by detecting errors as early as possible. </li><li>  How easy is it for administrators, testers and other members of a large team to understand the configuration when they need to change settings or look for defects?  A more declarative and better documented format would make their lives easier. </li></ul><br><a name="habracut"></a><br><h4>  Introducing convict </h4><br>  <a href="https://github.com/lloyd/node-convict">node-convict</a> solves both of these problems by providing a configuration scheme in which you can specify type information, default values, environment variables, and documentation for each of the settings. <br><br>  Using convict, the example above takes the following form: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conf = convict({ <span class="hljs-attr"><span class="hljs-attr">env</span></span>: { <span class="hljs-attr"><span class="hljs-attr">doc</span></span>: <span class="hljs-string"><span class="hljs-string">"The applicaton environment."</span></span>, <span class="hljs-attr"><span class="hljs-attr">format</span></span>: [<span class="hljs-string"><span class="hljs-string">"production"</span></span>, <span class="hljs-string"><span class="hljs-string">"development"</span></span>, <span class="hljs-string"><span class="hljs-string">"test"</span></span>], <span class="hljs-attr"><span class="hljs-attr">default</span></span>: <span class="hljs-string"><span class="hljs-string">"development"</span></span>, <span class="hljs-attr"><span class="hljs-attr">env</span></span>: <span class="hljs-string"><span class="hljs-string">"NODE_ENV"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">ip</span></span>: { <span class="hljs-attr"><span class="hljs-attr">doc</span></span>: <span class="hljs-string"><span class="hljs-string">"The IP address to bind."</span></span>, <span class="hljs-attr"><span class="hljs-attr">format</span></span>: <span class="hljs-string"><span class="hljs-string">"ipaddress"</span></span>, <span class="hljs-attr"><span class="hljs-attr">default</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">env</span></span>: <span class="hljs-string"><span class="hljs-string">"IP_ADDRESS"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: { <span class="hljs-attr"><span class="hljs-attr">doc</span></span>: <span class="hljs-string"><span class="hljs-string">"The port to bind."</span></span>, <span class="hljs-attr"><span class="hljs-attr">format</span></span>: <span class="hljs-string"><span class="hljs-string">"port"</span></span>, <span class="hljs-attr"><span class="hljs-attr">default</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">env</span></span>: <span class="hljs-string"><span class="hljs-string">"PORT"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">database</span></span>: { <span class="hljs-attr"><span class="hljs-attr">host</span></span>: { <span class="hljs-attr"><span class="hljs-attr">default</span></span>: <span class="hljs-string"><span class="hljs-string">"localhost:8091"</span></span>, <span class="hljs-attr"><span class="hljs-attr">env</span></span>: <span class="hljs-string"><span class="hljs-string">"DB_HOST"</span></span> } } }); conf.validate(); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = conf;</code> </pre><br>  It contains almost the same information, but presented in the form of a diagram.  Due to this, it is more convenient for us to export it and display it in a readable form, to do validation.  The declarative format makes the application more reliable and more friendly to all team members. <br><br><h4>  How is the scheme </h4><br>  For each setting, there are four properties, each of which helps to make the application more reliable and easier to understand: <br><br><ol><li>  <b>Type</b>  The <code>format</code> property indicates either one of the built-in convict types ( <code>ipaddress</code> , <code>port</code> , <code>int</code> , etc.) or a function for validating user types.  If the parameter fails type checking during validation, an error occurs. </li><li>  <b>Default values</b>  Each parameter <i>must</i> have a default value. </li><li>  <b>Environment variables</b>  If the variable specified in <code>env,</code> set, then its value will be used instead of the default value. </li><li>  <b>Documentation</b>  The <code>doc</code> property is quite obvious.  The advantage of including the documentation in the schema before comments in the code is that this information is used in the <code>conf.toSchemaString()</code> method for more informative output. </li></ol><br><h4>  Additional configuration levels </h4><br>  Above the foundation of the default values, you can build additional configuration levels using the <code>conf.load()</code> and <code>conf.loadFile()</code> calls.  For example, you can load additional parameters from a JavaScript object for a specific environment: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conf = convict({ <span class="hljs-comment"><span class="hljs-comment">//   ,      }); if (conf.get('env') === 'production') { //          conf.load({ port: 8080, database: { host: "ec2-117-21-174-242.compute-1.amazonaws.com:8091" } }); } conf.validate(); module.exports = conf;</span></span></code> </pre><br>  Or you can create separate configuration files for each of the environments, and load them with <code>conf.loadFile()</code> : <br><br><pre> <code class="javascript hljs">conf.loadFile(<span class="hljs-string"><span class="hljs-string">'./config/'</span></span> + conf.get(<span class="hljs-string"><span class="hljs-string">'env'</span></span>) + <span class="hljs-string"><span class="hljs-string">'.json'</span></span>);</code> </pre><br>  <code>loadFile()</code> can also load several files at once if you pass an array of arguments: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// CONFIG_FILES=/path/to/production.json,/path/to/secrets.json,/path/to/sitespecific.json conf.loadFile(process.env.CONFIG_FILES.split(','));</span></span></code> </pre><br>  Loading additional parameters via <code>load()</code> and <code>loadFile()</code> is useful when there are settings for each of the environments that should not be set in the environment variables.  Separate declarative configuration files in JSON format allow you to more clearly present the differences between the parameters in different environments.  And since files are uploaded using <a href="https://github.com/kof/node-cjson">cjson</a> , they can contain comments, which makes them even more understandable. <br><br>  Note that environment variables have the highest priority, higher than the default settings and settings loaded via <code>load()</code> and <code>loadFile()</code> .  To check which settings are valid, you can call <code>conf.toString()</code> . <br><br><h4>  ‚ÄúV‚Äù means validation </h4><br>  After the settings are loaded, you can run a validation to check if they all have the correct format in accordance with the scheme.  There are several built-in formats in convict, such as <code>url</code> , <code>ports</code> or <code>ipaddress</code> , and you can also use built-in JavaScript constructors (for example, <code>Number</code> ).  If the <code>format</code> property is not specified, convict will check the type of the parameter to match the default value type (by calling <a href="http://perfectionkills.com/instanceof-considered-harmful-or-how-to-write-a-robust-isarray/">Object.prototype.toString.call</a> ).  The following three schemes are equivalent: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conf1 = convict({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: { <span class="hljs-attr"><span class="hljs-attr">format</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-string"><span class="hljs-string">'Brendan'</span></span> } }); <span class="hljs-comment"><span class="hljs-comment">//    , ,     //  ,      var conf2 = convict({ name: { default: 'Brendan' } }); //    var conf3 = convict({ name: 'Brendan' });</span></span></code> </pre><br>  The format can also be specified as an enumeration, by explicitly specifying a list of acceptable values, for example <code>["production", "development", "test"]</code> .  Any value that is not in the list will not pass validation. <br><br>  Instead of the built-in types, you can use your own validators.  For example, we want the parameter to be a string of 64 hexadecimal digits: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> check = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'validator'</span></span>).check; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conf = convict({ <span class="hljs-attr"><span class="hljs-attr">key</span></span>: { <span class="hljs-attr"><span class="hljs-attr">doc</span></span>: <span class="hljs-string"><span class="hljs-string">"API key"</span></span>, <span class="hljs-attr"><span class="hljs-attr">format</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">val</span></span></span><span class="hljs-function">) </span></span>{ check(val, <span class="hljs-string"><span class="hljs-string">'should be a 64 character hex key'</span></span>).regex(<span class="hljs-regexp"><span class="hljs-regexp">/^[a-fA-F0-9]{64}$/</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">default</span></span>: <span class="hljs-string"><span class="hljs-string">'3cec609c9bc601c047af917a544645c50caf8cd606806b4e0a23312441014deb'</span></span> } });</code> </pre><br>  A call to <code>conf.validate()</code> return detailed information about each erroneous setting, if any.  This helps to avoid redeploying the application when each configuration error is detected.  Here's what the error message will look like if we try to set the <code>key</code> parameter from the previous example to the value <code>'foo'</code> : <br><br><pre> <code class="javascript hljs">conf.set(<span class="hljs-string"><span class="hljs-string">'key'</span></span>, <span class="hljs-string"><span class="hljs-string">'foo'</span></span>); conf.validate(); <span class="hljs-comment"><span class="hljs-comment">// Error: key: should be a 64 character hex key: value was "foo"</span></span></code> </pre><br><h4>  Conclusion </h4><br>  node-convict extends the standard Node.js application configuration template, making it more reliable and convenient for team members who don‚Äôt have to figure out the wilds of imperative code to check or change settings.  The configuration scheme gives the project team more context for each setting and allows you to do validation for early detection of errors in the configuration. <br><br><hr><br><div class="spoiler">  <b class="spoiler_title">All articles of the cycle:</b> <div class="spoiler_text"><ol><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/195494/">Hunting for memory leaks in Node.js</a> " </li><li>  "We <a href="http://habrahabr.ru/company/nordavind/blog/195686/">load Node to the eyeballs</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196018/">Store the session on the client to simplify application scaling</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196358/">Frontend performance. Part 1 - concatenation, compression, caching</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196518/">We write a server that does not fall under load</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196818/">Frontend performance. Part 2 - we cache dynamic content using etagify</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197166/">Taming Web Application Configurations with node-convict</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197370/">Frontend performance. Part 3 - font optimization</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197566/">Localization of Node.js Applications. Part 1</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198154/">Localization of Node.js Applications. Part 2: Toolkit and Process</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198252/">Localization of Node.js Applications. Part 3: Localization in Action</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198590/">Awsbox - PaaS infrastructure for deploying Node.js applications in the Amazon cloud</a> " </li></ol><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/197166/">https://habr.com/ru/post/197166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197154/index.html">CentOS 6.x 64 and Squid with authorization from Win2008AD</a></li>
<li><a href="../197158/index.html">About structuring and automation</a></li>
<li><a href="../197160/index.html">History of Apple operating systems. Part 3. Generation NeXT</a></li>
<li><a href="../197162/index.html">PVS-Studio now works without a Visual Studio or C ++ Builder environment - we check preprocessed files for anything</a></li>
<li><a href="../197164/index.html">Six puzzles in C ++</a></li>
<li><a href="../197172/index.html">Review of the new Kindle Paperwhite (2013)</a></li>
<li><a href="../197178/index.html">How the attackers used the site as an advertising platform and how I fought it</a></li>
<li><a href="../197180/index.html">The future of man and computer: the next 10 years</a></li>
<li><a href="../197184/index.html">Why we do not test. Practice conducting a technical interview</a></li>
<li><a href="../197190/index.html">On bare iron ... VMM 2012 R2 features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>