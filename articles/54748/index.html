<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Combining bandwidth of two Internet channels and simple fault tolerance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have my own home network, with a linux server, and it is connected to the Internet via a wireless connection - on the roof of the antenna and the ro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Combining bandwidth of two Internet channels and simple fault tolerance</h1><div class="post__text post__text-html js-mediator-article"> I have my own home network, with a linux server, and it is connected to the Internet via a wireless connection - on the roof of the antenna and the router, connected to the server with a twisted pair.  All in general is not bad, the channel with a guaranteed band in both directions, a permanent IP address, quite reliable - rarely falls.  But here he has one drawback - the price bites. <br>  The pricing policy of the provider is built in such a way that in order to double the speed - you also need to pay twice as much.  And I want more speed!  And reliability too - as it became ‚Äúcold‚Äù during a strong frost and the Internet was not available in the evening and at night. <br>  Therefore, I decided to conduct a second Internet channel home, chose one known provider in Ukraine, which provides access via ADSL.  He and cheap rates and ADSL modem is inexpensive.  So I did, connected, stuck the ADLS switch modem - everything works.  But I didn‚Äôt want to refuse the good old wireless channel, so I decided to make the Internet traffic go straight on both channels, so that I could use the total bandwidth.  Yes, and so that when one channel falls, it takes the other load on itself. <br><br><a name="habracut"></a><br><br>  After searching on the Internet, I found out that there are at least two solutions: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      - at the firewall level, scatter TCP sessions across different interfaces.  Disadvantages - sites that have session binding to an IP address will stop working, since consecutive requests from one user may come through different channels and from different IP. <br>  - at the routing level, scatter routes through different interfaces.  Problems of the first solution will not be, since the routes are cached and subsequent calls to the same address will go through the same interface.  But balancing will not be as accurate, and downloading from one server even in several streams will not be able to achieve the total speed of the two channels. <br><br>  I chose for myself balancing with routing, since the stable operation of all sites was very important to me, well, this functionality was already in my core, and the firewall would have to be patched. <br><br>  So let's get started! <br><br>  First, we define the variables: <br>  $ cat / etc / balance / vars <br><br><blockquote><ol><li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li></li><li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li></li><li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li></li><li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li></li><li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li></li><li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li></li><li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li></li><li></li><li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li></li><li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> <li> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font> <br></code></code> </li> </ol></blockquote> <code><code>#!/bin/bash # LAN <font color="#0000ff">interface</font> IF0= <font color="#A31515">"eth1"</font> # WAN <font color="#0000ff">interface</font> 1 IF1= <font color="#A31515">"eth0"</font> # WAN <font color="#0000ff">interface</font> 2 IF2= <font color="#A31515">"ppp0"</font> IP1= <font color="#A31515">"194.9.xx.xx"</font> IP2= <font color="#A31515">"`ip addr show $IF2 | grep inet | awk '{print $2}'`"</font> # gateway 1 P1= <font color="#A31515">"194.9.xx.xx"</font> # gateway 2 P2= <font color="#A31515">"195.5.xx.xx"</font> # LAN netmask P0_NET= <font color="#A31515">"192.168.0.0/24"</font> # WAN1 netmask P1_NET= <font color="#A31515">"194.9.xx.xx/xx"</font> # WAN2 netmask P2_NET= <font color="#A31515">"195.5.xx.xx/xx"</font> TBL1= <font color="#A31515">"provider1"</font> TBL2= <font color="#A31515">"provider2"</font> # Realtive weight of channels bandwidth W1= <font color="#A31515">"2"</font> W2= <font color="#A31515">"1"</font></code> <br></code> <br><br>  Add two additional routing tables to the / etc / iproute2 / rt_tables file: <br> <code>echo "1 provider1" &gt;&gt; /etc/iproute2/rt_tables <br> echo "2 provider2" &gt;&gt; /etc/iproute2/rt_tables <br></code> <br><br>  Now we will write a script that will prescribe all the necessary routes and firewall rules: <br><br>  cat /etc/balance/routing.sh <br><br><blockquote><ol><li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li></li><li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li></li><li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li></li><li></li><li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li></li><li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li></li><li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li></li><li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li></li><li></li><li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li></li><li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> <li> <code><code>#!/bin/bash . /etc/balance/vars echo <font color="#A31515">"1"</font> &gt; /proc/sys/net/ipv4/ip_forward ip route add $P1_NET dev $IF1 src $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add <font color="#0000ff">default</font> via $P2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET dev $IF1 src $IP1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET dev $IF2 src $IP2 ip route add <font color="#0000ff">default</font> via $P1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP1 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip rule add <font color="#0000ff">from</font> $IP2 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P2_NET   dev $IF2 table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL1 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P0_NET   dev $IF0 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add $P1_NET   dev $IF1 table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 ip route add 127.0.0.0/8 dev lo  table $TBL2 &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -s $P0_NET -o $IF1 -j MASQUERADE iptables -t nat -A POSTROUTING -s $P0_NET -o $IF2 -j MASQUERADE</code></code> </li> </ol></blockquote><br><br>  This command set provides response routing through the interface on which the request was received, as well as masquerading on both interfaces. <br><br>  Now we will write a script that will determine if a particular channel is working and change the default gateway entries accordingly. <br><br>  $ cat /etc/balance/check.sh <br><br><blockquote><ol><li>  #! / bin / bash </li><li></li><li>  .  / etc / balance / vars </li><li></li><li>  OLDIF1 = 0 </li><li>  OLDIF2 = 0 </li><li></li><li>  .  /etc/balance/routing.sh </li><li>  <font color="#0000ff">while</font> <font color="#0000ff">true</font> ;  <font color="#0000ff">do</font> </li><li></li><li></li><li>  ping -c 3 -s 100 $ P1 -I $ IF1&gt; / dev / <font color="#0000ff">null</font> </li><li>  <font color="#0000ff">if</font> [$?  -ne 0];  then </li><li>  echo <font color="#A31515">"Failed IF1!"</font> </li><li>  NEWIF1 = 0 </li><li>  <font color="#0000ff">else</font> </li><li>  NEWIF1 = 1 </li><li>  fi </li><li></li><li>  ping -c 3 -s 100 $ P2 -I $ IF2&gt; / dev / <font color="#0000ff">null</font> </li><li>  <font color="#0000ff">if</font> [$?  -ne 0];  then </li><li>  echo <font color="#A31515">"Failed IF2!"</font> </li><li>  NEWIF2 = 0 </li><li>  <font color="#0000ff">else</font> </li><li>  NEWIF2 = 1 </li><li>  fi </li><li></li><li>  <font color="#0000ff">if</font> ((($ NEWIF1! = $ OLDIF1) || ($ NEWIF2! = $ OLDIF2)));  then </li><li>  echo <font color="#A31515">"Changing routes"</font> </li><li></li><li>  <font color="#0000ff">if</font> ((($ NEWIF1 == 1) &amp;&amp; ($ NEWIF2 == 1)));  then </li><li>  echo <font color="#A31515">"Both channels"</font> </li><li>  ip route delete <font color="#0000ff">default</font> </li><li>  ip route add <font color="#0000ff">default</font> scope global nexthop via $ P1 dev $ IF1 weight $ W1 \ </li><li>  nexthop via $ P2 dev $ IF2 weight $ W2 </li><li>  elif ((($ NEWIF1 == 1) &amp;&amp; ($ NEWIF2 == 0)));  then </li><li>  echo <font color="#A31515">"First channel"</font> </li><li>  ip route delete <font color="#0000ff">default</font> </li><li>  ip route add <font color="#0000ff">default</font> via $ P1 dev $ IF1 </li><li>  elif ((($ NEWIF1 == 0) &amp;&amp; ($ NEWIF2 == 1)));  then </li><li>  echo <font color="#A31515">"Second channel"</font> </li><li>  ip route delete <font color="#0000ff">default</font> </li><li>  ip route add <font color="#0000ff">default</font> via $ P2 dev $ IF2 </li><li>  fi </li><li></li><li>  <font color="#0000ff">else</font> </li><li>  echo <font color="#A31515">"Not changed"</font> </li><li>  fi </li><li></li><li>  OLDIF1 = $ NEWIF1 </li><li>  OLDIF2 = $ NEWIF2 </li><li>  sleep 3 </li><li>  done </li></ol></blockquote><br><br>  We check the work of the channel by pinging the gateway, and if there is no answer to 3 pings in a row, we consider that the channel has fallen, and accordingly exclude it from the routing table. <br><br>  Thus, if both channels work: <br><br>  $ ip route <br> <code>195.5.xx.xx dev ppp0 proto kernel scope link src 95.133.xx.xx <br> 194.9.xx.xx/xx dev eth0 proto kernel scope link src 194.9.xx.xx <br> 192.168.0.0/24 dev eth1 proto kernel scope link src 192.168.0.75 <br> default <br> nexthop via 194.9.xx.xx dev eth0 weight 2 <br> nexthop via 195.5.xx.xx dev ppp0 weight 1 <br></code> <br><br>  Total we have two default gw, the first with a weight of 2 and the second with a weight of 1. Ie through the first channel will go twice as much traffic than through the second. <br><br>  In order to customize these scripts for your needs, you need to adjust the values ‚Äã‚Äãin the vars file, the other scripts practically do not require any configuration. </div><p>Source: <a href="https://habr.com/ru/post/54748/">https://habr.com/ru/post/54748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../54735/index.html">Openssh. Installation</a></li>
<li><a href="../54736/index.html">Symantec Backup Exec System Recovery. Basic setting</a></li>
<li><a href="../54738/index.html">The results of the tender "Classmates"</a></li>
<li><a href="../5474/index.html">What makes Habra.</a></li>
<li><a href="../54747/index.html">Apple's iPhone OS 3.0 Preview Event</a></li>
<li><a href="../5475/index.html">Top10 game girls</a></li>
<li><a href="../54751/index.html">Asterisk - Enterprise Computer Telephony System</a></li>
<li><a href="../54753/index.html">Nuclear error</a></li>
<li><a href="../54757/index.html">Constructor Theme for Wordpress</a></li>
<li><a href="../54762/index.html">C ++ Pattern Specialization Tricks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>