<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple export to Excel XLSX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the topic begun in the previous article , I want to share my experience in data export, in particular, in the XLSX format. 



 So,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple export to Excel XLSX</h1><div class="post__text post__text-html js-mediator-article">  In continuation of the topic begun in the <a href="http://habrahabr.ru/post/235973/">previous article</a> , I want to share my experience in data export, in particular, in the XLSX format. <br><br><img src="https://habrastorage.org/files/62f/b08/c3a/62fb08c3a71b40c4bb2da88dc75c6065.png"><br><br>  So, who cares how to fill out <a href="http://msdn.microsoft.com/en-us/library/aa338205(v%3Doffice.12).aspx">XLSX</a> without large and complex libraries, please under the cat. <br><a name="habracut"></a><br>  Recently, I faced the task of exporting an unpredictable amount of tabular data in XLSX format.  Like any sensible programmer, first of all it is useful to look for ready-made solutions. <br>  Almost immediately stumbled upon the <a href="https://github.com/PHPOffice/PHPExcel">PHPExcel</a> library.  A powerful solution, with a bunch of different functions and features.  Rummaging a little more found reviews of programmers about it.  In particular, the forums have complaints about the speed and failure to work with a large amount of data.  Marked the library as one of the solutions and began to look further. <br>  I found some more libraries for working with XLSX, but they were all either forgotten, because  they were not updated for 2-3 years, or they were necessarily drafted by third-party libraries, or they used <a href="https://ru.wikipedia.org/wiki/Document_Object_Model">DOM</a> to work with files, which I didn‚Äôt really like.  Each time, bumping into the next library and studying the mechanisms of its work, I caught myself thinking that all this was ‚Äúfrom a cannon on a sparrow.‚Äù  I do not need such a difficult decision! <br>  I admit honestly, having studied superficially each of the solutions found, did not install and test one.  I needed a simpler and more reliable solution like a tank. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Task </h4><br>  In general, since I did not find anything suitable, then it is necessary to formulate technical requirements for what is needed.  The requirements, as expected, turned out to be trivial: <br><ul><li>  Arrange the export mechanism as a standalone class. </li><li>  Implement a set of functions in a class for writing cell values ‚Äã‚Äãand a number of </li><li>  Ability to work with unlimited data </li><li>  Unpacking and packing XLSX. </li></ul><br>  Separately dwell only on the last paragraph.  As you know, XLSX is a regular <a href="https://ru.wikipedia.org/wiki/ZIP">zip</a> archive that you can unpack and see that it consists of several files and directories.  Inversely, it can be packaged and renamed to XLSX.  If all changes are correct, then Microsoft Excel will open the file without problems. <br><br><h4>  Implementation </h4><br>  Initially, I really wanted to create all the files that make up XLSX, code, but, fortunately, I quickly realized the meaninglessness of my idea.  And a different, more correct and simple solution was born.  Using Microsoft Excel, you need to create an XLSX file in the form in which it is needed in the end, but without data, in other words, a template, and then, using code, just add data! <br>  In this case, the class will have to unpack the template in a separate directory, make changes to /xl/worksheets/sheet1.xml and package the contents of the directory back to XLSX. <br><br>  The class declaration contains public variables: <br>  <i>$ templateFile</i> - <i>template</i> file name <br>  <i>$ exportDir</i> is the folder into which the template will be unpacked, of course, with the necessary access rights. <br><br>  The class constructor takes the name of the future file, the number of columns and rows.  Then it checks that the file name is correct, the folder for unpacking the template exists and forms the full name of the final folder for unpacking the template. <br>  After creating the class, you can unpack the template and open it on the sheet1.xml record.  In fact, I do not just append to the file, but completely overwrite it.  Once I took an initial line from it, I made a change in it in the dimension tag, which reflects the size of the exported range, and write it to a file. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">openWriter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_dir(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;baseDir)) CFileHelper::removeDirectory(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;baseDir); mkdir(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;baseDir); exec(<span class="hljs-string"><span class="hljs-string">"unzip $this-&gt;templateFullFilename -d \"$this-&gt;baseDir\""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;workSheetHandler = fopen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;baseDir.<span class="hljs-string"><span class="hljs-string">'/xl/worksheets/sheet1.xml'</span></span>, <span class="hljs-string"><span class="hljs-string">'w+'</span></span>); fwrite(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;workSheetHandler, <span class="hljs-string"><span class="hljs-string">'&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;&lt;worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"&gt;&lt;dimension ref="A1:'</span></span>.chr(<span class="hljs-number"><span class="hljs-number">64</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;colCount).<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rowCount.<span class="hljs-string"><span class="hljs-string">'"/&gt;&lt;sheetData&gt;'</span></span>); }</code> </pre> <br><br>  The resetRow and flushRow functions ensure the speed of work and the ability to work with large amounts of data.  They are responsible for clearing the current row in memory and writing the current row to disk. <br>  But the preservation of the values ‚Äã‚Äãof cells with different types was not such a simple task. <br><br><h5>  Line entry </h5><br>  It would seem difficult to write a string value to a file.  However, XLSX is not so simple.  All strings inside XLSX are stored in a separate /xl/sharedStrings.xml file.  Cells are not written string values, and their ordinal numbers - indices.  A sensible solution in terms of reducing file size. <br><br>  But this solution is inconvenient from the point of view of the program filling the template.  If we fulfill this requirement, then I would have to perform a separate pass through all string values ‚Äã‚Äãin the data array, exclude duplicate values, save them in sharedStrings.xml, index them, and enter their indices instead of values ‚Äã‚Äãin the original array.  Slow and uncomfortable. <br><br>  It turns out that you can bypass the requirement and store the string values ‚Äã‚Äãof the cells directly in the cells.  But in this case the recording format will be different: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">appendCellString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;curCel++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($value)) { $value = htmlspecialchars($value, ENT_QUOTES, <span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>); $value = preg_replace( <span class="hljs-string"><span class="hljs-string">'/[\x00-\x13]/'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, $value ); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;currentRow[] = <span class="hljs-string"><span class="hljs-string">'&lt;cr="'</span></span>.chr(<span class="hljs-number"><span class="hljs-number">64</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;curCel).<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;numRows.<span class="hljs-string"><span class="hljs-string">'" t="inlineStr"'</span></span>.(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isBold ? <span class="hljs-string"><span class="hljs-string">' s="7"'</span></span> : <span class="hljs-string"><span class="hljs-string">''</span></span>).<span class="hljs-string"><span class="hljs-string">'&gt;&lt;is&gt;&lt;t&gt;'</span></span>.$value.<span class="hljs-string"><span class="hljs-string">'&lt;/t&gt;&lt;/is&gt;&lt;/c&gt;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;numStrings++; } }</code> </pre><br><br><h5>  Record number </h5><br>  There were no difficulties with writing integers or fractional numbers.  It's simple: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">appendCellNum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;curCel++; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;currentRow[] = <span class="hljs-string"><span class="hljs-string">'&lt;cr="'</span></span>.chr(<span class="hljs-number"><span class="hljs-number">64</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;curCel).<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;numRows.<span class="hljs-string"><span class="hljs-string">'"&gt;&lt;v&gt;'</span></span>.$value.<span class="hljs-string"><span class="hljs-string">'&lt;/v&gt;&lt;/c&gt;'</span></span>; }</code> </pre><br><br><h5>  Record date and time </h5><br>  Date and time are stored as the number of seconds past since January 1, 1970, divided by the number of seconds in a day.  Moreover, in the calculation made a mistake with the definition of a leap year.  In general, without going into details that are easy to find on the network, in order to correctly calculate the date, we had to declare two constants in the class: <br>  <i>ZERO_TIMESTAMP</i> - date offset in Excel format from UNIX_TIMESTAMP <br>  <i>SEC_IN_DAY</i> - seconds in days. <br>  After calculating the date and time value, the integer part of the fraction is the date, the fractional part is the time: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ZERO_TIMESTAMP = <span class="hljs-number"><span class="hljs-number">2209161600</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SEC_IN_DAY = <span class="hljs-number"><span class="hljs-number">86400</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">appendCellDateTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;curCel++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($value)) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;appendCellString(<span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $dt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime($value); $ts = $dt-&gt;getTimestamp() + <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ZERO_TIMESTAMP; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;currentRow[] = <span class="hljs-string"><span class="hljs-string">'&lt;cr="'</span></span>.chr(<span class="hljs-number"><span class="hljs-number">64</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;curCel).<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;numRows.<span class="hljs-string"><span class="hljs-string">'" s="1"&gt;&lt;v&gt;'</span></span>.$ts/<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SEC_IN_DAY.<span class="hljs-string"><span class="hljs-string">'&lt;/v&gt;&lt;/c&gt;'</span></span>; } }</code> </pre><br>  After recording all the data, it remains to close the worksheet and the workbook. <br><br><h4>  Application </h4><br>  As before, the use of the described class is based on the export of data using the <a href="http://www.yiiframework.com/doc/api/1.1/CArrayDataProvider">CArrayDataProvider</a> provider.  Assuming that the volume of exported data can be very large, a special iterator <a href="http://www.yiiframework.com/doc/api/1.1/CDataProviderIterator">CDataProviderIterator is used</a> , which <a href="http://www.yiiframework.com/doc/api/1.1/CDataProviderIterator">iterates</a> over the returned data by 100 records (you can specify a different number of records). <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exportXLSX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($organization, $user, &amp;$filename)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_provider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CArrayDataProvider(<span class="hljs-comment"><span class="hljs-comment">/*query*/</span></span>); Yii::import(<span class="hljs-string"><span class="hljs-string">'ext.AlxdExportXLSX.AlxdExportXLSX'</span></span>); $export = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AlxdExportXLSX($filename, count(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_attributes), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_provider-&gt;getTotalItemCount() + <span class="hljs-number"><span class="hljs-number">1</span></span>); $export-&gt;openWriter(); $export-&gt;resetRow(); $export-&gt;openRow(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_attributes <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $code =&gt; $format) $export-&gt;appendCellString(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_objectref-&gt;getAttributeLabel($code)); $export-&gt;closeRow(); $export-&gt;flushRow(); $rows = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CDataProviderIterator(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_provider, <span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($rows <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { $export-&gt;resetRow(); $export-&gt;openRow(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_attributes <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $code =&gt; $format) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($format-&gt;type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'Num'</span></span>: $export-&gt;appendCellNum($row[$code]); <span class="hljs-comment"><span class="hljs-comment">/*other types*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: $export-&gt;appendCellString(<span class="hljs-string"><span class="hljs-string">''</span></span>); } } $export-&gt;closeRow(); $export-&gt;flushRow(); } $export-&gt;closeWriter(); $export-&gt;zip(); $filename = $export-&gt;getZipFullFileName(); }</code> </pre><br>  Anyone interested, can get the source code of my class <a href="https://github.com/Alxdhere/AlxdExportXLSX">AlxdExportXLSX</a> completely free of charge. </div><p>Source: <a href="https://habr.com/ru/post/236107/">https://habr.com/ru/post/236107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236091/index.html">My contribution to copterostroenie</a></li>
<li><a href="../236093/index.html">New cloud service from IBM!</a></li>
<li><a href="../236095/index.html">Electronic money in Russia: a comparison of the financial success of market players</a></li>
<li><a href="../236103/index.html">Integrated IT Infrastructure for SMB</a></li>
<li><a href="../236105/index.html">Opera 24 - you can not execute mercy</a></li>
<li><a href="../236109/index.html">Results of the meeting of the NASA special committee: Curiosity will travel less, drill more, 7 "alien" missions are extended</a></li>
<li><a href="../236111/index.html">Harmless advice from an electronic freelancer. What is our brother doing today and is there light at the end of the tunnel?</a></li>
<li><a href="../236113/index.html">Response Policy Zones (RPZ) on guard network</a></li>
<li><a href="../236115/index.html">Internet of things is coming</a></li>
<li><a href="../236119/index.html">Impressions of visiting EuroPython 2014</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>