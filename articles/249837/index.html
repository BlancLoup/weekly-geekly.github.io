<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage Remote IIS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Some time ago I was given the task of finding the best way to programmatically control a remote IIS and implement it as a kind of modul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage Remote IIS</h1><div class="post__text post__text-html js-mediator-article"><h1>  Introduction </h1><br>  Some time ago I was given the task of finding the best way to programmatically control a remote <acronym>IIS</acronym> and implement it as a kind of module.  The task is interesting, with many difficulties, so I want to share my experience. <br><br>  Here is a list of basic requirements for the implemented module: <br><ul><li>  The ability to perform basic operations with <acronym>IIS</acronym> : <br><ul><li>  site creation </li><li>  create virtual application </li><li>  create virtual directory </li><li>  configure bindings for sites, including the installation of <acronym>SSL</acronym> certificates </li><li>  creating application pools with fine tuning </li></ul></li><li>  Support for parallel work with multiple <acronym>IIS</acronym> on different servers in the farm </li><li>  Support for <acronym>IIS</acronym> version 8.0 (earlier versions do not need to be supported). </li></ul><br>  In a word, the module should have been able to do almost everything that can be done through the <acronym>IIS Manager</acronym> . <br><a name="habracut"></a><br>  I found and researched three tools that are suitable for solving problems: <br><ol><li>  <a href="https://technet.microsoft.com/en-us/library/jj635848.aspx">Windows Management Instrumentation (WMI)</a> </li><li>  <a href="https://msdn.microsoft.com/en-us/library/ms228060(v%3Dvs.140).aspx">ASP.NET Configuration API</a> </li><li>  <a href="http://www.iis.net/learn/manage/provisioning-and-managing-iis/microsoftwebadministration">Microsoft Web Administration</a> </li></ol><br>  After creating test applications with each of the options considered, I chose Microsoft.Web.Administration as the most promising. <br><br>  I refused the first option, because it is rather difficult to understand the methods of the tool, which increases the chance of error.  At the same time, working with it resembles working with COM components. <br>  An example of creating a site using WMI: <br><pre><code class="cs hljs">DirectoryEntry IIS = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectoryEntry(<span class="hljs-string"><span class="hljs-string">"IIS://localhost/W3SVC"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] bindings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] { <span class="hljs-string"><span class="hljs-string">"127.0.0.1:4000:"</span></span>, <span class="hljs-string"><span class="hljs-string">":8000:"</span></span> }; IIS.Invoke(<span class="hljs-string"><span class="hljs-string">"CreateNewSite"</span></span>, <span class="hljs-string"><span class="hljs-string">"TestSite"</span></span>, bindings, <span class="hljs-string"><span class="hljs-string">"C:\\InetPub\\WWWRoot"</span></span>);</code> </pre> <br>  The second option is to work with XML configuration files.  That is, it was supposed to almost manually change the root web.config file on the web servers.  As you know, this option did not suit me either. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The third option allowed to create sites, doing all the low-level work for the developer.  An additional advantage of this tool is that <acronym>IIS Manager</acronym> uses this particular library to perform all available operations. <br><br>  Of course, there were difficulties in implementing the solution.  I spent a lot of Google hours to get this Microsoft.Web.Administration to work as I wanted.  On the Internet, you can find a lot of information on how to work with this library, what you can do with it, etc.  However, all this information is heavily scattered in various articles.  This prompted me to write about my experience of ‚Äúdiving into the world of pitfalls‚Äù Microsoft.Web.Administration.  I tried to collect in it all the problems that I encountered and their solutions.  Suddenly someone come in handy. <br><br>  So, let's start the technical part. <br><br><h1>  System configuration </h1><br>  We have a farm of web servers, each of which is managed by Windows Server 2012 Standard with <acronym>IIS</acronym> 8.0.  There is a separate Application server running Windows service that uses our module.  <acronym>IIS is</acronym> not deployed on this server.  We need to manage web servers from the Application server. <br><img src="https://habrastorage.org/files/258/9cf/e59/2589cfe590394b71b8f01af6b3cfc017.jpg"><br><br><h1>  Development </h1><br><h2>  Connecting Microsoft.Web.Administration </h2><br>  The first problems appeared immediately at the library testing stage.  I connected it to the project, wrote the code that was supposed to create the site and received an access error Exception from HRESULT: 0x80070005 (E_ACCESSDENIED).  As it turned out after reading a series of descriptions of a similar problem (for example, <a href="http://stackoverflow.com/questions/8963641/permissions-required-to-use-microsoft-web-administration">stackoverflow.com/questions/8963641/permissions-required-to-use-microsoft-web-administration</a> ), Microsoft.Web.Administration requires root access to access the root web.config file. . <br><br>  Well, we create the user on a remote server with login and the password.  We create the same user on the local computer with the same login and password (this is important, otherwise the application will not log in to the remote machine).  We start.  Same problem! <br><br>  We study the problem of access in more detail.  It turns out that it is not enough to create a user with administrator rights.  After all, starting with Windows Vista, the UAC system appeared.  And even the computer administrator, in the understanding of this system, is not an administrator at all, but a user with extended rights.  It turns out that in order for our application to work, you need to disable UAC on the remote server.  However, disabling UAC through Windows Administration is not enough, since  the problem remains.  It is necessary to <a href="http://fastvista.ru/content/view/168/">completely disable UAC</a> .  I did this through the registry, as described in the article on the link.  Yes, I agree, it is not safe.  But this is the only solution.  Fortunately, the customer agrees. <br><br>  We try to run our application.  Eureka!  The site is created.  So you can move on. <br>  After the application was deployed on the test server, the second configuration problem manifested itself: the module could not find the Microsoft.Web.Administration library and crashed.  It turned out that the GAC on the server was building a different version.  To cope with this difficulty, it was decided to include copying the desired library in the Bin project. <br><br>  The latter difficulty associated with connecting the library also arose because of the versioning of the builds.  At the active development stage, libraries with versions 7.0.0.0 and 7.5.0.0 were found. The second one simplified the implementation of some non-trivial things, for example, the installation of AlwaysRunning for the application pool.  So I plugged it in first.  But after uploading to the test server, the application fell again.  It turns out that Microsoft.Web.Administration 7.5.0.0 only works with <acronym>IIS Express</acronym> .  Therefore, if you plan to manage a full <acronym>IIS</acronym> , use version 7.0.0.0. <br><br>  These were the main problems with the connection of the Microsoft.Web.Administration library and its preparation for solving the set tasks.  Ahead was the implementation of functionality according to customer requirements.  About them it goes on. <br><br><h2>  Implementation of requirements </h2><br>  Among the methods that I implemented in the module, there are both banal and those over which I had to break my head.  I will not describe those things that can be easily found on the Internet, and everything that is already clear from the names of the methods of the Microsoft.Web.Administration library, for example, the creation of a web site and buyings for it.  Instead, I will focus on the problems that I had to think about and for which it was difficult to find a solution on the Internet (or could not do it at all). <br><br><h2>  Multithreading and multitasking </h2><br>  According to the module requirements, it was necessary to provide for the possibility of parallel creation of several web sites on one or several remote servers.  In this case, two threads cannot control one remote <acronym>IIS</acronym> , since  in fact, this means changing the same root web.config file.  Therefore, it was decided to make Lock threads on the name of the web server.  This is done as follows: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ServerManager _server; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; LockersByServerName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Locker { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LockersByServerName.GetOrAdd(ServerName, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>()); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConnectAndProcess</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action handler, CancellationToken token</span></span></span><span class="hljs-function">)</span></span> { token.ThrowIfCancellationRequested(); <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Locker) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _server = ServerManager.OpenRemote(ServerName); token.ThrowIfCancellationRequested(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { handler(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FileLoadException) { <span class="hljs-comment"><span class="hljs-comment">// try again token.ThrowIfCancellationRequested(); if (_server != null) _server.Dispose(); _server = ServerManager.OpenRemote(ServerName); token.ThrowIfCancellationRequested(); handler(); } } finally { if(_server != null) _server.Dispose(); _server = null; } } }</span></span></code> </pre><br>  In this example, ServerName is the NetBIOS name of the computer on the local network. <br><br>  Each method of the developed module is wrapped in a given handler.  For example, checking the existence of a web site: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WebSiteExists</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, CancellationToken token</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ConnectAndGetValue(() =&gt; { Site site = _server.Sites[name]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> site != <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }, token); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TValue ConnectAndGetValue&lt;TValue&gt;(Func&lt;TValue&gt; func, CancellationToken token) { TValue result = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(TValue); ConnectAndProcess(() =&gt; { result = func(); }, token); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br>  Why do we reconnect to the server every time? <br>  Firstly, the system, within which the creation of this module was carried out, is freely configurable.  Therefore, we do not know in advance what methods will be called, in what order and for how long an instance of the module class will be needed (let's call it MWAConnector). <br>  Secondly, the connector may need another thread.  And if we openly connect one connector, then we cannot allow the connection of the second, because  otherwise, there will be an error of parallel access to the file for editing. <br>  For these reasons, the code holds one instance of the MWAConnector class for several operations, each of which will be performed in the independent context of a separate connection. <br>  The disadvantage of this approach is the cost of creating connections.  It was decided to neglect these costs, since  they are not a bottleneck of the module: direct execution of the operation takes several times more CPU time than creating a connection. <br><br><h2>  Installing AlwaysRunning </h2><br>  One of the tasks was to create an application pool with the AlwaysRunning flag.  In the properties of the ApplicationPool class from the Microsoft.Web.Administration 7.0.0.0 library, you can find a lot: AutoStart, Enable32BitAppOnWin64, ManagedRuntimeVersion, QueueLength.  But there is no runningmode.  In the version 7.5.0.0 build, this property is there, but, as noted above, this version only works with <acronym>IIS Express</acronym> . <br>  The solution to the problem was found.  This is done like this: <br><pre> <code class="cs hljs">ApplicationPool pool = _server.ApplicationPools.Add(name); <span class="hljs-comment"><span class="hljs-comment">//some code to set pool properties if (alwaysRunning) { pool["startMode"] = "AlwaysRunning"; }</span></span></code> </pre><br>  To save changes, call CommitChanges (). <br><pre> <code class="cs hljs">_server.CommitChanges();</code> </pre><br><h2>  Installing PreloadEnabled </h2><br>  Another problem I encountered was the lack of a built-in property for setting the PreloadEnabled flag for web applications and the site.  This flag is responsible for reducing the time of initial loading of the site after the restart.  It is useful when the site is ‚Äúwarming up‚Äù for a long time.  And some of the sites being developed by the customer are just like that. <br>  As a solution, I will give a snippet of code that creates a web application for the site: <br><pre> <code class="cs hljs">Site site = _server.Sites[siteName]; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> path = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"/{0}"</span></span>, applicationName); Application app = site.Applications.Add(path, physicalPath); app.ApplicationPoolName = applicationPoolName; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preload) app.SetAttributeValue(<span class="hljs-string"><span class="hljs-string">"preloadEnabled"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); _server.CommitChanges();</code> </pre><br>  Note that the name of the web application must begin with ‚Äú/‚Äù.  This is necessary because  otherwise, there will be an error in the method of receiving, creating or deleting the application. <br><br><h2>  Change site settings like a web application </h2><br>  Sometimes it becomes necessary to change the application pool for the site itself.  The problem is that there is no such property in the Site class.  It can only be found on an instance of the Application class. <br>  The solution is to get the web site application: <br><pre> <code class="cs hljs">Site site = _server.Sites[siteName]; Application app = site.Applications[<span class="hljs-string"><span class="hljs-string">"/"</span></span>];</code> </pre><br><br><h2>  Deleting a site </h2><br>  Deleting a site would seem to be a simple task, and it suffices to call _server.Sites.Remove (site).  However, a problem has recently arisen when deleting a site that has https banding.  The fact is that Microsoft.Web.Administration deletes the site, deletes the information about the links, which is logical.  At the same time, the library also deletes the IP: port: SSL correspondence entry in the system log.  Thus, if several sites have bandings using the same certificate, then if you delete any of these sites, all the rest lose the binding and certificate. <br><br>  The latest Microsoft.Web.Administration library contains a method for deleting banding, which takes the second parameter to flag the need to remove an entry from the system config.  Therefore, the solution to the problem is as follows: <br><pre> <code class="cs hljs">Site site = _server.Sites[name]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (site == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bindings = site.Bindings.ToList(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Binding binding <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bindings) { site.Bindings.Remove(binding, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } _server.Sites.Remove(site); _server.CommitChanges();</code> </pre><br><h1>  Conclusion </h1><br>  Currently, this module successfully copes with its tasks and works in production.  With its help, dozens of sites, web applications, pools, virtual directories are created every week. <br><br>  I gave the main problems I encountered while working on the module, and the solutions I found.  I hope this material will be useful to someone.  If anyone has any questions or suggestions, ask - I will try to answer. </div><p>Source: <a href="https://habr.com/ru/post/249837/">https://habr.com/ru/post/249837/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249811/index.html">Arduino Pro Mini + current sensor GY-712 monitor the burnout of lamps</a></li>
<li><a href="../249817/index.html">A terrible bug in the Portland Group C ++ compiler</a></li>
<li><a href="../249819/index.html">Proper handling of XAML resources</a></li>
<li><a href="../249825/index.html">Jammer: we suppress GSM, 3G, 4G, WiMAX, Yota</a></li>
<li><a href="../249831/index.html">Bookmark syncing is already in Opera 28 beta</a></li>
<li><a href="../249839/index.html">Programming Philosophy 4 - Chapito Technology</a></li>
<li><a href="../249843/index.html">Anonymous Santa Claus 2014 - Post boasting Christmas gifts</a></li>
<li><a href="../249845/index.html">Practice "Intel IoT". Edison - the mighty "crumb"</a></li>
<li><a href="../249853/index.html">Possible use of virtuality for creating programs in the future</a></li>
<li><a href="../249855/index.html">Making custom firmware for Grandstream phones</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>