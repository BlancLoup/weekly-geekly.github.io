<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing FreeBSD 9.1 with root partition encryption</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúIf you have paranoia, this does not mean that you are not being watched.‚Äù ¬© Popular wisdom 

 After reading the post How I introduced the first rule ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing FreeBSD 9.1 with root partition encryption</h1><div class="post__text post__text-html js-mediator-article">  ‚ÄúIf you have paranoia, this does not mean that you are not being watched.‚Äù ¬© Popular wisdom <br><br>  After reading the post <a href="http://habrahabr.ru/post/157899/">How I introduced the first rule of doing business in Russia</a> , I had this question: <br><br>  What to do if a company develops a software product (SaaS), and in the development process it is necessary to use local develop and stage servers?  What will happen if the ‚Äúattacker‚Äù gets physical access to the disks and how not to give him all the source codes of the projects?  And if we roll out the code to the battlefield through scripts, Chef or Puppet, then we also give all access to the combat sites. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The answer is obvious: encrypt everything of value.  But as we all know, encryption options are mass.  Starting from encrypting individual files and creating cryptocontainers (for example, TrueCrypt) and ending with full disk encryption. <br><br>  You can say "so you yourself break the rule and keep your local servers in the office?".  And I agree, but with a reservation.  For a comfortable development, the closer the source, the better, and given the speed of the Internet for legal entities in the regions, which can be obtained for reasonable money, keep develop and stage servers somewhere far away will lead to excruciating pain.  Here I am talking about a scheme where there are no source codes on the development machines.  All code lies on the network develop server.  And in general, ping out and ping in local gigabit are a little different things. <br><br>  So let's get down to encryption. <br><a name="habracut"></a><br>  Given: server on FreeBSD. <br>  Task: Encrypt all partitions. <br><br><h5>  Encryption schemes </h5><br>  What are the encryption options? <br><ul><li>  File system encryption (for example, ZFS) </li><li>  Third-party encryption </li><li>  The standard FreeBSD mechanisms for any gbde and geli filesystem. </li></ul><br>  Let us specify the conditions that our scheme should satisfy: <br><ol><li>  Transparent full disk encryption </li><li>  No external storage for key storage or kernel boot </li><li>  Minimum hardware requirements </li></ol><br>  We can say that the second paragraph reduces the cryptographic strength of the system, because we voluntarily refuse encryption keys (leaving only the password) and discard the flash drive, which can be quickly pulled out of the server if necessary. <br><br>  That's right, but if we use virtualization, then in general, we need a flash drive for each virtual machine, which is a little sad. <br>  ZFS for its work requires a lot of resources, which contradicts the third paragraph of conditions. <br><br>  So we choose the most versatile and native option for the system, namely, encryption of partitions using geli.  Read more about geli in the handbook. <br><br>  <b>Note:</b> <blockquote>  When using this scheme, you need to make sure that there is a console access to the server.  In the case of remote servers, there must be a KVM or equivalent.  This is due to the fact that when booting the system will ask for the password for the encrypted partition! </blockquote><br><h5>  Preparation and installation of the system </h5><br>  First we need an operating system image (I used a FreeBSD 9.1 x64 image).  Boot and run the installation. <br><br>  Starting with FreeBSD 9, the familiar sysinstall was replaced by bsdinstall.  This fact makes the installation with disk encryption a little easier, mainly because the loaded environment is easier to use than in previous versions of the system, for example, the required kernel modules are loaded automatically. <br><br><ul><li>  In the "Welcome" menu, select "Install" </li><li>  Choosing a keyboard layout </li><li>  Specify the host name </li><li>  Select the required system components.  (I add the source codes, due to the fact that you still need to rebuild the kernel anyway) </li><li>  Next in the "Partitioning" menu, select "Shell" </li></ul><br><h5>  Disk partitioning </h5><br>  The disk that we use to install the system 'da0'.  We will use GPT markup. <br><br>  Kernel modules are loaded automatically when we need them, so we can skip loading the geli module and go straight to partitioning the disk and creating a crypto partition.  Here is what we need to do: <br><ol><li>  Create a GPT partitioning scheme </li><li>  Create boot block </li><li>  Create and format boot partition </li><li>  Create a swap partition (if needed), and yes, it will also be encrypted </li><li>  Create and initialize the primary encrypted partition. </li><li>  Format the encrypted partition </li><li>  Mount file systems in / mnt </li><li>  Continue installation </li></ol><br><h6>  1. Creating a boot block </h6><br>  To begin, delete all partitions and create a GPT partitioning scheme: <br><pre><code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># gpart destroy -F da0 # gpart create -s gpt da0</span></span></code> </pre> <br><h6>  2. Create a boot block </h6><br>  Create a partition with the type ‚Äúfreebsd-boot‚Äù and the size of 64Kb and install the bootloader. <br><br>  <b>Important:</b> <blockquote>  currently, the partition should not be larger than 512K.  This is due to the limitations of the bootloader code. </blockquote><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># gpart add -t freebsd-boot -s 64k ‚Äìl gpboot da0 # gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 1 da0</span></span></code> </pre><br><h6>  3. Create and format the boot partition </h6><br>  Boot partition of 1 gigabyte in size and tag boot <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># gpart add -t freebsd-ufs -s 1g -l boot da0</span></span></code> </pre><br>  Create a file system on the partition.  The ‚ÄìU flag enables soft-update on the partition.  Use soft-update or not you decide.  There are arguments both for and against. <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># newfs -U gpt/boot</span></span></code> </pre><br><h6>  4. Creating a swap partition </h6><br>  Create a partition size of 4 gigabytes <br><pre> <code class="hljs swift"># gpart add -t freebsd-<span class="hljs-built_in"><span class="hljs-built_in">swap</span></span> -l <span class="hljs-built_in"><span class="hljs-built_in">swap</span></span> ‚Äìs 4g da0</code> </pre><br><h6>  5. Creating and initializing an encrypted volume </h6><br>  For the rest of the space we create the main section. <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># gpart add -t freebsd-ufs -l enc da0</span></span></code> </pre><br>  <b>Note:</b> this is not ufs volume, this is geli volume <br><br>  Initialize geli volume <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># geli init -b gpt/enc</span></span></code> </pre><br>  Geli will ask for a password to access the section. <br><br>  We connect the ciphered section <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># geli attach gpt/enc</span></span></code> </pre><br><h6>  6. Format the encrypted volume </h6><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># newfs -U gpt/enc.eli</span></span></code> </pre><br>  Please note, here we specify '.eli'! <br><h6>  7. Mount file systems in / mnt </h6><br>  Mount the encrypted volume <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># mount /dev/gpt/enc.eli /mnt</span></span></code> </pre><br>  Since we have a separate boot partition, we need the / boot directory to be written to our boot partition when installing. <br><pre> <code class="hljs dos"># <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> /mnt/boot2 # mount /dev/gpt/boot /mnt/boot2 # <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> /mnt/boot2/boot # <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt # ln -s boot2/boot boot</code> </pre><br>  We make a copy of the service information geli for possible recovery.  For now, put them in a specially created folder, and after installing the system, it is recommended to transfer these files to external media. <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># mkdir gelibackups # cp /var/backups/* gelibackups</span></span></code> </pre><br><h6>  8. Continue installation </h6><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># exit</span></span></code> </pre><br>  After that, the installation process will start.  Time to drink a cup of coffee, tea or other beverages. <br><br>  After installation, we will be asked to enter the root password, configure the network, create users. <br><br>  When you see ‚ÄúManual Configuration‚Äù on the screen, you will be prompted to open ‚ÄúShell‚Äù to make changes to the newly installed system.  We agree.  This action will provide us with a chroot console for our installed system. <br><br><h5>  Configuration files </h5><br>  The files that we need to edit are fstab (5), loader.conf (5) and rc.conf (5). <br><h6>  loader.conf </h6><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># vi /boot/loader.conf</span></span></code> </pre><br>  Add the following lines: <br><pre> <code class="hljs objectivec">geom_eli_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> vfs.root.mountfrom=<span class="hljs-string"><span class="hljs-string">"ufs:/dev/da0p4.eli"</span></span></code> </pre><br>  <b>Note:</b> <blockquote>  if you did not create a swap partition, then the encrypted volume will probably be ad0p3.eli.  You should also enclose the path to the GPT section in the second line in quotes, if this is not done, the file will not be processed correctly by the system. </blockquote><br><h6>  fstab </h6><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># vi /etc/fstab</span></span></code> </pre><br>  Add the following lines: <br><pre> <code class="hljs swift">/dev/gpt/enc.eli / ufs rw,noatime <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> /dev/gpt/boot /boot2 ufs rw,noatime <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> /dev/gpt/<span class="hljs-built_in"><span class="hljs-built_in">swap</span></span>.eli <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-built_in"><span class="hljs-built_in">swap</span></span> sw <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><h6>  rc.conf </h6><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># vi /etc/rc.conf</span></span></code> </pre><br>  To encrypt the swap partition, add the following line from the handbook: <br><pre> <code class="hljs objectivec">geli_swap_flags=<span class="hljs-string"><span class="hljs-string">"-e blowfish -l 128 -s 4096 -d"</span></span></code> </pre><br><br>  At this setting is over. <br>  In the console type: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># exit</span></span></code> </pre><br>  and select "Reboot". <br><br>  The goal is achieved.  We received a fully encrypted disk information from which you can not get without knowing the password. <br>  Now, when the system boots into the console, you will be prompted to enter a password for encrypted partitions.  In our case, this is the root partition. <br><br>  The following resources were used to write this article: <br>  <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/">FreeBSD Handbook</a> <br>  <a href="http://namor.userpage.fu-berlin.de/howto_fbsd9_encrypted_ufs.html">Installing FreeBSD 9.0 with encrypted root fs (all ufs)</a> <br>  <a href="http://www.wonkity.com/~wblock/docs/html/disksetup.html">Disk Setup On FreeBSD</a> </div><p>Source: <a href="https://habr.com/ru/post/193228/">https://habr.com/ru/post/193228/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193212/index.html">Integration of Java and 1C through the .Net framework on the example of Apache PDFBox</a></li>
<li><a href="../193220/index.html">I will build my mail server with Postfix and Dovecot</a></li>
<li><a href="../193222/index.html">Discussion of the project TZ open data portal</a></li>
<li><a href="../193224/index.html">Column ‚ÄúOthers‚Äù: about budget smartphones and local brands. Afterword</a></li>
<li><a href="../193226/index.html">Yandex added the ability to pay for a mobile phone directly through a search service.</a></li>
<li><a href="../193230/index.html">Where are all the laptops on Android?</a></li>
<li><a href="../193232/index.html">Selection of manifestos from the IT world</a></li>
<li><a href="../193234/index.html">Metric # 21 - Podcast on IT technology, products and services</a></li>
<li><a href="../193238/index.html">What's new in SQLite (2013)?</a></li>
<li><a href="../193242/index.html">Mega-Tutorial Flask, Part 1: "Hello, World!"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>