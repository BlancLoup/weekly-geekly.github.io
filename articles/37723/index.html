<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Garbage collection after unloading the module from the parent application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="First, everything written below refers to the client side of web applications created in JavaScript. 
 Secondly, this applies to web applications that...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Garbage collection after unloading the module from the parent application</h1><div class="post__text post__text-html js-mediator-article">  First, everything written below refers to the client side of web applications created in JavaScript. <br>  Secondly, this applies to web applications that use a modular architecture to extend its functionality (module loading / unloading). <br><a name="habracut"></a><br>  <b>Parent application</b> - the application in which the modules are launched, the launched module knows about the parent application. <br>  <b>Module</b> - a set of scripts and resources that implement certain functionality, designed to expand the possibility of a web-application.  Module code can call internal functions of a web application and, as a result, change the internal state of this application. <br><br>  <b>Task:</b> When unloading a module from a web application, roll back the changes that the module has made by calling functions of the web application inside its code. <br><br>  <b>Example: A</b> mapping application loads a module showing the user layer with the methods of this application; after unloading the module, you must correctly remove the user layer.  For this, the mapping application has an internal method for correctly deleting a user layer and after unloading the module it must be called. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The task is to ensure that the module knew what it was creating using web application methods and knew how to remove it using cleaning methods from the same web application.  Of course, it is ideal that each module developer for all created objects himself calls the necessary cleaning functions, but it is better to automate this by increasing the security of the entire system. <br><br>  In the process of inventing how to do this, 4 solutions were generated.  Two of which used the caller property from the Function object, but after <a href="http://www.opera.com/docs/specs/opera9/js/ecma/">studying</a> this <a href="http://www.opera.com/docs/specs/opera9/js/ecma/">www.opera.com/docs/specs/opera9/js/ecma,</a> these solutions could be safely scrapped, unfortunately ... Although there is still a controversial issue Of course, the fact that Opera does not have this property solves certain issues of JavaScript security, I raised this issue in a post <a href="http://habrahabr.ru/blogs/javascript/28660/">Modifying the platform‚Äôs kernel code with applets (modules)</a> and suggested the hack of my approach through the caller property <a href="http://habrahabr.ru/blogs/javascript/28660/">habrahabr.ru/blogs/javascript/28660 / # comment_756953</a> .  In the Opera, of course, such a hack will not work, but the absence of this property does not allow to implement some beautiful solutions, in particular, what will be discussed in this topic.  And of course putting safety of JavaScript execution in the first place, the caller property may eventually be removed altogether (although some unconscious individuals do not understand what, how and why it happens in the world of technology, but simply <a href="http://habrahabr.ru/blogs/opera/37628/">minus without trying to get to the bottom</a> ).  So I had to look for another solution. <br><br>  Next, the essence of the problem is superficially presented, focusing on the essence of the problem. <br><br>  Approximate module class: <br><br><blockquote>  <font color="black"><font color="#0000ff">function</font> Module (fCode) {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> (fCode) <font color="#0000ff">this</font> .CreateInstance (fCode);</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> <font color="#0000ff">this</font> ;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">Module.prototype = <font color="#0000ff">new</font> Object;</font> <font color="black"><br><br></font>  <font color="black">Module.prototype.oInstance = <font color="#0000ff">null</font> ;</font> <font color="black"><br><br></font>  <font color="black">Module.prototype.CreateInstance = <font color="#0000ff">function</font> (fCode) { <font color="#0000ff">this</font> .oInstance = fCode;</font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">Module.prototype.GetInstance = <font color="#0000ff">function</font> () { <font color="#0000ff">return</font> <font color="#0000ff">this</font> .oInstance;</font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">Module.prototype.Run = <font color="#0000ff">function</font> () {</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">if</font> ( <font color="#0000ff">this</font> .oInstance) <font color="#0000ff">this</font> .oInstance.apply ( <font color="#0000ff">this</font> .oInstance, arguments);</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">Module.prototype.Unload = <font color="#0000ff">function</font> () { <font color="#008000">/ * There will be a clean code * /</font> }</font> </blockquote><br>  The Module constructor accepts executable code, in this case in the form of a finished function, but you can make the code come in the form of text. <br>  The Run method runs the code and passes the necessary parameters to it. <br>  The Unload method deals with the correct deletion of objects created in the module. <br><br>  Based on the Module class, we create our parent web application: <br><br><blockquote>  <font color="black"><font color="#0000ff">function</font> BaseModule () {}</font> <font color="black"><br></font>  <font color="black">BaseModule.prototype = <font color="#0000ff">new</font> Module ( <font color="#0000ff">function</font> (oParentInstance) {</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">function</font> MyClass () { <font color="#0000ff">this</font> .aObjects = [];</font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">MyClass.prototype.aObjects = <font color="#0000ff">null</font> ;</font> <font color="black"><br><br></font>  <font color="black">MyClass.prototype.CreateObject = <font color="#0000ff">function</font> (sParam) {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">var</font> oObject = <font color="#0000ff">new</font> Object;</font> <font color="black"><br></font>  <font color="black">oObject.sParam = sParam;</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">this</font> .aObjects.push (oObject);</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">MyClass.prototype.RemoveObject = <font color="#0000ff">function</font> (oObject) {</font> <font color="black"><br></font>  <font color="black">alert ( <font color="#A31515">‚ÄúRelease object:‚Äû</font> + oObject.sParam);</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">var</font> i = 0; i &lt; <font color="#0000ff">this</font> .aObjects.length; i ++) {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> ( <font color="#0000ff">this</font> .aObjects [i] == oObject) {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">this</font> .aObjects.splice (i, 1);</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">break</font> ;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">delete oObject;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">var</font> oMyClass = <font color="#0000ff">new</font> MyClass;</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">this</font> .oMyClass = oMyClass;</font> <font color="black"><br><br></font>  <font color="black">});</font> </blockquote><br>  The application contains the MyClass class that provides two methods for correctly creating and deleting objects (in the example, only abstract objects are shown).  Once launched, the application creates an instance of the class and makes it public: var oMyClass = new MyClass;  this.oMyClass = oMyClass; <br>  Now other modules can get the oMyClass property and call the CreateObject and RemoveObject methods. <br><br>  We describe the loadable module: <br><br><blockquote>  <font color="black"><font color="#0000ff">function</font> ExternModule1 () {}</font> <font color="black"><br></font>  <font color="black">ExternModule1.prototype = <font color="#0000ff">new</font> Module ( <font color="#0000ff">function</font> (oParentInstance) {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">var</font> oMyClass = oParentInstance.oMyClass;</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">var</font> oObject = oMyClass.CreateObject ( <font color="#A31515">‚ÄúHello world!‚Äù</font> );</font> <font color="black"><br></font>  <font color="black">});</font> </blockquote><br>  After loading and starting execution, the module accesses the namespace of the parent application, gets the oMyClass property, and calls the CreateObject method. <br><br>  And in general: <br><br><blockquote>  <font color="black"><font color="#008000">// Run our application.</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">var</font> oBaseModule = <font color="#0000ff">new</font> BaseModule;</font> <font color="black"><br></font>  <font color="black">oBaseModule.Run ({});</font> <font color="black"><br><br></font>  <font color="black"><font color="#008000">// Run the module by passing the Function object with the application code (logically linking the parent application and the launched module).</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">var</font> oExternModule1 = <font color="#0000ff">new</font> ExternModule1 ();</font> <font color="black"><br></font>  <font color="black">oExternModule1.Run (oBaseModule.GetInstance ());</font> <font color="black"><br><br></font>  <font color="black"><font color="#008000">// Upload the module.</font></font> <font color="black"><br></font>  <font color="black">oExternModule1.Unload ();</font> </blockquote><br><br>  In the context of the problem being solved, it is necessary that after the module is unloaded, the objects created in the module through the methods of the parent application are automatically deleted.  In the example above, an object is created through the CreateObject method, and after unloading, if the developer of the module itself did not delete it using the RemoveObject method, the module itself should do this for it. <br><br>  It was decided for those objects that need automatic deletion with a call to a special deletion method, to introduce the function of registering an object, and registration for the context in which this object was created.  In the example about the object, oObject should know the Module in which this object was created.  After unloading, the module itself goes through the list of those objects that were created in it and calls the Release method (the method already indicates how to delete itself correctly). <br><br>  Let us extend the native Object object by specifying methods for registering and deleting objects: <br><br><blockquote>  <font color="black"><font color="#0000ff">function</font> GBind (oContext, fFunctor) {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> <font color="#0000ff">function</font> () {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> fFunctor.apply (oContext, arguments);</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">Object.prototype.aHeap = <font color="#0000ff">null</font> ;</font> <font color="black"><br></font>  <font color="black">Object.prototype.Release = <font color="#0000ff">function</font> () {}</font> <font color="black"><br><br></font>  <font color="black">Object.prototype.RegisterObject = <font color="#0000ff">function</font> (oContext, oObject, fRelease) {</font> <font color="black"><br></font>  <font color="black">oObject.Release = GBind (oContext, fRelease);</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> (! <font color="#0000ff">this</font> .aHeap) <font color="#0000ff">this</font> .aHeap = [];</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">this</font> .aHeap.push (oObject);</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">Object.prototype.ReleaseObjects = <font color="#0000ff">function</font> () {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> (! <font color="#0000ff">this</font> .aHeap) <font color="#0000ff">return</font> ;</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">var</font> i = 0; i &lt; <font color="#0000ff">this</font> .aHeap.length; i ++)</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> ( <font color="#0000ff">this</font> .aHeap [i] .Release)</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">this</font> .aHeap [i] .Release ( <font color="#0000ff">this</font> .aHeap [i]);</font> <font color="black"><br></font>  <font color="black">}</font> </blockquote><br><br>  Let's refine the CreateObject method taking into account the registration of the created object: <br><br><blockquote>  <font color="black">MyClass.prototype.CreateObject = <font color="#0000ff">function</font> (sParam) {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">var</font> oObject = <font color="#0000ff">new</font> Object;</font> <font color="black"><br></font>  <font color="black">oObject.sParam = sParam;</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">this</font> .aObjects.push (oObject);</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">this</font> .RegisterObject ( <font color="#0000ff">this</font> , oObject, <font color="#0000ff">function</font> (oObject) { <font color="#0000ff">this</font> .RemoveObject (oObject);});</font> <font color="black"><br><br></font>  <font color="black">}</font> </blockquote><br>  where the RegisterObject method indicates where to delete (the context in which the deletion method will be called), what to delete (the object to be deleted) and how to delete (the method to be deleted). <br><br>  There is another important thing to do: RegisterObject is still called in the context of the parent web application, and for the module to register the object in its context, it is necessary to call RegisterObject in the context of the module.  Before that, I had a caller based solution.  To determine the context of the call, there was a function that recursively ran through the caller property to the call point (the module where the call was made from), received the context of the module and already called RegisterObject through it.  Without the caller property, this problem can be solved differently, but not so beautiful.  Since the module knows which application is its parent, it can replace the context of calling the RegisterObject method with its own context (the problem is solved through the closure).  The substitution is done before the launch of the module code.  Immediately add to the Unload method delete registered objects.  And the final class of the module: <br><br><blockquote>  <font color="black"><font color="#0000ff">function</font> Module (fCode) {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> (fCode) <font color="#0000ff">this</font> .CreateInstance (fCode);</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> <font color="#0000ff">this</font> ;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">Module.prototype = <font color="#0000ff">new</font> Object;</font> <font color="black"><br><br></font>  <font color="black">Module.prototype.oInstance = <font color="#0000ff">null</font> ;</font> <font color="black"><br><br></font>  <font color="black">Module.prototype.CreateInstance = <font color="#0000ff">function</font> (fCode) { <font color="#0000ff">this</font> .oInstance = fCode;</font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">Module.prototype.GetInstance = <font color="#0000ff">function</font> () { <font color="#0000ff">return</font> <font color="#0000ff">this</font> .oInstance;</font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">Module.prototype.Run = <font color="#0000ff">function</font> () {</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">var</font> oParentInstance = arguments [0] .oMyClass;</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">var</font> oCloneInstance = {};</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">for</font> (vProp <font color="#0000ff">in</font> oParentInstance) oCloneInstance [vProp] = oParentInstance [vProp];</font> <font color="black"><br></font>  <font color="black">oCloneInstance.RegisterObject = GBind ( <font color="#0000ff">this</font> .oInstance, Object.prototype.RegisterObject);</font> <font color="black"><br></font>  <font color="black">arguments [0] .oMyClass = oCloneInstance;</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">if</font> ( <font color="#0000ff">this</font> .oInstance) <font color="#0000ff">this</font> .oInstance.apply ( <font color="#0000ff">this</font> .oInstance, arguments);</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">Module.prototype.Unload = <font color="#0000ff">function</font> () { <font color="#0000ff">this</font> .oInstance.ReleaseObjects ();</font>  <font color="black">}</font> </blockquote><br><br>  An example for studying with two modules: <a href="http://www.okarta.ru/hyper/modulerelease.html">www.okarta.ru/hyper/modulerelease.html</a> <br><br>  On the basis of articles: <a href="http://habrahabr.ru/blogs/javascript/25529/">Dynamic loading of modules on JavaScript</a> , <a href="http://habrahabr.ru/blogs/javascript/26215/">Schedules of tasks on JavaScript</a> , <a href="http://habrahabr.ru/blogs/javascript/28660/">Modification of the kernel code of the platform with loadable modules</a> and this article made the following practical application example: <a href="http://www.okarta.ru/hyper/base.html">www.okarta.ru/hyper/base.html</a> <br><br>  PS Again, the idea of ‚Äã‚Äãimplementation is given, there are various nuances, but if you give a realization with their account, then the article (as well as the code) will grow very much, and it will be very difficult to understand the essence. </div><p>Source: <a href="https://habr.com/ru/post/37723/">https://habr.com/ru/post/37723/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../37722/index.html">On the issue of browser compatibility</a></li>
<li><a href="../377221/index.html">Rocketbook: "cloud" notepad for automatic transfer of handwritten text and drawings to the cloud</a></li>
<li><a href="../377223/index.html">Turkey wants to ban Minecraft</a></li>
<li><a href="../377227/index.html">The main risks for Tesla business</a></li>
<li><a href="../377229/index.html">The revolution in artificial intelligence. Part Two: Immortality or the destruction of life on earth</a></li>
<li><a href="../377231/index.html">Fascinating video rotation of NASA satellites around the Earth</a></li>
<li><a href="../377233/index.html">An attempt to add natural smells to virtual reality</a></li>
<li><a href="../377237/index.html">Soon, anyone can make their eyes blue</a></li>
<li><a href="../377239/index.html">Scientists have obtained a self-propelled drop of liquid metal</a></li>
<li><a href="../377241/index.html">Chinese ID cards. From shabby papers to the card "all in one"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>