<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Docker Swarm + Consul + Gobetween as an engine for a geo-distributed cluster</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preamble 


 Some time ago, we faced the task of designing and deploying a system for streaming video. The point was in the mass start / stop of insta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Docker Swarm + Consul + Gobetween as an engine for a geo-distributed cluster</h1><div class="post__text post__text-html js-mediator-article"><h2 id="preambula">  Preamble </h2><br><p>  Some time ago, we faced the task of designing and deploying a system for streaming video.  The point was in the mass start / stop of instances where streaming video is reassembled and streaming to multiple media cdn providers (youtube, livestream, ustream, etc.) as well as to its own rtmp and ts destination points.  Each instance required settings before launch.  contained specific information for each client.  It was also clear that the system should work in a large number of regions (at least in all points where there is an Amazon, and as a maximum - in any place where you can rent a server).  Also the main requirement is the launch of the instance within 1-2 seconds maximum, so that it is transparent to the user. </p><br><a name="habracut"></a><br><p>  It was at the beginning of 2015 that there was already talk that Docker would soon release a native clustering system.  And on February 26, 2015 she did come out.  It immediately became clear that this is for us a silver bullet and Swarm ideally falls on our project.  The project was launched in May 2015. </p><br><p>  After 11 months, we launched a second, more complex project in which it was necessary to organize static entry points (ip: port) for third-party equipment, while expanding the entire logic of operation and launch of instances dynamically in the desired region. </p><br><p>  In the process of design and subsequent development, we used Docker swarm rather non-standard.  And then came the idea of ‚Äã‚Äãhow to dynamically manage and balance its infrastructure.  Also, as part of this path, the <a href="https://github.com/yyyar/gobetween">Gobetween</a> project <a href="https://github.com/yyyar/gobetween">appeared</a> which was supposed to help us in the future to flexibly manage our infrastructure and also be easily replicable. </p><br><h2 id="zadacha">  Task </h2><br><p>  In this article I would like to share the idea and the fundamental implementation of building a distributed system. <br>  I will specifically omit the security aspect - here everyone decides how / what is better to build.  Some are closed with passwords / certificates, etc., some take out the management part in the network not intersecting directly with the public access networks (they live inside vpc and are interconnected by means of tunnels). </p><br><p>  Schematic diagram of the docker cluster on Standalone Swarm. </p><br><p>  Consider the system fundamentally - as a large number of regions and with one core (upavlyayuschim). </p><br><img src="http://i.piccy.info/i9/89febfc382a58dadef479d31a6a9e6d8/1471790191/75126/1058105/Untitled.png" alt="image"><br><p>  In this case, a system with one master and a large number of docker hosts, who announce themselves to the consul cluster, is considered.  Why is that?  Yes, because in essence, Manage is of no value in itself - there is no data in it that I would not want to lose.  It doesn‚Äôt even have any settings - it is the task scheduler for the docker node list, which it takes from the Consul cluster.  Moreover, you can make as many such instances as you wish, but there is no point - below I will explain why. </p><br><p>  The biggest advantage of this system is everything is transparent, manageable, scalable.  So let's start by configuring the cluster consul. </p><br><h1 id="ustanovka-i-nastroyka-consul-klastera">  Install and Configure Consul Cluster </h1><br><p>  At the output, we want to get the following cluster structure: <br>  3 nodes in RAFT with auto wizard selection. </p><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">sever1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.consul</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bootstrap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">consul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">consul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">agent</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sever2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.consul</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.12</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">consul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">consul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">agent</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sever3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.consul</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.13</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">consul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">consul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">agent</span></span></code> </pre> <br><p>  First, fix Consul on server (N) .consul.example.com: </p><br><p>  We swing the consul with <a href="https://consul.io/">https://consul.io</a> <br>  No containers, consul under UPSTART. </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$wget</span></span> https://releases.hashicorp.com/consul/0.6.4/consul_0.6.4_linux_amd64.zip <span class="hljs-variable"><span class="hljs-variable">$unzip</span></span> *.zip <span class="hljs-variable"><span class="hljs-variable">$mv</span></span> consul /usr/sbin/consul</code> </pre> <br><p>  Check that Consul works: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$consul</span></span> --version Consul v0.6.4 Consul Protocol: 3 (Understands back to: 1)</code> </pre> <br><p>  After installation on all three servers, we will prepare the cluster for the initial boot: </p><br><p>  Generating a cluster token: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$consul</span></span> keygen ozgffIYeX6owI0215KWR5Q==</code> </pre> <br><p>  Create a user from which Consul will run: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$adduser</span></span> consul</code> </pre> <br><p>  Create on all 3 servers the necessary directories: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$mkdir</span></span> -p /etc/consul.d/{bootstrap,server,client}</code> </pre> <br><p>  Create a directory for storing data Consul: </p><br><pre> <code class="hljs php">$mkdir /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/consul $chown consul:consul /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/consul</code> </pre> <br><p>  On the node that we will use to start the cluster for the first time (sever1.consul.example.com), we need to create the bootstrap config: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$vim</span></span> /etc/consul.d/bootstrap/config.json</code> </pre> <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"bootstrap"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"server"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"datacenter"</span></span>: <span class="hljs-string"><span class="hljs-string">"production"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/consul"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"encrypt"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"log_level"</span></span>: <span class="hljs-string"><span class="hljs-string">"INFO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"encrypt"</span></span>:ozgffIYeX6owI0215KWR5Q==, <span class="hljs-attr"><span class="hljs-attr">"enable_syslog"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre> <br><p>  On <b>ALL</b> three servers you need to create a server config /etc/consul.d/server/config.json: </p><br><p>  Server1: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"bootstrap"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"server"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"datacenter"</span></span>: <span class="hljs-string"><span class="hljs-string">"production"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/consul"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"encrypt"</span></span>: <span class="hljs-string"><span class="hljs-string">"ozgffIYeX6owI0215KWR5Q=="</span></span>, <span class="hljs-attr"><span class="hljs-attr">"log_level"</span></span>: <span class="hljs-string"><span class="hljs-string">"INFO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"enable_syslog"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start_join"</span></span>: [<span class="hljs-string"><span class="hljs-string">"10.0.0.12"</span></span>, <span class="hljs-string"><span class="hljs-string">"10.0.0.13"</span></span>] }</code> </pre> <br><p>  Server2 </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"bootstrap"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"server"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"datacenter"</span></span>: <span class="hljs-string"><span class="hljs-string">"production"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/consul"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"encrypt"</span></span>: <span class="hljs-string"><span class="hljs-string">"ozgffIYeX6owI0215KWR5Q=="</span></span>, <span class="hljs-attr"><span class="hljs-attr">"log_level"</span></span>: <span class="hljs-string"><span class="hljs-string">"INFO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"enable_syslog"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start_join"</span></span>: [<span class="hljs-string"><span class="hljs-string">"10.0.0.11"</span></span>, <span class="hljs-string"><span class="hljs-string">"10.0.0.13"</span></span>] }</code> </pre> <br><p>  Server3: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"bootstrap"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"server"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"datacenter"</span></span>: <span class="hljs-string"><span class="hljs-string">"production"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/consul"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"encrypt"</span></span>: <span class="hljs-string"><span class="hljs-string">"ozgffIYeX6owI0215KWR5Q=="</span></span>, <span class="hljs-attr"><span class="hljs-attr">"log_level"</span></span>: <span class="hljs-string"><span class="hljs-string">"INFO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"enable_syslog"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start_join"</span></span>: [<span class="hljs-string"><span class="hljs-string">"10.0.0.11"</span></span>, <span class="hljs-string"><span class="hljs-string">"10.0.0.12"</span></span>] }</code> </pre> <br><p>  Now create a UPSTART script for Consul on all servers: /etc/init/consul.conf: </p><br><pre> <code class="hljs sql">description "Consul server process" <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-filesystems <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> net-device-up IFACE=eth0) <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> runlevel [!<span class="hljs-number"><span class="hljs-number">12345</span></span>] respawn setuid consul setgid consul exec consul <span class="hljs-keyword"><span class="hljs-keyword">agent</span></span> -config-dir /etc/consul.d/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span></code> </pre> <br><h1 id="pervichnyy-zapusk-klastera">  Primary cluster start </h1><br><p>  Initialize our cluster (Initial Start): at sever1.consul.example.com: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#consul agent -config-dir /etc/consul.d/bootstrap -bind="IP_ADDRESS"</span></span></code> </pre> <br><p>  The service should start and capture the terminal.  In bootstrap mode, the server itself assigns itself to the master and initializes all the necessary data structures. </p><br><p>  On the other two servers (sever2.consul.example.com, sever3.consul.example.com), the consul is simply started in server mode. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#start consul</span></span></code> </pre> <br><p>  These servers connect to the bootstrap server.  At the moment we have a cluster of three servers, two of which are working in the normal mode of the server, and one is in the initialization mode, which means that he himself makes decisions on data distribution without asking the others. </p><br><p>  Now we can stop the bootstrap server and restart the consul in the standard server mode: </p><br><p>  On the bootstrap server, click: </p><br><blockquote>  CTRL-C </blockquote><p>  The consul will stop and then restart in standard server mode: </p><br><p>  sever1.consul.example.com: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#consul start</span></span></code> </pre> <br><p>  Check that everything went well with this command: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#consul members -rpc-addr=10.0.0.11:8400</span></span></code> </pre> <br><p>  The output should be: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Node</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Address</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Status</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Type</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Build</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Protocol</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.consul</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8301</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">alive</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">production</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.consul</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.12</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8301</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">alive</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">production</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.consul</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.13</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8301</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">alive</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">production</span></span></code> </pre> <br><p>  So, we have a ready and operational consul cluster. </p><br><h1 id="balansirovschik-nagruzki-kak-frontend-konsul-klastera">  Load Balancer as Frontend Cluster Consul </h1><br><p>  In this case, we will use the load balancer and all requests to the consul cluster will go through it.  In the case of Amazon, the use of consul agents from different VPCs, not to mention the regions, has many unresolved problems (announcing your internal IP instead of the one specified at the start of the external one, which destroys the second stage of entering the node / server in the cluster), and raising the consul cluster in each region and to configure synchronization - from my point of view at this stage is not rational. </p><br><h2 id="ustanavlivaem-consul-agent">  Install Consul Agent </h2><br><p>  By analogy - download and install on the server, where our balancer will be located, Consul. <br>  then we will create an agent config: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$vim</span></span> /etc/consul.d/server/config.json</code> </pre> <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"server"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"datacenter"</span></span>: <span class="hljs-string"><span class="hljs-string">"production"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/consul"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ui_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"/home/consul/dist"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"encrypt"</span></span>: <span class="hljs-string"><span class="hljs-string">"ozgffIYeX6owI0215KWR5Q=="</span></span>, <span class="hljs-attr"><span class="hljs-attr">"log_level"</span></span>: <span class="hljs-string"><span class="hljs-string">"INFO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"enable_syslog"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start_join"</span></span>: [<span class="hljs-string"><span class="hljs-string">"10.0.0.11"</span></span>, <span class="hljs-string"><span class="hljs-string">"10.0.0.12"</span></span>, <span class="hljs-string"><span class="hljs-string">"10.0.0.13"</span></span>] }</code> </pre> <br><p>  create an upstart for the agent: </p><br><pre> <code class="hljs sql">description "Consul server process" <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-filesystems <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> net-device-up IFACE=eth0) <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> runlevel [!<span class="hljs-number"><span class="hljs-number">12345</span></span>] respawn setuid consul setgid consul exec consul <span class="hljs-keyword"><span class="hljs-keyword">agent</span></span> -config-dir /etc/consul.d/<span class="hljs-keyword"><span class="hljs-keyword">agent</span></span></code> </pre><br><p>  we start the agent: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$start</span></span> consul</code> </pre> <br><p>  check what happened with us: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$consul</span></span> members -rpc-addr=10.0.0.11:8400</code> </pre> <br><p>  after launch, the output should be something like: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Node</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Address</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Status</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Type</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Build</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Protocol</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.consul</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8301</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">alive</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">production</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.consul</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.12</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8301</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">alive</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">production</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.consul</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.13</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8301</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">alive</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">production</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lb</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.consul</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8301</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">alive</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">client</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">production</span></span></code> </pre> <br><h2 id="nastraivaem-a-hrefhttpsgithubcomyyyargobetweengobetweena-v-vide-balansirovschika">  <a href="https://github.com/yyyar/gobetween">We adjust Gobetween</a> in the form of the balancer. </h2><br><p>  In <a href="https://habrahabr.ru/users/nickdoikov/topics/">previous</a> articles I described a part of the functionality of our LB. <br>  in this case, the easiest way is to use EXEC discovery together with the Consul agent installed locally - this allows you to look at the consul cluster from the inside (after all, in the future it may well turn out that we will add / remove some of the nodes and then we will not need to reconfigure). </p><br><p>  Download the latest release (the version may change later, so watch out for the releases): </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$wget</span></span> https://github.com/yyyar/gobetween/releases/download/0.3.0/gobetween_0.3.0_linux_amd64.tar.gz <span class="hljs-variable"><span class="hljs-variable">$tar</span></span> -xvf gobetween_0.3.0_linux_amd64.tar.gz <span class="hljs-variable"><span class="hljs-variable">$cp</span></span> gobetween_0.3.0_linux_amd64/gobetween /usr/sbin</code> </pre> <br><p>  So, let's create a script to determine the list of available consul backend servers, which will return a list of servers that have been checked and which are registered to the consul and marked with the CONSUL service </p><br><p>  create a directory for configs and discovery scripts </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$mkdir</span></span> /etc/gobetween/</code> </pre> <br><p>  create a discovery script: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$vim</span></span> /etc/gobetween/consul_node_discovery.sh</code> </pre> <br><p>  such content: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash curl -Ss http://0.0.0.0:8500/v1/catalog/service/consul |jq '.[] | .Address' |sed 's/"//g'| sed 's/$/:8500/'</span></span></code> </pre> <br><p>  if you run the script by hand, the output should be something like: </p><br><pre> <code class="hljs css">10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8500</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.12</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8500</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.13</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8500</span></span></code> </pre> <br><p>  With this type of retrieving the list of working servers, we will not use helscheks - we will leave this to the consul himself to the cluster.  Now configure <a href="https://github.com/yyyar/gobetween">Gobetween</a> itself: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$vim</span></span> /etc/gobetween/gobetween.toml</code> </pre> <br><pre> <code class="hljs pgsql">[logging] <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> = "info" output = "stdout" [api] enabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> bind = ":8888" [api.basic_auth] <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> = "admin" <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> = "admin" [defaults] max_connections = <span class="hljs-number"><span class="hljs-number">0</span></span> client_idle_timeout = "0" backend_idle_timeout = "0" backend_connection_timeout = "0" [servers.consul] bind = "10.0.0.1:8500" protocol = "tcp" balance = "iphash" max_connections = <span class="hljs-number"><span class="hljs-number">0</span></span> client_idle_timeout = "10m" backend_idle_timeout = "10m" backend_connection_timeout = "5s" [servers.consul.<span class="hljs-keyword"><span class="hljs-keyword">access</span></span>] default = "deny" rules = [ "allow 99.99.99.1/24", # region1 docker nodes ip`s pool "allow 199.199.199.1/24", # region <span class="hljs-number"><span class="hljs-number">2</span></span> docker nodes pool "allow 200.200.200.200/32", #mage node "allow 99.99.98.1/32 " #region<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> balancer ] [servers.consul.discovery] failpolicy = "keeplast" <span class="hljs-type"><span class="hljs-type">interval</span></span> = "10s" timeout = "5s" kind = "exec" exec_command = ["/etc/gobetween/consul_node_discovery.sh"]</code> </pre><br><p>  Now let's create the upstart script /etc/init/gobetween.conf: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$vim</span></span> /etc/init/gbetween.conf</code> </pre> <br><pre> <code class="hljs mel"># gobetween service description <span class="hljs-string"><span class="hljs-string">"gobetween"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">env</span></span> DAEMON=/usr/sbin/gobetween <span class="hljs-keyword"><span class="hljs-keyword">env</span></span> NAME=gobetween <span class="hljs-keyword"><span class="hljs-keyword">env</span></span> CONFIG_PATH=/etc/gobetween/gobetween.toml export GOMAXPROCS=<span class="hljs-string"><span class="hljs-string">`nproc`</span></span> start on runlevel [<span class="hljs-number"><span class="hljs-number">2345</span></span>] stop on runlevel [!<span class="hljs-number"><span class="hljs-number">2345</span></span>] kill signal INT respawn respawn limit <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> umask <span class="hljs-number"><span class="hljs-number">022</span></span> expect stop respawn script <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> $DAEMON -c $CONFIG_PATH <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> end script post-stop script pid=<span class="hljs-string"><span class="hljs-string">`pidof gobetween`</span></span> kill <span class="hljs-number"><span class="hljs-number">-9</span></span> $pid end script</code> </pre> <br><p>  and now we will start the balancer: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$start</span></span> gobetween</code> </pre> <br><p>  Now we have a cluster, you can go to <a href="http://lb_ip:8888/servers/consul">http: // lb_ip: 8888 / servers / consul</a> and check that the list of servers of the consul was determined successfully. </p><br><h1 id="ustanovka-doker-nod-serverov-s-dokerom">  installing docker node (docker servers) </h1><br><p>  Our nodes will live in 2 subnets: </p><br><pre> <code class="hljs">99.99.99.1/24 - region 1 199.199.199.1/24 -region 2</code> </pre> <br><p>  Also external ELASTIC IP in Amazon - 50.50.50.50 </p><br><h2 id="docker">  Docker </h2><br><p>  So, here I see no point in repeating the steps of installing the docker to the server.  They can be read <a href="https://docs.docker.com/engine/installation/linux/ubuntulinux/">here</a> .  I will focus only on specific issues.  It should also be noted - this guide works for 12 and 14 Ubuntu branches, for Ubuntu 16 the same settings of the docker of the daemon are required, but they are made a little differently. </p><br><p>  Let's start with the configuration of the docker daemon and its launch. </p><br><p>  edit the initialization string docker daemon: </p><br><pre> <code class="bash hljs">vim /etc/default/docker</code> </pre> <br><p>  you need to add the line below, the remaining lines - comment out: </p><br><pre> <code class="hljs objectivec">DOCKER_OPTS=<span class="hljs-string"><span class="hljs-string">"-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --label region=region1 "</span></span></code> </pre> <br><p>  Next, restart the Docker: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$service</span></span> docker restart</code> </pre> <br><p>  After that, you need to make sure that the docker daemon starts up with the necessary settings: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ps</span></span> ax |grep docker</code> </pre> <br><p>  should see something like this: </p><br><pre> <code class="bash hljs">10174 ? Ssl 264:59 /usr/bin/docker daemon -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --label region=region</code> </pre> <br><h2 id="swarm-join">  Swarm join </h2><br><p>  install <a href="https://github.com/docker/swarm">Docker Swarm</a> on our server with the docker already installed.  I do not use Docker Swarm in containers, I like when everything is transparent and when I can initialize exactly as I want and control it with a simple upstart. </p><br><p>  So, the easiest way to get a binary file with a backup is to download its image to yourself on a local machine, then unpack the image and extract it in any possible way.  I prefer to collect it for myself.  Deciding how best I will leave the reader. </p><br><p>  Imagine that we already have a Docker Swarm binary, we copied it to our custom docker server.  now we just need to configure Swarm by writing an upstart script: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$vim</span></span> /etc/init/swarm.conf ```upstart description <span class="hljs-string"><span class="hljs-string">"Consul server process"</span></span> start on (<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-filesystems and net-device-up IFACE=eth0) stop on runlevel [!12345] respawn setuid root setgid root <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> bash -c <span class="hljs-string"><span class="hljs-string">'swarm join --ttl 20s --heartbeat 4s --advertise=SERVER_IP:2375 consul://50.50.50.50:8500/swarmcluster/ '</span></span></code> </pre><br><p>  SERVER_IP you can easily extract it yourself, it is inserted into me by substituting from Elastic IP during server creation in Amazon with the help of Ansible.  This is exactly the ip by which the SWARM Manage will connect to this docker host. </p><br><p>  now we start our swarm join: </p><br><pre> <code class="bash hljs">start swarm</code> </pre> <br><p>  you can check it by request </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$curl</span></span> -Ss http://50.50.50.50:8500/v1/kv/swarmcluster/docker/swarm/nodes/?keys&amp;seperator=/&amp;dc=production</code> </pre> <br><p>  and should get an answer: </p><br><pre> <code class="bash hljs">$ [<span class="hljs-string"><span class="hljs-string">"swarmcluster/docker/swarm/nodes/SERVER_IP:2375"</span></span>]</code> </pre> <br><p>  Now also scale the cluster to any number of regions.  Changing in the settings of the docker daemon tags (lables) for each region.  You can also add several tags to each server (it is convenient to divide the server by region and also, say, processor performance, memory size, disk type). </p><br><h2 id="ustanovka-swarm-manage">  installing swarm manage </h2><br><p>  So, now let's proceed directly to the installation of our distribution manager.  In fact, installing it is not much different from installing Swarm Join. </p><br><p>  Again, repeat the steps to copy the binary to the server and then create the UPSTART script: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$vim</span></span> /etc/init/swarm.conf</code> </pre> <br><pre> <code class="hljs pgsql">description "Consul server process" <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-filesystems <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> net-device-up IFACE=eth0) stop <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> runlevel [!<span class="hljs-number"><span class="hljs-number">12345</span></span>] respawn setuid root setgid root exec bash -c <span class="hljs-string"><span class="hljs-string">'swarm manage -H tcp://$0.0.0.0:2377 -strategy "binpack" consul://50.50.50.50:8500/swarmcluster/'</span></span></code> </pre><br><p>  SWARM_MANAGE_IP is the ip of our Manage.  In our case - 200.200.200.200.  Let <b>us consider -strategy,</b> this option determines the distribution of containers on the nodes corresponding to all parameters of the samples.  With the binpack strategy, the first node is filled first with containers, and only then the second.  If you have hundreds of starts / stops of containers per hour - this avoids fragmentation and allows you to remove unnecessary nodes from the cluster. </p><br><p>  There are 3 types of container distribution strategies: </p><br><p>  spread - distribution to the least loaded node <br>  binpack - the most dense packing containers <br>  random - there is nothing to say and everything is clear :) it is used only for debug. </p><br><p>  now finally run our swarm manage: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$service</span></span> swarm start</code> </pre> <br><p>  and check what happened with us: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$docker</span></span> -H 0.0.0.0:2377 info</code> </pre> <br><p>  and get something like this: </p><br><pre> <code class="hljs pgsql">Containers: <span class="hljs-number"><span class="hljs-number">1</span></span> Images: <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Version</span></span>: swarm/<span class="hljs-number"><span class="hljs-number">1.2</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Role</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> Strategy: binpack Filters: health, port, dependency, affinity, <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> Nodes: <span class="hljs-number"><span class="hljs-number">3</span></span> host1: <span class="hljs-number"><span class="hljs-number">99.99</span></span><span class="hljs-number"><span class="hljs-number">.99</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">2375</span></span> ‚îî Status: Healthy ‚îî Containers: <span class="hljs-number"><span class="hljs-number">0</span></span> ‚îî Reserved CPUs: <span class="hljs-number"><span class="hljs-number">0</span></span> / <span class="hljs-number"><span class="hljs-number">8</span></span> ‚îî Reserved Memory: <span class="hljs-number"><span class="hljs-number">0</span></span> B / <span class="hljs-number"><span class="hljs-number">16.46</span></span> GiB ‚îî Labels: executiondriver=, kernelversion=<span class="hljs-number"><span class="hljs-number">3.13</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-86</span></span>-generic, operatingsystem=Ubuntu <span class="hljs-number"><span class="hljs-number">14.04</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> LTS, region=region<span class="hljs-number"><span class="hljs-number">-1</span></span>, storagedriver=devicemapper ‚îî Error: (<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>) ‚îî UpdatedAt: <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T14:<span class="hljs-number"><span class="hljs-number">40</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>Z host3: <span class="hljs-number"><span class="hljs-number">99.99</span></span><span class="hljs-number"><span class="hljs-number">.99</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>:<span class="hljs-number"><span class="hljs-number">2375</span></span> ‚îî Status: Healthy ‚îî Containers: <span class="hljs-number"><span class="hljs-number">0</span></span> ‚îî Reserved CPUs: <span class="hljs-number"><span class="hljs-number">0</span></span> / <span class="hljs-number"><span class="hljs-number">2</span></span> ‚îî Reserved Memory: <span class="hljs-number"><span class="hljs-number">0</span></span> B / <span class="hljs-number"><span class="hljs-number">3.86</span></span> GiB ‚îî Labels: executiondriver=native<span class="hljs-number"><span class="hljs-number">-0.2</span></span>, kernelversion=<span class="hljs-number"><span class="hljs-number">3.13</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-74</span></span>-generic, operatingsystem=Ubuntu <span class="hljs-number"><span class="hljs-number">14.04</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> LTS, region=region<span class="hljs-number"><span class="hljs-number">-1</span></span>, storagedriver=devicemapper ‚îî Error: (<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>) ‚îî UpdatedAt: <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T14:<span class="hljs-number"><span class="hljs-number">40</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span>Z host3: <span class="hljs-number"><span class="hljs-number">199.199</span></span><span class="hljs-number"><span class="hljs-number">.199</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">2375</span></span> ‚îî Status: Healthy ‚îî Containers: <span class="hljs-number"><span class="hljs-number">1</span></span> ‚îî Reserved CPUs: <span class="hljs-number"><span class="hljs-number">0</span></span> / <span class="hljs-number"><span class="hljs-number">2</span></span> ‚îî Reserved Memory: <span class="hljs-number"><span class="hljs-number">512</span></span> MiB / <span class="hljs-number"><span class="hljs-number">3.86</span></span> GiB ‚îî Labels: executiondriver=native<span class="hljs-number"><span class="hljs-number">-0.2</span></span>, kernelversion=<span class="hljs-number"><span class="hljs-number">3.13</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-74</span></span>-generic, operatingsystem=Ubuntu <span class="hljs-number"><span class="hljs-number">14.04</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> LTS, region=region<span class="hljs-number"><span class="hljs-number">-2</span></span>, storagedriver=devicemapper ‚îî Error: (<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>) ‚îî UpdatedAt: <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span>T14:<span class="hljs-number"><span class="hljs-number">40</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>Z Kernel <span class="hljs-keyword"><span class="hljs-keyword">Version</span></span>: <span class="hljs-number"><span class="hljs-number">3.13</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-44</span></span>-generic Operating <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>: linux CPUs: <span class="hljs-number"><span class="hljs-number">12</span></span> Total Memory: <span class="hljs-number"><span class="hljs-number">24.18</span></span> GiB <span class="hljs-type"><span class="hljs-type">Name</span></span>: lb.ourcoolcluster.com</code> </pre><br><p>  in fact, you can already run the container: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$docker</span></span> tcp://0.0.0.0:2377 run -d -P -e constraint:region==region-1 hello-world</code> </pre> <br><p>  More information about filters and policies can be found <a href="https://docs.docker.com/swarm/scheduler/filter/">here</a> . </p><br><p>  So, we have a cluster in which it is possible to start the container depending on the region, and other data.  What next?  - try to organize by the entry point for each region. </p><br><h2 id="sozdanie-enterypoint-dlya-kazhdogo-regiona">  Create an enterypoint for each region </h2><br><p>  Now we will try to build a discovery service on exclusively the internal mechanisms of Sandalone Swarm.  We will use labels when launching containers.  You can do it by hand, or write your own engine that will launch the necessary container and at the same time rest api to work with the Balancer.  In this scheme, LB is configured once at the start of a new service in a region where it was not there before.  after that, you can safely start the replicas of the service as the load grows, and also to stop the container when it drops - the balancer will make the discovery of the list of nodes providing the service. </p><br><p>  Also, if necessary, you can easily keep a replica of the consul in the region and also a replica of the Swarm manage.  But we will consider the simplest scheme. </p><br><p>  The general scheme of how everything will work: </p><br><img src="http://i.piccy.info/i9/05b6e3a357409d154e1e686eed8cdca9/1471794288/89077/1058105/managing.png" alt="image"><br><p>  <a href="https://github.com/yyyar/gobetween">We</a> will omit the <a href="https://github.com/yyyar/gobetween">Gobetween</a> installation, we will only give the config with which it will be launched: </p><br><pre> <code class="hljs pgsql">[logging] <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> = "info" output = "stdout" [api] enabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> bind = ":8888" [api.basic_auth] <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> = "admin" <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> = "admin" [defaults] max_connections = <span class="hljs-number"><span class="hljs-number">0</span></span> client_idle_timeout = "0" backend_idle_timeout = "0" backend_connection_timeout = "0"</code> </pre> <br><p>  This is quite enough to start the balancer.  we will conduct all subsequent procedures through rest api - usually special services are involved.  Also, to simplify testing - on each docker server, create a file / tmp / test and record there information unique for each server.  For example "host1" and "host2" </p><br><p>  For example, run the container: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$docker</span></span> run -l service=region-1.nginx -d -p 22001:80 -e constraint:region==region-1 -v /tmp/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>:/usr/share/nginx/html:ro nginx <span class="hljs-variable"><span class="hljs-variable">$docker</span></span> run -l service=region-1.nginx -d -p 22001:80 -e constraint:region==region-1 -v /tmp/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>:/usr/share/nginx/html:ro nginx</code> </pre> <br><p>  If we in the region-1 have 2 or more nodes, then the container will start (Docker Swarm checks the availability of ports for mapping).  In the case of one docker node in the region, you can run 2 containers in this way: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$docker</span></span> run -l service=region-1.nginx -d -p 22002:80 -e constraint:region==region-1 -v /tmp/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>:/usr/share/nginx/html:ro nginx <span class="hljs-variable"><span class="hljs-variable">$docker</span></span> run -l service=region-1.nginx -d -p 22001:80 -e constraint:region==region-1 -v /tmp/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>:/usr/share/nginx/html:ro nginx</code> </pre> <br><p>  Containers run in the right region and work.  Now it's time to set up our balancer: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$curl</span></span> --user admin:admin -XPOST <span class="hljs-string"><span class="hljs-string">"http://50.50.50.50:8888/servers/r1nginx"</span></span> --data <span class="hljs-string"><span class="hljs-string">' { "bind":"LB_IP:LB_PORT", "protocol": "tcp", "balance": "weight", "max_connections": "0", "client_idle_timeout": "10m", "backend_idle_timeout": "10m", "backend_connection_timeout": "1m" "healthcheck": { "kind": "ping", "interval": "2s", "timeout": "1s" }, "discovery": { "kind": "docker", "docker_endpoint" : "http://50.50.50.50:2377", "docker_container_private_port" : "80", "docker_container_label":"service=region-1.nginx" } } '</span></span></code> </pre> <br><p>  Where: <br>  LB_IP - IP address looking in the direction of checking on the server with a running balancer. <br>  LB_PORT - tcp port on LB_IP looking in the direction of checking on a server with a running balancer. </p><br><p>  Now you can check what happened with us: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$curl</span></span> -sS http://LB_IP:LB_PORT host1 <span class="hljs-variable"><span class="hljs-variable">$curl</span></span> -sS http://LB_IP:LB_PORT host2</code> </pre> <br><p>  So, we have considered one of the simplest, but at the same time and quite functional ways of building a geo-distributed cluster on Docker Swarm standalone.  Installation is fairly simple and transparent, as is troubleshooting.  Thinking through this article, I was aware that I couldn‚Äôt cover many aspects of building and operating a system of this type, I was more likely to make the reader look at the problem from a different angle - the necessary sufficiency and asceticism, because it‚Äôs difficult to do it easily, but it‚Äôs easy and coherent to do complicated. </p><br><p>  Security issues and HA I left to the discretion of readers, perhaps, if there is interest, I will try to highlight them in subsequent articles. </p><br><ul><li>  <a href="https://habrahabr.ru/post/304096/">second overview article</a> </li><li>  <a href="https://habrahabr.ru/post/303428/">first review article</a> </li><li>  <a href="https://github.com/yyyar/gobetween/wiki/REST-API">DRAFT Rest API</a> </li><li>  <a href="https://github.com/yyyar/gobetween">Project on Github</a> </li><li>  <a href="https://github.com/yyyar/gobetween/wiki">Wiki on github</a> </li><li>  <a href="https://github.com/yyyar/gobetween/wiki/Performance-tests-results">Gobetween performance tests</a> </li><li>  <a href="https://github.com/yyyar/gobetween/wiki/3.3-Windows-specific-notes">Installing Gobetween on Windows</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/308182/">https://habr.com/ru/post/308182/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308168/index.html">Overview of Mathematica 11 and Wolfram Language Features</a></li>
<li><a href="../308170/index.html">BMW Music Light</a></li>
<li><a href="../308174/index.html">‚ÄúGreen‚Äù data centers: what do the giants of the industry use to reduce the energy consumption of their DCs?</a></li>
<li><a href="../308178/index.html">The digest of interesting materials for the mobile # 167 developer (August 15-21)</a></li>
<li><a href="../308180/index.html">Automation of mobile applications based on Appium</a></li>
<li><a href="../308184/index.html">Translation of excerpts from Robert Heinlein‚Äôs book, Take Your Government Back - part 15</a></li>
<li><a href="../308186/index.html">"Front End Developer" or who I am by profession</a></li>
<li><a href="../308188/index.html">DIY DI in Ruby</a></li>
<li><a href="../308190/index.html">The digest of fresh materials from the world of the frontend for the last week No. 224 (August 15 - 21, 2016)</a></li>
<li><a href="../308192/index.html">As I increased my productivity or magic kick for smart and lazy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>