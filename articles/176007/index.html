<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASP.NET MVC Lesson 2. Dependency Injection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of the lesson : Study DI (Dependency Injection). Example on Ninject, Unity, Autofac and Winsor. 

 In many cases, the same class instance ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASP.NET MVC Lesson 2. Dependency Injection</h1><div class="post__text post__text-html js-mediator-article">  <b>The purpose of the lesson</b> : Study DI (Dependency Injection).  Example on Ninject, Unity, Autofac and Winsor. <br><br>  In many cases, the same class instance is used in your application in different modules.  A simple way to implement is to use the Singleton pattern. <br><br>  But consider this situation from the other side.  Since this object is created when you first access it, we cannot control its lifetime.  In unit-test, there is no need to use this object (or it may not be possible).  To avoid this, we do not directly call the object, but through the interface.  Both a real class instance and a stub instance for testing will implement this interface.  And we assign the logic of creation to the DI-container. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  For example, before using the service.  We describe a pair of classes, an IWeapon interface with the Kill method, two Bazuka and Sword implementation classes, and a Warrior class that uses weapons: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IWeapon</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Bazuka</span></span> : <span class="hljs-title"><span class="hljs-title">IWeapon</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"BIG BADABUM!"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Sword</span></span> : <span class="hljs-title"><span class="hljs-title">IWeapon</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Chuk-chuck"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Warrior</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IWeapon Weapon; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Warrior</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IWeapon weapon</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Weapon = weapon; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Weapon.Kill(); } }</code> </pre> <br>  We use this: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Warrior warrior = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Warrior(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bazuka()); warrior.Kill(); Console.ReadLine(); } }</code> </pre><br>  We read between the lines.  Create a warrior and give him a bazooka, he goes and kills.  In the console we get: <br><pre> <code class="bash hljs">BIG BADABUM!</code> </pre><br>  Note that we do not have a check for null in the string <br><pre> <code class="cs hljs">Weapon.Kill();</code> </pre><br><br>  What is wrong here?  The warrior does not know whether he has a weapon, and the issue is not a separate module, but the main program. <br>  The essence of DI is to entrust the issue of weapons to another module. <br><br>  We connect Ninject: <br><br><pre> <code class="bash hljs">Install-Package Ninject</code> </pre><br><br>  Create a module that deals with the issuance of weapons: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WeaponNinjectModule</span></span> : <span class="hljs-title"><span class="hljs-title">NinjectModule</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Bind&lt;IWeapon&gt;().To&lt;Sword&gt;(); } }</code> </pre><br><br>  Which literally means: ‚Äúif they ask for a weapon, then give out swords‚Äù. <br>  We create a ‚Äúservice locator‚Äù and use weapons: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IKernel AppKernel; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { AppKernel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardKernel(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeaponNinjectModule()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> warrior = AppKernel.Get&lt;Warrior&gt;(); warrior.Kill(); Console.ReadLine(); } }</code> </pre><br>  As you can see, we create the warrior object not using the new construct, but via <code>AppKernel.Get&lt;&gt;()</code> .  When creating AppKernel, we pass the module responsible for issuing weapons (in this case, the sword) as a constructor.  Any object that we are trying to get via <code>AppKernel.Get</code> will (if possible) be initialized if there are modules that know how to do it. <br><br>  Another point of application is when the <code>Warrior</code> object does not take a weapon with it every time, and if it is not detected, it calls on the service to the locator and gets it: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OtherWarrior</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IWeapon _weapon; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IWeapon Weapon { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_weapon == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _weapon = Program.AppKernel.Get&lt;IWeapon&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _weapon; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Weapon.Kill(); } }</code> </pre><br>  We execute: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> otherWarrior = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OtherWarrior(); otherWarrior.Kill();</code> </pre><br>  Our warrior gets weapons for direct deliveries - super! <br><br>  Ninject has another very good detail.  If the property ( <code>public property</code> ) is marked with <code>[Inject]</code> , then when creating a class via <code>AppKernel.Get&lt;&gt;()</code> , the field is initialized by the locator service: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AnotherWarrior</span></span> { [Inject] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IWeapon Weapon { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Weapon.Kill(); } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> anotherWarrior = AppKernel.Get&lt;AnotherWarrior&gt;(); anotherWarrior.Kill();</code> </pre><br><br><h5>  Unity </h5><br>  Absolutely all the same: <br><ul><li>  Installation <br><pre> <code class="bash hljs">Install-Package Unity</code> </pre><br></li><li>  Initialize the locator service (Container) <br><pre> <code class="cs hljs">Container = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnityContainer();</code> </pre><br></li><li>  Type registration <br><pre> <code class="cs hljs">Container.RegisterType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IWeapon), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Bazuka));</code> </pre><br></li><li>  Object acquisition and use: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> warrior = Container.Resolve&lt;Warrior&gt;(); warrior.Kill();</code> </pre></li><li>  In addition, Unity has a lone class <code>(Singleton) ServiceLocator</code> , which registers the container and allows you to access services from anywhere. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serviceProvider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnityServiceLocator(Container); ServiceLocator.SetLocatorProvider(() =&gt; serviceProvider);</code> </pre><br></li><li>  The sly <code>OtherWarrior</code> now gets a weapon like this: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OtherWarrior</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IWeapon _weapon; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IWeapon Weapon { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_weapon == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _weapon = ServiceLocator.Current.GetInstance&lt;IWeapon&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _weapon; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Weapon.Kill(); } }</code> </pre></li></ul><br><br><h5>  Autofac </h5><br>  Also, in fact, everything happens: <br><ul><li>  Installation <br><pre> <code class="bash hljs">Install-Package Autofac</code> </pre></li><li>  Initialization of the builder of the service locator ( <code>ContainerBuilder</code> ) - no, no, this is not the container itself, it is like modules <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContainerBuilder();</code> </pre></li><li><br>  Registration types.  It is necessary to register all the necessary classes, because the creation of instances of unregistered classes is not implemented here. <br><pre> <code class="cs hljs">builder.RegisterType&lt;Bazuka&gt;(); builder.RegisterType&lt;Warrior&gt;(); builder.Register&lt;IWeapon&gt;(x =&gt; x.Resolve&lt;Bazuka&gt;());</code> </pre><br></li><li>  Creating a service locator (Container) <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> container = builder.Build();</code> </pre><br></li><li>  Object acquisition and use: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> warrior = container.Resolve&lt;Warrior&gt;(); warrior.Kill();</code> </pre><br></li></ul><br><h5>  Castle windsor </h5><br><ul><li>  Installation <br><pre> <code class="bash hljs">Install-Package Castle.Windsor</code> </pre><br></li><li>  Service Locator Initialization <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> container = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WindsorContainer();</code> </pre><br></li><li>  Registration types.  Similar to Autofac. <br><pre> <code class="cs hljs">container.Register(Component.For&lt;IWeapon&gt;().ImplementedBy&lt;Bazuka&gt;(), Component.For&lt;Warrior&gt;().ImplementedBy&lt;Warrior&gt;());</code> </pre><br></li><li>  Object acquisition and use: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> warrior = container.Resolve&lt;Warrior&gt;(); warrior.Kill();</code> </pre><br></li></ul><br><h5>  Small subtotal </h5><br>  In fact, the implementation of Dependency Injection is not much, but still different.  Some support initialization in <code>Web.config (App.config)</code> files.  Some set the rules for initialization, as we now look at the Ninject extension for asp.net mvc - this concerns the initialization of the service locator as a shared object generator, and separately for each stream or web request. <br><br><h5>  Area Objects (Ninject) </h5><br>  In Ninject, you can specify several ways to initialize getting an object from a class.  If we work in different contexts (for example, in different threads (Thread)), then the objects should be used different.  Thereby, the scalability and flexibility of the application is supported. <br><table><tbody><tr><td>  <b>Region</b> </td><td>  <b>Binding method</b> </td><td>  <b>Explanation</b> </td></tr><tr><td>  Temporary </td><td> <code>.InTransientScope()</code> </td> <td>  The class object will be created upon each request (default method). </td></tr><tr><td>  Single mother </td><td> <code>.InSingletonScope()</code> </td> <td>  The class object will be created once and will be reused. </td></tr><tr><td>  Flow </td><td> <code>.InThreadScope()</code> </td> <td>  One object per stream. </td></tr><tr><td>  Request </td><td> <code>.InRequestScope()</code> </td> <td>  One object will be for each web request </td></tr></tbody></table><br><br><h5>  Lifetime Manager in Unity </h5><br>  In Unity, for the task of initialization rules, the implementation of the LifetimeManager abstract class is used. <br>  It happens like this: <br><pre> <code class="cs hljs"> _container.RegisterType&lt;DbContext, SavecashTravelContext&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PerRequestLifetimeManager());</code> </pre><br>  Where PerRequestLifetimeManager is an implementation of LifetimeManager: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PerRequestLifetimeManager</span></span> : <span class="hljs-title"><span class="hljs-title">LifetimeManager</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Key to store data </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private readonly string _key = String.Format("SingletonPerRequest{0}", Guid.NewGuid()); </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Retrieve a value from the backing store associated with this Lifetime policy. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> the object desired, or null if no such object is currently stored. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public override object GetValue() { if (HttpContext.Current != null &amp;&amp; HttpContext.Current.Items.Contains(_key)) return HttpContext.Current.Items[_key]; return null; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Stores the given value into backing store for retrieval later. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="newValue"&gt;</span></span></span><span class="hljs-comment">The object being stored.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public override void SetValue(object newValue) { if (HttpContext.Current != null) HttpContext.Current.Items[_key] = newValue; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Remove the given object from backing store. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public override void RemoveValue() { if (HttpContext.Current != null &amp;&amp; HttpContext.Current.Items.Contains(_key)) HttpContext.Current.Items.Remove(_key); } }</span></span></code> </pre><br>  The bottom line.  All objects are stored in <code>HttpContext.Current.Items[_key]</code> and are issued only if they are already in the same context ( <code>HttpContext.Current</code> ).  Otherwise, a new object is created.  If the current context ( <code>HttpContext.Current</code> ) in the code area does not exist (we use such <code>LifetimeManager</code> in the console application or in a separate thread), then this container will not work. <br><br><h5>  Using Ninject in asp.net mvc </h5><br>  Install Ninject on asp.net mvc.  We separately create our own LessonProject project, create a HomeController with the method and view Index.  (/Contollers/HomeController.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HomeController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); } }</code> </pre><br>  And (/Views/Home/Index.cshtml): <br><br><pre> <code class="html hljs xml">@{ ViewBag.Title = "LessonProject"; Layout = "~/Views/Shared/_Layout.cshtml"; } <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>LessonProject<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  We start - it works. <br><br>  <i>Note: In the future, we will transfer this project to future lessons.</i> <br><br>  Now we install the Ninject module and Ninject.MVC3 for this project. <br><pre> <code class="bash hljs">Install-Package Ninject.MVC3</code> </pre><br>  Add a class to the App_Start folder (/App_Start/NinjectWebCommon.cs): <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">assembly: WebActivator.PreApplicationStartMethod(typeof(LessonProject.App_Start.NinjectWebCommon), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Start"</span></span></span><span class="hljs-meta">)</span></span>] [assembly: WebActivator.ApplicationShutdownMethodAttribute(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(LessonProject.App_Start.NinjectWebCommon), <span class="hljs-string"><span class="hljs-string">"Stop"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">LessonProject.App_Start</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Web.Infrastructure.DynamicModuleHelper; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Ninject; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Ninject.Web.Common; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NinjectWebCommon</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Bootstrapper bootstrapper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bootstrapper(); <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Starts the application </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public static void Start() { DynamicModuleUtility.RegisterModule(typeof(OnePerRequestHttpModule)); DynamicModuleUtility.RegisterModule(typeof(NinjectHttpModule)); bootstrapper.Initialize(CreateKernel); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Stops the application. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public static void Stop() { bootstrapper.ShutDown(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Creates the kernel that will manage your application. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">The created kernel.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> private static IKernel CreateKernel() { var kernel = new StandardKernel(); kernel.Bind</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Func&lt;IKernel&gt;</span></span></span><span class="hljs-comment">&gt;().ToMethod(ctx =&gt; () =&gt; new Bootstrapper().Kernel); kernel.Bind</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;IHttpModule&gt;</span></span></span><span class="hljs-comment">().To</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;HttpApplicationInitializationHttpModule&gt;</span></span></span><span class="hljs-comment">(); RegisterServices(kernel); return kernel; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Load your modules or register your services here! </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="kernel"&gt;</span></span></span><span class="hljs-comment">The kernel.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> private static void RegisterServices(IKernel kernel) { } } }</span></span></code> </pre><br><br>  In RegisterServices we add initialization of our services.  To begin with, we add a playful IWeapon, and later we will return to this method to register other services: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IWeapon</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Bazuka</span></span> : <span class="hljs-title"><span class="hljs-title">IWeapon</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"BIG BADABUM!"</span></span>; } } ‚Ä¶ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IKernel kernel</span></span></span><span class="hljs-function">)</span></span> { kernel.Bind&lt;IWeapon&gt;().To&lt;Bazuka&gt;(); }</code> </pre><br><br>  In the controller use the attribute <code>[Inject]</code> : <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HomeController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { [Inject] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IWeapon weapon { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(weapon); } }</code> </pre><br><br>  Change the View: <br><pre> <code class="html hljs xml">@model LessonProject.Models.IWeapon @{ ViewBag.Title = "LessonProject"; Layout = "~/Views/Shared/_Layout.cshtml"; } <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>LessonProject<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> @Model.Kill() <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  At the output we get: <br><img src="https://habrastorage.org/storage2/8fb/496/ff0/8fb496ff05351221ac16f967e86cbcc6.jpg"><br><br>  Ninject uses WebActivator: <br><ul><li>  registers its OnePerRequestHttpModule and NinjectHttpModule modules </li><li>  creates StandartKernel </li><li>  initializes our services. </li></ul><br><br><h5>  DependencyResolver </h5><br><br>  In asp.net mvc3, the DependencyResolver class appeared.  This class provides an instance of the service.  We can also get our registered services (and even the used DI container) through this class. <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HomeController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IWeapon weapon { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HomeController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { weapon = DependencyResolver.Current.GetService&lt;IWeapon&gt;(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(weapon); } }</code> </pre><br><h5>  Total </h5><br>  The use of DI containers in modern applications is necessary to get rid of strong code connectivity, and for easy access from any part of it to services.  Also, it is necessary for writing Unit tests. <br><br>  All sources are located at <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a> </div><p>Source: <a href="https://habr.com/ru/post/176007/">https://habr.com/ru/post/176007/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175993/index.html">Open government and all other state structures as platforms</a></li>
<li><a href="../175995/index.html">10 Tips for Initially Setting Up a Hyper-V Environment</a></li>
<li><a href="../175999/index.html">ASP.NET MVC. Lesson 0. Introduction</a></li>
<li><a href="../176001/index.html">ASP.NET MVC Lesson 1. Start</a></li>
<li><a href="../176005/index.html">Ultrabook Acer Aspire S7-191 video review</a></li>
<li><a href="../176013/index.html">#FailOverConf - how it was, presentations and videos</a></li>
<li><a href="../176015/index.html">Whatsapp not for sale</a></li>
<li><a href="../176017/index.html">ASP NET.MVC Lesson 3. Working with the Database</a></li>
<li><a href="../176019/index.html">Rapid deployment of the telephone network to Asterisk + Cisco</a></li>
<li><a href="../176021/index.html">ASP.NET MVC Lesson 4. Routing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>