<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compact varint - uniqueness and great values ‚Äã‚Äãfor the same value.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UPD 2018.03.15: Git has been using its compact varint version for a long time. Differences in the afterword . 


 Attention: The code presented in the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compact varint - uniqueness and great values ‚Äã‚Äãfor the same value.</h1><div class="post__text post__text-html js-mediator-article"><p>  <strong>UPD 2018.03.15:</strong> Git has been using its compact varint version for a long time.  Differences in the <a href="https://habrahabr.ru/post/350796/">afterword</a> . </p><br><p>  <em>Attention: The code <a href="https://github.com/golang/protobuf/pull/269/files">presented in the article is</a> slightly different from the original EncodeVarint and DecodeVarint and gives other results.</em>  <em>Be careful.</em> </p><br><p>  In a multiformats / unsigned-varint <a href="https://github.com/multiformats/unsigned-varint/issues/5">discussion of the correct entry of a number in a varint,</a> it was noted that many numbers in the <a href="https://developers.google.com/protocol-buffers/docs/encoding">original varint</a> can be written in a sequence of different lengths.  This will give different blocks and their hashes with identical values ‚Äã‚Äãencoded in the <a href="https://developers.google.com/protocol-buffers/docs/encoding">protobuffer</a> . </p><br><h2 id="originalnyy-varint">  Original varint </h2><br><p>  The original varint simply divides the number into pieces of 7 bits.  And it writes them in order from low to high, adding to each bit an upper 8th bit (MSB - the most significant bit).  The value of this bit depends on whether the last bit is (0) or not (1). </p><br><p>  Thus, for example, the value 0 can be written in many variants: </p><br><ol><li> <code>0000 0000 (0x00)</code> varint = 0 </li><li>  <code>1000 0000 0000 0000 (0x8000)</code> varint = 0 </li><li>  <code>1000 0000 1000 0000 0000 0000 (0x808000)</code> varint = 0 <br>  and so on. </li></ol><br><h2 id="compact-varint">  Compact varint </h2><br><p>  I thought that it is possible to begin the values ‚Äã‚Äãof a larger container from the maximum value of the previous container + 1. After all, if we use a container of this size, that number should be greater than the maximum of the previous container. </p><a name="habracut"></a><br><p>  Benefits: </p><br><ol><li>  A unique value for each set of bytes. <br><ol><li>  <code>0000 0000 (0x00)</code> varint = 0 </li><li>  <code>1000 0000 0000 0000 (0x8000)</code> varint = 128 </li><li>  <code>1000 0000 1000 0000 0000 0000 (0x808000)</code> varint = 16 512 </li></ol></li><li>  Larger values ‚Äã‚Äãfor a set of bytes of the same size. <br><ol><li>  For 2 bytes a maximum of 16 511 which is 128 more than 16 383 for the original varint </li><li>  For 8 bytes, the maximum is already 567 382 630 219 904 more </li></ol></li></ol><br><h3 id="kodiruem-v-compact-varint">  We code in compact varint </h3><br><p>  As I said above, the code is a little different from the original.  Here I just added one line: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">x</span></span> -= <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  And she gave uniqueness and savings. </p><br><p>  <a href="">https://github.com/ivan386/protobuf-1/blob/b76098a2adb7a080231cf14903ab7f3687667ce6/proto/encode.go#L95-L106</a> </p><br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EncodeVarint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> []</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">byte</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buf [maxVarintBytes]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &gt; <span class="hljs-number"><span class="hljs-number">127</span></span>; n++ { buf[n] = <span class="hljs-number"><span class="hljs-number">0x80</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">uint8</span></span>(x&amp;<span class="hljs-number"><span class="hljs-number">0x7F</span></span>) x &gt;&gt;= <span class="hljs-number"><span class="hljs-number">7</span></span> x -= <span class="hljs-number"><span class="hljs-number">1</span></span> } buf[n] = <span class="hljs-keyword"><span class="hljs-keyword">uint8</span></span>(x) n++ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf[<span class="hljs-number"><span class="hljs-number">0</span></span>:n] }</code> </pre> <br><h4 id="primer">  Example </h4><br><p>  300 = <code>000 0010 010 1100</code> </p><br><ol><li><p>  separate the first 7 bits: " <code>uint8(x&amp;0x7F)</code> , <code>x &gt;&gt;= 7</code> " <br> <code>010 1100</code> </p> <br></li><li><p>  add the most significant bit to them (1 since there are more bits): " <code>0x80 |</code> " <br> <code>1 010 1100</code> </p> <br></li><li><p>  subtract one from the remaining: " <code>x -= 1</code> " <br> <code>(000 0010) - 1 = 000 0001</code> <br>  This is the key and only difference from the original EncodeVarint.  Due to it, we can write a larger value in the same number of bytes. </p><br></li><li><p>  add the most significant bit to them (0 since this is the last part) <br> <code>0 000 0001</code> </p> <br></li><li>  glue <br> <code>1 010 1100 ++ 0 000 0001 = 1 010 1100 0 000 0001</code> </li> </ol><br><p> <code>300 = 1010 1100 0000 0001 (0xAC01) compact varint</code> </p> <br><h3 id="dekodiruem-compact-varint">  Decoding compact varint </h3><br><p>  Decryption also has not undergone great changes.  Here I changed one line: </p><br><pre> <code class="hljs dos">x |= (b &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>x7F) &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">shift</span></span></code> </pre> <br><p>  on </p><br><pre> <code class="hljs lisp">x += (<span class="hljs-name"><span class="hljs-name">b</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>xFF) &lt;&lt; shift</code> </pre> <br><p>  <a href="">https://github.com/ivan386/protobuf-1/blob/b76098a2adb7a080231cf14903ab7f3687667ce6/proto/decode.go#L63-L78</a> </p><br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecodeVarint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(buf []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64</span></span></span></span><span class="hljs-function"><span class="hljs-params">, n </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> shift := <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); shift &lt; <span class="hljs-number"><span class="hljs-number">64</span></span>; shift += <span class="hljs-number"><span class="hljs-number">7</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n &gt;= <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(buf) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> } b := <span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>(buf[n]) n++ x += (b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) &lt;&lt; shift <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (b &amp; <span class="hljs-number"><span class="hljs-number">0x80</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x, n } } <span class="hljs-comment"><span class="hljs-comment">// The number is too large to represent in a 64-bit value. return 0, 0 }</span></span></code> </pre> <br><h4 id="primer-1">  Example </h4><br><p>  300 in compact varint number = <code>1 010 1100 0000 000 1 (0xAC01)</code> </p><br><ol><li><p>  share </p><br><pre> <code class="hljs">1 010 1100 0000 000 1</code> </pre> <br></li><li><p>  add zeros or shift " <code>(b &amp; 0xFF) &lt;&lt; shift</code> " </p><br><pre> <code class="hljs">1 010 1100 = 0000 000 1 010 1100 0000 000 1 = 0000 000 1 000 0000</code> </pre> <br><p>  To the first byte, we simply added the higher 7 zeros to align and the second byte was shifted 7 bits forward <code>(b &amp; 0xFF) &lt;&lt; shift</code> .  In this case, the most significant bit is saved, unlike the original varint. </p><br></li><li><p>  now add " <code>x +=</code> " </p><br><pre> <code class="hljs">0000 000 1 010 1100 + 0000 000 1 000 0000 = 0000 001 0 010 1100 ‚Üí 256 + 32 + 8 + 4 = 300</code> </pre> <br><p>  This is a key moment of difference from the original DecodeVarint.  Instead of operation "or" we make addition.  Due to the most significant bit saved at the previous stage, we get a better result. </p><br></li></ol><br><h3 id="pochemu-on-bolee-kompaktnyy">  Why is it more compact: </h3><br><h4 id="vychislim-2h-baytovoe-maksimalnoe-znachenie">  Calculate the 2 byte maximum value </h4><br><pre> <code class="hljs go">a := []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>{<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">127</span></span>} <span class="hljs-comment"><span class="hljs-comment">// 1111 1111 0111 1111</span></span></code> </pre> <br><p>  <strong><em>2 byte maximum value of compact varint:</em></strong> 16511 <br>  coded: <code>1 111 1111 0111 111 1 (0xFF7F)</code> </p><br><ol><li>  share <br><pre> <code class="hljs">1 111 1111 0111 111 1</code> </pre> </li><li><p>  add zeros or shift </p><br><pre> <code class="hljs">1 111 1111 = 0000 000 1 111 1111 0111 111 1 = 0111 111 1 000 0000</code> </pre> <br></li><li>  we fold <br><pre> <code class="hljs">0000 000 1 111 1111 + 0111 111 1 000 0000 = 1000 000 0 111 1111 = 16511</code> </pre> </li></ol><br><p>  result: 16511 </p><br><p>  <strong><em>2-byte maximum value of the original varint:</em></strong> 16383 <br>  coded: <code>1 111 1111 0 111 1111 (0xFF7F)</code> </p><br><ol><li><p>  share </p><br><pre> <code class="hljs">1 111 1111 0 111 1111</code> </pre> <br></li><li><p>  discard the high bit </p><br><pre> <code class="hljs">111 1111 111 1111</code> </pre> <br></li><li>  glue the bits <br><pre> <code class="hljs">111 1111 ++ 111 1111 ‚Üí 111 1111 111 1111 = 16383</code> </pre> </li></ol><br><p>  Result: 16383 </p><br><p>  <strong><em>the difference between the maximum values:</em></strong> 16511 (compact varint) - 16383 (varint) = 128 </p><br><p>  For 2 bytes, it is not large but saves bytes with values ‚Äã‚Äãfrom 16384 to 16511 in comparison with the original varint. </p><br><h4 id="rasschitaem-ekonomiyu-dlya-8mi-baytovoy-zapisi">  Calculate the savings for an 8 byte record. </h4><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">// 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 0111 1111 a := []byte{255,255,255,255,255,255,255,127}</span></span></code> </pre> <br><pre> <code class="hljs lisp"><span class="hljs-number"><span class="hljs-number">72624976668147839</span></span> (    <span class="hljs-number"><span class="hljs-number">8</span></span>  compact varint) - <span class="hljs-number"><span class="hljs-number">72057594037927935</span></span> (    <span class="hljs-number"><span class="hljs-number">8</span></span>   varint ) = <span class="hljs-number"><span class="hljs-number">567382630219904</span></span> (  )</code> </pre> <br><p>  Here we save the 9th byte on a much larger segment of values. </p><br><h3 id="kod-dlya-vychisleniya-raznicy">  Code to calculate the difference: </h3><br><p>  Here, the volume needed to record all values ‚Äã‚Äãup to the specified value is calculated and the statistics of the difference between the old and new versions is displayed. </p><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main import ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> ) func DecodeVarintDifference(buf []byte) (difference uint64, newVarint uint64, oldVarint uint64, n <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span> := uint(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span> &lt; <span class="hljs-number"><span class="hljs-number">64</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span> += <span class="hljs-number"><span class="hljs-number">7</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n &gt;= len(buf) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> } b := uint64(buf[n]) n++ newVarint += (b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) &lt;&lt; <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span> oldVarint |= (b &amp; <span class="hljs-number"><span class="hljs-number">0x7F</span></span>) &lt;&lt; <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (b &amp; <span class="hljs-number"><span class="hljs-number">0x80</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newVarint - oldVarint, newVarint, oldVarint, n } } // The number is too large to represent in a <span class="hljs-number"><span class="hljs-number">64</span></span>-bit value. <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> } func convert(i uint64)(string){ v := []string{<span class="hljs-string"><span class="hljs-string">"B"</span></span>,<span class="hljs-string"><span class="hljs-string">"KB"</span></span>,<span class="hljs-string"><span class="hljs-string">"MB"</span></span>, <span class="hljs-string"><span class="hljs-string">"GB"</span></span>, <span class="hljs-string"><span class="hljs-string">"TB"</span></span>, <span class="hljs-string"><span class="hljs-string">"PB"</span></span>, <span class="hljs-string"><span class="hljs-string">"EB"</span></span>} l := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ; i &gt; <span class="hljs-number"><span class="hljs-number">1024</span></span>; i = i / <span class="hljs-number"><span class="hljs-number">1024</span></span> {l++} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"(%d %s)"</span></span>,i, v[l]) } func main() { a := []byte{<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">127</span></span>} var newByteCount, newStart, oldByteCount, oldStart uint64 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := len(a) - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i-- { difference, nVarint, oVarint, n := DecodeVarintDifference(a[i:]) newByteCount += (nVarint - newStart + <span class="hljs-number"><span class="hljs-number">1</span></span>) * uint64(n) oldByteCount += (oVarint - oldStart + <span class="hljs-number"><span class="hljs-number">1</span></span>) * uint64(n) fmt.Println(<span class="hljs-string"><span class="hljs-string">"size:"</span></span>, n, <span class="hljs-string"><span class="hljs-string">"B"</span></span>) fmt.Println() fmt.Println( <span class="hljs-string"><span class="hljs-string">"new start value:"</span></span>, newStart, <span class="hljs-string"><span class="hljs-string">"\nnew max value:"</span></span>,nVarint) fmt.Println() fmt.Println( <span class="hljs-string"><span class="hljs-string">"old start value:"</span></span>, oldStart, <span class="hljs-string"><span class="hljs-string">"\nold max value:"</span></span>,oVarint) fmt.Println() fmt.Println(<span class="hljs-string"><span class="hljs-string">"max value diff:"</span></span>, difference) oldByteCountForSameRange := oldByteCount + ( difference * uint64(n + <span class="hljs-number"><span class="hljs-number">1</span></span>) ) sizeDifference := oldByteCountForSameRange - newByteCount fmt.Println() fmt.Println(<span class="hljs-string"><span class="hljs-string">"for range from 0 to"</span></span>, nVarint) fmt.Println(<span class="hljs-string"><span class="hljs-string">"new varint data size:"</span></span>, newByteCount, <span class="hljs-string"><span class="hljs-string">"B"</span></span>, convert(newByteCount)) fmt.Println(<span class="hljs-string"><span class="hljs-string">"old varint data size:"</span></span>, oldByteCountForSameRange, <span class="hljs-string"><span class="hljs-string">"B"</span></span>, convert(oldByteCountForSameRange)) fmt.Println(<span class="hljs-string"><span class="hljs-string">"size differece:"</span></span>, sizeDifference, <span class="hljs-string"><span class="hljs-string">"B"</span></span>, convert(sizeDifference)) fmt.Println(<span class="hljs-string"><span class="hljs-string">"percent from data size new:"</span></span>, float64(sizeDifference) / float64(newByteCount) * <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"%") fmt.Println("</span></span>percent from data size old:<span class="hljs-string"><span class="hljs-string">", float64(sizeDifference) / float64(oldByteCountForSameRange) * 100, "</span></span>%") fmt.Println(<span class="hljs-string"><span class="hljs-string">"average byte per value new:"</span></span>, float64(newByteCount) / float64( nVarint + <span class="hljs-number"><span class="hljs-number">1</span></span> ) ) fmt.Println(<span class="hljs-string"><span class="hljs-string">"average byte per value old:"</span></span>, float64(oldByteCountForSameRange) / float64( nVarint + <span class="hljs-number"><span class="hljs-number">1</span></span> ) ) fmt.Println(<span class="hljs-string"><span class="hljs-string">"-------------------------------------------------------"</span></span>) fmt.Println() newStart = nVarint oldStart = oVarint } }</code> </pre> <br><p>  Testing on The Go Playground: <a href="https://play.golang.org/p/HPyb-sXMSjJ">https://play.golang.org/p/HPyb-sXMSjJ</a> </p><br><div class="spoiler">  <b class="spoiler_title">Calculation results</b> <div class="spoiler_text"><pre> <code class="hljs cs">size: <span class="hljs-number"><span class="hljs-number">1</span></span> B <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">127</span></span> old start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> old max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">127</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> diff: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> range <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> to <span class="hljs-number"><span class="hljs-number">127</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> varint data size: <span class="hljs-number"><span class="hljs-number">128</span></span> B (<span class="hljs-number"><span class="hljs-number">128</span></span> B) old varint data size: <span class="hljs-number"><span class="hljs-number">128</span></span> B (<span class="hljs-number"><span class="hljs-number">128</span></span> B) size differece: <span class="hljs-number"><span class="hljs-number">0</span></span> B (<span class="hljs-number"><span class="hljs-number">0</span></span> B) percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> % percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size old: <span class="hljs-number"><span class="hljs-number">0</span></span> % average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> old: <span class="hljs-number"><span class="hljs-number">1</span></span> ------------------------------------------------------- size: <span class="hljs-number"><span class="hljs-number">2</span></span> B <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">127</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">16511</span></span> old start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">127</span></span> old max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">16383</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> diff: <span class="hljs-number"><span class="hljs-number">128</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> range <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> to <span class="hljs-number"><span class="hljs-number">16511</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> varint data size: <span class="hljs-number"><span class="hljs-number">32898</span></span> B (<span class="hljs-number"><span class="hljs-number">32</span></span> KB) old varint data size: <span class="hljs-number"><span class="hljs-number">33026</span></span> B (<span class="hljs-number"><span class="hljs-number">32</span></span> KB) size differece: <span class="hljs-number"><span class="hljs-number">128</span></span> B (<span class="hljs-number"><span class="hljs-number">128</span></span> B) percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">0.38908140312481004</span></span> % percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size old: <span class="hljs-number"><span class="hljs-number">0.38757342699691155</span></span> % average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">1.9923691860465116</span></span> average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> old: <span class="hljs-number"><span class="hljs-number">2.0001211240310077</span></span> ------------------------------------------------------- size: <span class="hljs-number"><span class="hljs-number">3</span></span> B <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">16511</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">2113663</span></span> old start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">16383</span></span> old max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">2097151</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> diff: <span class="hljs-number"><span class="hljs-number">16512</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> range <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> to <span class="hljs-number"><span class="hljs-number">2113663</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> varint data size: <span class="hljs-number"><span class="hljs-number">6324357</span></span> B (<span class="hljs-number"><span class="hljs-number">6</span></span> MB) old varint data size: <span class="hljs-number"><span class="hljs-number">6340997</span></span> B (<span class="hljs-number"><span class="hljs-number">6</span></span> MB) size differece: <span class="hljs-number"><span class="hljs-number">16640</span></span> B (<span class="hljs-number"><span class="hljs-number">16</span></span> KB) percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">0.26310975171072726</span></span> % percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size old: <span class="hljs-number"><span class="hljs-number">0.2624193009395841</span></span> % average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">2.9921297803245928</span></span> average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> old: <span class="hljs-number"><span class="hljs-number">3.0000023655604675</span></span> ------------------------------------------------------- size: <span class="hljs-number"><span class="hljs-number">4</span></span> B <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">2113663</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">270549119</span></span> old start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">2097151</span></span> old max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">268435455</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> diff: <span class="hljs-number"><span class="hljs-number">2113664</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> range <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> to <span class="hljs-number"><span class="hljs-number">270549119</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> varint data size: <span class="hljs-number"><span class="hljs-number">1080066185</span></span> B (<span class="hljs-number"><span class="hljs-number">1</span></span> GB) old varint data size: <span class="hljs-number"><span class="hljs-number">1082196489</span></span> B (<span class="hljs-number"><span class="hljs-number">1</span></span> GB) size differece: <span class="hljs-number"><span class="hljs-number">2130304</span></span> B (<span class="hljs-number"><span class="hljs-number">2</span></span> MB) percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">0.19723828313354705</span></span> % percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size old: <span class="hljs-number"><span class="hljs-number">0.19685001953466882</span></span> % average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">3.992126032418808</span></span> average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> old: <span class="hljs-number"><span class="hljs-number">4.000000033265678</span></span> ------------------------------------------------------- size: <span class="hljs-number"><span class="hljs-number">5</span></span> B <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">270549119</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">34630287487</span></span> old start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">268435455</span></span> old max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">34359738367</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> diff: <span class="hljs-number"><span class="hljs-number">270549120</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> range <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> to <span class="hljs-number"><span class="hljs-number">34630287487</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> varint data size: <span class="hljs-number"><span class="hljs-number">172878758030</span></span> B (<span class="hljs-number"><span class="hljs-number">161</span></span> GB) old varint data size: <span class="hljs-number"><span class="hljs-number">173151437454</span></span> B (<span class="hljs-number"><span class="hljs-number">161</span></span> GB) size differece: <span class="hljs-number"><span class="hljs-number">272679424</span></span> B (<span class="hljs-number"><span class="hljs-number">260</span></span> MB) percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">0.15772870369226125</span></span> % percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size old: <span class="hljs-number"><span class="hljs-number">0.15748031203751395</span></span> % average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">4.992125984801758</span></span> average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> old: <span class="hljs-number"><span class="hljs-number">5.00000000040427</span></span> ------------------------------------------------------- size: <span class="hljs-number"><span class="hljs-number">6</span></span> B <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">34630287487</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">4432676798591</span></span> old start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">34359738367</span></span> old max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">4398046511103</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> diff: <span class="hljs-number"><span class="hljs-number">34630287488</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> range <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> to <span class="hljs-number"><span class="hljs-number">4432676798591</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> varint data size: <span class="hljs-number"><span class="hljs-number">26561157824660</span></span> B (<span class="hljs-number"><span class="hljs-number">24</span></span> TB) old varint data size: <span class="hljs-number"><span class="hljs-number">26596060791572</span></span> B (<span class="hljs-number"><span class="hljs-number">24</span></span> TB) size differece: <span class="hljs-number"><span class="hljs-number">34902966912</span></span> B (<span class="hljs-number"><span class="hljs-number">32</span></span> GB) percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">0.13140604465515907</span></span> % percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size old: <span class="hljs-number"><span class="hljs-number">0.1312335957776889</span></span> % average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">5.992125984257845</span></span> average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> old: <span class="hljs-number"><span class="hljs-number">6.000000000004512</span></span> ------------------------------------------------------- size: <span class="hljs-number"><span class="hljs-number">7</span></span> B <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">4432676798591</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">567382630219903</span></span> old start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">4398046511103</span></span> old max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">562949953421311</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> diff: <span class="hljs-number"><span class="hljs-number">4432676798592</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> range <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> to <span class="hljs-number"><span class="hljs-number">567382630219903</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> varint data size: <span class="hljs-number"><span class="hljs-number">3967210831773851</span></span> B (<span class="hljs-number"><span class="hljs-number">3</span></span> PB) old varint data size: <span class="hljs-number"><span class="hljs-number">3971678411539355</span></span> B (<span class="hljs-number"><span class="hljs-number">3</span></span> PB) size differece: <span class="hljs-number"><span class="hljs-number">4467579765504</span></span> B (<span class="hljs-number"><span class="hljs-number">4</span></span> TB) percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">0.1126126126124338</span></span> % percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size old: <span class="hljs-number"><span class="hljs-number">0.1124859392574144</span></span> % average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">6.992125984252029</span></span> average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> old: <span class="hljs-number"><span class="hljs-number">7.000000000000048</span></span> ------------------------------------------------------- size: <span class="hljs-number"><span class="hljs-number">8</span></span> B <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">567382630219903</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">72624976668147839</span></span> old start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">562949953421311</span></span> old max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">72057594037927935</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> diff: <span class="hljs-number"><span class="hljs-number">567382630219904</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> range <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> to <span class="hljs-number"><span class="hljs-number">72624976668147839</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> varint data size: <span class="hljs-number"><span class="hljs-number">580427963135197347</span></span> B (<span class="hljs-number"><span class="hljs-number">515</span></span> PB) old varint data size: <span class="hljs-number"><span class="hljs-number">580999813345182755</span></span> B (<span class="hljs-number"><span class="hljs-number">516</span></span> PB) size differece: <span class="hljs-number"><span class="hljs-number">571850209985408</span></span> B (<span class="hljs-number"><span class="hljs-number">520</span></span> TB) percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">0.09852216748768333</span></span> % percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size old: <span class="hljs-number"><span class="hljs-number">0.0984251968503923</span></span> % average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">7.9921259842519685</span></span> average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> old: <span class="hljs-number"><span class="hljs-number">8</span></span> ------------------------------------------------------- size: <span class="hljs-number"><span class="hljs-number">9</span></span> B <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">72624976668147839</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">9295997013522923647</span></span> old start <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">72057594037927935</span></span> old max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">9223372036854775807</span></span> max <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> diff: <span class="hljs-number"><span class="hljs-number">72624976668147840</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> range <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> to <span class="hljs-number"><span class="hljs-number">9295997013522923647</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> varint data size: <span class="hljs-number"><span class="hljs-number">9803799999989973164</span></span> B (<span class="hljs-number"><span class="hljs-number">8</span></span> EB) old varint data size: <span class="hljs-number"><span class="hljs-number">9876996826868106412</span></span> B (<span class="hljs-number"><span class="hljs-number">8</span></span> EB) size differece: <span class="hljs-number"><span class="hljs-number">73196826878133248</span></span> B (<span class="hljs-number"><span class="hljs-number">65</span></span> PB) percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">0.7466168922071861</span></span> % percent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> data size old: <span class="hljs-number"><span class="hljs-number">0.7410838351088465</span></span> % average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>: <span class="hljs-number"><span class="hljs-number">1.0546259842519685</span></span> average <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> per <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> old: <span class="hljs-number"><span class="hljs-number">1.0625</span></span> -------------------------------------------------------</code> </pre> </div></div><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  My <a href="https://github.com/golang/protobuf/pull/269">pull request</a> to golang / protobuf lay for a year before they looked at it and sent it to the <a href="https://github.com/google/protobuf/issues/4376">right place</a> for my proposal. </p><br><p>  <a href="https://github.com/multiformats/unsigned-varint">Multiformats / unsigned-varint</a> still uses the original varint.  Now it's too late to change it. </p><br><p>  And I hope that at least someone to <a href="https://github.com/google/protobuf/issues/4376">comact varint</a> will help save some bytes. </p><br><h2 id="posleslovie">  Afterword </h2><br><h3 id="20180315">  2018.03.15 </h3><br><p>  A few days later I came across an article in the Wikipedia <a href="https://en.wikipedia.org/wiki/Variable-length_quantity">Variable-length quantity</a> .  There, in the <a href="https://en.wikipedia.org/wiki/Variable-length_quantity">Removing Redundancy</a> section, the idea presented in my article is described. </p><br><p>  It turns out that Git has been using compact varint for a long time, but it records them from older to younger.  This has several disadvantages: </p><br><ol><li><p>  When encoding, an additional buffer is used which at the end is copied to the final one: <br>  <a href="">git / varint.c # L22 (encode_varint)</a> </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> varint[<span class="hljs-number"><span class="hljs-number">16</span></span>];</code> </pre> <br><p>  <a href="">git / varint.c # L28 (encode_varint)</a> </p><br><pre> <code class="hljs lisp">memcpy(<span class="hljs-name"><span class="hljs-name">buf</span></span>, varint + pos, sizeof(<span class="hljs-name"><span class="hljs-name">varint</span></span>) - pos)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  In the version presented in my article, the recording is done directly to the final buffer: <br>  <a href="">proto / encode.go # L99 (EncodeVarint)</a> </p><br><pre> <code class="go hljs">buf[n] = <span class="hljs-number"><span class="hljs-number">0x80</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">uint8</span></span>(x&amp;<span class="hljs-number"><span class="hljs-number">0x7F</span></span>)</code> </pre> <br></li><li><p>  When decoding, the unit is added separately and the high-order bit is reset: <br>  <a href="">git / varint.c # L10 (decode_varint)</a> </p><br><pre> <code class="cpp hljs">val += <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p>  <a href="">git / varint.c # L14 (decode_varint)</a> </p><br><pre> <code class="hljs lisp">val = (<span class="hljs-name"><span class="hljs-name">val</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>) + (<span class="hljs-name"><span class="hljs-name">c</span></span> &amp; <span class="hljs-number"><span class="hljs-number">127</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  In my version, the most significant bit is added to the number, replacing these two operations: <br>  <a href="">proto / decode.go # L70 (DecodeVarint)</a> </p><br><pre> <code class="go hljs">x += (b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) &lt;&lt; shift</code> </pre> <br></li><li>  <a href="">git / varint.c is</a> not compatible with mine since it uses a different order of bytes. </li></ol><br><h2 id="istochniki">  Sources </h2><br><ol><li>  <a href="https://developers.google.com/protocol-buffers/docs/encoding">Encoding |</a>  <a href="https://developers.google.com/protocol-buffers/docs/encoding">Protocol Buffers |</a>  <a href="https://developers.google.com/protocol-buffers/docs/encoding">Google Developers / Base 128 Varints</a> </li><li>  <a href="https://github.com/multiformats/unsigned-varint">Multiformats / unsigned-varint</a> </li><li>  <a href="https://github.com/golang/protobuf/pull/269">New varint with unique values</a> </li><li>  <a href="https://github.com/google/protobuf/issues/4376">Compact varint</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2580%25D1%258F%25D0%25B4%25D0%25BE%25D0%25BA_%25D0%25B1%25D0%25B0%25D0%25B9%25D1%2582%25D0%25BE%25D0%25B2">Byte order</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Variable-length_quantity">Variable-length quantity</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/350796/">https://habr.com/ru/post/350796/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350786/index.html">Do not deny yourself anything: giving carte blanche to uncensored reviews of our events in our blog</a></li>
<li><a href="../350788/index.html">Issue # 14: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../350790/index.html">Lightning Network In Depth, part 2: HTLC And Payment Routing</a></li>
<li><a href="../350792/index.html">Goldman Sachs lured away Google‚Äôs lead engineer to develop an API for his services</a></li>
<li><a href="../350794/index.html">Hessian-Free Optimization with TensorFlow</a></li>
<li><a href="../350798/index.html">FastTrack Training. "Network Basics". "The value of Cisco routers." Eddie Martin December 2012</a></li>
<li><a href="../350800/index.html">Analysis of performance tasks with JBreak (part 1)</a></li>
<li><a href="../350802/index.html">Parsing proposals for Russian language patterns</a></li>
<li><a href="../350804/index.html">Blockchain on Go. Part 2: Proof-of-Work</a></li>
<li><a href="../350806/index.html">About machine learning, history and life with Dmitry Vetrov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>