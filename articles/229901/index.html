<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hayload in the cloud on a live example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Flops.ru hosting with you and today we will tell you about the results of transferring a fairly large and loaded project to our cloud environme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hayload in the cloud on a live example</h1><div class="post__text post__text-html js-mediator-article">  Hello, <a href="https://flops.ru/">Flops.ru</a> hosting with you and today we will tell you about the results of transferring a fairly large and loaded project to our cloud environment.  The project in question is the <a href="http://adguard.com/">Adguard</a> line of ad-block applications, the developers of which kindly participated in the preparation of this article. <br><br>  In the article we will talk about the virtual infrastructure of the project, the results of transfer to the cloud, and at the same time we will list several interesting bottlenecks and bugs that were discovered through migration.  In addition, we give a number of graphs illustrating the work of the project.  In general, we invite under the cat. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db2/8bc/488/db28bc4887c8d39014f68641f8cb2f1a.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h4>  Brief characteristics of the project </h4><br>  Rush hour traffic is 200-250 Mbit per second.  The total memory capacity of all project virtual servers is 70 GB.  The total peak CPU consumption is around 8 Xeon 2620 processor cores. Before the move, the project lived on 8 virtual machines that were located on 2 physical servers.  During the migration, it was decided to transfer the most loaded applications to separate servers (one server - one application), and the number of machines increased to 12: <br><br><ul><li>  2 build servers with Windows OS </li><li>  3 loaded servers with backends for client applications </li><li>  1 database server </li><li>  1 server with all kinds of frontends </li><li>  1 Windows server with company accounting </li><li>  1 server test environment </li><li>  3 lightly loaded servers for various purposes (forum, tickets, bugtracker, etc.) </li></ul><br>  Since we support both Linux and Windows, every machine, without exception, managed to migrate.  We will not dwell on the move itself - it passed without surprises, and instead we will tell about interesting aspects that attracted attention after the move. <br><br>  Although the load created by the project is far from the very extreme highload, they are nevertheless quite high and affect all subsystems - from the network stack to the data storage system. <br><br><h4>  Public and local network </h4><br>  Let's start with the network stack.  The client‚Äôs product line consists of several desktop applications that periodically go to backend servers for updates and new databases.  Each product line is serviced by its own backend, located on a separate virtual server.  Since there are many customers, they generate a decent enough load on the network.  Here is a graph of traffic consumption of one of the backend servers: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8fa/d90/006/8fad90006da9cca8ff6f51217adcccd2.png"><br><br>  It should be noted separately the local network FLOPS, which is used for communication between client servers. <br><ol><li>  The local network is completely free, which allows you to use it without regard to traffic. </li><li>  Bandwidth - 1 Gbps. </li><li>  In contrast to DigitalOcean and Linode, the local FLOPS network is private and can be used to organize a trusted environment. </li><li>  If you want to completely isolate some virtual servers from the outside world, while maintaining their access to the Internet - you can do this using the local network by configuring NAT on another of your servers. </li></ol><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fc4/04d/f31/fc404df31d61e6b1342c46d380104c54.png"><br><br><a name="storage"></a><br><h4>  Disk subsystem </h4><br>  The only application that actively works with the disk is the Postgres database hosted on a separate virtual server.  Logs of calls, service data and statistics are actively written to the database, which causes high intensity of writing to disk - up to 750 iops to write and up to 1500 iops to read in peaks. <br><img src="https://habrastorage.org/getpro/habr/post_images/a90/c9e/a11/a90c9ea119446a0ad55b916f307bba98.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/a1a/338/268/a1a3382680f88936fbb668e103f3500a.png"><br><br>  Note that even under these conditions, the average load (Load Average) remains relatively small, mainly due to the low response time of the disk subsystem, due to the use of SSD: <br><img src="https://habrastorage.org/getpro/habr/post_images/b60/b22/dd5/b60b22dd5efc7dbdf11030570115ae34.png"><br><br>  Unlike read operations, which are well absorbed by various caches and do not always reach the disks, each write to the database is accompanied by a synchronous write to the Write-ahead log (WAL) and rests on the response of the block device.  Therefore, without using SSD, peak performance was lower, and LA - higher. <br><br><h4>  Transfer results </h4><br><h5>  Statistics and monitoring </h5><br>  Although the client had his own monitoring before the move, our funds significantly expanded his tools.  In addition, the client began to receive messages about events occurring within its servers, for example, the following: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/589/3e3/9c2/5893e39c282aaa2d43895387084fa415.png"><br><br>  Detailed statistics and the ability to reconfigure the server on the fly made it possible to very precisely adjust the required resource consumption for each server. <br><br><h5>  Easier bug detection </h5><br>  Statistics helped to track a number of elusive bugs that were previously unknown or that could not be localized.  Here are some of them: <br><br><h6>  <i>CPU spike</i> </h6><br>  After the transfer and analysis of graphs, it turned out that one of the backend applications showed very strange behavior - over time, CPU consumption spasmed by an integer number of cores: <br><img src="https://habrastorage.org/getpro/habr/post_images/fc1/1ef/09b/fc11ef09b2e5ea3fa18cb4d6d3e1d931.png"><br>  After the next jump, it turned out that the culprit was a very complex (and incorrect) regular expression, which periodically caused the threads to hang inside this regexp with 100% CPU consumption. <br><br><h6>  <i>Suboptimal work with gzip content</i> </h6><br>  The client was strongly puzzled by the permanently high CPU load on the backend servers.  The reason turned out to be that gzip-compression of server responses by java with such volumes of traffic requires large computational resources.  The client optimized the distribution of content, and things went much better.  Left and right - load on the CPU before and after optimization. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/113/9de/2dc/1139de2dc84cdb607d3d536a5e319071.png"><br><br><h6>  <i>Sharp traffic surges in the external network</i> </h6><br>  One of the phenomena that it took a long time for the client to think about it was a sudden traffic jump like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/8fa/d90/006/8fad90006da9cca8ff6f51217adcccd2.png"><br><br>  As it turned out, they were associated with the release of new versions.  If you are developing software and periodically releasing updates to it - we recommend you immediately consider the situations when your clients come to download them at the same time.  The more your distribution weighs - the more you risk falling in such situations :) <br><br><h5>  Minimization of equipment failure risks </h5><br>  Despite the fact that before the transfer, the project was serviced by two servers, each of which could serve the project alone, a possible failure of one of them would guarantee a simple tens of minutes and damaged nerves.  Moving to the cloud reduced dependence on physical iron. <br><br><h5>  Acceleration of the database </h5><br>  As you can see from the <a href="https://habr.com/ru/company/performix/blog/229901/">graphs above</a> , the database works quite intensively with the database and, in peaks, can generate up to 750 iops per write and up to 1500 iops per read.  The disk array used by the client before the move did not provide such performance and was a bottleneck in the system.  Migration to the cloud allowed us to get rid of this bottleneck. <br><br><h5>  Reducing the dependence of developers on the actions of the system administrator </h5><br>  The cloud control panel allowed developers to perform actions that were previously available only to the system administrator ‚Äî creating new virtual servers, launching a clone copy to check the test feature, analyzing the load, and changing instances.  Data on all servers is now at hand, which becomes significant when there are many machines. <br><br><h5>  Fast horizontal scaling </h5><br>  One of the results of the move, which made a great impression on the client, is the possibility of very fast horizontal scaling.  The whole sequence of actions is as follows: <br><ol><li> Cloning and starting a combat server <i>(5-10 seconds)</i> </li><li>  Configuring a round-robin DNS or adding another destination in the nginx proxy config <i>(1-3 minutes)</i> </li></ol><br><h5>  Economic effect </h5><br>  We estimate the cost of hosting before and after the move. <br><br>  <i>Before: the</i> project was located on two colocation servers with a configuration of 96 Gb RAM, 6 √ó 1 Tb SATA (hardware RAID10), 2x Xeon E5520.  Dedicated server with a similar config can be found for 18-20 thousand rubles per month.  We need two of them, so the cost of servers will be 36-40 thousand per month.  A dedicated band of 300 Mbps will cost anywhere from 13-15 thousand rubles a month.  The switch will probably cost another 3-5 thousand.  Rounding, we can say that the final cost will be in the region of 52-60 thousand rubles per month. <br><br>  <i>After: the</i> cost of 1 GB of memory on fixed tariff plans - 500 rubles per month.  The total cost of servers with a total RAM capacity of 70 GB is 35 thousand rubles.  In addition, it is necessary to include traffic that does not fit into the daily limit.  Its cost will be approximately 8-12 thousand rubles per month.  The result - 43-47 thousand rubles a month. <br><br>  It would be nice to take into account the costs of installation and configuration (monitoring, SMS notifications, backups, virtualization) of dedicated servers, but even without this, renting resources in the cloud in this particular case costs 15-20% cheaper than renting physical servers for the same the task. <br><br><h4>  Conclusion </h4><br>  When comparing the two ways of hosting a single complex project - in the cloud and on dedicated servers - the cloud showed its convincing superiority.  It turned out to be cheaper, more convenient, more flexible, helped eliminate a number of weaknesses in the project and gave the client the opportunity to abstract from many routine tasks, such as setting statistics, monitoring and backups. <br><br>  Although for now you can name separate scenarios where the cloud will lose to dedicated servers, we are sure that over the course of time there will be less and less such scenarios. <br><br>  Traditionally, we offer you to <a href="https://flops.ru/registration.html">register</a> and take advantage of the trial period FLOPS (see <a href="https://www.youtube.com/watch%3Fv%3DEMiR63hSJ-Q">video instruction</a> ) in order to evaluate the benefits yourself.  The trial period is 500 rubles or 2 weeks (depending on what ends earlier).  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/229901/">https://habr.com/ru/post/229901/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229887/index.html">Closures in Javascript [Part 2]</a></li>
<li><a href="../229891/index.html">Consolidation of LAN and SAN data center networks based on DCB and FCoE protocols</a></li>
<li><a href="../229893/index.html">Functional JavaScript, Part 1: Introduction</a></li>
<li><a href="../229895/index.html">Synthesis of optimal facial recognition algorithm</a></li>
<li><a href="../229899/index.html">Copyright maze generated?</a></li>
<li><a href="../229903/index.html">SharePoint Farm - a new feature in Microsoft Azure</a></li>
<li><a href="../229905/index.html">Make the simplest filter by product properties using ElasticSearch on Symfony2</a></li>
<li><a href="../229909/index.html">Search Preview - Chrome extension</a></li>
<li><a href="../229911/index.html">How to create a legend</a></li>
<li><a href="../229917/index.html">We program for iPhone and iPad. 3rd ed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>