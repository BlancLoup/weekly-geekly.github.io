<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microprocessor "out of the garage"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surely everyone dealing with electronics and FPGAs is familiar with the site opencores.org, where a lot of useful (and not so) solutions for electroni...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microprocessor "out of the garage"</h1><div class="post__text post__text-html js-mediator-article">  Surely everyone dealing with electronics and FPGAs is familiar with the site opencores.org, where a lot of useful (and not so) solutions for electronics are collected - dozens, maybe hundreds, of processors and peripherals implementations - both original implementations of already existing devices, and so on. and new developments.  This article will discuss a 32-bit microprocessor with the original command system, created on the basis <a href="http://marsohod.org/index.php/prodmarsohod2">of the Mars Rover 2 board</a> . <br><a name="habracut"></a><br>  Our team has been working on the L4 microkernel for 10 years and at some point it came to the realization that the microkernel itself can be implemented as a processor unit.  Moreover, if a full-fledged microkernel is very difficult to implement in hardware, then you can at least help the software part by shifting some of the functions to hardware.  First, we decided to go the easy and optimal way - to study existing solutions, choose the right one and <s>modify the file to</s> add features that are useful for the microkernel.  The work took about a month and almost all solutions found on opencores were studied.  Taking as a basis the ready-made solution opened up quite good possibilities, in the form of ready-made compilers and various libraries.  At some point, we no longer like the existing solutions - something turned out to be difficult, something suboptimal, something just unfinished, something to hide, had a not very suitable license and terms of use.  Grabbing courage and gritting our teeth, we began the adventure, deciding to develop a processor from the very beginning. <br><br>  What is the beginning of the microprocessor?  Ask your system programmer, and he will answer you that this is a system of commands.  Despite the total fashion on RISC architecture, we decided not to tie the length of the instructions to the size of the machine word.  Therefore, we conducted several experiments.  Oddly enough, but a very convenient tool for designing a command system turned out to be ... Microsoft Excel.  First of all, we selected a few columns, using them to number the instructions in the three numeral systems - decimal, hexadecimal and binary.  The result was 256 lines, according to the number of states that can be described in one byte.  Then we tried to logically group the instructions in such a way that the decoding scheme was as simple as possible.  The first block of instructions was taken by single-byte instructions ‚Äî prefixes, modifiers, and simple instructions.  The following block of instructions looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0e0/881/98c/0e088198c2253a05dd8e81648826a6e2.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the next stage, we had to decide on the number and types of registers.  How many registers do you think would be optimal for most tasks?  The answers to this question can vary greatly depending on the identity of the respondent - someone and 32 lack, as it is, and adherents of non-register architecture.  We decided to stop at 16 general registers.  This number is quite comfortable for programming in assembler, quite successfully falls on our architecture and is easily implemented in HDL. <br><br>  Having decided on the registers, we decided to make a completely position-independent command system ‚Äî there is no absolute transition command in the architecture at the absolute address ‚Äî all transitions are relative to the current command.  We are simply obsessed with compactness, so all transition teams have three forms - signed displacements of 1, 2 and 3 bytes.  For example, the following shows transitions with a 16-bit offset: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/296/001/d87/296001d879a497d0b840e9f47ccddc4a.png" alt="image"><br><br>  Finally, we abandoned the concept of a hardware stack, in favor of organizing the stack ‚Äúby agreement‚Äù.  For this, a special NOTCH prefix and the following scheme were introduced - if the prefix is ‚Äã‚Äãpreceded by a conditional or unconditional jump instruction, then the address of the next instruction is placed in the R15 register, i.e.  return address.  Accordingly, the instruction RETURN performs the transition to the contents of the register R15.  Thus, with nested subroutine calls, the care of saving the return address is left to the programmer or the compiler.  At first glance, this does not seem very convenient, optimal and familiar, but if you think about it, you get several advantages - firstly, you can save a few ticks without saving this register in external memory in terminal subroutines (i.e., subprograms that do not call other subroutines), secondly, the NOTCH prefix can be placed before a conditional branch instruction, thereby implementing conditional function calls ‚Äî albeit small, but also saving.  As for the complexity of programming in assembler, they are hidden by macros that are assembler mnemonics of a higher level. <br><br>  Positional independence of the code introduces another feature - reference to constant data.  Since the code can be located at an arbitrary address, the constant data can be located arbitrarily along with the code.  The solution turned out to be quite simple - using the same NOTCH prefix when loading a constant into a register, uses a constant as an offset relative to the instruction being executed - this solves the problem of addressing data in a position-independent code. <br><br>  After designing the command system, which generally took about a year, we armed ourselves with the Qauartus and Icarus Verilog environment and ... understood that we hurried.  Implementing a command system in Verilog was damn complicated.  Knowledgeable people advised to run solutions on a software model, writing a decoder and other functional devices on ordinary C.  After the implementation of the emulator of a nonexistent processor and the run of test programs on it, things went better.  Another half a year was needed to implement the processor on Verilog.  It should be said here that for a newbie, programming an FPGA can be incredibly difficult, and many years of programming experience in high-level languages ‚Äã‚Äãmay even complicate the task.  In this case, come to the aid of modeling tools.  At the first stage, Icarus Verilog turned out to be extremely useful - a free tool for circuit simulation, complete with GTKWave - a program for displaying signals.  Using these tools you can see what is happening with the device at any given time.  At some point, Icarus Verilog‚Äôs capabilities were few and we used ModelSim‚Äôs simulator from MentorGraphis, a very powerful commercial tool, a trimmed version of which can be installed for free with the Altera Quartus environment. <br><br>  You can talk about the debugging process for a long time.  And at some point, when the FPGA resources were occupied by a full third, an understanding suddenly emerged that the resulting processor could already be used for some projects. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/73f/cfc/319/73fcfc319b8ac2db4f6cfe64f60c5b2d.png"><br><br>  To demonstrate the capabilities of the processor, we wrote a simple firmware that, when started, displays the following menu on the screen of the remote terminal: <br><br><pre> ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt; Welcome to Everest core &lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
 ‚îÇ 1 - Load binary file via X-modem protocol ‚îÇ
 ‚îÇ 2 - Run previously loaded binary file
 ‚îÇ 3 - Show RAM (0x100000-0x100140)
 ‚îÇ 4 - Test of message registers
 ‚îÇ 5 - Show previously loaded ANSI picture
 ‚îÇ 6 - Show built-in ANSI pic # 1
 ‚îÇ 7 - Show built-in ANSI pic # 2
 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</pre><br><br>  If you press the 1 key and if your terminal supports file transfer using the X-modem protocol, then a file of up to 4 Kb in size can be uploaded to the device.  This can be a text or an ANSI image - in this case, pressing the 5 key will display the text or image on the screen.  But would it be worthwhile to write an article for this?  Of course not, so when you press key 2 in the terminal, control is transferred to the code loaded via the first menu item.  If you transfer control to the loaded text or the ansi-picture, then in a few steps the processor will stumble upon a non-existent (still undefined command) or turn to non-existent memory.  In this case, the processor will go into step-by-step mode - each code received from the terminal will cause the execution of one processor instruction with the output of the busses to the remote terminal. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/20c/925/e59/20c925e595973b9fc9a409ca36a147ab.jpg" alt="image"><br><br>  It's time to press the "Reset" button.  We called the ‚Äúreset‚Äù left button on the Mars Rover 2 board. <br><br>  To make the device do something meaningful, you need <a href="">Macro Assembler</a> .  In this archive, in addition to the assembler and a few examples, we put the source code of the processor microcode.  Below is an example of a simple user program that can be translated into a binary file using an assembler and loaded into the processor. <br><br><pre><code class="hljs sql">function user_main <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> r14, <span class="hljs-number"><span class="hljs-number">0x2000</span></span> push r15 <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _get_sysclock <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> r2, <span class="hljs-number"><span class="hljs-number">0x05F5E100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _div64 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _print_dec lea r1, $shw_str <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _puts <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _uart_status rcr r0, <span class="hljs-number"><span class="hljs-number">2</span></span> ;  RCV_RDY   jc done ;        <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> r0, <span class="hljs-number"><span class="hljs-number">0x01000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _delay jmp <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> done: pop r15 <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> tty.asm <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> delay.asm <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> mul.asm <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> div.asm <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> print_dec.asm <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> sysclock.asm $shw_str db <span class="hljs-string"><span class="hljs-string">' seconds since boot'</span></span>,<span class="hljs-number"><span class="hljs-number">13</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><br>  This program in a cycle, before pressing any key in the terminal, displays to the remote terminal information about the number of seconds since the start or reset of the device.  To check it in business, you will need the generated file <b>usr_demo2.bin</b> . <br><br>  A small explanation of the program.  The <i>_get_sysclock</i> subroutine returns the number of pulses of the crystal oscillator since the device was turned on or reset.  Sample subroutine dump: <br><pre> <code class="hljs pgsql">; <span class="hljs-comment"><span class="hljs-comment">------------------- _get_sysclock ------------------ 0198: 37 e3 ; DEC R14, 4 019a: 60 e3 ; MOV (R14), R3 019c: e3 ff fe ff f8 ; LOAD R3, 0xfffefff8 01a1: 68 03 ; MOV R0, (R3) 01a3: 36 33 ; INC R3, 4 01a5: 68 13 ; MOV R1, (R3) 01a7: 68 3e ; MOV R3, (R14) 01a9: 36 e3 ; INC R14, 4 01ab: 05 ; RETURN</span></span></code> </pre><br><br>  When exiting the <i>_get_sysclock</i> subroutine, the <i>R0</i> register contains the lower 32 bits, and the R1 register contains the higher 32-bits of the result. <br>  The constant 0x05F5E100 is the number of clock pulses per second. <br><br>  You can download the latest firmware version for the Mars Rover 2 card at <a href="http://marsohod.org/index.php/forum/8--/2542----">this link</a> . <br><br>  If you do not hear the news from our project, then you should know that we are working on transferring the L4 microkernel to the FPGA. <br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/222335/">https://habr.com/ru/post/222335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222323/index.html">Mobile application analytics. Webinar recording</a></li>
<li><a href="../222325/index.html">AniJS is a library for declarative description of CSS animations.</a></li>
<li><a href="../222327/index.html">Oracle wins appeal against google</a></li>
<li><a href="../222331/index.html">Non ASCII String Handling</a></li>
<li><a href="../222333/index.html">Sign in to twitter or how to kill a day with the library STTwitter</a></li>
<li><a href="../222337/index.html">Bleeding Heart Status: Upgrade to Broken</a></li>
<li><a href="../22234/index.html">TorrentView for Far</a></li>
<li><a href="../222343/index.html">Cross compilation of libraries under iOS, doing it right</a></li>
<li><a href="../222345/index.html">Two projects of mass online collaboration</a></li>
<li><a href="../222347/index.html">Headset AfterShokz Bluez. Sound directly to the brain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>