<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An extensive response to the comment, as well as a little about the life of providers in the Russian Federation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Spurred me on this post here this comment here . 

 I bring it here: 
 Kaleman today at 18:53 

 I was pleased today by the provider. Together with th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>An extensive response to the comment, as well as a little about the life of providers in the Russian Federation</h1><div class="post__text post__text-html js-mediator-article">  Spurred me on this post <a href="https://habr.com/ru/post/443898/">here this comment here</a> . <br><br>  I bring it here: <br><blockquote>  <a href="https://habr.com/en/users/kaleman/" class="user_link">Kaleman</a> today at 18:53 <br><br>  I was pleased today by the provider.  Together with the update of the site blocking system, he got a mail.ru.  In the morning I pull tech support, can not do anything.  The provider is small, and apparently the higher providers are blocking.  I also noticed a slowdown in the opening of all sites, maybe some kind of crooked DLP was hung?  Previously, there were no access problems.  The destruction of the Runet goes right before my eyes ... </blockquote>  The fact is that, it seems, we are the same provider: ( 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Indeed, <a href="https://habr.com/en/users/kaleman/" class="user_link">kaleman</a> almost guessed the reason for the problems with mail.ru (although for a long time we refused to believe in this). <br><br>  Further will be divided into two parts: <br><br><ol><li>  The reasons for our current problems with mail.ru and an exciting quest for finding them </li><li>  the existence of an ISP in today's realities, the stability of a sovereign Runet. </li></ol><a name="habracut"></a><br><h3>  Problems with the availability of mail.ru </h3><br>  Oh, that's a pretty long story. <br><br>  The fact is that in order to implement the requirements of the state (in more detail in the second part) we purchased, set up, installed some equipment, both for filtering prohibited resources and for implementing <a href="https://ru.wikipedia.org/wiki/NAT">NAT translations of</a> subscribers. <br><br>  Some time ago, we finally rebuilt the core of the network so that all subscriber traffic passed through this equipment strictly in the right direction. <br><br>  A few days ago they turned on the filtering of the ban on it (at the same time leaving the old system to work) - everything seemed to go well. <br><br>  Then - gradually began to include for different parts of subscribers NAT on this equipment.  In appearance, everything, too, seems to have gone well. <br><br>  But today, having turned on the NAT equipment for the next part of subscribers, from the very morning we were faced with a decent number of complaints about the unavailability or partial availability of <a href="https://mail.ru/">mail.ru</a> and other Mail Ru Group resources. <br><br>  Began to check: something somewhere <i>sometimes</i> , <i>occasionally</i> sends <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D1%2582%25D0%25B0%25D0%25BA%25D0%25B0_TCP_Reset">TCP RST</a> in response to requests exclusively to mail.ru networks.  Moreover, it sends an incorrectly generated (without ACK), clearly artificial TCP RST.  It looked like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/86a/f04/3de/86af043de858c07e275802c49d013755.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/737/32f/bd5/73732fbd5607595690b9572f9af45b98.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e66/6e1/876/e666e187691e5cf61821fd7a649879b2.png" alt="image"><br><br>  Naturally, the first thoughts were about the new equipment: a terrible DPI, no confidence in it, you never know what it is - after all, TCP RST is a fairly common thing among the means of blocking. <br><br>  We also put forward the assumption that <a href="https://habr.com/en/users/kaleman/" class="user_link">kaleman</a> is filtering someone ‚Äúsuperior‚Äù <a href="https://habr.com/en/users/kaleman/" class="user_link">‚Äîbut</a> they were immediately rejected. <br><br>  Firstly, we have enough sane uplinks to not suffer like this :) <br><br>  Secondly, we are connected to several <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25BE%25D1%2587%25D0%25BA%25D0%25B0_%25D0%25BE%25D0%25B1%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25B0_%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B5%25D1%2582-%25D1%2582%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25BC">IXs</a> in Moscow, and the traffic to mail.ru goes exactly through them - and they have neither duties, nor any other motive to filter traffic. <br><br>  The next half of the day was spent on what is commonly called shamanism - along with the vendor of the equipment, for which they were thankful, they did not give up :) <br><br><ul><li>  filtering was completely disabled </li><li>  NAT was disabled by the new scheme </li><li>  test pc was placed in a separate isolated pool </li><li>  changed IP addressing </li></ul><br>  In the second half of the day, a virtual machine was allocated, going online as a regular user, and representatives of the vendor were given access to it and the equipment.  The shamanism continued :) <br><br>  In the end, the representative of the vendor confidently stated that the piece of iron had absolutely nothing to do with it: rst `s come from somewhere higher. <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  <i>At this point, someone can say: but it was much easier to remove the dump not from the test PC, but from the trunk above the DPI?</i> <i><br><br></i>  <i>No, unfortunately, to take a dump (and even just to die) 40 + gbps is not at all trivial.</i> <br></div></div><br>  After that, in the evening - there was nothing left but to return to the assumption of strange filtering somewhere higher. <br><br>  I looked through what IX traffic now goes to the networks of the IWG and just paid off the bgp-sessions to it.  And - lo and behold!  - everything returned to normal :( <br><br>  On the one hand, it is very unfortunate that all day was spent searching for a problem, although it was solved in five minutes. <br><br>  On the other hand: <br><br>  - in my memory this is an unprecedented thing.  As I wrote above - IX `s <i>really</i> there is no point in filtering transit traffic.  They usually have hundreds of gigabits / terabits per second.  I just until the last could not seriously assume. <br><br>  - an incredibly successful set of circumstances: a new complex iron, which does not have much confidence and from which it is not clear what can be expected - sharpened just for blocking resources, including TCP RST `s <br><br>  Currently, the NOC of this internet exchange is looking for a problem.  According to them, (and I believe them) they have no specially deployed filtering system.  But, thanks to heaven, the next quest is no longer our problem :) <br><br>  It was a small attempt to justify, please understand and forgive :) <br><br>  PS: I deliberately do not call either the manufacturer DPI / NAT, or IX (I, in fact, do not even have special claims to them, the main thing is to understand what it was) <br><br><h3>  Today's (as well as yesterday and the day before yesterday) reality from the point of view of an Internet provider </h3><br>  I spent the last weeks, significantly rebuilding the core of the network, producing a bunch of ‚Äúprofitable‚Äù manipulations, with the risk of significantly affecting live user traffic.  Given the goals, results and consequences of all this - all this is morally hard enough.  Especially - once again listening to the wonderful-hearted speeches about the protection of the stability of the RuNet, sovereignty, etc.  etc. <br><br>  In this section, I will try to tell the "evolution" of the core network of a typical Internet service provider over the past ten years. <br><br>  <b>A dozen years ago.</b> <br><br>  In those blessed times, the core of the provider network could be as simple and reliable as a traffic jam: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e28/fd2/ca7/e28fd2ca79ed68fd42a819ceec7fb2e2.png" alt="image"><br><br>  In this very, very simplified picture there are no highways, rings, ip / mpls routing. <br><br>  Its essence is that user traffic ultimately came to the core level switching ‚Äî from where it went to <a href="https://en.wikipedia.org/wiki/Broadband_remote_access_server">BNG</a> , from which, as a rule, back to the kernel switching, and then ‚Äúto the exit‚Äù ‚Äîthrough one or more border gateway's to the Internet. <br><br>  Such a scheme is very, very easy to back up both on L3 (dynamic routing) and L2 (MPLS). <br><br>  You can put N + 1 anything: access servers, switches, boarders - and somehow reserve them for an automatic file server. <br><br>  <b>After a few years,</b> it became clear to everyone in Russia that it was impossible to continue living like this: it was urgent to protect children from the corrupting influence of the network. <br><br>  There was a need to urgently find ways to filter user traffic. <br><br>  There are different approaches. <br><br>  In a not very good case - something is put "in the cut": between user traffic and the Internet.  The traffic passing through this ‚Äúsomething‚Äù is analyzed and, for example, a fake packet with a redirect is sent to the side of the subscriber. <br><br>  In the best case - if the traffic volumes allow - you can make a small feint with your ears: send only the traffic coming from users to the addresses that need to be filtered (for this you can either take from the registry the IP addresses specified there, or additionally resolve the existing ones). in the registry domains). <br><br>  At one time for this purpose, I wrote a simple <a href="https://github.com/ircop/nfq_filter">mini-dpi</a> - although even the language does not turn so to call it.  It is very simple and not very productive - however, it allowed us, and dozens (if not hundreds) of other providers, not to spread millions on industrial DPI-systems at once, but gave several additional years of time. <br><br><div class="spoiler">  <b class="spoiler_title">By the way, about the then and current DPI</b> <div class="spoiler_text">  By the way, many who purchased DPI-systems available at that time on the market have already thrown them out.  Well, they are not sharpened by the like: hundreds of thousands of addresses, tens of thousands of URLs. <br><br>  And at the same time, domestic producers have risen to this market very strongly.  I'm not talking about the hardware component - everything is clear to everyone here, but software is the main thing in DPI - perhaps today if not the most advanced in the world, then surely a) it is developing by leaps and bounds, and b) at the price of boxed - just not comparable with foreign competitors. <br><br>  I would like to be proud, but a little sad =) <br></div></div><br>  Now everything looked like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/10a/ed1/948/10aed19485f0f45528168be60d564145.png" alt="image"><br><br>  <b>After another couple of years</b> , everyone already had auditors;  resources in the registry became more and more.  For some old equipment (for example, cisco 7600), the scheme with ‚Äúside filtering‚Äù became simply inapplicable: the number of routes on 76 platforms is limited to about nine hundred thousand, while the number of only IPv4 routes is now approaching 800 thousand.  And if ipv6 is also ... And how many are there?  900000 individual addresses in the bath pkn?  =) <br><br>  Someone switched to a scheme with the mirroring of all trunk traffic to the filtering server, which should analyze the entire stream and send something bad to both sides (to the sender and receiver) RST when something bad is found. <br><br>  However, the more traffic, the less applicable such a scheme.  At the slightest delay in processing, the mirrored traffic will simply fly by unnoticed, and the provider will receive a protocol on fines. <br><br>  More and more providers are forced to put DPI-systems of varying degrees of reliability in the context of highways. <br><br>  <b>A year or two ago,</b> according to rumors, practically all FSB started demanding the actual installation of <a href="https://vasexperts.ru/blog/osobennosti-i-otlichiya-sorm/">SORM</a> equipment (previously, most providers managed to agree with <i>the SORM plan</i> authorities - a plan of operational measures in case something needed to be found somewhere) <br><br>  In addition to money (not so outright, absolutely transcendental, but still - millions), SORM has demanded many more manipulations with the network from many. <br><br><ul><li>  SORM must see the "gray" addresses of users, before nat-broadcast </li><li>  SORM has a limited number of network interfaces. </li></ul><br>  Therefore, we, in particular, had to coolly rebuild a piece of the core - just to collect user traffic to access servers somewhere in one place.  In order to mirror it with several links in SORM. <br><br>  That is, very simplified, it was (left) vs became (right): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/258/c6a/0d6/258c6a0d6ab79e53e5f69cdec2d5afb9.png" alt="image"><br><br>  <b>Now</b> most providers require the introduction of SORM-3 as well - which includes, among other things, the logging of nat-broadcasts. <br><br>  For these purposes, we also had to add separate equipment for NAT (exactly the one mentioned in the first part) to the scheme above.  And add in a certain order: since SORM must ‚Äúsee‚Äù the traffic before the addresses are translated - the traffic must go strictly as follows: users -&gt; switching, core -&gt; access servers -&gt; SORM -&gt; NAT -&gt; switching, core -&gt; Internet.  To do this, we had to, literally, ‚Äúdeploy‚Äù traffic flows in the other direction to gain money, which was also quite difficult. <br><br>  Total: over a dozen years, the circuit of the middle provider core has become much more complicated, and additional points of failure (both in the form of equipment and in the form of single switching lines) have increased significantly.  Actually, in itself, the requirement to ‚Äúsee everything‚Äù implies reducing this ‚Äúall‚Äù to one point. <br><br>  It seems to me that this can be completely transparently extrapolated to current initiatives for the sovereignization of the RuNet, its protection, stabilization and improvement :) <br><br>  And ahead still Spring. </div><p>Source: <a href="https://habr.com/ru/post/444274/">https://habr.com/ru/post/444274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../444260/index.html">We develop a system for evaluating the work of support agents</a></li>
<li><a href="../444262/index.html">Markdown2pdf ready solution with source code for Linux</a></li>
<li><a href="../444268/index.html">Security Week 12: keyboard attacks</a></li>
<li><a href="../444270/index.html">Group-IB Webinar ‚ÄúGroup-IB's Approach to Cyber ‚Äã‚ÄãFormation: A Review of Current Programs and Practical Cases‚Äù</a></li>
<li><a href="../444272/index.html">PyDERASN: as I wrote the ASN.1 library with slots and blobs</a></li>
<li><a href="../444276/index.html">Entry into React Fiber architecture</a></li>
<li><a href="../444278/index.html">How to make your English article for Habr read tens of thousands of people: 3 simple tips</a></li>
<li><a href="../444286/index.html">Parsing PTZ cameras: what's inside and how it works</a></li>
<li><a href="../444288/index.html">New mobile application LampTest.ru</a></li>
<li><a href="../444290/index.html">Basics of reactive programming using RxJS. Part 2. Operators and Pipes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>