<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[DotNetBook] Stackalloc: forgotten C # command</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With this article, I continue to publish a series of articles, the result of which will be a book on the work of the .NET CLR, and .NET as a whole. Th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[DotNetBook] Stackalloc: forgotten C # command</h1><div class="post__text post__text-html js-mediator-article"><img width="350" src="https://habrastorage.org/webt/34/ua/e6/34uae6usmglyw10vxga3sgfgh8c.jpeg" align="left">  With this article, I continue to publish a series of articles, the result of which will be a book on the work of the .NET CLR, and .NET as a whole.  The whole book will be available on GitHub (link at the end of the article). <br><br>  In C #, there is a rather interesting and very rarely used <code>stackalloc</code> keyword.  It is so rarely found in the code (here I even with the word ‚Äúrare‚Äù underestimated. Rather, ‚Äúnever‚Äù), that finding a suitable example of its use is difficult enough and it is all the more difficult to invent: indeed, if something is rarely used, then experience working with him is too small.  Why all?  Because for those who finally decide to find out what this command does, <code>stackalloc</code> becomes more frightening than useful: the dark side of <code>stackalloc</code> is unsafe code.  The result that it returns is not a managed pointer: value is a regular pointer to a section of unprotected memory.  And if you make an entry at this address after the method has completed, you will start writing either to local variables of some method, or you will alter the return address from the method altogether, after which the application will end up with an error.  However, our task is to penetrate the very corners and find out what is hidden in them.  And to understand, in particular, that if they gave us this tool, it‚Äôs not so easy so that we could find the secret rake and step on them from the very beginning.  On the contrary: we were given this tool so that we could use it and make truly fast software.  I hope inspired you?  Then let's get started. <br><br><blockquote><h3>  Note </h3><br>  The chapter published on Habr√© is not updated and it is possible that it is already somewhat outdated.  So, please ask for a more recent text to the original: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li><img src="https://habrastorage.org/webt/3q/6g/qa/3q6gqaz40qx-jzscjf3jbxatxhg.png">  CLR Book: <a href="https://github.com/sidristij/dotnetbook/">GitHub, table of contents</a> </li><li><img src="https://habrastorage.org/webt/3q/6g/qa/3q6gqaz40qx-jzscjf3jbxatxhg.png">  CLR Book: <a href="">GitHub, chapter, link to the part `Memory allocation on the stack: stackalloc`</a> </li><li><img src="https://habrastorage.org/webt/eo/6g/eo/eo6geog0tg5ernqmv2lcmufefta.png">  Release 0.5.2 of the book, PDF: <a href="">GitHub Release</a> </li></ul><br></blockquote><br><a name="habracut"></a><br>  To find the right examples of using this keyword, you must first proceed to its authors: Microsoft and see how they use it.  This can be done by searching the full-text search in the <a href="https://github.com/dotnet/coreclr">coreclr</a> repository.  In addition to the various tests of the keyword itself, we will find no more than 25 uses of this keyword by library code.  I hope that in the previous paragraph, I motivated you strongly enough so that you did not stop reading, seeing this small figure and did not close my work.  To be honest, the CLR team is far more visionary and professional than the .NET Framework team, and if it did something, it should help us a lot.  And if this is not used in the .NET Framework ... Well, here we can assume that not all engineers are aware that there is such a powerful optimization tool.  Otherwise, the volume of its use would be much greater. <br><br>  <a href=""><b>Interop.ReadDir class</b></a> <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { <span class="hljs-comment"><span class="hljs-comment">// s_readBufferSize is zero when the native implementation does not // support reading into a buffer. byte* buffer = stackalloc byte[s_readBufferSize]; InternalDirectoryEntry temp; int ret = ReadDirR(dir.DangerousGetHandle(), buffer, s_readBufferSize, out temp); // We copy data into DirectoryEntry to ensure there are no dangling references. outputEntry = ret == 0 ? new DirectoryEntry() { InodeName = GetDirectoryEntryName(temp), InodeType = temp.InodeType } : default(DirectoryEntry); return ret; }</span></span></code> </pre><br>  What is <code>stackalloc</code> used <code>stackalloc</code> ?  As we can see, after memory allocation, the code goes to the unsafe method to fill the created buffer with data.  Those.  unsafe method, which requires a plot to write allocated space directly on the stack: dynamically.  This is a great optimization if you consider the alternatives: request a section of memory from Windows or a fixed (pinned) array of .NET, which besides the load on the heap loads the GC so that the array is nailed so that the GC does not push it during access to its data.  Allocating memory on the stack, we do not risk anything: the allocation takes place almost instantly and we can safely fill it with data and exit the method.  And along with the exit from the method, the stack frame of the method will disappear.  In general, the time savings are significant. <br><br>  Let's take another example: <br><br>  <a href=""><b>Class Number.Formatting :: FormatDecimal</b></a> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FormatDecimal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, ReadOnlySpan&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; format, NumberFormatInfo info</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> fmt = ParseFormatSpecifier(format, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> digits); NumberBuffer number = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; DecimalToNumber(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> number); ValueStringBuilder sb; <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* stackPtr = <span class="hljs-keyword"><span class="hljs-keyword">stackalloc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[CharStackBufferSize]; sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValueStringBuilder(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;(stackPtr, CharStackBufferSize)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fmt != <span class="hljs-number"><span class="hljs-number">0</span></span>) { NumberToString(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> sb, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> number, fmt, digits, info, isDecimal:<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { NumberToStringFormat(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> sb, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> number, format, info); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sb.ToString(); }</code> </pre><br>  This is an example of formatting numbers, based on an even more interesting example of the <a href="">ValueStringBuilder</a> class, based on <code>Span&lt;T&gt;</code> .  The essence of this part of the code is that in order to collect the textual representation of the formatted number as quickly as possible, the code does not use memory allocation for the character accumulation buffer.  This fine code allocates memory directly in the stack frame of the method, thereby ensuring that the garbage collector does not work on StringBuilder instances if the method worked on its basis.  Plus, the time of the method itself decreases: memory allocation on the heap also takes time.  And the use of the <code>Span&lt;T&gt;</code> instead of bare pointers introduces a sense of security to the operation of code based on <code>stackalloc</code> . <br><br>  And lastly, let's <code>ValueStringBuilder</code> at another example: the <code>ValueStringBuilder</code> class <code>ValueStringBuilder</code> , which is designed to use <code>stackalloc</code> .  Without it, there would be no this class. <br><br>  <a href=""><b>Class ValueStringBuilder</b></a> <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> ValueStringBuilder { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] _arrayToReturnToPool; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Span&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; _chars; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _pos; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValueStringBuilder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Span&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; initialBuffer</span></span></span><span class="hljs-function">)</span></span> { _arrayToReturnToPool = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; _chars = initialBuffer; _pos = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Length { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; _pos; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> delta = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> - _pos; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (delta &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Append(<span class="hljs-string"><span class="hljs-string">'\0'</span></span>, delta); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _pos = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(_chars.Slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, _pos)); Clear(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Insert</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_pos &gt; _chars.Length - count) { Grow(count); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> remaining = _pos - index; _chars.Slice(index, remaining).CopyTo(_chars.Slice(index + count)); _chars.Slice(index, count).Fill(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); _pos += count; } [MethodImpl(MethodImplOptions.AggressiveInlining)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pos = _pos; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pos &lt; _chars.Length) { _chars[pos] = c; _pos = pos + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { GrowAndAppend(c); } } [MethodImpl(MethodImplOptions.NoInlining)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GrowAndAppend</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c</span></span></span><span class="hljs-function">)</span></span> { Grow(<span class="hljs-number"><span class="hljs-number">1</span></span>); Append(c); } [MethodImpl(MethodImplOptions.NoInlining)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Grow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requiredAdditionalCapacity</span></span></span><span class="hljs-function">)</span></span> { Debug.Assert(requiredAdditionalCapacity &gt; _chars.Length - _pos); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] poolArray = ArrayPool&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;.Shared.Rent( Math.Max(_pos + requiredAdditionalCapacity, _chars.Length * <span class="hljs-number"><span class="hljs-number">2</span></span>)); _chars.CopyTo(poolArray); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] toReturn = _arrayToReturnToPool; _chars = _arrayToReturnToPool = poolArray; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (toReturn != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ArrayPool&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;.Shared.Return(toReturn); } } [MethodImpl(MethodImplOptions.AggressiveInlining)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] toReturn = _arrayToReturnToPool; <span class="hljs-comment"><span class="hljs-comment">// for safety, to avoid using pooled array if this instance is erroneously appended to again this = default; if (toReturn != null) { ArrayPool&lt;char&gt;.Shared.Return(toReturn); } } //   private void AppendSlow(string s); public bool TryCopyTo(Span&lt;char&gt; destination, out int charsWritten); public void Append(string s); public void Append(char c, int count); public unsafe void Append(char* value, int length); public Span&lt;char&gt; AppendSpan(int length); }</span></span></code> </pre><br>  This class in its functionality is similar to its older brother `StringBuilder`, while possessing one interesting and very important feature: it is a significant type.  Those.  passed entirely by value.  And the newest type modifier `ref`, which is assigned to the type declaration signature, tells us that this type has an additional limitation: it has the right to be only on the stack.  Those.  displaying its instances in class fields will result in an error.  Why all these squats?  To answer this question, just look at the `StringBuilder` class: <br><br>  <a href=""><b>Class StringBuilder</b></a> <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StringBuilder</span></span> : <span class="hljs-title"><span class="hljs-title">ISerializable</span></span> { <span class="hljs-comment"><span class="hljs-comment">// A StringBuilder is internally represented as a linked list of // blocks each of which holds a chunk of the string. It turns // out string as a whole can also be represented as just a chunk, // so that is what we do. // The characters in this block internal char[] m_ChunkChars; // Link to the block logically before this block internal StringBuilder m_ChunkPrevious; // The index in m_ChunkChars that represent the end of the block internal int m_ChunkLength; // The logical offset (sum of all characters in previous blocks) internal int m_ChunkOffset; internal int m_MaxCapacity = 0; // ... internal const int DefaultCapacity = 16;</span></span></code> </pre><br>  StringBuilder is a class within which there is a reference to an array of characters.  Those.  when you create it, at least two objects are created: a StringBuilder itself and an array of characters of at least 16 characters (by the way, this is why it is so important to set the expected length of the string: its construction will go through the generation of a simply connected list of 16-character arrays. Agree - waste).  What does this mean in the context of our conversation about the type ValueStringBuilder: by default is absent, since  it borrows memory from the outside, plus it itself is a significant type and forces the user to place a buffer for characters on the stack.  As a result, the entire instance of the type falls on the stack along with its contents, and the question of optimization here becomes resolved.  No heap allocation?  No problem with subsidence performance.  But you tell me: why then do not use ValueStringBuilder (or its self-written version: it‚Äôs internal itself and is not available to us) always?  The answer is this: you have to look at the problem that you are solving.  Will the resulting string be of known size?  Will she have some known maximum length?  If the answer is "yes" and if the size of the string does not go beyond some reasonable limits, then a meaningful version of StringBuilder can be used.  Otherwise, if we expect long lines, we switch to using the regular version. <br><br>  Also, before turning to conclusions it is worth mentioning how to do it is impossible or simply dangerous.  In other words, which code can work well, but at one point it will fire at the most inappropriate moment.  Again, consider an example: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateNoise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> noiseLength</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Span(<span class="hljs-keyword"><span class="hljs-keyword">stackalloc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[noiseLength]); <span class="hljs-comment"><span class="hljs-comment">// generate noise }</span></span></code> </pre><br>  The code is small and deleted: it is impossible to take and accept the size for allocating memory on the stack from outside.  If you so need the size specified outside and at the same time your code is known only to the consumer known to you, take, for example, the buffer itself: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateNoise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Span&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; noiseBuf</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// generate noise }</span></span></code> </pre><br>  This code is much more informative, since  makes the user think and be careful when choosing numbers.  The first option, under unfortunate circumstances, can throw a <code>StackOverflowException</code> if the method is rather shallow in the thread stack: just pass a large number as a parameter. <br><br>  The second problem I see is: if we randomly failed to get into the size of the buffer that we allocated ourselves on the stack, but we don‚Äôt want to lose performance, then, of course, we can go several ways: either allocate memory again on the stack either highlight it in a heap.  And most likely the second option in most cases would be preferable (and they did in the case of `ValueStringBuffer`), since  more secure in terms of getting `StackOverflowException`. <br><br><h3>  Conclusions to stackalloc </h3><br>  So, what is the best use of `stackalloc` and how? <br><br><ul><li>  To work with unmanaged code, when you need to fill in an unmanaged method some data buffer, or accept a certain data buffer from the unmanaged method that will be used within the life of the method body; </li><li>  For methods that need an array, but again for the duration of the method itself.  The formatting example is very good: this method may be called too often to allocate temporary arrays on the heap. </li><li>  If an unsafe version of the interaction is used, it is necessary to carefully check the operation of those methods that the link goes to (void *) since  if they give it away somewhere, then there is a further possibility of damage to the stack: you cannot guarantee that the external method will not decide to pass the link, for example, for caching.  If you are sure that this is excluded, the use will be safe. </li><li>  If you have the ability to use <code>ref struct</code> types or Span type, then working with stackalloc goes into the realm of managed code, which means that the compiler will simply prevent you from using the type differently than intended. </li></ul><br>  Using this allocator can greatly improve the performance of your applications. <br><br><blockquote><h3>  Link to the whole book </h3><br><ul><li><img src="https://habrastorage.org/webt/3q/6g/qa/3q6gqaz40qx-jzscjf3jbxatxhg.png">  CLR Book: <a href="https://github.com/sidristij/dotnetbook/">GitHub</a> </li><li><img src="https://habrastorage.org/webt/eo/6g/eo/eo6geog0tg5ernqmv2lcmufefta.png">  Release 0.5.0 books, PDF: <a href="">GitHub Release</a> </li></ul><br></blockquote></div><p>Source: <a href="https://habr.com/ru/post/348130/">https://habr.com/ru/post/348130/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348120/index.html">Managing Internet modules Laurent from RouterOS MikroTik</a></li>
<li><a href="../348122/index.html">Issue # 9: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../348124/index.html">Why most people do not use two-factor authentication?</a></li>
<li><a href="../348126/index.html">Can I use the CQRS pattern in GO?</a></li>
<li><a href="../348128/index.html">R as a lifeline for the system administrator</a></li>
<li><a href="../348132/index.html">From Amazon EC2 to Mail.ru Infra: Test Cloud VPS (Linux)</a></li>
<li><a href="../348134/index.html">Chromium: other errors</a></li>
<li><a href="../348136/index.html">The most correct implementation of splash screen</a></li>
<li><a href="../348138/index.html">Isometric depth sorting for moving platforms</a></li>
<li><a href="../348140/index.html">Four ways to fool a deep learning neural network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>