<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DirectAccess in Windows 7. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part, dedicated to DirectAccess, I began to look at the technological foundation of this solution. Let me remind you that this foundation...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DirectAccess in Windows 7. Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/company/microsoft/blog/105979/">first</a> part, dedicated to DirectAccess, I began to look at the technological foundation of this solution.  Let me remind you that this foundation consists of: IPv6, IPsec over IPv6, Name Resolution Policy Table (NRPT) table.  We discussed the reasons why DirectAccess uses IPv6 as the underlying protocol.  Does this mean that now, in an era of apparent IPv4 dominance, including on the Russian Internet, using DirectAccess is impossible?  Not.  With transit technologies, DirectAccess feels great in an IPv4 environment. <a name="habracut"></a><br><br>  <b>IPv6 transit technology</b> <br><br>  With DirectAccess, IPv6 information is transferred from a DA client on the Internet through a DA server in the perimeter zone to a server (or client) on the corporate network.  That is, it is assumed that all three participants of this information channel support IPv6.  For the DA client and the DA server, IPv6 support is strictly required.  Consequently, transit technologies can help in three situations: <br>  - when the Internet segments between the DA client and the DA server do not support IPv6; <br>  - when the corporate network segments between the DA server and the destination server to which the traffic is intended do not support IPv6; <br>  - when the destination server itself does not support IPv6. <br>  Consider all three cases in the listed order. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Transit between the DA client and the DA server</b> <br><br>  Once the DA client is on the Internet, he tries to establish an IPsec over IPv6 tunnel with a DA server.  How such a tunnel is built depends directly on what kind of IP configuration the client receives from the ISP.  In the ideal and, accordingly, the least likely case, the DA client receives an IPv6 address.  That is, the DA client was lucky to be on the IPv6 Internet, its packets are simply routed to the DA server. <br>  A more realistic option is that the DA client receives a public IPv4 address from the provider.  In this case, the client will use 6to4 transit technology (RFC 3056).  Thanks to this technology, an IPv6-address of the type 2002: WWXX: YYZZ :: / 48, starting from 2002, is formed on the client (the prefix 2002 just indicates that 6to4 transit technology is taking place) and contains a public IPv4-address in the WWXX: YYZZ fields (see fig. 1): <br><img src="https://habrastorage.org/storage/habraeffect/7e/a6/7ea6502fc625ee08446fecb048843ff7.jpg" alt="image"><br>  Fig.  one <br><br>  The IPv6 packet generated in this way is now packaged in an IPv4 packet and routed over the IPv4 Internet. <br>  A more realistic option is that the DA client receives a private IPv4 address from the provider, for example, 192.168.200.111.  In this case, another transit technology is used - Teredo (RFC 4380).  The task of Teredo is to ensure the passage of the original IPv6 packet not only through the IPv4 environment, but also through NAT.  In this regard, the principle of operation of Teredo is somewhat more complicated than 6to4, and the structure of the formed IPv6 address is: <br><img src="https://habrastorage.org/storage/habraeffect/82/db/82dbdabbe54741b508d7c167afa8f5a0.jpg" alt="image"><br>  Fig.  2 <br><br>  All Teredo addresses begin with the prefix 2001, and the Obscured External Port and Obscured External Address fields contain the external UDP port and external IP address used by NAT, respectively.  I will only clarify what is contained not in an explicit form, but as the result of an XOR operation with a predetermined number.  The formed packet is packed into a UDP packet, which, in turn, is packed into an IPv4 packet.  Now everything is ready to send information through NAT.  In more detail with the transit technologies 6to4 and Teredo, as well as the ISATAP technology mentioned later, you can get acquainted, for example, <a href="http://www.microsoft.com/downloads/en/details.aspx%3Ffamilyid%3DAFE56282-2903-40F3-A5BA-A87BF92C096D%26displaylang%3Den">here</a> . <br>  There is another quite possible option, when a DA-client receives a certain IPv4-address from the provider, but at the same time, communication with the outside world is allowed only on 80 and 443 TCP ports.  In this case, a protocol that is no longer an RFC standard and which is supported only in Windows 7 and Windows Server 2008 R2 will help.  The protocol is called IP-HTTPS and, as the name implies, enables the transmission of IPv6 packets using HTTPS over IPv4.  I emphasize that this protocol will be activated only if the use of the above transit technologies was unsuccessful. <br>  Finally, if only port 80 is allowed, then a surprise surprise, DirectAccess will not work, and access to corporate resources from the outside will be impossible.  Who would have thought.  :) <br><br>  <b>Transit between DA-server and destination server</b> <br><br>  OK, the IPv6 packets reached the DA server.  In accordance with its own settings, the DA server forwards the IPv6 packets further to the corporate network to the destination server, either with or without encryption.  And here the question is, does your organization‚Äôs network environment support IPv6?  More specifically, do active communication equipment, especially routers, know how to work with IPv6? <br>  Consider a situation where the destination server supports IPv6, and the communication equipment does not.  Then another transit technology comes to the rescue - ISATAP (Intra-Site Automatic Tunnel Addressing Protocol, RFC 4214).  When using ISATAP, it is assumed that the host has at least one IPv4 address assigned in any manner accepted by the organization.  Otherwise, how the host generally interacts with other machines on the network.  Then the host's IPv6 address is generated automatically, with the last 32-bits of its IPv6 address corresponding to its IPv4 address.  For example, if two hosts from different segments start interacting, their addresses may look like this (see Table 1): <br><br>  Field Value <br><br>  IPv6 Source Address FE80 :: 5EFE: 10.40.1.29 <br>  IPv6 Destination Address FE80 :: 5EFE: 192.168.41.30 <br>  IPv4 Source Address 10.40.1.29 <br>  IPv4 Destination Address 192.168.41.30 <br>  Table 1 <br><br>  Therefore, when a DA server needs to send an IPv6 packet through an IPv4 router, the DA server uses DNS to determine the recipient's IPv4 address, builds an ISATAP type IPv6 packet based on this information, packages it into a normal IPv4 packet and forwards it to the recipient.  The latter unpacks the information in the reverse order and receives the original IPv6 packet, from the header of which it is clear that the packet is really intended for this host and can be subjected to further processing. <br><br>  <b>NAT-PT</b> <br><br>  The last option that needs to be noted is the option when the destination server in principle cannot work with IPv6.  By the way, I note that if we talk about Windows, then support for IPv6 in the operating systems of the family is implemented starting with Windows XP., Well, for example, Windows 2000?  I really want to get access to such machines from outside using DirectAccess.  In this case, a device supporting the NAT-PT specification (RFC 2766) is required.  NAT-PT is responsible for translating IPv6 addresses to IPv4 addresses, thereby allowing DA clients in our case to access IPv4-only hosts.  NAT-PT is not supported in either Windows 7 or Windows Server 2008 R2.  However, support for this mechanism is implemented in the Forefront Unified Access Gateway (UAG) product.  Being installed on Windows Server 2008 R2 and configured as a DA server, UAG offers some advanced DirectAccess features, including NAT-PT.  A UAG review is beyond the scope of this discussion.  Well, in addition, the implementation of NAT-PT can be found in other products, including non-Microsoft. <br>  Summing up the transit theme, it is important to note that from the administrator, and even more so from the user, there is no need for special separate configuration of all these technologies.  All that is needed to ensure transit is configured by the wizard when setting up the DA-server.  On DA clients, 6to4, Teredo, IP-HTTPS, ISATAP support is enabled automatically and is used when necessary. <br><br>  <b>IPsec over IPv6</b> <br><br>  IPsec is the foundation for protecting traffic between participants in a DirectAccess solution.  For IP protocol of the fourth version, the IPsec specification appeared much later than the IP protocol itself.  This, in particular, has led to the emergence of various implementations of IPsec over IPv4, sometimes not fully compatible with each other.  IPsec for IPv6 was designed simultaneously with the new IP protocol.  Support for IPsec headers is a requirement for implementing an IPv6 stack.  This creates the prerequisites for maximum compatibility of solutions from different suppliers.  On the other hand, this does not mean that when using IPv6 you must use IPsec.  But in the case of DirectAccess based on IPv6, the use of IPsec is the most logical way to protect the transmitted traffic. <br>  As with the fourth version of IPsec for IPv6, there are two security options: Authentication header (AH) and Encapsulating Security Payload (ESP).  In the first version, each package is, in fact, signed with a digital signature, which ensures the authentication of the data, guaranteeing their integrity during transmission.  However, the packet data is transmitted in clear text without encryption.  In the second variant, plus to the whole, the packet data is also encrypted, which ensures the confidentiality of the transmitted information.  Combinations of these options determine the so-called access model when deploying DirectAccess. <br>  The first model is called Full Intranet Access (End-to-Edge).  In this model, encrypted traffic is transmitted over IPsec from the DA client to the DA server.  The DA server decrypts the traffic and forwards the packets to the internal network in the open form.  In practice, this means that by reaching the DA-server, the DA-client further potentially gets access to the entire internal network.  Most often, this logic is used in VPN solutions. <br>  In the Selected Server Access (Modified End-to-Edge) model, traffic is still encrypted only up to the DA server.  And on the internal network, only authentication (AH) is used.  This approach allows only certain DA clients to access certain servers and applications on the corporate network (see Figure 3). <br><img src="https://habrastorage.org/storage/habraeffect/c7/27/c727f67aee0da90cc20bed2718b00478.jpg" alt="image"><br>  Fig.  3 <br><br>  It should be borne in mind that the OS to Vista IPsec over IPv6 is not fully implemented, therefore, in the figure, the servers that the DA client can reach through this model are labeled as Windows Server 2008 or later. <br>  Finally, in the End-to-End model (Figure 4), packets are encrypted on the DA client and decrypted already on the destination server.  DA-server just passes through this traffic. <br><img src="https://habrastorage.org/storage/habraeffect/6b/7d/6b7d3bea6179aa51fb5df326117d9532.jpg" alt="image"><br>  Fig.  four <br><br>  This approach provides the highest level of protection. <br>  In the end, specific IPsec settings are set in group policies, which can always be changed.  Thus, by manipulating the IPsec settings, you can apply the hybrid models that best suit your particular situation.  This is the added flexibility of the DirectAccess solution. <br><br>  <b>Name Resolution Policy Table</b> <br><br>  The latest technological foundation of DirectAccess is the Name Resolution Policy Table (NRPT), or rather the way to resolve names using this table and the DNS system.  When a DA client is on the Internet, it must understand which names are internal, and, accordingly, must be resolved by the corporate DNS server, and which ones by external ones, which must be resolved by DNS servers on the Internet. <br>  So the NRPT table allows you to specify a DNS server not for the network interface, but for a certain namespace.  Each time, while outside the corporate network, when resolving a name, for example srv1.contoso.com, the DA client first checks if there is a line for the given name or part of it in the NRPT.  If it does, the client contacts the DNS server specified in the corresponding NRPT line for the given namespace for resolving this name (see Figure 5).  If not, then the call occurs in the DNS server specified in the network interface settings, that is, to the DNS provider. <br><img src="https://habrastorage.org/storage/habraeffect/66/64/6664059c145696c19534dc0900381651.jpg" alt="image"><br>  Fig.  five <br><br>  In addition, there are so-called exemption-policies.  The names specified in these policies are always resolved only by external Internet DNS servers. <br>  However, it is important to emphasize once again that such a ‚Äúnon-standard‚Äù version of name resolution using NRPT is applied only when the DA client ‚Äúunderstands‚Äù that it is on the Internet, outside.  If it is in the internal grid, why make such a garden.  Therefore, there is an algorithm for determining the location of the DA client.  This algorithm, as well as infrastructure requirements and settings for the DA server itself, will be discussed in the third final post on DirectAccess. </div><p>Source: <a href="https://habr.com/ru/post/109963/">https://habr.com/ru/post/109963/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109957/index.html">New version of the program Family and New Year's action</a></li>
<li><a href="../109958/index.html">Russian President ignores (c)</a></li>
<li><a href="../109960/index.html">During the day it was sold 3.3 million copies of the game World of Warcraft: Cataclysm</a></li>
<li><a href="../109961/index.html">Amavis :: Custom - paint yourself</a></li>
<li><a href="../109962/index.html">Alt Linux may be installed in Russian schools</a></li>
<li><a href="../109965/index.html">The opening of applications for the FOSS conference in Lviv (February 2011)</a></li>
<li><a href="../109968/index.html">Intellectual property infringement is rape</a></li>
<li><a href="../109969/index.html">Hi-Fi in the digital age. Part 2</a></li>
<li><a href="../109970/index.html">The story of one repository</a></li>
<li><a href="../109971/index.html">Java 7 for Mac OS X: The Future Behind OpenJDK</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>