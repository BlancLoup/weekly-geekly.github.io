<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expansion of functionality without source code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think each of you had the feeling that in one program or another there was a lack of some must have feature. If the program comes with source code, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expansion of functionality without source code</h1><div class="post__text post__text-html js-mediator-article">  I think each of you had the feeling that in one program or another there was a lack of some must have feature.  If the program comes with source code, then there are no problems.  Anyone can add the necessary functionality.  What if the program is closed?  Do not despair, this is not a lost case.  Now I will tell you how you can add what is missing for the author. <br><a name="habracut"></a><br><h5>  Retreat </h5><br>  OllyDbg debugger again became my victim.  After the release of version 2.00, I began to like it more and more, many interesting things appeared.  But the author categorically refused to integrate the plugin system into it, and this can be said, the main thing that made the debugger a real working tool. <br>  And at one moment, I realized for myself that it was time to add this opportunity myself. <br><br><h5>  Let's get started </h5><br>  The first question comes up - how to add your code? <br>  There are two main ways: <br><ul><li>  Add a new section, and put all your code in it. </li><li>  Put the code in the dll, and then in the free space of the program put a small code call. </li></ul><br>  There are other more sophisticated options, but I will not consider them. <br><br>  I chose the second option, because it is more convenient in terms of programming, and I don‚Äôt need to copy my code to the exe every time.  To load your dll, you can change the entry point to your code, or download a little later.  But it is better to load at the very beginning, then we will have access to all APIs before the parent process takes advantage of them. <br>  I did not have to do the patch, I found the already patched one, I changed only the name of the module being loaded. <br>  It was: <br><img src="http://knikolenko.narod2.ru/ollycode_before.gif" alt="image"><br>  It became: <br><img src="http://knikolenko.narod2.ru/ollycode_after1.gif" alt="image"><br>  And our code.  The trick of the first call is that with one command it pushes the address of the line onto the stack and jumps over it. <br><img src="http://knikolenko.narod2.ru/ollycode_after2.gif" alt="image"><br>  Jmp at 00401000 is OEP from Borland C 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The plugin loading scheme is trivial: <br>  We read from ini the path to the folder with plug-ins, if it is not there, then we take the path by default and check the presence of the folder through the GetFileAttributes.  Well, then by mask * .dll, with the help of FindFirstFile / FindNextFile, we list all the files. <br>  Load each through LoadLibrary.  And the plugin, in turn, will pull the functions we export.  Since in the 1.10 version all functions were exported from exe, we need to do the same export table, with the same ordinals, so that everything is transparent for the plug-ins too.  But more about that later. <br><br>  Since almost all the plugins were controlled from the menu, it was necessary to somehow create and process your branch in the main menu.  To process messages, we need to get the address of the window function.  And where can I get it?  The simple way is to intercept RegisterClass and pull the address from it out of the WNDCLASS-&gt; lpfnWndProc structure field.  And of course in his place to write your own. <br>  The second option is to find in the code, and make jmp on yourself.  I certainly love perverted methods, but not this time. <br><br>  I will do any interception of functions directly in the import table, substituting my own handler procedure instead of the API address, and from it already into the API.  With this method, everything will be transparent for the debugger itself, and it will think that it works directly with the system. <br>  Do not forget to set the rights to write to this area before any editing of another's memory, otherwise access errors will occur. <br>  This is how the API call before editing looks like: <br><img src="https://habrastorage.org/storage1/c4bb1ca0/a973c50d/6ceffbd7/332cae9a.png"><br>  And a few moments later: <br><img src="https://habrastorage.org/storage1/67e07c43/c0d16974/ec9194f0/cea9cc63.png"><br>  Even repeated re-analysis does not help, so it thinks that there is a call to RegisterClassW, however in both areas below you can make sure that the address 005EEA44 is far from the API address. <br><br>  So, ‚Äúwhere‚Äù to process messages, we know, now we need to create, then what to process.  To do this, we intercept the AppendMenu in the same way.  And in the handler, we expect to add a menu, in front of which we want to insert our menu. <br>  As soon as it appeared, we have a wide choice of menu creation.  But I have limited myself so far with the MF_STRING options for displaying a single item, MF_POPUP for drop-down submenus, and MF_SEPARATOR for separators.  All menu items added through a slightly outdated InsertMenu.  First of all, this is less code, and secondly, Oleg (OllyDbg developer) uses this method himself. <br>  Do not forget at the very end to call the original API AppendMenu for yourself and for the subsequent menu branch for us. <br>  The whole addition will look generalized as follows: <br>  Request from OllyDbg on AppendMenu (Help) -&gt; our CreateMenu () -&gt; Several of our InsertMenu () -&gt; our AppendMenu (Plugins) -&gt; execute the query AppendMenu (Help). <br><br>  Creating a menu, you need to see in advance which IDs are free, and which will not intersect.  In WndProc for the menu, we will catch WM_COMMAND.  We filter out only ours by range, for example, using an associative array by ID =&gt; processing_address, we transfer control to the correct plugin. <br><br>  This is how OllyDbg 2.00c versions look like before and after my intervention: <br><img src="https://habrastorage.org/storage1/c1b62759/61925d26/2dc80366/3d4d2bcb.png"><br><br>  Now the most crucial question is to find the addresses of the functions that should be exported to plugins.  Do not expect to find in the release versions of applications debug-information, which could greatly help. <br>  Therefore, let's go the following way, ship to Ida Pro: <br><ul><li>  We are looking for text strings that are displayed in case of errors, they can tell us the purpose of functions. </li><li>  After squeezing everything out of the lines, it makes sense to find handlers for various menus, they also narrow the search range significantly. </li><li>  And finally, an unpleasant and time-consuming method.  We load the program into the debugger, and set the breakpoint on the low-level specific (or not) API.  And gradually we rise to the upper levels of abstraction, while glancing in parallel with Ida.  And so, until we come to the function, when you can clearly define what it does in general.  For convenience, we name the functions in Ida, and save the addresses found by ourselves separately. </li></ul><br><br>  I wrote all the mini plug-in manager for the day on my knee on Fasm.  Then in a couple of weeks I picked up about 30 functions.  But at that time it was not compatible with PDK 1.10, which did not prevent me from writing my own to hide the debugger, load characters from the map files generated by IdaPro, and a simple dumper. <br><br><h5>  A spoon of tar </h5><br>  Probably Oleg paid attention to my idea, and nevertheless made his own PDK in 2.01 alpha 4, which should have killed my project at once.  But there are a couple of moments.  The new build has become IMHO overloaded and inconvenient, and old plugins are not supported. <br><br>  At the moment, the plugin manager is completely rewritten from scratch to C ++, with plans for compatibility with all versions.  And the interception of several functions here will not get off ... <br><br>  Well, here you can see how not to write code, even on the knee in one day. <br>  Shoals and so I know, and therefore rewritten from scratch. <br>  <a href="http://narod.ru/disk/21993659001/plugman.zip.html">Sora on fasm</a> <br>  The updated version will be later when it is finished. <br><br>  Special thanks to the author OllyDbg and forum participants exel @ b for their active support, and habrovchanam for the amendments. </div><p>Source: <a href="https://habr.com/ru/post/126458/">https://habr.com/ru/post/126458/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126447/index.html">Oatmeal - Why is it better not to say that you understand computers?</a></li>
<li><a href="../126450/index.html">Labs on ROUTE: EIGRP - Solution</a></li>
<li><a href="../126453/index.html">New simple JavaScript editor in Firefox</a></li>
<li><a href="../126455/index.html">7 reasons to suffer the customer</a></li>
<li><a href="../126456/index.html">SmartOS: fully modern OS</a></li>
<li><a href="../126459/index.html">Life abroad</a></li>
<li><a href="../126461/index.html">Go Language. Small client server application</a></li>
<li><a href="../126463/index.html">HTC launched a service to unlock the bootloader in Sensation</a></li>
<li><a href="../126465/index.html">PlayStation on GamesCom</a></li>
<li><a href="../126466/index.html">American scientists have developed micro robots</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>