<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Non-standard application of IT in everyday life: parsing, perceptual hash, image comparison = cost optimization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to share an interesting story, about an unusual solution of one interesting problem that I came across a year ago. Everything d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Non-standard application of IT in everyday life: parsing, perceptual hash, image comparison = cost optimization</h1><div class="post__text post__text-html js-mediator-article">  In this article I want to share an interesting story, about an unusual solution of one interesting problem that I came across a year ago.  Everything described in the article was done, above all, ‚Äújust for fun‚Äù and out of pure academic interest ... <br>  It was a year ago, just had free time and a desire to do something useful.  Obviously there was some intellectual hunger and an acute shortage of something new, some interesting task ... Hence the attempt to stick the bike even to where it was not needed at all ... Actually, this bike is everything described below ... <br><br><h4>  1. Task </h4><br>  At one trade and procurement enterprise, the issue of procurement optimization was quite acute.  The company had several dozen major suppliers, but at the same time, many suppliers had an intersection of goods at 20‚Äì30%, and prices were different for everyone.  Unfortunately, the majority of goods were purchased ‚Äúby old memory‚Äù, for example, they got used to that goods of group A are supplied by supplier X, and goods of group B are supplied by supplier Y, although if we select goods not by groups, but by piece, then we can save money.  For clarity, I will show by example: <br><a name="habracut"></a><br><pre>  For supplier X:
 Product A1 - 11 rubles.
 Product A2 - 10 rubles.
 Product B1 - 10 rubles.
 Goods B2 - 11 rubles.

 At supplier Y:
 Product A1 - 10 rubles.
 Product A2 - 11 rubles.
 Product B1 - 11 rubles.
 Product B2 - 10.5 rubles.
</pre><br>  From the table it is obvious that A1 and B2 are more profitable to purchase from ‚ÄúY‚Äù, and A2 and B1 from ‚ÄúX‚Äù.  But it is easy and simple on the example of 4 positions of the nomenclature and 2 suppliers, and if the nomenclature totals tens of thousands of positions, and dozens of suppliers? <br>  It would seem that what the problem is is an elementary task, but it requires a lot of simple calculations, the volume is not lifting with your hands, so you need to quickly transfer it to the PC and reap the benefits?  Everything would be so if there was one single base with all the nomenclature and prices.  But alas, this is utopia ... the base was in the usual, terrible state of the garbage, in which only those who could dump it every day could somehow figure it out.  The prices are still worse, they are generally spread in different directories, prices, sites.  If you try to catalog and aggregate it somehow, it becomes obvious that it is extremely difficult without manual intervention.  One supplier uses the manufacturer‚Äôs article, the other one puts his own, and the third does not indicate them in prices at all.  The names almost never match, for example, the same product can be called: ‚ÄúVase with a pattern 'triangular pattern'‚Äù, ‚ÄúVase A-563‚Äù, ‚ÄúVase with a pattern‚Äù, finally, just ‚ÄúVase‚Äù :) <br>  It means that it was also absolutely useless to connect by names. <br><br><h4>  2. Crazy idea </h4><br>  And then there was a crazy idea.  The specificity of the product was such that almost everywhere there was a picture, moreover, the suppliers often took pictures in one place, or in general from each other.  There was one ‚ÄúBUT‚Äù, the pictures were naturally of different sizes, they could even be different proportions.  So a ‚Äúhead on‚Äù comparison will not help us.  But, after all, does Yandex somehow find similar images?  And why shouldn't we try?!?  Resolved! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The study of literature, reading Google, articles, gave an idea of ‚Äã‚Äãhow similar images search works.  In short: image hashes are built, and then hashes are compared with each other.  The main differences are precisely in hash functions.  The simplest and fastest, both in implementation and in the complexity of calculations, is the perceptual hash ‚Äúby mean value‚Äù. <br>  In short, the principle of operation: the image is compressed into a square, for example 16x16, then from the color image we get an image in grayscale, then, by the points of the square, we calculate the average color value, and then in the second pass for each point we put 0 or 1, depending on the color of this point is less than or greater than the mean.  The resulting sequence, 0th and 1th, is the hash we are looking for. <br><br>  In order to make a quick prototype, it was decided to use ImageMagick to process images, and php was chosen as the scripting language. <br>  As a material for tests, I took the image "Chrysanthemum.jpg", from the standard set of Windows.  I called the first file test1.jpg, then took the source file and distorted the proportions, saving it as test2.jpg.  As the 3rd sample I took ‚ÄúDesert.jpg‚Äù and named it test3.jpg.  Here they are: <br><br><div class="spoiler">  <b class="spoiler_title">Images for the test</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/17c/d50/f3b/17cd50f3b8d93eaad41ecb54b42bc951.jpg"><br><img src="https://habrastorage.org/getpro/habr/post_images/881/938/8ae/8819388ae1943ebc78d628187c81c41d.jpg"><br><img src="https://habrastorage.org/getpro/habr/post_images/6de/44d/980/6de44d980d109a88805623b77b7e9ea7.jpg"><br></div></div><br><br>  Next, call ImageMagick for preprocessing: <br><pre><code class="bash hljs">E:\ImageMagick\convert.exe E:\Article\img\test1.jpg -resize 16x16! -colorspace gray E:\Article\img\_test1.jpg E:\ImageMagick\convert.exe E:\Article\img\test2.jpg -resize 16x16! -colorspace gray E:\Article\img\_test2.jpg E:\ImageMagick\convert.exe E:\Article\img\test3.jpg -resize 16x16! -colorspace gray E:\Article\img\_test3.jpg</code> </pre> <br><br>  We get: <br><div class="spoiler">  <b class="spoiler_title">Images 16x16 grayscale</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/602/dba/ff1/602dbaff1bd0e5b72465c479678adcc1.jpg"><br><img src="https://habrastorage.org/getpro/habr/post_images/5a0/730/e58/5a0730e588c0d7221aeb509be7030dc0.jpg"><br><img src="https://habrastorage.org/getpro/habr/post_images/af8/f95/618/af8f956188fe00bb1a18e6f4bf424df3.jpg"><br></div></div><br><br>  Next, consider the hash itself: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPerceptHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($imgName)</span></span></span><span class="hljs-function"> </span></span>{ $im = imagecreatefromjpeg($imgName); <span class="hljs-comment"><span class="hljs-comment">//    ,     256 (16*16),     $summ = 0; for($i=0;$i&lt;8;$i++){ for($j=0;$j&lt;8;$j++){ $summ += imagecolorat($im, $i, $j); } } $sred = $summ/64; //               0  1 $str=''; for($i=0;$i&lt;8;$i++){ for($j=0;$j&lt;8;$j++){ if(imagecolorat($im, $i, $j)&gt;=$sred){ $str .= '1'; }else{ $str .= '0'; } } } //  16- ,   $str = base_convert($str, 2, 16); return $str; } echo '_test1.jpg '.getPerceptHash("E:\Denwer3\home\imagecomparer.loc\www\Article\img\_test1.jpg").'&lt;br&gt;'; echo '_test2.jpg '.getPerceptHash("E:\Denwer3\home\imagecomparer.loc\www\Article\img\_test2.jpg").'&lt;br&gt;'; echo '_test3.jpg '.getPerceptHash("E:\Denwer3\home\imagecomparer.loc\www\Article\img\_test3.jpg").'&lt;br&gt;'; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  We get the result: <br><pre> _test1.jpg f9f6f0f0e0b0f000
 _test2.jpg fbf6f0f0c0b0f000
 _test3.jpg 1e1e3e3e3e3e3c00
</pre><br><br>  We see that the first and second hashes are very close, and the third is not even close.  There was also a series of other experiments, the method works. <br><br><h4>  3. Attempt to put into practice </h4><br>  The comparison method was found, verified, it worked on test examples.  It was time to check it out in battle.  It took several days to write various parsers of directories / prices / vendor sites, and the parsing itself.  All information + hashes were added to the database, and the images themselves to disk, for further experiments.  In total, about 3 million records were collected in the database. <br>  At the beginning, the method worked, but as the base grew, the results got worse and worse until they just fell into the dustbin.  There was a bunch of false positives.  The method worked well on images that were simply resized, but if the image was color-corrected, cropped, or even worse, watermark was applied to it (which was very, very often), then the result was bad. <br><br><h4>  4. pHash </h4><br>  It was obvious that the used hash function does not suit us, we need something more serious.  It was decided to use pHash based on <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D1%2581%25D0%25BA%25D1%2580%25D0%25B5%25D1%2582%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BA%25D0%25BE%25D1%2581%25D0%25B8%25D0%25BD%25D1%2583%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25B5%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">discrete cosine transform</a> <br><br>  By itself, the algorithm is hard and attempts to implement it in php did not end with anything good.  The solution was to make a console utility on the SI, which would get the path to the file at the input, would consider the hash and return it.  A library was found <a href="http://www.phash.org/">http://www.phash.org/</a> <br><br>  Then a test sample using this library was quickly written: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stdafx.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;windows.h&gt; using namespace std; #ifndef _WIN32 typedef unsigned _uint64 ulong64; typedef signed _int64 long64; #else typedef unsigned long long ulong64; typedef signed long long long64; typedef unsigned char uint8_t; typedef unsigned int uint32_t; #endif typedef int (*ph_dct_imagehash)(const char* file,ulong64 &amp;hash); int _tmain(int argc, TCHAR* argv[]) { if (argc &gt; 1) { char* filename = (char *)malloc( 255 ); wcstombs( filename, argv[1], 255 ); ph_dct_imagehash _ph_dct_imagehash; HINSTANCE hInstLibrary = LoadLibrary(L"pHash.dll"); if (hInstLibrary) { _ph_dct_imagehash = (ph_dct_imagehash)GetProcAddress(hInstLibrary, "ph_dct_imagehash"); int err = 0; err = GetLastError(); ulong64 myhash=0; _ph_dct_imagehash(filename, myhash); std::cout &lt;&lt; myhash &lt;&lt; std::endl; FreeLibrary(hInstLibrary); } else { return 0; } }else{ return 0; } return 0; }</span></span></span></span></code> </pre><br><br>  Compile, we get at the output - pHashConcole.exe <br><br>  From php, this construct is invoked through the usual exex: <br><pre> <code class="php hljs">$pHash=exec(<span class="hljs-string"><span class="hljs-string">'E:\Article\pHashConsole.exe "'</span></span>.$filename.<span class="hljs-string"><span class="hljs-string">'"'</span></span>);</code> </pre><br><br>  The hashes were added to the MySQL table, and the search result can be obtained with a very simple query: <br><pre> <code class="sql hljs">'<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * , <span class="hljs-keyword"><span class="hljs-keyword">BIT_COUNT</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">hash</span></span> ^ <span class="hljs-string"><span class="hljs-string">'.$pHash.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> distance <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> images <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> distance <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> , <span class="hljs-number"><span class="hljs-number">100</span></span>) s1 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> distance &lt; <span class="hljs-string"><span class="hljs-string">'.$precision.'</span></span>;'</code> </pre><br><pre> Where, $ pHash is the hash for which we are looking for similar ones.
 $ precision - accuracy, the more, the more results will be, but the more distant from the original they will be.  It is selected empirically.
</pre><br><br>  Using pHash made it possible to find not only scaled images, but also images with inscriptions, watermarks, and parts that have been color-corrected or cut out. <br><br><h4>  5. The End! </h4><br>  As a result of all these manipulations, it was possible to solve the task and, without manual analysis, collect a common base, thanks to which it was possible to optimize the expenses of the enterprise for procurement.  Such a seemingly insane idea turned out to be not only feasible, but also useful in practice, thanks to which a tangible result was obtained. <br><br>  That's such a funny story ... <br><br>  Thank you all for your attention!  The End! </div><p>Source: <a href="https://habr.com/ru/post/210388/">https://habr.com/ru/post/210388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210372/index.html">References for product manager level 80</a></li>
<li><a href="../210374/index.html">Employees of Google, Microsoft, Cisco and Apple went to Twitter, Box and Dropbox</a></li>
<li><a href="../210382/index.html">CES 2014 results: new ATIV line devices</a></li>
<li><a href="../210384/index.html">"Debriefing" - Dart-Anyang web development</a></li>
<li><a href="../210386/index.html">What is the theory and where does the scientific method</a></li>
<li><a href="../210390/index.html">7 simple optimizations that reduce the CPU load from 80% to 27%</a></li>
<li><a href="../210406/index.html">Lexand Capella: a smartphone with Full HD-screen and support for two SIM-cards for 9,600 rubles ($ 280)</a></li>
<li><a href="../210408/index.html">Forgotten zoom</a></li>
<li><a href="../210410/index.html">Implement an L2TP / IPsec VPN server using standard Windows 7/8 tools for connecting Windows / iOS / Android systems to an internal network</a></li>
<li><a href="../210412/index.html">The legacy of Konrad Zuse: Architecture Z1 and Z3 [Translation]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>