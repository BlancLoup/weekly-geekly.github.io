<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Own index types in Cach√© DBMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the object and relational data models of the Cach√© DBMS, there are three types of indices - regular, bitmap and bitslice . If for some reason these...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Own index types in Cach√© DBMS</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/post/272689/"><img src="https://habrastorage.org/files/6c7/a54/754/6c7a547547284690aaf4668949b8b29e.jpg" title="Nikolai Zagrekov - Peasant with scythe" align="left"></a>  In the object and relational data models of the Cach√© DBMS, there are three types of indices - regular, <a href="">bitmap</a> and <a href="">bitslice</a> .  If for some reason these indexes are not enough, starting from version 2013.1 the programmer can determine his type of indexes and use it in any classes. <br><br>  Details under the cut (if you are not afraid of words like method-generator). <br><a name="habracut"></a><br>  ‚ÄúOwn type of indexes‚Äù is a class that implements the methods of the <i>% Library.FunctionalIndex</i> interface for inserting / deleting / changing values ‚Äã‚Äãin the index.  This class can be specified as an index type in the index definition. <br><br>  For example: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs delphi"><span class="hljs-keyword"><span class="hljs-keyword">Property</span></span> A <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Property</span></span> B <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> someind <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> (A,B) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> CustomPackage.CustomIndex;</code> </pre> <br>  The <i>CustomPackage.CustomIndex</i> class is just the implementation of its type of indexes. <br><br>  As an example, consider a small prototype of the quad-tree index for spatial data, created on the <a href="http://habrahabr.ru/company/intersystems/blog/267459/">hackathon</a> by a team composed of Andrei <a href="http://habrahabr.ru/users/arechitsky/" class="user_link">ARechitsky</a> Rechitsky, <a href="https://github.com/APogrebnikov">Alexander Pogrebnikov</a> and the author of these lines.  The hackathon was held as part of the annual school of developers InterSystems (special thanks to the mastermind of the hackathon <a href="http://habrahabr.ru/users/tsafin/" class="user_link">tsafin</a> ).  The materials of the school, by the way, are available on <a href="http://www.intersystems.com/ru/who-we-are/events/event/school-2015/">our website</a> . <br><br>  In this article we will not touch on what a quad tree is and how to work with it. <br><br>  Let us dwell on the creation of a class that implements the <i>% Library.FunctionalIndex</i> interface for the current implementation of a quadtree.  She was engaged in our hackathon team Andrei.  Andrei created the class <i>SpatialIndex.Indexer</i> , which knew how two methods - <i>Insert (x, y, id)</i> and <i>Delete (x, y, id)</i> .  When creating an object of the <i>SpatialIndex.Indexer</i> class <i>,</i> it was necessary to specify the global node in whose subnodes an index was written.  It remained for me to create the <i>SpatialIndex.Index</i> class that implements the <i>InsertIndex</i> , <i>UpdateIndex</i> , <i>DeleteIndex,</i> and <i>PurgeIndex methods</i> .  The first three of these methods take as input the <i>Id of the</i> row to be changed and the values ‚Äã‚Äãto be indexed in the same order as in the definition of the index in the class where this index is used.  In our example, <i>pArg (1)</i> is <i>A</i> , <i>pArg (2)</i> is <i>B.</i> <br><br><pre> <code class="hljs mel">Class SpatialIndex.Index Extends %Library.FunctionalIndex [ System = <span class="hljs-number"><span class="hljs-number">3</span></span> ] { ClassMethod InsertIndex(pID As %CacheString, pArg... As %Binary) [ CodeMode = generator, ServerOnly = <span class="hljs-number"><span class="hljs-number">1</span></span> ] { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %mode<span class="hljs-string"><span class="hljs-string">'="method" { //'</span></span> set IndexGlobal = ..IndexLocation(%class,%property) $$$GENERATE($C(<span class="hljs-number"><span class="hljs-number">9</span></span>)_<span class="hljs-string"><span class="hljs-string">"set indexer = ##class(SpatialIndex.Indexer).%New($Name("</span></span>_IndexGlobal_<span class="hljs-string"><span class="hljs-string">"))"</span></span>) $$$GENERATE($C(<span class="hljs-number"><span class="hljs-number">9</span></span>)_<span class="hljs-string"><span class="hljs-string">"do indexer.Insert(pArg(1),pArg(2),pID)"</span></span>) } } ClassMethod UpdateIndex(pID As %CacheString, pArg... As %Binary) [ CodeMode = generator, ServerOnly = <span class="hljs-number"><span class="hljs-number">1</span></span> ] { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %mode<span class="hljs-string"><span class="hljs-string">'="method" { //'</span></span> set IndexGlobal = ..IndexLocation(%class,%property) $$$GENERATE($C(<span class="hljs-number"><span class="hljs-number">9</span></span>)_<span class="hljs-string"><span class="hljs-string">"set indexer = ##class(SpatialIndex.Indexer).%New($Name("</span></span>_IndexGlobal_<span class="hljs-string"><span class="hljs-string">"))"</span></span>) $$$GENERATE($C(<span class="hljs-number"><span class="hljs-number">9</span></span>)_<span class="hljs-string"><span class="hljs-string">"do indexer.Delete(pArg(3),pArg(4),pID)"</span></span>) $$$GENERATE($C(<span class="hljs-number"><span class="hljs-number">9</span></span>)_<span class="hljs-string"><span class="hljs-string">"do indexer.Insert(pArg(1),pArg(2),pID)"</span></span>) } } ClassMethod DeleteIndex(pID As %CacheString, pArg... As %Binary) [ CodeMode = generator, ServerOnly = <span class="hljs-number"><span class="hljs-number">1</span></span> ] { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %mode<span class="hljs-string"><span class="hljs-string">'="method" { //'</span></span> set IndexGlobal = ..IndexLocation(%class,%property) $$$GENERATE($C(<span class="hljs-number"><span class="hljs-number">9</span></span>)_<span class="hljs-string"><span class="hljs-string">"set indexer = ##class(SpatialIndex.Indexer).%New($Name("</span></span>_IndexGlobal_<span class="hljs-string"><span class="hljs-string">"))"</span></span>) $$$GENERATE($C(<span class="hljs-number"><span class="hljs-number">9</span></span>)_<span class="hljs-string"><span class="hljs-string">"do indexer.Delete(pArg(1),pArg(2),pID)"</span></span>) } } ClassMethod PurgeIndex() [ CodeMode = generator, ServerOnly = <span class="hljs-number"><span class="hljs-number">1</span></span> ] { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %mode<span class="hljs-string"><span class="hljs-string">'="method" { //'</span></span> set IndexGlobal = ..IndexLocation(%class,%property) $$$GENERATE($C(<span class="hljs-number"><span class="hljs-number">9</span></span>)_<span class="hljs-string"><span class="hljs-string">"kill "</span></span> _ IndexGlobal) } } ClassMethod IndexLocation(className As %String, indexName As %String) As %String { set storage = ##class(%Dictionary.ClassDefinition).%OpenId(className).Storages.GetAt(<span class="hljs-number"><span class="hljs-number">1</span></span>).IndexLocation <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span> $Name(@storage@(indexName)) } }</code> </pre> <br>  The <i>IndexLocation</i> method is auxiliary, by the name of the class and the index it returns the name of the global node in which to store the index values. <br><br>  Consider a test class with an index of type <i>SpatialIndex.Index</i> : <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> SpatialIndex.Test Extends %Persistent { Property <span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String(MAXLEN = <span class="hljs-number"><span class="hljs-number">300</span></span>); Property Latitude <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String; Property Longitude <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String; <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> coord <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> (Latitude, Longitude) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> SpatialIndex.<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>; }</code> </pre> <br>  When compiling the <i>SpatialIndex.Test</i> class <i>,</i> for each index of the <i>SpatialIndex.Index</i> type, the <i>following</i> methods are generated in the INT code: <br><br><pre> <code class="hljs vbscript">zcoordInsertIndex(pID,pArg...) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> indexer = ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SpatialIndex.Indexer).%<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>($Name(^SpatialIndex.TestI(<span class="hljs-string"><span class="hljs-string">"coord"</span></span>)))   <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> indexer.Insert(pArg(<span class="hljs-number"><span class="hljs-number">1</span></span>),pArg(<span class="hljs-number"><span class="hljs-number">2</span></span>),pID) } zcoordPurgeIndex() <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> {   kill ^SpatialIndex.TestI(<span class="hljs-string"><span class="hljs-string">"coord"</span></span>) } zcoordSegmentInsert(pIndexBuffer,pID,pArg...) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ..coordInsertIndex(pID, pArg...) } zcoordUpdateIndex(pID,pArg...) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> indexer = ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SpatialIndex.Indexer).%<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>($Name(^SpatialIndex.TestI(<span class="hljs-string"><span class="hljs-string">"coord"</span></span>)))   <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> indexer.Delete(pArg(<span class="hljs-number"><span class="hljs-number">3</span></span>),pArg(<span class="hljs-number"><span class="hljs-number">4</span></span>),pID)   <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> indexer.Insert(pArg(<span class="hljs-number"><span class="hljs-number">1</span></span>),pArg(<span class="hljs-number"><span class="hljs-number">2</span></span>),pID) }</code> </pre> <br>  And the <i>% SaveData</i> , <i>% DeleteData</i> , <i>% SQLInsert</i> , <i>% SQLUpdate</i> , <i>% SQLDelete</i> methods call index methods.  For example, in <i>% SaveData</i> : <br><br><pre> <code class="hljs perl"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> insert {    <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ...    <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ..coordInsertIndex(id,i%Latitude,i%Longitude,<span class="hljs-string"><span class="hljs-string">""</span></span>)    // ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {    <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ...    <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ..coordUpdateIndex(id,i%Latitude,i%Longitude,zzc27v3,zzc27v2,<span class="hljs-string"><span class="hljs-string">""</span></span>)    // ... }</code> </pre> <br>  The fun example is to look at a working example - download files from the repository <a href="https://github.com/intersystems-ru/spatialindex/tree/no-web-interface">https://github.com/intersystems-ru/spatialindex/tree/no-web-interface</a> .  This is a link to a branch without a web interface.  Import the classes themselves, unzip RuCut.zip and download the data: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> $system.OBJ.LoadDir(<span class="hljs-string"><span class="hljs-string">"c:\temp\spatialindex"</span></span>,<span class="hljs-string"><span class="hljs-string">"ck"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(SpatialIndex.Test).load(<span class="hljs-string"><span class="hljs-string">"c:\temp\rucut.txt"</span></span>)</code> </pre><br>  The file rucut.txt stores data about 100'000 locations in Russia - the name and coordinates.  The <i>load</i> method reads each line from the file and saves it as an object of the <i>SpatialIndex.Test</i> class.  After its execution in the global <i>^ SpatialIndex.TestI (‚Äúcoord‚Äù), the</i> quadtree will be stored in <i>Latitude</i> and <i>Longitude</i> coordinates. <br><br><h2>  And now requests </h2><br>  Build index - half the battle.  The most interesting thing is when queries can use this index.  For indexes of non-standard types, there is a standard syntax for using them, which looks like this: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SpatialIndex.Test <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> %FIND search_index(coord, <span class="hljs-string"><span class="hljs-string">'window'</span></span>, <span class="hljs-string"><span class="hljs-string">'minx=56,miny=56,maxx=57,maxy=57'</span></span>)</code> </pre><br>  Here <i>% ID% FIND search_index</i> is the fixed part.  Next comes the name of the index, note without quotes.  All other parameters <i>('window', 'minx = 56, miny = 56, maxx = 57, maxy = 57)</i> are passed to the <i>Find</i> method, which also needs to be defined in the class describing the type of index (in our case, <i>SpatialIndex.Index</i> ): <br><br><pre> <code class="hljs pgsql">ClassMethod Find(queryType <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Binary, queryParams <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Library.Binary [ CodeMode = generator, ServerOnly = <span class="hljs-number"><span class="hljs-number">1</span></span>, SqlProc ] { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %mod<span class="hljs-string"><span class="hljs-string">e'="method" { //'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> IndexGlobal = ..IndexLocation(%<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>,%property) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> IndexGlobalQ = $$<span class="ruby"><span class="ruby">$QUOTE(IndexGlobal) $$</span></span>$GENERATE($C(<span class="hljs-number"><span class="hljs-number">9</span></span>)_"set result = ##class(SpatialIndex.SQLResult).%New()") $$<span class="perl"><span class="perl">$GENERATE($C(</span><span class="hljs-number"><span class="perl"><span class="hljs-number">9</span></span></span><span class="perl">)</span><span class="hljs-number"><span class="perl"><span class="hljs-number">_</span></span></span><span class="hljs-string"><span class="perl"><span class="hljs-string">"do result.PrepareFind($Name("</span></span></span><span class="perl">_IndexGlobal</span><span class="hljs-number"><span class="perl"><span class="hljs-number">_</span></span></span><span class="hljs-string"><span class="perl"><span class="hljs-string">"), queryType, queryParams)"</span></span></span><span class="perl">) $$</span></span>$GENERATE($C(<span class="hljs-number"><span class="hljs-number">9</span></span>)_"quit result") } }</code> </pre> <br>  There are two parameters here - <i>queryType</i> and <i>queryParams</i> , but this is absolutely not necessary, there may be more or less. <br><br>  The <i>Find</i> method when compiling a class in which the <i>SpatialIndex.Index</i> index is used generates a helper method <i>z &lt;IndexName&gt; Find</i> , which is called when executing SQL queries: <br><br><pre> <code class="hljs dos">zcoordFind(queryType,queryParams) public { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>:'$isobject($get(%sqlcontext)) <span class="hljs-variable"><span class="hljs-variable">%sqlcontext=##class(%</span></span>Library.ProcedureContext).%New()   <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> result = ##class(SpatialIndex.SQLResult).%New()   <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> result.PrepareFind($Name(^SpatialIndex.TestI("coord")), queryType, queryParams)   quit result }</code> </pre><br>  The <i>Find</i> method must return an instance of the class that implements the <i>% SQL.Abstract</i> interface.  The methods of this interface are <i>NextChunk</i> , <i>PreviousChunk</i> return bit strings in chunks of 64000 bits <i>each</i> .  If the entry with the <i>ID</i> number satisfies the sample conditions, then the corresponding bit (number_bit * 64000 + position_number_internal_bit) is set to 1. <br><br><pre> <code class="hljs mel">Class SpatialIndex.SQLResult Extends %SQL.AbstractFind { Property ResultBits [ MultiDimensional, Private ]; Method %OnNew() As %Status [ Private, ServerOnly = <span class="hljs-number"><span class="hljs-number">1</span></span> ] { kill i%ResultBits kill qHandle <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span> $$$OK } Method PrepareFind(indexGlobal As %String, queryType As %String, queryParams As %Binary) As %Status { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> queryType = <span class="hljs-string"><span class="hljs-string">"window"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">4</span></span> { set item = $Piece(queryParams, <span class="hljs-string"><span class="hljs-string">","</span></span>, i) set param = $Piece(item, <span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) set value = $Piece(item, <span class="hljs-string"><span class="hljs-string">"="</span></span> ,<span class="hljs-number"><span class="hljs-number">2</span></span>) set arg(param) = value } set qHandle(<span class="hljs-string"><span class="hljs-string">"indexGlobal"</span></span>) = indexGlobal <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##class(SpatialIndex.QueryExecutor).InternalFindWindow(.qHandle,arg(<span class="hljs-string"><span class="hljs-string">"minx"</span></span>),arg(<span class="hljs-string"><span class="hljs-string">"miny"</span></span>),arg(<span class="hljs-string"><span class="hljs-string">"maxx"</span></span>),arg(<span class="hljs-string"><span class="hljs-string">"maxy"</span></span>)) set id = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { set id = $O(qHandle(<span class="hljs-string"><span class="hljs-string">"data"</span></span>, id),<span class="hljs-number"><span class="hljs-number">1</span></span>,idd) <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span>:id=<span class="hljs-string"><span class="hljs-string">""</span></span> set tChunk = (idd\<span class="hljs-number"><span class="hljs-number">64000</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>, tPos=(idd#<span class="hljs-number"><span class="hljs-number">64000</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span> set $BIT(i%ResultBits(tChunk),tPos) = <span class="hljs-number"><span class="hljs-number">1</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span> $$$OK } Method ContainsItem(pItem As %String) As %Boolean { set tChunk = (pItem\<span class="hljs-number"><span class="hljs-number">64000</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>, tPos=(pItem#<span class="hljs-number"><span class="hljs-number">64000</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span> $bit($get(i%ResultBits(tChunk)),tPos) } Method GetChunk(pChunk As %Integer) As %Binary { <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span> $get(i%ResultBits(pChunk)) } Method NextChunk(ByRef pChunk As %Integer = <span class="hljs-string"><span class="hljs-string">""</span></span>) As %Binary { set pChunk = $order(i%ResultBits(pChunk),<span class="hljs-number"><span class="hljs-number">1</span></span>,tBits) <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span>:pChunk=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span> tBits } Method PreviousChunk(ByRef pChunk As %Integer = <span class="hljs-string"><span class="hljs-string">""</span></span>) As %Binary { set pChunk = $order(i%ResultBits(pChunk),<span class="hljs-number"><span class="hljs-number">-1</span></span>,tBits) <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span>:pChunk=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">quit</span></span> tBits } }</code> </pre><br>  The <i>InternalFindWindow</i> method of the <i>SpatialIndex.QueryExecutor</i> class in the example above is an implementation of searching for points that fall into a given rectangle.  Further, in the FOR loop, the <i>IDs of the</i> matching strings are written into bit sets. <br><br>  In our hackathon project, in addition to searching in a rectangle, Andrey implemented a search inside the oval: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SpatialIndex.Test <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> %FIND search_index(coord,<span class="hljs-string"><span class="hljs-string">'radius'</span></span>,<span class="hljs-string"><span class="hljs-string">'x=55,y=55,radiusX=2,radiusY=2'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> %StartsWith <span class="hljs-string"><span class="hljs-string">'Z'</span></span></code> </pre><br><h2>  A bit about <i>% FIND</i> predicate </h2><br>  This predicate has an additional parameter <i>SIZE</i> , which can prompt the query optimizer an approximate order of the number of rows that will satisfy the predicate.  Based on this parameter, the optimizer will choose whether or not to use the index to which <i>% FIND</i> refers. <br><br>  For example, let's add the following index to the <i>SpatialIndex.Test</i> class: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> ByName <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span>;</code> </pre> <br>  Recompile the class and build this index: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(SpatialIndex.Test).%BuildIndices($LB("ByName"))</code> </pre> <br>  And, of course, run TuneTable: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> $system.SQL.TuneTable(<span class="hljs-string"><span class="hljs-string">"SpatialIndex.Test"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  Consider the query plan: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SpatialIndex.Test <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> %startswith <span class="hljs-string"><span class="hljs-string">'za'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> %FIND search_index(coord,<span class="hljs-string"><span class="hljs-string">'radius'</span></span>,<span class="hljs-string"><span class="hljs-string">'x=55,y=55,radiusX=2,radiusY=2'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> ((<span class="hljs-number"><span class="hljs-number">10</span></span>))</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/987/fdc/7cd/987fdc7cd70836888656dab1c8110eee.png"><br><br>  The coord index is supposed to return few rows, so the optimizer will not apply to the index by the <i>Name</i> field. <br><br>  Another picture for the request: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SpatialIndex.Test <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> %startswith <span class="hljs-string"><span class="hljs-string">'za'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> %FIND search_index(coord,<span class="hljs-string"><span class="hljs-string">'radius'</span></span>,<span class="hljs-string"><span class="hljs-string">'x=55,y=55,radiusX=2,radiusY=2'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> ((<span class="hljs-number"><span class="hljs-number">1000</span></span>))</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/d11/71a/17e/d1171a17e0ea659c3aff5195fc22e2c9.png"><br><br>  When executing this query, both indexes will be used. <br><br>  As a final example, a query that uses only an index across the <i>Name</i> field ‚Äî using the <i>coord</i> index, if it is expected that it returns about 100,000 lines, is useless: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SpatialIndex.Test <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> %startswith <span class="hljs-string"><span class="hljs-string">'za'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> %FIND search_index(coord,<span class="hljs-string"><span class="hljs-string">'radius'</span></span>,<span class="hljs-string"><span class="hljs-string">'x=55,y=55,radiusX=2,radiusY=2'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> ((<span class="hljs-number"><span class="hljs-number">100000</span></span>))</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/5b9/a61/77a/5b9a6177acadb2f304da394cee4bd95b.png"><br><br>  Thanks to all who read or at least looked through this article to the end. <br><br>  In addition to the documentation, links to which are slightly lower, other implementations of the <i>% Library.FunctionalIndex</i> and <i>% SQL.AbstractFind</i> interfaces will be of great help.  To see these implementations, open one of these classes in the studio and select Class -&gt; Inherited Classes from the menu. <br><br>  References: <br><ul><li>  <a href="">% FIND</a> </li><li>  <a href="">search_index</a> </li><li>  <a href="">% SQL.AbstractFind</a> </li><li>  <a href="">% Library.FunctionalIndex</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/272689/">https://habr.com/ru/post/272689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272673/index.html">Shadows of the characters in the video The Blacksmith</a></li>
<li><a href="../272675/index.html">PostgreSQL Designing a Document-Oriented API: Comprehensive Queries (Part 4)</a></li>
<li><a href="../272677/index.html">Perl5 plugin for IntelliJ IDEA v1.2: Moose and Signatures</a></li>
<li><a href="../272679/index.html">Neural network in Python, part 2: gradient descent</a></li>
<li><a href="../272681/index.html">Compare Swift and Rust</a></li>
<li><a href="../272693/index.html">Microsoft fixed a dangerous vulnerability in Windows Server</a></li>
<li><a href="../272695/index.html">As I have been rewriting my cryptocurrency with PHP for Go for 8 months. Part 1</a></li>
<li><a href="../272697/index.html">Optimizing hyperparameters in Vowpal Wabbit with the new vw-hyperopt module</a></li>
<li><a href="../272701/index.html">How to graze cats. The history of building a system of control and accounting of working time for an IT company</a></li>
<li><a href="../272703/index.html">The WikiLeaks Revolution: The Digest of Mishaps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>