<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Static analysis ‚Üí vulnerability ‚Üí profit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the articles about PVS-Studio , they are increasingly talking about vulnerabilities and security defects that can be found using static analysis. T...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Static analysis ‚Üí vulnerability ‚Üí profit</h1><div class="post__text post__text-html js-mediator-article"><p>  In the articles about <a href="https://habrahabr.ru/company/PVS-studio/">PVS-Studio</a> , they are increasingly talking about vulnerabilities and security defects that can be found using static analysis.  The authors of these articles are criticized ( <a href="https://habrahabr.ru/company/pvs-studio/blog/324114/">including</a> myself) that not every mistake is a security defect.  However, an interesting question arises whether it is possible to go all the way from reporting a static analyzer to operating a found problem and obtaining some benefit.  In my case, the benefit still remained theoretical, but it was possible to exploit the error, not really delving into the project code. </p><a name="habracut"></a><br><p>  Imagine that you are developing an obfuscator for Java classes.  Your business is to make it difficult to extract source code from .class files, including using the decompilers available on the market.  In addition to standard obfuscation techniques, it is quite reasonable to look for bugs in known decompilers and exploit them.  If the popular decompiler just crashes on the code you generated, customers will be very happy. </p><br><p>  One of the popular decompilers is Fernflower from JetBrains, which is part of IntelliJ IDEA.  JetBrains doesn‚Äôt really care about distributing it separately, but it can be collected from source files by downloading IntelliJ Community Edition from the <a href="https://github.com/JetBrains/intellij-community/tree/master/plugins/java-decompiler">repository</a> .  It is even easier to pull off the unofficial <a href="https://github.com/fesh0r/fernflower">mirror</a> : there‚Äôs no need to pump out the entire IDEA.  I'll take a recent commit <a href="https://github.com/fesh0r/fernflower/commit/d706718b1b22dfe2e378bd06c21c2cd8a8b194c7">d706718</a> .  Fernflower is going to run ant, does not require external dependencies and produces fernflower.jar, which can be used as a command line application: </p><br><pre><code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$ java -jar fernflower.jar Usage: java -jar fernflower.jar [-&lt;option&gt;=&lt;value&gt;]* [&lt;source&gt;]+ &lt;destination&gt; Example: java -jar fernflower.jar -dgs=true c:</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">my</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">source</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">c:</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">my</span></span></span></span></span><span class="hljs-formula">.jar d:</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">decompiled</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span></span></span></code> </pre> <br><p>  After recent improvements, the static IDEA analyzer has grown wiser and started issuing a warning in the <a href="">ConverterHelper :: getNextClassName method</a> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Character.isDigit(shortName.charAt(index))) { index++; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index == <span class="hljs-number"><span class="hljs-number">0</span></span> || index == shortName.length()) { <span class="hljs-comment"><span class="hljs-comment">// &lt;&lt;== return "class_" + (classCounter++); } else { ... }</span></span></code> </pre> <br><p>  The warning is: </p><br><blockquote>  Condition 'index == shortName.length ()' is always 'false' when reached </blockquote><p>  Such warnings about always true or always false condition are very interesting.  Often they indicate a bug not in this condition, but in some other place above.  Unaccustomed to even difficult to understand why such a conclusion was made.  Here before the condition was a while loop, the exit condition in which contains <code>shortName.charAt(index)</code> : get the character of the string at the index.  It is significant that the index cannot be greater than or equal to the length of the string: otherwise, <code>charAt</code> will be <code>charAt</code> with the exception <code>IndexOutOfBoundsException</code> .  Thus, if the cycle has reached <code>index == shortName.length()</code> , then we will not be able to get out of the cycle normally, and we are guaranteed to fall.  And if you <code>index == shortName.length()</code> loop normally, then the condition <code>index == shortName.length()</code> really always false. </p><br><p>  Next, you need to figure out whether an exception can occur or just an extra condition.  In the framework of this method, this situation does not contradict anything, it suffices that the entire <code>shortName</code> string <code>shortName</code> of only digits.  Great, it smells like a real bug.  But can a line consisting of one numbers get into this method?  We look at two points of calling this method: <a href="">ClassesProcessor :: new</a> and <a href="">IdentifierConverter :: renameClass</a> .  In both cases, the name of a class without a package is passed as <code>shortName</code> , which according to the rules of the Java Virtual Machine may well consist of numbers.  And in both cases, this code is executed under the condition <a href="">ConverterHelper :: toBeRenamed</a> .  The condition is a bit muddy, but it can be seen that it will work if the class name begins with a digit. </p><br><p>  Apparently, this code is responsible for renaming classes if their name is valid for the virtual machine, but not valid for the Java language.  Great, let's generate a correct class with a name from numbers.  Take your favorite <a href="http://asm.ow2.org/">ASM</a> and go ahead.  It is desirable for a class to <a href="https://habrahabr.ru/post/250029/">have a constructor</a> .  We print something in it: </p><br><pre> <code class="java hljs">String className = <span class="hljs-string"><span class="hljs-string">"42"</span></span>; ClassWriter cw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassWriter(ClassWriter.COMPUTE_MAXS); <span class="hljs-comment"><span class="hljs-comment">// public class 42 extends Object { cw.visit(Opcodes.V1_6, ACC_PUBLIC | ACC_SUPER, className, null, "java/lang/Object", new String[0]); // private 42() { MethodVisitor ctor = cw.visitMethod(ACC_PRIVATE, "&lt;init&gt;", "()V", null, null); // super(); ctor.visitIntInsn(ALOAD, 0); ctor.visitMethodInsn(INVOKESPECIAL, "java/lang/Object", "&lt;init&gt;", "()V", false); // System.out.println("In constructor!"); callPrintln(ctor, "In constructor!"); // return; ctor.visitInsn(RETURN); ctor.visitMaxs(-1, -1); ctor.visitEnd(); // }</span></span></code> </pre> <br><p>  Well, to check that the class is really normal, let's make it <code>main</code> with honest <code>Hello World</code> : </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// public static void main(String[] args) { MethodVisitor main = cw.visitMethod(ACC_PUBLIC|ACC_STATIC, "main", "([Ljava/lang/String;)V", null, null); // System.out.println("Hello World!"); callPrintln(main, "Hello World!"); // return; main.visitInsn(RETURN); main.visitMaxs(-1, -1); main.visitEnd(); // } cw.visitEnd(); // }</span></span></code> </pre> <br><p>  The <code>callPrintln</code> method <code>callPrintln</code> simple, here it is: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callPrintln</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MethodVisitor mv, String string)</span></span></span><span class="hljs-function"> </span></span>{ mv.visitFieldInsn(GETSTATIC, <span class="hljs-string"><span class="hljs-string">"java/lang/System"</span></span>, <span class="hljs-string"><span class="hljs-string">"out"</span></span>, <span class="hljs-string"><span class="hljs-string">"Ljava/io/PrintStream;"</span></span>); mv.visitLdcInsn(string); mv.visitMethodInsn(INVOKEVIRTUAL, <span class="hljs-string"><span class="hljs-string">"java/io/PrintStream"</span></span>, <span class="hljs-string"><span class="hljs-string">"println"</span></span>, <span class="hljs-string"><span class="hljs-string">"(Ljava/lang/String;)V"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); }</code> </pre> <br><p>  Save class to file: </p><br><pre> <code class="java hljs">Files.write(Paths.get(className+<span class="hljs-string"><span class="hljs-string">".class"</span></span>), cw.toByteArray());</code> </pre> <br><p>  Great, the class is generated and starts successfully: </p><br><pre> <code class="hljs swift">$ java <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-type"><span class="hljs-type">Hello</span></span> <span class="hljs-type"><span class="hljs-type">World!</span></span></code> </pre> <br><p>  Now we will try to decompile it: </p><br><pre> <code class="hljs scala">$ java -jar fernflower.jar <span class="hljs-number"><span class="hljs-number">42.</span></span><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dest</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">INFO</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Decompiling</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> 42 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">INFO</span></span></span></span>: ... done</code> </pre> <br><p>  Bad luck, did not fall.  Let's look at the contents of the resulting file: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> 42 </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> _2<span class="hljs-comment"><span class="hljs-comment">/* $FF was: 42*/</span></span>() { System.out.println(<span class="hljs-string"><span class="hljs-string">"In constructor!"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] var0)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>); } }</code> </pre> <br><p>  It‚Äôs unlikely that renaming works at all.  The class is still called 42 and, of course, is not a valid Java class.  Moreover, the designer was renamed and in general ceased to be a designer.  Of course, it's good that the decompiler could not create a valid Java file, but I wanted more. </p><br><p>  Maybe renaming can somehow be included?  There are some options that are described directly in <a href="">README.md</a> .  And among them is the <code>ren</code> option: </p><br><ul><li>  ren (0): rename ambiguous (resp. obfuscated) classes and class elements </li></ul><br><p>  Well, let's try: </p><br><pre> <code class="hljs dos">$ java -jar fernflower.jar -<span class="hljs-built_in"><span class="hljs-built_in">ren</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>.class dest Exception <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> thread "main" java.lang.StringIndexOutOfBoundsException: String index out of range: <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.lang.String.charAt(Unknown Source) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> ...renamer.ConverterHelper.getNextClassName(ConverterHelper.java:<span class="hljs-number"><span class="hljs-number">58</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> ...renamer.IdentifierConverter.renameClass(IdentifierConverter.java:<span class="hljs-number"><span class="hljs-number">187</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> ...renamer.IdentifierConverter.renameAllClasses(IdentifierConverter.java:<span class="hljs-number"><span class="hljs-number">169</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> ...renamer.IdentifierConverter.<span class="hljs-built_in"><span class="hljs-built_in">rename</span></span>(IdentifierConverter.java:<span class="hljs-number"><span class="hljs-number">63</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> ...main.Fernflower.decompileContext(Fernflower.java:<span class="hljs-number"><span class="hljs-number">46</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> ...main.decompiler.ConsoleDecompiler.decompileContext(ConsoleDecompiler.java:<span class="hljs-number"><span class="hljs-number">135</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> ...main.decompiler.ConsoleDecompiler.main(ConsoleDecompiler.java:<span class="hljs-number"><span class="hljs-number">96</span></span>)</code> </pre> <br><p>  Bydisch!  Ok, fell exactly where necessary.  And not even really delving into the source code of the decompiler.  What is interesting is that if a user decompiles an entire jar file in which such a class falls, then the whole decompilation falls before at least one file is decompiled.  And according to the report, it is completely unclear because of what particular class the error is.  It is enough to pack such a class somewhere deep in the obfuscated jar, and such a jar should not be decompiled.  Yes, unfortunately, it is necessary to start with the option disabled by default, but other obfuscation mechanisms can make the use of this option very desirable. </p><br><p>  Since I work for a company that produces a decompiler, not an obfuscator, then, of course, instead of exploiting the vulnerability, I <a href="https://youtrack.jetbrains.com/issue/IDEABKL-7547">reported it</a> , and it was closed.  And in order to use the updated IDEA static analyzer and find similar errors in your code, you can compile IntelliJ Community Edition from the <a href="https://github.com/JetBrains/intellij-community">sources</a> or wait for the 2017.2 EAP program.  And do not underestimate the static analysis.  If you do not analyze your code, competitors or intruders will do it and find there something that will ruin your life. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326384/">https://habr.com/ru/post/326384/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326372/index.html">How we sped up our DNS stack 3 times</a></li>
<li><a href="../326374/index.html">How airlines make life easier for passengers using SMS</a></li>
<li><a href="../326376/index.html">Go digest Events, articles, interesting projects from the world of Go (March 30 - April 13, 2017)</a></li>
<li><a href="../326380/index.html">Vector models and Russian literature</a></li>
<li><a href="../326382/index.html">We forge letters from the largest Russian banks</a></li>
<li><a href="../326386/index.html">What can go wrong on a tour - and how does this relate to the search aggregator</a></li>
<li><a href="../326388/index.html">Implement a custom UI element for timing. Part 2</a></li>
<li><a href="../326390/index.html">Why did it take 100 years to find the exact value of the Planck constant?</a></li>
<li><a href="../326392/index.html">VR development methodology</a></li>
<li><a href="../326394/index.html">Why use static types in javascript? (Advantages and disadvantages)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>