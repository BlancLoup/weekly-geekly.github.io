<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to ensure proper intersection of dynamic library boundaries using custom smart pointer removal tools</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many C ++ experts agitate to use smart pointers, arguing that from modern C ++, the explicit use of new should disappear altogether (well, at least wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to ensure proper intersection of dynamic library boundaries using custom smart pointer removal tools</h1><div class="post__text post__text-html js-mediator-article"> Many C ++ experts agitate to use smart pointers, arguing that from modern C ++, the explicit use of <code>new</code> should disappear altogether (well, at least when the absence of <code>std::make_unique</code> in C ++ 14).  All dynamic memory allocations must be encapsulated in either the standard library, or containers of type <code>std::vector</code> , or smart pointers. <br><br>  Smart pointers of the standard library can be configured so that they themselves are engaged in the release of their memory.  This possibility is the basis of the answer to the question posed in the title of the article. <br><br>  An object is intersecting the dynamic library boundary if it is initialized in one block and used in another.  This happens when, for example, an object is initialized in a dll and a pointer to it is returned. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Suppose one library (or an executable module) is associated with another library, using a factory to dynamically initialize an object and get a pointer to it.  The block that uses this pointer can delete the pointer to free the memory area it points to.  If a library that allocates memory and a block working with a pointer use different versions of the OS dynamic allocation (CRT in Windows), an error will occur.  An example of this problem (in the case of Windows): <br> <a href="http://msdn.microsoft.com/en-CA/library/ms235460(v%3Dvs.110).aspx"><img src="https://habrastorage.org/storage2/dd0/d53/07a/dd0d5307ac94558d3e0bd75b80e54c71.png"></a> <a name="habracut"></a><br>  As a rule (before the advent of C ++ 11), library developers had to develop functions to free memory for objects that were allocated within this library, in order to avoid this problem.  This had a side effect: the interfaces of such libraries became more ‚Äúheavy‚Äù, besides, they now needed ‚Äúknow-how‚Äù to correctly allocate and free memory for library objects.  Ideally, the user should not have been disturbed by the allocation / release scheme itself, it simply had to call the library mechanism (for example, the factory) to allocate memory, without worrying about its subsequent release. <br><br><h4>  Go to Codding </h4><br>  We will have two projects: the first will simply consist of a main file, using the library factory to initialize objects from it, the second will illustrate the problem situation and its solution. <br>  The problem area is the singleton factory (ProblematicFactory), which initializes the object and returns a pointer to it.  The solution is another one that, after initializing the object, returns a pointer <code>std::unique_ptr</code> , which has its own deletion tool, which releases the memory to the DLL. <br>  If you run the program in debug mode with the definition of <code>USE_PROBLEMATIC_FACTORY_AND_CAUSE_HEAP_CORRUPTION</code> , you can see that the debugger detects heap corruption. <br><br><h5>  Main file </h5><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// main.cpp #include &lt;ProblematicFactory.h&gt; #include &lt;SafeFactory.h&gt; //  undef  define,   assert'    #undef USE_PROBLEMATIC_FACTORY_AND_CAUSE_HEAP_CORRUPTION int main() { #ifdef USE_PROBLEMATIC_FACTORY_AND_CAUSE_HEAP_CORRUPTION { //     DLL auto wMyObject = ProblematicFactory::getInstance().create(); //       delete wMyObject; //  DLL           CLR DLL, //   ,  -     } #endif { auto wMyObject = SafeFactory::getInstance().create(); //      , wMyObject  //  ,    , //   MyClass.h (. ),   //      } { std::shared_ptr&lt; MyClass &gt; wMyObject = SafeFactory::getInstance().create(); } return 0; }</span></span></code> </pre><br><h5>  Problem factory </h5><br>  This is a typical implementation of a factory that returns a pointer to an object that can be created by the library. <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// ProblematicFactory.h #pragma once #include "DllSwitch.h" #include "MyClass.h" class LIBRARYFACTORY_API ProblematicFactory { public: static ProblematicFactory &amp; getInstance() { static ProblematicFactory wProblematicFactory; return wProblematicFactory; } MyClass * create() const { return new MyClass; } private: ProblematicFactory() {}; };</span></span></code> </pre><br><h5>  Safe factory </h5><br>  Syntactically, the use of this factory is exactly the same as the problem one (see main), but here the pointer is encapsulated in <code>std::unique_ptr</code> , and not <code>std::shared_ptr</code> . <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// SaveFactory.h #pragma once #include "DllSwitch.h" #include "MyClass.h" #include &lt;memory&gt; class LIBRARYFACTORY_API SafeFactory { public: static SafeFactory &amp; getInstance(); //  std::unique_ptr     , // ..       DLL.   //   ,   std::unique_ptr . //  ,      // ,    MyClass  std::default_delete inline std::unique_ptr&lt; MyClass &gt; create() const { return std::unique_ptr&lt; MyClass &gt;(doCreate()); } private: SafeFactory(); MyClass * doCreate() const; };</span></span></code> </pre><br><h5>  Crossing the border </h5><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// MyClass.h #pragma once #include "DllSwitch.h" #include &lt;memory&gt; class LIBRARYFACTORY_API MyClass { }; namespace std { template&lt;&gt; class LIBRARYFACTORY_API default_delete&lt; MyClass &gt; { public: void operator()(MyClass *iToDelete) { delete iToDelete; } }; }</span></span></code> </pre><br>  In all the above files, the header file <code>DllSwitch.h</code> , which defines <code>LIBRARYFACTORY_API</code> , its contents: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// DllSwitch.h #pragma once #ifdef LIBRARYFACTORY_EXPORTS #define LIBRARYFACTORY_API __declspec(dllexport) #else #define LIBRARYFACTORY_API __declspec(dllimport) #endif</span></span></code> </pre><br><br>  <b>UPD</b> All implementations of functions must be placed in separate files. </div><p>Source: <a href="https://habr.com/ru/post/182970/">https://habr.com/ru/post/182970/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../182954/index.html">SMB Hijacking. Kerberos is not a hindrance</a></li>
<li><a href="../182958/index.html">‚ÄúDid the texture kill the texture?‚Äù - thoughts about the role of textures, textures and materials in games</a></li>
<li><a href="../182964/index.html">5 rules for the layout of email-letters from Pechkin</a></li>
<li><a href="../182966/index.html">Facebook - from the server to the network of data centers for 8 years</a></li>
<li><a href="../182968/index.html">The third issue of the magazine TsODy.RF</a></li>
<li><a href="../182974/index.html">The evolution of design with the advent of adaptive design</a></li>
<li><a href="../182976/index.html">Experiment in Yandex: how robots help test services</a></li>
<li><a href="../182978/index.html">Flat design: why did the design go flat?</a></li>
<li><a href="../182980/index.html">Labyrinths of Bilbo Beggins</a></li>
<li><a href="../182986/index.html">How to become an entrepreneur? Four letters: JFDI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>