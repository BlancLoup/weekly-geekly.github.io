<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multi-hosting django applications using nginx + uwsgi + virtualenv</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task: to deploy several django-projects using different versions of django and different versions of python on the same server. 

 The instructions ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multi-hosting django applications using nginx + uwsgi + virtualenv</h1><div class="post__text post__text-html js-mediator-article">  Task: to deploy several django-projects using different versions of django <b>and different versions of python</b> on the same server. <br><br>  The instructions are for OS Ubuntu 12.04. <br><a name="habracut"></a><br><h4>  Training </h4><br>  To begin with we put the versions of python that we are interested in. <br><br>  Required packages for compilation: <br><pre><code class="bash hljs">sudo apt-get install zlib1g zlib1g-dev zlibc libssl-dev</code> </pre> <br>  We put the python, I put 2.7.4 and 3.3.1 <br><pre> <code class="bash hljs">wget http://python.org/ftp/python/2.7.4/Python-2.7.4.tar.bz2 tar -xf Python-2.7.4.tar.bz2 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> Python-2.7.4 ./configure --prefix=/opt/python2.7/ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-unicode=ucs4 make &amp;&amp; make install</code> </pre><br><pre> <code class="bash hljs">wget http://python.org/ftp/python/3.3.1/Python-3.3.1.tar.bz2 tar -xf Python-3.3.1.tar.bz2 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> Python-3.3.1 ./configure --prefix=/opt/python3.3/ make &amp;&amp; make install</code> </pre><br>  Let's create directories for our project configs. <br><ul><li>  /home/hosting/.nginx/ - there will be nginx configs here </li><li>  /home/hosting/.uwsgi/ - there will be uwsgi configs here </li><li>  /home/hosting/.virtualenvs/ - here will be the virtual environments of the projects </li><li>  / home / hosting / project1 / - files of the first jango project </li><li>  / home / hosting / project2 / - files of the second jango project </li></ul><br><h4>  Nginx installation </h4><br><pre> <code class="bash hljs">apt-get install nginx-full</code> </pre><br>  Why nginx-full and not nginx?  The nginx-full already includes a module for working with uwsgi. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You need to tell nginx where to download virtual host configs. <br>  Open /etc/nginx/nginx.conf. <br>  After <code>include /etc/nginx/sites-enabled/*;</code>  add line <code>include /home/hosting/.nginx/*.conf;</code> <br>  Now you need to create nginx-configs of virtual hosts. <br><ul><li>  /home/hosting/.nginx/project1.conf </li><li>  /home/hosting/.nginx/project2.conf </li></ul><br>  Config example: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> project1.com; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/project1.access.log; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/project1.<span class="hljs-literal"><span class="hljs-literal">error</span></span>.log; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">uwsgi_pass</span></span> unix:/tmp/project1.sock; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/uwsgi_params; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /static/ { <span class="hljs-attribute"><span class="hljs-attribute">alias</span></span> /home/hosting/project1/static/; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /media/ { <span class="hljs-attribute"><span class="hljs-attribute">alias</span></span> /home/hosting/project1/media/; } }</code> </pre></div></div><br>  You must give the rights to the /home/hosting/.nginx directory to the www-data user (or to the user under which nginx is working). <br><pre> <code class="bash hljs">chown -R www-data:www-data /home/hosting/.nginx/</code> </pre><br>  Run nginx <br><pre> <code class="bash hljs">service nginx start</code> </pre><br><h4>  Install virtualenvwrapper </h4><br>  virtualenvwrapper is a handy wrapper around virtualenv. <br>  Set pip if not yet worth it: <br><pre> <code class="bash hljs">sudo apt-get install python-pip</code> </pre><br>  Put virtualenvwrapper: <br><pre> <code class="bash hljs">pip install virtualenvwrapper</code> </pre><br>  In ~ / .bashrc add: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> WORKON_HOME=/home/hosting/.virtualenvs/ <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/virtualenvwrapper.sh</code> </pre><br>  We log in to the console so that .bashrc is loaded.  Now we need to have the mkvirtualenv command in the console. <br><br>  We place project files in directories: <br><ul><li>  / home / hosting / project1 / </li><li>  / home / hosting / project2 / </li></ul><br>  For each project we will create a virtual environment.  Let's say project1 will work on python 2.7, and project2 on 3.3. <br><pre> <code class="bash hljs">mkvirtualenv project1 -p /opt/python2.7/bin/python deactivate mkvirtualenv project2 -p /opt/python3.3/bin/python3 deactivate</code> </pre><br>  For each project we put dependences in a virtual environment.  (In my case, dependencies are written in the requirements.txt file in the root of each project) <br><pre> <code class="bash hljs">workon project1 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/hosting/project1 pip install -r requirements.txt workon project2 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/hosting/project2 pip install -r requirements.txt</code> </pre><br><h4>  Customize uwsgi. </h4><br>  We will configure it in the emperor mode (--emperor), since  This mode is specially designed for multi-hosting. <br><br>  In emperor mode, uwsgi will automatically load configs from the specified directory, which is convenient, that is, we run uwsgi once, and then it creates processes for all applications in configs. <br><br>  By default, uwsgi executes the project code by the Python in the current environment, so we will need to run uwsgi from virtualenv. <br>  Since we have several different versions of python, the uwsgi launched, for example, from under the python 2.7 will not be able to serve the django application with the python environment 3.3. <br>  So we will create an emperor for each version of the python, and we will group the application configs according to the interpreter version. <br><br>  Create virtual environments for emperors. <br><pre> <code class="bash hljs">mkvirtualenv python27 -p /opt/python2.7/bin/python deactivate mkvirtualenv python33 -p /opt/python3.3/bin/python3 deactivate</code> </pre><br>  Now you need to put uwsgi in each virtualenv and configure it. <br><pre> <code class="bash hljs">workon python27 pip install uwsgi workon python33 pip install uwsgi</code> </pre><br>  Create configs directories for each uwsgi-emperor. <br><pre> <code class="bash hljs">mkdir /home/hosting/.uwsgi/python27 mkdir /home/hosting/.uwsgi/python33</code> </pre><br>  Create uwsgi-configs for each project. <br>  /home/hosting/.uwsgi/python27/project1.ini <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">[uwsgi] protocol = wsgi master = <span class="hljs-literal"><span class="hljs-literal">true</span></span> processes = 1 <span class="hljs-comment"><span class="hljs-comment">#    socket = /tmp/project1.sock #   pythonpath   , . uwsgi         virtualenv pythonpath = /home/hosting/.virtualenvs/project1/lib/python2.7/site-packages/setuptools-0.6c11-py2.7.egg pythonpath = /home/hosting/.virtualenvs/project1/lib/python27.zip pythonpath = /home/hosting/.virtualenvs/project1/lib/python2.7 pythonpath = /home/hosting/.virtualenvs/project1/lib/python2.7/plat-linux2 pythonpath = /home/hosting/.virtualenvs/project1/lib/python2.7/lib-tk pythonpath = /home/hosting/.virtualenvs/project1/lib/python2.7/lib-old pythonpath = /home/hosting/.virtualenvs/project1/lib/python2.7/lib-dynload pythonpath = /home/hosting/.virtualenvs/project1/lib/python2.7/site-packages # -  virtualenv     ,      pythonpath = /opt/python2.7/lib/python2.7 chdir = /home/hosting/project1 virtualenv = /home/hosting/.virtualenvs/project1 env = DJANGO_SETTINGS_MODULE=settings module = django.core.handlers.wsgi:WSGIHandler() no-site = true vhost = true chmod-socket = 666</span></span></code> </pre></div></div><br>  Config of the second project - by analogy.  The file name must end with .ini, otherwise uwsgi will not pick up this config. <br><br>  Now you need to register uwsgi as a service in the system.  I used upstart, it is in ubunt out of the box. <br>  Create two config files: <br>  /etc/init/uwsgi27.conf <br><pre> <code class="bash hljs">description <span class="hljs-string"><span class="hljs-string">"uWSGI Emperor (python 2.7)"</span></span> start on runlevel [2345] stop on runlevel [06] <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> /home/hosting/.virtualenvs/python27/bin/uwsgi --master --emperor /home/hosting/.uwsgi/python27 --logto /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/uwsgi27.emperor.log</code> </pre><br>  /etc/init/uwsgi33.conf <br><pre> <code class="bash hljs">description <span class="hljs-string"><span class="hljs-string">"uWSGI Emperor (python 3.3)"</span></span> start on runlevel [2345] stop on runlevel [06] <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> /home/hosting/.virtualenvs/python33/bin/uwsgi --master --emperor /home/hosting/.uwsgi/python33/ --logto /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/uwsgi33.emperor.log</code> </pre><br><h4>  Users and Security </h4><br>  From root, we will only have ‚Äúimperial‚Äù processes, and the projects themselves will be under their users. <br><br>  Create a user for each project. <br><pre> <code class="bash hljs">adduser --no-create-home --disabled-login --disabled-password www-project1 adduser --no-create-home --disabled-login --disabled-password www-project2</code> </pre><br>  Add uid gid parameters to each of uwsgi ini-configs. <br><pre> <code class="bash hljs">uid = www-project1 <span class="hljs-comment"><span class="hljs-comment">#  gid = www-project1 # </span></span></code> </pre><br>  Set the correct access rights <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">chown -R www-data:www-data /home/hosting/.nginx chmod -R 770 /home/hosting/.nginx chown -R root:root /home/hosting/.uwsgi chmod -R 770 /home/hosting/.uwsgi chown -R root:root /home/hosting/.virtualenvs/python27 /home/hosting/.virtualenvs/python33 chmod -R 775 /home/hosting/.virtualenvs chown -R www-project1:www-project1 /home/hosting/project1 /home/hosting/.virtualenvs/project1 chown -R www-project2:www-project2 /home/hosting/project2 /home/hosting/.virtualenvs/project2</code> </pre></div></div><br>  Run uwsgi <br><pre> <code class="bash hljs">service uwsgi27 start service uwsgi33 start</code> </pre><br>  Check - everything should work. <br>  If something does not work, we look at the nginx logs specified in the project config, and the uwsgi-emperor logs. <br>  A sign that uwsgi has successfully deployed the application is the presence of the line <code>WSGI app 0 (mountpoint='') ready in 0 seconds on interpreter 0x135e280 pid: 21737 (default app)</code> in the uwsgi log. <br>  To add a new application, you need to create a config in .nginx and .uwsgi and restart nginx.  uwsgi will pick up the new config itself. <br><br><h4>  References </h4><br>  <a href="http://projects.unbit.it/uwsgi/wiki/MultiPython">projects.unbit.it/uwsgi/wiki/MultiPython</a> <br>  <a href="http://projects.unbit.it/uwsgi/wiki/DynamicVirtualenv">projects.unbit.it/uwsgi/wiki/DynamicVirtualenv</a> <br>  <a href="https://auphonic.com/blog/2011/06/18/django-deployment-nginx-uwsgi-virtualenv-and-fabric/">auphonic.com/blog/2011/06/18/django-deployment-nginx-uwsgi-virtualenv-and-fabric</a> <br>  <a href="http://eshlox.net/en/2012/09/11/nginx-uwsgi-virtualenv-and-django-ubuntu-1204/">eshlox.net/en/2012/09/11/nginx-uwsgi-virtualenv-and-django-ubuntu-1204</a> <br>  <a href="http://uwsgi-docs.readthedocs.org/en/latest/Emperor.html">uwsgi-docs.readthedocs.org/en/latest/Emperor.html</a> <br><br><h4>  PS </h4><br>  The method described in the article is not very beautiful in terms of architecture;  Initially, I hoped to get by with one uwsgi-emperor and resolve the version of the interpreter with the plugin parameter in the application config.  But I didn‚Äôt manage to build a uwsgi plugin for python, so I had to do it differently. </div><p>Source: <a href="https://habr.com/ru/post/179831/">https://habr.com/ru/post/179831/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179821/index.html">CentOS 6.4 + ReiserFS</a></li>
<li><a href="../179823/index.html">Ceph FS distributed file system in 15 minutes</a></li>
<li><a href="../179825/index.html">Installing Citrix XenServer on Software RAID</a></li>
<li><a href="../179827/index.html">Exploring SAP R / 3 in Unusual and Difficult Conditions</a></li>
<li><a href="../179829/index.html">Calculating the Nth sign of Pi without calculating the previous ones</a></li>
<li><a href="../179833/index.html">Fighting spam with standard mailer tools (using Exim for example)</a></li>
<li><a href="../179835/index.html">Household automation. Start</a></li>
<li><a href="../179837/index.html">We continue to delete. [Re: Working with ‚Äúbad‚Äù files on the Linux command line]</a></li>
<li><a href="../179839/index.html">Small multiplatform 2d tengine engine (android / ios / win32 / nix / kolibrios / web (emscripten))</a></li>
<li><a href="../179843/index.html">ModeBot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>