<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>One interesting bug in Lucene.Net</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some programmers, when they hear about static analysis, say that they do not need it, since all their code is covered by unit tests, and this is enoug...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>One interesting bug in Lucene.Net</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/18a/ebb/4f3/18aebb4f30321046c2af02cbe07612cf.png" align="left"><br>  Some programmers, when they hear about static analysis, say that they do not need it, since all their code is covered by unit tests, and this is enough to catch all the errors.  I got an error, which is theoretically possible to find with the help of unit tests, but if you don‚Äôt know about it, then it‚Äôs almost impossible to write such a test. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  Lucene.Net is a popular full-text search library ported from Java to C #.  The source code is open and available on the project website <a href="https://lucenenet.apache.org/">https://lucenenet.apache.org/</a> . <br><br>  Since this project is developing slowly, contains not so much code and is used in many other projects for full-text search, our analyzer has also found only five suspicious places [ <a href="http://www.viva64.com/ru/b/0158/">1</a> ].  For more I did not count.  But one of these positives seemed to me particularly interesting, and I decided to tell the readers of our blog about it. <br><br><h2>  About the error found </h2><br>  We have diagnostics of <a href="http://www.viva64.com/ru/d/0398/">V3035</a> that instead of + = you can write by mistake = +, where + will be a unary plus.  When I did it by analogy with the same diagnostics of <a href="http://www.viva64.com/ru/d/0192/">V588</a> , intended for the C ++ language, I thought - how can you make a mistake in C #?  In C ++, it's okay - someone uses different text editors instead of IDEs in which you can seal up and not notice the error.  But when typing text in Visual Studio, which automatically aligns the code after putting a semicolon, how can you skip this?  It turns out that you can.  I found this error in Lucene.Net.  And it is more interesting because it is rather difficult to find it in other ways besides static analysis.  Consider the code: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Substitute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> StringBuilder buffer </span></span></span><span class="hljs-function">)</span></span> { substCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = <span class="hljs-number"><span class="hljs-number">0</span></span>; c &lt; buffer.Length; c++ ) { .... <span class="hljs-comment"><span class="hljs-comment">// Take care that at least one character // is left left side from the current one if ( c &lt; buffer.Length - 1 ) { // Masking several common character combinations // with an token if ( ( c &lt; buffer.Length - 2 ) &amp;&amp; buffer[c] == 's' &amp;&amp; buffer[c + 1] == 'c' &amp;&amp; buffer[c + 2] == 'h' ) { buffer[c] = '$'; buffer.Remove(c + 1, 2); substCount =+ 2; } .... else if ( buffer[c] == 's' &amp;&amp; buffer[c + 1] == 't' ) { buffer[c] = '!'; buffer.Remove(c + 1, 1); substCount++; } .... } } }</span></span></code> </pre> <br>  There is a GermanStemmer class that truncates suffixes in German words to highlight a common root.  It works as follows: first, the Substitute method replaces different good letter combinations with other characters, so as not to confuse them with the suffix.  Replaced: 'sch' to '$', 'st' to '!'  and so on (this can be seen from the example code).  Moreover, the number of characters for which such substitutions reduce the length of the word is accumulated in the variable substCount.  Next, the Strip method cuts off unnecessary suffixes, and at the end the Resubstitute method performs the inverse replacement: '$' to 'sch', '!'  on 'st'.  That is, if we had, for example, the word kapitalistischen (capitalist), then <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B5%25D0%25BC%25D0%25BC%25D0%25B8%25D0%25BD%25D0%25B3">Stemmer would</a> work as follows: kapitalistischen =&gt; kapitali! I $ en (Substitute) =&gt; kapitali! I $ (Strip) =&gt; kapitalistisch (Resubstitute). <br><br>  Because of this typo in the code, if you replace 'sch' with '$' to the variable substCount, the value 2 will be assigned instead of increasing the substCount by 2. And such an error is rather difficult to find by other methods than static analysis.  There are developers who say: why do I need a static analyzer if I have unit tests?  So, in order to catch such an error with tests, you need to test Lucene.Net on the German text, using GermanStemmer. In the tests, the word that contains the combination 'sch' and one more letter combination for which the substitution will be performed must be indexed, and be present in the word before 'sch', so that substCount is non-zero by the time when the expression substCount = + 2 is executed. A rather non-trivial combination for the test, especially when you do not see an error. <br><br><h2>  Conclusion </h2><br>  Unit tests and static analysis are not exclusive, but complementary software development techniques [ <a href="http://www.viva64.com/ru/a/0080/">2</a> ].  I suggest to <a href="http://www.viva64.com/ru/pvs-studio-download/">download the</a> PVS-Studio static analyzer, check your projects and find errors that were not detected with the help of unit tests. <br><br><h2>  Additional links </h2><br><ol><li>  Andrey Karpov.  <a href="http://www.viva64.com/ru/b/0158/">Why in small programs low density of errors</a> . </li><li>  Andrey Karpov.  <a href="http://www.viva64.com/ru/a/0080/">How static analysis complements TDD</a> . </li></ol><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0381/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Ilya Ivanov.  <a href="http://www.viva64.com/en/b/0381/">An unusual bug in Lucene.Net</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/279221/">https://habr.com/ru/post/279221/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279209/index.html">Big survey on algorithms</a></li>
<li><a href="../279211/index.html">9 secrets of online payments. Part 3: Payment Method Selection Page</a></li>
<li><a href="../279213/index.html">Pandasql vs Pandas for solving data analysis tasks</a></li>
<li><a href="../279215/index.html">We study the source tree of Windows 10: from telemetry to open source</a></li>
<li><a href="../279219/index.html">Information Security Risks for Web Applications</a></li>
<li><a href="../279223/index.html">Disaster-resistant IaaS, as well as replication and backups</a></li>
<li><a href="../279225/index.html">VCloud Tools: IT GRAD Experience</a></li>
<li><a href="../279227/index.html">PCI DSS Certification: What it is and what it is eaten with</a></li>
<li><a href="../279229/index.html">Few of the containers</a></li>
<li><a href="../279231/index.html">The story of the development of Cosmos on Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>