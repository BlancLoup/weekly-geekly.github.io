<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Horizontal scaling PHP applications. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So you made a website. It is always interesting and exciting to observe how the counter of visits slowly but surely creeps upwards, showing every day ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Horizontal scaling PHP applications. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/8a9/a5e/df8/8a9a5edf88628031e2592b12677234c0.png"><br>  So you made a website.  It is always interesting and exciting to observe how the counter of visits slowly but surely creeps upwards, showing every day all the best results.  But one day, when you do not expect this, someone will post a link to your resource on some Reddit or Hacker News (or on Habr√© - lane), and your server will fall. <br><br>  Instead of getting new regular users, you‚Äôll be left with a blank page.  At this moment, nothing will help you to restore the server to work, and traffic will be lost forever.  How to avoid such problems?  In this article we will talk about <b>optimization and scaling</b> . <br><a name="habracut"></a><br><h4>  A little about optimization </h4><br>  The main tips are known to all: upgrade to the latest version of PHP (OpCache is now built in 5.5), deal with indexes in the database, cache the static (rarely modified pages such as ‚ÄúAbout us‚Äù, ‚ÄúFAQ‚Äù, etc.). <br><br>  It is also worth mentioning one particular aspect of optimization - serving static content with non-Apache server, such as, for example, Nginx, Configure Nginx to handle all static content (* .jpg, * .png, * .mp4, * .html ...), and the files requiring server processing let them send heavy Apache.  This is called <b>reverse proxy</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Scaling </h4><br>  There are two types of scaling - vertical and horizontal. <br>  In my understanding, the site is scalable if it can handle the traffic, without changes in the software. <br><br><h5>  Vertical scaling. </h5><br>  Imagine a server serving a web application.  It has 4GB of RAM, i5 processor and 1TB HDD.  It performs its functions perfectly, but in order to better cope with higher traffic, you decide to increase RAM to 16GB, install an i7 processor, and fork over an SSD drive.  Now the server is much more powerful, and copes with high loads.  This is vertical scaling. <br><br><h5>  Horizontal scaling. </h5><br>  Horizontal scaling - the creation of a cluster of interconnected (often not very powerful) servers that serve the site together.  In this case, a <b>load balancer</b> (aka <b>load balancer</b> ) is used - a machine or program, the main function of which is to determine which server to send the request to.  Servers in a cluster share the service of the application, without knowing anything about each other, thus significantly increasing the bandwidth and resiliency of your site. <br><br>  There are two types of balancers - hardware and software.  Software - installed on a regular server and receives all traffic, passing it to the appropriate handlers.  Such a balancer can be, for example, Nginx.  In the ‚ÄúOptimization‚Äù section, he intercepted all requests for static files, and served those requests himself, without burdening Apache.  Another popular load balancing software is <a href="http://www.squid-cache.org/">Squid</a> .  Personally, I always use it because  It provides an excellent user-friendly interface to control the deepest aspects of balancing. <br><br>  The hardware balancer is a dedicated machine whose sole purpose is to distribute the load.  Usually on this machine, no software other than developed by the manufacturer is no longer worth it.  Read about hardware load balancers <a href="http://www.serverwatch.com/article.php/3937981/5-Load-Balancers-You-Need-to-Know.htm">here</a> . <br><br>  Please note that these two methods are not mutually exclusive.  You can vertically scale any machine (aka <b>node</b> ) on your system. <br>  In this article, we discuss horizontal scaling, because  it is cheaper and more efficient, although more difficult to implement. <br><br><h5>  Permanent connection </h5><br>  When scaling PHP applications, there are several difficult problems.  One of them is working with user session data.  After all, if you logged in on the site, and the balancer sent your next request to another machine, then the new machine will not know that you are already logged in.  In this case, you can use a persistent connection.  This means that the balancer remembers which node sent the user's request last time, and sends the next request to the same place.  However, it turns out that the balancer is too overloaded with functions, besides processing hundreds of thousands of requests, it also has to remember exactly how it handled them, with the result that the balancer itself becomes a bottleneck in the system. <br><br><h5>  Exchange of local data. </h5><br>  It seems like a good idea to divide user session data between all the nodes of the cluster.  And despite the fact that this approach requires some changes in the architecture of your application, it is worth it - the balancer is unloaded, and the entire cluster becomes more fault tolerant.  The death of one of the servers does not affect the operation of the entire system. <br>  As we know, session data is stored in the <i>$ _SESSION</i> superglobal <i>array</i> , which writes and takes data from a file on disk.  If this disk is on the same server, it is obvious that other servers do not have access to it.  How do we make it available on multiple machines? <br>  First, note that <b>you can override the session handler in PHP</b> .  You can implement your own class to <a href="http://www.php.net/manual/ru/class.sessionhandler.php">work with sessions</a> . <br><br><h5>  Using the database to store sessions </h5><br>  Using our own session handler, we can store them in the database.  The database can be on a separate server (or even a cluster).  Usually this method works fine, but with really big traffic, the <b>database becomes a bottleneck</b> (and if the database is lost, we completely lose performance), because it has to serve all the servers, each of which tries to write or read session data. <br><br><h5>  Distributed file system </h5><br>  Perhaps you think that it would be nice to set up a network file system where all servers could write session data.  <b>Do not do this!</b>  This is a very slow approach, leading to data corruption and even data loss.  If, for some reason, you still decide to use this method, I recommend you <a href="http://www.gluster.org/about/">GlusterFS</a> <br><br><h5>  Memcached </h5><br>  You can also use memcached to store session data in RAM.  However, this is not safe, because memcached data is overwritten if free space runs out.  You are probably wondering, is not RAM divided into machines?  How is it applied to the entire cluster?  <b>Memcached has the ability to combine the available RAM on different machines into one pool</b> . <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/66f/96c/f33/66f96cf33aab4b1f139ae41fa2a27417.png"></div><br>  The more machines you have, the more you can take to this memory pool.  You do not need to pool all the memory of machines into a pool, but you can, and you can donate to the pool an arbitrary amount of memory from each machine.  So, it is possible to leave most of the memory for normal use, and allocate a piece for the cache, which will allow you to cache not only sessions, but other relevant information.  <b>Memcached is an excellent and widespread solution</b> . <br><br>  To use this approach, you need to edit php.ini a little <br><br><pre><code class="php hljs">session.save_handler = memcache session.save_path = <span class="hljs-string"><span class="hljs-string">"tcp://path.to.memcached.server:port"</span></span></code> </pre> <br><br><h5>  Redis cluster </h5><br>  Redis - NoSQL data storage.  Stores the base in RAM.  In contrast, memcached supports persistent data storage, and more complex data types.  <b>Redis does not support clustering</b> , so using it for horizontal scaling is somewhat difficult, however, this is temporary, and the alpha version of the <a href="http://redis.io/topics/cluster-tutorial">cluster solution is</a> already out. <br><br><h5>  Other solutions </h5><br>  <a href="http://files.zend.com/help/Zend-Server-5.5-Cluster-Manager/zend_server_cluster_manager_database.htm">ZSCM is a</a> good alternative from Zend, but requires a Zend Server on each node. <br>  If you are interested in other NoSQL repositories and caching systems - try <a href="http://scache.nanona.fi/introduction.html">Scache</a> , <a href="http://cassandra.apache.org/">Cassandra</a> or <a href="http://www.couchbase.com/">Couchbase</a> . <br><br><h4>  Total </h4><br>  As you can see, scaling out PHP applications is not so easy.  There are many difficulties, most of the solutions are not interchangeable, so you have to choose one and stick to it until the end, because when traffic goes off scale, there is no longer a chance to go smoothly to something else. <br><br>  I hope this small guide will help you choose the approach to scaling for your project. <br><br>  In the second part of the article we will talk about <b>database scaling</b> . </div><p>Source: <a href="https://habr.com/ru/post/210656/">https://habr.com/ru/post/210656/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210644/index.html">Cheat sheet for C ++ 11 for printing on the circle</a></li>
<li><a href="../210646/index.html">The task of changing the voice. Part 2. The physical / acoustic approach to the presentation of the speech signal</a></li>
<li><a href="../210648/index.html">Evernote sync speed quadrupled</a></li>
<li><a href="../210652/index.html">Who needs nested tasks in a project management system?</a></li>
<li><a href="../210654/index.html">Direct entry to the 1C: Enterprise Directory via Linq on the example of working with Asp.Net users</a></li>
<li><a href="../210660/index.html">What to do if the client is a friend / good friend?</a></li>
<li><a href="../210664/index.html">My comfortable home</a></li>
<li><a href="../210666/index.html">Access to the file system from the Portable Class Library (PCL)</a></li>
<li><a href="../210668/index.html">Two or more jobs on the same computer - free solution</a></li>
<li><a href="../210672/index.html">10 obscure Objective-C features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>