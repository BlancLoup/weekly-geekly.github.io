<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing a cool GUI on esp8266 with the uGFX library</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In many projects for esp8266 I use a touchscreen TFT screen. Depending on the project, the interface can be simple, for example, a text console that d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing a cool GUI on esp8266 with the uGFX library</h1><div class="post__text post__text-html js-mediator-article"><p>  In many projects for esp8266 I use a touchscreen TFT screen.  Depending on the project, the interface can be simple, for example, a text console that displays a log of the application or just a graph of the input signal changes.  And in some - a complex GUI, with multiple screens, graphic buttons, text input lines, and even a virtual keyboard. </p><br><p>  In this article I want to share my experience on how to connect a touchscreen screen to esp8266 and implement a graphical interface in the Arduino environment. </p><br><p>  Video teaser: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/N3VHPH-ZWb0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  So let's get started </p><a name="habracut"></a><br><h2 id="pervaya-chast-apparatnaya">  The first part, the hardware </h2><br><h3 id="vybor-modeli-ekrana">  Select screen model </h3><br><p>  Now on the market, read on aliexpress, a huge number of TFT screen models are being sold - in various sizes, with different resolutions, with or without a touchscreen. </p><br><p>  TFT screens differ in the method of connection - there are screens that are connected via the SPI bus, while others are connected via a parallel bus. </p><br><p>  Minimally, only 4 signal outputs (GPIO) are required for connecting via SPI bus, and for connecting via parallel bus - at least 10 (and this is without considering the touchscreen controller).  Connecting via a parallel bus gives great speed, because  in one clock cycle, 8 bits of information are transmitted at once, while in SPI only 1 bit is transmitted. </p><br><p>  However, with SPI connectivity, there is another advantage - fewer involved pins.  In esp8266, the number of required pins is decisive: the number of free GPIOs is limited. </p><br><p>  I would single out such most popular modules of TFT screens with an SPI interface: </p><br><ol><li> <code>ili9341</code> , 320x240, 2.4 ", with touchscreen controller <a href="https://ru.aliexpress.com/item/Free-Shipping-2-8-240x320-SPI-TFT-LCD-Serial-Port-Module-PCB-Adapter-Micro-SD-ILI9341/32573316100.html">link</a> </li><li>  <code>ili9225</code> , 176x220, 2.2, without touchscreen <a href="https://ru.aliexpress.com/item/ILI9225-2-0-Inch-UART-TFT-Display-Module-Color-LCD-Board-Serial-Port-SPI-FLASH-Interface/32813014176.html">link</a> </li><li>  <code>st7735</code> , 160x128, 1.8 ", without touchscreen <a href="https://ru.aliexpress.com/item/1-8-inch-SPI-TFT-LCD-Display-Module-ST7735-128x160-51-AVR-STM32-ARM-8-16/32817088094.html">link</a> </li></ol><br><h3 id="podklyuchenie-tft-ekrana-k-esp8266">  Connect TFT screen to esp8266. </h3><br><p>  Most SPI screens have similar hardware interfaces, and therefore, they connect to the processor in the same way, to the accuracy of small variations in the names.  In the plate below is a list of findings - and a description of what they mean: </p><br><table><thead><tr><th>  Conclusion </th><th>  Alternative names </th><th>  Connect to esp8266 </th><th>  Purpose </th></tr></thead><tbody><tr><td>  SCLK </td><td>  SCK, SCL </td><td>  GPIO14 </td><td>  SPI bus clock </td></tr><tr><td>  SDA </td><td>  MOSI </td><td>  GPIO13 </td><td>  Transferring SPI data from the processor to the screen </td></tr><tr><td>  CS </td><td>  SS </td><td>  GPIO5 </td><td>  Chip selection (multiple devices can be connected to the SPI bus) </td></tr><tr><td>  A0 </td><td>  RS, D / C </td><td>  GPIO15 </td><td>  Selection of data / command transfer mode </td></tr><tr><td>  RESET </td><td>  Rst </td><td>  VCC </td><td>  Hardware reset </td></tr><tr><td>  SDO </td><td>  Miso </td><td>  - </td><td>  Data transfer from the screen to the processor (optional) </td></tr><tr><td>  LED + </td><td>  LED </td><td>  VCC </td><td>  Turn on the backlight </td></tr><tr><td>  VSS </td><td>  VCC </td><td>  VCC </td><td>  Screen power + 3.3V </td></tr><tr><td>  GND </td><td></td><td>  GND </td><td>  Land </td></tr></tbody></table><br><p>  The <code>RESET</code> and <code>LED+</code> pins can be connected to the +3.3 volt power bus, however, if desired, they can be connected to the GPIO esp8266, and be able to programmatically control the reset and screen backlight. </p><br><p>  Conclusions <code>CS</code> and <code>A0</code> can be connected to any convenient esp8266 GPIO. </p><br><p>  The most important part is the <code>SCLK</code> and <code>SDA</code> pins.  They are responsible for transferring data over the SPI bus.  They need to be connected to the corresponding pins of the SPI esp8266 controller.  These are <code>GPIO14</code> and <code>GPIO13</code> respectively. </p><br><p>  If the screen has a touchscreen controller, it should also be connected to the SPI bus: </p><br><table><thead><tr><th>  Conclusion </th><th>  Connect to esp8266 </th><th>  Purpose </th></tr></thead><tbody><tr><td>  T_CLK </td><td>  GPIO14 </td><td>  SPI bus clock </td></tr><tr><td>  T_DIN </td><td>  GPIO13 </td><td>  Transferring SPI data from the processor to the touchscreen controller </td></tr><tr><td>  T_CS </td><td>  GPIO16 </td><td>  Chip selection (multiple devices can be connected to the SPI bus) </td></tr><tr><td>  T_DO </td><td>  GPIO12 </td><td>  Data transfer from controller to processor </td></tr><tr><td>  T_IRQ </td><td>  GPIO4 </td><td>  Sign of clicking on the touchscreen </td></tr></tbody></table><br><p>  Notice that the esp8266 <code>GPIO14</code> and <code>GPIO13</code> connected in parallel to the screen and touchscreen controller.  The fact is that several devices can be connected to the SPI bus.  The device is selected by setting the logic level <code>0</code> on the <code>CS</code> output of the required device. </p><br><p>  Screen connection diagram of ili9341 to esp8266 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cc6/b4f/b23/cc6b4fb23b33c67d5371399091bb4fd0.png" alt="esp8266-screen"></p><br><h2 id="chast-vtoraya-programmnaya">  Part two, software </h2><br><p>  We decided on the screen and the wiring diagram, now it's time to go to the program part.  First of all, we will choose the graphic library with which we will implement the GUI. </p><br><p>  Having tried several dozen libraries, I chose the <a href="https://ugfx.io/">uGFX</a> library.  In my opinion, this is one of the best graphics libraries for microcontrollers.  Rich functionality is combined with modularity and only the required components are included in the project.  The library is open source and free for non-commercial use.  The library has quality <a href="https://wiki.ugfx.io/index.php/Main_Page">documentation</a> available on the project website. </p><br><p>  A big plus of the uGFX library is an advanced font rendering engine, with utf8 support.  The kit includes a program for generating fonts from ttf files, including those with Cyrillic. </p><br><p>  The library is cross-platform - this means that the GUI part of the application can be assembled for any processor, including esp8266. </p><br><p>  Screen and touchscreen drivers are connected by dedicated modules, and if the necessary drivers are not included, you can implement them yourself. </p><br><p>  In addition, uGFX studio is included in the uGFX package - WYSWIG interface editor, in which you can visually prepare interface layouts, and uGFX studio will automatically generate code and decompose resources.  Unfortunately, now uGFX studio is still in the status of the beta version, and to get a beta, you need to write to the developers on the forum. </p><br><p>  And, the final cherry on the cake: the GUI code of the application, you can build under the desktop (Linux / Windows / OSX) and see directly on the computer what the interface will look like. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ac4/4f6/405/ac44f6405b8a69ac7db867c89d29b6bc.gif" alt="pc-demo"></p><br><h3 id="podklyuchaem-ugfx-k-proektu">  We connect uGFX to the project </h3><br><p>  The library uses its build system, which is out of the box not supported by the Arduino build system.  But this restriction can be circumvented.  I used <a href="https://wiki.ugfx.io/index.php/Teensy">this article</a> as a reference. </p><br><p>  The text below assumes that the Arduino development environment with esp8266 support is already installed and configured.  If still not, then about installation and environment setup it is possible to read in <a href="https://geektimes.ru/post/271754/">this article on geektimes</a> </p><br><p>  Now step by step how to connect the library: </p><br><ol><li>  Find the Libraries folder from the Arduino environment.  Depending on the platform, it may be located in such places: </li></ol><br><ul><li>  <code>OSX</code> - <code>/Users/&lt;username&gt;/Documents/Arduino/libraries/</code> </li><li>  <code>Windows</code> - <code>C:\Users\&lt;username&gt;\My Documents\Arduino\Libraries</code> </li><li>  <code>Linux</code> - <code>/home/&lt;username&gt;/Documents/Arduino/libraries</code> </li></ul><br><ol><li><p>  Copy or copy uGFX to the Libraries folder.  You <a href="">can</a> download <a href="">it from here</a> - a version with already built-in Cyrillic fonts </p><br></li><li>  Make a library "wrapper", which will contain the implementation of input / output for screen drivers and touchscreen, as well as connect to the assembly the uGFX components we need.  To do this, in the Libraries folder, you need to create a subfolder uGFXesp, with something like this: </li></ol><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">uGFXesp</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">library</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.properties</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">src</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">board_ILI9341</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cpp</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">board_ILI9341</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">gdisp_lld_config</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">gdisp_lld_ili9341</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.c</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">gfxconf</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">gfxlib</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.c</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">gmouse_lld_ADS7843</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.c</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">gmouse_lld_ADS7843_board</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cpp</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">gmouse_lld_ADS7843_board</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span></code> </pre> <br><ul><li>  The library.properties file is a library description for the Arduino environment: </li></ul><br><div class="spoiler">  <b class="spoiler_title">Content library.properties</b> <div class="spoiler_text"><pre> <code class="hljs delphi"><span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=uGFXesp version=<span class="hljs-number"><span class="hljs-number">1.0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> author=Oleg V. Gerasimov &lt;ogerasimov@gmail.com&gt; maintainer=Oleg V. Gerasimov &lt;ogerasimov@gmail.com&gt; sentence=UI features <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> esp paragraph=This <span class="hljs-keyword"><span class="hljs-keyword">library</span></span> add support screen <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> touch panel <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> esp board&lt;br /&gt;Requires uGFX <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>&lt;br /&gt; category=Display architectures=esp8266 includes=gfx.h url=http:<span class="hljs-comment"><span class="hljs-comment">//github.com</span></span></code> </pre></div></div><br><ul><li>  Files <code>gdisp_lld_ili9341.c</code> , <code>gmouse_lld_ADS7843.c</code> , <code>gdisp_lld_config.h</code> - connection to the touchscreen controller and screen controller driver assembly. </li><li>  File <code>gfxlib.c</code> - connection to the assembly of the library itself </li><li>  The <code>gfxconf.h</code> file is the configuration with which the uGFX library is built - you can enable / disable the required functionality </li><li>  File board_ILI9341.cpp - implementation of I / O on SPI for the screen driver.  I'll take a closer look at it in more detail; this is the most important part of integrating a graphic library with esp8266 </li></ul><br><div class="spoiler">  <b class="spoiler_title">Contents board_ILI9341.cpp</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">SPI</span></span>.h&gt; extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"user_interface.h"</span></span> } // <span class="hljs-type"><span class="hljs-type">Pin</span></span>,     <span class="hljs-type"><span class="hljs-type">RS</span></span>  <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">ESP_LCD_RS</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> // <span class="hljs-type"><span class="hljs-type">Pin</span></span>,     <span class="hljs-type"><span class="hljs-type">CS</span></span>  <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">ESP_LCD_CS</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> //   <span class="hljs-type"><span class="hljs-type">SPI</span></span>     : <span class="hljs-number"><span class="hljs-number">1</span></span>/ <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">SPILOWSPEED</span></span> <span class="hljs-number"><span class="hljs-number">1000000</span></span> //   <span class="hljs-type"><span class="hljs-type">SPI</span></span>  : <span class="hljs-number"><span class="hljs-number">32</span></span>/ <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">SPIHIGHSPEED</span></span> <span class="hljs-number"><span class="hljs-number">32000000</span></span> static <span class="hljs-type"><span class="hljs-type">SPISettings</span></span> spiSettings(<span class="hljs-type"><span class="hljs-type">SPILOWSPEED</span></span>, <span class="hljs-type"><span class="hljs-type">MSBFIRST</span></span>, <span class="hljs-type"><span class="hljs-type">SPI_MODE0</span></span>); //     static inline void cmdmode() { digitalWrite(<span class="hljs-type"><span class="hljs-type">ESP_LCD_RS</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } //     static inline void datamode() { digitalWrite(<span class="hljs-type"><span class="hljs-type">ESP_LCD_RS</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); } //   extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> void esp_lcd_init_board(void) { <span class="hljs-type"><span class="hljs-type">SPI</span></span>.begin(); pinMode(<span class="hljs-type"><span class="hljs-type">ESP_LCD_CS</span></span>, <span class="hljs-type"><span class="hljs-type">OUTPUT</span></span>); digitalWrite(<span class="hljs-type"><span class="hljs-type">ESP_LCD_CS</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); pinMode(<span class="hljs-type"><span class="hljs-type">ESP_LCD_RS</span></span>, <span class="hljs-type"><span class="hljs-type">OUTPUT</span></span>); datamode(); } // -  -  <span class="hljs-type"><span class="hljs-type">SPI</span></span>    extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> void esp_lcd_post_init_board(void) { spiSettings = <span class="hljs-type"><span class="hljs-type">SPISettings</span></span>(<span class="hljs-type"><span class="hljs-type">SPIHIGHSPEED</span></span>, <span class="hljs-type"><span class="hljs-type">MSBFIRST</span></span>, <span class="hljs-type"><span class="hljs-type">SPI_MODE0</span></span>); } static int aquire_count = <span class="hljs-number"><span class="hljs-number">0</span></span>; //   <span class="hljs-type"><span class="hljs-type">SPI</span></span>:  <span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-type"><span class="hljs-type">CS</span></span>    <span class="hljs-type"><span class="hljs-type">SPI</span></span>    extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> void esp_lcd_aquirebus(void) { if (!aquire_count++) { <span class="hljs-type"><span class="hljs-type">SPI</span></span>.beginTransaction(spiSettings); digitalWrite(<span class="hljs-type"><span class="hljs-type">ESP_LCD_CS</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } } //   <span class="hljs-type"><span class="hljs-type">SPI</span></span>:  <span class="hljs-number"><span class="hljs-number">1</span></span>   <span class="hljs-type"><span class="hljs-type">CS</span></span>    <span class="hljs-type"><span class="hljs-type">SPI</span></span> extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> void esp_lcd_releasebus(void) { if (aquire_count &amp;&amp; !--aquire_count) { digitalWrite(<span class="hljs-type"><span class="hljs-type">ESP_LCD_CS</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-type"><span class="hljs-type">SPI</span></span>.endTransaction(); } } //   extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> void esp_lcd_write_index(uint16_t cmd) { cmdmode(); <span class="hljs-type"><span class="hljs-type">SPI</span></span>.write(cmd); datamode(); } //    extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> void esp_lcd_write_data(uint16_t data) { <span class="hljs-type"><span class="hljs-type">SPI</span></span>.write(data); }</code> </pre> </div></div><br><ul><li>  File gmouse_lld_ADS7843_board.cpp - implementation of SPI I / O for a screen driver.  I will also focus on it in more detail: </li></ul><br><div class="spoiler">  <b class="spoiler_title">Content gmouse_lld_ADS7843_board.cpp</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Arduino</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">SPI</span></span>.h&gt; extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"user_interface.h"</span></span> } // <span class="hljs-type"><span class="hljs-type">Pin</span></span>,     <span class="hljs-type"><span class="hljs-type">TC_IRQ</span></span>   <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">ESP_TC_IRQ</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> // <span class="hljs-type"><span class="hljs-type">Pin</span></span>,     <span class="hljs-type"><span class="hljs-type">CS</span></span>   <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">ESP_TC_CS</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> //   <span class="hljs-type"><span class="hljs-type">SPI</span></span>    <span class="hljs-number"><span class="hljs-number">2</span></span>/ <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">SPISPEED</span></span> <span class="hljs-number"><span class="hljs-number">2000000</span></span> static <span class="hljs-type"><span class="hljs-type">SPISettings</span></span> spiSettings(<span class="hljs-type"><span class="hljs-type">SPISPEED</span></span>, <span class="hljs-type"><span class="hljs-type">MSBFIRST</span></span>, <span class="hljs-type"><span class="hljs-type">SPI_MODE0</span></span>); //   extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> int esp_gmouse_init_board() { pinMode(<span class="hljs-type"><span class="hljs-type">ESP_TC_CS</span></span>, <span class="hljs-type"><span class="hljs-type">OUTPUT</span></span>); digitalWrite(<span class="hljs-type"><span class="hljs-type">ESP_TC_CS</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); pinMode(<span class="hljs-type"><span class="hljs-type">ESP_TC_IRQ</span></span>, <span class="hljs-type"><span class="hljs-type">INPUT</span></span>); return <span class="hljs-number"><span class="hljs-number">1</span></span>; } //    <span class="hljs-type"><span class="hljs-type">TC_IRQ</span></span> (   ) extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> int esp_getpin_pressed() { //      watch dog,   esp8266   system_soft_wdt_feed (); //    return digitalRead (<span class="hljs-type"><span class="hljs-type">ESP_TC_IRQ</span></span>)==<span class="hljs-number"><span class="hljs-number">0</span></span>; } static int aquire_count = <span class="hljs-number"><span class="hljs-number">0</span></span>; //   <span class="hljs-type"><span class="hljs-type">SPI</span></span>:  <span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-type"><span class="hljs-type">CS</span></span>    <span class="hljs-type"><span class="hljs-type">SPI</span></span>    extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> void esp_aquire_bus() { if (!aquire_count++) { <span class="hljs-type"><span class="hljs-type">SPI</span></span>.beginTransaction(spiSettings); digitalWrite(<span class="hljs-type"><span class="hljs-type">ESP_TC_CS</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } } //   <span class="hljs-type"><span class="hljs-type">SPI</span></span>:  <span class="hljs-number"><span class="hljs-number">1</span></span>   <span class="hljs-type"><span class="hljs-type">CS</span></span>    <span class="hljs-type"><span class="hljs-type">SPI</span></span> extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> void esp_release_bus() { if (aquire_count &amp;&amp; !--aquire_count) { digitalWrite(<span class="hljs-type"><span class="hljs-type">ESP_TC_CS</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-type"><span class="hljs-type">SPI</span></span>.endTransaction(); } } //      extern <span class="hljs-comment"><span class="hljs-comment">"C"</span></span> uint16_t esp_read_value(uint16_t port) { <span class="hljs-type"><span class="hljs-type">SPI</span></span>.write (port); return <span class="hljs-type"><span class="hljs-type">SPI</span></span>.transfer16(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre> </div></div><br><p>  Actually, this preparatory work is completed.  A set of source files is on the <a href="https://github.com/olegator77/ugfxesp">githab</a> </p><br><p>  Now the preparation is completed, let's start developing a program or a sketch with a beautiful and convenient GUI. </p><br><h2 id="razrabatyvaem-sketch-s-gui">  Developing a sketch with GUI </h2><br><p>  In the <a href="https://habrahabr.ru/post/346014/">last article</a> I wrote about the "smart" extension for the new Christmas tree.  The sketch GUI consists of two screens. </p><br><ul><li>  Christmas tree screensaver </li><li>  screen with buttons on / off the garlands: </li></ul><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c5e/834/4e5/c5e8344e55ad2b8db224b399b64df7d7.jpg" alt="w1"><img src="https://habrastorage.org/getpro/habr/post_images/0e5/864/1ca/0e58641caad9c03469f5540a46826027.jpg" alt="w2"></p><br><p>  Here are some snippets from the code, as implemented by the GUI in this project: </p><br><div class="spoiler">  <b class="spoiler_title">Variable definition</b> <div class="spoiler_text"><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/   GHandle ghContainerMain; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  GHandle ghButton1,ghButton2,ghButton3,ghButton4,ghButtonAll,ghButtonVoice,ghButtonTree; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  gdispImage ballImg,bearImg,candleImg,microphoneImg,treeImg,bigTreeImg,lightsImg; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   GListener glistener; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/         extern "C" void gwinButtonDraw_ImageText(GWidgetObject *gw, void *param);</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">GUI Initialization Function</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> guiCreate(<span class="hljs-type"><span class="hljs-type">void</span></span>) { gfxInit(); //  ""  geventListenerInit(&amp;glistener); geventAttachSource(&amp;glistener, ginputGetKeyboard(<span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>); gwinAttachListener(&amp;glistener); //    GUI gwinSetDefaultFont(gdispOpenFont("DejaVuSans16")); gwinSetDefaultStyle(&amp;WhiteWidgetStyle, <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>); gwinSetDefaultColor(HTML2COLOR(<span class="hljs-number"><span class="hljs-number">0x000000</span></span>)); gwinSetDefaultBgColor(HTML2COLOR(<span class="hljs-number"><span class="hljs-number">0xFFFFFF</span></span>)); //  ,       SPIFFs gdispImageOpenFile(&amp;ballImg, "ball.bmp"); gdispImageOpenFile(&amp;bearImg, "bear.bmp"); gdispImageOpenFile(&amp;candleImg, "candle.bmp"); gdispImageOpenFile(&amp;microphoneImg, "music.bmp"); gdispImageOpenFile(&amp;treeImg, "tree.bmp"); gdispImageOpenFile(&amp;lightsImg, "lights.bmp"); gdispImageOpenFile(&amp;bigTreeImg, "bigtree.bmp"); //    GUI GWidgetInit wi; gwinWidgetClearInit(&amp;wi); wi.gx = <span class="hljs-number"><span class="hljs-number">0</span></span>; wi.gy = <span class="hljs-number"><span class="hljs-number">0</span></span>; wi.g.width = <span class="hljs-number"><span class="hljs-number">176</span></span>; wi.g.height = <span class="hljs-number"><span class="hljs-number">220</span></span>; wi.g.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>; ghContainerMain = gwinContainerCreate(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;wi, <span class="hljs-number"><span class="hljs-number">0</span></span>); wi.g.parent = ghContainerMain; wi.customDraw = gwinButtonDraw_ImageText; wi.customStyle = <span class="hljs-number"><span class="hljs-number">0</span></span>; wi.customParam = &amp;bigTreeImg; wi.gx = <span class="hljs-number"><span class="hljs-number">0</span></span>; wi.gy = <span class="hljs-number"><span class="hljs-number">0</span></span>; wi.text = ""; ghButtonTree = gwinButtonCreate(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;wi); wi.g.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>; wi.customParam = &amp;ballImg; wi.g.width = <span class="hljs-number"><span class="hljs-number">88</span></span>; wi.g.height = <span class="hljs-number"><span class="hljs-number">73</span></span>; wi.text = ""; ghButton1 = gwinButtonCreate(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;wi); wi.customParam = &amp;candleImg; wi.gx = <span class="hljs-number"><span class="hljs-number">88</span></span>; wi.gy = <span class="hljs-number"><span class="hljs-number">0</span></span>; wi.text = ""; ghButton2 = gwinButtonCreate(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;wi); wi.customParam = &amp;bearImg; wi.gx = <span class="hljs-number"><span class="hljs-number">0</span></span>; wi.gy = <span class="hljs-number"><span class="hljs-number">73</span></span>; wi.text = ""; ghButton3 = gwinButtonCreate(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;wi); wi.customParam = &amp;lightsImg; wi.gx = <span class="hljs-number"><span class="hljs-number">88</span></span>; wi.gy = <span class="hljs-number"><span class="hljs-number">73</span></span>; wi.text = ""; ghButton4 = gwinButtonCreate(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;wi); wi.customParam = &amp;treeImg; wi.gx = <span class="hljs-number"><span class="hljs-number">0</span></span>; wi.gy = <span class="hljs-number"><span class="hljs-number">146</span></span>; wi.text = ""; ghButtonAll = gwinButtonCreate(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;wi); wi.customParam = &amp;microphoneImg; wi.gx = <span class="hljs-number"><span class="hljs-number">88</span></span>; wi.gy = <span class="hljs-number"><span class="hljs-number">146</span></span>; wi.text = ""; ghButtonVoice = gwinButtonCreate(<span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;wi); }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Event handling</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">static <span class="hljs-type"><span class="hljs-type">bool</span></span> screenSaver = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; //       <span class="hljs-type"><span class="hljs-type">void</span></span> switchScreen (<span class="hljs-type"><span class="hljs-type">bool</span></span> flag) { gwinSetVisible (ghButton1,flag); gwinSetVisible (ghButton2,flag); gwinSetVisible (ghButton3,flag); gwinSetVisible (ghButton4,flag); gwinSetVisible (ghButtonAll,flag); gwinSetVisible (ghButtonVoice,flag); gwinSetVisible (ghButtonTree,!flag); screenSaver = !flag; } static unsigned long timeLastActivity =<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>() { unsigned long now = millis(); //      GEvent* pe = geventEventWait(&amp;glistener, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pe &amp;&amp; pe-&gt;<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == GEVENT_GWIN_BUTTON) { GEventGWinButton *we = (GEventGWinButton *)pe; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (we-&gt;gwin == ghButton1) {<span class="hljs-comment"><span class="hljs-comment">/*    */</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (we-&gt;gwin == ghButton2) {<span class="hljs-comment"><span class="hljs-comment">/*    */</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (we-&gt;gwin == ghButton3) {<span class="hljs-comment"><span class="hljs-comment">/*    */</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (we-&gt;gwin == ghButton4) {<span class="hljs-comment"><span class="hljs-comment">/*    */</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (we-&gt;gwin == ghButtonAll) {<span class="hljs-comment"><span class="hljs-comment">/*    */</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (we-&gt;gwin == ghButtonVoice) {<span class="hljs-comment"><span class="hljs-comment">/*    */</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (we-&gt;gwin == ghButtonTree) {switchScreen (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); startRecognize();} timeLastActivity = now; } //      <span class="hljs-number"><span class="hljs-number">10</span></span> ,    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!screenSaver &amp;&amp; now - timeLastActivity &gt; <span class="hljs-number"><span class="hljs-number">10000</span></span>) { switchScreen (<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } delay (<span class="hljs-number"><span class="hljs-number">10</span></span>); }</code> </pre> </div></div><br><p>  As a result - a reasonable number of lines of code gives a complete, and for my taste, beautiful GUI.  On the githabe <a href="https://github.com/olegator77/new-year-tree">full version of the sketch</a> </p><br><h1 id="esche-primery-ispolzovaniya">  More usage examples </h1><br><h2 id="prostoy-oscilograf">  Simple oscillograph </h2><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HYQeQsEpD5c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Sources on githaba: <a href="">the sketch itself</a> </p><br><p>  <a href="">Realization of drawing graphs</a> </p><br><h2 id="tetris">  Tetris </h2><br><iframe width="560" height="315" src="https://www.youtube.com/embed/jODLNU0opfc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Github sources: <a href="">tetris</a> </p><br><p>  <a href="">the source of the sketch from the first video</a> </p><br><p>  So, in this article, we managed to make a convenient and beautiful GUI solution, using the libraries available in Open Source. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346276/">https://habr.com/ru/post/346276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346266/index.html">The effect of group polarization and its mathematical modeling</a></li>
<li><a href="../346268/index.html">Physical simulation on the GPU using the compute shader in the Unity3D environment</a></li>
<li><a href="../346270/index.html">We work with smart cards using Python (part 1)</a></li>
<li><a href="../346272/index.html">"Simple" python programming</a></li>
<li><a href="../346274/index.html">Web installer on pure WINAPI with Hi DPI support and vector logo</a></li>
<li><a href="../346284/index.html">We select passwords using Google Chrome</a></li>
<li><a href="../346286/index.html">We write our own miniature Redis server in Python</a></li>
<li><a href="../346290/index.html">Testing of software documentation</a></li>
<li><a href="../346292/index.html">We turn speakers into speakers # 2: analysis of the speech of Artem Danilov, Avito</a></li>
<li><a href="../346294/index.html">What does Product Marketing Manager in JetBrains do?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>