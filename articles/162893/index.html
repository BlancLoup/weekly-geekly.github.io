<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A bit about Pivot tables in PostgreSQL and Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 Working at the institute, I have to deal with a lot of semi-structured information. Here, the prefix "semi" means that, in general, all d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A bit about Pivot tables in PostgreSQL and Python</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br><br>  Working at the institute, I have to deal with a lot of semi-structured information.  Here, the prefix "semi" means that, in general, all data is similar, but, as a rule, they are pushed into local folders on employees' computers, in .xls, .txt or in binary format.  The information is data obtained from various devices (level sensors, temperature, flow velocity, atmospheric pressure, humidity, and so on, up to 20-30 different parameters).  All instruments unload data each in its own format: either in ascii or a binary format, which is then processed, and, at the output, ascii is obtained again.  Well, in general, everything as always, you yourself represent all this chaos. <br><br>  I wanted to stuff the whole thing into one common database, so as not to look for the right data of the right version in the right folder, which takes a lot of time.  Experience in the development of various systems (mainly geo-information) is available.  But what was done before contained only processed data, and in general, all these systems were custom made.  There was no automation complex for themselves. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Processing of this whole economy is quite standard thing, nothing new and interesting: checking the time series for integrity (if you need interpolation), building a heap of various graphs, running different models on this data, processing the output of models (again a bunch of graphs), outputting statistics.  I will tell about the last in this article. <br><br><a name="habracut"></a><br><h4>  Statistics </h4><br>  It would not be so sad if there was no need to get not just ordinary indicators (minimum, maximum, average, deviation, etc.), but also summary tables (Pivot tables) of various kinds. <br><br><h5>  Simple </h5><br>  We have data on speed, we need to build a table of the form: <br><table><tbody><tr><th>  Gradations of speed, cm / s </th><th>  Repeatability,% </th></tr><tr><td>  0-10 </td><td>  60% </td></tr><tr><td>  10-20 </td><td>  thirty% </td></tr><tr><td>  20-30 </td><td>  ten% </td></tr></tbody></table><br>  The original series itself is about 10k speed values.  I am not an Excel guru and, except in VBA, I don‚Äôt know a simple way how to do this (no, of course, there is also an option to pull formulas, then sort and so on, and also make pivot tables in excel itself, but each time for each device this is brute force). <br>  In the database (I use PostgresSQL) the task looks like this: <br><br><pre><code class="sql hljs">REATE TABLE tbldata ( dataid serial NOT NULL, measurementdate timestamp without time zone, velocity double precision, direction double precision ); <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>*(<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(velocity)/(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbldata)::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbldata velocity&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> measurement&lt;<span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br><br>  How many gradations - so many requests, automated easily, works quickly.  You can write a stored procedure that will take values ‚Äã‚Äãfrom, step, number of steps and which will output SETOF RECORDS.  In general, the problem is solved. <br><br><h5>  More difficult </h5><br>  Problems begin when a table of the form is needed: <br><table><tbody><tr><th rowspan="2">  Gradations of speed, cm / s </th><th colspan="8">  Rumbam frequency,% </th></tr><tr><th>  WITH </th><th>  NE </th><th>  AT </th><th>  SE </th><th>  YU </th><th>  SW </th><th>  H </th><th>  NW </th></tr><tr><td>  0 - 10 </td><td>  10.8 </td><td>  8.2 </td><td>  1.3 </td><td>  1.3 </td><td>  2.1 </td><td>  10.1 </td><td>  6.9 </td><td>  25.4 </td></tr><tr><td>  10 - 20 </td><td>  4.0 </td><td>  0.1 </td><td>  0.1 </td><td>  1.6 </td><td>  3.3 </td><td>  0.6 </td><td>  0.1 </td><td>  10.9 </td></tr><tr><td>  20 - 30 </td><td>  1.8 </td><td>  0.0 </td><td>  0.0 </td><td>  1.2 </td><td>  3.4 </td><td>  0.1 </td><td>  0.0 </td><td>  2.2 </td></tr><tr><td>  30 - 40 </td><td>  0.7 </td><td>  0.0 </td><td>  0.0 </td><td>  0.8 </td><td>  1.2 </td><td>  0.0 </td><td>  0.0 </td><td>  0.3 </td></tr><tr><td>  40 - 50 </td><td>  0.1 </td><td>  0.0 </td><td>  0.0 </td><td>  0.3 </td><td>  0.2 </td><td>  0.0 </td><td>  0.0 </td><td>  0.1 </td></tr><tr><td>  50 - 60 </td><td>  0.1 </td><td>  0.0 </td><td>  0.0 </td><td>  0.2 </td><td>  0.1 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td></tr><tr><td>  60 - 70 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.1 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td></tr><tr><td>  70 - 80 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.1 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td></tr></tbody></table><br>  That is, you need to calculate the percentage of gradations for two variables: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>*(<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*)/(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbldata)::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbldata <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> velocity &gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> velocity&lt;<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (direction&gt;<span class="hljs-number"><span class="hljs-number">337.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> direction&lt;<span class="hljs-number"><span class="hljs-number">22.5</span></span>);</code> </pre><br><br>  Then you can take advantage of the excellent <a href="http://www.postgresql.org/docs/current/static/tablefunc.html">crosstab</a> .  To do this, you need to slightly modify the SQL by adding the information about the gradation number in speed and the number of gradation in the direction: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VelGrd,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DirGrid, <span class="hljs-number"><span class="hljs-number">100</span></span>*(<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*)/(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbldata)::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbldata <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> velocity &gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> velocity&lt;<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (direction&gt;<span class="hljs-number"><span class="hljs-number">337.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> direction&lt;<span class="hljs-number"><span class="hljs-number">22.5</span></span>);</code> </pre><br>  Then wrap it all into a function, which will include the beginning, step and number of steps for both speed and direction, which will give UNION ALL of all these requests. <br>  As a result, our query will look like this. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> crosstab(<span class="hljs-string"><span class="hljs-string">'fnMakePercentageByTwoVariables(0,10,10,22.5,45,8)'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tbldata(velGrid <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>,dirGrid1 <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, ‚Ä¶,dirGrid8 <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>);</code> </pre><br><h5>  Very bad </h5><br><table><tbody><tr><th rowspan="2">  Gradations of speed, cm / s </th><th colspan="8">  Rumbam frequency,% </th><th rowspan="2">  Amount </th><th rowspan="2">  Security% </th></tr><tr><th>  WITH </th><th>  NE </th><th>  AT </th><th>  SE </th><th>  YU </th><th>  SW </th><th>  H </th><th>  NW </th></tr><tr><td>  0 - 10 </td><td>  10.8 </td><td>  8.2 </td><td>  1.3 </td><td>  1.3 </td><td>  2.1 </td><td>  10.1 </td><td>  6.9 </td><td>  25.4 </td><td>  66.1 </td><td>  100.0 </td></tr><tr><td>  10 - 20 </td><td>  4.0 </td><td>  0.1 </td><td>  0.1 </td><td>  1.6 </td><td>  3.3 </td><td>  0.6 </td><td>  0.1 </td><td>  10.9 </td><td>  20.6 </td><td>  33.9 </td></tr><tr><td>  20 - 30 </td><td>  1.8 </td><td>  0.0 </td><td>  0.0 </td><td>  1.2 </td><td>  3.4 </td><td>  0.1 </td><td>  0.0 </td><td>  2.2 </td><td>  8.8 </td><td>  13.3 </td></tr><tr><td>  30 - 40 </td><td>  0.7 </td><td>  0.0 </td><td>  0.0 </td><td>  0.8 </td><td>  1.2 </td><td>  0.0 </td><td>  0.0 </td><td>  0.3 </td><td>  3.1 </td><td>  4.5 </td></tr><tr><td>  40 - 50 </td><td>  0.1 </td><td>  0.0 </td><td>  0.0 </td><td>  0.3 </td><td>  0.2 </td><td>  0.0 </td><td>  0.0 </td><td>  0.1 </td><td>  0.7 </td><td>  1.4 </td></tr><tr><td>  50 - 60 </td><td>  0.1 </td><td>  0.0 </td><td>  0.0 </td><td>  0.2 </td><td>  0.1 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.4 </td><td>  0.7 </td></tr><tr><td>  60 - 70 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.1 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.2 </td><td>  0.3 </td></tr><tr><td>  70 - 80 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.1 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.0 </td><td>  0.1 </td><td>  0.1 </td></tr><tr><td>  Amount </td><td>  17.6 </td><td>  8.3 </td><td>  1.4 </td><td>  5.5 </td><td>  10.3 </td><td>  10.9 </td><td>  7.1 </td><td>  39.0 </td><td>  100.0 </td><td></td></tr><tr><td>  Average speed, cm / s </td><td>  10.7 </td><td>  2.6 </td><td>  2.9 </td><td>  22.6 </td><td>  19.9 </td><td>  4.3 </td><td>  3.3 </td><td>  9.2 </td><td>  9.7 </td><td></td></tr><tr><td>  Maximum speed, cm / s </td><td>  76.2 </td><td>  57.8 </td><td>  50.2 </td><td>  78.3 </td><td>  61.1 </td><td>  48.8 </td><td>  42.9 </td><td>  62.5 </td><td>  78.3 </td><td></td></tr></tbody></table><br><br>  To be honest here, my patience is already over, to the previous query, you need to add three union and one join.  And if you want to know the square deviation and something else?  One more union and so on until there is enough imagination.  Security (in fact, it is a cumulative percentage from the bottom up), I still don‚Äôt know how to count, except for handles.  In general, if the look of the table does not change, then this can be avoided. <br><br><h5>  Much worse </h5><br>  But the challenge is to compare the readings of the two devices.  Then it turns out that each column must also be divided into two columns: <br><table><tbody><tr><th rowspan="3">  Gradations of speed, cm / s </th><th colspan="5">  Rumbam frequency,% </th></tr><tr><th colspan="2">  WITH </th><th>  ... </th><th colspan="2">  NW </th></tr><tr><th>  Device 1 </th><th>  Device 2 </th><th>  ... </th><th>  Device 1 </th><th>  Device 2 </th></tr><tr><td>  0 - 10 </td><td>  10.8 </td><td>  8.2 </td><td>  ... </td><td>  1.3 </td><td>  1.3 </td></tr><tr><td>  ... </td><td>  ... </td><td>  ... </td><td>  ... </td><td>  ... </td><td>  ... </td></tr></tbody></table><br><br>  We are also interested to compare the readings of devices immediately?  Yes, for me.  When I thought about such a comparison, I felt very sad.  There was no option faster than loading the data into SPSS, re-encode everything and output exactly what you need without tons of hatred.  It is also important to have tables where, according to the speed gradations, you also need to have a cumulative percentage, which you also had to do in Excel with your hands. <br><br><h5>  Decision </h5><br><br>  My main tool for work is python, I use Django to develop applications.  And in the end I decided - to hell with everything, enough pain and suffering.  Stored procedures are fast and good, but it's hard for me to maintain them.  Plus, the speed of work is not a factor - people who dealt with it to me, God forbid if they did not consider everything with their hands.  So wait a minute - another instead of having to shovel a series of data for a couple of hours - it‚Äôs just heavenly delight. <br><br>  And so salvation came in the face of <a href="http://pandas.pydata.org/">Pandas</a> , about which I did not find a single mention in Habr√©.  The main charm of the "panda" in their data types.  One-dimensional - <a href="http://pandas.pydata.org/pandas-docs/dev/dsintro.html">Series</a> .  In fact, the series has everything that I lacked in dict.  A lot of bikes are made to expand the dictionary functionality and this is all from ignorance about the panda. <br>  You can apply both to the dictionary using the key s ['a'], and as sa For all the rest, panda structures work with vectorized functions from numpy (I cannot live without numpy.where).  Series are added to the <a href="http://pandas.pydata.org/pandas-docs/dev/dsintro.html">DataFrame</a> - already a two dimensional structure.  DataFrame in the <a href="http://pandas.pydata.org/pandas-docs/dev/dsintro.html">Panel</a> .  All this works with slices, sub-indexes, a set of indices, with mixed data - in general, everything is divine! <br><br>  And back to my task to get the table I need: <br><br>  First, let's connect to the postgrese and get the result of the query <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pandas.io.sql <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> frame_query conn_string = <span class="hljs-string"><span class="hljs-string">"host='localhost' dbname='test' user='postgres' password='**********'"</span></span> conn = psycopg2.connect(conn_string) <span class="hljs-comment"><span class="hljs-comment">#frame_query   sql ,   DataFrame df = frame_query('select velocity,direction from tbldata', con=conn)</span></span></code> </pre><br><br>  Create gradations and labels for them. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeVelocityLabels</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c)</span></span></span><span class="hljs-function">:</span></span> ret = dict() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> levidx <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(len(c.levels)): lev=c.levels[levidx] ret[levidx]=str(lev).replace(<span class="hljs-string"><span class="hljs-string">'('</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>).replace(<span class="hljs-string"><span class="hljs-string">", "</span></span>,<span class="hljs-string"><span class="hljs-string">"-"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">']'</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret velGrid = np.linspace(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>) dirGrid = np.linspace(<span class="hljs-number"><span class="hljs-number">-22.5</span></span>,<span class="hljs-number"><span class="hljs-number">337.5</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span>) dirLabels=[<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>] velLabels = makeVelocityLabels(pd.cut(velGrid,velGrid)).values()</code> </pre><br>  Inquisitive eyes noticed the <a href="http://pandas.pydata.org/pandas-docs/dev/basics.html%3Fhighlight%3Dcut">cut</a> function.  It deals with the fact that it makes discrete from a continuous series, actually turns a variable into a Category type.  If I have always used <a href="http://docs.scipy.org/doc/numpy/reference/generated/numpy.where.html">numpy.where before</a> , piling up something like: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(len(velGrid)<span class="hljs-number"><span class="hljs-number">-1</span></span>): veloity[np.where((velocity&gt;velGrid[i]) &amp; (velocity&lt;velGrid[i+<span class="hljs-number"><span class="hljs-number">1</span></span>]))]=velGrid[i]</code> </pre><br>  now i do it <br><pre> <code class="python hljs">pd.cut(velocity,velGrid)</code> </pre><br><br>  Next, create a new DataFrame, put categorical variables in it: <br><pre> <code class="python hljs">resultDf = pd.DataFrame(index=df.index,columns=df.columns) <span class="hljs-comment"><span class="hljs-comment">#df[df.direction&gt;337.5].direction -   . # ,     . df.direction[df.direction&gt;337.5]-=360 resultDf.velocity = pd.cut(df.velocity,velGrid,labels=velLabels,include_lowest=True) resultDf.direction = pd.cut(df.direction,dirGrid,labels=dirLabels,include_lowest=True)</span></span></code> </pre><br><br>  Then the most interesting begins. Since there will be directions in the table heading (in fact, I cross the speed into directions), then in order to take statistics (minimum, maximum and mn), I need to count them as well for each direction. <br>  Let us understand how much we have measurements for each gradation of direction. <br><pre> <code class="python hljs">totalDir = resultDf.groupby(<span class="hljs-string"><span class="hljs-string">"direction"</span></span>).size() direction  <span class="hljs-number"><span class="hljs-number">97</span></span>  <span class="hljs-number"><span class="hljs-number">503</span></span>  <span class="hljs-number"><span class="hljs-number">1251</span></span>  <span class="hljs-number"><span class="hljs-number">592</span></span>  <span class="hljs-number"><span class="hljs-number">2773</span></span>  <span class="hljs-number"><span class="hljs-number">736</span></span>  <span class="hljs-number"><span class="hljs-number">388</span></span>  <span class="hljs-number"><span class="hljs-number">773</span></span></code> </pre><br>  I would recommend using the count () function instead of size (), which will return all values ‚Äã‚Äãthat are not missing. <br>  Next, we need to calculate statistics, also in directions, for maximum, average, and build the actual table. <br><br><pre> <code class="python hljs">dfDGr = df.copy() dfDGr.direction = resultDf.direction meanVel = dfDGr.groupby(<span class="hljs-string"><span class="hljs-string">"direction"</span></span>).mean() maxVel = dfDGr.groupby(<span class="hljs-string"><span class="hljs-string">"direction"</span></span>).max() totalVel = resultDf.groupby(<span class="hljs-string"><span class="hljs-string">"velocity"</span></span>).size() pivot = <span class="hljs-number"><span class="hljs-number">100</span></span> * pd.pivot_table(resultDf,rows=<span class="hljs-string"><span class="hljs-string">'velocity'</span></span>,cols=<span class="hljs-string"><span class="hljs-string">'direction'</span></span>,aggfunc=len, fill_value=<span class="hljs-number"><span class="hljs-number">0</span></span>)/totalDir.sum() direction         velocity <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span> <span class="hljs-number"><span class="hljs-number">1.279348</span></span> <span class="hljs-number"><span class="hljs-number">6.916913</span></span> <span class="hljs-number"><span class="hljs-number">10.839308</span></span> <span class="hljs-number"><span class="hljs-number">8.224378</span></span> <span class="hljs-number"><span class="hljs-number">25.432307</span></span> <span class="hljs-number"><span class="hljs-number">2.066639</span></span> <span class="hljs-number"><span class="hljs-number">1.265289</span></span> <span class="hljs-number"><span class="hljs-number">10.066076</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span><span class="hljs-number"><span class="hljs-number">-20</span></span> <span class="hljs-number"><span class="hljs-number">0.056235</span></span> <span class="hljs-number"><span class="hljs-number">0.126529</span></span> <span class="hljs-number"><span class="hljs-number">3.992689</span></span> <span class="hljs-number"><span class="hljs-number">0.070294</span></span> <span class="hljs-number"><span class="hljs-number">10.881485</span></span> <span class="hljs-number"><span class="hljs-number">3.303810</span></span> <span class="hljs-number"><span class="hljs-number">1.560523</span></span> <span class="hljs-number"><span class="hljs-number">0.632644</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-number"><span class="hljs-number">-30</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.014059</span></span> <span class="hljs-number"><span class="hljs-number">1.813581</span></span> <span class="hljs-number"><span class="hljs-number">0.014059</span></span> <span class="hljs-number"><span class="hljs-number">2.235344</span></span> <span class="hljs-number"><span class="hljs-number">3.388163</span></span> <span class="hljs-number"><span class="hljs-number">1.223113</span></span> <span class="hljs-number"><span class="hljs-number">0.112470</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span><span class="hljs-number"><span class="hljs-number">-40</span></span> <span class="hljs-number"><span class="hljs-number">0.014059</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.674821</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.323352</span></span> <span class="hljs-number"><span class="hljs-number">1.237171</span></span> <span class="hljs-number"><span class="hljs-number">0.801350</span></span> <span class="hljs-number"><span class="hljs-number">0.014059</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span><span class="hljs-number"><span class="hljs-number">-50</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.014059</span></span> <span class="hljs-number"><span class="hljs-number">0.140588</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.056235</span></span> <span class="hljs-number"><span class="hljs-number">0.224940</span></span> <span class="hljs-number"><span class="hljs-number">0.253058</span></span> <span class="hljs-number"><span class="hljs-number">0.042176</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span><span class="hljs-number"><span class="hljs-number">-60</span></span> <span class="hljs-number"><span class="hljs-number">0.014059</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.084353</span></span> <span class="hljs-number"><span class="hljs-number">0.014059</span></span> <span class="hljs-number"><span class="hljs-number">0.042176</span></span> <span class="hljs-number"><span class="hljs-number">0.112470</span></span> <span class="hljs-number"><span class="hljs-number">0.168705</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span><span class="hljs-number"><span class="hljs-number">-70</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.028118</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.014059</span></span> <span class="hljs-number"><span class="hljs-number">0.014059</span></span> <span class="hljs-number"><span class="hljs-number">0.126529</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">70</span></span><span class="hljs-number"><span class="hljs-number">-80</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.014059</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span> <span class="hljs-number"><span class="hljs-number">0.056235</span></span> <span class="hljs-number"><span class="hljs-number">0.000000</span></span></code> </pre><br><br>  It remains only to add statistics to the table, round it up and put the columns in the correct order. <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCumulate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s)</span></span></span><span class="hljs-function">:</span></span> ns = s.copy() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> val <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(s.size): ns[ns.index[val]]=np.sum(s[s.index[val]:s.index[s.size<span class="hljs-number"><span class="hljs-number">-1</span></span>]]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ns pivot[<span class="hljs-string"><span class="hljs-string">""</span></span>] = <span class="hljs-number"><span class="hljs-number">100</span></span> * np.round(totalVel/float(np.sum(totalVel)),<span class="hljs-number"><span class="hljs-number">3</span></span>) pivot[<span class="hljs-string"><span class="hljs-string">',%'</span></span>]=getCumulate(pivot[<span class="hljs-string"><span class="hljs-string">""</span></span>]) totalDirFr = pd.DataFrame(<span class="hljs-number"><span class="hljs-number">100</span></span>*totalDir/float(np.sum(totalDir))).T totalDirFr.index= [<span class="hljs-string"><span class="hljs-string">""</span></span>] pivot = pivot.append(totalDirFr) meanVelFr = meanVel.T meanVelFr.index=[<span class="hljs-string"><span class="hljs-string">" "</span></span>] pivot = pivot.append(meanVelFr) maxVelFr = maxVel.T maxVelFr.index=[<span class="hljs-string"><span class="hljs-string">" "</span></span>] pivot = pivot.append(maxVelFr) <span class="hljs-comment"><span class="hljs-comment">#    -   ,    ,     NA pivot=pivot.reindex(columns=np.append(dirLabels,["",",%"])) pivot = np.round(pivot,1).fillna(0)          ,% 0-10 10.8 8.2 1.3 1.3 2.1 10.1 6.9 25.4 66.1 100.0 10-20 4.0 0.1 0.1 1.6 3.3 0.6 0.1 10.9 20.6 33.9 20-30 1.8 0.0 0.0 1.2 3.4 0.1 0.0 2.2 8.8 13.3 30-40 0.7 0.0 0.0 0.8 1.2 0.0 0.0 0.3 3.1 4.5 40-50 0.1 0.0 0.0 0.3 0.2 0.0 0.0 0.1 0.7 1.4 50-60 0.1 0.0 0.0 0.2 0.1 0.0 0.0 0.0 0.4 0.7 60-70 0.0 0.0 0.0 0.1 0.0 0.0 0.0 0.0 0.2 0.3 70-80 0.0 0.0 0.0 0.1 0.0 0.0 0.0 0.0 0.1 0.1  17.6 8.3 1.4 5.5 10.3 10.9 7.1 39.0 0.0 0.0   10.7 2.6 2.9 22.6 19.9 4.3 3.3 9.2 0.0 0.0   76.2 57.8 50.2 78.3 61.1 48.8 42.9 62.5 0.0 0.0</span></span></code> </pre><br><h5>  Summary: </h5><br>  The result is exactly what you need.  Less blood?  - Yes.  Easier to modify?  - Yes. <br>  In fact, the whole hemorrhoids is that the variables are not categories, if they were fed to the input right away, then everything would be much simpler.  On my weak laptop, the whole script works in 0.2 seconds for 7113 values. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/162893/">https://habr.com/ru/post/162893/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162881/index.html">Integration of the 1C-Bitrix template</a></li>
<li><a href="../162883/index.html">Crowdfunding Secrets from Gary and Charles</a></li>
<li><a href="../162885/index.html">Black holes in the development of Web project</a></li>
<li><a href="../162889/index.html">Basics in SciLab. On the example of exam questions on CSVE</a></li>
<li><a href="../162891/index.html">Installing the patch when running VMware on Ubuntu 12.04 and other distributions</a></li>
<li><a href="../162895/index.html">10 misconceptions about Windows Azure and Open Source</a></li>
<li><a href="../162901/index.html">QR code to help IT manager</a></li>
<li><a href="../162903/index.html">More than mail</a></li>
<li><a href="../162905/index.html">The second life of the old clock</a></li>
<li><a href="../162909/index.html">Linux Olympics Report + Tasks with Answers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>