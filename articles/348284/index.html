<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart Contract Calling System in the Ethereum blockchain</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task 
 Often, smart contract developers under Ethereum are faced with a seemingly simple problem - calling a smart contract code in the future or on a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart Contract Calling System in the Ethereum blockchain</h1><div class="post__text post__text-html js-mediator-article"><h2>  Task </h2><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7f1/6dd/d3e/7f16ddd3ed51667b8968dd3786377120.png" alt="Centralized solution"></div><br>  Often, smart contract developers under Ethereum are faced with a seemingly simple problem - calling a smart contract code in the future or on a schedule.  But there is no suitable solution, and you have to develop a separate service for invoking contracts. <br><br>  Developing contact templates for the <b>MyWish</b> platform <b>,</b> we immediately faced this limitation.  And we set a goal to get around this restriction ‚Äúbeautifully‚Äù - with the help of a decentralized solution.  This system must put contracts into action, and therefore decided to name it Joule, in honor of the English physicist <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B6%25D0%25BE%25D1%2583%25D0%25BB%25D1%258C,_%25D0%2594%25D0%25B6%25D0%25B5%25D0%25B9%25D0%25BC%25D1%2581">James Joule</a> . <br><br>  In this article I would like to talk about the development of Joule, about the decisions that formed the basis of the system and the results obtained.  We want to believe that the development, to some extent, is innovative and the applied solutions may be interesting and useful for the Habr audience. <br><a name="habracut"></a><br>  Before describing the solution, it is necessary to tell the basic things about Ethereum blockchain smart contracts. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Smart contracts </h3><br>  Etherium smart network contracts are programs running in the <b>EVM</b> (ethereum virtual machine) environment.  Each such contract has a unique address, balance of funds (ethers), state (permanent memory) and a set of functions available for calling (or without functions). <br><br>  The code, balance and status of the contract is stored in the blockchain. <br><br>  The user can call the contract function using a transaction.  Or without a transaction, if the function does not change the state of the contract or someone else‚Äôs balance. <br><br>  The contract method may have any, in complexity, implementation, and is limited only by the gas required to carry out each instruction.  A contract may change its balance, may apply to other contracts, may receive funds from other network participants, etc. <br><br>  Etherium is so arranged that only a user can launch a transaction into the network with a contract call.  If, for example, in order for a contract to work, it is necessary to make a call to its method at some particular moment, then the user should be concerned about this. <br><br><h3>  Call system </h3><br>  The first obvious solution is a service that will publish a transaction to the network at the right time. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e47/293/ec2/e47293ec26613987bbcc701d01bc0a02.png" alt="Centralized solution"><br>  This solution has a key drawback - this solution is centralized.  If something happens to the server where the service is located, for example, it is disconnected for non-payment, it will be fined, etc., then calls will not be made.  So the contracts will not be executed, which is unacceptable. <br><br>  To circumvent this drawback, our team came up with the Joule system, which is implemented on the basis of smart contracts. <br><br><h2>  Joule </h2><br>  <b>Joule</b> is a smart contract on the <b>Ethereum</b> network that allows you to register a call to any contract at a specific point in time.  <b>Joule</b> provides the opportunity for any user of the Ethereum network to call registered contracts. <br><br>  To motivate network members to make a call, a reward and bonus are paid, which are set during call registration.  The calculation of the amount required for the reward is done by <b>Joule</b> .  The amount of remuneration fully covers the cost of gas spent on the call.  In the form of a bonus part, <b>WISH</b> tokens are paid for the call (not implemented in the current version). <br><br>  The system allows you to register multiple calls of contracts at the same time stamp.  Also, the same contract can be registered at different times.  The only restriction is that you cannot do registration with a completely identical set of parameters (contract address, time, gas and gas cost). <br><br>  <b>Joule</b> , like any ethereum network contract, allows you to simultaneously call yourself to multiple users.  And it may happen that there will be more calls to <b>Joule</b> than there are contracts available to call.  In this case, only the first caller will receive a reward. <br><br>  At any time, the user (using the smart contract method or the web interface) can find out which contracts are queued for a call and at what point the call must be made.  The amount of remuneration and the amount of gas required to fulfill the contract are also available from the <b>Joule</b> contract. <br><br>  <b>Joule</b> guarantees that the contract will not be called before the time specified at registration, and does not allow to disturb the order of calls. <br><br><h3>  Technical difficulties of implementation </h3><br>  To develop a contract as complex as <b>Joule,</b> it is necessary to solve a large number of technical problems.  One of such tasks is the issue of storing a set of addresses of contracts and time to call them (and other parameters).  Receipt of the first in line to call a contract must be made in constant time (independent of the number of contracts registered in the system). <br><br>  Additional complexity in the design process necessitates the choice of algorithms, with minimal gas consumption.  For example, you cannot use solutions that have an algorithmic complexity greater than <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>l</mi><mi>n</mi><mo stretchy=&quot;false&quot;>(</mo><mi>n</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.875ex" height="2.66ex" viewBox="0 -832 3821 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-6C" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-6E" x="1451" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-28" x="2052" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-6E" x="2441" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-29" x="3042" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-29" x="3431" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-1"> O (ln (n)) </script>  .  In addition to the cost of gas, there is still a limit on the number of gas.  For example, if the algorithm with the complexity of <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>n</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mn>2</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.302ex" height="2.66ex" viewBox="0 -832 3144 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-6E" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-2F" x="1753" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-32" x="2254" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-29" x="2754" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mn>2</mn><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-2"> O (n / 2) </script>  , and the search of each element will require <b>50,000</b> gas, then after adding <b>185</b> elements, the contract will not be able to search (with the current limit <b>of 4,600,000</b> gas per transaction). <br><br><h2>  Decision </h2><br>  This chapter will describe the key technical solutions included in the Joule system. <br><br><h3>  Record structure </h3><br>  To store the state (except for balance), the contract has access to a key-value type repository.  The key in the storage can be any 256-bit number.  In fact, before saving, EVM calculates a key checksum using the <a href="https://ru.wikipedia.org/wiki/SHA-3">keccak (sha-3)</a> algorithm <a href="https://ru.wikipedia.org/wiki/SHA-3">.</a>  The value is also a 256-bit number (the compiler allows you to put values ‚Äã‚Äãin a larger state by adding an offset parameter to the key).  Thus, the contract can store 2 ^ 256 unique values ‚Äã‚Äãof 256 bits each, which exceeds the requirements by many orders of magnitude. <br><br>  The key-value storage can be considered as a random access memory with a dimension of 2 ^ 256.  In this case, the key is a reference to the memory cell.  The data structure necessary for storing call recording consists of the following fields: contract address, time the contract is called, the number of gas required to call the contract and the cost of gas.  All this data can fit in 256 bits (32 bytes): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5b0/7f9/f18/5b07f9f18e021af07b1f9f65b937f17d.png" alt="Record structure"><br><br><h3>  Restrictions </h3><br>  Using this data storage structure, you must accept some restrictions: <br><br><ul><li>  <b>Address</b> - 20 bytes (address in the Ethereum network). </li><li>  <b>Timestamp</b> - 4 bytes, the standard <a href="https://ru.wikipedia.org/wiki/UNIX-%25D0%25B2%25D1%2580%25D0%25B5%25D0%25BC%25D1%258F">Unix Time</a> value, valid from 1970-01-01 00:00:00 to 2106-02-07T09: 28: 15 (for unsigned values).  In simple words - the maximum registration period is 2106.  In the future, this value can be increased to 6812 years due to the use of an extra byte from the field to the magnitude of the gas. </li><li>  <b>Gas</b> - 4 bytes, but in fact the network allows you to make a single transaction for no more than 4,600,000 gas.  Taking into account the cost of gas for the operation of the <b>Joule</b> system at the time of calling the contract, a limit of 4 million gas per contract is now registered.  Although, of course, 600,000 gas is not needed for Joule operation - an average of 50,000 gas is enough. </li><li>  <b>Gas Price</b> - 4 bytes.  Estimated at registration cost of gas.  This value is stored in gwei (10 ^ 9 wei), so the minimum size is 0.000000001 ether, and the maximum is 4.294967296 ether. </li></ul><br><h3>  Storing a chain of records </h3><br>  The smart contract supports two storage structures for a set of data: an array with access by index and a ratio (mapping) with access by key.  But in reality, the array is stored as a mapping, where the key is an index, and does not provide any advantages in terms of access speed.  In addition, inserting elements into the middle of an array requires shifting all elements and this may require an unacceptable amount of gas.  Therefore, a solution based on linked lists is better suited for this task. <br><br>  The following technology is used to store the list in the ratio: the value of the record (32 bytes) is considered as a key (or a link, if we draw an analogy with the C ++ language) to the next value. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c3/607/8c1/5c36078c1a3aa030a9ce944d020e5227.png" alt="Chain of records"><br><br>  The image on the left shows the registration records <b>R</b> and key acquisition functions. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi><mo stretchy=&quot;false&quot;>(</mo><mi>R</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>R</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.502ex" height="2.66ex" viewBox="0 -832 4521.6 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-4B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-28" x="889" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-52" x="1279" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-29" x="2038" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-3D" x="2705" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-52" x="3762" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo><mo>=</mo><mi>R</mi></math></span></span><script type="math/tex" id="MathJax-Element-3"> K (R) = R </script>  in the form of a chain of values.  On the right is a key-value store in the form of a table.  See that the value <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>K</mi><mn>0</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.027ex" height="2.419ex" viewBox="0 -780.1 1303.4 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-4B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-30" x="1201" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>K</mi><mn>0</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-4"> K_0 </script>  is lost because it is only the key to the next value.  The contract is not possible to read the key from the relationship.  For this, the table contains a zero record (Head), which always indicates the value of the beginning of the chain. <br><br>  The order of entries in the chain is the reverse of chronological, for instantaneous receipt of the next contract to be called.  Same registration times are ordered one after another in the order of addition. <br><br><h3>  Index </h3><br>  To maintain the list of registrations in the sorted order, entries must be inserted according to the date.  To speed up the search for a place to insert a new value, a tree-based index was developed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c0/946/dc0/7c0946dc004c4be2484fc721ade4ff43.png" alt="Tree"><br><br>  With this approach, the search for elements in the tree gives a constant value of complexity that does not depend on the number of elements in Devere <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.66ex" viewBox="0 -832 2043 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-31" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/348284/&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhjqSxakZd5Liru-ckjx8F7NFRUrA#MJMAIN-29" x="1653" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-5"> O (1) </script>  .  There is a worst-case scenario, which in the current implementation is <b>168</b> iterations.  The balance of the tree can be selected by changing the number of levels and multipliers. <br><br>  The last level, similar to the previous one, contains the values ‚Äã‚Äãof the maximum and minimum time stamp. <br><br><h3>  Placement and components </h3><br>  The code of contracts in the blockchain is not changeable.  And in the event of changes, you must post a new version of the contract.  At the same time from the old version you need to transfer data (state).  This may not always be easy to do, since the state of the contact is not accessible from the outside.  And if the contract does not initially have functions to access the state, then the transfer will be virtually impossible.  Similar to the state, it is impossible to transfer funds from a contract without functions previously prepared for this. <br><br>  To solve these problems, the <b>Joule</b> contract is divided into several separate contracts: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd3/091/b0a/cd3091b0a9411bdb0d8c8c45de634b75.png" alt="Structure"><br><br>  The <b>Joule</b> Ecosystem consists of the following contracts: <br><br><ul><li>  <b>Joule</b> - a contract that implements the key logic of registering and invoking contracts </li><li>  <b>Proxy</b> - a contract with a front controller function, to access <b>Joule</b> features.  <b>Proxy</b> accepts registrations, calls, and calls to registered contracts originate from its address.  Any interaction with <b>Joule</b> by users (regardless of the role of the user) occurs through a <b>proxy</b> . </li><li>  <b>Vault</b> - a vault of funds to compensate for calls. </li><li>  <b>Register</b> - a contract that stores a chain of records with registrations. </li><li>  <b>Index</b> is a contract for quickly finding a place in the register for inserting a new contract. </li><li>  <b>State</b> - a contract that implements the basic functions of storage.  Used by the <b>Index</b> and <b>Register</b> contracts. </li></ul><br>  This architecture allows you to change the logic of <b>Joule</b> without losing data.  No need to transfer or copy data.  No need to make mechanisms for transferring funds (which may be vulnerable to hacker attacks). <br><br>  Using the <b>proxy</b> contract simplifies integration with the <b>Joule</b> system for external developers.  They do not need to change the address of the contract if changes occur in <b>Joule</b> .  It will simplify the check in the registered contracts that the call comes from <b>Joule</b> . <br><br><h2>  Using </h2><br>  In this part we describe how you can use the resulting system. <br><br><h3>  Mining </h3><br>  Any user on the network who has an address and enough funds to make a call can multiply their funds with the help of <b>Joule</b> . <br><br>  To do this, it is sufficient at the right time to make a transaction with a call to <b>Joule</b> (method <b>invoke</b> or <b>invokeOnce</b> ).  During the transaction, <b>Joule will</b> transfer to the caller the reward that was reserved during the registration of the contract. <br><br>  The moment you should make a call can be easily determined using the <b>getTop</b> method.  This method returns the current status of the queue in <b>Joule</b> : the time of the nearest call, the minimum gas, the amount of remuneration for each contract and other values. <br><br>  The gas size for the transaction that the miner indicates should be no less than the value specified in the <b>invokeGas</b> field for the nearest contract.  Gas can be assigned with a reserve - unused gas will be returned back (funds for it will not be written off).  There are cases that there are several contracts ready to be called up for execution.  In this case, it is better to put gas equal to the amount of gas of all contracts.  Then (in the case of the <b>invoke</b> method) several contracts will be called up by one transaction, and the miner will receive a reward for each. <br><br>  When registering a contract, the developer sets the estimated value of the cost of gas (but not less than the value specified at least).  To call a miner must pick up such a value of gas that his transaction was faster than others (if any), but was not more expensive than the amount of remuneration.  The value of the gas cost and the amount of remuneration can be found using the <b>getTop</b> method. <br><br>  In case of a successful call, <b>Joule</b> publishes the <b>Invoked</b> event, by which you can find all your successful calls and find out the exact amount of the reward. <br><br><h3>  Register your contracts </h3><br>  If for some purposes there is a need to get a call to the contract at the appointed time - then the best solution to this problem is <b>Joule</b> . <br><br>  To register a call for a contract for a specific time, you must call the <b>register</b> method with the following parameters: <br><br><ul><li>  <b>Address</b> - the address of the contract to be called. </li><li>  <b>Timestamp</b> - the time in the unix timestamp format at which the call should be made.  It is important to understand that <b>Joule</b> guarantees only that the call will not be made earlier than this moment. </li><li>  <b>GasLimit</b> - the maximum gas value that will be provided for the call.  It is better to specify the value with a margin so that the situation does not arise, that the call to the contract will end in error due to a gas shortage. </li><li>  <b>GasPrice</b> - the estimated cost of gas to call the contract. </li></ul><br>  It is necessary to transfer the sum in the air for the remuneration for the call together with the <b>register</b> call.  The exact amount of the sum can be <b>obtained</b> using the <b>getPrice</b> method.  In case an excess amount is transferred, the balance will be returned to the caller. <br><br>  The contract must implement the <b>check</b> method.  If early calls can violate the logic of the contract or create a vulnerability, then you should add a check that the call was from <b>Joule</b> .  If the contract is already in the network, and there is no possibility to add the <b>check</b> method to it, then you can use the intermediary contract that implements the desired method and invokes the target contract.  Then when registering at <b>Joule, you</b> must specify the address of the contract of intermediary. <br><br>  In case of successful registration, <b>Joule</b> publishes the <b>Registered</b> event, with which you can see all your registrations. <br><br>  Both types of interaction can be implemented directly by working with a contract through an <b>Ethereum</b> network client, for example, <b>Parity</b> or <b>Geth (Mist)</b> . <br><br>  Also, for convenience, <b>Joule</b> has a web interface that allows you to make a call or register your contract using only a browser with an extension installed in it, such as <b>Metamask</b> or without an extension at all, for example, through <b>MEW</b> . <br><br><h2>  Conclusion </h2><br>  The result is a solution that allows you to bypass the platform restriction of smart contracts - to call the contract at the appointed time without the direct participation of the user. <br><br>  <b>Joule</b> code is available on <a href="https://github.com/MyWishPlatform/joule">github</a> . </div><p>Source: <a href="https://habr.com/ru/post/348284/">https://habr.com/ru/post/348284/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348272/index.html">The sum of the sums of arithmetic progressions</a></li>
<li><a href="../348276/index.html">Richard Hamming: Chapter 14. Digital Filters - 1</a></li>
<li><a href="../348278/index.html">The digest of fresh materials from the world of the frontend for the last week No. 300 (January 29 - February 4, 2018)</a></li>
<li><a href="../348280/index.html">Writing DNS proxy on Go</a></li>
<li><a href="../348282/index.html">Implicitness</a></li>
<li><a href="../348286/index.html">SOLID</a></li>
<li><a href="../348288/index.html">Announcement of Moscow Kubernetes Online: we have collected the pitfalls of k8s</a></li>
<li><a href="../348290/index.html">Timlides does not happen much</a></li>
<li><a href="../348294/index.html">Mobile devices from the inside. Study of tablet loading modes YB1-X90L</a></li>
<li><a href="../348298/index.html">Ternary operators and logical ‚ÄúAnd‚Äù in React.js</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>