<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking the Haiku operating system (BeOS family) with PVS-Studio. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Operating systems are one of the most complex and large projects in the software world, and therefore ideal for demonstrating the use of static code a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking the Haiku operating system (BeOS family) with PVS-Studio. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/6d4/8ad/3e0/6d48ad3e0aed4bf7ae5e892107787576.png" align="left"><br><br>  Operating systems are one of the most complex and large projects in the software world, and therefore ideal for demonstrating the use of static code analysis techniques.  After checking the Linux Kernel, I was inspired to analyze other open source operating systems. <br><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1530">Haiku</a> is a free operating system for personal computers that is aimed at binary compatibility with the BeOS operating system.  Haiku embodies the basic ideas of BeOS.  This is a modular system, architecturally designed as a hybrid core: a microkernel architecture that can dynamically load the necessary modules. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The project for verification was proposed by a user familiar with the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> product and our work on verifying open-source projects.  After a relatively recent <a href="http://www.viva64.com/ru/b/0299/">verification of the Linux Kernel</a> , I guessed what problems I would have to face and described them in a response letter.  Unexpectedly, I was offered assistance in building the operating system and integrating the analyzer.  Additionally, very extensive documentation was available on the official website and I decided to try it. <br><br>  After a while, I received a long-awaited analyzer check log and after analyzing the results, I decided to write two articles describing the most suspicious parts of the code in my opinion.  This is the first part. <br><a name="habracut"></a><br><h2>  Test results </h2><br>  In the first article, I issued warnings to the analyzer on conditional statements.  After all, an error in the condition can be interpreted as an error in the logic of program execution. <br><br><h3>  Warnings # 1, # 2: </h3><br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical to the operator of the operator: lJack-&gt; m_jackType &lt;lJack-&gt; m_jackType MediaJack.cpp 783 <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">CORTEX_NAMESPACE__ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compareTypeAndID</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> retValue = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lJack &amp;&amp; rJack) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lJack-&gt;m_jackType &lt; lJack-&gt;m_jackType) <span class="hljs-comment"><span class="hljs-comment">//&lt;== { return -1; } if (lJack-&gt;m_jackType == lJack-&gt;m_jackType) //&lt;== { if (lJack-&gt;m_index &lt; rJack-&gt;m_index) { return -1; } else { return 1; } } else if (lJack-&gt;m_jackType &gt; rJack-&gt;m_jackType) { retValue = 1; } } return retValue; }</span></span></code> </pre> <br>  The analyzer issued two warnings for this function.  In both cases, a typo is clearly noticeable (when the analyzer is already ‚Äúpoked a finger‚Äù, of course) in the names lJack and rjack. <br><br>  <a href="http://www.viva64.com/ru/d/0175/">V575</a> The 'strchr' function processes value '2112800'.  Inspect the second argument.  CommandActuators.cpp 1517 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strchr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> character)</span></span></span></span>; SendMessageCommandActuator:: SendMessageCommandActuator(int32 argc, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>** argv) : CommandActuator(argc, argv), fSignature((argc &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) ? argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] : <span class="hljs-string"><span class="hljs-string">""</span></span>) { .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* arg = argv[i]; <span class="hljs-function"><span class="hljs-function">BString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">argString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(arg)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* equals = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(arg, <span class="hljs-string"><span class="hljs-string">' = '</span></span>); <span class="hljs-comment"><span class="hljs-comment">//&lt;== .... }</span></span></code> </pre> <br>  The strchr () function returns a pointer to the first occurrence of the specified character in the specified string.  The character is converted to an int, in this case, '=' will be represented as the number 2112800. Most likely, they wanted to search for a single '=' character, and its code will be 61. <br><br>  If you wanted to find the substring "=", then the wrong function is clearly used and it should be replaced with the call to strstr (). <br><br><h3>  Warnings # 3, # 4: </h3><br>  <a href="http://www.viva64.com/ru/d/0091/">V502</a> Perhaps the '?:' Operator was different.  The '?:' Operator has a lower limit than the '-' operator.  AbstractLayout.cpp 244 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsVisible</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ancestorsVisible)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ int16 showLevel = BView::Private(view).ShowLevel(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (showLevel - (ancestorsVisible) ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Unfortunately, in this case, parenthesis of the variable 'ancestorsVisible' does not affect the order of calculations in this expression.  Therefore, the first in priority will be the operation of subtraction (bool is subtracted from int16), only then the ternary operator '?:' Is executed. <br><br>  The correct code is: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsVisible</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ancestorsVisible)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ int16 showLevel = BView::Private(view).ShowLevel(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (showLevel - (ancestorsVisible ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>) ) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0091/">V502</a> Perhaps the '?:' Operator was different.  The '?:' Operator has a operator.  fnmatch.c 58 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FOLD(c) \ ((flags &amp; FNM_CASEFOLD) &amp;&amp; ISUPPER ((unsigned char) (c)) \ ? tolower ((unsigned char) (c)) \ : (c))</span></span></code> </pre> <br>  I also advise authors to check the order of operations in this macro and place brackets for clarity. <br><br><h3>  Warnings # 5, # 6 </h3><br>  <a href="http://www.viva64.com/ru/d/0155/">V562</a> It's odd to compare 0 or 1 with a value of 0. cmp.c 300 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> same_file # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> same_file(s, t) \ ((((s)-&gt;st_ino == (t)-&gt;st_ino) \ &amp;&amp; ((s)-&gt;st_dev == (t)-&gt;st_dev)) \ || same_special_file (s, t)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> int main (int argc, char **argv) { .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (0 &lt; same_file (&amp;stat_buf[0], &amp;stat_buf[1]) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//&lt;== &amp;&amp; same_file_attributes (&amp;stat_buf[0], &amp;stat_buf[1]) &amp;&amp; file_position (0) == file_position (1)) return EXIT_SUCCESS; .... }</span></span></span></span></code> </pre> <br>  At first glance, the usual condition, but ‚Äúsame_file‚Äù is a macro that converts to a logical expression, like 'same_file_attributes', in the end got a strange comparison of ‚Äú0 &lt;value_of_boolean_type‚Äù.  There is no 'bool' type in C language.  The expression on the right will be of type 'int', but in its essence it is always ‚Äútrue‚Äù or ‚Äúfalse‚Äù, so we called it 'boolean'.  And the comparison ‚Äú0 &lt;boolean_expr‚Äù is quite suspicious. <br><br>  Similar use of macro: <ul><li>  V562 It's odd to compare 0 or 1 with a value of 0. cmp.c 313 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0155/">V562</a> It's a <a href="http://www.viva64.com/ru/d/0155/">bit of</a> a value type 18: 0x12 == IsProfessionalSpdif ().  CEchoGals_mixer.cpp 533 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ECHOSTATUS_DSP_DEAD 0x12 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//&lt;== virtual BOOL IsProfessionalSpdif() //&lt;== { .... return( (....) ? TRUE : FALSE ); } ECHOSTATUS CEchoGals::ProcessMixerFunction ( PMIXER_FUNCTION pMixerFunction, INT32 &amp; iRtnDataSz ) { .... case MXF_GET_PROF_SPDIF : if ( ECHOSTATUS_DSP_DEAD == IsProfessionalSpdif() ) //&lt;== { Status = ECHOSTATUS_DSP_DEAD; } else { pMixerFunction-&gt;Data.bProfSpdif = IsProfessionalSpdif(); } .... }</span></span></span></span></code> </pre> <br>  Another incorrect comparison with the use of macros.  The IsProfessionalSpdif () function returns TRUE or FALSE, and we compare the return result with the number 0x12. <br><br><h3>  Warnings # 7, # 8 </h3><br>  <a href="http://www.viva64.com/ru/d/0186/">V583</a> The '?:' Operator, regardless of its conditional expression, always returns one and the same value.  impactv.c 520 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Radeon_CalcImpacTVRegisters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... values-&gt;tv_hstart = internal_encoder ? values-&gt;tv_hdisp + <span class="hljs-number"><span class="hljs-number">1</span></span> - params-&gt;mode888 + <span class="hljs-number"><span class="hljs-number">12</span></span> : values-&gt;tv_hdisp + <span class="hljs-number"><span class="hljs-number">1</span></span> - params-&gt;mode888 + <span class="hljs-number"><span class="hljs-number">12</span></span>; .... }</code> </pre> <br>  Regardless of the value of the variable 'internal_encoder', the ternary operator returns the same values.  You must check this place for typos. <br><br>  <a href="http://www.viva64.com/ru/d/0112/">V523</a> The 'then' statement is equivalent to the 'else' statement.  mkntfs.c 1132 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insert_positioned_attr_in_mft_record</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flags &amp; ATTR_COMPRESSION_MASK) { hdr_size = <span class="hljs-number"><span class="hljs-number">72</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">FIXME:</span></span></span><span class="hljs-comment"> This compression stuff is all wrong. .... */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* now. (AIA) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val_len) mpa_size = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* get_size_for_compressed_....; */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> mpa_size = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { .... } .... }</code> </pre> <br>  The analyzer reminds that it is necessary to ‚Äúfix‚Äù the deferred places. <br><br>  Another place: <ul><li>  V523 The 'then' statement is equivalent to the 'else' statement.  mkntfs.c 1334 </li></ul><br><h3>  Warnings # 9, # 10 </h3><br>  <a href="http://www.viva64.com/ru/d/0092/">V503</a> This is a nonsensical comparison: pointer &lt;= 0. Header.cpp 900 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strstr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *searchString)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TTextControl::MessageReceived(BMessage *msg) { .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (node.GetNextAttrName(buffer) == B_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"email"</span></span>) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; .... }</code> </pre> <br>  The strstr () function returns a pointer to the first occurrence of the string ‚Äúemail‚Äù in the string 'buffer', if no such match is found, then NULL is returned.  Therefore, in this case it is necessary to compare with NULL. <br><br>  Possible Solution: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TTextControl::MessageReceived(BMessage *msg) { .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (node.GetNextAttrName(buffer) == B_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"email"</span></span>) == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0101/">V512</a> A call to the memcmp of the function will be "Private-key-format: v".  dst_api.c 858 <br><pre> <code class="cpp hljs">dst_s_read_private_key_file(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span>(in_buff, <span class="hljs-string"><span class="hljs-string">"Private-key-format: v"</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> fail; .... }</code> </pre> <br>  The length of the compared string does not match the specified number of compared characters.  The string "Private-key-format: v" is 21 characters. <br><br><h3>  Warnings # 11, # 12 </h3><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression '* r &amp;&amp; * r ==' '&amp;&amp; * r ==' \ t '' is always false.  Probably the '||'  operator should be used here.  selection.c 546 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">selection_rel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *r, *rname; .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (*r &amp;&amp; *r == <span class="hljs-string"><span class="hljs-string">' '</span></span> &amp;&amp; *r == <span class="hljs-string"><span class="hljs-string">'\t'</span></span>) r++; .... }</code> </pre> <br>  Most likely there is an error.  In the cycle we wanted to skip all the spaces and tabs, but one character can not be both at the same time. <br><br>  Possible correct option: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">selection_rel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *r, *rname; .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (*r == <span class="hljs-string"><span class="hljs-string">' '</span></span> || *r == <span class="hljs-string"><span class="hljs-string">'\t'</span></span>) r++; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0194/">V590</a> Consider inspecting the 'path [i] ==' / '&amp;&amp; path [i]! =' \ 0 '' expression.  The expression is misprint.  storage_support.cpp 309 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> parse_first_path_component(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *path, int32&amp; length, int32&amp; nextComponent) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; path[i] == <span class="hljs-string"><span class="hljs-string">'/'</span></span> &amp;&amp; path[i] != <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; i++); <span class="hljs-comment"><span class="hljs-comment">//&lt;== if (path[i] == '\0') // this covers "" as well nextComponent = 0; else nextComponent = i; .... }</span></span></code> </pre> <br>  Everything is fine here, but one check is superfluous and should be removed.  To save the logic of work, it is enough to leave: "for (; path [i] == '/'; i ++);". <br><br>  Similar places: <ul><li>  V590 Consider inspecting this expression.  The expression is misprint.  PoseView.cpp 5773 </li><li>  V590 Consider inspecting this expression.  The expression is misprint.  Tracker.cpp 1728 </li><li>  V590 Consider inspecting the '* ptr =='; '  &amp;&amp; * ptr! = '\ 0' 'expression.  The expression is misprint.  pc.c 316 </li></ul><br><h3>  Warning # 13, # 14 </h3><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  StatusView.cpp 1397 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TDragRegion::Draw(BRect) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fDragLocation != kDontDrawDragRegion || fDragLocation != kNoDragRegion) DrawDragRegion(); }</code> </pre> <br>  In this function, something is always drawn.  If you build a truth table of a logical expression in a condition, you can make sure that it is always true.  Perhaps there should be an '&amp;&amp;' operator. <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'reservedBase &lt;0' is always false.  Unsigned type value is never &lt;0. agp_gart.cpp 1172 <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* address types */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__haiku_addr_t</span></span>; <span class="hljs-comment"><span class="hljs-comment">//&lt;== typedef __haiku_addr_t addr_t; //&lt;== static status_t bind_aperture(...., addr_t reservedBase, ....) { .... if (status &lt; B_OK) { if (reservedBase &lt; 0) //&lt;== aperture-&gt;DeleteMemory(memory); return status; } .... }</span></span></code> </pre> <br>  In such a comparison with an unsigned type, the condition is always false and somewhere the memory is not cleared.  Unfortunately, such checks involving unsigned types in the code are <b>about two hundred</b> .  To describe in the article all such comparisons, or at least part of it makes no sense.  They are all of the same type and uninteresting.  However, we will provide developers with a full report and they will be able to analyze all such suspicious places. <br><br><h3>  Warnings # 15, # 16 </h3><br>  <a href="http://www.viva64.com/ru/d/0354/">V713</a> The pointer was used in the same logical expression.  util.c 311 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bittok2str</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">register</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> struct tok *lp, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (lp-&gt;s != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> &amp;&amp; lp != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { .... } .... }</code> </pre> <br>  The loop condition is confused with a pointer test sequence.  In the beginning it is dereferenced, and only then it is checked for equality to zero.  The correct option is: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (lp != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> &amp;&amp; lp-&gt;s != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) {</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0197/">V593</a> Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  VideoProducer.cpp 766 <br><pre> <code class="cpp hljs">int32 VideoProducer::_FrameGeneratorThread() { .... err = B_OK; <span class="hljs-comment"><span class="hljs-comment">// Send the buffer on down to the consumer if (wasCached || (err = SendBuffer(buffer, fOutput.source, fOutput.destination) != B_OK)) { .... } .... }</span></span></code> </pre> <br>  The analyzer detected a potential error in the expression, which most likely does not work as the programmer intended.  It was planned to perform the assignment ‚Äúerr = SendBuffer ()‚Äù and compare the result with the constant 'B_OK', but the priority of the operator '! =' Is higher than that of the = =, therefore the result of the logical operation is written to the variable 'err'. <br><br>  Similar places: <ul><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  if_age.c 590 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  if_alc.c 954 </li><li>  V593 Consider reviewing the A = B&gt; = C 'kind.  The expression is calculated as the following: 'A = (B&gt; = ‚Äã‚ÄãC)'.  RAW.cpp 2601 </li></ul><br><h3>  Warnings # 17, # 18 </h3><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'nogscale&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. tvp3026.c 212 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> mil2_dac_init (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { uint32 rfhcnt, nogscale, memconfig; .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (nogscale = <span class="hljs-number"><span class="hljs-number">1</span></span>; nogscale &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; nogscale--) { <span class="hljs-comment"><span class="hljs-comment">//&lt;== int max = -1 + 33.2 * mclk / (nogscale? 1: 4); for (rfhcnt = 15; rfhcnt &gt; 0; rfhcnt--) { int value = (rfhcnt &amp; 0x0e) * 256 + (rfhcnt &amp; 0x01) * 64; LOG(2,("mil2_dac_init factor %d, rfhcnt %2d: %d ?&lt;= %d\n", nogscale, rfhcnt, value, max)); if (value &lt;= max) goto rfhcnt_found; } } .... }</span></span></code> </pre> <br>  Most likely due to the transition operator 'goto' they never noticed that one of the cycles is ‚Äúeternal‚Äù, since  when checking ‚Äúnogscale&gt; = 0‚Äù, the decrement of an unsigned variable can be made infinitely. <br><br>  <a href="http://www.viva64.com/ru/d/0238/">V621</a> Consider inspecting the 'for' operator.  It is possible that you will not be executed at all.  if_ae.c 1670 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AE_IDLE_TIMEOUT 100 static void ae_stop_rxmac(ae_softc_t *sc) { .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* * Wait for IDLE state. */</span></span></span><span class="hljs-meta"> for (i = 0; i &lt; AE_IDLE_TIMEOUT; i--) { val = AE_READ_4(sc, AE_IDLE_REG); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((val &amp; (AE_IDLE_RXMAC | AE_IDLE_DMAWRITE)) == 0) break; DELAY(100); } .... }</span></span></code> </pre> <br>  For some reason, the value of the counter in this loop changes in the wrong direction, it is more logical to increment the variable 'i' so that the wait lasts a maximum of 100 iterations, rather than millions of times more. <br><br>  Similar place: <ul><li>  V621 Consider inspecting the 'for' operator.  It is possible that you will not be executed at all.  if_ae.c 1706 </li></ul><br><h3>  Warning # 19, # 20 </h3><br>  <a href="http://www.viva64.com/ru/d/0265/">V646</a> Consider inspecting the application's logic.  It's possible that 'else' keyword is missing.  Filter.cpp 760 <br><pre> <code class="cpp hljs">uchar Scaler::Limit(intType value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { value = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value &gt; <span class="hljs-number"><span class="hljs-number">255</span></span>) { value = <span class="hljs-number"><span class="hljs-number">255</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; }</code> </pre> <br>  There is no serious error in this function, but the code is poorly designed.  You must add the keyword 'else', or place the conditions on the same level. <br><br>  <a href="http://www.viva64.com/ru/d/0258/">V640</a> The code's operational logic does not correspond with its formatting.  The second statement will always be executed.  It is possible that curly brackets are missing.  strftime.c 1263 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DO_NUMBER(d, v) \ digits = width == -1 ? d : width; \ number_value = v; goto do_number size_t my_strftime (s, maxsize, format, tp extra_args) { .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (modifier == L_(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'O'</span></span></span><span class="hljs-meta">)) goto bad_format; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> DO_NUMBER (1, tp-&gt;tm_year + TM_YEAR_BASE); .... }</span></span></code> </pre> <br>  Macros and so deliver inconvenience when debugging, so also are the source of such errors: the macro 'DO_NUMBER' is expanded into several lines, but only the first one will be part of the conditional statement, the subsequent statements will be executed regardless of the condition. <br><br>  Similarly, a wrong macro is used here: <ul><li>  V640 The code's operational logic does not correspond with its formatting.  The second statement will always be executed.  It is possible that curly brackets are missing.  strftime.c 1267 </li></ul><br><h2>  Conclusion </h2><br>  Thanks to the help of interested people in setting up the assembly of the operating system and integrating the analyzer, we were able to quickly prepare everything for verification.  In fact, this is an ideal scenario for checking open-source projects, because you often have to deal with completely unfamiliar projects and, often, with your own build systems. <br><br>  The next article will present the remaining analyzer warnings, which I would like to talk about.  They will be of different types and divided into several groups. <br><br><h2>  This article is in English. </h2><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov.  <a href="http://www.viva64.com/en/b/0317/">Analysis of Haiku Operating System (BeOS Family) by PVS-Studio.</a>  <a href="http://www.viva64.com/en/b/0317/">Part 1</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio and CppCat, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/256347/">https://habr.com/ru/post/256347/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256331/index.html">Temporal relativistic ontological space</a></li>
<li><a href="../256333/index.html">The program of practical training in the field of information security: "Zero Security: A"</a></li>
<li><a href="../256337/index.html">Services on the conveyor. How is the information infrastructure of WebCanape?</a></li>
<li><a href="../256339/index.html">Doing yourself to open it up, or the Right to pre-edit</a></li>
<li><a href="../256345/index.html">Control robots created with LEGO¬Æ Mindstorms¬Æ NXT Brick using the Wolfram Language (Mathematica)</a></li>
<li><a href="../256349/index.html">GSM module control with AVR</a></li>
<li><a href="../256351/index.html">Say a word about poor recursion, or all that you did not know and do not want to know about it</a></li>
<li><a href="../256353/index.html">Using the driver keys of the lower and upper levels of the IR2110 - an explanation and examples of schemes</a></li>
<li><a href="../256355/index.html">godebug - cross-platform debugger for Go</a></li>
<li><a href="../256357/index.html">IT resources under control</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>