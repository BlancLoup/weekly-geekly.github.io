<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search Preview - Chrome extension</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About expansion 
 This extension provides the ability to view the search result site in Google, which significantly reduces the time for searching and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search Preview - Chrome extension</h1><div class="post__text post__text-html js-mediator-article"><h4>  About expansion </h4><br>  This extension provides the ability to view the search result site in Google, which significantly reduces the time for searching and processing information. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fe3/94c/c3e/fe394cc3ea8e5c49aa475a7c622ccc5d.png" alt="image"><br><br><h4>  Prehistory </h4><br>  After Google closed the project of Instant Preview, the search for the necessary information began to take much more time, open tabs and nerves. <br>  After that, I decided to correct this situation and write a small extension to make my life easier. <br><a name="habracut"></a><br><h4>  Development </h4><br>  Due to the fact that Google Chrome supported HTML5 technology (namely, iframe sandbox), it was easy to implement the extension and a prototype was written in one evening.  I was undoubtedly happy about it, but it was sad for other people who were also victims of the Instant Preview closure.  Therefore, I decided to put the extension in open access. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The extension itself was based on the ability to load into any iframe any page while the sandbox attribute allowed to disable javascript and the redirect of the main window i.e.  it was impossible to execute such code from an iframe: <br><br><pre><code class="javascript hljs">top.location = <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">redirect_url</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">;</span></span></code> </pre> <br><br>  And everything was fine until on some sites the title of the prohibition to display in the iframe ‚ÄúX-Frame-Options‚Äù was encountered, it was still half the trouble, but when Google Chrome in the new version forbade downloading unprotected content on a secure site, i.e.  it was impossible to implement on the site https data including iframe http.  As a result, most of the sites did not appear in the iframe.  Users began to complain, the extension was not able to cope with their task, again they had to go straight to the site from the search results, everything was back to the beginning. <br><br><h5>  Finding a solution </h5><br>  But this did not stop me, it was interesting to solve this problem.  The first thing that came to mind was using a web proxy, i.e.  in the iframe, to download data not directly from the site, but through the web proxy using the secure https protocol, thereby solving the problem with unprotected content, and also the web proxy could cut off the X-Frame-Options header. <br><br>  I didn‚Äôt want to waste time on developing my own web proxy, the task needs to be solved quickly.  A little googling I came across this <a href="https://github.com/labnol/google-proxy">google-proxy</a> script - this is the web proxy for appengine written in python.  Having installed it and rolling out the new version of the extension, I did not forget about the problem for a long time.  But the problem came again in the form of a shortage of the free quota of appengine, I had to make several mirrors for the web proxy.  Having made four mirrors, it seemed that everything was fine, but in an expansion review they wrote to me that the quota shortage error again appears.  In appengine, the quota is reset every 24 hours, i.e.  at the time when I use the quota extension, there is still enough, but for the residents of the other edge of the world the quota is already exhausted. <br><br><h5>  Own web proxy </h5><br>  A little thought, I decided all the same to spend time writing a web proxy and chose the language Go.  It took a little time to master the Go language, since  before that I wrote small scripts on it for educational purposes.  But with the development of a web server on Go did not come across.  <a href="http://www.gorillatoolkit.org/">After reading the</a> documentation and choosing <a href="http://www.gorillatoolkit.org/">gorillatoolkit</a> as a web tool, namely the gorilla / mux router.  Writing a router is pretty easy: <br><br><pre> <code class="go hljs">r := mux.NewRouter() r.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/env"</span></span>, environ) r.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/web_proxy"</span></span>, web_proxy.WebProxyHandler) r.PathPrefix(<span class="hljs-string"><span class="hljs-string">"/"</span></span>).Handler(http.StripPrefix(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, http.FileServer(http.Dir(staticDir)))) r.Methods(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>)</code> </pre><br><br>  Next, to replace links and addresses, cleaning html chose the <a href="https://github.com/moovweb/gokogiri">gokogiri</a> library this is a wrapper for libxml.  It was necessary to zaryutit all addresses (url) on my web proxy script.  Then I turned off some tags by completely removing them from the DOM, including the script tag.  Interactive site preview is not needed.  CSS was also processed, because  there are url images, fonts, etc. <br><br>  It turns out this mapping tags when traversing the DOM function is called corresponding to the tag. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( nodeElements = <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*context, xml.Node)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">// proxy URL "a": proxyURL("href"), "img": proxyURL("src"), "link": proxyURL("href"), "iframe": proxyURL("src"), // normalize URL "object": normalizeURL("src"), "embed": normalizeURL("src"), "audio": normalizeURL("src"), "video": normalizeURL("src"), // remove Node "script": removeNode, "base": removeNode, // style css "style": proxyCSSURL, } xpathElements string = createXPath() includeScripts = []string{ "/js/analytics.js", } cssURLPattern = regexp.MustCompile(`url\s*\(\s*(?:["']?)([^\)]+?)(?:["']?)\s*\)`) )</span></span></code> </pre><br><br>  Html filtering <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filterHTML</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *WebTransport, body, encoding []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, baseURL *url.URL)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> encoding == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { encoding = html.DefaultEncodingBytes } doc, err := html.Parse(body, encoding, []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(baseURL.String()), html.DefaultParseOption, encoding) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">""</span></span>), err } <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> doc.Free() c := &amp;context{t: t, baseURL: baseURL} nodes, err := doc.Root().Search(xpathElements) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, node := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span>(nodes) { name := strings.ToLower(node.Name()) nodeElements[name](c, node) } } <span class="hljs-comment"><span class="hljs-comment">// add scripts addScripts(doc) return []byte(doc.String()), nil }</span></span></code> </pre><br><br>  CSS filtering: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filterCSS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *WebTransport, body, encoding []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, baseURL *url.URL)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { cssReplaceURL := <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> []</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">byte</span></span></span></span> { cssURL := <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(cssURLPattern.FindSubmatch(m)[<span class="hljs-number"><span class="hljs-number">1</span></span>]) srcURL, err := replaceURL(t, baseURL, cssURL) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">"url("</span></span> + srcURL.String() + <span class="hljs-string"><span class="hljs-string">")"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cssURLPattern.ReplaceAllFunc(body, cssReplaceURL), <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre><br><br>  The cookie, the X-Frame-Options header, and the cache for 24 hours were also filtered out. <br>  Web proxy, it was decided to install on heroku, was also thinking about openshift, but as far as I know there is a limit on the number of connections. <br><br>  The decision on heroku + Go completely suited me and there are no problems with quotas no one complains (compared to appengine), since March, as they say, normal flight. <br><br><h5>  Expansion </h5><br>  The extension works well, added zoom buttons.  With the zoom, there was still that story, immediately followed the wrong path and applied the CSS transform scale to the iframe, it was necessary every time the zoom or the main window changes, to calculate the size of the iframe for a new one.  But then a rather simple solution was encountered: <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">zoom</span></span>: &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">zoom</span></span>&gt;%;</code> </pre><br><br>  This zoom applies to the web proxy page to document.documentElement.  But I didn‚Äôt stop there, I didn‚Äôt have enough highlighting in the preview of what I was looking for.  The algorithm for highlighting keywords was chosen simple - search for a string in a substring.  This worked well for simple cases, but when the text contains words with different endings, the search did not work or, even worse, the short substrings were found in the wrong words, you know how this search works. <br><br><h6>  Fulltext search backlight </h6><br>  The solution was found in the form of Porter's stemmer, namely, its implementation in the form of a <a href="https://github.com/fortnightlabs/snowball-js">snowball</a> , the <a href="https://github.com/slevithan/xregexp/">xregexp</a> library and the Unicode addon were also used to create a token that was passed to the stemmer.  I did not write an algorithm for determining the language for a stemmer, but applied a stemmer for different languages ‚Äã‚Äãto the token and, if successful, the stemmer returned true. <br><br><h5>  Instruments </h5><br>  As a language, I chose coffeescript, I like it like a python, but there are some shortcomings.  Gulp is responsible for building the dev and production versions.  Very simple collector, a large number of plugins.  Not a small part of the time I spent on studying and finishing gulpfile.coffee, but this is justified by the speed of assembly.  Also involved in the assembly is browserify. <br><br>  PS oh yes!  I almost forgot about the link to the <a href="https://chrome.google.com/webstore/detail/search-preview/majhgbekihmliceijipbdccgicepmmei">extension</a> . <br><br>  Questions, suggestions? </div><p>Source: <a href="https://habr.com/ru/post/229909/">https://habr.com/ru/post/229909/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229895/index.html">Synthesis of optimal facial recognition algorithm</a></li>
<li><a href="../229899/index.html">Copyright maze generated?</a></li>
<li><a href="../229901/index.html">Hayload in the cloud on a live example</a></li>
<li><a href="../229903/index.html">SharePoint Farm - a new feature in Microsoft Azure</a></li>
<li><a href="../229905/index.html">Make the simplest filter by product properties using ElasticSearch on Symfony2</a></li>
<li><a href="../229911/index.html">How to create a legend</a></li>
<li><a href="../229917/index.html">We program for iPhone and iPad. 3rd ed</a></li>
<li><a href="../229919/index.html">Assessment of renewable energy potential. Regional experience</a></li>
<li><a href="../229921/index.html">Using the principles of psychology to increase the conversion of sites. Part 1: Gestalt psychology, the law of brevity</a></li>
<li><a href="../229923/index.html">Open Interconnect Consortium - the new driving force of the ‚ÄúInternet of Things‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>