<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NGINX - The story of rebirth under Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since here we have a ‚Äúweek‚Äù of nginx, for example, here or here , then I will try and make my own, so to speak, contribution. It will be about nginx 4...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NGINX - The story of rebirth under Windows</h1><div class="post__text post__text-html js-mediator-article">  Since here we have a ‚Äúweek‚Äù of nginx, for example, <a href="http://habrahabr.ru/post/260065/">here</a> or <a href="http://habrahabr.ru/post/259403/">here</a> , then I will try and make my own, so to speak, contribution.  It will be about nginx 4 windows, namely, more or less official build for this apritritory, some not very favorite platform. <br><br>  Why windows.  It's simple, in the corporate sector of Windows on the server, and on the workstations - often an obligatory program.  And from these requirements for the platform, for example, in the ultimatum form voiced by the client, you cannot get anywhere. <br>  And since we have Windows, but I <s>don‚Äôt want to suffer from IIS, apache and others like them, if</s> you want to use your favorite tools, and nginx definitely applies to them, you sometimes have to put up with even some restrictions on this platform.  Rather had ... <br><br>  Although it should be noted that even with these restrictions, nginx will give odds to almost any web server under windows for many factors, including stability, memory consumption, and most importantly performance. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I hasten to immediately share the good news - there are practically no more restrictions that are critical to high performance, when using nginx under windows, and the last of the critical ones, with high probability, will also soon disappear.  But in order ... <br><br>  <a href="http://nginx.org/ru/docs/windows.html">Here are</a> the known problems with nginx 4 windows, namely: <br><br><ul><li>  Workflow can serve no more than 1024 simultaneous connections. </li><li>  Cache and other modules that require shared memory support do not work under Windows Vista and later versions due to the fact that address space randomization is enabled on these versions of Windows. </li><li>  Although it is possible to start several workflows, only one of them really works. </li></ul><br>  I changed the order a bit, because  It was in this sequence that I dealt with these restrictions, so to speak sorted "historically." <br><a name="habracut"></a><br><h4>  1024 simultaneous connections </h4><br>  Actually, this is not true, or rather, not quite true - since time immemorial, nginx could be built under Windows without this restriction ‚Äî it was necessary at the assembly stage to determine <code>FD_SETSIZE</code> equal to the number of connections you need. <br>  For example, for VS by adding the directive <code>--with-cc-opt=-DFD_SETSIZE=10240</code> , the nginx worker can manage 10K simultaneous connections if you specify <code>worker_connections 10240;</code> in the configuration <code>worker_connections 10240;</code>  . <br><br><h4>  Cache and other modules that require shared memory support </h4><br>  Until recently, all these functions and modules really did not work under Windows, starting with version x64 or where by default the whole system works with ASLR enabled. <br>  Moreover, disabling ASLR for nginx does not change anything, because  functions for working with shared memory are protected deep in the kernel, i.e.  ASLR (and probably DEP with it, for some reason it didn‚Äôt work with it) needs to be disabled for the entire system. <br><br>  This is actually quite a small list of functionality: Cache, any zones, respectively, limit_req, etc.  etc.  By the way, without the support of shared memory, it would be much more difficult to remove the 3rd limit, i.e.  implement support for multiple workers under windows. <br><br>  I will not bore the reader as I struggled with this, but together with Max (thanks to <a href="https://habrahabr.ru/users/mdounin/" class="user_link">mdounin</a> ) we did it to the release version.  A little about this, who are interested, see under the spoiler or in the source code <a href="http://hg.nginx.org/nginx/rev/af7eba90645d">hg.nginx.org</a> or <a href="https://github.com/sebres/nginx/commit/42e65a93b9751913247a82cd46baa177965ff36a">github</a> ... <br><div class="spoiler">  <b class="spoiler_title">A bit of theory ...</b> <div class="spoiler_text">  The shared memory itself can also be used with randomization of the address space.  It doesn‚Äôt interfere with one another, just when the ASLR is on, you are in another process almost guaranteed to get a pointer to ‚Äúthe same memory‚Äù, but under a different address.  This is not really critical, as long as the contents of this space itself does not contain direct pointers, aka pointer.  Those.  pointers offsets relative to the initial address of shmem are valid, but not direct pointers as they are. <br>  Respectively, without having to rewrite all the functionality that works with the pointer inside the shared mem in nginx, there is the only option to <s>fool</s> windows into giving the link to shmem under the constant for all workflow address.  Well, then everything is not very difficult, in fact. <br>  The beginning of the discussion about this can be read <a href="http://forum.nginx.org/read.php%3F29,258290,258290">here</a> .  Maxim, by the way, fixed the problem I had missed (remapping), sometimes arising after resetting the workers (reload on the fly). <br>  Viva open source! <br></div></div><br>  Those.  officially this restriction no longer applies with <a href="http://nginx.org/en/CHANGES">Release 1.9.0</a> dated 28 Apr 2015: <br><pre> <code class="bash hljs">Feature: shared memory can now be used on Windows versions with address space layout randomization.</code> </pre><br><h4>  Only one workflow really works. </h4><br>  In nginx there is a master process and child processes, called worker or worker. <br>  Under windows, nginx can have several worker processes running, i.e.  specifying the " <code>worker_processes 4;</code> " in the configuration, you will force the wizard to start four child worker processes.  The problem is that only one of them, ‚Äústealing‚Äù the listener connection from the wizard (using SO_REUSEADDR) will really listen to this socket, i.e.  make accept incoming connections.  As a result, the other workers - no incoming connections - no work. <br>  This limitation is related to the technical implementation of winsock, and the only way to get a distributed listener connection for all workflows in Windows is to clone a socket from the master process, i.e.  to use inherited handle from a socket from it. <br>  Who is interested in the implementation details, they can look at them under the spoiler or in the source code, so far only on my <a href="https://github.com/sebres/nginx/pull/1/files">github</a> . <br><div class="spoiler">  <b class="spoiler_title">Read more ...</b> <div class="spoiler_text">  Let's start with the fact that even if you run child processes ( <code>CreateProcess</code> ) using <code>bInheritHandle=TRUE</code> , and setting <code>SECURITY_ATTRIBUTES::bInheritHandle</code> when creating a socket is also TRUE, most likely you will fail.  in the workflow using this handle, you get "failed (10022: An invalid argument was supplied)".  While ‚Äúsuccessfully‚Äù duplicating this socket using <code>DuplicateHandle</code> , the duplicate handle will also not accept any function working with sockets (probably with error 10038 - WSAENOTSOCK). <br>  Why this happens is a little quotation from <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724251.aspx">MSDN - DuplicateHandle</a> : <br><blockquote>  Sockets.  Winsock at the target process.  Also, using DuplicateHandle interferes with internal reference counting on the underlying object.  To duplicate a socket handle, use the WSADuplicateSocket function. <br></blockquote>  The problem is that to duplicate a handle using WSADuplicateSocket, you need to know in advance the pid of the process, i.e.  this cannot be done before the process is started. <br>  As a result, to inform the child process the information received by the master from WSADuplicateSocket, which is necessary for creating a socket-clone in the workflow - we have two options, or use something of the IPC type, for example, as described in <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms741565.aspx">MSDN - WSADuplicateSocket</a> , or transmit it through shared memory (we have already repaired it above). <br>  I decided to use the second option, since  I think this is the least laborious of the two and the fastest way to implement connection inheritance. <br>  Below are the changes in the algorithm for running workflows under windows (marked with <code>*</code> ): <br><ul><li>  The master process creates all listener sockets; </li><li>  [cycle] The master process creates a workflow; </li><li>  <code>*</code> [win32] the wizard calls the new <code>ngx_share_listening_sockets</code> function: for each listener socket information is polled (for inheritance) specifically for this new worker (‚Äúcloned‚Äù via WSADuplicateSocket for pid), which will be stored in shared memory - shinfo (protocol structure); </li><li>  The master process waits for the worker to set a readiness event - the event ‚Äúworker_nnn‚Äù; </li><li>  <code>*</code> [win32] The workflow performs a new <code>ngx_get_listening_share_info</code> function to get shinfo inheritance information that will be used to create a new socket descriptor for the master's shared listener socket; </li><li>  <code>*</code> [win32] The workflow creates all listener sockets using shinfo information from the master process; </li><li>  The workflow sets the event ‚Äî event ‚Äúworker_nnn‚Äù; </li><li>  The master process stops waiting, and creates the next workflow, repeating the [cycle]. </li></ul><br>  If necessary, <a href="http://forum.nginx.org/read.php%3F29,259516,259516">here is a link</a> to the discussion about fixation so that it will be. <br></div></div><br>  As a result, nginx under windows now starts N "full-fledged", from the point of view of "listening" and, most importantly, establishing a connection, workflows that process incoming connections really parallel. <br><br>  This fix is ‚Äã‚Äãstill a ‚Äúpull request‚Äù (I sent the changeset to nginx-dev), but you can already try it, for example, by downloading it from <a href="">my github</a> and building it yourself under windows.  If they want to lay out somewhere binary. <br><br>  For a long time I tortured my hardware, driving it with tests and under load "scripts" - the result, all the workers are loaded more or less evenly and actually work in parallel.  I also tried to reboot nginx on the fly (reload) and randomly ‚Äúkill‚Äù some workers simulating the ‚Äúcrash‚Äù of the latter - everything works without the slightest criticism. <br>  While the only "flaw" manifested, IMHO - if you run <pre> <code class="bash hljs">netstat /abo | grep LISTEN</code> </pre>  then you will see only the master process in the list of "listeners", although in reality it is just that he never establishes a connection, only his child workflows. <br><br>  By the way, my experience so far says that <code>accept_mutex</code> for a windows platform probably needs to disable " <code>accept_mutex off;</code> ", since  at least on my test systems, with <code>accept_mutex</code> turned <code>accept_mutex</code> they worked significantly slower than they did with shutdown.  But I think everyone should check it experimentally (because it depends on a heap of parameters, such as the number of cores, workers, keep-alive connections, etc., etc.). <br><br>  Well, as without <s>beautiful plates with numbers of</s> performance comparison, before (the first column is marked ** NF) and after. <br>  The test is made on Windows7 - i5-2400 cpu @ 3.10GHz (4 core). <br>  Request: static, 452 bytes (+ header) - small gif-icons. <br><table><tbody><tr><th>  Workers x Concur. </th><th>  1 x 5 ** NF </th><th>  2 x 5 </th><th>  4 x 5 </th><th>  4 x 15 </th></tr><tr><td>  Transactions </td><td>  5624 hits </td><td>  11048 hits </td><td>  16319 hits </td><td>  16732 hits </td></tr><tr><td>  Availability </td><td>  100.00% </td><td>  100.00% </td><td>  100.00% </td><td>  100.00% </td></tr><tr><td>  Elapsed time </td><td>  2.97 secs </td><td>  2.97 secs </td><td>  2.97 secs </td><td>  2.96 secs </td></tr><tr><td>  Data transferred </td><td>  2.42 MB </td><td>  4.76 MB </td><td>  7.03 MB </td><td>  7.21 MB </td></tr><tr><td>  Response time </td><td>  0.00 secs </td><td>  0.00 secs </td><td>  0.00 secs </td><td>  0.00 secs </td></tr><tr><td>  Transaction rate </td><td>  1893.60 trans / sec </td><td>  3719.87 trans / sec </td><td>  5496.46 trans / sec </td><td>  5645.07 trans / sec </td></tr><tr><td>  Throughput </td><td>  0.82 MB / sec </td><td>  1.60 MB / sec </td><td>  2.37 MB / sec </td><td>  2.43 MB / sec </td></tr><tr><td>  Concurrency </td><td>  4.99 </td><td>  4.99 </td><td>  4.99 </td><td>  14.92 </td></tr><tr><td>  Successful transactions </td><td>  5624 </td><td>  11048 </td><td>  16319 </td><td>  16732 </td></tr><tr><td>  Failed transactions </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td></tr><tr><td>  Longest transaction </td><td>  0.11 </td><td>  0.11 </td><td>  0.11 </td><td>  0.11 </td></tr><tr><td>  Shortest transaction </td><td>  0.00 </td><td>  0.00 </td><td>  0.00 </td><td>  0.00 </td></tr></tbody></table><br>  And may nginx be with you and under windows. </div><p>Source: <a href="https://habr.com/ru/post/260133/">https://habr.com/ru/post/260133/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260119/index.html">Virtual Time Part 2: Simulation and Virtualization Issues</a></li>
<li><a href="../260121/index.html">The new version of the malware Duqu is used for cyber espionage</a></li>
<li><a href="../260125/index.html">Quick installation of SQL cluster of Galera MariaDB with HaProxy and ClusterControl from Severalnines</a></li>
<li><a href="../260127/index.html">Meeting in the Ministry of Finance with the developers on the subject of open data - June 16</a></li>
<li><a href="../260129/index.html">GrabDuck: integration with StackOverflow via StackExchange API</a></li>
<li><a href="../260135/index.html">Manage Azure DNS almost without PowerShell</a></li>
<li><a href="../260139/index.html">3CX Phone System v14: version for technical specialists</a></li>
<li><a href="../260141/index.html">Phalcon 2.0.3 release</a></li>
<li><a href="../260145/index.html">HL7 FHIR: Fast Healthcare Interoperability Resources</a></li>
<li><a href="../260149/index.html">How I found the best programming language in the world. Piece Yo (2.72)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>