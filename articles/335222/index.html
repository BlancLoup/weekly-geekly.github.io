<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microsoft Office Automation: Another Macro Virus Hole</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Microsoft Office software package is not only the actual standard of office software, but also a very complex and multifunctional environment that...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microsoft Office Automation: Another Macro Virus Hole</h1><div class="post__text post__text-html js-mediator-article">  The Microsoft Office software package is not only the actual standard of office software, but also a very complex and multifunctional environment that allows you to create solutions designed primarily to use the capabilities of Microsoft Office and automate routine user actions when working with documents.  This software platform, called the Microsoft Office Object Model (Microsoft Office Object Model), or Microsoft Office Automation (Microsoft Office Automation) is based on the COM Object Model and contains an extensive set of classes that provide access to virtually any element or action that is available to the user during work. with Microsoft Office through a graphical interface. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c0c/17d/e59/c0c17de596d0c9fe95f960bc38d541c8.gif" alt="image"><br>  <i><font color="#999999">Microsoft Word object model (partially)</font></i> <br><a name="habracut"></a><br>  Speaking of programming for Microsoft Office, they often mean "internal" programs - macros written in VBA (Visual Basic for Applications, the implementation of Visual Basic in Microsoft Office) and embedded in documents. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/394/ece/dc1/394ecedc121d175a686706b51ecef5c1.gif" alt="image"><br>  <i><font color="#999999">Create a macro for Microsoft Excel</font></i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Due to the wide possibilities of the language (due to access to external dll and components almost unlimited) and convenient distribution model (with document files), Microsoft Office macros have been used to create malicious software since the advent of VBA and got their own name - macro viruses.  Despite some tightening of settings related to macros (currently the current version of Microsoft Office prohibits automatic execution of macros at default settings, notifying the user of this), malicious programs are actively used by attackers even now.  To effectively use this technology with a twenty-year history, it was enough to supplement it with elements of social engineering. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/621/17b/351/62117b351618aafdebdf9057e6b3451b.png" alt="image"><br>  <i><font color="#999999">Suggesting that the user allow macros in a document containing malicious code</font></i> <br><br>  Microsoft Office objects are accessible not only from macros, but also from ‚Äúexternal‚Äù programs in any languages ‚Äã‚Äãthat support COM.  The latter can be compiled programs in languages ‚Äã‚Äãlike C ++ or Delphi, managed by Java or .Net applications, or by scripts in VBScript and PowerShell ‚Äî COM technology is available for almost everything that can run under Windows. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf4/5bb/b15/bf45bbb15595e0b133da842d74eab201.png" alt="image"><br>  <i><font color="#999999">Access to the Microsoft Office object model from PowerShell</font></i> <br><br>  The Microsoft Office Object Model represents Microsoft Office applications as COM objects.  But it is also possible to add documents and other COM objects ‚Äî ActiveX controls, not related to Microsoft Office, but present in the operating system.  Being included in the document, these elements can interact with the macro code, or execute their own code based on the ‚Äúproperties‚Äù added to the document - the properties of the object.  In skillful hands, embedding ActiveX controls can also lead to the execution of arbitrary code, so in recent versions of Microsoft Office, the launch of embedded ActiveX is prohibited by default, with the exception of some white list elements.  However, the user in this case, if desired, can explicitly allow execution. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3c0/63d/bd8/3c063dbd86038f2c173183dfe813b528.gif" alt="image"><br>  <i><font color="#999999">Embedded ActiveX Warning</font></i> <br><br>  The proposal to allow (or prohibit) the launch of active content will go to the user when opening the document in a normal manner in the appropriate application.  What happens if you open the same document using the Microsoft Office Object Model? <br>  Examples of such programs - a great many in various languages ‚Äã‚Äãand for various tasks: <br><br><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objWord = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"Word.Application"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objDoc = objWord.Documents.Add(<span class="hljs-string"><span class="hljs-string">"e:\test\fax.dotx"</span></span>) objDoc.SaveAs(<span class="hljs-string"><span class="hljs-string">"e:\test\temp.docx"</span></span>) objDoc.Close objWord.Quit</code> </pre>  <i><font color="#999999">VBScript example</font></i> <br><br><pre> <code class="cs hljs">application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Word.Application(); Object templatePathObj = <span class="hljs-string"><span class="hljs-string">"   "</span></span>;; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { document = application.Documents.Add(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> templatePathObj, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> missingObj, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> missingObj, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> missingObj); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception error) { document.Close(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> falseObj, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> missingObj, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> missingObj); application.Quit(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> missingObj, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> missingObj, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> missingObj); document = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; application = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> error; } _application.Visible = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre>  <i><font color="#999999">C # example</font></i> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> Word; _<span class="hljs-function"><span class="hljs-function">ApplicationPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">word</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">L"Word.Application"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; word-&gt;Visible = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; word-&gt;Activate(); _DocumentPtr wdoc1 = word-&gt;Documents-&gt;Add(); RangePtr range = wdoc1-&gt;Content; range-&gt;LanguageID = wdRussian; range-&gt;Tables-&gt;Add(range,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>); wdoc1-&gt;SaveAs(&amp;<span class="hljs-keyword"><span class="hljs-keyword">_variant_t</span></span>(<span class="hljs-string"><span class="hljs-string">"C:\\1test.doc"</span></span>)); wdoc1-&gt;Close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (_com_error&amp; er) {}</code> </pre>  <i><font color="#999999">C ++ Example</font></i> <br><br><pre> <code class="hljs php">$word = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object -ComObject Word.Application $word.Visible = $True $doc = $word.Documents.Add()</code> </pre>  <i><font color="#999999">PowerShell Example</font></i> <br><br>  When studying such examples, only <a href="http://habrahabr.ru/post/275989/">once we found an</a> interesting line <a href="http://habrahabr.ru/post/275989/">in the code</a> : <br><br><pre> <code class="vbscript hljs">app.AutomationSecurity = <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br>  What does it mean, tell the <a href="http://msdn.microsoft.com/en-us/vba/excel-vba/articles/application-automationsecurity-property-excel">official documentation</a> : <br><br><blockquote>  Application.AutomationSecurity Property (Excel) <br>  ... <br>  Microsoft Excel uses when it is programmatically opening files. <br>  ... <br>  MsoAutomationSecurity can be one of these MsoAutomationSecurity constants. <br><br>  msoAutomationSecurityByUI.  Use the security dialog box | <br>  msoAutomationSecurityForceDisable.  Disables all macros in all files. <br>  msoAutomationSecurityLow.  Enables all macros.  <b>This is the default value when the application is started</b> . <br></blockquote><br>  It turns out that if the Microsoft Office application is launched as an automation element, then the macro code in the opened documents will be executed by default.  Unless, of course, specifically change the security level of the management program.  This default does not depend on the settings made by the user or administrator.  In addition to macros, the code of any ActiveX controls added to the document will also be loaded and executed. <br><br><img src="https://habrastorage.org/web/d87/5ef/c87/d875efc8772148e188f5535b236dc1e3.jpg"><br>  <i><font color="#999999">Execution of a macro when opening a document through Automation</font></i> <br><br>  This non-obvious feature seems to be rarely taken into account.  For example, office software from other manufacturers use the Microsoft Office object model to import and export data into Word and Excel documents.  Quite often there are examples for 1C: <br><br><pre> <code class="1c hljs">MSWord = <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-type"><span class="hljs-type">COM</span></span>(<span class="hljs-string"><span class="hljs-string">"Word.Application"</span></span>); MSWord.Documents.Add(); ActiveDocument = MSWord.ActiveDocument; Content = ActiveDocument.Content; <span class="hljs-comment"><span class="hljs-comment">//     Content.InsertParagraphAfter(); Content.InsertAfter("  1"); Content.InsertParagraphAfter(); Content.InsertAfter("  2"); Content.InsertParagraphAfter(); //            //   Content.InsertParagraphAfter(); //     ActiveDocument.Range(Content.End - 1, Content.End).InsertFile(, "", , ); Content.InsertParagraphAfter();</span></span></code> </pre>  <i><font color="#999999">Example for 1C</font></i> <br><br>  1C programs, called ‚Äútreatments,‚Äù can also use COM in general and the Microsoft Office object model in particular.  Some useful treatments are provided to users by the manufacturer, for example, <a href="">processing ‚ÄúLoading</a> Data from a Tabular Document. <a href="">Epf‚Äù</a> allows you to load data from external table documents into the database. <br><br><img src="https://habrastorage.org/web/df2/1a7/c8a/df21a7c8a8da411ca8b5643be1643f9c.jpg"><br>  <i><font color="#999999">Macro execution when opening a document through 1C processing</font></i> <br><br>  As you can see, the AutomationSecurity property was also forgotten by 1C programmers. <br>  On the one hand, this is a classic example of what you need to think about security in the programming process, no matter what language is used.  On the other hand, what reason made Microsoft, when tightening Microsoft Office security settings, leave the object model unprotected? <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/PNSEPuYCj6k" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i><font color="#999999">A small video demonstrating how an attacker can take control of the accounting computer using the Metasploit Framework and the price of dumplings.</font></i>  <i><font color="#999999">The macro contained in the Excel document runs the script for PowerShell, which opens the attacker with access to the command line on the attacked system.</font></i> </div><p>Source: <a href="https://habr.com/ru/post/335222/">https://habr.com/ru/post/335222/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335212/index.html">Algorithm for memorizing foreign words</a></li>
<li><a href="../335214/index.html">‚ÄúA train that could!‚Äù Or ‚ÄúSpecialization Machine learning and data analysis‚Äù, through the eyes of a beginner in Data Science</a></li>
<li><a href="../335216/index.html">Asymmetric cryptography and public key cryptography are not the same thing?</a></li>
<li><a href="../335218/index.html">CNCF offered free open source cloud for DevOps / microservices</a></li>
<li><a href="../335220/index.html">How Discord Scaled Elixir to 5 Million Concurrent Users</a></li>
<li><a href="../335224/index.html">Optimization Method Trust-Region DOGLEG. Python implementation example</a></li>
<li><a href="../335226/index.html">ML Boot Camp V, solution history for 2nd place</a></li>
<li><a href="../335228/index.html">Dagaz: Steps</a></li>
<li><a href="../335230/index.html">The number game: how algorithmic trading will change the sphere of finance</a></li>
<li><a href="../335232/index.html">Daniel Story Comics (Part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>