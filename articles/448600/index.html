<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to study the critical DHCP vulnerability in Windows 10 has led to the detection of two more security errors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Image: Unsplash 

 As described in the previous article about CVE-2019-0726 , sometimes searching for details about a known vulnerability leads to the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to study the critical DHCP vulnerability in Windows 10 has led to the detection of two more security errors</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habr.com/ru/company/pt/blog/448600/"><img src="https://habrastorage.org/webt/yp/f9/um/ypf9um_w-o9bemj0w8q9gucekre.png"></a> <br><br>  <i>Image: <a href="https://unsplash.com/photos/T01GZhBSyMQ">Unsplash</a></i> <br><br>  As described in the <a href="https://habr.com/ru/company/pt/blog/448378/">previous article</a> about <a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0726">CVE-2019-0726</a> , sometimes searching for details about a known vulnerability leads to the discovery of a new vulnerability.  And in some cases, these new vulnerabilities are more than one. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The article dealt with two functions of the dhcpcore.dll library: the briefly mentioned UpdateDomainSearchOption and the DecodeDomainSearchListData that it calls in more detail.  As always happens when searching for vulnerabilities, even if important conclusions at the end are reduced to one or two functions, in the process of analysis you have to look through a much larger amount of code.  And sometimes the eye clings to trifles that are not related to the current task, but may have independent significance or come in handy later.  Suppose that at the moment there is no time to pay attention to them, but such trifles are deposited on the subcortex and, if after a certain period of time it becomes possible to return to them and check their guesses, re-emerge in consciousness. <br><br>  That is what happened this time.  When studying the DhcpExtractFullOptions function, which is responsible for processing all the options specified in the DHCP response from the server, in particular, the calling UpdateDomainSearchOption, two arrays on the stack of 256 elements each immediately attract attention: <br><br><img src="https://habrastorage.org/webt/6e/ug/5g/6eug5gck41wlfwrzpfcdkxqr1x0.png"><br><br>  At the same time, there is no noticeable presence of any checks that limit the values ‚Äã‚Äãof the iterators of these arrays.  Since at that moment we were reviewing another vulnerability, this information was irrelevant.  Therefore, it remained only to remember this place in the code in order to return to it later. <br><br><h2>  Analysis </h2><br>  A couple of weeks pass, and we again recall the previously received function DhcpExtractFullOptions.  We appeal to it in the disassembler, we brush the previously not completely disassembled pieces of code and try to understand what two static arrays intrigued us are used for. <br><br>  At the very beginning of the execution of the function, the arrays and their iterators are reset: <br><br><img src="https://habrastorage.org/webt/9i/cd/y8/9icdy8i_mroton7j0dmxna_qrrs.png"><br><br>  The function is engaged in the analysis of all options in the package received from the DHCP server, the collection of information from them and its subsequent processing.  In addition, according to the results of the analysis, she also writes the corresponding event in the ETW service (Event Tracing for Windows).  It is in the event logging that the buffers of interest take part.  Together with a large amount of other data, they are passed to the EtwEventWriteTransfer procedure.  The work on preparing all the data for logging is quite voluminous and does not matter much for the vulnerability we are considering, so we can do without illustrations. <br><br>  It is more important to determine how these buffers are filled.  Filling in the parse option cycle.  First, a function with a talking name ParseDhcpv4Option is called for the current option received for processing, which either fills the fields of the dhcp_pointers object based on the incoming data or marks an unfamiliar option when it encounters an option ID with a value for which there is no handler. <br><br><img src="https://habrastorage.org/webt/_w/9h/w1/_w9hw1bnfgfpfsodjisbt9xx4hk.png"><br><br>  Upon returning from ParseDhcpv4Option, the value of the identifier of the current option_tag is written to the next element of the array all_tags, the first array of interest to us.  If the function encountered an unfamiliar option and, accordingly, did not set the is_known_option flag, then the identifier value is also written to the next element of the second array, unknown_tags.  Naturally, the meaningful names of the variables in this article have already been obtained from the results of the code analysis. <br><br>  Thus, the array all_tags stores the tags of all options from the incoming message, and the array unknown_tags stores tags for only those options unknown to the parser.  At the same time, there is no verification of the index values ‚Äã‚Äãof these arrays at all.  Consequently, the values ‚Äã‚Äãof such indices can exceed 256 and lead to writing beyond the memory allocated on the stack for arrays.  To overflow the first array, it is sufficient to send a packet from the DHCP server with more than 256 options. The same is true for the second array, the only difference being that the options that the client cannot process are sent. <br><br><h2>  Exploitation </h2><br>  Let us try now on a practical example to make sure that our conclusions are correct.  To begin with, pay attention to the fact that the option tags occupy one byte, while the elements of the arrays are of type int, that is, they are four-byte.  Thus, we have an overflow in which we control every fourth byte, and the rest when overwritten are reset. <br><br><img src="https://habrastorage.org/webt/bi/ww/vy/biwwvyyk6c-1mnlqz7l_mrgb3pi.png"><br><br>  To test our assumption, the easiest way is to overwrite the security cookie stored on the stack of the function in question, which will cause an exception related to the security check.  Let us simulate a situation in which the DHCP server sends a sufficient number of options for rewriting.  Let it be 0x1a0 (416) options with id 0xaa and zero size.  Thus, each option takes up two bytes, and the full packet size with all the headers will be 1100‚Äì1200 bytes.  This value is within the <a href="https://ru.wikipedia.org/wiki/Maximum_transmission_unit">MTU</a> for Ethernet, therefore, there is reason to believe that the message will not be fragmented, which will allow us to avoid possible adverse effects. <br><br>  We send the package generated in the described manner in response to a request from a DHCP client and intercept an exception on the client machine in the corresponding svchost.exe process: <br><br><img src="https://habrastorage.org/webt/yt/n_/sg/ytn_sgcs4d4e-1yvzebztfcpb1a.png"><br><br>  As can be seen from the stack trace, the stack cookie and the return address of the function were rewritten with the option identifiers from our package. <br><br>  Of course, creating a working exploit for this error will require quite a lot of effort from the attacker.  On modern systems, the buffer overflow on the stack is quite complex and time-consuming in the operation of vulnerability due to all the existing protective mechanisms.  On the other hand, we should not forget that all these mechanisms either protect against rewriting of the return address and exception handlers, either prohibit the execution of code in regions of memory not intended for this, or interfere with the prediction of addresses.  For example, they cannot help in any way against overwriting the stack stored between the overflowing buffer and the return address of local variables.  And the DhcpExtractFullOptions function in question contains several potentially dangerous variables in this range. <br><br>  Again, we write to Microsoft about the error found.  After a brief correspondence and analysis of the application that took about a week, we get an answer that a CVE-identifier is being prepared for the described vulnerability, a correction is scheduled for release in March, and information about the vulnerability is already available to Microsoft, was reported by someone earlier.  The fact is, generally speaking, not surprising, because the error lies literally on the surface, and buffers that do not contain boundary checks of indices always attract attention first and can often be detected by automatic analysis tools. <br><br>  In March, as was stated, an update is issued, correcting the described error, which received the identifier <a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0697">CVE-2019-0697</a> .  The researcher who reported the information earlier turned out to be Mitch Adair, the Microsoft employee who discovered the DHCP vulnerability <a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0547">CVE-2019-0547</a> , which was fixed in January. <br><br>  <b>Author</b> : Mikhail Tsvetkov, Specialist, Application Technologies Analysis Department, Positive Technologies. </div><p>Source: <a href="https://habr.com/ru/post/448600/">https://habr.com/ru/post/448600/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448584/index.html">7 common mistakes when using prepositions in the English language and how to avoid them</a></li>
<li><a href="../448588/index.html">The architecture of the network load balancer in Yandeks.Oblak</a></li>
<li><a href="../448590/index.html">Familiar strangers or again about the use of design patterns</a></li>
<li><a href="../448594/index.html">Free antiviruses and firewalls (UTM, NGFW) from Sophos</a></li>
<li><a href="../448596/index.html">Tablet holder on a treadmill or search for free steps</a></li>
<li><a href="../448602/index.html">Is monitoring dead? - Long live monitoring</a></li>
<li><a href="../448604/index.html">GameBoy on C #</a></li>
<li><a href="../448608/index.html">How to take the first steps in robotics?</a></li>
<li><a href="../448610/index.html">DIY: How we did a ‚Äúlive‚Äù schedule for Codefest X</a></li>
<li><a href="../448618/index.html">Douglas-Pecker Algorithm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>