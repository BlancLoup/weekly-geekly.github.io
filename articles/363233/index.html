<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing the Cisco Nexus 1000v in VMware vSphere 5.x</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article is a translation of two articles by AJ Cruz: 
 Nexus 1000v Part 1 of 2 (Theory) 
 Nexus 1000v Part 2 of 2 (Installation & Operation) 

 Pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing the Cisco Nexus 1000v in VMware vSphere 5.x</h1><div class="post__text post__text-html js-mediator-article">  The article is a translation of two articles by AJ Cruz: <br>  <a href="http://nexusfu.blogspot.ru/2013/09/nexus-1000v-part-1-of-2-theory.html">Nexus 1000v Part 1 of 2 (Theory)</a> <br>  <a href="http://nexusfu.blogspot.ru/2013_10_01_archive.html">Nexus 1000v Part 2 of 2 (Installation &amp; Operation)</a> <br><br>  Partially overlaps with articles: <br>  <a href="http://habrahabr.ru/post/175663/">Installing Nexus 1000V on vSphere 5.1 (Part One)</a> <br>  <a href="http://habrahabr.ru/post/171639/">Installing Nexus 1000V on vSphere 5.1 (Part Two)</a> <br>  But there is a different presentation style and other features, such as installing VEM into the hypervisor core through VMware Update Manager. <br><br>  Nexus 1000v Part 1 of 2 (Theory) <br>  This will be the first of two publications about my study of the Nexus 1000v switch. <br>  Here I will talk about the theory of the Nexus 1000v.  And in the second part I will describe the installation and operation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      While I will continue my post, I can mention the different terminology that needs to be defined.  Therefore, I will immediately denote some terms: <br><br><ul><li>  <b>vDS</b> </li><li>  <b>vSphere Distributed Switch</b> ( <b>vSphere Distributed Switch</b> ) </li><li>  <b>Virtual Distributed Switch</b> ( <b>Virtual Distributed Switch</b> ) </li><li>  <b>DVS</b> </li><li>  <b>Distributed Virtual Switch</b> (Distributed <b>Switch</b> ) </li></ul><br><br>  All of the above is how the vSphere Distributed Switch is usually mentioned on the Internet and in all sorts of documentation. <br>  They all mean the same thing and relate to the virtual switch as a whole. <br>  Cisco Nexus 1000v is one of the options for implementing vDS.  vSphere also has a built-in vDS, with which I do not have much experience in handling. <br><br><a name="habracut"></a><br><br>  Let's find out what vDS is, namely the Nexus 1000v.  First, let's take a look at what we all know.  The image below is a Nexus 7004 switch: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a87/aeb/7ef/a87aeb7ef16c43158aba4723002bf1a3.png"></div><br><br>  Pretty standard.  We have a pair of Supervisor Engines in slots 1 and 2, Sup in slot 1 is active.  We also have a pair of I / O modules (IOM, line cards, Ethernet modules, interface cards) in slots 3 and 4. The matrix LAN lines are designed to show how we could connect to the rest of our infrastructure. <br><br>  Now look at the vDS graphical representation: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/9fb/bf7/21d/9fbbf721d865472680a7dcc5d9091436.png"></div><br><br>  We have the same four modules, but now they work as software within VMware (‚ÄúV‚Äù in vDS) and are distributed in two different ESXi hosts (‚ÄúD‚Äù in vDS). <br><br>  <b>VSM</b> - Virtual machine applains (Virtual Management Module) A virtual machine that is the ‚Äúbrain‚Äù (like the Supervisor Engine) of the vDS.  VSM can be run both on an ESX host and on a dedicated hardware. <br>  <b>VEM</b> - Virtual Ethernet Module.  Software on every ESXi host participating in vDS.  Analogue of a line card in a standard modular switch. <br>  <b>SVS</b> - Switch server verticalization.  In SVS, the configuration determines how the VEMs communicate with their parent VSM.  In general, it seems (at least in my head) to route the highways in standard modular switches. <br><br>  Let's dig a little deeper and see how virtual machines ‚Äúconnect‚Äù to vDS and how vDS connects to the rest of the world.  I have another image as an illustration: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/7b7/c3d/982/7b7c3d9825c146a2a989c906f0f0605f.png"></div><br><br>  It doesn't matter if the port profiles belong to <b>VEM</b> or <b>VSM</b> , I set them on VEM to make the work more understandable.  What is a port profile? <br>  In a virtual switch (and this is logical), we do not perform the operation on the physical interface.  In fact, the virtual interface to which the VM connects does not even exist until the VM adapter has been configured.  So, what we need to do is create a container where we all put it.  The container contains configuration information (vlan, QoS policy (Quality of Service), etc.) and acts as a kind of funnel or aggregation point for virtual machines. <br>  When we edit the settings of the virtual machine and select the connection to the network of its adapter, we will see a drop-down list (using the image above) with items ‚ÄúB‚Äù and ‚ÄúA.‚Äù <br><br>  Why don't we see two different port profiles (X or Y)? <br><br>  <b>Port profile vethernet</b> is a port profile type that is used for virtual machine connections.  Available in the drop-down list of network connections of the Virtual Machine adapter settings. <br>  <b>Ethernet port profile</b> ‚Äî A port profile type that is used to physically connect from an ESX server.  Not displayed in the VM adapter settings. <br><br>  Thus, although virtual machines are assigned to the vethernet port profile, physical network adapters are assigned to the ethernet port profile.  How do vethernet port profiles know which ethernet port profile to use for outgoing traffic? <br>  The 1000v is not running the spanning tree.  Ethernet port profiles must be configured with unique VLANs.  In other words, a specific VLAN must be tied to one ethernet port profile.  1000v will allow you to configure several Ethernet port profiles with the same VLAN, but in the future this will lead to problems. <br>  This does not mean that we can not have redundancy of uplink channels.  As you can see in the last image: two network adapters are assigned to the same ethernet port.  Backup can be achieved using LACP or vPC host mode (mac-pinning).  I do not want to delve too much into the mac-pinning process, but it basically works the same way as it sounds.  The MAC address of a specific virtual machine is attached to one of the physical output ports.  Separating the VM between the inter-physical physical network adapters (automatically through the host mode VPC) provides a measure of load balancing. <br><br>  <b>vPC Host Mode</b> (vPC Host Mode) - NOT VPC !!!  Throw the vPC out of your head.  vPC host mode = MAC pinning.  If you have already worked with VMware, this is the same as ‚ÄúRoute based on source virtual port identifier‚Äù. <br><br>  This is a load sharing method that does not require a special switch configuration.  As already mentioned, MAC addresses are simply tied to one physical port or another. <br><br>  Next, I would like to learn a little more about SVS connections.  Initially, VEM (ESXi host) and VSM should be contiguous with Layer 2. The latest 1000v versions support Layer 3 deployments and this is the recommended deployment method.  The connection between VEM and VSM is IP.  In fact, when deployed at Layer 3, all traffic is sent through <b>UDP port 4785</b> .  However, this does not happen automatically.  We need to configure the vethernet vmkernel port profile using the " <b>capability l3control</b> " <b>command</b> .  This is what instructs the VEM to encapsulate everything associated with the control plane in UDP 4785 and send it to the VSM. <br>  Now we see that we are faced with the "chicken or egg" problem, especially if the VSM is working on VEM. <br><br>  <b>System VLAN</b> ‚Äî allows end-to-end access to configured VLAN traffic traffic, which means immediate access to the network in the absence of a VSM connection;  vmkernel ports must be configured with a system VLAN.  In addition, the ‚Äúsystem vlan &lt;#&gt;‚Äù command is set to both the port of the vethernet profile and the port of the ethernet profile. <br><br>  The last thing I want to mention is how the boundary ports appear in the Nexus 1000v.  I mentioned that virtual interfaces do not exist until a VM is connected.  After the VM has assigned a vethernet port profile inside its network settings and it is in online status, a veth interface is created on the Nexus 1000v.  Veth interface is a physical boundary host port on a common physical switch.  The Veth interface inherits the configuration of the parent port of the vethernet profile. <br>  Ethernet port profiles are tied to physical network adapters in vSphere GUI (read more about this in the next post).  In the framework of the Nexus 1000v, they are shown as multilevel Ethernet interfaces: the first is module #, the second is the port number (vmnic).  Using the last image as a link, vmnic 3 will be displayed in 1000v as E3 / 4.  Three because VEM is module 3 and 4 because it is the fourth vmnic in the block.  However, we still do not perform any configuration on these interfaces, everything is done in the port profile. <br>  The final note on the issue of numbering VEM.  VEM will always be modules 1 and 2. By default, VEM will be numbered sequentially as ESXi hosts are added and placed online. <br><br>  Now we have a good base of the theory of 1000v, we are ready to move on to the second publication in this series. <br><br>  Nexus 1000v Part 2 of 2 (Installation and Operation) <br>  In part 2 of this series, we will go through the installation of the Cisco Nexus 1000v switch and consider some basic operations. <br>  I assume that the reader has basic knowledge of VMware networking technologies and architecture and 1000v operations. <br>  If you would like to first study the theory of 1000v - see part one: "Nexus 1000v Part 1 of 2 (Theory)" <br><br>  Notice that I start with an ESXi desktop, including vCenter.  If you want to see how I configured everything, then see my post ‚ÄúMy VMware Lab‚Äù. <br><br>  I start with my ESXi network settings for two standard vSwitchs.  vSwitch0 for management / VMkernel connections (including one VM port group per VLAN control) and vSwitch1 for VM traffic. <br>  I have four network cards, vmnic0 and vmnic1 are assigned to the switch vSwitch0, vmnic2 and vmnic3 - to the switch vSwitch1: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/bb3/105/9c6/bb31059c6e964b02a0b654796e5aee64.png"></div><br><br>  Here is some information about my setup: <br><pre><code class="cs hljs">VLAN101 - <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>  VLAN102 - <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> vCenter Appliance - <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span> ESXi host- <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.52</span></span>    - <span class="hljs-number"><span class="hljs-number">.254</span></span></code> </pre> <br><br>  My installation goal is to replace the vSwitch1 with a Nexus1000v and make sure that my vCenter and VM Win2008R2 are still pinging vDS. <br><br>  Installing the Nexus 1000v consists of five basic steps: <br><br><ol><li>  1. Install / Provide VSM Virtual Machines </li><li>  2. Register the Nexus 1000v plugin in vCenter </li><li>  3. Configure VSM-vCenter communication (SVS connection) </li><li>  4. Install the VEM software on each ESXi host and set the module status to Online </li><li>  5. Configure the host network configuration </li></ol><br><br>  We can either install 1000v manually or using the Cisco Java Installer.  Since the Java Installer is the recommended way, I will use it in the demonstration.  The Java Installer performs steps 1-3, and potentially 4 (this means that we have completed the installation). <br><br>  <b>Steps 1-3:</b> <br>  Go to the application to install the VSM and double click the installer icon: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/165/d02/be3/165d02be34fb424795c7951d5da028cd.png"></div><br><br>  Select the complete installation and click on the radio button for a user choice: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b23/a51/bef/b23a51bef266426e9a326ad09837b2e6.png"></div><br><br>  Click Next, enter the vCenter Server IP address and credentials, and click Next. <br><br>  The installer will install two VSMs no matter you have one ESXi host or several.  If you have only one - see the information for host 2. Fill in the installer with all the necessary information: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/987/839/91e/98783991effe4e468ccebc4da7fe0387.png"></div><br><br>  You can fill in all the fields yourself or select the [Browse] button options, just make sure that if you fill in your own, then you do not make mistakes.  The installer does not validate the input until you leave the screen.  So if you suddenly made a mistake, you will have to start over. <br>  The name of the virtual machine will automatically be added "-1" and "-2" for VSM 1 and 2, respectively. <br>  Select the .OVA file from the Nexus installation directory.  Please note that the ova with the numbers ‚Äú1010‚Äù in the title is for the Nexus 1010. <br>  We will put layer 3 into operation, which is the preferred method. <br>  When deploying Layer 3, the Management port and the Packet port are ignored.  I will just assign them all to the VLAN management. <br>  After you have completed everything, click [Next] <br><br>  While everything moves it's time to place the windows.  I would like to split the screen into two parts, leaving vCenter on the left side of the screen to see what is happening in vSphere while the 1000v installer is doing its job. <br><br>  You will see the entire result on the screen.  If everything looks good, click Next.  Relax and let ESXi work its magic during the installation process.  Upon completion of the installation, you will be presented with a confirmation screen: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/541/68a/d6d/54168ad6d97e481e926d171b28f27e02.png"></div><br><br>  Do not close this window yet - we will once again check all the steps that have been completed so far.  The installer has just completed steps 1 to 3. Let's check everything ourselves.  First, we can see in the image above that there are now two new virtual machines N1Kv-1 and N1Kv-2.  So we know that step 1 is completed. <br>  To check step 2 in vCenter, click ‚ÄúPlug-ins‚Äù in the menu and then ‚ÄúManage Plug-ins‚Äù (Manage Plug-ins). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/6d5/958/34a/6d595834aa3f43b6be0c730594fab095.png"></div><br><br>  We see that a new plugin has been installed for the Nexus 1000V.  Close this window. <br><br>  To check step 3, we look at both the 1000v and the inside of the vSphere. <br>  SSH to 1000v and go to the end of the configuration file: <br><br><pre> <code class="cs hljs">N1Kv<span class="hljs-meta"><span class="hljs-meta"># sh run !Command: show running-config !Time: Sat Aug 31 04:57:40 2013 version 4.2(1)SV2(1.1a) svs switch edition essential -----output omitted------ svs-domain domain id 1 control vlan 1 packet vlan 1 svs mode L3 interface mgmt0 svs connection vcenter protocol vmware-vim remote ip address 10.1.2.50 port 80 vmware dvs uuid "8f 99 26 50 21 ce f8 b2-97 7e 6d 49 a2 b6 9f d8" datacenter-name MYDC admin user n1kUser max-ports 8192 connect vservice global type vsg tcp state-checks invalid-ack tcp state-checks seq-past-window no tcp state-checks window-variation no bypass asa-traffic vnm-policy-agent registration-ip 0.0.0.0 shared-secret ********** log-level N1Kv#</span></span></code> </pre><br><br>  We see here the configuration of "svs connection vcenter".  The installer has set up a connection for us.  Now let's take a look at vCenter to make sure that it has created a new vDS. <br>  In vCenter, press CTRL + SHIFT + N or go to Home-&gt; Inventory-&gt; Networking. <br>  Expand the tree to verify that the connection of the 1000v and vDS was successful: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/792/881/12e/79288112efb541af8d3b2fb8c0d07983.png"></div><br><br>  Now let's go to step 4 - installing the VEM software on ESXi.  If we look at our installer, we will see that we have the option ‚Äúinstall VIB and add module‚Äù.  What is VIB? <br>  VIB stands for vSphere Installation Bundle.  This is just a piece of software or application that we can install on ESXi.  In our case, this is the Nexus 1000v VEM software. <br>  One caveat - the 1000v installer works with VMware Update Manager (VUM).  Since I do not have it, I can not use the installer.  So at the moment close the installer - we will do everything manually. <br><br>  <b>Step 4.</b> <br>  First we need to copy the VIB file to ESX.  You can do it in absolutely any way.  SCP is working.  I usually just copy it to my data store using vCenter.  To do this, go to vCenter and press CTRL + SHIFT + H to get back to Home-&gt; Inventory-&gt; Hosts &amp; Clusters.  Go to "Configuration" ("Settings"), then "Storage" ("Storage").  Right-click on the data store and click ‚ÄúBrowse Datastore.‚Äù  At the root level, click the ‚ÄúUpload files to this datastore‚Äù button and click ‚ÄúUpload File‚Äù. <br>  Go to the VIB file, select it (I just chose the latest version), and click [Open]. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b8f/a6a/c38/b8fa6ac38c7f482d831635f8d464104f.png"></div><br><br>  Enable SSH and ESXi shell on the ESX host and SSH directly on ESXi. <br>  If you are not familiar with this process, see: Using Shell ESXi in ESXi 5.x <br>  in CLI, go to the data store and copy the vib file to / tmp / so we can work with it. <br><br><pre> <code class="cs hljs">~ <span class="hljs-meta"><span class="hljs-meta"># ~ # ls altbootbank dev local.tgz proc store usr vmupgrade bin etc locker productLocker tardisks var bootbank lib mbr sbin tardisks.noauto vmfs bootpart.gz lib64 opt scratch tmp vmimages ~ # ~ # cd /vmfs /vmfs # /vmfs # ls devices volumes /vmfs # /vmfs # cd volumes /vmfs/volumes # /vmfs/volumes # ls 2c12e47f-6088b41c-d660-2d3027a4ae4d 521e1a46-2fa17fa3-cb7d-000c2956018f datastore1 (1) 3d762271-7f5b622d-3cfa-b4a79357ee70 521e1a4d-e203d122-8854-000c2956018f shared 521b4217-727150b0-5b58-000c2908bf12 521e1a4e-8824f799-5681-000c2956018f /vmfs/volumes # /vmfs/volumes # cd shared /vmfs/volumes/521b4217-727150b0-5b58-000c2908bf12 # /vmfs/volumes/521b4217-727150b0-5b58-000c2908bf12 # ls 6001.18000.080118-1840_amd64fre_Server_en-us-KRMSXFRE_EN_DVD.iso Cisco_bootbank_cisco-vem-v152-esx_4.2.1.2.1.1a.0-3.1.1.vib N1Kv-1 N1Kv-2 NSC Win2008R2_1 cross_cisco-vem-v152-4.2.1.2.1.1a.0-3.1.1.vib nexus-1000v.4.2.1.SV2.1.1a.iso vCenter Appliance /vmfs/volumes/521b4217-727150b0-5b58-000c2908bf12 # cp cross_cisco-vem-v152-4.2.1.2.1.1a.0-3.1.1.vib /tmp/ /vmfs/volumes/521b4217-727150b0-5b58-000c2908bf12 #</span></span></code> </pre><br><br>  Now go to / tmp and install the vib: <br><br><pre> <code class="cs hljs">/vmfs/volumes/<span class="hljs-number"><span class="hljs-number">521b</span></span>4217<span class="hljs-number"><span class="hljs-number">-727150b</span></span>0<span class="hljs-number"><span class="hljs-number">-5b</span></span>58<span class="hljs-number"><span class="hljs-number">-000</span></span>c2908bf12 <span class="hljs-meta"><span class="hljs-meta"># cd /tmp /tmp # /tmp # esxcli software vib install -v /tmp/*.vib Installation Result Message: Operation finished successfully. Reboot Required: false VIBs Installed: Cisco_bootbank_cisco-vem-v152-esx_4.2.1.2.1.1a.0-3.1.1 VIBs Removed: VIBs Skipped: /tmp #</span></span></code> </pre><br><br>  At the moment we‚Äôve half completed step 4. Now we have to connect the VEM module to the network.  To do this, you need to create a VMkernel port group with the ‚Äúcapability l3control‚Äù option.  Before that, let's check our status on 1000v: <br><br><pre> <code class="cs hljs">N1Kv<span class="hljs-meta"><span class="hljs-meta"># sh mod Mod Ports Module-Type Model Status --- ----- -------------------------------- ------------------ ------------ 1 0 Virtual Supervisor Module Nexus1000V active * 2 0 Virtual Supervisor Module Nexus1000V ha-standby Mod Sw Hw --- ------------------ ------------------------------------------------ 1 4.2(1)SV2(1.1a) 0.0 2 4.2(1)SV2(1.1a) 0.0 Mod MAC-Address(es) Serial-Num --- -------------------------------------- ---------- 1 00-19-07-6c-5a-a8 to 00-19-07-6c-62-a8 NA 2 00-19-07-6c-5a-a8 to 00-19-07-6c-62-a8 NA Mod Server-IP Server-UUID Server-Name --- --------------- ------------------------------------ -------------------- 1 10.1.1.10 NA NA 2 10.1.1.10 NA NA * this terminal session N1Kv#</span></span></code> </pre><br><br>  We see two VSM modules: 1 and 2. Currently, no VEM is online. <br>  Let's first create an ethernet port profile to control the uplink VLAN. <br>  But first, let's move our windows again.  I like to share the screen to watch what is happening in vCenter while I work at 1000v.  In vCenter, press CTRL + SHIFT + N to return to the network.  With the window open, now let's create a port profile: <br><br><pre> <code class="cs hljs">N1Kv<span class="hljs-meta"><span class="hljs-meta"># conf t Enter configuration commands, one per </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">. End with CNTL/Z. N1Kv(config)# port-profile type ethernet MGMT-Uplink N1Kv(config-port-prof)# vmware port N1Kv(config-port-prof)# switchport mode access N1Kv(config-port-prof)# switchport access vlan 101 N1Kv(config-port-prof)# no shutdown N1Kv(config-port-prof)# system vlan 101 N1Kv(config-port-prof)# state enable N1Kv(config-port-prof)#</span></span></code> </pre><br><br>  As soon as we install ‚Äústate enable‚Äù, the port profile is immediately added to the vCenter. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cb3/d07/eb4/cb3d07eb417242ff930e0c62921d2b10.png"></div><br><br>  Now let's create a port for the vethernet profile to manage traffic.  We will add ‚Äúcapability l3control‚Äù to this port. <br><br><pre> <code class="cs hljs">N1Kv(config-port-prof)<span class="hljs-meta"><span class="hljs-meta"># port-profile type vethernet VLAN101 N1Kv(config-port-prof)# vmware port N1Kv(config-port-prof)# switchport mode access N1Kv(config-port-prof)# switchport access vlan 101 N1Kv(config-port-prof)# no shutdown N1Kv(config-port-prof)# system vlan 101 N1Kv(config-port-prof)# capability l3control Warning: Port-profile 'VLAN101' is configured with 'capability l3control'. Also configure the corresponding access vlan as a system vlan in: * Port-profile 'VLAN101'. * Uplink port-profiles that are configured to carry the vlan N1Kv(config-port-prof)# 2013 Aug 31 06:56:59 N1Kv %MSP-1-CAP_L3_CONTROL_CONFIGURED: Profile is configured with capability l3control. Also configure the corresponding VLAN as system VLAN in this port-profile and uplink port-profiles that are configured to carry the VLAN to ensure no traffic loss. N1Kv(config-port-prof)# state enable N1Kv(config-port-prof)#</span></span></code> </pre><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2d4/cec/79b/2d4cec79be2e4ae880b4732aeb7b8e61.png"></div><br><br>  Now, at the final stage, we need to move the vmnic to the port of the ethernet profile, and move one of our vmkernel connections to the port of the vethernet profile. <br>  Right-click on vDS and click "Add Host": <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b38/0d8/75c/b380d875cb854f249c7fa8791413bf08.png"></div><br><br>  Select the ESXi host and vmnic to move.  I choose one of two network adapters on the switch vSwitch0, in order not to lose connection with ESXi, plus my iSCI is tied to vmnic0, so I can not move it right now.  On the right, select the MGMT-Uplink profile port in the drop-down list and click [Next]: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4ac/1ab/624/4ac1ab624bfd4ebb974dfbab6ffb75cb.png"></div><br><br>  On the next screen, you need to select the vmkernel port to transfer to 1000v.  I'm going to use VMK0 (Management) and in the drop-down list I select the port of the vethernet profile ‚ÄúVLAN101‚Äù, then press [Next]: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/05c/a87/ade/05ca87adea764d8ca69bb49098e38e63.png"></div><br><br>  Don't worry about migrating virtual machines yet, click [Next]. <br>  The next screen shows a visual representation of vDS.  Click [Finish]. <br>  Scroll back to the 1000v terminal and you should see: <br><br><pre> <code class="cs hljs">N1Kv(config-port-prof)<span class="hljs-meta"><span class="hljs-meta"># 2013 Aug 31 07:19:28 N1Kv %VEM_MGR-2-VEM_MGR_DETECTED: Host esx2 detected as module 3 2013 Aug 31 07:19:28 N1Kv %VEM_MGR-2-MOD_ONLINE: Module 3 is online</span></span></code> </pre><br><br>  When vCenter has finished its work, let's check in the 1000v console: <br><br><pre> <code class="cs hljs">N1Kv(config-port-prof)<span class="hljs-meta"><span class="hljs-meta"># sh mod Mod Ports Module-Type Model Status --- ----- -------------------------------- ------------------ ------------ 1 0 Virtual Supervisor Module Nexus1000V active * 2 0 Virtual Supervisor Module Nexus1000V ha-standby 3 248 Virtual Ethernet Module NA ok Mod Sw Hw --- ------------------ ------------------------------------------------ 1 4.2(1)SV2(1.1a) 0.0 2 4.2(1)SV2(1.1a) 0.0 3 4.2(1)SV2(1.1a) VMware ESXi 5.1.0 Releasebuild-799733 (3.1) Mod MAC-Address(es) Serial-Num --- -------------------------------------- ---------- 1 00-19-07-6c-5a-a8 to 00-19-07-6c-62-a8 NA 2 00-19-07-6c-5a-a8 to 00-19-07-6c-62-a8 NA 3 02-00-0c-00-03-00 to 02-00-0c-00-03-80 NA Mod Server-IP Server-UUID Server-Name --- --------------- ------------------------------------ -------------------- 1 10.1.1.10 NA NA 2 10.1.1.10 NA NA 3 10.1.1.52 564d33c8-ba44-2cce-c463-65954956018f 10.1.1.52 * this terminal session N1Kv(config-port-prof)#</span></span></code> </pre><br><br>  Is done.  Module 3 online, step 4 completed. <br><br>  <b>Step 5.</b> <br>  Now let's create our VM vlan, the ethernet port profile to boot and the vethernet port profile for our VMs: <br><br><pre> <code class="cs hljs">N1Kv(config-port-prof)<span class="hljs-meta"><span class="hljs-meta"># vlan 102 N1Kv(config-vlan)# name SERVERS N1Kv(config-vlan)# port-profile type ethernet VM-Uplink N1Kv(config-port-prof)# vmware port N1Kv(config-port-prof)# switchport mode access N1Kv(config-port-prof)# switchport access vlan 102 N1Kv(config-port-prof)# no shutdown N1Kv(config-port-prof)# state enable N1Kv(config-port-prof)# N1Kv(config-port-prof)# port-profile type vethernet VLAN102 N1Kv(config-port-prof)# vmware port N1Kv(config-port-prof)# switchport mode access N1Kv(config-port-prof)# switchport access vlan 102 N1Kv(config-port-prof)# no shutdown N1Kv(config-port-prof)# state enable N1Kv(config-port-prof)#</span></span></code> </pre><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fb3/3e6/554/fb33e6554444455a8044c0c8a3fd4b67.png"></div><br><br>  Next, we need to move the physical NIC to the VM-Uplink ethernet profile port.  To make this change as less painful as possible, I will move one NIC, migrate the virtual machines, then move the other NIC. <br>  Now that the ESXi host has already been added to the vDS, we can right-click on the N1Kv switch and click on ‚ÄúManage Hosts‚Äù instead of adding hosts. <br>  Select one of the vmnic-s on vSwitch1, select the VM-Uplink port group and click [Next] <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/439/79e/e95/43979ee95cd44b91bc8e07bdb5e64733.png"></div><br><br>  Click [Next] ([Next]) two more times, then [Finish] ([Finish]) <br><br>  Now we are ready to migrate the VM.  I'm going to start pinging my Win2008R2 VM. <br>  Press CTRL + SHIFT + H to return to Home-&gt; Inventory-&gt; Hosts &amp; Clusters (Home -&gt; Catalog-&gt; Hosts and Clusters). <br>  I right-click on my VM and go to ‚ÄúEdit Settings‚Äù.  Then I select the VLAN102 network from the vethernet port profile from the drop-down list and click [OK]. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4b5/9ec/03d/4b59ec03d76c46069e7a821401a95dee.png"></div><br><br><pre> <code class="cs hljs">C:\Users\acruz&gt;ping -t <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span> Pinging <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span> with <span class="hljs-number"><span class="hljs-number">32</span></span> bytes of data: Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">20</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">18</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">16</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">13</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">13</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">17</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">123</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">11</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">11</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">19</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">19</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Reply <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: bytes=<span class="hljs-number"><span class="hljs-number">32</span></span> time=<span class="hljs-number"><span class="hljs-number">17</span></span>ms TTL=<span class="hljs-number"><span class="hljs-number">127</span></span> Ping statistics <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>: Packets: Sent = <span class="hljs-number"><span class="hljs-number">16</span></span>, Received = <span class="hljs-number"><span class="hljs-number">16</span></span>, Lost = <span class="hljs-number"><span class="hljs-number">0</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>% loss), Approximate round trip times <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> milli-seconds: Minimum = <span class="hljs-number"><span class="hljs-number">11</span></span>ms, Maximum = <span class="hljs-number"><span class="hljs-number">123</span></span>ms, Average = <span class="hljs-number"><span class="hljs-number">33</span></span>ms C:\Users\acruz&gt;</code> </pre><br><br>  We see a lag, but I have not lost anything. <br>  I do the same for my vCenter device and any other virtual machines until my standard vSwitch 1 is empty: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/87b/092/685/87b0926853864d519cb00bb20bac6d6b.png"></div><br><br>  Our final configuration step is to move vmnic2 to the 1000v port of the VM Uplink profile, but before I do this, let's configure the VM Uplink port for load balancing;  otherwise we will run into problems. <br>  I do not want to make any specific settings on my switch (LACP), so I will do mac-pinning. <br><br><pre> <code class="cs hljs">N1Kv(config-port-prof)<span class="hljs-meta"><span class="hljs-meta"># port-profile VM-Uplink N1Kv(config-port-prof)# channel-group auto mode on mac-pinning N1Kv(config-port-prof)#</span></span></code> </pre><br><br>  For demonstration purposes, I'm going to move vmnic2 in another way.  Instead of right-clicking on vDS and then choosing Manage Hosts, let's click here on the vSphere Distributed Switch. <br>  We see the location of our vDS.  In the upper right corner, click " <b>Manage Physical Adapters ...</b> " ("Manage Physical Adapters ..."). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3d9/cc3/2cb/3d9cc32cbc0e468a9720528c2907fa8d.png"></div><br><br>  Scroll down to the VM-Uplink port group and click "" ("&lt;Click to add NIC&gt;"). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/500/eec/ca0/500eecca0ecc4dd088741a0b6cbfdd9d.png"></div><br><br>  Select the physical adapter you want to add, and click [OK]. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3eb/9c8/8f4/3eb9c88f4fab4206af569db3ba157cb6.png"></div><br><br>  Click the [Yes] ([Yes]) button to remove vmnic2 from the vSwitch1 switch and connect it to NIKv <br>  Click [OK] and after some time vmnic will be added: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/183/a39/193/183a391936d04aa18651ca80602760dc.png"></div><br><br>  As a final step, I'm going to click on the standard vSwitch and remove vSwitch 1. <br>  Some more useful information.  In the NIKv console, you can select " <b>show interface status</b> ", as well as on a normal switch, and see all 1000v ports. <br>  You can select " <b>show interface virtual</b> " and see all the veth ports and what hosts they are on. <br><br>  That's all.  Enjoy getting to know the Nexus 1000v. </div><p>Source: <a href="https://habr.com/ru/post/363233/">https://habr.com/ru/post/363233/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../363219/index.html">The smart pan will perfectly cook any dish.</a></li>
<li><a href="../363221/index.html">Object 2014-28E can be equipped with a Hall-type plasma engine.</a></li>
<li><a href="../363225/index.html">What is Heisenberg uncertainty principle?</a></li>
<li><a href="../363227/index.html">Absolute Zero - comic by Christopher Nolan about Dr. Mann</a></li>
<li><a href="../363229/index.html">Firefox changes default search to Yandex and Yahoo</a></li>
<li><a href="../363235/index.html">An older couple was fined ¬£ 100 for a negative hotel review.</a></li>
<li><a href="../363237/index.html">Samsung in 2015 will release 30% less smartphone models</a></li>
<li><a href="../363239/index.html">Hydrogel injections will increase the chances of survival for injured soldiers</a></li>
<li><a href="../363241/index.html">Computer algorithm selects the most significant authors of the past</a></li>
<li><a href="../363243/index.html">CANSONIC SKY - smart car system Android Auto category in the form of a rear-view mirror</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>