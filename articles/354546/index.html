<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DevConf: from shawarma to symfony or legacy migration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Toward the end of last year‚Äôs DevConf, Artem Degtyar and Pavel Stepanets told how they migrated an ERP system written in PHP5.3, working on Windows, i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DevConf: from shawarma to symfony or legacy migration</h1><div class="post__text post__text-html js-mediator-article">  Toward the end of last year‚Äôs DevConf, Artem Degtyar and Pavel Stepanets told how they migrated an ERP system written in PHP5.3, working on Windows, into Symfony + PHP7, and based on it a b2b cloud service.  The video is available on the <a href="https://devconf.ru/ru/archive/devconf2017/offer/295">report link</a> .  And I will present the text, a little compressed, option. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7d/sc/cs/7dsccsmdh-5q8j2ht_fkncydtfg.jpeg"></div><br>  We worked on a large system that allowed us to create applications and change statuses, plus billing, accounting for goods and materials, and a lot of things.  Today we will tell how to refactor this system, migrated it to symfony.  The system was originally written in pure PHP, and had many ‚Äúfeatures‚Äù.  For example, this five-level ternarnik on the slide worked in a very original way with the date that came from the user. <a name="habracut"></a><br><br><img src="https://habrastorage.org/webt/o_/a4/3m/o_a43m1wvfb8xtzbcu7ysljou-s.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Another example of intricacy.  Not the best way to secure $ _GET &amp; $ _POST.  Let us turn to more objective metrics.  PhpMetrics showed that there is a lot of code, but few files, and the ‚Äúmaintainability‚Äù of the code was very low. <br>  The previous programmer left the project and we inherited it in this state: <br><br><img src="https://habrastorage.org/webt/5s/9m/mw/5s9mmwixz_xetuo0yn-ufwp0nn8.jpeg"><br><br>  Large server server, 400 users, huge controllers.  We started with the fact that using PhpMetrics we built a dependency graph and found the key nodes of the system.  They covered them with unit tests and started reworking them.  We cleaned out the ‚Äúoriginality‚Äù and by tests we saw that nothing broke. <br>  I wanted to work with the database more conveniently than with pure SQL.  Included in the project Doctrine ORM.  She tuned up pretty easily.  We generated an XML config from an existing database, and according to it, classes of entities with annotations.  But not everything was smooth.  There was no foreign key in the database.  When we added connections between entities, the doctrine tried to create these connections.  But the data at that time in the database was inconsistent and any attempt to create the keys caused base errors. <br><br><img src="https://habrastorage.org/webt/f3/wt/mb/f3wtmbpdaj23fpie5ikdkwizxec.jpeg"><br><br>  Do not use the doctrine without migrations!  We used DoctrineMigrationBunde.  It allows you to calculate the difference in the schemes between the database and the doctrine config and generate migration.  Non-consistency was removed by the merciless <b>delete from ... left join (by foreign relations) where the foreign field is null</b> in migrations. <br>  There was one moment when the doctrine code worked well on LAN, but refused to work in production.  It turned out that the lexer of annotations of the doctrine fell when I met Cyrillic comments there.  Do not use them! (I would advise to avoid using Cyrillic at all except for localization files. <a href="https://habr.com/users/adelf/" class="user_link">Adelf note</a> ) <br><br><img src="https://habrastorage.org/webt/5z/zs/cz/5zzsczqa67fseiiy0sbleu6knky.png"><br><br>  The next step was the introduction of HttpFoundation.  A small task of modifying the form from POST to GET, which is not the most pleasant task if the global $ _GET &amp; $ _POST arrays are used.  I decided to integrate HttpFoundation from symfony.  And this process was almost painless.  In a code which caused the controller, the symphony requester object simply began to be transferred. <br><br>  The logical continuation was the complete processing of the front controller.  Previously, it was a huge file that did everything.  I connected the dependency files, initialized a bunch of global (yes-yes) variables, such as $ DB, $ USER, authentication, search, routing, logging, error checking and calling controllers.  The result was the integration of HttpKernel, a component of the symphony, which allows you to fully control the process of performing an HTTP request.  It has an EventDispatcher in its dependencies and it raises a bunch of useful events there.  Front controller greatly simplified. <br><br><img src="https://habrastorage.org/webt/xg/ir/ew/xgirewb74m4j0vy3iqfidgqvfze.png"><br><br>  Creating a request object.  Call HttpKernel to receive a response (response), which we send, and then we complete the work.  But here the problem was revealed.  The project's shawarma controllers could return a string, but could return nothing (null or false) and make echo themselves. <br><br><img src="https://habrastorage.org/webt/ca/tn/t8/catnt8cvsqnkpnjbhizfrcuy12u.jpeg"><br><br>  I had to expand the standard HttpKernel, adding to it what is highlighted on the slide.  All this happened without a feature freeze stage.  Tasks came constantly.  But the implementation of these components without breaking Bacward compatibility allowed implementing features simultaneously with refactoring. <br><br>  The next step was the introduction of DependencyInjection.  The system contained a large number of service classes that were difficult to bootstrap.  The DependencyInjection component allowed to flexibly configure all these services, providing a single access mechanism to them. <br><br>  In the old system there was a certain system of plug-ins based on global variables and routing depended on them as well.  We decided to switch to standard symfony routing.  Inside it, they used an old resolver, thus allowing legacy routes to work too. <br><br><img src="https://habrastorage.org/webt/yc/3q/ei/yc3qei3e1owu93aab40ujwzudvk.png"><br><br>  The day came when we decided to completely switch to symfony.  In a separate branch of the gita we allocated all our shawarma into a separate bundle.  However, they retained the entire physical structure of the files in order to avoid a bunch of conflicts when merge / rebase with the main branch.  As I already described, we rewrote HttpKernel, however at this stage we decided to do it without affecting the kernel.  We have added the so-called DefaultController, which included the whole scheme with the processing of old controllers.  However, all the routes fall under this pattern, so this route must go the last. <br><br><img src="https://habrastorage.org/webt/tm/6w/c5/tm6wc5ikkuoxhqeecnbzfqajsum.png"><br><br>  Shawarma stubbornly resisted.  She had her own auto-loader.  To do this, a call to the old autoloader was added to the AppKernel :: initializeContainer: spl_register_autoload ('oldAutoload'); <br><br>  Initialization of global variables is not lost anywhere.  She was carried to listener onKernelRequest. <br><br>  As a result, we currently have a project in which there is still a lot of legacy, but we can already call it Symfony-based and implement all new features in Symfony-style.  And we did it without the feature freeze, so the business was pleased. <br><br>  Finally, a small refactoring plan for translating the project to symfony. <br><br><img src="https://habrastorage.org/webt/jh/sm/wd/jhsmwdweqjq3brtdefkkpzep3t0.png"><br><br><hr><br>  I considered this a good material for an evening-Friday post.  Come May 18th to DevConf.  I think there will be many similar stories to be heard.  For example, Andrei Bryukhanov wants to make a report " <a href="https://devconf.ru/ru/offers/offer/365">Rewrite the project and survive</a> ."  And for Habr's readers there is a special <a href="https://devconf.ru/join%3Fcoupon%3Dhabr">registration with a discount</a> . </div><p>Source: <a href="https://habr.com/ru/post/354546/">https://habr.com/ru/post/354546/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354536/index.html">The experience of the transition to the Atlassian Stride (from the word Suffer)</a></li>
<li><a href="../354538/index.html">How I found a bug in the Avios Travel system and got thousands of valid points for aviation miles</a></li>
<li><a href="../354540/index.html">Survey: more than half of e-banking systems contain critical vulnerabilities</a></li>
<li><a href="../354542/index.html">How to make sure my site is not blocked by RKN</a></li>
<li><a href="../354544/index.html">Great content with small forces</a></li>
<li><a href="../354548/index.html">Introduction to complex numbers</a></li>
<li><a href="../354550/index.html">Animations in the world of states</a></li>
<li><a href="../354552/index.html">Accelerating Angular Applications</a></li>
<li><a href="../354554/index.html">2nd generation Infortrend EonStor DS2024 storage system review and testing</a></li>
<li><a href="../354558/index.html">Can I trust my Chrome and Firefox synchronization passwords?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>