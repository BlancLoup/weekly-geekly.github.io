<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GlusterFS, the experience of the new version</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 Last time ( Growing up with GlusterFS ) I described how to configure GlusterFS 3.0.x for my needs. We recently upgraded GlusterFS to 3.2.x.,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GlusterFS, the experience of the new version</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  Last time ( <a href="http://habrahabr.ru/post/140031/">Growing up with GlusterFS</a> ) I described how to configure GlusterFS 3.0.x for my needs.  We recently upgraded GlusterFS to 3.2.x., and since there were a lot of differences in configuration between these versions, I decided to describe the process for the general IT mind. <br><br>  At once I will make a reservation that the transition to the new version was due to glitches of the old one. <br>  It was after the next failures of the Amazon EBS. <a name="habracut"></a>  The disk on the second master degraded and we turned off the service at the time of fixing the problems by the brave AWS engineers.  After everything returned to normal, we tried to turn the second master back into the scheme, but something irreparable happened and all the clients simply hung up and the network drives did not corny.  There were errors in the clients, a long googling of which led to ‚Äúhints‚Äù on the forums that such hangs were fixed in new versions, which was perceived both happily and sadly at the same time :) It was necessary to update. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first thing that became clear is that our configs from the old versions will not work, moreover, they are no longer needed and everything is configured from the command line. <br>  Setting up the master-master is quite different than before, and this is the first minus of the new scheme, I will consider them at the end of the article. <br><br>  <i>Initialize peer:</i> <br><br><pre><code class="bash hljs">root@files1.domain.com:~<span class="hljs-comment"><span class="hljs-comment"># gluster peer probe files2.domain.com Probe successful</span></span></code> </pre> <br><br>  <i>Checking:</i> <br><br><pre> <code class="bash hljs">root@files1.domain.com:~<span class="hljs-comment"><span class="hljs-comment"># gluster peer status Number of Peers: 1 Hostname: files2.domain.com Uuid: c8f2fg43-ch7e-47f3-9ec5-b4b66f81101d State: Peer in Cluster (Connected)</span></span></code> </pre><br><br>  <i>Next, create a disk (volume):</i> <br><br><pre> <code class="bash hljs">root@files1.domain.com:~<span class="hljs-comment"><span class="hljs-comment"># gluster volume create volume_data replica 2 transport tcp files1.domain.com:/data files2.domain.com:/data Creation of volume volume_data has been successful. Please start the volume to access data.</span></span></code> </pre><br><br>  <i>Start the drive:</i> <br><br><pre> <code class="bash hljs">root@files1.domain.com:~<span class="hljs-comment"><span class="hljs-comment"># gluster volume start volume_data Starting volume volume_data has been unsuccessful</span></span></code> </pre><br><br>  <i>We perform on both masters:</i> <br><br><pre> <code class="bash hljs">/etc/init.d/glusterfs-server restart</code> </pre><br><br>  <i>If everything went smoothly, the output of the following command should look like this:</i> <br><br><pre> <code class="bash hljs">root@files1.domain.com:~<span class="hljs-comment"><span class="hljs-comment"># gluster volume info Volume Name: volume_data Type: Replicate Status: Started Number of Bricks: 2 Transport-type: tcp Bricks: Brick1: files1.domain.com:/data Brick2: files2.domain.com:/data</span></span></code> </pre><br><br>  <i>We restrict access to our balls in this way:</i> <br><br><pre> <code class="bash hljs">root@files1.domain.com:~<span class="hljs-comment"><span class="hljs-comment"># gluster volume set volume_data auth.allow 10.*</span></span></code> </pre><br><br>  <i>Look again info:</i> <br><br><pre> <code class="bash hljs">Volume Name: volume_data Type: Replicate Status: Started Number of Bricks: 2 Transport-type: tcp Bricks: Brick1: files1.domain.com:/data Brick2: files2.domain.com:/data Options Reconfigured: auth.allow: 10.*</code> </pre><br><br>  <i>Setup on servers is finished, we go to the client.</i>  <i>I assume that you are able to install the necessary version of the package for the client and it is already in the system.</i> <br><br><pre> <code class="bash hljs">root@client.domain.com:~<span class="hljs-comment"><span class="hljs-comment"># mkdir /data root@client.domain.com:~# mount -t glusterfs files1.domain.com:/volume_data /data</span></span></code> </pre><br><br>  <i>We look at the result:</i> <br><br><pre> <code class="bash hljs">root@client.domain.com:~<span class="hljs-comment"><span class="hljs-comment"># df -h Filesystem Size Used Avail Use% Mounted on /dev/sda1 7.9G 6.6G 987M 88% / none 3.4G 112K 3.4G 1% /dev none 3.6G 0 3.6G 0% /dev/shm none 3.6G 64K 3.6G 1% /var/run none 3.6G 0 3.6G 0% /var/lock none 3.6G 0 3.6G 0% /lib/init/rw /dev/sdb 414G 6.1G 387G 2% /mnt tmpfs 10M 8.0K 10M 1% /tmp/tmpfs files1.domain.com:/ volume_data 200G 109G 92G 55% /data</span></span></code> </pre><br><br>  <i>Register in / etc / fstab on client.domain.com:</i> <br><br><pre> <code class="bash hljs">files1.domain.com:/volume_data /data glusterfs defaults,_netdev 0 0</code> </pre><br><br>  <i>And in order to save our nerves when rebooting, we try an ordinary trick in such cases:</i> <br><br><pre> <code class="bash hljs">root@client.domain.com:~<span class="hljs-comment"><span class="hljs-comment"># umount /data root@client.domain.com:~# mount -a</span></span></code> </pre><br><br>  <i>Check that everything is OK:</i> <br><br><pre> <code class="bash hljs">root@client.domain.com:~<span class="hljs-comment"><span class="hljs-comment"># df -h Filesystem Size Used Avail Use% Mounted on /dev/sda1 7.9G 6.6G 987M 88% / none 3.4G 112K 3.4G 1% /dev none 3.6G 0 3.6G 0% /dev/shm none 3.6G 64K 3.6G 1% /var/run none 3.6G 0 3.6G 0% /var/lock none 3.6G 0 3.6G 0% /lib/init/rw /dev/sdb 414G 6.1G 387G 2% /mnt tmpfs 10M 8.0K 10M 1% /tmp/tmpfs files1.domain.com:/ volume_data 200G 109G 92G 55% /data</span></span></code> </pre><br><br>  That's all. <br><br>  <b>Separately, I wanted to dwell on the minuses in the new GlusterFS:</b> <br><br>  1) If you do not have online both masters when setting up, then you will stop at the first command. <br>  2) In the previous version I put passwords on my balls, in the new one you can only do as we did above auth.allow: 10. *, which, as you understand, is not always good practice. <br>  3) <pre> <code class="bash hljs">/etc/fstab: files1.domain.com:/volume_data /data glusterfs defaults,_netdev 0 0</code> </pre><br>  Glasterovtsy say that such a binding to one server only in order to pull out the configuration of peers and other things, BUT! <br>  Indeed, if one master disappears, the client knows where the second, everything works out well in the event that everything is already mounted, but alas, if you had to rebuild, pick up the machine from the image while the host specified in fstab lies.  Your ball will not start, because it will not be able to pull out the config.  And this change in the new version is very wrong for a distributed file system, IMHO. </div><p>Source: <a href="https://habr.com/ru/post/157029/">https://habr.com/ru/post/157029/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157017/index.html">Read only</a></li>
<li><a href="../157019/index.html">Samba4, Radius and PPTP using MS-CHAP v2</a></li>
<li><a href="../157021/index.html">Universal interface for image / video synchronization across devices.</a></li>
<li><a href="../157023/index.html">Puppet under load</a></li>
<li><a href="../157025/index.html">Book web programmer. Secrets of professional website development</a></li>
<li><a href="../157031/index.html">Bitcoin received official recognition</a></li>
<li><a href="../157033/index.html">Blacklist sites can benefit the Internet</a></li>
<li><a href="../157035/index.html">Patent trolling - now blamed Microsoft</a></li>
<li><a href="../157037/index.html">Attention! Competition!</a></li>
<li><a href="../157039/index.html">LG Nexus 4 - the new flagship in the Google Flotilla</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>