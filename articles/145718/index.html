<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Core Data: import data with a minimum of code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Like many developers, I don‚Äôt like to write a lot of code, especially where it seems unnecessary - in the early stages I try to figure out how to opti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Core Data: import data with a minimum of code</h1><div class="post__text post__text-html js-mediator-article">  Like many developers, I don‚Äôt like to write a lot of code, especially where it seems unnecessary - in the early stages I try to figure out how to optimize and generalize this code.  As for Core Data itself, it always seemed to me that all these endless fetches and the creation of new objects can be simplified.  Then I discovered the <a href="http://ru.wikipedia.org/wiki/ActiveRecord">ActiveRecord</a> pattern often mentioned in Habr√© and its very good (in my opinion) implementation on Objective-C - <a href="https://github.com/magicalpanda/magicalrecord">MagicalRecord</a> .  I will not go deeper into the description - everything is very well described on the project page. <br>  The next step of simplification was to be the mapping of data coming from outside. <br><br><a name="habracut"></a>  For myself, I solved this problem head on and worked for a long time.  Each ManagedObject-successor contained the following method, which parses the incoming JSON dictionary: <br><br><pre><code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)mapPropertiesFrom:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)dictonary { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.identifier = [<span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> numberWithInt:[[dictonary objectForKey:<span class="hljs-string"><span class="hljs-string">@"id"</span></span>] intValue]]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.privacy = [<span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> numberWithInt:[[dictonary objectForKey:<span class="hljs-string"><span class="hljs-string">@"public"</span></span>] intValue]]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.author = [KWUser findFirstByAttribute:<span class="hljs-string"><span class="hljs-string">@"profileId"</span></span> withValue:[dictonary objectForKey:<span class="hljs-string"><span class="hljs-string">@"profile"</span></span>]]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.profileId = [<span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> numberWithInt:[[dictonary objectForKey:<span class="hljs-string"><span class="hljs-string">@"profile"</span></span>] intValue]]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.latitude = [<span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> numberWithDouble:[[dictonary objectForKey:<span class="hljs-string"><span class="hljs-string">@"lat"</span></span>] doubleValue]]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.longitude = [<span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> numberWithDouble:[[dictonary objectForKey:<span class="hljs-string"><span class="hljs-string">@"lon"</span></span>] doubleValue]]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text = [dictonary objectForKey:<span class="hljs-string"><span class="hljs-string">@"text"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.category = [dictonary objectForKey:<span class="hljs-string"><span class="hljs-string">@"category"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.firstName = [dictonary objectForKey:<span class="hljs-string"><span class="hljs-string">@"firstname"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.lastName = [dictonary objectForKey:<span class="hljs-string"><span class="hljs-string">@"lastname"</span></span>]; }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is obvious that there are a lot of such objects, moreover, they also have relations.  The first thought that comes to mind is to iterate over attributes and relationships in runtime and save the result to objects.  <s>Unfortunately</s> , joy, I do not like to reinvent the wheel and recently stumbled upon a very interesting implementation of this approach. <br><br><h4>  Magical Import </h4><br>  MagicalImport is a set of categories that extend the functionality of MagicalRecord and allow you to customize the mapping of JSON objects directly in Core Data, while writing code is reduced to an indecent minimum.  I will not delve into the details of the implementation and the goals that were set before the developers, about all this is well written <a href="http://www.cimgf.com/2012/05/29/importing-data-made-easy/">here</a> .  Let us dwell on a specific example. <br><br><h4>  Data retrieval </h4><br>  Take for example a simple request to the Forsquare API, which will return us a list of objects near the Eiffel Tower. <br><br>  Request URL: <br> <code><a href="https://api.foursquare.com/v2/venues/search%3Fv%3D20120602%26ll%3D48.858%252C2.2944%26client_secret%3DILG5POWGBRBZDXLNPAGECAZOBC0KFPQAQ5SYOP51KFYANZ1B%26client_id%3DHDEHROGPMARZ2O1JTK55VHXE4TTNGE0NQR4DBCKHFZULURJV"></a> api.foursquare.com/v2/venues/search?v=20120602&amp;ll=48.858%2C2.2944&amp;client_secret=ILG5POWGBRBZDXLNPAGECAZOBC0KFPQAQ5SYOP51KFYANZ1B&amp;client_id=HDEHROGPMARZ2O1JTK55VHXE4TTNGE0NQR4DBCKHFZULURJV&gt;</code> <br> <br>  I used AFNetworking to get responsa.  API wrapper class: <br><br><pre> <code class="objectivec hljs">+ (LDFourSquareAPIClient *)sharedClient { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> LDFourSquareAPIClient *_sharedClient = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> onceToken; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;onceToken, ^{ _sharedClient = [[LDFourSquareAPIClient alloc] initWithBaseURL:[<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> URLWithString:kBaseURL]]; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _sharedClient; } - (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)initWithBaseURL:(<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *)url { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> initWithBaseURL:url]) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> registerHTTPOperationClass:[AFJSONRequestOperation <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setDefaultHeader:<span class="hljs-string"><span class="hljs-string">@"Accept"</span></span> value:<span class="hljs-string"><span class="hljs-string">@"application/json"</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; }</code> </pre><br><br>  Form the request parameters <br><br><pre> <code class="objectivec hljs"> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *latLon = <span class="hljs-string"><span class="hljs-string">@"48.858,2.2944"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *clientID = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithUTF8String:kCLIENTID]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *clientSecret = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithUTF8String:kCLIENTSECRET]; <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *queryParams; queryParams = [<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> dictionaryWithObjectsAndKeys:latLon, <span class="hljs-string"><span class="hljs-string">@"ll"</span></span>, clientID, <span class="hljs-string"><span class="hljs-string">@"client_id"</span></span>, clientSecret, <span class="hljs-string"><span class="hljs-string">@"client_secret"</span></span>, <span class="hljs-string"><span class="hljs-string">@"20120602"</span></span>, <span class="hljs-string"><span class="hljs-string">@"v"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>];</code> </pre><br><br>  <i>kCLIENTID</i> and <i>kCLIENTSECRET</i> are keys for authorization.  You can register your application, you can use mine. <br><br>  The request to the server and data retrieval looks like this: <br><br><pre> <code class="objectivec hljs"> [[LDFourSquareAPIClient sharedClient] getPath:<span class="hljs-string"><span class="hljs-string">@"v2/venues/search"</span></span> parameters:queryParams success:^(AFHTTPRequestOperation *operation, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> responseObject) { <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *venues = [[responseObject objectForKey:<span class="hljs-string"><span class="hljs-string">@"response"</span></span>] objectForKey:<span class="hljs-string"><span class="hljs-string">@"venues"</span></span>]; } failure:^(AFHTTPRequestOperation *operation, <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error) { }];</code> </pre><br><br>  The venues array will contain a list of places that we will store in our data model.  JSON object venue: <br><br><pre> <code class="javascript hljs">categories = ( { icon = { name = <span class="hljs-string"><span class="hljs-string">".png"</span></span>; prefix = <span class="hljs-string"><span class="hljs-string">"https://foursquare.com/img/categories/building/default_"</span></span>; sizes = ( <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">44</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">256</span></span> ); }; id = <span class="hljs-number"><span class="hljs-number">4</span></span>bf58dd8d48988d12d941735; name = <span class="hljs-string"><span class="hljs-string">"Monument / Landmark"</span></span>; pluralName = <span class="hljs-string"><span class="hljs-string">"Monuments / Landmarks"</span></span>; primary = <span class="hljs-number"><span class="hljs-number">1</span></span>; shortName = Landmark; } ); contact = { formattedPhone = <span class="hljs-string"><span class="hljs-string">"+33 892 70 12 39"</span></span>; phone = <span class="hljs-string"><span class="hljs-string">"+33892701239"</span></span>; }; hereNow = { count = <span class="hljs-number"><span class="hljs-number">3</span></span>; groups = ( { count = <span class="hljs-number"><span class="hljs-number">3</span></span>; items = ( ); name = <span class="hljs-string"><span class="hljs-string">"Other people here"</span></span>; type = others; } ); }; id = <span class="hljs-number"><span class="hljs-number">4</span></span>adcda09f964a520dd3321e3; likes = { count = <span class="hljs-number"><span class="hljs-number">0</span></span>; groups = ( ); }; location = { address = <span class="hljs-string"><span class="hljs-string">"Parc du Champ de Mars"</span></span>; city = Paris; country = France; crossStreet = <span class="hljs-string"><span class="hljs-string">"5 av. Anatole France"</span></span>; distance = <span class="hljs-number"><span class="hljs-number">42</span></span>; lat = <span class="hljs-string"><span class="hljs-string">"48.85836229464931"</span></span>; lng = <span class="hljs-string"><span class="hljs-string">"2.2945761680603027"</span></span>; postalCode = <span class="hljs-number"><span class="hljs-number">75007</span></span>; state = <span class="hljs-string"><span class="hljs-string">"\U00cele de France"</span></span>; }; name = <span class="hljs-string"><span class="hljs-string">"Tour Eiffel"</span></span>; specials = { count = <span class="hljs-number"><span class="hljs-number">0</span></span>; items = ( ); }; stats = { checkinsCount = <span class="hljs-number"><span class="hljs-number">31211</span></span>; tipCount = <span class="hljs-number"><span class="hljs-number">430</span></span>; usersCount = <span class="hljs-number"><span class="hljs-number">22307</span></span>; }; url = <span class="hljs-string"><span class="hljs-string">"http://www.tour-eiffel.fr"</span></span>; verified = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><br><h4>  Data model </h4><br>  The data model in this example consists of two objects ‚Äî Venue and Location and the one-to-one relationship between them. <br><br><img src="https://habrastorage.org/storage2/f71/90e/345/f7190e3457c2b6ff74e0309bb56d2407.png"><br><br><img src="https://habrastorage.org/storage2/ead/df9/437/eaddf94373a9ad7b441a129f52d4596a.png"><br><br><h4>  Data import </h4><br>  If the JSON response of the service is ‚Äúperfect‚Äù and its model is fully consistent with our base model, then in order to make the import, you need to add the following code in the completion block: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.data = [Venue MR_importFromArray:venues];</code> </pre><br>  to import the entire data array, or <br><br><pre> <code class="objectivec hljs">Venue *myVenue = [Venue MR_importFromObject:[venues objectAtIndex:<span class="hljs-number"><span class="hljs-number">0</span></span>]];</code> </pre><br>  to create a single object. <br><br>  At once I <b>‚Äôll</b> make a reservation that <b>MR_importFromArray</b> for some reason does not work (a <a href="https://github.com/magicalpanda/MagicalRecord/issues/180">ticket</a> on github) so I used the following code for import: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> *arr = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> array]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *venueDict <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> venues) { [arr addObject:[Venue MR_importFromObject:venueDict]]; } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.data = arr;</code> </pre><br><br>  Unfortunately, server responses do not always please us with their accuracy and the name of objects and relationships often do not correspond to the model.  This is where the UserInfo dictionary comes in, which each entity has, an attribute or a relationship.  It allows you to configure mapping for each of these objects. <br><br>  To reconfigure the attribute mapping, you need to add to this dictionary the pair 'mappedKeyName' - 'attribute name from JSON': <br><br><img src="https://habrastorage.org/storage2/1dd/028/b40/1dd028b407fa1aa7beebb66d4e1aeb24.png"><br><br>  Also, this mapping supports KVC, which is very useful if there is no desire to create nested entities in the model (we get rid of the Stats entity, we get access to the number of chekins): <br><br><img src="https://habrastorage.org/storage2/dea/00a/c8f/dea00ac8f864961bb073da5c5d61b132.png"><br><br>  Each object in the model should have something like primaryKey: MagicalImport will look for an attribute named objectNameID, or we can specify such an attribute in UserInfo (for example, the relationship between Location and Venue): <br><br><img src="https://habrastorage.org/storage2/f08/fc6/4ae/f08fc64ae90b3a4eeac5c923fe1b6214.png"><br><br>  I apologize for using lat as the 'primary key', naturally this was done just for the sake of example. <br><br><h4>  Import callbacks </h4><br>  The import mechanism provides callbacks that can be used to check / edit the processed data (implemented inside the NSManagedObject subclasses): <br><ul><li>  willImport: </li><li>  didImport: </li><li>  shouldImport'relationsName '(id) data: </li></ul><br><br>  For example, we will implement a check, based on which it will establish relationships only with those Location objects that contain the address: <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)shouldImportLocation:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)location { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *address = [location objectForKey:<span class="hljs-string"><span class="hljs-string">@"address"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> address ? <span class="hljs-literal"><span class="hljs-literal">YES</span></span> : <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; }</code> </pre><br><br><h4>  Conclusion </h4><br>  The considered example is trivial and therefore does not allow you to familiarize yourself with all the subtleties of MagicalImport (as well as the fact that there is no documentation on it yet), but it seems to me that it allows you to feel the advantages for which he thought: no extra code and flexibility when importing data. <br>  Test project can be found <a href="https://github.com/garnett/MagicalDataImportExample">here</a> .  (CocoaPods was used to connect MagicalRecord and <a href="http://cocoapods.org/">AFNetworking</a> ). </div><p>Source: <a href="https://habr.com/ru/post/145718/">https://habr.com/ru/post/145718/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145713/index.html">HowTo: Internet banking for legal entities using Aladdin eToken in Linux (Ubuntu)</a></li>
<li><a href="../145714/index.html">In what style do you name variables and functions in your projects?</a></li>
<li><a href="../145715/index.html">Samsung 300E5Z-A06 - a laptop with a matte screen for 11900 rubles</a></li>
<li><a href="../145716/index.html">Civilization 2: ten years without restarting</a></li>
<li><a href="../145717/index.html">Integrating an iOS Application With Evernote: First Steps</a></li>
<li><a href="../145719/index.html">The second meeting of the Microsoft .NET User Group in Gomel</a></li>
<li><a href="../145720/index.html">Cards in your project</a></li>
<li><a href="../145721/index.html">XEN Critical Vulnerability</a></li>
<li><a href="../145725/index.html">How to stay safe online and be able to protect personal data</a></li>
<li><a href="../145726/index.html">Installing the D-Link DWA-125 A3 driver in Debian Squeeze</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>