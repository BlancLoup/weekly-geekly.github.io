<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write a bot for MMORPG with assembler and draenei. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username%! And so, let's continue writing our bot. From past articles, we learned how to find the address of the intercepted function for DirectX ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write a bot for MMORPG with assembler and draenei. Part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/708/53f/a39/70853fa39f3f4d4f82bc6525a2ebc41f.png" align="left">  Hi% username%!  And so, let's continue writing our bot.  From past articles, we learned how to find the address of the intercepted function for DirectX 9 and 11, as well as execute arbitrary assembly code in the main stream of the game.  Naturally, all these operations can be seen defending the game and you will be punished.  But today, I will show you how to hide this code from protection, including from such a monster that everyone fears, like Warden.  As I said, I am not a bot driver because I was not caught.  Waiting for you under the cut! <a name="habracut"></a><br><br><h6>  <b>Disclaimer: The author is not responsible for your use of the knowledge gained in this article or damage as a result of their use.</b>  <b>All information here is for educational purposes only.</b>  <b>Especially for companies developing MMORPG, that would help them to fight with the bot.</b>  <b>And, of course, the author of the article is not a botmaster, not a cheater, and never was.</b> <br></h6><br><hr><br><br>  For those who missed past articles, here is the content, and who read everything, we go further: <br><h6>  <b>Content</b> </h6><br><ol><li>  <a href="http://habrahabr.ru/post/251137/">Part 0 - Search for a code injection point</a> </li><li>  <a href="http://habrahabr.ru/post/251149/">Part 1 - Implementing and executing third-party code</a> </li><li>  <a href="http://habrahabr.ru/post/251199/">Part 2 - Hide the code from prying eyes</a> </li><li>  <a href="http://habrahabr.ru/post/251353/">Part 3 - Under the gun World of Warcraft 5.4.x (Structures)</a> </li><li>  <a href="http://habrahabr.ru/post/251479/">Part 4 - Under the gun World of Warcraft 5.4.x (Moving)</a> </li><li>  Part 5 - Under the gun World of Warcraft 5.4.x (Casting Fireball) </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <b>1. Reasoning on the protection of games</b> </h5><br>  I would like to disperse the mystery clouds over anti-cheats, protectors and other protection accompanying the game.  Because there are not so many protection options and I will list the main ones: <br>  <u>1. Checking game files for originality</u> <br>  Everything is simple here, the game requests from the server the checksums of the game files and checks with those obtained as a result of the check.  In this case, you can simply modify the verification algorithm in the executable file.  But everything is much more complicated if the verification algorithm is also loaded from the server, as is the case with Warden. <br>  <u>2. Analysis of connected DLLs</u> <br>  In this case, you risk only using something popular, because  information about this, most likely already have the developers and as in the case of Valve Anti Cheat, unknown libraries are sent straight to the server for analysis, again, if you suspect.  So your ban can only be delayed indefinitely. <br>  <u>3. VMT analysis of imported libraries on traps</u> <br>  Everything is difficult here, you can get a ban even for TeamViwer or Fraps, if the game developers want it and you can‚Äôt prove anything.  And as <a href="http://habrahabr.ru/users/alexey2005/" class="user_link">Alexey2005</a> said in <a href="http://habrahabr.ru/post/251137/">Part 0 - Search for the code injection point</a> <br><blockquote>  The more paranoid the defense, the more false positives it has.  Because the process constantly breaks and introduces a huge pile of everything - all sorts of keystroke interceptors, antivirus scanners, various ‚Äúcontrol centers‚Äù for video and sound, input device settings like a mouse, etc. </blockquote><br>  <u>4. Protect game memory from read / write</u> <br>  This functionality has gaining popularity in Steam protection Easy Anti Cheat.  In Windows, the EasyAntiCheat service starts, which protects the memory of the game from reading and writing.  If the service is not running, then the game refuses to connect to the server and <b>I would like to hear reflections of the community about this</b> . <br>  <u>5. Checking certain parts of the game‚Äôs memory</u> <br>  This, again, deals with the well-known Warden.  Although to be honest, what she just does not do.  Warden loads memory check modules and a hash table from the server and compares values ‚Äã‚Äãwith a table.  In this way, it is easy to identify cheaters that modify the memory of a game to get advantages, such as increased speed, walking through the air and walls, and so on. <br>  <b>Total</b> <br>  From all of the above, it becomes clear that using popular programs and methods we run the risk of falling into a ban and to avoid this, we need to make our implementation difficult to determine.  What we now do.  First, let's write the GetFakeCommand and ObfuscateAsm methods: <br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetFakeCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { <span class="hljs-string"><span class="hljs-string">"mov edx, edx"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov edi, edi"</span></span>, <span class="hljs-string"><span class="hljs-string">"xchg ebp, ebp"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov esp, esp"</span></span>, <span class="hljs-string"><span class="hljs-string">"xchg esp, esp"</span></span>, <span class="hljs-string"><span class="hljs-string">"xchg edx, edx"</span></span>, <span class="hljs-string"><span class="hljs-string">"mov edi, edi"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num = Random.Int(<span class="hljs-number"><span class="hljs-number">0</span></span>, list.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> list[num]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IEnumerable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ObfuscateAsm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IList&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; asmLines</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = asmLines.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> k = Random.Int(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>); k &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>; k--) { asmLines.Insert(i, GetFakeCommand()); } } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = Random.Int(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>); j &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>; j--) { asmLines.Add(GetFakeCommand()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> asmLines; }</code> </pre> <br>  As you can see, GetFakeCommand returns an assembler command that does not change the state of registers and flags, and this list can be expanded if necessary several times, while ObfuscateAsm finds these commands in random places of our subroutine.  And so we modify the address substitution code from the previous article at the place where the <b>HookAddress is received</b> , I will not duplicate the entire code, but only show the changed part: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//     var RandomOffset = (uint)Random.Int(0, 60); var HookAddress = Memory.AllocateMemory(6000 + Random.Int(1, 2000)) + RandomOffset; //     Memory.Asm = new ManagedFasm(Memory.ProcessHandle); Memory.Asm.Clear(); foreach (var str in ObfuscateAsm(asmLine)) { Memory.Asm.AddLine(str); }</span></span></code> </pre><br>  The same trick can also be done with memory for argumentAddress1 and argumentAddress2.  Be sure to remember the value of <b>RandomOffset</b> for the case of freeing the memory <b>HookAddress</b> . <br><pre> <code class="cs hljs">Memory.FreeMemory(HookAddress - RandomOffset); Memory.FreeMemory(argumentAddress1 - RandomOffsetArgs1); Memory.FreeMemory(argumentAddress2 - RandomOffsetArgs2);</code> </pre><br>  And we will change the InjectAndExecute method and as promised, we will implement a queue for a multi-threaded method call: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InjectAndExecute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IEnumerable&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; asm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> returnValue = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> returnLength = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Locker) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> offset = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> randomValue = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)Random.Int(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    80/4 = 20  while (Memory.Read&lt;int&gt;(argumentAddress1 + offset) != 0 || Memory.Read&lt;int&gt;(argumentAddress2 + offset) != 0) { offset += 4; if (offset &gt;= 80) { offset = 0; } } Memory.Asm.Clear(); foreach (var str in asm) { for (var i = Random.Int(0, 3); i &gt;= 1; i--) { Memory.Asm.AddLine(ProtectHook()); } Memory.Asm.AddLine(str); } dwAddress = Memory.AllocateMemory(Memory.Asm.Assemble().Length + Random.Int(60, 80)) + randomValue; Memory.Asm.Inject(dwAddress); Memory.Write&lt;uint&gt;(argumentAddress1, dwAddress + offset); } while (Memory.Read&lt;int&gt;(argumentAddress1 + offset) &gt; 0) { Thread.Sleep(1); } byte[] result = new byte[0]; if (returnValue) { result = Memory.ReadBytes(Memory.Read&lt;uint&gt;(argumentAddress2 + offset), returnLength); } Memory.Write&lt;int&gt;(argumentAddress2 + offset, 0); Memory.FreeMemory(dwAddress - randomValue); return result; }</span></span></code> </pre><br>  In the first while cycle, we move in our queue and look for free space by the offset offset at the same time in two reserved addresses for the arguments, if not, we start from the beginning.  For masking, fake commands were added, and random offset and size for the allocated memory.  While this is all, I am waiting for your comments, tips and interesting decisions. </div><p>Source: <a href="https://habr.com/ru/post/251199/">https://habr.com/ru/post/251199/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251185/index.html">OData REST API and recursive queries</a></li>
<li><a href="../251189/index.html">Page caching in WordPress</a></li>
<li><a href="../251191/index.html">Review of the most interesting materials on data analysis and machine learning ‚Ññ36 (February 16 - 22, 2015)</a></li>
<li><a href="../251193/index.html">Naming complex actions in the REST API</a></li>
<li><a href="../251197/index.html">Weekly io.js, February 20, 2015</a></li>
<li><a href="../251205/index.html">Penguin talking</a></li>
<li><a href="../251207/index.html">About busting on the example of generating crosswords</a></li>
<li><a href="../251209/index.html">Ethical hacking and penetration testing courses. New set</a></li>
<li><a href="../251211/index.html">Objective-C Runtime for Si-Schnick. Part 3</a></li>
<li><a href="../251215/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ148 (February 16 - 22, 2015)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>