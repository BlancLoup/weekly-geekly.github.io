<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another smart outlet for another smart home</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For many years I dreamed of creating a smart home, but each time I stopped the problem of the connection of modules (sockets, sensors and switches) wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another smart outlet for another smart home</h1><div class="post__text post__text-html js-mediator-article">  For many years I dreamed of creating a smart home, but each time I stopped the problem of the connection of modules (sockets, sensors and switches) with the center and among themselves.  But progress does not stand still, more and more frequently encountered information about microcontrollers with built-in transceivers pushed me back to my old idea.  In this post I will talk about how to create a "smart socket" (actually a surge protector), which is presented in the photo below. <br><br><img src="https://habrastorage.org/files/780/d52/0be/780d520be92640d0940d4b99e0a3a9fa.jpg"><br><br>  Everything else is under the cut.  Caution!  A lot of pictures. <br><a name="habracut"></a><br><h4>  Foreword </h4><br>  First, I must say that in the city in which I now live, there is a very big problem with electronic components (resistors of 5p. Each, but we have never heard of microcontrollers here).  I have to order everything or ask my comrades to transfer me from more advanced places in this plan.  I hope this information will explain possible questions about the use of certain components.  This is not my first device and, thanks to the use of ready-made modules, the need to draw schemes has disappeared.  I present only the scheme of the triac key. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Components </h4><br>  I ordered wonderful modules with unsoldered nRF24LE1 from our beloved friends from heaven.  About this microcontroller has already been written a lot on Habr√© ( <a href="http://habrahabr.ru/company/coolrf/blog/195240/">here</a> , <a href="http://habrahabr.ru/post/215187/">and here</a> , and here again), and it really helped at the start. <br>  My modules, unlike most of those considered in Habr√©, are smaller in size and have PLS with a small step (by the way, the community can tell you how these pins are correctly named and where to get the mating part). <br><br><img src="https://habrastorage.org/files/6ab/372/99d/6ab37299df0c435184ab55c930676f9c.png"><br><br>  An ordinary, already tested by accountants and cleaners, a <s>surge protector</s> was chosen as the <s>martyr of the</s> modernized.  I rubbed it as much as I could, but there is some tiredness from constant kicking with my legs. <br><br><img src="https://habrastorage.org/files/c5d/fb4/d7c/c5dfb4d7cd5245f39472ea5bacdbe337.jpg"><br><br>  Similarly, the simistors BTA16 (600v, 16A) and the opto-simistors MOC3063 were ordered from the Middle Kingdom.  Partly was loose, partially bought. <br>  So, fight! <br><br><h4>  Development process </h4><br>  To begin with, I disassembled the power filter to understand if I had enough space. <br><br><img src="https://habrastorage.org/files/043/fab/e9a/043fabe9ab1c4de3808c28777c0abc17.jpg"><br>  Places <s>wagon and cart</s> missing. <br><br>  Next for the firmware nRF24LE1 decided to use the microUSB connector.  There are enough contacts, but you need to pull up the PROG input to the power supply in order to switch the micron to the programming mode.  I decided to do a simple jumper (which I had to make myself from heat shrinkage and wire). <br><br><img src="https://habrastorage.org/files/877/e49/914/877e49914bd84368877850ea0905987a.png"><br><br>  <i>Separate, great, thanks to the post from <a href="http://habrahabr.ru/post/210974/">MaksMS</a> , as well as to him personally.</i>  <i>The article and the correspondence with him greatly helped to start programming the nrf24le1, as well as to get the radio part.</i> <br><br>  So, the module responds to requests from the programmer (using USB ASP), go to the management of the power unit.  To control the triac decided to use the opto-triac MOC3063.  This microcircuit completely separates the power part from the low-voltage one, but there is one nuance.  The MOC3063 has a built-in 0-crossing (zero-cross) detector in the power supply network and sends an opening pulse to the triac itself, which in turn leads to the fact that we cannot dim the outlet, but I did not pursue this goal.  The wiring diagram is below: <br><br><img src="https://habrastorage.org/files/508/6f6/1f4/5086f61f4f814ef7af2fc067c444dd78.png"><br><br>  The scheme is simple, I think, no further explanation is necessary.  The only retreat, instead of the limiting resistor, was a green LED that will signal when the opacistor is turned on. <br>  According to the scheme assembled, small modules for 5 outlets (only 3 in the photo): <br><br><img src="https://habrastorage.org/files/7f0/925/97c/7f092597c4f944c4abf9410fd347f7f5.jpg"><br><br><img src="https://habrastorage.org/files/e7f/5a2/d02/e7f5a2d021be4f7b8f3cde4057f25e7f.jpg"><br><br>  Further, one of the lines in the network filter was cut in the indicated places, and from the cut-out gaps made jumpers on the ‚Äúnon-bonded‚Äù ends, so that when the plug was turned on they would not be strongly bent. <br><br><img src="https://habrastorage.org/files/850/3b6/1c1/8503b61c11114ae280f2a7fa87a81230.jpg"><br><br><img src="https://habrastorage.org/files/6b2/78f/668/6b278f6680a94c5297cf034276415661.jpg"><br><br>  Soldered the control outputs of the triac modules to the pins of the microcontroller module 0.2, 0.1, 0.0, 1.6, 1.5. <br>  5 yellow LEDs soldered to pins 0.7, 1.0, 1.1, 1.2, 1.3.  By pins 0.5, 0.6, I soldered green and red LEDs to indicate the operation of the module (command parsing, receiving or sending data). <br>  All this stuff is packaged in a network filter housing. <br><br><img src="https://habrastorage.org/files/910/34a/d0d/91034ad0d3f84cebbabd98b19351ba64.jpg"><br><br>  The triac modules fit perfectly in the gaps between the boxes for the plugs (in the photo they are green and gray wiring), under the modules there are green LEDs (in pre-drilled holes) in the opposite side from them, yellow LEDs are installed. <br>  From the left in the middle are the ends of the two LEDs of the micron state. <br>  Well, in the lower left corner you can see the radio itself with a hanging connector for programming.  <s>Wait, where is the vaunted microUSB !?</s>  At the time of the shooting, the microUSB cable that I had turned out to be too long and the programmer did not see the MK. <br><br>  Further, the biggest problem of the whole event: food for the microcontroller.  At first I wanted to make a capacitor power supply, but I did not find the necessary capacitors and a zener diode in the city, but there was no desire to order and wait.  I decided to use the power supply from charging for some phone. <br><br><img src="https://habrastorage.org/files/310/a05/5e8/310a055e8cf842c193475695b29c6940.jpg"><br><br>  He suffered for a long time with a block that was on top (with a red stripe), but it turned out that his optocoupler had burned down, and the zener diode on the block was extremely hot.  It was very dangerous to put such a thing, and I decided to use a block that is below (with a yellow stripe), although I had to leave one of the home devices without power. <br><br><img src="https://habrastorage.org/files/81d/c58/03c/81dc5803c22e48c5919b536e67a4c438.jpg"><br><br>  It is clear that the capacitor version would be much smaller, but the charging has a galvanic isolation, which allows in the future to bring a connector for programming outside the case. <br>  However, the unit fits perfectly into the filter housing, and the whole structure has the following appearance: <br><br><img src="https://habrastorage.org/files/663/9c8/b21/6639c8b21aa34cf782b78786947942f3.jpg"><br><br>  After assembly in working condition: <br><br><img src="https://habrastorage.org/files/780/d52/0be/780d520be92640d0940d4b99e0a3a9fa.jpg"><br><br><img src="https://habrastorage.org/files/691/93f/81f/69193f81f19948cab694a1742422d715.jpg"><br><br><h4>  Functional </h4><br>  Unfortunately, I can not yet post the firmware, because it is very confused.  It was written taking into account the work on the network with many devices, and there is a lot of superfluous in it.  If the community is interested <s>and I finally get an invite,</s> I will publish everything in the next post.  It should be noted that there is no tricky algorithm there.  It all comes down to simple jerking pins on / off.  No shima and so on.  Simple flashing of LEDs (power modules for MK - ordinary LEDs) <br><br>  The principle of operation is as follows: when receiving a packet from the server, the module determines what should be done with the selected outlet and turns it on or off.  In the off state, against the outlet, the yellow LED is on, in the on state, the green one is on. <br>  Then I made a very serious mistake, it was necessary to drill holes for LEDs perpendicular to the holes for the plug.  Since 80% of all power supplies that I found at home, either two LEDs or one of them close. <br><br><h5>  Little about the server </h5><br>  The server is the same nRF24LE1 module, connected via USB-UART converter to a PC, from which other devices on the network are controlled via a Java application.  Photo below <br><br><img src="https://habrastorage.org/files/eee/54a/b7f/eee54ab7ffa74895b816050741bf3df3.jpg"><br><br><h4>  Conclusion </h4><br>  The network filter is already working for the benefit of my home.  The software is still raw and it makes no sense to show it <s>and blush</s> . <br>  To those who are going to repeat this miracle, I can send a lightweight version of the firmware and server, as well as give a couple of tips: <br><ul><li>  The LEDs should be installed perpendicularly, and for those specially provided with plexiglass, I recommend making a luminous stroke.  Will be cool! </li><li>  The radio module itself should be installed in the opposite direction from the voltage input.  The interference is less, and more space. </li><li>  Use short microUSB </li><li>  It is necessary to add the function of maintaining the state of pins when power is off.  I myself plan to do this in the new firmware version </li></ul><br><br>  Special thanks to Associate Professor Yuri Ivanovich Ivanov (Kaf. SAU, SFU) for help in the development of capacitor and other types of power supplies.  Although they are not in this project, I will apply them in the following, and I will definitely tell you about this if the community approves this post. <br><br>  I expect critics <s>and better praise</s> and suggestions for improving the design. <br><br><h5>  Required documentation </h5><br>  <a href="http://www.nordicsemi.com/eng/content/download/2443/29442/file/nRF24LE1_Product_Specification_rev1_6.pdf">Datasheet on nRF24LE1</a> <br>  <a href="http://pdf1.alldatasheet.com/datasheet-pdf/view/22039/STMICROELECTRONICS/BTA16.html">Datasheet on BTA16</a> <br>  <a href="http://pdf1.alldatasheet.com/datasheet-pdf/view/85581/ETC/MOC3063.html">Datasheet on MOC3063</a> <br>  <a href="http://eugenemcu.ru/publ/10-1-0-58">The control circuit of the power load with a more detailed description</a> </div><p>Source: <a href="https://habr.com/ru/post/221247/">https://habr.com/ru/post/221247/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../221229/index.html">Spying Math: Punishment for Spyware</a></li>
<li><a href="../221231/index.html">Windows internals. The second volume is on sale!</a></li>
<li><a href="../221239/index.html">High-precision active controlled copy of the human body. The concept of prototyping an artificial mechanostat system</a></li>
<li><a href="../221243/index.html">How to understand NullPointerException</a></li>
<li><a href="../221245/index.html">"Brakes" and lags in real life</a></li>
<li><a href="../221249/index.html">Documenting is a separate item of project revenue.</a></li>
<li><a href="../221251/index.html">VK Friendly Link Analysis with Python</a></li>
<li><a href="../221253/index.html">How do we build a small radio station in a large network</a></li>
<li><a href="../221257/index.html">Three universal filters for designing user friendly directory structures</a></li>
<li><a href="../221259/index.html">Testing individual symfony 2 bundles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>