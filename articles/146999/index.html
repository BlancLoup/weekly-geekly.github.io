<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sphinx: delta indexes and multiple search servers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="More or less big project sooner or later comes to the need for full-text content search. 
 For this purpose, the search engine Sphinx was invented. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sphinx: delta indexes and multiple search servers</h1><div class="post__text post__text-html js-mediator-article">  More or less big project sooner or later comes to the need for full-text content search. <br>  For this purpose, the search engine <a href="http://sphinxsearch.com/">Sphinx</a> was invented. <br><br>  When the base becomes large or the indexes a lot of reindexing begins to take quite a long time, which can have various negative consequences for the project.  At this point, it is worth thinking about using <a href="http://sphinxsearch.com/docs/current.html">delta indexes</a> . <br>  The author was faced with this need at the moment when the reindexing began to take more than an hour. <br><a name="habracut"></a><br>  But this is all described in detail in the documentation and is done quite simply: <br><pre><code class="hljs pgsql">source src_mysql { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = mysql sql_host = localhost sql_user = sphinx sql_pass = secret sql_range_step = <span class="hljs-number"><span class="hljs-number">1000</span></span> } source src_news : src_mysql { sql_db = project sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET NAMES</span></span> utf8 sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-type"><span class="hljs-type">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 sql_query_pre = REPLACE <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> sph_counter <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'src_news'</span></span>, MAX(id) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news sql_query_range = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MIN(id), MAX(id) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> news_id, title, content <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id&gt;=$<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> id&lt;=$<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> } source src_news_delta : src_news { sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET NAMES</span></span> utf8 sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-type"><span class="hljs-type">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 sql_query_range = sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> news_id title, content <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news \ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id &gt; ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> max_value <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sph_counter <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> source = <span class="hljs-string"><span class="hljs-string">'src_news'</span></span>) sql_query_post = REPLACE <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> sph_counter <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'src_news'</span></span>, MAX(id) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news }</code> </pre> <br><br>  Now consider the case when there are several indexing servers.  There may be several reasons for this, but a problem appears: one server, after indexing, rewrites the value of the last ID in the database.  When starting indexing on the next server, the records indexed by the previous server will not be included in the selection.  There are "gaps" in the indices and search results will be constantly different, and random results will be missed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>What to do?</b> <br><br>  It is necessary in the <strong>sph_counter</strong> table <strong>to</strong> additionally store the ID of the indexing server. <br><br>  Add a hostname column. <br><br>  As a result, the table will have the following form: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`sph_counter`</span></span> ( <span class="hljs-string"><span class="hljs-string">`source`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`max_value`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`hostname`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`source`</span></span>,<span class="hljs-string"><span class="hljs-string">`hostname`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre><br>  * <strong><i>Pay attention to the index, it is necessary for the correct operation of the REPLACE INTO</i></strong> <br><br>  Further, depending on your configuration option 2: <br><br><h5>  1. The Sphinx process runs on the same server as the database, master-master replication is configured </h5><br>  In this situation, the problem is solved quite simply: use the global variable MySQL - <b>'hostname'</b> <br>  Our configuration takes the following form: <br><pre> <code class="hljs pgsql">source src_news : src_mysql { sql_db = project sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET NAMES</span></span> utf8 sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-type"><span class="hljs-type">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 sql_query_pre = REPLACE <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> sph_counter <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'src_news'</span></span>, MAX(id), @@hostname <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news sql_query_range = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MIN(id), MAX(id) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> news_id, title, content <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id&gt;=$<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> id&lt;=$<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> } source src_news_delta : src_news { sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET NAMES</span></span> utf8 sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-type"><span class="hljs-type">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 sql_query_range = sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> news_id, title, content <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news \ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id &gt; ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> max_value <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sph_counter <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> source = <span class="hljs-string"><span class="hljs-string">'src_news'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> hostname = @@hostname) sql_query_post = REPLACE <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> sph_counter <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'src_news'</span></span>, MAX(id), @@hostname <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news }</code> </pre><br><br><h5>  2. MySQL and Sphinx servers are different, requests go to master </h5><br>  In such a situation, using the global <b>hostname</b> variable no longer works - we will always get the name of the server on which the database is running. <br><br>  <b>Output:</b> we will use the connection information and user variables. <br><br><pre> <code class="hljs pgsql">source src_news : src_mysql { sql_db = project sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET NAMES</span></span> utf8 sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-type"><span class="hljs-type">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @sphinx_instance:=<span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(STRCMP(@sphinx_host:=SUBSTRING_INDEX(host,<span class="hljs-string"><span class="hljs-string">':'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>),<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>),@sphinx_host,@@hostname) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> sphinx_instance \ <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> information_schema.processlist <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ID=connection_id(); sql_query_pre = REPLACE <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> sph_counter <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'src_news'</span></span>, MAX(id), @sphinx_instance <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news sql_query_range = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MIN(id), MAX(id) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> news_id, title, content <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id&gt;=$<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> id&lt;=$<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> } source src_news_delta : src_news { sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET NAMES</span></span> utf8 sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-type"><span class="hljs-type">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @sphinx_instance:=<span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(STRCMP(@sphinx_host:=SUBSTRING_INDEX(host,<span class="hljs-string"><span class="hljs-string">':'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>),<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>),@sphinx_host,@@hostname) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> sphinx_instance \ <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> information_schema.processlist <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ID=connection_id(); sql_query_pre = REPLACE <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> sph_counter <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'src_news'</span></span>, MAX(id), @sphinx_instance <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news sql_query_range = sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> news_id, title, content <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news \ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id &gt; ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> max_value <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sph_counter <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> source = <span class="hljs-string"><span class="hljs-string">'src_news'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> hostname = @sphinx_instance) sql_query_post = REPLACE <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> sph_counter <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'src_news'</span></span>, MAX(id), @sphinx_instance <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> news }</code> </pre><br><br>  This configuration will work in both cases. </div><p>Source: <a href="https://habr.com/ru/post/146999/">https://habr.com/ru/post/146999/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146989/index.html">What paper periodicals do you read,%% username?</a></li>
<li><a href="../146990/index.html">Scalaxi again offers to go somewhere ...</a></li>
<li><a href="../146991/index.html">Up to Windows 8 you can upgrade for $ 39.99</a></li>
<li><a href="../146993/index.html">Using OpenCL in Python</a></li>
<li><a href="../146997/index.html">Do you plan to upgrade from Windows 7 to Windows 8?</a></li>
<li><a href="../147000/index.html">Five ways to find an interesting task.</a></li>
<li><a href="../147002/index.html">Blizzard bans Diablo III players for using Wine</a></li>
<li><a href="../147003/index.html">20 commandments of user interface design</a></li>
<li><a href="../147004/index.html">Tale of CPA-Typesquatter</a></li>
<li><a href="../147007/index.html">A digital startup program is just the beginning. Interview with Arkady Moreynis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>