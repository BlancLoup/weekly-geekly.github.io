<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I inserted Java 7 into a running application, and what I had to invent for a C runtime</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once, in the icy winter season, one old C ++ application that had worked successfully for years had to insert a new Java runtime 7 instead of a well-r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I inserted Java 7 into a running application, and what I had to invent for a C runtime</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/9b8/795/a1c/9b8795a1c469f0c1dfecd735ea8ffb41.png" alt="image" align="left"><br><br>  Once, in the icy winter season, one old C ++ application that had worked successfully for years had to insert a new Java runtime 7 instead of a well-run Java 6. Nothing boded, and suddenly. <br><br>  The code is, in general, obvious and simple - a little JNI <s>, and here it is - a bad tooth</s> .  I will give the code only for Windows, because  Equilibrism miracles under poppy are not required. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h4>  How it was </h4><br>  Once, many years ago, we created a simple DLL linked to jvm.dll in the standard way, exported two and a half functions in it, and ‚Äúpulled‚Äù it dynamically.  This trick with ears is obvious - we still have to find where Java itself is located.  This simple proxy was called something like this. <br><br><pre><code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">bool</span></span> <span class="hljs-type"><span class="hljs-type">LoadJavaEngine</span></span>(<span class="hljs-type"><span class="hljs-type">HANDLE</span></span>&amp; engHandle) { bool loadResult = false; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { ... // here we have auto variables, nothing interesting // first we need to find java <span class="hljs-type"><span class="hljs-type">CRegKey</span></span> rk; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rk.<span class="hljs-type"><span class="hljs-type">Open</span></span>(<span class="hljs-type"><span class="hljs-type">HKEY_LOCAL_MACHINE</span></span>, <span class="hljs-type"><span class="hljs-type">L</span></span><span class="hljs-string"><span class="hljs-string">"SOFTWARE\\JavaSoft\\Java Runtime Environment\\1.6"</span></span>, <span class="hljs-type"><span class="hljs-type">KEY_QUERY_VALUE</span></span>) != <span class="hljs-type"><span class="hljs-type">ERROR_SUCCESS</span></span> || rk.<span class="hljs-type"><span class="hljs-type">QueryValue</span></span>(strBuf, <span class="hljs-type"><span class="hljs-type">L</span></span><span class="hljs-string"><span class="hljs-string">"RuntimeLib"</span></span>, &amp;strBufSz) != <span class="hljs-type"><span class="hljs-type">ERROR_SUCCESS</span></span>) break; <span class="hljs-type"><span class="hljs-type">WCHAR</span></span>* backslashAddr = wcsrchr(strBuf, <span class="hljs-type"><span class="hljs-type">L'</span></span>\\'); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(backslashAddr) <span class="hljs-type"><span class="hljs-type">BufLen</span></span> = backslashAddr - strBuf; strBuf[<span class="hljs-type"><span class="hljs-type">BufLen</span></span>] = <span class="hljs-type"><span class="hljs-type">L'</span></span>\<span class="hljs-number"><span class="hljs-number">0</span></span>'; // now <span class="hljs-type"><span class="hljs-type">C</span></span> runtime knows <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> is <span class="hljs-keyword"><span class="hljs-keyword">jvm</span></span>.dll located retnPWD = <span class="hljs-type"><span class="hljs-type">SetDllDirectoryW</span></span>(strBuf); // ... nothing intersting - <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the same manner we're looking for our proxy path <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> registry <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((engHandle = <span class="hljs-type"><span class="hljs-type">LoadLibrary</span></span>(strBuf))==<span class="hljs-type"><span class="hljs-type">NULL</span></span>) break; // now try to initialize <span class="hljs-type"><span class="hljs-type">JVM</span></span> by calling our proxy linked with <span class="hljs-keyword"><span class="hljs-keyword">jvm</span></span>.dll <span class="hljs-type"><span class="hljs-type">CreateJavaVMFunPtr</span></span> <span class="hljs-type"><span class="hljs-type">CreateJavaVM</span></span> = (<span class="hljs-type"><span class="hljs-type">CreateJavaVMFunPtr</span></span>)<span class="hljs-type"><span class="hljs-type">GetProcAddress</span></span>(engHandle, <span class="hljs-string"><span class="hljs-string">"CreateJavaVM"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-type"><span class="hljs-type">CreateJavaVM</span></span>) loadResult = <span class="hljs-type"><span class="hljs-type">CreateJavaVM</span></span>(needJNIProxy); } while(false); return loadResult; }</code> </pre> <br><br><h4>  Unexpected rake out of the blue </h4><br>  As you can see, the code is extremely simple and in general it occupies as many as three lines. <br><br><pre> <code class="cpp hljs"> SetDllDirectory LoadLibrary GetProcAddress</code> </pre><br><br>  And now - complicate.  From Java 6 we turn to Java 7. The optimistic forecast was like that - we‚Äôll change one line and everything works. <br><br>  Change <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rk.Open(HKEY_LOCAL_MACHINE, <span class="hljs-string"><span class="hljs-string">L"SOFTWARE\\JavaSoft\\Java Runtime Environment\\1.6"</span></span>,</code> </pre><br>  on <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rk.Open(HKEY_LOCAL_MACHINE, <span class="hljs-string"><span class="hljs-string">L"SOFTWARE\\JavaSoft\\Java Runtime Environment\\1.7"</span></span>,</code> </pre><br>  and <s>comes the famous Lithuanian holiday "oblomaitis"</s> Path not found.  Do not want to download our simple proxy. <br><br><h4>  Telepathy session </h4><br>  During the one and a half hour proceedings, it turned out: <br><br><ol><li>  The previous version of the main program and our plugin on java for it were compiled by visual studios from 2003 to 2008 (MSVCR80.dll, MSVCR90.dll, etc.), and Java 6, respectively, with a rare book with MSVCR71.dll. </li><li>  New Java compiled using MSVCR100.dll (yeah, yeah).  And the version of the program at the customer - uses MSVCR90.dll.  That does not load. </li></ol><br><br>  Googling options did not give - prescribing and deleting manifests gave zero to the mass with the same result. <br><br><h4>  Rumor on a tambourine </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/f16/ab8/45f/f16ab845f900189f6fc4ea61ad372833.png" alt="image" align="right"><br>  And then a large file was pulled out of his pocket, and they gave birth to <s>another monster of</s> props.  And instead of one SetDllDirectory, this is what happened: <br><br><pre> <code class="cpp hljs"> wcscat(strBuf, <span class="hljs-string"><span class="hljs-string">L"\\msvcr100.dll"</span></span>); test = LoadLibraryW(strBuf); strBuf[BufLen] = L'\<span class="hljs-number"><span class="hljs-number">0'</span></span>; wcscat(strBuf, <span class="hljs-string"><span class="hljs-string">L"\\client\\jvm.dll"</span></span>); test = LoadLibraryW(strBuf); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(test == <span class="hljs-number"><span class="hljs-number">0</span></span>) { strBuf[BufLen] = L'\<span class="hljs-number"><span class="hljs-number">0'</span></span>; wcscat(strBuf, <span class="hljs-string"><span class="hljs-string">L"\\server\\jvm.dll"</span></span>); test = LoadLibraryW(strBuf); } strBuf[BufLen] = L'\<span class="hljs-number"><span class="hljs-number">0'</span></span>; retnPWD = SetDllDirectoryW(strBuf);</code> </pre><br>  That is, if you load dependencies from MSVCR100.dll with your hands, it finds and works.  Otherwise, alas. <br><br>  Disclaimer: the option ‚Äúyou put a newer version for the customer‚Äù is not appropriate.  The main application is Adobe InDesign Server CS5, for $ 7k per license. <br><br>  Details about the barbed wire can be found in previous publications on the topic. <br><br>  <a href="http://habrahabr.ru/post/122746/">http://habrahabr.ru/post/122746/</a> <br>  <a href="http://habrahabr.ru/post/127574/">http://habrahabr.ru/post/127574/</a> </div><p>Source: <a href="https://habr.com/ru/post/148068/">https://habr.com/ru/post/148068/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148055/index.html">Fotker - comfortable viewing Yandex. Stock</a></li>
<li><a href="../148058/index.html">Now you can blur faces on Youtube</a></li>
<li><a href="../148060/index.html">Photos of the earliest prototype Apple iPad</a></li>
<li><a href="../148063/index.html">VK Cup 2012 - how it was</a></li>
<li><a href="../148067/index.html">I'll just leave it here</a></li>
<li><a href="../148070/index.html">Travel to Antarctica on Street View</a></li>
<li><a href="../148072/index.html">HTC HD2 received unofficial firmware Android 4.1 Jelly Bean</a></li>
<li><a href="../148074/index.html">Competition to the day of the sysadmin</a></li>
<li><a href="../148075/index.html">Google Chrome and LEGO</a></li>
<li><a href="../148076/index.html">Entertaining functional programming in Ruby</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>