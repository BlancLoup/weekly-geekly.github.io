<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementation of the program code for the display module on ILI9341 + STM32. Part 4.2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 1 
 Part 2 
 Part 3 
 Part 4.1 

 Prologue 
 Opinions were different about the analysis of the code and its necessity in general. In this article...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementation of the program code for the display module on ILI9341 + STM32. Part 4.2</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://geektimes.ru/post/267682/">Part 1</a> <br>  <a href="http://geektimes.ru/post/267712/">Part 2</a> <br>  <a href="http://geektimes.ru/post/267812/">Part 3</a> <br>  <a href="http://geektimes.ru/post/267986/">Part 4.1</a> <br><br><h4>  <b>Prologue</b> </h4><br>  Opinions were different about the analysis of the code and its necessity in general.  In this article I tried to implement the ‚Äúgolden section‚Äù method, <i><u>therefore:</u></i> <br>  a) at the end of the article the source code will be attached to the <s>experts not to read further</s> <br>  b) I will give the algorithm of work and analyze it <br>  c) explain how to use SPL libraries <br>  d) in the volume of the article I will tell you how to use a certain periphery, I will show the implementation of working with it in the code <br>  e) I will describe in a separate paragraph work with ILI9341, since  the topic is quite chewed up, then I‚Äôll just tell you about the main thing - how to think about implementing the initialization function (on the Internet I saw only a code with the phrase: ‚Äúhere‚Äôs the initialization, copy and don‚Äôt think about it‚Äù) and run it through hardware SPI. <br><br>  <u>Too detailed analysis of the code you will not see here,</u> everything will be in moderation, otherwise I will have to write a book of pages in 200-250.  Therefore, study datasheets and other documentation ( <i>links will be</i> ) before you start writing a program.  Those who sit for the first time in the MK - do not be afraid if I have any questions, I will tell you and help, so you will master this code. <br><a name="habracut"></a><br><h4>  <b>What is the development environment and is it possible to make life easier for libraries?</b> </h4><br>  <i>I will say right away</i> - the <u>code in this article is not ‚Äúnative‚Äù, but it has been tested and it works!</u>  Since  IAR is not the most convenient software for newbies, and somehow many people bypass it because of too much functionality or even some other reasons, it was decided for the educational article to move the project to ‚Äúcoconut‚Äù ( <b><i>CooCoxIDE 1.7.7</i></b> ).  I also decided to move away from the registers and write the code in <i>SPL.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <u><i>SPL</i></u> - is the standard library from ST to work with the periphery of the MK STM32.  Now the replacement came new libraries HAL, but so far they have not supplanted the first in many projects.  You can deduct advantages and advantages in Google. <br>  I chose <i>SPL</i> - because  I like the final code more after the ‚Äúhard optimization‚Äù, they are more intuitive, HAL is more adapted to work with various <i>RTOS.</i>  This is purely my opinion, I do not ask anyone to take it on faith and tell in the comments that it is better or worse, not worth it. <br><br>  As I wrote above - there was a transition from registers to libraries, what is the difference: <br><br><h6>  <u>Pros:</u> </h6>  a) readability of code written using SPL is simply excellent, and in articles with a bias for learning this is the most important thing; <br>  b) the speed of writing the code is much higher, it took me 1.5 hours to write the code from scratch for the existing algorithm and debug it; <br>  c) easier moving from stone to stone, well, suddenly you do not have STM32F103RBT6, but there is STM32F105VCT6 and you will be collecting on it. <br><br><h6>  <u>Minuses:</u> </h6>  a) SPL functions are more cumbersome and take up more memory, and also take longer to execute.  <b>But this applies only to the initialization functions, everything else has the same speed;</b> <br>  b) in datasheets, all parsing is done on registers and this is the main disadvantage. <br><br><h5>  <i><u>My result:</u></i> </h5>  <i>You can safely work in CoIDE and write programs using SPL exactly to the level while you consider yourself an amateur.</i>  <i>As soon as you have a goal to design serious devices or start making money with electronics - immediately transfer to IAR and smoke datasheets with their registers.</i> <br><br><h4>  <b>We make the algorithm of our program</b> </h4><br>  <u><i>To begin, let's figure out the <s>hell to the nose of the</s> overall functional structure of the device:</i></u> <br><br><img src="https://habrastorage.org/files/429/c11/a77/429c11a7793b437cbb35d0f83f822695.jpg"><br>  Figure 1 - Flowchart for the control program <br><br>  Now we can see what our part of the device should measure and how to deal with the data obtained.  All measured voltages and currents should be output to the TFT panel, whether the voltage falls within the normal range ( <i>according to GOST</i> ), and at the end multiply the output current with the output voltage and obtain the power consumption of the load.  It seems that everything is simple and clear. <br>  Also, our board should measure the temperature, display it on the screen, in case of emergency, <b>85 <sup>o</sup> C</b> should <i>turn off the device</i> by filing a <i>log.</i>  <i>1</i> on the feet of the <b>SD</b> driver <i>IR2110</i> in the power boards.  As well as according to the results of the measured temperature, the value of the duty ratio of the PWM controlling the coolers should be regulated. <br>  All alarm conditions should also be displayed on the LED display, which is used to display <s><i>"serious things"</i></s> system problems or device failure. <br>  The functionality of this unit is not complicated, and therefore it will not be difficult to implement it. <br><br><h4>  <b>What needs to be done before continuing to study the article?</b> </h4><br>  1) <u>Download the software with which we will work.</u>  This will be <b>CooCoxIDE 1.7.7</b> , below I have attached a reference to my poison, where you can download the folder with this version of the program, already with <i>SPL</i> installed in it, as well as with the already downloaded compiler so that you don‚Äôt suffer and do not search.  Everything to start work there is: <br>  <a href="https://yadi.sk/d/yjRAx1iHmVMfd">CooCoxIDE 1.7.7</a> <br><br>  2) Download the <b>holy manuscript</b> called datashit on <u><i>STM32F103</i></u> : <br>  <a href="https://yadi.sk/i/3GZ00dwrmWTFj">Datasheet STM32F103</a> <br><br>  3) Download at least a <i>scripture</i> called reference manual, which is Googleed as <b>RM0008</b> and has an epic volume of 1128 pages.  This is the most extensive scientific writing that I have mastered, although there were still all volumes of Landau-Livshits, but there are several books all the same ... I‚Äôm for something - I advise you to refer to this file with any misunderstandings and curiosities. <br>  <a href="https://yadi.sk/i/tqS3MGmEmWUb5">RM0008</a> <br><br>  4) Another very strongly I advise the blog of one boy with a level of knowledge of ST - God, he has there chewed a periphery for beginners and quite complex and interesting tasks: <br>  <a href="http://catethysis.ru/">Nikolay Gorbunov</a> <br><br>  5) And the last ... run to download a very useful program <b>STM32CubeMX</b> - <a href="http://www.st.com/web/en/catalog/tools/PF259242">Official site ST</a> <br><br>  I hope you downloaded everything that I advised you and now you can start writing the program. <br><br><h4>  <b>We collect the project</b> </h4><br><h6>  <u>1) We choose the periphery with which we have to work</u> </h6><br><img src="https://habrastorage.org/files/f42/ff7/e8c/f42ff7e8c2294b0794184837aa833066.JPG"><br>  Figure 2 - A repository for selecting the periphery that we will use <br><br>  <i>Now briefly who and for what answers:</i> <br><br>  a) <b>CMSIS core</b> - first of all we tick on this library, several more libraries will be connected immediately.  This is the minimum you can work with.  This library, as its name implies, connects the ‚Äúcore‚Äù, the basic functions through which the rest of the peripherals will work <br><br>  b) The <b>RCC</b> is the library responsible for the clocking of the microcontroller, this is a separate tricky moment that I will consider today.  This library allows you to select the source of generation, as well as set the frequency division factor for each periphery. <br><br>  c) <b>GPIO</b> - library of work with input / output ports.  It also allows you to carry out all the initial settings for the rest of the periphery. <br><br>  d) <b>DMA</b> - this library allows you to work with direct memory access.  This can be read in great detail on the Internet - the topic is chewed, for beginners it is enough to understand that this principle allows increasing the speed of the entire device. <br><br>  e) <b>SPI</b> - a library for working with the <i>SPI</i> interface, which allows you to exchange data with a bunch of devices.  In our case, through it we communicate with the <i>TFT</i> screen on the <i>ILI9341</i> . <br><br>  f) <b>TIM</b> - a library for working with a timer.  Here I think everything is clear, it will allow us to run <i>PWM</i> to control the coolers and of course to implement delays and generate interrupts. <br><br>  g) <b>ADC</b> is a library for working with our main periphery with an <i>analog-to-digital converter</i> (ADC), which measures all of our voltages and currents. <br><br><h4>  <b>We proceed to writing the program.</b> </h4><br>  I was not going to give lessons on <b>C</b> , but since I am guided by an audience of people who were afraid to take up studying MK and I want to push them, I will describe the main points.  The first 2 teams: <br><br>  1) <b>define</b> is a command that serves to substitute one value instead of another.  Half here did not understand, as I did when I studied) <br><br>  <u>Example 1:</u> <br><br>  We have a program that lights the LED with the team <b>GPIO_SetBits (GPIOA, GPIO_Pin_1);</b>  and turns it off with the command <b>GPIO_ResetBits (GPIOA, GPIO_Pin_1);</b>  .  Now you do not need to think about these commands.  As you can see, the command is quite complicated and in the process of writing the code you don‚Äôt want to rewrite it 100 times, and even more so you don‚Äôt want to remember how to turn on / off the LED every time.  Therefore, we proceed as follows, we write: <br><br><pre><code class="hljs lisp">#define LED_ON GPIO_SetBits(<span class="hljs-name"><span class="hljs-name">GPIOA</span></span>, GPIO_Pin_1) #define LED_OFF GPIO_ResetBits(<span class="hljs-name"><span class="hljs-name">GPIOA</span></span>, GPIO_Pin_1)</code> </pre> <br><br>  What have we done?  And simplify your life.  Now every time we write in the text of the program <b>LED_ON;</b>  ( <u><i>semicolon is required</i></u> ), then this phrase will be replaced with the <b>GPIO_SetBits</b> command <b>(GPIOA, GPIO_Pin_1);</b>  The same with shutdown. <br><br>  <u>Example 2:</u> <br><br>  You write a program that counts the days of the year.  In order not to write the number <b>365</b> in the program each time (and in fact there can be any complex number, even though Pi), we act like the previous example and write: <br><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> Year 365</span></span></code> </pre><br><br>  It is worth noting that since <b>365 is</b> just a constant and not a command, there is no need to put a semicolon after it.  Otherwise, it will insert not <b>365</b> , but <b>365;</b>  and when used in the same formula will be perceived as an error. <br><br>  <u><i>The <b>#define X1 Y2</b> command simply replaces all X1 with Y2 in the code.</i></u> <br><br>  I hope there are no questions left and go to a simpler, but perhaps the most important team: <br><br>  2) <b>include</b> - it allows us to attach other files and libraries to our code. <br><br>  <u>Example 1:</u> <br><br>  Any code, including ours, will begin with this command!  We selected library ticks in the repository and Coconut took and copied the files with libraries into the folder with our project.  This is not enough, we need to attach them in our <i>main</i> file <i>.</i> <br>  I have not yet begun to attach all the libraries, ADCs, timers, etc. that we mentioned above and did not add here.  Attached the main library, so at this stage not to bother.  <i>We get this code:</i> <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x_conf.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x_rcc.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x_gpio.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x_spi.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"TFT ILI9341.h"</span></span></span></span></code> </pre><br><br>  To understand where we got this incomprehensible file, you need to look into the project tree: <br><img src="https://habrastorage.org/files/41e/307/e22/41e307e22d8946f3ae170da67f74e300.JPG"><br>  Figure 3 - Project Tree with Required Libraries <br><br>  As you can see, all that we have attached is in this "tree".  This is a library of CMSIS and others.  Here you should pay attention to four points: <br><br>  a) I think the moment with the connection is clear, but I will clarify - <b>#include the ‚Äúfile name‚Äù</b> This is how you should include the file, indicating its name in brackets and do not put a semicolon at the end of the line. <br><br>  b) if you noticed, then I connect only files with the extension <b>.h</b> , you should always do this way.  What is the difference between a file with a <b>.h</b> extension and a file with a <b>.c</b> extension <b>?</b> <br><br>  c) there are 2 files when using <i>SPL</i> libraries, which are always connected to <i>main</i> . <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x_conf.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x.h"</span></span></span></span></code> </pre><br><br>  d) apparently the file <b>font.h</b> I did not connect to the main file <b>main</b> , since  I have it connected in the <b>TFT</b> library file <b>ILI9341.h</b> Why is that?  FONT is a library with fonts and is used only in the functions of working with the TFT panel.  In order not to clutter up the main file, I attached fonts using <b>#include</b> inside the <i>TFT</i> file <i>ILI9341.h</i> . <br><br>  3) <b>Differences between .h and .c files</b> <br><br>  Any decent library consists of two files, one of them has the <b>.c</b> permission. This file contains all the functions and their implementations.  The file with this extension is the main one for the <b>.h</b> file and therefore is attached inside the latter. <br>  The second part of the library file <b>.h</b> contains just all the necessary inclusions, such as <i>FONT</i> for <i>TFT ILI9341</i> .  It also describes all <i>define</i> , declared constants.  To work with this library, as you saw above, we include this particular file, and the <i>.c</i> file comes as a ‚Äútail‚Äù inside <i>.h</i> <br><br>  Fuh ... everything, if your brain doesn‚Äôt explode, then just relax, have some tea and go on for the most interesting. <br><br><hr><br><br><h4>  <b>Clocking microcontrollers STM32</b> </h4><br><br>  Getting to the most responsible and cunning item.  Clocking <i>STM</i> ok is not like AVR and peaks.  There, the frequency of quartz is simply taken and chased into stone. <br><br>  <i>The STM32 is done like this:</i> <br><br>  a) MK always starts from <i>HSI</i> - this is an internal 8 MHz oscillator <br>  b) Then the MK switches to <i>HSE</i> - this is an external quartz resonator <br>  c) Next, the signal goes to the PLL, where the frequency is multiplied and goes to the periphery. <br><br>  It is because of the last point, when I switched to STMs, I had a stupor: I connected the quartz to 8 MHz, and everything works at 72 MHz.  Therefore, typical quartz is 8, 16, 24 MHz.  Further, the frequency is multiplied inside the microcontroller. <br>  All this can be seen in the following diagram from the datasheet, it is on page 14. That is why I included this manuscript in the mandatory) <br><br><img src="https://habrastorage.org/files/b38/5d0/01a/b385d001a28a46e98e1fab0afa8cdb3d.JPG"><br>  Figure 4 - The timing scheme of the periphery of the microcontroller STM32 <br><br>  I also ask you to note that when the clock frequency is taken from the <i>PLL</i> (frequency multiplier) and then distributed around the periphery and set using a divider.  There are two buses: <i>APB2</i> and <i>APB1</i> , on each hanging a certain periphery.  Each bus has a frequency limit: 72 MHz for APB2 and 36 MHz for APB1, that is, on the 1st bus, the frequency is equal to <i>1/2</i> of the clock frequency with <i>PLL</i> . <br><br>  <u>Let me give an example:</u> with <i>SPI1, the</i> power comes from the APB2 bus with a maximum frequency of 72 MHz, and the <i>SPI2</i> hangs on the APB1 bus with a frequency of 36 MHz and this means that the SPI2 speed will be lower.  <u>It is worth considering!</u> <br><br>  Now let's turn to the function that performs all the tire settings.  The <b>RCC</b> library is responsible for clocking, so the function should be searched for in the <b>stm32f10x_rcc.h</b> file, which we connected to our project at the very beginning. <br><br><pre> <code class="hljs ruby">void RCC_Configuration(void) { RCC_DeInit(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   reset RCC_HSEConfig(RCC_HSE_ON); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   HSE ( ) HSEStartUpStatus = RCC_WaitForHSEStartUp(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HSEStartUpStatus == SUCCESS) /<span class="hljs-regexp"><span class="hljs-regexp">/   ,     { RCC_HCLKConfig(RCC_SYSCLK_Div1); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    1 (Div1),    72  RCC_PCLK2Config(RCC_HCLK_Div1); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  APB2    PLL  72  RCC_PCLK1Config(RCC_HCLK_Div1); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  APB1    PLL  72  RCC_ADCCLKConfig(RCC_PCLK2_Div2); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    2 (Div2)    36   72  RCC_PLLConfig(RCC_PLLSource_PREDIV1, RCC_PLLMul_9); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   9,  8  * 9 = 72   PLL RCC_PLLCmd(ENABLE); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  PLL while (RCC_GetFlagStatus(RCC_FLAG_PLLRDY) == RESET) {} /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   PLL  RCC_SYSCLKConfig(RCC_SYSCLKSource_PLLCLK); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  PLL     while (RCC_GetSYSCLKSource() != 0x08) {} /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   PLL     } }</span></span></code> </pre><br><br>  <i>And now let's remember that before using a function, you need to declare it at the beginning of the program, so in the end we will get such a piece of code that will customize your clocking.</i>  <i>It will work on any MK <b>F10x</b> series, so you can save it as a library:</i> <br><br><pre> <code class="hljs markdown">/<span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">****   **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">**/ void RCC_Configuration(void); ErrorStatus HSEStartUpStatus; RCC_ClocksTypeDef RCC_Clocks; void RCC_Configuration(void) { RCC_DeInit(); //   reset RCC_HSEConfig(RCC_HSE_ON); //   HSE ( ) HSEStartUpStatus = RCC_WaitForHSEStartUp(); //      if (HSEStartUpStatus == SUCCESS) //   ,     { RCC_HCLKConfig(RCC_SYSCLK_Div1); //    1 (Div1)     72  RCC_PCLK2Config(RCC_HCLK_Div1); //  APB2    PLL  72  RCC_PCLK1Config(RCC_HCLK_Div1); //  APB1    PLL  72  RCC_ADCCLKConfig(RCC_PCLK2_Div2); //    2 (Div2)    36    72  RCC_PLLConfig(RCC_PLLSource_PREDIV1, RCC_PLLMul_9); //    9,  8  *</span></span> 9 = 72   PLL RCC<span class="hljs-emphasis"><span class="hljs-emphasis">_PLLCmd(ENABLE); //  PLL while (RCC_</span></span>GetFlagStatus(RCC<span class="hljs-emphasis"><span class="hljs-emphasis">_FLAG_</span></span>PLLRDY) == RESET) {} //   PLL  RCC<span class="hljs-emphasis"><span class="hljs-emphasis">_SYSCLKConfig(RCC_</span></span>SYSCLKSource<span class="hljs-emphasis"><span class="hljs-emphasis">_PLLCLK); //  PLL     while (RCC_</span></span>GetSYSCLKSource() != 0x08) {} //   PLL     } }</code> </pre><br><br>  I think the clocking I described more or less in detail, now I need to disassemble the periphery. <br><br><h4>  <b>Work with I / O ports</b> </h4><br>  <i>GPIO</i> is our input / output ports.  This is the foundation of  before using any other peripherals, it is necessary to configure the ports to which it is derived. <br>  I will lead the story about this periphery using the example of the LED display in our circuit.  From the <a href="http://geektimes.ru/post/267986/">previous article</a> we will take the connection: <br><br>  <i>a) LED ‚Ññ1 (LED1) is connected to PB12</i> <i><br></i>  <i>b) LED No. 2 (LED2) is connected to PB13</i> <i><br></i>  <i>c) LED ‚Ññ3 (LED3) is connected to PB14</i> <i><br></i>  <i>d) LED ‚Ññ4 (LED4) is connected to PB15</i> <i><br></i>  <i>e) LED No. 5 (LED5) is connected to the PC6</i> <br><br>  What does this mean ... STM has ports, they have 16 pins from 0 to 15. True, there are exceptions, some ports do not always have 16 legs, but they can, for example, only 4 or 5. The designation <b>PB12</b> means that this is port B and 12th conclusion.  Now open the previously downloaded <b>STM32CubeMX</b> and see where these legs are and whether it will be convenient for us to plant them. <br><img src="https://habrastorage.org/files/801/0f0/bb6/8010f0bb648e4fa1be3db81b026ece1a.JPG"><br>  Figure 5 - Selecting the location of the periphery in the program STM32CubeMX <br><br>  The great beauty of STM is that their <i>‚Äúflexibility‚Äù</i> allows you to use any legs for I / O, and the entire periphery can be transferred to alternative legs (a fallback), the so-called <b>Remap</b> .  All this allows very high quality, fast and convenient to part fee, so beginners learn to use all that gives us the developers of ST. <br><br>  Now we need to work with the display, that is, light the LEDs in certain situations.  Now we go and see how to do it, we need to set our output to <b>log.1</b> , because  the anodes are connected to the MC, and the cathodes with the minus circuit.  To do this, open the <b>stm32f10x_gpio.h</b> file and scroll down the file, there is a list of all available functions: <br><img src="https://habrastorage.org/files/296/adb/44f/296adb44fc564433929f6284553c91c1.JPG"><br>  Figure 6 - Functions available when working with GPIO <br><br>  There we see the functions of setting and resetting the output state: <br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GPIO_SetBits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GPIO_TypeDef* GPIOx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> GPIO_Pin)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GPIO_ResetBits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GPIO_TypeDef* GPIOx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> GPIO_Pin)</span></span></span></span>;</code> </pre><br><br>  How to work with such functions: copy it, apparently the first entry in brackets <i>GPIO_TypeDef * GPIOx</i> , as is clear, instead of <i>‚Äúx‚Äù</i> you need to specify the port, we have ports B and C, we get <b>GPIOB</b> .  Here we recall the functions from the beginning of the article, which I requested not to eat too much, it is already time).  We look at the second part in the brackets <b>uint16_t GPIO_Pin</b> , here we see the variable <i>GPIO_Pin</i> , we also see that the type of this variable is unsigned, <b>16 bits</b> in size, that is, <i>2 <sup>16</sup></i> or <i>65536</i> .  But we do not need so much, I think it is clear that here we need to specify the number of output (pin) <i>from 0 to 15.</i> As a result, we get <b>GPIO_Pin_12</b> .  Given all this, we write code: <br><pre> <code class="hljs ruby">GPIO_SetBits(GPIOB, GPIO_Pin_12); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ‚Ññ <span class="hljs-number"><span class="hljs-number">1</span></span> GPIO_SetBits(GPIOB, GPIO_Pin_13); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ‚Ññ <span class="hljs-number"><span class="hljs-number">2</span></span> GPIO_SetBits(GPIOB, GPIO_Pin_14); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ‚Ññ <span class="hljs-number"><span class="hljs-number">3</span></span> GPIO_SetBits(GPIOB, GPIO_Pin_15); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ‚Ññ <span class="hljs-number"><span class="hljs-number">4</span></span> GPIO_SetBits(GPIOC, GPIO_Pin_6); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ‚Ññ <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre><br><br>  As you can see, every time we remember which leg we connected the LED to, write extra letters, when the code is at least 5,000 lines, oh how important it is)) Therefore, we remember the remarkable feature of the <b>#define</b> command and modify our code: <br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED1_ON GPIO_SetBits(GPIOB, GPIO_Pin_12) //   ‚Ññ 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED2_ON GPIO_SetBits(GPIOB, GPIO_Pin_13) //   ‚Ññ 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED3_ON GPIO_SetBits(GPIOB, GPIO_Pin_14) //   ‚Ññ 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED4_ON GPIO_SetBits(GPIOB, GPIO_Pin_15) //   ‚Ññ 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED5_ON GPIO_SetBits(GPIOC, GPIO_Pin_6) //   ‚Ññ 5</span></span></code> </pre><br><br>  Now it's unforgettable to make a function that will also turn off our ‚Äúlight bulbs‚Äù.  To do this, we change the current <i>SetBits</i> function to <i>ResetBits</i> - I think everything is very clear here.  We end up with this end code: <br><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED1_ON GPIO_SetBits(GPIOB, GPIO_Pin_12) //   ‚Ññ 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED2_ON GPIO_SetBits(GPIOB, GPIO_Pin_13) //   ‚Ññ 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED3_ON GPIO_SetBits(GPIOB, GPIO_Pin_14) //   ‚Ññ 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED4_ON GPIO_SetBits(GPIOB, GPIO_Pin_15) //   ‚Ññ 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED5_ON GPIO_SetBits(GPIOC, GPIO_Pin_6) //   ‚Ññ 5 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED1_OFF GPIO_ResetBits(GPIOB, GPIO_Pin_12) //   ‚Ññ 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED2_OFF GPIO_ResetBits(GPIOB, GPIO_Pin_13) //   ‚Ññ 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED3_OFF GPIO_ResetBits(GPIOB, GPIO_Pin_14) //   ‚Ññ 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED4_OFF GPIO_ResetBits(GPIOB, GPIO_Pin_15) //   ‚Ññ 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LED5_OFF GPIO_ResetBits(GPIOC, GPIO_Pin_6) //   ‚Ññ 5</span></span></code> </pre><br>  Now for simple ignition of the LED it is enough to write <b>LED1_ON;</b>  To turn it off, we also write LED1_OFF; <br><br>  It seems everything is simple?  But no!  There was the last moment that had to be shown at the beginning, but he would probably have scared half of the people.  Although it is simple, but the performance depends on it - this is the <b>initialization of the GPIO periphery</b> .  It is necessary to indicate the port from where to get him the clock frequency, on which one to work and in what mode.  All this is done in the same <b>stm32f10x_gpio.h</b> library, but now you also need to connect the clocking library <b>stm32f10x_rcc.h</b> to it. <br>  Before you <i>need to</i> do something with any peripherals, <i>you need to enable its clocking</i> , this is done in <b>stm32f10x_rcc.h</b> , go there and see what function to do it, their list is also at the end of the file: <br><img src="https://habrastorage.org/files/006/c86/ff8/006c86ff8424433da81ba5b06ac7001b.JPG"><br>  Figure 7 - Clocking Functions <br><br>  Here we see the familiar APB2 and APB1, the buses to which our ports are connected.  In this case, both C and B are on APB2, I highlighted this function on the screen.  It is the simplest: in the first part it is necessary to write the name of the periphery, in the second to indicate the status.  There can be two <b>statuses</b> : <b>ENABLE</b> (enabled) and <b>DISABLE.</b>  Xs why, but it‚Äôs important to write status in large letters, otherwise Coco will not highlight the text. <br>  Now you need somewhere to get the correct name of the periphery.  Therefore, we go to the library file <b>stm32f10x_rcc.h</b> and presses <u><b>Ctrl + F</b></u> - this is a search in the file, write RCC_APB2Periph to it and click <i>Find</i> .  And we poke <i>Find</i> several times until we reach such a list, where all the states that this inscription can accept are indicated.  Select the desired peripherals: <br><img src="https://habrastorage.org/files/005/276/292/0052762928fd42f3a1c7aead1bb43ac1.JPG"><br>  Figure 8 - Search function values ‚Äã‚Äãby library <br><br>  And so ... how to enable clocking figured out, we got this line, or rather 2 lines, because  use two ports B and C: <br><pre> <code class="hljs pgsql">RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOC, <span class="hljs-keyword"><span class="hljs-keyword">ENABLE</span></span>); RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, <span class="hljs-keyword"><span class="hljs-keyword">ENABLE</span></span>);</code> </pre><br><br>  Everything, with the clocking library, let's finish it now and go to the <b>stm32f10x_gpio.h</b> file <b>.</b> Go to the end and look for the initialization function, they are usually called <i>Init</i> , there‚Äôs a complete captaincy if you know English at least a little.  Next, copy the name of the function <b>GPIO_Init</b> and then follow the standard <i>Ctrl + F</i> : <br><img src="https://habrastorage.org/files/53d/745/442/53d7454425454d71bcc69fc5f40f8290.JPG"><br>  Figure 9 - This is what the function in the list looks like <br><br>  Next, we poke <i>Find a</i> couple of times until we get to the moment there will be a description of the function and what it looks like: <br><img src="https://habrastorage.org/files/525/3f6/459/5253f64595144c1386b3d30d9608f1f1.JPG"><br>  Figure 10 - Initialization Function <br><br>  so it looks and consists of 3 components: <br>  a) GPIO_Pin - here we indicate how the output is set up <br>  b) GPIO_Speed ‚Äã‚Äã- here we indicate the speed / frequency maximum at which the controller's foot can work <br>  c) GPIO_Mode - set the foot operation mode <br><br>  If you select each component, press <i>Ctrl + F</i> and paste and press <i>Find</i> , then there will be a list of what you can write with each component.  Now an example of initialization for our case: <br><br><pre> <code class="hljs ruby">RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOC, ENABLE); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    GPIO_InitTypeDef led; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     led led.GPIO_Pin = (GPIO_Pin_12 <span class="hljs-params"><span class="hljs-params">| GPIO_Pin_13 |</span></span> GPIO_Pin_14 <span class="hljs-params"><span class="hljs-params">| GPIO_Pin_15) ; //       led.GPIO_Speed = GPIO_Speed_2MHz; //     led.GPIO_Mode = GPIO_Mode_Out_PP; //    ,   push-pull GPIO_Init(GPIOB, &amp;led); //  </span></span></code> </pre><br><br>  Details about the settings can be read in datashit or google, some of the other modes of operation will be found further, so choose how you will study. <br>  I set the maximum frequency to 2 MHz, since  in this mode, the periphery consumes a little less current.  If this would be a setting for <i>SPI</i> , then you need to specify the maximum, <u>so that there is no limit</u> .  I think everything is clear, if not ready to answer in a personal. <br><br>  <b>As a result, after today's part, we should get such a code</b> .  It is for learning, but complementing it in the future we will get the final source: <u>disassembled and understandable to everyone!</u> <br><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"stm32f10x_conf.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"stm32f10x_rcc.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"stm32f10x.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"stm32f10x_gpio.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"stm32f10x_spi.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"TFT ILI9341.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LED1_ON</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_SetBits</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, <span class="hljs-type"><span class="hljs-type">GPIO_Pin_12</span></span>) //   ‚Ññ <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LED2_ON</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_SetBits</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, <span class="hljs-type"><span class="hljs-type">GPIO_Pin_13</span></span>) //   ‚Ññ <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LED3_ON</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_SetBits</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, <span class="hljs-type"><span class="hljs-type">GPIO_Pin_14</span></span>) //   ‚Ññ <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LED4_ON</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_SetBits</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, <span class="hljs-type"><span class="hljs-type">GPIO_Pin_15</span></span>) //   ‚Ññ <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LED5_ON</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_SetBits</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOC</span></span>, <span class="hljs-type"><span class="hljs-type">GPIO_Pin_6</span></span>) //   ‚Ññ <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LED1_OFF</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_ResetBits</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, <span class="hljs-type"><span class="hljs-type">GPIO_Pin_12</span></span>) //   ‚Ññ <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LED2_OFF</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_ResetBits</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, <span class="hljs-type"><span class="hljs-type">GPIO_Pin_13</span></span>) //   ‚Ññ <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LED3_OFF</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_ResetBits</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, <span class="hljs-type"><span class="hljs-type">GPIO_Pin_14</span></span>) //   ‚Ññ <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LED4_OFF</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_ResetBits</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, <span class="hljs-type"><span class="hljs-type">GPIO_Pin_15</span></span>) //   ‚Ññ <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LED5_OFF</span></span> <span class="hljs-type"><span class="hljs-type">GPIO_ResetBits</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOC</span></span>, <span class="hljs-type"><span class="hljs-type">GPIO_Pin_6</span></span>) //   ‚Ññ <span class="hljs-number"><span class="hljs-number">5</span></span> /****************************************************************************************************************/ /**********************     **********************************************************/ /****************************************************************************************************************/ /***************************************   **********************************/ void <span class="hljs-type"><span class="hljs-type">RCC_Configuration</span></span>(void); <span class="hljs-type"><span class="hljs-type">ErrorStatus</span></span> <span class="hljs-type"><span class="hljs-type">HSEStartUpStatus</span></span>; <span class="hljs-type"><span class="hljs-type">RCC_ClocksTypeDef</span></span> <span class="hljs-type"><span class="hljs-type">RCC_Clocks</span></span>; void <span class="hljs-type"><span class="hljs-type">RCC_Configuration</span></span>(void) { <span class="hljs-type"><span class="hljs-type">RCC_DeInit</span></span>(); //   reset <span class="hljs-type"><span class="hljs-type">RCC_HSEConfig</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_HSE_ON</span></span>); //   <span class="hljs-type"><span class="hljs-type">HSE</span></span> ( ) <span class="hljs-type"><span class="hljs-type">HSEStartUpStatus</span></span> = <span class="hljs-type"><span class="hljs-type">RCC_WaitForHSEStartUp</span></span>(); //      if (<span class="hljs-type"><span class="hljs-type">HSEStartUpStatus</span></span> == <span class="hljs-type"><span class="hljs-type">SUCCESS</span></span>) //   ,     { <span class="hljs-type"><span class="hljs-type">RCC_HCLKConfig</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_SYSCLK_Div1</span></span>); //    <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-type"><span class="hljs-type">Div1</span></span>)     <span class="hljs-number"><span class="hljs-number">72</span></span>  <span class="hljs-type"><span class="hljs-type">RCC_PCLK2Config</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_HCLK_Div1</span></span>); //  <span class="hljs-type"><span class="hljs-type">APB2</span></span>    <span class="hljs-type"><span class="hljs-type">PLL</span></span>  <span class="hljs-number"><span class="hljs-number">72</span></span>  <span class="hljs-type"><span class="hljs-type">RCC_PCLK1Config</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_HCLK_Div1</span></span>); //  <span class="hljs-type"><span class="hljs-type">APB1</span></span>    <span class="hljs-type"><span class="hljs-type">PLL</span></span>  <span class="hljs-number"><span class="hljs-number">72</span></span>  <span class="hljs-type"><span class="hljs-type">RCC_ADCCLKConfig</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_PCLK2_Div2</span></span>); //    <span class="hljs-number"><span class="hljs-number">2</span></span> (<span class="hljs-type"><span class="hljs-type">Div2</span></span>)    <span class="hljs-number"><span class="hljs-number">36</span></span>    <span class="hljs-number"><span class="hljs-number">72</span></span>  <span class="hljs-type"><span class="hljs-type">RCC_PLLConfig</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_PLLSource_PREDIV1</span></span>, <span class="hljs-type"><span class="hljs-type">RCC_PLLMul_9</span></span>); //    <span class="hljs-number"><span class="hljs-number">9</span></span>,  <span class="hljs-number"><span class="hljs-number">8</span></span>  * <span class="hljs-number"><span class="hljs-number">9</span></span> = <span class="hljs-number"><span class="hljs-number">72</span></span>   <span class="hljs-type"><span class="hljs-type">PLL</span></span> <span class="hljs-type"><span class="hljs-type">RCC_PLLCmd</span></span>(<span class="hljs-type"><span class="hljs-type">ENABLE</span></span>); //  <span class="hljs-type"><span class="hljs-type">PLL</span></span> while (<span class="hljs-type"><span class="hljs-type">RCC_GetFlagStatus</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_FLAG_PLLRDY</span></span>) == <span class="hljs-type"><span class="hljs-type">RESET</span></span>) {} //   <span class="hljs-type"><span class="hljs-type">PLL</span></span>  <span class="hljs-type"><span class="hljs-type">RCC_SYSCLKConfig</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_SYSCLKSource_PLLCLK</span></span>); //  <span class="hljs-type"><span class="hljs-type">PLL</span></span>     while (<span class="hljs-type"><span class="hljs-type">RCC_GetSYSCLKSource</span></span>() != <span class="hljs-number"><span class="hljs-number">0x08</span></span>) {} //   <span class="hljs-type"><span class="hljs-type">PLL</span></span>     } } /**************************    ***********************************************/ /**************************************************************************************************/ /**************************************************************************************************/ int main(void) { <span class="hljs-type"><span class="hljs-type">RCC_GetClocksFreq</span></span> (&amp;<span class="hljs-type"><span class="hljs-type">RCC_Clocks</span></span>); <span class="hljs-type"><span class="hljs-type">RCC_Configuration</span></span>(); <span class="hljs-type"><span class="hljs-type">RCC_GetClocksFreq</span></span> (&amp;<span class="hljs-type"><span class="hljs-type">RCC_Clocks</span></span>); /*************   *****************************************/ <span class="hljs-type"><span class="hljs-type">RCC_APB2PeriphClockCmd</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_APB2Periph_GPIOC</span></span>, <span class="hljs-type"><span class="hljs-type">ENABLE</span></span>); //    <span class="hljs-type"><span class="hljs-type">GPIO_InitTypeDef</span></span> led; //     led led.<span class="hljs-type"><span class="hljs-type">GPIO_Pin</span></span> = (<span class="hljs-type"><span class="hljs-type">GPIO_Pin_12</span></span> | <span class="hljs-type"><span class="hljs-type">GPIO_Pin_13</span></span> | <span class="hljs-type"><span class="hljs-type">GPIO_Pin_14</span></span> | <span class="hljs-type"><span class="hljs-type">GPIO_Pin_15</span></span>) ; //       led.<span class="hljs-type"><span class="hljs-type">GPIO_Speed</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_Speed_2MHz</span></span>; //     led.<span class="hljs-type"><span class="hljs-type">GPIO_Mode</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_Mode_Out_PP</span></span>; //    ,   push-pull <span class="hljs-type"><span class="hljs-type">GPIO_Init</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, &amp;led); //   while(<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-type"><span class="hljs-type">LED1_ON</span></span>; <span class="hljs-type"><span class="hljs-type">LED2_OFF</span></span>; <span class="hljs-type"><span class="hljs-type">LED3_ON</span></span>; <span class="hljs-type"><span class="hljs-type">LED4_ON</span></span>; <span class="hljs-type"><span class="hljs-type">LED5_OFF</span></span>; } }</code> </pre><br><br>  <u><i>As a result, we learned how to adjust the clocking from quartz for high accuracy, disassembled how to use SPL libraries and how to configure GPIO and use them.</i></u>  <u><i>We also mentioned the main functions of ala define and incloud, with parsing of their application in real code.</i></u> <br><br><h4>  <b>Epilogue</b> </h4><br>  Yeah, the article really strained my head, because  Sensei is bad for me, and they asked me to tell in detail about the firmware.  I hope it worked out for me and those who are only planning to start studying the programming of microcontrollers will be able to understand me, my descriptions and advice. <br>  It so happened that this part is not the last, there <b>will be another 4.3</b> , where we will analyze the remaining periphery and complete the program.      ,   ,               . <br><br>  4.3        ,         .   <i></i>    ‚Äî              ,         . <br>    ‚Äî <b>¬´     0-60  20¬ª.</b>    ,      . <br><br> <u>       <s> </s>    ,              .  !</u> <br><br>  <a href="http://geektimes.ru/post/268722/">Part 5</a> <br>  <a href="https://geektimes.ru/post/269650/">Part 6</a> </div><p>Source: <a href="https://habr.com/ru/post/358324/">https://habr.com/ru/post/358324/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358314/index.html">On the issue of delays and durations</a></li>
<li><a href="../358316/index.html">Designing a powerful double conversion UPS (on-line). Part 1</a></li>
<li><a href="../358318/index.html">Calculation and manufacture of the "heart" of the IIP - pulse transformer. Part 2</a></li>
<li><a href="../358320/index.html">Designing low-power DC-DC for the organization of emergency power. Part 3</a></li>
<li><a href="../358322/index.html">Indication of output parameters and implementation of load protection in the UPS. Part 4.1</a></li>
<li><a href="../358326/index.html">Productronic 2015</a></li>
<li><a href="../358328/index.html">Symmetric cards as a means of minimizing Boolean functions</a></li>
<li><a href="../358330/index.html">History of one oscilloscope on stm32</a></li>
<li><a href="../358332/index.html">Arduino LLC and Arduino SRL Are United Again</a></li>
<li><a href="../358334/index.html">Determine the length of the tracks on the board</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>