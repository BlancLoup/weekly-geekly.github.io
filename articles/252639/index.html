<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>130 thousand surveillance cameras - how to make them work?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! We would like to thank you again for the excellent feedback; we will give detailed answers to a number of your questions, including a detail...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>130 thousand surveillance cameras - how to make them work?</h1><div class="post__text post__text-html js-mediator-article">  <b>Hi, Habr!</b>  We would like to thank you again for the excellent feedback; we will give detailed answers to a number of your questions, including a detailed description of the infrastructure of our system.  We ourselves thought soon to make such a post, but since you, too, expressed interest in this subject, we have a little forced the process. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/784/48d/99d/78448d99db2245afaa3180cbcf5e1bd9.png"></div><br>  Under the cut - immediately to the point. <br><a name="habracut"></a><br>  <b>The system architecture is built on a modular principle</b> , which is the standard for systems of this scale.  But there is one significant difference: these modules in the system are not just a lot, but a lot.  Each module performs separate highly specialized tasks related to receiving video images and information from city and departmental information systems (IS), controlling access to the processed data, providing photo and video images to <abbr title="Unified Data Storage Center">ECDD</abbr> users and various external consumers, including residents of the city. <br><br>  The modules closely interact with each other on the basis of various technologies (mainly JSON, REST API and SOAP).  The modules themselves are implemented in various languages ‚Äã‚Äã(Java, C #, Java Script and others), using frameworks (ASP.NET Web API, WCF, NLog, Entity Framework, MySQL ADO.NET managed drivers, Unity 3, EPPlus, Json.NET, EmitMapper, DotNetZip, jQuery, knockoutjs, Moment.js, underscore.js and so on). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All this software diversity operates under various operating systems (Windows Server, SUSE Linux Enterprise Server, CentOS and others) in the VMware vSphere 5 virtualization environment. <br><br>  The system architecture is shown in the diagram: <br><br><img src="https://habrastorage.org/files/935/5e2/40e/9355e240e7204ccc9dc2a57e213d162a.png"><br><br>  All modules have their own mechanisms for fault tolerance and balancing.  Cluster technologies, various options for balancing HTTP requests based on nginx are used for this, as well as queue and priority management at the application level.  In addition, all modules are combined according to the principle of weak connectivity, which significantly increases the possibilities for development and modification of the system as a whole. <br><br>  This approach allows us to make the system not only scalable, but also very flexible in terms of implementing new technological processes or making changes to existing ones, since each module can develop independently and support for backward compatibility of the module is imperative. <br><br><habracut><h2>  <font color="#3881bd">Description of the main components of the system</font> </h2><br>  <b>The video core, which provides for receiving and processing video streams</b> , consists of several hundreds of video servers running on dedicated virtual machine resources running Linux, ensuring reception of video traffic from more than 145 thousand cameras, coders and other video streaming systems.  The traffic is <abbr title="Real Time Streaming Protocol, Real-Time Streaming Protocol"><a href="https://ru.wikipedia.org/wiki/RTSP">received</a></abbr> via the <abbr title="Real Time Streaming Protocol, Real-Time Streaming Protocol"><a href="https://ru.wikipedia.org/wiki/RTSP">RTSP</a></abbr> protocol (video in H.264 format), the traffic receiving pattern can be used differently - on an ongoing basis with a customized recording depth (retention period), or on request if you simply need to watch the video.  Such a flexible approach allows saving both server resources and reducing the workload of communication channels. <br><br>  TCP is mainly used as a transport layer protocol, but in some cases UDP can also be used.  Video servers perform several tasks: <br><br>  - <b>Primary:</b> receiving a video stream, recording it, and then issuing streaming or archived video to retransmission servers or long-term storage of a portion of the archived video on a separate dedicated storage; <br>  - <b>A number of additional:</b> monitoring the availability of a video source, monitoring the receipt and compliance of a video stream with specified parameters (fps, bitrate, packet loss), as well as through specialized data communication buses, information from video servers goes to the service delivery monitoring system for subsequent accounting and transmission to operational services. <br><br>  Management of video servers is carried out through a specialized HTTP API that allows you to fully automate the work through control systems.  The operation of video servers is controlled through Zabbix, using additional internal mechanisms of video servers. <br><br>  <b>Restrimming</b> - a retransmission server is a link between the video core (performing the primary video reception and recording) and users (essentially the main consumers of video content).  Built-in mechanisms for the reencapsulation and distribution of streaming video allow for the retransmission of live and archived video content to PCs and portable devices (tablets, phones).  Restrimming can also provide streaming video content over RTSP for additional systems, for example, video analytics systems or transcoding management systems - after all, users sometimes need a ‚Äúcompressed‚Äù video stream if they suddenly ‚Äúdipped‚Äù the channel, and watch the video very much :) Also users can use the special mode of viewing as a slideshow.  Relay servers operate in a cluster and support dynamic backup mode, as well as isolating the video core from possible surges in user-generated traffic. <br><br>  <b>The user interface</b> - a web interface (front-end) provides authorized access for several tens of thousands of registered users to the video surveillance system and provides a wide range of different functionalities available from anywhere in the intracity network, and in some cases through closed dedicated Internet resources. <br><br>  Work is provided in the environment of various operating systems (Windows, MacOS, Linux) on all major browsers, which greatly simplifies the organization of workplaces.  It also supports work with a number of mobile devices, for example, based on iOS. <br><br>  The functionality is quite diverse - from the usual viewing of streaming and archival video (via flash player on PC, and native iOS tools) and controlling <abbr title="Pan-tilt-zoom">PTZ</abbr> camera functions, search engines with links to different layers of cartography and integration with urban systems data, and to use a flexible role model, the formation of a personal representation of the user interface and built-in mechanisms for user training. <br><br>  Front-end uses technologies such as RequireJS, knockout, lodash, leaflet and others.  The back-end is built according to a modular principle, which allows for ensuring the necessary level of redundancy and scaling of components, using a configuration management system.  Software and technologies: Java / Tomcat, MariaDB, RabbitMQ and several others. <br><br>  <b>Integration gateway</b> is a set of modules of subsystems that provide isolation of external consumers of information from the system core.  Issues various information to external systems after passing authorization and taking into account specified powers (i.e. available data volume and functionality).  There are three main logical components: <br><br><ul><li>  <b>The service interaction component</b> is the HTTP API, through which the output of a given set of information (camera names, addresses and location coordinates, screenshots, and other accompanying information) is provided. <br><br></li><li>  <b>Relay component</b> - designed to minimize load on the video core and provide video streaming to external systems (broadcasting on flash is supported, as well as <abbr title="HTTP Live Streaming">HLS</abbr> for iOS devices).  The video core and the restriction server have the functionality of a <abbr title="Content Delivery Network - content delivery network">CDN</abbr> , and this component works as an additional CDN link for the distribution of video content. <br><br></li><li>  <b>The interface provision component</b> is designed to be embedded into external systems as a ready-to-use interface for playing streaming and archival video information, for example, by embedding via iframe and simple customization (visual presentation settings ‚Äî colors, necessary function buttons, etc.) through simple parameterized calls. </li></ul><br>  The use of these components allows external systems not only to access data and form their own information visualization interface, but also to implement already prepared components as simply as possible. <br><br><img src="https://habrastorage.org/files/3a1/841/318/3a184131894e4c529e1d06b1257d4024.jpg"><br><br>  <b>To provide users with access to cameras of the video surveillance system,</b> there is a whole range of interrelated components that provide user authentication and authorization, prioritization of access to PTZ control functions, logging of user actions and interaction of individual modules. <br><br>  The system supports two types of authentication: using the user accounts of the ECDC and using a single city control system of access to resources (in fact, this is an <abbr title="Single Sign-On, Single Sign-On Technology">SSO</abbr> option for citywide IP).  At the same time, for a single physical user, it is possible to share different types of authentication.  The key authentication information of the ECDD users is stored in Active Directory, and all additional information is stored in the Microsoft SQL database. <br><br>  All passwords, of course, are transmitted between the modules in encrypted form.  Or they are not transmitted at all, as we also can :) <br><br>  The granting of access rights and priorities is implemented on the basis of a role model for all modules, which allows providing access not only to video surveillance cameras, but also to individual functions of the system.  Currently, there are more than 100 different authorities in the system: access to live broadcast, the ability to view and export a photo and video archive, PTZ control, make changes to individual system registers and directories, create a schedule for taking pictures, create patrol routes , access from mobile devices and much more.  The system is constantly evolving, new user groups with their tasks are connected, and the addition of new powers to the system occurs, in fact, on the fly. <br><br>  In addition, there are several levels of priorities for different user groups and system services, which allows avoiding conflicts between different user groups and transparently intercepting PTZ camera control, providing control in patrol modes, or moving the field of view on a schedule. <br><br>  In order to quickly and simply provide permissions for tens of thousands of users and manage them, the system uses various mechanisms: assignment of permissions to groups of users, use of templates with predefined typical permissions, smart groups (when based on specified rules new users are automatically distributed into groups ).  Similar mechanisms are used to manage camera registries, but the distribution into groups is mainly implemented according to geographical principle, type of service, or belonging to a departmental video surveillance system. <br><br>  Access control is carried out almost in real time, and any change in the composition of powers immediately affects the user.  In addition, token-based validation session mechanisms are used to control the lifetime of links to live video streams.  By the way, it was the absence of this mechanism in the test service for the residents of the city that made it possible to get access to the ‚Äúexpired‚Äù links to the video streams. <br><br>  The system will record all user actions and interaction of modules at all levels, which will allow an analysis of any situation.  The logging system records the date and time of the event, what actions the user performed (up to pressing the interface buttons), what tasks the scheduler performed in the system, what ended the information exchange and much more.  To date, the system has recorded more than 10 billion records of the implementation of "technological" processes, each of which consists of several separate actions being recorded.  Every day, DIT employees receive statistics that allow users to determine user activity in various sections: which portals they used, the number of live viewings, which camera groups had the largest number of requests, etc. <br><br>  As a ‚Äúcherry on the cake,‚Äù video surveillance system in numbers: <br><br>  <b>Number of cameras:</b> more than 145 thousand; <br>  <b>Number of users:</b> more than 10 thousand; <br>  <b>Network video traffic volume:</b> about 120 Gbit / s; <br>  <b>Storage</b> capacity <b>:</b> 20 PB. <br><br>  The official <a href="http://video.dit.mos.ru/">page of the system here</a> .  You can see the camera specifications, learn how to act in the event of an accident that could get into the lens, and view several cameras in public places using <a href="http://video.dit.mos.ru/window">the Window to City service</a> . <br><br>  Read also in our blog on Habr√©: <br>  <font color="#3881bd"><b>¬ª</b></font> <a href="http://habrahabr.ru/company/dit/blog/252375/">Habraeffect for 130,000 Moscow cameras</a> <br>  <font color="#3881bd"><b>¬ª</b></font> <a href="http://habrahabr.ru/company/dit/blog/252141/">Information technology feeds more than 750 thousand people in Moscow</a> <br>  <font color="#3881bd"><b>¬ª</b></font> <a href="http://habrahabr.ru/company/dit/blog/251711/">Blog of the Department of Information Technology of the city of Moscow on" Habrahabr "</a> <br><br>  Thanks for attention! </habracut></div><p>Source: <a href="https://habr.com/ru/post/252639/">https://habr.com/ru/post/252639/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252611/index.html">Webmaster‚Äôs blocking of a banned site without settings and client-side software</a></li>
<li><a href="../252613/index.html">Apple released iOS 8.2</a></li>
<li><a href="../252621/index.html">Instantiate not instantiated</a></li>
<li><a href="../252629/index.html">Comparing libraries for asynchronous requests</a></li>
<li><a href="../252637/index.html">Animations against lags, or the best battle that was not</a></li>
<li><a href="../252641/index.html">Trends and statistics: How Internet companies create an effective newsletter</a></li>
<li><a href="../252643/index.html">What are you guided in the first place, choosing a cloud provider - IaaS service provider?</a></li>
<li><a href="../252645/index.html">We stamp windows: automated deployment of Windows virtual machines to Hyper-V using Vagrant (part 3)</a></li>
<li><a href="../252647/index.html">Assembler with C ++ in Visual Studio 2013</a></li>
<li><a href="../252649/index.html">CDN in a backpack. How we made a portable CDN</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>