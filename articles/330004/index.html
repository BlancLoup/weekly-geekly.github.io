<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hard Reverse or features reverse files for PowerPC architecture Big-Endian</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tasks for reverse engineering are an essential part of any CTF, and NeoQUEST is no exception in this regard. In each task, we add a ‚Äúzest‚Äù, which, on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hard Reverse or features reverse files for PowerPC architecture Big-Endian</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/web/1df/d5c/0fb/1dfd5c0fbdc842a7babc62973e389e95.jpg">  Tasks for reverse engineering are an essential part of any CTF, and NeoQUEST is no exception in this regard.  In each task, we add a ‚Äúzest‚Äù, which, on the one hand, somewhat complicates the participants to complete the task, and on the other, it allows us to deal with what we haven‚Äôt worked with yet. <br><br>  If we talk about the "highlights", then the task of the online-stage NeoQUEST-2017 of the planet Endian "Crew Rescue" is practically a cupcake!  Welcome to the cut, to the very jungle of the reverse: let's talk about the <a href="https://ru.wikipedia.org/wiki/PowerPC">PowerPC</a> Big-Endian architecture and a little about <a href="http://www.qemu.org/">QEMU</a> ! <br><br>  And we remind you that <b>NeoQUEST 2017</b> will be held in Petersburg <b>on June 29</b> : reports, workshops, contests, prizes, a great time and <b>free entry when registering on the <a href="http://neoquest.ru/">site</a></b> - everything is for you!  Read more about what will be included in the program "confrontation", read <a href="https://habrahabr.ru/company/neobit/blog/330014/">here</a> and on the site! <br><a name="habracut"></a><br><h3>  <b>Where to begin?</b>  <b>From the legend!</b> </h3><br>  So ... While the spaceships were plowing through the universe, the participants of NeoQUEST found themselves on the planet "Endian" and "discovered the ship of the last expedition, the one that was considered to be missing without a trace!".  Already not bad!  And it's nice to know that in space, too, use IP-addresses. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We read carefully the legend and get the following information: <br><br><ol><li>  IP address of the on-board computer 213.170.100.211 </li><li>  "Special" file 1_8139.rom </li><li>  A PowerPC Big-Endian Binary 2_quest.cod_data </li></ol><br>  First of all, we drive this IP address into the address bar of the browser and drive it! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/18b/e1d/8f1/18be1d8f164e4608a7d497154a652a95.png"></div><br>  The name of the tab immediately gives the first hint.  Somehow QEMU is used here.  Mentally put a tick in order not to forget, register and load the file 1_8139.rom. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/3be/fb0/287/3befb02870724f5ebadc861d72d2f77a.png"></div><br>  What is going on?  A screenshot is displayed, apparently from the qemu virtual machine, in the screenshot - please enter the password.  However, how to enter it?  All that we can do is load a strange file, although ... SeaBIOS and Booting from ROM ... Those who worked with QEMU have probably already guessed what kind of file we are loading.  But for the sake of purity of the experiment, let's try to set the file command on it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/135/90a/70a/13590a70a67d4ddab18680359a4436c3.png"></div><br>  Thus, it turns out that our 8139 file is a BIOS ROM Extension or PCI Expansion ROM. <br>  If you try to load an arbitrary file, here is the output we will have: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/6d9/260/3bb/6d92603bb4c44d6eb8774d84722bc4b8.jpg"></div><br>  It seems that the first 3 bytes are checked.  Well, this is not a problem - we put the first three bytes, as they ask, iii ... Nothing!  Same.  How so?  But the fact is that if the file is not in the format of PCI Expansion ROM, then qemu will simply not launch it.  And judging by the assignment, there is also some kind of signature.  We will understand further. <br><br><h3>  <b>PCI Expansion ROM</b> </h3><br>  What kind of animal is this?  <b>PCI Expansion ROM</b> is a special piece of the initialization code of a logical PCI device, usually stored either in the BIOS or on a PCI device chip.  One of the most common use cases is the implementation of the network boot (PXE) mechanism.  If you want to see how this happens, we run qemu without parameters, and after the attempt to boot from CD / HDD fails, qemu will show you PXE. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/efb/d2a/8e1/efbd2a8e1d114cf09d55e214a6d6bf8c.png"></div><br>  We decided on the type of file, let's look at its structure. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/6ee/ff8/8eb/6eeff88eb28c49bab0f4555de4c8a8cd.png"></div><br>  Under x86, PCI 2 is allocated the first 2 bytes to the 0x55aa signature, the third byte indicates the size of the module (PCI ROM size = 3 bytes * 512), the fourth byte is already the executable code.  In most PCI ROMs, if not all, this is the usual jump to the initialization code. <br><br>  Oh yeah, I almost forgot: since this is quite an old technology, and it was used before the time of UEFI, then all the code is 16-bit Real Mode. <br><br>  Next, bytes 0x18 indicate the offset of the PCIR structure, and 0x1A indicates the PnP structure.  These structures are of an official nature and carry basic information about the PCI ROM module. <br>  The attentive reader will notice that the vendor and id device just correspond to the reltek 8139 network card. It was her module that was taken as the basis. <br><br>  Of these structures, PnP is of the greatest interest.  It contains interesting fields such as checksum and bootstrap entry. <br><br>  Bootstrap entry indicates the code to which control is transferred when you try to boot from this device.  In this case, it looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/fee/f69/157/feef691573054215b996965d02cb00a6.png"></div><br>  And, as we see, it is very similar to our screenshot, it means that we are on the right track!  Now all you need is for the NOP password verification procedure and try to feed the modified webcam file. <br><br>  Do not forget that we have a checksum field in the PnP structure.  How is cheksumma considered?  It's simple - initially it is put in 0x00 and the sum of the bytes of the file is considered.  Then the resulting amount is subtracted from 0x100.  So we get the value we need.  Why 0x100?  Because cheksumma single-byte.  The fact is that the sum of all bytes during the test should show 0x0.  That is, if the sum of bytes showed us 0x10, the value of the checksum will be 0xF0. <br><br>  It is clear that when the module is loaded, it runs in qemu.  But nothing prevents us from trying to also use the qemu -option-rom command 1_8139.rom <br><br>  If everything is done correctly (patch ROM and cheksumm right), then this ROM will simply return control to the BIOS.  We try in webcam ... Success!  Something new has appeared: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/6c6/86f/d94/6c686fd947a846f48eca7e077bfa7eb3.jpg"></div><br>  Read CRC?  Another cheksumma?  Well, at least the line hints that we are using the CRC (and therefore XOR) to verify the module.  Find this value in the module. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/ec7/b96/40f/ec7b9640fa964fa48d65c36855b13228.png"></div><br>  Almost the very end of the file.  We know the place, now it remains to understand the CRC signature algorithm.  Or at least find a polynomial, and then you can go through the options.  On assignment we are given some PowerPC Big-endian.  No need to scare us with all sorts of PPC, we are so scared.  Take IDA Pro, HEX-editor, and go! <br><br>  The file size is quite large, so the decision "in the forehead" is hardly appropriate here.  Let's try to search for the hooks that we have: the CRC algorithm and the message ‚ÄúCRC error‚Äù.  To begin with, we will find error messages, here the utility strings will help us. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/1a3/9ea/dba/1a39eadba39a4835b77f88faaf11e4f9.png"></div><br>  Fine!  Everything is there, but why 2 times?  We will understand!  We look in the HEX-editor or in IDA. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/801/8fe/11e/8018fe11e6294278982e6224c32f292c.png"></div><br>  We found the line, and at the same time the other error messages.  And also - look carefully!  - before each error message we have 2 bytes, and very similar.  Well, 0xFFFF (or -1) puts everything in its place.  This is an associative array of error messages.  Create a structure in IDA Pro and get just such beauty: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/633/de8/773/633de877346a49b287d18c88774dcedb.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/web/936/949/b0e/936949b0e3c04a95bd350bae131f89bf.png"></div><br>  Now, following the logic, all this code uses error codes.  However, we have 2 hits - error code 0x1604 and 0xA04.  Well, we will look both. <br><br><h3>  <b>0x1604</b> </h3><br>  We are looking for a 0x1604 mention in IDA: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/1f9/270/433/1f9270433c674dfe81795336d51c890a.png"></div><br>  Great, 2 hits.  We look! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/8a8/d40/256/8a8d40256511494585025a9cfc6eaf9f.png"></div><br>  This code validates the CRC.  For convenience, we immediately denote the function call at address 0x42944 as crc_1604 and remember that the function returns the value through the R3 register.  The register R29, most likely, stores the recorded value of the CRC, and in the register R0 - the calculated value of the CRC.  This becomes clear after viewing the function code crc_1604: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/781/b59/8a7/781b598a77fa4fa2a554d4a4fc5fa4bb.png"></div><br>  A small function, only it does not look like a CRC.  There is no polynomial here, but the usual byte XOR is used!  It immediately becomes clear that the code 0x1604 is for single-byte pseudo-CRC.  And it is also clear that the calculated value is returned via R3 to the calling function, and, most likely, the CRC should be compared either with the previously recorded one, or the CRC should be zero.  Here are the two most common integrity checks. <br>  Well, it follows from this that we need the code 0xA04 - we look! <br><br><h3>  <b>0xA04</b> </h3><br>  Similarly, we are looking for a reference to 0x1604 in IDA: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/23b/000/c48/23b000c48f0448b396907f5c92dec8fe.png"></div><br>  Oh, just one function, we are lucky! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/dc9/ee4/1d4/dc9ee41d44004482bdcb52907dee1b24.png"></div><br>  So what can be seen?  The code 0xA04 is set only if the register r3 is not equal to zero.  So, the function at 0x229c8 is our client! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/d5a/cd5/128/d5acd512855a45caa12d91aa79d7b993.png"></div><br>  Immediately pay attention to these parts of the code!  And yes, it also uses the usual XOR, only 4 byte.  If you analyze the function in detail, you can find some conditions that are imposed on the file being checked.  But we do not need it, because we have the file format, and we need only a signature mechanism.  We found it!  Normal XOR 4 bytes. <br>  Especially non-believers can show an approximate decompilation of this site (thanks to <a href="https://retdec.com/">retdec.com</a> ). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/d5c/aa0/2a0/d5caa02a0e1741e7b1ee2cd42e4e909d.png"></div><br>  It remains only to write the CRC count and go for the key!  We write the cherished lines of code a-la while (size--) {crc ^ = * input ++;} and replace the value at the end of the PCI ROM file.  Do not forget to change cheksummu, iii ... We are the champions! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/366/524/b92/366524b929ad474cb30176a32d0a6c95.png"></div><br><h3>  <b>At the "confrontation" will also be interesting!</b> </h3><br>  While doing this task, we bit into nostalgia and remembered the times when the MacBooks were on PowerPC, because not only Intel had a beautiful and diverse world! <br><br>  Participants in the hackquest final competition on June 29 in St. Petersburg will have a wide variety of tasks in which, in addition to reverse, knowledge of steganography, cryptography, the ability to conduct <a href="https://ru.wikipedia.org/wiki/OSINT">OSINT</a> , work with ‚Äúhorned green monsters‚Äù (this is, of course, about Android) and many much more! </div><p>Source: <a href="https://habr.com/ru/post/330004/">https://habr.com/ru/post/330004/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329994/index.html">BI.ZONE Announces CTFzone Presidential Election</a></li>
<li><a href="../329996/index.html">Simple React Router v4 Tutorial</a></li>
<li><a href="../329998/index.html">Quest from EPAM: Five Tasks from .NET Interviews</a></li>
<li><a href="../330000/index.html">‚ÄúThe lifetime of a tab can be almost endless‚Äù: Timofey Chaptykov about JS development on VKontakte</a></li>
<li><a href="../330002/index.html">Analysis of tasks of the WAF Bypass contest on PHDays VII</a></li>
<li><a href="../330006/index.html">Understanding Array.prototype.reduce () and Recursion Using the Example of Apple Pie</a></li>
<li><a href="../330008/index.html">How not to give the algorithm to sell the bank</a></li>
<li><a href="../330010/index.html">HPE 3PAR StoreServ 9450</a></li>
<li><a href="../330012/index.html">Attack on AB test: recipe 'R' + t (101) + 'es46'</a></li>
<li><a href="../330014/index.html">NeoQUEST-2017: what awaits the guests at the jubilee "confrontation"?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>