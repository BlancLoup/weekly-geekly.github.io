<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Telegram-bot for home video surveillance from scrap materials</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Disclaimer 


 This article contains a number of software code written in Python. Due to the fact that the author of an article by profession is a sys...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Telegram-bot for home video surveillance from scrap materials</h1><div class="post__text post__text-html js-mediator-article"><p>  <strong>Disclaimer</strong> </p><br><p>  This article contains a number of software code written in Python.  Due to the fact that the author of an article by profession is a sysadmin, but not a programmer, the style and quality of this code can cause the manifestation of uncontrollable emotions among professionals.  Please stop reading immediately if the appearance of an inaccurate or sub-optimal code may adversely affect your mental state. </p><br><p>  <strong>Formulation of the problem</strong> </p><br><p>  The main reason for the project, was a cold with the consequent: an excess of free time and the inability to leave the house.  Rummaging in my desk, I found: </p><br><ul><li>  <a href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b/">RaspberryPi 3 model B</a> <br><img src="https://habrastorage.org/getpro/habr/post_images/0d7/904/588/0d7904588ead307ae6fa381d30d4b019.jpg" alt="image"></li><li>  <a href="https://www.logitech.com/ru-ru/product/hd-webcam-c270">Logitech C270 webcam</a> <br><img src="https://habrastorage.org/getpro/habr/post_images/bc4/61e/fd6/bc461efd61f121ad1565749fb78fb119.png" alt="image"></li><li>  <a href="https://www.kingston.com/ru/flash/microsd_cards/sdc4">Kingston microSDHC 16 GB memory card</a> </li><li>  A number of wires and adapters </li></ul><br><p>  Of all the above, it was decided to build a home video surveillance system with intrusion alert functionality.  A telegram bot was chosen as the platform.  The bot has the following advantages over other possible implementations (web, mobile application): </p><br><ul><li>  No additional client software installation required. </li><li>  The server part can work with a private IP address via NAT, with the minimum connection requirements (up to 3G modem) </li><li>  Most of the infrastructure is on the side of the service provider, who has solved authorization, security issues and so on for me ... </li></ul><br><p>  Using a cursory analysis of online publications, no existing solutions were found. </p><a name="habracut"></a><br><p>  <strong>Step 1.</strong>  <strong>operating system</strong> </p><br><p>  <a href="http://www.raspbian.org/">Raspbian</a> was used as the operating system.  For those who do not know, this is a Debian build optimized for work on the RaspberryPi hardware.  The system is characterized by stability, a large number of available application software, and good documentation.  System installation is trivial and repeatedly described in different sources.  I will not dwell on this in detail, I will only say that it all comes down to downloading a disk image and recording it on an SD card.  (Obviously, the <a href="https://downloads.raspberrypi.org/raspbian_lite_latest">version without GUI (lite) was used</a> ) Regarding the default settings, the following changes were made: </p><br><ul><li>  Setup OpenSSH server </li><li>  Time zone setting </li><li>  Installing python3-pip, supervisor packages <br><blockquote>  apt-get install python3-pip supervisor <br></blockquote></li><li>  Installing the PyTelegramBotAPI Module <br><blockquote>  pip3 install PyTelegramBotAPI <br></blockquote></li></ul><br><p>  <strong>Step2.</strong>  <strong>Image capture</strong> </p><br><p>  Initially, I planned to use some kind of ready-made solution for saving images from a webcam, and then independently engage in motion detection, but to my luck, <a href="https://motion-project.github.io/">Motion</a> was discovered - a finished product that does exactly what I need: captures images from a webcam and determines are there any changes on them  The package is included in the standard repository and its installation does not cause difficulties: </p><br><blockquote>  apt-get install motion </blockquote><p>  The configuration file (/etc/motion/motion.conf) is so extensive that within the framework of this article it is impossible to describe it completely, I‚Äôll dwell only on those parameters that are significant or have been changed from the standard ones: </p><br><div class="spoiler">  <b class="spoiler_title">motion.conf</b> <div class="spoiler_text"><pre><code class="hljs mel">#  - videodevice /dev/video0 #   ( . ) width <span class="hljs-number"><span class="hljs-number">1280</span></span> height <span class="hljs-number"><span class="hljs-number">720</span></span> #     ( <span class="hljs-number"><span class="hljs-number">2</span></span>,  <span class="hljs-number"><span class="hljs-number">100</span></span>) #   CPU         <span class="hljs-string"><span class="hljs-string">""</span></span> framerate <span class="hljs-number"><span class="hljs-number">4</span></span> #          event_gap <span class="hljs-number"><span class="hljs-number">0</span></span> #    jpg   <span class="hljs-number"><span class="hljs-number">75</span></span> output_pictures on quality <span class="hljs-number"><span class="hljs-number">75</span></span> picture_type jpeg #   ffmpeg_output_movies off # <span class="hljs-number"><span class="hljs-number">30</span></span>    () <span class="hljs-string"><span class="hljs-string">" "</span></span> snapshot_interval <span class="hljs-number"><span class="hljs-number">30</span></span> #        locate_motion_mode on locate_motion_style box #    target_dir /var/lib/motion #     (      <span class="hljs-keyword"><span class="hljs-keyword">snapshot</span></span>) snapshot_filename %v-%Y%m%d%H%M%S-<span class="hljs-keyword"><span class="hljs-keyword">snapshot</span></span> # !      . #           : #   <span class="hljs-number"><span class="hljs-number">1970</span></span>  +       #           #   ,  ... picture_filename %s%q</code> </pre> </div></div><br><p>  Motion automatically creates a symlink to the last saved snapshot named lastsnap.jpg </p><br><p>  <strong>Step 3. Programming</strong> </p><br><p>  Suddenly I had to write significantly less than I had originally planned.  The program consists of two small scripts and a configuration file.  Additionally, in two text files I store information about the mode of operation (the mode of intrusion detection is on or off) and the last processed image. </p><br><p>  The following information is stored in the config.py configuration file: telegram-api-token (how to get it, it <a href="https://khashtamov.com/ru/create-telegram-bot-in-python/">is</a> written in detail <a href="https://khashtamov.com/ru/create-telegram-bot-in-python/">here</a> ), a list of user IDs for which access is allowed, the name of the file with the last snapshot, the path to the folder with all the snapshots. </p><br><div class="spoiler">  <b class="spoiler_title">config.py</b> <div class="spoiler_text"><pre> <code class="python hljs">token = <span class="hljs-string"><span class="hljs-string">'4345435465:AsdfzzsdxgsYnb8DxDtn2L5KjfePsXozjv-o0'</span></span> users=[<span class="hljs-string"><span class="hljs-string">'1234567890'</span></span>,<span class="hljs-string"><span class="hljs-string">'0987654321'</span></span>] lastimage=<span class="hljs-string"><span class="hljs-string">'/var/lib/motion/lastsnap.jpg'</span></span> motiondir=<span class="hljs-string"><span class="hljs-string">'/var/lib/motion'</span></span></code> </pre> </div></div><br><p>  Actually the bot itself.  It has the following features: </p><br><ul><li>  Check if user is allowed to access </li><li>  Report unauthorized user ID (so that he can come with him to me for access) </li><li>  Show last shot taken </li><li>  Enable / Disable Discovery Mode </li><li>  Tell all bot users that the mode has been changed </li></ul><br><div class="spoiler">  <b class="spoiler_title">bot.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> telebot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telebot <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> types <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime logger = telebot.logger telebot.logger.setLevel(logging.INFO) <span class="hljs-comment"><span class="hljs-comment"># Outputs debug messages to console. bot = telebot.TeleBot(config.token, threaded=True) ###    def autor(chatid): strid = str(chatid) for item in config.users: if item == strid: return True return False ###     def sendall(text): if len(config.users) &gt; 0: for user in config.users: try: bot.send_message(user, text) except: print(str(datetime.datetime.now()) + ' ' + '   ' + text + '  ' + str( user)) ###    def checkmode(): try: mode_file = open("mode.txt", "r") modestring = mode_file.read() mode_file.close() if modestring == '1': return True else: return False except: return False print(str(datetime.datetime.now()) + ' ' + ' ,  !') sendall(str(datetime.datetime.now()) + ' ' + ' ,  !') ###   @bot.message_handler(commands=['', 'start', '']) def menu(message): if autor(message.chat.id): markup = types.ReplyKeyboardMarkup() markup.row('/', '/') if checkmode(): bot.send_message(message.chat.id, '  .', reply_markup=markup) else: bot.send_message(message.chat.id, '  .', reply_markup=markup) try: f = open(config.lastimage, 'rb') bot.send_photo(message.chat.id, f) except: bot.send_message(message.chat.id, ' ') else: markup = types.ReplyKeyboardMarkup() markup.row('/') bot.send_message(message.chat.id, '  .  ID: ' + str(message.chat.id), reply_markup=markup) ###   @bot.message_handler(commands=['']) def toggle(message): if autor(message.chat.id): try: if checkmode(): last_file = open("mode.txt", "w") last_file.write('0') last_file.close() sendall(' ' + message.chat.first_name + '   ') else: last_file = open("mode.txt", "w") last_file.write('1') last_file.close() sendall(' ' + message.chat.first_name + '   ') except: bot.send_message(message.chat.id, '  ') print(str(datetime.datetime.now()) + ' ' + "  ") menu(message) if __name__ == '__main__': bot.polling(none_stop=False)</span></span></code> </pre></div></div><br><p>  The second script, run at regular intervals, checks if there are raw jpg files without the word snapshot in the name, and if enabled, the detection mode sends these files to all bot users. </p><br><div class="spoiler">  <b class="spoiler_title">sender.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> telebot <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> config logger = telebot.logger telebot.logger.setLevel(logging.INFO) <span class="hljs-comment"><span class="hljs-comment"># Outputs debug messages to console. bot = telebot.TeleBot(config.token, threaded=True) files = [] clearfiles = [] tosend = [] tosendfull = [] ###    def checkmode(): try: mode_file = open("mode.txt", "r") modestring = mode_file.read() mode_file.close() if modestring == '1': return True else: return False except: return False ##     def sendall(filename): for username in config.users: try: f = open(filename, 'rb') bot.send_photo(username, f) except: print( str(datetime.datetime.now()) + ' ' + '   ' + filename + '  ' + username) ##      def writeproc(filename): try: last_file = open("last.txt", "w") last_file.write(filename) last_file.close() return last_file.close() except: return False ##      def readproc(): try: last_file = open("last.txt", "r") lasstring = last_file.read() last_file.close() lastint = str(lasstring) return lastint except: return -1 ##     processed = readproc() if processed == -1: print(str(datetime.datetime.now()) + ' ' + '     . ') quit(2) ##    files = os.listdir(config.motiondir) files = filter(lambda x: x.endswith('.jpg'), files) ##      ,  for file in files: if ('snapshot' in file) or ('last' in file) or ('-' in file): pass else: clearfile = file[:-4] clearfiles.append(clearfile) clearfiles.sort() ##     for file in clearfiles: if int(file) &gt; int(processed): tosend.append(file) ###    : if len(tosend) &gt; 0: try: if writeproc(tosend[-1]) == False: print(str(datetime.datetime.now()) + ' ' + '   . !') quit(2) else: print(str(datetime.datetime.now()) + ' ' + '   ') ###       -     ##    if checkmode(): ##        for filename in tosend: fullname = config.motiondir + '/' + filename + '.jpg' tosendfull.append(fullname) ##    for filename in tosendfull: sendall(filename) time.sleep(1) else: print(str(datetime.datetime.now()) + ' ' + '  ') except: print(str(datetime.datetime.now()) + ' ' + ' ') else: print(str(datetime.datetime.now()) + ' ' + ' ')</span></span></code> </pre></div></div><br><p>  <strong>Step 4. Putting it all together</strong> <br>  I placed all the scripts in the / home / bigbro / bot directory.  For start, control and logging used supervisor.  Accordingly, in the /etc/supervisor/conf.d directory, I created files of approximately the following form: </p><br><pre> <code class="hljs ruby">[<span class="hljs-symbol"><span class="hljs-symbol">program:</span></span>bot] directory=<span class="hljs-regexp"><span class="hljs-regexp">/home/bigbro</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bot command=/usr</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bin/python</span></span>3 /home/bigbro/botbot.py autostart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> autorestart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> stderr_logfile=<span class="hljs-regexp"><span class="hljs-regexp">/var/log</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bot.err.log stdout_logfile=/var</span></span><span class="hljs-regexp"><span class="hljs-regexp">/log/bot</span></span>.out.log</code> </pre><br><p>  To periodically launch the send script, you could use cron, but for reasons of consistency, I also run it through the supervisor and this bash script: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash while true; do python3 sender.py ; sleep 30; done;</span></span></code> </pre> <br><p>  <strong>Result</strong> <br>  Everything works exactly as it was intended: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/317/3e4/3a2/3173e43a2ae82c80b22149647d9ea3ad.png" alt="image"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/341678/">https://habr.com/ru/post/341678/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341666/index.html">Joker 2017 conference: amazing stories</a></li>
<li><a href="../341668/index.html">R, Asterisk and wardrobe</a></li>
<li><a href="../341670/index.html">Let's try to evaluate Kubernetes</a></li>
<li><a href="../341672/index.html">Do you have a student syndrome?</a></li>
<li><a href="../341676/index.html">No, I do not have third-party projects to show you</a></li>
<li><a href="../341680/index.html">And you still do not pay a premium for on time made projects?</a></li>
<li><a href="../341686/index.html">How to talk about modern web development to the time traveler from 2007</a></li>
<li><a href="../341688/index.html">Angular 5</a></li>
<li><a href="../341690/index.html">Why visual programming and D3NE may be useful to you</a></li>
<li><a href="../341692/index.html">Hello from the Mesozoic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>