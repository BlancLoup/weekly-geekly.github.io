<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Evolution of the Reddit Mobile Architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the first article where we talk about the architecture of the Reddit application for iOS. Here we are talking about functionality that works c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Evolution of the Reddit Mobile Architecture</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/1r/dn/uj/1rdnujtx26d-qbtgc7g3w7g6cui.jpeg"><br><br>  This is the first article where we talk about the architecture of the Reddit application for iOS.  Here we are talking about functionality that works closer to the UI.  In particular, the transition to the <a href="https://en.wikipedia.org/wiki/Model%25E2%2580%2593view%25E2%2580%2593presenter">Model-View-Presenter</a> (MVP) architecture.  The advantages of this refactoring are: <br><br><ul><li>  Improved code flexibility, clarity, and maintainability to support future growth and accelerate iterations. </li><li>  Increase scroll performance 1.58 times. </li><li>  Stimulation of unit testing.  The number of tests increased from a few to more than 200. </li></ul><a name="habracut"></a><br>  Below is an illustrative diagram of our multi-tier architecture.  The first article focuses on the View and Presenter levels. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/51d/640/d33/51d640d336e400357f95b3f1e7c7121d.png"></div><br>  <i><font color="gray">The final look of our layered architecture</font></i> <br><br><h1>  Prerequisites for change </h1><br>  More than a year ago we published the article <a href="https://redditblog.com/2017/06/08/building-the-feed-for-the-reddit-ios-app/">‚ÄúBuilding a Ribbon in the Reddit App for iOS‚Äù</a> .  It discussed how to generate a productive, expandable tape with a remarkable rate of 99.95% of sessions without failures.  We explained how to use the Model-View-Controller (MVC) architecture and create abstractions for paginated data. <br><br>  Now Reddit has grown and continues to grow as an organization and as a service.  Consequently, the requirements for the Reddit iOS application have increased.  It should support more feature requests, faster iteration cycles, and higher quality standards.  The development team has grown from three to more than twenty people.  The original MVC architecture hardly meets these requirements, so architectural changes had to be made. <br><br><h1>  The essence of the problem </h1><br>  Over time, the code lost in flexibility and clarity.  In the community of iOS developers, the MVC abbreviation is often decoded as Massive View Controller, because view controllers often inflate to divine objects in more than a thousand lines.  Despite all our efforts, the problem really arose: the inheritance hierarchy became uncomfortably deep, and the controllers began to turn into incomprehensible divine objects that resist change. <br><br>  We drove the last nail into MVC's coffin when we decided to change the presentation level for the ribbon.  Reddit‚Äôs audience is growing, so scrolling performance has become too often degraded from 60 FPS to 45‚Äì55 FPS.  This means that you need to rewrite the ribbon view layer while maintaining the original implementation.  But in the existing MVC architecture, we could not rewrite the ribbon view layer without duplicating thousands of lines of code. <br><br>  In addition, many parts of the code base are difficult to test.  The code is in the class of the presentation layer that is hard to test, and the dependencies are often in singles (singletons) or hard-coded in the class itself.  We wanted to implement the possibility of normal testing. <br><br>  Other tasks to refactor: the number of failures should remain low, the new architecture should lay the foundation for future growth and not interfere with functions that depend on the existing infrastructure.  That is, evolutionary, not revolutionary, changes are required. <br><br><h1>  Switch to MVP </h1><br>  We decided that a new version of the application is needed to solve the above problems.  After reviewing several options, we decided to use the <a href="https://en.wikipedia.org/wiki/Model%25E2%2580%2593view%25E2%2580%2593presenter">Model-View-Presenter</a> (MVP) architecture.  MVP meets all of the above criteria, and it‚Äôs also a well-known and documented architecture, so it‚Äôs easier to train engineers.  It also retains the concept of ‚Äúview models‚Äù.  If necessary, Presenter can create objects of the representation model <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle">on the basis of the sole responsibility</a> - and use them to extend our views. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9d/71a/cc4/d9d71acc4bf37f6494d524015b4fb55f.png"></div><br>  <i><font color="gray">Model-View-Presenter Chart</font></i> <br><br><h1>  Getting rid of Massive View Controller </h1><br>  For iOS applications, it is assumed that view objects are subclasses of UIView, controller objects are subclasses of UIViewController, and model objects are simple ol objects.  As is clear from the name of the UIViewController, here the view and the controller are combined into one object.  That is, the MVC model on iOS often loses its advantages due to the rigid connection between the presentation layer and the controller.  Interestingly, Apple itself <a href="https://habr.com/post/423531/">recognizes this connection</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b21/06c/33f/b2106c33f786ae4c88477a1bed5d2eb0.png"></div><br>  <i><font color="gray">Often, the Model-View-Controller architecture for iOS turns into</font></i> <br><br>  In MVP architecture, we take this concept into account and formalize it, considering the UIViewController as an explicit object of the presentation layer.  The concept of handling UIViewController as a view object with an unfortunate name has <a href="https://davedelong.com/blog/2018/04/24/a-better-mvc-part-5-an-evolution/">become popular</a> in recent years. <br><br>  So, we delete all extraneous logic in our UIViewControllers.  Then we assign Presenter to the role of intermediary between the view and the model.  In this new role, he does not know about view objects, such as the UIViewController.  Notice that the Presenter interacts with the view through the interface.  Theoretically, you can change the view implementation to NSViewController (for MacOS), etc. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/332/85c/ee2/33285cee27e5526bbdaf6f136487fe4b.png"></div><br>  <i><font color="gray">Facilitate ViewController by introducing Presenter and sharing responsibilities</font></i> <br><br><h1>  Thinking MVP options </h1><br>  As seen in the MVP diagram, the architecture came out very similar to MVC.  Indeed, there are more similarities than differences.  Such an architecture simply helps to establish the <a href="https://martinfowler.com/eaaDev/SeparatedPresentation.html">correct separation of presentation code and business logic</a> , as MVC seeks.  In fact, all derived MV (x) architectures, such as MVP, MVVM, MVAdapter, and others, are simply different versions of the same concept. <br><br>  One may ask why we abandoned MVC at all.  In fact, Apple describes <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/CocoaEncyclopedia/Model-View-Controller/Model-View-Controller.html">different types of controllers</a> : for models, intermediaries and coordination.  Honestly, maybe we could replace our Presenter with another controller.  But they decided not to do this, because most iOS developers for several reasons formed the belief that UIViewController is a synonym for the controller.  Using the word Presenter, we kind of signal that this object differs significantly from a regular controller with a certain set of functions and properties. <br><br><h1>  Improved flexibility, maintainability and clarity </h1><br>  ‚ÄúPrefer composition to inheritance‚Äù is a famous mantra in object programming.  With inheritance, you need to predict the future and build a huge taxonomy of objects.  But if your ‚Äúperfectly‚Äù built inheritance hierarchy begins to fall apart due to unforeseen changes, it is difficult to modify this rigid structure.  In the composition, objects are created from other objects and delegate work to them.  This is useful because it is easy to change the behavior of an object at runtime, simply by changing the objects of which it is composed.  These composite objects are also clearer, since the code is pushed out of the inheritance hierarchy into an abstraction oriented to one specific task. <br><br>  Such composition is one of the main advantages that MVP architecture has given us.  Now you can change the behavior of the controller simply by changing the composition of a specific Presenter.  We are now less worried about decoding the complex and rigid structure of inheritance.  Finally, presentation controllers and Presenter objects are easier to understand because they have a clearer set of tasks. <br><br>  By introducing Presenter and transferring part of the logic of the view controller there, we simplified the inheritance hierarchy of the controller.  The figure below shows that we managed to delete the GalleryFeedViewController class, since we put all this logic in the Presenter.  As already discussed, this inheritance hierarchy is easier to understand and less rigid. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b56/d90/c13/b56d90c13388424bf32dcad9ccbd8b1a.png"></div><br>  <i><font color="gray">Simplify inheritance hierarchy through composition</font></i> <br><br><h1>  Free change of presentation layer implementation </h1><br>  As discussed earlier, tape scrolling performance began to decline from 60 FPS to 45‚Äì55 FPS.  Therefore, for the ribbon view layer, we decided to use <a href="http://texturegroup.org/">Texture</a> .  This is an open source Apple UIKit based platform that improves interface performance by preprocessing in the background thread.  In the previous MVC architecture, we could not change the implementation of the presentation layer without a lot of code duplication. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/836/f03/2dd/836f032dd8dfc3b87940913d0352a9da.png"></div><br>  <i><font color="gray">Before MVP implementation, third-party code that does not belong to View (orange) had to be duplicated in the ViewController.</font></i> <br><br>  The new MVP architecture allowed to introduce support for Texture, and not rewrite things from scratch.  We simply put all non-View logic into the generic Presenter class.  Then they wrote a new implementation of the presentation layer c Texture and reused the Presenter code.  This provided support for both View implementations until it was time to comfortably roll out the tape with Texture for all users. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bcc/4fb/8bc/bcc4fb8bc0d4426c9409015a0528a7ec.png"></div><br>  <i><font color="gray">After implementing MVP: code that is not related to View is moved to a shared Presenter</font></i> <br><br>  What is the result?  The diagram below shows the increase in tape scrolling performance.  We wanted to stay in the 60 FPS area to achieve an absolutely smooth scroll. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/91d/421/7fb/91d4217fbf1d8576f9b28f5d6029ab94.png"></div><br><br><h1>  Unit testing </h1><br>  Of course, we implemented unit tests not only because of MVP, but it was an important factor.  In particular, the MVP architecture has increased the testing area by moving the code to a level where it is easier to check.  A side effect is that the View levels are now easier - and therefore less likely to test them. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb5/1c5/f09/eb51c5f094d5e10252c25110e97514e1.png"></div><br>  <i><font color="gray">Increasing the area of ‚Äã‚Äãtesting after the transfer of code that does not apply to the View, beyond this layer</font></i> <br><br>  Unit tests have improved the maintainability of the code base: they allow you to make changes more confidently and help you understand what the correct behavior should be.  They also make the code more flexible and understandable, because they encourage methods such as dependency injection, composition, and programming abstractions.  The number of unit tests has grown from a few pieces to more than 200. <br><br><h1>  Critical analysis of MVP in Reddit </h1><br>  Although the transition to MVP helped a lot, but there are still some things to be learned. <br><br>  The transition of the tape to the Texture has caused new problems with the threads.  The application did not initially support the asynchronous implementation of View.  That is, errors inevitably appear in the event of a mismatch between the View state and the state of the application.  For example, in the tape view there may be N records.  And in the background thread, the application state has imperceptibly changed - and now contains less than N messages.  If you do not resolve the inconsistency, the application will simply crash when View tries to display the Nth post in the feed. <br><br>  Fixing errors with threads is the hardest.  They are difficult to reproduce, so they are difficult to debug.  I had to change the logic of the request and the data to view the tape.  In particular, we implemented ‚Äúprotection‚Äù with the prohibition of any changes to the data source, when the View of the tape undergoes some changes.  This and other minor fixes have reduced the number of errors associated with stream processing.  However, asynchronous multithreading can still be improved. <br><br>  Secondly, the Presenter layer is an extra ‚Äústep‚Äù in the pipeline.  This step has a price in terms of increasing the complexity of the code and reducing performance.  Sometimes you just want to execute this logic in a UIViewController on a whim or because you are used to doing so.  In the worst case scenario, you find that the Presenter is present simply as an entity, without any meaningful logic.  In such a situation, the Presenter does not seem to justify its existence. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f8c/2b8/4c7/f8c2b84c7672d146fe7b9ac37eee24c8.png"></div><br>  <i><font color="gray">Sometimes you can go from the View layer to the RedditCore layer without the participation of the Presenter</font></i> <br><br>  In fact, our application is not completely transformed into MVP architecture.  First, converting each individual UIViewController to a Presenter will be too time consuming ‚Äî and not an evolutionary change.  Secondly, as mentioned in the previous paragraph, sometimes Presenter is simply not needed.  As we found in the work on implementing Texture for Ribbon, Presenter is great for facilitating massive MVC, or for implementing a View with variable behavior, or if you have complex logic to check.  But sometimes UIViewController is so simple that Presenter does not make sense.  So it is optional.  Presenter should be implemented only when necessary. <br><br><h1>  Summary and future plans </h1><br>  Refactoring the MVP architecture in the Reddit app for iOS helped solve many tasks.  Having introduced the Presenter level, we gradually developed the application architecture to support the new implementation of the presentation level without disrupting other functions.  The code has become clearer by facilitating the ‚Äúmassive MVC‚Äù - the transfer of extraneous logic into the Presenter layer.  We also gave developers the opportunity to more quickly iterate and deploy new features.  And significantly improved the tests. <br><br>  Given all this, there is still a long way to go.  We continue to create Presenter objects and improve them.  You need to continue to move extraneous logic from UIViewControllers to the Presenter level.  It is also necessary that all Presenters better comply with the sole responsibility principle.  In the end, both the application and the architecture evolve constantly. </div><p>Source: <a href="https://habr.com/ru/post/423531/">https://habr.com/ru/post/423531/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../423519/index.html">Wandering monster: how to get rid of problems on the map</a></li>
<li><a href="../423521/index.html">Seven rules of thumb for experimenting with websites</a></li>
<li><a href="../423523/index.html">Combined sensor, with preference and poetess</a></li>
<li><a href="../423527/index.html">Children's apps massively collect personal data and pass it on to third parties.</a></li>
<li><a href="../423529/index.html">What do you need for the whole team to work? How to tighten all the project management system?</a></li>
<li><a href="../423533/index.html">FAQ on intercity passenger bus flights</a></li>
<li><a href="../423535/index.html">Why should trash can access the Internet</a></li>
<li><a href="../423537/index.html">Artificial intelligence in the service of network security. Part 1</a></li>
<li><a href="../423539/index.html">The digest of fresh materials from the world of the frontend for the last two weeks ‚Ññ330 (September 3 - 16, 2018)</a></li>
<li><a href="../423541/index.html">Kodi addons are used to distribute crypto miners</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>