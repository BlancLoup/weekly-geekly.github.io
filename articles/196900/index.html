<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About flags 0x41414141 times</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No matter how much we talk about the need to use flags of the linker and compiler aimed at identifying memory damage and complicating their use - our ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About flags 0x41414141 times</h1><div class="post__text post__text-html js-mediator-article">  No matter how much we <a href="http://habrahabr.ru/company/dsec/blog/141684/">talk</a> about the need to use <a href="http://msdn.microsoft.com/en-us/library/bb430720.aspx">flags of the</a> linker and compiler aimed at identifying memory damage and complicating their use - our developers of DBs, ABS and various certified products, as a rule, do not listen to this.  And when writing a pre-auth RCE server side exploit, once again the idea appeared to write about it on the basis of our latest works. <br><br><img src="https://habrastorage.org/storage3/c4d/175/86c/c4d17586c3ff35601b67e8d60544dbad.png"><br><br><a name="habracut"></a>  So, in the course of one of our recent work on analyzing the security of an application without source code (a client-server application for Windows OS), we found a vulnerability using the fuzzing method.  We were immediately pleased by the fact that for its operation there is no need to know the login and password, since the data leading to the application crash were contained in the first package responsible for authentication (2013 in the yard). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In 2011, our researcher found a similar vulnerability in Oracle PeopleSoft (this vulnerability was closed in <a href="http://www.oracle.com/technetwork/topics/security/cpujan2011-194091.html">CPU January 2011</a> ).  There, the vulnerability manifested itself when entering a password of a certain length.  But we couldn‚Äôt squeeze anything out of the DoS, because the / GS (stack cookie) compilation flag was used, and our overflowed buffer did not reach SEH, and we couldn‚Äôt overwrite it to transfer control to our code. <br><br>  But our new target did not have this.  The only thing she used was DEP.  So writing a remote exploit for Windows 7 was just a formality.  The task was quite simple and boring: rewrite the return address to the <a href="http://www.xakep.ru/post/53257/">chain of ROP gadgets</a> to disable DEP and transfer control to our shellcode, which lay in the same stack. <br><br>  We decided to write an exploit for Windows 8 as well, which introduced a number of <a href="http://media.blackhat.com/bh-us-12/Briefings/M_Miller/BH_US_12_Miller_Exploit_Mitigation_Slides.pdf">additional security mechanisms</a> , of which we were interested in the mechanism responsible for randomizing the load of libraries compiled without the / DYNAMICBASE (ASLR) flag.  This feature is called ForceASLR.  It was introduced, as mentioned, in Windows 8, but is also available for Windows 7 after installing the KB2639308 <a href="http://support.microsoft.com/kb/2639308/en-us">update</a> and a small registry setting for the application of interest (see Image File Execution Option). <br><br>  Adding to <br><pre><code class="bash hljs">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\&lt;executable&gt;</code> </pre> <br>  and for WOW on x64 - in <br><pre> <code class="bash hljs">HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\&lt;executable&gt;</code> </pre><br>  the MitigationOptions key and the value 0x100, you can force ASLR on for the program. <br><br>  So even the last <a href="http://codeinsecurity.wordpress.com/2013/09/09/installing-dropbox-prepare-to-lose-aslr/">Dropbox file</a> itself can be quickly (or system administrator) fixed for Firefox, Chrome for Windows 7/8 users (IE10 is okay in this regard) by turning on ASLR for the necessary programs - however, only in Windows7 / 8, Windows Server 2008 R2, and that is not always ... But more on that later. <br><br>  Let's go back to our story.  We wanted to almost artificially introduce the presence of ASLR for this program, which would break our plan at the stage of preparation of the ROP chain (since now we do not know the address of our ROP gadgets).  But even here disappointment awaited us, since the application was compiled without a relocation table (fixed base address), namely, compulsory randomization of loading the executable file is based on it.  So even the newfangled feature of Windows 8 did not help this software. <br><br>  In order to somehow have fun and surprise the customer, we wrote shellcode, which itself restored the operation of the server being operated, so it wasn‚Äôt even noticeable that it fell, and the clients worked uninterruptedly with it (there could be problems except for clients who only connected to the server) =) To do this, I had to restart the stream and correctly reinitialize all the service structures. <br><br>  <b>Reference.</b>  <b>ASLR bypass techniques:</b> <br><ul><li>  Bust </li><li>  Partial rewriting of EIP </li><li>  Address leak <br><ul><li>  Through vulnerability </li><li>  <a href="http://gdtr.files.wordpress.com/2013/06/leak1.pdf">Through timing attack</a> </li><li>  Through games with lines / objects </li><li>  ... </li></ul></li><li>  Using pre-known addresses <br><ul><li>  <a href="http://www.greyhathacker.net/%3Fp%3D585">Libraries without ASLR</a> </li><li>  System structures ( <a href="http://cansecwest.com/slides/2013/DEP-ASLR%2520bypass%2520without%2520ROP-JIT.pdf">technique with _ KUSER_SHARED_DATA</a> ) </li><li>  <a href="http://kingcope.wordpress.com/2013/01/24/attacking-the-windows-78-address-space-randomization/">Intentional location</a> </li><li>  JIT / Heap spray </li><li>  ... </li></ul></li></ul><br>  Besides the fact that such software is easy to exploit, it is also an opportunity to easily exploit vulnerabilities in other more protected programs, for example, in browsers.  I will explain.  One of the ASLR bypass techniques is a special attack initiated by the attacking library without ASLR into the address space of the attacked application (The last widely known case of using this technique is a targeted attack using the <a href="http://blogs.technet.com/b/srd/archive/2013/09/17/cve-2013-3893-fix-it-workaround-available.aspx">CVE-2013-3893 operation</a> in Internet Explorer).  And the attacker decided to attack clients / employees of the bank (it‚Äôs not a secret, of course, what kind of RBS system is used) or a government institution (and, naturally, the secret is not a list of certified software allowed to work in such companies for encryption, demarcation). access, memory cleanup, etc.).  An attacker, examining this software, will try to load them (if they do not load themselves), since they are mostly without ASLR.  And at the same time a good targeted attack is obtained.  After all, if the browser does not load, for example, an ActiveX-element of a certain RBS system, then the victim, most likely, is not a client of this bank, and therefore the target of the attacker. <br><br><img src="https://habrastorage.org/storage3/08c/674/4d2/08c6744d20aab1e13bfe41be6da78925.png"><br><br>  This example wanted to show how heterogeneous systems are now and how sophisticated attacks are.  Do not forget that a huge amount of software lives on the user's computer at the same time.  Weak software can be used to compromise your software, or your software to compromise someone else's. <br><br>  <b>History reference:</b> <br><ul><li>  GS appeared in 2002 </li><li>  SafeSEH appeared in 2003 </li><li>  DEP appeared in 2004 </li><li>  ASLR appeared in 2006 </li><li>  ForceASLR appeared in 2012 </li></ul><br>  The appearance of the mechanism does not mean that it has become enabled by default in VisualStudio.  See what your projects use from this, and correlate to which year of release they are from a security point of view. <br><br>  Remember that with the transition to a new studio, you get not only a new graphical user interface and programmer news, but also all the new features of the compiler and linker, of which very many are related to security.  For some, it may be news, but even the / GS flag has <a href="http://blogs.technet.com/b/srd/archive/2013/10/02/software-defense-mitigating-stack-corruption-vulnerabilties.aspx">evolved</a> and by 2010 is version 4, not to mention a <a href="http://inseclab.org/papers/smashing_w8_stack.pdf">number of improvements</a> , such as pointer protection, heap metadata protection, and the order of variables on the stack, which even sometimes do not have special names . <br><br>  For the sake of completeness, we say that ASLR and DEP can be configured not only through flags, but also using the registry and a special API: MitigationOptions in IFEO (Image File Execution Option), UpdateProcThreadAttribute, SetProcessMitigationPolicy API, but with flags much easier. <br><br>  To increase user security, of course, there is such a thing as EMET ( <a href="http://habrahabr.ru/company/eset/blog/184428/">Enhanced Mitigation Experience Toolkit</a> ), but we, unfortunately, agree with the comment to the article at the link: " <i>And yet this thing is for very advanced users</i> ."  I do not mean the complexity of working with the program, but the weak computer literacy of most users. <br><br>  Spend a few minutes of time, set the flags of the compiler and linker, and you will complicate many times, and in some cases make it impossible to write a stable working exploit.  As a result, the attacker will be content with only DoS. <br><br>  Yes, there are similar (and specific) flags for mobile platforms: <br>  <b>iOS</b> : ‚ÄìfPIE, ‚Äìfstack-protector-all, -fobjc-arc <br>  <b>Android</b> (for native libraries): -fstack-protector, -Wformat-security, NX, ASLR, PIE <br>  <b>BlackBerry 10</b> (for native libraries): - fstack-protector-all, -D_FORTIFY_SOURCE = 2, -fPIE, -Wl, -z, relro, -Wl, -z, now, -pie <br>  <b>WindowsPhone 8</b> (for native libraries): similar to Windows 8 <br><br>  Not everyone can immediately write a safe code (unrealistic), not everyone can afford software for analyzing code security (the budget does not allow), not everyone can quickly and painlessly implement SDL into a company (this, of course, we must strive for), but everyone can set the flags.  So with minimal effort, you can significantly increase security. <br><br>  <i>PS: Naturally, compilation flags do not affect architectural, logical and configuration vulnerabilities;)</i> <i><br></i>  <i>PPS: There are also sandboxes and virtualization, but this is not a panacea either.</i>  <i>About them - already at <a href="http://www.zeronights.ru/">ZeroNights 2013</a> !</i> </div><p>Source: <a href="https://habr.com/ru/post/196900/">https://habr.com/ru/post/196900/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196884/index.html">With a camera in the clouds. Part 1</a></li>
<li><a href="../196886/index.html">(Archive) Matreshka.js - MK.Object</a></li>
<li><a href="../196888/index.html">"Boost.Asio C ++ Network Programming". Chapter 6: - other features</a></li>
<li><a href="../196894/index.html">Another way to spend money - thanks to the "beloved" mobile operator!</a></li>
<li><a href="../196896/index.html">Ask questions to the experts. How can developers get help from Intel?</a></li>
<li><a href="../196904/index.html">RAD Studio XE5 World Tour in Lviv, Ufa, Kiev, Minsk</a></li>
<li><a href="../196910/index.html">Opera 17 release</a></li>
<li><a href="../196912/index.html">SlideStackView or Extending ViewGroup on Android (part 2)</a></li>
<li><a href="../196916/index.html">Agile application in a fixed phase contract</a></li>
<li><a href="../196920/index.html">God bless Dynamic SQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>