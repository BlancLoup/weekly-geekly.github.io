<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DDD in practice. Design a wish list</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a lot of scattered material on DDD on the Internet. Except for the blue book, these are mostly short articles with a theory, drawn from the s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DDD in practice. Design a wish list</h1><div class="post__text post__text-html js-mediator-article"><p>  There is a lot of scattered material on <abbr title="Domain-oriented design">DDD</abbr> on the Internet.  Except for the blue book, these are mostly short articles with a theory, drawn from the same book, and which intersects little with practice.  It is possible, of course, that I was simply looking badly, but I have long wanted to find some integral example, as they say, ‚Äúfrom and to‚Äù.  And I decided to create such an example on Symfony 3 and VueJS.  Just want to say that I have been studying DDD recently, so I took a fairly simple subject area - <a href="https://github.com/franzose/symfony-ddd-wishlist">the</a> wish list. </p><a name="habracut"></a><br><h2 id="spisok-zhelaniy">  A wish list </h2><br><p>  Anyone ever buys something.  Be it a new phone, a gift, a trip abroad or even an apartment.  The wish list, as an addition to the ‚Äúhard money‚Äù money box, is designed to help track the accumulated funds for each of the wishes and make these funds constantly increase.  For example, today I decided to start saving money on a new laptop: I‚Äôll add a wish and start saving money.  And tomorrow I want to calculate how much money will need to be put off daily, so that in six months I could buy a good gift for my wife. </p><br><h2 id="zhelanie">  A wish </h2><br><p>  The desires that we consider can be satisfied by buying something for money.  From this it follows that every desire has a <em>cost</em> , an <em>initial fund</em> (if you started saving money before you decided to add a wish to the list) and accumulated funds - a <em>fund</em> that is expressed by the sum of all <em>contributions</em> .  A deposit is a lump sum of money for a specific desire.  Since desires require regular investment, it would be nice to determine the <em>base rate</em> , below which the amount of the deposit can not be.  In addition, we should be able to track contributions to any of the desires, in order to withdraw them, if necessary.  With the accumulation of a sufficient amount of funds desire becomes fulfilled.  If there is an excess of cash, then it can be redistributed to his other desires (about this in one of the following articles). </p><br><h3 id="proektiruem-suschnosti">  Design Entities </h3><br><p> Based on the above requirements, we can encode two entities: <code>Wish</code> (desire) and <code>Deposit</code> (contribution). </p><br><h3 id="zhelanie-konstruktor-suschnosti">  Desire: Entity Designer </h3><br><p>  Let's start with a desire and think about what fields we need and how we design the entity constructor.  The first thing that comes to mind is something like this code: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DateTimeImmutable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Collections</span></span>\<span class="hljs-title"><span class="hljs-title">ArrayCollection</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Wish</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $price; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $fee; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $deposits; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $initialFund; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $createdAt; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $updatedAt; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( string $name, int $price, int $fee, int $initialFund )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;name = $name; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;price = $price; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;fee = $fee; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;initialFund = $initialFund; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deposits = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayCollection(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createdAt = $createdAt ?? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTimeImmutable(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;updatedAt = $createdAt ?? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTimeImmutable(); } }</code> </pre><br><p>  However, there are a number of problems: </p><br><ol><li>  Surrogate key used </li><li>  No validation fields </li><li>  If validation is encoded in the constructor, it will become even more monstrous. </li><li>  No information about the currency in which the calculations are carried out </li><li>  The constructor is overloaded with arguments. </li></ol><br><p>  What are we going to do?  There is a solution to use value objects.  Then the constructor of our entity will be transformed as follows: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DateTimeImmutable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Collections</span></span>\<span class="hljs-title"><span class="hljs-title">ArrayCollection</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Wish</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $expense; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $deposits; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $published = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $createdAt; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $updatedAt; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( WishId $id, WishName $name, Expense $expense, DateTimeImmutable $createdAt = null )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id = $id; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;name = $name; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;expense = $expense; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deposits = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayCollection(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createdAt = $createdAt ?? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTimeImmutable(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;updatedAt = $createdAt ?? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTimeImmutable(); } }</code> </pre><br><p>  We used three value objects: </p><br><ol><li>  <code>WishId</code> , which is a <code>UUID</code> generated using the <a href="https://github.com/ramsey/uuid">ramsey / uuid</a> library </li><li>  <code>WishName</code> - the name of the desire </li><li>  <code>Expense</code> , which represents "spending" on desire: cost, base rate and initial fund (perhaps not the most successful name, but I did not invent another one) </li></ol><br><p>  You may ask: why did the date of its creation hit the entity constructor?  I will answer you: this is done to facilitate the writing of tests and is not used anywhere except for tests.  Perhaps not the best solution, of course. </p><br><p>  Well, since we used value objects, it would be nice to look at their implementation.  To begin with, we will think about how to implement identifiers (looking ahead, I‚Äôll say that in addition to <code>WishId</code> , we will also have <code>DepositId</code> ).  To do this, we will write a simple test using the example of one of them (the essence is the same, so there is no point in writing two different tests): </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Tests</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">WishId</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PHPUnit</span></span>\<span class="hljs-title"><span class="hljs-title">Framework</span></span>\<span class="hljs-title"><span class="hljs-title">TestCase</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IdentityTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFromValidString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $string = <span class="hljs-string"><span class="hljs-string">'550e8400-e29b-41d4-a716-446655440000'</span></span>; $wishId = WishId::fromString($string); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertInstanceOf(WishId::class, $wishId); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertEquals($string, $wishId-&gt;getId()); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertEquals($string, (string) $wishId); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testEquality</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $string = <span class="hljs-string"><span class="hljs-string">'550e8400-e29b-41d4-a716-446655440000'</span></span>; $wishIdOne = WishId::fromString($string); $wishIdTwo = WishId::fromString($string); $wishIdThree = WishId::next(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertTrue($wishIdOne-&gt;equalTo($wishIdTwo)); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertFalse($wishIdTwo-&gt;equalTo($wishIdThree)); } }</code> </pre><br><p>  Based on these tests, we can make a basic class of identifiers that contains common logic: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ramsey</span></span>\<span class="hljs-title"><span class="hljs-title">Uuid</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">InvalidUuidStringException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ramsey</span></span>\<span class="hljs-title"><span class="hljs-title">Uuid</span></span>\<span class="hljs-title"><span class="hljs-title">Uuid</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Ramsey</span></span>\<span class="hljs-title"><span class="hljs-title">Uuid</span></span>\<span class="hljs-title"><span class="hljs-title">UuidInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">InvalidIdentityException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UuidInterface $id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id = $id; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>(Uuid::fromString($id)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InvalidUuidStringException $exception) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidIdentityException($id); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>(Uuid::uuid4()); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id-&gt;toString(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equalTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AbstractId $id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getId() === $id-&gt;getId(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getId(); } }</code> </pre><br><p>  And the "real" identifiers are just to "get rid of" him: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WishId</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// }</span></span></code> </pre><br><p>  And the same with DepositId: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DepositId</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractId</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// }</span></span></code> </pre><br><p>  Now consider <code>WishName</code> .  This is the simplest object value, and we only need the name not to be empty.  Let's first write the tests: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Tests</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">WishName</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PHPUnit</span></span>\<span class="hljs-title"><span class="hljs-title">Framework</span></span>\<span class="hljs-title"><span class="hljs-title">TestCase</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WishNameTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \InvalidArgumentException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testShouldNotCreateWithEmptyString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WishName(<span class="hljs-string"><span class="hljs-string">''</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGetValueShouldReturnTheName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $expected = <span class="hljs-string"><span class="hljs-string">'A bucket of candies'</span></span>; $name = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WishName($expected); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertEquals($expected, $name-&gt;getValue()); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertEquals($expected, (string) $name); } }</code> </pre><br><p>  Now let's actually code <code>WishName</code> .  By the way, for checking here and further, we will use the very convenient <a href="https://github.com/webmozart/assert">webmozart / assert</a> library: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Webmozart</span></span>\<span class="hljs-title"><span class="hljs-title">Assert</span></span>\<span class="hljs-title"><span class="hljs-title">Assert</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WishName</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $name; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $name)</span></span></span><span class="hljs-function"> </span></span>{ Assert::notEmpty($name, <span class="hljs-string"><span class="hljs-string">'Name must not be empty.'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;name = $name; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;name; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getValue(); } }</code> </pre><br><p>  We now turn to a more interesting object-value - <code>Expense</code> .  It is designed to monitor the correct values ‚Äã‚Äãof the cost, base rate and initial fund.  We will help him in this by defining the requirements: </p><br><ol><li>  Cost can only be a positive number. </li><li>  The same applies to the base rate. </li><li>  Initial fund cannot be a negative number if specified </li></ol><br><p>  In addition, the following restrictions apply to properties: </p><br><ol><li>  Base rate must be less than the cost </li><li>  The initial fund must also be less than the cost. </li></ol><br><p>  Since we also need a currency, we will not use ‚Äúbare‚Äù <code>int</code> 's to work with money, but use the <a href="https://github.com/moneyphp/money">moneyphp / money</a> library.  Considering the above, about <code>Expense</code> , we will write the following tests: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Tests</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Money</span></span>\<span class="hljs-title"><span class="hljs-title">Currency</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Money</span></span>\<span class="hljs-title"><span class="hljs-title">Money</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Expense</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PHPUnit</span></span>\<span class="hljs-title"><span class="hljs-title">Framework</span></span>\<span class="hljs-title"><span class="hljs-title">TestCase</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExpenseTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \InvalidArgumentException * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@dataProvider</span></span></span><span class="hljs-comment"> nonsensePriceDataProvider */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testPriceAndFeeMustBePositiveNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($price, $fee, $initialFund)</span></span></span><span class="hljs-function"> </span></span>{ Expense::fromCurrencyAndScalars(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>), $price, $fee, $initialFund); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nonsensePriceDataProvider</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'Price must be greater than zero'</span></span> =&gt; [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">'Fee must be greater than zero'</span></span> =&gt; [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">'Price must be positive'</span></span> =&gt; [<span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">'Fee must be positive'</span></span> =&gt; [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">'Initial fund must be positive'</span></span> =&gt; [<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>], ]; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \InvalidArgumentException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFeeMustBeLessThanPrice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Expense::fromCurrencyAndScalars(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>), <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \InvalidArgumentException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testInitialFundMustBeLessThanPrice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Expense::fromCurrencyAndScalars(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>), <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \InvalidArgumentException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testNewPriceMustBeOfTheSameCurrency</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $expense = Expense::fromCurrencyAndScalars(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>), <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>); $expense-&gt;changePrice(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'RUB'</span></span>))); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testChangePriceMustReturnANewInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $expense = Expense::fromCurrencyAndScalars(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>), <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>); $actual = $expense-&gt;changePrice(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertNotSame($expense, $actual); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertEquals(<span class="hljs-number"><span class="hljs-number">200</span></span>, $actual-&gt;getPrice()-&gt;getAmount()); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \InvalidArgumentException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testNewFeeMustBeOfTheSameCurrency</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $expense = Expense::fromCurrencyAndScalars(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>), <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>); $expense-&gt;changeFee(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'RUB'</span></span>))); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testChangeFeeMustReturnANewInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $expense = Expense::fromCurrencyAndScalars(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>), <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>); $actual = $expense-&gt;changeFee(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertNotSame($expense, $actual); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertEquals(<span class="hljs-number"><span class="hljs-number">20</span></span>, $actual-&gt;getFee()-&gt;getAmount()); } }</code> </pre><br><p>  In them, among other things, laid the possibility of changing the value and the base rate of desire.  Therefore, the class contains two additional tests for matching currencies. </p><br><p>  Now we can encode <code>Expense</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Money</span></span>\<span class="hljs-title"><span class="hljs-title">Currency</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Money</span></span>\<span class="hljs-title"><span class="hljs-title">Money</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Webmozart</span></span>\<span class="hljs-title"><span class="hljs-title">Assert</span></span>\<span class="hljs-title"><span class="hljs-title">Assert</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Expense</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $price; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $fee; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $initialFund; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Money $price, Money $fee, Money $initialFund)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;price = $price; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;fee = $fee; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;initialFund = $initialFund; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromCurrencyAndScalars</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Currency $currency, int $price, int $fee, int $initialFund = null )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ([$price, $fee] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $argument) { Assert::notEmpty($argument); Assert::greaterThan($argument, <span class="hljs-number"><span class="hljs-number">0</span></span>); } Assert::lessThan($fee, $price, <span class="hljs-string"><span class="hljs-string">'Fee must be less than price.'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> !== $initialFund) { Assert::greaterThanEq($initialFund, <span class="hljs-number"><span class="hljs-number">0</span></span>); Assert::lessThan($initialFund, $price, <span class="hljs-string"><span class="hljs-string">'Initial fund must be less than price.'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money($price, $currency), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money($fee, $currency), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money($initialFund ?? <span class="hljs-number"><span class="hljs-number">0</span></span>, $currency) ); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrency</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Currency</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;price-&gt;getCurrency(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPrice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Money</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;price; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changePrice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Money $amount)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Expense</span></span></span><span class="hljs-function"> </span></span>{ Assert::true($amount-&gt;getCurrency()-&gt;equals(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getCurrency())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($amount, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;fee, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;initialFund); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFee</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Money</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;fee; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeFee</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Money $amount)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Expense</span></span></span><span class="hljs-function"> </span></span>{ Assert::true($amount-&gt;getCurrency()-&gt;equals(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getCurrency())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;price, $amount, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;initialFund); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInitialFund</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Money</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;initialFund; } }</code> </pre><br><p>  So, we looked at all the value objects that are used by the <code>Wish</code> entity, with its constructor determined, so now it's time to go directly to the business logic. </p><br><h3 id="zhelanie-kopim-denezhki">  Desire: saving money </h3><br><p>  Imagine an ordinary piggy bank.  There put coins or pieces of paper of a certain denomination and currency.  Those.  Contribution is made to the piggy bank.  As soon as the piggy bank is filled to the top, it is broken.  So it is with us with our desires: we invest some amount of money in them, and when a sufficient amount is accumulated, we believe that the wish is fulfilled (you can go to the store :) and therefore it is already meaningless to make contributions to it.  There is another small limitation: contributions can be made only if the wish is published (for example, you can postpone it until better times). </p><br><p>  It's time to write tests again. </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Tests</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DateInterval</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DateTimeImmutable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Money</span></span>\<span class="hljs-title"><span class="hljs-title">Currency</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Money</span></span>\<span class="hljs-title"><span class="hljs-title">Money</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">FrameworkBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Tests</span></span>\<span class="hljs-title"><span class="hljs-title">TestCase</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">DepositId</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Expense</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Wish</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">WishId</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">WishName</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WishTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \Wishlist\Domain\Exception\DepositIsTooSmallException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMustDeclineDepositIfItIsLessThanFee</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithPriceAndFee(<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); $wish-&gt;publish(); $wish-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testExtraDepositMustFulfillTheWish</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithPriceAndFund(<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">900</span></span>); $wish-&gt;publish(); $wish-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertTrue($wish-&gt;isFulfilled()); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \Wishlist\Domain\Exception\WishIsUnpublishedException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMustNotDepositWhenUnpublished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithEmptyFund(); $wish-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \Wishlist\Domain\Exception\WishIsFulfilledException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMustNotDepositWhenFulfilled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $fulfilled = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithPriceAndFund(<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">450</span></span>); $fulfilled-&gt;publish(); $fulfilled-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); $fulfilled-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testDepositShouldAddDepositToInternalCollection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithEmptyFund(); $wish-&gt;publish(); $depositMoney = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>)); $wish-&gt;deposit($depositMoney); $deposits = $wish-&gt;getDeposits(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertCount(<span class="hljs-number"><span class="hljs-number">1</span></span>, $deposits); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertArrayHasKey(<span class="hljs-number"><span class="hljs-number">0</span></span>, $deposits); $deposit = $deposits[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertTrue($deposit-&gt;getMoney()-&gt;equals($depositMoney)); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertSame($wish, $deposit-&gt;getWish()); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \InvalidArgumentException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testDepositAndPriceCurrenciesMustMatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithEmptyFund(); $wish-&gt;publish(); $wish-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">125</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'RUB'</span></span>))); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createWishWithEmptyFund</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Wish</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Wish( WishId::next(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WishName(<span class="hljs-string"><span class="hljs-string">'Bicycle'</span></span>), Expense::fromCurrencyAndScalars( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>), <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span> ) ); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createWishWithPriceAndFund</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $price, int $fund)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Wish</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Wish( WishId::next(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WishName(<span class="hljs-string"><span class="hljs-string">'Bicycle'</span></span>), Expense::fromCurrencyAndScalars( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>), $price, <span class="hljs-number"><span class="hljs-number">10</span></span>, $fund ) ); } }</code> </pre><br><p>  To make the tests work, we add several methods to the essence of <code>Wish</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... //    use   use Wishlist\Domain\Exception\DepositIsTooSmallException; use Wishlist\Domain\Exception\WishIsFulfilledException; use Wishlist\Domain\Exception\WishIsUnpublishedException; // ... public function deposit(Money $amount): Deposit { $this-&gt;assertCanDeposit($amount); $deposit = new Deposit(DepositId::next(), $this, $amount); $this-&gt;deposits-&gt;add($deposit); return $deposit; } private function assertCanDeposit(Money $amount) { if (!$this-&gt;published) { throw new WishIsUnpublishedException($this-&gt;getId()); } if ($this-&gt;isFulfilled()) { throw new WishIsFulfilledException($this-&gt;getId()); } if ($amount-&gt;lessThan($this-&gt;getFee())) { throw new DepositIsTooSmallException($amount, $this-&gt;getFee()); } Assert::true( $amount-&gt;isSameCurrency($this-&gt;expense-&gt;getPrice()), 'Deposit currency must match the price\'s one.' ); } public function isFulfilled(): bool { return $this-&gt;getFund()-&gt;greaterThanOrEqual($this-&gt;expense-&gt;getPrice()); } public function publish() { $this-&gt;published = true; $this-&gt;updatedAt = new DateTimeImmutable(); } public function unpublish() { $this-&gt;published = false; $this-&gt;updatedAt = new DateTimeImmutable(); } public function getFund(): Money { return array_reduce($this-&gt;deposits-&gt;toArray(), function (Money $fund, Deposit $deposit) { return $fund-&gt;add($deposit-&gt;getMoney()); }, $this-&gt;expense-&gt;getInitialFund()); }</span></span></code> </pre><br><p>  Consider all these methods in turn. </p><br><ol><li>  <code>deposit</code> - checks whether a <code>deposit</code> can be made, and if it can, it makes a contribution to the desire for the specified amount of money.  To do this, create an entity of the entity Deposit and save it to the internal collection of deposits. </li><li>  <code>isFulfilled</code> - indicates whether the desire is fulfilled.  Well, we have previously determined that the desire is considered fulfilled if its savings are greater than or equal to the value. </li><li>  <code>publish/unpublish</code> - publishes or puts into drafts, respectively. </li><li>  <code>getFund</code> - returns the fund, i.e.  accumulated funds. </li></ol><br><p>  You must have noticed that the eponymous entity is used in the <code>Wish::deposit</code> method.  Now, in order to continue to develop the business logic of desire further, we need to program the essence of <code>Deposit</code> .  Let's do it and take care of, the good is that it is much simpler and it will not take much time. </p><br><h3 id="deposit-konstruktor">  Deposit: Designer </h3><br><p>  The contribution will have only four properties: </p><br><ol><li>  ID, as this is an entity, and you also need to be able to manage deposits </li><li>  The desire this contribution relates to </li><li>  Amount of deposit </li><li>  Date of deposit </li></ol><br><p>  It is also necessary to take into account that the contribution cannot be zero, since it is meaningless, as if we were putting imaginary money in our piggy bank, and in our hands we would not even have a toy equivalent of money :). </p><br><p>  As always, let's start with the tests: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Tests</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Mockery</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Money</span></span>\<span class="hljs-title"><span class="hljs-title">Currency</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Money</span></span>\<span class="hljs-title"><span class="hljs-title">Money</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PHPUnit</span></span>\<span class="hljs-title"><span class="hljs-title">Framework</span></span>\<span class="hljs-title"><span class="hljs-title">TestCase</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Deposit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">DepositId</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>\<span class="hljs-title"><span class="hljs-title">Wish</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DepositTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \InvalidArgumentException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testDepositAmountMustNotBeZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = Mockery::mock(Wish::class); $amount = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Deposit(DepositId::next(), $wish, $amount); } }</code> </pre><br><p>  In this test, we used the <a href="https://github.com/mockery/mockery">mockery / mockery library</a> in order not to fully describe the desire, since  we are interested in the logic of the contribution itself.  Here there is a reason for the discussion of whether it is necessary to do in the <code>Deposit</code> constructor a desire check, similar to that done in the <code>Wish::deposit</code> method.  I did not do this, since the <code>Deposit</code> entity is not used anywhere directly, all operations with deposits, which will be discussed in the article, are carried out only in the essence of <code>Wish</code> . </p><br><p>  The result is such a simple entity: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DateTimeImmutable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DateTimeInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Money</span></span>\<span class="hljs-title"><span class="hljs-title">Money</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Webmozart</span></span>\<span class="hljs-title"><span class="hljs-title">Assert</span></span>\<span class="hljs-title"><span class="hljs-title">Assert</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Deposit</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $wish; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $amount; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $createdAt; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DepositId $id, Wish $wish, Money $amount)</span></span></span><span class="hljs-function"> </span></span>{ Assert::false($amount-&gt;isZero(), <span class="hljs-string"><span class="hljs-string">'Deposit must not be empty.'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id = $id; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;wish = $wish; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;amount = $amount; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createdAt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTimeImmutable(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DepositId</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWish</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Wish</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;wish; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMoney</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Money</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;amount; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DateTimeInterface</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createdAt; } }</code> </pre><br><h3 id="zhelanie-izymaem-vklad">  Desire: we withdraw contribution </h3><br><p>  With the essence of <code>Deposit</code> figured out, you can now return to programming desire.  By the condition of the task, we can not only accumulate money on desire, but also withdraw deposits already made.  For example, if one of them was made by mistake. </p><br><p>  Naturally, we first add a few tests to the <code>WishTest</code> class: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \Wishlist\Domain\Exception\WishIsUnpublishedException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMustNotWithdrawIfUnpublished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithPriceAndFund(<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); $wish-&gt;publish(); $deposit = $wish-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); $wish-&gt;unpublish(); $wish-&gt;withdraw($deposit-&gt;getId()); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \Wishlist\Domain\Exception\WishIsFulfilledException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMustNotWithdrawIfFulfilled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithPriceAndFund(<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">450</span></span>); $wish-&gt;publish(); $deposit = $wish-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); $wish-&gt;withdraw($deposit-&gt;getId()); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@expectedException</span></span></span><span class="hljs-comment"> \Wishlist\Domain\Exception\DepositDoesNotExistException */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testWithdrawMustThrowOnNonExistentId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithEmptyFund(); $wish-&gt;publish(); $wish-&gt;withdraw(DepositId::next()); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testWithdrawShouldRemoveDepositFromInternalCollection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithEmptyFund(); $wish-&gt;publish(); $wish-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); $wish-&gt;withdraw($wish-&gt;getDeposits()[<span class="hljs-number"><span class="hljs-number">0</span></span>]-&gt;getId()); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertCount(<span class="hljs-number"><span class="hljs-number">0</span></span>, $wish-&gt;getDeposits()); }</code> </pre><br><p>  As you can see, the restrictions on the withdrawal of deposits are similar to those that we wrote to make them.  Now we add the necessary logic to the desire class: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlish</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;...&gt; public function withdraw(DepositId $depositId) { $this-&gt;assertCanWithdraw(); $deposit = $this-&gt;getDepositById($depositId); $this-&gt;deposits-&gt;removeElement($deposit); } private function assertCanWithdraw() { if (!$this-&gt;published) { throw new WishIsUnpublishedException($this-&gt;getId()); } if ($this-&gt;isFulfilled()) { throw new WishIsFulfilledException($this-&gt;getId()); } } private function getDepositById(DepositId $depositId): Deposit { $deposit = $this-&gt;deposits-&gt;filter( function (Deposit $deposit) use ($depositId) { return $deposit-&gt;getId()-&gt;equalTo($depositId); } )-&gt;first(); if (!$deposit) { throw new DepositDoesNotExistException($depositId); } return $deposit; }</span></span></code> </pre><br><p>  As they say, in any incomprehensible situation, throw an exept!  The <code>withdraw</code> method turned out to be quite simple, however we took into account all the conditions of the problem: </p><br><ol><li>  It will not be possible to withdraw a contribution that is not </li><li>  We will not be able to do this if the desire is in draft or has already been fulfilled. </li></ol><br><h3 id="zhelanie-rasschityvaem-izlishki-nakopleniy">  Desire: expect surplus savings </h3><br><p>  The function is not the most important, in fact, but it is done in the event that one day it turns out that there is no sufficient amount at hand to replenish stocks, but there is a large one.  Well, or, for example, if you set aside sufficiently large amounts for a wish, and then you simply ‚Äúmissed‚Äù, not keeping up with the amount of funds already available.  To calculate the surplus is, in fact, simple: from the value of the desire we subtract its fund and take the absolute value.  If the difference was positive, the excess can be considered equal to zero. </p><br><p>  <code>WishTest</code> add <code>WishTest</code> class <code>WishTest</code> new tests: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSurplusFundsMustBe100</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithPriceAndFund(<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span>); $wish-&gt;publish(); $wish-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); $wish-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); $expected = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertTrue($wish-&gt;calculateSurplusFunds()-&gt;equals($expected)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSurplusFundsMustBeZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithPriceAndFund(<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">250</span></span>); $wish-&gt;publish(); $wish-&gt;deposit(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>))); $expected = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertTrue($wish-&gt;calculateSurplusFunds()-&gt;equals($expected)); }</code> </pre><br><p>  Based on the above and the written tests, we can write this method, in essence, <code>Wish</code> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;...&gt; public function calculateSurplusFunds(): Money { $difference = $this-&gt;getPrice()-&gt;subtract($this-&gt;getFund()); return $difference-&gt;isNegative() ? $difference-&gt;absolute() : new Money(0, $this-&gt;getCurrency()); }</span></span></code> </pre><br><h3 id="zhelanie-vanguem-datu-ispolneniya"> :    </h3><br><p>       : </p><br><ol><li>       </li><li>       </li></ol><br><p>   :     ,     ,     .      ,      . </p><br><p>    .     ,      ,        ,          . </p><br><p>  ,  : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFulfillmentDatePredictionBasedOnFee</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $price = <span class="hljs-number"><span class="hljs-number">1500</span></span>; $fee = <span class="hljs-number"><span class="hljs-number">20</span></span>; $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithPriceAndFee($price, $fee); $daysToGo = ceil($price / $fee); $expected = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTimeImmutable())-&gt;add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateInterval(<span class="hljs-string"><span class="hljs-string">"P{$daysToGo}D"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertEquals( $expected-&gt;getTimestamp(), $wish-&gt;predictFulfillmentDateBasedOnFee()-&gt;getTimestamp() ); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFulfillmentDatePredictionBasedOnFund</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $price = <span class="hljs-number"><span class="hljs-number">1500</span></span>; $fund = <span class="hljs-number"><span class="hljs-number">250</span></span>; $fee = <span class="hljs-number"><span class="hljs-number">25</span></span>; $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWish($price, $fee, $fund); $daysToGo = ceil(($price - $fund) / $fee); $expected = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTimeImmutable())-&gt;add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateInterval(<span class="hljs-string"><span class="hljs-string">"P{$daysToGo}D"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertEquals( $expected-&gt;getTimestamp(), $wish-&gt;predictFulfillmentDateBasedOnFund()-&gt;getTimestamp() ); }</code> </pre> <br><p>    ,        : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">predictFulfillmentDateBasedOnFee</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DateTimeInterface</span></span></span><span class="hljs-function"> </span></span>{ $daysToGo = ceil( <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getPrice() -&gt;divide(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getFee()-&gt;getAmount()) -&gt;getAmount() ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createFutureDate($daysToGo); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">predictFulfillmentDateBasedOnFund</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DateTimeInterface</span></span></span><span class="hljs-function"> </span></span>{ $daysToGo = ceil( <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getPrice() -&gt;subtract(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getFund()) -&gt;divide(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getFee()-&gt;getAmount()) -&gt;getAmount() ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createFutureDate($daysToGo); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createFutureDate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($daysToGo)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DateTimeInterface</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTimeImmutable())-&gt;add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateInterval(<span class="hljs-string"><span class="hljs-string">"P{$daysToGo}D"</span></span>)); }</code> </pre> <br><h3 id="zhelanie-menyaem-sostoyanie"> :   </h3><br><p> ,       , ‚Äî   ,    : </p><br><ol><li>     ¬´¬ª </li><li>  Change in value </li><li>     </li></ol><br><p> ,     ,            <code>WishTest</code> .   : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testPublishShouldPublishTheWish</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithEmptyFund(); $updatedAt = $wish-&gt;getUpdatedAt(); $wish-&gt;publish(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertTrue($wish-&gt;isPublished()); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertNotSame($updatedAt, $wish-&gt;getUpdatedAt()); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testUnpublishShouldUnpublishTheWish</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithEmptyFund(); $updatedAt = $wish-&gt;getUpdatedAt(); $wish-&gt;unpublish(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertFalse($wish-&gt;isPublished()); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertNotSame($updatedAt, $wish-&gt;getUpdatedAt()); }</code> </pre> <br><p>      ,   : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;...&gt; class Wish { // &lt;...&gt; public function publish() { $this-&gt;published = true; $this-&gt;updatedAt = new DateTimeImmutable(); } public function unpublish() { $this-&gt;published = false; $this-&gt;updatedAt = new DateTimeImmutable(); } public function isPublished(): bool { return $this-&gt;published; } // &lt;...&gt; }</span></span></code> </pre><br><p>  ,       . : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testChangePrice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithPriceAndFee(<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); $expected = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>)); $updatedAt = $wish-&gt;getUpdatedAt(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertSame($updatedAt, $wish-&gt;getUpdatedAt()); $wish-&gt;changePrice($expected); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertTrue($wish-&gt;getPrice()-&gt;equals($expected)); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertNotSame($updatedAt, $wish-&gt;getUpdatedAt()); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testChangeFee</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $wish = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createWishWithPriceAndFee(<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); $expected = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Money(<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(<span class="hljs-string"><span class="hljs-string">'USD'</span></span>)); $updatedAt = $wish-&gt;getUpdatedAt(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertSame($updatedAt, $wish-&gt;getUpdatedAt()); $wish-&gt;changeFee($expected); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertTrue($wish-&gt;getFee()-&gt;equals($expected)); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::assertNotSame($updatedAt, $wish-&gt;getUpdatedAt()); }</code> </pre> <br><p>      : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;...&gt; class Wish { // &lt;...&gt; public function changePrice(Money $amount) { $this-&gt;expense = $this-&gt;expense-&gt;changePrice($amount); $this-&gt;updatedAt = new DateTimeImmutable(); } public function changeFee(Money $amount) { $this-&gt;expense = $this-&gt;expense-&gt;changeFee($amount); $this-&gt;updatedAt = new DateTimeImmutable(); } // &lt;...&gt; }</span></span></code> </pre> <br><p>  ,     <del>   </del>  ,    .         : </p><br><ol><li>    ‚Äî <code>Wish::deposit(Money $amount)</code> </li><li>    ‚Äî <code>Wish::withdraw(DepositId $depositId)</code> </li><li>      ‚Äî <code>Wish::predictFulfillmentDateBasedOnFee()</code>  <code>Wish::predictFulfillmentDateBasedOnFund()</code> </li><li>      ‚Äî <code>Wish::publish()</code>  <code>Wish::unpublish()</code> </li><li>      ‚Äî <code>Wish::changePrice(Money $amount)</code>  <code>Wish::changeFee(Money $amount)</code> </li></ol><br><p>     -  ,         ,       Wish: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Wishlist</span></span>\<span class="hljs-title"><span class="hljs-title">Domain</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WishRepositoryInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WishId $wishId)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Wish</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Wish $wish)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">slice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $offset, int $limit)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contains</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Wish $wish)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">containsId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WishId $wishId)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNextWishId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WishId</span></span></span></span>; }</code> </pre> <br><p>  ,      ,         .  Good luck! </p><br><p> PS: <a href="https://github.com/franzose/symfony-ddd-wishlist">  </a> .       ,     .       ,  ¬´   ¬ª        :) </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335834/">https://habr.com/ru/post/335834/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335820/index.html">Modern methods of web application security research</a></li>
<li><a href="../335824/index.html">The second edition of the book "Learning Python. Game programming, data visualization, web applications</a></li>
<li><a href="../335826/index.html">How hackers prepare attacks on banks</a></li>
<li><a href="../335828/index.html">Download photos from Instagram using the Vkontakte bot</a></li>
<li><a href="../335830/index.html">On the quality of requirements in IT projects, to be honest (from the standpoint of the development team). Part 1</a></li>
<li><a href="../335836/index.html">How to write normal texts in English, not being a native speaker</a></li>
<li><a href="../335838/index.html">Overview of C ++ deep learning libraries Apache.SINGA, tiny-dnn, OpenNN</a></li>
<li><a href="../335840/index.html">Random RPG damage distribution</a></li>
<li><a href="../335842/index.html">Everything is relative, or the implementation of one simple task in python and tcl</a></li>
<li><a href="../335844/index.html">Automate workflow with the new platform. Part 1. Office. Work with "Incoming Documents"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>