<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cuckoo - proprietary automated malware analysis lab</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A month ago, the portal in my new job was hacked. Leadership asked the question "How?". During a brief search and analysis of connections to the serve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cuckoo - proprietary automated malware analysis lab</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a3c/f83/97c/a3cf8397cb5d4f11901cdfe804299f91.png" alt="image"><br>  A month ago, the portal in my new job was hacked.  Leadership asked the question "How?".  During a brief search and analysis of connections to the servers, the PC of the employee from whom the connection was established at about the same time was found.  The employee did not know anything about the burglary, but during the conversation he remembered one case, shortly before the burglary he received a document from a ‚Äúcompany employee‚Äù who did not open.  The file was in exe format, the whole story began with this. <br><a name="habracut"></a><br>  The directors of the Directorate set the task to analyze the file and understand what it does and what data the attacker could have gone.  I have never come across the topic of analyzing malicious files, and the most logical thing was to find some information in Google. <br><br>  For several days I found and read a huge number of malware analysis manuals, almost all manuals offered to analyze the software manually, using sandboxes and various utilities, but the easiest and fastest of all ways to analyze the virus was <a href="https://malwr.com/">malwr.com</a> - the automatic file analysis service in sandbox.  I registered, downloaded the virus, got "in the queue" and waited, only after a day the news appeared on the main page: <br><br><img src="https://habrastorage.org/files/395/ac4/17f/395ac417fc3e47c7b6e9903c8b7d3411.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On July 24th, during the daytime, the service stopped its operation for an indefinite time due to the increasing load. <br><br>  After looking at the site pages and the description, I came across a reference to the analysis platform used - Cuckoo Sandbox - and decided to learn more about the program. <br><br><h4>  What kind of animal is this "Cuckoo"? </h4><br>  <b><a href="http://www.cuckoosandbox.org/">Cuckoo Sandbox</a></b> is a system for automatically researching malware, exploits, malicious scripts, documents, archives and links.  The system is able to check pdf, doc, xls, rtf documents, Python scripts, JS, DLL libraries, binaries, jar and much more. <br><br><h4>  How does it work? </h4><br>  In a specially prepared virtual system, Python 2.7 is installed, the Cuckoo agent is added to autoload, which will interact with the sandbox, network interfaces are specially configured to intercept and further analyze network traffic.  After all the manipulations, a snapshot of the file system, also a Snapshot, is taken  The sandbox loads the file being tested, determines its type and, in accordance with the file type, makes the necessary manipulations, all changes inside the sandbox are recorded into the report.  After work, the system restores snapshot and the virtual system returns to its original state. <br><br>  Cuckoo Sandbox is capable of: <br><ul><li>  Monitoring calls to win32 API functions </li><li>  Network activity dump </li><li>  Dump and memory analysis </li><li>  Creating screenshots during analysis </li><li>  Saving copies of all files created and uploaded during the verification process </li><li>  Tracing instructions performed by the malicious process </li><li>  Creating a convenient report in json, mmdef, maec, html-formats </li><li>  Absolute isolation of the environment in which malware is launched </li></ul><br>  Warming up the public interest, I‚Äôll post a small screen of those signatures that the sandbox identified in one file attached to a spam letter: <br><br><img src="https://habrastorage.org/files/b1f/406/cc5/b1f406cc513d430bbe05752b555a6c7b.png" alt="image"><br><br>  You must admit that this gives much more information about any file than the classic anti-virus ‚ÄúTrojan.Gen‚Äù (you can consider this a ‚Äústone in the garden‚Äù of Symantec). <br><br>  <a href="http://cuckoo.droppages.com/">Here I posted the analysis of the file in HTML format</a> , how it is created by the sandbox. <br><br>  Cuckoo Sandbox is <a href="http://docs.cuckoosandbox.org/en/latest/">well documented</a> and <a href="http://docs.cuckoosandbox.org/en/latest/installation/">its installation</a> , including, on some sites there are instructions for installing it, but at the moment not a single instruction works exactly as written.  During the setup, I ran into a lot of problems, after which I decided to write here a complete and current guide for installation and configuration, with all the nuances, additions and modifications.  For the laziest, I prepared a script that will configure and install the sandbox automatically, let's start. <br><br><h4>  Install and configure Cuckoo, with all the subtleties and additional utilities. </h4><br>  All subsequent installation was carried out on VPS Digitalocean (2GB Ram / 40GB SSD / Ubuntu 14.04 x32). <br>  <i>Note: if you decide to try building a sandbox on the same hosting - you should not choose London DC, you will have problems accessing some links.</i> <br><br>  Ubuntu is selected on the recommendation of the developers, as the system on which the sandbox was tested directly. <br><br>  The installation plan will look like this: <br><ol><li>  <a href="https://habr.com/ru/post/234467/">Installing dependencies and packages required by utilities and sandboxes</a> </li><li>  <a href="https://habr.com/ru/post/234467/">Installing Utilities and Cuckoo Sandbox</a> </li><li>  <a href="https://habr.com/ru/post/234467/">Cuckoo Sandbox setup</a> </li><li>  <a href="https://habr.com/ru/post/234467/">Installing and configuring Virtualbox</a> </li><li>  <a href="https://habr.com/ru/post/234467/">Installing or loading a virtual system, setting it up</a> </li><li>  <a href="https://habr.com/ru/post/234467/">Web interface</a> </li><li>  <a href="https://habr.com/ru/post/234467/">Autoload</a> </li><li>  <a href="https://habr.com/ru/post/234467/">Cuckoo extras and features</a> </li><li>  <a href="https://habr.com/ru/post/234467/">Ready script installation and configuration Cuckoo</a> </li><li>  <a href="https://habr.com/ru/post/234467/">Bonus</a> </li></ol><br><br><h4><a name="1"></a>  Installing dependencies and packages required by utilities and sandboxes </h4><br>  If you are too lazy to do it yourself or read, go directly to the <a href="https://habr.com/ru/post/234467/">Ready script</a> item.  Please note, the script was tested and built only under Ubuntu 14.04 LTS x32, operation on other OSes is not guaranteed.  If you decide to figure it out for yourself, then the next chapter is for you. <br><br><h5>  Install all dependencies: </h5><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp apt-get update apt-get install git automake mongodb mingw32 dkms unzip wget python python-sqlalchemy python-bson python-pip python-dpkt python-jinja2 python-magic python-mysqldb python-gridfs python-libvirt python-bottle python-pefile python-chardet -y apt-get install python-dev libxml2-dev libxslt1-dev libevent-dev libpcre3 libpcre3-dev zlib1g-dev libtool libpcre++-dev ‚Äìy apt-get install mariadb-server -y</code> </pre> <br>  It is advisable to do the following installations one by one, as I wrote: <br><pre> <code class="bash hljs">pip install lxml pip install cybox==2.0.1.4 pip install maec==4.0.1.0 pip install django pip install py3compat pip install pymongo</code> </pre><br>  <i>Note: Pymongo can only be installed via PIP, if you install it via APT - the web interface will not work.</i> <br><br><h4><a name="2"></a>  Installing Utilities and Cuckoo Sandbox </h4><br><h5>  SSDEEP </h5><br>  (ssdeep is a tool for recursively computing and comparing contextual partial hashes, better known as fuzzy hashing) <br><pre> <code class="bash hljs">apt-get install ssdeep python-pyrex subversion libfuzzy-dev -y svn checkout http://pyssdeep.googlecode.com/svn/trunk/ pyssdeep <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> pyssdeep python setup.py build python setup.py install pip install pydeep</code> </pre><br><br><h5>  Yara </h5><br>  (YARA is a tool that helps virus analysts identify and classify examples of malware) <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp wget https://github.com/plusvic/yara/archive/v2.1.0.tar.gz tar xzf v2.1.0.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> yara-2.1.0 chmod +x build.sh ./build.sh make install <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> yara-python python setup.py build python setup.py install</code> </pre><br><br><h5>  Distorm3 </h5><br>  (Distorm3 - disassembler) <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp wget http://distorm.googlecode.com/files/distorm3.zip unzip distorm3.zip <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> distorm3 python setup.py build python setup.py install</code> </pre><br><br><h5>  Volatility </h5><br>  (Volatility is a Python framework designed to study the memory dumps of the operating system) <br><pre> <code class="bash hljs">add-apt-repository ppa:pi-rho/security apt-get update apt-get install volatility</code> </pre><br>  <i>Note: Do not build the package from source (as described in some installation manuals for 2012-2013), install from the repo as in this article, otherwise the web ui will not work, collected by Volatility from any sources and any version breaks report upload to MongoDB ( without Mongo, the new web interface will not work), with the version from the repository there is no such problem.</i> <br><br><h5>  Install the Cuckoo Sandbox </h5><br>  First add the user: <br><pre> <code class="bash hljs">useradd cuckoo usermod -a -G vboxusers cuckoo id cuckoo</code> </pre><br><br>  Now install: <br>  <b>Stable</b> <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt wget http://downloads.cuckoosandbox.org/1.1/cuckoo_1.1.tar.gz tar xzf cuckoo_1.1.tar.gz</code> </pre><br>  <b>Dev</b> <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/cuckoobox/cuckoo.git</code> </pre><br>  <i>Note: In the example below, the stable version was used, I recommend also using the stable version.</i> <br><br><h4><a name="3"></a>  Cuckoo Sandbox setup </h4><br>  Configure <a href="https://github.com/cuckoobox/community">Cuckoo community signatures</a> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/cuckoo ./utils/community.py --signatures --force</code> </pre><br>  Now configure the Cuckoo database: <br><br><pre> <code class="bash hljs">mysql -u root -p &gt; create database cuckoo; &gt; grant all privileges on cuckoo.* to cuckoo@localhost identified by <span class="hljs-string"><span class="hljs-string">'cuck00pass'</span></span> ; &gt; flush privileges; &gt; quit;</code> </pre><br>  Customize cuckoo <br><br><ol><li>  File /opt/cuckoo/conf/cuckoo.conf <br>  Turn on memory dump entry: <br><pre> <code class="bash hljs">memory_dump = on</code> </pre> <br>  Set up a connection to the database: <br><pre> <code class="bash hljs">connection = mysql://cuckoo:cuck00pass\@localhost/cuckoo</code> </pre> <br>  The server is weak, so we increase the time limits: <br><pre> <code class="bash hljs">default = 240 critical = 1200 vm_state = 600</code> </pre> </li><li>  File /opt/cuckoo/conf/memory.conf <br>  There is only 40 GB on the server, therefore we disable saving of memory dumps: <br><pre> <code class="bash hljs">delete_memdump = yes</code> </pre> </li><li>  File /opt/cuckoo/conf/processing.conf <br>  Turn on RAM analysis: <br><pre> <code class="bash hljs">memory = yes</code> </pre> <br>  Note: in the key parameter you can enter your own API key for the <a href="http://virustotal.com/">virustotal.com</a> service </li><li>  vim /opt/cuckoo/conf/virtualbox.conf <br>  Change the Virtualbox mode: <br><pre> <code class="bash hljs">mode = headless</code> </pre><br>  Change the name of the virtual machine from cuckoo1 to WindowsXP: <br><pre> <code class="bash hljs">machines = WindowsXP [WindowsXP] label = WindowsXP</code> </pre></li><li>  File /opt/cuckoo/conf/reporting.conf <br>  Let's enable importing reports to MongoDB for web interface operation <br><pre> <code class="bash hljs">[mongodb] enabled = yes</code> </pre></li></ol><br>  This completes the Cuckoo setup, now let's get started with Virtualbox and the guest OS. <br><br><h4><a name="4"></a>  Installing and configuring Virtualbox </h4><br><h5>  Virtualbox and all necessary components </h5><br><pre> <code class="bash hljs">wget -q http://download.virtualbox.org/virtualbox/debian/oracle_vbox.asc -O- | sudo apt-key add ‚Äì sh -c <span class="hljs-string"><span class="hljs-string">'echo "deb http://download.virtualbox.org/virtualbox/debian trusty contrib" &gt;&gt; /etc/apt/sources.list.d/virtualbox.list'</span></span> apt-get update apt-get install virtualbox-4.3 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp VBOX_LATEST_VERSION=$(curl http://download.virtualbox.org/virtualbox/LATEST.TXT) wget http://download.virtualbox.org/virtualbox/<span class="hljs-variable"><span class="hljs-variable">${VBOX_LATEST_VERSION}</span></span>/Oracle_VM_VirtualBox_Extension_Pack-{VBOX_LATEST_VERSION}.vbox-extpack vboxmanage extpack install /tmp/Oracle_VM_VirtualBox_Extension_Pack-<span class="hljs-variable"><span class="hljs-variable">${VBOX_LATEST_VERSION}</span></span>.vbox-extpack <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt wget http://dlc.sun.com.edgesuite.net/virtualbox/<span class="hljs-variable"><span class="hljs-variable">${VBOX_LATEST_VERSION}</span></span>/VBoxGuestAdditions_<span class="hljs-variable"><span class="hljs-variable">${VBOX_LATEST_VERSION}</span></span>.iso</code> </pre><br><br><h4><a name="5"></a>  Installing or loading a virtual system, setting it up </h4><br>  We have 2 options for installing the OS: <br><ol><li>  <a href="http://www.modern.ie/">Download it from the site</a> </li><li>  Install manually </li></ol><br>  The first option is the fastest, but also not the most stable.  The use of this OS for non-commercial purposes is permitted and there will be no problems with the license. <br>  The second option is longer and more reliable, I chose the last one, but I will describe both in order. <br><br>  <b>Download virtual OS from the site</b> <br><pre> <code class="bash hljs">wget https://az412801.vo.msecnd.net/vhd/VMBuild_20131127/VirtualBox/IE6_WinXP/Linux/IE6.WinXP.For.LinuxVirtualBox.sfx chmod +x IE6.WinXP.For.LinuxVirtualBox.sfx ./IE6.WinXP.For.LinuxVirtualBox.sfx vboxmanage import IE6\ -\ WinXP.ova --vsys 0 --unit 10 --disk=/root/VirtualBox\ VMs/WindowsXP/WindowsXP.vmdk --memory 1024 --vmname WindowsXP</code> </pre><br><br>  <b>Manual OS installation</b> <br><pre> <code class="bash hljs">vboxmanage createvm --name <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --ostype WindowsXP --register vboxmanage modifyvm <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --memory 1000 --acpi on --boot1 dvd vboxmanage createhd --filename <span class="hljs-string"><span class="hljs-string">"WindowsXP.vdi"</span></span> --size 20000 vboxmanage storagectl <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --name <span class="hljs-string"><span class="hljs-string">"IDE"</span></span> --add ide --controller PIIX4 vboxmanage storageattach <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --storagectl <span class="hljs-string"><span class="hljs-string">"IDE"</span></span> --port 0 --device 0 --<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> hdd --medium <span class="hljs-string"><span class="hljs-string">"WindowsXP.vdi"</span></span></code> </pre><br><br>  <i>Note: The following instructions are equally acceptable for both methods.</i> <br><br>  <b>Configuring the network</b> <br><pre> <code class="bash hljs">vboxmanage hostonlyif create vboxmanage modifyvm <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --nic1 hostonly --hostonlyadapter1 vboxnet0 --nicpromisc1 allow-all --hwvirtex off --vtxvpid off</code> </pre><br><br>  <b>Configure shared folders</b> <br><pre> <code class="bash hljs">mkdir -p /opt/cuckoo/shares/setup mkdir -p /opt/cuckoo/shares/WindowsXP vboxmanage sharedfolder add <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --name <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --hostpath /opt/cuckoo/shares/WindowsXP --automount vboxmanage sharedfolder add <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --name setup --hostpath /opt/cuckoo/shares/setup --automount --<span class="hljs-built_in"><span class="hljs-built_in">readonly</span></span> vboxmanage modifyvm <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --nictrace1 on --nictracefile1 /opt/cuckoo/shares/WindowsXP/dump.pcap</code> </pre><br><br>  <b>Enable RDP access</b> <br><pre> <code class="bash hljs">vboxmanage modifyvm <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --vrdeport 5000 --vrde on</code> </pre><br>  <i>Port can specify any</i> <br><br>  This is where the configuration of the virtual containers is complete, it remains to configure iptables, tcpdump, and if you chose to install from scratch, you need to install Windows. <br><br>  <b>Iptables rules and kernel parameter changes</b> <br><pre> <code class="bash hljs">iptables -A FORWARD -o eth0 -i vboxnet0 -s 192.168.56.0/24 -m conntrack --ctstate NEW -j ACCEPT iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT iptables -A POSTROUTING -t nat -j MASQUERADE sysctl -w net.ipv4.ip_forward=1</code> </pre><br>  <b>tcpdump</b> <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">setcap</span></span> cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump <span class="hljs-built_in"><span class="hljs-built_in">getcap</span></span> /usr/sbin/tcpdump</code> </pre><br>  <b>Raise the interface</b> <br><pre> <code class="bash hljs">ifconfig vboxnet0 192.168.56.1</code> </pre><br><br>  Now go directly to the guest OS itself: <br><br> <b><a name="script"></a></b>  <b>Install Windows</b> <br>  Upload your image to the server and connect it to the virtual machine: <br><pre> <code class="bash hljs">vboxmanage storageattach <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --storagectl <span class="hljs-string"><span class="hljs-string">"IDE"</span></span> --port 0 --device 1 --<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> dvddrive --medium /patch/to/licensed/windows.iso</code> </pre><br>  Turn on <br><pre> <code class="bash hljs">vboxmanage startvm <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> headless</code> </pre><br>  After this command, you can connect to the virtual OS via RDP on port 5000 and install it.  After installation, connect and install VBoxGuestAdditions: <br><pre> <code class="bash hljs">vboxmanage storageattach <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> --storagectl <span class="hljs-string"><span class="hljs-string">"IDE"</span></span> --port 0 --device 1 --<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> dvddrive --medium /opt/VBoxGuestAdditions_4.3.14.iso</code> </pre><br>  <i>Note: your add-ons version may be different.</i> <br>  If you have downloaded a ready-made virtual system, in any case, update GuestAdditions is necessary. <br>  After installation we reboot. <br><br>  <b>Insist guest OS</b> <br><ol><li>  Configure the connection to the network as follows (you can specify any dns): <br><br><img src="https://habrastorage.org/files/910/d15/23c/910d1523c8a94a679b80691b76407af1.png" alt="image"></li><li>  Install VboxTools from the disk that is connected to the system. </li><li>  Install Pyton 2.7: <a href="http://python.org/download/">http://python.org/download/</a> </li><li>  Installing <a href="http://www.activestate.com/activepython">http://www.activestate.com/activepython</a> </li><li>  Install the PIL Python module to create screenshots: <a href="http://www.pythonware.com/products/pil/">http://www.pythonware.com/products/pil/</a> </li><li>  Disable automatic update of Windows. </li><li>  Disable firewall. </li><li>  Copy the agent from the setup network folder to the folder C: \ Python27, <br>  We set the agent to autoload, for this we add to the registry branch (start-&gt; run-&gt; regedit) HKLM \ SOFTWARE \ Microsoft \ Windows \ CurrentVersion \ Run string parameter <br>  Name: 'Agent' <br>  Type: 'REG_SZ' <br>  Content: "C: \ Python27 \ agent.pyw" <br><br><img src="https://habrastorage.org/files/d05/abb/4cd/d05abb4cdad247a3b4a89d7a3f079f4a.png" alt="image"></li><li>  We enable IE, in the settings we set the home page with an empty tab, optionally in the browser properties turn off all protective mechanisms. </li><li>  Disable SSDP: start-&gt; execute-&gt; msconfig and in the service section disable the ‚ÄúSSDP Discovery Service‚Äù so that the network requests of this service are not included in the reports. <br><br><img src="https://habrastorage.org/files/feb/d71/e4c/febd71e4c99c4935813894662dcd2d1d.png" alt="image"><br><br></li><li>  Reboot and in the pop-up window that appears when loading, select ‚ÄúDo not display this message when rebooting‚Äù and OK. </li><li>  After restarting the guest OS, start-&gt; execute-&gt; cmd and type netstat ‚Äìna in the console and see if there is an agent on port 8000 <br><br><img src="https://habrastorage.org/files/285/113/f20/285113f20a6743f9a32a4ad9b6d21ef9.png" alt="image"><br><br></li><li>  Optionally install various vulnerable software of old versions (browsers, Flash player, Java, Acrobat Reader ...): <a href="http://www.oldapps.com/">http://www.oldapps.com</a> <br>  <i>Note: if you have a license for the office, it is better to install it, and it is better to install more, Skype, ICQ, mail client, one way or another, some malicious software tries to collect data from these applications or exploit them.</i>  <i>For example, the hacker who hacked our site, after several unsuccessful attempts to get into the network again, collected a virus that exploits the vulnerability CVE2012-0158, without Microsoft Office, it would not be possible to calculate.</i> </li></ol><br>  This completes the installation of the guest OS. <br>  We do snapshot (without turning off the guest OS) <br><pre> <code class="bash hljs">vboxmanage snapshot <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> take <span class="hljs-string"><span class="hljs-string">"WindowsXPSnap01"</span></span> --pause</code> </pre><br>  And turn off: <br><pre> <code class="bash hljs">vboxmanage controlvm <span class="hljs-string"><span class="hljs-string">"WindowsXP"</span></span> poweroff</code> </pre><br><br><h4><a name="6"></a>  Web interface </h4><br>  The Cuckoo Sandbox has 2 web interfaces, new and old.  The one that is less informative, has fewer features and is much less convenient than the new one: <br>  Old interface: <br><br><img src="https://habrastorage.org/files/150/9d3/61b/1509d361b01b4c299a5ba35b8a57c02b.png" alt="image"><br><br>  New interface: <br><br><img src="https://habrastorage.org/files/31d/e06/887/31de068873eb455d9397b0c8c0f4b58e.png" alt="image"><br><br>  The old interface comes up without a database, without Django, simply by running the web.py script from the utils folder, so if that's enough for you, use it, but I recommend spending 5 minutes of your valuable time and taking up a new web interface. <br>  Install Apache: <br><pre> <code class="bash hljs">apt-get install apache2</code> </pre><br>  Apache chose  I know him better and worked with him longer, if you want, you can configure Nginx or Unicorn. <br>  The file /etc/apache2/sites-enabled/000-default.conf is deleted <br>  Create the file /etc/apache2/sites-enabled/cuckoo.conf with the following content: <br><pre> <code class="bash hljs">&lt;VirtualHost *:80&gt; ServerName cuckoo.local ServerAdmin webmaster@localhost DocumentRoot /opt/cuckoo/web ErrorLog <span class="hljs-variable"><span class="hljs-variable">${APACHE_LOG_DIR}</span></span>/error.log CustomLog <span class="hljs-variable"><span class="hljs-variable">${APACHE_LOG_DIR}</span></span>/access.log combined WSGIScriptAlias / /opt/cuckoo/web/web/wsgi.py &lt;Directory /opt/cuckoo/web/web&gt; &lt;Files wsgi.py&gt; Require all granted &lt;/Files&gt; &lt;/Directory&gt; Alias /static /opt/cuckoo/web/static &lt;Directory /opt/cuckoo/web/static/&gt; Require all granted &lt;/Directory&gt; &lt;/VirtualHost&gt;</code> </pre><br>  In the /opt/cuckoo/web/web/wsgi.py file we find: <br><pre> <code class="bash hljs">import os os.environ.setdefault(<span class="hljs-string"><span class="hljs-string">"DJANGO_SETTINGS_MODULE"</span></span>, <span class="hljs-string"><span class="hljs-string">"web.settings"</span></span>)</code> </pre><br>  And change to: <br><pre> <code class="bash hljs">import os, sys sys.path.append(<span class="hljs-string"><span class="hljs-string">'/opt/cckoo'</span></span>) sys.path.append(<span class="hljs-string"><span class="hljs-string">'/opt/cuckoo/web'</span></span>) os.chdir(<span class="hljs-string"><span class="hljs-string">'/opt/cuckoo/web/'</span></span>) os.environ.setdefault(<span class="hljs-string"><span class="hljs-string">"DJANGO_SETTINGS_MODULE"</span></span>, <span class="hljs-string"><span class="hljs-string">"web.settings"</span></span>)</code> </pre><br>  correct rights: <br><pre> <code class="bash hljs">chown -R cuckoo:cuckoo /opt/cuckoo/</code> </pre><br>  We change the user from which apache will be launched in the / etc / apache2 / envvars file <br><pre> <code class="bash hljs">APACHE_RUN_USER=www-data APACHE_RUN_GROUP=www-data</code> </pre><br>  on <br><pre> <code class="bash hljs">APACHE_RUN_USER=cuckoo APACHE_RUN_GROUP=cuckoo</code> </pre><br>  Install the wsgi support module: <br><pre> <code class="bash hljs">aptitude install libapache2-mod-wsgi -y</code> </pre><br><br><h4><a name="7"></a>  Autoload software </h4><br><h5>  Interface autoloading </h5><br>  In the /etc/rc.local file to the line exit 0 enter: <br><pre> <code class="bash hljs">VBoxManage list vms &gt; /dev/null ifconfig vboxnet0 192.168.56.1</code> </pre><br><br><h5>  Sandbox autostart </h5><br><pre> <code class="bash hljs">apt-get install supervisor</code> </pre><br>  Create the file /etc/supervisor/conf.d/cuckoo.conf with the following content: <br><pre> <code class="bash hljs">[program:cuckoo] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=python cuckoo.py directory=/opt/cuckoo [program:cuckoo-api] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=python api.py directory=/opt/cuckoo/utils</code> </pre><br>  We carry out: <br><pre> <code class="bash hljs">supervisord -c /etc/supervisor/supervisord.conf supervisorctl -c /etc/supervisor/supervisord.conf reload</code> </pre><br><br><h5>  Autoloading iptables rules </h5><br><pre> <code class="bash hljs">apt-get install iptables-persistent</code> </pre><br><br>  Done, now after the reboot, all services will start and everything will work. <br><br><h4><a name="8"></a>  Cuckoo extras and features </h4><br><h5>  PEID Signatures </h5><br>  Install a new database of signatures, in the new database they are 2 times more: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp wget http://research.pandasecurity.com/blogs/images/userdb.txt mv userdb.txt /opt/cuckoo/data/peutils/UserDB.TXT</code> </pre><br><br><h5>  ClamAV Yara Rules + AlienVault Labs <a href="http://habrahabr.ru/company/pt/blog/142024/">APT</a> Threat Signatures </h5><br>  <i>Note: when you try to download the ClamAV-Yara rules conversion script from London DC digitalocean, the error ‚ÄúRequest doesn‚Äôt matter from your country That's all we know.‚Äù</i> <br><pre> <code class="bash hljs">apt-get install clamav -y wget http://db.local.clamav.net/main.cvd wget http://db.local.clamav.net/daily.cvd sigtool -u main.cvd sigtool -u daily.cvd wget http://malwarecookbook.googlecode.com/svn-history/r5/trunk/3/3/clamav_to_yara.py python clamav_to_yara.py -f main.ndb -o main.yar python clamav_to_yara.py -f daily.ndb -o daily.yar mkdir /opt/cuckoo/data/yara/clamav mv *.yar /opt/cuckoo/data/yara/clamav/</code> </pre><br>  The converted database will give an error, referring to the wrong signature EOL_0_94_2, delete it: <br>  delete lines from /opt/cuckoo/data/yara/clamav/main.yar file <br><pre> <code class="bash hljs">¬´rule EOL_0_94_2 { strings: <span class="hljs-variable"><span class="hljs-variable">$a0</span></span> = { This ClamAV version has reached End of Life! Please upgrade to version 0.95 or later. For more information see www.clamav.net/eol-clamav-094 and www.clamav.net/download }^M condition: <span class="hljs-variable"><span class="hljs-variable">$a0</span></span> }¬ª</code> </pre><br>  Or simply execute the following commands: <br><pre> <code class="bash hljs">RM_EOL=$(sed -n <span class="hljs-string"><span class="hljs-string">'/EOL_0_94_2/{=}'</span></span> main.yar) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {1..8}; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> sed -i <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${RM_EOL}</span></span></span><span class="hljs-string">d"</span></span> main.yar; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Next, set the APT threat rules from AlienVaults: <br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/AlienVault-Labs/AlienVaultLabs.git mv AlienVaultLabs/malware_analysis/ /opt/cuckoo/data/yara/</code> </pre><br>  And connect these rules to Cuckoo: <br>  Fill in the /opt/cuckoo/data/yara/index_binary.yar file: <br><pre> <code class="bash hljs">include <span class="hljs-string"><span class="hljs-string">"clamav/main.yar"</span></span> include <span class="hljs-string"><span class="hljs-string">"clamav/daily.yar"</span></span> include <span class="hljs-string"><span class="hljs-string">"malware_analysis/CommentCrew/apt1.yara"</span></span> include <span class="hljs-string"><span class="hljs-string">"malware_analysis/FPU/fpu.yar"</span></span> include <span class="hljs-string"><span class="hljs-string">"malware_analysis/Georbot/GeorBotBinary.yara"</span></span> include <span class="hljs-string"><span class="hljs-string">"malware_analysis/Georbot/GeorBotMemory.yara"</span></span> include <span class="hljs-string"><span class="hljs-string">"malware_analysis/Hangover/hangover.yar"</span></span> include <span class="hljs-string"><span class="hljs-string">"malware_analysis/KINS/kins.yar"</span></span> include <span class="hljs-string"><span class="hljs-string">"malware_analysis/OSX_Leverage/leverage.yar"</span></span> include <span class="hljs-string"><span class="hljs-string">"malware_analysis/TheMask_Careto/mask.yar"</span></span> include <span class="hljs-string"><span class="hljs-string">"malware_analysis/Urausy/urausy_skypedat.yar"</span></span></code> </pre><br><br><h5>  Zer0m0n or hide our sandbox </h5><br>  Any malicious file can try to check the presence of debuggers or virtual environment before executing, the result will be disappointing.  Here is what the <a href="https://github.com/a0rtega/pafish">Paranoid Fish</a> test shows when loading its executable file for verification: <br><br><img src="https://habrastorage.org/files/f2b/180/cc9/f2b180cc9e7d4d619a2ad4124d25aa56.png" alt="image"><br><br>  This can be easily corrected with Zer0m0n. <br>  zer0m0n is the driver for the Cuckoo Sandbox, which will perform a kernel analysis during the execution of malware.  He is able to almost completely hide the "virtuality" of the OS and allows you to bypass the detection of Cuckoo malicious files. <br><br>  Install it: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/conix-security/zer0m0n.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> zer0m0n/bin cp cuckoo.patch /opt/cuckoo <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/cuckoo patch -p1 &lt; ./cuckoo.patch cp /tmp/zer0m0n/bin/logs_dispatcher.exe /opt/cuckoo/analyzer/windows/dll/ cp /tmp/zer0m0n/bin/zer0m0n.sys /opt/cuckoo/analyzer/windows/dll/ cp -rf /tmp/zer0m0n/signatures/* /opt/cuckoo/modules/signatures/</code> </pre><br><br>  Let's correct the rights: <br><pre> <code class="bash hljs">chown -R cuckoo:cuckoo /opt/cuckoo/</code> </pre><br>  After that, the web interface will allow you to select the scan in the additional options, by default - Userland or with zer0m0n Kernelland: <br><br><img src="https://habrastorage.org/files/db6/86a/afe/db686aafed89429abe103270d1fa1c93.png" alt="image"><br><br>  If you launch the scan via the console - use the option kernel_analysis = yes <br><br>  Run the check again: <br><br><img src="https://habrastorage.org/files/270/9ce/83e/2709ce83eac04a248363ca5d2e5bc430.png" alt="image"><br><br><h4><a name="9"></a>  Ready script installation and configuration Cuckoo </h4><br>  As promised, I post the finished script.  It will automatically configure everything except the guest OS.  After the script has completed, you will need to return to the <a href="https://habr.com/ru/post/234467/">item for setting up the guest OS</a> and configure it. <br><div class="spoiler">  <b class="spoiler_title">setup_cuckoo.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #-------------------------------------------# #  Cuckoo Sandbox #    Ubuntu 14.04 #-------------------------------------------# #  cd /tmp apt-get update apt-get install git automake mongodb mingw32 dkms unzip wget python python-sqlalchemy python-bson python-pip python-dpkt python-jinja2 python-magic python-gridfs python-mysqldb python-libvirt python-bottle python-pefile python-chardet -y apt-get install python-dev libxml2-dev libxslt1-dev libevent-dev libpcre3 libpcre3-dev zlib1g-dev libtool libpcre++-dev -y debconf-set-selections &lt;&lt;&lt; 'mariadb-server-5.5 mysql-server/root_password password supersecretpassw0rd' debconf-set-selections &lt;&lt;&lt; 'mariadb-server-5.5 mysql-server/root_password_again password supersecretpassw0rd' apt-get install mariadb-server -y #  pip install lxml pip install cybox==2.0.1.4 pip install maec==4.0.1.0 pip install django pip install py3compat pip install pymongo # SSDEEP apt-get install ssdeep python-pyrex subversion libfuzzy-dev -y svn checkout http://pyssdeep.googlecode.com/svn/trunk/ pyssdeep cd pyssdeep python setup.py build python setup.py install pip install pydeep # Yara cd /tmp wget https://github.com/plusvic/yara/archive/v2.1.0.tar.gz tar xzf v2.1.0.tar.gz cd yara-2.1.0 chmod +x build.sh ./build.sh make install cd yara-python python setup.py build python setup.py install # Distorm3 cd /tmp wget http://distorm.googlecode.com/files/distorm3.zip unzip distorm3.zip cd distorm3/ python setup.py build python setup.py install # Volatility add-apt-repository ppa:pi-rho/security -y apt-get update apt-get install volatility -y # Cuckoo useradd cuckoo usermod -a -G vboxusers cuckoo cd /opt wget http://downloads.cuckoosandbox.org/1.1/cuckoo_1.1.tar.gz tar xzf cuckoo_1.1.tar.gz #  Cuckoo (https://github.com/cuckoobox/community) cd /opt/cuckoo ./utils/community.py --signatures --force #-------------------------------------------# #    Virtualbox #-------------------------------------------# wget -q http://download.virtualbox.org/virtualbox/debian/oracle_vbox.asc -O- | sudo apt-key add - sh -c 'echo "deb http://download.virtualbox.org/virtualbox/debian trusty contrib" &gt;&gt; /etc/apt/sources.list.d/virtualbox.list' apt-get update apt-get install virtualbox-4.3 -y cd /tmp VBOX_LATEST_VERSION=$(curl http://download.virtualbox.org/virtualbox/LATEST.TXT) wget http://download.virtualbox.org/virtualbox/${VBOX_LATEST_VERSION}/Oracle_VM_VirtualBox_Extension_Pack-${VBOX_LATEST_VERSION}.vbox-extpack vboxmanage extpack install /tmp/Oracle_VM_VirtualBox_Extension_Pack-${VBOX_LATEST_VERSION}.vbox-extpack cd /opt wget http://dlc.sun.com.edgesuite.net/virtualbox/${VBOX_LATEST_VERSION}/VBoxGuestAdditions_${VBOX_LATEST_VERSION}.iso #   vboxmanage createvm --name "WindowsXP" --ostype WindowsXP --register vboxmanage modifyvm "WindowsXP" --memory 1000 --acpi on --boot1 dvd vboxmanage createhd --filename "WindowsXP.vdi" --size 20000 vboxmanage storagectl "WindowsXP" --name "IDE" --add ide --controller PIIX4 vboxmanage storageattach "WindowsXP" --storagectl "IDE" --port 0 --device 0 --type hdd --medium "WindowsXP.vdi" vboxmanage hostonlyif create vboxmanage modifyvm "WindowsXP" --nic1 hostonly --hostonlyadapter1 vboxnet0 --nicpromisc1 allow-all --hwvirtex off --vtxvpid off #   mkdir -p /opt/cuckoo/shares/setup mkdir -p /opt/cuckoo/shares/WindowsXP vboxmanage sharedfolder add "WindowsXP" --name "WindowsXP" --hostpath /opt/cuckoo/shares/WindowsXP --automount vboxmanage sharedfolder add "WindowsXP" --name setup --hostpath /opt/cuckoo/shares/setup --automount --readonly vboxmanage modifyvm "WindowsXP" --nictrace1 on --nictracefile1 /opt/cuckoo/shares/WindowsXP/dump.pcap cp /opt/cuckoo/agent/agent.py /opt/cuckoo/shares/setup/agent.pyw #   RDP  5000  vboxmanage modifyvm "WindowsXP" --vrdeport 5000 --vrde on # iptables iptables -A FORWARD -o eth0 -i vboxnet0 -s 192.168.56.0/24 -m conntrack --ctstate NEW -j ACCEPT iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT iptables -A POSTROUTING -t nat -j MASQUERADE sysctl -w net.ipv4.ip_forward=1 # tcpdump setcap cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump getcap /usr/sbin/tcpdump #  Cuckoo mysql -uroot -psupersecretpassw0rd -e "create database cuckoo" mysql -uroot -psupersecretpassw0rd -e "grant all privileges on cuckoo.* to cuckoo@localhost identified by 'cuck00pass'" mysql -u root -psupersecretpassw0rd -e "flush privileges" #  Cuckoo sed -i -e "s@connection =@connection = mysql://cuckoo:cuck00pass\@localhost/cuckoo@" /opt/cuckoo/conf/cuckoo.conf sed -i -e "s@memory_dump = off@memory_dump = on@" /opt/cuckoo/conf/cuckoo.conf sed -i -e "s@default = 120@default = 240@" /opt/cuckoo/conf/cuckoo.conf sed -i -e "s@critical = 600@critical = 1200@" /opt/cuckoo/conf/cuckoo.conf sed -i -e "s@vm_state = 300@vm_state = 600@" /opt/cuckoo/conf/cuckoo.conf sed -i -e "s@delete_memdump = no@delete_memdump = yes@" /opt/cuckoo/conf/memory.conf sed -i -e "s@enabled = no@enabled = yes@" /opt/cuckoo/conf/processing.conf sed -i -e "s@enabled = no@enabled = yes@" /opt/cuckoo/conf/reporting.conf sed -i -e "s@enabled = no@enabled = yes@" /opt/cuckoo/conf/processing.conf sed -i -e "s@mode = gui@mode = headless@" /opt/cuckoo/conf/virtualbox.conf sed -i -e "s@cuckoo1@WindowsXP@" /opt/cuckoo/conf/virtualbox.conf #   apt-get install apache2 -y mv /etc/apache2/sites-enabled/000-default.conf /etc/apache2/sites-enabled/000-default.conf.bak cat &gt; /etc/apache2/sites-enabled/cuckoo.conf &lt;&lt;DELIM &lt;VirtualHost *:80&gt; ServerName cuckoo.local ServerAdmin webmaster@localhost DocumentRoot /opt/cuckoo/web ErrorLog /var/log/apache2/error.log CustomLog /var/log/apache2//access.log combined WSGIScriptAlias / /opt/cuckoo/web/web/wsgi.py &lt;Directory /opt/cuckoo/web/web&gt; &lt;Files wsgi.py&gt; Require all granted &lt;/Files&gt; &lt;/Directory&gt; Alias /static /opt/cuckoo/web/static &lt;Directory /opt/cuckoo/web/static/&gt; Require all granted &lt;/Directory&gt; &lt;/VirtualHost&gt; DELIM aptitude install libapache2-mod-wsgi -y mv /opt/cuckoo/web/web/wsgi.py /opt/cuckoo/web/web/wsgi.py.bak cat &gt; /opt/cuckoo/web/web/wsgi.py &lt;&lt;DELIM import os, sys sys.path.append('/opt/cuckoo') sys.path.append('/opt/cuckoo/web') os.chdir('/opt/cuckoo/web/') os.environ.setdefault("DJANGO_SETTINGS_MODULE", "web.settings") from django.core.wsgi import get_wsgi_application application = get_wsgi_application() DELIM chown -R cuckoo:cuckoo /opt/cuckoo/ #   vboxnet0 sed -i -e "s@exit 0@@" /etc/rc.local echo 'VBoxManage list vms &gt; /dev/null' &gt;&gt; /etc/rc.local echo 'ifconfig vboxnet0 192.168.56.1' &gt;&gt; /etc/rc.local echo 'exit 0' &gt;&gt; /etc/rc.local #  Cuckoo apt-get install supervisor -y cat &gt; /etc/supervisor/conf.d/cuckoo.conf &lt;&lt;DELIM [program:cuckoo] command=python cuckoo.py directory=/opt/cuckoo [program:cuckoo-api] command=python api.py directory=/opt/cuckoo/utils DELIM supervisord -c /etc/supervisor/supervisord.conf supervisorctl -c /etc/supervisor/supervisord.conf reload #  Iptables cat &gt; /etc/network/if-up.d/00-iptables &lt;&lt;DELIM #!/bin/sh iptables-restore &lt; /etc/firewall.conf DELIM iptables-save &gt;/etc/firewall.conf #  PEiD cd /tmp wget http://research.pandasecurity.com/blogs/images/userdb.txt mv userdb.txt /opt/cuckoo/data/peutils/UserDB.TXT #ClamAV   Yara cd /tmp apt-get install clamav -y wget http://db.local.clamav.net/main.cvd wget http://db.local.clamav.net/daily.cvd sigtool -u main.cvd sigtool -u daily.cvd wget https://malwarecookbook.googlecode.com/svn-history/r5/trunk/3/3/clamav_to_yara.py python clamav_to_yara.py -f main.ndb -o main.yar python clamav_to_yara.py -f daily.ndb -o daily.yar #,  ClamAV   EOL_0_94_2,  ,     Yara RM_EOL=$(sed -n '/EOL_0_94_2/{=}' main.yar) for n in {1..8}; do sed -i "${RM_EOL}d" main.yar; done mkdir /opt/cuckoo/data/yara/clamav mv *.yar /opt/cuckoo/data/yara/clamav/ git clone https://github.com/AlienVault-Labs/AlienVaultLabs.git mv AlienVaultLabs/malware_analysis/ /opt/cuckoo/data/yara/ mv /opt/cuckoo/data/yara/index_binary.yar /opt/cuckoo/data/yara/index_binary.yar.bak cat &gt; /opt/cuckoo/data/yara/index_binary.yar &lt;&lt;DELIM include "signatures/embedded.yar" include "signatures/vmdetect.yar" include "clamav/main.yar" include "clamav/daily.yar" include "malware_analysis/CommentCrew/apt1.yara" include "malware_analysis/FPU/fpu.yar" include "malware_analysis/Georbot/GeorBotBinary.yara" include "malware_analysis/Georbot/GeorBotMemory.yara" include "malware_analysis/Hangover/hangover.yar" include "malware_analysis/KINS/kins.yar" include "malware_analysis/OSX_Leverage/leverage.yar" include "malware_analysis/TheMask_Careto/mask.yar" include "malware_analysis/Urausy/urausy_skypedat.yar" DELIM #Zer0m0n git clone https://github.com/conix-security/zer0m0n.git cd zer0m0n/bin cp cuckoo.patch /opt/cuckoo cd /opt/cuckoo patch -p1 &lt; ./cuckoo.patch cp /tmp/zer0m0n/bin/logs_dispatcher.exe /opt/cuckoo/analyzer/windows/dll/ cp /tmp/zer0m0n/bin/zer0m0n.sys /opt/cuckoo/analyzer/windows/dll/ cp -rf /tmp/zer0m0n/signatures/* /opt/cuckoo/modules/signatures/ chown -R cuckoo:cuckoo /opt/cuckoo/</span></span></code> </pre></div></div><br><h4><a name="10"></a>  Bonus </h4><br>  As a bonus, I'll post the instructions for integrating the Cuckoo Sandbox with the <a href="https://www.paterva.com/web6/products/maltego.php">Maltego</a> program. <br>  We will integrate the system with the <a href="http://cuckoo.readthedocs.org/en/latest/usage/api/">REST API</a> sandbox service that runs on port 8090. <br>  I work on a mac and performed the following actions on mac os 10.9.4, but on any Linux system everything should be installed and working in the same way without problems: <br>  To get started, download Maltego from the site and unpack it into the application folder. <br>  After we open the program: <br><br><img src="https://habrastorage.org/files/2c9/763/b9c/2c9763b9c8c04134a2b5995791c65dec.png" alt="image"><br><br>  She will offer to enter or register, register, log in (do not bother with captcha, enter anything, it does not work), then download and install the files necessary for integrating the sandbox with Maltego from the developer repository: <br><br><pre> <code class="bash hljs">sudo -s git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/bostonlink/cuckooforcanari.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> cuckooforcanari python setup.py install canari create-profile cuckooforcanari</code> </pre><br>  Now you need to import the cuckoo config into Matlego: <br>  Click on the program icon in the upper left corner -&gt; import -&gt; Import Configuration and select the configuration from the folder downloaded from github: <br><br><img src="https://habrastorage.org/files/38f/5f8/bcd/38f5f8bcd87c49bca5d6d1a5c99da623.png" alt="image"><br><br>  We export everything: <br><br><img src="https://habrastorage.org/files/112/25e/087/11225e087c3b4d3a9cfe3f5732946159.png" alt="image"><br><br>  Done, now open the configuration file, enter the host, port and folder where you will add the malware: <br><pre> <code class="bash hljs">vim ~/.canari/cuckooforcanari.conf</code> </pre><br>  Done, now in the program we create a new chart, drag the Cuckoo Malware Sample icon onto the chart, rename the file to the name of your virus and load it via the Submit File For Analisys: <br><br><img src="https://habrastorage.org/files/44b/87b/386/44b87b38679e4c5da7fa0d64215504a2.png" alt="image"><br><br>  After downloading you will see the task number: <br><br><img src="https://habrastorage.org/files/af5/b71/289/af5b712894cb4c24b3ab75bd365883fd.png" alt="image"><br><br>  Upon completion of the scan, you can receive any data in the form of graphs: <br><br><img src="https://habrastorage.org/files/cbc/12a/7f7/cbc12a7f77b34d73b6a100972d91bf1d.png" alt="image"><br><br>  Read more about this in the official video from the developer: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/1GGArfEijgE%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700191,15700253&amp;usg=ALkJrhgumBGKG9YqKN470ND6U3MdU3hHfg" frameborder="0" allowfullscreen=""></iframe><br><br>  Another bonus, a <a href="http://pdf.th7.cn/down/files/1407/Cuckoo%2520Malware%2520Analysis.pdf">book I found online</a> , is a good guide to using the Cuckoo Sandbox to analyze malicious files. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And if you use Symantec Endpoint Protection 12.1 antivirus at work, you can use the console utility under Windows </font></font><a href="https://yadi.sk/d/QuEme_C8aNwBc"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEPQuarantineTool.zip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> which is not officially supported by Symantec, but I found a link to it </font></font><a href="http://www.symantec.com/business/support/index%3Fpage%3Dcontent%26id%3DTECH150607"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in their support</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . With this utility, you can pull out and restore files from quarantine, via </font></font><a href="http://curl.haxx.se/download.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">curl for Windows,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> upload files to the server for scanning, using the </font></font><a href="http://cuckoo.readthedocs.org/en/latest/usage/api/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REST API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and using the same utility, put files back to quarantine. Thus, automating the analysis of threats and making black lists of sites and servers, where viruses are thrown.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In conclusion, I want to say that this tool helped to accomplish all the tasks, and the logs and malicious files of the hacker that was mentioned at the very beginning of the article are now analyzed in just a few minutes and allow you to understand the whole picture of the malware used by the hacker:</font></font><br><br>  Thanks for attention. <br><br><h4>  List of used sources </h4><br> <a href="http://docs.cuckoosandbox.org/">docs.cuckoosandbox.org</a> <br> <a href="http://xakep.ru/articles/57409/">xakep.ru/articles/57409</a> <br> <a href="http://lanswer.blogspot.ru/2012/11/add-cucksandbox-to-ubuntu-service.html">lanswer.blogspot.ru/2012/11/add-cucksandbox-to-ubuntu-service.html</a> <br> <a href="http://reverselab.info/page/cuckoo-sandbox">reverselab.info/page/cuckoo-sandbox</a> <br> <a href="http://www.alienvault.com/blogs/tag/yara">www.alienvault.com/blogs/tag/yara</a> <br> <a href="http://www.securitylab.ru/analytics/441524.php">www.securitylab.ru/analytics/441524.php</a> <br> <a href="https://www.modern.ie/ru-ru/">www.modern.ie/ru-ru</a> <br> <a href="http://www.aldeid.com/wiki/PEiD">www.aldeid.com/wiki/PEiD</a> <br> <a href="http://blog.prowling.nu/2014/08/cuckoo-sandbox-django-interface-with.html">blog.prowling.nu/2014/08/cuckoo-sandbox-django-interface-with.html</a> <br> <a href="https://github.com/conix-security/zer0m0n">github.com/conix-security/zer0m0n</a> <br> <a href="https://github.com/bostonlink/cuckooforcanari">github.com/bostonlink/cuckooforcanari</a> <br> <a href="http://santi-bassett.blogspot.ru/2013/01/installing-cuckoo-sandbox-on-virtualbox.html">santi-bassett.blogspot.ru/2013/01/installing-cuckoo-sandbox-on-virtualbox.html</a> </div><p>Source: <a href="https://habr.com/ru/post/234467/">https://habr.com/ru/post/234467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234457/index.html">Voice recorder as inbox in GTD system</a></li>
<li><a href="../234459/index.html">Overview of the most interesting materials on data analysis and machine learning ‚Ññ10 (August 18 - 25, 2014)</a></li>
<li><a href="../234461/index.html">CA7CH: the world's smallest wireless stream camera</a></li>
<li><a href="../234463/index.html">FAQ about the design, construction and launch of power centers in Russia</a></li>
<li><a href="../234465/index.html">Technological singularity as an event inevitable</a></li>
<li><a href="../234469/index.html">LAN between houses using WiFI bridge</a></li>
<li><a href="../234471/index.html">Review WD My Cloud 2 Tb. NAS or cloud? Or maybe together?</a></li>
<li><a href="../234477/index.html">ATtiny13 firmware and programming with Arduino UPD 03/17/2016</a></li>
<li><a href="../234481/index.html">Setting up PostgreSQL monitoring in Zabbix</a></li>
<li><a href="../234483/index.html">TestLink - pain and tears tester or a panacea? Implementation experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>