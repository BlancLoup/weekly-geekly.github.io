<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bash scripting techniques. # 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My last article Bash scripting techniques caused a heated debate in the comments. Its main message was in using the library of functions. In addition,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bash scripting techniques. # 2</h1><div class="post__text post__text-html js-mediator-article">  My last article <a href="http://habrahabr.ru/post/158971/">Bash scripting techniques</a> caused a heated debate in the comments.  Its main message was in using the library of functions.  In addition, I described the method of parsing parameters in Bash.  I thank everyone for the constructive comments.  I draw your attention that the article is intended for a wide range of readers, and is not addressed exclusively to system administrators. <br><br>  We will continue what we have begun and, with a real example, we will complement the approach to parsing the parameters and unifying the functionality of the scripts. <br><a name="habracut"></a>  So, let's write a script that synchronizes a certain directory to another: dir-sync.  In essence, this is cloning, and has the following differences from copying: <br><br><ul><li>  Files with the same date / time that already exist are not copied (this can be achieved with the cp command with the -u option) </li><li>  The destination directory deletes all files and directories that are not in the source. </li><li>  The script can synchronize data not only locally, but also to a remote computer </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In other words, in the receiver, we get exactly what is in the source, and this happens in the most optimal way.  This is an extremely useful approach, for example, when periodically saving a large amount of data to an external disk.  Only the new is copied, and what has changed, while the deleted files in the source are also deleted in the receiver.  In addition, access rights, Selinux attributes, and extended file attributes are also copied. <br><br>  Actually, as many have probably already guessed, we will not reinvent the wheel, but use the rsync program, which is intended for this.  Here the task is to wrap rsync with our script so that it is convenient to use.  Well, who wants to write something like that ?: <br><br><pre> rsync -rlptgoDvEAH --delete --delete-excluded --super --force
 --progress --log-file = / var / log / rs-total.txt --log-file-format =% o% i% f% b
 / data / src / proj / perl / my / web / company / roga-i-kopyta /
 / data / save / proj / perl / my / web / company / roga-i-kopyta /
</pre><br><br>  Obviously, our script has at least 2 parameters - the source and destination directories.  In the last article, this situation was not considered, namely, how, along with the keys, to handle the parameters of a fixed position.  And it is very desirable that the keys could be inserted anywhere, flowing around them fixed parameters.  For example: <br><br><pre><code class="bash hljs">dir-sync -key1 src-sri -key2 dest-dir key3</code> </pre> <br><br>  The algorithm for parsing the parameters I described earlier allows you to process keys in any order and in two forms.  It remains only to make the following changes to it: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     fixPrmCnt=0 pSrcDir= # - pDstDir= # - ... while [ 1 ] ; do if [ "$1" = "--yes" ] ; then pYes=1 ... else #     . #    ( )    . # ,    ¬´ ¬ª - #       (( fixPrmCnt++ )) #      #  ( )  ‚Äî     #    if [ 1 -eq $fixPrmCnt ] ; then pSrcDir="$1" elif [ 2 -eq $fixPrmCnt ] ; then pDstDir="$1" #    ,   #   -  else errMess ":  " exit 1 fi fi shift done</span></span></code> </pre><br><br>  As can be seen from the example, the processing of fixed parameters perfectly fits into the previously proposed scheme.  By the way, I added several functions to the library of functions that do not need to be considered, errMess is one of them.  In this article I do not focus on the implementation of library functions, since they are still very simple and obvious.  You can read them in the library file (at the end of the article).  For me, the main thing is to show how simple functions can significantly improve the clarity, readability and simplicity of the script code. <br><br>  Now we define the functionality of our cloning script.  He must: <br><br><ul><li>  When run without parameters, display a brief help. </li><li>  Require confirmation if nothing is specified except for the two specified parameters.  Yes!  The script is super-destructive, and this thing will not be superfluous. </li><li>  As described earlier, the --yes key is used to suppress confirmation.  This will allow to use the script in other scripts. </li></ul><br><br>  And here is another highlight: <br><ul><li>  When specifying the -i option, the script should become interactive. </li></ul><br><br>  For this script, this feature is probably unnecessary.  I describe it as a demonstration of what is possible, and sometimes convenient.  In fact, if the script has many options that it is important not to forget, it is better to provide such an opportunity, but of course, not for every reason.  The general rule is that interactivity should be optional.  However, there are also scripts that should be extremely interactive ‚Äî for example, to perform specific actions for inexperienced users. <br><br>  Well, actually functional: <br><br><ul><li>  Mode selection: replica / update </li><li>  Enable background mode (via nohup) </li><li>  Set log file name </li><li>  An opportunity to look at the resulting rsync command (also as an example, no more) </li></ul><br><br>  For the first time, the functionality is enough.  If necessary, we will develop it in the future.  I won't describe rsync and nohup ‚Äî it's enough just to read their man. <br><br>  We describe all the keys: <br><br><ul><li>  --yes: Suppress confirmation request </li><li>  -i |  --interactive: enable interactive mode </li><li>  -lf |  --log-file =: set log file name </li><li>  -u |  --update: update mode (default is an exact copy) </li><li>  -sc |  --show-command: show final rsync command </li><li>  -n |  --dry-run: ‚Äúidle mode‚Äù - rsync starts and informs about actions, but does not actually do anything </li><li>  -bg |  --background: run in background </li></ul><br><br>  These keys require corresponding variables.  So the header of the script will be something like this: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   fixPrmCnt=0 #    pInter= #   pLogFile= #  - pUpdate= #   pShowCmd= #   rsync pDryRun= #   pBackgr= #    pSrcDir= #   pDstDir= #   RSCmd= #  rsync RSPrm= #   rsync</span></span></code> </pre><br><br>  We do not declare the parameter pYes, as it is in our library.  Now consider the main blocks of the program. <br><br>  Here is what the parameter handling looks like: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> usage <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> [ 1 ] ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"--yes"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pYes=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"-i"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pInter=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"--interactive"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pInter=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> procParmS <span class="hljs-string"><span class="hljs-string">"-lf"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$2</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pLogFile=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cRes</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-built_in"><span class="hljs-built_in">shift</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> procParmL <span class="hljs-string"><span class="hljs-string">"--log-file"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pLogFile=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cRes</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"-u"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pUpdate=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"--update"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pUpdate=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"-sc"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pShowCmd=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"--show-command"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pShowCmd=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"-n"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pDryRun=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"--dry-run"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pDryRun=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"-bg"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pBackgr=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"--background"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> pBackgr=1 <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">break</span></span> <span class="hljs-comment"><span class="hljs-comment">#   else (( fixPrmCnt++ )) if [ 1 -eq $fixPrmCnt ] ; then pSrcDir="$1" elif [ 2 -eq $fixPrmCnt ] ; then pDstDir="$1" else errMess ":  " exit 1 fi fi shift done</span></span></code> </pre><br><br>  In the absence of parameters, a brief reference is displayed.  Further processing of the parameters, followed by their verification and, if necessary, a change (biting off the final slash). <br><br><pre> <code class="bash hljs">checkParm <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pSrcDir</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"  -"</span></span> checkParm <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pDstDir</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">"  -"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pInter</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span> ] &amp;&amp; [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pYes</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> errMess <span class="hljs-string"><span class="hljs-string">" : --yes  -i"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-comment"><span class="hljs-comment">#   ,    pSrcDir="${pSrcDir%/}" pDstDir="${pDstDir%/}" checkDir "$pSrcDir" checkDir "$pDstDir"</span></span></code> </pre><br><br>  The non-interactive part of the script looks very simple: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    if [ "$pInter" != "1" ] ; then #   if [ "$pYes" != "1" ] ; then echo " ${curScript##*/}  !" showInfo myAskYesNo "    !  ?" || exit fi createCmd</span></span></code> </pre><br><br>  We will look at the showInfo and createCmd functions ‚Äî this is actually the display of information about the parameters and the generation of the rsync command. <br><br>  And the next block is the interactive part.  Once again I draw your attention to how simple and readable the code becomes if you use the functions of the library.  Even the interactive part does not take up much space and is also understandable and simple. <br><br><pre> <code class="bash hljs"> cat &lt;&lt;EOF  <span class="hljs-variable"><span class="hljs-variable">${curScript##*/}</span></span>  !        .   : ------------------------ c) <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> ( ) u) update ( ) .)  EOF input1 <span class="hljs-string"><span class="hljs-string">" : "</span></span> <span class="hljs-string"><span class="hljs-string">"cu."</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cRes</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"."</span></span> ] &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> pBackgr= <span class="hljs-comment"><span class="hljs-comment">#    ,     input1 "       ? (y/n): " "yn." [ "$cRes" = "." ] &amp;&amp; exit [ "$cRes" = "y" ] &amp;&amp; pBackgr=1 #       ,      read -p "  - ( : $pLogFile): " a1 [ -n "$a1" ] &amp;&amp; pLogFile="$a1" [ "$a1" = "." ] &amp;&amp; exit pShowCmd= #    ,     input1 "    ? (y/n): " "yn." [ "$cRes" = "." ] &amp;&amp; exit [ "$cRes" = "y" ] &amp;&amp; pShowCmd=1 createCmd echo #     showInfo if [ "$pShowCmd" = "1" ] ; then echo " rsync:" echo " $RSCmd" "${RSPrm[@]}" fi myAskYesNo "!  ?" || exit</span></span></code> </pre><br><br>  As we can see, here parameters are sequentially polled, but not all.  It is assumed that the directories are still provided from the command line and do not participate in the survey - it is more convenient to set them there, although nothing prevents those who wish to add their processing here. <br><br>  There are also showInfo and createCmd functions. <br><br>  And now we slightly modify the function input1 (see in the library) so that it accepts a parameter that says that if you press a dot, you need to exit the script - ‚Äúdot-exit‚Äù.  We exclude one line to process each parameter!  Now the part of the code responsible for this looks like this: <br><br><pre> <code class="bash hljs"> input1 <span class="hljs-string"><span class="hljs-string">" : "</span></span> <span class="hljs-string"><span class="hljs-string">"cu."</span></span> <span class="hljs-string"><span class="hljs-string">"dot-exit"</span></span> pBackgr= <span class="hljs-comment"><span class="hljs-comment">#    ,     input1 "       ? (y/n): " "yn." "dot-exit" [ "$cRes" = "y" ] &amp;&amp; pBackgr=1 #       ,      read -p "  - ( : $pLogFile): " a1 [ -n "$a1" ] &amp;&amp; pLogFile="$a1" pShowCmd= #    ,     input1 "    ? (y/n): " "yn." "dot-exit" [ "$cRes" = "y" ] &amp;&amp; pShowCmd=1</span></span></code> </pre><br><br>  You can go further and enter several functions for entering parameters.  But it will leave the next time. <br><br>  The ending is obvious: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pBackgr</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> nohup <span class="hljs-variable"><span class="hljs-variable">$RSCmd</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${RSPrm[@]}</span></span></span><span class="hljs-string">"</span></span> &amp; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-variable"><span class="hljs-variable">$RSCmd</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${RSPrm[@]}</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br><br>  We will look at using the array a little later, and now we will notice that if rsync is launched at the very end, the result of its execution will be the result of the execution of our script.  By this we strive for the implementation of the rule that any script should return a result. <br><br>  And now we will consider functions which are also simple and clear. <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showInfo</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> a1 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pUpdate</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> a1=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> a1=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> padMid 80 <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$a1</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$cRes</span></span> padMid 80 <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pSrcDir</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$cRes</span></span> padMid 80 <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pDstDir</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$cRes</span></span> padMid 80 <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pLogFile</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$cRes</span></span> transYesNoRu <span class="hljs-variable"><span class="hljs-variable">$pBackgr</span></span> padMid 80 <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cRes</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$cRes</span></span> transYesNoRu <span class="hljs-variable"><span class="hljs-variable">$pDryRun</span></span> padMid 80 <span class="hljs-string"><span class="hljs-string">"   "</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cRes</span></span></span><span class="hljs-string">"</span></span> ; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$cRes</span></span> }</code> </pre><br><br>  Here we use the library functions padMid to display the parameter values ‚Äã‚Äãnicely and smoothly (the parameter ‚Äú80‚Äù is the width of the string).  The transYesNoRu function of 1 makes ‚Äúyes‚Äù, from the rest ‚Äúno‚Äù. <br><br>  The conclusion is approximately as follows: <br><br><pre> <code class="bash hljs">.....................................  .......................... /data/src/proj/fed16 ........................... /data/src/proj/sync -......................... /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/dir-sync.log   ...................................     ........................ </code> </pre><br><br>  Finally, the heart of the script is the generation of the rsync command, where keys are sequentially added in accordance with the specified parameters. <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createCmd</span></span></span></span>() { RSCmd=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$rsync</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pUpdate</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span> ] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> RSCmd=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RSCmd</span></span></span><span class="hljs-string"> -urlptgoDvEAH"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> RSCmd=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RSCmd</span></span></span><span class="hljs-string"> -rlptgoDvEAH --delete"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-comment"><span class="hljs-comment">#    -    ,   if [ "$pBackgr" = "1" ] ; then RSCmd="$RSCmd -q" else RSCmd="$RSCmd --progress -v" fi if [ "$pDryRun" = "1" ] ; then RSCmd="$RSCmd -n" fi RSCmd="$RSCmd --super --force" #   -   n=-1 ((n++)) ; RSPrm[n]="--log-file=$pLogFile" ((n++)) ; RSPrm[n]="$pSrcDir/" ((n++)) ; RSPrm[n]="$pDstDir/" }</span></span></code> </pre><br><br>  That is, createCmd generates the RSCmd variable, which is then run at the end of the script. <br><br>  Note especially the use of the RSPrm array.  The fact is that if there are spaces in the file names (and we are writing a more or less universal script, which should be taken into account this moment), then the assembly of a single RSCmd line will not work.  Remember the ending: $ RSCmd "$ {RSPrm [@]}"?  If everything were typed only in the $ RSCmd line and the ending would look like $ RSCmd, then the name of the directory or log file with spaces would be broken by the bash interpreter.  For example, if you specified the source directory ‚Äúmy dir‚Äù, instead of copying ‚Äúmy dir‚Äù where indicated, there would be an attempt to copy my into dir, and then another into this ‚Äúsomewhere‚Äù. <br><br>  Attempts to build a string like <br><br><pre> <code class="bash hljs">RSCmd=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RSCmd</span></span></span><span class="hljs-string"> \"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pSrcDir</span></span></span><span class="hljs-string">/\" \"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pDstDir</span></span></span><span class="hljs-string">/\" "</span></span></code> </pre><br><br>  , that is, to add escaped quotes to this line, they will also not succeed.  We will get the names of files like ‚Äúmy dir‚Äù <i>along with quotes</i> . <br><br>  Using an array solves this problem.  The array is also initialized as a normal variable (RSPrm =), more precisely, it <i>is a</i> normal variable until it is used as an array.  And that's exactly what we do when we execute ((n ++));  RSPrm [n] = "- log-file = $ pLogFile".  Array indices in bash start at zero.  For universality and readability, we initialize n = -1, then simply increment it and get a new valid index. <br><br>  The use of the array occurs at the end: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$RSCmd</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${RSPrm[@]}</span></span></span><span class="hljs-string">"</span></span></code> </pre><br><br>  This construction does the following - the elements of the array are inserted into the string <i>separately, and they are an indivisible parameter,</i> whatever they are (whitespace characters.) If you replace the @ symbol with * we get an effect similar to using a regular string, that is, each element the array will be parsed by whitespace characters and it is precisely the tokens broken in this way that will appear as parameters.  This is exactly what we avoided, therefore we need only @ here. <br><br>  In general, using arrays in this way is extremely useful when the parameters are strings containing spaces.  For example, the same rsync can accept file filtering options, such as: '-f- * .tmp', meaning that synchronization ignores * .tmp files.  So, '-f- * .tmp' is a single parameter that contains a space.  If you collect strings once, you can specify these parameters in quotes or apostrophes of the type: <br><br><pre> <code class="bash hljs">rsync ... <span class="hljs-string"><span class="hljs-string">'-f- *.tmp'</span></span> <span class="hljs-string"><span class="hljs-string">'-f- *.log'</span></span> ...</code> </pre><br><br>  But if you try to assemble such a line in advance, and then execute it - there will be a guard!  For example: <br><br><pre> <code class="bash hljs">param=<span class="hljs-string"><span class="hljs-string">"-f- *.tmp"</span></span> param=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$param</span></span></span><span class="hljs-string"> -f- *.log"</span></span></code> </pre><br><br>  likewise does not work and <br><br><pre> <code class="bash hljs">param=<span class="hljs-string"><span class="hljs-string">"'-f- *.tmp'"</span></span> param=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$param</span></span></span><span class="hljs-string"> '-f- *.log'"</span></span></code> </pre>  And in such cases we are forced to use an array as described above. <br><br><h3>  Summary </h3><br><ul><li>  We added the processing of fixed parameters to the parsing algorithm. </li><li>  We have seen that interactivity can be provided with simple and understandable means. </li><li>  We have seen that library functions clarify and make writing easier. </li><li>  We have seen how arrays can help with parameter assembly. </li><li>  We got a really working script within its capabilities. </li></ul><br><br>  What haven't we got?  Of course the perfect sync script.  This option is far from perfect, and there are more complaints about it than lines of code in it.  But he did not claim to be the ideal, but just a clear example.  But he still has, besides clarity, one more advantage - it works.  And performs its narrow function. <br><br>  I draw the attention of readers who are not familiar with rsync - one of the directories can be set on a remote machine in the form <br><br><pre> <code class="bash hljs">[user@][host:]dir-from-root</code> </pre><br>  , i.e <br><br><pre> <code class="bash hljs">vova@mycomp:/save/work mycomp:/save/work</code> </pre><br><br>  The script call can be, for example, like this: <br><br><pre> <code class="bash hljs">dir-sync -u /work mycomp:/save/work</code> </pre><br><br>  If there are readers who would like to continue developing this script - write in the comments. <br><br>  <a href="http://linuxmy.com/139/144/43-c40/c43/136-136">Library files and the script itself can be found here</a> . </div><p>Source: <a href="https://habr.com/ru/post/163691/">https://habr.com/ru/post/163691/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../163681/index.html">Game Theory: An Introduction</a></li>
<li><a href="../163683/index.html">Designer developer Arduino named entrepreneur of the year in the US</a></li>
<li><a href="../163685/index.html">Christmas sale on Google Play! Discounts up to 86%!</a></li>
<li><a href="../163687/index.html">What else can you type?</a></li>
<li><a href="../163689/index.html">Minicomputer from a router with OpenWRT: we are developing a USB video card</a></li>
<li><a href="../163693/index.html">EU is going to reform copyright</a></li>
<li><a href="../163695/index.html">"Do not tell me where to go" - your user</a></li>
<li><a href="../163699/index.html">The history of one mBaaS (cloud backend) service on the example of QuickBlox</a></li>
<li><a href="../163703/index.html">The story of one habraspor</a></li>
<li><a href="../163707/index.html">Using CDN for Windows Azure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>