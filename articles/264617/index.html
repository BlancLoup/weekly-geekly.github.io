<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OTRS 4.0.10. We put on Ubuntu + AD + Kerberos + SSO (Part One)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vidu that the article and so it turned out too big, and besides, I want to add to it her a couple of nuances break it into several parts, and I will p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OTRS 4.0.10. We put on Ubuntu + AD + Kerberos + SSO (Part One)</h1><div class="post__text post__text-html js-mediator-article">  Vidu that the article and so it turned out too big, and besides, I want to add to it her a couple of nuances break it into several parts, and I will publish further additions as separate parts. <br><br>  <a href="http://habrahabr.ru/post/264617/">Part One: System Preparation</a> <br>  <a href="http://habrahabr.ru/post/265537/">Part Two: Installing and Configuring OTRS</a> <br>  <a href="http://habrahabr.ru/post/265541/">Part three: fix the shoals fasten buns</a> <br><br><h4>  Instead of introducing </h4><br>  Any sufficiently large organization sooner or later faces the need to introduce a ticket or helpdesk system.  And our organization is no exception, in connection with which the management has been tasked to select and implement a system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Frankly speaking, there were no doubts about the choice, for personal reasons the choice fell on OTRS.  Powerful and flexible with a huge number of reports that management loves so much.  But as it turned out, to introduce it is a completely non-trivial task.  The torture lasted for two weeks, tons of information were shoveled, a bunch of different manuals were tried, and I had the impression that I was either a complete idiot or one of two, because in all the manuals and in a bunch of reviews they all said in one voice that everything worked and was well placed and is configured, but I do not like. <br><br>  In fact, the problem with all these manuals is that everything seems to be the same as yours, but somewhere a little bit the wrong version of the package, a little bit less structured AD, etc. That's because of all these little almost does not fold the stone flower.  In a word, by trial and error, reading the documentation and analyzing manuals, I developed my own, quite working method, which I would like to explain. <br><a name="habracut"></a><br><h4>  Baseline and Requirements </h4><br><ul><li>  In an organization, AD is raised on two Win2008r2 controllers, and since this is so, then integration with AD is needed, since in my opinion, the integration of everything and everything, especially with LDAP "is the true way" </li><li>  Many services (such as mail and Jabber) are raised on Linux, and Ubuntu Server 14.04 is chosen as the OS, and since OTRS is OpenSource, then in my opinion, it will be installed on the proprietary OS, so I will install it on Ubuntu.  By the way, if it will be interesting in the following articles, I‚Äôll try to tell you about my experience in raising these services and integrating them with AD and OTRS.  (The integration of OTRS and Jabber is generally a very cool and useful thing) </li><li>  The ability to quickly pick up on the machine file scanner for scanning a little bit, etc. </li><li>  And finally, since we have AD, and when the computer is turned on, the user still enters his password and the system already at this stage knows who works in the system, then it would be necessary to save him of unnecessary passwords and logins and implement pass-through authorization. </li></ul><br>  Here is the standard set of requirements, as I already said, corporate mail and Jabber work in the network, and an additional requirement was to integrate OTRS and with them too.  But since the article turned out so great about integrating OTRS with them, I‚Äôll tell you when I will write about them. <br><br>  In fact, it is not difficult to put OTRS and even integrates with AD at times, the whole snag was in pass-through authorization or (SSO).  A bunch of manuals were found on the network in this regard, but none came up to me for various reasons, in one OTRS was installed on Windows, in the other too old version of OTRS, in the third one used an adapter module written by who and when. <br>  In general, I will say that there are 4 ways to implement pass-through authorization. <br><br><ol><li>  The first is SSPI, but it does not fit, because it is a module for OTRS under Windows </li><li>  The second is the self-written ADSSO module, in fact just a doped LDAP authorization module, which in my opinion is a crutch. </li><li>  The third is again a self-written NTLM authorization module for OTRS, which is also a crutch. </li><li>  And the last is the regular OTRS HTTPBasicAuth module in a company with Kerberos authentication. </li></ol><br>  Here is the last in my opinion (and I think many will agree with me) is the most correct and safe.  So, the source data: <br><ul><li>  Network 192.168.0.0/16 </li><li>  Domain DOMAIN.RU </li><li>  Domain controllers on them and DNS and NTP </li><li>  PDC - ad1.domain.ru (192.168.10.1) </li><li>  SDC - ad2.domain.ru (192.168.10.2) </li><li>  GATE 192.168.10.10 </li><li>  All domain users are in the organization unit ORGANIZATION within which are scattered in groups. </li><li>  A group of OTRSagents has been created, which includes service workers, that is, those who receive applications (in the terminology of OTRS "Agents"). </li><li>  Clients, that is, those who send applications (in the terminology of OTRS ‚ÄúKustomer‚Äù) will be all domain users without exception. </li></ul><br>  Another configuration is also possible from the OTRS config. You will understand how to configure it for other locations of users and agents. <br><br>  The OTRS server will read the information from LDAP on behalf of the user otrs.admin, for the period of the configuration we will give it domain administrator rights, after the configuration we will select them and even the right to log in on the machines, it just needs to be able to read the information from LDAP. <br><br><h4>  1. Preparation of the system </h4><br><h5>  1.1 Install Ubuntu Server with these settings (these are my settings, you may have other) </h5><br><ul><li>  IP: 192.168.10.14 </li><li>  MASK: 255.255.0.0 </li><li>  GATE: 192.168.10.10 </li><li>  DNS: 192.168.10.1 192.168.10.2 8.8.8.8 </li><li>  NAME: HELPDESK </li><li>  USER: helpdesk </li><li>  PASS: strongpass </li></ul><br>  At the final stage, the installation will ask if we want to preinstall any software, choose the installation of the OpenSSH server. <br><br><h5>  1.2.  We cling on SSH to the new server </h5><br><pre><code class="bash hljs">ssh 192.168.10.14 -l helpdesk</code> </pre> <br>  We agree to accept the key and enter the password for helpdesk <br>  Raise rights to root <br><pre> <code class="bash hljs">sudo su</code> </pre><br>  <b>!</b>  <b>ATTENTION!</b>  <b>All further actions are performed from su, and after system reboots, we do not forget to again raise the rights to root.</b> <br><br>  We check the relevance of the information in the <i>/ etc / hostname</i> and <i>/ etc / hosts</i> files: in the first one there should be the name of our machine in large letters, in the second there should be an entry like: <i>127.0.0.1 helpdesk.domain.ru helpdesk</i> <br><br>  If something is wrong - fix it.  Now we try to ping all domain controllers by IP, full and abbreviated name.  Must ping for everyone.  If not, we understand the network settings. <br><br><h5>  1.3.  Update and install mc </h5><br><pre> <code class="bash hljs">apt-get update &amp;&amp; apt-get -y upgrade &amp;&amp; apt-get install -y mc</code> </pre><br>  for the inexperienced, you can execute commands in turn <br><pre> <code class="bash hljs">apt-get update apt-get -y upgrade apt-get install -y mc</code> </pre><br><h4>  2. Enter the machine in the domain and set up domain authorization.  Configuring Samba, Kerberos and Winbind. </h4><br>  An excellent article on this subject is on the Ubuntu tech support site: <a href="http://help.ubuntu.ru/wiki/%25D0%25B2%25D0%25B2%25D0%25BE%25D0%25B4_%25D0%25B2_%25D0%25B4%25D0%25BE%25D0%25BC%25D0%25B5%25D0%25BD_windows">help.ubuntu.ru/wiki/%D0%B2%D0%B2%D0%BE%D0%B4_%D0%B2_%D0%B4%D0%BE%D0% BC% D0% B5% D0% BD_windows</a> <br><br><h5>  2.1.  Install and configure Kerberos </h5><br>  Put the necessary packages: <br><pre> <code class="bash hljs">apt-get install krb5-user samba winbind libpam-krb5 libpam-winbind libnss-winbind ntp smbclient rlwrap</code> </pre><br>  It is very important for Kerberos to work so that the clock on the computers goes synchronously and the time difference does not exceed 5 minutes.  Configure time synchronization with the domain controller in the <i>/etc/ntp.conf</i> file <br><br>  As the name implies, the file is responsible for setting the <i>ntp</i> daemon, which periodically adjusts the system clock.  The time <i>server</i> is set by the <i>server</i> directive, so we need to comment out all the lines indicating the time servers that are there and enter our own. <br><pre> <code class="bash hljs">mcedit /etc/ntp.conf</code> </pre><br>  We comment on all the deadlines starting with server: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#server 0.ubuntu.pool.ntp.org #server 1.ubuntu.pool.ntp.org #server 2.ubuntu.pool.ntp.org #server 3.ubuntu.pool.ntp.org # Use Ubuntu's ntp server as a fallback. #server ntp.ubuntu.com</span></span></code> </pre><br>  And we write our own: <br><pre> <code class="bash hljs">server 192.168.10.1 server 192.168.10.2</code> </pre><br>  I have two domain controllers and an exact time service is raised on each one.  After that, save the file and restart the daemon with the new settings: <br><pre> <code class="bash hljs">service ntp restart</code> </pre><br>  The output should be: <br><pre> <code class="bash hljs">root@HELPDESK:/home/helpdesk<span class="hljs-comment"><span class="hljs-comment"># service ntp restart * Stopping NTP server ntpd [ OK ] * Starting NTP server ntpd [ OK ]</span></span></code> </pre><br>  The daemon is launched with new settings and synchronizes the clock.  Kerberos is configured by editing the <i>krb5.conf</i> file: <br><pre> <code class="bash hljs">mcedit /etc/krb5.conf</code> </pre><br>  First of all, let's turn on the logs, for this we will add a section to the very beginning of the file: <br><pre> <code class="bash hljs">[logging] default = FILE:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/krb5libs.log kdc = FILE:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/krb5kdc.log admin_server = FILE:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/kadmind.log</code> </pre><br>  And then we need to explain kerberos in which domain (in Kerberos terminology - in which realm) it works and who rules this realm.  To do this, rule the sections: <br><pre> <code class="bash hljs">[libdefaults] default_realm = DOMAIN.RU <span class="hljs-comment"><span class="hljs-comment">#(    ) [realms] #    DOMAIN.RU = { #.   .    kdc = ad1.domain.ru #     kdc = ad2.domain.ru #.   ,    admin_server = ad1.domain.ru admin_server = ad2.domain.ru default_domain = domain.ru } [domain_realm] #     .domain.ru = DOMAIN.RU #  () domain.ru = DOMAIN.RU</span></span></code> </pre><br>  Now we need to check the performance of our config, for this we will try to get a kerberos ticket in the domain for some user: <br><pre> <code class="bash hljs">kinit username@DOMAIN.COM <span class="hljs-comment"><span class="hljs-comment"># username ‚Äî   , !  !</span></span></code> </pre><br>  After that, she will request a password and try to get a ticket.  If everything went well, the command will remain silent, that is, the output will be empty.  Something like this: <br><pre> <code class="bash hljs">root@HELPDESK:/home/helpdesk<span class="hljs-comment"><span class="hljs-comment"># kinit otrs.admin@DOMAIN.RU Password for otrs.admin@DOMAIN.RU: root@HELPDESK:/home/helpdesk#</span></span></code> </pre><br>  Check if we got the ticket, enter: <br><pre> <code class="bash hljs">klist</code> </pre><br>  And we see something like this: <br><pre> <code class="bash hljs">root@HELPDESK:/home/helpdesk<span class="hljs-comment"><span class="hljs-comment"># klist Ticket cache: FILE:/tmp/krb5cc_0 Default principal: test@DOMAIN.RU Valid starting Expires Service principal 10.08.2015 15:46:01 11.08.2015 01:46:01 krbtgt/DOMAIN.RU@DOMAIN.RU renew until 11.08.2015 15:45:57</span></span></code> </pre><br>  As you can see, we received the ticket successfully and everything is OK.  So the config works.  Now we crash the ticket until we need it. <br><pre> <code class="bash hljs">Kdestroy</code> </pre><br>  The output is also empty, and that means the ticket has been destroyed (note that the command destroys ALL tickets in the cache). <br><br><h5>  2.2 It's time to configure SAMBA and join the domain. </h5><br>  To do this, edit the file <i>/etc/samba/smb.conf</i> : <br><pre> <code class="bash hljs">mcedit /etc/samba/smb.conf</code> </pre><br>  Here we rule the [global] section: <br><pre> <code class="bash hljs">[global] <span class="hljs-comment"><span class="hljs-comment">#         ,  workgroup  #    ,  realm -    workgroup = RUS realm = DOMAIN.RU #          AD security = ADS encrypt passwords = true #   dns proxy = no socket options = TCP_NODELAY #    ,             , #    ,           domain master = no local master = no preferred master = no os level = 0 domain logons = no #    load printers = no show add printer wizard = no printcap name = /dev/null disable spoolss = yes</span></span></code> </pre><br>  Check the configuration correctness with the command: <br><pre> <code class="bash hljs">testparm</code> </pre><br>  The output will be something like this: <br><pre> <code class="bash hljs">Load smb config files from /etc/samba/smb.conf rlimit_max: increasing rlimit_max (1024) to minimum Windows <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> (16384) Processing section <span class="hljs-string"><span class="hljs-string">"[printers]"</span></span> Processing section <span class="hljs-string"><span class="hljs-string">"[print$]"</span></span> Loaded services file OK. Server role: ROLE_DOMAIN_MEMBER Press enter to see a dump of your service definitions</code> </pre><br>  By pressing Enter, we will see the compiled <i>smb.conf</i> (that is, no comments): <br><br>  The message <i>‚Äúrlimit_max: increasing rlimit_max (1024) to minimum Windows limit (16384)‚Äù</i> occurs due to the difference in the pool of limits between Windows and Ubuntu, we will get rid of it a little later, when we correct the limits. <br><br>  Now we try to directly enter the domain.  To do this, execute the command: <br><pre> <code class="bash hljs">net ads join -U username -D DOMAIN <span class="hljs-comment"><span class="hljs-comment">#username -  </span></span></code> </pre><br>  She first asks for the user's password and if everything is OK, then the output will be like this: <br><pre> <code class="bash hljs">Using short domain name -- RUS Joined <span class="hljs-string"><span class="hljs-string">'HELPDESK'</span></span> to dns domain <span class="hljs-string"><span class="hljs-string">'domain.ru'</span></span></code> </pre><br>  You can check the correctness of connection to the domain with the command: <br><pre> <code class="bash hljs">net ads testjoin</code> </pre><br>  Her output should be: <br><pre> <code class="bash hljs">Join is OK</code> </pre><br>  You can check the settings at this stage by trying to index the shared resources of any machine in the domain.  We get a ticket: <br><pre> <code class="bash hljs">kinit username@DOMAIN.COM</code> </pre><br>  And we try to look at the resources of any machine, for example a file server: <br><pre> <code class="bash hljs">smbclient -k -L //File-server</code> </pre><br>  The -k key says that you need to use kerberos, <i>File-server</i> is the name of the machine in the domain that has shared resources.  In the output of the command, you should see a list of common resources of the specified machine, if yes, everything is ok, so far everything has been done correctly.  Then we destroy the tickets with the command: <br><pre> <code class="bash hljs">kdestroy</code> </pre><br><h5>  2.3 Configuring Winbind </h5><br>  To do this, we rule the same <i>/etc/samba/smb.conf</i> and add the following lines to the [global] section: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#           Winbind. #       . idmap config * : range = 10000-20000 idmap config * : backend = tdb #     . winbind enum groups = yes winbind enum users = yes #       .        #    , ..  username - DOMAIN\username. #      ,      . winbind use default domain = yes #          #,    ,    shell'   #/bin/false template shell = /bin/bash #     Kerberos  pam_winbind.so    winbind refresh tickets = yes #           kerberos #       (     # ),      ¬´passdb backend = tdbsam¬ª   : kerberos method = system keytab dedicated keytab file = /etc/krb5.keytab</span></span></code> </pre><br>  We check the correctness of our configuration: <br><pre> <code class="bash hljs">testparm</code> </pre><br>  And if everything is ok, we restart the daemons (in exactly the following sequence): <br><pre> <code class="bash hljs">service winbind stop service smbd restart service winbind start</code> </pre><br>  If the services are restarted, the normal output will be approximately as follows: <br><pre> <code class="bash hljs">root@HELPDESK:/home/helpdesk<span class="hljs-comment"><span class="hljs-comment"># service winbind stop winbind stop/waiting root@HELPDESK:/home/helpdesk# service smbd restart smbd stop/waiting smbd start/running, process 4859 root@HELPDESK:/home/helpdesk# service winbind start winbind start/running, process 4871</span></span></code> </pre><br>  Do you have the same?  Then we go further.  It's time to fix the limits on which the samba swears.  They are governed in the /etc/security/limits.conf file.  It is necessary to add two lines to the end of the file: <br><pre> <code class="bash hljs">* - nofile 16384 root - nofile 16384</code> </pre><br>  After this operation, you must restart the machine: <br><pre> <code class="bash hljs">shutdown -r now</code> </pre><br>  or <br><pre> <code class="bash hljs">reboot</code> </pre><br>  Who like? <br><br>  After the reboot, check if our machine has established a trust relationship with the domain: <br><pre> <code class="bash hljs">wbinfo -t</code> </pre><br>  The output should be like this: <br><pre> <code class="bash hljs">checking the trust secret <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> domain DCN via RPC calls succeeded</code> </pre><br>  Let me remind you that all commands are executed by root.  At first, I had a gag at this stage, because after the reboot I forgot to raise the rights to su.  All secrets (tickets, etc.) are stored in samba databases /var/lib/samba/private/*.tdb which only root can access.  So do not forget after the reboots to increase the rights and all commands are executed from the superuser.  We also check that winbind sees users and groups in the domain: <br><pre> <code class="bash hljs">wbinfo -u</code> </pre><br>  and <br><pre> <code class="bash hljs">wbinfo -g</code> </pre><br><h5>  2.4.  Well, another bonus </h5><br>  Since we‚Äôve entered the machine into the domain, we‚Äôll add the ability to log in to the machine under the domain accounts.  To do this, add the <i>winbind</i> data source in the <i>/etc/nsswitch.conf</i> file.  It will also give us the opportunity to work with domain users as local, and therefore assign them as owners of objects and give access rights.  That will give the opportunity to raise the balls on the Linux machine.  Here are the lines: <br><pre> <code class="bash hljs">passwd: compat group: compat</code> </pre><br>  to mind <br><pre> <code class="bash hljs">passwd: compat winbind group: compat winbind</code> </pre><br>  It is also recommended to add a line to the end of the file: <br><pre> <code class="bash hljs">files: dns mdns4_minimal[NotFound=<span class="hljs-built_in"><span class="hljs-built_in">return</span></span>] mdns4</code> </pre><br>  This stage is checked by querying the list of users and groups: <br><pre> <code class="bash hljs">getent passwd</code> </pre><br>  and <br><pre> <code class="bash hljs">getent group</code> </pre><br>  In the output, we are looking for domain users and groups, and if we find them, then everything is ok.  And the last thing: let's give the opportunity to open sessions to domain users, in previous versions of Ubunt, non-trivial dances with a percussion instrument were needed for this, but now PAM.D does a great job with our task, we add the line to the <i>/etc/pam.d/common-session file</i> : <br><pre> <code class="bash hljs">session optional pam_mkhomedir.so skel=/etc/skel/ <span class="hljs-built_in"><span class="hljs-built_in">umask</span></span>=0077</code> </pre><br>  Now <i>reboot</i> and try to log in under the domain register, if it works, then all the previous steps are done correctly. <br><br><h4>  3. Create a Kerberos key and add HTTP principality to the domain. </h4><br>  I spent the next 3 stages for 2 weeks, until I figured out what was happening.  As is often the case, everything turned out to be quite simple and started up the first time; it was just necessary to analyze a ton of information and put it into a single sequence <br>  At this three stages <a href="http://val-khmyrov.blogspot.ru/2011/04/apache-active-directory-kerberos.html">, this article</a> helped me a lot. <br><br>  So, the Kerberos protocol, is a network authentication protocol based on the principle of trust to a third party, the directory says so to us.  What does it mean?  This means that in the authentication process there is a third party that the interaction participants trust by default, such a party is called the Key Distribution Center, if the client sends a message to the KDC before the server goes to the server, and the KDC sends the session copy to each participant in the session key, valid for a short period of time.  The purpose of these keys is to authenticate the client and server. <br><br>  For people familiar with cryptography, I‚Äôll say that the entire Kerberos mechanism slightly more than completely copies the PKI mechanism.  In fact, he is only sharpened for other tasks.  Only instead of the certificate authority in this case is the Key Distribution Center (KDC).  Usually located on a domain controller. <br><br>  The new word ‚Äúprincipled‚Äù, in the terminology of Kerberos, is the name of the participants in the network interaction, that is, those who apply to the KDC for keys. <br><br>  You can perform this step in two ways, complicated and simpler.  For some reason, all the manuals on the network describe a more complicated method, namely, creating a Kerberos key on a domain controller using the <i>ktpass</i> utility (a terrible beast with an incredible number of keys) and then copying it to a Linux machine.  I do not deny the canonical correctness of this path, but if you please, the command is obtained in several lines and I did not comprehend Zen when using it. <br><br>  As it turned out, there is a simpler way - creating a key directly on a Linux machine.  In the network, I found only one mention of it, maybe I looked badly, but it works. <br><br>  Also, in order to control the accuracy at this stage, we will need to do something on the domain controller. <br>  First we go to the controller and open the ‚ÄúAD-users and computers‚Äù snap-in, open the container with computers and look for our Linux-machine, it should appear there after we included it into the domain.  Found - approx.  Go ahead. <br><br>  Now we need an ADSI editor, open the command line, type: <br><pre> <code class="dos hljs">adsiedit.msc</code> </pre><br>  And click inter.  We see the console tree copying the AD console in its structure.  Here we find our car, open its properties and look for the <i>servicePrincipalName</i> attribute in the list.  Now there should be two entries of the type <i>HOST / hepldesk.domain.ru</i> and <i>HOST / helpdesk</i> . <br><br>  Both start on HOST in one full in another abbreviated name of our machine, this means that now our machine is HOST, that is, an ordinary machine in the domain. <br><br>  Now we go to the Linux machine and execute the command: <br><pre> <code class="bash hljs">net ads keytab create</code> </pre><br>  The output of the command is empty, but after execution the file /etc/krb5.keytab should be created, or any other one, depending on what you specified in the <i>smb.conf</i> file in the <i>dedicated keytab file</i> directive <i>.</i>  But after all, OTRS, this is a web application and our Linux machine will provide http services, which means we need to add HTTP as well.  No sooner said than done: <br><pre> <code class="bash hljs">net ads keytab add HTTP</code> </pre><br>  If you now look at the list of principals, in the properties of the machine on the domain, you will notice that there are two more added - " <i>HTTP / helpdesk.domain.ru</i> " and " <i>HTTP / helpdesk</i> " (a small nuance: the information in the ADSI Edit window is not updated automatically, so close the properties of the machine, press F5 and open them again). <br><br>  In principle, this already means that the addition was successful.  However, let's see what is now in the keytab: <br><pre> <code class="bash hljs">klist -ek /etc/krb5.keytab <span class="hljs-comment"><span class="hljs-comment">#     keytab Keytab name: FILE:/etc/krb5.keytab KVNO Principal ---- -------------------------------------------------------------------------- 2 host/helpdesk.domain.ru@DOMAIN.RU (DES cbc mode with CRC-32) 2 host/helpdesk.domain.ru@DOMAIN.RU (DES cbc mode with RSA-MD5) 2 host/helpdesk.domain.ru@DOMAIN.RU (ArcFour with HMAC/md5) 2 host/helpdesk@DOMAIN.RU (DES cbc mode with CRC-32) 2 host/helpdesk@DOMAIN.RU (DES cbc mode with RSA-MD5) 2 host/helpdesk@DOMAIN.RU (ArcFour with HMAC/md5) 2 HELPDESK$@DOMAIN.RU (DES cbc mode with CRC-32) 2 HELPDESK$@DOMAIN.RU (DES cbc mode with RSA-MD5) 2 HELPDESK$@DOMAIN.RU (ArcFour with HMAC/md5) 2 HTTP/helpdesk.domain.ru@DOMAIN.RU (DES cbc mode with CRC-32) 2 HTTP/helpdesk.domain.ru@DOMAIN.RU (DES cbc mode with RSA-MD5) 2 HTTP/helpdesk.domain.ru@DOMAIN.RU (ArcFour with HMAC/md5) 2 HTTP/helpdesk@DOMAIN.RU (DES cbc mode with CRC-32) 2 HTTP/helpdesk@DOMAIN.RU (DES cbc mode with RSA-MD5) 2 HTTP/helpdesk@DOMAIN.RU (ArcFour with HMAC/md5)</span></span></code> </pre><br>  For complete confidence, you can get a Kerberos ticket from the KDC for the newly established principals: <br><pre> <code class="bash hljs">kvno HTTP/web.domain.ru@DOMAIN.RU HTTP/web@DOMAIN.RU HTTP/web.domain.ru@DOMAIN.RU: kvno = 2 HTTP/web@DOMAIN.RU: kvno = 2</code> </pre><br>  We look tickets team: <br><pre> <code class="bash hljs">klist -e</code> </pre><br>  The output will be a complete list of tickets currently available, and among them should be HTTP tickets, if there is, then everything is OK, and if you are not a perfectionist, you can proceed to the next step. <br><br>  And for the rest I will say, I am just a perfectionist and I consider it somewhat incorrect to store all the keys in one file, let's select everything related to HTTP into a separate key file. You can do this with the help of <i>ktutil</i> .  It does not support advanced editing functions, so it can be launched via <i>rlwrap</i> . <br><pre> <code class="bash hljs">rlwrap ktutil</code> </pre><br>  Load the containment of the keytab file: <br><pre> <code class="bash hljs">ktutil: read_kt /etc/krb5.keytab</code> </pre><br>  Let's see what we have now in it: <br><pre> <code class="bash hljs">ktutil: list</code> </pre><br>  We are interested in everything that starts with HTTP, we delete everything that is superfluous: <br><pre> <code class="bash hljs">ktutil: delent 1 <span class="hljs-comment"><span class="hljs-comment"># 1    </span></span></code> </pre><br>  It should be something like this: <br><pre> <code class="bash hljs">ktutil: list slot KVNO Principal ---- ---- --------------------------------------------------------------------- 1 2 HTTP/helpdesk.domain.ru@DOMAIN.RU 2 2 HTTP/helpdesk.domain.ru@DOMAIN.RU 3 2 HTTP/helpdesk.domain.ru@DOMAIN.RU 4 2 HTTP/helpdesk.domain.ru@DOMAIN.RU 5 2 HTTP/helpdesk.domain.ru@DOMAIN.RU 6 2 HTTP/HELPDESK@DOMAIN.RU 7 2 HTTP/HELPDESK@DOMAIN.RU 8 2 HTTP/HELPDESK@DOMAIN.RU 9 2 HTTP/HELPDESK@DOMAIN.RU 10 2 HTTP/HELPDESK@DOMAIN.RU</code> </pre><br>  Now save all that remains in a separate file: <br><pre> <code class="bash hljs">ktutil: write_kt /etc/httpd.keytab</code> </pre><br>  And exit the utility: <br><pre> <code class="bash hljs">quit</code> </pre><br><h4>  4. We put Apache2 and modules.  (LAMP) + Perl </h4><br>  Excellent manual for setting up services in Ubuntu 14 <a href="http://www.server-world.info/en/note%3Fos%3DUbuntu_14.04%26p%3Dinstall">here</a> <a href="http://www.server-world.info/en/note%3Fos%3DUbuntu_14.04%26p%3Dinstall"><br></a>  . <br>  I don‚Äôt know how for you, but for me if the web server is <b>LAMP</b> , so we put the whole stack at once, especially since we <i>already</i> need MySQL and Apache, and php has a convenient function <i>phpinfo ();</i>  with which we will monitor environment variables. <br><br><h6>  So let's go.  We put Apache </h6><br><pre> <code class="bash hljs">apt-get install mysql-server apache2 php5 libapache2-mod-php5 libapache2-mod-auth-mysql php5-mysql php5-cgi libapache2-mod-php5 php5-common php-pear</code> </pre><br>  During the installation of the <i>mysql-server,</i> it will ask you to set a password for the mysql superuser ( <i>root @ localhost</i> ), ask not to be confused with the system superuser, even though they are both <i>root</i> , they are different users.  Although no one forbids to specify the same passwords for them.  So we indicate this password and remember it, we will still need it. <br><br>  After all the packages have been delivered, we will need to configure MySQL a little at once, to do this, open the <i>/etc/mysql/my.cnf</i> file: <br><pre> <code class="bash hljs">mcedit /etc/mysql/my.cnf</code> </pre><br>  We find two lines in the file indicating the maximum size of received packets.  Lines begin with <i>max_allowed_packet</i> .  By default, this item is set to 16 megabytes, change to 20 MB in both lines: <br><pre> <code class="bash hljs">max_allowed_packet = 20M</code> </pre><br>  And you also need to change the size of the log file <i>innodb</i> , as I understand it is an analogue of the transaction log in MS SQL.  To do this, find the following string: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># * InnoDB</span></span></code> </pre><br>  And after it add one more line of the following content: <br><pre> <code class="bash hljs">innodb_log_file_size = 512M</code> </pre><br>  You can do more, but OTRS recommends just such a volume.  Now a little nuance: while the old log files are there, MySQL will not be able to create new files and increase their volume accordingly, so go to the <i>/ var / lib / mysql</i> folder and delete or move wherever you are (better to move, always have time to delete) two files with names like <i>ib_logfile0 and ib_logfile1</i> . <br><br>  Now restart MySQL: <br><pre> <code class="bash hljs">service mysql restart</code> </pre><br>  We check that in place of the old log files, new ones of increased volume have been created, then everything is OK.  After that, open the browser on the next machine and go to the <i><a href="http://helpdesk/">helpdesk</a></i> address, the Apache2 start page should open.  Opened?  So everything is OK ‚Äî Apache is installed. <br><br><h6>  Now Perl. </h6><br> <code>apt-get install perl libapache2-mod-perl2 libdbd-mysql-perl libnet-dns-perl libnet-ldap-perl libio-socket-ssl-perl libpdf-api2-perl libsoap-lite-perl libgd-text-perl libgd-graph-perl libapache-dbi-perl libyaml-libyaml-perl <br></code> <br>  We will explain to Apache what to do with PHP and PERL scripts. To do this, <i>we will</i> uncomment the 220th AddHandler line in the /etc/apache2/mods-enabled/mime.conf file and bring it to the form: <br><pre> <code class="bash hljs">AddHandler cgi-script .cgi .pl</code> </pre><br>  And just add another one of this type: <br><pre> <code class="bash hljs">AddHandler php5-script .php</code> </pre><br>  Now turn on the php5, perl and cgi modules, and then restart Apache: <br><pre> <code class="bash hljs">a2enmod php5 a2enmod perl a2enmod cgi service apache2 restart</code> </pre><br>  Now check if everything works.  To do this, create two directories in <i>/ var / www / html</i> : <br><pre> <code class="bash hljs">mkdir /var/www/html/php mkdir /var/www/html/perl</code> </pre><br>  And create a test file in each: <br><pre> <code class="bash hljs">touch /var/www/html/php/index.php touch /var/www/html/perl/index.cgi</code> </pre><br>  We fill the first file (index.php) as follows: <br><pre> <code class="bash hljs">cat /var/www/html/php/index.php &lt;html&gt; &lt;body&gt; &lt;div style=<span class="hljs-string"><span class="hljs-string">"width: 100%; font-size: 40px; font-weight: bold; text-align:center;"</span></span>&gt; &lt;?php <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> Date(<span class="hljs-string"><span class="hljs-string">"Y/m/d"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;br&gt;Path :"</span></span>.<span class="hljs-variable"><span class="hljs-variable">$_SERVER</span></span>[<span class="hljs-string"><span class="hljs-string">'PHP_SELF'</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;br&gt;Remote User :"</span></span>.<span class="hljs-variable"><span class="hljs-variable">$_SERVER</span></span>[<span class="hljs-string"><span class="hljs-string">'REMOTE_USER'</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;br&gt;Auth type :"</span></span>.<span class="hljs-variable"><span class="hljs-variable">$_SERVER</span></span>[<span class="hljs-string"><span class="hljs-string">'AUTH_TYPE'</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;br&gt;Auth User :"</span></span>.<span class="hljs-variable"><span class="hljs-variable">$_SERVER</span></span>[<span class="hljs-string"><span class="hljs-string">'PHP_AUTH_USER'</span></span>]; ?&gt; &lt;/div&gt; &lt;?php phpinfo(); ?&gt; &lt;/body&gt; &lt;/html&gt;</code> </pre><br>  In the second we write the following: <br><pre> <code class="bash hljs">cat /var/www/html/perl/index.cgi <span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl print "Content-type: text/html\n\n"; print "&lt;html&gt;\n&lt;body&gt;\n"; print "&lt;div style=\"width: 100%; font-size: 40px; font-weight: bold; text-align: center;\"&gt;\n"; print "CGI Test Page"; print "\n&lt;/div&gt;\n"; print "&lt;/body&gt;\n&lt;/html&gt;\n";</span></span></code> </pre><br>  Set rights: <br><pre> <code class="bash hljs">chmod 755 /var/www/html/php/index.php chmod 755 /var/www/html/perl/index.cgi</code> </pre><br>  And another nuance: it is necessary to explain to the Apache that in the <i>/ var / www / html / perl /</i> directory there are scripts and he can execute them.  To do this, add to the <i>/etc/apache2/sites-available/000-default.conf</i> file after the line <i>DocumentRoot,</i> here is the following block: <br> <code>&lt;Directory "/var/www/html/perl"&gt; <br> AllowOverride All <br> Options +ExecCGI <br> Require all granted <br></code> <br><br>  And restart apachephp5: <br><pre> <code class="bash hljs">service apache2 restart</code> </pre><br>  Now we try to open the <i><a href="">helpdesk / perl / index.cg</a></i> i and <i><a href="http://helpdesk/php/index.php">helpdesk / php / index.php</a></i> addresses in the browser.  Should open, pay attention in the php script there is a small block, placed at the very top of the page, the current date, and several environment variables, this block is still useful to us when we debug Kerberos - authentication. <br><br>  Also, by the short name the page may not open and you will have to enter the full computer name, that is, <i><a href="http://helpdesk.domain.ru/php/index.php">helpdesk.domain.ru/php/index.php</a></i> and <i><a href="http://helpdesk.domain.ru/perl/index.cgi">helpdesk.domain.ru/perl/index.cgi</a></i> .  I will not consider how to fix this, especially since this topic is not very relevant, I can only say that you need to dig in the direction of the DNS and Apache settings. <br><br><h4>  5. Configure Kerberos authentication in Apache2.  We check the performance of authentication.  Configure transparent authentication. </h4><br>  With this item, everything should be even easier.  We put the module: <br><pre> <code class="bash hljs">apt-get install libapache2-mod-auth-kerb</code> </pre><br>  Turn it on: <br><pre> <code class="bash hljs">a2enmod auth_kerb</code> </pre><br>  Restart Apache: <br><pre> <code class="bash hljs">service apache2 restart</code> </pre><br>        php- (        ,   php-         ,     ).     <i>/etc/apache2/sites-available/000-default.conf</i>        perl      php: <br> <code>&lt;Directory /var/www/html/php&gt; <br> AuthType Kerberos <br> AuthName "Kerberos Authntication" <br> KrbAuthRealms DOMAIN.RU <br> Krb5Keytab /etc/httpd.keytab <br> KrbMethodNegotiate Off <br> KrbSaveCredentials Off <br> KrbVerifyKDC Off <br> Require valid-user <br></code> <br><br>         Kerberos: <br><pre> <code class="bash hljs">chmod 644 /etc/httpd.keytab</code> </pre><br>  Apache: <br><pre> <code class="bash hljs">service apache2 restart</code> </pre><br>       <i><a href="http://helpdesk/php/index.php">helpdesk/php/index.php</a></i>    ,     .           .        Remote_user, Auth_type  Auth_user,      . Kerberos  . <br><br>   ,    ,           ,         . <br><br>        <i>/etc/apache2/sites-available/000-default.conf</i>  : <br> <code>KrbMethodNegotiate Off <br></code> <br>  on <br> <code>KrbMethodNegotiate On <br></code> <br>    : <br><h6>  IE </h6><br>  IE    <a href="http://helpdesk/">helpdesk</a>  <a href="http://helpdesk.domain.ru/">helpdesk.domain.ru</a>  : <br><br><img src="https://habrastorage.org/files/7f1/d71/efc/7f1d71efc8bb41cb93c9234e91a92692.jpeg" alt="image"><br><br>          Windows. <br><br><img src="https://habrastorage.org/files/d68/e9a/ca7/d68e9aca7667419c9df1664ba17518e3.jpeg" alt="image"><br><br>    IE      :        ,     . <br><br><h6> FireFox </h6><br>    Mozilla Firefox,      .     ¬´about:config¬ª,    ‚Äî ¬´network.neg¬ª.      ,    . <br><br><img src="https://habrastorage.org/files/3da/3cd/1bf/3da3cd1bf02d4fde96c46aad23679db0.png"><br><br>     <i><a href="http://helpdesk/php/index.php">helpdesk/php/index.php</a></i>                  , ,   .          . <br><br>  <b>!</b>  <b>ATTENTION!</b> <b>             !</b> </div><p>Source: <a href="https://habr.com/ru/post/264617/">https://habr.com/ru/post/264617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264601/index.html">Malefactors actively exploit new vulnerability in Windows</a></li>
<li><a href="../264603/index.html">Adobe has added new security restrictions for Flash Player.</a></li>
<li><a href="../264607/index.html">Universal JavaScript</a></li>
<li><a href="../264609/index.html">Immersion into the abyss of the Python interpreter. P1</a></li>
<li><a href="../264611/index.html">Platform for Android on Unity3D</a></li>
<li><a href="../264619/index.html">Mozilla Firefox web browser under fire: the anatomy of a 0day cyber attack</a></li>
<li><a href="../264623/index.html">Plot-oriented games</a></li>
<li><a href="../264631/index.html">The third set in the School of Interface Development Yandex. Analysis of introductory tasks and useful tips</a></li>
<li><a href="../264633/index.html">Channel Status Protocols and Single-Zone OSPF (Part 2)</a></li>
<li><a href="../264635/index.html">MODX Revolution Meets Fenom</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>