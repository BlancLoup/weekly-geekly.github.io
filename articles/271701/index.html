<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Design prototypes of cells in the same XIB with UITableView</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="And at the same time, we solve the problem of automatic cell height calculation once and for all. 

 Disclaimer: 
 Probably, this method does not prov...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Design prototypes of cells in the same XIB with UITableView</h1><div class="post__text post__text-html js-mediator-article">  And at the same time, we solve the problem of automatic cell height calculation once and for all. <br><br>  Disclaimer: <br>  Probably, this method does not provide the best performance, may have a certain amount of pitfalls, cause dizziness, nausea and the devil, please do not read the old and pregnant children. <br><br>  <s>Creating</s> Overcoming difficulties is probably the best motivation for a programmer.  It's not a secret, Xcode contains a lot of flaws, non-transparent solutions and bugs.  Today I will try to find a solution to one of them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/956/d65/a0f/956d65a0fb924a0d8b5829927f8eba96.png"><br><a name="habracut"></a><br>  In iOS5, they introduced a remarkable feature - Storyboard, as well as the ability to create prototypes of cells right inside the created table (which, nevertheless, are compiled into separate NIBs).  However, they decided not to implement the new functionality in the usual XIBs. <br><br>  I was a little puzzled that in a fresh Xcode, you can still create a UITableViewController, which will immediately have a table, and even a cell prototype.  However, when compiling Xcode will give an error that you can not do this way. <br><br>  So we approached the question <i>"why?"</i> <br><br>  Suppose there are two large storyboards.  Why two?  Because if you push a mountain of views, buttons and tablets into one, then even a new and frisky (albeit a year ago) MacBook Pro Retina 13 "turns into a pumpkin. <br><br>  So, there are two storyboards, and, let's say, both of them must open the same controller under different circumstances. <br><br>  An inquisitive reader will notice that iOS9 has entered links to an external storyboard, but what if the project requires iOS8 support, or even 7?  Unfortunately, the guys from Cupertino don't like to add backward compatibility. <br><br>  A possible solution would be to create a ViewController without a View and an external Xib with the same class name so that it is automatically loaded by the loadView method.  Or explicitly set the nibName property: <br><br><img src="https://habrastorage.org/files/178/fa4/c31/178fa4c313ae46809fd32b3e40c47f8d.png"><br>  It seems that earlier there was an explicit field for this, but I did not find it in Xcode 7. <br><br>  And here we are faced with the problem that the prototypes of the cells for the table will have to be put into external Xibs, one at a time per file, and explicitly register them in the code.  After using Storyboard, I don‚Äôt want to do that at all. <br><br>  And here's how to do it (the code will be in Objective-C, since black magic is used further): <br><br>  Create a .h file with the following content: <br><pre><code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableView</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XibCells</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IBOutletCollection</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableViewCell</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSArray</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cellPrototypes</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  This will allow cells to be thrown into the Interface Builder file (but not inside the table, but nearby), and connect them to the IBOutletCollection cellPrototypes <br><br><img src="https://habrastorage.org/files/39a/657/010/39a6570108bc4a4f96481927dd0cc8cf.png"><br><br>  Now you need to somehow slip the loaded cells into the table so that it loads them as needed. <br>  To do this, in the .m file, create a UINib descendant with preloaded data and override the <i>instantiateWithOwner: options</i> method <i>:</i> <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PrepopulatedNib</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UINib</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSData</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nibData</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PrepopulatedNib</span></span></span><span class="hljs-class"> + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nibWithObjects</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSArray</span></span></span><span class="hljs-class">*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">objects</span></span></span><span class="hljs-class"> </span></span>{ PrepopulatedNib* nib = [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> alloc] init]; nib.nibData = [<span class="hljs-built_in"><span class="hljs-built_in">NSKeyedArchiver</span></span> archivedDataWithRootObject:objects]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nib; } - (<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *)instantiateWithOwner:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)ownerOrNil options:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)optionsOrNil { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">NSKeyedUnarchiver</span></span> unarchiveObjectWithData:_nibData]; } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre><br>  When the PrepopulatedNib object is initialized, the transferred array is archived to NSData using NSKeyedArchiver. <br>  Next, UITableView calls the instantiateWithOwner: nil options: nil method, and we unzip the array back, thus creating a copy of the objects.  The cells obtained in this way are 100% identical, since they have just been unarchived from NIB-a and comply with the NSCoding protocol. <br><br>  The final touch: make the table link the transferred cells and PrepopulatedNib: <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableView</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XibCells</span></span></span><span class="hljs-class">) - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setCellPrototypes</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSArray</span></span></span><span class="hljs-class">*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cellPrototypes</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span>* cell <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cellPrototypes) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> registerNib:[PrepopulatedNib nibWithObjects:@[cell]] forCellReuseIdentifier:cell.reuseIdentifier]; } } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre><br>  Now the table can work as if it was loaded from the Storyboard.  Here you can get a little confused and when you first call to return the original objects of the cells transferred in the array, so that the resources are not in vain, but they will come in handy later: <br><br>  <b>So, on the automatic calculation of the height of the cells</b> <br>  In iOS8, we finally introduced an out-of-the-box cell height calculation when using Layout Constraints (although it was very buggy).  In iOS9, this feature was polished and Stack Views was added.  Again, there is no question of any backward compatibility. <br><br>  I propose a convenient solution to this problem using the code for loading cells from one XIB <br><br>  One way to calculate the height is to store one invisible UITableViewCell instance with constraints installed.  For this, in the procedure <i>tableView: heightForRowAtIndexPath:</i> in this instance, the item / text of the future cell is set, and, after calling the <i>[cell layoutIfNeeded]</i> method, the <i>cell.frame.size.height is</i> returned. <br><br>  Let's use our preloaded cells for this method.  To do this, we will store the cells in the NSDictionary associated with the table.  To do this, add the .m file instruction <pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;objc/runtime.h&gt;</span></span></span></span></code> </pre> <br>  In the setCellPrototypes method: create an NSDictionary with cells, where the key is reuseIdentifier: <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableView</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XibCells</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cellPrototypesKey</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setCellPrototypes</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSArray</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableViewCell</span></span></span><span class="hljs-class"> *&gt; *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cellPrototypes</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span>* dict = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span> dictionaryWithCapacity:cellPrototypes.count]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span>* cell <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cellPrototypes) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> registerNib:[PrepopulatedNib nibWithObjects:@[cell]] forCellReuseIdentifier:cell.reuseIdentifier]; dict[cell.reuseIdentifier] = cell; } objc_setAssociatedObject(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, &amp;cellPrototypesKey, cellPrototypes, OBJC_ASSOCIATION_RETAIN_NONATOMIC); } - (<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span>*)cellPrototypes { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//   warning-a - (UITableViewCell *)cellPrototypeWithIdentifier:(NSString *)reuseIdentifier { NSDictionary* dict = (NSDictionary*)objc_getAssociatedObject(self, &amp;cellPrototypesKey); return dict[reuseIdentifier]; } @end</span></span></code> </pre><br>  The declaration of cellPrototypeWithIdentifier: will need to be moved to the .h file so that it can be used in the code. <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableView</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XibCells</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IBOutletCollection</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableViewCell</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSArray</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cellPrototypes</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITableViewCell</span></span></span><span class="hljs-class">*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cellPrototypeWithIdentifier</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class">*)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reuseIdentifier</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Now in the datasource code you can use prototypes to calculate the height: <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span>)tableView:(<span class="hljs-built_in"><span class="hljs-built_in">UITableView</span></span> *)tableView heightForRowAtIndexPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSIndexPath</span></span> *)indexPath { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> cellItem = _items[indexPath.section][indexPath.row]; MyTableViewCell* cell = [tableView cellPrototypeWithIdentifier:<span class="hljs-string"><span class="hljs-string">@"Cell"</span></span>]; cell.item = cellItem; [cell layoutIfNeeded]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell.frame.size.height; }</code> </pre><br><br>  The code on purpose does not constitute an all-in-one solution, since it is a Proof of concept and is provided for informational purposes only. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/271701/">https://habr.com/ru/post/271701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271689/index.html">Developing your own solution: risks and responsibilities</a></li>
<li><a href="../271693/index.html">We write software for generating music card data. Part one: parse the MIDI file</a></li>
<li><a href="../271695/index.html">Developer Economics Tenth Study</a></li>
<li><a href="../271697/index.html">Machine Learning Hackathon: Come. To train a model. To win</a></li>
<li><a href="../271699/index.html">Professional test on the knowledge of the realities of the market for customized development and digital communications</a></li>
<li><a href="../271703/index.html">How sometimes bad code and antipattern solve</a></li>
<li><a href="../271705/index.html">End of an era of dynamic languages</a></li>
<li><a href="../271707/index.html">Mikrotik: small utility. Part 2</a></li>
<li><a href="../271711/index.html">Features (traits) in Perl 6 - metadata along with a symbol</a></li>
<li><a href="../271713/index.html">"Darknet Weekdays" - video materials for training on information security</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>