<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home hosting sites with dynamic IP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I (like many web developers) have about a dozen sites that need to be hosted somewhere. 

 Sites practically do not make a profit, since these are som...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home hosting sites with dynamic IP</h1><div class="post__text post__text-html js-mediator-article">  I (like many web developers) have about a dozen sites that need to be hosted somewhere. <br><br>  Sites practically do not make a profit, since these are some old works (for various reasons that did not go into production), the home page, the site instituted by beautiful mail and the like.  But at the same time, it is a pity to leave these sites, and therefore you have to spend quite real money on them every month to buy hosting.  Money, frankly speaking, is small, but nevertheless it is a pity, since there is no return from the sites. <br><br>  At the same time available: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Ubuntu home server </li><li>  Fast ethernet internet from MTS </li></ul><br>  But there is no key - static IP.  If it were, then everything would be much simpler and I would definitely not have written this article.  And my MTS absolutely does not want to issue a static IP (unless I connect as a business client). <br><br>  Of course, there are well-known Dynamic DNS services like <a href="http://noip.com/">noip.com</a> , but they successfully solve only the task of remote access to our server (via SSH or FTP), but we are completely unsuitable for hosting, because we need to register the domain settings on the DNS server A-record with a real IP address (and not a link to our virtual domain). <br><a name="habracut"></a><br><h2>  What to do? </h2><br>  I will not dwell on how to set up a linux server (and especially how to select it), since I assume that you already have it.  Also, I will not describe in detail the settings of nginx and Apache, since, again, I assume that you will cope with this yourself. <br><br>  The first thing I have a problem with is how to redirect visitors from my domains (I have 2 domains) to my home server.  That is, that the client who dialed domain.com got exactly on my home server, taking into account that the IP address is changing on it every day. <br><br>  To solve, we need to configure the DNS server, namely the following records: SOA, NS, MX, A, CNAME.  It is important that we have the option of setting the TTL (time to live), since the lifetime of our records should be very short, literally 60-120 seconds.  Otherwise, if the server‚Äôs IP address is changed, users will not be able to get to our server for a long time (due to caching). <br><br>  So, we need a DNS server, solutions: <br><br><ol><li>  We use services that provide us with DNS hosting </li><li>  We use our own DNS server in conjunction with the DDNS domain </li></ol><br>  Consider both options. <br><br><h3>  We use services that provide us with DNS hosting </h3><br>  For this there are a number of free services, of which the most popular is <a href="http://freedns.afraid.org/">freedns.afraid.org</a> .  On such services, you can add your domain (s) and be able to update the A-record with them using the API using a small script. <br><br>  It looks quite good, but the catch is that these services reserve the right to add third-level subdomains to your domain.  That is, you registered user.ru with them, and they calmly add their sites of the form hello.user.ru, shop.user.ru and so on.  Of course, this can be waived, but ... for the money.  I don‚Äôt see sense to pay money for such services, because for comparable money you can buy full hosting on any provider without any dancing around the DNS settings. <br><br>  The remaining services will not be considered, and focus on the second option. <br><br><h3>  We use our own DNS server in conjunction with the DDNS domain </h3><br>  For this option, we must, firstly, have a DDNS domain (which is updated when changing IP), for example, domain.ddns.net, and secondly, we will have to install and configure BIND on our server. <br><br>  In total, you need to do exactly 5 steps.  Everywhere under the words "domain" or "domain.ru" means your domain name (short or full). <br><br><h5>  1. Configure 2 or 3 DDNS Subdomains </h5><br>  Why 2 or 3?  Because a number of registrants will not allow you to use a domain with only one NS server.  The most annoying thing is that not everyone will say about it - your domain will simply not work, but you will not understand why. <br><br>  Everything is simple - go to <a href="http://noip.com/">noip.com</a> , register an account there and add 3 free subdomains (more than 3 will not allow). <br><br><h5>  2. Set up your own DNS server </h5><br>  Install BIND: <br><br><pre><code class="hljs swift">$ sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install bind9</code> </pre> <br>  Create zones (one zone for each of our domain): <br><br><pre> <code class="hljs perl">$ sudo nano /etc/<span class="hljs-keyword"><span class="hljs-keyword">bind</span></span>/zones.my</code> </pre> <br>  with content: <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">zone</span></span> "domain.ru" { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> master; file "/etc/bind/db.domain.ru"; };</code> </pre> <br>  and the actual file with zone settings: <br><br><pre> <code class="hljs pgsql">$ nano /etc/bind/db.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.ru</code> </pre> <br>  and write inside: <br><br><pre> <code class="hljs dos">; ; BIND data file <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> local loopback interface ; $TTL <span class="hljs-number"><span class="hljs-number">60</span></span> @ <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> SOA domain.ru. admin.domain.ru. ( <span class="hljs-number"><span class="hljs-number">1477015437</span></span> ; Serial <span class="hljs-number"><span class="hljs-number">10800</span></span> ; Refresh <span class="hljs-number"><span class="hljs-number">3600</span></span> ; Retry <span class="hljs-number"><span class="hljs-number">604800</span></span> ; Expire <span class="hljs-number"><span class="hljs-number">1800</span></span> ) ; Negative Cache TTL @ <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> NS domain.ddns.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>. @ <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> NS domain.ddnsking.com. @ <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> NS domain.myftp.biz. @ <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> MX <span class="hljs-number"><span class="hljs-number">10</span></span> mx.yandex.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>. @ <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> A <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">4</span></span> mail <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> CNAME domain.mail.yandex.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>. * <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> CNAME domain.ru.</code> </pre><br>  Note: I note that the TTL is set to 60 seconds.  In the /etc/bind/named.conf.local file we add the connection of our zone: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "/etc/bind/zones.my";</code> </pre> <br>  All, we restart BIND: <br><br><pre> <code class="hljs pgsql">$ sudo service bind9 <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span></code> </pre> <br>  And look at / var / log / syslog so that there are no error messages <br><br><h5>  3. Set up our domain (s) </h5><br>  We go to the registrar's control panel and there in the settings of our domain we specify the DDNS subdomains created as NS servers: <br><br><pre> <code class="hljs pgsql">nameserver1 = <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.ddns.net nameserver2 = <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.ddnsking.com nameserver3 = <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.myftp.biz</code> </pre> <br>  After that, you may have to wait a few hours (or even a day) until the settings clash between all servers. <br><br><h5>  4. Set up periodic IP address updates </h5><br>  My router supports updating IP-addresses on one domain, but I need to do this immediately for 3 domains.  Plus, we need to update the IP address in the BIND config, so we will write a script that will do: <br><br><ol><li>  Determine our external IP address </li><li>  Check whether the IP address has changed, if not changed, then you do not need to do anything </li><li>  Update the IP address of all DDNS subdomains using the noip.com service API </li><li>  Register new IP address in BIND config </li><li>  Restart BIND </li></ol><br>  Let the script itself be on the shell: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # This script works via noip.com service + local Bind server # Settings ZONES_CONFIG=zones.my IP_FILE=./current_ip.txt DDNS_USER=user DDNS_PASS=password DDNS_HOST=domain.ddns.net DDNS_HOSTS=domain.ddns.net,domain.ddnsking.com,domain.myftp.biz # Start DATE=$(date +"%Y-%m-%d %H:%M:%S") # detect an external IP IP=$(dig +short $DDNS_HOST) if [ $? -ne 0 ] || [ -z $IP ] || [ $IP = "0.0.0.0" ] ; then echo "$DATE Can't detect a remote IP. Aborting." exit 1 fi # verify IP changing PREV_IP="(unknown)" if [ -e $IP_FILE ] ; then PREV_IP=$(cat $IP_FILE) fi if [ $IP = $PREV_IP ] ; then echo "$DATE IP '$IP' has not changed" else echo "$DATE IP has been changed from '$PREV_IP' to '$IP'" echo "$DATE IP will be updated on DDNS server" /usr/bin/curl -u $DDNS_USER:$DDNS_PASS "https://dynupdate.no-ip.com/nic/update?hostname=$DDNS_HOSTS&amp;myip=$IP" fi echo $IP &gt; $IP_FILE # check BIND config cd /etc/bind if [ ! -e $ZONES_CONFIG ] ; then echo "$DATE File $ZONES_CONFIG not found!" exit 1 fi # read the list of active zones ZONE_FILES=$(grep file $ZONES_CONFIG | grep -v ^# | perl -ne '/file "(.+)"/ &amp;&amp; print "$1\n"') for ZONE_FILE in $ZONE_FILES; do echo "$DATE Process the zone config $ZONE_FILE" cat $ZONE_FILE | perl -ne "s/([\t ]+IN[\t ]+A[\t ]+)[\d\.]*/\${1}${IP}/; print \${_}" &gt; $ZONE_FILE.tmp if [ $(diff -w $ZONE_FILE $ZONE_FILE.tmp | wc -l) -ne 0 ] ; then # update serial number STAMP=$(date +%s) cat $ZONE_FILE.tmp | perl -ne "s/\d+(?=.+Serial)/$STAMP/; print \${_}" &gt; $ZONE_FILE # reload BIND service bind9 reload echo "$DATE Config $ZONE_FILE is updated" else # nothing to do rm $ZONE_FILE.tmp echo "$DATE Config $ZONE_FILE is NOT changed" fi done</span></span></code> </pre><br>  The script must be run under the root (so that it has enough rights to update the BIND configs and restart it).  Add to crontab root its launch every minute: <br><br><pre> <code class="hljs markdown"><span class="hljs-bullet"><span class="hljs-bullet">* </span></span><span class="hljs-bullet"><span class="hljs-bullet">* *</span></span> <span class="hljs-bullet"><span class="hljs-bullet">* *</span></span> cd /home/root &amp;&amp; ./update<span class="hljs-emphasis"><span class="hljs-emphasis">_bind_</span></span>config.sh &gt;&gt; /var/log/update<span class="hljs-emphasis"><span class="hljs-emphasis">_bind_</span></span>config.log</code> </pre> <br>  A few words about the definition of the current IP-address.  In the script above, this is done through the rezolving of the domain.ddns.net DDNS subdomain.  That is, first our router prescribes it there, and then we read.  This is not a very good option, since we are tied to a router and can lose a few minutes while the IP address is updated to the current one on the DDNS subdomain.  All this time, our server will be unavailable. <br><br>  Therefore, I have used an improved version of myself, which at the same time does not climb the Internet: <br><br><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">IP</span></span>=$(perl -le 'use <span class="hljs-type"><span class="hljs-type">LWP</span></span>::<span class="hljs-type"><span class="hljs-type">UserAgent</span></span>; my $content=<span class="hljs-type"><span class="hljs-type">LWP</span></span>::<span class="hljs-type"><span class="hljs-type">UserAgent</span></span>-&gt;new-&gt;get(<span class="hljs-string"><span class="hljs-string">"http://router"</span></span>)-&gt;decoded_content(); $content =~ q(&lt;span id=<span class="hljs-string"><span class="hljs-string">"wan_ipaddr"</span></span>&gt;([\d\.]+)&lt;/span&gt;); print $<span class="hljs-number"><span class="hljs-number">1</span></span>')</code> </pre> <br>  In this embodiment, we load the main page of the router (via http), then we regexp it to find the current IP address.  Of course, this option is not for everyone, but it works on DD-WRT firmware. <br><br><h5>  5. Configure the router </h5><br>  I already wrote about the need to configure access to the DDNS service, but do not forget about the need to set up forwarding ports on your router: <br><ul><li>  HTTP - TCP, port 80 </li><li>  DNS - TCP + UDP, port 53 </li></ul><br><br><h1>  Conclusion </h1><br>  So, what I got in the end: <br><br><ul><li>  My sites live on a home server, for which I do not pay anyone; </li><li>  My domains are resolved via my own DNS server, the record lifetime is 1 minute, that is, the update is very fast; </li><li>  The NS records are not real IP addresses (which I often change), but DDNS subdomains; </li><li>  The urgency of the records in the DDNS subdomains and in the config of my DNS server is provided automatically, without any intervention on my part. </li></ul><br>  According to my measurements, when MTS (my provider) updates my IP address, then my sites start to work after about 2 minutes.  This is perfectly acceptable to me. <br><br>  <b>PS</b> If someone liked this note, then I can write the second part, where I will tell you how to set up work using Yandex DNS hosting.  This will allow you to abandon your own DNS server, abandon DDNS subdomains, plus slightly improve the reliability of operation (since the DNS server will never change its IP).  That is the scheme I use at the moment. </div><p>Source: <a href="https://habr.com/ru/post/313426/">https://habr.com/ru/post/313426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313414/index.html">Synergistic organizations. Part 0</a></li>
<li><a href="../313416/index.html">Android In-app Billing: from a mobile application to server validation and testing</a></li>
<li><a href="../313418/index.html">Preparing to migrate vCenter Server to vSphere 6.0 Update 2m. Part 2</a></li>
<li><a href="../313420/index.html">Procedural generation of planetary maps</a></li>
<li><a href="../313422/index.html">42 lines of code to exit the limb</a></li>
<li><a href="../313428/index.html">Donald Knut on the first steps in programming: How I spent the summer with a computer, not with girls (19,20,21,22 / 97)</a></li>
<li><a href="../313430/index.html">Gartner: VMware vs Citrix? Parse</a></li>
<li><a href="../313440/index.html">Mobile solutions for the financial sector</a></li>
<li><a href="../313442/index.html">Caller ID in a virtual PBX: there, here and back</a></li>
<li><a href="../313444/index.html">Mirai botnet was used for powerful DDoS attacks on Dyn</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>