<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>External components in 1C 8.2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 This article gives an idea of ‚Äã‚Äãthe work of external components in the 1C: Enterprise system. 
 The process of developing an external c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>External components in 1C 8.2</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  This article gives an idea of ‚Äã‚Äãthe work of external components in the 1C: Enterprise system. <br>  The process of developing an external component for the ‚Äú1C: Enterprise‚Äù system version 8.2, running under Windows operating systems with a file version of the work, will be shown.  This type of work is used in most solutions designed for small businesses.  VK will be implemented in the programming language C ++. <br><a name="habracut"></a><br><br><h4>  External components "1C: Enterprise" </h4><br>  "1C: Enterprise" is an extensible system.  To extend the functionality of the system uses external components (VK).  From the point of view of a VC developer, it is some external object that has properties and methods, and can also generate events for processing by the ‚Äú1C: Enterprise‚Äù system. <br>  External components can be used to solve a class of problems that are difficult or even impossible to implement in the programming language built into 1C: Enterprise.  In particular, this class can include tasks that require low-level interaction with the operating system, for example, to work with specific equipment. <br>  The 1C: Enterprise system uses two technologies for creating external components: <br><ul><li>  using the native API </li><li>  using COM technology </li></ul><br>  Given the restrictions between the two technologies mentioned above, the difference is insignificant, so we will consider the development of VC using Native API.  If necessary, the implemented developments can be applied for the development of VC using COM technology, as well as, with minor modifications, are applied for use in the 1C: Enterprise system with other work options that are different from the file mode of operation. <br><br><h5>  VK structure </h5><br>  The external component of the 1C: Enterprise system is represented as a DLL library.  The library code describes a descendant class of IComponentBase.  In the created class, the methods responsible for implementing the functions of the external component must be defined.  The redefinable methods will be described in more detail below as the material is presented. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Running a demo VK </h4><br>  <i>Task:</i> <i><br></i> <ol><li>  Assemble the external component supplied with an ITS subscription and intended to demonstrate the basic capabilities of the external component mechanism in 1C </li><li>  Connect the demo component to the 1C configuration </li><li>  Make sure the correct functionality of the claimed functions </li></ol><br><br><h5>  Compilation </h5><br>  The demo VK is located on the ITS subscription disk in the "/ VNCOMP82 / example / NativeAPI" directory. <br>  We will use Microsoft Visual Studio 2008 to build the demo VK. Other versions of this product do not support the used format of the Visual Studio project. <br><img src="https://habrastorage.org/storage2/040/0ed/b81/0400edb81e32695f83721f22e0fab496.jpg"><br>  Open the AddInNative project.  In the project settings, we include the directory with the header files necessary for building the project.  By default, they are located on the ITS disk in the <b>/ VNCOMP82 / include</b> directory. <br>  The result of the build is the file <b>/bind/AddInNative.dll</b> .  This is the compiled library for connecting to the 1C configuration. <br><br><h5>  Connecting VK to 1C configuration </h5><br>  Create an empty 1C configuration. <br>  Below is the code for the managed application module. <br><pre><code class="1c hljs"><span class="hljs-keyword"><span class="hljs-keyword"></span></span> ; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title"></span></span></span><span class="hljs-function">()</span></span> <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-string"><span class="hljs-string">"...\bind\AddInNative.dll"</span></span>, <span class="hljs-string"><span class="hljs-string">"DemoVK"</span></span>, <span class="hljs-class"><span class="hljs-class"></span></span>.Native);  = <span class="hljs-keyword"><span class="hljs-keyword"></span></span>(<span class="hljs-string"><span class="hljs-string">"AddIn.DemoVK.AddInNativeExtension"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span></span></code> </pre> <br>  If no error was reported when starting the 1C configuration, the VC was successfully connected. <br>  As a result of executing the above code, the <b>DemoKomp</b> object appears in the global configuration visibility, having properties and methods that are defined in the code of the external component. <br><br><h5>  Demonstration of the pledged functionality </h5><br>  Check the performance of the demo VK.  To do this, we will try to set and read some properties, call some VK methods, and also receive and process the VK message. <br>  In the documentation supplied on the ITS disk, the following functional of the demonstration VC is declared: <br><ol><li>  Management of the state of the object components <br>  Methods: <b>Enable</b> , <b>Disable</b> <br>  Properties: <b>Enabled</b> </li><li>  Timer control <br>  Every second, the component sends a message to the ‚Äú1C: Enterprise‚Äù system with the <b>Component</b> , <b>Timer</b> parameters and the system clock counter line. <br>  Methods: <b>StartTimer</b> , <b>StopTimer</b> <br>  Properties: <b>YesTimer</b> </li><li>  The <b>ShowVStatStatus</b> method that displays the text passed to the method as parameters in the status bar </li><li>  Method <b>DownloadPicture</b> .  It loads the image from the specified file and transfers it to the ‚Äú1C: Enterprise‚Äù system as binary data. </li></ol><br>  Make sure that these functions work.  To do this, execute the following code: <br><pre> <code class="1c hljs"><span class="hljs-keyword"><span class="hljs-keyword"></span></span> ; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title"></span></span></span><span class="hljs-function">()</span></span> <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(...);  = <span class="hljs-keyword"><span class="hljs-keyword"></span></span>(<span class="hljs-string"><span class="hljs-string">"AddIn.DemoVK.AddInNativeExtension"</span></span>); .(); <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(.); .(); <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(.); .(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title"></span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"></span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"></span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"></span></span></span></span>) <span class="hljs-built_in"><span class="hljs-built_in"></span></span>( + <span class="hljs-string"><span class="hljs-string">" "</span></span> +  + <span class="hljs-string"><span class="hljs-string">" "</span></span> + ); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span></span></code> </pre><br>  The result of running the configuration is shown in the image. <br><img src="https://habrastorage.org/storage2/807/64c/531/80764c5314424392169a5aa643f719bd.png"><br>  The "Messages" panel <b>displays the</b> results of calling the <b>DemoComp. Disable ()</b> and <b>Demo</b> . <b>Comp</b> . <b>Enable ()</b> methods.  Subsequent lines on the same panel contain the results of processing the messages received from the VC - <b>Source</b> , <b>Event</b> and <b>Data,</b> respectively. <br><br><h4>  Arbitrary external component name </h4><br>  <i>Task: Change the name of the external component to arbitrary.</i> <br>  The previous section used the identifier <b>AddInNativeExtension</b> , the meaning of which was not explained.  In this case, <b>AddInNativeExtension</b> is the name of the extension. <br>  In the VK code, the <b>RegisterExtensionAs</b> method is defined, which returns the name ‚Äú1C: Enterprise‚Äù to the system, which is necessary for the subsequent registration of the VK in the system.  It is recommended to specify an identifier that to some extent reveals the essence of the external component. <br>  Here is the full code of the <b>RegisterExtensionAs</b> method with the modified extension name: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CAddInNative::RegisterExtensionAs(WCHAR_T** wsExtensionName) { <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *wsExtension = <span class="hljs-string"><span class="hljs-string">L"SomeName"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iActualSize = ::wcslen(wsExtension) + <span class="hljs-number"><span class="hljs-number">1</span></span>; WCHAR_T* dest = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_iMemory) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(m_iMemory-&gt;AllocMemory((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)wsExtensionName, iActualSize * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR_T))) ::convToShortWchar(wsExtensionName, wsExtension, iActualSize); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br>  In the above example, the name of VK is changed to <b>SomeName</b> .  Then, when connecting VC, you must specify a new name: <br><pre> <code class="1c hljs"> = <span class="hljs-keyword"><span class="hljs-keyword"></span></span>(<span class="hljs-string"><span class="hljs-string">"AddIn.DemoVK.SomeName"</span></span>);</code> </pre><br><br><h4>  Expansion of the list of properties VK </h4><br>  <i>Task:</i> <i><br></i> <ol><li>  <i>To study the implementation of the properties of VK</i> </li><li>  <i>Add a read / write string property</i> </li><li>  <i>Add a read / write string type property that stores the data type of the last property set.</i>  <i>When setting the property value, no action is taken.</i> </li><li>  <i>Verify the performance of the changes</i> </li></ol><br>  To determine the properties of the component being created, the developer must implement the following methods in the code of the AddInNative.cpp library: <br>  <b>Getnprops</b> <br>  Returns the number of properties of this extension, 0 - in the absence of properties <br>  <b>Findprop</b> <br>  Returns the sequence number of the property whose name is passed in the parameters <br>  <b>GetPropName</b> <br>  Returns the property name by its ordinal number and by the passed language identifier. <br>  <b>Getpropval</b> <br>  Returns the value of the property with the specified sequence number. <br>  <b>SetPropVal</b> <br>  Sets the value of the property with the specified sequence number. <br>  <b>IsPropReadable</b> <br>  Returns the flag flag for reading the property with the specified sequence number. <br>  <b>IsPropWritable</b> <br>  Returns the flag flag for writing the property with the specified sequence number. <br><br>  A complete description of the methods, including a list of parameters, is described in detail in the documentation supplied on the ITS disk. <br>  Consider the implementation of the methods <b>CAddInNative</b> class. <br>  In the demo VK, 2 properties are defined: <b>Enabled</b> and <b>IsTimer</b> ( <b>IsEnabled</b> and <b>IsTimerPresent</b> ). <br>  In the global scope of the library code, two arrays are defined: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *g_PropNames[] = {<span class="hljs-string"><span class="hljs-string">L"IsEnabled"</span></span>, <span class="hljs-string"><span class="hljs-string">L"IsTimerPresent"</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *g_PropNamesRu[] = {<span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>};</code> </pre><br>  which store the Russian and English names of properties.  The header file <b>AddInNative.h</b> defines the enumeration: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Props { ePropIsEnabled = <span class="hljs-number"><span class="hljs-number">0</span></span>, ePropIsTimerPresent, ePropLast <span class="hljs-comment"><span class="hljs-comment">// Always last };</span></span></code> </pre><br>  <b>ePropIsEnabled</b> and <b>ePropIsTimerPresent</b> , respectively, with values ‚Äã‚Äãof 0 and 1 are used to replace the sequence numbers of properties with meaningful identifiers.  ePropLast, which has a value of 2, is used to get the number of properties (using the GetNProps method).  These names are used only inside the code components and are not accessible from the outside. <br>  The FindProp and GetPropName methods make it easier to search through the <b>g_PropNames</b> and <b>g_PropNamesRu arrays</b> . <br>  To store the value of fields in the library module, the CAddInNative class defines properties that store the value of the component properties.  The <b>GetPropVal</b> and <b>SetPropVal methods</b> respectively return and set the value of these properties. <br>  The <b>IsPropReadable</b> and <b>IsPropWritable methods</b> both return <b>trure</b> or <b>false</b> , depending on the passed sequence number of the property in accordance with the application logic. <br>  In order to add an arbitrary property it is necessary: <br><ol><li>  Add the name of the property being added to the <b>g_PropNames</b> and <b>g_PropNamesRu arrays</b> ( <b>AddInNative.cpp</b> file) </li><li>  Add a name in the <b>Props</b> enumeration ( <b>AddInNative.h</b> file) before <b>ePropLast</b> that uniquely identifies the property being added. </li><li>  Organize memory for storing property values ‚Äã‚Äã(create component module fields that store the corresponding values) </li><li>  Make changes to the <b>GetPropVal</b> and <b>SetPropVal methods</b> to interact with the memory allocated in the previous step </li><li>  In accordance with the logic of the application, make changes to the <b>IsPropReadable</b> and <b>IsPropWritable methods.</b> </li></ol><br>  Clauses 1, 2, 5 do not need clarification.  The details of the implementation of these steps can be found by studying the annex to the article. <br>  We give the names of the test properties <b>Test</b> and <b>Type Test,</b> respectively.  Then as a result of the implementation of paragraph 1 we have <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *g_PropNames[] = {<span class="hljs-string"><span class="hljs-string">L"IsEnabled"</span></span>, <span class="hljs-string"><span class="hljs-string">L"IsTimerPresent"</span></span>, <span class="hljs-string"><span class="hljs-string">L"Test"</span></span>, <span class="hljs-string"><span class="hljs-string">L"TestType"</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *g_PropNamesRu[] = {<span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>};</code> </pre><br>  The <b>Props</b> enumeration will be: <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Props { ePropIsEnabled = <span class="hljs-number"><span class="hljs-number">0</span></span>, ePropIsTimerPresent, ePropTest1, ePropTest2, ePropLast <span class="hljs-comment"><span class="hljs-comment">// Always last };</span></span></code> </pre><br>  To greatly simplify the code, we will use STL C ++.  In particular, to work with <b>WCHAR</b> strings, we include the <b>wstring</b> library. <br>  To save the value of the <b>Test</b> method, we define the private field in the <b>CAddInNative</b> class in the scope: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">string</span></span> test1;</code> </pre><br>  To transfer string parameters between 1C: Enterprise and external components, the 1C: Enterprise memory manager is used.  Consider his work in more detail.  The functions <b>AllocMemory</b> and <b>FreeMemory</b> , defined in the file <b>ImemoryManager.h,</b> are used to allocate and free memory, respectively.  If it is necessary to transfer a string parameter to the 1C: Enterprise system, the external component must allocate memory for it by calling the <b>AllocMemory</b> function.  Its prototype is as follows: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> ADDIN_API </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AllocMemory</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">** pMemory, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ulCountByte)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br>  where <b>pMemory</b> is the address of the pointer to which the address of the allocated memory will be placed, <br>  <b>ulCountByte</b> - the size of the allocated memory. <br>  An example of memory allocation for a line: <br><pre> <code class="cpp hljs">WCHAR_T *t1 = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, *test = <span class="hljs-string"><span class="hljs-string">L"TEST_STRING"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iActualSize = wcslen(test1)+<span class="hljs-number"><span class="hljs-number">1</span></span>; m_iMemory-&gt;AllocMemory((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)&amp;t1, iActualSize * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR_T)); ::convToShortWchar(&amp;t1, test1, iActualSize);</code> </pre><br>  For the convenience of working with string types, we describe the function <b>wstring_to_p</b> .  It gets a wstring string as a parameter.  The result of the function is the completed <b>tVariant</b> structure.  Function code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CAddInNative::wstring_to_p(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring str, tVariant* val) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* t1; TV_VT(val) = VTYPE_PWSTR; m_iMemory-&gt;AllocMemory((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)&amp;t1, (str.length()+<span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR_T)); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(t1, str.c_str(), (str.length()+<span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(WCHAR_T)); val -&gt; pstrVal = t1; val -&gt; strLen = str.length(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br>  Then the corresponding case section of the switch statement of the <b>GetPropVal</b> method will look like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ePropTest1: wstring_to_p(test1, pvarPropVal); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre><br>  <b>SetPropVal method</b> : <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ePropTest1: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TV_VT(varPropVal) != VTYPE_PWSTR) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; test1 = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring((<span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>*)(varPropVal -&gt; pstrVal)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre><br>  To implement the second property, we define the class field <b>CaddInNative</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> last_type;</code> </pre><br>  in which we will save the type of the last passed value.  To do this, add the following command to the CaddInNative :: SetPropVal method: <br><pre> <code class="cpp hljs">last_type = TV_VT(varPropVal);</code> </pre><br>  Now, when we <b>ask to</b> read the value of the second property, we will return the value of <b>last_type</b> , which is required by the indicated task. <br>  Check the performance of the changes. <br>  To do this, we bring the appearance of the 1C configuration to the form: <br><pre> <code class="1c hljs"><span class="hljs-keyword"><span class="hljs-keyword"></span></span> ; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title"></span></span></span><span class="hljs-function">()</span></span> <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-string"><span class="hljs-string">"DemoVK"</span></span>, <span class="hljs-class"><span class="hljs-class"></span></span>.Native);  = <span class="hljs-keyword"><span class="hljs-keyword"></span></span>(<span class="hljs-string"><span class="hljs-string">"AddIn.DemoVK.SomeName"</span></span>); . = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(.)); . = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(.)); . = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(.)); <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-built_in"><span class="hljs-built_in"></span></span>(.)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span></span></code> </pre><br>  As a result of the launch, we will receive a sequence of messages: <br> <code>3</code> <br> <code></code> <br> <code></code> <br> <code>22</code> <br> <br>  The second and third messages are the result of reading the property set in the previous step.  The first and second messages contain the code of the type of the last property set.  3 corresponds to the integer value, 22 - string.  The correspondence of types and their codes is established in the <b>types.h</b> file, which is located on the ITS disk. <br><br><h4>  Expansion of the list of methods </h4><br>  <i>Task:</i> <i><br></i> <ol><li>  <i>Extend the functionality of the external component with the following functionality:</i> </li><li>  <i>Examine methods for implementing external component methods</i> </li><li>  <i>Add a method-function <b>Funk1</b> , which takes two lines as a parameter (‚ÄúParameter1‚Äù and ‚ÄúParameter2‚Äù).</i>  <i>The result is a string of the form: ‚ÄúCheck.</i>  <i>Parameter1, Parameter2</i> </li><li>  <i>Verify the performance of the changes</i> </li></ol><br>  To define the methods of the component being created, the developer must implement the following methods in the AddInNative library code: <br>  <b>GetNMethods</b> , <b>FindMethod</b> , <b>GetMethodName</b> <br>  Designed to obtain respectively the number of methods, search for the number and name of the method  Similar to the corresponding methods for properties <br>  <b>Getnparams</b> <br>  Returns the number of method parameters with the specified sequence number;  if the method with this number is missing or has no parameters, returns 0 <br>  <b>GetParamDefValue</b> <br>  Returns the default value of the specified parameter of the specified method. <br>  <b>HasRetVal</b> <br>  Returns the flag of the presence of a method with the specified sequence number of the return value: true for methods with a return value and <b>false</b> otherwise <br>  <b>CallAsProc</b> <br>  Executes the method with the specified sequence number.  If the method returns <b>false</b> , a runtime error occurs and the execution of the 1C: Enterprise module is terminated.  Memory for an array of parameters is allocated and released by 1C: Enterprise. <br>  <b>Callasfunc</b> <br>  Executes the method with the specified sequence number.  If the method returns <b>false</b> , a runtime error occurs and the execution of the 1C: Enterprise module is terminated.  Memory for an array of parameters is allocated 1C: Enterprise.  If the return value is of type string or binary data, the component allocates memory with the <b>AllocMemory</b> function of the <b>memory</b> manager, writes the data there, and stores this address in the appropriate structure field.  1C: Enterprise will free this memory by calling <b>FreeMemory</b> . <br>  A complete description of the methods, including a list of parameters, is described in detail in the documentation supplied on the ITS disk. <br>  Consider the implementation of the methods described above. <br>  In the component code, two arrays are defined: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *g_MethodNames[] = {<span class="hljs-string"><span class="hljs-string">L"Enable"</span></span>, <span class="hljs-string"><span class="hljs-string">L"Disable"</span></span>, <span class="hljs-string"><span class="hljs-string">L"ShowInStatusLine"</span></span>, <span class="hljs-string"><span class="hljs-string">L"StartTimer"</span></span>, <span class="hljs-string"><span class="hljs-string">L"StopTimer"</span></span>, <span class="hljs-string"><span class="hljs-string">L"LoadPicture"</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *g_MethodNamesRu[] = {<span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>};</code> </pre><br>  and listing: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Methods { eMethEnable = <span class="hljs-number"><span class="hljs-number">0</span></span>, eMethDisable, eMethShowInStatusLine, eMethStartTimer, eMethStopTimer, eMethLoadPicture, eMethLast <span class="hljs-comment"><span class="hljs-comment">// Always last };</span></span></code> </pre><br>  They are used in the functions <b>GetNMethods</b> , <b>FindMethod</b> and <b>GetMethodName</b> , by analogy with the description of properties. <br>  The methods <b>GetNParams</b> , <b>GetParamDefValue</b> , <b>HasRetVal</b> implement the switch, depending on the passed parameters and application logic return the desired value.  The <b>HasRetVal</b> method in its code has a list of only methods that can return a result.  For them, it returns <b>true</b> .  Returns <b>false</b> for all steel methods. <br>  The <b>CallAsProc</b> and <b>CallAsFunc methods</b> contain the directly executable method code. <br>  To add a method that can only be called as a function, you must make the following changes in the source code of the external component: <br><ol><li>  Add method name to <b>g_MethodNames</b> and <b>g_MethodNamesRu arrays</b> ( <b>AddInNative.cpp</b> file) </li><li>  Add a meaningful method identifier to the Methods enumeration (file <b>AddInNative.h</b> ) </li><li>  Make changes to the code of the <b>GetNParams</b> function in accordance with the program logic </li><li>  If necessary, make changes to the code of the <b>GetParamDefValue</b> method if you want to use the default values ‚Äã‚Äãof the method parameters. </li><li>  Make changes to <b>HasRetVal</b> function </li><li>  Make changes to the logic of the <b>CallAsProc</b> or <b>CallAsFunc</b> functions by placing the directly executed code of the method </li></ol><br>  We <b>present the g_MethodNames</b> and <b>g_MethodNamesRu arrays</b> , as well as the enumeration <b>Methods</b> to the form: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *g_MethodNames[] = {<span class="hljs-string"><span class="hljs-string">L"Enable"</span></span>, <span class="hljs-string"><span class="hljs-string">L"Disable"</span></span>, <span class="hljs-string"><span class="hljs-string">L"ShowInStatusLine"</span></span>, <span class="hljs-string"><span class="hljs-string">L"StartTimer"</span></span>, <span class="hljs-string"><span class="hljs-string">L"StopTimer"</span></span>, <span class="hljs-string"><span class="hljs-string">L"LoadPicture"</span></span>, <span class="hljs-string"><span class="hljs-string">L"Test"</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> *g_MethodNamesRu[] = {<span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>, <span class="hljs-string"><span class="hljs-string">L""</span></span>};</code> </pre><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Methods { eMethEnable = <span class="hljs-number"><span class="hljs-number">0</span></span>, eMethDisable, eMethShowInStatusLine, eMethStartTimer, eMethStopTimer, eMethLoadPicture, eMethTest, eMethLast <span class="hljs-comment"><span class="hljs-comment">// Always last };</span></span></code> </pre><br>  <b>Let's edit the GetNProps</b> function <b>so</b> that it returns the number of parameters of the ‚ÄúTest‚Äù method: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> CAddInNative::GetNParams(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lMethodNum) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(lMethodNum) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethShowInStatusLine: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethLoadPicture: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethTest: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Let's make changes to the <b>CAddInNative :: GetParamDefValue function</b> : <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CAddInNative::GetParamDefValue(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lMethodNum, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lParamNum, tVariant *pvarParamDefValue) { TV_VT(pvarParamDefValue)= VTYPE_EMPTY; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(lMethodNum) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethEnable: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethDisable: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethShowInStatusLine: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethStartTimer: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethStopTimer: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethTest: <span class="hljs-comment"><span class="hljs-comment">// There are no parameter values by default break; default: return false; } return false; }</span></span></code> </pre><br>  Thanks to the added line <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethTest:</code> </pre><br>  in the absence of one or more arguments, the corresponding parameters will be empty ( <b>VTYPE_EMPTY</b> ).  If a default value is required for a parameter, it should be specified in the <b>eMethTest</b> section of the switch statement of the <b>CAddInNative :: GetParamDefValue function</b> . <br>  Since the ‚ÄúTest‚Äù method can return a value, it is necessary to make changes to the code of the <b>HasRetVal</b> function: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CAddInNative::HasRetVal(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lMethodNum) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(lMethodNum) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethLoadPicture: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethTest: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br>  And add the executable code of the method to the <b>CallAsFunc</b> function: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CAddInNative::CallAsFunc(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lMethodNum, tVariant* pvarRetValue, tVariant* paParams, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lSizeArray) { ... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring s1, s2; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(lMethodNum) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethLoadPicture: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethTest: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lSizeArray || !paParams) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; s1 = (paParams) -&gt; pwstrVal; s2 = (paParams+<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; pwstrVal; wstring_to_p(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring(s1+s2), pvarRetValue); ret = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }</code> </pre><br>  Compile the component and bring the configuration code to the form: <br><pre> <code class="1c hljs"><span class="hljs-keyword"><span class="hljs-keyword"></span></span> ; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title"></span></span></span><span class="hljs-function">()</span></span> <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-string"><span class="hljs-string">"DemoVK"</span></span>, <span class="hljs-class"><span class="hljs-class"></span></span>.Native);  = <span class="hljs-keyword"><span class="hljs-keyword"></span></span>(<span class="hljs-string"><span class="hljs-string">"AddIn.DemoVK.SomeName"</span></span>);  = .(<span class="hljs-string"><span class="hljs-string">", "</span></span>, <span class="hljs-string"><span class="hljs-string">"!"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span></span></code> </pre><br>  After launching the configuration, we will receive a message: ‚ÄúHello, World!‚Äù, Which indicates that the method worked successfully. <br><br><h4>  Timer </h4><br>  <i>Task:</i> <i><br></i> <ol><li>  <i>To study the implementation of the timer in the demonstration VC</i> </li><li>  <i>Modify the StartTimer method by adding the ability to transfer the timer interval in parameters (in milliseconds)</i> </li><li>  <i>Verify the performance of the changes</i> </li></ol><br>  In WinAPI, you can use the <b>WM_TIMER</b> message to work with time.  This message will be sent to your program at a time interval that you specify when creating a timer. <br>  To create a timer, use the <b>SetTimer</b> function: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">UINT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetTimer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HWND hWnd, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">//   UINT nIDevent, //  ()  UINT nElapse, //  TIMERPROC lpTimerFunc); //   </span></span></span></span></span></span></code> </pre><br>  The operating system will send a <b>WM_TIMER</b> message to the program at the interval specified in the <b>nElapse</b> argument (in milliseconds).  In the last parameter, you can specify the function that will be executed each time the timer is triggered.  The title of this function should look like this (the name can be any): <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TimerProc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HWND hwnd, UINT uMsg, UINT_PTR idEvent, DWORD dwTime)</span></span></span></span></code> </pre><br>  Consider the implementation of the timer in the demo VK. <br>  Since we are considering the process of developing an external component for the OS of the Windows family, we will not consider the implementation of the timer in other operating systems.  For GNU / Linux OS, in particular, the implementation will differ in the syntax of the <b>SetTimer</b> function and <b>TimerProc</b> . <br>  In executable code, the <b>SetTimer</b> method is <b>called</b> , to which the <b>MyTimerProc</b> function is <b>passed</b> : <br><pre> <code class="cpp hljs">m_uiTimer = ::SetTimer(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,(TIMERPROC)MyTimerProc);</code> </pre><br>  The identifier of the created timer is placed in the <b>m_uiTimer</b> variable <b>so</b> that it can be disabled later. <br>  The <b>MyTimerProc</b> function looks like this: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">VOID CALLBACK </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyTimerProc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( HWND hwnd, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">// handle of window for timer messages UINT uMsg, // WM_TIMER message UINT idEvent, // timer identifier DWORD dwTime // current system time ) { if (!pAsyncEvent) return; wchar_t *who = L"ComponentNative", *what = L"Timer"; wchar_t *wstime = new wchar_t[TIME_LEN]; if (wstime) { wmemset(wstime, 0, TIME_LEN); ::_ultow(dwTime, wstime, 10); pAsyncEvent-&gt;ExternalEvent(who, what, wstime); delete[] wstime; } }</span></span></span></span></span></span></code> </pre><br>  The essence of the function is reduced to the fact that the <b>ExternalEvent</b> method is called, which sends a message to the ‚Äú1C: Enterprise‚Äù system. <br>  To expand the functionality of the <b>StartTimer</b> method, <b>we</b> perform the following actions: <br>  <b>We modify the</b> code of the <b>GetNParams</b> method so that it returns the value 1 for the <b>eMethStartTimer</b> method: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethStartTimer: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  Let us <b>call the</b> code of the <b>CallAsProc</b> method: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> eMethStartTimer: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lSizeArray || TV_VT(paParams) != VTYPE_I4 || TV_I4(paParams) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; pAsyncEvent = m_iConnect; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> __linux__ m_uiTimer = ::SetTimer(NULL,0,TV_I4(paParams),(TIMERPROC)MyTimerProc); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   GNU/Linux #endif break;</span></span></span></span></code> </pre><br>  Now check the performance.  To do this, in the module of the managed configuration application we will write the code: <br><pre> <code class="1c hljs"><span class="hljs-keyword"><span class="hljs-keyword"></span></span> ; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title"></span></span></span><span class="hljs-function">()</span></span> <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-string"><span class="hljs-string">"DemoVK"</span></span>, <span class="hljs-class"><span class="hljs-class"></span></span>.Native);  = <span class="hljs-keyword"><span class="hljs-keyword"></span></span>(<span class="hljs-string"><span class="hljs-string">"AddIn.DemoVK.SomeName"</span></span>); .(<span class="hljs-number"><span class="hljs-number">2000</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword"></span></span></span></span></code> </pre><br>  After starting the configuration, the program will receive messages with an interval of 2 seconds, which indicates the correct operation of the timer. <br><br><h4>  Interaction with the system "1C: Enterprise" </h4><br>  For interaction between the external component and the ‚Äú1C: Enterprise‚Äù system, the methods of the IAddInDefBase class described in the <b>AddInDefBase.h</b> file are <b>used</b> .  We list the most frequently used: <br>  Error message generation <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> ADDIN_API </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wcode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> WCHAR_T* source, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> WCHAR_T* descr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> scode)</span></span></span></span></code> </pre><br>  <b>wcode</b> , <b>scode</b> - error codes (a list of error codes with a description can be found on the ITS disk) <br>  <b>source</b> - the source of the error <br>  <b>descr</b> - error description <br>  Sending a message to the 1C: Enterprise system <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> ADDIN_API </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExternalEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WCHAR_T* wszSource, WCHAR_T* wszMessage, WCHAR_T* wszData)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br>  <b>wszSource</b> - the source of the message <br>  <b>wszMessage</b> - message text <br>  <b>wszData</b> - transmitted data <br>  Interception of the message is carried out by the procedure for processing an external event. <br>  Registration of the external component in the system "1C: Enterprise" <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> ADDIN_API </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterProfileAs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WCHAR_T* wszProfileName)</span></span></span></span></code> </pre><br>  <b>wszProfileName</b> - the name of the component. <br>  These methods are sufficient for the full interaction of VK and 1C.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To receive data from an external component from the 1C: Enterprise system and vice versa, the external component sends a special message, which in turn is intercepted by the 1C system and, if necessary, calls the methods of the external component to transfer data back. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TVariant data type </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When exchanging data between the external component and the ‚Äú1C: Enterprise‚Äù system, the tVariant data type is used. </font><font style="vertical-align: inherit;">It is described in the types.h file, which can be found on the ITS disk:</font></font><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tVariant</span></span></span><span class="hljs-class"> {</span></span> _ANONYMOUS_UNION <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> i8Val; <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> shortVal; <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> lVal; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> intVal; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> uintVal; <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> llVal; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ui8Val; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> ushortVal; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ulVal; <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> ullVal; <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> errCode; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> hRes; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> fltVal; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dblVal; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> bVal; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> chVal; <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> wchVal; DATE date; IID IDVal; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tVariant</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pvarVal</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tm</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tmVal</span></span></span><span class="hljs-class">;</span></span> _ANONYMOUS_STRUCT <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* pInterfaceVal; IID InterfaceID; } __VARIANT_NAME_2<span class="hljs-comment"><span class="hljs-comment">/*iface*/</span></span>; _ANONYMOUS_STRUCT <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* pstrVal; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> strLen; <span class="hljs-comment"><span class="hljs-comment">//count of bytes } __VARIANT_NAME_3/*str*/; _ANONYMOUS_STRUCT struct { WCHAR_T* pwstrVal; uint32_t wstrLen; //count of symbol } __VARIANT_NAME_4/*wstr*/; } __VARIANT_NAME_1; uint32_t cbElements; //Dimension for an one-dimensional array in pvarVal TYPEVAR vt; };</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tVariant</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> type is a </font><b><font style="vertical-align: inherit;">struct</font></b><font style="vertical-align: inherit;"> , which includes itself:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mixture (union) intended for data storage directly </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> data type identifier </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, working with variables of the type </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tVariant</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> occurs according to the following algorithm:</font></font><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Determining the type of data currently stored in a variable </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Refer to the appropriate mix field for direct data access. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tVariant</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> type </font><font style="vertical-align: inherit;">greatly simplifies the interaction of the 1C: Enterprise system and the external component.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> application </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ‚Äúexamples‚Äù directory contains examples for the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">examples / 1 </font><font style="vertical-align: inherit;">article </font><font style="vertical-align: inherit;">‚Äî launching the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">examples / 2 </font><font style="vertical-align: inherit;">demo component </font><font style="vertical-align: inherit;">‚Äî demonstrating the expansion of the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">examples / 3 </font><font style="vertical-align: inherit;">property list </font><font style="vertical-align: inherit;">‚Äî demonstrating expanding the list of methods </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each directory contains a VS 2008 project and a ready configuration 1C.</font></font><br>  <a href="">Download the application</a> </div><p>Source: <a href="https://habr.com/ru/post/191014/">https://habr.com/ru/post/191014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191002/index.html">Cross the grass with the hedgehog. Find all-all 0-day. Capture the Universe! 11</a></li>
<li><a href="../191004/index.html">Highscreen Alpha R review: Full HD, two batteries and other animals</a></li>
<li><a href="../191006/index.html">Chess on pure sed</a></li>
<li><a href="../191008/index.html">Tenders from the inside - customer's view</a></li>
<li><a href="../191010/index.html">Why study TDD is difficult and what to do about it. Part 1</a></li>
<li><a href="../191018/index.html">Five pitfalls when using shared_ptr</a></li>
<li><a href="../191022/index.html">The concept of the Ministry of Communications and Mass Media: I want a substantive conversation</a></li>
<li><a href="../191024/index.html">Inforza - a new channel to attract customers for studios and agencies</a></li>
<li><a href="../191030/index.html">Analysis of all tasks and results of Yandex. Algorithm</a></li>
<li><a href="../191032/index.html">Python inside. Process structures</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>