<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Network on DHCP Option82 - it's just</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will focus on building a network using a user connection technology known as IPoE using dynamic DHCP address allocation using option 82. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Network on DHCP Option82 - it's just</h1><div class="post__text post__text-html js-mediator-article">  This article will focus on building a network using a user connection technology known as IPoE using dynamic DHCP address allocation using option 82. <br><br>  So our task is to build a network in which the user needs a minimum of actions for authorization and networking.  You can even call it like: "plugged the cable into the computer, and it worked." <br><br>  As a billing system, we will use a free (up to 200 subscribers) certified ACP Felix2.  As the DHCP server, we will use the ISC DHCP server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  General scheme of work </h4><br><img src="https://habrastorage.org/storage2/ca0/1d1/6e5/ca01d16e5187c6541b382960e1836366.png"><br><br><a name="habracut"></a><br><br>  When the user turns on the computer, the operating system sends a DHCP request for an IP address to the network.  The switch has DHCP redirection requests (DHCP Relay) enabled and support for option 82 of the DHCP protocol is enabled, so it intercepts the DHCP request from the user, adds Option82 data (Agent Circuit ID and Agent Remote ID) to the DHCP packet and redirects the request to the DHCP server. <br><br>  When a DHCP request arrives at a DHCP server, it issues an IP address based on current configuration data.  The configuration sets the correspondence between the IP address given to the user, the IP address and the port of the switch to which the user is connected.  The DHCP server configuration is configured by ASR Felix2 according to the information in the database. <br><br>  ACP Felix2 periodically collects from the DHCP server data on the MAC addresses of users (who were given IP addresses) on the switch ports.  By the IP address and port number of the switch, the system finds the user in the database and notes that the MAC address belongs to this user. <br><br>  Also, ACP Felix2 periodically retrieves the ARP table from the router (IP-MAC correspondence table) and, if the IP-MAC pair matches the user in the database, this user is considered authorized.  As soon as the IP-MAC pair disappears (the user turns off the computer), the system transfers the user to the list of unauthorized (having performed before this check that the subscriber's equipment is really turned off). <br><br><br><br><br><h4>  Practical implementation </h4><br>  First we need a computer with two network cards and any switch that supports DHCP Relay (option 82).  We will build the first (test) network according to the following scheme: <br><br><img src="https://habrastorage.org/storage2/2df/c70/037/2dfc700379d08a0002555342706a409b.png"><br><br>  In this scheme, the system on the ACP Felix2 will additionally perform the function of a router. <br><br><br><br><br><h4>  Installation </h4><br>  Download ( <a href="http://felix2.ru/download">felix2.ru/download</a> ) and install it using any of the methods described above on the Felix2 ASR server. <br>  In this article we will use the "Installation Disk ACP Felix2".  Detailed instructions for installing ASR Felix2 are here: <a href="http://felix2.ru/documentation">felix2.ru/documentation</a> <br>  After installation, we log in using the root username and password specified during installation. <br>  After installation, the eth0 network interface is configured to work with the internal network: <br><br> <code>IP-: 10.1.1.1 <br>  : 255.255.255.0</code> <br> <br>  The eth1 interface needs to be configured to work with a higher ISP: <br><br><pre> <code class="bash hljs">ifconfig eth1 1.1.1.2 netmask 255.255.255.0 route add default gw 1.1.1.1</code> </pre><br><br>  Here 1.1.1.2 is the IP address given to us by the upstream Internet service provider, 1.1.1.1 is the IP address of the provider's gateway. <br>  To ensure that the network configuration does not reset after a reboot, it must be described in the / etc / network / interfaces file <br><br>  Install the ISC-DHCP server: <br><br><pre> <code class="bash hljs">apt-get update apt-get install isc-dhcp-server</code> </pre><br><br>  Immediately after installing the DHCP server will not start, so it is not yet configured: <br><br><pre> <code class="bash hljs">root@felix2:~<span class="hljs-comment"><span class="hljs-comment"># cat /var/log/syslog | grep dhcp | tail -n 10 May 8 21:48:33 felix2 dhcpd: May 8 21:48:33 felix2 dhcpd: May 8 21:48:33 felix2 dhcpd: No subnet declaration for eth0 (10.1.1.1). May 8 21:48:33 felix2 dhcpd: ** Ignoring requests on eth0. If this is not what May 8 21:48:33 felix2 dhcpd: you want, please write a subnet declaration May 8 21:48:33 felix2 dhcpd: in your dhcpd.conf file for the network segment May 8 21:48:33 felix2 dhcpd: to which interface eth0 is attached. ** May 8 21:48:33 felix2 dhcpd: May 8 21:48:33 felix2 dhcpd: May 8 21:48:33 felix2 dhcpd: Not configured to listen on any interfaces!</span></span></code> </pre><br><br><br><br><br><br><h4>  Configuration </h4><br>  The ISC DHCP server configuration template file (dhcp_opt82_ip-port.conf) and all other necessary configuration files can be downloaded from here: <br>  <a href="">ftp://download.felix2.ru/config.examples/felix2_dhcp_opt82.tar.gz</a> <br><br>  Download, unpack, replace configuration files: <br><br><pre> <code class="bash hljs">wget ftp://download.felix2.ru/config.examples/felix2_dhcp_opt82.tar.gz tar -xf felix2_dhcp_opt82.tar.gz -C /etc/felix2/</code> </pre><br><br>  Restart ASR Felix2: <br><br><pre> <code class="bash hljs">/etc/init.d/felix2 restart</code> </pre><br><br><br><br><br><br><h4>  Creating equipment and test user in ACP Felix2 </h4><br>  Log in to the web admin interface.  You can use a test machine for this by temporarily putting a static IP address on it (for example, 10.1.1.10/24).  The web-based admin interface is available on port 444 over HTTPS.  Default login / password: su / su. <br><br><img src="https://habrastorage.org/storage2/158/a42/9fd/158a429fda17cf210bea15b36f6b1d6a.png"><br><br>  In order for additional fields to appear in the interface, we indicate in the interface settings (Configuration -&gt; Interface settings) that the DHCP-Opt82 address issuance scheme is used: <br><br><img src="https://habrastorage.org/storage2/7c0/fde/09d/7c0fde09d9f7e4bc17546f264af8efdf.png"><br><br>  Now we will add our switch to the equipment base (Equipment -&gt; New equipment): <br>  Status: Established, IP address: 10.1.1.253, Model: DES-3200-28, and click "Add." <br><br><img src="https://habrastorage.org/storage2/44b/b1a/7d6/44bb1a7d6cbd2586fcfdddcf3cd40f7f.png"><br><br>  Create a new user (Users -&gt; New User).  We select the connection address.  The system will automatically suggest the subnet used in this house and select the first free IP address. <br><br>  Select the equipment to which the user will be connected.  The system will offer to choose equipment from the list of equipment installed in this house. <br><br>  Specify that the user will be connected to the first port of the switch.  Mark the flag "Connection completed" and click "Add." <br><br><img src="https://habrastorage.org/storage2/039/c60/b79/039c60b79915ef0c5c2150730dc63606.png"><br><br>  After that, we will replenish the account (Account replenishment -&gt; New replenishment), activate the tariff plan (Payments -&gt; Payment at the rate).  View the current status of the user can be in (Users -&gt; Personal statistics). <br><br>  Check that the server's DHCP configuration file is updated: <br><br><pre> <code class="bash hljs">cat /etc/dhcp/dhcpd.conf</code> </pre><br><br>  Check that the DHCP server works: <br><br><pre> <code class="bash hljs">ps ax | grep dhcpd</code> </pre><br><br><br><br><br><br><h4>  Switch Setup </h4><br>  Now you need to configure the switch.  If the switch is out of the box, the instruction must specify the default IP address.  If the equipment is ‚Äúused‚Äù and you do not know what its IP address / login / password is, you need to reset the configuration via the console connection. <br><br>  In this article we will use the switch out of the box DES-3200-28. <br><br>  Put a static IP address on a test machine (for example, 10.90.90.1/8) Connect to the switch via telnet protocol: <br><br><img src="https://habrastorage.org/storage2/078/b28/f2e/078b28f2e585e786f5e79a7eaea203fa.png"><br><br>  Turn on, configure DHCP Relay: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> dhcp_relay config dhcp_relay hops 16 time 0 config dhcp_relay option_82 state <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> config dhcp_relay option_82 check <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> config dhcp_relay option_82 policy replace config dhcp_relay option_82 remote_id default config dhcp_relay add ipif System 10.1.1.1</code> </pre><br><br>  Now the switch will intercept DHCP requests, add authentication information (option 82) and send to a DHCP server (10.1.1.1) <br>  Set the default route and new switch IP address: <br><br><pre> <code class="bash hljs">create iproute default 10.1.1.1 config ipif System vlan default ipaddress 10.1.1.253/24 state <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span></code> </pre><br><br>  After the last command (change IP-address), the connection will be terminated.  We put a static IP address on the test machine (for example, 10.1.1.10/24). We connect to the switchboard at a new address, save the configuration: <br><br><pre> <code class="bash hljs">save</code> </pre><br><br>  We enable on the test computer receiving network settings via DHCP. <br>  We connect the test computer to the first port of the switch.  We check that DHCP-Relay packets from the switch reach the server and the client receives an IP address: <br><br><pre> <code class="bash hljs">tail ‚Äìn 1000 /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/syslog | grep dhcpd</code> </pre><br><br><img src="https://habrastorage.org/storage2/798/fc7/c4b/798fc7c4b68f7a606a2a04c587908f07.png"><br><br>  We check that user data is displayed correctly in the Felix2 ASR interface. <br><br><img src="https://habrastorage.org/storage2/615/f2a/d93/615f2ad93ecde46159ba6e668e736f1f.png"><br><br><br><br><br><br><h4>  Real network diagram </h4><br>  The network scheme considered above was a test one (you cannot connect many users to one switch).  Below is an example of a real network diagram (no more than ~ 600 subscribers).  Uplink from the trunk provider comes to the optical port of the switch.  This port needs to be combined in a VLAN with the port where the eth1 network interface card is connected from the server with Felix2 ACP. <br><br>  For example, combine 1 and 24 port in 1000y VLAN: <br><br><pre> <code class="bash hljs">create vlan v1000 tag 1000 config vlan v1000 add untagged 1,24</code> </pre><br><br><img src="https://habrastorage.org/storage2/938/b3d/002/938b3d002602362fac182c83f0a23574.png"><br><br>  As the network grows, it is also advisable to spread the houses across separate VLANs. <br><br><br><br><br><br><h4>  Network Map with Dedicated Router </h4><br>  With the growth of intranet (local) traffic, the connection between the switch and the server with the Felix2 ASR, which simultaneously performs the role of a router, will become a bottleneck.  To avoid this, you need to install a dedicated router. <br><br>  You also need to tell ASR Felix2 to get the ARP table from the external router.  Edit the /etc/felix2/felix2.xml file: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arp_fetcher</span></span></span><span class="hljs-tag">&gt;</span></span>    <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connection</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DGS-3627G"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10.1.1.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"22"</span></span></span><span class="hljs-tag">        </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocol</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ssh"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">passwd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"12345"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">interface</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DLINK"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arp_fetcher</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  The arp_fetcher module can receive the ARP address table from CISCO equipment (interface = "CISCO"), D-Link (interface = "DLINK"), or from a Linux-based software router (interface = "Linux"). <br><br><img src="https://habrastorage.org/storage2/194/e7b/448/194e7b448afb5797ec48fa2b6f75e686.png"><br><br><br><br><br><br><br>  At the request of habrazhiteli, an example of a system-generated configuration file for an ISC DHCP server has been added. <br>  In this example, users connected to ports 1-3 of the switch with the address 10.1.1.253 are given addresses 10.1.1.2-10.1.1.4, respectively. <br><br><br><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Automatically generated configuration file # Filename: dhcpd.conf (/etc/dhcp/dhcpd.conf) # Generator: Felix2 # Creation Date: 15.05.2012 11:31:36 # # # option definitions common to all supported networks... # authoritative; default-lease-time 86400; max-lease-time 86400; ddns-update-style none; log-facility local7; if exists agent.remote-id and exists agent.circuit-id { if binary-to-ascii(16, 8, "", substring(option agent.remote-id, 2, 1)) = "0" { set switch-mac = concat("0", binary-to-ascii(16, 8, "", substring(option agent.remote-id, 2, 1)), ":", binary-to-ascii(16, 8, ":", substring(option agent.remote-id, 3, 6))); } else { set switch-mac = binary-to-ascii(16, 8, ":", substring(option agent.remote-id, 2, 6)); } set switch-addr = binary-to-ascii(10, 8, ".", packet(24, 4)); set switch-port = binary-to-ascii(10, 8, "", substring(option agent.circuit-id, 5, 1)); set switch-port-vlan = binary-to-ascii(10, 8, "", substring(option agent.circuit-id, 2, 2)); log(info, concat("- Lease: ", binary-to-ascii(10, 8, ".", leased-address), " via IP: ", switch-addr, " (MAC: ", switch-mac, ") on port: ", switch-port, " in VLAN: ", switch-port-vlan)); } # # subnets # subnet 10.1.1.0 netmask 255.255.255.0 { option routers 10.1.1.1; option domain-name-servers 10.1.1.1; class "1:1" {match if binary-to-ascii(10, 8, ".", packet(24, 4))="10.1.1.253" and binary-to-ascii(10, 8, "", suffix(option agent.circuit-id, 1)) = "1";} pool {range 10.1.1.2; allow members of "1:1";} class "1:2" {match if binary-to-ascii(10, 8, ".", packet(24, 4))="10.1.1.253" and binary-to-ascii(10, 8, "", suffix(option agent.circuit-id, 1)) = "2";} pool {range 10.1.1.3; allow members of "1:2";} class "1:3" {match if binary-to-ascii(10, 8, ".", packet(24, 4))="10.1.1.253" and binary-to-ascii(10, 8, "", suffix(option agent.circuit-id, 1)) = "3";} pool {range 10.1.1.4; allow members of "1:3";} }</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/143846/">https://habr.com/ru/post/143846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143838/index.html">Practical advice on the separation of data into parts. Generate PartitionKey and RowKey for Azure Table Storage</a></li>
<li><a href="../143839/index.html">American dream, or Half a year in the top. In the mind</a></li>
<li><a href="../143840/index.html">About the organization of the desktop, works and documents</a></li>
<li><a href="../143842/index.html">Buy a computer with Windows 7 - get Windows 8 for $ 15</a></li>
<li><a href="../143843/index.html">Ultrabook review Acer Aspire S3</a></li>
<li><a href="../143847/index.html">Once again about the electronic library for PocketBook</a></li>
<li><a href="../143848/index.html">Twitter got to user mail</a></li>
<li><a href="../143849/index.html">Offshore Masters</a></li>
<li><a href="../143850/index.html">Are you ready to temporarily transfer access to your main social network account to a third party for a fee?</a></li>
<li><a href="../143851/index.html">Rate your contribution to Facebook</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>