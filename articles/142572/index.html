<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Persistent segment trees</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Data structures can be divided into two groups: ephemeral and persistent . 

 Data structures that store only their latest version are ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Persistent segment trees</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Data structures can be divided into two groups: <i>ephemeral</i> and <i>persistent</i> . <br><br>  Data structures that store only their latest version are called <i>ephemeral</i> . <br>  <i>Persistent</i> structures, that is, those that retain all their previous versions, can in turn be further divided into two subgroups: if the data structure allows only the latest version to be changed, it is called <i>partially persistent</i> , if it is allowed to change any version, such a structure is considered <i>fully persistent</i> . <br><br>  Further, the segment tree and its fully persistent version will be considered. <br>  All code is available on <a href="https://github.com/aidarbiktimirov/data-structures">GitHub</a> . <br><a name="habracut"></a><br><h4>  Segment tree </h4><br>  Those who are already familiar with segment trees can go directly to the section on the <a href="https://habr.com/ru/post/142572/">persistent version</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The segment tree is a data structure that allows for the given array <code>A</code> quickly perform the following operations: <br><br><ul><li>  <code>Change(i, x)</code> - change the value of <code>A[i]</code> to x </li><li>  <code>F(i, j)</code> - calculate <code>f(A[i], A[i + 1], ..., A[j])</code> </li></ul><br>  Both operations are performed in O (log n).  The function <code>f</code> often taken as the sum, minimum or maximum. <br><br><h5>  Description </h5><br>  Let <code>n</code> be the length of array <code>A</code> , we will fill it with neutral elements until its length equals to a power of two (for example, if <code>f</code> is a sum, the array will be complemented with zeros). <br><br>  Now we will build such a binary tree that its leaves will be all elements of <code>A</code> and the depth of all leaves is the same, and in all other vertices the values ‚Äã‚Äãof <code>f</code> will be stored from the values ‚Äã‚Äãof the child vertices. <br><br>  Consider as an example a tree of segments for the array <code>A = [4, 1, 4, 2, 5, 3]</code> : <br><img src="https://habrastorage.org/storage2/549/053/b2f/549053b2f992ca7dae0fd0f6013b51ed.png" alt="    [4, 1, 4, 2, 5, 3]" title="Tree segments for the array [4, 1, 4, 2, 5, 3]"><br><br>  It is convenient to keep such a tree as a binary heap: in the form of an array of vertices recorded in a row from top to bottom from left to right: <br><br><blockquote><pre>  19 11 8 5 6 8 0 4 1 4 2 5 3 0 0 </pre></blockquote><br>  In this case, for a vertex with index <code>i</code> its ancestor will be a vertex <code>((i - 1) / 2)</code> , and the left and right child vertices will have indices <code>(2 * i + 1)</code> and <code>(2 * i + 2)</code> respectively (assuming that the elements in the array are numbered from zero). <br><br><h5>  Building </h5><br>  It is convenient to build a segment tree recursively from top to bottom: for each vertex, construct the left and right child vertices, then calculate the value of <code>f</code> from their values, and for sheets, simply write the corresponding value of the array into the tree. <br><img src="https://habrastorage.org/storage2/2d5/09a/36b/2d509a36b9046633f03cac5eef43e111.gif" alt="   " title="Animated construction of the segment tree"><br>  By building a tree in this way, each vertex will be visited once, and since the number of vertices in the tree is Œò (n), the complexity of the construction is also Œò (n). <br><br><h5>  Change </h5><br>  After the value of any element was changed, some of the values ‚Äã‚Äãof the ancestors of this element could deteriorate in the tree.  This can be corrected by recalculating the values ‚Äã‚Äãof the ancestors of this element, climbing up the tree. <br><br>  For example, if in the array <code>A</code> to replace <code>A[3]</code> by <code>10</code> , then the vertices with values <code>6</code> , <code>11</code> and <code>19</code> will be recalculated. <br><br>  Since the height of the tree is log n, the change operation will affect exactly log n vertices, which means that the asymptotic behavior of the operation O (log n). <br><br><h5>  Calculate F </h5><br>  This operation will be performed recursively from top to bottom. <br><br>  Suppose that at an arbitrary vertex <code>v</code> calculated <code>F</code> for the range <code>l..r</code> , then it is easy to check that the value of <code>F</code> for <code>l..((l + r) / 2)</code> counted in the left child vertex and for <code>((l + r) / 2 + 1)..r</code> . <br><br>  Suppose that the query <code>F(i, j)</code> received, and the current vertex is <code>v</code> .  Two cases are possible: <br><br><ul><li>  Node <code>v</code> has already calculated the value of <code>F(i, j)</code> .  Then the answer to the received request will be the value of the vertex <code>v</code> . </li><li>  Node <code>v</code> written <code>F</code> for a larger range.  In this case, we recursively call the calculation <code>F(i, (l + r) / 2)</code> for the left child vertex and <code>F((l + r) / 2 + 1, j)</code> for the right, and the answer is f from these two values. </li></ul><br><br><h5>  Example </h5><br>  <a href="">Implementing a segment tree in C ++</a> . <br><br><h4><a name="persistent-segment-tree"></a>  Persistent Segment Tree </h4><br>  The persistence can be achieved in different ways, the easiest of them is to make a complete copy of the old version with each change and change it like a regular segment tree, but this method is too memory intensive and worsens the asymptotic behavior of the <code>Change</code> operation to O (n). <br><br><h5>  Building </h5><br>  Building a persistent tree of segments will be similar to building a regular tree of segments, except that now for each vertex you also have to explicitly store references to child vertices. <br>  You will also need to store an array of vertices that are rooted in the corresponding versions of the tree.  When constructing, a single vertex is added to it, which is the root of the resulting tree. <br><br><img src="https://habrastorage.org/storage2/724/28f/0bb/72428f0bb524fe7edf8e172f7bcee4a7.png" alt="  ,  0" title="Persistent Segment Tree, Version 0"><br><br>  Since the only change compared to the ephemeral tree of segments is the addition of information about the left and right daughter vertices, the construction complexity remains the same, that is, Œò (n). <br><br><h5>  Change </h5><br>  Instead of completely copying the tree, if you change the vertices, only those vertices that should have been changed will be added to it, and instead of changing the values ‚Äã‚Äãof the old vertices, the recalculated values ‚Äã‚Äãwill be saved to the new ones.  All new vertices will refer to one vertex from the tree of the old version and one of the newly added ones. <br><br>  Adding a new branch is done in the same way as building an entire tree, except that instead of building two child vertices, a new vertex is built only in the direction in which the modified vertex lies. <br>  After that, the array of root vertices is updated. <br><br><img src="https://habrastorage.org/storage2/0c8/68b/0aa/0c868b0aa3d58afe2ef715d1b0f6c18e.png" alt="  ,  1 (A[3] = 10)" title="Persistent segment tree, version 1 (A [3] = 10)"><br><br>  Since the change only adds log n vertices, the asymptotics of the operation is O (log n). <br><br><h5>  Calculate F </h5><br>  The calculation of F is done in the same way as an ephemeral tree.  The only differences are: transitions to child nodes and starting from different root nodes. <br>  Hence the complexity of O (log n). <br><br><h5>  Example </h5><br>  <a href="">Implementing a persistent segment tree in C ++</a> . <br><br><h4>  Tasks </h4><br>  With the help of a persistent segment tree, you can solve the " <a href="http://neerc.ifmo.ru/school/archive/2010-2011/ru-olymp-team-russia-2010-statements.pdf">Rollback</a> " <a href="http://neerc.ifmo.ru/school/archive/2010-2011/ru-olymp-team-russia-2010-analysis.pdf">task</a> ( <a href="http://neerc.ifmo.ru/school/archive/2010-2011/ru-olymp-team-russia-2010-analysis.pdf">parse the problem</a> ).  Solving the problem using the above implementation of the persistent segment tree is available on <a href="https://github.com/aidarbiktimirov/data-structures">GitHub</a> . <br>  Also <a href="http://codeforces.ru/blog/entry/2954">here</a> you can read a discussion of the problem of the k-th order statistics on a range. </div><p>Source: <a href="https://habr.com/ru/post/142572/">https://habr.com/ru/post/142572/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142566/index.html">Fake S3 for offline development and money saving</a></li>
<li><a href="../142567/index.html">Google conducts "spring cleaning"</a></li>
<li><a href="../142568/index.html">The program from Navizon allows you to search for nearby smartphones with Wi-Fi</a></li>
<li><a href="../142569/index.html">How do you write terms in SI-like languages? With brackets in terms of or without?</a></li>
<li><a href="../142570/index.html"># BADA55-colors for web design</a></li>
<li><a href="../142573/index.html">Skype for Windows Phone out of beta</a></li>
<li><a href="../142574/index.html">Save gmail</a></li>
<li><a href="../142575/index.html">Dynamic Binary Instrumentation in Information Security</a></li>
<li><a href="../142577/index.html">node-get</a></li>
<li><a href="../142579/index.html">Subjective opinion about Mac OS in comparison</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>