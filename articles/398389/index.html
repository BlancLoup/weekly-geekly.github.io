<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>KiQ anecdote or as a talking toy for adults did</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the world there are an incredible number of talking toys for children and this only exacerbates the impression that adults are bored. Our team deci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>KiQ anecdote or as a talking toy for adults did</h1><div class="post__text post__text-html js-mediator-article"><img src="https://ksr-ugc.imgix.net/assets/013/958/564/d6c061618e04b2f7d81d1d88c07c543d_original.jpg?w=680&amp;fit=max&amp;v=1475469443&amp;auto=format&amp;q=92&amp;s=94a8eb1e4d730d541ec407637a1490ee" alt="Kiq toy"><br><br>  In the world there are an incredible number of talking toys for children and this only exacerbates the impression that adults are bored.  Our team decided to correct this situation. <br><a name="habracut"></a><br><h3>  Beginning of the story </h3><br>  It all started with the fact that a bright thought came to the inquisitive mind of one of my friends and colleagues: why not just make fun of thematic jokes not only children, but also adults?  The benefit of affordable and well-proven iron is now never uncommon, and it can not only flash lights, but also <a href="http://hackaday.com/2015/06/06/esp8266-as-a-networked-mp3-decoder/">sing songs</a> . <br><br>  In this regard, he called me and offered to <s>repeat the epic feat to</s> make sure whether the ESP8266 plays well in MP3 format over the network and <s>if the hamster is tearing to pieces</s> does it really have enough performance, which I did quickly in the New Year holidays of 2016: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/pW-BoVe46O8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i>On the video, the ESP8266 plays Internet radio, outputting sound using the 5-bit PWM over I2S hack.</i> <br><br>  However, playing MP3 radio from the Internet was eating almost the entire ESP8266 resource and sounded ‚Äúso-so‚Äù, while imagination was already drawing us <a href="http://www.hasbro.com/en-us/brands/furby">more</a> than just an MP3 radio column.  With these creative impulses, we went to our team and beloved chef <a href="https://www.linkedin.com/in/vladponomarev/en">Vladimir</a> . <br><br>  After a small brainstorming session, a more detailed picture began to emerge, and even a <i>logical chain</i> of what we not only want, but also can do: <br><br><ul><li>  MP3 replaced with something less demanding of resources and more free, stopped at <a href="http://www.speex.org/">Speex</a> , which <a href="https://geektimes.ru/users/flexxnn/" class="user_link">flexxnn</a> rather successfully and quickly ported to ESP8266. <br><br></li><li>  Records jokes taken from the server in the cloud and stored locally on the SD card, because  The Internet is not everywhere there, and even if you keep it on ESP8266 permanently, you can‚Äôt get enough of any battery. <br><br></li><li>  To tie the "jokes of humor" to some events, and not just to speak randomly.  The smartphone was chosen as an event generator, as almost everyone already has it.  Well, the actual events can be easily received from the Apple Notification Center Service (ANCS), which is already on the iPod, iPhone and iPad. <br><br></li><li>  Use Bluetooth Low Energy (BLE) to communicate with your smartphone, because charging a toy more than once a week will not seem funny to anyone. <br><br></li><li>  So that the toy does not infuriate the user with frequent jokes to all the coming events, they decided to use logic in the script language.  We stopped at <a href="http://www.compuphase.com/pawn/pawn.htm">Pawn language</a> . <br><br></li><li>  Since everyone has different tastes for jokes, and it‚Äôs already sad to listen to the same joke - it was decided to give the user the opportunity to vote for the jokes by ‚Äúpat‚Äù and ‚Äúbeat‚Äù (accelerometer) to form on the content server the next time more relevant playlist. </li></ul><br><h3>  Iron selection </h3><br>  Initially, I wanted to make a very simple, but fully working prototype on the all-in-one board, so we decided to try MediaTek on <a href="">LinkIt ONE</a> .  And <a href="https://geektimes.ru/users/netsnail/" class="user_link">netsnail</a> is almost immediately succeeded.  There was a connection with the phone and with the SD card MP3 perfectly played. <br>  It would seem - here it is happiness and the platform is ready!  But then we faced the <s>harsh reality of the</s> limitations of their closed SDK and the euphoria passed. <br><br>  <i>We realized that there was no ready-made platform on one board satisfying all our wishes in nature, which means we had to create it from scratch.</i> <br><br>  So, we had to choose (February 2016) the most suitable BLE chip, which had to be connected with ESP8266.  As a connection between the ESP8266 and the BLE chip (we didn‚Äôt even know what kind of chip it would be) they decided to use a standard TWI (I2C). <br><br>  But with BLE, the choice was not very big then: <br><br><ul><li>  <a href="http://www.ti.com/product/CC2541">TI CC2541</a> - somehow didn‚Äôt immediately attract due to the architecture of <a href="https://en.wikipedia.org/wiki/Intel_MCS-51">8051</a> , and even 8 KB of RAM didn‚Äôt look promising easy life, considering the number of BLE services and features that we needed in the toy. <br><br></li><li>  <a href="http://ru.mouser.com/new/broadcom/broadcom-bcm20732-soc/">BCM20732</a> - looked very promising, but in reality the SDK turned out to be very raw, and the BLE ‚Äúkeychain‚Äù of the Broadcom WICED Smart was so buggy that I wouldn't write anything special here, so as not to swear.  Let me know if the situation has improved now. <br><br></li><li>  <a href="https://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF52832">nRF52832</a> - the first chip, which immediately pleased.  But then there was no compact BLE module - <a href="https://geektimes.ru/users/rekod/" class="user_link">rekod</a> began to prototype on the <a href="http://www.digikey.com/catalog/en/partgroup/nrf52-development-kits/54030">debug board</a> , the SDK really liked, contained many different <i>working</i> examples.  An example of BLE ANCS started immediately and we immediately saw notifications from the iPhone in the logs with UART.  By the way, on this debug board there is a real programmer and debugger SEGGER J-Link, which greatly facilitated our life in the future. <br><br></li><li>  <a href="https://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF51822">nRF51822</a> - at that time there were ready-made <a href="https://ru.aliexpress.com/item/Low-Power-NRF51822-Wireless-Module-2-4G-Wireless-SOC-Single-Chip-BLE4-0-Bluetooth-Module/32334236969.html">modules</a> , and programmed them through SEGGER from nRF52832.  What surprised me the most was that the code from the older model nRF52832 is perfectly transferred to the younger nRF51822 and back! </li></ul><br>  As a result, the first iron looked <s>like a tarantula spider like</s> this: <br><br><img src="https://kiqup.com/sites/default/files/images/pic1.jpg" alt="iron spider"><br><br>  Catching glitches due to falling off dupont cables, especially on the nRF51822 module, where the pin's are a bit smaller, was very sad. <br><br><h3>  BLE services on nRF51822 and iOS application </h3><br>  Nevertheless, I and the <a href="https://geektimes.ru/users/affair/" class="user_link">affair</a> started implementing BLE services and features on nRF51822 already on this spider-iron, divided everything roughly in half: <br><br><ul><li>  Apple Notification Center Service ( <a href="https://developer.apple.com/library/content/documentation/CoreBluetooth/Reference/AppleNotificationCenterServiceSpecification/Introduction/Introduction.html">ANCS</a> ) - to receive notification of events from a smartphone. </li><li>  Apple Current Time Service (CTS) - when connected, the toy takes time from the phone. </li><li>  HandShake Service (HSS) - this service, by the way, makes the toy ‚Äúunwilling‚Äù, unlike ordinary headsets and similar gadgets.  The fact is that in the cloud there is a ClientID and the user does not just make a pair of phone and toys via Bluetooth, but also an additional binding, which is not so easy to reset.  The description of this process requires a separate article, so I will limit myself to a brief mention. </li><li>  Battery As Service (BAS) - transfer the battery status to the application on the smartphone. </li><li>  Content Service (CONTS) - with this you can see a list of previously played jokes with text (text is taken from a server in the cloud). </li><li>  Settings Service (SETTS) - these can be used to configure inappropriate content of jokes, the time when the toy should be silent (at night, for example), etc. </li></ul><br>  <a href="https://geektimes.ru/users/maximkit/" class="user_link">MaximKit</a> at the same time did an <b>application for iOS</b> . <br><br><img src="https://ksr-ugc.imgix.net/assets/013/983/125/8dfbfd651b320b4818fa9ed65ebf67fc_original.jpg?w=680&amp;fit=max&amp;v=1475618060&amp;auto=format&amp;q=92&amp;s=952c7ac032d25e8b72ec4425cad5891d" alt="image"><br>  <i>The picture on the right shows the main application screen.</i> <br><br>  Here <a href="https://geektimes.ru/users/flexxnn/" class="user_link">flexxnn</a> could not bear our suffering because of falling off the wiring and made the first normal prototype at home using the <a href="http://easyelectronics.ru/sozdanie-pechatnoj-platy-metodom-lazernogo-utyuga.html">laser iron</a> method: <br><br><img src="https://kiqup.com/sites/default/files/images/pic2.jpg" alt="the first more or less prototype"><br><br>  The photo is not visible, but there is already a slot for microSD cards.  On the small square shawl below - <a href="http://opendevices.ru/wp-content/uploads/2011/11/alc5627_datasheet_1.2.pdf">ALC5627</a> , the sound was already much better than the 5-bit PWM via I2S. <br><br>  For power management chose <a href="http://dl.linux-sunxi.org/AXP/AXP209_Datasheet_v1.0en.pdf">AXP209</a> .  Allows you to charge and use the battery at the same time, as well as monitor its condition.  The chip is very common, but it has a lot of specifics both in programming and in the required external components, the so-called.  "Harness". <br><br><h3>  Magic on ESP8266 </h3><br>  In parallel with this, <a href="https://geektimes.ru/users/flexxnn/" class="user_link">flexxnn</a> ported to ESP8266 <a href="http://www.speex.org/">Speex</a> , <a href="http://elm-chan.org/fsw/ff/00index_e.html">FatFs</a> , made a bootloader for ESP8266 and nRF51822, so that you could not sew the updated firmware over the wires, but put it on the microSD firmware files. <br><br>  Personally, I think he was helped by aliens, since he did it all in about a month.  But he does not confess contact with the alien mind. <br><br>  And then the second more normal prototype: <br><br><img src="https://kiqup.com/sites/default/files/images/pic3.jpg" alt="the first more or less prototype"><br><br>  But a more normal prototype is no longer crawling into a soft toy.  And if he did, then with a sudden move on a potential user from the toy, an ‚Äúalien‚Äù would be useful, which of course was unacceptable for MVP. <br><br>  Therefore, it was decided to order a fee to professionals and this is what happened in the end: <br><br><img src="https://kiqup.com/sites/default/files/images/pic4.jpg" alt="image"><br><br>  In a cat, such a design already fits perfectly, although it looks like something inhumane: <br><br><img src="https://kiqup.com/sites/default/files/images/pic5.jpg" alt="image"><br><br>  At the same time, fears were confirmed that events from the phone could come quite often and eventually the user would get annoyed instead of fun.  It required flexible logic for filtering, which can be easily changed at any time without flashing.  In this regard, I, having studied the materiel and realizing that for ESP8266 there are no fast and compact scripts (Lua and microPython interpreters), I decided to port the <a href="http://www.compuphase.com/pawn/pawn.htm">Pawn language</a> , which quickly (only 18 times slower than the native one) executes a compact bytecode. <br><br>  By the way, the source for Pawn is very similar to C, so modifying scripts is a pleasure - they just need to be compiled into AMX bytecode and copied to the SD card. <br><br><h3>  Cheating gadgets.  Pretending iOS on Android </h3><br>  And then "suddenly" we all remembered that Android phones in the world are not so few, and even more than phones with iOS. <br><br>  As a result, I had to check in tempo if we could <b>fool gadgets and pretend to be iOS on Android</b> , so that they could see the ANCS service, indistinguishable from Apple. <br><br>  In the end, everything worked out and after a week the gadgets (and our cat is no exception) sincerely believed that I had an iPhone with ANCS service, connecting to my Nexus 5 and even to the old Samsung Galaxy with Android 4.4. <br><br><h3>  Go cloud </h3><br>  Since no one likes to listen to the joke several times (fact), and there are preferences and cultural restrictions, it was decided to create a unique playlist for each user.  For this <a href="https://geektimes.ru/users/affair/" class="user_link">affair</a> closely engaged in the server in the cloud. <br><br>  But how to decide who will like it?  That's right - let the user decide!  For this, I made a basic gesture detection on the <a href="http://www.st.com/content/ccc/resource/technical/document/datasheet/3c/ae/50/85/d6/b1/46/fe/CD00274221.pdf/files/CD00274221.pdf/jcr:content/translations/en.CD00274221.pdf">LIS3DH</a> accelerometer from STMicroelectronics.  I liked the joke - I tilted the cat, as if ‚Äúyes‚Äù, I didn‚Äôt like the joke - I tilted it sideways, as if ‚Äúno‚Äù.  <i>He also added ‚Äúforget-me-not‚Äù for the phone - if the connection via BLE disappears and the accelerometer detects movement, then the cat is carried somewhere, and the phone is forgotten.</i> <br><br>  After the user is ‚Äúpolaykal‚Äù and thus outlines his preferences, the information goes to the server, where the ‚Äúgenomes‚Äù of the playlists are compared and new sets of jokes are formed to the user.  But this is a topic for a separate article. <br><br><h3>  Results </h3><br>  As a result, the entertainment turned out to be a great platform that can: <br><br><ul><li>  contact the phone via BLE and receive notification of events; </li><li>  communicate via WiFi and download content and firmware updates; </li><li>  save and read files in FAT32 on microSD; </li><li>  play jokes packed by speex codec; </li><li>  define user preferences using an accelerometer (gesture detection); </li><li>  to form playlists for each user based on his preferences in humor; </li></ul><br>  Remarkably, ‚Äúvery good hands‚Äù can easily connect to the appropriate pins (even the holes for the connectors on the board are left) and ‚Äúwise up the cat‚Äù as they please.  This makes the all-in-one platform attractive to geeks. <br><br>  With this platform we went to kickstarter, calling the finished toy KiQ.  On the first day, 40% was collected, and now it is already 57%.  But that's another story. <br><br>  Thanks to all those who read to this line.  I am waiting for interesting questions from you. </div><p>Source: <a href="https://habr.com/ru/post/398389/">https://habr.com/ru/post/398389/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../398377/index.html">What is information in terms of physics?</a></li>
<li><a href="../398379/index.html">Your unmanned taxi arrives</a></li>
<li><a href="../398381/index.html">Prototype robot for timelapse shooting running Arduino</a></li>
<li><a href="../398385/index.html">The illusions of the brain. The world's first universal hallucination</a></li>
<li><a href="../398387/index.html">Attack of the machines: a brutal fight</a></li>
<li><a href="../398391/index.html">"Gray, blow, cool ...", or the logic of climate control in a smart home</a></li>
<li><a href="../398393/index.html">Cool Nikon D5500a takes stunning photos of the cosmos</a></li>
<li><a href="../398395/index.html">Wow: Nobel Prize instead of gravitational waves was given for topology</a></li>
<li><a href="../398397/index.html">Ultra-bright X-ray sources found in two old galaxies. New natural phenomenon?</a></li>
<li><a href="../398399/index.html">Auto Digest: Present and Future Technologies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>