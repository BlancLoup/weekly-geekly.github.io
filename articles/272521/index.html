<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Detailing, reflections and post effects in GTA V</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: 

 This publication is a continuation of the material ‚ÄúHow the frame is rendered in GTA V‚Äù . Now the author considers the issues ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Detailing, reflections and post effects in GTA V</h1><div class="post__text post__text-html js-mediator-article"><h6>  <i>From the translator:</i> <i><br><br></i>  <i>This publication is a continuation of the material</i> <b><a href="http://habrahabr.ru/company/ua-hosting/blog/271931/">‚ÄúHow the frame is rendered in GTA V‚Äù</a></b> .  <i>Now the author considers the issues of detailing, lighting and post-processing a frame.</i>  <i>Enjoy reading.</i> </h6><br><h3>  Level of detail </h3><br>  If we are talking about the absolute advantages of Rockstar over its competitors, then the indicators of the level of detail of the company's products are definitely beyond praise.  Los Santos is a whole pleiad of various scenes of different levels of detail / polygonality, all data being broadcast in real time and this does not block the loading screen for a minute.  Just breathtaking! <br><br><h4>  Lights of the night city </h4><br><blockquote>  All the lights that are visible in the distance are real.  You can drive closer and see lights that radiate light in the distance. </blockquote><br>  It was with such a statement that Aaron Garbut, one of the founders and art directors of Rockstar North, made a speech shortly before the release of the game on PS3. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Is it so?  Let's take a look at this nightly scene: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/206/45c/490/20645c49013e4a97efb1d13b3634dccc.jpg" alt="image"><br>  <i>Till lights</i> <br>  <b>Caution!</b>  <b>Traffic!</b> <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/82f/7cd/fa0/82f7cdfa0a8d0cb45973ec5447deb7dc.jpg" alt="image"><br>  <i>Lights "After"</i> <br><br>  It turns out that it is: every small spot of light is a quad, visualized in the form of a tiny 32x32 texture, like the one you can see below. <br><img src="https://habrastorage.org/getpro/habr/post_images/6d3/642/7a5/6d36427a5518d5a6fa1ea30d777d7fa9.png" alt="image"><br><br>  All of them are tightly grouped within the framework of the scene geometry, but these are still tens of thousands of polygons with which the graphics processor has to work. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/82f/7cd/fa0/82f7cdfa0a8d0cb45973ec5447deb7dc.jpg" alt="image"><br>  <i>Lights</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/888/be1/77c/888be177c28003bf309f59ac33a28ac2.jpg" alt="image"><br>  <i>Blueprint lights</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0f8/ff0/565/0f8ff05652a39402cb6e373109cce5d2.jpg" alt="image"><br>  <i>Depth test (passed / failed)</i> <br><br>  And it's not only about static geometry: the headlights of cars also move along the road - the image is updated in real time.  Of course, at a great distance it makes no sense to fully visualize models of cars, and 2 headlights are enough to create the illusion of movement.  But if you decide to drive closer to one of the light sources, the level of detail rises and we get a full-fledged image of the car. <br><br><h4>  Low poly mesh </h4><br>  Let's return to the frame that we analyzed earlier.  Some fairly large areas are processed in just one render call.  So it was, in particular, in the case of rendering the hill in this image: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/51e/bb0/b5e/51ebb0b5ec9c6fbe5d709c29bfc005ee.jpg" alt="image"><br>  <i>Hill for just one draw command</i> <br><br>  So what is this tiny mound in the distance? <br><br>  In fact, Winewood Hills is by no means small.  This is a large area of ‚Äã‚Äãseveral square kilometers with dozens of houses and other buildings. <br><br>  At the top of the hill are the Galileo Observatory, the theater of Sisyphus, Lake Weinwood.  To create all these sights - you can take a closer look or just drive past - it took thousands of draw calls and countless polygons. <br><br>  But in our case, this zone is far away, and therefore is represented by a low-poly version: only one draw call, which involved some 2500 triangles. <br><br><img src="https://habrastorage.org/files/df6/121/018/df6121018930451fb004062f4c35219f.JPG"><br>  <i>Low poly model Vinewood Hills</i> <br><br>  Rendering is performed using a single graphic grid processing the diffuse texture data.  Even if there is a mechanism for converting the graphic grid into a low-poly version, it is impossible to fully automate the process, and therefore I would not be surprised if Rockstar 3D artists have to spend more than one day to adjust everything manually. <br><br>  Another example of a similar rendering in a single draw call is the Little Seoul district, which united several city blocks. <br><br><img src="https://habrastorage.org/files/0c4/bc3/ce9/0c4bc3ce9b8e49189f5a352c84c4f3c7.JPG"><br>  <i>Low poly model of Little Seoul</i> <br><br>  Having a low-poly model of the virtual world in hand, it is much easier to visualize the texture of reflections, which does not require any detail or high resolution.  For games of one level of detail, real-time processing of cubic environmental textures is often very expensive or even completely impossible due to the variety of geometric shapes used. <br><br><h4>  Providing game resources </h4><br>  Creating multiple versions of the virtual world with different levels of detail, as done in the GTA, is not an easy and very time-consuming task.  But even seemingly having reached your goal, you still remain halfway there: you may have gigabytes of models and textures on your hard drive, but they all cost nothing until you find a suitable way to load them into RAM or in memory of the graphics processor. <br><br>  GTA V provides a gaming resource in real time, uploading / downloading models and textures as you move around the map.  Moreover, the ability to use this content in real time while still enjoying the game without interruption is truly impressive. <br><br><blockquote>  From a technical point of view, the most difficult thing was to fit the necessary information in the memory of the console so that it still worked as smoothly as we can see [...].  We can translate and compile much more, which allows for a higher level of detail than it was in GTA 4. </blockquote><br>  <i>Aaron Garbut</i> <br><br>  Of course, such a data transfer mechanism also has its limitations: for example, when you choose a character, the camera jumps from one part of the map to another, in this case the system is overloaded and, it is logical that it takes 5 seconds to navigate in the new conditions and switch.  But in GTA V, such a transition was overplayed very effectively with the approaching / receding animation / translation window, and so the screen loading is not felt at all. <br><br>  As a rule, when you are driving a car, the movement speed is low enough so that the bandwidth of the data transmission system allows you to gradually load the available updates.  Airplanes are another matter: by the standards of streaming systems, they move too fast, and therefore they had to significantly reduce their speed relative to the indicators we are used to in reality.  In addition, the level of detail of the graphic grids corresponding to the flight scenes is much lower than in the case of walking / driving, which also facilitates the transfer of data.  Although, when a game resource asks for fresh updates, sometimes you have to resort to the above trick.  In the settings of the PC version, a special option ‚ÄúHigh-resolution data transfer during the flight‚Äù has been added. <br><br><h3>  Reflection </h3><br>  Since in the scene that I analyzed earlier, there was little water, let's take a closer look at the visualization of a pool or ocean using the example of the following scene: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/283/566/f93/283566f93fb106bff43faf898b0c4dfa.jpg" alt="image"><br>  <i>Pool</i> <br><br>  As we have already seen, the scene is rendered according to the standard scheme: a cubic texture of the environment is generated, basically, it is necessary to render objects that reflect the environment. <br><br>  So the scene looks like before rendering water: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/77d/726/d48/77d726d48b8966175ad13568412d89be.jpg" alt="image"><br>  <i>Before rendering water</i> <br><br>  The visualization of the surface of the water is a separate story that has nothing to do with the creation of a cubic texture. <br><br><h4>  Reflection map </h4><br>  First, the plane reflection map is generated.  And with a very low resolution, 240x120, and the process itself is similar to the process of generating a cubic texture, but this time it creates only one buffer, in which there is a ladder and characters. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e5e/bb1/61b/e5ebb161b4963d3dd018afb009f89879.png" alt="image"><br><br>  The scene is visualized as if upside down and only then, after applying symmetry, will it be possible to get the correct reflection. <br><br><h4>  Refraction map </h4><br>  A part of the image is extracted - areas with a water surface - allowing you to create a refraction map.  Due to this, the effect of refraction is subsequently imitated: the glow from under the water. <br><br>  At this stage, a blue is added to the ‚Äúwater opacity‚Äù (the deeper, the more saturated the tint), as well as caustics.  The final version of the map is half the size of a similar buffer. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/77d/726/d48/77d726d48b8966175ad13568412d89be.jpg" alt="image"><br>  <i>The foundation</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/055/342/b3d/055342b3dc8254aa7b3e4cff929342fa.jpg" alt="image"><br>  <i>Refraction map</i> <br><br><h4>  Combining </h4><br>  To combine different buffers, a rectangular polygon is drawn, which acts as the surface of the water in the pool.  Taking into account the texture of the relief, the polygon normals are shifted pixel by pixel, which imitates light ripples. <br><br>  For the ocean, however, not the normals are shifted, but the entire graphic grid of an individual frame is drawn with the vertices upward, which imitates the movement of the waves. <br><br>  Taking into account the normals of individual pixels, the pixel shader analyzes the indicators of the reflection and refraction map at different points, the coordinates are calculated using the Fresnel equations. <br><br><img src="https://habrastorage.org/files/c33/97a/371/c3397a3717f940cb82a0ef5211154c28.JPG"><br>  <i>Reflection map, refraction map and relief map</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/77d/726/d48/77d726d48b8966175ad13568412d89be.jpg" alt="image"><br>  <i>Water "Before"</i> <br><br>  And, as a result, we get the following image: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/283/566/f93/283566f93fb106bff43faf898b0c4dfa.jpg" alt="image"><br>  <i>Water "after"</i> <br><br>  The result is pleasantly pleased.  In combination with a successful ripple effect, the water looks very realistic. <br><br><h4>  Mirrors </h4><br>  Mirrors are visualized in the same way as water.  In this situation, everything is even much simpler, because mirrors only reflect the light and here it is not necessary to take into account its refraction. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/95b/249/edb/95b249edb5a378f3bbbd0d50edd12af4.jpg" alt="image"><br>  <i>Mirror reflection</i> <br><br>  Unlike water, the surface of the mirror is perfectly flat and motionless, and therefore it is not so easy to hide the very low resolution of the object - texels are seen very well.  Increasing the reflection settings in the settings, we get a higher resolution. <br><br>  To create a reflection map requires an additional stage of rendering the scene, but this is not an easy task.  The engine does not allow to start this process if the mirror is not visible in the doorway or the player is too far from it (in this case, the mirror resembles a black square). <br><br><h4>  Headlights </h4><br><br>  Remember that in the environment map, which is generated at the beginning of each frame, there are no characters, no cars, but only the main buildings and the landscape? <br><br>  How, in this case, the headlights of the car in the following screenshot are reflected in the wet asphalt? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56d/7d8/804/56d7d8804503f58de6e62c3f4399f637.jpg" alt="image"><br>  <i>Headlight reflections</i> <br><br>  In the frame that I analyzed in <a href="http://habrahabr.ru/company/ua-hosting/blog/271931/">Part 1</a> , this was not obvious, since it was day.  But, in fact, after combining all the buffers, the headlights are drawn one by one.  For each light bulb, the amount of light emitted into other graphic grids is calculated, including strong reflection from glossy surfaces, such as wet asphalt. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ac8/ac9/ec5/ac8ac9ec51dc4884801813a26bcfc3e5.jpg" alt="image"><br>  <i>Headlights 0%</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bde/854/67e/bde85467e5da574a8352b2435a0f5a3a.jpg" alt="image"><br>  <i>Headlights 50%</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e4/964/f36/7e4964f3617550cde44aacd1547e887c.jpg" alt="image"><br>  <i>Headlights 80%</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cc/000/116/6cc00011698edc12a3fe436f94c0e1c6.jpg" alt="image"><br>  <i>Headlights 100%</i> <br><br>  For each light source, its own graphic grid is drawn: initially it looks like a cellular octahedron, but subsequently the vertex shader modifies the grid to match the shape of the light halo. <br><br>  This graphic grid is not textured, it only helps to group the pixels inside the light halo so that the pixel shader can be applied.  The shader will allow you to dynamically calculate the lighting depending on the pixel depth, its distance from light sources, its normals and the presence of specular / glossy properties. <br><br>  Below you see a blueprint of the graphic grid used to calculate the illumination of the road with a lantern. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2d3/37b/38d/2d337b38d82c27c2869b233a2e3add88.jpg" alt="image"><br>  <i>Before building a grid</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ef/869/5c5/4ef8695c5fee37d2d5c42d6b14936446.jpg" alt="image"><br>  <i>After building the grid</i> <br><br>  With this consideration, one big advantage of deferred shading becomes obvious compared to the direct one: a large number of light sources can be visualized in a scene, practically without the help of a pixel shader that processes only pixels lit by one or another object.  With direct shading, it is necessary to calculate the effect of several light sources on a fragment of a frame at once, even if it is not illuminated or subsequently overlapped by another fragment. <br><br>  And since you are still reading my review, I propose to proceed to its final part, devoted to post-effects. <br><br><h3>  Effects of post-processing </h3><br><br>  Post effects are applied after the scene is rendered to improve the quality of the parts, make adjustments, create a new atmosphere ... <br><br>  In Part 1, we saw how certain post-effects were superimposed, in particular, glow, anti-aliasing and tonal compression.  Today let's talk about other effects found in GTA V. <br><br>  Glare and light streaks <br><br>  Sometimes, when light passes through a real lens, the scattering and internal refraction of the rays cause their distortion. <br><br>  In this article, ‚ÄúGlare‚Äù I called several bright spots along one axis formed by a bright light source and the center of the screen.  There are also "light streaks" - the rays from the light source.  This kind of distortion is very common in films, and when they appear in the game, some kind of ‚Äúcinematic‚Äù effect is created. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b75/103/c10/b75103c10cb73484b697ceb941b2cff8.jpg" alt="image"><br>  <i>Glare and light streaks</i> <br><br>  As a rule, 2 ways of visualization of such effects are used: <br><br><ul><li>  On the basis of the image: the brightest areas are highlighted, which are subsequently duplicated and distorted.  This option is suitable for any number of bright light sources. </li><li>  based on sprites: added textured sprites, the position of which is changed manually.  Each light source has to be processed separately, but the artist is given more opportunities to change the shape, color and intensity of glare and light strips ... </li></ul><br>  Both methods are involved in GTA V: the method using images allows you to add a thin blue halo in the lower left corner of the frame.  In fact, this is a symmetrical reflection of the contents of the brightness buffer.  But the most noticeable distortions in this scene appear due to manipulations with sprites made with the sun.  First, light strips are added by rendering 12 inverted quadrilaterals around the sun.  Then 70 sprites are drawn along the "sun - center of the screen" axis for highlights.  Effects become more intense when you turn the camera on the sun. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b8/c95/eed/6b8c95eed710a7011057abb9af3d65f7.jpg" alt="image"><br>  <i>The foundation</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/746/70b/cd2/74670bcd28a984bc52dae55d6a804410.jpg" alt="image"><br>  <i>Base + streaks of light</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fba/592/f33/fba592f3331a2c97d610938608a6356e.jpg" alt="image"><br>  <i>Base + light streaks + glare</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c8/cfd/dd8/5c8cfddd81a68d123719f1fcd68a5141.jpg" alt="image"><br>  <i>Base + light streaks + glare (ultra-sensitive blueprint)</i> <br><br>  The engine uses several sprites to simulate various lens distortion effects: <br><br><img src="https://habrastorage.org/files/2c5/28c/634/2c528c63407f4f3aad5593fc551cc66d.JPG"><br>  <i>Distortion effects</i> <br><br>  And, as a result, we get the following result: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b48/2cf/2bb/b482cf2bb3036931ea5d2c7c7a09b117.jpg" alt="image"><br>  <i>Base image</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/341/a12/9c7/341a129c794f7753a3299969e3ce966a.jpg" alt="image"><br>  <i>Base Image + Glare</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f5b/869/717/f5b869717407347597f8f7550fcf9f90.jpg" alt="image"><br>  <i>Base Image + Glare (Blueprint)</i> <br><br>  In GTA V, much attention is paid to the details, and glare is no exception: their size is proportional to the camera diaphragm.  So, if you suddenly look at the sun, the glare will first increase, and then, as soon as the diaphragm narrows, it decreases.  The animation below illustrates this feature beautifully. <br><br>  It is also pleasant that if you switch to the first-person mode, there will practically be no glare, because now you can see everything with the eyes of a person, and not through the camera lens. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/822/119/44c/82211944c1a9e9a56313e1b7bb7007d0.jpg" alt="image"><br>  <i>Wide aperture</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1ef/098/b1c/1ef098b1cf24d4c6c4afe5d526c45b51.jpg" alt="image"><br>  <i>Narrow aperture</i> <br><br><h4>  Anamorphic lenses </h4><br>  At night or when playing on dark areas of the map, the effect of anamorphic lenses is modeled: long vertical or horizontal, usually blue, stripes.  Recently, insignificant bands from anamorphic lenses have become widespread in the practice of Hollywood, because they often appear in new science fiction films. <br><br>  Here the effect is achieved with the help of sprites, as well as in the case of the sun rays, which we considered earlier.  True, it applies only to very bright, as the headlights of the car, the light sources directed directly into the camera. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f0b/892/32b/f0b89232bc09567e4d8217da0b8f4fbd.jpg" alt="image"><br>  <i>Anamorphic ‚ÄúBefore‚Äù effect</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/763/5c7/746/7635c7746ac3f3a9de82dcb445f1988a.jpg" alt="image"><br>  <i>Anamorphic ‚ÄúAfter‚Äù effect</i> <br><br><h4>  Depth of field </h4><br>  In the cinema, the scene presented below would look a bit ‚Äúartificial‚Äù: everything is too sharp and clear, but in the film the landscape in the background is out of focus, slightly blurred. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a07/434/df6/a07434df6f048655e1ee7d2526f57ffe.jpg" alt="image"><br>  <i>Base image</i> <br><br>  All you need to do is add a depth of field (DoF), blurring out areas of the image that remain out of focus. <br><br>  How to do it?  First, an unsharp map ( <a href="https://en.wikipedia.org/wiki/Circle_of_confusion">CoC</a> ) is generated based on the depth buffer.  It allows you to calculate how the pixels are out of focus, and, accordingly, sets the degree of impending blurring.  The CoC value of an individual pixel depends solely on its distance to the camera (depth) and lens parameters. <br><br>  It is worth noting, however, that in GTA V CoC, a value from -1 to 1 is assigned, so you can find out if the pixel is in front of the lens or behind the focus area.  For example, pixels located far beyond the focus limits are assigned to CoC 1, and out-of-focus pixels that fall very close to the camera are assigned a value of -1.  Any figure around 0 assumes that the pixel will, practically, not be blurred. <br><br>  What are numeric values ‚Äã‚Äãfor? <br><br>  This is because achieving a decent depth of field is not so easy and many factors have to be taken into account when applying a blur effect to the scene. <br><br>  For example, you do not want the out-of-focus pixel in the background to not overlap the neighboring out-of-focus located in front of it.  And what if there is an inverse problem: it is necessary that the blurred foreground pixel overlaps the clear fragment behind it.  As soon as it comes to pixel blur, the question is not ‚Äúhow much to blur‚Äù, it is also necessary to analyze nearby fragments, which can be both in front of and behind the pixel under investigation, both outside and in focus ... The numeric format of CoC values ‚Äã‚Äãis noticeable facilitates the task. <br><br>  On the CoC map below, I used the green channel for CoC&gt; 0 and the red channel for CoC &lt;0, which helps orient. <br><br><img src="http://www.adriancourreges.com/img/blog/2015/gtav/c/30_depth.png" alt="image"><br>  <i>Depth map</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9a3/e7e/52a/9a3e7e52a054c03e8afc20e98852aed3.png" alt="image"><br>  <i>CoC card</i> <br><br>  So, after studying the CoC card, it becomes clear that Leicester, highlighted in black, will be in focus, and Franklin in the foreground and the landscape in the background - out of focus. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2a1/82d/92d/2a182d92d771edcdf748a4e9e949d3c8.png" alt="image"><br>  <i>CoC foreground blur map</i> <br><br>  Then the engine selects only ‚Äúout-of-focus foreground areas‚Äù: all texels with CoC &lt;0.  This CoC foreground map is blurred with a computational shader, first horizontally and then vertically. <br><br>  Why?  Well, the CoC value for Franklin pixels is approximately 0.7, while for the bench right behind it, which came into focus, it is 0. Now that the blur is complete, the image of Franklin looks rather blurry and the bench will remain clear. moreover, the area next to Franklin's right hand looks strange: it turns out a sharp transition from a clearly blurred hand to the extremely clear lines of the bench.  The hard borders are very noticeable ... Disorder, the contours should merge smoothly, and the Franklin pixels should slightly overlap the neighboring ones. <br><br>  This is what a CoC blur card is needed for: to smooth out the roughness of the CoC card and ensure that the out-of-focus foreground pixels are properly superimposed. <br><br>  Now we have everything we need to calculate the depth of field.  Previously, the degree of blurring was calculated using a pixel shader at a lower resolution, separately horizontally and separately vertically, which guaranteed more accurate results.  The GTA V team decided to keep the method with 2 phases, but preferred to perform all the necessary operations with the original resolution, and in order to avoid performance degradation, use a computational shader instead of a pixel one. <br><br>  And this is reasonable, because <a href="https://fgiesen.wordpress.com/2012/07/30/fast-blurs-1/">computational shaders easily adapt to the blurring of large areas</a> .  So when calculating the total value of a ‚Äúblur‚Äù of a pixel, its color will depend on a smaller or larger number of neighboring (depending on the CoC pixel) and some of the latter will be excluded if the likelihood of incorrect compilation occurs. <br><br><img src="https://habrastorage.org/files/2fd/366/4b6/2fd3664b66c44db1be0ad8665398aa81.JPG"><br>  <i>Base, depth, CoC map and CoC blurred foreground map</i> <br><br>  When using double blur using a computational shader, we obtain the following image: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a07/434/df6/a07434df6f048655e1ee7d2526f57ffe.jpg" alt="image"><br>  <i>Depth of field "to"</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c9/284/b0b/0c9284b0bc93a3ef3bfe5a6ce65c9c8e.jpg" alt="image"><br>  <i>Depth of Field "After"</i> <br><br>  This effect gives the frame a completely different perception of dimensions, like in the movies, when the director focuses the camera on a character to draw attention to it. <br><br><h3>  Conclusion </h3><br>  Of course, there are other post-effects processing that could be considered, but it seems that this series of articles on GTA V was so much more lengthy than I had planned. <br><br>  There is a heat haze imitation, scattering of light in depth (sometimes bright areas overlap adjacent ones, sometimes corresponding graphical grids are added manually) or motion blur (like a mixed approach, when blur is performed only in the camera‚Äôs moving direction, eliminating player pixels due to the template buffer used in as a mask). <br><br>  The ‚ÄúWasted‚Äù screen, when your character dies, is also a clean post-effect: after the main rendering is completed, the scene is blurred, grayed out, then a vignette is applied, gritiness is added, like in a movie, and finally the familiar text is drawn over it. <br><br>  Hopefully, I still helped a little to understand how Rockstar managed to create a product that became a true guide in the world of video games.  The boundless universe, the specifics of filing and attention to detail, as well as the ability to run the game on the console of the old generation made GTA V an amazing project. </div><p>Source: <a href="https://habr.com/ru/post/272521/">https://habr.com/ru/post/272521/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272507/index.html">JavaScript encryption using the pidCrypt library</a></li>
<li><a href="../272509/index.html">Randomness in PHP7 - Will I get lucky?</a></li>
<li><a href="../272513/index.html">Implement Bootstrap 3 Datepicker in SonataAdminBundle</a></li>
<li><a href="../272517/index.html">Presentation of the e-government portal in Kiev</a></li>
<li><a href="../272519/index.html">Simple Blender. Part 1</a></li>
<li><a href="../272523/index.html">Editing a Raspberry Pi image with qemu-user-static (Ubuntu 14.04)</a></li>
<li><a href="../272525/index.html">Speed ‚Äã‚Äãchase: 4 ways to reduce delays when trading on the stock exchange</a></li>
<li><a href="../272529/index.html">Security and microservices</a></li>
<li><a href="../272531/index.html">Best Pull Request</a></li>
<li><a href="../272535/index.html">The final schedule of Community DevCamp (Moscow, December 12)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>