<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up wifi authorization via sms under ubuntu 16.04</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! Not so long ago, our organization faced the task of legalizing wifi access, but to continue using the system for free. (According to the Gove...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up wifi authorization via sms under ubuntu 16.04</h1><div class="post__text post__text-html js-mediator-article">  Hi Habr!  Not so long ago, our organization faced the task of legalizing wifi access, but to continue using the system for free.  (According to the Government Resolution No. 758 of July 31, 2014 and No. 801 of August 12, 2014, all public WIFI networks are required to identify users).  We have 10 rooms for events (from 30 to 400 people), and on average between 4 and 12 per day, plus the constant turnover of the people and capricious users. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b0c/d71/ef9/b0cd71ef9506f8917b017833b5b73039.png" alt="image"></div><a name="habracut"></a><br>  To begin, I will tell you how we have a network.  If you do not go into details, then hung access points HP MSM430 (J9651), management via HP MSM760 (J9420A) and HP Gateway F1000-EI (JG214A).  The choice of equipment is not successful, but we work with what we have. <br><br>  It so happened that in life I loved the Windows system more, but after receiving the task, after reading a lot of articles, I came to the conclusion that * nix system is best for this purpose.  The choice fell on the Ubuntu server 16.04.  Then there were several days of torment, but in the end everything turned out. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This article is for those who love Windows, looks at Ubuntu and puts a bunch of software from scratch. <br><br>  How I decided to organize everything: <br><br>  There is an open network, let's call it Free.  When you connect, the user is redirected to a hotspot with an authorization page.  There, he is given an Internet access code and a phone number to which he must send a message (a bit unusual, but the task was to save, including via SMS).  As soon as the message comes to us, Internet access immediately opens.  I‚Äôll make a reservation that it‚Äôs better to use a SIM card and a modem number MTS (not an advertisement), since they didn‚Äôt find an opportunity to send an SMS from the site without specifying the left number (although this is a problem, but in the process of solving). <br><br>  What we need: <br><br><ul><li>  Ubuntu Server 16.04 horse </li><li>  transparent squid proxy </li><li>  Mysql (MariaDB) </li><li>  Nginx </li><li>  PHP FPM </li><li>  USB redirector (virtual machine for HyperV) </li><li>  modem Huawei E153 MTS </li><li>  SMS tools for reading SMS </li><li>  etc.  etc. </li></ul><br>  Let's start. <br><br><h2>  Installing Ubuntu Server 16.04 </h2><br>  Here, everything is pretty trite: <br><br><ol><li>  Create a virtual machine (2 cores, 4 GB of memory, 2 network interfaces, 30 GB disk) </li><li>  We swing the last distribution kit, we connect, we put ... </li><li>  We configure network interfaces, one looks in vlan of wifi network, the second towards the gateway </li></ol><br><h2>  Network Setup and Forwarding Packages </h2><br><br>  We look at what network cards we have and what logical names are assigned to them: <br><pre><code class="bash hljs">cat /proc/net/dev</code> </pre> <br>  In my case, this is eth0 and eth1: <br><pre> <code class="bash hljs">Inter-| Receive | Transmit face |bytes packets errs drop fifo frame compressed multicast|bytes packets errs drop fifo colls carrier compressed lo: 632643353 3624368 0 0 0 0 0 0 632643353 3624368 0 0 0 0 0 0 eth1: 8789521059 30492824 0 0 0 0 0 0 65843784529 28992970 0 0 0 0 0 0 eth0: 65798728800 56063700 0 0 0 0 0 0 8382628950 29920038 0 0 0 0 0 0</code> </pre><br><br>  Edit the network interface configuration file: <br><pre> <code class="bash hljs">nano /etc/network/interfaces</code> </pre> <br><pre> <code class="bash hljs">auto eth0 iface eth0 inet static <span class="hljs-comment"><span class="hljs-comment">#     address 10.66.66.6 netmask 255.255.255.240 network 10.66.66.0 broadcast 10.66.66.15 gateway 10.66.66.1 dns-nameservers 10.66.66.1 auto eth1 iface eth1 inet static #   wifi  address 10.0.87.254 netmask 255.255.248.0 network 10.0.80.0 broadcast 10.0.87.255</span></span></code> </pre> <br>  Make sure that IPv6 interfaces are actually present in the system: <br><br><pre> <code class="bash hljs">ip a | grep inet</code> </pre> <br>  You can also see that some applications post TCP listeners on IPv6 interfaces.  You can see all ports listened in the system with the command: <br><br><pre> <code class="bash hljs">sudo ss -lnptu | sort</code> </pre> <br>  To turn off IPv6 support on all network interfaces at once, open the sysctl.conf file for editing <br><br><pre> <code class="bash hljs">sudo nano -Y sh /etc/sysctl.conf</code> </pre> <br>  Add lines to the end of the file to enable forwarding and disable IPv6: <br><br><pre> <code class="bash hljs">net.ipv4.ip_forward=1 net.ipv6.conf.all.disable_ipv6 = 1</code> </pre> <br>  To verify that our option can be read by sysctl at boot time, run: <br><br><pre> <code class="bash hljs">sudo sysctl -p</code> </pre> <br><pre> <code class="bash hljs">/etc/init.d/networking restart</code> </pre> <br><h2>  MySQL installation </h2><br>  As the database server, I chose MaridDB.  In terms of functionality, something is even better than MySQL, but the article is not about that. <br><br><pre> <code class="bash hljs">apt-get install mariadb-server <span class="hljs-comment"><span class="hljs-comment">#    mysql_secure_installation # mysql    mysql -u root use mysql; update user set plugin='' where User='root'; flush privileges;</span></span></code> </pre> <br>  Check if everything started well with us: <br><br><pre> <code class="bash hljs">service mysql status</code> </pre> <br><h2>  Installing Squid with SSL support and IPv6 disable </h2><br>  There are many articles on how to build and install proxies, but this stage was probably the most dreary.  By default, Squid without SSL support is in the Ubunt repository.  I decided to rebuild, and so it took 2 days ... As a result, I got my own manual how to build the latest version 3.5.20 for x64. <br><br>  We put the necessary software for the assembly: <br><br><pre> <code class="bash hljs">apt-get install git fakeroot checkinstall build-essential devscripts patch libssl-dev libgnutls28-dev apt-cache policy squid3 apt-get update apt-get build-dep squid3</code> </pre> <br>  Uncomment the source repositories and add a new one: <br><br><pre> <code class="bash hljs">nano /etc/apt/sources.list deb-src http://ftp.de.debian.org/debian/ testing main contrib non-free</code> </pre> <br>  The new repository, will swear on the keys, so we will immediately get them: <br><br><pre> <code class="bash hljs">gpg --keyserver keyserver.ubuntu.com --recv 8B48AD6246925553 gpg --<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> --armor 8B48AD6246925553 | sudo apt-key add - gpg --keyserver keyserver.ubuntu.com --recv 7638D0442B90D010 gpg --<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> --armor 7638D0442B90D010 | sudo apt-key add -</code> </pre> <br>  Do not forget to update information about repositories: <br><br><pre> <code class="bash hljs">apt-get update</code> </pre> <br>  In order not to clutter up the working folder, go to tmp and download from testing the latest version of squid with the rules for building under debian <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp/ apt-get <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> squid3</code> </pre> <br>  Current version 3.5.19, updated to the latest 3.5.21 <br><br><pre> <code class="bash hljs">wget http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.21.tar.gz tar -xf squid-3.5.21.tar.gz mkdir ./squid-3.5.21/debian/ cp -r ./squid3-3.5.19/debian/* ./squid-3.5.21/debian/ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> squid-3.5.21/ nano debian/rules</code> </pre> <br>  Add lines (do not forget to specify the path to openssl.cnf, I have it / etc / ssl) <br><br><pre> <code class="bash hljs">--<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-ipv6 \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-icap-client \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-ssl-crtd \ --with-openssl=/etc/ssl \</code> </pre><br>  We correct the error (constant messages in the logs: SECURITY ALERT: Host header detected for local detected ... = 443 remote = ...: *), well described in the <a href="https://habrahabr.ru/sandbox/99037/">article</a> , with an assessment of all security risks.  (The article describes about version 3.5.12, the code has changed a little here). <br><pre> <code class="bash hljs">nano ./src/client_side_request.cc</code> </pre><br>  We are looking for the hostHeaderIpVerify function and modify its code a bit: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ClientRequestContext::hostHeaderIpVerify(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ipcache_addrs* ia, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DnsLookupDetails &amp;dns) { Comm::ConnectionPointer clientConn = http-&gt;getConn()-&gt;clientConnection; <span class="hljs-comment"><span class="hljs-comment">// note the DNS details for the transaction stats. http-&gt;request-&gt;recordLookup(dns); if (ia != NULL &amp;&amp; ia-&gt;count &gt; 0) { // Is the NAT destination IP in DNS? for (int i = 0; i &lt; ia-&gt;count; ++i) { if (clientConn-&gt;local.matchIPAddr(ia-&gt;in_addrs[i]) == 0) { debugs(85, 3, HERE &lt;&lt; "validate IP " &lt;&lt; clientConn-&gt;local &lt;&lt; " possible from Host:"); http-&gt;request-&gt;flags.hostVerified = true; http-&gt;doCallouts(); return; } debugs(85, 3, HERE &lt;&lt; "validate IP " &lt;&lt; clientConn-&gt;local &lt;&lt; " non-match from Host: IP " &lt;&lt; ia-&gt;in_addrs[i]); } } // patch for SECURITY ALERT: Host header forgery detected http-&gt;request-&gt;flags.hostVerified = true; http-&gt;doCallouts(); return; debugs(85, 3, HERE &lt;&lt; "FAIL: validate IP " &lt;&lt; clientConn-&gt;local &lt;&lt; " possible from Host:"); hostHeaderVerifyFailed("local IP", "any domain IP"); }</span></span></code> </pre><br>  We confirm the patch and collect (wait about 10-15 minutes) <br><br><pre> <code class="bash hljs">dpkg-source --commit <span class="hljs-comment"><span class="hljs-comment">#patch update to squid 3.5.20 debuild</span></span></code> </pre> <br>  We look, what packages we have gathered: <br><br><pre> <code class="bash hljs">ls -l /tmp/ | grep .deb$</code> </pre> <br>  If there are no packages, then check the folder. <pre> <code class="bash hljs">ls -l /tmp/squid3-3.5.19/ | grep .deb$</code> </pre> <br>  And we start the installation of Squid: <br><br><pre> <code class="bash hljs">apt-get install squid-langpack libdbi-perl dpkg -i squid-common_3.5.19-1_all.deb dpkg -i squid_3.5.19-1_amd64.deb dpkg -i squid3_3.5.19-1_all.deb dpkg -i squidclient_3.5.19-1_amd64.deb</code> </pre> <br>  if for any reason, the installer hangs up, then reset the lock: <br><br><pre> <code class="bash hljs">fuser -vki /var/lib/dpkg/lock</code> </pre> <br>  we start and check the status <br><br><pre> <code class="bash hljs">service squid start systemctl status -l squid</code> </pre> <br>  in response should see something similar <br><br><pre> <code class="bash hljs">squid.service - LSB: Squid HTTP Proxy version 3.x Loaded: loaded (/etc/init.d/squid; bad; vendor preset: enabled) Active: active (running)</code> </pre> <br>  Checking the installed version of Squid <br><pre> <code class="bash hljs">/usr/sbin/squid -v Squid Cache: Version 3.5.21 Service Name: squid Ubuntu linux</code> </pre><br>  Now let's set it up, first we will create an SSL certificate and save the default config: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/squid openssl req -new -newkey rsa:1024 -days 365 -nodes -x509 -keyout squidCA.pem -out squidCA.pem mv ./squid.conf ./squid.conf.default nano ./squid.conf</code> </pre> <br>  The configuration file is almost unchanged from the <a href="https://habrahabr.ru/post/267851/">article</a> . <br><br><pre> <code class="hljs pgsql">acl localnet src <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.80</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">21</span></span> acl SSL_ports port <span class="hljs-number"><span class="hljs-number">443</span></span> acl Safe_ports port <span class="hljs-number"><span class="hljs-number">80</span></span> # http acl Safe_ports port <span class="hljs-number"><span class="hljs-number">21</span></span> # ftp acl Safe_ports port <span class="hljs-number"><span class="hljs-number">443</span></span> # https acl Safe_ports port <span class="hljs-number"><span class="hljs-number">70</span></span> # gopher acl Safe_ports port <span class="hljs-number"><span class="hljs-number">210</span></span> # wais acl Safe_ports port <span class="hljs-number"><span class="hljs-number">1025</span></span><span class="hljs-number"><span class="hljs-number">-65535</span></span> # unregistered ports acl Safe_ports port <span class="hljs-number"><span class="hljs-number">280</span></span> # http-mgmt acl Safe_ports port <span class="hljs-number"><span class="hljs-number">488</span></span> # gss-http acl Safe_ports port <span class="hljs-number"><span class="hljs-number">591</span></span> # filemaker acl Safe_ports port <span class="hljs-number"><span class="hljs-number">777</span></span> # multiling http acl <span class="hljs-keyword"><span class="hljs-keyword">CONNECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONNECT</span></span> dns_nameservers <span class="hljs-number"><span class="hljs-number">10.66</span></span><span class="hljs-number"><span class="hljs-number">.66</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> http_access deny !Safe_ports http_access deny <span class="hljs-keyword"><span class="hljs-keyword">CONNECT</span></span> !SSL_ports http_access allow localhost manager http_access deny manager http_access allow localnet http_access allow localhost http_access deny <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> #http_port <span class="hljs-number"><span class="hljs-number">3128</span></span> #    intercept http_port <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.87</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>:<span class="hljs-number"><span class="hljs-number">3128</span></span> intercept <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>=NO_SSLv3:NO_SSLv2 #    ,       #  ,   ,    ,   #    ,     ,      #   ,     =) http_port <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.87</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>:<span class="hljs-number"><span class="hljs-number">3130</span></span> <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>=NO_SSLv3:NO_SSLv2 # ,  HTTPS     https_port <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.87</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>:<span class="hljs-number"><span class="hljs-number">3129</span></span> intercept ssl-bump <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>:NO_SSLv3:NO_SSLv2 <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-auth=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> cert=/etc/squid/squidCA.pem always_direct allow <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> sslproxy_cert_error allow <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> sslproxy_flags DONT_VERIFY_PEER #      (    .<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com) acl blocked ssl::server_name "/etc/squid/blocked_https.txt" acl step1 at_step SslBump1 ssl_bump peek step1 # ,       ssl_bump terminate blocked ssl_bump splice <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M <span class="hljs-number"><span class="hljs-number">4</span></span>MB coredump_dir /var/spool/squid refresh_pattern ^ftp: <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">10080</span></span> refresh_pattern ^gopher: <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">1440</span></span> refresh_pattern -i (/cgi-bin/|\?) <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">0</span></span> refresh_pattern . <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">4320</span></span> cache_dir aufs /var/spool/squid <span class="hljs-number"><span class="hljs-number">2048</span></span> <span class="hljs-number"><span class="hljs-number">49</span></span> <span class="hljs-number"><span class="hljs-number">256</span></span> maximum_object_size <span class="hljs-number"><span class="hljs-number">61440</span></span> KB minimum_object_size <span class="hljs-number"><span class="hljs-number">3</span></span> KB cache_swap_low <span class="hljs-number"><span class="hljs-number">90</span></span> cache_swap_high <span class="hljs-number"><span class="hljs-number">95</span></span> maximum_object_size_in_memory <span class="hljs-number"><span class="hljs-number">512</span></span> KB memory_replacement_policy lru #logfile_rotate <span class="hljs-number"><span class="hljs-number">31</span></span> logfile_daemon /usr/lib/squid/log_db_daemon access_log daemon:/<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3306</span></span>/base/<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">password</span></span> squid</code> </pre> <br>  Create a file with a list of blocked resources <br><br><pre> <code class="bash hljs">nano ./blocked_https.txt</code> </pre> <br>  I pay attention that we will write logs to the database.  To do this, create a table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`access_log`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`time_since_epoch`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`time_response`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ip_client`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ip_server`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`http_status_code`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`http_reply_size`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`http_method`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`http_url`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">500</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`http_username`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`http_mime_type`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`squid_request_status`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`squid_hier_status`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre> <br>  we start and check the status <br><br><pre> <code class="bash hljs">service squid start systemctl status -l squid</code> </pre> <br>  in response should see something similar <br><br><pre> <code class="bash hljs"> squid.service - LSB: Squid HTTP Proxy version 3.x Loaded: loaded (/etc/init.d/squid; bad; vendor preset: enabled) Active: active (running)</code> </pre> <br>  Check the ports used and the version of the installed squid <br><br><pre> <code class="bash hljs">sudo ss -lnptu | grep :3128 sudo ss -lnptu | grep :3129 sudo ss -lnptu | grep :3130 squid -version Squid Cache: Version 3.5.20</code> </pre> <br><h2>  We put USB-Redirector and modem </h2><br>  Since the cluster is used for HyperV 2012R2, the problem arises, namely how to plug in a modem.  Our organization is used quite successfully: <a href="http://www.incentivespro.com/downloads.html">USB-Redirector</a> .  We put it under Ubuntu <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp/ wget http://www.incentivespro.com/usb-redirector-linux-x86_64.tar.gz tar -xf usb-redirector-linux-x86_64.tar.gz ./usb-redirector-linux-x86_64/installer.sh install-client</code> </pre> <br>  connect to the server where we connected the modem <br><br><pre> <code class="bash hljs">usbclnt -addserver 10.XXX:32032 usbclnt -autoconnect on 1</code> </pre> <br>  we watch the list of all usb devices <br><br><pre> <code class="bash hljs">usbclnt -l ================= USB CLIENT OPERATION SUCCESSFUL =============== List of USB servers and devices: 1: USB server at 10.XXX:32032 Mode: auto-connect Status: connected - 7: HUAWEI Mobile Vid: 12d1 Pid: 1001 Port: 3-2 Mode: manual-connect Status: disconnected</code> </pre><br>  install modem drivers <br><br><pre> <code class="bash hljs">apt-get install usb-modeswitch usb-modeswitch-data</code> </pre><br>  connect and check if the modem is installed <br><br><pre> <code class="bash hljs">usbclnt -connect 1-7 ls /dev | grep ttyUSB</code> </pre><br>  in response must see: <br><br><pre> <code class="bash hljs">ttyUSB0 ttyUSB1 ttyUSB2</code> </pre> <br><br>  The USB device needs to be switched to modem mode, for this we install the minicon program: <br><pre> <code class="bash hljs">apt-get install minicom</code> </pre><br>  Run its configuration: <br><pre> <code class="bash hljs">minicom -s</code> </pre><br>  Select "Configure serial port" and in the "serial port" set / dev / ttyUSB0 <br>  We do not change anything else in the settings.  The following at-commands are used to switch modes of operation in huawei modems: <br>  AT ^ U2DIAG = 0 device in modem only mode <br>  AT ^ U2DIAG = 1 device in modem + CD-ROM mode <br>  AT ^ U2DIAG = 255 - device in modem mode + CD-ROM + Card Reader <br>  AT ^ U2DIAG = 256 device in modem + Card Reader <br>  Turn on the modem only mode: <br>  AT ^ U2DIAG = 0 <br>  In response, we get "OK".  Exit the program, to do this, press Ctrl + A and Q. <br><br><h2>  Install SMS-tools </h2><br>  Information about the packages can be found on <a href="http://smstools3.kekekasvi.com/">the</a> developer's <a href="http://smstools3.kekekasvi.com/">website</a> . <br>  Install and configure: <br><br><pre> <code class="bash hljs">apt-get install smstools nano /etc/smsd.conf</code> </pre> <br>  find the line [GSM1] <br><br><pre> <code class="bash hljs">[GSM1] device = /dev/ttyUSB0 incoming = yes baudrate = 9600 eventhandler = /var/www/sms_recieve.php</code> </pre><br>  create an incoming SMS handler file and make it executable <br><br><pre> <code class="bash hljs">nano /var/www/sms_recieve.php chmod 755 /var/www/sms_recieve.php service smstools restart</code> </pre> <br><h2>  We configure the DHCP server </h2><br><pre> <code class="bash hljs">apt-get install isc-dhcp-server nano /etc/default/isc-dhcp-server <span class="hljs-comment"><span class="hljs-comment">#,      dhcp  INTERFACES="eth1" sudo nano /etc/dhcp/dhcpd.conf #  authoritative; subnet 10.0.80.0 netmask 255.255.248.0 { range 10.0.80.1 10.0.86.254; option domain-name-servers 10.0.87.254; option domain-name "wifi-free"; option subnet-mask 255.255.248.0; option routers 10.0.87.254; option broadcast-address 10.0.87.255; default-lease-time 7200; #2h max-lease-time 72000; #20h } /etc/init.d/isc-dhcp-server restart</span></span></code> </pre> <br><h2>  Configuring Nginx and PHP 5.6 FPM </h2><br>  Since php has been updated to version 7 and in all ubuntu repositories already has php7, we add a new one and install: <br><br><pre> <code class="bash hljs">add-apt-repository ppa:ondrej/php apt-get install php5.6-cli php5.6-common php5.6-mysql php5.6-gd php5.6-fpm php5.6-cgi php-pear</code> </pre> <br>  stop the installed service and edit the configuration files <br><br><pre> <code class="bash hljs">service php5.6-fpm stop nano /etc/php/5.6/fpm/php.ini cgi.fix_pathinfo = 0 post_max_size = 200M upload_max_filesize = 200M nano /etc/php/5.6/fpm/pool.d/www.conf security.limit_extensions = .php .php3 .php4 .php5 listen = /run/php/php5.6-fpm.sock listen.owner = www-data listen.group = www-data listen.mode = 0660 service php5.6-fpm start</code> </pre> <br>  You can make sure that the permissions for the socket are set correctly: <br><br><pre> <code class="bash hljs">ls -la /run/php/php5.6-fpm.sock <span class="hljs-comment"><span class="hljs-comment">#srw-rw---- 1 www-data www-data 0 May 2 16:36 /run/php/php5.6-fpm.sock</span></span></code> </pre> <br>  Checking: <br><br><pre> <code class="bash hljs">php -v PHP 5.6.23-2+deb.sury.org~xenial+1 (cli) Copyright (c) 1997-2016 The PHP Group Zend Engine v2.6.0, Copyright (c) 1998-2016 Zend Technologies with Zend OPcache v7.0.6-dev, Copyright (c) 1999-2016, by Zend Technologies</code> </pre><br>  Go to Nginx <br><br><pre> <code class="bash hljs">apt-get install nginx nginx-extras</code> </pre> <br>  The main Nginx settings are stored in the /etc/nginx/nginx.conf file. <br><br>  The base site settings are stored in the / etc / nginx / sites-available / default file. <br><br>  The base configuration file of the site can be placed in the / etc / nginx / sites-available / folder and then included by adding a symbolic link to this file in the / etc / nginx / sites-enabled / folder. <br><br><pre> <code class="bash hljs">touch /etc/nginx/sites-available/hotspot.domain.com ln -s /etc/nginx/sites-available/hotspot.domain.com /etc/nginx/sites-enabled/ mkdir /etc/nginx/common</code> </pre> <br>  I will continue to be brief, since explanations can be read on the <a href="http://help.ubuntu.ru/wiki/nginx-phpfpm">link</a> .  We create common server configuration files in which we describe the security, compression, caching and php settings. <br><br><pre> <code class="bash hljs">touch /etc/nginx/common/upstream nano /etc/nginx/common/upstream upstream php-fpm { <span class="hljs-comment"><span class="hljs-comment"># PHP5.6-FPM  server unix:/run/php/php5.6-fpm.sock; }</span></span></code> </pre><br><pre> <code class="bash hljs">touch /etc/nginx/common/security nano /etc/nginx/common/security add_header X-Frame-Options <span class="hljs-string"><span class="hljs-string">"SAMEORIGIN"</span></span>; add_header X-Content-Type-Options <span class="hljs-string"><span class="hljs-string">"nosniff"</span></span>;</code> </pre><br><pre> <code class="bash hljs">touch /etc/nginx/common/gzip nano /etc/nginx/common/gzip gzip on; gzip_disable <span class="hljs-string"><span class="hljs-string">"msie6"</span></span>; gzip_comp_level 6; gzip_min_length 1100; gzip_buffers 16 8k; gzip_proxied any; gzip_types text/plain application/xml text/css text/js text/xml application/x-javascript text/javascript application/javascript application/json application/xml+rss;</code> </pre> <br><pre> <code class="bash hljs">touch /etc/nginx/common/php-fpm nano /etc/nginx/common/php-fpm <span class="hljs-comment"><span class="hljs-comment">#     PHP-FPM    "/etc/php/5.6/fpm/pool.d/www.conf" fastcgi_pass php-fpm; #   -  "include fastcgi_params"    include fastcgi_params; fastcgi_split_path_info ^(.+?\.php)(/.*)?$; #   "$document_root"           (. http://wiki.nginx.org/Pitfalls) fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_TRANSLATED $document_root$fastcgi_script_name; # . http://trac.nginx.org/nginx/ticket/321 set $path_info $fastcgi_path_info; fastcgi_param PATH_INFO $path_info; # Additional variables fastcgi_param SERVER_ADMIN email@example.com; fastcgi_param SERVER_SIGNATURE nginx/$nginx_version; fastcgi_index index.php;</span></span></code> </pre> <br><pre> <code class="bash hljs">touch /etc/nginx/common/cache nano /etc/nginx/common/cache location ~* <span class="hljs-string"><span class="hljs-string">".+\.(?:ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|rss|css|swf|js|atom|jpe?g|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$"</span></span> { access_log off; log_not_found off; expires max; }</code> </pre> <br>  In my cases, I had a public wildcard certificate for my domain.  Unpack the certificate file and set permissions <br><br><pre> <code class="bash hljs"> openssl pkcs12 -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> certname.pfx -nocerts -out /etc/nginx/ssl/key.pem -nodes openssl pkcs12 -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> certname.pfx -nokeys -out /etc/nginx/ssl/cert.pem openssl rsa -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /etc/nginx/ssl/key.pem -out /etc/nginx/ssl/domain.key <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/nginx/ssl/ chown www-data:www-data domain.key chmod 400 domain.key</code> </pre> <br><pre> <code class="bash hljs">touch /etc/nginx/common/ssl nano /etc/nginx/common/ssl ssl_certificate /etc/nginx/ssl/domain.crt; ssl_certificate_key /etc/nginx/ssl/domain.key; ssl_session_timeout 20m; <span class="hljs-comment"><span class="hljs-comment">#  20  ssl_session_cache shared:SSL:20m; #   20 ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_prefer_server_ciphers on; ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AE$</span></span></code> </pre><br>  We configure our server: <br><br><pre> <code class="bash hljs">nano /etc/nginx/sites-available/hotspot.domain.com include common/upstream; server { listen 80; server_name hotspot.domain.com; root /var/www; index index.php index.html index.htm; client_max_body_size 200m; <span class="hljs-comment"><span class="hljs-comment">#        200 # Buffers fastcgi_buffers 64 4K; include common/security; include common/gzip; location "/" { index index.php index.html index.htm; #           try_files $uri $uri/ =404; #        ,  -   404 include common/deny; include common/cache; include common/php-fpm; } }</span></span></code> </pre><br>  and redirect from the default server (do not forget that the DNS server must resolve the name hotspot.domain.com): <br><br><pre> <code class="bash hljs">nano /etc/nginx/sites-available/default server { listen 80 default_server; <span class="hljs-comment"><span class="hljs-comment">#listen [::]:80 default_server; listen 443 ssl default_server; #listen [::]:443 ssl default_server; include common/ssl; rewrite ^ http://hotspot.domain.com?url=$scheme://$host$request_uri? redirect; ... }</span></span></code> </pre><br><br><h2>  Configure phpmyadmin </h2><br>  For more convenient work with the database, install phpmyadmin. <br><br><pre> <code class="bash hljs">apt-get install phpmyadmin apt-get install mcrypt php5.6-mcrypt php5.6-mbstring php-gettext</code> </pre> <br><pre> <code class="bash hljs">touch /etc/nginx/common/phpmyadmin nano /etc/nginx/common/phpmyadmin location /phpmyadmin { root /usr/share/; index index.htm index.html index.php; location ~ ^/phpmyadmin/(.+.php)$ { try_files <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> = 404; root /usr/share/; fastcgi_pass unix:/run/php/php5.6-fpm.sock; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME <span class="hljs-variable"><span class="hljs-variable">$request_filename</span></span>; include /etc/nginx/fastcgi_params; } location ~* ^/phpmyadmin/(.+.(html|ico|xml|css|jpg|png|js|txt|gif|jpeg))$ { root /usr/share/; } } location /phpMyAdmin { rewrite ^/* /phpmyadmin last; }</code> </pre> <br>  and similarly connect to nginx <br><br><pre> <code class="bash hljs">nano /etc/nginx/sites-available/hotspot.domain.com include common/phpmyadmin;</code> </pre> <br>  restart <br><br><pre> <code class="bash hljs">service nginx restart service php5.6-fpm restart</code> </pre> <br><h2>  Configuring iptables firewall </h2><br>  In this section, we need to restrict access to the server and wrap traffic on the proxy.  To begin with, let's configure saving all rules after a reboot: <br><br><pre> <code class="bash hljs">apt-get install iptables-persistent ipset</code> </pre> <br>  since in our task, we need the ipset tables to be saved, we edit the following file a little: <br><br><pre> <code class="bash hljs">nano /usr/share/netfilter-persistent/plugins.d/15-ip4tables <span class="hljs-comment"><span class="hljs-comment">#  save_rules() touch /etc/iptables/rules.v4 touch /etc/iptables/ipset.rules chmod 0642 /etc/iptables/ipset.rules chmod 0640 /etc/iptables/rules.v4 iptables-save &gt; /etc/iptables/rules.v4 ipset save &gt; /etc/iptables/ipset.rules #  load_rules() ipset restore &lt; /etc/iptables/ipset.rules iptables-restore &lt; /etc/iptables/rules.v4 2&gt; /dev/null</span></span></code> </pre><br>  To save the rules on the firewall, use the command: <br><br><pre> <code class="bash hljs">netfilter-persistent save</code> </pre> <br>  We use conntrack to monitor and reset established connections. <br><br><pre> <code class="bash hljs">apt-get install conntrack</code> </pre> <br>  Configuring iptables rules <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   mac-ip ipset --create authorized macipmap --network 10.0.80.0/21 ipset -L authorized #     iptables -t nat -N toSQUID iptables -t nat -N toHOTSPOT #     iptables -t nat -F PREROUTING # DNS    iptables -t nat -A PREROUTING -i eth1 -p udp --dport 53 -j DNAT --to 10.66.66.1 # ip,mac ,    squid iptables -t nat -A PREROUTING -i eth1 -m set --match-set authorized src,src -j toSQUID # ip,mac  ,     iptables -t nat -A PREROUTING -i eth1 -j toHOTSPOT iptables -t nat -F toHOTSPOT #  ,       nginx iptables -t nat -A toHOTSPOT -p tcp -m multiport --dports 80,8080 -j DNAT --to-destination 10.0.87.254:80 iptables -t nat -A toHOTSPOT -p tcp -m multiport --dports 443 -j DNAT --to-destination 10.0.87.254:443 iptables -t nat -A toHOTSPOT -j RETURN iptables -t nat -F toSQUID #      #    telegram (       squid) iptables -t nat -A toSQUID -p tcp -d 149.154.164.0/22 --dport 443 -j ACCEPT #  whatsapp iptables -t nat -A toSQUID -p tcp -m multiport --dport 4244,5242,5228,5223,5222 -j ACCEPT iptables -t nat -A toSQUID -p tcp -m multiport --dports 80,25,465,110,995,119,563,8080 -j REDIRECT --to-ports 3128 iptables -t nat -A toSQUID -p tcp -m multiport --dports 443 -j REDIRECT --to-ports 3129 iptables -t nat -A toSQUID -j RETURN # NAT    iptables -t nat -A POSTROUTING -s 10.0.80.0/21 -o eth0 -j MASQUERADE #      iptables -P INPUT ACCEPT iptables -F INPUT #   lo iptables -A INPUT -i lo -j ACCEPT #        iptables -A INPUT -i eth0 -p tcp -m multiport --dports 22,80,443 -j ACCEPT #    iptables -A INPUT -p icmp -m icmp --icmp-type 0 -j ACCEPT iptables -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT #     iptables -A INPUT -p TCP -m state --state ESTABLISHED,RELATED -j ACCEPT iptables -A INPUT -p UDP -m state --state ESTABLISHED,RELATED -j ACCEPT #    iptables -A INPUT -i eth1 -p tcp -m multiport --dport 3128,3129,3130 -j ACCEPT iptables -A INPUT -i eth1 -p udp -m multiport --dport 3128,3129,3130 -j ACCEPT ‚Ññ    iptables -A INPUT -i eth1 -p tcp -m multiport --dports 80,443 -j ACCEPT #      iptables -P INPUT DROP #    ,    iptables -N FORWARD_AUTHORIZED iptables -F FORWARD_AUTHORIZED #   telegram iptables -A FORWARD_AUTHORIZED -p tcp -d 149.154.164.0/22 --dport 443 -j ACCEPT #   whatsapp iptables -A FORWARD_AUTHORIZED -p tcp -m multiport --dport 4244,5242,5228,5223,5222 -j ACCEPT iptables -A FORWARD_AUTHORIZED -j RETURN #      iptables -P FORWARD ACCEPT iptables -F FORWARD #   dns iptables -A FORWARD -i eth1 -p udp --dport 53 -d 10.66.66.1 -j ACCEPT #     iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT #       FORWARD_AUTHORIZED iptables -A FORWARD -i eth1 -m set --match-set authorized src,src -j FORWARD_AUTHORIZED #      iptables -P FORWARD DROP</span></span></code> </pre> <br>  To catch problems we use the following commands. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     ip conntrack -D conntrack --orig-src 10.0.8X.XXX #     tail -f /var/log/firewall | grep 10.0.8X.XXX</span></span></code> </pre> <br><h2>  Customize php request processing files and scripts </h2><br>  We create tables in our database: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> FOREIGN_KEY_CHECKS=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`mac-auth`</span></span> ( <span class="hljs-string"><span class="hljs-string">`mac`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-string"><span class="hljs-string">`code`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">`phone`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'     '</span></span>, <span class="hljs-string"><span class="hljs-string">`updated`</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-string"><span class="hljs-string">`created`</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`mac`</span></span> (<span class="hljs-string"><span class="hljs-string">`mac`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`code`</span></span> (<span class="hljs-string"><span class="hljs-string">`code`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`mac-ip`</span></span> ( <span class="hljs-string"><span class="hljs-string">`mac`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-string"><span class="hljs-string">`ip`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'ip  '</span></span>, <span class="hljs-string"><span class="hljs-string">`date`</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`mac`</span></span> (<span class="hljs-string"><span class="hljs-string">`mac`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`ip`</span></span> (<span class="hljs-string"><span class="hljs-string">`ip`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`mac-phone`</span></span> ( <span class="hljs-string"><span class="hljs-string">`mac`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-string"><span class="hljs-string">`phone`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">`date`</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`mac`</span></span> (<span class="hljs-string"><span class="hljs-string">`mac`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`ip`</span></span> (<span class="hljs-string"><span class="hljs-string">`phone`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`mac-ip`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">`mac`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`mac`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> <span class="hljs-string"><span class="hljs-string">`mac-auth`</span></span> (<span class="hljs-string"><span class="hljs-string">`mac`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> FOREIGN_KEY_CHECKS=<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  we create a script, at login, to check the operation of all services: <br><br><pre> <code class="bash hljs">nano /var/www/check_services.sh <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash function check { printf %-30s "check $1" if (( $(ps -ef | grep -v grep | grep $1 | wc -l) &gt; 0 )) then echo -e "[\033[32;1m OK \033[0m]" else echo -e "[\033[31;1m ERROR \033[0m]" fi } check dhcpd check nginx check mysql check php-fpm check smstools check squid check usbsrvd</span></span></code> </pre><br>  set launch permissions and add to start <br><br><pre> <code class="bash hljs">chmod 755 /var/www/check_services.sh nano ~/.profile /var/www/check_services.sh</code> </pre> <br>  And now the sources of php files: <br><br><pre> <code class="bash hljs">nano /var/www/sms_recieve.php</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/php &lt;?php require_once 'hotspot/connect.php'; $sms_type = $argv[1]; $sms_file = $argv[2]; $sms_file_content = file_get_contents($sms_file); $i = strpos($sms_file_content, "\n\n"); $sms_headers_part = substr($sms_file_content, 0, $i); $sms_message_body = substr($sms_file_content, $i + 2); $sms_header_lines = split("\n", $sms_headers_part); $sms_headers = array(); foreach ($sms_header_lines as $header) { $i = strpos($header, ":"); if ($i !== false) $sms_headers[substr($header, 0, $i)] = substr($header, $i + 2); } $phone = (float)$sms_headers['From']; $code = (int)$sms_message_body; //     $interval = '30 DAY'; //$interval = '1 MINUTE'; $macs = sql_getRows('SELECT `mac` FROM `mac-auth` WHERE `code` = 1 AND `updated` &lt; DATE_SUB(NOW(),INTERVAL '.$interval .')'); if (!empty($macs)){ $data = sql_getColumn('SELECT DISTINCT(`ip`) as `ip`,`mac` FROM `mac-ip` WHERE `mac` IN ("'.implode('","',$macs).'") ORDER BY `date` DESC','mac'); foreach ($data as $mac=&gt;$ip){ sql_query('UPDATE `mac-auth` SET `code` = "0" WHERE `mac` IN ("'.implode('","',$macs).'")'); //    shell_exec('sudo ipset -D authorized '.$ip .','.$mac); //    ip shell_exec('sudo conntrack -D conntrack --orig-src '.$ip); } shell_exec('sudo ipset save &gt; /etc/iptables/ipset.rules'); } echo $phone.'-'.$code; $mac = sql_getValue('SELECT `mac` FROM `mac-auth` WHERE `code` = '.$code); if ($mac){ $ip = sql_getValue('SELECT DISTINCT(`ip`) FROM `mac-ip` WHERE `mac` = "'.$mac.'" ORDER BY `date` DESC'); echo '-'.$mac.'-'.$ip; //       sql_query('INSERT `mac-phone` (`mac`,`phone`) VALUES("'.$mac.'","'.$phone.'")'); sql_query('UPDATE `mac-auth` SET `phone` = "'.$phone.'", `code` = "1" WHERE `mac` = "'.$mac.'"'); //    shell_exec('sudo ipset -A authorized '.$ip .','.$mac); shell_exec('sudo ipset save &gt; /etc/iptables/ipset.rules'); shell_exec('sudo conntrack -D conntrack --orig-src '.$ip); } //  unlink($sms_file); ?&gt;</span></span></code> </pre> <br><pre> <code class="bash hljs">nano /var/www/hotspot/index.php</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//     require_once 'connect.php'; // ip  $ip = ''; if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])){ $ip = $_SERVER['HTTP_X_FORWARDED_FOR']; } if (empty($ip)) $ip = $_SERVER['REMOTE_ADDR']; //  ip  if (!preg_match('/^10\.0\.8[0-7]\.\d{1,3}$/', $ip)) { $ip = false; } //   if ($ip) $mac = trim(shell_exec("arp -a ".$ip." | awk '{print $4}'")); if (!isset($mac) || $mac == "entries") $mac = false; //      $url = $_GET['url']; //if (strpos($url, 'gstatic.com')!==false) $url = 'http://www.domain.ru'; //   header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1 header("Expires: Sat, 26 Jul 1997 05:00:00 GMT"); //    //   $error = false; if (!$mac){ $error = '    . &lt;br/&gt;      .&lt;br/&gt;&lt;font class="eng error"&gt;Error with your network card. Internet access can not be granted&lt;/font&gt;'; } else { //,    ip    $base_ip = sql_getValue('SELECT DISTINCT(`ip`) FROM `mac-ip` WHERE `mac` = "'.$mac.'" ORDER BY `date` DESC'); if ($base_ip != $ip){ sql_query('INSERT INTO `mac-ip` (`mac`,`ip`) VALUES ("'.$mac.'","'.$ip.'")'); } //    $code = sql_getValue('SELECT `code` FROM `mac-auth` WHERE `mac` = "'.$mac.'"'); switch ($code){ case '1': //  shell_exec('sudo ipset -A authorized '.$ip .','.$mac); shell_exec('sudo ipset save &gt; /etc/iptables/ipset.rules'); //    ip,  TOO_MANY_REDIRECTS shell_exec('sudo conntrack -D conntrack --orig-src '.$ip); header('Location: '.$url); die; break; case '': //  sql_query('INSERT INTO `mac-auth` (`mac`,`code`) VALUES ("'.$mac.'",0)'); case '0': //       //  do { $code = rand(10000,99999); } while(sql_getValue('SELECT `mac` FROM `mac-auth` WHERE `code` = "'.$code.'"')); sql_query('UPDATE `mac-auth` SET `code` = '.$code.' WHERE `mac` = "'.$mac.'"'); default: //  ,     break; } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;!DOCTYPE HTML&gt; &lt;html&gt; &lt;head&gt; &lt;title&gt;&lt;/title&gt; &lt;meta http-equiv="Content-Type" content="text/html; charset=windows-1251"&gt; &lt;meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=1" /&gt; &lt;/head&gt; &lt;body&gt; &lt;style type="text/css"&gt; html, body { width: auto; margin: 0px; padding: 0px; } * { font-family: "Tahoma", sans-serif; font-size: 14px; text-align:center; font-style: normal; font-variant: normal; font-weight: normal; color: #000; } .center { width: 400px; padding: 10px; margin: auto; } .logo { background-image: url("/logo2.gif"); width: 177px; height: 209px; margin: auto; } .header { font-size: 16px; padding: 10px; } .repeat { padding: 10px; } .sms { font-size: 11px; color: #4c4b4b; padding: 10px; } .law { font-size: 11px; color: #4c4b4b; padding: 10px; } .code { font-size: 16px; font-weight: bold; } .num { font-size: 16px; font-weight: bold; } .internet-disabled { background-color: #dadbdb; color: white; padding: 7px 20px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; border: 2px solid #ffffff; border-radius: 4px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19); } .internet { background-color: #3e315f; color: white; padding: 7px 20px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; border: 2px solid #ffffff; border-radius: 4px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19); } .internet:hover { background-color: #ffffff; color: #3e315f; border: 2px solid #3e315f; box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24), 0 17px 50px 0 rgba(0,0,0,0.19); } .eng { font-size: 12px; line-height: 12px; } .error { color: #d11313; } &lt;/style&gt; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> if (!$error) {</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;script type="text/javascript"&gt; window.onload = function(){ window.htime = 60; check = function(){ if (window.htime &lt;=0 ) { return true; } else { return false; } } window.htimer = window.setInterval(function(){ document.getElementById('button').innerHTML = ' ' + window.htime + ' .'; window.htime -= 1; if (window.htime &lt;= 0) { window.clearInterval(window.htimer); document.getElementById('button').className = "internet"; document.getElementById('button').innerHTML = '  '; } }, 1000); } &lt;/script&gt; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;div class="center"&gt; &lt;div class="logo"&gt;&lt;/div&gt; &lt;div class="header"&gt;     &lt;br/&gt;   . &lt;font class="eng"&gt;Welcome to the open network of the Civic Chamber of the Russian Federation.&lt;/font&gt;&lt;/div&gt; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> if ($error) { echo '&lt;div class="error"&gt;'.$error.'&lt;/div&gt;';} else { </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;div&gt;        SMS  : &lt;font class="code"&gt;</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $code;</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">&lt;/font&gt;  : &lt;font class="num"&gt;+7 917 XXX-XX-XX.&lt;/font&gt;&lt;br/&gt;&lt;font class="eng"&gt;To access Internet, text this code &lt;b&gt;</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $code;</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">&lt;/b&gt; to number &lt;b&gt;+7 917 XXX-XX-XX.&lt;/b&gt;&lt;/font&gt;&lt;/div&gt; &lt;div class="repeat"&gt;  SMS   : &lt;br/&gt;&lt;font class="eng"&gt;After you've sent SMS with code, please click this button:&lt;/font&gt;&lt;/div&gt; &lt;a target="_self" href="</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> echo $url;</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">" id="button" class="internet-disabled" onclick="return check();"&gt; &lt;/a&gt; &lt;div class="repeat"&gt;    SMS    . ,   .&lt;br/&gt;&lt;font class="eng"&gt;Please allow a minor delay in providing you access ‚Äî delivery and processing of your SMS might take a few moments. Thank you for your patience.&lt;/font&gt;&lt;/div&gt; &lt;div class="sms"&gt; SMS-     .&lt;br/&gt;Cost of SMS-messages is charged according to your tariff plan.&lt;/div&gt; &lt;div class="law"&gt;   ‚Ññ758  31  2014.  ‚Ññ801  12  2014 . -   WIFI     .&lt;br/&gt;We require our WiFi users to authenticate following the provisions of the Russian law, stated by enactments 758 of 31st July 2014 and 801 of 12th August 2014. &lt;/div&gt; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment"> &lt;/div&gt; &lt;/body&gt; &lt;/html&gt;</span></span></code> </pre><br><pre> <code class="bash hljs">nano /var/www/hotspot/connect.php</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># mysql login params $mysql_host = ''; $mysql_db = ''; $mysql_login = ''; $mysql_password = ''; $sql_link = mysqli_connect($mysql_host, $mysql_login, $mysql_password, $mysql_db) or die(mysql_error()); function sql_query($sql, $unbuffered = false){ global $sql_link; $resource = $unbuffered ? mysqli_real_query($sql_link, $sql) : mysqli_query($sql_link, $sql); if (mysqli_errno($sql_link) === 1016) { if (preg_match("/'(\S*)\.MYD'\. \(errno\: 145\)/", mysqli_error($sql_link), $m)) { mysqli_unbuffered_query("REPAIR TABLE ".$m[1]); $resource = $unbuffered ? mysqli_unbuffered_query($sql_link, $sql) : mysqli_query($sql_link, $sql); } } return $resource; } function sql_getValue($sql, $unbuffered = false){ $resource = sql_query($sql, $unbuffered); $ret = false; if (is_resource($resource) || is_object($resource)) { $row = mysqli_fetch_row($resource); $ret = $row[0]; } return $ret; } function sql_getRows($sql, $use_key = false, $unbuffered = false){ $resource = sql_query($sql, $unbuffered); $ret = false; if (is_resource($resource) || is_object($resource)) { $row = true; while ($row) { $row = mysqli_fetch_array($resource, MYSQLI_ASSOC); if (!$row) continue; $_row = $row; if ($use_key) { if (isset($_row[$use_key])) { $link = &amp;$ret[$_row[$use_key]]; $link = $_row; } } else { $link = &amp;$ret[]; $link = (count($_row) == 1) ? array_shift($_row) : $_row; } } } return $ret; } function sql_getColumn($sql, $id_field = 'id', $unbuffered = false){ $resource = sql_query($sql, $unbuffered); $ret = false; if (is_resource($resource) || is_object($resource)) { $row = true; while ($row) { $row = mysqli_fetch_array($resource, MYSQLI_ASSOC); if (!$row) continue; $_row = $row; $id = $_row[$id_field]; unset($_row[$id_field]); $value = current($_row); $ret[$id] = $value; } } return $ret; } function sql_getRow($sql, $unbuffered = false){ $resource = sql_query($sql, $unbuffered); $ret = false; if (is_resource($resource) || is_object($resource)) { $ret = mysqli_fetch_assoc($resource); } return $ret; }</span></span></code> </pre><br>   ,   sudoers    iptables  php <br><br><pre> <code class="bash hljs">nano /etc/sudoers smsd ALL=(ALL) NOPASSWD: /sbin/ipset smsd ALL=(ALL) NOPASSWD: /sbin/iptables www-data ALL=(ALL) NOPASSWD: /sbin/ipset www-data ALL=(ALL) NOPASSWD: /sbin/iptables smsd ALL=(ALL) NOPASSWD: /usr/sbin/conntrack www-data ALL=(ALL) NOPASSWD: /usr/sbin/conntrack</code> </pre><br>    .     ,  .  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/307338/">https://habr.com/ru/post/307338/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307328/index.html">Systematization of publications in the web. Part 3 of 3: Strategy placement of scientific publications</a></li>
<li><a href="../307330/index.html">How to hire programmers. Interview with Katerina Gavrilova from DigitalHR</a></li>
<li><a href="../307332/index.html">Code samples from the summer school on Node.js and JavaScript in KPI</a></li>
<li><a href="../307334/index.html">Threejs editor</a></li>
<li><a href="../307336/index.html">Physicists from the Delft University of Technology have created an atomic data warehouse</a></li>
<li><a href="../307340/index.html">We control the computer through a browser</a></li>
<li><a href="../307342/index.html">Kerio Control 9.1 opens up new next-generation firewall (NGFW) capabilities for SMB companies</a></li>
<li><a href="../307344/index.html">Ecosystem support. Automate user registration with Golang</a></li>
<li><a href="../307346/index.html">CodeRush for Roslyn: Part 3 - an overview of the possibilities for learning code</a></li>
<li><a href="../307348/index.html">How to gain courage and open a store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>