<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another virtual interface</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article , a sketch of the code of the Linux kernel module was shown to create an additional virtual network interface. It was a simpli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another virtual interface</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/company/ua-hosting/blog/269987/">previous article</a> , a sketch of the code of the Linux kernel module was shown to create an additional virtual network interface.  It was a simplified fragment <b>of a real project</b> that had worked for several years without failures and reclamations, so that it could well serve as a template for further improvement, correction and development. <br><br>  But such an approach to implementation is, firstly, not the only one, and, secondly, in some situations it may be unacceptable (for example, in an embedded system with a kernel under 2.6.36, where there is no netdev_rx_handler_register () call yet).  Below we will consider an alternative with the same functionality, but implementing it on a completely different layer of the TCP / IP network stack. <br><a name="habracut"></a><br><h1>  Network layer protocols </h1><br>  Quite a lot, not to repeat, it is written that the levels (layers) of the TCP / IP network stack do not clearly correspond to 7 levels of the OSI / ISO open systems interaction model (or, to be honest, the OSI model, which is close to the heart of academia, inadequate real-life TCP / IP network).  The creation of a virtual interface, <a href="http://habrahabr.ru/company/ua-hosting/blog/269987/">in the previous implementation discussed</a> , was performed at the <b>interface</b> level (L2, Level 2 - very roughly corresponding to the OSI link level).  The current implementation leverages the capabilities of the <b>network</b> layer (L3). <br><br>  It is advisable to consider a certain minimum in relation to the network layer facilities, in the volume even slightly wider than necessary for the current task, for the possibilities of its subsequent expansion.  At the network level of the network protocol stack (TCP / IP, but not only - all other protocol families are supported here, but today they seem to be of little relevance) <b>processing of</b> such protocols as IP / IPv4 / IPv6, IPX, IGMP, RIP, OSPF, ARP, or <b>add</b> original user protocols.  To install the network layer handlers, the network layer API is provided (&lt;linux / netdevice.h&gt;): <br><pre><code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet_type</span></span></span></span> { __be16 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* This is really htons(ether_type). */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">net_device</span></span></span></span> *dev; <span class="hljs-comment"><span class="hljs-comment">/* NULL is wildcarded here */</span></span> int (*func) (<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sk_buff</span></span></span></span>*, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">net_device</span></span></span></span>*, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet_type</span></span></span></span>*, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">net_device</span></span></span></span>*); ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list_head</span></span></span></span> list; }; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> void dev_add_pack( <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet_type</span></span></span></span> *pt ); <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> void dev_remove_pack( <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet_type</span></span></span></span> *pt );</code> </pre> <br>  In fact, in the core protocol modules we need to <b>add a filter</b> through which the socket buffers from the <b>incoming</b> interface stream pass (the outgoing stream is simpler, as was shown in the previous implementation).  The dev_add_pack () function adds another new handler for packages of a given type, implemented by the func () function.  The function <b>adds but does not replace the</b> existing handler (including the default handler of the Linux network system).  Socket buffers that satisfy the criteria laid down in the struct packet_type structure (according to the protocol type and the dev network interface) are selected (fall into the function) for processing into the function. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Note:</b> In the same way (installation of the filter function), new protocols are added and at the higher <b>transport</b> layer of the network stack (on which, for example, UDP, TCP, SCTP protocols are processed).  All higher levels (more or less similar to OSI model levels) are not represented in the kernel, and are serviced in user space by BSD socket programming techniques.  But all those related to higher levels, the details will no longer be considered in the text. <br><br>  If we would like to <b>add a</b> new protocol (proprietary), we would have to override its type: <br><pre> <code class="hljs swift">#define <span class="hljs-type"><span class="hljs-type">PROTO_ID</span></span> <span class="hljs-number"><span class="hljs-number">0x1234</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet_type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">test_proto</span></span></span><span class="hljs-class"> = </span></span>{ __constant_htons( <span class="hljs-type"><span class="hljs-type">PROT_ID</span></span> ), ... }</code> </pre><br>  The problem with this would be that the standard IP stack does not know such a protocol, and we will have to assume all of its processing.  But our goal is only to <b>override the</b> processing of some packets, then for this we use the constant ETH_P_ALL, indicating that all protocols must pass through the filter (and if the dev field is NULL, then all network interfaces). <br><br>  For comparison and concretization, we find a large number of protocol identifiers (Ethernet Protocol ID's) in &lt;linux / if_ether.h&gt;, here are some of them, for example: <br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ETH_P_LOOP 0x0060 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Ethernet Loopback packet */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ETH_P_IP 0x0800 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Internet Protocol packet */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ETH_P_ARP 0x0806 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Address Resolution packet */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ETH_P_PAE 0x888E </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Port Access Entity (IEEE 802.1X) */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ETH_P_ALL 0x0003 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Every packet (be careful!!!) */</span></span></span><span class="hljs-meta"> ...</span></span></code> </pre><br>  In this case, the type field is not an abstract numeric value in the program code, this value in binary form will be entered in the Ethernet header of the frame that is physically sent to the propagation medium: <br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ethhdr</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> h_dest[ETH_ALEN]; <span class="hljs-comment"><span class="hljs-comment">/* destination eth addr */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> h_source[ETH_ALEN]; <span class="hljs-comment"><span class="hljs-comment">/* source ether addr */</span></span> __be16 h_proto; <span class="hljs-comment"><span class="hljs-comment">/* packet type ID field */</span></span> } __attribute__((packed));</code> </pre><br>  (We will need the same description in the code when filling in the struct packet_type structure in the module). <br><br>  The filter function itself (the func field), which we still have to write, perhaps in the simplest form, is something like this: <br><pre> <code class="hljs rust">int test_pack_rcv( <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sk_buff</span></span></span></span> *skb, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">net_device</span></span></span></span> *dev, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet_type</span></span></span></span> *pt, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">net_device</span></span></span></span> *odev ) { LOG( <span class="hljs-string"><span class="hljs-string">"packet received with length: %u\n"</span></span>, skb-&gt;len ); kfree_skb( skb ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> skb-&gt;len; };</code> </pre><br>  The function is shown here mainly because of the <b>obligatory</b> call to kfree_skb ().  He, in contrast to the seemingly close dev_kfree_skb () in the transmission channel, <b>does not destroy the</b> socket buffer, but only decrements its usage counter (users field).  When installing each additional protocol filter by calling dev_add_pack (), this field of socket buffers will be incremented.  You can install several network level filters (in the same or several loadable modules) and they will work <b>all</b> right in the reverse way of installing them, but each of them must execute kfree_skb ().  Otherwise, you will have a slow but steady memory leak in the network stack, so its result, like a system crash, will be detected only after a few hours of continuous operation. <br><br>  This is quite an interesting and not obvious place, so much so that it makes sense to digress and see the source code for the implementation of kfree_skb () (file net / core / skbuff.c): <br><pre> <code class="hljs rust">void kfree_skb(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sk_buff</span></span></span></span> *skb) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(!skb)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (likely(atomic_read(&amp;skb-&gt;users) == <span class="hljs-number"><span class="hljs-number">1</span></span>)) smp_rmb(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (likely(!atomic_dec_and_test(&amp;skb-&gt;users))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; trace_kfree_skb(skb, __builtin_return_address(<span class="hljs-number"><span class="hljs-number">0</span></span>)); __kfree_skb(skb); }</code> </pre><br>  Calling kfree_skb () will actually free the socket buffer only in the case of skb-&gt; users == 1, for all other values ‚Äã‚Äãit will only decrement skb-&gt; users (usage counter). <br><br>  Now we have enough details to organize the work of the virtual interface, but using, at this time, the network layer of the IP stack. <br><br><h1>  Virtual Interface Module </h1><br>  We proceed as <a href="http://habrahabr.ru/company/ua-hosting/blog/269987/">before</a> : create two module variants ‚Äî a simplified version of virtl.ko, whose network interface (virt0) <b>replaces the</b> parent network interface, and the full version virt.ko, which analyzes network protocol frames (ARP and IP4) and affects only that traffic. which its interface refers to.  The difference is that during the load of the simplified module, the work of the parent interface is temporarily stopped (until the module virtl.ko is unloaded), and when loading the full version both interfaces can work in parallel and independently.  The code of the full module is noticeably more cumbersome, and it adds nothing to an understanding of the principles.  Further, a simplified version showing the principles is considered in detail, and only later we will minimally touch the full version (its code and test protocol are given in the archive of examples): <br><div class="spoiler">  <b class="spoiler_title">the code is quite long here</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">#include &lt;linux/module.h&gt; #include &lt;linux/version.h&gt; #include &lt;linux/netdevice.h&gt; #include &lt;linux/etherdevice.h&gt; #include &lt;linux/inetdevice.h&gt; #include &lt;linux/moduleparam.h&gt; #include &lt;net/arp.h&gt; #include &lt;linux/ip.h&gt; #define ERR(...) printk( KERN_ERR <span class="hljs-string"><span class="hljs-string">"! "</span></span>__VA_ARGS__ ) #define LOG(...) printk( KERN_INFO <span class="hljs-string"><span class="hljs-string">"! "</span></span>__VA_ARGS__ ) #define DBG(...) if( debug != <span class="hljs-number"><span class="hljs-number">0</span></span> ) printk( KERN_INFO <span class="hljs-string"><span class="hljs-string">"! "</span></span>__VA_ARGS__ ) static char* link = <span class="hljs-string"><span class="hljs-string">"eth0"</span></span>; module_param( link, charp, <span class="hljs-number"><span class="hljs-number">0</span></span> ); static char* ifname = <span class="hljs-string"><span class="hljs-string">"virt"</span></span>; module_param( ifname, charp, <span class="hljs-number"><span class="hljs-number">0</span></span> ); static int debug = <span class="hljs-number"><span class="hljs-number">0</span></span>; module_param( debug, int, <span class="hljs-number"><span class="hljs-number">0</span></span> ); static struct net_device *child = NULL; static struct net_device_stats stats; //     static u32 child_ip; struct priv { struct net_device *parent; }; static char* strIP( u32 addr ) { //  IP    static char saddr[ MAX_ADDR_LEN ]; sprintf( saddr, <span class="hljs-string"><span class="hljs-string">"%d.%d.%d.%d"</span></span>, ( addr ) &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>xFF, ( addr &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span> ) &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>xFF, ( addr &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span> ) &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>xFF, ( addr &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span> ) &amp; <span class="hljs-number"><span class="hljs-number">0</span></span>xFF ); return saddr; } static int open( struct net_device *dev ) { struct in_device *in_dev = dev-&gt;ip_ptr; struct in_ifaddr *ifa = in_dev-&gt;ifa_list; /* IP ifaddr chain */ LOG( <span class="hljs-string"><span class="hljs-string">"%s: device opened"</span></span>, dev-&gt;name ); child_ip = ifa-&gt;ifa_address; netif_start_queue( dev ); if( debug != <span class="hljs-number"><span class="hljs-number">0</span></span> ) { char sdebg[ <span class="hljs-number"><span class="hljs-number">40</span></span> ] = <span class="hljs-string"><span class="hljs-string">""</span></span>; sprintf( sdebg, <span class="hljs-string"><span class="hljs-string">"%s:"</span></span>, strIP( ifa-&gt;ifa_address ) ); strcat( sdebg, strIP( ifa-&gt;ifa_mask ) ); DBG( <span class="hljs-string"><span class="hljs-string">"%s: %s"</span></span>, dev-&gt;name, sdebg ); } return <span class="hljs-number"><span class="hljs-number">0</span></span>; } static int stop( struct net_device *dev ) { LOG( <span class="hljs-string"><span class="hljs-string">"%s: device closed"</span></span>, dev-&gt;name ); netif_stop_queue( dev ); return <span class="hljs-number"><span class="hljs-number">0</span></span>; } static struct net_device_stats *get_stats( struct net_device *dev ) { return &amp;stats; } //   static netdev_tx_t start_xmit( struct sk_buff *skb, struct net_device *dev ) { struct priv *priv = netdev_priv( dev ); stats.tx_packets++; stats.tx_bytes += skb-&gt;len; skb-&gt;dev = priv-&gt;parent; //    ()  skb-&gt;priority = <span class="hljs-number"><span class="hljs-number">1</span></span>; dev_queue_xmit( skb ); DBG( <span class="hljs-string"><span class="hljs-string">"tx: injecting frame from %s to %s with length: %u"</span></span>, dev-&gt;name, skb-&gt;dev-&gt;name, skb-&gt;len ); return <span class="hljs-number"><span class="hljs-number">0</span></span>; return NETDEV_TX_OK; } static struct net_device_ops net_device_ops = { .ndo_open = open, .ndo_stop = stop, .ndo_get_stats = get_stats, .ndo_start_xmit = start_xmit, }; //   int pack_parent( struct sk_buff *skb, struct net_device *dev, struct packet_type *pt, struct net_device *odev ) { skb-&gt;dev = child; //      stats.rx_packets++; stats.rx_bytes += skb-&gt;len; DBG( <span class="hljs-string"><span class="hljs-string">"tx: injecting frame from %s to %s with length: %u"</span></span>, dev-&gt;name, skb-&gt;dev-&gt;name, skb-&gt;len ); kfree_skb( skb ); return skb-&gt;len; }; static struct packet_type proto_parent = { __constant_htons( ETH_P_ALL ), //   : ETH_P_ARP &amp; ETH_P_IP NULL, pack_parent, (void*)<span class="hljs-number"><span class="hljs-number">1</span></span>, NULL }; int __init init( void ) { void setup( struct net_device *dev ) { //   ( GCC) int j; ether_setup( dev ); memset( netdev_priv( dev ), <span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof( struct priv ) ); dev-&gt;netdev_ops = &amp;net_device_ops; for( j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; ETH_ALEN; ++j ) //  MAC   dev-&gt;dev_addr[ j ] = (char)j; } int err = <span class="hljs-number"><span class="hljs-number">0</span></span>; struct priv *priv; char ifstr[ <span class="hljs-number"><span class="hljs-number">40</span></span> ]; sprintf( ifstr, <span class="hljs-string"><span class="hljs-string">"%s%s"</span></span>, ifname, <span class="hljs-string"><span class="hljs-string">"%d"</span></span> ); #if (LINUX_VERSION_CODE &lt; KERNEL_VERSION(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)) child = alloc_netdev( sizeof( struct priv ), ifstr, setup ); #else child = alloc_netdev( sizeof( struct priv ), ifstr, NET_NAME_UNKNOWN, setup ); #endif if( child == NULL ) { ERR( <span class="hljs-string"><span class="hljs-string">"%s: allocate error"</span></span>, THIS_MODULE-&gt;name ); return -ENOMEM; } priv = netdev_priv( child ); priv-&gt;parent = dev_get_by_name( &amp;init_net, link ); //   if( !priv-&gt;parent ) { ERR( <span class="hljs-string"><span class="hljs-string">"%s: no such net: %s"</span></span>, THIS_MODULE-&gt;name, link ); err = -ENODEV; goto err; } if( priv-&gt;parent-&gt;type != ARPHRD_ETHER &amp;&amp; priv-&gt;parent-&gt;type != ARPHRD_LOOPBACK ) { ERR( <span class="hljs-string"><span class="hljs-string">"%s: illegal net type"</span></span>, THIS_MODULE-&gt;name ); err = -EINVAL; goto err; } memcpy( child-&gt;dev_addr, priv-&gt;parent-&gt;dev_addr, ETH_ALEN ); memcpy( child-&gt;broadcast, priv-&gt;parent-&gt;broadcast, ETH_ALEN ); if( ( err = dev_alloc_name( child, child-&gt;name ) ) ) { ERR( <span class="hljs-string"><span class="hljs-string">"%s: allocate name, error %i"</span></span>, THIS_MODULE-&gt;name, err ); err = -EIO; goto err; } register_netdev( child ); //    proto_parent.dev = priv-&gt;parent; dev_add_pack( &amp;proto_parent ); //      LOG( <span class="hljs-string"><span class="hljs-string">"module %s loaded"</span></span>, THIS_MODULE-&gt;name ); LOG( <span class="hljs-string"><span class="hljs-string">"%s: create link %s"</span></span>, THIS_MODULE-&gt;name, child-&gt;name ); return <span class="hljs-number"><span class="hljs-number">0</span></span>; err: free_netdev( child ); return err; } void __exit virt_exit( void ) { struct priv *priv= netdev_priv( child ); dev_remove_pack( &amp;proto_parent ); //    unregister_netdev( child ); dev_put( priv-&gt;parent ); free_netdev( child ); LOG( <span class="hljs-string"><span class="hljs-string">"module %s unloaded"</span></span>, THIS_MODULE-&gt;name ); LOG( <span class="hljs-string"><span class="hljs-string">"============================================="</span></span> ); } module_init( init ); module_exit( virt_exit ); MODULE_AUTHOR( <span class="hljs-string"><span class="hljs-string">"Oleg Tsiliuric"</span></span> ); MODULE_LICENSE( <span class="hljs-string"><span class="hljs-string">"GPL v2"</span></span> ); MODULE_VERSION( <span class="hljs-string"><span class="hljs-string">"3.7"</span></span> );</code> </pre><br></div></div><br>  Everything is quite transparent: <br><ul><li>  After registering a new network interface (virt0), it makes a call to dev_add_pack (), which sets a filter of received packets for the parent interface; </li><li>  The dev field on the parent interface pointer is pre-installed in the packet_type structure: only from this interface will incoming traffic be intercepted by the function pack_parent () defined in the structure; </li><li>  This function captures the statistics of the interface and, most importantly, replaces the pointer of the parent interface to the virtual one in the socket buffer. </li><li>  Reverse substitution (virtual to physical) occurs in the send frame start_xmit () function. </li></ul><br>  Here's how it works: <br><ul><li>  On the tested computer, we load the module and configure it on a separate new subnet: <br><pre> <code class="dos hljs">$ ip address ... <span class="hljs-number"><span class="hljs-number">2</span></span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number"><span class="hljs-number">1500</span></span> qdisc pfifo_fast state UP qlen <span class="hljs-number"><span class="hljs-number">1000</span></span> link/ether <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span>:b9:e0 brd ff:ff:ff:ff:ff:ff inet <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">21</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> brd <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">255</span></span> scope global eth0 inet6 fe80::a00:<span class="hljs-number"><span class="hljs-number">27</span></span>ff:fe52:b9e0/<span class="hljs-number"><span class="hljs-number">64</span></span> scope link valid_lft forever preferred_lft forever <span class="hljs-number"><span class="hljs-number">3</span></span>: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number"><span class="hljs-number">1500</span></span> qdisc pfifo_fast state UP qlen <span class="hljs-number"><span class="hljs-number">1000</span></span> link/ether <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>d brd ff:ff:ff:ff:ff:ff inet <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">56</span></span>.<span class="hljs-number"><span class="hljs-number">102</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> brd <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">56</span></span>.<span class="hljs-number"><span class="hljs-number">255</span></span> scope global eth1 inet6 fe80::a00:<span class="hljs-number"><span class="hljs-number">27</span></span>ff:fe0f:<span class="hljs-number"><span class="hljs-number">136</span></span>d/<span class="hljs-number"><span class="hljs-number">64</span></span> scope link valid_lft forever preferred_lft forever $ sudo insmod virt.ko link=eth1 debug=<span class="hljs-number"><span class="hljs-number">1</span></span> $ sudo ifconfig virt0 <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span> $ sudo ifconfig virt0 virt0 Link encap:Ethernet HWaddr <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>d inet addr:<span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span> Bcast:<span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">255</span></span> Mask:<span class="hljs-number"><span class="hljs-number">255</span></span>.<span class="hljs-number"><span class="hljs-number">255</span></span>.<span class="hljs-number"><span class="hljs-number">255</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> inet6 addr: fe80::a00:<span class="hljs-number"><span class="hljs-number">27</span></span>ff:fe0f:<span class="hljs-number"><span class="hljs-number">136</span></span>d/<span class="hljs-number"><span class="hljs-number">64</span></span> Scope:Link UP BROADCAST RUNNING MULTICAST MTU:<span class="hljs-number"><span class="hljs-number">1500</span></span> Metric:<span class="hljs-number"><span class="hljs-number">1</span></span> RX packets:<span class="hljs-number"><span class="hljs-number">0</span></span> errors:<span class="hljs-number"><span class="hljs-number">0</span></span> dropped:<span class="hljs-number"><span class="hljs-number">0</span></span> overruns:<span class="hljs-number"><span class="hljs-number">0</span></span> frame:<span class="hljs-number"><span class="hljs-number">0</span></span> TX packets:<span class="hljs-number"><span class="hljs-number">46</span></span> errors:<span class="hljs-number"><span class="hljs-number">0</span></span> dropped:<span class="hljs-number"><span class="hljs-number">0</span></span> overruns:<span class="hljs-number"><span class="hljs-number">0</span></span> carrier:<span class="hljs-number"><span class="hljs-number">0</span></span> collisions:<span class="hljs-number"><span class="hljs-number">0</span></span> txqueuelen:<span class="hljs-number"><span class="hljs-number">1000</span></span> RX bytes:<span class="hljs-number"><span class="hljs-number">0</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> B) TX bytes:<span class="hljs-number"><span class="hljs-number">8373</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> KiB)</code> </pre><br>  (This shows statistics with zero number of bytes received on the interface). </li><li>  On the computer from which we are testing, we create an alias IP for the new subnet (192.168.50.0/24) and can carry traffic to the created interface: <br><pre> <code class="dos hljs">$ sudo ifconfig vboxnet0:<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> $ <span class="hljs-built_in"><span class="hljs-built_in">ping</span></span> <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-built_in"><span class="hljs-built_in">PING</span></span> <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span> (<span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>) <span class="hljs-number"><span class="hljs-number">56</span></span>(<span class="hljs-number"><span class="hljs-number">84</span></span>) bytes of data. <span class="hljs-number"><span class="hljs-number">64</span></span> bytes from <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>: icmp_req=<span class="hljs-number"><span class="hljs-number">1</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">627</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes from <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>: icmp_req=<span class="hljs-number"><span class="hljs-number">2</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">305</span></span> ms <span class="hljs-number"><span class="hljs-number">64</span></span> bytes from <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>: icmp_req=<span class="hljs-number"><span class="hljs-number">3</span></span> ttl=<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">326</span></span> ms ^C --- <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ping</span></span> statistics --- <span class="hljs-number"><span class="hljs-number">3</span></span> packets transmitted, <span class="hljs-number"><span class="hljs-number">3</span></span> received, <span class="hljs-number"><span class="hljs-number">0</span></span>% packet loss, <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>ms rtt min/avg/max/mdev = <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">305</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">419</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">627</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">148</span></span> ms</code> </pre></li><li>  On the same (testing) computer (counterpart), it is very informative to observe traffic (in a separate terminal) recorded by tcpdump: <br><pre> <code class="dos hljs">$ sudo tcpdump -i vboxnet0 tcpdump: verbose output suppressed, use -v or -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> full protocol decode listening on vboxnet0, link-<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> EN10MB (Ethernet), capture size <span class="hljs-number"><span class="hljs-number">65535</span></span> bytes ... <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>.<span class="hljs-number"><span class="hljs-number">740607</span></span> ARP, Request who-has <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span> tell <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>, length <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>.<span class="hljs-number"><span class="hljs-number">741104</span></span> ARP, Reply <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span> is-<span class="hljs-built_in"><span class="hljs-built_in">at</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>f:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">6</span></span>d (oui Unknown), length <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>.<span class="hljs-number"><span class="hljs-number">741116</span></span> IP <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>: ICMP <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> request, id <span class="hljs-number"><span class="hljs-number">8402</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, length <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>.<span class="hljs-number"><span class="hljs-number">741211</span></span> IP <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>: ICMP <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> reply, id <span class="hljs-number"><span class="hljs-number">8402</span></span>, seq <span class="hljs-number"><span class="hljs-number">1</span></span>, length <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>.<span class="hljs-number"><span class="hljs-number">741164</span></span> IP <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>: ICMP <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> request, id <span class="hljs-number"><span class="hljs-number">8402</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, length <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>.<span class="hljs-number"><span class="hljs-number">741451</span></span> IP <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>: ICMP <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> reply, id <span class="hljs-number"><span class="hljs-number">8402</span></span>, seq <span class="hljs-number"><span class="hljs-number">2</span></span>, length <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>.<span class="hljs-number"><span class="hljs-number">741163</span></span> IP <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>: ICMP <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> request, id <span class="hljs-number"><span class="hljs-number">8402</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, length <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>.<span class="hljs-number"><span class="hljs-number">741471</span></span> IP <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span> &gt; <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>: ICMP <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> reply, id <span class="hljs-number"><span class="hljs-number">8402</span></span>, seq <span class="hljs-number"><span class="hljs-number">3</span></span>, length <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>.<span class="hljs-number"><span class="hljs-number">747701</span></span> ARP, Request who-has <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> tell <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>, length <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>.<span class="hljs-number"><span class="hljs-number">747715</span></span> ARP, Reply <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> is-<span class="hljs-built_in"><span class="hljs-built_in">at</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>a:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> (oui Unknown), length <span class="hljs-number"><span class="hljs-number">28</span></span></code> </pre></li></ul><br><br><h1>  Expanding opportunities </h1><br>  Now, briefly, in two words, on how to make a full-fledged virtual interface that works only with its own traffic and does not disrupt the operation of the parent interface (what the full version of the module does in the archive).  For this you need: <br><br><ul><li>  Declare <b>two separate</b> protocol handlers (for ARP name resolution protocols and for IP protocol itself): <br><pre> <code class="hljs perl">//   ETH_P_ARP <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arp_pack_rcv( struct sk_buff *skb, struct net_device *dev, struct packet_type *pt, struct net_device *odev ) { ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> skb-&gt;len; }; static struct packet_type arp_proto = { __constant_htons( ETH_P_ARP ), NULL, arp_pack_rcv, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ETH_P_ARP (void*)<span class="hljs-number"><span class="hljs-number">1</span></span>, NULL }; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ETH_P_IP <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ip4_pack_rcv( struct sk_buff *skb, struct net_device *dev, struct packet_type *pt, struct net_device *odev ) { ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> skb-&gt;len; }; static struct packet_type ip4_proto = { __constant_htons( ETH_P_IP ), NULL, ip4_pack_rcv, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ETH_P_IP (void*)<span class="hljs-number"><span class="hljs-number">1</span></span>, NULL };</code> </pre></li><li>  Both register them sequentially in the module initialization function: <br><pre> <code class="hljs rust"> arp_proto.dev = ip4_proto.dev = <span class="hljs-keyword"><span class="hljs-keyword">priv</span></span>-&gt;parent; <span class="hljs-comment"><span class="hljs-comment">//      dev_add_pack( &amp;arp_proto ); dev_add_pack( &amp;ip4_proto );</span></span></code> </pre><br></li><li>  Each of the installed filters should <b>replace the</b> interface only for those frames whose IP of the recipient matches the IP of the interface ... </li><li>  Two separate handlers are convenient in that the headers of the ARP and IP frames have a completely different format, and it is necessary to allocate IP assignments in them in different ways (all the full code is shown in the archive of the example). </li></ul><br>  Using such a full-fledged module, you can open to the host, for example, two parallel SSH sessions on different interfaces (using different IP), which will in parallel actually use a single common physical interface: <br><pre> <code class="dos hljs">$ ssh olej@<span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span> olej@<span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">17</span></span>'s password: Last login: Mon Jul <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span> from <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">9</span></span> ... $ ssh olej@<span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">56</span></span>.<span class="hljs-number"><span class="hljs-number">101</span></span> olej@<span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">56</span></span>.<span class="hljs-number"><span class="hljs-number">101</span></span>'s password: Last login: Mon Jul <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span> from <span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> ... $ who olej tty1 <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span> (:<span class="hljs-number"><span class="hljs-number">0</span></span>) olej pts/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span> (:<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>) ... olej pts/<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span> (<span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>) olej pts/<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span> (<span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">56</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br><br>  The last command shown (who) is executed already in an SSH session, that is, on the same remote host to which <b>two independent</b> connections from two different subnets are fixed (the last two lines of output), which actually represent one host, but from the point of view its various network interfaces. <br><br><h1>  Further clarification </h1><br>  In preparing and debugging examples of modules, for more details, this (fairly fresh) book was actively used: Rami Rosen: ‚ÄúLinux Kernel Networking: Implementation and Theory‚Äù, Apress, 650 pages, 2014, ISBN-13: 978-1-4302 -6196-4. <br><img src="https://habrastorage.org/getpro/habr/post_images/464/de9/dbc/464de9dbc696d2420a2055ef38fdb81f.jpg"><br><br>  The author kindly provided it for free download even before the book was released for sale (2013-12-22).  You can download it <a href="http://www.foxebook.net/linux-kernel-networking-implementation-and-theory/">on this page</a> . <br><br>  Anyone who is interested in issues like the ones discussed in this article will be able to find in this edition a lot of ideas for the further development of the technology of own use of network interfaces. <br><br>  The archive of codes mentioned in the text for experiments and further development can be found <a href="https://yadi.sk/d/TUnvim3EkLgco">here</a> or <a href="https://drive.google.com/file/d/0B__cqmYoRw_6UU1NVWJZNXdHV3c/view%3Fusp%3Dsharing">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/270517/">https://habr.com/ru/post/270517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270505/index.html">Time to materialize: 5 days left until the end of the competition</a></li>
<li><a href="../270507/index.html">Regular expression searches can be quick and easy.</a></li>
<li><a href="../270509/index.html">GDG DevFest Voronezh 2015: photo and video report from the event</a></li>
<li><a href="../270513/index.html">OpenStreetMap as a geodata source</a></li>
<li><a href="../270515/index.html">‚ÄúBig data‚Äù - is it boring?</a></li>
<li><a href="../270519/index.html">Symfony2 two-factor authentication with a certificate</a></li>
<li><a href="../270521/index.html">Docker 1.9 + Weave 1.2.1 bridge mode</a></li>
<li><a href="../270523/index.html">Colocation in theory and practice</a></li>
<li><a href="../270525/index.html">Cryptographers invent new ways to blackmail users</a></li>
<li><a href="../270527/index.html">Official Firebird 3.0 Release Candidate 1 and Beta Documentation for Firebird 3.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>