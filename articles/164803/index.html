<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Postgre (no) SQL or again about storing data with a flexible structure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When the question is about storing flexible (not known, frequently modified) data structures in the database, developers usually refer to the ‚Äúgreat a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Postgre (no) SQL or again about storing data with a flexible structure</h1><div class="post__text post__text-html js-mediator-article">  When the question is about storing flexible (not known, frequently modified) data structures in the database, developers usually refer to the ‚Äúgreat and terrible‚Äù EAV pattern, or to the now fashionable NOSQL databases. <br>  Not so long ago, such a task became in front of me. <br>  - <b>EAV</b> .  I have a persistent hostility, and it was said and written that there was a lot of everything negative (Kite, Fowler, Karvin, Gorman).  The main disadvantage is that when writing queries you have to operate not with real entities (‚ÄúEmployee‚Äù, ‚ÄúHome‚Äù, ‚ÄúClient‚Äù, then this is what SQL is intended for), but with objects at a lower level (sorry for the confusion).  Therefore, it was not the most desirable option. <br>  - <b>NOSQL</b> .  At first, I was very interested in this option (in particular, MongoDB).  After prolonged use of relationals, at first you begin to experience a feeling of total freedom, which takes your breath away.  Keeping documents of any structure, instant creation of new collections, requests for them is a beauty!  But after a short use, the euphoria began to subside, and problems show up: <br>  - Poor query language (IMHO) + no joins; <br>  - Lack of schemes (a good article was recently on this topic (and not only on this one) <a href="http://habrahabr.ru/post/164361/">habrahabr.ru/post/164361</a> ); <br>  - Lack of built-in support for referential integrity; <br>  - Lack of gadgets in the form of stored procedures / functions, triggers, views, and much more. <br>  - In my application, in addition to data with a flexible (changeable) structure, it is also necessary to store normal static data - a table of users, visits, employees, etc.  Working with which (again, IMHO) is much simpler and (most important) safer in a conventional relational database (the same referential integrity, etc.). <br><br><a name="habracut"></a><br><br>  I tried to solve the first problem (partially) with the help of ORM (it was Spring Data), it allowed me to write tolerable requests to objects, but for this, you need to create and compile in advance all classes (corresponding to the necessary collections) and operate on them already.  For me it did not fit, because  collections should be created and changed frequently and quickly - on the go. <br>  The second is by creating a separate collection to store the structures of all the other collections, to check the correctness of the input data, etc. <br>  Until the solution of the remaining problems, the matter did not come up, quit ... <br>  Already at this stage, my base began to resemble a very fragile structure, completely dependent on the application, plus I had to manually implement many things that most of the relations can do out of the box.  Maybe this is normal, but somehow I was not used to it, as it became uncomfortable. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, I thought about how great it would be to combine a relational and NOSQL DBMS.  On the one hand, the whole power of the relational with all the accompanying ones, on the other - the ease and elegance of the document-oriented solution.  Indeed, what prevents you from storing objects with a flexible structure in some separate special table (s), for example, in xml format, and accessing them using XPATH, especially since many modern DBMS have advanced XML tools (including indexing). <br>  I decided to try on a small example using Postgresql, what happens, what the queries will look like: <br><br>  For a start, two service tables are enough, I think the comments are superfluous: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> classes ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, is_closed <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span>, obects_count <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> classes_pk PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> ) ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> objects ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> <span class="hljs-keyword"><span class="hljs-keyword">xml</span></span>, id_classes <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> objects_pk PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> ), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> classes_objects <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (id_classes) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> classes (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">MATCH</span></span> SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ACTION</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> fki_classes_objects <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> objects <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> btree (id_classes );</code> </pre> <br><br>  Create two entities for experimenting: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> classes( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, is_closed, obects_count) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'customers'</span></span>, <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> classes( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, is_closed, obects_count) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'orders'</span></span>, <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><br>  Let's prepare two functions for generating test random data (taken on the Internet): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> random(<span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span> + ($<span class="hljs-number"><span class="hljs-number">2</span></span> - $<span class="hljs-number"><span class="hljs-number">1</span></span>) * random())::<span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span>; $BODY$ LANGUAGE sql VOLATILE COST 100; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> random_string(<span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> chars <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>[] := <span class="hljs-string"><span class="hljs-string">'{0,1,2,3,4,5,6,7,8,9,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}'</span></span>; result text := ''; i integer := 0; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> <span class="hljs-string"><span class="hljs-string">'Given length cannot be less than 0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; for i in 1..length loop result := result || chars[1+random()*(array_length(chars, 1)-1)]; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; return result; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; $BODY$ LANGUAGE plpgsql VOLATILE COST 100;</code> </pre><br><br>  Filling the table with random data, objects of the ‚ÄúClient‚Äù and ‚ÄúOrder‚Äù classes (one to many connection, each client made five orders): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> customer_pk <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; order_pk integer; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-number"><span class="hljs-number">.10000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> customer_pk := <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'objects_id_seq'</span></span>); order_pk := nextval('objects_id_seq'); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> objects (<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>, id_classes) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>(( <span class="hljs-string"><span class="hljs-string">'&lt;Customers&gt; &lt;Customer&gt; &lt;ID&gt;'</span></span> || customer_pk || <span class="hljs-string"><span class="hljs-string">'&lt;/ID&gt; &lt;Name&gt;'</span></span> || random_string(<span class="hljs-string"><span class="hljs-string">'10'</span></span>) || <span class="hljs-string"><span class="hljs-string">'&lt;/Name&gt; &lt;Partners&gt;'</span></span> || random_string(<span class="hljs-string"><span class="hljs-string">'10'</span></span>) || <span class="hljs-string"><span class="hljs-string">'&lt;/Partners&gt; &lt;/Customer&gt; &lt;/Customers&gt;'</span></span>)::<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); for j in 1..5 LOOP <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> objects (<span class="hljs-keyword"><span class="hljs-keyword">body</span></span>, id_classes) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>(( <span class="hljs-string"><span class="hljs-string">'&lt;Orders&gt; &lt;Order&gt; &lt;ID&gt;'</span></span> || order_pk || <span class="hljs-string"><span class="hljs-string">'&lt;/ID&gt; &lt;Customer_id&gt;'</span></span> || customer_pk || <span class="hljs-string"><span class="hljs-string">'&lt;/Customer_id&gt; &lt;Cost&gt;'</span></span> || random(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>) || <span class="hljs-string"><span class="hljs-string">'&lt;/Cost&gt; &lt;/Order&gt; &lt;/Orders&gt;'</span></span>)::<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$$;</code> </pre><br><br>  The first request will choose the maximum cost of the order: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(((xpath(<span class="hljs-string"><span class="hljs-string">'/Orders/Order/Cost/text()'</span></span>, O.body))[<span class="hljs-number"><span class="hljs-number">1</span></span>])::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> cost_of_order <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Objects O <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> O.id_classes = <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* Aggregate (cost=2609.10..2609.11 rows=1 width=32) -&gt; Seq Scan on objects o (cost=0.00..2104.50 rows=50460 width=32) Filter: (id_classes = 2) */</span></span></code> </pre><br>  The request turned out to be a bit quirky, but still quite understandable: it is immediately clear to which entity the request is executed and by what attribute.  Oddly enough it turned out to be a full scan, but nothing prevents to build an index on the Cost attribute: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> obj_orders_cost_idx <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> objects <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> btree (((xpath(<span class="hljs-string"><span class="hljs-string">'/Orders/Order/Cost/text()'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">body</span></span>))[<span class="hljs-number"><span class="hljs-number">1</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>));</code> </pre><br><br>  And now the query works much faster and uses the index: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* Result (cost=0.15..0.16 rows=1 width=0) InitPlan 1 (returns $0) -&gt; Limit (cost=0.00..0.15 rows=1 width=32) -&gt; Index Scan Backward using obj_orders_cost_idx on objects o (cost=0.00..7246.26 rows=50207 width=32) Index Cond: ((((xpath('/Orders/Order/Cost/text()'::text, body, '{}'::text[]))[1])::text)::double precision IS NOT NULL) Filter: (id_classes = 2) */</span></span></code> </pre><br><br>  Now let's try to select information about orders of several specific employees, i.e.  a bunch of two tables: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> (xpath(<span class="hljs-string"><span class="hljs-string">'/Customers/Customer/Name/text()'</span></span>, C.body))[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> customer , (xpath(<span class="hljs-string"><span class="hljs-string">'/Orders/Order/Cost/text()'</span></span>, O.body))[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> cost_of_order <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> objects C , objects O <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> C.id_classes = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> O.id_classes = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (xpath(<span class="hljs-string"><span class="hljs-string">'/Orders/Order/Customer_id/text()'</span></span>, O.body))[<span class="hljs-number"><span class="hljs-number">1</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = (xpath(<span class="hljs-string"><span class="hljs-string">'/Customers/Customer/ID/text()'</span></span>, C.body))[<span class="hljs-number"><span class="hljs-number">1</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ((xpath(<span class="hljs-string"><span class="hljs-string">'/Customers/Customer/ID/text()'</span></span> ,C.body))[<span class="hljs-number"><span class="hljs-number">1</span></span>])::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-number"><span class="hljs-number">1997585</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">1997595</span></span>;</code> </pre><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* Hash Join (cost=1873.57..6504.85 rows=12867 width=64) Hash Cond: ((((xpath('/Orders/Order/Customer_id/text()'::text, o.body, '{}'::text[]))[1])::text)::integer = (((xpath('/Customers/Customer/ID/text()'::text, c.body, '{}'::text[]))[1])::text)::integer) -&gt; Seq Scan on objects o (cost=0.00..2104.50 rows=50460 width=32) Filter: (id_classes = 2) -&gt; Hash (cost=1872.93..1872.93 rows=51 width=32) -&gt; Bitmap Heap Scan on objects c (cost=196.38..1872.93 rows=51 width=32) Recheck Cond: (id_classes = 1) Filter: (((((xpath('/Customers/Customer/ID/text()'::text, body, '{}'::text[]))[1])::text)::integer &gt;= 1997585) AND ((((xpath('/Customers/Customer/ID/text()'::text, body, '{}'::text[]))[1])::text)::integer &lt;= 1997595)) -&gt; Bitmap Index Scan on fki_classes_objects (cost=0.00..196.37 rows=10140 width=0) Index Cond: (id_classes = 1) */</span></span></code> </pre><br><br>  Expected fullscan, now we index slightly: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> obj_customers_id_idx <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> objects <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> btree (((xpath(<span class="hljs-string"><span class="hljs-string">'/Customers/Customer/ID/text()'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">body</span></span>))[<span class="hljs-number"><span class="hljs-number">1</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> obj_orders_id_idx <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> objects <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> btree (((xpath(<span class="hljs-string"><span class="hljs-string">'/Orders/Order/ID/text()'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">body</span></span>))[<span class="hljs-number"><span class="hljs-number">1</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> obj_orders_customerid_idx <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> objects <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> btree (((xpath(<span class="hljs-string"><span class="hljs-string">'/Orders/Order/Customer_id/text()'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">body</span></span>))[<span class="hljs-number"><span class="hljs-number">1</span></span>]::<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>));</code> </pre><br><br>  Now it turns out more fun: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* Hash Join (cost=380.52..5011.80 rows=12867 width=64) Hash Cond: ((((xpath('/Orders/Order/Customer_id/text()'::text, o.body, '{}'::text[]))[1])::text)::integer = (((xpath('/Customers/Customer/ID/text()'::text, c.body, '{}'::text[]))[1])::text)::integer) -&gt; Seq Scan on objects o (cost=0.00..2104.50 rows=50460 width=32) Filter: (id_classes = 2) -&gt; Hash (cost=379.88..379.88 rows=51 width=32) -&gt; Bitmap Heap Scan on objects c (cost=204.00..379.88 rows=51 width=32) Recheck Cond: (((((xpath('/Customers/Customer/ID/text()'::text, body, '{}'::text[]))[1])::text)::integer &gt;= 1997585) AND ((((xpath('/Customers/Customer/ID/text()'::text, body, '{}'::text[]))[1])::text)::integer &lt;= 1997595) AND (id_classes = 1)) -&gt; BitmapAnd (cost=204.00..204.00 rows=51 width=0) -&gt; Bitmap Index Scan on obj_customers_id_idx (cost=0.00..7.35 rows=303 width=0) Index Cond: (((((xpath('/Customers/Customer/ID/text()'::text, body, '{}'::text[]))[1])::text)::integer &gt;= 1997585) AND ((((xpath('/Customers/Customer/ID/text()'::text, body, '{}'::text[]))[1])::text)::integer &lt;= 1997595)) -&gt; Bitmap Index Scan on fki_classes_objects (cost=0.00..196.37 rows=10140 width=0) Index Cond: (id_classes = 1) */</span></span></code> </pre><br><br>  This query has also not lost its visibility, but it can be even more combed: deal with type conversion, optimize xml structure, etc.  There is a lot of work, it's just a small example. <br><br>  What else can you do: <br><br>  1. Flexible search by attributes of objects of any classes; <br>  2. The objects table can be partitioned (at least partially), for example, to store objects of large classes physically separately. <br><br>  Storing data in a database in xml format is not naturally a novelty, but there was very little information about this when searching for a solution to my question, not to mention specific examples.  I hope someone will come in handy or (and) to hear in the comments reviews and opinions of people who have worked with a similar scheme. </div><p>Source: <a href="https://habr.com/ru/post/164803/">https://habr.com/ru/post/164803/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164795/index.html">Sass course on Code School and worldview after it with an example (look at .less, .scss and .sass)</a></li>
<li><a href="../164797/index.html">Yes, Randy Zuckerberg, please read to us a lecture on "Human Decency"</a></li>
<li><a href="../164799/index.html">Android programming course for beginners</a></li>
<li><a href="../1648/index.html">Police took mobbers for extremists</a></li>
<li><a href="../16480/index.html">Time management and Buridan donkey.</a></li>
<li><a href="../164805/index.html">jQuery inside - attributes, properties, data</a></li>
<li><a href="../164807/index.html">ACL: in search of the perfect solution.</a></li>
<li><a href="../164809/index.html">Interkassa changes keys</a></li>
<li><a href="../164811/index.html">Free implementation of contactless computer management interface: Enable Viacam</a></li>
<li><a href="../164815/index.html">Economic strategy or 4200 bytes for 10 years</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>