<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SharePoint 2013/2016 database maintenance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My name is Lyubov Volkova, I am a systems architect in the business solutions development department. In the previous article I talked about monitorin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SharePoint 2013/2016 database maintenance</h1><div class="post__text post__text-html js-mediator-article">  My name is Lyubov Volkova, I am a systems architect in the business solutions development department.  In the previous article I talked about <a href="https://habrahabr.ru/company/softline/blog/322940/">monitoring performance counters of SharePoint Server 2013/2016</a> .  Today we will discuss an equally important task - the maintenance of SharePoint 2013/2016 databases. <br><br>  Any Microsoft SharePoint 2013/2016 farm necessarily includes a SQL server that stores data from various services and components deployed for the corporate portal.  As you know, the performance of working with databases has a significant impact on the work of the corporate portal as a whole.  If you do not pay attention to the maintenance of the SharePoint database or do it illiterately, then in practice there are the following obvious problems: a decrease in the productivity of work on the corporate portal, which very often results in a gradual increase in the waiting time for pages, forms, data on web pages, and duplication of actions and their inconsistency in terms of administration. <br><br>  Very often, the development of maintenance plans causes significant difficulties for portal administrators because of the complexity, complexity and the need to possess competencies not only in administering SharePoint, but also in administering SQL Server.  Therefore, in the article I performed a review of all key database maintenance operations, gave examples of scripts and practical tips.  Using the above descriptions, you will find many recommendations for action.  I note that the articles are not exhaustive, because  It is not possible to include a description of absolutely all the details and subtleties of servicing the SharePoint databases.  In order for you to get more detailed information on a particular topic, there are links to additional publications. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/287/ac5/8e9/287ac58e92ee4a6f9c8104587ca2240f.jpg"><a name="habracut"></a><br><br><h2>  <font color="#2e74b5">Introduction</font> </h2><br>  The whole variety of databases on which SharePoint work depends can be divided into three groups: <br><br><ol><li>  SQL server system databases (master, model, msdb, tempdb). </li><li>  SharePoint system databases (Configuration and Content Center Administration database). </li><li>  SharePoint Server databases that provide data storage for deployed service applications (for example, metadata management services, user profile services, business data connection services, etc.). </li></ol><br>  For optimal performance of Microsoft SharePoint 2013/2016 databases, it is crucial that you follow the standard maintenance procedures for all related databases in a timely manner. <br><br>  The following is a list of recommended SharePoint database maintenance tasks: <br><br><ul><li>  Check the integrity of the database. </li><li>  Defragmentation indices. </li><li>  Index performance optimization using fill factor. </li><li>  Compress SharePoint databases. </li><li>  Setting recovery mode for databases; </li><li>  Backup system databases; </li><li>  Develop maintenance plans. </li></ul><br>  These database maintenance tasks can be performed using Transact-SQL commands, the user interface, and the maintenance wizard. <br><br>  General information about the purpose, location requirements, default recovery models, and other information on each of the databases can be found <a href="https://technet.microsoft.com/ru-ru/library/cc678868.aspx">here</a> . <br><br>  This article focuses on system administrators, database administrators and technical professionals involved in supporting the work of corporate SharePoint portals. <br><br><h2>  <font color="#2e74b5">Database Integrity Check</font> </h2><br>  The <a href="https://msdn.microsoft.com/ru-ru/library/ms176064.aspx">DBCC CHECKDB</a> command provides a comprehensive check of the logical and physical integrity of all objects in the specified database and includes the following set of checks: <br><br><ul><li>  consistency of the allocation of disk space for the specified database; </li><li>  the integrity of all pages and structures that make up the table or indexed view; </li><li>  consistency of directories in the specified database operating in network mode; </li><li>  the contents of each indexed view in the database; </li><li>  consistency between metadata tables, files in system folders and files at the link level when storing varbinary (max) data in the file system using FILESTREAM; </li><li>  Service Broker data in the database. </li></ul><br>  Example script to check the integrity of the SharePoint content database "WSS_Content": <br><br><pre><code class="sql hljs">DBCC CHECKDB ('WSS_Content') <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PHYSICAL_ONLY, ALL_ERRORMSGS <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  An example of the results of the execution of the script, indicating the absence of errors: <br><br><img src="https://habrastorage.org/files/229/5cd/8f9/2295cd8f9e3b41f5980d9520446352aa.png"><br><br>  Examples of results indicating errors and the need to solve a problem for a specific database: <br><br><img src="https://habrastorage.org/files/02e/e86/94a/02ee8694a125497dbd76cd2a75db988d.png"><br><br>  The DBCC CHECKDB command makes extensive use of I / O subsystem, CPU, and memory resources.  To reduce the workload on a working system related to consistency checking, it is recommended that you execute the DBCC CHECKDB command for restored backup copies of SharePoint databases on a separate server. <br><br>  If the DBCC CHECKDB command is executed on a working database, it is recommended that it be performed during non-working hours, limited to checking the integrity of the physical structure of the pages and the record headers and the integrity of the allocation of space in the database. <br><br><h2>  <font color="#2e74b5">Defragmentation Indexes</font> </h2><br><h3>  <font color="#2e74b5">Introduction</font> </h3><br>  Index fragmentation is a state in which the key-determined logical order of pages in an index differs from the physical order in which pages are placed in data files.  It may also indicate a low data density on the data file pages, which results in inefficient use of disk space, memory, and I / O resources. <br><br>  The main reasons for index fragmentation are numerous inserts, updates, or deletes data in tables.  Figure 1 and Figure 2 show the difference between the new unfragmented index and the same index after a large number of insert, update and delete operations.  The red arrow defines the physical order of the index, and the black arrow defines the logical order of the pages. <br><br>  Figure 1. Unfragmented index (source: Paul S. Randal) <br><br><img src="https://habrastorage.org/files/884/0c5/8cd/8840c58cd31249c5a15a97bd947301fb.jpg"><br><br>  Figure 2. Fragmented Index (source: Paul S. Randal) <br><br><img src="https://habrastorage.org/files/6fa/739/6c6/6fa7396c629b4b73beaa610f81854684.jpg"><br><br>  Since the insertion, update, and deletion of data in rows of tables and indexes is uneven, each page will have different levels of completeness (data density) at different points in time.  In this case, when processing a query that requires scanning part or all of the table indexes, a high degree of fragmentation will entail an increase in the number of page reads, which, in turn, will prevent parallel scanning of data and lead to a significant decrease in performance. <br><br>  Index fragmentation can lead to poor performance and inefficient use of space.  At the same time, even in databases with a low intensity of use, the degree of index fragmentation can grow at a rapid rate. <br><br><h3>  <font color="#2e74b5">Reorganization and rebuilding indexes</font> </h3><br>  To reduce index fragmentation, two methods are supported: <br><br><ol><li>  Reorganize the index, which defragments and compresses clustered and non-clustered indexes in tables and views, which can significantly improve the performance of working with indexes.  Reorganization is always performed online, so the base table is accessible to users. <br><br></li><li>  Rebuilding an index, which results in a complete rebuilding of an index using the same columns, index types, attribute uniqueness, and sort order.  Rebuilding improves index scan performance.  You can rebuild the index online or offline. </li></ol><br>  Online index rebuild is supported only in SQL Server Enterprise editions.  In cases where the release of SQL Server hosting the database in question, or the index itself, does not support online rebuilding of the index, the above procedures are performed offline.  Online rebuild may not be available for an index containing columns with large objects, for example, columns with the data type NVARCHAR (MAX), IMAGE, etc. <br><br>  During the autonomous rebuild process, the table level is locked, as a result of which they become unavailable for recording or even for viewing.  Many SharePoint database indexes contain columns with large objects and are therefore always rebuilt using a stand-alone process. <br><br>  It should be noted that in case of operative rebuilding, short-term locking of tables can be performed, as a result of which any operations, except for SELECT, are prohibited.  SharePoint 2013/16 databases use clustered indexes in a special way.  When rebuilding such an index offline, an exclusive lock is applied to the table, which <b>completely prevents users from accessing it</b> . <br><br>  The preferred method of defragmenting an index depends on its degree of fragmentation, and also on whether it can remain online or needs to be processed offline.  The following table describes the recommended defragmentation methods for indexes with varying degrees of fragmentation for SharePoint databases: <br><table><tbody><tr><th>  Degree of fragmentation </th><th>  Recommended actions </th></tr><tr><td>  From 5 to 10% </td><td>  Reorganization (online) </td></tr><tr><td>  From 10 to 75% </td><td>  Rebuild (live mode) <br>  with ALTER INDEX REBUILD WITH (ONLINE = ON) </td></tr><tr><td>  More than 75% </td><td>  Rebuild (offline) <br>  with ALTER INDEX REBUILD WITH (ONLINE = OFF) </td></tr></tbody></table><br><h3>  <font color="#2e74b5">Automating index maintenance through system tasks</font> </h3><br><h4>  <font color="#1f4d78">Health Analyzer Rules</font> </h4><br>  In SharePoint 2013/2016, the service and components monitoring process can be partially automated using the SharePoint Health Analyzer rules ( <a href="https://technet.microsoft.com/ru-ru/library/hh564122.aspx">checking index statistics</a> and <a href="https://technet.microsoft.com/ru-ru/library/ff805060.aspx">checking index fragmentation</a> for search service crawl databases).  Their use allows daily assessment of the state, as well as automatically maintain the indices for the following databases: <br><br><ul><li>  Configuration database </li><li>  SharePoint content databases, including the Administration Center content database. </li><li>  Database user profiles. </li><li>  The social tag database of the user profile service application. </li><li>  Word Automation Database. </li></ul><br>  You can view a complete list of system tasks related to health analysis in the SharePoint Administration Center by going to the <b>Tracking \ View Job Definitions</b> section.  Examples of system tasks: <br><br><img src="https://habrastorage.org/files/661/ccc/95d/661ccc95d8e14f639ddd5c95a1604f21.png"><br><br><h3>  <font color="#2e74b5">Rules that check index fragmentation</font> </h3><br><ol><li>  <b>Database indexes used by SharePoint are fragmented.</b>  When you run this rule, the following tasks are performed: <br><br><ul><li>  The rule reports fragmented indexes.  This is due to the importance of the index state.  As a result of the operation of the health analyzer rules, this rule will always report fragmented indexes to bring recovery operations into effect. <br><br></li><li>  For each SharePoint database, the restore operation looks for, and in case of a successful search, executes the stored procedure's <i>proc_DefragmentIndices</i> stored procedure.  During the execution of this stored procedure, a list of all indexes in the database is built.  Each index is rated with its current level of fragmentation.  For recovery, any indexes that are <b>more than 30 percent</b> fragmented are considered. <br><br></li><li>  If the SQL Server edition supports rebuilding indexes online, a corresponding attempt is made to rebuild the index for each index.  If this fails, then offline index recovery is performed. </li></ul><br></li><li>  <b>Search - One or more crawl databases may have fragmented indexes.</b>  This rule supports SharePoint search service crawl database indexes.  By default, this rule is configured to run only on demand.  The rule is run from any server in the farm.  When you run this rule, the following tasks are performed: <br><br><ul><li>  The rule confirms that the environment is in a state in which defragmentation of indexes is safe. <br><br></li><li>  For each crawl database configured for search applications in the local farm, the rule runs the <i>proc_MSS_DefragGathererIndexes</i> stored procedure. <br><br></li><li>  Each crawl database index in the list will be rebuilt.  If the release of SQL Server supports rebuilding indexes online, then the corresponding index rebuild is performed.  If rebuilding indexes in this mode fails, the index will be rebuilt offline. </li></ul></li></ol><br><h3>  <font color="#2e74b5">Running Index Defragment Stored Procedures</font> </h3><br>  Many SharePoint databases include stored procedures used by the health analyzer to defrag indexes.  Although these rules automatically perform defragmentation, it is possible that you will need to start defragmentation manually.  For example, this may require your SLA or some corporate regulations. <br><br>  You can schedule these stored procedures to run daily, weekly, or monthly depending on your needs and the general indicators of change in your environment. <br><br>  It is recommended that you allow SharePoint to manage its own database indexes.  If you need to manually perform this action, at a minimum it is recommended to set up a daily maintenance schedule so that the <i>proc_DefragmentIndice</i> s procedure and the weekly <i>proc_MSS_DefragSearchIndexes</i> procedure are <i>performed</i> . <br><br><h3>  <font color="#2e74b5">Monitoring index fragmentation using SQL Server</font> </h3><br>  Before proceeding with the implementation of a maintenance plan for a fragmented index, it is necessary to determine the most fragmented tables and indices, and only after that develop a plan for their <a href="https://msdn.microsoft.com/ru-ru/library/ms189858.aspx">rebuilding and reorganization</a> . <br><br>  For example, in SharePoint 2013/2016, the <b>AllDocs</b> table, which contains document libraries, associated documents, lists and list items, and the corresponding metadata are highly fragmented.  Despite the availability of automated system tasks of the health analyzer, their work is not always effective <br>  The degree of index fragmentation is defined as the proportion of index pages, the logical order of which is different from the physical one.  To define it in SQL Server 2014 and SQL Server 2016, you should use the <font color="#2e74b5"><a href="https://msdn.microsoft.com/ru-ru/library/ms188917.aspx">sys.dm_db_index_physical_stats</a></font> dynamic administrative view. <br><br>  You can use the following script (for example, the SharePoint content database ‚ÄúWSS_Content‚Äù): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [WSS_Content]; GO <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> obj.type_desc ,tbl.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'TableName'</span></span> ,inx.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'IndexName'</span></span> ,phys.avg_fragmentation_in_percent ,phys.fragment_count ,phys.avg_fragment_size_in_pages <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_db_index_physical_stats(DB_ID(),<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-string"><span class="hljs-string">'DETAILED'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> phys <span class="hljs-comment"><span class="hljs-comment">--LIMITED/SAMPLED/DETAILED JOIN sys.objects as obj on obj.object_id=phys.object_id JOIN sys.indexes as inx on inx.object_id=phys.object_id JOIN sys.tables as tbl on tbl.object_id=phys.object_id WHERE avg_fragmentation_in_percent &gt; 75 ORDER BY avg_fragmentation_in_percent DESC;</span></span></code> </pre> <br>  The result set returned by <b>sys.dm_db_index_physical_stats</b> includes the following columns: <br><table><tbody><tr><th>  Column </th><th>  Description </th></tr><tr><td>  avg_fragmentation_in_percent </td><td>  The percentage of logical fragmentation (unordered pages in the index). </td></tr><tr><td>  fragment_count </td><td>  The number of fragments (physically consistent leaf pages) in the index. </td></tr><tr><td>  avg_fragment_size_in_pages </td><td>  The average number of pages in one index fragment. </td></tr></tbody></table><br>  Example output of the index fragmentation analysis result: <br><br><img src="https://habrastorage.org/files/4a0/928/0e5/4a09280e5ae44e59b9ec93fe27bb678a.png"><br><br><h3>  <font color="#2e74b5">Reorganize the index for the SharePoint database</font> </h3><br>  Below is an example of a script that enables the reorganization of one of the indexes of the AllDocs table in the SharePoint content database: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [WSS_Content] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [AllDocs_Url] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[AllDocs] REORGANIZE <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ( LOB_COMPACTION = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br><h3>  <font color="#1f4d78">Rebuild index for SharePoint database</font> </h3><br>  An example script to rebuild all indexes on a separate SharePoint database table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [WSS_Content] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[AllDocs] <span class="hljs-keyword"><span class="hljs-keyword">REBUILD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> ( FILLFACTOR = <span class="hljs-number"><span class="hljs-number">80</span></span> , SORT_IN_TEMPDB = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ,STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  Sample script to rebuild a separate index <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [WSS_Content] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [AllDocs_Url] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[AllDocs] <span class="hljs-keyword"><span class="hljs-keyword">REBUILD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> = ALL <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> , STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> , SORT_IN_TEMPDB = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> , IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> , ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> , ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> , FILLFACTOR = <span class="hljs-number"><span class="hljs-number">80</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  An example of the result obtained (checking defragmentation of the index after rebuilding: <br><br><img src="https://habrastorage.org/files/c15/21a/917/c1521a91754944b684cb70a25c67ce76.png"><br><br><h2>  <font color="#2e74b5">Index Performance Optimization with Fill Factor</font> </h2><br>  You can use the fill factor to further optimize data storage and index performance.  When creating or rebuilding an index, the fill factor (from 1 to 100) determines the percentage of space at the level of each leaf page that can be filled with data.  The rest is reserved for further expansion.  In most cases, the default fill level 0 set at the server level is optimal (each page can be filled to 100%).  However, in SharePoint 2013, you can use a value of 80, which is set at the server level and provides optimal expansion options and minimal fragmentation. <br><br>  The fill factor (the ‚Äúfill factor‚Äù parameter) is used to fine tune the storage and index performance.  When you create or rebuild an index, the fill factor displays the percentage of space occupied by each page in the final level, which allows you to reserve space for free space for future expansion.  For example, if you specify a value of 80 for the fill factor, 20 percent of the disk space occupied by it will be reserved on each page of the final level.  This disk space will be used to expand the index when new data is added to the base table.  Empty space is reserved not at the end of the index, but between the rows of the index. <br><br>  The fill factor is a percentage from 1 to 100;  The default value on the server is 0, which means complete filling of the pages of the final level. <br><br>  For SharePoint, 80 is best for supporting database growth and reducing index fragmentation. <br><br><img src="https://habrastorage.org/files/880/da9/0d7/880da90d7d15410ab6491d1faf40b913.png"><br><br>  The following script will allow you to get information from the current default index fill factor settings at the SQL server level: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">minimum</span></span>, maximum,value_in_use <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.configurations <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-string"><span class="hljs-string">'fill factor (%)'</span></span> )</code> </pre> <br>  Example result: <br><br><img src="https://habrastorage.org/files/ecb/c6c/01f/ecbc6c01f8f541e4bf8e9c446393ed82.png"><br><br><h2>  <font color="#2e74b5">Compress SharePoint Database</font> </h2><br><h3>  <font color="#2e74b5">Automatic database compression</font> </h3><br>  Care should be taken to ensure that the automatic compression of SharePoint databases is not enabled in any way.  Compression can be used to reduce the size of a data file or transaction log, but it is a very coarse, resource-intensive process that causes extensive logical fragmentation of browsing in data files and leads to poor performance.  Manual compression of individual data files and log files may be acceptable under special circumstances. <br><br>  Automatic compression is especially harmful because it runs every 30 minutes in the background and tries to compress databases for which the automatic compression option is set.  This process is not entirely predictable in that it only compresses databases with more than 25% free space.  Automatic compression uses a lot of resources and causes degradation of performance, so that it is undesirable under any circumstances.  It should always be turned off. <br><br><h3>  <font color="#2e74b5">Recommendations</font> </h3><br>  Database compression can be performed only after deleting a large amount of data, provided that the resulting free space is not expected to be used.  It is strongly recommended to remember a few important rules: <br><br><ul><li>  do not enable automatic database compression; </li><li>  Do not include database compression in maintenance plans or scheduled tasks; </li><li>  compress only those databases for which more than 50% of the content has been deleted; </li><li>  compress only the SharePoint content databases; </li><li>  perform compression only during non-working hours due to the high load on the basic server subsystems during this operation; </li><li>  reorganize or rebuild indexes after compression (depending on the degree of fragmentation); </li><li>  The use of the TRUNCATEONLY and EMPTYFILE parameters is not supported by SharePoint databases. </li></ul><br>  Use the <font color="#2e74b5"><a href="https://msdn.microsoft.com/ru-ru/library/ms190488.aspx">DBCC SHRINKDATABASE command</a></font> to compress data and log files, for example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [WSS_Content] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> DBCC SHRINKDATABASE(N<span class="hljs-string"><span class="hljs-string">'WSS_Content'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  To compress individual files, use the <font color="#2e74b5">DBCC SHRINKFILE</font> command, for example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [WSS_Content] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> DBCC SHRINKFILE (N<span class="hljs-string"><span class="hljs-string">'WSS_Content'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br><h3>  <font color="#2e74b5">Configuring SharePoint Database Recovery Modes</font> </h3><br>  In practice, the default recovery models for databases on which SharePoint relies are not always optimal and lead to an increase in transaction log files and inefficient use of disk space, additional backup costs. <br><br>  The table below summarizes the recommendations for typical configuration of recovery modes for each of the SharePoint databases. <br><br>  Table 1. Typical recovery mode settings for SharePoint databases <br><table><tbody><tr><th>  Database </th><th>  <nobr>Recommended Recovery Mode and Comments</nobr> </th></tr><tr><td>  <nobr>Master database</nobr> </td><td>  Plain </td></tr><tr><td>  <nobr>Model database template</nobr> </td><td>  Plain. <br>  As a rule, tuning is performed once or very rarely.  It is enough to perform a backup after making changes. <br></td></tr><tr><td>  <nobr>Msdb database</nobr> </td><td>  Plain <br></td></tr><tr><td>  <nobr>Tempdb database</nobr> </td><td>  Plain <br></td></tr><tr><td>  Central Administration Content Database </td><td>  Plain. <br></td></tr><tr><td>  <nobr>Configuration database</nobr> </td><td>  Plain. <br>  Changes are usually actively made at the stage of initial or spot configuration of services and components of the SharePoint farm, which has clear short time boundaries.  It is more efficient to perform a backup after making completed blocks of changes. <br></td></tr><tr><td>  Application Management Service Database </td><td>  Plain. <br>  Typically, in the SharePoint farm is set from 0 to a small number of applications (1-5) SharePoint.  Application installations are usually significantly separated in time.  More efficiently perform a full backup of the database after installing a separate application <br></td></tr><tr><td>  Subscription Settings Service Database </td><td>  Plain. <br>  As a rule, SharePoint applications are installed on a small number of sites (1-5).  Application installations are usually significantly separated in time.  It is more efficient to perform a full backup of the database after installing a separate application. <br><br>  Full. <br>  If you intend to install applications on an unlimited number of web sites, installations are often performed <br></td></tr><tr><td>  Business Connectivity Service </td><td>  Plain. <br>  Setting up and making changes related to the operation of this service is usually short in time and is performed once or a small number of times.  It is more efficient to perform a full database backup after the completed blocks for creating / editing data models, external content types and external data lists <br></td></tr><tr><td>  Managed Metadata service application database </td><td>  Plain <br>  in the case of using directories with rarely changeable content. <br><br>  Full access in case of making changes to the term sets on a regular basis (active creation and editing of hierarchical reference books, tagging of list items and documents). <br></td></tr><tr><td>  SharePoint Translation Service Application Database </td><td>  Plain. <br></td></tr><tr><td>  <nobr>Power Pivot Database</nobr> </td><td>  Full access <br></td></tr><tr><td>  PerformancePoint Services Database </td><td>  Plain <br>  in the case of working with a set of indicator panels, in whose settings changes are rarely made. <br><br>  Full access in case of intensive creation / modification of indicator panels <br></td></tr><tr><td>  Search Administration Database </td><td>  Plain. <br>  Setting up and making changes related to the operation of this service is usually short in time and is performed once or a small number of times.  It is more efficient to perform a full backup of the database after the completed setting blocks, changes to the search pattern <br></td></tr><tr><td>  <nobr>Analytics Reporting Database</nobr> </td><td>  Simple, if the analysis of search results and intelligent adaptation of the issuance of results, search suggestions is not critical. <br><br>  Full access if the search on the portal and its constant personalized work are critical for business <br></td></tr><tr><td>  <nobr>Crawl database</nobr> </td><td>  Plain. <br>  Restoring this database from a backup or using a recovery wizard will often be much longer compared to resetting the index and completely crawling the content. <br></td></tr><tr><td>  <nobr>Link Database</nobr> </td><td>  Plain, <br>         ,     . <br><br>  ,              <br></td></tr><tr><td> <nobr>  Secure Store</nobr> </td><td>  Plain. <br>    ,               - <br> .            . <br></td></tr><tr><td>   -  </td><td>  Plain. <br>  ,           InfoPath, -  Visio        .              InfoPath  Visio-  -. <br></td></tr><tr><td>         </td><td>    .          . <br></td></tr><tr><td> <nobr>  </nobr> </td><td> , <br>   - ,            <br><br>  ,   . <br></td></tr><tr><td> <nobr>   </nobr> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simple </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if recovery time takes less time compared to reconfiguring connections and performing full profile synchronization </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full access if the situation is reversed</font></font><br></td></tr><tr><td> <nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Social Tag Database</font></font></nobr> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simple, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if working with social content is not a business critical functionality </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full access, if the situation is reversed</font></font><br></td></tr><tr><td> <nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Word Automation Database</font></font></nobr> </td><td>  Full access <br></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> These recommendations can serve as a guideline, but in order to make a decision on the adjustment of the recovery mode of each individual database, we strongly recommend that you at least analyze: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The purpose, nature of the stored information, the frequency of data changes, the categories of users and the degree of importance of the data for each of them. </font></font></li><li>         . ,           -  ,       ( ),         -   .  ,           (,          .),       . </li><li>    .      <a href="https://technet.microsoft.com/ru-ru/library/cc678868.aspx"></a> . </li><li>      .          SharePoint ( , -,  )      . ,        -           ,    .  ,                ,   .  :     <a href="https://technet.microsoft.com/en-us/library/ee428315.aspx">SharePoint</a> ,   <a href="https://technet.microsoft.com/ru-ru/library/ms187048(v%3Dsql.105).aspx">SQL Server</a> . </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In some cases, you can consider the complete exclusion of backup databases of a separate service application. </font><font style="vertical-align: inherit;">In practice, this is often a search service, if it is allowed to be idle in its work, comparable to the time of full re-creation, configuration and crawling of content.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Technologies that are planned to be used to provide fault tolerance requirements (if any). </font><font style="vertical-align: inherit;">You may have to immediately exclude from the simple recovery mode.</font></font></li></ul><br><h2> <font color="#2e74b5"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Database Backup</font></font></font> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To perform a manual backup of the database on the SQL server (for example, the system model database), you must perform the following steps: </font></font><br><br><ol><li>  <b>Microsoft SQL Server Management Studio</b> ,   ,      ,          <b></b> &gt; <b>  </b> . </li><li>   <b></b>       . <br><br><img src="https://habrastorage.org/files/075/800/0ef/0758000efa8b48eaa0c1578bd52409dc.png"><br><br></li><li>   <b> </b>                  . <br><br><img src="https://habrastorage.org/files/eaf/414/028/eaf414028a8b417b9290185b485312eb.png"><br><br></li><li>   <b>  </b>    ,       . <br><br><img src="https://habrastorage.org/files/a74/fa6/1e6/a74fa61e62884fe6a09e361ad891b293.png"><br><br></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detailed recommendations for backup and recovery in SharePoint 2013 can be found </font></font><a href="https://technet.microsoft.com/ru-ru/library/gg266384.aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2> <font color="#2e74b5"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Developing service plans</font></font></font> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using SQL Server maintenance plans, you can automate and schedule important tasks to protect your data. </font><font style="vertical-align: inherit;">Using maintenance plans in SQL Server, an administrator can plan various operations, including checking database consistency, reorganizing, and rebuilding indexes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To create a SQL Server 2014/2016 database maintenance plan, follow these steps:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Click the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">on the taskbar and select </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All Programs&gt; SQL Server Management Studio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li>         SQL Server   . </li><li>   <b></b> ,      <b> </b>    <b>  </b> . </li><li>   <b></b>   ,     <b>  </b> . <br><br><img src="https://habrastorage.org/files/104/d0a/883/104d0a883f6143cda29b21e8fc8bdbe4.png"><br><br></li><li>        <b></b>  <b> </b> . </li><li> ,       . <br><br><ul><li>     ,   <b>       </b> . </li><li>        ,   <b>    </b> . </li></ul><br>       10         200 ,     .        . <br><br>        ,      ,       . <br><br></li><li>   <b></b> ,     .    <b>  </b> . <br><br><img src="https://habrastorage.org/files/60b/1f5/30e/60b1f530e0c84c8b98374c1571e94480.png"><br><br></li><li>  ,   <b></b>    <b></b> . </li><li>   ¬´   ¬ª  ,     ,    <b></b> . <br><br><img src="https://habrastorage.org/files/973/696/577/973696577bc34a3cbc2cda5d64133c2f.png"><br><br>    : <br><br><ul><li>       ,    ,     . </li><li>           . </li><li>        ,       .   ,         ,        . </li><li>  <b>  </b>   ,    . </li></ul><br>           ,       ,   . <br><br></li><li>          ¬´    ¬ª.           <b></b>  <b></b> .  ,   <b></b> . <br><br><img src="https://habrastorage.org/files/b67/ca4/f79/b67ca4f7998a48d68f67e2b11cfbb7b6.png"><br><br></li><li>   <b> ¬´   ¬ª</b>  ,     ,   ,    <b></b> .        SharePoint. <br><br><img src="https://habrastorage.org/files/0f4/71a/bd6/0f471abd6cb3435faba1715fea10b633.png"><br><br></li><li>   <b> ¬´ ¬ª</b>   <b> </b>  ,     ,   <b>  </b> ,          <b></b> . <br><br><img src="https://habrastorage.org/files/a63/3cb/cfb/a633cbcfbe374e568dec9b1acca16d81.png"><br><br></li><li>       ,     <b> </b>   <b> ¬´ ¬ª</b> . </li><li>   <b>     </b> ,   <b>80</b> ,         <b></b> . <br><br>   <b>     </b>      . <br><br><img src="https://habrastorage.org/files/400/7b1/b6b/4007b1b6b56641bbb92d49bb3e3617ae.png"><br><br></li><li>      <b>  ¬´  ¬ª</b>    <b></b> . <br><br>       . <br><br><img src="https://habrastorage.org/files/01f/487/817/01f487817c134622aea8353a2d65f061.png"><br><br></li><li>   <b>  </b>   <b>    </b> ,     .   <br>  Further </li></ol><br><br><img src="https://habrastorage.org/files/f6f/7c3/aee/f6f7c3aeefd74486863b31f0a49a4a7e.png"></div><p>Source: <a href="https://habr.com/ru/post/323046/">https://habr.com/ru/post/323046/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323036/index.html">Making your own log (archive) of alarms in Citect</a></li>
<li><a href="../323038/index.html">About ScalaCheck. Properties Part 3</a></li>
<li><a href="../323040/index.html">JPoint 2017 Java Conference: Moscow, April 7-8 - Review reports</a></li>
<li><a href="../323042/index.html">Zabbix 3.X: monitoring Adaptec controllers on Windows Server (Hyper-V Core)</a></li>
<li><a href="../323044/index.html">How we reconstructed the courthouse in Smolensk: from laser scans of stucco molding under mold to release</a></li>
<li><a href="../323048/index.html">1,500,000 installations in 3 months - Tap Tap Builder development history</a></li>
<li><a href="../323050/index.html">All the ‚Äújoys‚Äù of CallKit or how we did the caller ID on iOS 10</a></li>
<li><a href="../323052/index.html">Safe Builder on Scala and Java</a></li>
<li><a href="../323056/index.html">News of our online courses: updated course "Web-technologies" and added "Statement of tasks for software development"</a></li>
<li><a href="../323058/index.html">Superjob Data Science Meetup. Live broadcast</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>