<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Remote logging in journald or Still ‚Äúyou don't need this‚Äù?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Disclaimer 


 All experiments were performed on CentOS Linux release 7.2.1511 as the main system, with the latest available from the systemd turnip r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Remote logging in journald or Still ‚Äúyou don't need this‚Äù?</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/ba3/a39/9c9/ba3a399c9f884ef19a36369221944077.jpg"></p><br><h2 id="diskleymer">  Disclaimer </h2><br><p>  All experiments were performed on CentOS Linux release 7.2.1511 as the main system, with the latest available from the systemd turnip reps (systemd-219-19.el7_2.13).  I hope some of the data will be irrelevant at the time of publication of the article. </p><br><h3 id="vvodnaya-chast">  Prologue </h3><br><p>  Starting to capture linux distros with the release of Fedora 15, systemd finally won.  Bison and aksakals are gradually accustomed to units and systemctl.  The last defenders of the Good Old are gnashing their teeth.  In these realities, it is impossible to bypass the systemd child products.  And today, let's talk, for example, about journald. </p><br><a name="habracut"></a><br><p> By itself, journald (and, accordingly, journalctl) is a great tool.  Originated as a slightly third-party systemd project, by now journald has become the second tool from the systemd family that system administrators are familiar with.  I really like the idea of ‚Äã‚Äãrunning log storage with an optional ability to reset to permanent storage, an idea with <code>journalctl --boot</code> boot boot-id and machine-id ( <code>journalctl --machine</code> ), the ability to call logs of any registered <code>journalctl -u</code> applications from a single interface, and the presence of out-of-the-box log rotation (both in place and in time) using <code>journalctl --vacuum-size</code> or <code>journalctl --vacuum-time</code> .  From the good one can not fail to mention also the parameters <code>since</code> , <code>until</code> and <code>priority</code> , which can ‚Äúfade‚Äù events in time and priority, and, of course, the <code>utc</code> parameter, which removes a huge headache with multi-timezone teams and projects.  The binary file storage format may be a bit controversial, but this choice was explained by the authors even at the first journald announcements (safety and cheap storage, integration with systemd, forced uniform format, portability). </p><br><p>  Unfortunately, the journald directory mechanism, which allows, for example, organizing the translation of log messages or providing urls to end-users for solving problems with specific errors, has not acquired much of the distribution.  But in general, even the systemd developers do not take full advantage of this opportunity - to us, mortals. </p><br><p>  This is all implemented, works, described in hundreds of manuals, tested.  Thank you very much, but I want more. </p><br><h3 id="preambula">  Preamble </h3><br><p>  Not long ago, a friend asked him to set up a server for collecting logs.  Hha!  - I thought, - this is a great reason to study journald in the light of its capabilities of the central log server! </p><br><p>  It is clear that the tool depends on the task.  So this time was a brief collection of requirements: </p><br><ol><li>  It is necessary to organize a single point of logging. </li><li>  It is necessary to organize the ability to connect to a single point of logging in advance of an unknown number of clients (and disconnect them, respectively) </li><li>  It is advisable to organize the ability to view logs online, with automatic receipt of new records. </li><li>  During the previous step, the storage of logs at the central point can be limited to N hours (not even days) </li><li>  The message format is inconsistent down to the multiline. </li><li>  The key software of interest is written to stdout (yes, you can change the behavior or nakostilyt, but buy what they sell), the console does not close </li></ol><br><p>  And general technical introductory: </p><br><ol><li>  Data is transmitted over public networks. </li><li>  Head dedicated machine: Centos7.2 (latest) </li><li>  Connected machines: Ubuntu 16.04 </li></ol><br><p>  It seems that systemd and journald are a good choice, right?  After all, all the items have already been implemented!  Raise the test stand! </p><br><h3 id="golovnoy-host">  Host host </h3><br><p>  Well, let's start. <br>  We are interested in three components: </p><br><ol><li>  <code>systemd-journal-gatewayd</code> - http-daemon, opening the port to view (or download) journal entries </li><li>  <code>systemd-journal-remote</code> - a daemon that downloads or accepts journal entries on a central server. </li><li>  <code>systemd-journal-upload</code> - daemon duplicating journal entries to a remote server </li></ol><br><p>  All these components are included in the <code>systemd-journal-gateway</code> centos package, so we execute: </p><br><pre> <code class="hljs sql">yum -y <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> &amp;&amp; yum -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> systemd-journal-gateway</code> </pre> <br><p>  The <code>systemd-journal-remote</code> daemon is used to receive logs on the host machine.  From him and begin. </p><br><h4 id="systemd-journal-remote">  systemd-journal-remote </h4><br><p>  Remote has two modes of operation: active (in which it goes to the remote log itself and downloads logs - including in tracking mode. For this mode, all remote machines need <code>systemd-journal-gatewayd</code> ) and passive (in which the daemon hangs and waiting for him to come).  Taking into account the unknown number of machines - choose the passive mode.  The whole configuration, in fact, is to make the <code>/var/log/journal/remote</code> directory, assign the rights of the desired user to it and start the service: </p><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">mkdir</span></span> -p /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/journal/remote <span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> systemd-journal-remote:systemd-journal-remote /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/journal/remote systemctl start /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/journal/remote</code> </pre> <br><p>  Since we are collecting a demo booth, let's switch the file reception protocol from https to http.  To do this, you need to edit the starting service file <code>/lib/systemd/system/systemd-journal-remote.service</code> , replacing the option <code>listen-https</code> with <code>listen-http</code> .  It will also be useful to correct <code>/lib/systemd/system/systemd-journal-remote.socket</code> , specifying only the address of interest for binding the daemon. </p><br><p>  The daemon started, hangs in the passive mode, works on http.  Hooray! </p><br><h4 id="dyavol-v-detalyah">  The devil is in the details </h4><br><p>  First, when creating the <code>/var/log/journal</code> directory, all your system logs will be written to the <code>/var/log/journal/&lt;uuid&gt;</code> directory.  To change this behavior and return as it was, you need to fill in the configuration file <code>/etc/systemd/journald.conf</code> (or even better <code>/etc/systemd/journald.conf.d/&lt; &gt;.conf</code> , because the first one can be wiped with updates), namely the string <code>Storage=</code> .  By default, the value of this parameter is <code>auto</code> , which means "if there is a directory in var, journald writes logs there."  In my case, the parameter had to be forced to set to <code>volatile</code> . </p><br><h4 id="systemd-journal-upload">  systemd-journal-upload </h4><br><p>  Upload is still easier: create <code>/etc/systemd/journal-upload.d/&lt; &gt;.conf</code> , writing there: </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">Upload</span></span>] URL=http:<span class="hljs-comment"><span class="hljs-comment">//&lt;IP- remote&gt;:&lt;  &gt;</span></span></code> </pre> <br><p>  and run <code>systemctl start systemd-journal-upload</code> </p><br><h4 id="dyavol-v-detalyah-1">  The devil is in the details </h4><br><p>  Secondly, the demon will not start due to a very old <a href="https://bugzilla.redhat.com/show_bug.cgi%3Fid%3D1262743">bug in Centos</a> .  So do usermod with your hands: <code>usermod -a -G systemd-journal systemd-journal-upload</code> .  After that, the daemon should start successfully. </p><br><h4 id="udalennye-klienty">  Remote clients </h4><br><p>  On remote clients, I remind you, it costs Ubuntu 16.04.  So we put <code>apt-get install systemd-journal-remote</code> and make <code>/etc/systemd/journal-upload.d/&lt; &gt;.conf</code> changes <code>/etc/systemd/journal-upload.d/&lt; &gt;.conf</code> , similar to the previous paragraph (except <code>usermod</code> ). </p><br><h4 id="systemd-journal-gatewayd">  systemd-journal-gatewayd </h4><br><p>  And here, in fact, nothing to describe.  The current version presented in Centos does not allow specifying non-standard directories for the specified daemon.  Moreover, the standard directory for logs from other machines, according to the logic of developers, is non-standard for the log viewer.  In the new versions of systemd, this seems to be <a href="https://github.com/systemd/systemd/issues/3871">fixed</a> , but we will not install non-native versions ... </p><br><p>  Well, let's at least watch the logs: </p><br><pre> <code class="hljs pgsql">journalctl -D /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/journal/remote <span class="hljs-comment"><span class="hljs-comment">--follow</span></span></code> </pre> <br><p>  Well, something like it works ... </p><br><h4 id="dyavol-v-detalyah-2">  The devil is in the details </h4><br><p>  Thirdly, thanks to the old <a href="https://github.com/systemd/systemd/issues/1387">bug in systemd</a> , the directory <code>/var/log/journal/remote</code> will start to swell in the wildest.  And then nothing will help you ... </p><br><h4 id="doydyom-do-konca">  Let's get to the end! </h4><br><p>  However, since we have come this far, let's get to the end.  Run the <code>systemd-journal-gatewayd</code> daemon on the host machine (again, do not forget to fix <code>/lib/systemd/system/systemd-journal-gatewayd.socket</code> again to limit the daemon, right?) And carefully examine the web-browser viewer: </p><br><ul><li>  Online logging is virtually absent </li><li>  Fierce <code>on mouse over</code> and <code>on mouse scroll</code> for logs </li><li>  microhttpd under the hood </li><li>  Sorry, but terrifying interface </li><li>  It is possible to filter logs by systemd-unit, but (due to the number of non-informative session-units for example from cron-scripts) the inability to use filters </li><li>  All units are written completely - if you use for example passwords to databases in cron strings, your passwords will wait for you </li></ul><br><p>  NDA  Perhaps it‚Äôs good that it wasn‚Äôt possible to set it up, m? </p><br><h4 id="itogo">  Total </h4><br><p>  For the proof of concept, a <a href="https://github.com/skob/journal">pet-project</a> was written in a couple of days, the blessing of journald provides a native library for python.  Of the features: </p><br><ol><li>  Online browsing by SSE </li><li>  Ability to filter output units by the administrator at the configuration level </li><li>  Ability to filter hosts / priority / units by the user at the web application level </li><li>  Well, a little bootstrap </li></ol><br><p>  The same project was unrolled to a friend, with a description of the problems, a disclaimer and a forced cleaning of magazines. </p><br><p>  But on large projects personally, I probably will not use journald as a central repository of logs for a long time.  Until the above bugs are removed, my choice is definitely in favor of syslog. </p><br><p>  Article author: <a href="https://habrahabr.ru/users/skob/">Stepan Karamyshev</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/317182/">https://habr.com/ru/post/317182/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317172/index.html">Inkscape: the beginning (translation)</a></li>
<li><a href="../317174/index.html">Recovering virtualized Active Directory deleted objects from tombstone objects</a></li>
<li><a href="../317176/index.html">Where is the Internet of Things going?</a></li>
<li><a href="../317178/index.html">Why not write bots for Skype</a></li>
<li><a href="../317180/index.html">About C language and performance</a></li>
<li><a href="../317184/index.html">Why to achieve the goal is enough notebook</a></li>
<li><a href="../317188/index.html">Experience in building Infrastructure-as-Code in VMware. Part 1: Problem Identification</a></li>
<li><a href="../317192/index.html">Software patents must survive: American practice</a></li>
<li><a href="../317194/index.html">Implementation of PCI Express v3.0 x16 on FPGA Virtex 7</a></li>
<li><a href="../317196/index.html">Berkeley Unified Parallel C (UPC). Debugging with the GNU gdb C debbuger. Call stack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>