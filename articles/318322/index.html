<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>19 unexpected finds in the Node.js documentation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I would like to think that I quite well know Node. For three years now, as none of the sites I have been working on, it cannot do without it. But so f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>19 unexpected finds in the Node.js documentation</h1><div class="post__text post__text-html js-mediator-article">  I would like to think that I quite well know Node.  For three years now, as none of the sites I have been working on, it cannot do without it.  But so far I have not read the documentation properly. <br><br>  I like to write useful things about interfaces, properties, methods, functions, data types, and everything else related to web development.  So I fill in the gaps in knowledge.  Now I'm busy with the documentation for Node.js, and before that I worked on HTML, DOM, Web API, CSS, SVG and EcmaScript. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e21/fbf/1f7/e21fbf1f75aef5ebb3411d7df24a1bc3.jpg" alt="image"></div><br>  Reading the Node.js documentation revealed a lot of great things to me that I didn‚Äôt know before.  I want to share them in this little material.  I'll start with the most interesting.  I also usually do when I show my gadgets to my new acquaintance. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">1. Module querystring as a universal parser</font> </h2><br>  Let's say you got the data from some eccentric database, which produced an array of key / value pairs in about the form: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <code>name:Sophie;shape:fox;condition:new</code> .  It is quite natural to assume that this can be easily converted to a JavaScript object.  Therefore, you create an empty object, then an array, dividing the string by the symbol ‚Äú <code>;</code>  ".  Next - loop through each element of this array, break the lines again, now by the ‚Äú <code>:</code> ‚Äù symbol.  As a result, the first element received from each line becomes the name of the property of the new object, the second one - the value. <br><br>  Is that right? <br><br>  No, not right.  In this situation, it suffices to use the <a href="https://nodejs.org/api/querystring.html"><code>querystring</code></a> . <br><br><pre> <code class="hljs ruby">const weirdoString = <span class="hljs-string"><span class="hljs-string">`name:Sophie;shape:fox;condition:new`</span></span>; const result = querystring.parse(weirdoString, <span class="hljs-string"><span class="hljs-string">`;`</span></span>, <span class="hljs-string"><span class="hljs-string">`:`</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> : <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> <span class="hljs-string"><span class="hljs-string">`Sophie`</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-symbol"><span class="hljs-symbol">shape:</span></span> <span class="hljs-string"><span class="hljs-string">`fox`</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-symbol"><span class="hljs-symbol">condition:</span></span> <span class="hljs-string"><span class="hljs-string">`new`</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> };</code> </pre> <br><h2>  <font color="#3AC1EF">2. Debugging: V8 Inspector</font> </h2><br>  If you run Node with the <code>--inspect</code> key, it will report the URL.  Go to this address in Chrome.  And now - a pleasant surprise.  We are available to <a href="https://nodejs.org/api/debugger.html">debug Node.js</a> using the Chrome developer tools.  Happy times are here.  Here is a <a href="https://medium.com/%40paul_irish/debugging-node-js-nightlies-with-chrome-devtools-7c4a1b95ae27">guide</a> on this topic from Paul Irish. <br><br>  It should be noted that this function still has the status of an experimental one, but I gladly use it, and so far it has not failed me. <br><br><h2>  <font color="#3AC1EF">3. Difference between nextTick and setImmediate</font> </h2><br>  As is the case with many other software mechanisms, remembering the difference between these two functions is very easy if you give them more meaningful names. <br><br>  So, the <a href="https://nodejs.org/api/process.html"><code>process.nextTick()</code></a> function should be called <code>process.sendThisToTheStartOfTheQueue()</code> .  And <a href="https://nodejs.org/api/timers.html"><code>setImmediate()</code></a> - <code>sendThisToTheEndOfTheQueue()</code> . <br><br>  By the way, here is a useful material about the <a href="https://nodejs.org/en/blog/release/v0.10.0/">optimization of</a> <code>nextTick</code> starting from Node v0.10.0.  A small retreat.  I always thought that in React <code>props</code> should be called <code>stuffThatShouldStayTheSameIfTheUserRefreshes</code> , and <code>state</code> - <code>stuffThatShouldBeForgottenIfTheUserRefreshes</code> .  The fact that these names have the same length, consider a good match. <br><br><h2>  <font color="#3AC1EF">4. Server.listen accepts an object with parameters</font> </h2><br>  I am an adherent of passing parameters as an object, for example, with the name ‚Äúoptions‚Äù, and not an approach, when a bunch of parameters are expected at the input to a function, which, moreover, have no names, and they should also be arranged in a strictly defined order.  As it turned out, when setting up the server to <a href="https://nodejs.org/api/net.html">listen to requests,</a> you can use an object with parameters. <br><br><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">`http`</span></span>) .createServer() .listen({   <span class="hljs-symbol"><span class="hljs-symbol">port:</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span>,   <span class="hljs-symbol"><span class="hljs-symbol">host:</span></span> <span class="hljs-string"><span class="hljs-string">`localhost`</span></span>, }) .on(<span class="hljs-string"><span class="hljs-string">`request`</span></span>, (req, res) =&gt; {   res.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(<span class="hljs-string"><span class="hljs-string">`Hello World!`</span></span>); });</code> </pre> <br>  This useful feature is well hidden.  In the documentation for <a href="&amp;xid=17259,15700023,15700043,15700186,15700190,15700248,15700253&amp;usg=ALkJrhi7zWOA1hcbKwio6rbO_BdR0elCeA#http_class_"><code>http.Server</code></a> about her - not a word.  However, it can be found in the description of <a href="https://nodejs.org/api/net.html"><code>net.Server</code></a> , which is <code>http.Server</code> . <br><br><h2>  <font color="#3AC1EF">5. Relative file paths</font> </h2><br>  The path in the file system, which is passed to the <a href="https://nodejs.org/api/fs.html"><code>fs</code></a> module, can be relative.  The starting point is the current working directory returned by <code>process.cwd()</code> .  Probably, this is what everyone knows, but I always thought that I could not do without full ways. <br><br><pre> <code class="hljs ruby">const fs = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">`fs`</span></span>); const path = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">`path`</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     ... fs.readFile(path.join(__dirname, <span class="hljs-string"><span class="hljs-string">`myFile.txt`</span></span>), (err, data) =&gt; { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  -  }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     ? fs.readFile(<span class="hljs-string"><span class="hljs-string">`./path/to/myFile.txt`</span></span>, (err, data) =&gt; { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  -  });</code> </pre> <br><h2>  <font color="#3AC1EF">6. Parsing files</font> </h2><br>  Usually, when I needed to get his name and extension out of the file path, I used regular expressions.  Now I understand that there is absolutely no need for this.  The same can be done by <a href="https://nodejs.org/api/path.html">standard means</a> . <br><br><pre> <code class="hljs pgsql">myFilePath = `/someDir/someFile.json`; <span class="hljs-type"><span class="hljs-type">path</span></span>.parse(myFilePath).base === `someFile.json`; // <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span>.parse(myFilePath).name === `someFile`; // <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span>.parse(myFilePath).ext === `.json`; // <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">7. Coloring logs in the console</font> </h2><br>  I‚Äôll pretend that I didn‚Äôt know that the <code>console.dir(obj, {colors: true})</code> construct allows objects to <a href="https://nodejs.org/api/console.html">be displayed in the console</a> with properties and values ‚Äã‚Äãhighlighted in color.  This makes it easier to read logs. <br><br><h2>  <font color="#3AC1EF">8. control setInterval ()</font> </h2><br>  For example, you use <code>setInterval()</code> to clean the database once a day.  By default, the Node event loop will not stop as long as there is code that is scheduled to be executed using <code>setInterval()</code> .  If you want to give Node a rest (I don‚Äôt know, in fact, what advantages you can get from this), use the <a href="https://nodejs.org/api/timers.html"><code>unref()</code></a> function. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dailyCleanup = setInterval(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { cleanup(); }, <span class="hljs-number"><span class="hljs-number">1000</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">24</span></span>); dailyCleanup.unref();</code> </pre> <br>  However, it is worth being careful here.  If the Node is no longer busy (for example, there is no http server waiting for connections), it will exit. <br><br><h2>  <font color="#3AC1EF">9. Process completion constants</font> </h2><br>  If you like to kill, then you probably already did: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">process</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.kill</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">process</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pid</span></span>, `<span class="hljs-selector-tag"><span class="hljs-selector-tag">SIGTERM</span></span>`);</code> </pre> <br>  I can‚Äôt say anything bad about this design.  But what if there was a mistake in the command caused by a typo?  In the history of programming such cases are known.  The second parameter here must be a string or a corresponding integer, so it is not surprising to write something wrong.  In order to insure against errors, you can do this: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">process</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.kill</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">process</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pid</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">os</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.constants</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.signals</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.SIGTERM</span></span>);</code> </pre> <br><h2>  <font color="#3AC1EF">10. Verify IP Addresses</font> </h2><br>  Node.js has a built-in tool for <a href="https://nodejs.org/api/net.html">checking IP addresses</a> .  I used to write regular expressions more than once to do this.  For more intelligence was not enough.  Here's how to do it right: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">require</span></span>(`<span class="hljs-selector-tag"><span class="hljs-selector-tag">net</span></span>`)<span class="hljs-selector-class"><span class="hljs-selector-class">.isIP</span></span>(`10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span>`)</code> </pre> <br>  will return <code>4</code> . <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">`net`</span></span>).isIP(<span class="hljs-string"><span class="hljs-string">`cats`</span></span>)</code> </pre> <br>  will return <code>0</code> . <br><br>  That's right, cats are not IP addresses. <br><br>  You may have noticed that in the examples I use single quotes for strings.  I like to do that, but I suspect that it looks strange, so I consider it necessary to mention this, although I myself don‚Äôt really know why.  In general, this is my style. <br><br><h2>  <font color="#3AC1EF">11. End of line character, os.EOL</font> </h2><br>  Have you ever asked for a line ending character?  Yes?  Everything, put out the light.  Here, especially for those who did, a wonderful thing: <a href="https://nodejs.org/api/os.html"><code>os.EOL</code></a> .  On Windows, this will give <code>\r\n</code> , on all other operating systems - <code>\n</code> .  <a href="https://github.com/sasstools/sass-lint/pull/92/files"><code>  os.EOL</code></a> will ensure uniform code behavior in different operating systems. <br><br>  Here I will make an amendment, since at the time of writing this article, it was not enough to go into this topic.  Readers of the previous version of this post pointed out to me that using <code>os.EOL</code> can lead to trouble.  The fact is that here it is necessary to proceed from the assumption that in a certain file either CRLF ( <code>\r\n</code> ) or LF ( <code>\n</code> ) can be used, but one cannot be completely sure of such an assumption. <br><br>  If you have an open source project, and you want to forcefully use a specific line feed, here is the <a href="http://eslint.org/docs/rules/linebreak-style">eslint rule</a> , which, in part, can help.  True, it is useless if Git works with texts. <br><br>  And yet, <code>os.EOL</code> is not a useless toy.  For example, this thing may be useful when generating log files that are not planned to be transferred to other operating systems.  In this case, <code>os.EOL</code> ensures that such files are correctly displayed, for example, for viewing which is used Notepad in Windows Server. <br><br><pre> <code class="hljs ruby">const fs = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">`fs`</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      CRLF fs.readFile(<span class="hljs-string"><span class="hljs-string">`./myFile.txt`</span></span>, <span class="hljs-string"><span class="hljs-string">`utf8`</span></span>, (err, data) =&gt; { data.split(<span class="hljs-string"><span class="hljs-string">`\r\n`</span></span>).forEach(line =&gt; {   <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  -  }); }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       const os = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">`os`</span></span>); fs.readFile(<span class="hljs-string"><span class="hljs-string">`./myFile.txt`</span></span>, <span class="hljs-string"><span class="hljs-string">`utf8`</span></span>, (err, data) =&gt; { data.split(os.EOL).forEach(line =&gt; {   <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  -  }); });</code> </pre> <br><h2>  <font color="#3AC1EF">12. HTTP status codes</font> </h2><br>  Node has a ‚Äúdirectory‚Äù with HTTP status codes and their names.  I'm talking about the <a href="&amp;xid=17259,15700023,15700043,15700186,15700190,15700248,15700253&amp;usg=ALkJrhi7zWOA1hcbKwio6rbO_BdR0elCeA#http_"><code>http.STATUS_CODES</code></a> object.  His keys are state codes, and the values ‚Äã‚Äãare their names. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5ce/5ec/73b/5ce5ec73b2f2a0a947e7210fb9b114ef.png"></div><br>  <i><font color="#999999">Http.STATUS_CODES object</font></i> <br><br>  Here's how to use it: <br><br><pre> <code class="hljs ruby">someResponse.code === <span class="hljs-number"><span class="hljs-number">301</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">`http`</span></span>).STATUS_CODES[someResponse.code] === <span class="hljs-string"><span class="hljs-string">`Moved Permanently`</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">13. Prevent unnecessary server shutdowns.</font> </h2><br>  It has always seemed a little strange to me that a code like the one below causes the server to stop. <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">const</span></span> jsonData = getDataFromSomeApi(); //   !  ! const <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">JSON</span></span></span><span class="hljs-class">.parse(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">jsonData</span></span></span><span class="hljs-class">); //    .</span></span></code> </pre> <br>  In order to prevent such nonsense, right at the beginning of the application for Node.js you can put such a construction, which displays <a href="https://nodejs.org/api/process.html">unhandled exceptions</a> to the console: <br><br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">process</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(`uncaughtException`, console.<span class="hljs-literal"><span class="hljs-literal">error</span></span>);</code> </pre> <br>  Of course, I am in my right mind, so I use <a href="http://pm2.keymetrics.io/">PM2</a> and wrap everything I can in <code>try‚Ä¶catch</code> blocks when I program to order, but in home projects ... <br><br>  I want to pay special attention to the fact that this approach in no way belongs to the ‚Äú <a href="https://nodejs.org/api/process.html">best practical development methods</a> ‚Äù, and its use in large and complex applications is probably a bad idea.  Decide for yourself whether to trust a post on a blog written by some dude or official documentation. <br><br><h2>  <font color="#3AC1EF">14. A few words about once ()</font> </h2><br>  In addition to the <code>on()</code> method, <code>EventEmitter</code> objects <code>EventEmitter</code> have a <a href="https://nodejs.org/api/events.html"><code>once()</code></a> method.  I am quite sure that I am the last person on Earth who has learned about it.  Therefore, I limit myself to a simple example, which everyone will understand. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.once(`request`, (req, res) =&gt; res.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(`<span class="hljs-keyword"><span class="hljs-keyword">No</span></span> more <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> me.`));</code> </pre> <br><h2>  <font color="#3AC1EF">15. Customizable console</font> </h2><br>  <a href="https://nodejs.org/api/console.html">The console</a> can be configured using the following design, passing it its own output streams: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">new</span></span> console.Console(standardOut, <span class="hljs-literal"><span class="hljs-literal">error</span></span>Out)</code> </pre> <br>  What for?  I do not know for sure.  Maybe you want to create a console that outputs data to a file, or to a socket, or somewhere else. <br><br><h2>  <font color="#3AC1EF">16. DNS queries</font> </h2><br>  One bird whistled to me here that Node <a href="https://github.com/nodejs/node/issues/5893">did not cache the</a> results of DNS queries.  Therefore, if you refer to a certain URL several times, priceless milliseconds are spent on requests, without which it would be possible to do.  In this case, you can query the DNS yourself, using <a href="https://nodejs.org/api/dns.html"><code>dns.lookup()</code></a> , and cache the results.  Or, use the <a href="https://www.npmjs.com/package/dnscache">dnscache</a> package, which does the same. <br><br><pre> <code class="hljs coffeescript">dns.lookup(`<span class="javascript"><span class="javascript">www.myApi.com</span></span>`, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err, address)</span></span></span><span class="hljs-function"> =&gt;</span></span> { cacheThisForLater(address); });</code> </pre> <br><h2>  <font color="#3AC1EF">17. Module fs: minefield</font> </h2><br>  If your programming style is similar to mine, that is, it is something like: ‚ÄúI will read a piece of documentation diagonally and will mess around with the code until it works,‚Äù then you are not insured against problems with the <a href="https://nodejs.org/api/fs.html"><code> fs</code></a> .  The developers have done a lot of work aimed at unifying the interaction of Node with various operating systems, but their capabilities are not unlimited.  As a result, features of various operating systems break the ocean surface of the code as sharp reefs, which are also mined.  And you in this drama play the role of a boat that can sit on one of the reefs. <br><br>  Unfortunately, the differences related to <code>fs</code> are not reducible to the usual: ‚ÄúWindows and everyone else‚Äù, so we cannot just brush it off, hiding behind the idea: ‚Äúyes, who uses Windows‚Äù.  (I first wrote here a whole speech about anti-Windows sentiment in web development, but in the end I decided to remove it, otherwise I got my eyes on my forehead from this my sermon). <br><br>  Here, in brief, what I found in the documentation for the <code>fs</code> module.  I am sure that these revelations can bite somebody as well as a roasted rooster. <br><br><ul><li>  The <code>mode</code> property of the object returned by <code>fs.stats(),</code> different in Windows and other operating systems.  On Windows, it may not correspond to file access constants, such as <code>fs.constants.S_IRWXU</code> . <br><br></li><li>  The <code>fs.lchmod()</code> function is available only in macOS. <br></li><li>  Calling <code>fs.symlink()</code> with the <code>type</code> parameter is supported only on Windows. <br><br></li><li>  The <code>recursive</code> option, which can be passed to the <code>fs.watch()</code> function, works only on Windows and macOS. <br><br></li><li>  The <code>fs.watch()</code> callback function accepts a file name only on Linux and Windows. <br><br></li><li>  The <code>fs.open()</code> call with the <code>a+</code> flag for the directory will work on FreeBSD and on Windows, but will not work on macOS and Linux. <br></li><li>  The <code>position</code> parameter passed to <code>fs.write()</code> will be ignored in Linux if the file is opened in attachment mode.  The kernel ignores the position and appends data to the end of the file. </li></ul><br>  (I‚Äôm not keeping up with fashion here, I‚Äôm calling Apple‚Äôs OS ‚ÄúmacOS‚Äù, although it‚Äôs not even two months after the old name, OS X, passed away). <br><br><h2>  <font color="#3AC1EF">18. The net module is twice as fast as the http module</font> </h2><br>  Reading the documentation for Node.js, I realized that the <a href="https://nodejs.org/api/net.html"><code>net</code></a> module is a thing.  It is the basis of the <code>http</code> module.  It made me think that if you need to organize the interaction of servers (as it turned out, I needed it), should I use the <code>net</code> module only? <br><br>  Those who are closely involved in networking systems may not believe that such a question should be asked at all, but I am a web developer who has suddenly fallen into the world of servers and knows only HTTP and nothing else.  All these TCP, sockets, all this talk about threads ... For me, it's like <a href="https://www.youtube.com/watch%3Fv%3DFQgH4G3qypI">Japanese rap</a> .  That is, it seems to me incomprehensible, but it sounds intriguing. <br><br>  In order to sort things out, experiment with <code>net</code> and <code>http</code> , and compare them, I set up a couple of servers (I hope you are listening to Japanese rap) and loaded them with requests.  As a result, <a href="&amp;xid=17259,15700023,15700043,15700186,15700190,15700248,15700253&amp;usg=ALkJrhi7zWOA1hcbKwio6rbO_BdR0elCeA#http_class_"><code>http.Server</code></a> was able to process approximately 3400 requests per second, and <a href="https://nodejs.org/api/net.html"><code>net.Server</code></a> - approximately 5500. In addition, <code>net.Server</code> easier to <code>net.Server</code> . <br><br>  Here, if you are interested, the code of clients and servers with which I experimented.  If you're not interested, please apologize for having to scroll the page for so long. <br><br>  Here is the <a href="https://gist.github.com/davidgilbertson/8c38f7604eb95cec2836be68217e643b">client.js</a> code. <br><br><pre> <code class="hljs pgsql">//    .  ‚Äì  TCP-,  ‚Äì  HTTP (    <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.js). //         . //       . const net = require(`net`); const http = require(`http`); <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> parseIncomingMessage(res) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Promise((resolve) =&gt; {   let data = ``;   res.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(`data`, (chunk) =&gt; {     data += chunk;   });   res.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(`<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>`, () =&gt; resolve(data)); }); } const testLimit = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*  ------------------  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  --  NET client  --  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ------------------  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> testNetClient() { const netTest = {   startTime: process.hrtime(),   responseCount: <span class="hljs-number"><span class="hljs-number">0</span></span>,   testCount: <span class="hljs-number"><span class="hljs-number">0</span></span>,   payloadData: {     <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: `millipede`,     feet: <span class="hljs-number"><span class="hljs-number">100</span></span>,     test: <span class="hljs-number"><span class="hljs-number">0</span></span>,   }, }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> handleSocketConnect() {   netTest.payloadData.test++;   netTest.payloadData.feet++;   const payload = <span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify(netTest.payloadData);   this.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(payload, `utf8`); } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> handleSocketData() {   netTest.responseCount++;   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (netTest.responseCount === testLimit) {     const hrDiff = process.hrtime(netTest.startTime);     const elapsedTime = hrDiff[<span class="hljs-number"><span class="hljs-number">0</span></span>] * <span class="hljs-number"><span class="hljs-number">1e3</span></span> + hrDiff[<span class="hljs-number"><span class="hljs-number">1</span></span>] / <span class="hljs-number"><span class="hljs-number">1e6</span></span>;     const requestsPerSecond = (testLimit / (elapsedTime / <span class="hljs-number"><span class="hljs-number">1000</span></span>)).toLocaleString();     console.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>(`net.<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> handled an average <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> ${requestsPerSecond} requests per second.`);   } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (netTest.testCount &lt; testLimit) {   netTest.testCount++;   const socket = net.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(<span class="hljs-number"><span class="hljs-number">8888</span></span>, handleSocketConnect);   socket.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(`data`, handleSocketData); } } <span class="hljs-comment"><span class="hljs-comment">/*  -------------------  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  --  HTTP client  --  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  -------------------  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> testHttpClient() { const httpTest = {   startTime: process.hrtime(),   responseCount: <span class="hljs-number"><span class="hljs-number">0</span></span>,   testCount: <span class="hljs-number"><span class="hljs-number">0</span></span>, }; const payloadData = {   <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: `centipede`,   feet: <span class="hljs-number"><span class="hljs-number">100</span></span>,   test: <span class="hljs-number"><span class="hljs-number">0</span></span>, }; const <span class="hljs-keyword"><span class="hljs-keyword">options</span></span> = {   hostname: `localhost`,   port: <span class="hljs-number"><span class="hljs-number">8080</span></span>,   <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>: `POST`,   headers: {     <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: `application/x-www-form-urlencoded`,   }, }; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> handleResponse(res) {   parseIncomingMessage(res).<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(() =&gt; {     httpTest.responseCount++;     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (httpTest.responseCount === testLimit) {       const hrDiff = process.hrtime(httpTest.startTime);       const elapsedTime = hrDiff[<span class="hljs-number"><span class="hljs-number">0</span></span>] * <span class="hljs-number"><span class="hljs-number">1e3</span></span> + hrDiff[<span class="hljs-number"><span class="hljs-number">1</span></span>] / <span class="hljs-number"><span class="hljs-number">1e6</span></span>;       const requestsPerSecond = (testLimit / (elapsedTime / <span class="hljs-number"><span class="hljs-number">1000</span></span>)).toLocaleString();       console.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>(`http.<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> handled an average <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> ${requestsPerSecond} requests per second.`);     }   }); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (httpTest.testCount &lt; testLimit) {   httpTest.testCount++;   payloadData.test = httpTest.testCount;   payloadData.feet++;   const payload = <span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify(payloadData);   <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>[`Content-Length`] = Buffer.byteLength(payload);   const req = http.request(<span class="hljs-keyword"><span class="hljs-keyword">options</span></span>, handleResponse);   req.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(payload); } } <span class="hljs-comment"><span class="hljs-comment">/*  --  Start tests  --  */</span></span> // flip these occasionally <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ensure ther<span class="hljs-string"><span class="hljs-string">e's no bias based on order setTimeout(() =&gt; { console.info(`Starting testNetClient()`); testNetClient(); }, 50); setTimeout(() =&gt; { console.info(`Starting testHttpClient()`); testHttpClient(); }, 2000);</span></span></code> </pre> <br>  Here is <a href="https://gist.github.com/davidgilbertson/8c38f7604eb95cec2836be68217e643b">server.js</a> . <br><br><pre> <code class="hljs pgsql">//    .  ‚Äì TCP,  ‚Äì HTTP. //          <span class="hljs-type"><span class="hljs-type">JSON</span></span>,      ,       . const net = require(`net`); const http = require(`http`); <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> renderAnimalString(jsonString) { const data = <span class="hljs-type"><span class="hljs-type">JSON</span></span>.parse(jsonString); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> `${data.test}: your are a ${data.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> you have ${data.feet} feet.`; } <span class="hljs-comment"><span class="hljs-comment">/*  ------------------  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  --  NET server  --  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ------------------  */</span></span> net .createServer((socket) =&gt; {   socket.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(`data`, (jsonString) =&gt; {     socket.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(renderAnimalString(jsonString));   }); }) .<span class="hljs-keyword"><span class="hljs-keyword">listen</span></span>(<span class="hljs-number"><span class="hljs-number">8888</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*  -------------------  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  --  HTTP server  --  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  -------------------  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> parseIncomingMessage(res) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Promise((resolve) =&gt; {   let data = ``;   res.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(`data`, (chunk) =&gt; {     data += chunk;   });   res.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(`<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>`, () =&gt; resolve(data)); }); } http .createServer() .<span class="hljs-keyword"><span class="hljs-keyword">listen</span></span>(<span class="hljs-number"><span class="hljs-number">8080</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(`request`, (req, res) =&gt; {   parseIncomingMessage(req).<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>((jsonString) =&gt; {     res.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(renderAnimalString(jsonString));   }); });</code> </pre> <br><h2>  <font color="#3AC1EF">19. Tricks of the REPL mode</font> </h2><br><ol><li>  If you are working in the <a href="https://nodejs.org/api/repl.html">REPL</a> mode, that is, you wrote a <code>node</code> in the terminal and pressed <b>Enter</b> , you can enter a command like <code>.load someFile.js</code> and the system will load the requested file (for example, a bunch of constants can be specified in such a file). <br><br></li><li>  In this mode, you can set the environment variable <code>NODE_REPL_HISTORY=""</code> in order to disable the recording of history to a file.  In addition, I learned (at least - remembered) that the REPL history file, which allows you to travel to the past, is stored at <code>~/.node_repl_history</code> . <br><br></li><li>  The underscore character " <code>_¬ª</code> is the name of a variable that stores the result of the last expression executed.  I think it can be useful. <br><br></li><li>  When the Node starts up in REPL mode, the modules are loaded automatically (more precisely, on request).  For example, you can simply type <code>os.arch()</code> on the command line to find out the architecture of the OS.  A construct like <code>require(`os`).arch();</code>  need not. <br></li></ol><br><h2>  <font color="#3AC1EF">Results</font> </h2><br>  As you can see, reading the documentation is a good thing.  Many new can be found even in the area, which, like, you know along and across.  I hope you find my finds useful. <br><br>  By the way, do you know anything else interesting about Node.js?  If so - share :) </div><p>Source: <a href="https://habr.com/ru/post/318322/">https://habr.com/ru/post/318322/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318310/index.html">FX Architecture: a revolution for data convergence</a></li>
<li><a href="../318312/index.html">New Year Bug Stories</a></li>
<li><a href="../318316/index.html">Friday format: Successful vacation for an IT specialist or some other favorite work</a></li>
<li><a href="../318318/index.html">Analog. Net Entity Framework in Delphi through RTTI. Part one, introductory</a></li>
<li><a href="../318320/index.html">NFV MANO Platform Review from the open source community</a></li>
<li><a href="../318324/index.html">Personal experience: how we chose the DLP system</a></li>
<li><a href="../318326/index.html">Boring about decoding</a></li>
<li><a href="../318328/index.html">ABBYY Cloud OCR SDK subscriptions: ‚Äúshut up and take my money!‚Äù</a></li>
<li><a href="../318330/index.html">Dataset study with IMDB</a></li>
<li><a href="../318332/index.html">Admin Generator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>