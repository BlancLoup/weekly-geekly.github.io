<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sphinx distribute. Accelerate the search</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I recently needed to revisit the work of the full-text search engine Sphinx , since some of the frequent requests took seconds, and some even more tha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sphinx distribute. Accelerate the search</h1><div class="post__text post__text-html js-mediator-article">  I recently needed to revisit the work of the full-text search engine <a href="http://sphinxsearch.com/">Sphinx</a> , since some of the frequent requests took seconds, and some even more than ten.  After searching for vulnerabilities and ways to optimize, I found a simple way to improve performance - load parallelization across multiple threads, as a result I got a good reduction in query time. <br><br>  One of the unpleasant features of Sphinx is very poor information in Russian.  Surprised that the topic of load distribution was not addressed, I decided to share this solution on Habr√©. <br><br>  <b>Objective</b> : To improve the performance of Sphinx by splitting the load into multiple threads. <br><a name="habracut"></a><br>  <b>Solution</b> : split indexes and specify the number of threads in the configuration. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Execution threads </h4><br>  Let's start with a simpler one ‚Äî specifying the number of threads to execute.  Suppose that our server has a quad core processor, so the best way is to use four threads.  To do this, use the <a href="http://sphinxsearch.com/docs/current/conf-dist-threads.html">dist_threads</a> directive in the <i>searchd</i> section of the configuration file. <br><br><pre><code class="hljs">searchd { ... dist_threads = 4 ... }</code> </pre> <br>  The directive indicates the maximum number of threads to process a request.  The default value is 0, which implies non-use of multi-threading. <br><br><h4>  Index Separation </h4><br>  Next, we divide the indices so that each thread processes its own interval of records.  In other words: for example, in our table there are 1,000,000 entries and four streams.  It is necessary for each stream to process 1,000,000 / 4 = 250,000 entries, so that Sphinx later obtains the results of the work of these streams and gives the most relevant result.  It is logical that four threads processing 250,000 records will do their job more quickly than one stream processing 1,000,000 records almost four times. <br><br>  Suppose we have some source and index: <br><br><pre> <code class="hljs pgsql">source books { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = mysql sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id, <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tb_books } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> books { source = books min_infix_len = <span class="hljs-number"><span class="hljs-number">3</span></span> }</code> </pre><br>  For example, let's leave the <a href="http://sphinxsearch.com/docs/current/conf-min-infix-len.html">min_infix_len</a> directive. <br>  To divide the index into four parts, create four sources with limited recording intervals and assign them by <i>index</i> 'at: <br><br><pre> <code class="hljs pgsql">source books_base { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = mysql } source books0: books_base { sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id, <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tb_books <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id % <span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> } source books1: books_base { sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id, <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tb_books <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id % <span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> } source books2: books_base { sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id, <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tb_books <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id % <span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span> } source books3: books_base { sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> id, <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tb_books <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> id % <span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> ind_books_base { min_infix_len = <span class="hljs-number"><span class="hljs-number">3</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> ind_books0: ind_books_base { source = books0 } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> ind_books1: ind_books_base { source = books1 } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> ind_books2: ind_books_base { source = books2 } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> ind_books3: ind_books_base { source = books3 } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> ind_books { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = distributed <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> = ind_books0 <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> = ind_books1 <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> = ind_books2 <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> = ind_books3 }</code> </pre><br>  The easiest way to divide the table into approximately equal parts is to specify the number of entries in the query <i>id</i> , but this is not the only way.  Alternatively, you can use the <a href="http://sphinxsearch.com/docs/current.html">sql_query_range</a> directive, but in my case this method did not work due to the non-uniform distribution of <i>id</i> -records of records over the table. <br><br>  It is good practice to point out the ancestors of <i>indexes</i> and <i>sourcs</i> to inherit from them and put some duplicate directives in them.  In this case, I have issued <i>type</i> and <i>min_infix_len</i> directives in them. <br><br>  In order to have some index that could be accessed for results, we created an <i>ind_books</i> index with a type of <a href="http://sphinxsearch.com/docs/current.html">distributed,</a> in <a href="http://sphinxsearch.com/docs/current.html">local</a> directives which indicated the names of the indices, the results of which must be obtained. <br><br><h4>  Delta </h4><br>  If you use the <a href="http://habrahabr.ru/post/146999/">delta index,</a> then the simplest solution is to merge it with one of the obtained indices. <br><br>  However, in this case, it is necessary to keep in mind that if <i>delta</i> turns out to be too large, then the selected index, with which we merge it, will be noticeably more than the others, which can negatively affect performance.  To prevent this, it is best to merge it with all indices in turn. <br><br>  Ultimately, using this method allowed me to reduce the query time from 2 to 10 times. </div><p>Source: <a href="https://habr.com/ru/post/263849/">https://habr.com/ru/post/263849/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263837/index.html">Corporate Cisco Jabber: Version 11 is very pleased</a></li>
<li><a href="../263839/index.html">Bartle's Psychotypes and Audience Balancing</a></li>
<li><a href="../263841/index.html">Google Chrome for Windows switched to using the AppContainer sandbox</a></li>
<li><a href="../263843/index.html">Acceleration of image processing in Android</a></li>
<li><a href="../263845/index.html">Hacker projects on Kickstarter</a></li>
<li><a href="../263853/index.html">Magic of tensor algebra: Part 15 - Motion of a non-free solid</a></li>
<li><a href="../263855/index.html">Operation Potao: Malware Analysis for cyber espionage, part 1</a></li>
<li><a href="../263859/index.html">Automating the ip-network using the tools at hand (Python)</a></li>
<li><a href="../263861/index.html">Alarm, ahtung, attention, whistle all the server</a></li>
<li><a href="../263863/index.html">How to find a place on earth and not get to the Yandex counter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>