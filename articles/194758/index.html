<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Scale a real-life project database using SQL Azure Federations. Part 3: Migration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I welcome all residents of Habrahabr! All successful new work week! So, we continue the process of migrating the database to use SQL Azure Federations...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Scale a real-life project database using SQL Azure Federations. Part 3: Migration</h1><div class="post__text post__text-html js-mediator-article">  I welcome all residents of Habrahabr!  All successful new work week!  So, we continue the process of migrating the database to use SQL Azure Federations.  As you remember, <a href="http://habrahabr.ru/company/epam_systems/blog/193874/">last time</a> we decided which table and field we would break the database into shards.  Let's finally do it! <br><br><h4>  Migration </h4><br>  So, we will break the database on the table of accounts (Account), since the data stored in it and associated with it logically with each other do not overlap.  Since we have a database creation script, we will try to adapt it to use SQL Azure Federations. <br><br>  We assume that the database has already been created in the Windows Azure Management Portal or through SQL Server Management Studio. <br><a name="habracut"></a><br>  Open the script to create objects in the database. <br> <code>USE xPenses</code> <br> <code>GO</code> <br> <br> <code>IF EXISTS (SELECT name FROM sysobjects where name = N'Operation') DROP TABLE Operation</code> <br> <code>...</code> <br> <br>  The first thing to remove is the use of a USE operation, since this is one of the main limitations of SQL Azure.  One database - one connection.  Instead, add requests to create a federation: <br> <code>-- A database must be selected before executing this statement</code> <br> <code>CREATE FEDERATION Accounts(AccountId BIGINT RANGE)</code> <br> <code>GO</code> <br> <br> <code>USE FEDERATION Accounts(AccountId = 1) WITH RESET, FILTERING = OFF</code> <br> <code>GO</code> <br> <br>  Please note that if you connect using SSMS to SQL Azure Server, you must select a database from the list to execute the query. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage3/6e3/a47/849/6e3a478493a25df9b012c02b1491a14a.png"><br><br>  Thus, we will create a new federation, the data of which is distributed according to the value of the account identifier (Account ID).  Please note that at the moment there are no tables in the database, that is, the AccountId field is not associated with any data set in real tables.  The field name may also differ from the field name of the table, which will be distributed. <br><br>  Here we can see another logical <a href="http://msdn.microsoft.com/en-us/library/windowsazure/hh597460.aspx">limitation of SQL Azure Federations</a> .  The field over which the distribution will be performed must be of type INT, BIGINT, UNIQUEIDENTIFIER and VARBINARY. <br><br>  After creating the federation, we need to select the first shard in which we begin to enter data.  That is, the shard that stores the data of the first account (AccountId = 1). <br><br>  See our script further.  We need to modify the creation of the table of accounts so that SQL Azure knows that the data of this particular table will be distributed across shards across the Id field. <br> <code>CREATE TABLE Account (</code> <br> <code>[Id] INTEGER NOT NULL PRIMARY KEY IDENTITY(1,1),</code> <br> <code>[EntityId] INTEGER NOT NULL FOREIGN KEY REFERENCES Entity(Id),</code> <br> <code>[Currency] NVARCHAR(3)</code> <br> <code>)</code> <br> <br>  Thus, the table creation script will turn into the following: <br> <code>CREATE TABLE Account (</code> <br> <code>[Id] BIGINT NOT NULL,</code> <br> <code>[EntityId] INTEGER NOT NULL FOREIGN KEY REFERENCES Entity(Id),</code> <br> <code>[Currency] NVARCHAR(3),</code> <br> <code>CONSTRAINT [PK_Account] PRIMARY KEY CLUSTERED</code> <br> <code>(</code> <br> <code>[Id] ASC</code> <br> <code>)</code> <br> <code>) FEDERATED ON (AccountId= Id)</code> <br> <br>  So what has changed?  The ID field type has become BIGINT.  In addition, we lost the ability to automatically generate values ‚Äã‚Äãfor this field when inserting a new record.  This is another of the limitations of SQL Azure Federations.  However, it remains possible to use the keyword DEFAULT.  For example, this will be useful if the type of the field ID is UNIQUEIDENTIFIER.  In this case, we can declare a field like this: <br> <code>[Id] UNIQUEIDENTIFIERNOT NULL DEFAULT NEWID()</code> <br> <br>  Then when inserting new records into the table, we don‚Äôt need to specify the ID of the created record.  When working with other types, this logic should be implemented at the application level. <br><br>  The next thing you should pay attention to is the declaration of the main key of the table.  We need to explicitly indicate that the key being created will be clustered. <br><br>  The last thing to do is to indicate using the FEDERATED ON keyword that the table will be federated.  We will break the data in it by the ID field. <br><br>  So, with the creation of a table of accounts we figured out.  We go further.  As can be seen from the database schema, the table of accounts is the parent of the ‚Äúcredit card‚Äù and ‚Äúbank account‚Äù tables. <br><br><img src="https://habrastorage.org/storage3/d9a/b3f/4b3/d9ab3f4b38c15e392af5cc8d884cb19b.png"><br><br><habracut><br><br>  That is, the BankAccount and CreditCard tables have a foreign key to the Account table.  Since the table of accounts is now federated with us, it is impossible to ensure the integrity of the links of one table to another. <br><br>  This is another <a href="http://msdn.microsoft.com/en-us/library/windowsazure/hh597469.aspx">limitation of SQL Azure Federations</a> .  The tables on which the data is distributed (federated table) cannot be referenced in other tables.  That is, it will be necessary to remove all foreign keys from the tables referring to the accounts table (Account). <br><br>  Thus, the script to create a table, for example, CreditCard, instead of the form: <br> <code>CREATE TABLE CreditCard (</code> <br> <code>[Id] INTEGER NOT NULL PRIMARY KEY IDENTITY(1,1),</code> <br> <code>[AccountId] INTEGER NOT NULL FOREIGN KEY REFERENCES Account(id),</code> <br> <code>[Type] NVARCHAR(MAX)</code> <br> <code>CONSTRAINT CreditCardType CHECK (</code> <br> <code>[Type] = 'Visa'</code> <br> <code>OR [Type] = 'MasterCard'</code> <br> <code>OR [Type] = 'JCB'</code> <br> <code>OR [Type] = 'AmericanExpress'),</code> <br> <code>[Number] NVARCHAR(MAX)</code> <br> <code>)</code> <br> <br>  It will look like: <br> <code>CREATE TABLE CreditCard (</code> <br> <code>[Id] INTEGER NOT NULL PRIMARY KEY IDENTITY(1,1),</code> <br> <code>[AccountId] BIGINT NOT NULL,</code> <br> <code>[Type] NVARCHAR(MAX)</code> <br> <code>CONSTRAINT CreditCardType CHECK (</code> <br> <code>[Type] = 'Visa'</code> <br> <code>OR [Type] = 'MasterCard'</code> <br> <code>OR [Type] = 'JCB'</code> <br> <code>OR [Type] = 'AmericanExpress'),</code> <br> <code>[Number] NVARCHAR(MAX)</code> <br> <code>)</code> <br> <br>  That is, the integrity of the reference records from the table of credit cards to the table of accounts falls on the shoulders of the application logic. <br><br>  If you try to execute the database creation script at this stage, then all the tables will be successfully created, but besides the tables there are also two procedures in the database.  The first of them - adding a new category does not require changes, since its logic does not go beyond the bounds of a single shard. <br><br>  But the procedure for adding a new account (AddAccount) requires small changes.  So consider the source code of this procedure: <br> <code>CREATE PROCEDURE AddAccount(</code> <br> <code>@Name NVARCHAR(MAX),</code> <br> <code>@Description NVARCHAR(MAX),</code> <br> <code>@Currency NVARCHAR(3),</code> <br> <code>@Instrument NVARCHAR(MAX),</code> <br> <code>@Type NVARCHAR(MAX),</code> <br> <code>@Number NVARCHAR(MAX)</code> <br> <code>)</code> <br> <code>AS</code> <br> <code>INSERT INTO Entity VALUES (@Name, @Description)</code> <br> <code>DECLARE @EntityId INTEGER = (SELECT Id FROM Entity WHERE Name = @Name AND Description = @Description)</code> <br> <br> <code>INSERT INTO Account VALUES (@EntityId, @Currency)</code> <br> <br> <code>IF (@Instrument = 'BankAccount')</code> <br> <code>BEGIN</code> <br> <code>INSERT INTO BankAccount VALUES (</code> <br> <code>(SELECT Id FROM Account WHERE Account.EntityId = @EntityId),</code> <br> <code>@Type,</code> <br> <code>@Number</code> <br> <code>) END</code> <br> <br> <code>IF (@Instrument = 'CreditCard')</code> <br> <code>BEGIN</code> <br> <code>INSERT INTO CreditCard VALUES (</code> <br> <code>(SELECT Id FROM Account WHERE Account.EntityId = @EntityId),</code> <br> <code>@Type,</code> <br> <code>@Number</code> <br> <code>) END</code> <br> <code>GO</code> <br> <br>  In fact, the changes that need to be made are fairly obvious.  Since we have lost the ability to automatically generate the value of the ID field for the account, this logic falls on the shoulders of the application logic.  That is, we need to make changes to the procedure header: <br> <code>CREATE PROCEDURE AddAccount(</code> <br> <code>@AccountId BIGINT,</code> <br> <code>@Name NVARCHAR(MAX),</code> <br> <code>@Description NVARCHAR(MAX),</code> <br> <code>@Currency NVARCHAR(3),</code> <br> <code>@Instrument NVARCHAR(MAX),</code> <br> <code>@Type NVARCHAR(MAX),</code> <br> <code>@Number NVARCHAR(MAX)</code> <br> <code>)</code> <br> <code>AS</code> <br> <code>INSERT INTO Entity VALUES (@Name, @Description)</code> <br> <code>DECLARE @EntityId INTEGER = (SELECT Id FROM Entity WHERE Name = @Name AND Description = @Description)</code> <br> <br> <code>INSERT INTO Account VALUES (@AccountId, @EntityId, @Currency)</code> <br> <code>...</code> <br> <code>GO</code> <br> <br>  Accordingly, the insertion of records in the account table, instead of the code: <br> <code>EXEC AddAccount 'Cash', 'Everyday cash account', 'USD', NULL, NULL, NULL</code> <br> <br>  Now it will take on input one more parameter (ID of the account being created): <br> <code>EXEC AddAccount 1, 'Cash', 'Everyday cash account', 'USD', NULL, NULL, NULL</code> <br> <br>  Probably the next logical question would be the following: is it possible to add the command to use the necessary federation (USE FEDERATION) to the body of the procedure?  Since, if the ID of the created account has come to us, then we know with which federation we need to work, which means we can go straight to using the necessary shard: <br> <code>USE FEDERATION Accounts(AccountId = @AcccountId) WITH RESET, FILTERING = OFF</code> <br> <code>GO</code> <br> <br>  Unfortunately, if you do this, SSMS will give you an error.  The thing is that the AddAccount procedure is stored in a particular shard, which means that we have no possibility of using USE FEDERATION.  In addition, the use of USE FEDERATION is generally impossible in procedures.  The code for switching federations must be located "level up". <br><br>  This completes the changes that need to be made in the database creation script.  We can execute it without errors.  As a result, one federation root and one shard (federation member) will be created. <br><br><img src="https://habrastorage.org/storage3/c1f/551/c64/c1f551c64bb61fab4daae9e47a5f7bc6.png"><br><br><h4>  Sharding </h4><br>  All that is left for us to do is, in fact, produce scaling databases.  That is, to separate the data related to one account from the data of another account. <br><br>  To do this, create a separate script: <br> <code>-- Scaling out the federation</code> <br> <code>USE FEDERATION ROOT WITH RESET</code> <br> <code>GO</code> <br> <br> <code>ALTER FEDERATION Accounts SPLIT AT (AccountId = 2)</code> <br> <code>GO</code> <br> <br>  The first thing that makes this script is to use federation root, that is, it works within the xPenses database, because the information about federations (metadata) is stored there. <br><br>  Then we indicate that we want to split the federation with the name Accounts, starting with the value of the AccountId field equal to 2. That is, the data of the first account remain in the shard already created, and the data of the other accounts are transferred to the next shard.  Also note that we do not indicate anywhere that the data is broken down into an account table.  We only work with xPenses database metadata! <br><br><img src="https://habrastorage.org/storage3/c1f/551/c64/c1f551c64bb61fab4daae9e47a5f7bc6.png"><br><br>  So, let's execute this command and ... The situation is quite possible when updating the Object Explorer window you will see the following: <br><br><img src="https://habrastorage.org/storage3/67d/70e/c3e/67d70ec3eab49545c7e68113ae86e869.png"><br><br>  Instead of one new shard, we got ... As many as 3!  In fact, nothing unusual about it.  The thing is that the data stored in the first shard is copied in accordance with the value of AccountId.  That is, for an account with an ID of 1, you need to copy the data to one shard, with an ID of 2 to another.  Of course it takes time.  After SQL Azure redistributes data across shards, we see that we really have a database with federation metadata and two shards. <br><br><img src="https://habrastorage.org/storage3/bff/507/230/bff507230d774ca3496b062c190bdbcc.png"><br><br>  Now, if we need to allow splitting the data into 3 shards, for example, the account data with an ID of 3 is transferred to a separate shard, we just need to run the following command: <br> <code>ALTER FEDERATION Accounts SPLIT AT (AccountId = 3)</code> <br> <code>GO</code> <br> <br><h4>  Conclusion </h4><br>  We have reviewed the migration process of the database creation script using SQL Azure Federations.  As you can see, most of the sharp corners are quite simple.  However, a fairly large part of the database logic should be transferred ‚Äúhigher‚Äù.  We stopped at the database level.  In real projects, it is highly recommended to start a thorough analysis of the subject area and database architecture before starting the migration to SQL Azure Federations. </habracut></div><p>Source: <a href="https://habr.com/ru/post/194758/">https://habr.com/ru/post/194758/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194740/index.html">Sooner or later we will have to do it.</a></li>
<li><a href="../194742/index.html">How we shot NY 41x41</a></li>
<li><a href="../194746/index.html">AJAX in Joomla components! 2.5</a></li>
<li><a href="../194748/index.html">Overview of the stand-case with a Micro USB keyboard for a 7 "tablet</a></li>
<li><a href="../194750/index.html">Another tacacs +</a></li>
<li><a href="../194760/index.html">Side Effects Cryptography</a></li>
<li><a href="../194764/index.html">RailsClub'Moscow 2013. Conference news</a></li>
<li><a href="../194774/index.html">The coolest PC system unit (DIY)</a></li>
<li><a href="../194776/index.html">How the creators of Pivotal Tracker work ... On the development, management and hiring of people</a></li>
<li><a href="../194778/index.html">How changes in US Internet law can make life difficult for Russian game developers and game platform operators</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>