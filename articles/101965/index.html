<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IPhone Software Optimization: a live example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Programming on the iOS platform (the one that was recently called the iPhone OS) is a strange combination of joy from fruitful work and the agony of s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IPhone Software Optimization: a live example</h1><div class="post__text post__text-html js-mediator-article">  Programming on the iOS platform (the one that was recently called the iPhone OS) is a strange combination of joy from fruitful work and the agony of swimming against the tide.  Each developer has his own opinion as to which of these components prevails.  Personally, I like this activity, so it seemed to me appropriate to share my impressions of the <i>process of</i> working on another project. <br><br>  At the end of March I was offered to write a mobile version of <a href="http://www.bookmate.ru/">Bookmate</a> for iPhone.  The design of the most part of the application was already ready in the form of a thick PSD, on the server side the work was in full swing, I had, as they say, ‚Äúonly‚Äù to write the client part in Objective-C. <br><br>  In this article we will discuss the first container with a rake, attacking us.  If you play Starcraft, the analogy with the zerg will be more suitable, which suddenly climbed out of all the cracks in typically incredible quantities. <br><a name="habracut"></a><br><h4>  Architecture </h4><br>  In a nutshell, Bookmate is a server that stores books consisting of a set of HTML files.  The main task of the Bookmate client (in common, "reading rooms") is to show and process this HTML.  Why html?  Unlike, for example, PDF, it is easy enough to reformat it when changing the font size, which is absolutely necessary in a mobile application on a tiny screen.  On the other hand, since HTML does not have the usual concept of a page, it is, strictly speaking, not very suitable for displaying books in the traditional page form.  To correctly transfer a line that does not fit on the screen to the next page, you need to know its vertical indent on the page.  To do this, the HTML engine must first process the entire document and calculate the size and coordinates of all the blocks in the document according to the style sheet.  After that, you can do what any typesetting program does like Adobe InDesign or QuarkXPress. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Colleagues from Bookmate by that time had already written a library in JavaScript, which does all this nicely and quickly. <br><br><h4>  Hello iPhone </h4><br>  As a base test platform, we chose the iPhone 3G, because  this is both very popular in Russia, and the oldest iPhone model I still have.  As one of the test books, the publication ‚ÄúModels for assembly‚Äù by Julio Cortazar was made in one file of 890 KB in size. <br><br>  The first prototype was UIWebView, a JavaScript library and some (albeit substantial) amount of code in the interlayer between them in Objective-C. <br><br>  iPhone 3G is a very, very smart phone.  <i>Mostly</i> .  Honestly, I hardly ever tried to open such heavy sites in Mobile Safari, and I‚Äôm not sure that these are found in nature.  Poor iPhone!  For the more than 40 seconds that he spent on the opening of the ‚ÄúModel for assembly‚Äù, he managed to close all other applications due to lack of memory, and shout at me that now the memory will end altogether, and moan about hard fate, and warm not able to change anything. <br><br>  But at that moment we had no time for joking.  The first vanguard of the avant-garde clutched at the foot, and the earth shook under the horde, still invisible, but already terrible. <br><br>  To optimize, in fact, there was nothing.  For a good half of these 40 seconds, WebKit was engaged in parsing, building a DOM, recalculating geometry, and devouring (for lack of other terms) memory.  The latter is in itself a serious problem in iOS due to the inability to use a disk for virtual memory, and in our case, this also led to the need to urgently free up memory due to background programs (such as Mail and Phone), which also takes time.  JavaScript, iterating over the entire DOM, just finished off WebKit. <br><br>  Such performance, obviously, did not suit anyone.  It was also obvious that JavaScript on the iPhone is not fast enough for our purposes, and that we cannot afford 20 MB of memory. <br><br><h4>  And what to do with it? </h4><br>  To better understand the scale of the disaster, you need a little interruption to the description of the context in which it occurs.  WebKit is <a href="http://webkit.org/">an open source library</a> .  But in iOS, it refers to a <i>private API</i> , the use of which is prohibited by Apple.  Even if it were possible to build WebKit for iOS on its own and include it in the program as a static library, UIKit is already linked with WebKit, which inevitably leads to character collisions;  even if you rename the entire WebKit and avoid collisions, UIWebView does not provide any access to the WebKit components on which it is built: see above for using the private API.  It turns out that we cannot get to the DOM from Objective-C directly, without JavaScript.  And that means, as the one-eyed blind tortoise said recently, ‚ÄúWell, that's it, they came.‚Äù <br><br>  All that remains is to forget WebKit: parse the HTML using libxml and draw the DOM manually.  That is, you need to write your own HTML engine.  I could agree on this only for the sake of experiment, in order to understand whether it makes sense in terms of performance.  In the end, I saw the source of WebKit and am aware of the futility of trying to rewrite it alone, while making it much faster.  On the other hand, we do not use the features of WebKit even by 10%.  If you write your own highly specialized engine, it will be ten times easier than any modern browser.  Oh, where our not disappeared! <br><br><h4>  libXML </h4><br>  At annually held in hell for programmers competition for the worst API libxml again the main prize.  Perhaps I find fault, but the source is much clearer than the <a href="http://www.xmlsoft.org/html/libxml-HTMLparser.html">documentation</a> .  Typical example: <br> <code>Function: htmlCtxtReset <br> void htmlCtxtReset(htmlParserCtxtPtr ctxt) <br> Reset a parser context <br> ctxt: an HTML parser context</code> <br>  In all seriousness, is that all ?!  Everything that is written here is clear from the names of the function and the argument.  What exactly does this feature do?  Why is it needed?  When to use it?  What, I'm sorry, <a href="http://veillard.com/">I</a> wrote this <a href="http://veillard.com/">dunce</a> ?  Sit down, libxml, deuce. <br><br>  It is fair to say that the library itself works well enough for almost everyone to use it.  And in life it is much easier.  And there is on every iPhone. <br><br><h4>  First results </h4><br>  In order to lose as little time as possible on a dead-end development, I started from the slowest section.  This is the calculation of the size of blocks of text, which is reduced to the summation of the sizes of <a href="http://ru.wikipedia.org/wiki/%25D0%2593%25D0%25BB%25D0%25B8%25D1%2584">glyphs</a> .  The results of performance measurements were not without surprises. <br><ul><li>  UIWebView + JavaScript - 38 seconds, 20 MB of memory.  This is our first option after all optimizations. </li><li>  NSString, -sizeWithFont: - 14 seconds, 8 MB of memory.  Since it makes no sense to repeatedly calculate the size of the same glyphs in the same font, the results are cached.  35% of the time it takes to call the method - [NSString sizeWithFont:]. </li><li>  Core Text under iPhone OS 3.1.3 - more than 70 seconds.  Core Text is a private API in iPhone OS up to version 3.2, I just wanted to compare its speed, because  It is amazingly easy to use and very fast on a Mac. </li></ul><br>  Armed with numbers, I wrote a letter to those.  support for developers (so-called <a href="http://developer.apple.com/programs/iphone/test.html">DTS</a> , Developer Technical Support, which is generally a paid service).  At the same time he asked why the underlying function CGFontGetGlyphsForUnichars () - [NSString sizeWithFont:] belongs to a private API. <br><br>  That's why I respect Apple, because it is related to developers, when the latter do not whine on the whole Internet, but ask questions "in the prescribed form."  Two days later I received a detailed answer to my questions, from which it followed: <br><ul><li>  access to WebKit is not provided by party policy; </li><li>  Core Text under iPhone OS prior to version 3.2 is a private API due to being too slow;  since version 3.2, it should be significantly faster than UIWebView + JavaScript; </li><li>  CGFontGetGlyphsForUnichars () is a private API due to its not quite adequate design;  On the Internet, you can find its analogues and make sure that this is the case; </li><li>  In general, I am on the right path, because they themselves do not know the other; </li><li>  you'll have to choose between convenience - [NSString sizeWithFont:] and Core Graphics speed. </li></ul><br><br><h4>  For the cause! </h4><br>  Algorithm text layout sounds pretty simple, if not go into details.  First you need to break the text into fragments with the same style, for example, if in the middle of a block of text there is a phrase in italics, such a block is divided into three style fragments.  Then you need to understand where the text <i>can be</i> transferred to a new line - these are, as a rule, punctuation between words or hyphenation within words.  Let's call them candidates for the transfer.  Then we take fragments of the text between candidates for transfer, one by one, count their length, and put them on a line until their total length exceeds the length of the line.  Similar to pages: we add lines until the next line comes out beyond the height of the page. <br><br>  It turns out an impressive set of objects: each block of text (for example, a paragraph) consists of an array of strings containing so-called.  <i>glyph runs</i> - text fragments of the same style.  These same glyph runs we draw as they are. <br><br>  At this point, there are interesting opportunities for optimization, and the code quickly turns into spaghetti.  As we descend to the lowest-level API, it becomes clear that there is not enough linguistic education.  On the horizon, there are all new writing systems with which this code does not work.  For example, because of the direction of the letter, as in Arabic or Hebrew, or because there are no spaces between words, as in Thai. <br><br>  As a result, realizing that it was impossible to grasp the immense from the first attempt, I had to postpone the support of languages ‚Äã‚Äãwith the direction of writing from right to left and languages ‚Äã‚Äãlike Thai, which I know too little.  For the same reason, the implementation of text alignment at both edges has been postponed - it requires an efficient hyphenation system, which, in turn, needs to know in what language each word is. <br><br>  Nevertheless, in terms of productivity, significant progress was achieved compared to what we started with.  Now the masterpiece of Cortazar appears on the screen in less than 6 (!) Seconds.  It was a really tough month.  I had to temporarily reflash my brain, otherwise he refused to work with HTML and CSS.  My wife all this time listened from my corner only grunting and swearing.  The client was also not sweet: firstly, no one counted on an extra month, secondly, the start of work on the project was discouraged (‚Äúa pretty start, what will happen next?‚Äù), Thirdly, there were no guarantees that this pile of plywood will be able to take off at all.  However, who does not risk, that goes on foot.  And we so wanted to heaven! <br><br>  The Bookmate application is already available in the <a href="http://itunes.com/apps/bookmate">App Store</a> (the link opens in iTunes; if for some reason it does not work, there is <a href="http://itunes.apple.com/ru/app/id386177450%3Fmt%3D8">an alternative one</a> , it opens in a browser). <br><br><h4>  Epilogue </h4><br>  About Steve Jobs tell the <a href="http://www.folklore.org/StoryView.py%3Fproject%3DMacintosh%26story%3DSaving_Lives.txt">story</a> .  In 1983, he urged engineers to optimize the loading time of a mac with these words: ‚ÄúHow many people will use a mac?  Million?  No more.  I bet a few years later, five million people will turn on their macs at least once a day.  Suppose you can reduce the boot time by 10 seconds.  Multiply it by five million users, it will turn out 50 million seconds, every single day.  For the year it's probably dozens of lives.  If you load it 10 seconds faster, you saved a dozen lives.  Well, is it worth it? ‚Äù  I think yes. </div><p>Source: <a href="https://habr.com/ru/post/101965/">https://habr.com/ru/post/101965/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../101955/index.html">The Rage engine on the iPhone showed an impressive 60 fps</a></li>
<li><a href="../101957/index.html">D'Artagnan and the Internet, or work on the problem of broken links</a></li>
<li><a href="../101960/index.html">JavaFX Competition: Tower Defense</a></li>
<li><a href="../101963/index.html">Media server, collect their own hands from those found in the "bins of the motherland"</a></li>
<li><a href="../101964/index.html">Review of fresh materials, July 2010</a></li>
<li><a href="../101967/index.html">Evernote Gallery: Awesome Note Organizer</a></li>
<li><a href="../101969/index.html">let's get acquainted</a></li>
<li><a href="../101970/index.html">21st century minimalism</a></li>
<li><a href="../101971/index.html">Setting Group Restricted Use Policies in Windows 7</a></li>
<li><a href="../101973/index.html">B / In Ukraine, using scrap, destroyed the database of quality certificates for all types of products</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>