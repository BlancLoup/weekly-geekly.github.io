<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How have I been pwned? scaled under high load and how much it cost (<$ 25)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The picture shows a graph of the growth of traffic that cloud adepts around the world sell as one of the scenarios, where elastic scaling has a high v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How have I been pwned? scaled under high load and how much it cost (<$ 25)</h1><div class="post__text post__text-html js-mediator-article">  The picture shows a graph of the growth of traffic that cloud adepts around the world sell as one of the scenarios, where elastic scaling has a high value: <br><br><img alt="12h an hour almost immediately" src="https://habrastorage.org/getpro/habr/post_images/d90/dc0/fce/d90dc0fcea9d0fa2b32e4d1b11d0936e.png" width="800" height="168"><br><br>  Is this the schedule for <a href="https://haveibeenpwned.com/">Have I been pwned?</a>  (HIBP), which at one moment began to serve from ~ 100 sessions per hour to ... 12000 sessions per hour.  Almost instantly. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This happened during the week in September, when traffic literally increased 60 times.  September 10 - 2105 sessions, September 11 - 124036 sessions.  Interesting things happen when the load increases so dramatically, so quickly.  So I wanted to share with you a few things that I learned - what was done by me well and what needed to be improved. <br><a name="habracut"></a><br>  Oh, by the way, why did traffic grow so sharply?  Because the news everywhere reported that <a href="http://time.com/3318853/google-user-logins-bitcoin/">5 million Gmail accounts were hacked</a> .  Of course, in reality they meant that 5 million addresses of unknown origin, almost entirely on gmail.com, were merged into the Russian forum with the corresponding passwords.  But this in no way prevented a large number of people from going crazy around the world and coming to HIBP in order to check whether they were or not the ‚Äúlucky ones‚Äù whose data leaked to the network.  This gave me the opportunity to experience a unique experience and set interesting tasks for me to solve.  Let me go through some tasks. <br><br><h3>  1) Measure everything as early as possible. </h3><br>  Do you know that you can not fix something that you are not able to measure?  Yes, in fact, it is very difficult to understand what is happening now, if you do not have the ability to measure different things.  I had three really important tools that helped me a lot: <br><br>  <strong>Google Analytics:</strong> this is the source of the graphics you saw above and I actively used this tool while the load was increasing, practically in real time studying how many people were on the site at a certain point in time (at least those who did not block in tracking): <br><br><img alt="Google Analytics showing 1175 people on the site right now" src="https://habrastorage.org/getpro/habr/post_images/ef9/d17/d2e/ef9d17d2e376f166233612e1cf6bbc9d.png" width="367" height="244"><br><br>  <strong>New Relic:</strong> This is an absolutely cool tool and if you still do not use it in your cloud websites, then I suggest you rather read Scott Hanselman's article on <a href="http://www.hanselman.com/blog/PennyPinchingInTheCloudEnablingNewRelicPerformanceMonitoringOnWindowsAzureWebsites.aspx">how to start using the service for free</a> . <br><br><img alt="NewRelic web transactions response time graph" src="https://habrastorage.org/getpro/habr/post_images/e16/1bf/d65/e161bfd65fc56dd413e7ec68aa44d005.png" width="800" height="326"><br><br>  In fact, it was the very first truly useful tool, not only to determine how hard I felt, but also to determine the possible causes that affect system performance.  I took this graph immediately after scaling, it shows a lot of errors in the interval from 2:30.  In addition, the graph shows a large increase in the CLR time metric. And as you can see, things went much better right after 6:00. <br><br>  NewRelic was also a tool that was available from anywhere from any device.  The iPad application is just great, it contains information panels that provide all the necessary information from the total number of requests, to requests to certain pages.  Browser and server timings with details such as network latency and DOM rendering turned out to be particularly useful data (NewRelic adds some client scripts that will allow to receive such data).  These data later showed me how heavily the server is loaded: <br><br><img alt="NewRelic dashboard on the iPad" src="https://habrastorage.org/getpro/habr/post_images/750/3cb/ddc/7503cbddc6d52524c0b5c608a8bbc6cc.png" width="800" height="600"><br><br>  <strong>Azure monitoring:</strong> you get Azure monitoring features for free, they are available to you in the Azure management portal.  Monitoring allows you to monitor a number of metrics for which you end up paying for it, so watching them is really important: <br><br><img alt="Azure &amp; # 39;  s website monitoring graph" src="https://habrastorage.org/getpro/habr/post_images/0d3/8bf/572/0d38bf572eda99f323914863c8748fc9.png" width="800" height="405"><br><br>  They also fit well into the platform's notification service (Azure Alerts), which I will discuss shortly. <br><br>  The most important thing in all of this is that from the very beginning I had really good sources of information on a number of metrics and knew what was going on at any given time.  I did not have to spend time on immersion and research on what the hell is going on in reality, since I already saw the whole picture in front of me in a convenient way. <br><br><h3>  2) Configure notifications </h3><br>  I understood about the drama that arose on Thursday morning due to the fact that my mailbox was filled with notifications - there were dozens of them and they all looked like this: <br><br><img alt="Azure alert for high CPU usage" src="https://habrastorage.org/getpro/habr/post_images/1b2/79d/f36/1b279df364ccacb66ff3708236014748.png" width="300" height="532"><br><br>  This is a notification from Azure for the metrics of the CPU, and I also set up a similar one to notify if a certain number of requests have been exceeded.  All these notifications refer to the monitoring metrics about which I spoke above and they let me know that something unusual is happening with my service. <br><br>  Other notifications were from NewRelic, notifications about the full load of the service were especially useful (NewRelic periodically pings endpoints and checks the availability of the connection to the database and the storage), and notifications about the degradation of the Apdex index were also useful: <br><br><img alt="Alert from NewRelic for a low Apdex" src="https://habrastorage.org/getpro/habr/post_images/956/92c/053/95692c0536f8344508774d3db95d02a9.png" width="700" height="394"><br><br>  <a href="https://docs.newrelic.com/docs/apm/new-relic-apm/apdex/apdex-measuring-user-satisfaction">Apdex</a> is the NewRelic way of measuring user satisfaction from the site and the coolest thing about it is that it collects all the indicators from the database and request queues to the CLR time and simply says ‚Äúwill the user be satisfied with the response timeout? ".  This question includes the real user too - the one that loads your website through a bad connection from another part of the world and the one that works through high-speed 4G next to the data center itself.  I will not dive deeply into this question here, just to show how the picture of my service looked on Thursday morning: <br><br><img alt="NewRelic Apdex showing a big drop during high load" src="https://habrastorage.org/getpro/habr/post_images/d3c/07a/200/d3c07a2000e9933fa1b083e88aa00152.png" width="446" height="201"><br><br>  At the lowest point, more than 25,000 users were modeled and of these, too many had a review of the site as ‚ÄúUnpleasant‚Äù simply because the system was too slow.  She worked - but too slowly.  In any case, the main thing is that I was <em>very</em> happy to have proactive notifications about what is happening with my site. <br><br>  But from all this follows the next question - why has the system slowed down?  Didn't I have a ‚Äúcloud scaling‚Äù?  Have I recently <a href="http://www.troyhunt.com/2014/07/scaling-standard-azure-website-to-380k.html">told you</a> with <a href="http://www.troyhunt.com/2014/07/scaling-standard-azure-website-to-380k.html">pleasure how great the scaling of services is in Azure</a> ?  Yes, that's it, except for one problem ... <br><br><h3>  3) Initially set the maximum scaling limit </h3><br>  If you are unfamiliar with the concept of scaling or do not know how it works in Azure, then first read the material <a href="http://www.troyhunt.com/2014/07/scaling-standard-azure-website-to-380k.html">on the link</a> .  In short, scaling is accomplished by approaching when new instances of the same resources are added, instead of increasing the capacity of an already existing resource.  In Azure, this means I can do things like this: <br><br><img alt="Setting the instance count in Azure" src="https://habrastorage.org/getpro/habr/post_images/f46/304/8a2/f463048a2b06a8e174d427946d6e629d.png" width="631" height="132"><br><br>  See the problem?  Yes, I left the number ‚Äú3‚Äù as the maximum number of copies.  That's all.  This is the reason why my ‚ÄúApdex‚Äù index became unacceptable, as Azure did exactly what I indicated to it.  Looking at it now, my decision seems silly to me.  This restriction exists so that you do not scale to the maximum number of instances automatically and a month after that did not receive a shocking account for the cloud.  However, when you have <em>notifications</em> , such a restriction of yourself becomes meaningless.  Let me explain: <br><br>  Azure uses per-minute billing.  Lift a copy, use it for an hour and a half and turn it off; you will only pay for 90 minutes of consumption.  Regardless of the size of the instance, 90 minutes will cost you <em>less than a dollar</em> for any purpose.  If you set up notifications, for example, to an unusually high level of requests (this is configured in the Azure management portal), you will know that your environment was scaled almost as soon as this happens, and maybe even <em>before</em> it happens.  It depends on how you set up the notifications.  Bearing in mind such advantages, I would rather choose to scale the service up to 10 copies with paying an extra pair of dollars than the pain of my users working with one single copy. <br><br>  In fact, it seems strange, why you may <em>not want to</em> scale at all?  I mean, you won't say ‚ÄúWow!  My site is actually very successful, I think I should leave my users suffering a little bit more. ‚Äù  Some people may worry about the effects of such things as DDoS attacks, but these are the things that come to light quickly using the tools I described above. <br><br>  So my advice is to maximize your level of automatic scaling of the service and stop worrying (I'll talk about the money side a little later). <br><br><h3>  4) Scale in advance </h3><br>  Horizontal scaling (adding instances) can occur automatically, but vertical scaling (increasing the size of each instance) is a manual process.  Both processes give you the opportunity to increase computing capacity, but at the same time, they achieve this in different ways.  In <a href="http://www.troyhunt.com/2014/07/scaling-standard-azure-website-to-380k.html">this article on Azure,</a> I said that when moving from a small instance to a medium sized instance, both performance and price doubled.  Switching from medium to large size doubles the parameters again and so on - the larger the instance, the more you get. <br><br>  When I discovered a problem with scaling due to a limit of three instances, I not only increased it to 10, but also changed the size of the instances from small to medium.  Why?  Partly because I was not sure that ten small copies would be enough, but also because I wanted to allocate more resources to handling high loads as soon as possible and quickly returning my site to normal operation. <br><br>  Another reason is that larger instances under load will not exhaust their resources so quickly.  Pay attention to the schedule: <br><br><img alt="Very fast change" src="https://habrastorage.org/getpro/habr/post_images/c0e/5cd/445/c0e5cd44529e782737ce623493bf55ad.png" width="737" height="187"><br><br>  Here you can see that at midnight there were 727 sessions, then 753 at one in the morning, at two o'clock already 9042 and 11910 at three in the morning, This is a <em>significant</em> change in a very short period of time.  Returning to the issue of performance, when Azure scales up a service, adding an instance, it looks for some time how things are (this time is configured), and then if necessary adds another instance and so on.  The pause period between adding an instance was set to 45 minutes, which gave Azure a lot of time to understand how things are going with the load and decide whether or not to add another instance.  But since traffic grew so quickly, an additional small-instance could have exhausted its resources very quickly, in a much shorter period than the pause period.  A medium copy gave me much more room to maneuver. <br><br>  Of course, large copies would give me even more power.  One day, our two-year-old child woke up crying at one in the morning of Friday night and my wife went to check on him.  Being a caring parent, I decided to check how my HIBP site is doing and saw about 2,200 requests per minute with four medium instances raised.  I changed the size of the copies to large and went back to sleep - more reinsured.  (And yes, the human child was all right too!) <br><br><h3>  5) Azure cloud is <em>incredibly</em> stable </h3><br>  Obviously, the site HIBP received a severe blow, I have no doubt.  If anything is to be expected when the site is full of requests, it is that its work will begin to fail.  Obviously, one of these failures is to slow down the site and in fact Apdex clearly shows this.  Another failure could be the fact that the site under load will begin to pour errors of various kinds, many of which NewRelic can determine.  And that's what was discovered: <br><br><img alt="Error rate at 0.0078%" src="https://habrastorage.org/getpro/habr/post_images/04e/f1a/894/04ef1a89494ffdfeed72c5a19c80822c.png" width="459" height="232"><br><br>  The key in the figure is the value in the upper right corner - the error rate is 0.0078% or in other words, this means that only 1 request out of 128,000 produced an error during the week.  Of course, this value is based only on those requests that, in principle, were received by the site and were processed by NewRelic cloud monitoring.  The red lines in the figure reflect the moment when the HIBP site was determined to be non-operational (fallen) (NewRelic connects to the site from the outside and checks whether it works or not).  I must say that I saw the reports of NewRelic that the site ‚Äúfell‚Äù, but after that I had the opportunity to enter the site through the browser without any problems right during the ‚Äúfall‚Äù period.  The ping function by which the service checks the site is an approximate constant of 2.66 requests per minute, so it is quite possible that the site was working when it was noted that it was ‚Äúlying‚Äù (or ‚Äúlying‚Äù at the time when it was said that it was working!): <br><br> <a href=""><img alt="Ping throughput rate at 2.66RPM" src="https://habrastorage.org/getpro/habr/post_images/dc9/168/90e/dc916890e7a15f33b3c4396c539e245b.png" width="773" height="184"></a> <br><br>  Inevitably, some of the requests could return with gateway timeout errors (gateway timeouts), but the fact that it continued to work so well under such a load is impressive. <br><br><h3>  6) <em>Grow thin</em> in advance </h3><br>  I‚Äôll share with you one little magic trick - faster sites scale faster.  I know the revelation, right?  :) <br><br>  In December, I wrote about <a href="http://www.troyhunt.com/2013/12/micro-optimising-web-content-for.html">world optimizations for web content for unexpected, wild success</a> .  Impressive then the popularity of the site pales in comparison with the past week, but what I did then helped me <em>to really</em> optimize the site for the moment when the load took off again.  Let me demonstrate what I mean.  Here is the site as it looks today: <br><br><img alt="The present day HIBP website" src="https://habrastorage.org/getpro/habr/post_images/4e5/949/84d/4e594984d1ebb758c240465c95037cf6.png" width="700" height="547"><br><br>  Bearing in mind our desire to scale specifically this site as much as possible, let's look at all requests that are sent to haveibeenpwned.com in boot order: <br><br><img alt="4 requests being made to HIBP" src="https://habrastorage.org/getpro/habr/post_images/599/be7/205/599be72053d2be6d10f2f2f9765d54e1.png" width="800" height="85"><br><br>  Wait - what ?!  Yeah, just four requests.  The reason why the number of requests to the site is so small is as follows: <br><br><ol><li>  I use a public CDN for everything that is possible.  I will talk about this in more detail separately, as this is a very important topic; </li><li>  I use the <a href="http://azure.microsoft.com/en-us/documentation/articles/cdn-how-to-use/">Azure CDN service</a> for all icons of hacked (pwned) companies.  This allows you to redirect requests from the site to distribute them worldwide; </li><li>  All JavaScript scripts and CSS styles are packed and minified.  This is good for end users who will have to make fewer HTTP requests and good for a site that will send less bytes from each request.  It would be nice to put them in the CDN too, but being able to overwrite them when editing the code and letting them automatically send via ASP.NET is much more important to me, considering how often I change different things. </li></ol><br>  But of course, all this can be improved even more.  For a start, 32KB is too much for a favicon - twice as much as the other content that comes from the domain!  Initially, I made it in the form of 64x64 pixels, which is more than enough, but ideally it could even be in the form of 48x48.  So I changed the icon and removed half the size, and then put it in the CDN, adding the link tag to the head of my template.  So another request and another 32KB of code disappeared for my clients.  This change will take effect the next time I publish the modified code. <br><br>  Another thing that allowed the site to lose weight was the fact that there was practically no work on the server to create the page - only the controller returns the view.  In fact, the Azure SQL Database (SQL Azure) was used to generate a list of leaks, but even with this, here's what the throughput looked like: <br><br><img alt="Response time for the SQL Azure database" src="https://habrastorage.org/getpro/habr/post_images/2eb/e23/d4f/2ebe23d4fb03b994911be4415f7e6b8e.png" width="800" height="173"><br><br>  Hmm ... - almost linear.  Yeah, all because the data is cached and actually requested by the home page from the database once every five minutes.  This shows us that the database is significantly isolated from high loads.  And in fact, the most protracted request is the one that checks the presence in the database of the user who subscribes to the notification.  This peak query looks like this: <br><br><img alt="Requests for checking" src="https://habrastorage.org/getpro/habr/post_images/8c6/ce9/928/8c6ce99288a95d8c82b4193a9fe88248.png" width="800" height="166"><br><br>  This corresponds to only 3.43k requests in two hours, or one lazy request in two seconds.  Of course, I was lucky that my site is of this type, which does not require frequent access to the database and this changes a lot when the load is seriously increased.  In such cases, multiple database connections can quickly increase the response time to user requests. <br><br>  So, if I do not often request data from the database, then how do I actually check the hacked accounts?  I talked in detail about this in my previous post, <a href="http://www.troyhunt.com/2013/12/working-with-154-million-records-on.html">‚ÄúThe story of‚Äú Have I been pwned? ‚Äù</a> , But in short, the answer is Azure Table Storage.  As described in my blog, this repository is extremely fast in scripts when you just need to select a row by a key field (for example, email in my case), just as I structured the data on the HIBP website.  This led to my Table Storage usage statistics looking like this: <br><br><img alt="Table Storage usage" src="https://habrastorage.org/getpro/habr/post_images/870/715/9bf/8707159bfa8ac6f3fc4d7f84d9f5d27f.png" width="722" height="494"><br><br>  Two big peaks look strange here.  They are caused by the fact that I uploaded 5 million GMail accounts on Thursday morning and then another 5 million mail.ru records 1 million yandex.ru records the next day.  Although the site was uploaded at this time, the download of 11 million entries had no effect on the availability or performance of the site. <br><br>  However, from the table we can find out some useful data, for example, the average delay on the server was around 7 ms.  <em>Seven milliseconds</em> !  In fact, even with a huge load, this figure remained at the same level and was even closer to 4 ms.  The only thing that, as you can see, actually changed was the percentage of successful requests.  The reason for this is simple - when someone searched for data via email and received zero results, such a request was considered ‚Äúfailed‚Äù in statistics. <br><br>  In conclusion of this section, I would like to say that the site was extremely effective from the very beginning and that is why I was able to scale it even wider.  I can not fail to highlight the importance of this again: optimizations are absolutely critical for the growth of the load and, of course, they make working with the site even more enjoyable even during normal work.  Optimize your site as soon as possible, before you need these optimizations. <br><br><h3>  7) Steal bandwidth from others! </h3><br>  So, as described above, I used the CDN for whatever is possible.  These include jQuery, Bootstrap (CSS and JS) and Font Awesome.  It looks like this: <br><br><img alt="Requests to external CDNs" src="https://habrastorage.org/getpro/habr/post_images/59a/c13/826/59ac13826252d986d7c4c41526b219da.png" width="569" height="98"><br><br>  This is a great opportunity to increase productivity.  Firstly, it allows reducing the number of requests to HIBP and reducing the data flow by 69 KB for each new visitor.  Ok, I could pack these JS and CSS files with others that are used on the site and get the same number of requests, but this would not allow me to reduce the amount of data transferred, for which I pay money.  Multiply these 69 KB by about a quarter of a million visitors in the hottest period and it will immediately be about 16 GB of transmitted data, which I saved. <br><br>  Finally, it's all about speed.  Much work was done by me to reduce the Apdex index, which also includes all the steps listed above.  The benefits of public CDNs are not only that they have data closer to the user, since they are hosted by large providers (such as jQuery on Google‚Äôs servers), but also that the requested data has most likely been cached by the user in the browser, since were obtained from other resources that also use these CDNs.  And there is nothing faster than working from the local cache! <br><br>  In fact, when speaking about geo-distributed things, the question may arise as to why I did not use the <a href="http://www.hanselman.com/blog/CloudPowerHowToScaleAzureWebsitesGloballyWithTrafficManager.aspx">Azure Traffic Manager service</a> and did not distribute my website across different Azure data centers throughout the world.  I could do it very simply (as described by the link) and I will most likely do it in the future, but at that time my site worked successfully on the basis of a single copy.  Adding another node, say in Europe, would double my expenses to the site.  But I assure you, if some day I encounter such a <em>constant</em> load, when one instance is simply not enough, then the most intelligent will be to use the Traffic Manager to increase the possibility of scaling.  This will not only speed up the site for those users who will be closer to the second location of the site, but <em>will</em> literally <em>double</em> my ability to scale to a serious load, bearing in mind the availability of a second data center for my needs. <br><br><h3>  8) Always, <em>always</em> be ready for quick code updates. </h3><br>  When dealing with a load that grows quickly and unexpectedly, it is necessary to be able to react just as quickly.  One of my decisions in the early stages was to remove a piece of code that I published a few days earlier.  This code had to launch a separate stream and send a notification to Google Analytics to register an API call, something that I had previously only tracked on the client side (and this led to me skipping the registration of calls that occurred directly).  I wasn't sure how much these additional requests to Google Analytics from the server could have an impact on performance, so I decided to kill them. <br><br>  And here an important thing comes up: since this code was ready for release, all I had to do was make a change and send it to GitHub for the automatic publication magic to occur ( <em>Azure Web Sites function - comment transl.</em> ) : <br><br><img alt="Azure deployment history showing a release" src="https://habrastorage.org/getpro/habr/post_images/8ce/129/fbc/8ce129fbca0204055c20815d8a272019.png" width="616" height="171"><br><br>  This process really requires a minimum of movement.  Yes, there is a slight slowdown in the service (usually NewRelic informed me that the speed was reduced for a period of one minute), but this is a very simple way to make a change and it does not affect people who use the service in any tangible way.  The main advantage here is that I can make changes and get them in production at first wish.  I had other ideas on how to reduce the load with changes in the code and the only barrier to their application would be the inability to make changes so quickly and without affecting the environment under high load. <br><br>  Of course, partly my ability to release new code so quickly is based on the fact that I use the automatic build feature.  About four years ago, I wrote a series of articles on your <a href="http://www.troyhunt.com/2010/11/you-deploying-it-wrong-teamcity.html">deployment it wrong!</a>  and in fact praised the importance of automation.  And now it distorts me when I see people posting their sites through the build in Visual Studio or, God forgive me, uploading changes using FTP.  There are a million reasons to use tools like GitHub and Azure Kudu service to place code.  Just use them and never go back to the past! <br><br><h3>  9) Experiment with the site instance size and auto scaling options to find your ideal. </h3><br>  One of the things that I learned during this exercise, which I was endlessly pleased with, is that scaling up and down horizontally and vertically does not have the slightest impact on performance during the transition ( <em>this is about the benefits of scaling Azure WebSites - comment perev.</em> ).  It would be much more difficult for me to decide, say, when to scale up to a more powerful instance, if this process could lead to site interruption.  On the graphs you can see small peaks, but I did not register dropped requests or anything else, which could say that users faced with a non-working site. <br><br>  By Friday night, the situation began to gradually return to normal.  I still used an instance of a medium-sized site, and the zoom feature reduced the number of instances to just one.  Then changed to two.  Then again to one.  Then, ok, it began to look like this (each color is a separate logical instance of the site): <br><br><img alt="Fluctuating instance counts" src="https://habrastorage.org/getpro/habr/post_images/e06/8a3/c03/e068a3c03a3ee03782b535251cfbe936.png" width="785" height="293"><br><br>  Behavior was like a toy Eo-Eo.   CPU       ,       . ,  CPU      ,         .          ,          NewRelic    Apdex  .  ,      CPU         ,  ,             . <br><br>    :           50% .   ,          , ,          ,   .    ,        ,       .  ,      ‚Äì  30%         ,        . <br><br>          ‚Äì    - .                . ,  Apdex       ,         . <br><br> ,          : <br><br><img alt="Default settings for scaling up" src="https://habrastorage.org/getpro/habr/post_images/056/7c8/53d/0567c853da913a0ca169fb2fdf4f7c66.png" width="302" height="461"><br><br>      : <br><br><img alt="Default settings for scaling down" src="https://habrastorage.org/getpro/habr/post_images/b18/036/ba4/b18036ba484dd0597be9872cbdc2ebf9.png" width="301" height="460"><br><br>  ,         . Apdex    ,         ,   . <br><br>    ,    .    ,     ,        ,    .                   .        , ,  <a href="http://www.troyhunt.com/2014/07/scaling-standard-azure-website-to-380k.html"> </a>         ( API)              .               ! <br><br><h3> 10) ,    ! </h3><br> , ,        ‚Äì     ?    ,  ?  ,     . <br><br>  ,        : <br><br> <a href=""><img title="image" alt="image" src="https://habrastorage.org/getpro/habr/post_images/7ba/c16/728/7bac16728a08ab1f55a6cdff20cb9c14.png" width="521" height="365"></a> <br><br>     ,    -                ,   Microsoft.   ,          ,     ,         . <br><br>     ,     .  ‚Äì  ‚Äú‚Äù   -.     ‚Äì        ,     24   .             : <br><br><img alt="Small standard website usage" src="https://habrastorage.org/getpro/habr/post_images/07e/0e0/ced/07e0e0cedb1c246c4f74d6db70abb90d.png" width="623" height="399"><br><br>    10     11 ,   12    .           medium,       . ,       ‚Äì  ,  <strong>  25.80    -,     </strong> . ,   24         . <br><br>     medium.       medium,  11  12         : <br><br><img alt="Medium standard website usage" src="https://habrastorage.org/getpro/habr/post_images/9ec/546/283/9ec5462831c4b4974b8c2fbeb8669234.png" width="620" height="404"><br><br>         ,     <strong>55.03  medium </strong> . <br><br>    .        11  -  ,      medium: <br><br><img alt="Large standard website usage" src="https://habrastorage.org/getpro/habr/post_images/ff7/080/3d8/ff70803d8663bf50ea68983046a8448e.png" width="624" height="396"><br><br>        ,      <strong> 20.34      7 </strong> . , , Azure    ,    20.34          20.34083  ( <em>     Azure ‚Äì . .</em> ). <br><br>      : <br><br><table cellpadding="1" width="600" border="1"><tbody><tr><td width="150"> <strong> </strong> </td><td width="150"> <strong>  </strong> </td><td width="150"> <strong> </strong> </td><td width="150">  <strong>Cost of</strong> </td></tr><tr><td width="150"> Small </td><td width="150"> $0.10 </td><td width="150"> 25.08 </td><td width="150"> $2.51 </td></tr><tr><td width="150">  Medium </td><td width="150"> $0.20 <br><br></td><td width="150"> 55.03 </td><td width="150"> $11.01 </td></tr><tr><td width="150">  Large </td><td width="150"> $0.40 </td><td width="150"> 20.34 <br><br></td><td width="150"> $8.14 </td></tr><tr><td width="150">  <strong>Total</strong> </td><td width="150"></td><td width="150"></td><td width="150"> <strong>$21.65</strong> </td></tr></tbody></table><br>  Yes. <strong>  ‚Äì $21.65</strong> .     ,     .           ,    HIBP     ,     ! <br><br>      ,        .     .  ‚Äì   !?        : <br><br><img alt="Chart of outbound data usage" src="https://habrastorage.org/getpro/habr/post_images/02e/20c/e31/02e20ce31f3bcc6d82a30fff789e9b06.png" width="617" height="398"><br><br>    20     ,    : <br><br><img alt="20GB of data costing $1.80" src="https://habrastorage.org/getpro/habr/post_images/2bc/013/af1/2bc013af1b206b979fb760e725ee54fd.png" width="683" height="112"><br><br>    .         Table Storage ‚Äì            . <br><br> <strong> ,       &lt;$25.</strong>       <a href="http://www.troyhunt.com/2014/03/donations-why-i-dont-need-them-and-why.html">Donations, why I don't need them and why I'm now accepting them for ‚ÄúHave I been pwned?‚Äù</a> ‚Äì     ,         .        ,         .     , ,   <em>   </em>    ! <br><br><h3>  Conclusion </h3><br>          ,    ‚Äú ‚Äù    .    ,      ,         (    10).  ,        ,            .               ,   ,         -  . <br><br>    ‚Äì     devops.      ,          ,     .     ,        ,            : -    ,  session state,    ‚Äì         ,           . <br><br>          Azure     ,   ,       - .       ,   ,         -,     ,      . ,         ‚Äì  ! <br><br><h3>  useful links </h3><br><ul><li>  <a href="http://l.techdays.ru/go/azuretrial">Try Azure</a> for free for 30 days! <br><ul><li>  <a href="http://www.azurehub.ru/">Microsoft Azure Development Center (azurehub.ru)</a> - scripts, tutorials, examples, design recommendations </li><li>  <a href="http://www.twitter.com/windowsazure_ru">Twitter.com/windowsazure_ru</a> - the latest Microsoft Azure news </li><li>  <a href="http://www.facebook.com/groups/azurerus/">Microsoft Azure Community on Facebook</a> - experts, questions </li></ul></li><li>  <a href="http://l.techdays.ru/go/mva">Explore</a> Microsoft Virtual Academy <a href="http://l.techdays.ru/go/mva">courses</a> on cloud and other technologies <br><ul><li>  <a href="http://www.microsoftvirtualacademy.com/training-courses/building-domain-network-fundamentals-part2-rus">Basics of building a domain network.</a>  <a href="http://www.microsoftvirtualacademy.com/training-courses/building-domain-network-fundamentals-part2-rus">Part 2</a> </li><li>  <a href="http://www.microsoftvirtualacademy.com/training-courses/introduction-to-games-programming-on-unity-rus">Unity Game Programming Introduction</a> </li><li>  <a href="http://www.microsoftvirtualacademy.com/training-courses/business-and-cloud-best-practices-solutions-rus">Business and the cloud: best practices solutions</a> </li><li>  <a href="http://www.microsoftvirtualacademy.com/training-courses/the-microsoft-hybrid-cloud-best-practices-guidance-rus">Microsoft Hybrid Cloud: Typical Solutions Guide</a> </li><li>  <a href="http://www.microsoftvirtualacademy.com/training-courses/introduction-to-the-graphics-library-win2d-rus">Introduction to the Win2D Graphic Library</a> </li></ul></li><li>  <a href="http://l.techdays.ru/go/getvs">Download</a> free or trial Visual Studio </li><li>  <a href="http://l.techdays.ru/go/winstart">Become a</a> universal Windows application <a href="http://l.techdays.ru/go/winstart">developer</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/242975/">https://habr.com/ru/post/242975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242963/index.html">November 20 - the launch of the first strategic MMO game for ... programmers</a></li>
<li><a href="../242965/index.html">Portable distribution of .Net applications with Microsoft Report Viewer and Oracle Instant Client reports</a></li>
<li><a href="../242967/index.html">Big little things: 7 UBANK features that will make your life easier and more fun</a></li>
<li><a href="../242969/index.html">Snippet msVendor for miniShop2</a></li>
<li><a href="../242971/index.html">Future Directory Services (in the clouds) - register for a webinar</a></li>
<li><a href="../242977/index.html">Another simple state machine for Unity</a></li>
<li><a href="../242979/index.html">How to make profitable design development sites (part 4)</a></li>
<li><a href="../242983/index.html">Advantages of a new backup method for virtual machines over classic schemes</a></li>
<li><a href="../242987/index.html">Wikipedia. Forbidden to donate from Russia?</a></li>
<li><a href="../242989/index.html">Run GWT Super Dev Mode for remote server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>