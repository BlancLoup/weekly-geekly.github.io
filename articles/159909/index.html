<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing a Restricted Boltzmann machine on c #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hey. The course on neural networks has ended. Good course, but little practice. So in this post we will look at, write and test a limited Boltzmann ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing a Restricted Boltzmann machine on c #</h1><div class="post__text post__text-html js-mediator-article">  Hey.  The <a href="https://class.coursera.org/neuralnets-2012-001/">course on neural networks has</a> ended.  Good course, but little practice.  So in this post we will look at, write and test a <a href="http://en.wikipedia.org/wiki/Restricted_Boltzmann_machine">limited Boltzmann machine</a> ‚Äî a <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25BE%25D1%2585%25D0%25B0%25D1%2581%25D1%2582%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9">stochastic</a> , <a href="http://en.wikipedia.org/wiki/Generative_model">generative</a> model of a <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D1%2581%25D0%25BA%25D1%2583%25D1%2581%25D1%2581%25D1%2582%25D0%25B2%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BD%25D0%25B5%25D0%25B9%25D1%2580%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D0%25B5%25D1%2582%25D1%258C">neural network</a> .  We will train it using the <a href="http://deeplearning.net/tutorial/rbm.html">Contrastive Divergence (CD-k)</a> algorithm, developed by Professor <a href="http://www.cs.toronto.edu/~hinton/">Jeffrey Hinton</a> , who, by the way, leads the course.  We will test on a set of printed English letters.  In the next post, one of the shortcomings of the error back-propagation algorithm and the method of initial initialization of weights using the Boltzmann machine will be considered.  Who is not afraid of formulas and sheets of text, please under the cat. <br><br><a name="habracut"></a><br><br><h4>  A very brief history excursion. </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will not particularly focus on the history of the origin of the limited Boltzmann machine (RBM), I will only mention that it all began with <a href="http://en.wikipedia.org/wiki/Recurrent_neural_network">recurrent neural networks</a> , which are feedback networks that are extremely difficult to train.  As a consequence of this slight difficulty in learning, people began to invent more <i>limited</i> recurrent models for which simpler learning algorithms could be applied.  One of these models was <a href="http://en.wikipedia.org/wiki/Hopfield_network">the Hopfield neural network</a> , and he also introduced the concept of network energy, comparing neural network dynamics with thermodynamics: <br><br><img src="https://habrastorage.org/storage2/ada/b6b/616/adab6b616a20e36d983d95a5d361302d.gif"><br><ul><li>  <i>w</i> - weight between neurons </li><li>  <i>b</i> - neuron displacement </li><li>  <i>s</i> - the state of the neuron </li></ul><br><br>  The next step on the path to RBM was <a href="http://en.wikipedia.org/wiki/Boltzmann_machine">Boltzmann‚Äôs</a> ordinary <a href="http://en.wikipedia.org/wiki/Boltzmann_machine">machines</a> , they differ from the Hopfield network in that they have a <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25BE%25D1%2585%25D0%25B0%25D1%2581%25D1%2582%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9">stochastic nature</a> , and the neurons are divided into two groups describing the monitored and hidden states (by the way, with the <a href="http://en.wikipedia.org/wiki/Hidden_Markov_model">hidden Markov models</a> , by the way Hinton admits that from there he borrowed the word "hidden").  Energy in Boltzmann machines is expressed as follows: <br><br><img src="https://habrastorage.org/storage2/ccb/486/20e/ccb48620ed1c2e6f60576ba6abad23d3.gif"><br><br>  The Boltzmann machine is a fully connected undirected graph, and thus, any two vertices from the same group depend on each other. <br><img src="https://habrastorage.org/getpro/habr/post_images/a98/598/8ad/a985988ad4c1cef559dec32ec6d2405d.png" alt="image"><br><br>  But if we remove the links within the group to get a <a href="http://en.wikipedia.org/wiki/Bipartite_graph">bipartite graph</a> , we get the structure of the RBM model. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/053/df9/017/053df9017e7ac32a9b6cbb95ada6a5c6.png" alt="image"><br><br>  The peculiarity of this model is that with a given state of neurons of one group, the states of neurons of another group will be independent of each other.  Now you can go to the theory where this property plays the key role. <br><br><h4>  Interpretation and purpose </h4><br><br>  RBMs are interpreted similarly to hidden Markov models.  We have a number of states that we can observe (visible neurons that provide an interface for communicating with the external environment) and a number of states that are hidden, and we cannot directly see their state (hidden neurons).  But we can make a probabilistic conclusion regarding hidden states, based on the states that we can observe.  Having trained such a model, we also have the opportunity to draw conclusions regarding visible states, knowing the hidden ones (no one has canceled the <a href="http://en.wikipedia.org/wiki/Bayes%2527_theorem">Bayes theorem</a> =), and thereby generate data from the probability distribution on which the model has been trained. <br><br>  Thus, we can formulate the purpose of training the model: it is necessary to adjust the parameters of the model so that the recovered vector from the initial state is closest to the original.  By restored is meant a vector obtained by a probabilistic inference from hidden states, which, in turn, are obtained by a probabilistic inference from the observed states, i.e.  from the original vector. <br><br><h4>  Theory </h4><br><br>  We introduce the following notation: <br><ul><li>  <i>w_ij</i> - the web between the i-th neuron </li><li>  <i>a_i</i> - offset of the visible neuron </li><li>  <i>b_j</i> - offset of the hidden neuron </li><li>  <i>v_i</i> - the state of the visible neuron </li><li>  <i>h_j</i> - the state of the hidden neuron </li></ul><br><br>  We will consider a training set consisting of binary vectors, but this is easily generalized to vectors of real numbers.  Suppose we have n visible neurons and m hidden ones.  We introduce the concept of energy for RBM: <br><br><img src="https://habrastorage.org/storage2/4b5/685/13e/4b568513e34b0df3db98be4b349e0518.gif"><br><br>  The neural network will calculate the joint probability of all possible pairs of <i>v</i> and <i>h</i> as follows: <br><br><img src="https://habrastorage.org/storage2/9c7/ff7/37f/9c7ff737ffea4b037f0a0a296c05a341.gif"><br><br>  where <i>Z</i> is a partition function or a normalizer ( <a href="http://en.wikipedia.org/wiki/Partition_function_(statistical_mechanics)">partition function</a> ) of the following form (suppose we have only N images v, and M images h): <br><br><img src="https://habrastorage.org/storage2/388/882/d94/388882d944fff7180821429ea8961ff5.gif"><br><br>  Obviously, the total probability of the vector <i>v</i> will be calculated by summing over all <i>h</i> : <br><br><img src="https://habrastorage.org/storage2/151/ff7/730/151ff7730a5bd2a5755affdfafbe3e6f.gif"><br><br>  Consider the probability that for a given <i>v</i> one of the hidden states is <i>h_k = 1</i> .  To do this, we represent one neuron, then the energy of the system with 1 will be E1, and with 0 it will be E0, and the probability 1 will be equal to the sigmoid function of the linear combination of the current neuron with the state vector of the layer under review together with the offset: <br><br><img src="https://habrastorage.org/storage2/fc3/e88/1d6/fc3e881d6f87d221a65cd356ec78a32f.gif"><br><br>  And since for this <i>v</i> all <i>h_k</i> are independent of each other, then: <br><br><img src="https://habrastorage.org/storage2/b2a/8e0/1c5/b2a8e01c573825aaa9b7ee80ebe03929.gif"><br><br>  A similar conclusion is made for the probability <i>v</i> for a given <i>h</i> . <br><br>  As we remember, the purpose of training is to make the recovered vector closest to the original, or, in other words, maximize the probability <i>p (v)</i> .  For this, it is necessary to calculate the partial derivatives of the probabilities from the model parameters.  Let's start with the energy differentiation by model parameters: <br><br><ul><li><img src="https://habrastorage.org/storage2/ebb/b98/e2e/ebbb98e2e7c84736da93ff88b3b525aa.gif"><br></li><li><img src="https://habrastorage.org/storage2/ebb/b98/e2e/ebbb98e2e7c84736da93ff88b3b525aa.gif"><br></li><li><img src="https://habrastorage.org/storage2/9a5/8e7/ec5/9a58e7ec596b9aef09658664519cb67e.gif"><br></li></ul><br><br>  We also need derivative exponents of negative energy: <br><ul><li><img src="https://habrastorage.org/storage2/958/0ed/174/9580ed1741b6b310a29726c232db0a58.gif"><br></li><li><img src="https://habrastorage.org/storage2/42c/307/ce0/42c307ce02f15042d9786875d629ed09.gif"><br></li><li><img src="https://habrastorage.org/storage2/e79/a64/953/e79a6495350029389fb709cad5589441.gif"><br></li></ul><br><br>  Differentiate the amount of: <br><br><ul><li><img src="https://habrastorage.org/storage2/ef1/1da/1fa/ef11da1fadeef9238f4553bb07e2d441.gif"><br></li><li><img src="https://habrastorage.org/storage2/bca/539/ace/bca539aceebb0c3255c67cd57da3820d.gif"><br></li><li><img src="https://habrastorage.org/storage2/b98/e46/15e/b98e4615e68349b171d4c318f817f520.gif"><br></li></ul><br><br>  We are almost at the goal -) Consider the partial derivative of probability <i>v</i> by weights: <br><br><img src="https://habrastorage.org/storage2/edd/ac7/bd6/eddac7bd6c561c3e496106d45b06384a.gif"><br><br>  Obviously, maximizing probability is the same as maximizing the logarithm of probability, this trick will help come to a beautiful solution.  Consider the derivative of the natural logarithm by weight: <br><br><img src="https://habrastorage.org/storage2/273/9b9/6ab/2739b96ab61161e59e9db7f330b2a840.gif"><br><br>  Combining the last two formulas, we get the following expression: <br><br><img src="https://habrastorage.org/storage2/0bc/711/285/0bc71128535db069e0fb1fd266b00d92.gif"><br><img src="https://habrastorage.org/storage2/d5d/b07/554/d5db07554bdc455c9c4f1afaab2eb632.gif"><br><img src="https://habrastorage.org/storage2/115/280/279/115280279dd823cbe8aa232001d0c3a3.gif"><br><br>  Multiplying the numerator and denominator of each term by <i>Z</i> and, simplifying to probabilities, we obtain the following expression: <br><br><img src="https://habrastorage.org/storage2/7f0/5ee/51f/7f05ee51fabb07defee5a63abb762045.gif"><br><br>  And by the definition of <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B5_%25D0%25BE%25D0%25B6%25D0%25B8%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">mathematical expectation,</a> we get the final expression (M before the square bracket is the sign of the mathematical expectation): <br><br><img src="https://habrastorage.org/storage2/fb0/9bc/9ae/fb09bc9ae5941c6d9f284ec0e389f996.gif"><br><br>  Derivatives based on displacement of neurons are derived in the same way: <br><br><ul><li><img src="https://habrastorage.org/storage2/995/636/94a/99563694a9b4dc87874c4f036740293a.gif"><br></li><li><img src="https://habrastorage.org/storage2/0dc/848/6ed/0dc8486edf35005a4d5ce15eea03fc85.gif"><br></li></ul><br><br>  And in the end, there are three rules for updating model parameters, where <i>this</i> is the speed of learning: <br><ul><li><img src="https://habrastorage.org/storage2/0c1/0f4/105/0c10f410525856e84e9b8ba5556f85ef.gif"><br></li><li><img src="https://habrastorage.org/storage2/d7b/4fd/9fe/d7b4fd9fe04d61f8d877e1627bbd0151.gif"><br></li><li><img src="https://habrastorage.org/storage2/1bb/dda/9ce/1bbdda9ce573ef177980776471f3973d.gif"><br></li></ul><br><br>  <i>PS the fry in indexes could be mistaken, on Habr√© there is no built in</i> <i><img src="https://habrastorage.org/storage2/86a/200/36b/86a20036b86fca429ca801221c9be111.gif"></i>  <i>editor =)</i> <br><br><h4>  Algorithm learning Contrastive Divergence </h4><br>  This algorithm was invented by Professor Hinton in 2002, and it is notable for its simplicity.  The main idea is that mathematical expectations are replaced by well-defined values.  Introduces the concept of the sampling process (Gibbs sampling, to see the association, you can look <a href="http://en.wikipedia.org/wiki/Gibbs_measure">here</a> ).  The CD-k process is as follows: <br><ol><li>  the state of visible neurons is equal to the input image </li><li>  displays the probabilities of the states of the hidden layer </li><li>  each neuron of the hidden layer is assigned a state "1" with a probability equal to its current state </li><li>  the probabilities of the visible layer are derived based on the hidden </li><li>  if the current iteration is less than k, then return to step 2 </li><li>  displays the probabilities of the states of the hidden layer </li></ol><br><br>  In lectures at Hinton, it looks like this: <br><img src="https://habrastorage.org/storage2/34a/65f/7f7/34a65f7f7c22b642cb6264efd3a96f8e.png"><br><br><img src="https://habrastorage.org/storage2/621/b3c/2e5/621b3c2e5f734564dea4cf795c43e84a.gif"><br><br>  Those.  the longer we do the sampling, the more accurate our gradient will be.  At the same time, the professor claims that even for CD-1 (only one iteration of sampling), a quite good result is already obtained.  The first term is called the <b>positive phase</b> , and the second with a minus sign is called the <b>negative phase</b> . <br><br><h4>  Talk is cheap.  Show me the code. </h4><br><br>  As in the <a href="http://habrahabr.ru/post/154369/">implementation of the reverse error propagation algorithm</a> , I use almost the same interfaces.  So consider immediately the function of learning neural network.  We will implement the training using the moment of inertia. <br><br><pre> <code class="hljs haskell"><code class="cs"><span class="hljs-title"><span class="hljs-title">public</span></span> void <span class="hljs-type"><span class="hljs-type">Train</span></span>(<span class="hljs-type"><span class="hljs-type">IMultilayerNeuralNetwork</span></span> network, <span class="hljs-type"><span class="hljs-type">IList</span></span>&lt;<span class="hljs-type"><span class="hljs-type">DataItem</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  .      ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class"> config = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30, //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CD</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1, //     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> //      };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"></span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> visibleLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[0]; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">    ,     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> hiddenLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[1]; //    if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) //      { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; //init stop factors bool stopFlag = false; double lastError = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Double</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; //    ,      double lastErrorChange = double.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; double learningRate = _config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class">; int currentEpoche = 0; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt; batchEnumerator = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt;(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator'</span></span></span><span class="hljs-class"> </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> ,     </span></span><a href="http://habrahabr.ru/post/154369/"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"> </span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">do { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class">; //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">start</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">processing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batchEnumerator</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gradient</span></span></span><span class="hljs-class"> //         ,     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[,] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iterate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compute</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mean</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wights</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nabla</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">them</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation //... #endregion //   currentEpoche++; if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">); } } while (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling,      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region iterate through batch</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">//        foreach (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">layer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> //     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">++) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hidden</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">probabilities</span></span></span><span class="hljs-class"> //           ,     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">accumulate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">negative</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">phase</span></span></span><span class="hljs-class"> //      -   ,       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } break; } #endregion //sample hidden states //    ,     ,       ,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } #region accumulate positive phase //   ,      if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == 0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } } #endregion //calculate visible probs //    visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) //{ // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; //} } #endregion }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,    .    :         ( </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> )     .      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region compute mean of wights nabla, and update them</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //      ,      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; //       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   -  .     ,   ,  </span></span><i><span class="hljs-class"><span class="hljs-class">/      </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     ,      ,  .   :        . ,       ,   ,        .       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">string msg = "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Epoche</span></span></span><span class="hljs-class"> #" + currentEpoche; #region calculate error if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> % </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> == 0) { #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculating</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">squared</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reconstruction</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMetrics</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetricsCreator</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SquareEuclideanDistance</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Calculate</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">network</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ComputeOutput</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">)); } msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SqDist</span></span></span><span class="hljs-class"> is " + d; lastErrorChange = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Math</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Abs</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">); lastError = d; #endregion } #endregion msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Time</span></span></span><span class="hljs-class">: " + (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Duration</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToString</span></span></span><span class="hljs-class">(); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       .      ,      ,     ,      ( 260  29  29 ): </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg"><span class="hljs-class"><span class="hljs-class">    </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RegularizationFactor</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ErrorFunction</span></span></span><span class="hljs-class"> = </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NeuronLocalGainLimit</span></span></span><span class="hljs-class">: not setted </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">True</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,     1000 . ..   10,       26  ,    26000 .  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (26  )     13128,     76. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ( ,  ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         </span></span><a href="http://deeplearning.net/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><a href="http://yann.lecun.com/exdb/mnist/"><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MNIST</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><a href=""><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</span></span></a><span class="hljs-class"><span class="hljs-class"> .         ,        =) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">  ,      ,        . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://class.coursera.org/neuralnets-2012-001/"><span class="hljs-class"><span class="hljs-class">https://class.coursera.org/neuralnets-2012-001/</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://deeplearning.net/tutorial/rbm.html"><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations"><span class="hljs-class"><span class="hljs-class">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Public</span></span></span><span class="hljs-class">/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DBNEquations</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~kriz/learning-features-2009-</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TR</span></span></span><span class="hljs-class">.pdf</span></span></a><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PS</span></span></span><span class="hljs-class">     </span></span><a href="https://habrahabr.ru/users/ambikontur/" class="user_link"><span class="hljs-class"><span class="hljs-class">ambikontur</span></span></a><span class="hljs-class"><span class="hljs-class">        ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UPD</span></span></span></span></b><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class">                </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </pre> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> <div class="spoiler"> <code><b class="spoiler_title"><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br>  <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></b></code> <div class="spoiler_text"> <pre> <code class="hljs haskell"><code class="cs"><span class="hljs-title"><span class="hljs-title">public</span></span> void <span class="hljs-type"><span class="hljs-type">Train</span></span>(<span class="hljs-type"><span class="hljs-type">IMultilayerNeuralNetwork</span></span> network, <span class="hljs-type"><span class="hljs-type">IList</span></span>&lt;<span class="hljs-type"><span class="hljs-type">DataItem</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  .      ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class"> config = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30, //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CD</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1, //     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> //      };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"></span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> visibleLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[0]; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">    ,     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> hiddenLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[1]; //    if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) //      { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; //init stop factors bool stopFlag = false; double lastError = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Double</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; //    ,      double lastErrorChange = double.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; double learningRate = _config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class">; int currentEpoche = 0; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt; batchEnumerator = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt;(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator'</span></span></span><span class="hljs-class"> </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> ,     </span></span><a href="http://habrahabr.ru/post/154369/"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"> </span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">do { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class">; //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">start</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">processing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batchEnumerator</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gradient</span></span></span><span class="hljs-class"> //         ,     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[,] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iterate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compute</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mean</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wights</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nabla</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">them</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation //... #endregion //   currentEpoche++; if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">); } } while (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling,      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region iterate through batch</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">//        foreach (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">layer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> //     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">++) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hidden</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">probabilities</span></span></span><span class="hljs-class"> //           ,     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">accumulate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">negative</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">phase</span></span></span><span class="hljs-class"> //      -   ,       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } break; } #endregion //sample hidden states //    ,     ,       ,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } #region accumulate positive phase //   ,      if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == 0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } } #endregion //calculate visible probs //    visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) //{ // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; //} } #endregion }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,    .    :         ( </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> )     .      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region compute mean of wights nabla, and update them</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //      ,      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; //       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   -  .     ,   ,  </span></span><i><span class="hljs-class"><span class="hljs-class">/      </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     ,      ,  .   :        . ,       ,   ,        .       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">string msg = "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Epoche</span></span></span><span class="hljs-class"> #" + currentEpoche; #region calculate error if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> % </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> == 0) { #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculating</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">squared</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reconstruction</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMetrics</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetricsCreator</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SquareEuclideanDistance</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Calculate</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">network</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ComputeOutput</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">)); } msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SqDist</span></span></span><span class="hljs-class"> is " + d; lastErrorChange = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Math</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Abs</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">); lastError = d; #endregion } #endregion msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Time</span></span></span><span class="hljs-class">: " + (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Duration</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToString</span></span></span><span class="hljs-class">(); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       .      ,      ,     ,      ( 260  29  29 ): </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg"><span class="hljs-class"><span class="hljs-class">    </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RegularizationFactor</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ErrorFunction</span></span></span><span class="hljs-class"> = </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NeuronLocalGainLimit</span></span></span><span class="hljs-class">: not setted </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">True</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,     1000 . ..   10,       26  ,    26000 .  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (26  )     13128,     76. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ( ,  ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         </span></span><a href="http://deeplearning.net/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><a href="http://yann.lecun.com/exdb/mnist/"><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MNIST</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><a href=""><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</span></span></a><span class="hljs-class"><span class="hljs-class"> .         ,        =) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">  ,      ,        . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://class.coursera.org/neuralnets-2012-001/"><span class="hljs-class"><span class="hljs-class">https://class.coursera.org/neuralnets-2012-001/</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://deeplearning.net/tutorial/rbm.html"><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations"><span class="hljs-class"><span class="hljs-class">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Public</span></span></span><span class="hljs-class">/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DBNEquations</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~kriz/learning-features-2009-</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TR</span></span></span><span class="hljs-class">.pdf</span></span></a><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PS</span></span></span><span class="hljs-class">     </span></span><a href="https://habrahabr.ru/users/ambikontur/" class="user_link"><span class="hljs-class"><span class="hljs-class">ambikontur</span></span></a><span class="hljs-class"><span class="hljs-class">        ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UPD</span></span></span></span></b><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class">                </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </pre> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </div></div> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> <div class="spoiler"> <code><b class="spoiler_title"><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br>   <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></b></code> <div class="spoiler_text"> <pre> <code class="hljs haskell"><code class="cs"><span class="hljs-title"><span class="hljs-title">public</span></span> void <span class="hljs-type"><span class="hljs-type">Train</span></span>(<span class="hljs-type"><span class="hljs-type">IMultilayerNeuralNetwork</span></span> network, <span class="hljs-type"><span class="hljs-type">IList</span></span>&lt;<span class="hljs-type"><span class="hljs-type">DataItem</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  .      ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class"> config = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30, //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CD</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1, //     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> //      };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"></span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> visibleLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[0]; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">    ,     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> hiddenLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[1]; //    if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) //      { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; //init stop factors bool stopFlag = false; double lastError = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Double</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; //    ,      double lastErrorChange = double.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; double learningRate = _config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class">; int currentEpoche = 0; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt; batchEnumerator = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt;(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator'</span></span></span><span class="hljs-class"> </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> ,     </span></span><a href="http://habrahabr.ru/post/154369/"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"> </span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">do { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class">; //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">start</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">processing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batchEnumerator</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gradient</span></span></span><span class="hljs-class"> //         ,     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[,] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iterate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compute</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mean</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wights</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nabla</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">them</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation //... #endregion //   currentEpoche++; if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">); } } while (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling,      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region iterate through batch</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">//        foreach (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">layer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> //     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">++) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hidden</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">probabilities</span></span></span><span class="hljs-class"> //           ,     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">accumulate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">negative</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">phase</span></span></span><span class="hljs-class"> //      -   ,       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } break; } #endregion //sample hidden states //    ,     ,       ,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } #region accumulate positive phase //   ,      if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == 0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } } #endregion //calculate visible probs //    visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) //{ // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; //} } #endregion }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,    .    :         ( </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> )     .      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region compute mean of wights nabla, and update them</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //      ,      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; //       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   -  .     ,   ,  </span></span><i><span class="hljs-class"><span class="hljs-class">/      </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     ,      ,  .   :        . ,       ,   ,        .       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">string msg = "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Epoche</span></span></span><span class="hljs-class"> #" + currentEpoche; #region calculate error if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> % </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> == 0) { #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculating</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">squared</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reconstruction</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMetrics</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetricsCreator</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SquareEuclideanDistance</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Calculate</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">network</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ComputeOutput</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">)); } msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SqDist</span></span></span><span class="hljs-class"> is " + d; lastErrorChange = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Math</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Abs</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">); lastError = d; #endregion } #endregion msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Time</span></span></span><span class="hljs-class">: " + (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Duration</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToString</span></span></span><span class="hljs-class">(); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       .      ,      ,     ,      ( 260  29  29 ): </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg"><span class="hljs-class"><span class="hljs-class">    </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RegularizationFactor</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ErrorFunction</span></span></span><span class="hljs-class"> = </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NeuronLocalGainLimit</span></span></span><span class="hljs-class">: not setted </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">True</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,     1000 . ..   10,       26  ,    26000 .  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (26  )     13128,     76. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ( ,  ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         </span></span><a href="http://deeplearning.net/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><a href="http://yann.lecun.com/exdb/mnist/"><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MNIST</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><a href=""><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</span></span></a><span class="hljs-class"><span class="hljs-class"> .         ,        =) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">  ,      ,        . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://class.coursera.org/neuralnets-2012-001/"><span class="hljs-class"><span class="hljs-class">https://class.coursera.org/neuralnets-2012-001/</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://deeplearning.net/tutorial/rbm.html"><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations"><span class="hljs-class"><span class="hljs-class">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Public</span></span></span><span class="hljs-class">/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DBNEquations</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~kriz/learning-features-2009-</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TR</span></span></span><span class="hljs-class">.pdf</span></span></a><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PS</span></span></span><span class="hljs-class">     </span></span><a href="https://habrahabr.ru/users/ambikontur/" class="user_link"><span class="hljs-class"><span class="hljs-class">ambikontur</span></span></a><span class="hljs-class"><span class="hljs-class">        ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UPD</span></span></span></span></b><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class">                </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </pre> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </div></div> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> <div class="spoiler"> <code><b class="spoiler_title"><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> #region iterate through batch <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></b></code> <div class="spoiler_text"> <pre> <code class="hljs haskell"><code class="cs"><span class="hljs-title"><span class="hljs-title">public</span></span> void <span class="hljs-type"><span class="hljs-type">Train</span></span>(<span class="hljs-type"><span class="hljs-type">IMultilayerNeuralNetwork</span></span> network, <span class="hljs-type"><span class="hljs-type">IList</span></span>&lt;<span class="hljs-type"><span class="hljs-type">DataItem</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  .      ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class"> config = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30, //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CD</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1, //     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> //      };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"></span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> visibleLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[0]; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">    ,     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> hiddenLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[1]; //    if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) //      { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; //init stop factors bool stopFlag = false; double lastError = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Double</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; //    ,      double lastErrorChange = double.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; double learningRate = _config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class">; int currentEpoche = 0; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt; batchEnumerator = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt;(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator'</span></span></span><span class="hljs-class"> </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> ,     </span></span><a href="http://habrahabr.ru/post/154369/"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"> </span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">do { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class">; //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">start</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">processing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batchEnumerator</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gradient</span></span></span><span class="hljs-class"> //         ,     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[,] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iterate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compute</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mean</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wights</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nabla</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">them</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation //... #endregion //   currentEpoche++; if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">); } } while (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling,      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region iterate through batch</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">//        foreach (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">layer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> //     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">++) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hidden</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">probabilities</span></span></span><span class="hljs-class"> //           ,     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">accumulate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">negative</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">phase</span></span></span><span class="hljs-class"> //      -   ,       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } break; } #endregion //sample hidden states //    ,     ,       ,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } #region accumulate positive phase //   ,      if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == 0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } } #endregion //calculate visible probs //    visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) //{ // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; //} } #endregion }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,    .    :         ( </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> )     .      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region compute mean of wights nabla, and update them</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //      ,      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; //       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   -  .     ,   ,  </span></span><i><span class="hljs-class"><span class="hljs-class">/      </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     ,      ,  .   :        . ,       ,   ,        .       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">string msg = "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Epoche</span></span></span><span class="hljs-class"> #" + currentEpoche; #region calculate error if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> % </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> == 0) { #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculating</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">squared</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reconstruction</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMetrics</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetricsCreator</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SquareEuclideanDistance</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Calculate</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">network</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ComputeOutput</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">)); } msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SqDist</span></span></span><span class="hljs-class"> is " + d; lastErrorChange = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Math</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Abs</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">); lastError = d; #endregion } #endregion msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Time</span></span></span><span class="hljs-class">: " + (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Duration</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToString</span></span></span><span class="hljs-class">(); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       .      ,      ,     ,      ( 260  29  29 ): </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg"><span class="hljs-class"><span class="hljs-class">    </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RegularizationFactor</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ErrorFunction</span></span></span><span class="hljs-class"> = </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NeuronLocalGainLimit</span></span></span><span class="hljs-class">: not setted </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">True</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,     1000 . ..   10,       26  ,    26000 .  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (26  )     13128,     76. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ( ,  ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         </span></span><a href="http://deeplearning.net/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><a href="http://yann.lecun.com/exdb/mnist/"><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MNIST</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><a href=""><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</span></span></a><span class="hljs-class"><span class="hljs-class"> .         ,        =) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">  ,      ,        . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://class.coursera.org/neuralnets-2012-001/"><span class="hljs-class"><span class="hljs-class">https://class.coursera.org/neuralnets-2012-001/</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://deeplearning.net/tutorial/rbm.html"><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations"><span class="hljs-class"><span class="hljs-class">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Public</span></span></span><span class="hljs-class">/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DBNEquations</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~kriz/learning-features-2009-</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TR</span></span></span><span class="hljs-class">.pdf</span></span></a><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PS</span></span></span><span class="hljs-class">     </span></span><a href="https://habrahabr.ru/users/ambikontur/" class="user_link"><span class="hljs-class"><span class="hljs-class">ambikontur</span></span></a><span class="hljs-class"><span class="hljs-class">        ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UPD</span></span></span></span></b><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class">                </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </pre> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </div></div> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> <div class="spoiler"> <code><b class="spoiler_title"><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> #region compute mean of wights nabla, and update them <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></b></code> <div class="spoiler_text"> <pre> <code class="hljs haskell"><code class="cs"><span class="hljs-title"><span class="hljs-title">public</span></span> void <span class="hljs-type"><span class="hljs-type">Train</span></span>(<span class="hljs-type"><span class="hljs-type">IMultilayerNeuralNetwork</span></span> network, <span class="hljs-type"><span class="hljs-type">IList</span></span>&lt;<span class="hljs-type"><span class="hljs-type">DataItem</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  .      ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class"> config = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30, //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CD</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1, //     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> //      };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"></span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> visibleLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[0]; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">    ,     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> hiddenLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[1]; //    if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) //      { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; //init stop factors bool stopFlag = false; double lastError = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Double</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; //    ,      double lastErrorChange = double.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; double learningRate = _config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class">; int currentEpoche = 0; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt; batchEnumerator = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt;(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator'</span></span></span><span class="hljs-class"> </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> ,     </span></span><a href="http://habrahabr.ru/post/154369/"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"> </span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">do { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class">; //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">start</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">processing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batchEnumerator</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gradient</span></span></span><span class="hljs-class"> //         ,     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[,] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iterate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compute</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mean</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wights</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nabla</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">them</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation //... #endregion //   currentEpoche++; if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">); } } while (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling,      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region iterate through batch</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">//        foreach (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">layer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> //     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">++) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hidden</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">probabilities</span></span></span><span class="hljs-class"> //           ,     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">accumulate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">negative</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">phase</span></span></span><span class="hljs-class"> //      -   ,       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } break; } #endregion //sample hidden states //    ,     ,       ,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } #region accumulate positive phase //   ,      if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == 0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } } #endregion //calculate visible probs //    visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) //{ // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; //} } #endregion }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,    .    :         ( </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> )     .      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region compute mean of wights nabla, and update them</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //      ,      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; //       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   -  .     ,   ,  </span></span><i><span class="hljs-class"><span class="hljs-class">/      </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     ,      ,  .   :        . ,       ,   ,        .       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">string msg = "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Epoche</span></span></span><span class="hljs-class"> #" + currentEpoche; #region calculate error if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> % </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> == 0) { #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculating</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">squared</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reconstruction</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMetrics</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetricsCreator</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SquareEuclideanDistance</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Calculate</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">network</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ComputeOutput</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">)); } msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SqDist</span></span></span><span class="hljs-class"> is " + d; lastErrorChange = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Math</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Abs</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">); lastError = d; #endregion } #endregion msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Time</span></span></span><span class="hljs-class">: " + (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Duration</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToString</span></span></span><span class="hljs-class">(); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       .      ,      ,     ,      ( 260  29  29 ): </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg"><span class="hljs-class"><span class="hljs-class">    </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RegularizationFactor</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ErrorFunction</span></span></span><span class="hljs-class"> = </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NeuronLocalGainLimit</span></span></span><span class="hljs-class">: not setted </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">True</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,     1000 . ..   10,       26  ,    26000 .  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (26  )     13128,     76. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ( ,  ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         </span></span><a href="http://deeplearning.net/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><a href="http://yann.lecun.com/exdb/mnist/"><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MNIST</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><a href=""><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</span></span></a><span class="hljs-class"><span class="hljs-class"> .         ,        =) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">  ,      ,        . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://class.coursera.org/neuralnets-2012-001/"><span class="hljs-class"><span class="hljs-class">https://class.coursera.org/neuralnets-2012-001/</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://deeplearning.net/tutorial/rbm.html"><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations"><span class="hljs-class"><span class="hljs-class">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Public</span></span></span><span class="hljs-class">/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DBNEquations</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~kriz/learning-features-2009-</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TR</span></span></span><span class="hljs-class">.pdf</span></span></a><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PS</span></span></span><span class="hljs-class">     </span></span><a href="https://habrahabr.ru/users/ambikontur/" class="user_link"><span class="hljs-class"><span class="hljs-class">ambikontur</span></span></a><span class="hljs-class"><span class="hljs-class">        ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UPD</span></span></span></span></b><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class">                </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </pre> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </div></div> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> <div class="spoiler"> <code><b class="spoiler_title"><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> #region Logging and error calculation <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></b></code> <div class="spoiler_text"> <pre> <code class="hljs haskell"><code class="cs"><span class="hljs-title"><span class="hljs-title">public</span></span> void <span class="hljs-type"><span class="hljs-type">Train</span></span>(<span class="hljs-type"><span class="hljs-type">IMultilayerNeuralNetwork</span></span> network, <span class="hljs-type"><span class="hljs-type">IList</span></span>&lt;<span class="hljs-type"><span class="hljs-type">DataItem</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ,  .      ,       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class"> config = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">() { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30, //   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CD</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1, //     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9, //  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0, //      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> //      };</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"></span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> visibleLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[0]; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">    ,     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILayer</span></span></span><span class="hljs-class"> hiddenLayer = network.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Layers</span></span></span><span class="hljs-class">[1]; //    if (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) //      { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; //init stop factors bool stopFlag = false; double lastError = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Double</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; //    ,      double lastErrorChange = double.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxValue</span></span></span><span class="hljs-class">; double learningRate = _config.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class">; int currentEpoche = 0; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt; batchEnumerator = new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;double&gt;&gt;(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchEnumerator'</span></span></span><span class="hljs-class"> </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> ,     </span></span><a href="http://habrahabr.ru/post/154369/"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">      : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class"> </span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">do { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class">; //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">start</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">processing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batchEnumerator</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gradient</span></span></span><span class="hljs-class"> //         ,     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[,] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">]; #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iterate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">through</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">compute</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mean</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wights</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nabla</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">them</span></span></span><span class="hljs-class"> //... #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endregion</span></span></span><span class="hljs-class"> } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation //... #endregion //   currentEpoche++; if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class">); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stop</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> + " &gt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">:" + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastErrorChange</span></span></span><span class="hljs-class">); } } while (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stopFlag</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling,      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region iterate through batch</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">//        foreach (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">layer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> //     /    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } #region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">++) { //</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hidden</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">probabilities</span></span></span><span class="hljs-class"> //           ,     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">accumulate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">negative</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">phase</span></span></span><span class="hljs-class"> //      -   ,       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] -= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } break; } #endregion //sample hidden states //    ,     ,       ,        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Gibbs</span></span></span><span class="hljs-class"> sampling for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; } #region accumulate positive phase //   ,      if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class"> == 0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class">; } } } #endregion //calculate visible probs //    visibleLayer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Compute</span></span></span><span class="hljs-class">(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) //{ // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_r</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NextDouble</span></span></span><span class="hljs-class">() &lt;= </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LastState</span></span></span><span class="hljs-class"> ? 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> : 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; //} } #endregion }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         ,    .    :         ( </span></span><i><span class="hljs-class"><span class="hljs-class"></span></span></i><span class="hljs-class"><span class="hljs-class"> )     .      . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region compute mean of wights nabla, and update them</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">++) { //      ,      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; //       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">] += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedWeights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Weights</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">]; } } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hiddenLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedHiddenBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class">*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">] + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nablaVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">batch</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visibleLayer</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Neurons</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">].</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Bias</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">learningRate</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">momentumSpeedVisibleBiases</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]; } }</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   -  .     ,   ,  </span></span><i><span class="hljs-class"><span class="hljs-class">/      </span></span></i><span class="hljs-class"><span class="hljs-class"> ,     ,      ,  .   :        . ,       ,   ,        .       . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b class="spoiler_title"><span class="hljs-class"><span class="hljs-class">#region </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logging</span></span></span><span class="hljs-class"> and error calculation</span></span></b><span class="hljs-class"><span class="hljs-class"> </span></span><code class="cs"><span class="hljs-class"><span class="hljs-class">string msg = "</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Epoche</span></span></span><span class="hljs-class"> #" + currentEpoche; #region calculate error if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">currentEpoche</span></span></span><span class="hljs-class"> % </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_config</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> == 0) { #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">calculating</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">squared</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reconstruction</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMetrics</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetricsCreator</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SquareEuclideanDistance</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataItem</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> += </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sed</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Calculate</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">network</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ComputeOutput</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataItem</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Input</span></span></span><span class="hljs-class">)); } msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SqDist</span></span></span><span class="hljs-class"> is " + d; lastErrorChange = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Math</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Abs</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lastError</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">); lastError = d; #endregion } #endregion msg += "; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Time</span></span></span><span class="hljs-class">: " + (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Now</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dtStart</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Duration</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToString</span></span></span><span class="hljs-class">(); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Logger</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Instance</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Log</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">);</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       .      ,      ,     ,      ( 260  29  29 ): </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg"><span class="hljs-class"><span class="hljs-class">    </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningAlgorithmConfig</span></span></span><span class="hljs-class">: </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LearningRate</span></span></span><span class="hljs-class"> = 0.01 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BatchSize</span></span></span><span class="hljs-class"> = 10 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RegularizationFactor</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MaxEpoches</span></span></span><span class="hljs-class"> = 1000 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinError</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MinErrorChange</span></span></span><span class="hljs-class"> = 0 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CostFunctionRecalculationStep</span></span></span><span class="hljs-class"> = 1 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ErrorFunction</span></span></span><span class="hljs-class"> = </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Momentum</span></span></span><span class="hljs-class"> = 0.9 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NeuronLocalGainLimit</span></span></span><span class="hljs-class">: not setted </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GibbsSamplingChainLength</span></span></span><span class="hljs-class"> = 30 </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UseBiases</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">True</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  ,     1000 . ..   10,       26  ,    26000 .  </span></span><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs"><span class="hljs-class"><span class="hljs-class">  </span></span></a><span class="hljs-class"><span class="hljs-class"> . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (26  )     13128,     76. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       ( ,  ): </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">    ,     (        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">). </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">         </span></span><a href="http://deeplearning.net/"><span class="hljs-class"><span class="hljs-class"> </span></span></a><span class="hljs-class"><span class="hljs-class">  </span></span><a href="http://yann.lecun.com/exdb/mnist/"><span class="hljs-class"><span class="hljs-class">   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MNIST</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> : </span></span><a href=""><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</span></span></a><span class="hljs-class"><span class="hljs-class"> .         ,        =) </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RBM</span></span></span><span class="hljs-class">  ,      ,        . </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><a href="https://class.coursera.org/neuralnets-2012-001/"><span class="hljs-class"><span class="hljs-class">https://class.coursera.org/neuralnets-2012-001/</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://deeplearning.net/tutorial/rbm.html"><span class="hljs-class"><span class="hljs-class">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations"><span class="hljs-class"><span class="hljs-class">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Public</span></span></span><span class="hljs-class">/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DBNEquations</span></span></span></span></a><span class="hljs-class"><span class="hljs-class"> </span></span><a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf"><span class="hljs-class"><span class="hljs-class">http://www.cs.toronto.edu/~kriz/learning-features-2009-</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TR</span></span></span><span class="hljs-class">.pdf</span></span></a><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PS</span></span></span><span class="hljs-class">     </span></span><a href="https://habrahabr.ru/users/ambikontur/" class="user_link"><span class="hljs-class"><span class="hljs-class">ambikontur</span></span></a><span class="hljs-class"><span class="hljs-class">        ! </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><b><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UPD</span></span></span></span></b><span class="hljs-class"><span class="hljs-class"> : </span></span><br><span class="hljs-class"><span class="hljs-class">                </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </pre> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </div></div> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> <h4> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </h4> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> <h4> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </h4> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> <ul><li> <code><a href="https://class.coursera.org/neuralnets-2012-001/"><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' </a><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> https://class.coursera.org/neuralnets-2012-001/ <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </li> <li> <code><a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf"><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' </a><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </li> <li> <code><a href="http://deeplearning.net/tutorial/rbm.html"><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' </a><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </li> <li> <code><a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations"><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' </a><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </li> <li> <code><a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf"><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' </a><a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </li> <li> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </li> </ul> <code><code class="cs">public void Train(IMultilayerNeuralNetwork network, IList&lt;DataItem&gt; data) <br> <br>       ,  .      ,       . <br> <br> LearningAlgorithmConfig config = new LearningAlgorithmConfig() { BatchSize = 10, //  MaxEpoches = 1000, //      GibbsSamplingChainLength = 30, //   k  CD-k LearningRate = 0.01, //  CostFunctionRecalculationStep = 1, //     Momentum = 0.9, //  MinError = 0, //      MinErrorChange = 0, //      UseBiases = true //      };</code> <br> <br>       . <br> <br> <b class="spoiler_title"></b> <code class="cs">ILayer visibleLayer = network.Layers[0]; // RBM    ,     ILayer hiddenLayer = network.Layers[1]; //    if (!_config.UseBiases) //      { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { visibleLayer.Neurons[i].Bias = 0d; } for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].Bias = 0d; } } //init momentum //         double[,] momentumSpeedWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] momentumSpeedVisibleBiases = new double[visibleLayer.Neurons.Length]; double[] momentumSpeedHiddenBiases = new double[hiddenLayer.Neurons.Length]; //init stop factors bool stopFlag = false; double lastError = Double.MaxValue; //    ,      double lastErrorChange = double.MaxValue; double learningRate = _config.LearningRate; int currentEpoche = 0; BatchEnumerator&lt;DataItem&lt;double&gt;&gt; batchEnumerator = new BatchEnumerator&lt;DataItem&lt;double&gt;&gt;(data, _config.BatchSize, true);</code> <br> <br> <br>  BatchEnumerator' <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViYnJkS0xjbC1SM1U">  </a> ,     <a href="http://habrahabr.ru/post/154369/">  </a> . <br> <br>      : <br> <br> <b class="spoiler_title"> </b> <code class="cs">do { DateTime dtStart = DateTime.Now; //start batch processing foreach (IList&lt;DataItem&lt;double&gt;&gt; batch in batchEnumerator) { //batch gradient //         ,     /    double[,] nablaWeights = new double[visibleLayer.Neurons.Length, hiddenLayer.Neurons.Length]; double[] nablaHiddenBiases = new double[hiddenLayer.Neurons.Length]; double[] nablaVisibleBiases = new double[visibleLayer.Neurons.Length]; #region iterate through batch //... #endregion #region compute mean of wights nabla, and update them //... #endregion } #region Logging and error calculation //... #endregion //   currentEpoche++; if (currentEpoche &gt;= _config.MaxEpoches) { stopFlag = true; Logger.Instance.Log("Stop: currentEpoche:" + currentEpoche + " &gt;= _config.MaxEpoches:" + _config.MaxEpoches); } else if (_config.MinError &gt;= lastError) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinError:" + _config.MinError + " &gt;= lastError:" + lastError); } else if (_config.MinErrorChange &gt;= lastErrorChange) { stopFlag = true; Logger.Instance.Log("Stop: _config.MinErrorChange:" + _config.MinErrorChange + " &gt;= lastErrorChange:" + lastErrorChange); } } while (!stopFlag);</code> <br> <br> <br>    ,    Gibbs sampling,      . <br> <br> <b class="spoiler_title">#region iterate through batch</b> <code class="cs">//        foreach (DataItem&lt;double&gt; dataItem in batch) { //init visible layer states //     /    for (int i = 0; i &lt; dataItem.Input.Length; i++) { visibleLayer.Neurons[i].LastState = dataItem.Input[i]; } #region Gibbs sampling for (int k = 0; k &lt;= _config.GibbsSamplingChainLength; k++) { //calculate hidden states probabilities //           ,     hiddenLayer.Compute(); #region accumulate negative phase //      -   ,       if (k == _config.GibbsSamplingChainLength) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //     nablaWeights[i, j] -= visibleLayer.Neurons[i].LastState * hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] -= hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] -= visibleLayer.Neurons[i].LastState; } } break; } #endregion //sample hidden states //    ,     ,       ,        Gibbs sampling for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { hiddenLayer.Neurons[i].LastState = _r.NextDouble() &lt;= hiddenLayer.Neurons[i].LastState ? 1d : 0d; } #region accumulate positive phase //   ,      if (k == 0) { for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { nablaWeights[i, j] += visibleLayer.Neurons[i].LastState* hiddenLayer.Neurons[j].LastState; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { nablaHiddenBiases[i] += hiddenLayer.Neurons[i].LastState; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { nablaVisibleBiases[i] += visibleLayer.Neurons[i].LastState; } } } #endregion //calculate visible probs //    visibleLayer.Compute(); //  ,            ,     ,  .    ;           //todo: may be not do sampling, like in 3.2 of http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf //sample visible //for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) //{ // visibleLayer.Neurons[i].LastState = _r.NextDouble() &lt;= visibleLayer.Neurons[i].LastState ? 1d : 0d; //} } #endregion }</code> <br> <br> <br>         ,    .    :         ( <i></i> )     .      . <br> <br> <img src="https://habrastorage.org/storage2/74d/9d9/140/74d9d9140e4bd004b870fb6c545c0a0c.gif"> <br> <br> <b class="spoiler_title">#region compute mean of wights nabla, and update them</b> <code class="cs">for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { for (int j = 0; j &lt; hiddenLayer.Neurons.Length; j++) { //      ,      momentumSpeedWeights[i, j] = _config.Momentum*momentumSpeedWeights[i, j] + nablaWeights[i, j]/batch.Count; //       visibleLayer.Neurons[i].Weights[j] += learningRate * momentumSpeedWeights[i, j]; hiddenLayer.Neurons[j].Weights[i] = visibleLayer.Neurons[i].Weights[j]; } } if (_config.UseBiases) { for (int i = 0; i &lt; hiddenLayer.Neurons.Length; i++) { momentumSpeedHiddenBiases[i] = _config.Momentum*momentumSpeedHiddenBiases[i] + nablaHiddenBiases[i]/batch.Count; hiddenLayer.Neurons[i].Bias += learningRate * momentumSpeedHiddenBiases[i]; } for (int i = 0; i &lt; visibleLayer.Neurons.Length; i++) { momentumSpeedVisibleBiases[i] = _config.Momentum*momentumSpeedVisibleBiases[i] + nablaVisibleBiases[i]/batch.Count; visibleLayer.Neurons[i].Bias += learningRate * momentumSpeedVisibleBiases[i]; } }</code> <br> <br> <br>   -  .     ,   ,  <i>/      </i> ,     ,      ,  .   :        . ,       ,   ,        .       . <br> <br> <b class="spoiler_title">#region Logging and error calculation</b> <code class="cs">string msg = "Epoche #" + currentEpoche; #region calculate error if (currentEpoche % _config.CostFunctionRecalculationStep == 0) { #region calculating squared error with reconstruction IMetrics&lt;double&gt; sed = MetricsCreator.SquareEuclideanDistance(); double d = 0; foreach (DataItem&lt;double&gt; dataItem in data) { d += sed.Calculate(dataItem.Input, network.ComputeOutput(dataItem.Input)); } msg += "; SqDist is " + d; lastErrorChange = Math.Abs(lastError - d); lastError = d; #endregion } #endregion msg += "; Time: " + (DateTime.Now - dtStart).Duration().ToString(); Logger.Instance.Log(msg);</code> <br> <br> <br>  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViVnhKc2N1d2w2TWs">  </a> . <br> <br>   RBM <br>       .      ,      ,     ,      ( 260  29  29 ): <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViXzAwY1NBZm5uNjg">    </a> . <br> <br>     : <br> <br> LearningAlgorithmConfig: <br> LearningRate = 0.01 <br> BatchSize = 10 <br> RegularizationFactor = 0 <br> MaxEpoches = 1000 <br> MinError = 0 <br> MinErrorChange = 0 <br> CostFunctionRecalculationStep = 1 <br> ErrorFunction = <br> Momentum = 0.9 <br> NeuronLocalGainLimit: not setted <br> GibbsSamplingChainLength = 30 <br> UseBiases = True <br> <br>  ,     1000 . ..   10,       26  ,    26000 .  <a href="https://docs.google.com/open%3Fid%3D0B4bl7YMqDnViZE5EN0NYWGhKYWs">  </a> . <br> <br>    ,     (26  )     13128,     76. <br> <br>       ( ,  ): <br> <img src="https://habrastorage.org/storage2/69f/477/e5c/69f477e5c7616c4f71a7d6ad1f091de5.png"> <br> <br>         : <br> <img src="https://habrastorage.org/storage2/53f/5b9/945/53f5b9945c6717c2beeddbe279659b00.png"> <br> <br>    ,     (        RBM). <br> <br>   ,   -  ,    . ,  .      841 (29*29)    .   ,   841     29  29 ,        ,   .         ,       ,    ,    .   : <br> <br> <img src="https://habrastorage.org/storage2/5da/32e/cfa/5da32ecfaaefcc8616fa43caec70eed6.png"> <br> <br>         <a href="http://deeplearning.net/"> </a>  <a href="http://yann.lecun.com/exdb/mnist/">   MNIST</a> : <a href="">http://deeplearning.net/tutorial/_images/filters_at_epoch_14.png</a> .         ,        =) <br> <br>       RBM  ,      ,        . <br> <br>  <br> <a href="https://class.coursera.org/neuralnets-2012-001/">https://class.coursera.org/neuralnets-2012-001/</a> <a href="http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf">http://www.cs.toronto.edu/~hinton/absps/guideTR.pdf</a> <a href="http://deeplearning.net/tutorial/rbm.html">http://deeplearning.net/tutorial/rbm.html#contrastive-divergence-cd-k</a> <a href="http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations">http://www.iro.umontreal.ca/~lisa/twiki/bin/view.cgi/Public/DBNEquations</a> <a href="http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf">http://www.cs.toronto.edu/~kriz/learning-features-2009-TR.pdf</a>     <br> <br> PS     <a href="https://habrahabr.ru/users/ambikontur/" class="user_link">ambikontur</a>        ! <br> <br> <b>UPD</b> : <br>                <br> <img src="https://habrastorage.org/storage2/3ca/0e8/368/3ca0e83689081586afa874a458da214e.png"> <br>     <br> <img src="https://habrastorage.org/storage2/bd7/4f1/3f0/bd74f13f01417dbd1754ca96819a3e4d.png"></code> </div><p>Source: <a href="https://habr.com/ru/post/159909/">https://habr.com/ru/post/159909/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159895/index.html">Benchmark Windows Azure showed high performance for large-scale computing</a></li>
<li><a href="../159897/index.html">Skitch and Evernote: an open letter to Keith Lang, co-founder of Skitch</a></li>
<li><a href="../159903/index.html">Disney Research Robot</a></li>
<li><a href="../159905/index.html">School girl in Texas suspended from refusal to wear RFID</a></li>
<li><a href="../159907/index.html">Web Font Performance</a></li>
<li><a href="../159911/index.html">New version of NetWrix Change Reporter Suite provides reliable control over IT infrastructure</a></li>
<li><a href="../159915/index.html">Ostrovok.ru mobile application for booking hotels</a></li>
<li><a href="../159923/index.html">XenDesktop Failover Cluster</a></li>
<li><a href="../159925/index.html">Energy saving. When is it profitable?</a></li>
<li><a href="../159929/index.html">SIEM systems: are there any prospects for OpenSource?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>