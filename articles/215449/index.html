<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another archive storage format: dar</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 

 There is a well-known saying that system administrators are divided into three types: those who do not make backups; those who are alr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another archive storage format: dar</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br><br>  There is a well-known saying that system administrators are divided into three types: those who do not make backups;  those who are <em>already</em> doing backups and those who are doing and checking that the backups are working. <br><br>  However, this is not enough, and now for the user of the backup system, such a parameter as speed is important, and not only the speed of the backup itself, that is, file archiving, but also recovery. <br><a name="habracut"></a><br>  Agree, it is foolish to read the entire archive of 50-100-1000 gigabytes in size in order to extract one file. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And if you have these archives incremental, then to restore one file for the desired date, you will need to consistently read all the archives in order.  And everything becomes much worse if the archive file is located on a remote server. <br><br>  And this is exactly what you will do if you use the TAR archive format.  After all, this is an industry standard for archives, and it is used in many backup utilities. <br><br>  And the reason for this behavior is very simple - the lack of indexes, by which you can pull out one file from the archive. <br><br>  TAR has a lot of flaws, many of which are fatal.  I will give a small list of the main shortcomings that came across during the study: <br><br><ul><li>  The absence of the index, and as a result - the inability to pull out one file without reading the entire archive. </li><li>  Zoo formats: GNU tar of different versions, BSD tar also of different versions, which sometimes imply the incompatibility of archives with each other. </li><li>  No built-in encryption. </li><li>  The impossibility of selective compression (why should we, for example, compress jpeg?). </li><li>  Completely vague errors during archiving and during recovery (a typical error message is ‚ÄúUnexpected EOF of archive‚Äù, which can mean anything). </li><li>  It may simply not make an archive, for example, because some of the files were deleted during archiving, and tar does not handle this situation at all. </li></ul><br><br>  And this is just what I remembered on the go. <br><br>  I conducted a fairly extensive study of archivers (zip, rar, 7zip), and even any monster systems for backups: open source (well, or conditionally open source) type bacula, and proprietary. <br><br>  And I found the format of the archive, which more or less suited me and the company in all respects and fit my task. <br><br>  I suggest you pay attention to the <a href="http://dar.linux.free.fr/">dar</a> archiver and briefly tell about its advantages and disadvantages (they exist, but there are few of them, and you can live with them), and then proceed to practical examples. <br><br><h3>  Virtues </h3><br><br><ul><li>  The archive file has an index, and even more - the index itself can be placed separately and backed up, which will restore the archive if it has a damaged index. </li><li>  Not only the usual differential and incremental backups, but also decremental. </li><li>  Encryption (blowfish, aes, twofish, serpent, camelia). </li><li>  You can compress files with certain extensions. </li><li>  You can not compress files with certain extensions. </li><li>  You can flexibly manage the process of archiving and unarchiving (how to react to deleting files, changing, moving, etc.). </li><li>  There is a archive manager supplied with dar, it allows you not to restore all the archives in a row when searching for a file, automatically selecting only the necessary ones. </li></ul><br><br>  These are only its main advantages, in general, dar is very rich in features, and a quote from the man speaks best of it: ‚Äú... <br><br>  The project is actively developing and is well supported by the developer.  I received an answer to my questions within a couple of days, and the answers are always very informative.  I know only one project with the same level of support - <a href="http://libguestfs.org/">libguestfs</a> , by the way, I <a href="http://habrahabr.ru/post/121218/">already wrote</a> about it. <br><br><h3>  disadvantages </h3><br><br><ul><li>  Unreal number of options, and if you seriously dig into how to respond to various file changes during archiving / unzipping - you can go crazy. </li><li>  A completely unobvious process of archiving / restoring via pipe (for example, via ssh). </li><li>  In certain situations, dar may require a user reaction (this is solved by adding arguments to the command, but, as a rule, this interactivity is very unexpected, especially while you are writing your first scripts with dar). </li></ul><br><br>  Not that this is a disadvantage, but dar is very verbose.  If tar writes one line after the operation, dar writes a lot and in great detail.  And of course, you can shut it up (no one has yet escaped <code>&gt;/dev/null 2&gt;&amp;1</code> ). <br><br><h2>  Practical work </h2><br><br>  I bet that some of the audience already ran to install dar in their favorite distributions and read the man‚Äôs own.  For those who stayed, I will tell you how to use it.  And when enthusiasts return, I will show how to use this wonderful utility, and tell you about some basic concepts that you will encounter on the <code>man dar</code> pages. <br><br><h3>  Archiving </h3><br><br>  The first example is the simplest: <br><br> <code>dar -R $HOME -c /mnt/backup/archive <br></code> <br><br>  Archives the / home directory. <br><br>  Let's exclude a couple of directories (~ / movies, ~ / downloads): <br><br> <code>dar -R $HOME -c /mnt/backup/archive -P movies -P downloads <br></code> <br><br>  I think everyone has already noticed that the name of the archive does not mention the file extension .dar.  And in the file name, the number 1 came from somewhere. This is all because dar was originally intended for backup to removable media (CD, DVD or, for example, tape drives), so it archives into <em>slices</em> , and digit 1 occurs because This slice is the <em>first</em> .  And since we did not specify the key <code>-s 100M</code> - and the only one.  Dar also has keys for running scripts, when performing certain operations (tar has such keys).  For example, when a slice is recorded, you can run the script and change the media, and then again, and so on. <br><br>  In general, breaking the archive into several parts will not surprise anyone. <br><br>  By default, dar archives without compression, and to enable compression, you need to pass the <code>-z algo:level</code> key to it.  Supports gzip, bzip2, lzo.  And at the output we get the same .N.dar file, without adding any .gz and others.  The archiver himself knows what is inside him. <br><br>  Let us turn to the following goodies - exceptions for compression during archiving: <br><br> <code>dar -R $HOME -c /mnt/backup/archive -Y "*.txt" "*.fb2" -Z "*.mp4" <br></code> <br><br>  The <code>-Y</code> switch indicates for which files the compression should be turned on, and <code>-Z</code> for which it is not needed.  And by default, the exception has a higher priority (but this behavior can be changed if necessary). <br><br>  And now let's get down to the differential, incremental and most tasty - decremental backup. <br><br>  If someone doesn‚Äôt know what it means - not a problem, I‚Äôll tell you: <br><br><ul><li>  Differential: a full copy is first created, and each subsequent day only the difference between this copy and the current state of the files is saved. </li><li>  Incremental: a full copy is created, the next day the difference between the full and the current state is saved, and the third is the difference between the second day and the third. </li><li>  Decremental: a full copy is saved every day and the difference between the current state and yesterday's state is preserved. </li></ul><br><br>  At the same time, no one bothers you to implement both incremental and decrement backup at the same time.  So for two weeks, a backup may look like this (above the days of the week, below is the type of backups d- - decremental, + i - incremental): <br><br> <code>MTWTFSSMTWTFS</code> <br> <code>d- d- d- d- d- d- f +i +i +i +i +i +i <br></code> <br><br>  What will allow to manage one full copy, saving a significant amount of space. <br><br>  You should also know that the only thing you need in order to make an incremental archive is an index.  In terms of dar, an index is called a directory, and saving an index to a file is the isolation of a directory.  Also, I will continue to use only the terms incremental / decremental, since the differential archive is a special case of incremental <br><br>  So let's create an incremental archive: <br><br> <code>dar -R $HOME -c /mnt/backup/archive_monday -A /mnt/backup/archive <br></code> <br><br>  And now let's do one more: <br><br> <code>dar -R $HOME -c /mnt/backup/archive_tuesday -A /mnt/backup/archive_monday <br></code> <br><br>  Do you understand the idea?  Great, we go on.  And now let's save the index separately (note, we will not cut it from the archive, but simply copy it as with mbr backup. After all, do you back up your bootloader?), So that you don‚Äôt back up with a multi-gigabyte backup just to create an incremental archive.  We are doing ‚Äúisolation on the fly‚Äù now, but the catalog can be saved at any convenient time by taking it from a ready-made archive. <br><br> <code>dar -R $HOME -c /mnt/backup/archive_wednesday -A /mnt/backup/archive_tuesday -@ /mnt/backup/CAT_archive_wednesday <br></code> <br><br>  And now let's make a backup one more time, using only the CAT <em>archive</em> wednesday index: <br><br> <code>dar -R $HOME -c /mnt/backup/archive_thursday -A /mnt/backup/CAT_archive_wednesday -@ /mnt/backup/CAT_archive_thursday <br></code> <br><br>  Well, we figured out the incremental backup that was familiar to many, but what is the decrement backup for the beast? <br><br>  For a start, we need one yesterday's complete archive from which we will make decremental, and today's full. <br><br> <code>dar -R $HOME -c /mnt/backup/archive_sunday</code> <br> <code>dar -R $HOME -+ /mnt/backup/archive_saturday_decremental -A /mnt/backup/archive_saturday -@ /mnt/backup/archive_sunday -ad <br></code> <br><br>  In general, everything is a little confused here (get used to it), because <code>-+</code> according to the documentation was created to <em>merge</em> two archives, and <code>-@</code> , as we have said, serves to isolate the directory on the fly, and the <code>-ad</code> changes the behavior of these keys to implement decrement.  In a sense, this is logical.  Probably. <br><br>  Well, we got to the moment of truth - data recovery.  After all, everyone understands that a backup that cannot be restored is equivalent to an undrawn backup? <br><br>  Before recovery, it would be nice to check the archive: <br><br> <code>dar -t /mnt/backup/archive_sunday</code> <br> <br>  If dar did not return an error code (at the end of the man, all possible exit codes that dar can return are listed), then you can recover: <br><br> <code>mkdir sunday</code> <br> <code>dar -x /mnt/backup/archive_sunday -R sunday</code> <br> <br><h3>  Remote Machine Operations </h3><br><br><h4>  File recovery </h4><br><br>  I casually already mentioned that recovering files from remote machines via a pipe (for example, via ssh) is a non-trivial task. <br><br>  I will try to tell you in detail how it works. <br><br>  All the difficulties are due to the fact that to restore a single dar file you need to read the index.  If, however, it is used in the same way as tar, in stream reading mode (key - sequence-read), then no such problems arise. <br><br>  To solve the problem with reading the index, two versions of dar have been created: <br><br><ul><li>  Primary: dar, which says you need to recover. </li><li>  Auxiliary: dar_slave, which accepts a command and passes dar the recovered data, which dar then writes to the disk. </li></ul><br><br>  Therefore, the scheme of work (for recovery) is as follows: <br><br> <code>(2) --&gt; dar --&gt; (1) --&gt; dar_slave archive --&gt; (2) <br></code> <br><br><ol><li>  dar through the pipe says dar_slave: ‚ÄúI want to restore file A‚Äù. </li><li>  dar_slave reads the index of the archive file, finds out at what offset the file is located, and transfers it to stdout, which reads dar and writes the resulting file to disk. </li></ol><br><br>  The difficulty is in transferring the file from dar_slave to dar.  For such a ‚Äúring‚Äù data transfer, we will have to build a small crutch using mkfifo: <br><br> <code><code>mkfifo /tmp/fifo&lt;.code&gt; <br> dar -x -i /tmp/fifo -R sunday | ssh user@host dar_slave sunday &gt; /tmp/fifo</code> <br> <code>rm /tmp/fifo</code> <br> <br>    ,    , ,  NFS. <br> <br>   <br> <br>       :         ,         : <br> <br> <code>dar -R $HOME -c - -A /mnt/backup/CAT_archive_wednesday -@ /mnt/backup/CAT_archive_thursday | ssh user@host 'cat &gt; archive_thursday' <br></code> <br> <br>   <br> <br>     dar     dar_manager,       dar.  ,  , ,     ,       (,      ,  ,      ). <br> <br>     ,    ,        . <br> <br> ,  , ,   :     production-,          ,        , , ,       . <br> <br>     dar  dar_static:   ,         . <br> <br>   <br> <br>     ,       (     ),             dar.   Ubuntu 12.04 ,    dar  2.4.2,    /     .  dar  2.4.12      . <br> <br>   ,  ,   2.4,      dar  2.3    .</code> <h4> <code><code>mkfifo /tmp/fifo&lt;.code&gt; <br> dar -x -i /tmp/fifo -R sunday | ssh user@host dar_slave sunday &gt; /tmp/fifo</code> <br> <code>rm /tmp/fifo</code> <br> <br>    ,    , ,  NFS. <br> <br>   <br> <br>       :         ,         : <br> <br> <code>dar -R $HOME -c - -A /mnt/backup/CAT_archive_wednesday -@ /mnt/backup/CAT_archive_thursday | ssh user@host 'cat &gt; archive_thursday' <br></code> <br> <br>   <br> <br>     dar     dar_manager,       dar.  ,  , ,     ,       (,      ,  ,      ). <br> <br>     ,    ,        . <br> <br> ,  , ,   :     production-,          ,        , , ,       . <br> <br>     dar  dar_static:   ,         . <br> <br>   <br> <br>     ,       (     ),             dar.   Ubuntu 12.04 ,    dar  2.4.2,    /     .  dar  2.4.12      . <br> <br>   ,  ,   2.4,      dar  2.3    .</code> </h4> <code><code>mkfifo /tmp/fifo&lt;.code&gt; <br> dar -x -i /tmp/fifo -R sunday | ssh user@host dar_slave sunday &gt; /tmp/fifo</code> <br> <code>rm /tmp/fifo</code> <br> <br>    ,    , ,  NFS. <br> <br>   <br> <br>       :         ,         : <br> <br> <code>dar -R $HOME -c - -A /mnt/backup/CAT_archive_wednesday -@ /mnt/backup/CAT_archive_thursday | ssh user@host 'cat &gt; archive_thursday' <br></code> <br> <br>   <br> <br>     dar     dar_manager,       dar.  ,  , ,     ,       (,      ,  ,      ). <br> <br>     ,    ,        . <br> <br> ,  , ,   :     production-,          ,        , , ,       . <br> <br>     dar  dar_static:   ,         . <br> <br>   <br> <br>     ,       (     ),             dar.   Ubuntu 12.04 ,    dar  2.4.2,    /     .  dar  2.4.12      . <br> <br>   ,  ,   2.4,      dar  2.3    .</code> <h2> <code><code>mkfifo /tmp/fifo&lt;.code&gt; <br> dar -x -i /tmp/fifo -R sunday | ssh user@host dar_slave sunday &gt; /tmp/fifo</code> <br> <code>rm /tmp/fifo</code> <br> <br>    ,    , ,  NFS. <br> <br>   <br> <br>       :         ,         : <br> <br> <code>dar -R $HOME -c - -A /mnt/backup/CAT_archive_wednesday -@ /mnt/backup/CAT_archive_thursday | ssh user@host 'cat &gt; archive_thursday' <br></code> <br> <br>   <br> <br>     dar     dar_manager,       dar.  ,  , ,     ,       (,      ,  ,      ). <br> <br>     ,    ,        . <br> <br> ,  , ,   :     production-,          ,        , , ,       . <br> <br>     dar  dar_static:   ,         . <br> <br>   <br> <br>     ,       (     ),             dar.   Ubuntu 12.04 ,    dar  2.4.2,    /     .  dar  2.4.12      . <br> <br>   ,  ,   2.4,      dar  2.3    .</code> </h2> <code><code>mkfifo /tmp/fifo&lt;.code&gt; <br> dar -x -i /tmp/fifo -R sunday | ssh user@host dar_slave sunday &gt; /tmp/fifo</code> <br> <code>rm /tmp/fifo</code> <br> <br>    ,    , ,  NFS. <br> <br>   <br> <br>       :         ,         : <br> <br> <code>dar -R $HOME -c - -A /mnt/backup/CAT_archive_wednesday -@ /mnt/backup/CAT_archive_thursday | ssh user@host 'cat &gt; archive_thursday' <br></code> <br> <br>   <br> <br>     dar     dar_manager,       dar.  ,  , ,     ,       (,      ,  ,      ). <br> <br>     ,    ,        . <br> <br> ,  , ,   :     production-,          ,        , , ,       . <br> <br>     dar  dar_static:   ,         . <br> <br>   <br> <br>     ,       (     ),             dar.   Ubuntu 12.04 ,    dar  2.4.2,    /     .  dar  2.4.12      . <br> <br>   ,  ,   2.4,      dar  2.3    .</code> <h2> <code><code>mkfifo /tmp/fifo&lt;.code&gt; <br> dar -x -i /tmp/fifo -R sunday | ssh user@host dar_slave sunday &gt; /tmp/fifo</code> <br> <code>rm /tmp/fifo</code> <br> <br>    ,    , ,  NFS. <br> <br>   <br> <br>       :         ,         : <br> <br> <code>dar -R $HOME -c - -A /mnt/backup/CAT_archive_wednesday -@ /mnt/backup/CAT_archive_thursday | ssh user@host 'cat &gt; archive_thursday' <br></code> <br> <br>   <br> <br>     dar     dar_manager,       dar.  ,  , ,     ,       (,      ,  ,      ). <br> <br>     ,    ,        . <br> <br> ,  , ,   :     production-,          ,        , , ,       . <br> <br>     dar  dar_static:   ,         . <br> <br>   <br> <br>     ,       (     ),             dar.   Ubuntu 12.04 ,    dar  2.4.2,    /     .  dar  2.4.12      . <br> <br>   ,  ,   2.4,      dar  2.3    .</code> </h2> <code><code>mkfifo /tmp/fifo&lt;.code&gt; <br> dar -x -i /tmp/fifo -R sunday | ssh user@host dar_slave sunday &gt; /tmp/fifo</code> <br> <code>rm /tmp/fifo</code> <br> <br>    ,    , ,  NFS. <br> <br>   <br> <br>       :         ,         : <br> <br> <code>dar -R $HOME -c - -A /mnt/backup/CAT_archive_wednesday -@ /mnt/backup/CAT_archive_thursday | ssh user@host 'cat &gt; archive_thursday' <br></code> <br> <br>   <br> <br>     dar     dar_manager,       dar.  ,  , ,     ,       (,      ,  ,      ). <br> <br>     ,    ,        . <br> <br> ,  , ,   :     production-,          ,        , , ,       . <br> <br>     dar  dar_static:   ,         . <br> <br>   <br> <br>     ,       (     ),             dar.   Ubuntu 12.04 ,    dar  2.4.2,    /     .  dar  2.4.12      . <br> <br>   ,  ,   2.4,      dar  2.3    .</code> </div><p>Source: <a href="https://habr.com/ru/post/215449/">https://habr.com/ru/post/215449/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215439/index.html">New version of ABBYY FineReader for Mac: without leaving the jungle of complex features</a></li>
<li><a href="../215441/index.html">From developer to designers: experience and tips</a></li>
<li><a href="../215443/index.html">DesignSpark Mechanical: Modeling a useful box for free (that is, for nothing)</a></li>
<li><a href="../215445/index.html">Crowdsourcing to search for a missing plane</a></li>
<li><a href="../215447/index.html">Multitasking in iOS 7</a></li>
<li><a href="../215451/index.html">Do startups have a life after death?</a></li>
<li><a href="../215453/index.html">Random Forest model for classification, implementation on c #</a></li>
<li><a href="../215455/index.html">The first Samsung U28 monitor U28D590 is already on sale</a></li>
<li><a href="../215457/index.html">The most popular passwords in 2013</a></li>
<li><a href="../215459/index.html">Google launched Add-ons for Google Docs and Sheets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>