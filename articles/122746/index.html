<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A tale about how a good young man fought a three-headed snake, or How to embed SVG graphics in Adobe InDesign documents - part one</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to all habrazhiteli! 
 First, a small lyrical digression. This post was not written by me, but for now not filled with upd: already envelope...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A tale about how a good young man fought a three-headed snake, or How to embed SVG graphics in Adobe InDesign documents - part one</h1><div class="post__text post__text-html js-mediator-article">  Greetings to all habrazhiteli! <br>  First, a small lyrical digression.  This post was not written by me, but for <s>now not filled with</s> upd: already <a href="https://habrahabr.ru/users/viklequick/" class="user_link">enveloped viklequick</a> , and, in my opinion, deserves your attention with all the consequences.  So‚Ä¶ <br><br>  <b>Zachin</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4e0/36b/771/4e036b771eb8c43b7247aec6431d30d5.jpg" alt="image">  Once, in an icy winter season, the <s>author</s> did well <s>to the</s> good fellow to fight with vector images in EPS format.  And he decided to keep up with the progress and embed graphs and diagrams in the Adobe InDesign documents in the form of SVG.  And then a great disappointment befell him, because Adobe Systems prefers its own Adobe Flash, and in Adobe InDesign, SVG support is not at its root.  However, the well-done young man has accumulated a notable experience in creating plug-ins for InDesign, and he decided to use his powerful hero and take the three-headed hydra.  The bogatyr said - the bogatyr did, namely, the fence. <br>  About the details of this struggle and will lead our tale. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  <b>Tale</b> <br><br>  <b>Step One, or Study the Anatomy of the Hydra Triceps</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/064/d16/f4a/064d16f4a4a007a126108ae19217d360.png" alt="image">  To begin with, it is necessary to briefly mention how InDesign works with pictures. <br>  From the point of view of InDesign, images are a special type of PageItem that can draw and print itself.  And this very PageItem can be put on the page, or as inline in a frame, or in a table cell, and all this must be able to handle.  And still, drawing happens three types - fast (the crossed out rectangle is drawn), optimum (raster proxy image), and full (slow).  It is also necessary to support all this. <br>  Thus, we see the Import Plug-in, Page Item and several auxiliary classes, like this: <br><br><pre>  Class
 {
   kSVGItem,
   kDisplayListPageItemBoss,
   {
     IID_ISHAPE, kSVGShapeImpl,
     IID_IINKRESOURCES, kAllProcessInkResourcesImpl,
     IID_IFLATTENERUSAGE, kSVGItemFlattenerUsageImpl,
     IID_IVISITORHELPER, kEPSItemVisitorHelperImpl,
     IID_ISCRIPT, kSVGItemScriptImpl,
   }
 },
</pre><br><br>  so: <br><br> <code>Class <br> { <br> kSVGPlaceProviderBoss, <br> kInvalidClass, <br> { <br> IID_IK2SERVICEPROVIDER, kImportServiceImpl, <br> IID_IIMPORTPROVIDER, kSVGPlaceProviderImpl, <br> IID_IIMPORTPREVIEW, kSVGImportPreviewImpl, <br> } <br> }, <br></code> <br><br>  And, of course, there is also a standard header on the subject of startup / shutdown, which makes no sense to bring. <br>  Let's see what it is and why. <br>  ‚Ä¢ IID_ISHAPE is the implementation of the actual page item, which is responsible for rendering. <br>  ‚Ä¢ IID_IINKRESOURCES - we process links to external files (Ink). <br>  ‚Ä¢ IID_IFLATTENERUSAGE - we process the rasterization of the alpha channel in PDF.  Actually, this is one line, obviously requiring the inclusion of a flattener, and no more. <br>  ‚Ä¢ IID_IVISITORHELPER - we leave it standard, borrowing from EPS. <br>  ‚Ä¢ IID_ISCRIPT - we provide support for our element through scripting.  This is also a very simple part, which only correctly defines the type of object. <br>  ‚Ä¢ IID_IK2SERVICEPROVIDER and IID_IIMPORTPROVIDER - we add support for the Place command. <br>  ‚Ä¢ IID_IIMPORTPREVIEW - and provide a preview in the file-specific dialog (Windows specific). <br>  The most interesting is actually IID_ISHAPE, this is the heart of our plugin.  He is required to draw himself directly on IGraphicsPort, and also to obtain a raster proxy image.  Looking ahead, I want to note - there were enough surprises. <br><br>  <b>Step Two, or Choose a Bogatyr Sword</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0e2/54e/601/0e254e6016e9999957b3a63d8e9a3577.png" alt="image">  Express googling, as well as viewing sample images from OpenClipArt, made me think about Apache Batik.  I will say straight away that I had to make some efforts to repair the Batik itself, but in the end they turned out to be insignificant.  Basically boiled down to "guess the version of SVG content."  However, the task ‚Äúhow to draw a batik image on IGraphicsPort‚Äù appeared, and we will focus on it as the most difficult one.  And we will move from boring C ++ matters to a fun Java creative and vice versa. <br>  However, the disgraceful minstrels will tell us - it‚Äôs you, the hero, wandered into the wrong tale, and you‚Äôll end up with five meters of barbed wire, as always happens when crossing a hedgehog with a snake.  Experience, the son of difficult mistakes, teaches us - in this case, it turns out something more useful. <br><br>  <b>Step Three, or Getting to a Duel</b> <br>  As mentioned above, Java should be taught to work with indizayn threads.  Actually, the task is obvious and is solved through JNI: <br><img src="https://habrastorage.org/getpro/habr/post_images/dc6/4cf/390/dc64cf3900c7d4f785ad0aa76b52c17c.png" alt="image"><br> <code>/** <br> * Class for reading from InDesign IPMStream <br> */ <br> public class PMInputStream extends InputStream <br> { <br> /** <br> * Creates PMInputStream object and attaches it to IPMStream* already <br> * opened by InDesign. <br> * @param iPMStreamPtr IPMStream* to attach to <br> * @throws IOException The stream has no ability to read. <br> */ <br> public PMInputStream(long iPMStreamPtr) throws IOException { <br> this.ownedStreamPtr = iPMStreamPtr; <br> this.retain(); <br> } <br> <br> @Override <br> public int read() throws IOException { <br> return readByte(); <br> } <br> <br> @Override <br> public int read(byte b[], int off, int len) throws IOException { <br> if (len == 0) return 0; <br> return readBytes(b, off, len); <br> } <br> <br> @Override <br> public long skip(long n) throws IOException { <br> return performSeek(n, SeekFromCurrent); <br> } <br> <br> public long seek(long numberOfBytes, int fromHere) throws IOException { <br> return performSeek(numberOfBytes, fromHere); <br> } <br> <br> @Override <br> public int available() { <br> return availableBytes(); <br> } <br> <br> // native functions below <br> ... <br></code> <br><br>  The implementation is built through the native function, we give them a list.  They are self-evident and require no special comments.  There is only one interesting point, here it is: <br><br> <code>/** <br> * 'Cause IPMStream is a COM-like object we gotta call AddRef() for it <br> * if we wanna save pointer in our class. <br> */ <br> private native void retain(); <br> /** <br> * Once we called AddRef() we shouldn't forget calling corresponding <br> * Release(). Let's do it! <br> */ <br> private native void release(); <br></code> <br><br>  And the list itself: <br><br> <code>protected native int readByte(); <br> protected native int readBytes(byte b[], int off, int len); <br> protected native long performSeek(long numberOfBytes, int fromHere); <br> protected native int availableBytes(); <br> <br> protected native String getFileName(); <br> protected native long getLastModifiedTime(); <br></code> <br><br>  The last two functions were added to cache elements directly in Java, in order not to build again DOM models for each drawing.  You just need to track changes in data and quickly re-read them when you change. <br>  And the final touch is the actual implementation of the native methods. <br><br> <code>class IPMStream; class PMInputStream <br> { <br> private: <br> IPMStream* fStream; <br> <br> public: <br> PMInputStream(IPMStream* stream); <br> ~PMInputStream() { close(); } <br> <br> void close(); <br> <br> int read() { <br> unsigned char result; <br> return read(&amp;result, 1) == 1? result: -1; <br> } <br> <br> int read(unsigned char* buffer, int len){ return fStream-&gt;XferByte(buffer, len); } <br> XInt64 seek(XInt64 numberOfBytes, SeekFrom fromHere) { <br> return fStream-&gt;Seek((int32)numberOfBytes, fromHere); <br> } <br> <br> public: <br> enum SeekFrom { SeekFromStart = kSeekFromStart, <br> SeekFromCurrent = kSeekFromCurrent, <br> SeekFromEnd = kSeekFromEnd <br> }; <br> }; <br></code> <br><br>  We have already reached SVG, but now the task is to get and draw a picture.  Actually, by drawing a vector image in BufferedImage, we get our proxy image.  The standard example of batik clearly shows us how it was obtained, so to save space I allow myself not to bring this footcloth here.  It is also obvious that PixelGrabber is used to get an array of bytes in RGB from a BufferedImage.  We transfer the resulting array to the AGMImageRecord in the same way as discussed in the second part of the article. <br>  It is interesting that drawing on IGraphicsPort instead of BufferedImage differs in exactly one line, instead of the standard offscreen Graphics2D, we need to substitute our implementation.  This is what we will do. <br><br>  <b>Step Four, or Cunningly connect to the sword an electric current, so that sparks fly</b> <br>  The amount of code for literate inheritance Graphics2D is large, boring, but obvious, and it can easily be peeped from the same Apache Batik.  Therefore, we will focus on the most interesting parts, but a whole pack of getters and setters a la <code>Paint getPaint(){ return paint; }</code>  <code>Paint getPaint(){ return paint; }</code> we will lower. <br>  I note only that, in general, you can safely insert plugs of this type: <br><br> <code>public void setXORMode(Color c1){ throw new RuntimeException("setXORMode: N/A"); }</code> <br> <br>  and such: <br><br> <code>public void fillRect(int x, int y, int w, int h) { fill(new Rectangle(x, y, w, h)); }</code> <br> <br>  As a result of such simplifications and the elimination of duplicates, we have so many real functions: <br><br> <code>public void draw(Shape s); <br> public void fill(Shape s); <br> public boolean drawImage(Image img, int x, int y, int width, int height, Color bgcolor, ImageObserver observer); <br> <br> public void drawString(String str, float x, float y); <br> public void drawString(AttributedCharacterIterator iterator, float x, float y); <br></code> <br><br>  You can go further by using StrokeTextPainter, and this set will be reduced to three functions, which is good. <br>  Now let's get to the other side, and see what we need from IGraphicsPort: <br><br> <code>private native void newpath(); <br> private native void moveto(float x, float y); <br> private native void lineto(float x, float y); <br> private native void curveto(float x1, float y1, float x2, float y2, float x3, float y3); <br> private native void curvetov(float x2, float y2, float x3, float y3); <br> private native void closepath(); <br> <br> private native void gsave(); <br> private native void grestore(); <br> <br> private native void setlinewidth(float width); <br> private native void setdash(int len, float[] dashArray, float offset); <br> private native void setopacity(float opacity, boolean bIsAlphaShape); // from 0 to 1.0 <br> private native void setrgbcolor(float r, float g, float b); <br> <br> private native void fill(); <br> private native void eofill(); <br> private native void stroke(); <br> <br> private native void image(int[] buffer, int x, int y, int width, int height, double[] transformMatrix); <br> <br> private native void clip(); <br> private native void eoclip(); <br></code> <br><br>  Experienced look can be seen a clear lack of drawing tools such as gradients.  Alas, the Adobe documentation for this part of the API is so scanty that I never managed to use the available functions, I had to shaman, as will be discussed below. <br>  As you can see, we need a little bit.  However, a new task arises: we need to somehow combine the whole thing now.  Let's start with a simple - with geometric shapes. <br>  The most difficult thing here is to deploy the shape from Java to a set of native functions.  To do this, we use the standard PathIterator, and at the same time, we do not forget about transformations, because Batik uses the AffineTransform very actively: <br><br> <code>private void applyPath(PathIterator pi, int kind) { <br> float[] coord = new float[6]; <br> int retSeg; <br> <br> newpath(); <br> while(!pi.isDone()) { <br> retSeg = pi.currentSegment(coord); <br> switch (retSeg) { <br> case SEG_LINETO: <br> lineto(coord[0], coord[1]); <br> break; <br> case SEG_CUBICTO: <br> curveto(coord[0], coord[1], coord[2], coord[3], coord[4], coord[5]); <br> break; <br> case SEG_MOVETO: <br> moveto(coord[0], coord[1]); <br> break; <br> case SEG_QUADTO: <br> curvetov(coord[0], coord[1], coord[2], coord[3]); <br> break; <br> case SEG_CLOSE: <br> closepath(); <br> break; <br> } <br> pi.next(); <br> } <br> <br> if(kind == PATH_FILL) { <br> if(pi.getWindingRule() == PathIterator.WIND_EVEN_ODD) eofill(); <br> else fill(); <br> } <br> else if(kind == PATH_STROKE) stroke(); <br> else if(kind == PATH_CLIP) { <br> if(pi.getWindingRule() == PathIterator.WIND_EVEN_ODD) eoclip(); <br> else clip(); <br> } <br> } <br></code> <br><br>  Now we can easily draw primitives: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f33/dd7/cf5/f33dd7cf557d35689f9e88a153ac6eb4.png" alt="image"><br><br> <code>public void draw(Shape s) { <br> PathIterator pi = s.getPathIterator(getTransform()); <br> applyClip(getClip()); <br> applyStroke(s); <br> applyStyles(); <br> applyPath(pi, PATH_STROKE); <br> restoreClip(); <br> } <br></code> <br><br>  For now, we will not focus on all kinds of apply *, they are discussed further.  As a matter of fact, fill () looks exactly the same, except for some difficulties with gradients.  As you might guess, applyClip () is also implemented in the same way: <br><br> <code>private void applyClip(Shape xclip) { <br> gsave(); <br> if(xclip != null) { <br> PathIterator pi = xclip.getPathIterator(getTransform()); <br> applyPath(pi, PATH_CLIP); <br> } <br> } <br></code> <br><br>  The real code is a bit more complicated, you have to take into account the peculiarities of the flattener implementation in IGraphicsPort, and if necessary, turn the bypass in order to bypass the path counterclockwise.  And, as mentioned earlier, Batik perfectly knows how to text a vector into a set of glyphs, so you should not worry about working with fonts.  So the text inevitably becomes a set of geometric shapes. <br><br>  To be continued‚Ä¶ </div><p>Source: <a href="https://habr.com/ru/post/122746/">https://habr.com/ru/post/122746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122738/index.html">Advertising for your Android application</a></li>
<li><a href="../122739/index.html">Function-Based Iterators and Generators</a></li>
<li><a href="../122740/index.html">Baldur's Gate on Android: GemRB emulator in action</a></li>
<li><a href="../122742/index.html">Encrypt, scan, smile - the first startup in the domain.rf</a></li>
<li><a href="../122744/index.html">Chrome extension for Google Music</a></li>
<li><a href="../122747/index.html">Recovery strategy for damaged table in MySQL</a></li>
<li><a href="../122748/index.html">Youtube and numbers on the keyboard</a></li>
<li><a href="../122751/index.html">Voice tree on Asterisk do it yourself</a></li>
<li><a href="../122753/index.html">Working with AD: Search by SIDHistory attribute</a></li>
<li><a href="../122754/index.html">C parallel network computing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>