<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yii exchange of experience: models (ending)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuation of the previous post 

 The area of ‚Äã‚Äãresponsibility of the model and its place in the project 
 Models are intended only for handling da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yii exchange of experience: models (ending)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a84/5b6/2b2/a845b62b22489df97996ffb65fd91b3a.png"><br>  Continuation of the <a href="http://habrahabr.ru/post/212681/">previous post</a> <br><a name="habracut"></a><br><h5>  The area of ‚Äã‚Äãresponsibility of the model and its place in the project </h5><br>  Models are intended only for handling data (search, saving, deleting), as well as related static files, as they are also an integral part of the data structure (photo, video).  Naturally, when deleting a record, the media files associated with it should be deleted, for this it is convenient to use beforeDelete () or afterDelete (). <br>  Simple business logic can be implemented in the model, for complex - it is better to use the service layer (Service Layer) so you save the model from the mass of dependencies and will not inflate the divine object from it. <br>  In models should not appear: <br><ul><li>  HTML, CSS, javascript </li><li>  Superglobal arrays ($ _GET, ...) </li><li>  Global variables </li><li>  Verification of access rights (this moment may be controversial, practice shows that access control to operations should be carried out in the controller) </li><li>  Text strings not wrapped in Yii :: t () </li></ul><br>  Models should have as few dependencies on other components as possible, so we can make it portable and use it in other projects.  In this case, the components on which the model depends should be installed by setters (for example, User :: setEmailComponent ('email')).  You can also assign components in User :: init (), but you must also check for its presence.  If the component is secondary and unavailable, the model must work without noise, however if the component is paramount, then an exception should be thrown at the initialization stage. <br>  These simple rules will allow your code to be supported by a team of programmers, and it is sufficiently flexible to extend the functionality. <br><br><h5>  Status check </h5><br>  Usually, checks are done in different places, both in controllers and in views, and checking often looks like this: <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   if($model-&gt;status == 1){ ... } //    if($model-&gt;getStatus() === Model::STATUS_ACTIVE){ ... } //   if($model-&gt;status !== 1 &amp;&amp; $model-&gt;status !== 2 &amp;&amp; $model-&gt;status !== 4){ ... } //--   </span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, if you create an isActive () method that does this check, the code will become more controllable, especially in the context of frequently changing TK.  Also sometimes it will be useful to create a method that describes checking for the possibility of transition to a different status status.  For example: if a record has the status - ‚ÄúSpam‚Äù, then it cannot be transferred to the ‚ÄúActive‚Äù status, but it can be transferred to the ‚ÄúTo check‚Äù status.  It is desirable to place all this logic also in models.  (This can be useful when building workflow systems) <br><br><h5>  Use flag fields </h5><br>  To save the size of the table (the number of columns) and to have a more flexible model expansion functionality, use fields with bit flags. <br>  Such fields are usually represented in the database by the type integer (but not necessarily) and are able to place a fairly large number of flags.  I already touched flag fields in the previous article.  Now I will show practical application.  (Bit masks are described <a href="http://habrahabr.ru/post/134557/">in</a> detail <a href="http://habrahabr.ru/post/134557/">in this article</a> ). <br>  Example: There is a user model in which several simultaneous flags can be assigned to a user - ‚Äúbest author‚Äù, ‚Äúphone confirmed‚Äù, ‚Äúemail confirmed‚Äù, ‚Äúleft a request for moderator post‚Äù <br><div class="spoiler">  <b class="spoiler_title">Fragment of the model</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $flags = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FLAG_CONFIRM_EMAIL = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 00000001 const FLAG_CONFIRM_PHONE = 2; // 00000010 const FLAG_BEST_AUTHOR = 4; // 00000100 const FLAG_BECOME_MODERATOR = 8; // 00001000 /** *   * @param integer $flag * @return \User */ public function setFlag($flag) { $this-&gt;flag += intval($flag); return $this; } /** *   * @param integer $flag * @return \User */ public function unsetFlag($flag) { $this-&gt;flag -= intval($flag); return $this; } /** *    * @param integer $flag * @return boolean */ public function hasFlag($flag) { return ($this-&gt;flags &amp; intval($flag)); } /** *     * @return array */ public function getFlagsLabels(){ return array( self::FLAG_CONFIRM_EMAIL =&gt; Yii::t('User',"Email "), self::FLAG_CONFIRM_PHONE =&gt; Yii::t('User'," "), self::FLAG_BEST_AUTHOR =&gt; Yii::t('User'," "), self::FLAG_BECOME_MODERATOR =&gt; Yii::t('User',"   "), ); } /** *      * @param integer $flag * @return \User */ public function withFlags($flag=0) { $this-&gt;getDbCriteria()-&gt;mergeWith(array( 'order'=&gt;'flags &amp; :flag', 'params' =&gt; array(':flag' =&gt; $flag), )); return $this; }</span></span></code> </pre><br></div></div><br><br>  In the MySQL query, the check will look like: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`User`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATUS</span></span> &amp; <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre><br><br>  In the example, a <a href="">named group of conditions</a> is created; this allows searching as shown below: <br><br><pre> <code class="php hljs"> User::model()-&gt;withFlags(User::FLAG_CONFIRM_EMAIL)-&gt;findAll();</code> </pre><br><br><h5>  Relational relations </h5><br>  Relational relationships are well described in the <a href="">official documentation</a> . <br>  In practice, there are such nuances. <br><ul><li>  If the relational relationship is built correctly using FK, then everything should work clearly, since the integrity of the data is provided by the database. </li><li>  If the relational relationship is built only by means of YII (and it is not possible to use FK), in this case you should not use direct access to the variable designating the connection, instead use <a href="http://www.yiiframework.com/doc/api/1.1/CActiveRecord/">CActiveRecord :: getRelated ()</a> . </li><li>  Checking the correctness of connections (correct ID) must be controlled during validation and in the beforeSave () handler. </li><li>  Deleting related data must be implemented in the beforeDelete () handler. </li></ul><br><br><h5>  Representations for attributes </h5><br>  HTML code is sometimes found in model code - it does not belong there.  If there is a need to display an HTML-formatted attribute for this, use either the widget or create a helper for the model (a class with static methods).  examples are shown below. <br><br><div class="spoiler">  <b class="spoiler_title">Helper example</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserHelper</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *      * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProfileLink</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User $model, $htmlOptions = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CHtml::link($model-&gt;getUserName(),$model-&gt;getProfileUrl(),$htmlOptions); } }</code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Widget example</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserAvatar</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CWidget</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $emptyPhotoUrl = <span class="hljs-string"><span class="hljs-string">"/static/images/no-photo.png"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $model; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $htmlOptions; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $avatar = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emptyPhotoUrl; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;model-&gt;hasAvatar()) { $avatar = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;model-&gt;getAvatarUrl(); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> CHtml::image($avatar,<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;model-&gt;getUserName(),<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;htmlOptions); } }</code> </pre><br></div></div><br><br>  The widget and helper are conveniently used in views, the helper is convenient when used inside the widget CGridView. <br><br><h5>  Model journaling </h5><br>  For debugging models, especially for catching a difficult-to-reproduce error, it is sometimes useful to be able to learn the chronology of events. <br>  To do this, you can add logging methods to the model, and keep a log (log file) for all operations performed with data.  The implementation of this simple mechanics can be any, but it is useful to recall the CLogRoute component and configure one of the routes for your model, the log can be kept either in the database (caution, decreases performance) or in simple files.  It is also useful to write to the log user data on behalf of which the operation is performed, it will simplify the analysis of flights. </div><p>Source: <a href="https://habr.com/ru/post/212917/">https://habr.com/ru/post/212917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212901/index.html">Job Search Java Middle Developer (observations and impressions)</a></li>
<li><a href="../212907/index.html">PayPal: Adaptive Payments API System</a></li>
<li><a href="../212909/index.html">FortiAP-14C - remote access point from Fortinet. A good option to build a secure wireless network for a remote office</a></li>
<li><a href="../212911/index.html">Creating games for Windows 8 using Unity3D - look today at 10:00 online</a></li>
<li><a href="../212913/index.html">Startup tips or importance of experience</a></li>
<li><a href="../212919/index.html">OpenVox GSM Gateway as a complete replacement for PBX</a></li>
<li><a href="../212921/index.html">3D effect with white lines</a></li>
<li><a href="../212923/index.html">You do not want to think like a programmer</a></li>
<li><a href="../212925/index.html">What are we learning? Study on the importance of IT competencies</a></li>
<li><a href="../212927/index.html">Why you need a smartwatch: ten options for using Pebble</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>