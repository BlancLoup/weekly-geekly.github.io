<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Storing the ssh config in an ansible project and solving the tunnel problem when using the relative path</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ansible is an excellent server management tool. Together with git, it allows you to go into the paradigm of deploy as code with all the resulting char...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Storing the ssh config in an ansible project and solving the tunnel problem when using the relative path</h1><div class="post__text post__text-html js-mediator-article"><p>  Ansible is an excellent server management tool.  Together with git, it allows you to go into the paradigm of deploy as code with all the resulting charms, such as review of the code, merge (pull), change requests, and the like.  This is especially true if the team is working on this, and not the only person. </p><br><p>  In this light, it becomes obviously convenient to store the connection settings to the managed hosts directly in the same repository, in addition to the inventory / hosts file (it is generally better to bring it to some service like CMDBuild or similar ones).  That is, if, say, the connection port or IP address on the host has changed, the rest of the team members should receive it when they next pull up the changes from the repository, and did not make every change in their ~ / .ssh / config file. </p><br><p>  And most of the parameters will work properly without any effort, but not so simple if you want to use ssh-tunnels. <a name="habracut"></a><br>  So, suppose we saved the config file in the inventory / ssh.config file. <br>  It was prescribed basic connections and basic settings: </p><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Host</span></span> * IdentityFile /secret/id_rsa User wheel Host host.one HostName <span class="hljs-number"><span class="hljs-number">1.2.3.4</span></span> User ant Host host.two HostName <span class="hljs-number"><span class="hljs-number">2.3.4.5</span></span> Port <span class="hljs-number"><span class="hljs-number">2022</span></span></code> </pre> <br><p>  Well, and so on, everything is standard, as we usually write it in the user level config. </p><br><p>  In ansible.cfg, it is proposed to specify its relative path using the -F option: </p><br><pre> <code class="hljs lua">ssh_args = -o ControlMaster=auto -o ControlPersist=<span class="hljs-number"><span class="hljs-number">60</span></span>s -F inventory/ssh.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span></code> </pre> <br><p>  This will allow everyone to simply clone the repository and immediately start working without setting up their machine and access (of course, it‚Äôs worth taking private access keys somewhere, it‚Äôs not generally recommended to keep them here, although if you have private repositories, you can also consider) . </p><br><p>  Most options will then work, however, if you try to use tunnels, something like this: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">organization</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gateway</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">HostName</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inner</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">HostName</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ProxyCommand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">organization</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gateway</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-W</span></span> %<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span>:%<span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span></code> </pre> <br><p>  You will immediately receive an error that you can not connect to the host inner.host! </p><br><p>  How so? <br>  In fact, everything is simple.  Ansible when connecting simply calls the ssh binary file, passes it the specified options.  Next, here is a tunnel, for ssh it will fork and call the specified command as is.  This can be nc by the word or port forwarding using iptables (firewalld).  That is, no interpretation is made.  And this means that the command will be called: </p><br><pre> <code class="hljs perl">ssh organization.gateway -W %h:%p</code> </pre> <br><p>  And in general, ssh cannot establish a connection because it does not know what an organization.gateway is. </p><br><p>  Of course, we could correct this situation by specifying the path to the file here: </p><br><pre> <code class="hljs pgsql">Host <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span>.host HostName <span class="hljs-number"><span class="hljs-number">2.3</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> ProxyCommand ssh -F /<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/same/ssh.config organization.gateway -W %h:%p</code> </pre> <br><p>  This will work, but we did not want to be attached to the path on a specific machine, but rather to keep a file that is universal for all! <br>  A partial solution to the problem will be an indication of the relative path, but only partially decides if you want to call ansible by an absolute path from another directory. </p><br><p>  Since  ssh does not provide any inheritance of configs, for bash (it should work in sh too, for others it is possible to slightly modify) we can simply emulate it: </p><br><pre> <code class="hljs mel">Host inner.host HostName <span class="hljs-number"><span class="hljs-number">2.3</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> ProxyCommand ssh $( egrep -z -A1 <span class="hljs-string"><span class="hljs-string">'^-F$'</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span>/$PPID/cmdline ) organization.gateway -W %h:%p</code> </pre> <br><p>  All that we changed, put " <strong>$ (egrep -z -A1 '^ -F $' / proc / $ PPID / cmdline)</strong> " and all the magic will happen here.  So this is just "the same config with which the main ssh process is called." </p><br><p>  It works simply: for the spawned process, the value of the -F option is substituted, which is derived from the caller's options. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/307316/">https://habr.com/ru/post/307316/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307306/index.html">SObjectizer: from simple to complex. Part II</a></li>
<li><a href="../307308/index.html">Designing identical forms in WPF using abstract classes</a></li>
<li><a href="../307310/index.html">How to quickly raise the management accounting system in an advertising agency from scratch and without a budget</a></li>
<li><a href="../307312/index.html">Mathematics for artificial neural networks for beginners, part 2 - gradient descent</a></li>
<li><a href="../307314/index.html">The relationship between the monetization of games and the behavior of gamers</a></li>
<li><a href="../307318/index.html">Web application for working with markdown notes</a></li>
<li><a href="../307320/index.html">Multigrain: Features of PoS Terminal Malware</a></li>
<li><a href="../307324/index.html">When unit testing is really needed</a></li>
<li><a href="../307326/index.html">Project Management in L & D</a></li>
<li><a href="../307328/index.html">Systematization of publications in the web. Part 3 of 3: Strategy placement of scientific publications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>