<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Garbage collection and lifetime of objects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It would seem a simple question: can the CLR call the object's finalizer when the instance method has not completed its execution? 

 In other words, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Garbage collection and lifetime of objects</h1><div class="post__text post__text-html js-mediator-article">  It would seem a simple question: <b>can the CLR call the object's finalizer when the instance method has not completed its execution?</b> <br><br>  In other words, is it possible in the following case to see ‚ÄúFinalizing instance.‚Äù Before ‚ÄúFinished doing something.‚Äù? <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GcIsWeird</span></span> { ~GcIsWeird() { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Finalizing instance."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">42</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Doing something. The answer is ... "</span></span> + data); <span class="hljs-comment"><span class="hljs-comment">// Some other code... Console.WriteLine("Finished doing something."); } }</span></span></code> </pre> <br><a name="habracut"></a><br>  Answer: <b>It depends</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In debug builds this will never happen, but in Release it is possible.  To simplify this discussion, consider the following static method: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeWeirdAndVeryLongRunningStaticMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> heavyWeightInstance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">42</span></span>_000_000]; <span class="hljs-comment"><span class="hljs-comment">// The very last reference to 'heavyWeightInstance' Console.WriteLine(heavyWeightInstance.Length); for (int i = 0; i &lt; 10_000; i++) { // Doing some useful stuff. Thread.Sleep(42); } }</span></span></code> </pre><br>  The local variable 'heavyWeightInstance' is used only in the first two lines and can theoretically be compiled by the GC after that.  It would be possible to assign the variable null explicitly to release the link, but this is not required.  The CLR has an optimization that allows you to collect objects if they are no longer used.  The JIT compiler allocates a special table called the Pointer Table or GCInfo (see <a href="">gcinfo.cpp</a> in <a href="">coreclr repo</a> ), which gives enough information to the garbage collector to decide when the variable is reachable and when it is not. <br><br>  <b>An instance method</b> is just a static method with the 'this' pointer passed in the first argument.  This means that all optimizations are valid for both instance methods and static methods. <br><br>  To prove that this is true, we can run the following program and look at the result. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GcIsWeird</span></span> { ~GcIsWeird() { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Finalizing instance."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">42</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Doing something. The answer is ... "</span></span> + data); CheckReachability(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Finished doing something."</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckReachability</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> d</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> weakRef = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeakReference(d); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Calling GC.Collect..."</span></span>); GC.Collect(); GC.WaitForPendingFinalizers(); GC.Collect(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> message = weakRef.IsAlive ? <span class="hljs-string"><span class="hljs-string">"alive"</span></span> : <span class="hljs-string"><span class="hljs-string">"dead"</span></span>; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Object is "</span></span> + message); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GcIsWeird().DoSomething(); } }</code> </pre><br>  As expected, launching this program in release mode will lead to the following conclusion: <br><br> <code>Doing something. The answer is ... 42 <br> Calling GC.Collect... <br> <b>Finalizing instance.</b> <br> Object is dead <br> Finished doing something</code> <br> <br>  The output indicates that the object was compiled during the execution of the instance method.  Now let's see how this happens. <br><br><ul><li>  First, we can use WinDbg and call the GCInfo command for a given method table (method table). </li><li>  Secondly, we can compile CoreClr and run the application with JIT tracing enabled. </li></ul><br>  I decided to use the second option.  To do this, use the instructions described in the section <a href="">JIT Dumps</a> and perform the following steps: <br><br><ol><li>  Build CoreCLR Repo (do not forget to install all the necessary components of Visual Studio, such as VC ++, CMake and Python). </li><li>  Install dotnet cli. </li><li>  Create an application for dotnet core. </li><li>  Create and publish the dotnet core application. </li><li>  Copy the coreclr binaries just collected to the folder with the published application. </li><li>  Set several environment variables, such as, COMPlus_JitDump = YourMethodName. </li><li>  Launch the application. </li></ol><br>  And here is the result: <br><br><pre> <code class="hljs pgsql">*************** <span class="hljs-keyword"><span class="hljs-keyword">After</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> code gen, <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> unwindEmit() IN0002: <span class="hljs-number"><span class="hljs-number">000012</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> CORINFO_HELP_NEWSFAST IN0003: <span class="hljs-number"><span class="hljs-number">000017</span></span> mov rcx, <span class="hljs-number"><span class="hljs-number">0x1FE90003070</span></span> // Console.WriteLine("Doing something. The answer is ... " + data); IN0004: <span class="hljs-number"><span class="hljs-number">000021</span></span> mov rcx, gword ptr [rcx] IN0005: <span class="hljs-number"><span class="hljs-number">000024</span></span> mov edx, dword ptr [rsi+<span class="hljs-number"><span class="hljs-number">8</span></span>] IN0006: <span class="hljs-number"><span class="hljs-number">000027</span></span> mov dword ptr [rax+<span class="hljs-number"><span class="hljs-number">8</span></span>], edx IN0007: <span class="hljs-number"><span class="hljs-number">00002</span></span>A mov rdx, rax IN0008: <span class="hljs-number"><span class="hljs-number">00002</span></span>D <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.String:Concat(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>):<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> IN0009: <span class="hljs-number"><span class="hljs-number">000032</span></span> mov rcx, rax IN000a: <span class="hljs-number"><span class="hljs-number">000035</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Console:WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>) // CheckReachability(this); &lt;b&gt;IN000b: <span class="hljs-number"><span class="hljs-number">00003</span></span>A mov rcx, rsi&lt;/b&gt; //     ¬´this¬ª   GC IN000c: <span class="hljs-number"><span class="hljs-number">00003</span></span>D <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> Reachability.Program:CheckReachability(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>) // Console.WriteLine IN000d: <span class="hljs-number"><span class="hljs-number">000042</span></span> mov rcx, <span class="hljs-number"><span class="hljs-number">0x1FE90003078</span></span> IN000e: <span class="hljs-number"><span class="hljs-number">00004</span></span>C mov rcx, gword ptr [rcx] IN000f: <span class="hljs-number"><span class="hljs-number">00004</span></span>F mov rax, <span class="hljs-number"><span class="hljs-number">0x7FFB6C6B0160</span></span> *************** Variable <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> vars <span class="hljs-number"><span class="hljs-number">0</span></span>( <span class="hljs-type"><span class="hljs-type">UNKNOWN</span></span>) : <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> <span class="hljs-number"><span class="hljs-number">00000000</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">00000008</span></span>h, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rcx &lt;b&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>( <span class="hljs-type"><span class="hljs-type">UNKNOWN</span></span>) : <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> <span class="hljs-number"><span class="hljs-number">00000008</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">0000003</span></span>Ah, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rsi&lt;/b&gt; *************** <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> gcInfoBlockHdrSave() &lt;b&gt;Register slot id <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> reg rsi = <span class="hljs-number"><span class="hljs-number">0.</span></span>&lt;/b&gt; <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> slot <span class="hljs-number"><span class="hljs-number">0</span></span> at instr <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">0x12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Live. <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> slot <span class="hljs-number"><span class="hljs-number">0</span></span> at instr <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">0x17</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Dead. <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> slot <span class="hljs-number"><span class="hljs-number">0</span></span> at instr <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">0x2d</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Live. <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> slot <span class="hljs-number"><span class="hljs-number">0</span></span> at instr <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">0x32</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Dead. <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> slot <span class="hljs-number"><span class="hljs-number">0</span></span> at instr <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">0x35</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Live. &lt;b&gt;<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> slot <span class="hljs-number"><span class="hljs-number">0</span></span> at instr <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">0x3a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Dead.&lt;/b&gt;</code> </pre> <br>  The dump from the Jit compiler will be slightly different from the one that you can see in WinDBG or in the 'Disassembly' window in Visual Studio.  The main difference is that it shows much more information, including the number of local variables (when they are used in terms of the ASM offset) and GCInfo.  Another useful aspect is the command offset, which helps to understand the contents of the GCInfo table. <br><br>  In this case, it is clear that the ‚Äúthis‚Äù pointer is no longer needed after the command with offset 0x3A, i.e.  right before calling <b>CheckReachability</b> .  This is the reason why the object was collected (destroyed) after the GC was called inside the CheckReachability method. <br><br><h4>  Conclusion </h4><br>  JIT and GC work together to track some supporting information that helps the GC to collect objects as soon as they are no longer used by the application. <br>  The C # language specification says that this optimization is possible, but not necessary: ‚Äã‚Äã‚Äúif a local variable from the current scope is the only reference to an object, and this local variable is no longer used in any execution path of the procedure, then the garbage collector can ( <b>but not must</b> ) consider this object unused and available for assembly ".  So you should not rely on this behavior in production code. </div><p>Source: <a href="https://habr.com/ru/post/343748/">https://habr.com/ru/post/343748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343732/index.html">Corporate "stuffing" for small networks</a></li>
<li><a href="../343736/index.html">Avtomatny workshop - 2. Example "Crossing", the mathematical transformations of TK in OA</a></li>
<li><a href="../343738/index.html">We understand what was discovered there in the problem of queens</a></li>
<li><a href="../343740/index.html">Security Week 48: Root Access for Diligence, Miner Consultant and Trial Macro Malware</a></li>
<li><a href="../343744/index.html">We integrate smartcontract into the web application on Nodejs</a></li>
<li><a href="../343750/index.html">Release of the second version of the Nodejs plugin for Sublime Text</a></li>
<li><a href="../343752/index.html">Welford method and multidimensional linear regression</a></li>
<li><a href="../343754/index.html">[Peter] JUG.ru meeting with Oleg Nenashev from CloudBees-Groovy DSL at Jenkins and Pipeline. Implementations and underwater rakes</a></li>
<li><a href="../343758/index.html">Using Bash in SQL style</a></li>
<li><a href="../343760/index.html">Programming on the phone using the Termux terminal emulator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>