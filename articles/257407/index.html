<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We issue a digital certificate and verify the signature using BouncyCastle</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The flagship product of our company is Rutoken EDS - a device with Russian on-board cryptography. To integrate the device with browsers, the Rutoken P...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We issue a digital certificate and verify the signature using BouncyCastle</h1><div class="post__text post__text-html js-mediator-article">  The flagship product of our company is Rutoken EDS - a device with Russian on-board cryptography.  To integrate the device with browsers, the <a href="http://www.rutoken.ru/products/all/rutoken-plugin/">Rutoken Plugin</a> was released.  Demonstration of the plugin's capabilities can be viewed on the <a href="http://demo.rutoken.ru/">test sites</a> .  Some of them involve working with digital certificates stored on devices.  For example, the <a href="http://demobank.rutoken.ru/">Demo Bank,</a> when registering users, issues a user certificate, and when logging into the system, it requests and checks it.  To implement these tasks on the server uses the library BouncyCastle. <br><br><img src="https://habrastorage.org/files/641/614/686/6416146868a64957aa64067d96963fdb.jpg"><br>  This article will consider examples of its use for issuing certificates for PKCS # 10, as well as for verifying the CMS signature generated using Russian cryptoalgorithms. <br><a name="habracut"></a><br>  At the core of our "certification center" is the BouncyCastle library.  It should be noted that the site <a href="http://www.bouncycastle.org/csharp/">bouncycastle.org/csharp/</a> is an outdated version of the library, which did not work in the solution without fixes.  The working version can be taken on github - <a href="https://github.com/bcgit/bc-csharp">https://github.com/bcgit/bc-csharp</a> . <br><br>  There are also tests with a bunch of options for using the library for various needs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We do not need much from all this: <br>  - Work with PKCS # 10 queries <br>  - Extract certificates according to the request <br><br>  If there is a need to organize the entrance to the site using a certificate, we implement another algorithm, about it below. <br><br>  The root certificate can be generated by the library and used later.  We already have it, in the PEM format.  There is also a private key. <br><br><h4>  Customer </h4><br>  In our system, an IIS server with an ASP.NET web-api is looking to the outside world with a method issuing a certificate upon PKCS # 10 request.  On the client, that is, on the demo sites themselves, the application is running on AngularJs, which works with the <a href="http://www.rutoken.ru/products/all/rutoken-plugin/">plugin</a> .  Of course, you can write a client on anything, but the essence of work on the client side comes down to the following: <br><br>  - we pass the data of the fields to the createPkcs10 plugin function to form a PKCS # 10 request, we get the request text. <br>  - we send the text of the PKCS # 10 request with a post-request for the api method, we get a certificate or an error if it is impossible to issue a certificate. <br>  - we transfer the received certificate to the importCertificate plugin function, import it to the device. <br><br>  The working version of the site with the ability to manage certificates on Rutoken EDS devices is now spinning here - <a href="http://ra.rutoken.ru/">http://ra.rutoken.ru</a> .  You can create a key and make a request with the required fields.  Next, write a test certificate that will be imported to the token. <br>  <b>!</b>  <b>To work, you need to install a plugin and connect Rutoken EDS!</b> <br><br><h4>  Server </h4><br>  But back to the server side.  So, we have a root certificate in the PEM format and a private key to it.  We will issue a user certificate upon PKCS # 10 request.  The request itself also comes from the client in text form, in PEM format. <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> cCACert = <span class="hljs-string"><span class="hljs-string">@"-----BEGIN CERTIFICATE----- ***   *** -----END CERTIFICATE-----"</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> cCAKey = <span class="hljs-string"><span class="hljs-string">@"-----BEGIN PRIVATE KEY----- ***  *** -----END PRIVATE KEY-----"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    public string generateTestCert(string pkcs10text) { //    PemReader pRd = new PemReader(new StringReader(cCAKey)); AsymmetricKeyParameter _cCAKey = (AsymmetricKeyParameter)pRd.ReadObject(); pRd.Reader.Close(); //    pRd = new PemReader(new StringReader(cCACert)); var _cCACert = (X509Certificate)pRd.ReadObject(); pRd.Reader.Close(); //  : //X509CertificateParser certParser = new X509CertificateParser(); //var _caCert = certParser.ReadCertificate(Base64.Decode(cCACert.Replace("-----BEGIN CERTIFICATE-----", string.Empty).Replace("-----END CERTIFICATE-----",string.Empty))); Pkcs10CertificationRequest _pkcs10; //  pkcs10 using (StringReader _sr = new StringReader(pkcs10text)) { pRd = new PemReader(_sr); _pkcs10 = (Pkcs10CertificationRequest)pRd.ReadObject(); pRd.Reader.Close(); } //   X509V3CertificateGenerator v3CertGen = new X509V3CertificateGenerator(); var requestInfo = _pkcs10.GetCertificationRequestInfo(); var subPub = _pkcs10.GetPublicKey(); var issPub = _cCACert.GetPublicKey(); //   var randomGenerator = new CryptoApiRandomGenerator(); var random = new SecureRandom(randomGenerator); var serialNumber = BigIntegers.CreateRandomInRange( BigInteger.One, BigInteger.ValueOf(Int64.MaxValue), random); v3CertGen.Reset(); v3CertGen.SetSerialNumber(serialNumber); v3CertGen.SetIssuerDN(_cCACert.IssuerDN); v3CertGen.SetNotBefore(DateTime.UtcNow); //    v3CertGen.SetNotAfter(DateTime.UtcNow.AddYears(1)); v3CertGen.SetSubjectDN(requestInfo.Subject); v3CertGen.SetPublicKey(subPub); if (issPub is ECPublicKeyParameters) { //          ,    GOST3411withECGOST3410 ECPublicKeyParameters ecPub = (ECPublicKeyParameters)issPub; if (ecPub.AlgorithmName == "ECGOST3410") { v3CertGen.SetSignatureAlgorithm("GOST3411withECGOST3410"); } else { throw new Exception("   GOST3411withECGOST3410"); } } else { throw new Exception(" GOST3411withECGOST3410"); } // extensions v3CertGen.AddExtension( X509Extensions.SubjectKeyIdentifier, false, new SubjectKeyIdentifier(SubjectPublicKeyInfoFactory.CreateSubjectPublicKeyInfo(subPub))); v3CertGen.AddExtension( X509Extensions.AuthorityKeyIdentifier, false, new AuthorityKeyIdentifier(SubjectPublicKeyInfoFactory.CreateSubjectPublicKeyInfo(issPub))); v3CertGen.AddExtension( X509Extensions.BasicConstraints, false, new BasicConstraints(false)); X509Certificate _cert = v3CertGen.Generate(_cCAKey); _cert.CheckValidity(); _cert.Verify(issPub); var s = new StringWriter(); PemWriter pw = new PemWriter(s); pw.WriteObject(_cert); pw.Writer.Close(); return s.ToString(); }</span></span></code> </pre> <br><br><h4>  Verifying a signed CMS on the server </h4><br>  We will generate a CMS on the client and send it to the server, where we will verify the signature and chain of certificates. <br><br>  From BouncyCastle use: <br>  - Signed verification signed CMS <br>  - Building a certificate chain <br><br>  All verification is reduced to verifying the signature and building a chain of certificates, including the root and the user certificate issued on it.  For simplicity, we will not use intermediate certificates and will not work with CRL, although the library does have the ability to organize verification of the list of revoked certificates. <br><br>  Checking a signed CMS is done like this: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    public void verifyCert(X509Certificate cert) { try { //    var pRd = new PemReader(new StringReader(cCACert)); var _cCACert = (X509Certificate)pRd.ReadObject(); pRd.Reader.Close(); //     IList certList = new ArrayList(); certList.Add(_cCACert); certList.Add(cert); IX509Store x509CertStore = X509StoreFactory.Create( "Certificate/Collection", new X509CollectionStoreParameters(certList)); //   ,     ISet trust = new HashSet(); trust.Add(new TrustAnchor(_cCACert, null)); PkixCertPathBuilder cpb = new PkixCertPathBuilder(); X509CertStoreSelector targetConstraints = new X509CertStoreSelector(); targetConstraints.Subject = cert.SubjectDN; PkixBuilderParameters parameters = new PkixBuilderParameters(trust, targetConstraints); parameters.AddStore(x509CertStore); //   crl parameters.IsRevocationEnabled = false; //  ,   -  PkixCertPathBuilderResult result = cpb.Build(parameters); } catch (PkixCertPathBuilderException certPathEx) { throw new PkixCertPathBuilderException(string.Format("  , {0}", certPathEx.Message)); } catch (Exception ex) { throw new Exception(string.Format("  : {0}", cert.SubjectDN), ex); } } //  signed CMS public string verifyCms(string cmsText) { CmsSignedData cms = new CmsSignedData(Base64.Decode(cmsText)); SignerInformationStore sif = cms.GetSignerInfos(); var signers = sif.GetSigners(); var ucrts = cms.GetCertificates("collection"); //var crl = cms.GetCrls("collection"); //   ,     signer    foreach (SignerInformation signer in signers) { ICollection certCollection = ucrts.GetMatches(signer.SignerID); IEnumerator certEnum = certCollection.GetEnumerator(); certEnum.MoveNext(); X509Certificate cert = (X509Certificate)certEnum.Current; if (!signer.Verify(cert)) { throw new CertificateException("   "); } verifyCert(cert); } return "ok"; }</span></span></code> </pre><br><br>  Once again, the example is suitable for <b>testing</b> or <b>demonstrating</b> solutions that work with Russian certificates. </div><p>Source: <a href="https://habr.com/ru/post/257407/">https://habr.com/ru/post/257407/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257393/index.html">Offline data handling in a mobile application using Couchbase Lite</a></li>
<li><a href="../257397/index.html">Layout of responsive emails: a detailed guide (part 2)</a></li>
<li><a href="../257401/index.html">We get acquainted with Fabric.js. Part 4</a></li>
<li><a href="../257403/index.html">The first 6 lectures of the online school Android developers</a></li>
<li><a href="../257405/index.html">Recognizing users' physical activity with examples on R</a></li>
<li><a href="../257409/index.html">Discrete Fourier Transform of the Fractal Brownian Motion</a></li>
<li><a href="../257413/index.html">Trojan-Downloader.Win32.Cabby.cemx - Part One - Unpacking</a></li>
<li><a href="../257415/index.html">Typographer - the story continues</a></li>
<li><a href="../257417/index.html">120 servers in 30 days: tenders and other nuances of working with government agencies</a></li>
<li><a href="../257421/index.html">Interview about testing + screenshots of applications working in ReactOS, sent by testers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>