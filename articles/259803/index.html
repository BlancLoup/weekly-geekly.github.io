<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Predicting stock price using big data and machine learning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translator's note: In our blog, we already talked about tools for creating trading robots, and even analyzed the relationship between the name of the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Predicting stock price using big data and machine learning</h1><div class="post__text post__text-html js-mediator-article">  <b>Translator's note:</b> <i>In our blog, we already talked about <a href="http://habrahabr.ru/post/212335/">tools for creating</a> trading robots, and even analyzed the relationship <a href="http://habrahabr.ru/company/itinvest/blog/205886/">between the name of the</a> company's <a href="http://habrahabr.ru/company/itinvest/blog/205886/">stock</a> ticker and the success of its shares.</i>  <i>Today we present to your attention a translation of an interesting article, the author of which developed a system that analyzes changes in stock prices in the past and tries to predict the future stock price using machine learning.</i> <br><br> <a href="http://habrahabr.ru/company/itinvest/blog/259803/"><img src="https://habrastorage.org/files/026/3cd/080/0263cd0805874e50a6e9f68448f9e767.jpg"></a> <br><br><h5>  Short review </h5><br>  This post is based on an <a href="https://raw.github.com/ezhulenev/scala-openbook/master/assets/Modeling-high-frequency-limit-order-book-dynamics-with-support-vector-machines.pdf">article</a> called ‚ÄúModeling the dynamics of a high-frequency portfolio of limit orders using the reference vector method‚Äù.  Roughly speaking, I step by step implement the ideas presented in this article using <a href="https://spark.apache.org/">Spark</a> and <a href="https://spark.apache.org/mllib/">Spark MLLib</a> .  The authors use abbreviated examples, but I will use the full order book from the New York Stock Exchange ( <a href="http://www.nyxdata.com/Data-Products/NYSE-OpenBook-History">NYSE</a> ) (selected data are available on the <a href="">NYSE FTP</a> ), since working with Spark I can easily do this.  Instead of using the support vector method, I will use the <a href="http://spark.apache.org/docs/latest/mllib-decision-tree.html">decision tree</a> algorithm for classification, since Spark MLLib initially supports multiclass classification. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you want to further understand the problem and the proposed solution, you need to read that article.  I will do a full review of the problem in one or two sections, but in a less scientific language. <br><br>  Predictive modeling is the process of choosing or creating a model whose goal is the most accurate prediction of a possible outcome. <a name="habracut"></a><br><br><h4>  Model architecture </h4><br>  The authors propose a framework for extracting feature vectors from an unformatted order log, which can be used as a set of input data for a classification method (for example, support vector machine or decision tree building) to predict a change in the securities rate (grow, decrease, not change).  Based on a set of test data with labels assigned to them (price change), the classification algorithm builds a model that places new instances in one of the predefined categories. <br><br><pre><code class="cs hljs">Time(sec) Price($) Volume Event Type Direction - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - <span class="hljs-number"><span class="hljs-number">34203.011926972</span></span> <span class="hljs-number"><span class="hljs-number">598.68</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> submission ask <span class="hljs-number"><span class="hljs-number">34203.011926973</span></span> <span class="hljs-number"><span class="hljs-number">594.47</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> submission bid <span class="hljs-number"><span class="hljs-number">34203.011926974</span></span> <span class="hljs-number"><span class="hljs-number">594.49</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> submission bid <span class="hljs-number"><span class="hljs-number">34203.011926981</span></span> <span class="hljs-number"><span class="hljs-number">597.68</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> submission ask <span class="hljs-number"><span class="hljs-number">34203.011926991</span></span> <span class="hljs-number"><span class="hljs-number">594.47</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> execution ask <span class="hljs-number"><span class="hljs-number">34203.011927072</span></span> <span class="hljs-number"><span class="hljs-number">597.68</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> cancellation ask <span class="hljs-number"><span class="hljs-number">34203.011927082</span></span> <span class="hljs-number"><span class="hljs-number">599.88</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> submission ask <span class="hljs-number"><span class="hljs-number">34203.011927097</span></span> <span class="hljs-number"><span class="hljs-number">598.38</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> submission ask</code> </pre> <br>  In the table, each row represents a trade transaction that reflects the receipt of the order, the cancellation of the order or its execution.  The arrival time is counted from midnight in seconds and nanoseconds, the price is in US dollars, and the volume - in the number of shares.  Ask means that I sell and ask for my share of the specified price, Bid means that I want to buy at the specified price. <br><br>  From this log it is very easy to restore the status of the order portfolio after each completed operation.  You can learn more about the order book (order book) and <a href="http://www.investopedia.com/university/intro-to-order-types/limit-orders.asp">limit order portfolio</a> in Investopedia.  I will not go into details.  The general idea is very simple and straightforward. <br>  This is an electronic list of sell and buy orders for a specific security or financial instrument, sorted by price level. <br><br><h4>  Extracting feature vectors and preparing test data </h4><br>  After the order portfolios are restored from the order journal, we can extract attributes and form feature vectors that will be used as input data for the <code> </code> . <br><br>  Attributes are divided into three categories: basic, time insensitive and time sensitive.  Each of the categories can be calculated directly on the basis of the data obtained.  Basic attributes are prices and volumes, both with the ask flag and the bid flag, in the amount of n = 10 different levels (represent price levels of the order portfolio at a given moment), which can be directly obtained from the order portfolio.  Timeless insensitive attributes are easily calculated at a single point in time from the attributes of the base set.  These include the bid-ask spread and the average price of the spread, price ranges, and the average price and volume at various price levels, which are calculated in feature sets <code>v2</code> , <code>v3</code> and <code>v5</code> respectively.  A set of v5 is needed to keep track of the accumulating difference in price and volume of shares between ask and bid.  Then, taking into account the value of the data in previous periods, we calculate the parameters of the time-sensitive category.  You can read more about feature calculations in the <a href="https://raw.github.com/ezhulenev/scala-openbook/master/assets/Modeling-high-frequency-limit-order-book-dynamics-with-support-vector-machines.pdf">original article</a> . <br><br><img src="https://habrastorage.org/files/002/dbb/11c/002dbb11c8684dcfa7df22732d236e2d.png"><br><br><h4>  Markup test data </h4><br>  Preparation of test data for machine learning requires marking each time point, within which a change in the value of shares is observed (1 second, for example).  This is a simple task that requires only two portfolios of orders: the current portfolio of orders and a portfolio of orders, formed after some time. <br><br>  I will use the label <code>MeanPriceMove</code> , which can be <code>Stationary</code> , <code>Up</code> or <code>Down</code> (will not change, grow, decrease). <br><br><pre> <code class="cs hljs">trait Label[L] extends Serializable { label =&gt; <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">current: OrderBook, future: OrderBook</span></span></span><span class="hljs-function">): Option[L] } </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sealed</span></span></span><span class="hljs-function"> trait MeanPriceMove </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> MeanPriceMove</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Up extends MeanPriceMove <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Down extends MeanPriceMove <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Stationary extends MeanPriceMove } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> MeanPriceMovementLabel extends Label[MeanPriceMove] { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>] val basicSet = BasicSet.apply(BasicSet.Config.<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>) <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">current: OrderBook, future: OrderBook</span></span></span><span class="hljs-function">): Option[MeanPriceMove]</span></span> = { val currentMeanPrice = basicSet.meanPrice(current) val futureMeanPrice = basicSet.meanPrice(future) val cell: Cell[MeanPriceMove] = currentMeanPrice.zipMap(futureMeanPrice) { (currentMeanValue, futureMeanValue) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMeanValue == futureMeanValue) MeanPriceMove.<span class="hljs-function"><span class="hljs-function">Stationary else </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">currentMeanValue &gt; futureMeanValue</span></span></span><span class="hljs-function">) MeanPriceMove.Down else MeanPriceMove.Up } cell.toOption } }</span></span></code> </pre><br><h4>  Order logs </h4><br>  I will use <a href="http://www.nyxdata.com/Data-Products/NYSE-OpenBook-History">NYSE TAQ OpenBook</a> order <a href="http://www.nyxdata.com/Data-Products/NYSE-OpenBook-History">logs</a> and parse them using the <a href="https://github.com/ezhulenev/scala-openbook">Scala OpenBook</a> library.  A free dataset for two trading days is available for download on the <a href="">NYSE FTP</a> - it's very easy to get. <br><br>  The TAQ (Trades and Quotes) databases provide time-varying price glass values ‚Äã‚Äãin the T + 1 basis for closed markets.  The results of TAQ data processing are used in the development and testing of trading strategies, analysis of market trends on real data and market research for the purpose of monitoring or conducting an audit. <br><br><h4>  Preparation of test data </h4><br>  <code>OrderBook</code> consists of two sorted tables, where the key is the price, and the value is the number of shares. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">case</span></span></span><span class="hljs-function"> class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OrderBook</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">symbol: String, buy: TreeMap[Int, Int] = TreeMap.empty, sell: TreeMap[Int, Int] = TreeMap.empty</span></span></span><span class="hljs-function">)</span></span></code> </pre><br><h4>  Parameter Sets </h4><br>  I use the <code>Cell</code> tool from the <a href="https://github.com/pellucidanalytics/framian">Framian</a> library to visually present the extracted values ‚Äã‚Äãof attributes: <code>Value</code> , <code>NA</code> or <code>NM</code> . <br><br>  As defined in the original article, we have three sets of features.  The values ‚Äã‚Äãof the first two of them are calculated on the basis of the <code>OrderBook</code> data, the latter requires the creation of the <code>OrdersTrail</code> table, which is essentially an unformatted order log, which the window Fourier transform has been applied to. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> trait BasicAttribute[T] extends Serializable { self =&gt; <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderBook: OrderBook</span></span></span><span class="hljs-function">): Cell[T] def map[T2](</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f: T =&gt; T2</span></span></span><span class="hljs-function">): BasicAttribute[T2]</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicAttribute[T2] { <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderBook: OrderBook</span></span></span><span class="hljs-function">): Cell[T2]</span></span> = self(orderBook).map(f) } }</code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> trait TimeInsensitiveAttribute[T] extends Serializable { self =&gt; <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderBook: OrderBook</span></span></span><span class="hljs-function">): Cell[T] def map[T2](</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f: T =&gt; T2</span></span></span><span class="hljs-function">): TimeInsensitiveAttribute[T2]</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TimeInsensitiveAttribute[T2] { <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderBook: OrderBook</span></span></span><span class="hljs-function">): Cell[T2]</span></span> = self(orderBook).map(f) } }</code> </pre><br><pre> <code class="cs hljs">trait TimeSensitiveAttribute[T] extends Serializable { self =&gt; <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ordersTrail: Vector[OpenBookMsg]</span></span></span><span class="hljs-function">): Cell[T] def map[T2](</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f: T =&gt; T2</span></span></span><span class="hljs-function">): TimeSensitiveAttribute[T2]</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TimeSensitiveAttribute[T2] { <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ordersTrail: Vector[OpenBookMsg]</span></span></span><span class="hljs-function">): Cell[T2]</span></span> = self(ordersTrail).map(f) } }</code> </pre><br>  and here is the calculation of signs: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BasicSet</span></span> <span class="hljs-title"><span class="hljs-title">private</span></span>[<span class="hljs-title"><span class="hljs-title">attribute</span></span>] (<span class="hljs-title"><span class="hljs-title">val</span></span> <span class="hljs-title"><span class="hljs-title">config</span></span>: <span class="hljs-title"><span class="hljs-title">BasicSet</span></span>.<span class="hljs-title"><span class="hljs-title">Config</span></span>) <span class="hljs-title"><span class="hljs-title">extends</span></span> <span class="hljs-title"><span class="hljs-title">Serializable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>[attribute] <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">askPrice</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderBook: OrderBook</span></span></span><span class="hljs-function">)(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i: Int</span></span></span><span class="hljs-function">): Cell[Int]</span></span> = { Cell.fromOption { orderBook.sell.keySet.drop(i - <span class="hljs-number"><span class="hljs-number">1</span></span>).headOption } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>[attribute] <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bidPrice</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderBook: OrderBook</span></span></span><span class="hljs-function">)(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i: Int</span></span></span><span class="hljs-function">): Cell[Int]</span></span> = { Cell.fromOption { val bidPrices = orderBook.buy.<span class="hljs-function"><span class="hljs-function">keySet </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bidPrices.size &gt;= i</span></span></span><span class="hljs-function">)</span></span> { bidPrices.drop(bidPrices.size - i).headOption } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> None } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> def attribute[T](f: OrderBook =&gt; Cell[T]): BasicAttribute[T] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicAttribute[T] { <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orderBook: OrderBook</span></span></span><span class="hljs-function">): Cell[T]</span></span> = f(orderBook) } <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">askPrice</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i: Int</span></span></span><span class="hljs-function">): BasicAttribute[Int]</span></span> = attribute(askPrice(_)(i)) <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bidPrice</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i: Int</span></span></span><span class="hljs-function">): BasicAttribute[Int]</span></span> = attribute(bidPrice(_)(i)) val meanPrice: BasicAttribute[Double] = { val ask1 = askPrice(<span class="hljs-number"><span class="hljs-number">1</span></span>) val bid1 = bidPrice(<span class="hljs-number"><span class="hljs-number">1</span></span>) BasicAttribute.<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>(orderBook =&gt; ask1(orderBook).zipMap(bid1(orderBook)) { (ask, bid) =&gt; (ask.toDouble + bid.toDouble) / <span class="hljs-number"><span class="hljs-number">2</span></span> }) } }</code> </pre><br><h4>  Marking test data </h4><br>  To extract tagged data from orders, I use <code>LabeledPointsExtractor</code> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LabeledPointsExtractor</span></span>[<span class="hljs-title"><span class="hljs-title">L</span></span>: <span class="hljs-title"><span class="hljs-title">LabelEncode</span></span>] { <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">labeledPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">orders: Vector[OpenBookMsg]</span></span></span><span class="hljs-function">): Vector[LabeledPoint]</span></span> = { log.debug(s<span class="hljs-string"><span class="hljs-string">"Extract labeled points from orders log. Log size: ${orders.size}"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre><br>  and so it can be improved with the help of the builder: <br><br><pre> <code class="cs hljs">val extractor = { import com.scalafi.dynamics.attribute.LabeledPointsExtractor._ (LabeledPointsExtractor.newBuilder() += basic(_.askPrice(<span class="hljs-number"><span class="hljs-number">1</span></span>)) += basic(_.bidPrice(<span class="hljs-number"><span class="hljs-number">1</span></span>)) += basic(_.meanPrice) ).result(symbol, MeanPriceMovementLabel, LabeledPointsExtractor.Config(<span class="hljs-number"><span class="hljs-number">1.</span></span>millisecond)) }</code> </pre><br>  <code>Extractor</code> prepare the marked points using the <code>MeanPriceMovementLabel</code> with three signs: the ask price (ask price), the set price (bid price) and the average price (mean price). <br><br><h4>  Run a classification model </h4><br>  In the "real" application, I use 36 attributes from all 3 sets.  The tests are run with examples of data downloaded from the NYSE FTP: <code>EQY_US_NYSE_BOOK_20130403</code> to train the model and <code>EQY_US_NYSE_BOOK_20130404</code> to check the correctness of the work. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> DecisionTreeDynamics extends App with ConfiguredSparkContext with FeaturesExtractor { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val log = LoggerFactory.getLogger(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getClass) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">case</span></span></span><span class="hljs-function"> class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">training: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, validation: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, filter: Option[String] = None, symbol: Option[String] = None</span></span></span><span class="hljs-function">) val parser</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OptionParser[Config](<span class="hljs-string"><span class="hljs-string">"Order Book Dynamics"</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// .... } parser.parse(args, Config()) map { implicit config =&gt; val trainingFiles = openBookFiles("Training", config.training, config.filter) val validationFiles = openBookFiles("Validation", config.validation, config.filter) val trainingOrderLog = orderLog(trainingFiles) log.info(s"Training order log size: ${trainingOrderLog.count()}") // Configure DecisionTree model val labelEncode = implicitly[LabelEncode[MeanPriceMove]] val numClasses = labelEncode.numClasses val categoricalFeaturesInfo = Map.empty[Int, Int] val impurity = "gini" val maxDepth = 5 val maxBins = 100 val trainingData = trainingOrderLog.extractLabeledData(featuresExtractor(_: String)) val trainedModels = (trainingData map { case LabeledOrderLog(symbol, labeledPoints) =&gt; log.info(s"$symbol: Train Decision Tree model. Training data size: ${labeledPoints.count()}") val model = DecisionTree.trainClassifier(labeledPoints, numClasses, categoricalFeaturesInfo, impurity, maxDepth, maxBins) val labelCounts = labeledPoints.map(_.label).countByValue().map { case (key, count) =&gt; (labelEncode.decode(key.toInt), count) } log.info(s"$symbol: Label counts: [${labelCounts.mkString(", ")}]") symbol -&gt; model }).toMap val validationOrderLog = orderLog(validationFiles) log.info(s"Validation order log size: ${validationOrderLog.count()}") val validationData = validationOrderLog.extractLabeledData(featuresExtractor(_: String)) // Evaluate model on validation data and compute training error validationData.map { case LabeledOrderLog(symbol, labeledPoints) =&gt; val model = trainedModels(symbol) log.info(s"$symbol: Evaluate model on validation data. Validation data size: ${labeledPoints.count()}") log.info(s"$symbol: Learned classification tree model: $model") val labelAndPrediction = labeledPoints.map { point =&gt; val prediction = model.predict(point.features) (point.label, prediction) } val trainingError = labelAndPrediction.filter(r =&gt; r._1 != r._2).count().toDouble / labeledPoints.count log.info(s"$symbol: Training Error = " + trainingError) } } }</span></span></code> </pre><br><h4>  Learning errors </h4><br>  The results of the classification by building a decision tree for a single <code>ORCL</code> ticker: <br><br><pre> <code class="xml hljs">ORCL: Train Decision Tree model. Training data size: 64064 ORCL: Trained model in 3740 millis ORCL: Label counts: [Stationary -&gt; 42137, Down -&gt; 10714, Up -&gt; 11213] ORCL: Evaluate model on validation data. Validation data size: 54749 ORCL: Training Error = 0.28603262160039455</code> </pre><br>  As you can see, this rather simple model was able to successfully classify about 70% of the data. <br><br>  <b>Note</b> : Although the model works very well, this does not mean that it can successfully be used to build a profitable automated trading strategy.  First, I do not check if my model predicts any price changes with an average accuracy of 70% with a 95% probability.  The model does not measure the "intensity" of the dynamics of securities prices, moreover, in reality, the model should work effectively enough to cover transaction costs.  Not to mention the other little things that are important for building a real trading system. <br><br>  In fact, a lot can be done in terms of improving the system and checking the results.  Unfortunately, it is very difficult to get enough data: the data for the two trading days is not enough to draw conclusions and start creating a system that can earn all the money in the world.  However, I think this is a pretty good starting point. <br><br><h4>  results </h4><br>  I relatively easily conducted a rather complex research project on a larger scale than the one described in the original article. <br><br>  The latest technologies in the field of big data allow you to create models using all available information without the use of samples.  Using all the information helps to create the best models and isolate all the details from the complete data set. <br><br><blockquote>  <a href="https://github.com/ezhulenev/orderbook-dynamics">Application code on GitHub</a> </blockquote><br><h5>  <b>Offtopic: the</b> <a href="http://www.itinvest.ru/">ITinvest</a> <a href="http://habrahabr.ru/company/itinvest/blog/259517/">developer</a> <a href="http://www.itinvest.ru/">competition</a> and the StockSharp project team continue - create additions or corrections to the StockSharp system on GitHab, and receive a cash reward for each commit made. </h5></div><p>Source: <a href="https://habr.com/ru/post/259803/">https://habr.com/ru/post/259803/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259791/index.html">Kingdom of multi-layered mirrors</a></li>
<li><a href="../259793/index.html">Create responsive emails for the future without media queries.</a></li>
<li><a href="../259795/index.html">tmsTable - as I wrote a plugin to display tables, guided by the principle of KISS</a></li>
<li><a href="../259797/index.html">Wireless Bridge Setup on QDSL-1040WU</a></li>
<li><a href="../259799/index.html">Application Migration - Myths and Reality</a></li>
<li><a href="../259805/index.html">Returning the execution result from the DialogFragment to the Fragment bypassing the Activity</a></li>
<li><a href="../259809/index.html">ESP8266 - solar-powered sensor data collection</a></li>
<li><a href="../259811/index.html">20th anniversary php</a></li>
<li><a href="../259815/index.html">Life without DDoS</a></li>
<li><a href="../259821/index.html">Customize Checkpoint. Part 1. Installation and initial configuration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>