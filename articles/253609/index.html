<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The ‚Äúperfect storm‚Äù and how it is treated</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 Broadcast storm is a nightmare for networkers when in a matter of seconds the transmission of useful traffic is paralyzed in the entire d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The ‚Äúperfect storm‚Äù and how it is treated</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  <b>Broadcast storm</b> is a nightmare for networkers when in a matter of seconds the transmission of useful traffic is paralyzed in the entire data center network.  How this happens and what should have been thought before - in our today's post. <br><img src="http://" alt="image"><img src="https://habrastorage.org/files/8c4/67e/353/8c467e3533a5452582015312fb64a4aa.jpg" alt="image"><a name="habracut"></a><br><br>  <b>Where did it go</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Initially, there was Ethernet, and there was no routing in it, and now it doesn‚Äôt exist either, and therefore the switch has to send data packets to all ports - well, for sure.  From the addressee the answer to a certain port comes, the switch remembers the correspondence [port - addressee] and the next ‚Äúparcel‚Äù is sent not anyhow somewhere, but by memorable, so to speak, places. <br><br>  If there is no answer, and at the moment of sending unknown unicast, a couple of switches are locked into a ring, the package is returned to the ‚Äúsender‚Äù, which, of course, throws it back to all ports, because what else can it do?  The "unattended" data packet is again returned and flies away again.  Every next round of ‚Äúlooped‚Äù broadcast flood is accompanied by an exponential increase in the number of packets in a network segment.  Very soon, this avalanche "clogs" the bandwidth of the ports, in the background the overloaded switch processors "boil" beautifully - and your network becomes a monument to itself. <br><br>  The cause of a storm can be either a hacker attack, or a misfire of your engineer when setting up equipment - or a protocol failure.  In other words, no one is insured. <br><br>  <b>There was such a case</b> <br><br>  In 2009, a Broadcast storm occurred in the network of one of our clients, which instantly spread to us, paralyzing the work of the entire data transmission network of the company.  Mail, telephony and the Internet fell off, the monitoring system "went crazy" - and it became impossible to even locate the "original source".  A full reset of the switch did not help.  There was nothing left for us to do but to consistently turn off ALL ports, client and own ports ... Such is Black Monday. <br><br>  As it turned out later, one of the client‚Äôs employees confused the equipment ports - and looped his topology at the level of the brodcast domain.  It happens. <br><br>  It is clear that in the risk group here, first of all, commercial data centers: a redundant connection for each client in itself already means redundancy of connections between switches.  However, I would not recommend networkers to corporate data centers to relax either: it‚Äôs possible to close a pair of switches over each other by absent-mindedness in the server room. <br>  The good news is that with proper preparation you can get off with a little fright where you would otherwise get a simple service. <br><br>  <b>Where to begin</b> <br><br>  Start with <b>network segmentation</b> by <b>VLAN</b> : when the network is divided into small isolated segments (fault domain), the storm that covers one of the sections is limited to this area.  Well, ideally.  In fact, a powerful storm, alas, is capable of throwing packets into so-called independent virtual networks, too. <br>  In an amicable way, you need to abandon the "looped-in" VLANs both within your own infrastructure and when clients connect to the network (if we are talking about a commercial data center).  For example, use <b>the FHRP protocols</b> and the <b>U-shaped topology</b> at the access level. <br><br><img src="https://habrastorage.org/files/fb2/ef9/fc3/fb2ef9fc319d4d07b5695678647ead27.png" alt="image"><br>  <i>U-shaped topology avoids loopback</i> <br><br>  In some cases, however, with all the desire, there is no way out of the "looping".  Let's say you need to deploy a fault-tolerant (2N) infrastructure for a customer with a connection to our cloud.  Client VLANs here have to be ‚Äúforwarded‚Äù within the cloud infrastructure between all the ESXi virtualization cluster hosts ‚Äî that is, the solution itself implies the complete duplication of all network elements. <br>  We look at the picture - we see the ring. <br><br><img src="https://habrastorage.org/files/0cc/7de/b4e/0cc7deb4eec54fd5ba4a695f410a2184.png" alt="image"><br>  <i>Ring topology occurs with full redundancy of communication channels and customer infrastructure</i> <br><br>  <b>What to do if you are ‚ÄúLord of the Rings"</b> <br><br>  You can do different things, and each option, as usual, has its own advantages and costs. <br><br>  Here, for example, the <b>RSTP</b> protocol (modification SpanningTreeProtocol) is able to quickly - within 6 seconds - find and ‚Äúbreak‚Äù broadcasted loops.  He finds them through the exchange of BPDU (Bridge Protocol Data Unit) messages between the switches, and ‚Äúbreaks‚Äù the blocking of backup links.  In case of problems with the primary channel, the RTSP rebuilds the topology using the backup port. <br><br>  Good in general, but there is a nuance.  One RSTP process is allocated for each VLAN, while the number of processes, unlike VLANs, is very limited, and with a sharp increase in the number of VLANs within one process grid, RSTP may simply not be enough.  That is, for the corporate data center will go, and for the commercial - with an ever-growing number of clients (VLAN) - is not very. <br><br>  In this case, there is <b>MSTP</b> - an improved and updated edition of RSTP.  It is able to combine several VLANs into one STP process (instance), which in a good sense of the word affects the scalability of the network: the ‚Äúceiling‚Äù here is 4,096 clients (the maximum number of VLANs).  MSTP also allows you to manage traffic by distributing MST processes between the main link and the backup link, and allows you to unload the ‚Äúplugged‚Äù switches if necessary.  However, you need to be able to work with MST, that is, this is plus at least one expensive nerd in the state (which is not available to everyone). <br><br><img src="https://habrastorage.org/files/312/59f/fd3/31259ffd377a4527ac4fd43c6edaf030.png" alt="image"><br>  <i>The RSTP and MST protocols "break" the loop, blocking traffic on one of the channels</i> <br><br>  From the proven MSTP alternatives, we can advise Cisco <b>FlexLinks</b> , which we use when there is one switch or stack on the client side under a single control.  FlexLinks is able to reserve switch links without using STP, ‚Äúassigning‚Äù in each pair of ports the primary and backup.  It is used at the access level when connecting equipment from different companies on the principle of Looped Triangle in a commercial data center.  A very simple tool in terms of settings, which is nice in itself, and allows you to count on greater stability of the service (as compared with, for example, STP).  You will love FlexLinks for instantly switching to backup links and load balancing on VLANs - and then, perhaps, fall out of love for the opportunity to apply it exclusively in the Looped Triangle topology. <br><br><img src="https://habrastorage.org/files/c15/549/0d6/c155490d69fc4aea88e5c552db8ddfe1.png" alt="image"><br>  <i>In the Looped Triangle topology, you can instantly switch traffic between channels in the event of a failure.</i> <br><br>  Now we digress from the technology.  Do you love economic efficiency just as I love her?  Then you will be interested to know that both MST \ RSTP and FlexLinks, blocking backup links, virtually exclude half of the ports from the traffic cycle in nature. <br><br>  But solutions that do not do this: <b>Cisco VSS</b> (Virtual Switch System), <b>Nexus vPC</b> (virtual port-channel), <b>Juniper virtual router</b> and other <b>mLAG-like</b> (multichassis link aggregation) technologies.  They are good because they use all available links, combining them into one logical channel <b>EtherChannel</b> .  It turns out a kind of switching cluster in which the control module of one of the switches (Control-plane) ‚Äúdrives‚Äù all the links of the cluster (Data-Plane).  In the event of failure of the current Control-plane, its authority is automatically transferred to the ‚Äúsurvivor‚Äù.  We use <b>Cisco Nexus vPC</b> for load balancing between customer links that have one switch or stack.  If, on the client side, two separate switches connected by a common VLAN are added to the STP scheme. <br><br><img src="https://habrastorage.org/files/e72/169/0d8/e721690d85304ce8b47e96dc0fda9a73.png" alt="image"><br>  <i>Combining links into one logical channel solves the problem with storms and does not affect performance</i> <br><br>  <b>If you have clouds</b> <br><br>  Virtualization, disaster-tolerant cloud services distributed between data centers, and other cluster solutions - all this requires a slightly different approach to the organization of a Layer 2 network.  We remove STP on the mezzanine - we get <b>TRILL</b> . <br><br>  TRILL uses a routing mechanism at the Ethernet level and builds a loop-free path for broadband traffic itself, thereby preventing the occurrence of storms.  Well, isn't it a miracle? :) Another TRILL allows you to evenly distribute the load between the links (up to 16 links), combine distributed data centers into a single L2 network and manage traffic flexibly.  TRILL is a generally accepted standard that vendor options quickly emerged: <b>FabricPath</b> from Cisco (which we use) and <b>VCS</b> from Brocade.  Juniper developed its own <b>Qfabric</b> technology, which allows to create a single Ethernet factory. <br><br>  <b>Control shot</b> <br><br>  What protocol will give you 100% storm protection?  That's right, no.  Therefore, you may be interested in the following two tools: <br><br>  ‚Ä¢ <b>Storm-control</b> <br>  Allows you to set per second ‚Äúquota‚Äù on the number of broadcasted packets passing through one port.  Anything beyond the ‚Äúquota‚Äù is discarded, and thus the load is controlled.  Some nuance is that Storm-control does not distinguish the useful traffic from garbage. <br>  ‚Ä¢ <b>Control ‚Äî plane policing (CoPP)</b> <br>  A sort of storm-control for a switch processor.  With a broadcast storm, among other things, the number of ARP requests increases dramatically.  When this number rolls over, the processor is loaded 100% - and the network, of course, tells you ‚Äúgoodbye‚Äù.  CoPP can ‚Äúdose‚Äù the number of ARP requests and thus control the load on the processor.  It copes well with Broadcast storms from traffic exchange points, and with various DDoS attacks - checked. <br><br>  <b>How to build a death proof network</b> <br><br>  So, which of the possible options we have tested on ourselves and use, depending on the input: <br><br>  1. <b>U, V and U-shaped topology + RSTP (MST) + storm control + CoPP.</b> <br><br>  The basic set, first of all, for a commercial data center, in which you have to connect a large number of external (uncontrollable) networks to your own network - and therefore it is highly desirable to prevent the emergence of "loops" in general. <br>  If U, V, and U-shaped topologies are not your case, the ‚Äúabbreviated‚Äù version of <b>RSTP (MST) + storm control + CoPP</b> will also work. <br><br>  2. If there is a task to maximize the capabilities of the equipment and channels, take a closer look at the option <b>mLAG (VSS, vPC) + storm control + CoPP</b> . <br><br>  3. If you already have Cisco or Juniper equipment and there are no topological contraindications, try the <b>Flex Links / RTG + storm control + CoPP combination.</b> <br><br>  4. If you have a complex case with distributed platforms and other virtualization and fault tolerance refinements, your version is <b>TRILL + storm control + CoPP.</b> <br><br>  5. If you do not know what your case is, we can talk about it :). <br><br>  The main thing is to start doing at least something now, even if you sincerely think that a broadcasted storm is what happens to others.  In reality, storms "cover" the network of very different scales, and ridiculous mistakes are made even by people who, as they say, twenty years in the arts.  "And let it inspire you to the feat" (c). </div><p>Source: <a href="https://habr.com/ru/post/253609/">https://habr.com/ru/post/253609/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253597/index.html">Rivulet - audio player for torrents</a></li>
<li><a href="../253599/index.html">RuSSIR 2015: deadline for submission of articles is approaching</a></li>
<li><a href="../253601/index.html">Samsung's MagicIWB Interactive Demonstration for Business and Education</a></li>
<li><a href="../253605/index.html">Upcoming Microsoft Azure Events - Scott Guthrie Online and Moscow Community Meeting for ITPro</a></li>
<li><a href="../253607/index.html">"Soft + boxed server" or a complete solution?</a></li>
<li><a href="../253611/index.html">And for whom are you Habrahabr</a></li>
<li><a href="../253613/index.html">Mirantis OpenStack 6.0: now with plugins</a></li>
<li><a href="../253615/index.html">50% discount on e-books</a></li>
<li><a href="../253617/index.html">As I defended against phishing, and wrote a bicycle, but my own</a></li>
<li><a href="../253619/index.html">Electronic signature in a trusted environment based on the bootable Ubuntu 14.04 LTS and Rutoken EDS Flash</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>