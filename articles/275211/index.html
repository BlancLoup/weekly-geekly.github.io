<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Google Cloud Storage with Java: images and other files in the clouds</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the continuation of a series of articles on Java web development on the Google App Engine / Google Cloud Endpoints platform, we consider the Google...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Google Cloud Storage with Java: images and other files in the clouds</h1><div class="post__text post__text-html js-mediator-article">  In the continuation of a <a href="http://habrahabr.ru/post/268863/">series of articles</a> on Java web development on the Google App Engine / Google Cloud Endpoints platform, we consider the Google Cloud Storage file storage service. <br><br>  In general, the scheme is as follows: the server on the backend generates a temporary link (address) to transfer the file to a specific container (bucket) of our storage, which is inserted into the frontend form for file transfer.  The user sends an HTTP-request POST to the specified address with one or more files in the request body, files are received and placed in the repository, and HTTP-request along with the data about the placed files is received by the servlet, which after processing the information about the placed files, returns the HTTP response to the user: JSON or text / html, or in general what we wish. <br><br>  Files are stored in the repository, the servlet has a key that allows access to the file, in particular, you can give the file to the user using another servlet or create a ‚Äústatic‚Äù link (https: //). <br>  Access to the repository is also available via the web interface, and from the command line using the <a href="https://cloud.google.com/storage/docs/gsutil">gsutil</a> utility. <br><a name="habracut"></a><br>  As an example, we will integrate Google Cloud Storage with an application on GAE: hello-habrahabr-api.appspot.com + hello-habrahabr-webapp.appspot.com used in the previous <a href="http://habrahabr.ru/post/268863/">examples</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Connect Google Cloud Storage to a project on Google App Engine / Google Cloud Endpoints </h4><br>  To start, go to the developer console (App Engine Developer console): <a href="https://appengine.google.com/dashboard%3F%26app_id%3Dhello-habrahabr-api">appengine.google.com/dashboard?&amp;app_id=hello-habrahabr-api</a> (https://appengine.google.com/dashboard?&amp;app_id={proekt ID}) <br><br>  Go to the Application Settings&gt; Cloud Integration menu and click 'Create' at the bottom of the page: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/981/82d/f3b/98182df3b1df2be80576d83e2ebf6270.png" alt="image"><br><br>  We receive the message "Cloud integration tasks have started". <br><br>  Notice now that the Google Developer Console exists in two versions of the ‚Äúold‚Äù and ‚Äúnew‚Äù, functions are gradually transferred from the ‚Äúold‚Äù to the ‚Äúnew‚Äù.  We are turning on Cloud Integration from the old developer console (we should expect that this function will soon appear in the new console). <br><br>  We are reloading the page, below in the Cloud Integration section, instead of the 'Create' button, we see the message ‚ÄúThe project was created successfully.  See a bit higher in the Basics section, we see a link to the connected Google Cloud Storage Bucket, by default it is given the same name as the GAE project, in my case hello-habrahabr-api.appspot.com: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/200/542/bd0/200542bd0feb6f37b7570a024c9e2857.png" alt="image"><br><br>  We click on the link, it leads us to the address <a href="https://console.developers.google.com/storage/browser/">console.developers.google.com/storage/browser</a> {Bucket name} / D in my case: <a href="https://console.developers.google.com/storage/browser/hello-habrahabr-api.appspot.com/">console.developers.google.com/storage/browser/hello-habrahabr-api.appspot.com</a> (of course, requires authorization) and we get into the Storage browser: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66a/b24/1f9/66ab241f9a799e02a1951907da5cf2cf.png" alt="image"><br><br>  Here we can create new folders, upload and delete files, manage file access rights, including we can make the file access public and get a permanent link to the file for the web (for example, if we want to use an image or another static file for the web). site), search and filter. <br><br>  Cloud Storage provides a free bucket for each application on the Google App Engine, but in this case, the Storage Browser web interface only provides the ability to view the contents of the bucket.  In order to activate all the functions of the Storage browser and to create additional buckets, you must enable billing and enter your credit card details (click on ‚ÄúSign for free trial‚Äù and enter credit card details, for 60 days we get a free, or rather, within $ 300, trial period ). <br><br><h4>  Creating a temporary file download link </h4><br>  Required Imports: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.BlobstoreService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.BlobstoreServiceFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.UploadOptions;</code> </pre> <br>  Team to create links: <br><br><pre> <code class="java hljs">String uploadUrl = BlobstoreServiceFactory.getBlobstoreService().createUploadUrl( <span class="hljs-string"><span class="hljs-string">"/upload"</span></span>, <span class="hljs-comment"><span class="hljs-comment">// path to upload handler (servlet) UploadOptions.Builder.withGoogleStorageBucketName("hello-habrahabr-api.appspot.com") // bucket name )</span></span></code> </pre><br>  For example, if we create an API on Cloud Endpoints, then an API that returns a link to download a file will look like: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.appspot.hello_habrahabr_api; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.server.spi.config.Api; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.api.server.spi.config.ApiMethod; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.BlobstoreServiceFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.UploadOptions; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.Serializable; <span class="hljs-meta"><span class="hljs-meta">@Api</span></span>(name = <span class="hljs-string"><span class="hljs-string">"uploadAPI"</span></span>, version = <span class="hljs-string"><span class="hljs-string">"ver.1.0"</span></span>, scopes = {Constants.EMAIL_SCOPE}, clientIds = { Constants.WEB_CLIENT_ID, Constants.API_EXPLORER_CLIENT_ID }, description = <span class="hljs-string"><span class="hljs-string">"uploads API"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UploadAPI</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// add this class to &lt;init-param&gt; of &lt;servlet-name&gt;SystemServiceServlet&lt;/servlet-name&gt; in web.xml /* API methods can return JavaBean Objects only, so we use this as a wrapper for String */ class StringWrapperObject implements Serializable { private String string; public StringWrapperObject() { } public StringWrapperObject(String string) { this.string = string; } public String getString() { return string; } public void setString(String string) { this.string = string; } } // end of StringWrapperObject class @ApiMethod( name = "getCsUploadURL", path = "getCsUploadURL", httpMethod = ApiMethod.HttpMethod.POST ) @SuppressWarnings("unused") public StringWrapperObject getCsUploadURL() { String uploadURL = BlobstoreServiceFactory.getBlobstoreService().createUploadUrl( "/cs-upload", // upload handler servlet address UploadOptions.Builder.withGoogleStorageBucketName( "hello-habrahabr-api.appspot.com" // Cloud Storage bucket name ) ); return new StringWrapperObject(uploadURL); } }</span></span></code> </pre><br>  Frontend form: <br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>File Upload Form<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> One File: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enctype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"multipart/form-data"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Upload"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> Multiple Files: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enctype</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"multipart/form-data"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"files[]"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiple</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Upload"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- JavaScript --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="hljs-meta"><span class="javascript"><span class="hljs-meta"> 'use strict'</span></span></span><span class="javascript">; $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> url = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"https://hello-habrahabr-api.appspot.com/_ah/api/uploadAPI/ver.1.0/getCsUploadURL"</span></span></span><span class="javascript">; $.ajax(url, { </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">method</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"POST"</span></span></span><span class="javascript">, </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// (default: 'GET') async: false, // default: true processData: true, // (default: true) (By default, data passed in to the 'data' option as an object) success: function (data) { console.log("responce received:"); console.log(data); $("form").attr("action", data.string); } }) }) </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The same form in the form of JSP: <br><pre> <code class="java hljs">&lt;%@ page contentType=<span class="hljs-string"><span class="hljs-string">"text/html;charset=UTF-8"</span></span> language=<span class="hljs-string"><span class="hljs-string">"java"</span></span> %&gt; &lt;%@ page <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>=<span class="hljs-string"><span class="hljs-string">"com.google.appengine.api.blobstore.BlobstoreService"</span></span> %&gt; &lt;%@ page <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>=<span class="hljs-string"><span class="hljs-string">"com.google.appengine.api.blobstore.BlobstoreServiceFactory"</span></span> %&gt; &lt;%@ page <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>=<span class="hljs-string"><span class="hljs-string">"com.google.appengine.api.blobstore.UploadOptions"</span></span> %&gt; &lt;% BlobstoreService blobstoreService = BlobstoreServiceFactory.getBlobstoreService(); %&gt; &lt;html&gt; &lt;head&gt; &lt;title&gt;File Upload Form&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;hr&gt; One File: &lt;hr&gt; &lt;form action=<span class="hljs-string"><span class="hljs-string">"&lt;%= blobstoreService.createUploadUrl("</span></span>/cs-upload<span class="hljs-string"><span class="hljs-string">", UploadOptions.Builder.withGoogleStorageBucketName("</span></span>hello-habrahabr-api.appspot.com<span class="hljs-string"><span class="hljs-string">")) %&gt;"</span></span> method=<span class="hljs-string"><span class="hljs-string">"post"</span></span> enctype=<span class="hljs-string"><span class="hljs-string">"multipart/form-data"</span></span>&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"file"</span></span> name=<span class="hljs-string"><span class="hljs-string">"file"</span></span>&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"submit"</span></span> value=<span class="hljs-string"><span class="hljs-string">"Upload"</span></span>&gt; &lt;/form&gt; &lt;hr&gt; Multiple Files: &lt;hr&gt; &lt;form action=<span class="hljs-string"><span class="hljs-string">"&lt;%= blobstoreService.createUploadUrl("</span></span>/cs-upload<span class="hljs-string"><span class="hljs-string">", UploadOptions.Builder.withGoogleStorageBucketName("</span></span>hello-habrahabr-api.appspot.com<span class="hljs-string"><span class="hljs-string">")) %&gt;"</span></span> method=<span class="hljs-string"><span class="hljs-string">"post"</span></span> enctype=<span class="hljs-string"><span class="hljs-string">"multipart/form-data"</span></span>&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"file"</span></span> name=<span class="hljs-string"><span class="hljs-string">"files[]"</span></span> multiple&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"submit"</span></span> value=<span class="hljs-string"><span class="hljs-string">"Upload"</span></span>&gt; &lt;/form&gt; &lt;/body&gt; &lt;/html&gt;</code> </pre><br>  The link will look like this: <br><br> <code>https://hello-habrahabr-api.appspot.com/_ah/upload/AMmfu6YJ0ci-sKP5k98sKaJEUjYwBFbkVfQ7iylXTJV52_gy5HIECKNG52IPUCJ9PB3wpL2wxgX82GkGkzetHt-6fuu4yzAzFFhD8HGOcD7eJ48KJLnKnb2EqbuoFEdyuc8r_FTR7779IIaf42rf_jhkl7Hju3GxWDmxh2WtmcPR2AbB9OWlQhYxBIWtZgBW9OsHO50pI21/ALBNUaYAAAAAVp2DRSZYST46t2kPmrGrrBoY3AFjyOiD/ <br></code> <br><br>  But the HTTP response will be generated by the servlet located at <code>/cs-upload</code> <br><br><h4>  HTTP response response upload (upload handler) </h4><br>  This servlet will look like this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.appspot.hello_habrahabr_api; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.BlobKey; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.BlobstoreServiceFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.FileInfo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.images.ImagesServiceFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.images.ServingUrlOptions; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.repackaged.com.google.gson.Gson; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.repackaged.com.google.gson.GsonBuilder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.ServletException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServlet; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletRequest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletResponse; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.PrintWriter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.logging.Logger; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CSUploadHandlerServlet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpServlet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger LOG = Logger.getLogger(CSUploadHandlerServlet.class.getName()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String HOST = <span class="hljs-string"><span class="hljs-string">"https://hello-habrahabr-api.appspot.com"</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Object to be returned as JSON in HTTP-response (and can be stored in data base) */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UploadedFileData</span></span></span><span class="hljs-class"> </span></span>{ FileInfo fileInfo; String BlobKey; String fileServeServletLink; String servingUrlFromgsObjectName; String servingUrlFromGsBlobKey; } <span class="hljs-comment"><span class="hljs-comment">// end of uploadedFileData @Override public void doPost(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException { // Returns the FileInfo for any files that were uploaded, keyed by the upload form "name" field. // This method should only be called from within a request served by the destination of a createUploadUrl call. // https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/blobstore/BlobstoreService#getFileInfos-HttpServletRequest- java.util.Map&lt;java.lang.String, java.util.List&lt;FileInfo&gt;&gt; fileInfoListsMap = BlobstoreServiceFactory.getBlobstoreService().getFileInfos(req); LOG.warning("[LOGGER]: " + new Gson().toJson(fileInfoListsMap)); ArrayList&lt;UploadedFileData&gt; uploadedFilesDataList = new ArrayList&lt;&gt;(); for (java.util.List&lt;FileInfo&gt; fileInfoList : fileInfoListsMap.values()) { for (FileInfo fileInfo : fileInfoList) { UploadedFileData uploadedFileData = new UploadedFileData(); uploadedFileData.fileInfo = fileInfo; LOG.warning("uploadedFileData created:" + new Gson().toJson(uploadedFileData)); BlobKey blobKey = BlobstoreServiceFactory.getBlobstoreService().createGsBlobKey(fileInfo.getGsObjectName()); uploadedFileData.BlobKey = blobKey.getKeyString(); uploadedFileData.fileServeServletLink = HOST + "/serve?blob-key=" + blobKey.getKeyString(); // Use Images Java API to create serving URL // works only for images (PNG, JPEG, GIF, TIFF, BMP, ICO, WEBP) for (com.google.appengine.api.images.Image.Format type : com.google.appengine.api.images.Image.Format.values()) { LOG.warning("com.google.appengine.api.images.Image.Format type: " + type.toString()); LOG.warning("fileInfo.getContentType(): " + fileInfo.getContentType()); if (fileInfo.getContentType().toLowerCase().contains(type.toString().toLowerCase())) { uploadedFileData.servingUrlFromgsObjectName = ImagesServiceFactory.getImagesService().getServingUrl(ServingUrlOptions.Builder.withGoogleStorageFileName(fileInfo.getGsObjectName())); // should be the same as servingUrlFromGsBlobKey uploadedFileData.servingUrlFromGsBlobKey = ImagesServiceFactory.getImagesService().getServingUrl(ServingUrlOptions.Builder.withBlobKey(blobKey)); // should be the same as servingUrlFromgsObjectName } } uploadedFilesDataList.add(uploadedFileData); } } res.setContentType("application/json"); res.setCharacterEncoding("UTF-8"); PrintWriter pw = res.getWriter(); //get the stream to write the data Gson gson = new GsonBuilder().disableHtmlEscaping().create(); pw.println( gson.toJson(uploadedFilesDataList) ); LOG.warning("uploadedFilesDataMap" + new Gson().toJson(uploadedFilesDataList)); pw.close(); //closing the stream } // doPost End }</span></span></code> </pre><br>  and will issue in HTTP response JSON of the following type: <br><div class="spoiler">  <b class="spoiler_title">Json</b> <div class="spoiler_text"><pre> <code class="javascript hljs">[{ <span class="hljs-string"><span class="hljs-string">"fileInfo"</span></span>: { <span class="hljs-string"><span class="hljs-string">"contentType"</span></span>: <span class="hljs-string"><span class="hljs-string">"image/svg+xml"</span></span>, <span class="hljs-string"><span class="hljs-string">"creation"</span></span>: <span class="hljs-string"><span class="hljs-string">"Jan 18, 2016 7:16:18 PM"</span></span>, <span class="hljs-string"><span class="hljs-string">"filename"</span></span>: <span class="hljs-string"><span class="hljs-string">"Sun_symbol.svg"</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">188</span></span>, <span class="hljs-string"><span class="hljs-string">"md5Hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"YWZmM2UzMzk2ZDk2NTc0ZWM3NDI0YjYyMDMxZGIxYTM="</span></span>, <span class="hljs-string"><span class="hljs-string">"gsObjectName"</span></span>: <span class="hljs-string"><span class="hljs-string">"/gs/hello-habrahabr-api.appspot.com/L2FwcGhvc3RpbmdfcHJvZC9ibG9icy9BRW5CMlVxM3RWVU9nMWVxdmxfQ1dlSk5HaXIwNHpwamE3Y2FhVzlwRjF3dk4zQnFlU3JBMVkxaERGT2NRbXpLZ0pBOW0yTjZiaXhsZjFGWElmdFRNX1p2WXF4WTJnTlF1Zy42LWZnTzcybk1xNG03X1pw"</span></span> }, <span class="hljs-string"><span class="hljs-string">"BlobKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"AMIfv968eMcYEHQml68MAl4NVtOQGKjXUWadeyP7njbaVhHXq_1xDAnRQgHeHrOv4RPLm-KdmqEHP5nb1zNuCFFszRxOVUV4Z97B9slNi7SSGWZ1qKbYcbJi2nl5Z7JX9g1xN4RclYpmLPLfh5k2jAULi6p9g84JSyh5uP3RDkNnPuXkBjxSuBTOWCVxOmpRS-xsB1YedYAgF6cRYLq0hVpm_bOY3Cbl3Ai0W-_req9jxcuPWkoguhHiZ2SSBRF9NlvgG_hCf3vouYtYS2O9DBbioeOL_p1Ck8gfvhQiiK6XpXM4S7vAYqYZCQKJ_9T4tswy075-e6NlsdtXGj9zhSxCy_GfSSBrnvbwcQUDA7lN_IYIfm0QWs-XgzBl9izizUeE46jOI-1O"</span></span>, <span class="hljs-string"><span class="hljs-string">"fileServeServletLink"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://hello-habrahabr-api.appspot.com/serve?blob-key=AMIfv968eMcYEHQml68MAl4NVtOQGKjXUWadeyP7njbaVhHXq_1xDAnRQgHeHrOv4RPLm-KdmqEHP5nb1zNuCFFszRxOVUV4Z97B9slNi7SSGWZ1qKbYcbJi2nl5Z7JX9g1xN4RclYpmLPLfh5k2jAULi6p9g84JSyh5uP3RDkNnPuXkBjxSuBTOWCVxOmpRS-xsB1YedYAgF6cRYLq0hVpm_bOY3Cbl3Ai0W-_req9jxcuPWkoguhHiZ2SSBRF9NlvgG_hCf3vouYtYS2O9DBbioeOL_p1Ck8gfvhQiiK6XpXM4S7vAYqYZCQKJ_9T4tswy075-e6NlsdtXGj9zhSxCy_GfSSBrnvbwcQUDA7lN_IYIfm0QWs-XgzBl9izizUeE46jOI-1O"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"fileInfo"</span></span>: { <span class="hljs-string"><span class="hljs-string">"contentType"</span></span>: <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>, <span class="hljs-string"><span class="hljs-string">"creation"</span></span>: <span class="hljs-string"><span class="hljs-string">"Jan 18, 2016 7:16:18 PM"</span></span>, <span class="hljs-string"><span class="hljs-string">"filename"</span></span>: <span class="hljs-string"><span class="hljs-string">"world_map_04.jpg"</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">44680</span></span>, <span class="hljs-string"><span class="hljs-string">"md5Hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"MzQyMzliZGQ4NmYyNmZiNzc3ZjAyMzBhNmM4NDVmNWE="</span></span>, <span class="hljs-string"><span class="hljs-string">"gsObjectName"</span></span>: <span class="hljs-string"><span class="hljs-string">"/gs/hello-habrahabr-api.appspot.com/L2FwcGhvc3RpbmdfcHJvZC9ibG9icy9BRW5CMlVxM3RWVU9nMWVxdmxfQ1dlSk5HaXIwNHpwamE3Y2FhVzlwRjF3dk4zQnFlU3JBMVkxaERGT2NRbXpLZ0pBOW0yTjZiaXhsZjFGWElmdFRNX1p2WXF4WTJnTlF1Zy5Ld1pSRTQ2M3J3ZWYxa3Bm"</span></span> }, <span class="hljs-string"><span class="hljs-string">"BlobKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"AMIfv95nBw0rYnC39nCATxvyecFw0JEe64eTm-OhpsSsrR3Idv_rPbO2c6xTDx3q1xkulXfUyapqtEXdeQQur7FcppXa9rRcnlF7QnU8jur7a7AP3T5Ze_-bdD_F6F5mGP9Tteo7p7cN4UccqoYhnAyabAIsJBq3pZIwX2NlHhqcK_aelnu1tl3aszZU4cVmhLiZGE8hFvgDQyt-2oB4DurXUKTwGC56cZykCdYONO0EDETgkImiytbtk1iV_muyYZzfd7on3OS0LSmY8ls7QIcm1IMgl5jDPJANlsk_iWtnRJfEiYAC9pZ7DfhSPxTeYzko0b1TXrKuGjpG8cYMcxiA0Cmeya8y-7SCQuWQLlKCX8WFpIVOr26UguDaq8SFYplALbxgQUiB"</span></span>, <span class="hljs-string"><span class="hljs-string">"fileServeServletLink"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://hello-habrahabr-api.appspot.com/serve?blob-key=AMIfv95nBw0rYnC39nCATxvyecFw0JEe64eTm-OhpsSsrR3Idv_rPbO2c6xTDx3q1xkulXfUyapqtEXdeQQur7FcppXa9rRcnlF7QnU8jur7a7AP3T5Ze_-bdD_F6F5mGP9Tteo7p7cN4UccqoYhnAyabAIsJBq3pZIwX2NlHhqcK_aelnu1tl3aszZU4cVmhLiZGE8hFvgDQyt-2oB4DurXUKTwGC56cZykCdYONO0EDETgkImiytbtk1iV_muyYZzfd7on3OS0LSmY8ls7QIcm1IMgl5jDPJANlsk_iWtnRJfEiYAC9pZ7DfhSPxTeYzko0b1TXrKuGjpG8cYMcxiA0Cmeya8y-7SCQuWQLlKCX8WFpIVOr26UguDaq8SFYplALbxgQUiB"</span></span>, <span class="hljs-string"><span class="hljs-string">"servingUrlFromgsObjectName"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://lh3.googleusercontent.com/biRXwDZgclmYJa4hDUwOqBMK--VDNwj-9kZ27vzachWAGBunKVDelImXC9S5EZIhDm1T4xbyq8djFqNKkTzkSpcVkgbPO2ovxg"</span></span>, <span class="hljs-string"><span class="hljs-string">"servingUrlFromGsBlobKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://lh3.googleusercontent.com/biRXwDZgclmYJa4hDUwOqBMK--VDNwj-9kZ27vzachWAGBunKVDelImXC9S5EZIhDm1T4xbyq8djFqNKkTzkSpcVkgbPO2ovxg"</span></span> }]</code> -xsB1YedYAgF6cRYLq0hVpm_bOY3Cbl3Ai0W-_req9jxcuPWkoguhHiZ2SSBRF9NlvgG_hCf3vouYtYS2O9DBbioeOL_p1Ck8gfvhQiiK6XpXM4S7vAYqYZCQKJ_9T4tswy075-e6NlsdtXGj9zhSxCy_GfSSBrnvbwcQUDA7lN_IYIfm0QWs-XgzBl9izizUeE46jOI-1O", <code class="javascript hljs">[{ <span class="hljs-string"><span class="hljs-string">"fileInfo"</span></span>: { <span class="hljs-string"><span class="hljs-string">"contentType"</span></span>: <span class="hljs-string"><span class="hljs-string">"image/svg+xml"</span></span>, <span class="hljs-string"><span class="hljs-string">"creation"</span></span>: <span class="hljs-string"><span class="hljs-string">"Jan 18, 2016 7:16:18 PM"</span></span>, <span class="hljs-string"><span class="hljs-string">"filename"</span></span>: <span class="hljs-string"><span class="hljs-string">"Sun_symbol.svg"</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">188</span></span>, <span class="hljs-string"><span class="hljs-string">"md5Hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"YWZmM2UzMzk2ZDk2NTc0ZWM3NDI0YjYyMDMxZGIxYTM="</span></span>, <span class="hljs-string"><span class="hljs-string">"gsObjectName"</span></span>: <span class="hljs-string"><span class="hljs-string">"/gs/hello-habrahabr-api.appspot.com/L2FwcGhvc3RpbmdfcHJvZC9ibG9icy9BRW5CMlVxM3RWVU9nMWVxdmxfQ1dlSk5HaXIwNHpwamE3Y2FhVzlwRjF3dk4zQnFlU3JBMVkxaERGT2NRbXpLZ0pBOW0yTjZiaXhsZjFGWElmdFRNX1p2WXF4WTJnTlF1Zy42LWZnTzcybk1xNG03X1pw"</span></span> }, <span class="hljs-string"><span class="hljs-string">"BlobKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"AMIfv968eMcYEHQml68MAl4NVtOQGKjXUWadeyP7njbaVhHXq_1xDAnRQgHeHrOv4RPLm-KdmqEHP5nb1zNuCFFszRxOVUV4Z97B9slNi7SSGWZ1qKbYcbJi2nl5Z7JX9g1xN4RclYpmLPLfh5k2jAULi6p9g84JSyh5uP3RDkNnPuXkBjxSuBTOWCVxOmpRS-xsB1YedYAgF6cRYLq0hVpm_bOY3Cbl3Ai0W-_req9jxcuPWkoguhHiZ2SSBRF9NlvgG_hCf3vouYtYS2O9DBbioeOL_p1Ck8gfvhQiiK6XpXM4S7vAYqYZCQKJ_9T4tswy075-e6NlsdtXGj9zhSxCy_GfSSBrnvbwcQUDA7lN_IYIfm0QWs-XgzBl9izizUeE46jOI-1O"</span></span>, <span class="hljs-string"><span class="hljs-string">"fileServeServletLink"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://hello-habrahabr-api.appspot.com/serve?blob-key=AMIfv968eMcYEHQml68MAl4NVtOQGKjXUWadeyP7njbaVhHXq_1xDAnRQgHeHrOv4RPLm-KdmqEHP5nb1zNuCFFszRxOVUV4Z97B9slNi7SSGWZ1qKbYcbJi2nl5Z7JX9g1xN4RclYpmLPLfh5k2jAULi6p9g84JSyh5uP3RDkNnPuXkBjxSuBTOWCVxOmpRS-xsB1YedYAgF6cRYLq0hVpm_bOY3Cbl3Ai0W-_req9jxcuPWkoguhHiZ2SSBRF9NlvgG_hCf3vouYtYS2O9DBbioeOL_p1Ck8gfvhQiiK6XpXM4S7vAYqYZCQKJ_9T4tswy075-e6NlsdtXGj9zhSxCy_GfSSBrnvbwcQUDA7lN_IYIfm0QWs-XgzBl9izizUeE46jOI-1O"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"fileInfo"</span></span>: { <span class="hljs-string"><span class="hljs-string">"contentType"</span></span>: <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>, <span class="hljs-string"><span class="hljs-string">"creation"</span></span>: <span class="hljs-string"><span class="hljs-string">"Jan 18, 2016 7:16:18 PM"</span></span>, <span class="hljs-string"><span class="hljs-string">"filename"</span></span>: <span class="hljs-string"><span class="hljs-string">"world_map_04.jpg"</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">44680</span></span>, <span class="hljs-string"><span class="hljs-string">"md5Hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"MzQyMzliZGQ4NmYyNmZiNzc3ZjAyMzBhNmM4NDVmNWE="</span></span>, <span class="hljs-string"><span class="hljs-string">"gsObjectName"</span></span>: <span class="hljs-string"><span class="hljs-string">"/gs/hello-habrahabr-api.appspot.com/L2FwcGhvc3RpbmdfcHJvZC9ibG9icy9BRW5CMlVxM3RWVU9nMWVxdmxfQ1dlSk5HaXIwNHpwamE3Y2FhVzlwRjF3dk4zQnFlU3JBMVkxaERGT2NRbXpLZ0pBOW0yTjZiaXhsZjFGWElmdFRNX1p2WXF4WTJnTlF1Zy5Ld1pSRTQ2M3J3ZWYxa3Bm"</span></span> }, <span class="hljs-string"><span class="hljs-string">"BlobKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"AMIfv95nBw0rYnC39nCATxvyecFw0JEe64eTm-OhpsSsrR3Idv_rPbO2c6xTDx3q1xkulXfUyapqtEXdeQQur7FcppXa9rRcnlF7QnU8jur7a7AP3T5Ze_-bdD_F6F5mGP9Tteo7p7cN4UccqoYhnAyabAIsJBq3pZIwX2NlHhqcK_aelnu1tl3aszZU4cVmhLiZGE8hFvgDQyt-2oB4DurXUKTwGC56cZykCdYONO0EDETgkImiytbtk1iV_muyYZzfd7on3OS0LSmY8ls7QIcm1IMgl5jDPJANlsk_iWtnRJfEiYAC9pZ7DfhSPxTeYzko0b1TXrKuGjpG8cYMcxiA0Cmeya8y-7SCQuWQLlKCX8WFpIVOr26UguDaq8SFYplALbxgQUiB"</span></span>, <span class="hljs-string"><span class="hljs-string">"fileServeServletLink"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://hello-habrahabr-api.appspot.com/serve?blob-key=AMIfv95nBw0rYnC39nCATxvyecFw0JEe64eTm-OhpsSsrR3Idv_rPbO2c6xTDx3q1xkulXfUyapqtEXdeQQur7FcppXa9rRcnlF7QnU8jur7a7AP3T5Ze_-bdD_F6F5mGP9Tteo7p7cN4UccqoYhnAyabAIsJBq3pZIwX2NlHhqcK_aelnu1tl3aszZU4cVmhLiZGE8hFvgDQyt-2oB4DurXUKTwGC56cZykCdYONO0EDETgkImiytbtk1iV_muyYZzfd7on3OS0LSmY8ls7QIcm1IMgl5jDPJANlsk_iWtnRJfEiYAC9pZ7DfhSPxTeYzko0b1TXrKuGjpG8cYMcxiA0Cmeya8y-7SCQuWQLlKCX8WFpIVOr26UguDaq8SFYplALbxgQUiB"</span></span>, <span class="hljs-string"><span class="hljs-string">"servingUrlFromgsObjectName"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://lh3.googleusercontent.com/biRXwDZgclmYJa4hDUwOqBMK--VDNwj-9kZ27vzachWAGBunKVDelImXC9S5EZIhDm1T4xbyq8djFqNKkTzkSpcVkgbPO2ovxg"</span></span>, <span class="hljs-string"><span class="hljs-string">"servingUrlFromGsBlobKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://lh3.googleusercontent.com/biRXwDZgclmYJa4hDUwOqBMK--VDNwj-9kZ27vzachWAGBunKVDelImXC9S5EZIhDm1T4xbyq8djFqNKkTzkSpcVkgbPO2ovxg"</span></span> }]</code> -bdD_F6F5mGP9Tteo7p7cN4UccqoYhnAyabAIsJBq3pZIwX2NlHhqcK_aelnu1tl3aszZU4cVmhLiZGE8hFvgDQyt-2oB4DurXUKTwGC56cZykCdYONO0EDETgkImiytbtk1iV_muyYZzfd7on3OS0LSmY8ls7QIcm1IMgl5jDPJANlsk_iWtnRJfEiYAC9pZ7DfhSPxTeYzko0b1TXrKuGjpG8cYMcxiA0Cmeya8y-7SCQuWQLlKCX8WFpIVOr26UguDaq8SFYplALbxgQUiB", <code class="javascript hljs">[{ <span class="hljs-string"><span class="hljs-string">"fileInfo"</span></span>: { <span class="hljs-string"><span class="hljs-string">"contentType"</span></span>: <span class="hljs-string"><span class="hljs-string">"image/svg+xml"</span></span>, <span class="hljs-string"><span class="hljs-string">"creation"</span></span>: <span class="hljs-string"><span class="hljs-string">"Jan 18, 2016 7:16:18 PM"</span></span>, <span class="hljs-string"><span class="hljs-string">"filename"</span></span>: <span class="hljs-string"><span class="hljs-string">"Sun_symbol.svg"</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">188</span></span>, <span class="hljs-string"><span class="hljs-string">"md5Hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"YWZmM2UzMzk2ZDk2NTc0ZWM3NDI0YjYyMDMxZGIxYTM="</span></span>, <span class="hljs-string"><span class="hljs-string">"gsObjectName"</span></span>: <span class="hljs-string"><span class="hljs-string">"/gs/hello-habrahabr-api.appspot.com/L2FwcGhvc3RpbmdfcHJvZC9ibG9icy9BRW5CMlVxM3RWVU9nMWVxdmxfQ1dlSk5HaXIwNHpwamE3Y2FhVzlwRjF3dk4zQnFlU3JBMVkxaERGT2NRbXpLZ0pBOW0yTjZiaXhsZjFGWElmdFRNX1p2WXF4WTJnTlF1Zy42LWZnTzcybk1xNG03X1pw"</span></span> }, <span class="hljs-string"><span class="hljs-string">"BlobKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"AMIfv968eMcYEHQml68MAl4NVtOQGKjXUWadeyP7njbaVhHXq_1xDAnRQgHeHrOv4RPLm-KdmqEHP5nb1zNuCFFszRxOVUV4Z97B9slNi7SSGWZ1qKbYcbJi2nl5Z7JX9g1xN4RclYpmLPLfh5k2jAULi6p9g84JSyh5uP3RDkNnPuXkBjxSuBTOWCVxOmpRS-xsB1YedYAgF6cRYLq0hVpm_bOY3Cbl3Ai0W-_req9jxcuPWkoguhHiZ2SSBRF9NlvgG_hCf3vouYtYS2O9DBbioeOL_p1Ck8gfvhQiiK6XpXM4S7vAYqYZCQKJ_9T4tswy075-e6NlsdtXGj9zhSxCy_GfSSBrnvbwcQUDA7lN_IYIfm0QWs-XgzBl9izizUeE46jOI-1O"</span></span>, <span class="hljs-string"><span class="hljs-string">"fileServeServletLink"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://hello-habrahabr-api.appspot.com/serve?blob-key=AMIfv968eMcYEHQml68MAl4NVtOQGKjXUWadeyP7njbaVhHXq_1xDAnRQgHeHrOv4RPLm-KdmqEHP5nb1zNuCFFszRxOVUV4Z97B9slNi7SSGWZ1qKbYcbJi2nl5Z7JX9g1xN4RclYpmLPLfh5k2jAULi6p9g84JSyh5uP3RDkNnPuXkBjxSuBTOWCVxOmpRS-xsB1YedYAgF6cRYLq0hVpm_bOY3Cbl3Ai0W-_req9jxcuPWkoguhHiZ2SSBRF9NlvgG_hCf3vouYtYS2O9DBbioeOL_p1Ck8gfvhQiiK6XpXM4S7vAYqYZCQKJ_9T4tswy075-e6NlsdtXGj9zhSxCy_GfSSBrnvbwcQUDA7lN_IYIfm0QWs-XgzBl9izizUeE46jOI-1O"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"fileInfo"</span></span>: { <span class="hljs-string"><span class="hljs-string">"contentType"</span></span>: <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>, <span class="hljs-string"><span class="hljs-string">"creation"</span></span>: <span class="hljs-string"><span class="hljs-string">"Jan 18, 2016 7:16:18 PM"</span></span>, <span class="hljs-string"><span class="hljs-string">"filename"</span></span>: <span class="hljs-string"><span class="hljs-string">"world_map_04.jpg"</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">44680</span></span>, <span class="hljs-string"><span class="hljs-string">"md5Hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"MzQyMzliZGQ4NmYyNmZiNzc3ZjAyMzBhNmM4NDVmNWE="</span></span>, <span class="hljs-string"><span class="hljs-string">"gsObjectName"</span></span>: <span class="hljs-string"><span class="hljs-string">"/gs/hello-habrahabr-api.appspot.com/L2FwcGhvc3RpbmdfcHJvZC9ibG9icy9BRW5CMlVxM3RWVU9nMWVxdmxfQ1dlSk5HaXIwNHpwamE3Y2FhVzlwRjF3dk4zQnFlU3JBMVkxaERGT2NRbXpLZ0pBOW0yTjZiaXhsZjFGWElmdFRNX1p2WXF4WTJnTlF1Zy5Ld1pSRTQ2M3J3ZWYxa3Bm"</span></span> }, <span class="hljs-string"><span class="hljs-string">"BlobKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"AMIfv95nBw0rYnC39nCATxvyecFw0JEe64eTm-OhpsSsrR3Idv_rPbO2c6xTDx3q1xkulXfUyapqtEXdeQQur7FcppXa9rRcnlF7QnU8jur7a7AP3T5Ze_-bdD_F6F5mGP9Tteo7p7cN4UccqoYhnAyabAIsJBq3pZIwX2NlHhqcK_aelnu1tl3aszZU4cVmhLiZGE8hFvgDQyt-2oB4DurXUKTwGC56cZykCdYONO0EDETgkImiytbtk1iV_muyYZzfd7on3OS0LSmY8ls7QIcm1IMgl5jDPJANlsk_iWtnRJfEiYAC9pZ7DfhSPxTeYzko0b1TXrKuGjpG8cYMcxiA0Cmeya8y-7SCQuWQLlKCX8WFpIVOr26UguDaq8SFYplALbxgQUiB"</span></span>, <span class="hljs-string"><span class="hljs-string">"fileServeServletLink"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://hello-habrahabr-api.appspot.com/serve?blob-key=AMIfv95nBw0rYnC39nCATxvyecFw0JEe64eTm-OhpsSsrR3Idv_rPbO2c6xTDx3q1xkulXfUyapqtEXdeQQur7FcppXa9rRcnlF7QnU8jur7a7AP3T5Ze_-bdD_F6F5mGP9Tteo7p7cN4UccqoYhnAyabAIsJBq3pZIwX2NlHhqcK_aelnu1tl3aszZU4cVmhLiZGE8hFvgDQyt-2oB4DurXUKTwGC56cZykCdYONO0EDETgkImiytbtk1iV_muyYZzfd7on3OS0LSmY8ls7QIcm1IMgl5jDPJANlsk_iWtnRJfEiYAC9pZ7DfhSPxTeYzko0b1TXrKuGjpG8cYMcxiA0Cmeya8y-7SCQuWQLlKCX8WFpIVOr26UguDaq8SFYplALbxgQUiB"</span></span>, <span class="hljs-string"><span class="hljs-string">"servingUrlFromgsObjectName"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://lh3.googleusercontent.com/biRXwDZgclmYJa4hDUwOqBMK--VDNwj-9kZ27vzachWAGBunKVDelImXC9S5EZIhDm1T4xbyq8djFqNKkTzkSpcVkgbPO2ovxg"</span></span>, <span class="hljs-string"><span class="hljs-string">"servingUrlFromGsBlobKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://lh3.googleusercontent.com/biRXwDZgclmYJa4hDUwOqBMK--VDNwj-9kZ27vzachWAGBunKVDelImXC9S5EZIhDm1T4xbyq8djFqNKkTzkSpcVkgbPO2ovxg"</span></span> }]</code> </pre><br></div></div><br>  That is, the downloaded file we can then give the user using any type of link <code>http://lh3.googleusercontent.com/biRXwDZgclmYJa4hDUwOqBMK--VDNwj-9kZ27vzachWAGBunKVDelImXC9S5EZIhDm1T4xbyq8djFqNKkTzkSpcVkgbPO2ovxg <br></code> <code>http://lh3.googleusercontent.com/biRXwDZgclmYJa4hDUwOqBMK--VDNwj-9kZ27vzachWAGBunKVDelImXC9S5EZIhDm1T4xbyq8djFqNKkTzkSpcVkgbPO2ovxg <br></code>  - if it is an image file, or (in any case) the servlet to which reference will appear as <code>https://hello-habrahabr-api.appspot.com/serve?blob-key=AMIfv95nBw0rYnC39nCATxvyecFw0JEe64eTm-OhpsSsrR3Idv_rPbO2c6xTDx3q1xkulXfUyapqtEXdeQQur7FcppXa9rRcnlF7QnU8jur7a7AP3T5Ze_-bdD_F6F5mGP9Tteo7p7cN4UccqoYhnAyabAIsJBq3pZIwX2NlHhqcK_aelnu1tl3aszZU4cVmhLiZGE8hFvgDQyt-2oB4DurXUKTwGC56cZykCdYONO0EDETgkImiytbtk1iV_muyYZzfd7on3OS0LSmY8ls7QIcm1IMgl5jDPJANlsk_iWtnRJfEiYAC9pZ7DfhSPxTeYzko0b1TXrKuGjpG8cYMcxiA0Cmeya8y-7SCQuWQLlKCX8WFpIVOr26UguDaq8SFYplALbxgQUiB <br></code> <code>https://hello-habrahabr-api.appspot.com/serve?blob-key=AMIfv95nBw0rYnC39nCATxvyecFw0JEe64eTm-OhpsSsrR3Idv_rPbO2c6xTDx3q1xkulXfUyapqtEXdeQQur7FcppXa9rRcnlF7QnU8jur7a7AP3T5Ze_-bdD_F6F5mGP9Tteo7p7cN4UccqoYhnAyabAIsJBq3pZIwX2NlHhqcK_aelnu1tl3aszZU4cVmhLiZGE8hFvgDQyt-2oB4DurXUKTwGC56cZykCdYONO0EDETgkImiytbtk1iV_muyYZzfd7on3OS0LSmY8ls7QIcm1IMgl5jDPJANlsk_iWtnRJfEiYAC9pZ7DfhSPxTeYzko0b1TXrKuGjpG8cYMcxiA0Cmeya8y-7SCQuWQLlKCX8WFpIVOr26UguDaq8SFYplALbxgQUiB <br></code>  where to <code>serve <br></code> <code>serve <br></code>  - servlet path, <code>blob-key <br></code> <code>blob-key <br></code>  - the parameter with which we can find the required file, in the most obvious variant its value will be BlobKey. <br><br>  It should be noted that BlobKey does not give direct access to the file bypassing the servlet, and the servlet may or may not transfer the file depending on the criteria we set, including  we can use the OAuth2.0 authentication provided by Google App Engine, use additional parameters in the request, etc. <br><br>  The servlet rendering file may look like this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.appspot.hello_habrahabr_api; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.BlobKey; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.BlobstoreService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.blobstore.BlobstoreServiceFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.users.User; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.users.UserService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.google.appengine.api.users.UserServiceFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServlet; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletRequest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletResponse; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.logging.Logger; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileServeServlet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpServlet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger LOG = Logger.getLogger(CSUploadHandlerServlet.class.getName()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BlobstoreService blobstoreService = BlobstoreServiceFactory.getBlobstoreService(); <span class="hljs-comment"><span class="hljs-comment">// works both for Bloobstore and Cloud Storage public void doGet( HttpServletRequest req, HttpServletResponse res ) throws IOException { // --- check user: UserService userService = UserServiceFactory.getUserService(); User user = userService.getCurrentUser(); if (user == null) { LOG.warning("[LOGGER] User not logged in"); } else { LOG.warning("[LOGGER] user: " + user.getEmail()); } // get parameter from url constructed with: // "/serve?blob-key=" + blobKey.getKeyString() BlobKey blobKey = new BlobKey(req.getParameter("blob-key")); blobstoreService.serve(blobKey, res); } }</span></span></code> </pre><br><h4>  Images Java API </h4><br>  As already shown above, using the Images Java API, we can <br><pre> <code class="java hljs">ImagesServiceFactory.getImagesService().getServingUrl( ServingUrlOptions.Builder.withGoogleStorageFileName(fileInfo.getGsObjectName()) );</code> </pre><br>  or by <br><pre> <code class="java hljs">ImagesServiceFactory.getImagesService().getServingUrl( ServingUrlOptions.Builder.withBlobKey(blobKey) );</code> </pre><br>  get the URL providing the image file.  This method of downloading a file is faster than using a servlet, but accordingly we have a link to a ‚Äústatic‚Äù file and cannot process the request as in the case of using a servlet. <br><br>  But such a created link to a file can be, just as it was created, deleted using the <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/images/ImagesService">.deleteServingUrl (BlobKey blobKey)</a> method <a href="https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/images/ImagesService">while the</a> file itself is not deleted from the repository, and a new link can be created for it.  Those.  we can make such links ‚Äúdisposable‚Äù by creating and deleting them if necessary. <br><br>  In addition to the links to images created using getServingUr (), you can add image-changing parameters in the format <code>http://[image-url]=s200-fh-p-b10-c0xFFFF0000 <br></code> <code>http://[image-url]=s200-fh-p-b10-c0xFFFF0000 <br></code>  : <br><br>  s640 - generates an image of 640 pixels on the largest face <br>  s0 - the original image size (by default, the output image is reduced!) <br>  w100 - generates an image width of 100 pixels <br>  h100 - generates an image height of 100 pixels <br>  c - cuts the image to the specified size (s200, for example) <br>  p - ‚Äúsmart‚Äù image cropping, trying to cut to the face (not very successful) <br>  pp - an alternative method to do the same as in the previous paragraph (it works the same way) <br>  cc - generates a round image <br>  fv - flips vertically <br>  fh - flips horizontally <br>  r {90} - rotates by the specified number of degrees clockwise <br>  rj - gives the image in JPG format <br>  rp - gives an image in PNG format <br>  rw - produces an image in WebP format <br>  rg - gives an image in GIF format <br>  b10 - adds a frame of the specified width (in this case 10px) <br>  c0xffff0000 - sets the frame color (in this case, red) <br>  d - adds the header to start the download in the browser <br>  h - displays the HTML page containing the image <br><br>  For example, from the source image: <br><img src="https://habrastorage.org/getpro/habr/post_images/1f2/8bb/cbb/1f28bbcbbdc1f2dd7c364b4cae720cc8.jpg" alt="image"><br>  with parameters: <code>=w100-h100-cc <br></code> <code>=w100-h100-cc <br></code>  - You can generate a round avatar; <br><img src="https://habrastorage.org/getpro/habr/post_images/ed5/25e/28b/ed525e28b76be6b156ac53555dafbcc9.jpg" alt="image"><br>  with parameters: <code>=s200-b3-c0xffff0000 <br></code> <code>=s200-b3-c0xffff0000 <br></code>  - thumbnail the size of the maximum face in 200px with a red frame width of 3px: <br><img src="https://habrastorage.org/getpro/habr/post_images/db7/dfa/6eb/db7dfa6ebae86c34546525ef1f103153.jpg" alt="image"><br>  Unlike using CSS, in this case, the image will be downloaded from the server already reduced to the desired size. <br><br>  For more options, see <a href="http://stackoverflow.com/questions/25148567/list-of-all-the-app-engine-images-service-get-serving-url-uri-options">stackoverflow.com/questions/25148567/list-of-all-the-app-engine-images-service-get-serving-url-uri-options</a> <br><br><h4>  Access to the repository from the command line ( <a href="https://cloud.google.com/storage/docs/gsutil">gsutil</a> utility) </h4><br>  gsutil is written in Python (requires Python 2.6.x or 2.7.x) and works from the command line on Linux / Unix, Mac OS, and Windows (XP and above). <br><br>  Installation Instructions: <a href="https://cloud.google.com/storage/docs/gsutil_install">cloud.google.com/storage/docs/gsutil_install</a> <br><br>  After installation, run: <br><br><pre> <code class="bash hljs">gcloud auth login</code> </pre><br>  and log in (as described on <a href="http://habrahabr.ru/post/268863/">habrahabr.ru/post/268863</a> ) <br><br>  gsutil represents access to storage containers using commands similar to the usual Linux / Unix console commands, files in the storage are indicated by the ‚Äúpath‚Äù of the form gs: // {container name}, for example gs: //hello-habrahabr-api.appspot.com <br><br>  So, to display information about the files in the container, enter the command <br><pre> <code class="bash hljs">gsutil ls gs://hello-habrahabr-api.appspot.com</code> </pre><br>  for all files in all containers available to the current user (Google account): <br><pre> <code class="bash hljs">gsutil ls gs://*</code> </pre><br>  for output by the ls command, specify the <code>-l</code> parameter for more detailed information; for complete information about the files, specify the <code>-L</code> parameter: <br><br><img src="https://habrastorage.org/files/4ab/5e7/5c2/4ab5e75c208e428a88ca6cbafb35366d.png"><br><br>  Accordingly, you can use the commands <code>cp</code> , <code>mv</code> , <code>rm</code> as the file addresses in the container using <code>gs://{ } /{   } <br></code> <code>gs://{ } /{   } <br></code>  and normal paths for files on the local OS, wildcard characters are also supported ( <code>gs://* <br></code> <code>gs://* <br></code>  ) Learn more about gsutil commands: <a href="https://cloud.google.com/storage/docs/gsutil">cloud.google.com/storage/docs/gsutil</a> <br>  Thus, using the gsutil capabilities, you can organize and automate work with files in the storage. <br><br><h4>  Links </h4><br><ul><li>  <a href="https://cloud.google.com/storage/docs/overview">What is Google Cloud Storage?</a> </li><li>  <a href="https://cloud.google.com/appengine/docs/java/googlecloudstorageclient/">Java Client for Google Cloud Storage</a> </li><li>  <a href="https://cloud.google.com/appengine/docs/java/images/">Images Java API Overview</a> </li><li>  <a href="https://cloud.google.com/appengine/docs/java/blobstore/">Blobstore Java API Overview</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/275211/">https://habr.com/ru/post/275211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275197/index.html">How important is the API or compare Yandex.XML and the real issue</a></li>
<li><a href="../275199/index.html">Digest of the best webinars for programmers from GeekBrains</a></li>
<li><a href="../275203/index.html">Spring Boot - a problem with the security of executable jar files launched as an init.d service</a></li>
<li><a href="../275205/index.html">Promotion extended: instant dedicated servers in the Netherlands from $ 39 only until the end of the month</a></li>
<li><a href="../275207/index.html">VR and AR Digest: December</a></li>
<li><a href="../275215/index.html">How to start working with MIPSfpga</a></li>
<li><a href="../275217/index.html">A few stories about good customer support or how to create the best service in the world.</a></li>
<li><a href="../275219/index.html">How to make a contribution to the Open Source project: simple tips</a></li>
<li><a href="../275223/index.html">BindableConverter for WPF</a></li>
<li><a href="../275225/index.html">Application Configuration with github</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>