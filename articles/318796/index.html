<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sending a GPS track via SMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You have a distributed and fault-tolerant backend, a cool mobile application is written for all possible platforms, but suddenly it turns out that you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sending a GPS track via SMS</h1><div class="post__text post__text-html js-mediator-article">  You have a distributed and fault-tolerant backend, a cool mobile application is written for all possible platforms, but suddenly it turns out that your users are so far from civilization that the only way to communicate with them is SMS?  Then it will be interesting to you to read the story of how to transfer maximum information using this archaic data transmission channel, using the example of a GPS track. <br><a name="habracut"></a><br><h2>  A little bit about the GPS track </h2><br>  In our particular case, a track meant a sequence of <i>points</i> defined by the <i>coordinates</i> in which the user was located, with reference to <i>time</i> and possibly some <i>flags</i> (for example, SOS, the beginning of the track). <br><br>  <i>Time</i> could be determined in this way: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> time= System.currentTimeMillis();</code> </pre> <br>  <i>Coordinates</i> are longitude and latitude.  The <a href="">Location</a> object in Android uses double for longitude and latitude. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, each track point should have contained 64 + 2 * 64 + 2 = 194 bits of information. <br><br><h2>  About SMS </h2><br><div class="spoiler">  <b class="spoiler_title">Bike about SMS</b> <div class="spoiler_text">  In the zero years in student years, various winter visiting schools and youth conferences were held at recreation centers outside the city.  At that time, reliable cellular coverage outside the city was rare, and I had to somehow tell my parents that I was alive and well, I did not freeze, and I did not forget my hat.  It was then that the understanding came that SMS'ki is a necessary and useful thing.  It was not possible to send an SMS from the ground, but at some height it was possible for the second or third time.  The most reliable thing was to tie the phone to a long stick, type and send a message, lift the stick up, hold it vertically for some time, then check whether the message was sent, if necessary, repeat the procedure.  Some particularly desperate phones were thrown up in the hope of sending SMS in this way ‚Äî messages were sent, and only then they had to look for their Nokia in a snowdrift.  In my memory, no phone is lost, not broken - Nokia is the same. <br></div></div><br>  Who used (uses) SMS remembers that Cyrillic can dial 70 characters in one SMS, and translit - as many as 160!  That's where injustice is, and you say sanctions. <br><br>  About how SMS'ka is arranged can be read in <a href="https://www.ietf.org/rfc/rfc5724.txt">RFC 5724</a> : <br><blockquote>  GSM SMS messages are alphanumeric paging messages <br>  from SMS clients.  SMS messages have a maximum length of 160 <br>  characters (7-bit characters from the GSM character set [SMS-CHAR]), <br>  or 140 octets.  Other character sets (such as UCS-2 16-bit <br>  characters, resulting in 70-character messages) MAY also be supported <br>  [SMS-CHAR] but are defined as being optional by the SMS <br>  specification.  Consequently, applications handling SMS messages as <br>  part of a chain of character-processing applications MUST make sure <br>  that character sets are correctly mapped to and from the character <br>  set used for SMS messages. </blockquote><br>  Thus, as a payload, you can use 140 bytes, which are transformed into those same 160 characters for 7-bit encoding (Latin, numbers, and <a href="https://en.wikipedia.org/wiki/GSM_03.38">some more characters</a> ). <br><br>  It is allowed to send a much larger amount of text, but then the original message will be divided into parts.  Each part will be less than 6 bytes, since information about the segments is stored in a special <a href="https://en.wikipedia.org/wiki/Concatenated_SMS">UDH</a> header at the beginning of each piece.  In 7-bit characters, 153 remains. <br><br>  The theory supports splitting up to 255 segments, but in practice, it saw guaranteed support for only 6 segments. <br><br><h2>  Binary format: Title </h2><br>  To put the track's binary data into SMS, a simple and compatible with 7-bit Base64 coding had to be used, which at the output for every three bytes of the source data gives four 7-bit characters.  Total, there are not so many payloads left - only 160 * 3/4 ‚Äã‚Äã= 120 bytes. <br><br>  A great future was predicted to the application, so the developed format should not be limited to one type of message or one version of the protocol, therefore the short type was assigned to messageType. <br><br>  Since the data had to come via SMS, where there are no certificates, passwords and authentication that are familiar to the classic web-a, it was necessary to learn how to bind the received message to the user of the system: a random authenticationToken of a long type was entered. <br><br>  For integrity control, a short checksum field has been added. <br><br>  The total size of the header has become equal to 2 + 8 + 2 = 12 bytes. <br><br>  Exclude from the total amount of useful data header size: 120 - 12 = 108 bytes or <br>  864 bits. <br><br><h2>  Naive implementation </h2><br>  One point of the track is 194 bits.  One SMS'ku includes 864 bits of track data.  Ahem, fit only 864/194 = 4 points. <br><br>  And what if you break the message into 6 segments?  1 segment = 153 7-bit characters;  6 segments = 153 * 6 = 818 7-bit characters.  The payload will be 818 * 3/4 ‚Äã‚Äã= 613 bytes.  Thus, 613 - 12 = 601 bytes or 4808 bits will remain under the track data.  So, you will be able to shove 4808/194 = 24 points into a fat SMS, and 19 more bytes will remain. <br><br>  In addition to the obvious minus - very few points can be placed in the message, the inconvenient logic of working with a point that does not occupy a multiple of a byte gets out. <br><br><h2>  Optimization </h2><br><h3>  Time </h3><br><ol><li>  In fact, we don't need accuracy in milliseconds. </li><li>  The application will not send data for the past decades </li><li>  The application is unlikely to exist unchanged for 50 years </li></ol><br>  Let we leave accuracy to 4 seconds. <br><br>  Let's enter our <i>era</i> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> ERA = <span class="hljs-number"><span class="hljs-number">1388534400000L</span></span>;</code> </pre> <br>  Regarding the standard Unix (1 January 1970 UTC).  The date above is January 1, 2014 UTC. <br><br>  Given the last assumption, we only need to store 4 bytes for the time: <br><br>  (60/4) * 60 * 24 * 365.25 * 50 = 394 470 000 &lt;2 ^ 29.  3 more bits in stock (on flags). <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> time= System.currentTimeMillis(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> newTime = (time - ERA) / (<span class="hljs-number"><span class="hljs-number">1000</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>);</code> </pre><br><h3>  Geography </h3><br>  The earth is very close in shape to the ball oblate from the side of the poles, thus the length of the equator (40,075,696 meters) is slightly longer than the length of twice the meridian (40,008,552 meters). <br><br>  The coordinates in the Location are specified in degrees (¬± depending on the C / B and C / S). <br><br>  In total, we have 360 ‚Äã‚Äãdegrees around, or 21,600 minutes or 1,296,000 seconds.  Thus, in one meter of the equator or meridian of at least 0.032 seconds (1,296,000 / 40,075,696 = 0.0323388 ...).  At latitude, say, 60 degrees in one meter of parallel will be approximately 2 times more seconds (about 0.064 seconds).  What does it mean?  A 1 meter positioning error at the equator and at the 60th parallel differs in error in degrees Location.getLongitude () twice.  In this case, the farther from the equator, the error in degrees with a fixed in meters above.  And vice versa: when moving away from the equator with a fixed error in degrees - the error decreases in meters, that is, near the equator, rounding to 32/1000 seconds will give the greatest positioning error of no more than one meter. <br><br>  Suppose we are satisfied with the positioning accuracy of 5 meters (in fact, the accuracy of the values ‚Äã‚Äãobtained from the GPS module turns out to be several times worse).  Let's take the border lower: let the latitude and longitude positioning accuracy of at least 3 meters (5&gt; 3 * sqrt (2)). <br><br>  Now, we can drop coordinates in double and bring them to a non-negative integer value with an accuracy of 96/1000 seconds: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> newLatitude = (latitude + <span class="hljs-number"><span class="hljs-number">90</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">96</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> newLongitude = (longitude + <span class="hljs-number"><span class="hljs-number">180</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">96</span></span>;</code> </pre><br>  Obviously, the new values ‚Äã‚Äãwill not exceed 360 * 60 * 60 * 1000/96 = 13,500,000 &lt;2 ^ 24, which fits into 3 bytes, and the bit is still ‚Äúin reserve‚Äù from the latitude conversion, since the maximum possible value will be 2 times less and 23 bits will be enough to store the value. <br><br><h2>  Result </h2><br>  The size of the track point was reduced to 4 + 3 + 3 = 10 bytes and a few more bits remained unused.  The usual SMS began to enter 864/80 = 10 points.  Fat out of 6 segments: 4808/80 = 60 points. <br><br><h3>  More optimizations </h3><br>  Before that, we didn‚Äôt use the fact that the points belong to the same track; <br><br>  Thus, the absolute coordinates and time were recorded only for the first point, and all subsequent points kept an offset relative to the previous one both in coordinates and in time.  Such optimization allowed reducing the size of subsequent points by another 2 bytes to 8 bytes, increasing, as a result, the total number of points in one SMS'k to 13, and in fat, to 84. <br><br><h3>  Format description </h3><br>  HEADER (96) + BODY (variable): <br>  ||  Message Type (16) |  Authentication Token (64) |  Checksum (16) ||  Data (variable) || <br><br>  FIRST TRACKPOINT INFO (80): <br>  ||  Start (1) |  SOS (1) |  Reserved (1) |  DateTime (29) |  Reserved (1) |  Latitude (23) |  Longitude (24) || <br><br>  NTH TRACKPOINT INFO (64): <br>  ||  Offset (16) |  Start (1) |  SOS (1) |  North (1) |  Latitude (21) |  Reserved (1) |  Reserved (1) |  East (1) |  Longitude (21) || <br><br>  The brackets indicate the length of the fields in bits. <br><br><h3>  Example </h3><br>  HEX-record of a binary message (30 bytes), consisting of a header (12 bytes) and two dots (10 and 8 bytes, respectively): <br><br> <code>00 01 00 11 AA BB CC DD EE FF 00 90 80 00 24 09 54 04 9D 89 87 A0 09 B1 40 00 00 20 92 7C <br></code> <br>  Decryption: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">short</span></span> messageType = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 00 01 long authenticationToken = 4972798176784127L; // 00 11 AA BB CC DD EE FF short checksum = 144; // 00 90 boolean start = true; // [1]000 0000 00 24 09 boolean sos = false; // 1[0]000 0000 00 24 09 int dateTime = 9225; // 100[0 0000 00 24 09] // 1  2014 10:15:00 UTC int latitude = 5506205; // 0[101 0100 04 9D] // 56.83213333¬∞ . . ( : 56.832139¬∞ . .) int longitude = 9013152; // 89 87 A0 // 60.35072¬∞ . . ( : 60.350722¬∞ . .) int offset = 2481 // 09 B1 // 1  2014 12:45:24 UTC boolean start2 = false; // [0]100 0000 00 00 boolean sos2 = true; // 0[1]00 0000 00 00 boolean north2 = false; // 01[0]0 0000 00 00 int latitude2 = 0; // 010[0 0000 00 00] // 56.83213333¬∞ . . boolean east2 = true; // 00[1]0 0000 92 7C int longitude2 = 37500; // 001[0 0000 92 7C] // 61.35072¬∞ . .</span></span></code> </pre> <br>  <b>PS Happy</b> New Year!  I hope the post will be someone useful / interesting. </div><p>Source: <a href="https://habr.com/ru/post/318796/">https://habr.com/ru/post/318796/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318784/index.html">Can your code reason?</a></li>
<li><a href="../318786/index.html">Competitiveness: Cooperativeness</a></li>
<li><a href="../318788/index.html">42% of people who do not buy your product</a></li>
<li><a href="../318790/index.html">Creating a blog engine with Phoenix and Elixir / Part 7. Add comments / New Year's announcement in the conclusion</a></li>
<li><a href="../318792/index.html">FBI, CIA and Obama against PHP script</a></li>
<li><a href="../318798/index.html">We want to give you a New Year's gift, but we need your help.</a></li>
<li><a href="../318800/index.html">Creating music interfaces</a></li>
<li><a href="../318802/index.html">20 harmful tips on developing games on Unity</a></li>
<li><a href="../318804/index.html">How IT professionals work. Dmitry Kravchuk - CTO and co-founder of LinguaTrip</a></li>
<li><a href="../318806/index.html">How not to distribute prohibited content, but still feel the effect of 139-FZ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>