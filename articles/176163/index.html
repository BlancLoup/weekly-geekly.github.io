<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Save image using libpng</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Having fun at leisure with OpenGL, I decided to learn how to take screenshots by means of the program, not the system. Pretty quickly google the glRea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Save image using libpng</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/b74/a26/1c0/b74a261c0cbe4b32030dadf06515123f.png" align="left"><br>  Having fun at leisure with OpenGL, I decided to learn how to take screenshots by means of the program, not the system.  Pretty quickly google the glReadPixels function, but with the saving of the picture, the problem came out.  I remembered the old days, when I saved my code completely in bmp, I found the save function in tga, I realized that all these options are smelling of bicycling and decided to use a widespread library.  The choice fell on libpng. <br>  Then came the rake. <br><br>  It turned out that there is no description of the library in Russian (that‚Äôs why I‚Äôm writing this post now), and the English documentation is not written in the most convenient way and does not contain even the simplest full-fledged example of use. <br>  Below I will try to explain how to save the image by means of libpng in the simplest case. <br><a name="habracut"></a><br><br>  First you need to connect the header file 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;png.h&gt;</span></span></span></span></code> </pre> <br><br>  In the function / method in which we will save the image, open the file in which we will save and create the png structure. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Renderer::screenshoot(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; name) { FILE *fp = fopen(name.c_str(), <span class="hljs-string"><span class="hljs-string">"wb"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fp) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } png_structp png_ptr = png_create_write_struct(PNG_LIBPNG_VER_STRING, <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>, <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>, <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!png_ptr) { <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> close_file; }</code> </pre><br><br>  Now you need to create a png information structure, call setjmp, in case of errors, and initialize the output to a file. <br><br><pre> <code class="cpp hljs"> png_infop png_info; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(png_info = png_create_info_struct(png_ptr))) { <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> destroy_write; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setjmp(png_jmpbuf(png_ptr))) { <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> destroy_write; } png_init_io(png_ptr, fp);</code> </pre><br><br>  Next you need to set the image parameters (size, number of colors, number of bits per color channel, interlaced and compressed. As well as form an image and an array of pointers to individual lines of the image. <br><br>  Here the rake begins. <br><br>  Rake number 1: the function glReadPixels gives the image, the lines in which go from the bottom up, although usually working with graphics, we mean the reverse order. <br>  Rake number 2: if you specify glReadPixels functions that we want to get RGBA colors, then in fact we get them in the order of ARGB.  It's a shame, but it took me an hour to figure it out, during which I did not understand why my colors were not displayed correctly in the screenshot. <br><br>  Let's declare an array of data, in which there will be data for libpng, and an array of argb_data, in which there will be data from OpenGL, well, let's not forget about an array of pointers rows. <br><br><pre> <code class="cpp hljs"> png_set_IHDR(png_ptr, png_info, width, height, <span class="hljs-number"><span class="hljs-number">0</span></span>, PNG_COLOR_TYPE_RGB, PNG_INTERLACE_NONE, PNG_COMPRESSION_TYPE_DEFAULT, PNG_FILTER_TYPE_DEFAULT); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> data[width*height*<span class="hljs-number"><span class="hljs-number">3</span></span>], argb_data[width*height*<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *rows[height]; render(); glReadPixels(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height, GL_RGBA, GL_UNSIGNED_INT_8_8_8_8, argb_data); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; height; ++i) { rows[height - i - <span class="hljs-number"><span class="hljs-number">1</span></span>] = data + (i*width*<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; width; ++j) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i1 = (i*width+j)*<span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i2 = (i*width+j)*<span class="hljs-number"><span class="hljs-number">4</span></span>; data[i1++] = argb_data[++i2]; data[i1++] = argb_data[++i2]; data[i1++] = argb_data[++i2]; } }</code> </pre><br><br>  Now it's up to you to save the image, complete the input and process errors. <br><br><pre> <code class="cpp hljs"> png_set_rows(png_ptr, png_info, rows); png_write_png(png_ptr, png_info, PNG_TRANSFORM_IDENTITY, <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); png_write_end(png_ptr, png_info); destroy_write: png_destroy_write_struct(&amp;png_str, <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); close_file: fclose(fp); }</code> </pre><br><br>  In such a relatively simple way, you can save the image in png.  However, do not think that this is all that this library is capable of.  You can follow the process of saving, apply filters, use interlacing, compression ... But to understand this you should read the original <a href="http://www.libpng.org/pub/png/libpng-1.2.5-manual.html">documentation</a> . <br><br>  <b>UPD.</b>  Thanks to <a href="http://habrahabr.ru/users/mrgobus/" class="user_link">MrGobus</a> for the comment about glReadPixels and the order of the rows. </div><p>Source: <a href="https://habr.com/ru/post/176163/">https://habr.com/ru/post/176163/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176147/index.html">Simultaneous work of php 5.2 and php 5.3 on Ubuntu 12.04</a></li>
<li><a href="../176153/index.html">IT park through the eyes of the resident</a></li>
<li><a href="../176155/index.html">Who to send PMBok to study</a></li>
<li><a href="../176157/index.html">Briefly about hydrodynamics: energy conservation</a></li>
<li><a href="../176159/index.html">Nanocellulose: supermaterial that can be grown</a></li>
<li><a href="../176165/index.html">Active Directory and backups in the cloud, site tracing and other Windows Azure updates</a></li>
<li><a href="../176167/index.html">Highscreen Yummy Duo - the most budget smartphone with two SIM-cards and a full set of communications</a></li>
<li><a href="../176171/index.html">Where do ideas come from?</a></li>
<li><a href="../176175/index.html">RPG for teaching kids Java programming</a></li>
<li><a href="../176181/index.html">Survey: when registering on the website / mobile application, what is more convenient for you to enter as a login?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>