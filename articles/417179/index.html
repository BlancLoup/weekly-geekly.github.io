<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up a home environment for development (docker + gitlab + DNS)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Intro 


 I could not think of a suitable name for the post, so I will briefly describe what will be discussed. 


 Most of us have some small persona...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up a home environment for development (docker + gitlab + DNS)</h1><div class="post__text post__text-html js-mediator-article"><h1 id="intro">  Intro </h1><br><p>  I could not think of a suitable name for the post, so I will briefly describe what will be discussed. </p><br><p>  Most of us have some small personal crafts that do not go beyond our homes.  Someone is hosting them on a work computer, someone is on Heroku, someone is on a VPS, and someone has a home server.  Reddite even has a community <a href="https://www.reddit.com/r/homelab/">r / homelab</a> , in which people discuss different hardware and software for the so-called.  <em>home lab</em> . </p><br><p>  I'm not so keen on this issue, but I have an Intel NUC at home that plays music from a NAS using <a href="https://www.musicpd.org/">MPD</a> .  In addition to MPD, my small crafts that help me work with him are spinning around: now the dead telegraph bot, HTTP API on the synatra and a clumsy frontend for it. </p><br><p>  In the post I will describe the process of installing a DNS server for working with domain names for services, a scheme of simultaneous operation of several services using Docker and installing Gitlab with CI without any particular details (many of which I don‚Äôt understand myself).  You will not learn anything new, but suddenly this ‚Äúguide‚Äù will be useful to someone.  Besides, I would like to hear suggestions on how to make it simpler / more elegant / more correct. </p><a name="habracut"></a><br><p>  Initially, the code of my services was on the bitbet / github and after creating the docker-images I had to log in under SSH and run a couple of scripts that created / updated containers with services.  I caught myself thinking that I see a minor annoying bug in the application, which I do not fix just because I'm too lazy to perform the whole procedure.  Obviously, it was time to automate everything.  This is where the idea of ‚Äã‚Äãinstalling Gitlab + CI came. </p><br><h1 id="lokalnye-domeny-s-pomoschyu-dns">  Local domains using DNS </h1><br><p> All containers were created with the flag - <code>--network=host</code> for simplicity - it was enough to use different ports in applications.  However, as the number of services grows, remember which application uses which port.  Yes, and entering each time the IP address with the port in the browser is not very nice, so before installing the glitb I decided to deal with hosting several applications on the same server. </p><br><p>  The idea is simple: we configure DNS, feed it to the router, install Nginx and with its configuration we redirect requests to different ports depending on the domain.  This will allow not to bother with the ports during development, since  containers will start using <code>--publish</code> instead of <code>--network=host</code> . </p><br><p>  When installing <a href="https://www.itzgeek.com/how-tos/linux/debian/configure-dns-server-on-debian-9-ubuntu-16-04.html">this guide was used</a> .  It is configured for Ubuntu 16.04, I have Debian. </p><br><p>  Further actions are performed from the <code>root</code> . </p><br><p>  First of all, install <code>bind9</code> and utilities: </p><br><pre> <code class="bash hljs">apt-get install -y bind9 bind9utils bind9-doc dnsutils</code> </pre> <br><p>  Next, we need to configure the domain zone.  To do this, add the following to the <code>/etc/bind/named.conf.local</code> file: </p><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">zone</span></span> "nondv.home" <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> { //    <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> master; file "/etc/bind/fwd.nondv.home.db"; // Forward lookup file allow-<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">none</span></span>; }; // Since this <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> DNS, it should be <span class="hljs-keyword"><span class="hljs-keyword">none</span></span>. };</code> </pre> <br><p>  Also, a reverse lookup configuration is added to the guide, but, to be honest, I don‚Äôt really understand why this is needed, so I didn‚Äôt do it. </p><br><p>  Now create the file <code>/etc/bind/fwd.nondv.home.db</code> : </p><br><pre> <code class="hljs vbscript">$TTL <span class="hljs-number"><span class="hljs-number">604800</span></span> @ <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> SOA ns1.mydomain.home. root.mydomain.home. ( <span class="hljs-number"><span class="hljs-number">20</span></span> ; Serial <span class="hljs-number"><span class="hljs-number">604800</span></span> ; Refresh <span class="hljs-number"><span class="hljs-number">86400</span></span> ; Retry <span class="hljs-number"><span class="hljs-number">2419200</span></span> ; Expire <span class="hljs-number"><span class="hljs-number">604800</span></span> ) ; Negative Cache TTL ;Name <span class="hljs-built_in"><span class="hljs-built_in">Server</span></span> Information <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> NS ns1.nondv.home. ;IP address of Name <span class="hljs-built_in"><span class="hljs-built_in">Server</span></span> ns1 <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> A <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> ;A - Record HostName <span class="hljs-keyword"><span class="hljs-keyword">To</span></span> Ip Address nuc <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> A <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> gitlab <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> A <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> mpd <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> A <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> @ <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> A <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> <br><p>  Next, restart bind9 and set autorun: </p><br><pre> <code class="bash hljs">systemctl restart bind9 systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> bind9</code> </pre> <br><p>  Note that I used <code>.home</code> instead of <code>.local</code> .  This was done because the <code>nondv.local</code> domain <code>nondv.local</code> not resolved without subdomains.  Well, more precisely, <code>dig</code> recognized it normally, but browsers and <code>curl</code> did not.  As a colleague explained to me, this is most likely due to a different software like Bonjour (my working laptop with an apple on the lid).  In general, there should be no such problems with the <code>.home</code> domain. </p><br><p>  Actually, that's all.  After that I added DNS as primary to the router and reconnected to it (so that the <code>/etc/resolve.conf</code> file was automatically updated). </p><br><h1 id="nginx">  Nginx </h1><br><p>  As I said, in order to be able to access all services at the same time via HTTP on port 80, we need to configure Nginx so that it proxies requests to different ports depending on the domain. </p><br><p>  Documentation on the nginx image is available on the <a href="https://hub.docker.com/_/nginx/">Docker Hub</a> website. </p><br><p>  Prepare the main configuration file <code>/srv/nginx/nginx.conf</code> : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">user</span></span> nginx; <span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/error.log <span class="hljs-literal"><span class="hljs-literal">warn</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pid</span></span> /var/run/nginx.pid; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/mime.types; <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> application/octet-stream; <span class="hljs-attribute"><span class="hljs-attribute">log_format</span></span> main <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_addr</span></span></span><span class="hljs-string"> - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_user</span></span></span><span class="hljs-string"> [</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time_local</span></span></span><span class="hljs-string">] "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$status</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$body_bytes_sent</span></span></span><span class="hljs-string"> "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_referer</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_user_agent</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_forwarded_for</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx/access.log main; <span class="hljs-attribute"><span class="hljs-attribute">sendfile</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> nondv.home; <span class="hljs-attribute"><span class="hljs-attribute">rewrite</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^/$</span></span> http://mpd.nondv.home <span class="hljs-literal"><span class="hljs-literal">redirect</span></span>; <span class="hljs-comment"><span class="hljs-comment">#  ,       } include /etc/nginx/conf.d/*.conf; }</span></span></code> </pre> <br><p>  Next, configure the domains.  I will show only one: </p><br><pre> <code class="hljs pgsql"># /srv/nginx/conf.d/gitlab.conf <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; server_name gitlab.nondv.home; <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> / { proxy_pass http://<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3080</span></span>; } }</code> </pre><br><p>  The container is started by the command: </p><br><pre> <code class="bash hljs">docker run --detach \ --network host \ --name nginx \ --restart always \ --volume /srv/nginx/nginx.conf:/etc/nginx/nginx.conf:ro \ --volume /srv/nginx/conf.d:/etc/nginx/conf.d:ro \ nginx:alpine</code> </pre> <br><p>  That's all, now HTTP requests for port 80 will be trapped using nginx and redirected to the correct port. </p><br><h1 id="gitlab">  Gitlab </h1><br><p>  Everything is simple according to the <a href="https://docs.gitlab.com/omnibus/docker/">official manual</a> : </p><br><pre> <code class="hljs tex">docker run --detach <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--hostname gitlab.nondv.home <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--publish 3080:80 --publish 3022:22 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--name gitlab <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--restart always <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--volume /srv/gitlab/config:/etc/gitlab:Z <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--volume /srv/gitlab/logs:/var/log/gitlab:Z <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--volume /srv/gitlab/data:/var/opt/gitlab:Z <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>gitlab/gitlab-ce:latest</code> </pre> <br><p>  We are waiting for everything to be configured (we look at <code>docker logs -f gitlab</code> ) and then we enter the container ( <code>docker exec -it gitlab bash</code> ) for add.  settings: </p><br><pre> <code class="hljs pgsql">nano /etc/gitlab/gitlab.rb # <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> vim # /etc/gitlab/gitlab.rb external_url <span class="hljs-string"><span class="hljs-string">'http://gitlab.nondv.home'</span></span> gitlab_rails[<span class="hljs-string"><span class="hljs-string">'gitlab_shell_ssh_port'</span></span>] = <span class="hljs-number"><span class="hljs-number">3022</span></span> # /etc/gitlab/gitlab.rb gitlab-ctl reconfigure</code> </pre> <br><p>  For reliability, you can restart the container ( <code>docker container restart gitlab</code> ). </p><br><h2 id="ci">  CI </h2><br><p>  Gitlab CI is already integrated, but it needs Gitlab Runner ( <a href="https://docs.gitlab.com/runner/install/docker.html">documentation</a> ). </p><br><p>  For this, I wrote a small script: </p><br><pre> <code class="bash hljs">NAME=<span class="hljs-string"><span class="hljs-string">"gitlab-runner</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$NAME</span></span> docker run -d --name <span class="hljs-variable"><span class="hljs-variable">$NAME</span></span> --restart always \ --network=host \ -v /srv/gitlab-runner/config:/etc/gitlab-runner \ -v /var/run/docker.sock:/var/run/docker.sock \ gitlab/gitlab-runner:alpine</code> </pre> <br><p>  After creating the runner, we need to register it.  To do this, go to the guitar tab (through the browser), go to the Admin area ‚Üí Overview ‚Üí Runners.  There is described the installation runners.  In short, you just do: </p><br><pre> <code class="bash hljs">docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it gitlab-runner register</code> </pre> <br><p>  and answer the questions. </p><br><h1 id="vashi-sobstvennye-http-servisy">  Your own HTTP services </h1><br><p>  They run by analogy with the gitlab.  Publish them on any port and add the config to nginx. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Now you can host your projects on a home server and use the power of Gitlab CI to automate the assembly and publishing of your projects.  It's convenient to do <code>git push</code> and not worry about running, right? </p><br><p>  I would also recommend setting up mail for gitlab.  Personally, I used a mailbox on Yandex.  <a href="https://docs.gitlab.com/omnibus/settings/smtp.html">Documentation</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/417179/">https://habr.com/ru/post/417179/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417167/index.html">Launch LDA in the real world. Detailed guide</a></li>
<li><a href="../417171/index.html">Study: Women's managed hedge funds perform better</a></li>
<li><a href="../417173/index.html">"Old New Vinyl": 20 materials on the history and production of players and records</a></li>
<li><a href="../417175/index.html">Restoration of the Acme road semaphore in the first half of the 20th century</a></li>
<li><a href="../417177/index.html">Local web server under Linux, with automatic raising of hosts and switching versions of PHP</a></li>
<li><a href="../417181/index.html">Fintech-digest: in the store you can withdraw money from the card at the checkout; PayPal wants to buy more companies.</a></li>
<li><a href="../417183/index.html">Sales Funnel Analytics</a></li>
<li><a href="../417185/index.html">Ultra-high-energy neutrinos emitted by radiant galaxies at the other end of the universe were first detected.</a></li>
<li><a href="../417189/index.html">How people "drowned" New Orleans</a></li>
<li><a href="../417193/index.html">Overview of the IT-market of cloud solutions for business</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>