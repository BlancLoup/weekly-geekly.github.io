<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MVC model metadata output to dynamic markup</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In ASP.NET MVC, metadata ‚Äî attributes that describe model fields ‚Äî are used both when generating markup (displaying the name of a field, its placehold...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MVC model metadata output to dynamic markup</h1><div class="post__text post__text-html js-mediator-article">  In ASP.NET MVC, metadata ‚Äî attributes that describe model fields ‚Äî are used both when generating markup (displaying the name of a field, its placeholder, etc.) and when validating data (outputting validation rules).  Conventionally, there are 2 types of validation: <br><ul><li>  client validation </li><li>  server validation </li></ul><br>  Client validation is good because the user immediately sees the mistakes made in filling in the fields and can make corrections without having to send data to the server (unobtrusive validation).  This type of validation is necessary in our case. <br><br><div class="spoiler">  <b class="spoiler_title">what is the actual problem?</b> <div class="spoiler_text">  When using the classic approach to generating markup, everything works automatically, but what if we use ajax and generate html markup dynamically on the client?  In this case, nothing is automatically added to the markup.  Of course, you can add everything you need manually and it would seem that the problem has been exhausted, but the problem of code duplication arises here, since the same data has to be described twice - on the server and on the client, which in turn leads to other problems.  In some cases, dynamic markup is very convenient, but here the question arises of the withdrawal of model metadata and data validation on the client side.  This will be discussed further. <br></div></div><br>  So, it is necessary to implement automatic output of the MVC model metadata to the client side and unobtrusive validation. <br><a name="habracut"></a><br><h5>  Key ideas: </h5><br><ul><li>  metadata will be delivered to the client via http header </li><li>  Metadata will be added automatically through filters. </li><li>  before transmitting the data, we will encoding the lines in base64 (this is necessary, since the http header is transferred to ASCII). </li><li>  on the client in the Backbone model, override the parse method - in it we will intercept the transferred metadata and execute the decode from base64 </li><li>  backbone backbone-validation.js library must be enabled on the client - validation library </li></ul><br>  The idea of ‚Äã‚Äãtransferring metadata via the http header is taken from <a href="http://habrahabr.ru/post/152845/">this</a> article. <br>  You can learn more about the backbone-validation.js library <a href="http://thedersen.com/projects/backbone-validation/">here</a> . <br><br><h5>  server part </h5><br>  On the server, write 2 filters: <br><ul><li>  filter to display in the model metadata header </li><li>  filter to display in the header of model validation rules </li></ul><br><div class="spoiler">  <b class="spoiler_title">metadata filter (field name, placeholder, etc.)</b> <div class="spoiler_text"><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MetaToHeader</span></span> : <span class="hljs-title"><span class="hljs-title">ActionFilterAttribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> header; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MetaToHeader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> header</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header = header; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ActionExecutedContext filterContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = filterContext.Result <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> JsonResult; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; result.Data != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> meta = GetMeta(result.Data); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsonMeta = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JavaScriptSerializer().Serialize(meta); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsonMetaBytes = Encoding.UTF8.GetBytes(jsonMeta); filterContext.HttpContext.Response.Headers.Add(header, Convert.ToBase64String(jsonMetaBytes)); } <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuted(filterContext); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IDictionary&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">, </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMeta</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> model</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> meta = ModelMetadataProviders.Current.GetMetadataForType(() =&gt; model, model.GetType()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> meta.Properties.ToDictionary( p =&gt; p.PropertyName, p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { label = p.GetDisplayName(), title = p.Description, placeholder = p.Watermark, readOnly = p.IsReadOnly } <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">validation rule filter</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ValidationToHeader</span></span> : <span class="hljs-title"><span class="hljs-title">ActionFilterAttribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> header; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Func&lt;ModelClientValidationRule, List&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;&gt;&gt; Rules; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidationToHeader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> header</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.header = header; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidationToHeader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Rules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Func&lt;ModelClientValidationRule, List&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;&gt;&gt;() { { <span class="hljs-string"><span class="hljs-string">"length"</span></span>, r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.ValidationParameters.ContainsKey(<span class="hljs-string"><span class="hljs-string">"max"</span></span>)) result.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> {maxLength = r.ValidationParameters[<span class="hljs-string"><span class="hljs-string">"max"</span></span>]}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.ValidationParameters.ContainsKey(<span class="hljs-string"><span class="hljs-string">"min"</span></span>)) result.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> {minLength = r.ValidationParameters[<span class="hljs-string"><span class="hljs-string">"min"</span></span>]}); result.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { msg = r.ErrorMessage }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }, { <span class="hljs-string"><span class="hljs-string">"range"</span></span>, r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.ValidationParameters.ContainsKey(<span class="hljs-string"><span class="hljs-string">"max"</span></span>)) result.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> {max = r.ValidationParameters[<span class="hljs-string"><span class="hljs-string">"max"</span></span>]}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.ValidationParameters.ContainsKey(<span class="hljs-string"><span class="hljs-string">"min"</span></span>)) result.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> {min = r.ValidationParameters[<span class="hljs-string"><span class="hljs-string">"min"</span></span>]}); result.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> {msg = r.ErrorMessage}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }, { <span class="hljs-string"><span class="hljs-string">"remote"</span></span>, r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.ValidationParameters.ContainsKey(<span class="hljs-string"><span class="hljs-string">"url"</span></span>)) result.Add(<span class="hljs-string"><span class="hljs-string">"url"</span></span>, r.ValidationParameters[<span class="hljs-string"><span class="hljs-string">"url"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.ValidationParameters.ContainsKey(<span class="hljs-string"><span class="hljs-string">"type"</span></span>)) result.Add(<span class="hljs-string"><span class="hljs-string">"type"</span></span>, r.ValidationParameters[<span class="hljs-string"><span class="hljs-string">"type"</span></span>]); result.Add(<span class="hljs-string"><span class="hljs-string">"msg"</span></span>, r.ErrorMessage); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> {remote = result} }; } }, { <span class="hljs-string"><span class="hljs-string">"required"</span></span>, r =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { required = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, msg = r.ErrorMessage } } }, { <span class="hljs-string"><span class="hljs-string">"number"</span></span>, r =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { pattern = <span class="hljs-string"><span class="hljs-string">"number"</span></span>, msg = r.ErrorMessage } } } }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ActionExecutedContext filterContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = filterContext.Result <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> JsonResult; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; result.Data != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> meta = GetRules(result.Data, filterContext.Controller.ControllerContext); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsonMeta = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JavaScriptSerializer().Serialize(meta); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsonMetaBytes = Encoding.UTF8.GetBytes(jsonMeta); filterContext.HttpContext.Response.Headers.Add(header, Convert.ToBase64String(jsonMetaBytes)); } <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuted(filterContext); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IDictionary&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">, </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRules</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> model, ControllerContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> meta = ModelMetadataProviders.Current.GetMetadataForType(() =&gt; model, model.GetType()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> meta.Properties.ToDictionary( p =&gt; p.PropertyName, p =&gt; PropertyRules(p, context) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PropertyRules</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModelMetadata meta, ControllerContext controllerContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> meta.GetValidators(controllerContext) .SelectMany(v =&gt; v.GetClientValidationRules()) .SelectMany(r =&gt; Rules[r.ValidationType](r)) .ToArray(); } }</code> </pre><br></div></div><br>  It is worth paying attention to the fact that the filters work with the data sent to the client in Json format. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  client part </h5><br>  on the client, create: <br><ul><li>  base Backbone model in which we will override the parse method </li><li>  basic backbone view </li></ul><br><div class="spoiler">  <b class="spoiler_title">base model</b> <div class="spoiler_text"><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> models = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.App.Models; models.DataMetaModel = Backbone.Model.extend({ <span class="hljs-attr"><span class="hljs-attr">metaHeader</span></span>: <span class="hljs-string"><span class="hljs-string">'data-meta'</span></span>, <span class="hljs-attr"><span class="hljs-attr">validationHeader</span></span>: <span class="hljs-string"><span class="hljs-string">'data-validation'</span></span>, <span class="hljs-attr"><span class="hljs-attr">urlRoot</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">initialize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.urlRoot = options.url; }, <span class="hljs-attr"><span class="hljs-attr">parse</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response, xhr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> metaData = xhr.xhr.getResponseHeader(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.metaHeader); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> validationData = xhr.xhr.getResponseHeader(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.validationHeader); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.meta = metaData ? $.parseJSON(Base64.decode(metaData)) : <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.validation = validationData ? $.parseJSON(Base64.decode(validationData)) : <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response; } }); })();</code> </pre><br></div></div><br>  The parse method is redefined to intercept metadata and validation rules from the http header, which will then be used by Backbone by the backbone-validation.js library <br><div class="spoiler">  <b class="spoiler_title">basic backbone view</b> <div class="spoiler_text"><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> views = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.App.Views; views.dataMetaView = Backbone.View.extend({ <span class="hljs-attr"><span class="hljs-attr">events</span></span>: { <span class="hljs-string"><span class="hljs-string">'submit'</span></span>: <span class="hljs-string"><span class="hljs-string">'evSubmit'</span></span>, <span class="hljs-string"><span class="hljs-string">'blur input[type=text]'</span></span>: <span class="hljs-string"><span class="hljs-string">'evBlur'</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">initialize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ _.extend(Backbone.Validation.callbacks, { <span class="hljs-attr"><span class="hljs-attr">valid</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.validCallback, <span class="hljs-attr"><span class="hljs-attr">invalid</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.invalidCallback, }); _.extend(Backbone.Validation.validators, { <span class="hljs-attr"><span class="hljs-attr">remote</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.remoteValidator }); Backbone.Validation.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, { <span class="hljs-attr"><span class="hljs-attr">offFlatten</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-comment"><span class="hljs-comment">//  .    backbone-validation.js : var flatten = function (obj, into, prefix) { }); }, render: function () { this.addMeta(); }, addMeta: function () { _.each(this.model.meta, function (meta, name) { $('label[for=' + name + ']').text(meta.label); $('input[name=' + name + ']').attr({ title: meta.title, placeholder: meta.placeholder, readonly: meta.readOnly }); }); }, evBlur: function (e) { var $el = $(e.target); this.model.set($el.attr('name'), $el.val(), {validate: true, validateAll: false}); }, evSubmit: function (e) { if (!this.model.isValid(true)) return false; }, validCallback: function (view, attr, selector) { var control = view.$('[' + selector + '=' + attr + ']'); var group = control.parents(".control-group"); group.removeClass("error"); if (control.data("error-style") === "tooltip") { // CAUTION: calling tooltip("hide") on an uninitialized tooltip // causes bootstraps tooltips to crash somehow... if (control.data("tooltip")) control.tooltip("hide"); } else if (control.data("error-style") === "inline") { group.find(".help-inline.error-message").remove(); } else { group.find(".help-block.error-message").remove(); } }, invalidCallback: function (view, attr, error, selector) { var control = view.$('[' + selector + '=' + attr + ']'); var group = control.parents(".control-group"); group.addClass("error"); if (control.data("error-style") === "tooltip") { var position = control.data("tooltip-position") || "right"; control.tooltip({ placement: position, trigger: "manual", title: error }); control.tooltip("show"); } else if (control.data("error-style") === "inline") { if (group.find(".help-inline").length === 0) { group.find(".controls").append("&lt;span class=\"help-inline error-message small-text\"&gt;&lt;/span&gt;"); } var target = group.find(".help-inline"); target.text(error); } else { if (group.find(".help-block").length === 0) { group.find(".controls").append("&lt;p class=\"help-block error-message small-text\"&gt;&lt;/p&gt;"); } var target = group.find(".help-block"); target.text(error); } }, remoteValidator: function (value, attr, customValue, model) { var result, data = model.toJSON(); data[attr] = value; $.ajax({ type: customValue.type || 'GET', data: data, url: customValue.url, async: false, success: function (state) { if (!state) result = customValue.msg || 'remote validation error'; }, error: function () { result = "remote validation error"; } }); return result; } }); })();</span></span></code> </pre><br></div></div><br>  Here, in Backbone View, the entry point to the validation library is first initialized - backbone-validation.js: <br><pre> <code class="javascript hljs">Backbone.Validation.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, { <span class="hljs-attr"><span class="hljs-attr">offFlatten</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-comment"><span class="hljs-comment">//  .    backbone-validation.js : var flatten = function (obj, into, prefix) { });</span></span></code> </pre><br>  Second, the callback functions (valid, invalid) necessary for highlighting errors are initialized.  Also, the remote validation attribute is initialized here: <br><pre> <code class="javascript hljs">remoteValidator: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value, attr, customValue, model</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result, data = model.toJSON(); data[attr] = value; $.ajax({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: customValue.type || <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: data, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: customValue.url, <span class="hljs-attr"><span class="hljs-attr">async</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">success</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!state) result = customValue.msg || <span class="hljs-string"><span class="hljs-string">'remote validation error'</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ result = <span class="hljs-string"><span class="hljs-string">"remote validation error"</span></span>; } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br>  On the client side, the attribute of remote validation is only an ajax method (the type of the method can be specified in the model description on the server side), which accepts as a response a variable indicating the state of the validated field: <br><ul><li>  <b>true</b> - the field is valid </li><li>  <b>false</b> is invalid </li></ul><br>  Remote validation is required when validation is not possible or, for some reason, difficult to do on the client side.  In the code on the server side, the remote validation attribute is described as follows. <br><pre> <code class="hljs json">[Remote(<span class="hljs-string"><span class="hljs-string">"RemoteEmailValidation"</span></span>, <span class="hljs-string"><span class="hljs-string">"Friends"</span></span>, ErrorMessage = <span class="hljs-string"><span class="hljs-string">"   "</span></span>)]</code> </pre><br><a name="using"></a><br><h5>  Using </h5><br>  On the <b>server</b> side, you need to create a method that will send data in Json format.  To it and apply the created filters: <br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">MetaToHeader(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"data-meta"</span></span></span><span class="hljs-meta">)</span></span>] [ValidationToHeader(<span class="hljs-string"><span class="hljs-string">"data-validation"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Json(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Friend(), JsonRequestBehavior.AllowGet); }</code> </pre><br>  The parameters in the filters specify the name of the http header.  The same names are used on the client in the parse method. <br><br>  On the <b>client</b> side, create a Backbone <b>FriendModel</b> model that <b>inherits</b> from the created Base Backbone model <b>DataMetaModel</b> , in which the parse method is redefined: <br><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> models = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.App.Models; models.FriendModel = models.DataMetaModel.extend({ <span class="hljs-attr"><span class="hljs-attr">initialize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ models.DataMetaModel.prototype.initialize.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, options); } }); })();</code> </pre><br><br>  We will also create a Backbone View <b>NewFriend</b> inherited from the created backbone View <b>dataMetaView</b> : <br><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> views = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.App.Views; views.NewFriend = views.dataMetaView.extend({ <span class="hljs-attr"><span class="hljs-attr">initialize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ views.dataMetaView.prototype.initialize.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.model.on(<span class="hljs-string"><span class="hljs-string">'sync'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.render, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.template = _.template($(options.template).html()); }, <span class="hljs-attr"><span class="hljs-attr">render</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$el.html(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.template(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.model.toJSON())); views.dataMetaView.prototype.render.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">load</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.model.fetch(); } }); })();</code> </pre><br>  Here in the <b>render</b> method, after performing all the actions, you must call the base render method. <pre> <code class="javascript hljs">views.dataMetaView.prototype.render.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre>  in order to add metadata (name, placeholder, etc.) to the drawn fields in accordance with the model description on the server side.  However, the validation rules passed to the client are not added to the DOM.  They are only used by the backbone-validation.js library. <br><br><h5>  Example </h5><br>  Create a <b>Friend</b> model: <br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Friend { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Display(<span class="hljs-type"><span class="hljs-type">Name</span></span> = "", Prompt = " ", Description = " ")] [Required(ErrorMessage = "First name required")] [StringLength(<span class="hljs-number"><span class="hljs-number">50</span></span>, MinimumLength = <span class="hljs-number"><span class="hljs-number">2</span></span>)] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string FirstName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Display(<span class="hljs-type"><span class="hljs-type">Name</span></span> = "", Prompt = " ", Description = " ")] [Required(ErrorMessage = "Last name required")] [StringLength(<span class="hljs-number"><span class="hljs-number">50</span></span>, MinimumLength = <span class="hljs-number"><span class="hljs-number">2</span></span>)] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string LastName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Display(<span class="hljs-type"><span class="hljs-type">Name</span></span> = "", Prompt = " ", Description = " ")] [Required(ErrorMessage = "Age required")] [Range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, ErrorMessage = "Age must be between 0 and 120")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span>? Age { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Display(<span class="hljs-type"><span class="hljs-type">Name</span></span> = " ", Prompt = "  ", Description = "  ")] [Required(ErrorMessage = "Email required")] [Email(ErrorMessage = "Not a valid email")] [Remote("RemoteEmailValidation", "Friends", ErrorMessage = "   ")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string Email { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  In the controller to the method that returns the model, add two filters: <br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">MetaToHeader(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"data-meta"</span></span></span><span class="hljs-meta">)</span></span>] [ValidationToHeader(<span class="hljs-string"><span class="hljs-string">"data-validation"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Json(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Friend(), JsonRequestBehavior.AllowGet); }</code> </pre><br>  on the client, we will create a model and View specified in the <a href="https://habr.com/ru/post/178823/">use</a> clause, and also define a template that will be used by the View to generate dynamic markup: <br><pre> <code class="javascript hljs">&lt;script type=<span class="hljs-string"><span class="hljs-string">'text/template'</span></span> id=<span class="hljs-string"><span class="hljs-string">'dataMeta-template'</span></span>&gt; &lt;form action="/Friends/Create" method="post"&gt; &lt;div class="control-group"&gt; &lt;label for="FirstName"&gt;&lt;/label&gt; &lt;div class="controls"&gt; &lt;input type='text' name="FirstName" value='&lt;%- FirstName %&gt;' /&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label for="LastName"&gt;&lt;/label&gt; &lt;div class="controls"&gt; &lt;input type='text' name="LastName" value='&lt;%- LastName %&gt;' /&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label for="Age"&gt;&lt;/label&gt; &lt;div class="controls"&gt; &lt;input type='text' name="Age" value='&lt;%- Age %&gt;' /&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label for="Email"&gt;&lt;/label&gt; &lt;div class="controls"&gt; &lt;input type='text' name="Email" value='&lt;%- Email %&gt;' /&gt; &lt;/div&gt; &lt;/div&gt; &lt;p&gt;&lt;button class="btn" type="submit"&gt;Create&lt;/button&gt;&lt;/p&gt; &lt;/form&gt; &lt;/script&gt;</code> </pre><br><br>  The entry point on the page is the script: <br><pre> <code class="javascript hljs">&lt;script&gt; (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> models = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.App.Models, views = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.App.Views; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataMetaModel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> models.FriendModel({ <span class="hljs-attr"><span class="hljs-attr">urlRoot</span></span>: <span class="hljs-string"><span class="hljs-string">'/Friends/GetData'</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataMetaView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> views.NewFriend({ <span class="hljs-attr"><span class="hljs-attr">el</span></span>: <span class="hljs-string"><span class="hljs-string">'#dataMeta'</span></span>, <span class="hljs-attr"><span class="hljs-attr">model</span></span>: dataMetaModel, <span class="hljs-attr"><span class="hljs-attr">template</span></span>: <span class="hljs-string"><span class="hljs-string">'#dataMeta-template'</span></span> }); dataMetaView.load(); })(jQuery); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br><h5>  Result </h5><br><img src="http://img14.imageshost.ru/img/2013/05/03/image_51839652245e0.jpg"><br><img src="http://img14.imageshost.ru/img/2013/05/03/image_518392549fa5e.jpg"><br><img src="http://img14.imageshost.ru/img/2013/05/03/image_51839255a9a68.jpg"><br><img src="http://img14.imageshost.ru/img/2013/05/03/image_51839256cfc00.jpg"><br><br><h5>  <a href="https://github.com/aesamson/DataMeta">Project</a> </h5></div><p>Source: <a href="https://habr.com/ru/post/178823/">https://habr.com/ru/post/178823/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178811/index.html">Work with data models in javascript</a></li>
<li><a href="../178813/index.html">Introducing GStreamer: Introduction</a></li>
<li><a href="../178815/index.html">Chaos within us</a></li>
<li><a href="../178817/index.html">Probability Theory and Anthropogenic Factor</a></li>
<li><a href="../178819/index.html">Xmenu - a small "framework" for building console menus</a></li>
<li><a href="../178825/index.html">A little more about SDH and PDH</a></li>
<li><a href="../178827/index.html">Tools that we use for team development.</a></li>
<li><a href="../178831/index.html">Quickly squaring numbers from 1 to 100</a></li>
<li><a href="../178833/index.html">How I chose a lightweight PHP framework</a></li>
<li><a href="../178839/index.html">Assembling a Cmake packer or training on cats</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>