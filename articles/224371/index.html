<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PVS-Studio checks OpenMW: everything is not smooth in the Morrowind universe</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I checked the OpenMW project with PVS-Studio and wrote this tiny article. There were too few errors. But I was asked to write about the verification o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PVS-Studio checks OpenMW: everything is not smooth in the Morrowind universe</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/43f/a1d/5ce/43fa1d5ce1bfeca268d2a8c6755946d6.png"></div><br>  I checked the OpenMW project with PVS-Studio and wrote this tiny article.  There were too few errors.  But I was asked to write about the verification of this project article, and here it is. <br><a name="habracut"></a><br><h2>  Openmw </h2><br>  OpenMW is an attempt to recreate the popular RPG Morrowind, a complete implementation of all the features of the game with open source.  To run OpenMW, you need the original Morrowind CD. <br><br>  Source code available at: <a href="https://code.google.com/p/openmw/">https://code.google.com/p/openmw/</a> <br><br><h2>  Suspicious places found </h2><br>  <b>Fragment N1</b> <br><pre><code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUtf8</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c, ToUTF8::Utf8Encoder&amp; encoder, ToUTF8::FromType encoding)</span></span></span><span class="hljs-function"> </span></span>{ .... conv[<span class="hljs-number"><span class="hljs-number">0xa2</span></span>] = <span class="hljs-number"><span class="hljs-number">0xf3</span></span>; conv[<span class="hljs-number"><span class="hljs-number">0xa3</span></span>] = <span class="hljs-number"><span class="hljs-number">0xbf</span></span>; conv[<span class="hljs-number"><span class="hljs-number">0xa4</span></span>] = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; conv[<span class="hljs-number"><span class="hljs-number">0xe1</span></span>] = <span class="hljs-number"><span class="hljs-number">0x8c</span></span>; conv[<span class="hljs-number"><span class="hljs-number">0xe1</span></span>] = <span class="hljs-number"><span class="hljs-number">0x8c</span></span>; &lt;&lt;&lt;&lt;==== conv[<span class="hljs-number"><span class="hljs-number">0xe3</span></span>] = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; .... }</code> </pre> <br>  PVS-Studio warning: V519 The 'conv [0xe1]' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 103, 104. openmw fontloader.cpp 104 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is probably a typo.  In the highlighted line, the index 0xe2 is most likely to be used. <br><br>  <b>Fragment N2</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Flags { .... NoDuration = <span class="hljs-number"><span class="hljs-number">0x4</span></span>, .... } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CastSpell::cast (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ESM::Ingredient* ingredient) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!magicEffect-&gt;mData.mFlags &amp; ESM::MagicEffect::NoDuration) .... }</code> </pre> <br>  PVS-Studio warning: V564 The '&amp;' operator is applied to bool type value.  You've probably forgotten to include the operator.  openmw spellcasting.cpp 717 <br><br>  The error is related to the priority of operations.  In the beginning, the action is executed (! MagicEffect-&gt; mData.mFlags).  Result: 0 or 1. Then the action is performed: 0 &amp; 4 or 1 &amp; 4. This has no practical meaning.  Most likely, the code should look like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ! (magicEffect-&gt;mData.mFlags &amp; ESM::MagicEffect::NoDuration) )</code> </pre> <br>  <b>Fragment N3</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Clothing::blank() { mData.mType = <span class="hljs-number"><span class="hljs-number">0</span></span>; mData.mWeight = <span class="hljs-number"><span class="hljs-number">0</span></span>; mData.mValue = <span class="hljs-number"><span class="hljs-number">0</span></span>; mData.mEnchant = <span class="hljs-number"><span class="hljs-number">0</span></span>; mParts.mParts.clear(); mName.clear(); mModel.clear(); mIcon.clear(); mIcon.clear(); mEnchant.clear(); mScript.clear(); }</code> </pre> <br>  PVS-Studio warning: V586 The 'clear' function is called twice for deallocation of the same resource.  Check lines: 48, 49. components loadclot.cpp 49 <br><br>  The object 'mIcon' is cleared twice.  The second cleaning is superfluous or it was necessary to clean something else. <br><br>  <b>Fragment N4</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Storage::loadDataFromStream( ContainerType&amp; container, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::istream&amp; stream) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> line; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!stream.eof()) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::getline( stream, line ); .... } .... }</code> </pre> <br>  PVS-Studio warning: V663 Infinite loop is possible.  The 'cin.eof ()' condition is not a loop from the loop.  Consider adding the 'cin.fail ()' function call to the conditional expression.  components translation.cpp 45 <br><br>  When working with the 'std :: istream' class, it is not enough to call the 'eof ()' function to end the loop.  In case of a failure in reading data, the call to the 'eof () function will always return the value' false '.  To complete the loop in this case, additional verification of the value returned by the 'fail ()' function is necessary. <br><br>  <b>Fragment N5</b> <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Factory</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReadSourceCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mReadSourceCache; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWriteSourceCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mReadSourceCache; } .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> mReadSourceCache; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> mWriteSourceCache; .... };</code> </pre> <br>  PVS-Studio warning: V524 It is odd that the body of the getWriteSourceCache function is fully equivalent to the body of the getReadSourceCache function.  components factory.hpp 209 <br><br>  It seems to me that the function getWriteSourceCache () should be like this: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWriteSourceCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mWriteSourceCache; }</code> </pre> <br>  <b>Fragment N6, N7, N8</b> <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rangeTypeLabel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idx)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* rangeTypeLabels [] = { <span class="hljs-string"><span class="hljs-string">"Self"</span></span>, <span class="hljs-string"><span class="hljs-string">"Touch"</span></span>, <span class="hljs-string"><span class="hljs-string">"Target"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; idx &lt;= <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rangeTypeLabels[idx]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Invalid"</span></span>; }</code> </pre> <br>  PVS-Studio warning: V557 Array overrun is possible.  The value of 'idx' index could reach 3. esmtool labels.cpp 502 <br><br>  Incorrect array index check.  If the variable 'idx' is equal to 3, then the array will overrun. <br><br>  Right: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; idx &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>)</code> </pre> <br>  A similar situation occurred in two more places: <ul><li>  V557 Array overrun is possible.  The value of 'idx' index could reach 143. esmtool labels.cpp 391 </li><li>  V557 Array overrun is possible.  The value of 'idx' index could reach 27. esmtool labels.cpp 475 </li></ul><br>  <b>Fragment N9</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> UpperBodyCharacterState { UpperCharState_Nothing, UpperCharState_EquipingWeap, UpperCharState_UnEquipingWeap, .... }; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CharacterController::updateWeaponState() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((weaptype != WeapType_None || UpperCharState_UnEquipingWeap) &amp;&amp; animPlaying) .... }</code> </pre> <br>  PVS-Studio Warning: V560 A part of conditional expression is always true: UpperCharState_UnEquipingWeap.  openmw character.cpp 949 <br><br>  This condition is very suspicious.  Now it can be simplified to: "if (animPlaying)".  Obviously something is wrong. <br><br>  <b>Fragment N10, N11</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> World::clear() { mLocalScripts.clear(); mPlayer-&gt;clear(); .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mPlayer) .... }</code> </pre> <br>  PVS-Studio warning: V595 The mPlayer 'pointer was used against nullptr.  Check lines: 234, 245. openmw worldimp.cpp 234 <br><br>  Similarly: V595 The mBody pointer was used before it was verified against nullptr.  Check lines: 95, 99. openmw physic.cpp 95 <br><br>  <b>Fragment N12</b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ExprParser::replaceBinaryOperands() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t1==t2) mOperands.push_back (t1); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t1==<span class="hljs-string"><span class="hljs-string">'f'</span></span> || t2==<span class="hljs-string"><span class="hljs-string">'f'</span></span>) mOperands.push_back (<span class="hljs-string"><span class="hljs-string">'f'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::logic_error (<span class="hljs-string"><span class="hljs-string">"failed to determine result operand type"</span></span>); }</code> </pre> <br>  PVS-Studio warning: V596 The object was not created.  The 'throw' keyword could be missing: throw logic_error (FOO);  components exprparser.cpp 101 <br><br>  Forgot the 'throw' keyword.  The code should be: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::logic_error (<span class="hljs-string"><span class="hljs-string">"failed to determine result operand type"</span></span>);</code> </pre> <br><h2>  Conclusion </h2><br>  The acquisition of PVS-Studio and the implementation of this tool in the development process will speed up the development process, detect errors early and, as a result, make the project better. <br><br><h2>  This article is in English. </h2><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="http://www.viva64.com/en/b/0259/">PVS-Studio Checks OpenMW: Not All is Fine in the Morrowind Universe</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected the answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio and CppCat, version 2014</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/224371/">https://habr.com/ru/post/224371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../224359/index.html">The reception of pre-orders on the Flame dev-smartphone under Firefox OS has begun</a></li>
<li><a href="../224363/index.html">Device Blocks in Objective-C</a></li>
<li><a href="../224365/index.html">Why does the Surface Pro 3 digitizer have only 256 pressure levels?</a></li>
<li><a href="../224367/index.html">ASUS VivoTab Note 8 Review</a></li>
<li><a href="../224369/index.html">XCOM: Enemy Unknown porting to Linux</a></li>
<li><a href="../224373/index.html">Portrait of active authors in the social network Odnoklassniki</a></li>
<li><a href="../224375/index.html">Skype: Online Voice Translator</a></li>
<li><a href="../224379/index.html">How Wikipedia works (part 1)</a></li>
<li><a href="../224381/index.html">The presentation of the server line EcoServer held at the All-Russian forum of providers of hosting</a></li>
<li><a href="../224383/index.html">Bootloader with AES-128 and EAX on AVR Assembler in 1024 bytes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>