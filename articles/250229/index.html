<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PIC16F1503. Wheelbarrow for pumping - 2. Light</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It used to be about sound . 

 I left the last post unfinished. If you remember, I couldn‚Äôt manage to find ‚Äúthat sound‚Äù. Attempts to pick up ‚Äútsiferki...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PIC16F1503. Wheelbarrow for pumping - 2. Light</h1><div class="post__text post__text-html js-mediator-article">  It used to be <a href="http://habrahabr.ru/post/250123/">about sound</a> . <br><br>  I left the last post unfinished.  If you remember, I couldn‚Äôt manage to find ‚Äúthat sound‚Äù.  Attempts to pick up ‚Äútsiferki on a whim‚Äù turned out to be much worse than the usual ‚Äúpi-piu‚Äù ... On the one hand all the same - from the Chinese tweeter no sound is achieved, but on the other hand - ‚Äúunclean work, low class.  Again, drive the clock frequency at 16 MHz for the sake of this ... <br><br><img src="https://habrastorage.org/files/467/246/10a/46724610af9c431aa5f260bee356e5fb.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, I did something wrong somewhere.  The next evening, an educational program on music and its literacy gave rise to even more questions than it was before (like why there is C sharp, but there is no re-sharp, but instead E-flat instead?).  But I‚Äôm no stranger to "taking the Japanese by the manual", so I continued to understand.  Simultaneously with the customer they discussed the change of the TZ (a familiar picture, isn‚Äôt it?), Which consisted in adding a ‚Äúbottom light‚Äù.  To my timid attempts to say that this is actually a police car, an answer was received that it was a police car in the Negro quarter ... <br><a name="habracut"></a><br>  First I decided to finish the sound.  I changed the frequencies and PWM, set the divider by 1 to 255, got the frequencies 7692 Hz and 62 Hz.  The range has changed a bit, but still - quite. <br><br>  And then something pulled me to measure the frequency with a divider 128. I expected to get something like (7692-62) / 2 = 3815 Hz, but for some reason I received only 125 ... And then me, as my favorite programmers in sweaters with deer , it dawned on: who said that the frequency-divider dependence is linear?  A couple of extra measurements showed that I am absolutely right.  A little bit of trachybidoc with an oscilloscope and an Excel feature gave just such a beautiful picture of Hz-Timer (originals as usual, in the archive at the end of the post): <br><br><img src="https://habrastorage.org/files/35f/a27/288/35fa272888f44d158aa19c3fbb71f48e.png"><br><br>  Now it became clear to me why my sounds were so terrible.  Plus, in the comments, they remembered the door bells, where in 2KB of ROM they thrust melodies ... When you know what to look for, it is found quickly. <br><br>  The first (like) such a scheme was published in the journal Radio, 92, 8th number.  There was also a smart (for me) sign <br><br><img src="https://habrastorage.org/files/726/57a/b21/72657ab218ed4d45baaedfc76694b686.jpg"><br><br>  And on the next page is the firmware itself.  Even more googlezh and we find "Radio amateur", 93, February.  There is absolutely the same principle, but there are more melodies. <br><br>  Again, we charge the Excel (in the archive on the second tab) and transfer delays from ‚Äúiron‚Äù to ‚Äúsoft‚Äù. <br><br>  Add some code <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// come cool sound const uint8_t m1[31]={49,49,52,52,58,58,58,58,38,38,28,52,52,52,52,52,52,52,52,38,38,36,38,36,38,52,52,49,49,49,49}; const uint8_t m2[31]={49,42,38,38,49,42,38,42,49,52,58,52,49,42,52,65,49,42,38,38,49,42,38,42,49,52,58,42,49,42,52}; // play like this uint8_t c; for(c=0;c&lt;31;c++) { PWM3_LoadDutyValue(m1[c]*2); TMR2_LoadPeriodRegister(m1[c]); __delay_ms(120); }</span></span></code> </pre> <br>  And cheers!  From the Chinese tweeter heard quite a recognizable sound that does not offend even my ears.  In principle, we can be proud of ourselves - we repeated the 20-year scheme on ‚Äúlogic‚Äù on a new element base.  So even if the machine is not playable, you can always convert it into a doorbell :) <br><br>  In general, while the process of finding the best ‚Äúwah-wow‚Äù continues, but in principle we have closed the problem of sound.  Go to the light. <br><br>  As I wrote in the first post, the native LEDs were blue and very bright.  Plus, I was outraged that blue shines through a red light filter and breaks all harmony.  So you need to change. <br><br>  He took out a red LED from the stash, turned it on.  The first problem: the brightness is different.  Blue is very bright.  Changing to ‚Äúfrom the stash‚Äù is still different.  Of course, you can mute additional resistors, but it is too simple.  Finally got to the RGB LED and the miracle happened!  It shines with all colors with the same brightness.  In principle, it is not surprising, because it costs as much as fifty "cheapest". <br><br>  It was decided that I would take four RGB LEDs for all needs (the red and blue parts of the chandelier, the headlights and the bottom).  My LEDs have a common cathode, so I will need 3 (RGB) * 4 (pieces) - 12 legs for control.  Again, the problem: the microcontroller has only 12 (in general, 14, but two power) legs, one of which is allocated exclusively ‚Äúto the input‚Äù (it hangs on the reset) and we have taken one to the ‚Äúmusic‚Äù.  And somewhere you need to hang the switch and leave the stock. <br><br>  Usually in such cases it is easy to do: they take and install some kind of ‚Äúport extender‚Äù.  The most common option is a shift register type 74HC595.  But putting a second microcircuit alongside is a brute force and a complete budget overrun.  If all projects do this, then there will be nothing left for pies ... And we at studiovsemoe.com really love to eat :) <br><br>  Therefore, I will go the other way and do everything with the controller.  Spreading legs (all on the way out) like this <br><br><img src="//habrastorage.org/files/868/bfc/174/868bfc1744784a4f8f658f218be62675.png"><br><br>  And I connect the LEDs like this (as usual, the complete diagram is in the archive) <br><br><img src="//habrastorage.org/files/64d/550/5eb/64d5505eb5a945f6a2ddc0371795c84c.png"><br><br>  In the diagram, I ‚Äúbroke‚Äù each LED into three separate ones, so that the operating principle would be clear.  Well, for some reason, the resistors are plugged into 10k, although in reality they are 200-300 Ohm.  As a result, we have a 4x3 LED matrix. <br><br>  <b><i>Attention: this scheme is suitable only for 1-2-3 LEDs.</i></b>  <b><i>If you plan to connect more - use a special driver like L298 - otherwise the current through the output of the chip will be too large.</i></b> <br><br>  Add some code <br><br><pre> <code class="cpp hljs">LATCbits.LATC0 = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// RED LATCbits.LATC1 = 1; // GREEN LATCbits.LATC2 = 1; // BLUE LATCbits.LATC3 = 0; LATCbits.LATC4 = 0; LATCbits.LATC5 = 0; LATAbits.LATA5 = 0;</span></span></code> </pre><br><br>  Here we set the legs of C0-C2 in one, and C3-C5 and A5 - in zero.  If everything is correctly assembled, then all the LEDs with a ‚Äúwhite light‚Äù should light up. <br><br>  What happened?  As you know, the current flows from a place with a high potential to a place with a low one.  And we have on some legs 1 (or + 3V), and on the other - 0. That LED lights up.  If on those and on those legs apply 0 or 1 - nothing will burn.  <i>By the way, the universality of the circuit also emerges from here - if you do not have LEDs with a common cathode, like mine, but with a common anode, then in the code it will be enough for you to change 0 to 1 and everything will work.</i> <br><br>  As a result, combining the state of the C0-C2 legs, we can choose the color of the glow, while others choose which LED lights up from 4x, for the total, instead of the original 12 legs, it cost 7y.  Not very cool (you can get by with 2 shift registers), but for our purposes it is more than enough. <br><br>  But we have at least two LEDs to be on at the same time and in different colors (for example, a chandelier and a headlight, a headlight and a bottom).  Here I use the old as the world trick: I will quickly switch between the LEDs and turn on the necessary colors.  If done quickly enough, the eye will not notice flicker. <br><br>  We try to blink colors (I think, the meaning can be understood from the notation) <br><br><pre> <code class="cpp hljs">LATCbits.LATC3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC4 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC5 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATAbits.LATA5 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) { LATCbits.LATC0 = <span class="hljs-number"><span class="hljs-number">1</span></span>; LATCbits.LATC1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>); LATCbits.LATC0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC1 = <span class="hljs-number"><span class="hljs-number">1</span></span>; LATCbits.LATC2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>); LATCbits.LATC0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC2 = <span class="hljs-number"><span class="hljs-number">1</span></span>; __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>); }</code> </pre><br><br>  And we look how beautifully the LEDs blink, turning over the colors ... <br><br>  In principle, you can rewrite to work directly with the port - it's easier. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) { LATC=<span class="hljs-number"><span class="hljs-number">0b00000001</span></span>; __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>); LATC=<span class="hljs-number"><span class="hljs-number">0b00000010</span></span>; __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>); LATC=<span class="hljs-number"><span class="hljs-number">0b00000100</span></span>; __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>); }</code> </pre> <br><br>  What is the difference?  The difference is.  that the first option takes (with all the strapping) 89 bytes, and the second 81. 8 bytes of difference out of the blue.  Well, the second is faster :) <br><br>  If you do not understand, the design <br><br><pre> <code class="cpp hljs">LATC=<span class="hljs-number"><span class="hljs-number">0b00000001</span></span>;</code> </pre><br><br>  Fully similar <br><br><pre> <code class="cpp hljs">LATCbits.LATC0 = <span class="hljs-number"><span class="hljs-number">1</span></span>; LATCbits.LATC1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC4 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC5 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC6 = <span class="hljs-number"><span class="hljs-number">0</span></span>; LATCbits.LATC7 = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br><br>  Where are the cons?  The downsides are that on some controllers, the high-order bits can be used for something useful, and we shove everything and use our dirty hands ... <br><br>  Where else is the minus?  Another disadvantage is that we again have to engage in "dragon race".  Well, this is an unworthy business for talents like us.  Don't bother doing this. <br><br>  We have a timer that is responsible for the sound.  No, we will not touch him, but we will touch his neighbors.  For a change, take TIM1 <br><br>  How does it differ from TIM2?  Firstly, greater accuracy - if TIM2 has a range divided into 255 parts, then here it is 65,535. So you can more accurately fall into the frequency.  Secondly, he is not tied to anything and nothing is tied to him.  And finally, its output can be brought to the foot of the microcontroller.  Almost none of this is necessary for us, so we just allow it interrupts and we will blink LEDs in the interrupt handler. <br><br>  In general, we set it up like this. <br><br><img src="//habrastorage.org/files/7dc/db9/0ab/7dcdb90ab2dc4f8abea2bbd644e30829.png"><br><br>  Here the main thing to pay attention to the inclusion of interrupts and call every interrupt function (the bottom line). <br><br>  Now in the tmr1.c file at the very end there is a function that will be called every 64 microseconds (by the way, thanks to the wide capabilities (pay attention to the Reload Value field) we can change this value to ‚Äúevery 4 seconds‚Äù). <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TMR1_ISR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Clear the TMR1 interrupt flag PIR1bits.TMR1IF = 0; TMR1H = (timer1ReloadVal &gt;&gt; 8); TMR1L = timer1ReloadVal; // Add your TMR1 interrupt custom code }</span></span></code> </pre> <br><br>  Since we love extensible and configurable code, we add two files to the project that are responsible for the operation of LEDs. <br><br>  led.h: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// basic colors #define RED 1 #define GREEN 2 #define BLUE 4 #define OFF 0 // set led N to color C void setLed(uint8_t n,uint8_t c); // get color of led N uint8_t getLed(uint8_t n); extern volatile uint8_t lc[4]; // How LED connected #define _LED1_ LATCbits.LATC3 #define _LED2_ LATCbits.LATC4 #define _LED3_ LATCbits.LATC5 #define _LED4_ LATAbits.LATA5 #define _LEDR_ LATCbits.LATC0 #define _LEDG_ LATCbits.LATC1 #define _LEDB_ LATCbits.LATC2</span></span></code> </pre><br><br>  Then in the led.c add "work" with color <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> lc[<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// current led colors 0 - off void setLed(uint8_t n,uint8_t c) { lc[n]=c; } uint8_t getLed(uint8_t n) { return lc[n]; }</span></span></code> </pre><br><br>  And in the interrupt handler code <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(current_led) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: _LED1_=<span class="hljs-number"><span class="hljs-number">0</span></span>; _LED2_=<span class="hljs-number"><span class="hljs-number">1</span></span>; _LED3_=<span class="hljs-number"><span class="hljs-number">1</span></span>; _LED4_=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: _LED1_=<span class="hljs-number"><span class="hljs-number">1</span></span>; _LED2_=<span class="hljs-number"><span class="hljs-number">0</span></span>; _LED3_=<span class="hljs-number"><span class="hljs-number">1</span></span>; _LED4_=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: _LED1_=<span class="hljs-number"><span class="hljs-number">1</span></span>; _LED2_=<span class="hljs-number"><span class="hljs-number">1</span></span>; _LED3_=<span class="hljs-number"><span class="hljs-number">0</span></span>; _LED4_=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: _LED1_=<span class="hljs-number"><span class="hljs-number">1</span></span>; _LED2_=<span class="hljs-number"><span class="hljs-number">1</span></span>; _LED3_=<span class="hljs-number"><span class="hljs-number">1</span></span>; _LED4_=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((lc[current_led]&amp;RED)==RED) _LEDR_=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _LEDR_=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((lc[current_led]&amp;GREEN)==GREEN) _LEDG_=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _LEDG_=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((lc[current_led]&amp;BLUE)==BLUE) _LEDB_=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _LEDB_=<span class="hljs-number"><span class="hljs-number">0</span></span>; current_led++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(current_led&gt;<span class="hljs-number"><span class="hljs-number">3</span></span>) current_led=<span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br><br>  Finally, there is nothing left to do, how to write a verification code. <br><br><pre> <code class="cpp hljs">setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>,RED); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>,GREEN); setLed(<span class="hljs-number"><span class="hljs-number">2</span></span>,BLUE); setLed(<span class="hljs-number"><span class="hljs-number">3</span></span>,RED+GREEN+BLUE); __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>,RED); setLed(<span class="hljs-number"><span class="hljs-number">2</span></span>,GREEN); setLed(<span class="hljs-number"><span class="hljs-number">3</span></span>,BLUE); setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>,RED+GREEN+BLUE); __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>); setLed(<span class="hljs-number"><span class="hljs-number">2</span></span>,RED); setLed(<span class="hljs-number"><span class="hljs-number">3</span></span>,GREEN); setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>,BLUE); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>,RED+GREEN+BLUE); __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>); setLed(<span class="hljs-number"><span class="hljs-number">3</span></span>,RED); setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>,GREEN); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>,BLUE); setLed(<span class="hljs-number"><span class="hljs-number">2</span></span>,RED+GREEN+BLUE); __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>);</code> </pre><br><br>  Compile, run and get a complete bummer.  Nothing blinks and does not overflow.  Why?  <i>I will spare you from thinking and searching.</i>  Because we set to generate an interrupt every 64 microseconds.  And the processor clock speed was set at 62 kilohertz.  That is, 1 clock cycle takes 16 microseconds.  Does anyone believe that the processor is capable of performing all the jumble of commands, drawn above, in 4 cycles?  So I do not believe.  As a result, the microcontroller permanently hangs in the timer interrupt handler. <br><br>  By logical reflections <i>(in fact, a banal selection) we</i> find out that one interrupt is processed in the order of 3 milliseconds (or FFC0 in the timer counter). <br><br>  What is visible?  Seen color changing LEDs that flicker.  And "pure white" is not visible.  What is the reason?  The reason is in time, or rather in frequency.  How do LEDs work for us now?  3ms on fire - 9ms not on fire.  PWM frequency of 80 hertz with a filling of 25%.  By experience, I know that the eye ceases to notice shim somewhere from 200 hertz. <br><br>  What to do?  The easiest way out is to raise the frequency.  Sooner or later the eye will cease to notice flicker.  Whatever frequency of sound we have ‚Äúfloated away‚Äù, we look at the possible values ‚Äã‚Äãof the prescaler for TIM2 - 1: 1, 1: 4, 1:16 and 1:64.  We now have a frequency of 62KHz, which means we can supply 62 * 4 = 250KHz, 62 * 16 = 1MHz or 62 * 64 = 4MHz. <br><br>  The best is the enemy of the good, so I set the frequency of the microcontroller at 1 MHz, change the divider at 1:16 and re-fill the firmware.  Hooray!  Flicker disappeared. <br><br><img src="//habrastorage.org/files/e49/eb6/bfb/e49eb6bfbc9f4de4b4aea2e67662259a.jpg"><br><br>  True, some colors ... not very.  No, these are not iPhone glitches with which I took a photo.  It really is only red like red (in fact there should be white-red-blue-green).  And the switching is kind of sluggish, completely different from the required 50ms. <br><br>  What is the problem?  Again, the physicist's villain has tripped us up: in 180 microseconds (3ms / 16) the LED does not have time to ‚Äúlight up‚Äù.  The result is what is visible in the photo. <br><br>  What can be done?  Well, again, this suggests a solution ‚Äúon the forehead‚Äù - poking delays after ignition of the LED, so that it would catch fire.  In principle, the solution is good.  But it is better to first give a programmer on the head. <br><br>  What for?  Let's do a mental experiment and add 2 more LEDs.  If we used to have PWM with a filling of 25%, now it will be at 16%.  Adding four more will reduce to 10%.  This is how it will be necessary to turn up the frequency and how to make sex with delays, so that the resulting construction would work? <br><br>  Therefore, once again look at the algorithm.  He now looks like this <br><br>  <i>- turn on the current LED and turn off the rest</i> <i><br></i>  <i>- does the current led have something in the red channel?</i>  <i>if yes, then turn on the red channel, otherwise turn off</i> <i><br></i>  <i>- does the current led have something in the green channel?</i>  <i>if yes, then turn on the green channel, otherwise turn off</i> <i><br></i>  <i>- does the current led have something in the blue channel?</i>  <i>if yes, then turn on the blue channel, otherwise turn off</i> <i><br></i> <br><br>  And now we are going to cram more delays for each LED ... again we get flicker, again the frequency is raised.  Full professional incompetence and sobbing in a dark corner are waiting for us if we don‚Äôt think of a way out :) <br><br>  Since I do not want to cry, I change the algorithm for the next <br><br>  <i>- Turn on channel N (red, green, blue)</i> <i><br></i>  <i>- Should the current channel H be lit in the LED M (0,1,2,3, ...)?</i>  <i>If yes, then turn it on.</i>  <i>If not, turn it off.</i> <i><br></i>  <i>- Repeat the cycle for M</i> <i><br></i>  <i>- We'll wait for the last LED to turn on.</i> <i><br></i>  <i>- Repeat the cycle for H</i> <br><br>  It seems the difference is not big, but feel the difference: with any number of PWM LEDs for them will be with a filling of 33%.  We are checking. <br><br>  Code for one channel (the rest is completely similar).  Definitions can also be viewed in the full version, but I think the names will be clear. <br><br><pre> <code class="cpp hljs">_LEDR_=_LEDON_; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((lc[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; RED) == RED) _LED1_ = _LEDOFF_; <span class="hljs-comment"><span class="hljs-comment">// INVERTED! else _LED1_ = _LEDON_; if ((lc[1] &amp; RED) == RED) _LED2_ = _LEDOFF_; // INVERTED! else _LED2_ = _LEDON_; if ((lc[2] &amp; RED) == RED) _LED3_ = _LEDOFF_; // INVERTED! else _LED3_ = _LEDON_; if ((lc[3] &amp; RED) == RED) _LED4_ = _LEDOFF_; // INVERTED! else _LED4_ = _LEDON_; for(leds=0;leds&lt;80;leds++) current_led++; _LEDR_=_LEDOFF_;</span></span></code> </pre> <br><br>  And we admire. <br><br><img src="//habrastorage.org/files/719/471/433/71947143309842739e4e0da023e075ca.jpg"><br><br>  It is not so clearly seen in the photograph, but in reality green turned green and blue turned blue. <br><br>  Well now we change to "almost like in the final." <br><br><pre> <code class="cpp hljs">setLed(<span class="hljs-number"><span class="hljs-number">3</span></span>,RED+GREEN+BLUE); setLed(<span class="hljs-number"><span class="hljs-number">2</span></span>,GREEN); setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>,RED); __delay_ms(<span class="hljs-number"><span class="hljs-number">100</span></span>); setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>,OFF); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>,BLUE); __delay_ms(<span class="hljs-number"><span class="hljs-number">100</span></span>); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>,OFF);</code> </pre><br><br>  Chandelier winks!  Headlight shines!  And the bottom is all green!  In general, complete and unconditional success in our endeavors.  We are cool!  What else is needed for motivation?  :) Get a little silence :) A preliminary demonstration of the results to the customer received full approval and allocation of additional amounts of resources for work (‚ÄúDad, I will behave very quietly for two evenings‚Äù and other parent blackmail) <br><br>  Bonus for this business: almost NYPD blinking standard <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> c; setLed(<span class="hljs-number"><span class="hljs-number">3</span></span>, RED + GREEN + BLUE); setLed(<span class="hljs-number"><span class="hljs-number">2</span></span>, GREEN); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>, RED); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>, OFF); __delay_ms(<span class="hljs-number"><span class="hljs-number">40</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c = <span class="hljs-number"><span class="hljs-number">0</span></span>; c &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; c++) { setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>, OFF); __delay_ms(<span class="hljs-number"><span class="hljs-number">10</span></span>); setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>, RED); __delay_ms(<span class="hljs-number"><span class="hljs-number">10</span></span>); } setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>, BLUE); setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>, OFF); __delay_ms(<span class="hljs-number"><span class="hljs-number">40</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c = <span class="hljs-number"><span class="hljs-number">0</span></span>; c &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; c++) { setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>, OFF); __delay_ms(<span class="hljs-number"><span class="hljs-number">10</span></span>); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>, BLUE); __delay_ms(<span class="hljs-number"><span class="hljs-number">10</span></span>); } }</code> </pre> <br><br>  <i>The most thoughtful question for fights is: why does __delay_ms (_X_) in this case pause 5 times more than _X_ ms?</i> <br><br>  But that's not all.  Next, consider the most important question: <a href="http://habrahabr.ru/post/250537/">how to turn off this thing?</a> <br><br>  As usual, the complete set of everything lies here <a href="">multik.org/pic/policelight.rar</a> </div><p>Source: <a href="https://habr.com/ru/post/250229/">https://habr.com/ru/post/250229/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250217/index.html">Reduce development and testing time with Azure Web Sites and Visual Studio Online</a></li>
<li><a href="../250219/index.html">Technopark - 3 years</a></li>
<li><a href="../250221/index.html">Programmer fanatic</a></li>
<li><a href="../250223/index.html">The digest of interesting materials from the world of Drupal # 4</a></li>
<li><a href="../250227/index.html">Implementing a Reliable Udp Protocol for .Net</a></li>
<li><a href="../250231/index.html">We write full tweak for iOS using iOSOpenDev</a></li>
<li><a href="../250233/index.html">EveryLang - translate, check spelling, switch and show the current keyboard layout</a></li>
<li><a href="../250235/index.html">Oddities in the work of Yandex.Metro: debriefing and update applications</a></li>
<li><a href="../250237/index.html">HotSpot - margin notes</a></li>
<li><a href="../250239/index.html">Another way to compress CSS files</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>