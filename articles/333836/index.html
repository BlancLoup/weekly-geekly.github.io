<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Doom 3 source code analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="November 23, 2011 id Software has maintained its own tradition and published the source code of its previous engine. 

 This time it‚Äôs time for idTech...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Doom 3 source code analysis</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/8cd/366/8a7/8cd3668a72a918ed09acc9acd5913745.jpg" alt="image"><br><br>  November 23, 2011 id Software has maintained its own tradition and published the source code of its previous engine. <br><br>  This time it‚Äôs time for <a href="http://en.wikipedia.org/wiki/Id_Tech_4">idTech4</a> , which was used in Prey, in Quake 4 and, of course, in Doom 3. In just a few hours, more than 400 forks of the GitHub repository were created, people began to explore the internal mechanisms of the game or port it to other platforms.  I also decided to participate and created an <a href="http://fabiensanglard.net/doom3_macosx/index.php">Intel version for Mac OS X</a> , which John Carmack <a href="http://twitter.com/">kindly advertised</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In terms of cleanliness and commentary, this is the best release of the id Software code since the <a href="http://fabiensanglard.net/doomIphone/index.php">Doom iPhone</a> codebase (which was released later, and therefore commented better).  I highly recommend everyone to study this engine, compile it and experiment. <br><br>  Here are <a href="http://fabiensanglard.net/doom3/doom3_notes.txt">my notes</a> on what I understood.  As usual, I cleaned them up, I hope they will save someone a couple of hours and encourage someone to learn the code to improve their programming skills. <br><a name="habracut"></a><br><h1>  Part 1: Overview </h1> <br>  I noticed that I use more and more illustrations and less text to explain the codebase.  I used to use <a href="http://www.gliffy.com/">gliffy</a> for this, but it has annoying limitations (for example, the lack of an alpha channel).  I am thinking of creating my own tool based on SVG and Javascript specifically for illustrations on 3D engines.  I wonder if there is something like that already?  Well, okay, back to the code ... <br><br><h2>  Introduction </h2><br>  Very nice to get access to the source code of this amazing engine.  At the time of release in 2004, Doom III set new graphics and sound standards for real-time engines, the most notable of which was Unified Lighting and Shadows.  For the first time, technology has allowed artists to express themselves on a Hollywood scale.  Even eight years later, the first encounter with HellKnight at Delta-Labs-4 still looks incredibly spectacular: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/julDSrdOBQI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  First contact </h2><br>  The source code is now distributed via Github, which is good, because the id Software FTP server was almost always down or overloaded. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e82/968/5e8/e829685e80401c97f5c0ee2e90889d64.png"><br><br>  <a href="">The original</a> TTimo <a href="">release</a> is normally compiled using Visual Studio 2010 Professional.  Unfortunately, MFC is missing in Visual Studio 2010 and therefore cannot be used.  After the release it was somewhat disappointing, but since then the <a href="https://bugzilla.icculus.org/show_bug.cgi%3Fid%3D5290">dependencies have been removed</a> . <br><br> <code>Windows 7 : <br> =========== <br> <br> <br> <br> git clone https://github.com/TTimo/doom3.gpl.git</code> <br> <br><img src="https://habrastorage.org/getpro/habr/post_images/3aa/51d/e97/3aa51de9743e8458f5f80bb982f78daa.png"><br><br>  To read and study the code, I prefer to use XCode 4.0 on Mac OS X: the search speed from SpotLight, highlighting variables and ‚ÄúCommand-Click‚Äù to go to the right place make work more convenient than in Visual Studio.  The XCode project was broken during the release, but it is <a href="http://fabiensanglard.net/doom3_macosx/index.php">very easy to fix</a> , and now there is the Github repository of the ‚Äúbad sector‚Äù user, which works well on Mac OS X Lion. <br><br> <code>MacOS X : <br> ========= <br> <br> <br> <br> git clone https://github.com/badsector/Doom3-for-MacOSX-</code> <br> <br>  <u><b>Notes:</b></u> it turned out that highlighting of variables and the transition to Control-Click are also available in Visual Studio 2010 after installing <a href="http://blogs.msdn.com/b/kirillosenkov/archive/2010/06/07/copy-code-in-html-format-with-visual-studio-2010.aspx">Visual Studio 2010 Productivity Power Tools</a> .  I do not understand why this is not in the ‚Äúvanilla‚Äù installation package. <br><br>  Both code bases are now in the best condition: <b>one click is enough to build an executable file!</b> <br><br><ul><li>  Download the code. </li><li>  Press F8 / Command-B. </li><li>  You can run! </li></ul><br>  <b><u>An interesting fact:</u></b> to start the game you need the <code>base</code> folder with Doom 3 resources. I didn‚Äôt want to waste time extracting them from the Doom 3 CDs and updating them, so I downloaded the version from Steam.  It seems that the guys from id Software did the same, because in the debug settings of the published Visual Studio project there is still <code>"+set fs_basepath C:\Program Files (x86)\Steam\steamapps\common\doom 3"</code> ! <br><br>  <b><u>Interesting fact:</u></b> The engine was developed in Visual Studio .NET ( <a href="http://www.iddevnet.com/doom3/code.php">source code</a> ).  But there is not a single C # line in the code, and the published version requires Visual Studio 2010 Professional to be compiled. <br><br>  <b><u>Interesting fact:</u></b> The Id Software team seems to be fans of the Matrix franchise: Quake III's working title was Trinity, and Doom III's working name was Neo.  This explains why all the source code is in the <code>neo</code> subfolder. <br><br><h2>  Architecture </h2><br>  The game is divided into projects reflecting the overall architecture of the engine: <br><br><table><tbody><tr><th>  Projects <br></th><th colspan="2">  Assembly <br></th><th width="400">  Notes <br></th></tr><tr><td></td><th>  Windows <br></th><th>  Mac os x <br></th><td></td></tr><tr><td>  Game <br></td><td>  gamex86.dll <br></td><td>  gamex86.so <br></td><td>  Gameplay doom3 <br></td></tr><tr><td>  Game-d3xp <br></td><td>  gamex86.dll <br></td><td>  gamex86.so <br></td><td>  Doom3 eXPension gameplay (ressurection) <br></td></tr><tr><td>  Mayaimport <br></td><td>  Mayaimport.dll <br></td><td>  - </td><td>  Part of the resource creation toolchain: it loads at runtime to open Maya files and import monsters, camera routes and maps. <br></td></tr><tr><td>  Doom3 <br></td><td>  Doom3.exe <br></td><td>  Doom3.app <br></td><td>  Doom 3 engine <br></td></tr><tr><td>  TypeInfo <br></td><td>  TypeInfo.exe <br></td><td>  - </td><td>  An internal auxiliary RTTI file: generates a <code>GameTypeInfo.h</code> , a map of all types of Doom3 classes with the size of each element.  This allows you to debug memory using the TypeInfo class. <br></td></tr><tr><td>  CurlLib <br></td><td>  CurlLib.lib <br></td><td>  - </td><td>  HTTP client used to download files (statically linked with gamex86.dll and doom3.exe). <br></td></tr><tr><td>  idLib <br></td><td>  idLib.lib <br></td><td>  idLib.a <br></td><td>  Id software library.  Includes a parser, a lexical analyzer, a dictionary ... (statically linked to gamex86.dll and doom3.exe). <br></td></tr></tbody></table><br>  As in all other engines, starting with idTech2, we see one binary file with closed source (doom.exe) and one open source dynamic library (gamex86.dll): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/34c/f16/b65/34cf16b6539e2aad012911dec699ec14.png"><br><br>  Most of the codebase was available from October 2004 in the <a href="http://www.iddevnet.com/">Doom3 SDK</a> , only the source code of the Doom3 executable file was missing.  Modders could build <code>idlib.a</code> and <code>gamex86.dll</code> , but the engine core was still closed. <br><br>  <u><b>Note:</b></u> The engine does not use the standard C ++ library: all containers (map, list with pointers ...) are re-implemented, but <code>libc</code> is actively used. <br><br>  <u><b>Note:</b></u> In the Game module, each class inherits idClass.  This allows the engine to perform internal RTTI and create instances of classes by class name. <br><br>  <u><b>Interesting fact:</b></u> If you look at the illustration, you will notice that some necessary frameworks (such as <code>Filesystem</code> ) are located in the Doom3.exe project.  This presents a problem, because gamex86.dll must load and resources.  These subsystems are dynamically loaded by the gamex86.dll library from doom3.exe (this is what the arrow in the illustration means).  If you open the DLL in PE explorer, you can see that gamex86.dll exports one method: <code>GetGameAPI</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/df1/3c1/19f/df13c119f6185a9c06c346d76ce8248b.png"><br><br>  Everything works in the same way as <a href="http://fabiensanglard.net/quake2/quake2Polymorphism.php">Quake2 loaded the renderer and gaming ddl</a> , passing pointers to objects: <br><br>  When Doom3.exe is loaded, it: <br><br><ul><li>  Loads the DLL into the process memory space using <code>LoadLibrary</code> . </li><li>  Retrieves the <code>GetGameAPI</code> address in dll using <code>GetProcAddress</code> win32. </li><li>  Calls <code>GetGameAPI</code> . </li></ul><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-function">gameExport_t * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGameAPI_t</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( gameImport_t *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">import</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>;</code> </pre> <br>  At the end of this ‚Äúconnection setup‚Äù, Doom3.exe has a pointer to an <code>idGame</code> object, and Game.dll has a pointer to a <code>gameImport_t</code> object, which contains additional links to all missing subsystems, for example <code>idFileSystem</code> . <br><br>  How Gamex86 sees objects in the Doom 3 executable: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> version; <span class="hljs-comment"><span class="hljs-comment">//  API idSys * sys; //    idCommon * common; //  idCmdSystem * cmdSystem //    idCVarSystem * cvarSystem; //    idFileSystem * fileSystem; //   idNetworkSystem * networkSystem; //   idRenderSystem * renderSystem; //   idSoundSystem * soundSystem; //   idRenderModelManager * renderModelManager; //    idUserInterfaceManager * uiManager; //    idDeclManager * declManager; //   idAASFileManager * AASFileManager; //   AAS idCollisionModelManager * collisionModelManager; //    } gameImport_t;</span></span></code> </pre> <br>  How Doom 3 sees Game / Modd objects: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> version; <span class="hljs-comment"><span class="hljs-comment">//  API idGame * game; //     idGameEdit * gameEdit; //     } gameExport_t;</span></span></code> </pre> <br>  <u><b>Notes: An</b></u> excellent resource for a better understanding of each subsystem is the <a href="http://www.iddevnet.com/doom3/code.php">Doom3 SDK documentation page</a> : it looks like it was written in 2004 by a person with a deep understanding of the code (that is, most likely, one of the development team). <br><br><h2>  Code </h2><br>  Before parsing, here are some statistics from <code>cloc</code> : <br><br> <code>./cloc-1.56.pl neo <br> <br> 2180 text files. <br> 2002 unique files. <br> 626 files ignored. <br> <br> http://cloc.sourceforge.net v 1.56 T=19.0 s (77.9 files/s, 47576.6 lines/s) <br> <br> ------------------------------------------------------------------------------- <br> Language files blank comment code <br> ------------------------------------------------------------------------------- <br> C++ 517 87078 113107 366433 <br> C/C++ Header 617 29833 27176 111105 <br> C 171 11408 15566 53540 <br> Bourne Shell 29 5399 6516 39966 <br> make 43 1196 874 9121 <br> m4 10 1079 232 9025 <br> HTML 55 391 76 4142 <br> Objective C++ 6 709 656 2606 <br> Perl 10 523 411 2380 <br> yacc 1 95 97 912 <br> Python 10 108 182 895 <br> Objective C 1 145 20 768 <br> DOS Batch 5 0 0 61 <br> Teamcenter def 4 3 0 51 <br> Lisp 1 5 20 25 <br> awk 1 2 1 17 <br> ------------------------------------------------------------------------------- <br> SUM: 1481 137974 164934 601047 <br> -------------------------------------------------------------------------------</code> <br>  By the number of lines of code, it is usually impossible to say anything definite, but here it will be very useful for evaluating the work needed to understand the engine.  In the code of 601 047 lines, that is, the engine is twice "more difficult" to understand than Quake III.  Some statistics about the history of id Software engines in the number of lines of code: <br><table><tbody><tr><td>  Code lines </td><td>  Doom </td><td>  idTech1 </td><td>  idTech2 </td><td>  idTech3 </td><td>  idTech4 </td></tr><tr><td>  Engine </td><td>  39079 </td><td>  143855 </td><td>  135788 </td><td>  239398 </td><td>  601032 </td></tr><tr><td>  Instruments </td><td>  341 </td><td>  11155 </td><td>  28140 </td><td>  128417 </td><td>  - </td></tr><tr><td>  Total </td><td>  39420 </td><td>  155010 </td><td>  163928 </td><td>  367815 </td><td>  601032 </td></tr></tbody></table><br><img src="https://habrastorage.org/getpro/habr/post_images/973/5e2/6ed/9735e26ed5dc2929ed6defee06022960.png"><br><br>  <u><b>Note:</b></u> A significant increase in volume in idTech3 was due to the tools from the lcc codebase (the C compiler was used to generate QVM bytecode). <br><br>  <u><b>Note:</b></u> For Doom3, the tools are not counted, because they are included in the engine code base. <br><br>  At a high level, you can see a couple of funny facts: <br><br><ul><li>  For the first time in the history of id Software, the code was written in C ++ and not in C. John Carmack <a href="http://fabiensanglard.net/doom3/interviews.php">explained this</a> in an interview. <br></li><li>  In the code abstraction and polymorphism are actively used.  But an interesting trick allows you to avoid a decrease in vtable performance on some objects. </li><li>  All resources are stored in human readable text format.  No more binaries.  The code is actively used lexical analyzer / parser.  John Carmack <a href="http://fabiensanglard.net/doom3/interviews.php">spoke about this</a> in an interview. </li><li>  Templates are used in low-level helper classes (mostly in idLib), but never applied at the upper levels, so code, unlike Google V8, does not cause the eyes to bleed. </li><li>  From the point of view of commenting, this is the second quality code base of id software, only the <a href="http://fabiensanglard.net/doomIphone/index.php">Doom iPhone is</a> better, perhaps because it came out later on Doom3.  30% of comments are still an outstanding result, it is very rare to find such a well-documented project!  In some parts of the code (see the dmap section), there are more comments than code. </li><li>  OOP encapsulation made the code cleaner and made it easier to read. </li><li>  The days of low-level assembly optimization are over.  Some tricks, for example, <code>idMath::InvSqrt</code> and spatial localization optimizations have been preserved, but mostly the code simply uses the available tools (GPU shaders, OpenGL VBO, SIMD, Altivec, SMP, L2 optimization ( <code>R_AddModelSurfaces</code> for processing models) ...). </li></ul><br>  It is also interesting to take a look at <a href="">the idTech4 Code Writing Standard</a> ( <a href="http://fd.fabiensanglard.net/doom3/CodeStyleConventions.pdf">mirror</a> ) written by John Carmack (I am especially grateful for comments on the location of <code>const</code> ). <br><br><h2>  Expand the loop </h2><br>  Here is an analysis of the main loop with the most important parts of the engine: <br><br><pre> <code class="cpp hljs"> idCommonLocal commonLocal; <span class="hljs-comment"><span class="hljs-comment">//    idCommon * common = &amp;commonLocal; //   ( Init   ,   ) int WINAPI WinMain( HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow ) { Sys_SetPhysicalWorkMemory( 192 &lt;&lt; 20, 1024 &lt;&lt; 20 ); //Min = 201,326,592 Max = 1,073,741,824 Sys_CreateConsole(); //   ,   :     "" ( )  . for (int i = 0; i &lt; MAX_CRITICAL_SECTIONS; i++ ) { InitializeCriticalSection( &amp;win32.criticalSections[i] ); } common-&gt;Init( 0, NULL, lpCmdLine ); //    VRAM (   OpenGL,   ) Sys_StartAsyncThread(){ //     . while ( 1 ){ usleep( 16666 ); //   60  common-&gt;Async(); //   Sys_TriggerEvent( TRIGGER_EVENT_ONE ); //   ,   pthread_testcancel(); // ,       (  ). } } Sys_ShowConsole while( 1 ){ Win_Frame(); // /  common-&gt;Frame(){ session-&gt;Frame() //   { for (int i = 0 ; i &lt; gameTicsToRun ; i++ ) RunGameTic(){ game-&gt;RunFrame( &amp;cmd ); //         GameX86.dll. for( ent = activeEntities.Next(); ent != NULL; ent = ent-&gt;activeNode.Next() ) ent-&gt;GetPhysics()-&gt;UpdateTime( time ); //    } } session-&gt;UpdateScreen( false ); //     { renderSystem-&gt;BeginFrame idGame::Draw //  .     ! renderSystem-&gt;EndFrame R_IssueRenderCommands //  .     . } } } }</span></span></code> </pre> <br>  Read more about the completely disassembled cycle <a href="http://fabiensanglard.net/doom3/doom3_unrolled.php">here</a> .  When reading the code, I used it as a map. <br><br>  This is the standard for the id Software engines main cycle.  With the exception of <code>Sys_StartAsyncThread</code> , which means that Doom3 is multi-threaded.  The task of this stream is the management of time-critical functions that the engine should not limit with the frame rate: <br><br><ul><li>  Sound mixing. </li><li>  Generation of user input. </li></ul><br>  <u><b>Interesting fact:</b></u> all idTech4 high-level objects are abstract classes with virtual methods.  Typically, this reduces performance, because the address of each virtual method before calling it at runtime must be found in the vtable.  But there is a ‚Äútrick‚Äù to avoid this.  Instances of all objects are statically created as follows: <br><br><pre> <code class="cpp hljs"> idCommonLocal commonLocal; <span class="hljs-comment"><span class="hljs-comment">//  idCommon * common = &amp;commonLocal; //   gamex86.dll</span></span></code> </pre> <br>  Since the object that is statically placed in the data segment is of a known type, the compiler can optimize the search in vtable by calling the <code>commonLocal</code> methods.  When installing the connection (handshake), the interface pointer is used, so <code>doom3.exe</code> can exchange links to objects with <code>gamex86.dll</code> , but in this case the search costs in vtable are not optimized. <br><br>  <u><b>Interesting fact:</b></u> Having studied most of id Software's engines, I find it remarkable that one method name has NEVER changed since the doom1 engine: the method that reads mouse input and joystick data is still called <code>IN_frame()</code> . <br><br><h2>  Renderer </h2><br>  Two important parts: <br><br><ul><li>  Since Doom3 uses a portal system, the <code>dmap</code> completely different from the traditional bsp linker.  I have reviewed it below in the appropriate section. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/287/ab3/05d/287ab305d121667fbc763a4fffef4b29.png"></li><li>  The runtime renderer has a very interesting architecture.  It is divided into two parts with a frontend and a backend (for more details, see the ‚ÄúRenderer‚Äù section below). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/76b/577/fae/76b577fae03ec77054d0dc121087981c.png"></li></ul><br><h2>  Profiling </h2><br>  I used Xcode <a href="https://developer.apple.com/library/mac/">Instruments</a> to check what CPU cycles are doing.  For results and analysis, see the ‚ÄúProfiling‚Äù section below. <br><br><h2>  Scripting and Virtual Machine </h2><br>  In each idTech product, the VM and the scripting language changed completely ... and id did it again (for more, see the ‚ÄúScript VM‚Äù section) <br><br><h2>  Interview </h2><br>  While reading the code, I was puzzled by some innovations, so I wrote to John Carmack and he was so kind that he answered and explained the following features in detail: <br><br><ul><li>  C ++. </li><li>  Renderer splitting into two parts. </li><li>  Text resources. </li><li>  Interpreted bytecode. </li></ul><br>  In addition, I gathered on one page all the videos and interviews with the press about idTech4.  All of them are collected on <a href="http://fabiensanglard.net/doom3/interviews.php">the interview page</a> . <br><br><h1>  Part 2: Dmap </h1><br>  As with all id Software engines, maps created by a team of designers go through powerful pre-processing by the utility to increase performance at runtime. <br><br>  In idTech4, this utility is called <code>dmap</code> and its purpose is to read the soup from the polyhedrons from the <code>.map</code> file, define the areas connected by the portals and save them in the <code>.proc</code> file. <br><br>  The purpose of this tool is to use the runtime portal system in <code>doom3.exe</code> .  There is a terrific 1992 Seth Teller article: <a href="http://people.csail.mit.edu/seth/pubs/">"Visibility Computations in Densely Occluded Polyhedral Environment"</a> .  It describes in detail and with many illustrations how the idTech4 engine works. <br><br><h2>  Editor </h2><br>  Designers create level maps using CSG (Constructive Solid Geometry): they use polyhedra, usually having six faces, and place them on the map. <br><br>  These blocks are called brushes.  In the figure below, eight brushes are used (I will use the same map to explain each <code>dmap</code> step). <br><br>  The designer may well understand what is ‚Äúinside‚Äù (the first drawing), but <code>dmap</code> receives only a brush soup, in which there is nothing inside or outside (the second drawing). <br><br><table><tbody><tr><td>  What the designer sees </td><td>  What does <code>Dmap</code> see when reading brushes from a <code>.map</code> file? </td></tr><tr><td><img src="https://habrastorage.org/getpro/habr/post_images/b9a/4dd/e7f/b9a4dde7f40f300c9350a206d6b7a5f6.png"><br></td><td><img src="https://habrastorage.org/getpro/habr/post_images/61f/7a6/c7b/61f7a6c7b65907863d7f8e4623c0c0a8.png"><br></td></tr></tbody></table><br><img src="https://habrastorage.org/getpro/habr/post_images/f0d/195/70e/f0d19570e0c8b4dd3823cb6aa9845fe8.png"><br><br>  A brush is determined not through faces, but through planes.  Defining planes instead of faces may seem inefficient, but it will be very useful later when checking whether two surfaces are on the same plane.  There are no internal and external parts, because the planes are not oriented equally.  The orientation of the planes may be different inside or outside the volume. <br><br><h2>  Code review </h2><br>  Dmap source code is very well commented, just look at this number: comments more than code! <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( uEntity_t *e, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> floodFill )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">bspface_t</span></span> *faces; <span class="hljs-comment"><span class="hljs-comment">//  bsp-     //    faces = MakeStructuralBspFaceList ( e-&gt;primitives ); e-&gt;tree = FaceBSP( faces ); //      , //     MakeTreePortals( e-&gt;tree ); //        FilterBrushesIntoTree( e ); // ,   bsp  if ( floodFill &amp;&amp; !dmapGlobals.noFlood ) { if ( FloodEntities( e-&gt;tree ) ) { //     FillOutside( e ); } else { common-&gt;Printf ( "**********************\n" ); common-&gt;Warning( "******* leaked *******" ); common-&gt;Printf ( "**********************\n" ); LeakFile( e-&gt;tree ); //     // "" ,    // -noFlood return false; } } //         //        , //         ClipSidesByTree( e ); //  ,     //  ,        FloodAreas( e ); //     BSP-     ,   //      ,  //     PutPrimitivesInAreas( e ); //         //      , //        //  Prelight( e ); //  -    T-  if ( !dmapGlobals.noOptimize ) { OptimizeEntity( e ); } else if ( !dmapGlobals.noTJunc ) { FixEntityTjunctions( e ); } //   -    FixGlobalTjunctions( e ); return true; }</span></span></code> </pre> <br><h2>  0. Load Level Geometry </h2><br>  The <code>.map</code> file is a list of entities.  The level is the first entity in the file that has the class "worldspawn".  An entity contains a list of primitives, which are almost always brushes.  The remaining entities are light sources, monsters, player spawn points, weapons, etc. <br><br><pre> <code class="cpp hljs"> Version <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">//  0 { "classname" "worldspawn" //  0 { brushDef3 { ( 0 0 -1 -272 ) ( ( 0.0078125 0 -8.5 ) ( 0 0.03125 -16 ) ) "textures/base_wall/stelabwafer1" 0 0 0 ( 0 0 1 -56 ) ( ( 0.0078125 0 -8.5 ) ( 0 0.03125 16 ) ) "textures/base_wall/stelabwafer1" 0 0 0 ( 0 -1 0 -3776) ( ( 0.0078125 0 4 ) ( 0 0.03125 0 ) ) "textures/base_wall/stelabwafer1" 0 0 0 ( -1 0 0 192 ) ( ( 0.0078125 0 8.5 ) ( 0 0.03125 0 ) ) "textures/base_wall/stelabwafer1" 0 0 0 ( 0 1 0 3712 ) ( ( 0.006944 0 4.7 ) ( 0 0.034 1.90) ) "textures/base_wall/stelabwafer1" 0 0 0 ( 1 0 0 -560 ) ( ( 0.0078125 0 -4 ) ( 0 0.03125 0 ) ) "textures/base_wall/stelabwafer1" 0 0 0 } } //  1 { brushDef3 } //  2 { brushDef3 } } . . . //  37 { "classname" "light" "name" "light_51585" "origin" "48 1972 -52" "texture" "lights/round_sin" "_color" "0.55 0.06 0.01" "light_radius" "32 32 32" "light_center" "1 3 -1" }</span></span></code> </pre> <br>  Each brush is described as a set of planes.  The sides of the brush are called faces (or bends), each of which is obtained by trimming the plane with all the other planes of the brush. <br><br>  <u><b>Note: The</b></u> very interesting and fast Plane Hashing System is used during the boot phase: <code>idHashIndex</code> created on top of <code>idPlaneSet</code> , which you should look at. <br><br><h2>  1. MakeStructuralBspFaceList and FaceBSP </h2><br>  The first step is to cut the map using the binary space partitioning method (Binary Space Partition).  Each non-transparent face of the card is used as a dividing plane. <br><br>  The following heuristics are used to select a separator: <br><br>  <b>1:</b> if the map contains more than 5000 units: we cut it with the help of an axis-oriented plane (Axis Aligned Plane) in the middle of the space.  In the figure below, the space 6000x6000 is cut three times. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dae/f83/f4b/daef83f4bdaa45f519a96804eb47fc11.png"><br><br>  <b>2:</b> When there are no more parts left over 5000 units: we use faces marked as ‚Äúportals‚Äù (they have the <code>textures/editor/visportal</code> ).  In the figure below the portals are marked in blue. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a9e/0c9/6d5/a9e0c96d53b7e39e74de65fec0ad343b.png"><br><br>  <b>3:</b> Use the remaining faces.  We select the edge that is the most collinear with the majority of others. And we cut the smallest faces.  Also preference is given to axial dividers.  Separation planes are marked in red. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/870/f03/7fd/870f037fda8d6bd72fbec34c7a921200.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b0c/571/e83/b0c571e83afddeee9478a477d72ef845.png"><br><br>  The process ends when there are no available faces: the entire sheet of the BSP-tree is a convex subspace: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dae/dd9/871/daedd9871e6b4ba27b4ec7c0f9c00f9f.png"><br><br><h2>  2. MakeTreePortals </h2><br>  Now the map is divided into convex subspaces, but these subspaces do not know anything about each other.  The goal of this stage is to connect each of the leaves with its neighbors using the automatic creation of portals.  The idea is to start with six portals that restrict the map: connect the ‚Äúexternal‚Äù with the ‚Äúinternal‚Äù (with the BSP root).  Then, for each node in the BSP, we divide each portal in the node, add a dividing plane as a portal, and repeat it recursively. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/10f/287/232/10f2872327879aaf61c1202803ecb9da.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/5d2/817/005/5d28170054ea5deb1d5394033c6955b6.png"><br><br>        ,  .    ,  ,      :         . <br><br>        -¬´¬ª  BSP-.             .  ,       ,       ¬´¬ª   ¬´¬ª. <br><br>          ,       : <br><br>    BSP         ,    ,   : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/288/d0d/f6c/288d0df6c031a17bb72eb5afb38540e4.png"><br><br><h2> 3. FilterBrushesIntoTree </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/63e/2e1/2fc/63e2e12fc84c411617aa550ce71b616b.jpg"><br><br>          ,  BSP ‚Äî  ,   ‚Äî  .      BSP   <b></b> . <br><br>      :      ,   ,   EPSILON,         ,       . <br><br>  ¬´¬ª  ¬´¬ª    . <br><br> ,   ,   ()    . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/54e/951/da6/54e951da6ca8caa17aa2ea74950a5939.png"><br><br><h2> 4. FloodEntities  FillOutside </h2><br>           .      . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/971/26e/93b/97126e93bb9196140894929139989eef.png"><br><br>   FillOutside        ,     <b></b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b51/aa0/fc5/b51aa0fc533faee0b6721792637f9d6e.png"><br><br>   ,      ,  :             . <br><br><h2> 5. ClipSidesByTree </h2><br>      :        BSP.      ,   .        <code>visibleHull</code> . <br><br>     ¬´¬ª ,    . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b64/5ac/4e3/b645ac4e3141d392f546f34df6faf3e0.png"><br><br>          <code>visibleHull</code> . <br><br><h2> 6. FloodAreas </h2><br>  <code>dmap</code>     :      .      ,   . <br><br>     <u> </u> :   ,        visportals ( ,    1).   <code>dmap</code>             . <br><br>          .       ()   ,    visportal (,   areaportal),  ,   : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/86c/7bd/164/86c7bd164cf8a7db0a0ec7de8a6abb4d.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/315/371/fa3/315371fa3c9b9e94ee5f5fa0fc178545.png"><br><br>              (). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/287/ab3/05d/287ab305d121667fbc763a4fffef4b29.png"><br><br><h2> 7. PutPrimitivesInAreas </h2><br>        ¬´ ¬ª  ,    6  visibleHull,    5:     ‚Äî  ,   ‚Äî  visibleHull. <br><br>      visibleHull      BSP:        areaID. <br><br> <b><u>:</u></b>    ‚Äî       .      ¬´func_static¬ª,        .    ¬´¬ª ,      (     ). <br><br><h2> 8. Prelight </h2><br>      <code>dmap</code>     .        <code>.proc</code> .     ,       <code>"_prelight_light"</code> ,     ,         <code>.map</code>      <code>.proc</code> : <br><br><pre> <code class="cpp hljs"> shadowModel { <span class="hljs-comment"><span class="hljs-comment">/* name = */</span></span> <span class="hljs-string"><span class="hljs-string">"_prelight_light_2900"</span></span> <span class="hljs-comment"><span class="hljs-comment">/* numVerts = */</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-comment"><span class="hljs-comment">/* noCaps = */</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-comment"><span class="hljs-comment">/* noFrontCaps = */</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span> <span class="hljs-comment"><span class="hljs-comment">/* numIndexes = */</span></span> <span class="hljs-number"><span class="hljs-number">96</span></span> <span class="hljs-comment"><span class="hljs-comment">/* planeBits = */</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">183.125</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">183.125</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1013.34375</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">184</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1013.34375</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">184</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1010</span></span> <span class="hljs-number"><span class="hljs-number">978</span></span> <span class="hljs-number"><span class="hljs-number">184</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">184</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1013.34375</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">168</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1013.34375</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">168</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">168.875</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">168.875</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1010</span></span> <span class="hljs-number"><span class="hljs-number">978</span></span> <span class="hljs-number"><span class="hljs-number">168</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">167.3043518066</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">183.125</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">183.125</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1010</span></span> <span class="hljs-number"><span class="hljs-number">978</span></span> <span class="hljs-number"><span class="hljs-number">184</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">184</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">981.34375</span></span> <span class="hljs-number"><span class="hljs-number">184</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">981.34375</span></span> <span class="hljs-number"><span class="hljs-number">184</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">981.34375</span></span> <span class="hljs-number"><span class="hljs-number">168</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">981.34375</span></span> <span class="hljs-number"><span class="hljs-number">168</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1010</span></span> <span class="hljs-number"><span class="hljs-number">978</span></span> <span class="hljs-number"><span class="hljs-number">168</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">167.3043518066</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">168.875</span></span> ) ( <span class="hljs-number"><span class="hljs-number">-1008</span></span> <span class="hljs-number"><span class="hljs-number">976</span></span> <span class="hljs-number"><span class="hljs-number">168.875</span></span> ) <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> }</code> </pre> <br><h2> 9. FixGlobalTjunctions </h2><br>  -        ,   idTech4   :            . -   . <br><br><h2> 10.   </h2><br>          <code>.proc</code> : <br><br><ul><li>         . </li><li> BSP-  areaID  . </li><li>   . </li><li>  . </li></ul><br><h2>  Story </h2><br>     <code>dmap</code>   <a href="">,     </a> Quake ( <code>qbsp.exe</code> ), Quake 2 ( <code>q2bsp.exe</code> )  Quake 3 ( <code>q3bsp.exe</code> ).    ,     (PVS)      : <br><br><ul><li> <code>qbsp.exe</code>  <code>.map</code>    <code>.prt</code> ,         BSP (     2 ¬´MakeTreePortals¬ª). </li><li> <code>vis.exe</code>   <code>.prt</code>   .   : <br><ul><li>        . </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> before filling into a sheet: a visibility check was performed by cutting off the next portal with two previous portals relative to the visibility pyramid (many believed that visibility is determined by the emission of thousands of rays, but this is a myth that many people believe now). </font></font></li></ul></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The illustration is always better: let's say I </font></font><code>qbsp.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">found six leaves connected by portals and is now executed </font></font><code>vis.exe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to generate PVS. </font><font style="vertical-align: inherit;">This process will be performed for each sheet, but in this example we will consider only sheet 1. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/273/69f/5c6/27369f5c6fc5305a383c3428836634f8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the sheet is always visible from itself, the initial PVS for sheet 1 will be as follows:</font></font><br><table><tbody><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sheet identifier </font></font></td><td>  one </td><td>  2 </td><td>  3 </td><td>  four </td><td>  five </td><td>  6 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bit Vector (PVS for Sheet 1) </font></font></td><td>  one </td><td>  ? </td><td>  ? </td><td>  ? </td><td>  ? </td><td>  ? </td></tr></tbody></table><br>    :    ,         ,      .  ,     3   PVS: <br><br><table><tbody><tr><td>   </td><td>  one </td><td>  2 </td><td>  3 </td><td>  four </td><td>  five </td><td>  6 </td></tr><tr><td>   (PVS   1) </td><td>  one </td><td>  one </td><td>  one </td><td>  ? </td><td>  ? </td><td>  ? </td></tr></tbody></table><br><img src="https://habrastorage.org/getpro/habr/post_images/a11/3a9/67b/a113a967b67b4655e878fd20b5dbe802.png"><br><br>   3        :      n-2   n-1,            . <br><br>    ,  ,    4  6   ,     5 .        6.   PVS   1  : <br><br><table><tbody><tr><td>   </td><td>  one </td><td>  2 </td><td>  3 </td><td>  four </td><td>  five </td><td>  6 </td></tr><tr><td>   (PVS   1) </td><td>  one </td><td>  one </td><td>  one </td><td>  0 </td><td>  one </td><td>  0 </td></tr></tbody></table><br>  idTech4 PVS  ,     .                   . <br><br> <u><b> :</b></u>        10          GDC Vault ( ): <br><br> <a href="http://www.gdcvault.com/play/1014234/Excerpt-Quake-Postmortem-Optimizing-Level"><img src="https://habrastorage.org/getpro/habr/post_images/91a/586/b8a/91a586b8a04b8ef3f53d017000477596.png"></a>  . <br><br><h1>  3:  </h1><br>   idTech4    : <br><br><ul><li> ¬´Unified Lighting and Shadows¬ª:           . </li><li> ¬´Visible Surface Determination¬ª:     VSD    ‚Äî   PVS. </li><li> ¬´Multi-pass Rendering¬ª. </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The most important in idTech4 has become a multi-pass renderer. The influence of each light source in the field of visibility is accumulated in the frame buffer of the video processor by means of additive mixing. Doom 3 takes full advantage of the fact that the color registers of the frame buffer perform saturation rather than transfer. </font><font style="vertical-align: inherit;">I created my own </font><a href=""><font style="vertical-align: inherit;">level</font></a><font style="vertical-align: inherit;"> to illustrate additive blending. The screenshot below shows three sources of light in the room, for which three passes are made. The result of each pass is accumulated in the frame buffer. Notice the white light in the center of the screen where all the light sources are mixed. </font><font style="vertical-align: inherit;">I changed the slider to isolate each pass: </font><i><font style="vertical-align: inherit;">Pass 1: blue light source </font></i><i><font style="vertical-align: inherit;">Pass 2: green light </font></i><i><font style="vertical-align: inherit;">Pass 3: red light</font></i></font><br><br> <code>  () : <br> ============================ <br> <br> 1111 1111 <br> + 0000 0100 <br> --------- <br> = 0000 0011 <br> <br>   () : <br> ========================== <br> <br> 1111 1111 <br> + 0000 0100 <br> --------- <br> = 1111 1111</code> <br> <br><font style="vertical-align: inherit;"></font><a href=""><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/56c/fe5/076/56cfe5076138129c620388e31a4b0fc6.jpg"><br><br><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/2a6/30b/0bd/2a630b0bdf61ba6983b0f43e004ed3fc.jpg"><br> <i><font style="vertical-align: inherit;"></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e1e/be0/9b3/e1ebe09b3432dea16fae64699fccb304.jpg"><br> <i><font style="vertical-align: inherit;"></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ac2/d46/643/ac2d46643763f5ee34a2cd9c538cf9c6.jpg"><br> <i><font style="vertical-align: inherit;"></font></i> <br><br>      ,          : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e1e/be0/9b3/e1ebe09b3432dea16fae64699fccb304.jpg"><br> <i>    </i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f47/0cb/479/f470cb4791e48bd09bcf3b3830e73ea3.jpg"><br> <i>     </i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56c/fe5/076/56cfe5076138129c620388e31a4b0fc6.jpg"><br> <i>     </i> <br><br> <u><b> :</b></u>       ,     Photoshop (Linear Dodge     OpenGL)   <a href="">   </a> . <br><br>           (bumpmapping)          2012 : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd7/09b/521/bd709b5217d11cf62633956c458988ed.png"><br><br><h2>  Architecture </h2><br>      idTech,   ,      (  ): <br><br><ul><li> : <br><ol><li>     ,     . </li><li>      ( <code>def_view_t</code> )  /     VBO . </li><li>   RC_DRAW_VIEW. </li></ol></li><li> : <br><ol><li>  RC_DRAW_VIEW    . </li><li>               VBO. </li></ol></li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/440/a32/342/440a32342349db9c7358a9e2bad3770b.png"><br><br>      <a href="http://en.wikipedia.org/wiki/LCC_(compiler)">- LCC</a> ,    -   Quake3: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/efc/ae1/62c/efcae162c81dfd9b244c16672dc32a73.png"><br><br>   ,       LCC,      ,   <a href="http://fabiensanglard.net/doom3/interviews.php">    </a>  SMP-.       ,   ‚Äî  .  , -                . <br><br> <u><b>   :</b></u>        ‚Äî       ,   ,     C++  C (    ): <br><br>   -  .  idTech4       Quake3 (   C),       C++.        idtech4  C++. <br><br>   Quake   Doom3?  ,   ,      Mac OS X: <br><br><pre> <code class="cpp hljs"> - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)quakeMain;</code> </pre> <br><h2> , ,    </h2><br>      ,   : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/76b/577/fae/76b577fae03ec77054d0dc121087981c.png"><br><br><ol><li>        : <br><ul><li> <b> </b> ,      ,    .          . </li><li>       ,      ,   <b> </b> .     VBO . </li></ul></li><li>     <b> </b> .             OpenGL   ,    .     VBO  . </li><li>    OpenGL     . </li></ol><br><h2>   Doom3 </h2><br>    :    (Visible Surface Determination, VSD).   ‚Äî       ,    .    <b></b> .    ,         (     ¬´ ¬ª).      <b> </b> ,        OpenGL. <br><br>  Here is how it looks in code: <br><br><pre> <code class="cpp hljs"> - idCommon::Frame - idSession::UpdateScreen - idSession::Draw - idGame::Draw - idPlayerView::RenderPlayerView - idPlayerView::SingleView - idRenderWorld::RenderScene - build params - ::R_RenderView(params) <span class="hljs-comment"><span class="hljs-comment">//   { R_SetViewMatrix R_SetupViewFrustum R_SetupProjection //    . static_cast&lt;idRenderWorldLocal *&gt;(parms-&gt;renderWorld)-&gt;FindViewLightsAndEntities() { PointInArea //  BSP     FlowViewThroughPortals //   ,      ,    . } R_ConstrainViewFrustum //   Z-      . R_AddLightSurfaces //  ,     ,    (  ) R_AddModelSurfaces //     ( ) R_RemoveUnecessaryViewLights R_SortDrawSurfs //   qsort  C.     C++   . R_GenerateSubViews R_AddDrawViewCmd }</span></span></code> </pre> <br> <u><b>:</b></u>     C  C++. <br><br>      ,   .    visplanes    : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a41/399/271/a4139927164795f5fa1ac05566c519b8.png"><br><br>   <code>.proc</code>    <code>.map</code> ,        .         ,    : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ea3/c02/b3b/ea3c02b3bf99d02b97e1183f3c756f5a.png"><br><br> <code>  1 : <br> ========= <br> <br> -  0 <br> -  1 <br> <br>   2 : <br> ========= <br> <br> -  1 <br> -  2 <br> -  3</code> <br> <br>           ,  .         . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b6d/98a/624/b6d98a624d991bb317d847e28ebab6a8.png"><br><br>     : <br><br><ol><li> ,       BSP-  <code>PointInArea</code> . </li><li> <code>FlowViewThroughPortals</code> :              .        .       <a href="http://www.realtimerendering.com/">Realtime rendering</a> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4de/060/c9b/4de060c9b3ca62906768b348ca3b936f.png"><br><br>        ,   ,  <u></u> ,    : <br><br> <code>  ( /) : <br> ================================== <br> <br>  1 -  0 <br>  1 -  1 <br>  1 -  1 <br> <br>  2 -  1 <br>  2 -  1</code> <br> <br>      :   ¬´ 2 ‚Äî  2¬ª,   2   . </li><li> <code>R_AddLightSurfaces</code>          ,    ,   . <br><br> <code>  ( /) : <br> ================================== <br> <br>  1 -  0 <br>  1 -  1 <br>  1 -  1 <br> <br>  2 -  1 <br>  2 -  1 <br>  2 -  2</code> </li> <li> <code>R_AddModelSurfaces</code> :   ,        VBO ,     .        (   ). </li><li>  ¬´¬ª  .   <code>R_AddDrawViewCmd</code>   <code>RC_DRAW_VIEW</code> ,      . </li></ol><br><h2>   Doom3 </h2><br>         : Doom3     : <br><br><ul><li> R10 (GeForce256) </li><li> R20 (GeForce3) </li><li> R200 (Radeon 8500) </li><li> ARB (OpenGL 1.X) </li><li> ARB2 (OpenGL 2.0) </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For 2012, only ARB2 is supported by modern video processors: standards ensured not only portability, but also increased the lifespan of the game. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the video card supported bumpmapping (a </font></font><a href="http://fabiensanglard.net/bumpMapping/index.php"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tutorial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on using Hellknight, which I wrote several years ago) and reflection maps, idtech4 included them, but they all tried </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to save pixel fillrate speed (fillrate) with the</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> following operations </font><u><font style="vertical-align: inherit;">as much as possible</font></u><font style="vertical-align: inherit;"> :</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OpenGL Scissor test (separately for each light source created by the front end) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Filling the Z-buffer in the first stage. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Below is the expanded backend code: </font></font><br><br><pre> <code class="cpp hljs"> idRenderSystemLocal::EndFrame R_IssueRenderCommands RB_ExecuteBackEndCommands RB_DrawView RB_ShowOverdraw RB_STD_DrawView { RB_BeginDrawingView <span class="hljs-comment"><span class="hljs-comment">//  z-,     .. RB_DetermineLightScale RB_STD_FillDepthBuffer //      ( )  . //        ,      _DrawInteractions { 5 GPU specific path switch (renderer) { R10 (GeForce256) R20 (geForce3) R200 (Radeon 8500) ARB (OpenGL 1.X) ARB2 (OpenGL 2.0) } //     qglStencilFunc( GL_ALWAYS, 128, 255 ); RB_STD_LightScale //        (, ,  ....) int processed = RB_STD_DrawShaderPasses( drawSurfs, numDrawSurfs ) //      RB_STD_FogAllLights(); //       _currentRender if ( processed &lt; numDrawSurfs ) RB_STD_DrawShaderPasses( drawSurfs+processed, numDrawSurfs-processed ); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To go step by step through the backend, I took the famous screen from the Doom3 level and stopped the engine at each stage of rendering: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae3/76c/367/ae376c367691a0702df1eaaa52c81625.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since Doom3 uses bumpmapping and reflection maps over diffuse textures, rendering the surface can use a search in three textures. </font><font style="vertical-align: inherit;">Up to 5-7 light sources can affect a pixel, so it‚Äôs not crazy to assume that up to 21 texture searches per pixel can be assumed ... even without redrawing. </font><font style="vertical-align: inherit;">The first stage of the backend is needed to achieve 0 redraws: turning off all shaders, writing only to the depth buffer and rendering the whole geometry: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d9/bc3/299/4d9bc3299e3728e76d1e133c0b32daf1.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The depth buffer is now full. </font><font style="vertical-align: inherit;">From this point on, the depth recording is disabled and the depth test is enabled.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rendering primarily in z-buffer may seem counterproductive, but in fact it is extremely useful to save fillrate: </font></font><br><br><ul><li>       . </li><li>       . </li><li>       (    ),     .      . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that the color buffer is cleared and filled with black: in its natural form, the world of Doom3 is totally black, because there is no ‚Äúambient‚Äù lighting ‚Äî to be visible, the polygon / surface must interact with the light source. That explains why Doom3 was so dark! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that, the engine will perform 11 passes (one for each light source. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I divided the rendering process into parts. The pictures below show each individual light source passage. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a0/cc1/512/4a0cc1512ac15deacac3115e826d9be2.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effect of light source 1 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/48f/285/7ac/48f2857aca26cf86974c418131e1eb56.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effect of light source 2 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ec5/a81/f17/ec5a81f17dae7ccab8c06ef47f4c85f8.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effect of light source 3 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/13b/265/ad2/13b265ad2695abf344e2721e57fa580e.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effect of light source 4 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/501/2b0/fe5/5012b0fe57795834f7cb3e75e40654ac.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effect of light source 5 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8cf/af0/4df/8cfaf04dff55de9e57e1b579b9ac81f3.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effect of light source 6 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cbe/29f/c9a/cbe29fc9a33b69b3d29b0bc9e1e9cdab.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effect of light source 7 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e37/fd1/568/e37fd1568bd7ad45453341982631d740.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effect of light source 8 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8fb/580/10a/8fb58010ab29a1b387104f6791ea2f64.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effect of light source 9</font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b99/82b/b93/b9982bb93b2b4abb6f4bec7f230e1ffe.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Influence of the light source 10 </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/56a/801/563/56a801563062dfe83d0faa857514e68f.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Influence of the light source 11 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6bd/a14/1dc/6bda141dc5a4af8e47f5a5c2c0de8e01.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Last pass: passage of ambient lighting</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And now what happens in the video processor frame buffer: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d0f/919/464/d0f9194642593832ce0f5c3fd56bd584.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After passing the light source 1 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6e2/d41/b2c/6e2d41b2ce970f1b76e99ae1313ee3e4.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After passing the light source 2 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/40d/eb3/716/40deb3716a23416459fe7f91a219bee6.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After passing the light source 3 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/551/b38/52c/551b3852c9bc99e0dac44e9043cfcc81.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After passing the light source 4 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6c6/eb9/637/6c6eb963787c71db0cd1f937c593953c.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After passing the light source 5 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f2/39d/bb9/6f239dbb990b273bcdc7aa29f565cf88.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the passage of the light source 6 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/020/448/198/020448198609065118ed8b88c0b786af.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after passage of the light source 7 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/96b/903/816/96b9038166fb7da3b7399fe8b88f3245.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after passage of the light source 8 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/073/1e2/bde/0731e2bde13a3e99e8e111f31af537ed.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after the passage of the light source 9 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/869/a12/1a7/869a121a74517267f6d82dbb452e7769.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after passage of the light source 10 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d26/0be/a0b/d260bea0b16c72298ee0c4aa87fb5aed.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after passage of the light source 11 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fb8/315/b20/fb8315b20977ad5a119930a432617e0a.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after passage of the light source 12 </font></font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae3/76c/367/ae376c367691a0702df1eaaa52c81625.jpg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R follows the light source 13 passes </font></font></i> <br><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buffer templates and Scissors test:</font></font></u> <br><br>     ,          .       depth-fail/depth pass     Creative Labs.           (depth pass),        . -       depth fail,   ‚Äî     ! <br><br>   fillrate,     ,     scissor test  OpenGL.       ,       -    . <br><br>         8.     ,        :    . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f0/24c/eb5/6f024ceb5e2cd147b821c8882927f9c0.png"><br><br>         7.   scissor   fillrate. <br><br> &lt;img src=¬´ <a href="">fd.fabiensanglard.net/doom3/renderer/DOOM3-Context3-Static-StencilBuffer2.png</a> ¬ª <br><br><h2>   </h2><br>    ‚Äî  <code>RB_STD_DrawShaderPasses</code> :    ,    .           .        .  ,       .  2004          .          ,   Doom III    : <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/grrM6vpUeFI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <u>Stages:</u> <br><br><ul><li>  . </li><li>   . </li><li>        . </li><li> ,     ,     ! </li></ul><br> ,       ,  ,   - . ,          ,       .  : idTech4          .    RoQ: ,      ,    id Software. <br><br> <b><u> :</u></b> <br><br>    RoQ    2005           : <br><br><ul><li>     30   . </li><li>     512x512:      </li><li>     <code>idCinematicLocal::ImageForTime</code>           OpenGL. </li></ul><br>              . <br><br> -  <a href="http://www.battleteam.net/tech/fis/docs/index.html"> </a>    <a href="http://www.battleteam.net/tech/fis/">   Doom 1</a> ! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/721/14c/393/72114c393cdc9f1d1b41855bb7ea2fe0.jpg"><br><br> <b><u> :</u></b>          Doom3 (,    ..). <br><br><h2>   ... </h2><br>   ‚Äî    ,     <a href="http://fabiensanglard.net/doom3/renderer.txt"> </a> . <br><br><h1>  4:  </h1><br>  XCode    : <a href="https://developer.apple.com/library/mac/">Instruments</a> .          (         ). <br><br><h2>  Overview </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/c58/58a/641/c5858a641ae8db1003d45ae22a9bd739.png"><br><br>       ,   : <br><br><ul><li>  ,       . </li><li>  ,          . </li><li>   ( 8% ),  CoreAudio      <code>idAudioHardwareOSX</code> (:      OpenAL,       ). </li></ul><br><h2>   </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/466/582/0e7/4665820e7f9b94646e4d4b1af40668da.png"><br><br>   Doom 3 ‚Ä¶ <code>QuakeMain</code> ! ,  ,  Quake 3  Mac OS X      .    : <br><br><ul><li> 65%     ( <code>UpdateScreen</code> ). </li><li> 25%   :    ,  id Software. </li></ul><br><h2>   </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/ef1/d7b/2a2/ef1d7b2a22bbdcdb3ae70082cb1b30be.png"><br><br> <u>     gamex86.dll ( game.dylib  Mac OS X):</u> <br><br>    25%   ,   .     : <br><br><ul><li>   ():       .  - ,  ,      . </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The physics engine is more complicated (linear complementarity solvers), and therefore more costly compared to previous games. </font><font style="vertical-align: inherit;">It is executed for each object and includes ragdoll modeling and resolving interactions.</font></font></li></ul><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Renderer </font></font></h2><br><img src="https://habrastorage.org/getpro/habr/post_images/dbe/c20/25b/dbec2025b88dc1526a402392a9fb1a58.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As written above, the renderer consists of two parts: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frontend ( </font></font><code>idSessionLocal::Draw</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) takes 43.9% of the rendering process. </font><font style="vertical-align: inherit;">It's worth noting that this </font></font><code>Draw</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is a rather inappropriate name, because the frontend does not perform a single OpenGL draw call!</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Backend ( </font></font><code>idRenderSessionLocale:EndFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) takes 55.9% of the rendering process.</font></font><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The load distribution is quite balanced, and this is not surprising: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The frontend performs many calculations relating to the definition of visible surfaces. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Also, the frontend is engaged in animating models and finding shadow silhouettes. </font></font></li><li>     . </li><li>              (:            <code>glDrawElements</code> ). </li></ul><br><h2> :  </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/d7d/2b5/e4e/d7d2b5e4eb9b15b5caa6db908089000d.png"><br><br> <u> :</u> <br><br> ,  ÃÅ   (91%)      VBO   ( <code>R_AddModelSurfaces</code> ).    (4%)          ( <code>R_AddLightSurfaces</code> ).   (2,9%)     :  BSP     . <br><br><h2> :  </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/300/45c/0d8/30045c0d8f4bd99640bc16653c7d3525.png"><br><br> <u> :</u> <br><br> ,      ( <code>GLimp_SwapBuffers</code> )       (10%)  ,         . 5% ‚Äî         ,      Z- ( <code>RB_STS_FillDepthBuffer</code> ). <br><br><h2>   </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/3ca/e33/028/3cae33028bc73431ebf7ffbdf18cd83d.png"><br><br>      Instruments    ,  <a href="">  </a> . <br><br><h1>  4:    </h1><br>  , <u></u>     idTech1  idTech3,   : <br><br><ul><li> idTech1: QuakeC,    . </li><li> idTech2: C,     x86 (  ). </li><li> idTech3: C,    LCC  -,   QVM (Quake Virtual Machine).   x86 -       . </li></ul><br> idTech4   ,   : <br><br><ul><li>     - ,   C++. </li><li>    ( typedef,   ). </li><li>  <u></u>    :   JIT-   ,   idTech3 (  <a href="http://fabiensanglard.net/doom3/interviews.php">   </a>  ). </li></ul><br>      <a href="http://www.iddevnet.com/doom3/script.php">  Doom3 Scripting SDK</a> . <br><br><h2>  Architecture </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is a general picture: </font></font><br><br> <u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilation:</font></font></b></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at boot time, </font></font><code>idCompiler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one predefined file </font><font style="vertical-align: inherit;">is </font><font style="vertical-align: inherit;">transferred </font></font><code>.script</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A series of directives </font></font><code>#include</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">creates a script stack containing the lines of all scripts and the source code of all functions. It is scanned </font></font><code>idLexer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, generating base tokens (tokens). Tokens come in </font></font><code>idParser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and generate one huge byte code that is stored in the singleton </font></font><code>idProgram</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: it represents the virtual machine's RAM and contains VM segments </font></font><code>.text</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>.data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ff/ed8/e5e/7ffed8e5ef3a2a00915e801d7cd14478.png"><br><br> <u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Virtual machine:</font></font></b></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> During execution, the engine assigns each thread the </font></font><code>idThread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">time of the real CPU (one after the other) until it reaches the end of the linked list. Each </font></font><code>idThread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contains</font></font><code>idInterpreter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">storing the state of the virtual machine CPU. </font><font style="vertical-align: inherit;">Unless the interpreter goes mad and does not perform more than 5 million instructions, it will not be able to empty the CPU: this is joint multitasking.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Compiler </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The compilation pipeline is similar to what you will see when reading any other compiler, such as Google V8 or Clang, except for the absence of a preprocessor. </font><font style="vertical-align: inherit;">Therefore, functions such as ‚Äúpass comments‚Äù, macros, directives (# include, # if) must be executed in the lexical analyzer and in the parser. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since it is </font></font><code>idLexer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actively used by the entire engine for parsing all text resources (maps, entities, camera routes), it is very primitive. </font><font style="vertical-align: inherit;">For example, it returns a total of five types of tokens:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TT_STRING </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TT_LITERAL </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TT_NUMBER </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TT_NAME </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TT_PUNCTUATION </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, the parser does much more work than in the ‚Äústandard‚Äù compiler pipeline. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When you start the game idCompiler loads the first script </font></font><code>script/doom_main.script</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the series </font></font><code>#include</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">creates a stack of scripts, connected into one huge script. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It seems that the engine parser is a standard descending parser with a recursive descent. </font><font style="vertical-align: inherit;">It seems that the grammar of the scripting language is LL (1), requiring 0 returns (even though the lexical analyzer has the ability to cancel the reading of one lexeme). </font><font style="vertical-align: inherit;">If you have already read </font></font><a href="http://www.amazon.ca/Compilers-Principles-Techniques-Alfred-Aho/dp/0201100886"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this book</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then do not get lost ... and if not, then this is a good reason to start to understand.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interpreter </font></font></h2><br>       <code>idThread</code> ,      ,   .     .  <code>idThread</code>  <code>idInterpreter</code> ,    ,    (  /,     ). <br><br>    <code>idInterpreter::Execute</code> ,       :   . <br><br><pre> <code class="cpp hljs"> idThread::Execute <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> idInterpreter::Execute(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { doneProcessing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( !doneProcessing &amp;&amp; !threadDying ) { instructionPointer++; st = &amp;gameLocal.program.GetStatement( instructionPointer ); <span class="hljs-comment"><span class="hljs-comment">//op -      (unsigned short),     65 535  switch( st-&gt;op ) { . . . } } }</span></span></code> </pre> <br>  ,  <code>idInterpreter</code>  ,    <code>idThread::Execute</code> ,     ,   .       <a href="https://habrahabr.ru/post/324550/">  Another World</a> . <br><br> <u><b> :</b></u> -      x86,        .       ,  Doom3     JIT-   x86,   Quake3. </div><p>Source: <a href="https://habr.com/ru/post/333836/">https://habr.com/ru/post/333836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333824/index.html">Microsoft Bot Framework on Linux under Node.JS</a></li>
<li><a href="../333828/index.html">Black Lambda of corporal Volkov: a new direction and grants for summer school</a></li>
<li><a href="../333830/index.html">Firstborn MEGA Accelerator: the year of free flight</a></li>
<li><a href="../333832/index.html">Prototyping Tools on Mac: Comparative Feature</a></li>
<li><a href="../333834/index.html">Preview RamblerFront & # 2</a></li>
<li><a href="../333838/index.html">Antivirus on batch file in the past „Ö° it's time to PowerShell sniffer</a></li>
<li><a href="../333840/index.html">The need to regulate the Internet of things</a></li>
<li><a href="../333842/index.html">Monitoring the work of production web studio</a></li>
<li><a href="../333844/index.html">PostgreSQL multi-tiered backup with Barman and synchronous transfer of transaction logs</a></li>
<li><a href="../333846/index.html">Photographing objects in C #: Chronicle and comparison of images, reconstruction of the state of the image</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>