<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home server - ESXi, paranoia</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear habrovchane! 

 On Habr√© many articles, about the configuration of certain pieces of the home server. I would like to share another opt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home server - ESXi, paranoia</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear habrovchane! <br><br>  On Habr√© many articles, about the configuration of certain pieces of the home server.  I would like to share another option for building a home network aimed at a sysadmin or developer.  This time based on ESXi. <br><br>  Anyone interested - welcome under cat. <br><a name="habracut"></a><br>  I will not talk about installing and configuring ESX and guest systems, because the network is full of articles on this topic, and the documentation on the official site is quite decent.  And I will tell you some ideas that I implemented at home and some subtleties.  But first things first. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's start with the server itself - <a href="http://www-03.ibm.com/systems/data/flash/systemx/hardware/tower/x3200M2/">IBM System X3200 M2</a> .  I got it almost for nothing.  I learned from a friend that his friend was selling some kind of server.  Phoned, met, and - voila, the server after a small modding, took the place of honor of the old typewriter based on another Celeron'a 1.8.  I should note, however, that the case was slightly dented, namely, the bottom of the front cover was missing, and there was no RAM inside.  But these are trifles.  It was more difficult to get 2 missing sleds to the basket.  There is no direct sale in the city, in specialized stores under the order - to wait 1.5 months and the amount is 1.5k apiece ... abandoned this idea.  I ordered from <a href="http://www.ebay.com/">China</a> for 500r with delivery, they came for the same 1.5 months. <br><br><h6>  Total we have: </h6><br><ol><li>  IBM System X3200 M2 Server <br><ul><li>  Intel¬Æ Xeon¬Æ X3320 2.5GHz </li><li>  4G DDR2 800MHz </li><li>  5 hard drives with a total capacity of about 2TB (no raid) </li><li>  ESXi </li></ul></li><li>  Asus F3SE laptop (replaces my computer with a stationary machine, except for the server I don‚Äôt have, in fact, this is my workplace and entertainment tool) </li><li>  LinkSys WRT54GS v7 access point (WAN, 4xLAN 100Mb, WiFi), flashed with <a href="http://www.dd-wrt.com/">dd-wrt</a> micro (oh, how much we experienced with it :)), </li><li>  WiFi phone - Nokia E52. </li></ol><br><br><h5>  <strong>Objectives of the final system:</strong> </h5><br><ol><li>  Maximum unload laptop software </li><li>  Provide a development platform and tests (the scheme is approximately as follows: installed, configured, tried, turned off; when needed, turned it on again) </li><li>  Together with network-facing services, provide a corporate level of server and data protection.  In the case of a functional / security dilemma, choose security. </li></ol><br><br>  So let's get down to the most interesting part.  From this point on, we assume that the server is connected to the network, operates 24/7, there is unlimited internet, ESXi is installed, several guest systems are created (win2k8 - 1 pc, winxp - 1 pc, Fedora 14 - N pc in the minimum configuration, or any other distribution to taste and color), if something starts somewhere (mc, nano, sudo, etc.), it means that it is already installed. <br><br><h6>  <strong>Step 1.</strong> Choosing a functional </h6><br>  What will we need? <br><ol><li>  Web server (Apache, IIS, GlassFish / Tomcat), </li><li>  DBMS (MSSQL, MySQL, FireBird, PostgreSQL), </li><li>  Torrent client, FlyLinkDC client, </li><li>  SSH access to all linux servers, RDP to one of the Win servers, </li><li>  File storage </li></ol><br><br><h6>  <strong>Step 2.</strong> Network Architecture </h6><br><br>  And that's what we should have about: <br><img src="http://s006.radikal.ru/i214/1104/5a/60ac19462e95.jpg" alt="image"><br><br>  I want to immediately warn the respected habrovchan from holivar on the organization of this network, it is dictated by some subjective requirements, and, so far, only its virtual part can change.  Sorry, but "it happened so historically."  However, constructive criticism is welcome.  I will consider in the future. <br><br>  As can be seen from the diagram, of all virtual machines, only one is connected to the physical network - GALAXY.  This server will be the gateway to all virtual machines, will monitor access to important ports (SSH, RDP) and also keep a variety of logs. <br><br><h6>  <strong>Step 3.</strong> Configure the gateway </h6><br>  Without further ado, I will lay out the firewall configuration file from my gateway, with a few changes.  Of course, all interfaces are raised, static IPs are configured, DNSs, gateways are registered, and the necessary NAT is configured at the point.  I am sorry, but all IP and ports are replaced or erased.  In this regard, I am paranoid if that.  :) <br><br>  <strong>firewall.sh</strong> <br> <code>#!/bin/sh <br> <br> modprobe ip_nat_ftp <br> modprobe ip_conntrack_ftp <br> modprobe nf_conntrack_tftp <br> <br> ipt='/sbin/iptables' <br> <br> home='#.#.#.#/24' <br> vmnet='#.#.#.#/24' <br> mehome='#.#.#.#' <br> mevmnet='#.#.#.#' <br> <br> venera='#.#.#.#' <br> <br> ${ipt} -F -t nat <br> ${ipt} -F -t filter <br> ${ipt} -F -t mangle <br> <br> #established <br> ${ipt} -t filter -A INPUT -p all -m state --state ESTABLISHED,RELATED -j ACCEPT <br> ${ipt} -t filter -A OUTPUT -p all -m state --state ESTABLISHED,RELATED -j ACCEPT <br> <br> #allow forwarding <br> echo "1" &gt; /proc/sys/net/ipv4/ip_forward <br> ${ipt} -t filter -P FORWARD DROP <br> <br> #log some new connections <br> ${ipt} -A INPUT -m state --state NEW -p tcp --dport 12121 -j LOG --log-level INFO --log-prefix "SSH-NEW : " <br> ${ipt} -A FORWARD -m state --state NEW -d ${venera} -j LOG --log-level INFO --log-prefix "VENERA : " <br> <br> #localhost <br> ${ipt} -t filter -A INPUT -i lo -j ACCEPT <br> <br> #icmp home <br> ${ipt} -t filter -A FORWARD -p icmp -s ${home} -j ACCEPT <br> ${ipt} -t filter -A FORWARD -p icmp -d ${home} -j ACCEPT <br> ${ipt} -t filter -A INPUT -p icmp -s ${home} -j ACCEPT <br> ${ipt} -t filter -A OUTPUT -p icmp -d ${home} -j ACCEPT <br> #icmp vmnet <br> ${ipt} -t filter -A FORWARD -p icmp -s ${vmnet} -j ACCEPT <br> <br> #dns tcp <br> ${ipt} -t filter -A INPUT -p tcp --sport 53 -j ACCEPT <br> ${ipt} -t filter -A OUTPUT -p tcp --dport 53 -j ACCEPT <br> ${ipt} -t filter -A FORWARD -p tcp --dport 53 -j ACCEPT <br> ${ipt} -t filter -A FORWARD -p tcp --sport 53 -j ACCEPT <br> <br> #dns udp <br> ${ipt} -t filter -A INPUT -p udp --sport 53 -j ACCEPT <br> ${ipt} -t filter -A OUTPUT -p udp --dport 53 -j ACCEPT <br> ${ipt} -t filter -A FORWARD -p udp --dport 53 -j ACCEPT <br> ${ipt} -t filter -A FORWARD -p udp --sport 53 -j ACCEPT <br> <br> #ssh <br> ${ipt} -t filter -A INPUT -p tcp --dport 12121 -j ACCEPT <br> <br> #nat venera (GlassFish[80-&gt;8080], SSH[3333-&gt;12121]) <br> ${ipt} -t nat -A PREROUTING -d ${mehome} -p tcp --dport 3333 -j DNAT --to ${venera}:12121 <br> ${ipt} -t nat -A PREROUTING -d ${mehome} -p tcp --dport 80 -j DNAT --to ${venera}:8080 <br> #${ipt} -t filter -A FORWARD -d ${venera} -p tcp --dport 8080 -j ACCEPT <br> ${ipt} -t nat -A POSTROUTING -s ${venera} -j SNAT --to-source ${mehome} <br> #firwarding for venera <br> ${ipt} -t filter -A FORWARD -s ${venera} -j ACCEPT <br> ${ipt} -t filter -A FORWARD -d ${venera} -p tcp --dport 12121 -j ACCEPT <br> ${ipt} -t filter -A FORWARD -d ${mehome} -p tcp --dport 80 -j ACCEPT <br> <br> # .         <br> ${ipt} -t filter -A OUTPUT -p all -j ACCEPT <br> <br> #    <br> ${ipt} -t filter -A INPUT -p all -j DROP <br> ${ipt} -t filter -A OUTPUT -p all -j DROP <br></code> <br><br>  By analogy with the VENERA server, we configure other servers, including excluding the necessary ports by the rules.  Please note that the <strong>third</strong> line is commented out on the <strong>nat venera</strong> block. <br>  It allows connections to SSH port 12121. It is commented out for the reason described below. <br><br><h6>  <strong>Step 4.</strong> Paranoia </h6><br>  The culmination of this story is the implementation of the <a href="http://en.wikipedia.org/wiki/Port_knocking">port knocking</a> technique. <br>  Perhaps one of you has come across this topic, but for one reason or another has rejected its implementation. <br>  <s>Who is lazy</s> Who can not go on the link above, in a nutshell I will tell what it is and what they eat with.  This technique allows you to open the desired port, only after knocking on a certain sequence of ports from the same IP.  Moreover, the ports of this sequence may not even be open.  A sufficient sign is the sending of a packet with a SYN flag to this port (well, or another, at your discretion).  After the sequence is correctly activated, the command that opens the desired port in the firewall is executed.  to close this port, it is necessary, according to the same technique, to knock in the same way on another sequence of ports. <br><br>  It goes without saying that ‚Äúeverything is already stolen before us‚Äù (C).  There is a daemon <a href="http://www.zeroflux.org/projects/knock">knockd</a> and a client with it that implements this functionality. <br>  Everything would be simple enough if I had not encountered a strange problem.  There is no binary under the RPM system (poke your nose, please, if I was looking bad). <br>  We download source codes, we unpack. <br><br> <code>./configure <br> make <br></code> <br><br>  We arrived, the source code is not compiled with the gcc error "PATH_MAX - undeclared" ... what to do?  :) <br>  Right.  Get into the source and see what's wrong there.  Fortunately, in addition to the service files, there are only 4 files: the implementation of the client, the server and the implementation of its own list (.h + .c).  After a brief reflection, I entered another one in the server file between the existing inclusions: <br> <code>#include &lt;limits.h&gt; <br></code> <br><br>  and it all worked :) <br>  By the way, people write from forums that under FreeBSD they install without problems from ports, but I haven't tried my own (yes, I have such a virtual machine for tests).  Please, unsubscribe about the objective results with the latest version. <br><br>  The knockd documentation is not bad.  The demon is simple, convenient, checked - it works.  So, with your permission, I will not describe it, but I will give an approximate config for this case with a firewall to complete the picture: <br> <code>[options] <br> logfile = /var/log/knockd.log <br> <br> [openSSH] <br> sequence = 1,2,3 <br> seq_timeout = 5 <br> command = /sbin/iptables -A FORWARD -s %IP% -p tcp --dport 8080 -j ACCEPT <br> tcpflags = syn <br> <br> [closeSSH] <br> sequence = 3,2,1 <br> seq_timeout = 5 <br> command = /sbin/iptables -D FORWARD -s %IP% -p tcp --dport 8080 -j ACCEPT <br> tcpflags = syn <br></code> <br><br>  At home I use several sequences to open different ports to different virtual machines.  Unfortunately, ports have chosen only TCP, because they can be connected with a simple telnet.  But as soon as I deal with the knockd mobile client for UDP, I will definitely do everything as needed. <br><br>  On the rest of the virtual machines we start the necessary services, set up everything as we like.  Do not forget to forward the necessary ports through the virtual gateway, and register something in /etc/knockd.conf, if necessary.  We use. <br><br><h2>  findings </h2><br>  This server I have since the end of January 2011.  What I just did not try to do / try on it.  And different services, and Gentoo, and FBSD, and GlassFish, and firewalls / nat, FireFox on a Windows machine via SSH + XMing, etc.  And all this in one car.  Now I can state with confidence that virtualization is awesome.  Unfortunately, I haven‚Äôt managed to try KVM and XEN yet (live sit with XEN doesn‚Äôt count - you need to feel with the handles), but running another hypervisor on the virtual machine ... even for my perverted brain, this is too much.  Apparently his time just did not come. <br><br>  Soon the USB zvukovuha will come from <a href="http://www.dealextreme.com/">another China</a> , and I will have a heaped alarm clock with a managed production calendar from 1Skey.  ^ _ ^ <br>  In general, who has the opportunity to put this miracle on a dedicated machine - dare.  Perhaps this topic will help someone set up a server at work.  Anyway, I will be glad that I helped. <br><br>  Thanks for attention. <br><br>  PS I do not claim 100% security of this scheme, but it is much better than open ports, it calms my paranoia and gives invaluable experience of long-term use.  Of course, the standard ports on the end servers are changed where possible.  There is a lack of a block by IP addresses of malicious brute force players, but this is still all ahead. <br><br>  <strong>UPD:</strong> I apologize if I did not choose the right blog.  Poke, please, nose better to put it? </div><p>Source: <a href="https://habr.com/ru/post/118316/">https://habr.com/ru/post/118316/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../118310/index.html">Node.js - a guide to convincing the authorities</a></li>
<li><a href="../118311/index.html">The concept of the visual image of the XXII Olympic and XI Paralympic Games 2014 is presented.</a></li>
<li><a href="../118313/index.html">Good Rules for Permission Design on File Servers</a></li>
<li><a href="../118314/index.html">Android 3.0 - this is not an accident!</a></li>
<li><a href="../118315/index.html">Two weeks with two cores</a></li>
<li><a href="../118317/index.html">What does DIPM for SSDs mean?</a></li>
<li><a href="../118318/index.html">Development of multitouch web applications</a></li>
<li><a href="../118319/index.html">Font Zoom and Layout</a></li>
<li><a href="../118321/index.html">Modding Yota Egg</a></li>
<li><a href="../118323/index.html">New model of the reader ABC n618</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>