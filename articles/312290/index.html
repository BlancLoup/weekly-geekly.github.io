<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The concept of a sandbox when developing extensions for the browser Google Chrome</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over 5 years of developing extensions for the Google Chrome browser, some experience has been accumulated that I would like to share in a series of ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The concept of a sandbox when developing extensions for the browser Google Chrome</h1><div class="post__text post__text-html js-mediator-article">  Over 5 years of developing extensions for the Google Chrome browser, some experience has been accumulated that I would like to share in a series of articles and, if possible, explain some subtleties and pitfalls, and describe how modern front-end technologies were successfully applied. <a name="habracut"></a><br><br><h3>  Part 1. </h3><br><h4>  Introduction </h4><br>  I encountered Google Chrome browser extensions in 2012, when I was actively buying goods from the Amazon showcase and it was awfully awkward to look for sellers who delivered goods to the Russian Federation and from whom it is most advantageous to buy based on the cost of delivery.  It was here that I decided to make life easier for myself, as well as for other customers, by creating an extension ‚ÄúAmazon ships to you‚Äù, about which there was even <a href="https://habrahabr.ru/post/196484/">an article on Habr√©</a> .  Over time, it became irrelevant, since  In the Amazon showcase, after a couple of years, normal filters were made and I removed it from the publication. <br><br>  Then it was time to use the <a href="https://music.yandex.ru/">Ya.Muzyka</a> and <a href="https://radio.yandex.ru/">Ya.Radio service</a> and I really didn‚Äôt have enough control of the player on the Ya.Muzyka website when he plays in the background tab, at least with hot keys.  As a result, I, as an experienced person, not having found analogues, decided to make an <a href="https://chrome.google.com/webstore/detail/%25D1%258F%25D0%25BD%25D0%25B4%25D0%25B5%25D0%25BA%25D1%2581%25D0%25BC%25D1%2583%25D0%25B7%25D1%258B%25D0%25BA%25D0%25B0-%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5-%25D0%25BF/gcfheefljlblchcfjlknidfimnfillec">extension</a> for this <a href="https://chrome.google.com/webstore/detail/%25D1%258F%25D0%25BD%25D0%25B4%25D0%25B5%25D0%25BA%25D1%2581%25D0%25BC%25D1%2583%25D0%25B7%25D1%258B%25D0%25BA%25D0%25B0-%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5-%25D0%25BF/gcfheefljlblchcfjlknidfimnfillec">‚ÄúYandex.Music - player control‚Äù</a> , which is my hobby to this day, despite the release of the <a href="https://chrome.google.com/webstore/detail/%25D1%258F%25D0%25BD%25D0%25B4%25D0%25B5%25D0%25BA%25D1%2581%25D0%25BC%25D1%2583%25D0%25B7%25D1%258B%25D0%25BA%25D0%25B0/kefiofndeiobnlbabkhfkfmgdhmhhfmc">official extension from Yandex</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is assumed that the reader should already be familiar with the basic structure of the extension elements ( <a href="https://developer.chrome.com/extensions/manifest">manifest.json</a> , <a href="https://developer.chrome.com/extensions/event_pages">background page</a> , <a href="https://developer.chrome.com/extensions/content_scripts">content script</a> , <a href="https://developer.chrome.com/extensions/browserAction">popup</a> ).  A brief educational program under the spoiler below. <br><br><div class="spoiler">  <b class="spoiler_title">Likbez on extensions</b> <div class="spoiler_text">  An extension is a software package that extends browser functionality.  It is distributed through the official <a href="https://chrome.google.com/webstore/">Chrome Web Store</a> , you can also download a local extension in the developer mode on the <a href="http://chrome//extensions/">chrome: // extensions /</a> page, but Google is struggling with them more and more tightening the nuts. <br><br><blockquote>  Previously, it was possible to use local extensions without problems, then the browser began to notify you of the presence of such extensions, but now such extensions are disabled by default when the browser is started and must be activated manually (which has annoyed the developers of extensions during active development). <br></blockquote><br><br>  All metadata extensions are described in the manifest, but nothing special is said about it, everything is described in the <a href="https://developer.chrome.com/extensions/manifest">documentation</a> . <br><br>  <a href="https://developer.chrome.com/extensions">The extension</a> consists of a background page ( <a href="https://developer.chrome.com/extensions/background_pages">background page</a> or <a href="https://developer.chrome.com/extensions/event_pages">event page</a> ), a <a href="https://developer.chrome.com/extensions/browserAction">pop-up window</a> , <a href="https://developer.chrome.com/extensions/options">a settings page</a> , a <a href="https://developer.chrome.com/extensions/content_scripts">content script</a> that is embedded on the target site, and specific <a href="https://developer.chrome.com/extensions/override">override pages</a> that override the standard browser pages: a history manager, bookmarks, a new page, etc. <br><br>  From the point of view of the UI, the extension contains a <a href="https://developer.chrome.com/extensions/browserAction">browserAction</a> (or <a href="https://developer.chrome.com/extensions/pageAction">pageAction</a> ) element - an icon on the browser panel to the right of the address bar, clicking on which can initiate an action or opens another UI element - a <a href="https://developer.chrome.com/extensions/browserAction">pop</a> - <a href="https://developer.chrome.com/extensions/browserAction">up window</a> .  Also on this icon you can display a <a href="https://developer.chrome.com/extensions/browserAction">badge</a> - an icon, for example, with the number of unread letters. <br><br>  The browser provides extensions with multiple <a href="https://developer.chrome.com/extensions/api_index">APIs</a> for various needs, for example, through the <a href="https://developer.chrome.com/extensions/tabs">chrome.tabs</a> API, you can access all tabs, close, open new ones, see tabs metadata, etc. <br><br>  Plus, there are certain <a href="https://developer.chrome.com/extensions/messaging">data transfer mechanisms</a> between different extension pages. <br></div></div><br><h4>  Sandboxes </h4><br>  A typical extension task is an extension of the functionality of a certain site, for which it is necessary to implement the code on the landing page.  Take for example Ya.Muzyku (hereinafter): to control the player on the site through the pop-up extension window (see screenshot No. 1), we need to track the opening of the page, then embed our code into it, which will later interact with js- code and DOM showcases and transfer all changes to the extension so that when a pop-up window opens, always display the current state of the player on the showcase.  This is where the important one appears that I would like to begin by telling and what the title of the section says: <b>sandboxes</b> . <br><br><img src="https://habrastorage.org/webt/wi/5z/y5/wi5zy5e1rxudedl924mpmex_uno.jpeg" alt="image"><br>  (screenshot number 1) <br><br>  The background extension page, being the main extension controller, with proper extensions ( <a href="https://developer.chrome.com/extensions/declare_permissions">tabs, activeTab</a> ) can track the opening of the <a href="https://music.yandex.ru/">music.yandex.ru</a> page using <a href="https://developer.chrome.com/extensions/tabs">chrome.tabs.onUpdated</a> and inject our code (content script) to the storefront via <a href="https://developer.chrome.com/extensions/tabs">chrome.tabs.executeScript</a> .  However, the embedded code is in its sandbox (B), from which there is access to the showcase DOM document, but not to the showcase js code that runs in its sandbox (A).  In theory, it would be possible to track changes in the DOM elements on the storefront to translate the current state into the extension (for example, the track has changed - take the name of the track from the DOM, the performer), but this does not work as we would like: with delays on updating the storefront, always present target DOM elements in the current storefront display and other things that, in actual use of the extension, make the data out of sync between the storefront and the display in the extension.  How do we get access to the showcase js-code (sandbox A)? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/r1/0e/b4/r10eb4pmen24a9ma1py984zsjd4.jpeg" alt="image"></div><br>  To implement js code in the sandbox A from the content script, the following ‚Äúhack‚Äù can help us (hereinafter es6 notation): <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">injectCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func, ...args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> script = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'script'</span></span>); script.textContent = <span class="hljs-string"><span class="hljs-string">'try {('</span></span> + func + <span class="hljs-string"><span class="hljs-string">')('</span></span> + args + <span class="hljs-string"><span class="hljs-string">'); } catch(e) {console.error("injected error", e);};'</span></span>; (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.head || <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.documentElement).appendChild(script); script.parentNode.removeChild(script); }</code> </pre> <br>  As a result, our content script can inject its code into the sandbox of the showcase js code in order to gain access to the storefront API and at a low level to access objects and events of the player, playlist, and other showcase entities.  But that's not all: the access to the API is obtained, for example, the start of playing the track our embedded code ‚Äúcaught‚Äù, but how can we transfer it back to the content script, which, in turn, has mechanisms for transferring data to the background extension page ? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jt/cg/zk/jtcgzkxkp2lvs1uaqznyckb7644.jpeg" alt="image"></div><br>  Alas, there is no access from sandbox A to sandbox B; in any case, it is unknown to me.  But this is not scary, because we remember what the content script has access to from its sandbox B: to the DOM showcase window, hence the exit: embedded in the sandbox A, the code can create arbitrary events: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.dispatchEvent(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomEvent(CUSTOM_EVENT_NAME, {<span class="hljs-attr"><span class="hljs-attr">detail</span></span>: payload}));</code> </pre><br>  And the content script can catch them: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.addEventListener(CUSTOM_EVENT_NAME, e =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(e.detail); <span class="hljs-comment"><span class="hljs-comment">//payload });</span></span></code> </pre><br>  It turns out this scheme: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/j7/1d/dj/j71ddjctje5i4qwamqap-utyqrm.jpeg" alt="image"></div><br>  After that, the content script sends this event to the background page using one of the mechanisms: <a href="https://developer.chrome.com/extensions/runtime">chrome.runtime.sendMessage</a> or <a href="https://developer.chrome.com/extensions/runtime">chrome.runtime.connect</a> .  Their difference is that the first method opens a channel, transmits data, closes the channel, while the second creates a permanent channel within which data transfer takes place.  When playing tracks, there is a constant transmission of progress events (current playback time), so the choice was obvious for me: to raise the permanent communication channel of the content script with the background page, which gives another not obvious bonus: control of loss of communication with the showcase for various reasons, from exceptions in the js code before closing the tab (although it is the closing of the tab that is easily tracked through <a href="https://developer.chrome.com/extensions/tabs">chrome.tabs.onRemoved</a> ). <br><br>  With these sandboxes finished, but that's not all: there is still a sandbox (B) of the background page and a sandbox (D) of the pop-up window.  Everything is a bit simpler, these sandboxes have access to each other through the API: <br><br><ul><li>  from the pop-up window, you can access the background page via <a href="https://developer.chrome.com/extensions/extension">chrome.extension.getBackgroundPage ()</a> </li><li>  from the background page, the pop-up window can be accessed via <a href="https://developer.chrome.com/extensions/extension">chrome.extension.getViews ({type: 'popup'})</a> </li></ul><br>  But there is an underwater stone: a pop-up window cannot, for example, add its event listener to the background page, but the above-described methods give access to each other's window object (since they are running in the same thread).  For consistency of intercommunications and for forced isolation of the background page code from the pop-up window code (otherwise popup can modify bg objects, which will disrupt the unidirectional flow of data from the content script to the background page to store the current state and from there to the pop-up window) raising the channel as between the content script and the background page. <br><br>  There is little code and examples, since  everything is in the documentation, to which I refer as much as possible for any references to methods and APIs, I don‚Äôt have anything to add here, because  I don‚Äôt pretend on the status of a tutorial (when you can copy all the code and earn something).  But the concept itself was worth chewing, because  Repeatedly explained to colleagues on the programmer‚Äôs workshop.  You can summarize the section with the following illustration: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ws/jo/ho/wsjohotbmllqjjk0tmxntamqxi4.jpeg" alt="image"></div><br>  In the next part, I plan to talk about the translation history of the extension <a href="https://chrome.google.com/webstore/detail/%25D1%258F%25D0%25BD%25D0%25B4%25D0%25B5%25D0%25BA%25D1%2581%25D0%25BC%25D1%2583%25D0%25B7%25D1%258B%25D0%25BA%25D0%25B0-%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5-%25D0%25BF/gcfheefljlblchcfjlknidfimnfillec">‚ÄúYandex.Music - player control"</a> for the now popular React + Redux, which, by the way, came up to display the player status in the pop-up extension window. </div><p>Source: <a href="https://habr.com/ru/post/312290/">https://habr.com/ru/post/312290/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312276/index.html">Results of the survey on the functions of the browser Vivaldi</a></li>
<li><a href="../312278/index.html">Analysis of the tasks of the first stage of selection to the school programmers HeadHunter 2016</a></li>
<li><a href="../312282/index.html">Prevent it: make life easier for the client and yourself at the same time</a></li>
<li><a href="../312286/index.html">Developing intelligent bots using the Microsoft Bot Framework, Azure Cognitive Services and NER systems. Part 1</a></li>
<li><a href="../312288/index.html">Do not think about seconds down</a></li>
<li><a href="../312292/index.html">Installing Mikrotik Cloud Hosted Router on VPS Hosting Digital Ocean</a></li>
<li><a href="../312294/index.html">What's wrong with the display of currency symbols in iOS</a></li>
<li><a href="../312296/index.html">The United States has transferred control of the domains to the world community: what does it mean</a></li>
<li><a href="../312300/index.html">We understand in MAVLink. Part 1</a></li>
<li><a href="../312302/index.html">We sit on a Java-hardcore: Free broadcast of the track Joker 2016 without cuts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>