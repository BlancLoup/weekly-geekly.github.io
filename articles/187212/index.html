<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Load Test with Go</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, Habrahabr. 
 You are probably familiar with JMeter . If in short - a very convenient tool for carrying out load testing, it has a huge...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Load Test with Go</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, Habrahabr. <br>  You are probably familiar with <a href="http://jmeter.apache.org/">JMeter</a> .  If in short - a very convenient tool for carrying out load testing, it has a huge functionality and many, many useful chips.  But the article is not about him. <br><br><h5>  How did it start </h5><br>  There is a pretty heavy node in our project, JMeter has been helping for a long time.  Profiling and optimization gave their profit, but everything came up against a small problem.  JMeter could not create a very large traffic, and if more precisely, after 10 seconds of the mode we need, OutOfMemory occurred and testing stopped, in some cases there was no problem, but the speed of sending requests noticeably decreased, while the CPU load was 400%, solved restarting the program.  It was extremely uncomfortable to use. <br>  So, we have a problem, and it needs to be solved, the first thing that came to mind was to make a mini-test that meets the minimum requirements.  It has long been interesting to try Go to taste.  This is how the go-meter application was born.  When writing, there were a lot of questions, answers to which either did not exist or they did not explain the problem, so I decided to share my experience and an example of working code, if you are interested, I‚Äôll ask for a tackle. <br><a name="habracut"></a><br><h5>  Foreword </h5><br>  I think writing that this language does not make sense, you can always see a <a href="http://tour.golang.org/">tour</a> of the <a href="http://www.youtube.com/watch%3Fv%3DytEkHepK08c">language</a> , which reveals the main elements.  How to install and configure the environment is also not worth it, everything is written in a completely understandable language in the <a href="http://golang.org/doc/code.html">documentation</a> . <br>  Why chose Go?  There are several criteria that are very important to me: it works quickly, cross-platform, there are streams that are easy to manage, unusual.  Of course, you say that you can write it in any other language.  I agree with you, but the task was not only to write, but also to learn something new. <br><br><h5>  Let's get started </h5><br>  Without hesitation, it was decided to store the test profile in JSON format, after running the application, the profile is read and testing is started.  During testing, a pivot table is displayed in the console (response time, number of requests per second, and the percentage of errors, warnings, and successful requests).  With JSON, everything is simple; to do this, you need to make structures for each element, open and read the file: <br><pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(this *Settings)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fileName </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { file, e := ioutil.ReadFile(fileName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e } e = json.Unmarshal(file, this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's go further.  After starting, we need to start the N-streams, and after working on each of them, aggregate the data, then output beautifully to the console.  For this in this interesting language there are Channels.  A kind of "pipe" between different streams.  No need for synchronization, locking, everything is done for us.  The idea is this: the thread sends the request, determines the result and reports it to the main thread, which in turn waits until all the threads have completed and output all the received data.  The streams will communicate by means of the structure transfer: <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Status <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { IsError <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsWarning <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsSuccess <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Duration *time.Duration Size <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> IsFinished <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Error *error FinishedAt *time.Time StartedAt *time.Time }</code> </pre><br>  Each thread we will have to perform an M-time HTTP request to the specified resource.  If we have a POST request, then still sending certain data that the user wants: <br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartThread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(setts *settings.Settings, source *Source, c </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">chan</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *Status)</span></span></span></span>{ iteration := setts.Threads.Iteration <span class="hljs-comment"><span class="hljs-comment">//  key, value    header := map[string]string{} for _, s := range setts.Request.Headers { keyValue := regexp.MustCompile("=").Split(s, -1) header[keyValue[0]] = keyValue[1] } sourceLen := len(*source) // URL url := setts.Remote.Protocol + "://" + setts.Remote.Host + ":" + strconv.Itoa(setts.Remote.Port) + setts.Request.Uri if iteration &lt; 0 { iteration = sourceLen } index := -1 for ;iteration &gt; 0; iteration-- { status := &amp;Status{false, false, false, nil, 0, false, nil, nil, nil} index++ if index &gt;= sourceLen { if setts.Request.Source.RestartOnEOF { index = 0 } else { index-- } } //     var s *bytes.Buffer if strings.ToLower(setts.Request.Method) != "get" { s = bytes.NewBuffer((*source)[index]) } // HTTP  req, err := http.NewRequest(setts.Request.Method, url, s); if err != nil { status.Error = &amp;err status.IsError = true c &lt;- status break } //  for k,v := range header { req.Header.Set(k,v) } //  startTime := time.Now() //  res, err := http.DefaultClient.Do(req); if err != nil { status.Error = &amp;err status.IsError = true c &lt;- status break } endTime := time.Now() //   status.FinishedAt = &amp;endTime status.StartedAt = &amp;startTime diff := endTime.Sub(startTime) //        3  (Error, Warning, Success) checkStatus(setts.Levels, res, diff, status) //  ioutil.ReadAll(res.Body) res.Body.Close() //   c &lt;- status //    ,   if setts.Threads.Delay &gt; 0 { sleep := time.Duration(setts.Threads.Delay) time.Sleep(time.Millisecond * sleep) } } //      status := &amp;Status{false, false, false, nil, 0, true, nil, nil, nil} c &lt;- status }</span></span></code> </pre><br><br>  It remains only to start our threads at program start and listen to the data from them. <br><pre> <code class="go hljs">c := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> *Status, iteration * setts.Threads.Count) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; setts.Threads.Count; i++{ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> StartThread(&amp;setts, source, c) } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := iteration * setts.Threads.Count; i&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> ; i-- { counter(&lt;-c) } fmt.Println(<span class="hljs-string"><span class="hljs-string">"Completed"</span></span>)</code> </pre><br><br><h5>  Instead of conclusion </h5><br>  These are the most interesting moments, in my opinion.  All source codes are available on <a href="https://github.com/a696385/go-meter">GitHub</a> , where you can see the whole cycle of work with an example of use.  In fact, this miracle has coped with this task with a vengeance. When generating traffic with a volume of 3 times more than was the case with JMeter, the processor load rarely exceeds 15%. <br>  If it will be interesting, I will tell about the process of writing HTTP Restfull Web service with storage in MongoDB and Redis. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/187212/">https://habr.com/ru/post/187212/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../187200/index.html">Services of P2P money transfer from card to card Visa and Mastercard</a></li>
<li><a href="../187202/index.html">VLC is back in the App Store</a></li>
<li><a href="../187204/index.html">Neato XV-21 Robot Vacuum Cleaner: Purchase in the USA, Delivery, Experience of Use</a></li>
<li><a href="../187208/index.html">Development of IntelliJ IDEA plugin. Part 3</a></li>
<li><a href="../187210/index.html">Chronic fatigue, apathy, seasonal ‚Äúdepression‚Äù and much more: a trivial reason</a></li>
<li><a href="../187214/index.html">KPHP from VK</a></li>
<li><a href="../187218/index.html">Interview with Thierry Carres, Chairman of the OpenStack Technical Committee and Release Manager</a></li>
<li><a href="../187222/index.html">REPL for Perl</a></li>
<li><a href="../187224/index.html">Development of IntelliJ IDEA plugin. Part 4</a></li>
<li><a href="../187226/index.html">Work with PEB and TEB</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>