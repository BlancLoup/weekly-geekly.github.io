<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The fastest SAX parser for python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suddenly I wanted to recount all xml-tags in 240 thousand xml-files with a total weight of 180 GB. Python - and quickly. 
 Task 
 In fact, I wanted to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The fastest SAX parser for python</h1><div class="post__text post__text-html js-mediator-article">  Suddenly I wanted to recount all xml-tags in 240 thousand xml-files with a total weight of 180 GB.  Python - and quickly. <a name="habracut"></a><br><h4>  Task </h4><br>  In fact, I wanted to estimate how much it would be possible to overtake the Library, whose name cannot be said out loud, from fb2 to the docbook.  In connection with the ‚Äúspecificity‚Äù of FB2, it is necessary to estimate which tags you can simply skip because of rarity.  Those.  just count the number of occurrences of each tag in all files. <br>  On the way, it was planned to compare different sax-parsers.  Unfortunately - testing failed, because  and xml.sax and lxml on the first fb2 broke.  As a result, xml.parsers.expat remained. <br>  Yes, and more - the * .fb2 files are packed into zip archives. <br><h4>  Initial data </h4><br>  The initial data is the snapshot of the Library as of 2013.02.01, drawn from the Internet: 242525 * .fb2 files with a total weight of 183909288096 bytes, packed into 56 zip archives with a total weight of 82540008 bytes. <br>  Platform: Asus X5DIJ (Pentium DualCore T4500 (2x2.30), 2GB RAM);  Fedora 18, python 2.7. <br><h4>  Code </h4><br>  Written in haste, with a claim to versatility: <br><pre><code class="hljs lua">#!/bin/env python # -*- coding: utf<span class="hljs-number"><span class="hljs-number">-8</span></span> -*- <span class="hljs-string"><span class="hljs-string">''</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-string"><span class="hljs-string">''</span></span> import sys, <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>, zipfile, hashlib, pprint import xml.parsers.expat, magic mime = magic.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(magic.MIME_TYPE) mime.<span class="hljs-built_in"><span class="hljs-built_in">load</span></span>() tags = dict() files = <span class="hljs-number"><span class="hljs-number">0</span></span> reload(sys) sys.setdefaultencoding(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) def start_element(name, attrs): tags[name] = tags[name] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tags <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> def parse_dir(fn): dirlist = <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.listdir(fn) dirlist.<span class="hljs-built_in"><span class="hljs-built_in">sort</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dirlist: parse_file(<span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>.join(fn, i)) def parse_file(fn): m = mime.file(fn) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m == <span class="hljs-string"><span class="hljs-string">'application/zip'</span></span>): parse_zip(fn) elif (m == <span class="hljs-string"><span class="hljs-string">'application/xml'</span></span>): parse_fb2(fn) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> &gt;&gt; sys.<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, <span class="hljs-string"><span class="hljs-string">'Unknown mime type (%s) of file %s'</span></span> % (m, fn) def parse_zip(fn): <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> &gt;&gt; sys.<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, <span class="hljs-string"><span class="hljs-string">'Zip:'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>.basename(fn) z = zipfile.ZipFile(fn, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) filelist = z.namelist() filelist.<span class="hljs-built_in"><span class="hljs-built_in">sort</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filelist: try: parse_fb2(z.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(n)) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> &gt;&gt; sys.<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, n except: <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> &gt;&gt; sys.<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, <span class="hljs-string"><span class="hljs-string">'X:'</span></span>, n def parse_fb2(fn): global files <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(fn, str): fn = <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(fn) parser = xml.parsers.expat.ParserCreate() parser.StartElementHandler = start_element parser.Parse(fn.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(), True) files += <span class="hljs-number"><span class="hljs-number">1</span></span> def print_result(): out = <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(<span class="hljs-string"><span class="hljs-string">'result.txt'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tags.iteritems(): out.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(u<span class="hljs-string"><span class="hljs-string">'%s\t%d\n'</span></span> % (k, v)) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> <span class="hljs-string"><span class="hljs-string">'Files:'</span></span>, files <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (__name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(sys.argv) != <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> &gt;&gt; sys.<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, <span class="hljs-string"><span class="hljs-string">'Usage: %s &lt;xmlfile|zipfile|folder&gt;'</span></span> % sys.argv[<span class="hljs-number"><span class="hljs-number">0</span></span>] sys.<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) src = sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>.isdir(src)): parse_dir(src) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: parse_file(src) print_result()</code> </pre> <br><h4>  results </h4><br>  We charge: <br><pre> <code class="hljs vbscript"><span class="hljs-built_in"><span class="hljs-built_in">time</span></span> nice ./thisfile.py ~/Torrent/....ec &gt; out.txt <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;<span class="hljs-built_in"><span class="hljs-built_in">err</span></span>.txt</code> </pre> <br>  We get: <br>  * Runtime - 74'15..45 "(a little work was done in parallel and music was listened to, essno); <br>  * It turned out that the processing speed is ~ 40 MB / s (or 58 cycles / byte) <br>  * 2584 * .fb2 files are dropped (though expat is a non validate parser, but not to the same degree ...) - ~ 10%; <br>  * in the file results.txt - which is not ... <br>  * well, actually, for the sake of which everything was started: out of 65 tags FB2 _ not only one is used (output-document-class);  You can skip a couple more (output, part, stylesheet);  the rest are applied from 10 thousand times. <br>  * according to rough estimates, reading files (with unpacking) takes 52%, parsing - 40%, processing start_element - 8%. <br><br>  And faster - can I?  On python. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/171447/">https://habr.com/ru/post/171447/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171435/index.html">Logic - the most interesting news gaming and IT-industry ‚Ññ16</a></li>
<li><a href="../171437/index.html">Object Oriented Design ... in CSS</a></li>
<li><a href="../171439/index.html">Some of the simplest principles of auto-vectorization</a></li>
<li><a href="../171441/index.html">Review of the mechanical mechanical keyboard Neo Zelia KB-87</a></li>
<li><a href="../171443/index.html">Using Qt Models</a></li>
<li><a href="../171449/index.html">Chrome Super Sync Sports Browser Game</a></li>
<li><a href="../171455/index.html">Europeans and European languages: translate or not translate?</a></li>
<li><a href="../171457/index.html">New builds of Ubuntu Touch are now laid out every day</a></li>
<li><a href="../171459/index.html">SublimeHaskell updated</a></li>
<li><a href="../171461/index.html">Chrome for Android plans to "speed up" by passing traffic through a remote server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>