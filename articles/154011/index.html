<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to speed up insert in sqlite</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. In my first Android application, I immediately encountered the need to work with the database. I needed to provide my users with a start-up ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to speed up insert in sqlite</h1><div class="post__text post__text-html js-mediator-article">  Good day.  In my first Android application, I immediately encountered the need to work with the database.  I needed to provide my users with a start-up data set (about 5,000-6,000 records), with which they could work out of the box.  It was decided to attach a text file with data in the form of JSON to the application, when it was first started, parse it and put it in the database.  How to do it wrong and how to rejoice in the performance gain after refactoring can be read further. <a name="habracut"></a><br><br>  I don‚Äôt want to tell a long story about the thorns that a person writing his first Java application had to go through, and also immediately under Android.  In my opinion, it is better not to bore you with stories, but go straight to the point.  After all, exactly for the answer you looked here? <br><br>  So what was.  DBHelper is implemented naiveton naively, and the database object was also stored in the same way: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DBHelper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLiteOpenHelper</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DBHelper instance; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> SQLiteDatabase db; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DBHelper </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DBHelper(Pleazzme.getAppContext()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SQLiteDatabase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDB</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (db == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) db = getInstance().getWritableDatabase(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> db; } ... }</code> </pre> <br>  In a separate AsyncTask, the parser was started, which in a cycle gave me an object with the save () method: <br><pre> <code class="java hljs">... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ContentValues values = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContentValues(); values.put(id, Id); values.put(name, Name); values.put(categoriesIds, App.gson.toJson(CategoriesIds)); values.put(datecreated, DateCreated.getTime()); Document.save(); values.put(document_id, Document.getId()); values.put(hasbarcode, hasBarcode); values.put(headofficeaddress, HeadOfficeAddress); values.put(phonenumbers, PhoneNumbers); values.put(website, WebSite); values.put(popularity, Popularity); values.put(keywords, Keywords); DBHelper.getDB().insertWithOnConflict(table, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, values, SQLiteDatabase.CONFLICT_REPLACE); } ...</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this scenario, I received the save object in the database for 40-50ms.  As a result, all the preservation poured me into 4 minutes minimum.  Naturally, this did not suit the users.  And I started smoking search engines and the Internet for a solution to speed up my inserts.  The answer was found <a href="http://www.outofwhatbox.com/blog/2010/12/android-using-databaseutils-inserthelper-for-faster-insertions-into-sqlite-database/">here</a> and in the <a href="http://sqlite.org/speed.html">documentation</a> . <br><br>  To speed up the process, the following steps were taken: <br><ul><li>  instead of using ContentValues ‚Äã‚Äãuse InsertHelper </li><li>  Before launching a large insert, turn off synchronization in the database, lock and put everything in one transaction </li><li>  for the correct operation of all of the above, it is necessary to transfer a database object pulled out in the async-type to the save () method of each object, otherwise we will get an action </li></ul><br><br>  Given that the code is much more eloquent, in the final design looks like this: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DBHelper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLiteOpenHelper</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DBHelper instance; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> SQLiteDatabase db; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DBHelper </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DBHelper(Pleazzme.getAppContext()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SQLiteDatabase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDB</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (db == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) db = getInstance().getWritableDatabase(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> db; } ... <span class="hljs-comment"><span class="hljs-comment">/*new code*/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bigDataBegin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SQLiteDatabase _db)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//_db.setLockingEnabled(false); //_db.execSQL("PRAGMA synchronous=0"); _db.beginTransaction(); } public static void bigDataEnd(SQLiteDatabase _db){ //_db.setLockingEnabled(true); //_db.execSQL("PRAGMA synchronous=1"); _db.setTransactionSuccessful(); _db.endTransaction(); } }</span></span></code> </pre><br><br>  The class of the saved object: <br><pre> <code class="java hljs">... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> InsertHelper ih; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SQLiteDatabase db)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ih == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) ih = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InsertHelper(db, table); ih.prepareForInsert(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ih.bind(ih.getColumnIndex(key), value); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NullPointerException e) { } ..... ih.execute(); ih.close(); } ...</code> </pre><br><br>  And so that all this good "soared" the code to save objects: <br><pre> <code class="java hljs">SQLiteDatabase database = DBHelper.getDB(); DBHelper.bigDataBegin(database); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; currSize; i++) { gson.fromJson(o, Data.class).save(database); } DBHelper.bigDataEnd(database);</code> </pre><br><br>  After all the manipulations and speed measurements, the result was as follows: <br><ul><li>  up to - 40ms per object </li><li>  after - 4ms to the site </li></ul><br><br>  I hope the information will be useful for someone.  At once I will say, first of all it is designed for novice programmers.  If someone can offer more effective options, I will be glad. <br><br>  <b>UPD.</b> <br>  In an unconscious burst of joy, I shared my discovery, as it turned out too soon.  After the tests, it turned out that in case of an attempt to add some data with another parallel thread, we will get ayay, in addition, some devices swear at attempts to use the pragma directly. <br><br>  Thus, it remains only to use one transaction (I commented out the error code).  In this form, it remains as safe as possible.  True, at the same time, it loses all sorts of claims for something that carries more information than documentation. <br><br>  Another interesting fact for me was that a noticeable performance increase was observed on powerful devices (SGS2 for example with 4.0.4 on board), despite the fact that the younger brothers (HTC Wildfire) did not show a significant increase ... </div><p>Source: <a href="https://habr.com/ru/post/154011/">https://habr.com/ru/post/154011/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154001/index.html">Paper layouts of browser interfaces, smartphones and tablets</a></li>
<li><a href="../154003/index.html">Writing a complex application on knockoutjs</a></li>
<li><a href="../154005/index.html">Responding to incidents in Internet banking systems - instructions from Group-IB</a></li>
<li><a href="../154007/index.html">Writing a module in C ++ for nodejs using the example of working with MySQL</a></li>
<li><a href="../154009/index.html">Clustering in the Rambler-Maps API</a></li>
<li><a href="../154013/index.html">Is the possibility of free editing a wiki an open door for proving the FSB?</a></li>
<li><a href="../154015/index.html">Game "Life" and the simulation of natural selection</a></li>
<li><a href="../154017/index.html">NAMT team car robot at Robokross 2012</a></li>
<li><a href="../154019/index.html">Functional programming in OOP</a></li>
<li><a href="../154021/index.html">Casting on models printed on a 3D printer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>