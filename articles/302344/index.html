<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Failover cluster of Windows Server in Microsoft Azure. Network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preface. This publication is a continuation of the topic of creating a Windows Server failover cluster in the Microsoft Azure cloud. This time the con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Failover cluster of Windows Server in Microsoft Azure. Network</h1><div class="post__text post__text-html js-mediator-article">  <i>Preface.</i>  <i>This publication is a <a href="https://habrahabr.ru/company/icl_services/blog/282822/">continuation of the topic of</a> creating a Windows Server failover cluster in the Microsoft Azure cloud.</i>  <i><a href="https://blogs.technet.microsoft.com/askcore/2015/06/24/building-windows-server-failover-cluster-on-azure-iaas-vm-part-2-network-and-creation/">This time the</a> conversation will go about the network.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e83/357/a84/e83357a84f6d4d4fa94143d0a7beece5.png"></div><br><br>  Hi, fans of clusters.  In my <a href="https://blogs.technet.microsoft.com/askcore/2015/06/24/windows-server-failover-cluster-on-azure-iaas-vm-part-1-storage/">previous article,</a> I talked about how to get around the limitations of the Microsoft Azure IaaS environment when preparing data storage for a Microsoft Windows failover cluster.  Let's now talk about another important part of creating a cluster - the network. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Before you begin, let's list a few basic network concepts in Azure.  Here are the terms that we need for an article on creating a cluster: <br><br>  <b>VIP (Virtual IP address)</b> : Public IP address of the cloud service.  It is also used by Azure Load Balancer, which distributes traffic before it is sent to the virtual machine. <br><br>  <b>DIP (Dynamic IP address)</b> : The internal IP address obtained by the virtual machine from Microsoft Azure DHCP. <br><br>  <b>Internal Load Balancer</b> : An internal Microsoft Azure balancer that distributes traffic between virtual machines inside a VNET or cloud service. <br><br>  <b>Endpoint</b> : Associates the VIP / DIP + port on the virtual machine with the port on the Azure Load Balancer for external traffic or the Internal Load Balancer for traffic inside the VNET (or cloud service). <br><br>  You can find more information about these terms and Azure networks in this blog: <br>  <b>VIPs, DIPs and PIPs in Microsoft Azure</b> <br>  <a href="http://blogs.msdn.com/b/cloud_solution_architect/archive/2014/11/08/vips-dips-and-pips-in-microsoft-azure.aspx">http://blogs.msdn.com/b/cloud_solution_architect/archive/2014/11/08/vips-dips-and-pips-in-microsoft-azure.aspx</a> <br><br>  OK, enough theory.  The data storage is ready and we know how networks work in Azure.  Are we ready to create a cluster?  Yes! <br><br>  Instead of using Failover Cluster Manager, I recommend using the New-Cluster cmdlet and specifying a static IP address when creating the cluster.  Using this method, you can add all cluster nodes and it is easier to figure out the IP address settings without performing additional actions through the Failover Cluster Manager. <br><br><pre><code class="cpp hljs">New-Cluster -Name DEMOCLUSTER -Node node1,node2 -StaticAddress <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span></code> </pre> <br><br>  <b>Note</b> : The static IP address assigned by the Cluster Name Object (CNO) is not intended to communicate over the network.  It is needed to perform the dependency required for CNO activation.  Therefore, you cannot, for example, ping this address, cannot resolve a DNS name, and cannot use CNO for management since its address is not available. <br><br>  If for some reason you do not want to use PowerShell, or if you are used to using the Failover Cluster Manager, you will have to take a few additional steps.  The difference when using Failover Cluster Manager instead of PowerShell is that you have to create a cluster with one node and add a second one later.  The reason is that CNO cannot be activated because it cannot get a unique IP address from Azure DHCP.  Instead, the CNO, when created via the Failover Cluster Manager, has the same IP address as the node on which the CNO resource is located.  This address will not allow the cluster to be activated, since it will be considered a duplicate (after all, it turns out that there are two objects in the network with the same address).  To solve this problem, you will have to create a cluster with one node, as mentioned above, and then manually set a new address for the CNO. <br><br>  <b>Example:</b> <br><br>  CNO DEMOCLUSTER is not active due to the fact that the IP address on which it depends is not available.  The reason is that the CNO receives a conflict at the address 10.0.0.4, since it is already occupied by the virtual machine itself. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fe3/5b2/98e/fe35b298e4f34a73ad8f994e0e68cecc.png" alt="image"></div><br><br>  To fix this, we need to set some other unused address from the same subnet in the resource settings, for example 10.0.0.7. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f57/4d5/dfb/f574d5dfb0da47be948e8ec3d3aa20a3.png" alt="image"></div><br><br>  After that we can activate the CNO resource. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/651/648/a43/651648a43cc8477484894e9148029439.png" alt="image"></div><br><br>  Now, we can add a second node to our cluster. <br><br>  When our cluster is ready, we can add a new service to it.  For this article, I use the File Server role, since it is at the same time one of the most common and easy to understand. <br><br>  <b>Note</b> : We do not recommend that you, in fact, use a clustered file server in Azure for reasons of limitations in performance and the cost of such a solution. <br><br>  Unlike the clusters that you deploy locally, I recommend that you stop all nodes and leave only one active.  This is necessary to avoid a situation where a role moves between nodes due to the fact that the VCO (Virtual Computer Object of the servers) will automatically receive the same IP address as the cluster node on which it is located and, thus, it will disconnect from error and move to the next node.  The situation is completely similar to what we discussed for the CNO. <br><br>  The screenshot below shows the result (we assigned the IP address 10.0.0.8 to our cluster) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/602/76f/419/60276f4197674da5b2e3289714d169e6.png" alt="image"></div><br><br>  Remember that this is all the same temporary IP address that we use to activate the cluster.  None of the virtual machines in our network, except the cluster node itself, will be able to access the cluster at this address.  The Azure network works in such a way that all traffic from the virtual machine comes back to it. <br><br>  The fun begins.  We need to use Azure Load Balancer so that this address can be used to connect clients with our cluster. <br><br>  Load Balancer is a network resource in Azure that distributes traffic between different virtual machines.  The address of the Load Balancer can be either an external VIP or an internal DIP.  Each virtual machine must have its own endpoint, to which the Load Balancer traffic will be directed.  Endpoint has two types of ports.  The first one is Regular ports for client-server interaction.  For example, port 445 for SMB on a file server or port 80 HTTP on a Web server.  The second type of port is Probe (default port is 59999).  The task of this port is to determine which of the cluster nodes is the active holder of the VCO.  Load Balancer regularly polls all cluster nodes via Probe (the default test interval is 10 seconds).  You should know which ports the application or service you are going to host on your cluster uses, since you will have to specify these ports in the endpoint settings, and then add the Probe port there.  After that you need to add this Probe port to the VCO address settings.  As a result, Load Balancer will direct traffic to the corresponding server port on which the VCO is active. All this needs to be done using PowerShell. <br><br>  <b>Note</b> : At the time of this writing, Microsoft is supporting only one cluster resource group in ctive / Passive mode.  The reason is that the VCO can use only the IP address of the cloud service (VIP) or the IP address of the internal Load Balancer.  This restriction is still in force, despite the fact that several VIP addresses can now be created in the cloud service. <br><br>  The diagram below shows the work of the Internal Load Balancer (ILB): <br><div style="text-align:center;"><img src="https://habrastorage.org/files/715/92c/ff6/71592cff6e64452487e847a0dc4c1f20.png" alt="image"></div><br><br>  In our example, we are creating a file cluster, so the port for the endpoint will be 445. We will choose the address of the ILB 10.0.0.8.  Let's see how to set it up. <br><br>  <b>Step 1: Add a cluster to the cloud service</b> <br><br>  These commands are executed on the machine that you use to manage your Microsoft Azure environment. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   $ServiceName = "demovm1-3va468p3" #   ,     .   .       ,    ,   PowerShell  get-azurevm.</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/files/60a/efb/99a/60aefb99ab1d4fe3a5fff77869c8e13e.png" alt="image"></div><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ILBName</span></span> = <span class="hljs-string"><span class="hljs-string">"DEMOILB"</span></span> <span class="hljs-comment"><span class="hljs-comment">#   ILB $SubnetName = "Subnet-1" #       $ILBStaticIP = "10.0.0.8" #  IP   ILB #  ILB,    Add-AzureInternalLoadBalancer -InternalLoadBalancerName $ILBName -SubnetName $SubnetName -ServiceName $ServiceName -StaticVNetIPAddress $ILBStaticIP #   Get-AzureInternalLoadBalancer ‚Äìservicename $ServiceName</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0e5/dce/61c/0e5dce61c55c483eadda6620d9d0d386.png" alt="image"></div><br><br>  <b>Step 2: Set up an endpoint for each node using the ILB.</b> <br><br>  These commands are executed on the machine that you use to manage your Microsoft Azure environment. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   $VMNodes = "DEMOVM1", ‚ÄúDEMOVM2" #   ,   $EndpointName = "SMB" #    endpoint $EndpointPort = "445" # public port  endpoint (   -  SMB) #  endpoint   445  probe  59999    .     .     ProbeIntervalInSeconds.       Load Balancer    . ForEach ($node in $VMNodes) { Get-AzureVM -ServiceName $ServiceName -Name $node | Add-AzureEndpoint -Name $EndpointName -LBSetName "$EndpointName-LB" -Protocol tcp -LocalPort $EndpointPort -PublicPort $EndpointPort -ProbePort 59999 -ProbeProtocol tcp -ProbeIntervalInSeconds 10 -InternalLoadBalancerName $ILBName -DirectServerReturn $true | Update-AzureVM } #   ForEach ($node in $VMNodes) { Get-AzureVM ‚ÄìServiceName $ServiceName ‚ÄìName $node | Get-AzureEndpoint | where-object {$_.name -eq "smb"} }</span></span></code> </pre><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a81/9b8/7a1/a819b87a12d548b79c3e2ed7b825f67d.png" alt="image"></div><br><br>  <b>Step 3: Update the VCO IP address settings with the selected Probe port.</b> <br><br>  These commands are executed on the cluster node.  <b>Option for Windows Server 2008 R2</b> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   $ClusterNetworkName = "Cluster Network 1" #    (  Get-ClusterNetwork  GUI,    ) $IPResourceName = ‚ÄúIP Address 10.0.0.0" # the IP Address resource name (Use get-clusterresource | where-object {$_.resourcetype -eq "IP Address"} or GUI to find the name) $ILBIP = ‚Äú10.0.0.8‚Äù # IP  ILB #   IP  VCO,    ILB cluster res $IPResourceName /priv enabledhcp=0 overrideaddressmatch=1 address=$ILBIP probeport=59999 subnetmask=255.255.255.255</span></span></code> </pre><br><br>  <b>Option for Windows Server 2012/2012 R2</b> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   $ClusterNetworkName = "Cluster Network 1" #    (  Get-ClusterNetwork  GUI,    ) $IPResourceName = ‚ÄúIP Address 10.0.0.0" #   IP  (  get-clusterresource | where-object {$_.resourcetype -eq "IP Address"}  GUI,    ) $ILBIP = ‚Äú10.0.0.8‚Äù # IP  ILB $params = @{"Address"="$ILBIP"; "ProbePort"="59999"; "SubnetMask"="255.255.255.255"; "Network"="$ClusterNetworkName"; "OverrideAddressMatch"=1; "EnableDhcp"=0} #   IP  VCO,    ILB Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple $params</span></span></code> </pre><br><br>  The result should be something like this: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/360/270/af2/360270af2b8d49e2baef2704b208f4b6.png" alt="image"></div><br><br>  Disable and re-enable the cluster resource IP address and run the cluster role. <br><br>  Your ILB is now associated with the VCO IP address.  The last thing you need to do is configure WIndows Firewall.  You need to set up rules allowing connections on port 59999 (or the one you chose) on all nodes of your cluster.  That's all.  Your cluster is ready to go.  Please note that the first connection to a VCO or an attempt to connect to it immediately after transferring roles from one node to another can take up to 10 seconds.  This is related to the value of the <b>ProbeIntervalInSeconds</b> parameter that we set earlier. <br><br>  In our example, we chose an internal IP address of 10.0.0.8 for VCO.  If you want to make your VCO accessible from the outside, you can use the external IP address of the cloud service (VIP).  The steps will be the same and easier because you can skip step 1 (Azure Load Balancer is already used for VIP).  You only need to create an endoint with the necessary ports on each cluster node (Step 2) and configure the VCO IP address (Step 3).  Remember that if your cluster is accessible from the outside, then you should pay more attention to its security settings. <br><br>  Fine!  You have created your cluster in an Azure IaaS environment.  It turned out quite long, but I hope you found it interesting and you learned something useful.  You can ask me questions in the comments. <br><br>  Good luck with clusters! <br><br>  Mario liu <br>  Support Escalation Engineer <br>  CSS Americas |  WINDOWS |  HIGH AVAILABILITY </div><p>Source: <a href="https://habr.com/ru/post/302344/">https://habr.com/ru/post/302344/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302334/index.html">GoTo hell. Summer Schools on Programming, Data Analysis and Robotics for the most stupid high school students</a></li>
<li><a href="../302336/index.html">How to unload a logically consistent data set from several tables in the database under OLTP load</a></li>
<li><a href="../302338/index.html">Intel Internet of Things Gateways: sending messages to a MQTT broker using Python</a></li>
<li><a href="../302340/index.html">How to communicate with customers and negotiate project work</a></li>
<li><a href="../302342/index.html">HP 3PAR Storage Lineup</a></li>
<li><a href="../302348/index.html">Sudden advertising in your video on Youtube: why it appears and how to remove it</a></li>
<li><a href="../302350/index.html">Linux for a novice developer or how to forget about Windows forever</a></li>
<li><a href="../302352/index.html">Why online promotion cannot guarantee N sales per month?</a></li>
<li><a href="../302354/index.html">Take part in the ‚ÄúData. Technology. SQL Server 2016 ¬ª</a></li>
<li><a href="../302356/index.html">We play sound on DualShock4 from the computer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>