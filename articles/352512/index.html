<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we in Smart Engines taught Sailfish OS recognition</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! As you already know from our articles, we in Smart Engines are engaged in recognition, and we try to recognize on anything and in any condition...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we in Smart Engines taught Sailfish OS recognition</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ka/qm/i5/kaqmi5cmdvhvdx2pz7m7bbs3iqg.png" width="80%" alt="Smart Engines and Sailfish OS"></div><br><p>  Hello!  As you already know from our articles, we in Smart Engines are engaged in recognition, and we try to recognize on anything and in any conditions.  We support all popular operating systems: iOS, Android, Windows, Linux, MacOS, Solaris.  We also support domestic producers: Elbrus and AstraLinux.  Our algorithms are optimized for ARMv7-v8, AArch64, x86, x86_64, SPARC, E2K, MIPS. </p><br><p>  Therefore, when we saw the growing popularity of the Russian operating system Sailfish Mobile OS RUS, we could not avoid it.  Sailfish Mobile OS RUS is a POSIX-compatible operating system for mobile devices, developed by the domestic company Open Mobile Platform for solving problems of corporate users and government agencies.  As of February 2018, it is the only mobile operating system included in the register of Russian software and certified by the Federal Security Service of the AK1 / KC1 class. </p><br><p>  In this article we will tell you about our experience of porting our <a href="http://smartengines.ru/smart-idreader/">Smart IDReader</a> ( <a href="http://smartengines.biz/ocr-products/">Hieroglyph</a> technology) to our recognition library on Sailfish OS.  It will contain code, links and videos.  We want this article to be technically informative and useful as a general instruction for those who port C ++ applications to Sailfish OS. </p><br><a name="habracut"></a><br><p>  We are grateful to colleagues from the <a href="http://omprussia.ru/">Open Mobile Platform</a> (OMP), Kirill Chuvilin and Alexey Andreev, for consultations in developing the application and providing two INOI R7 devices for testing and demonstration. </p><br><p>  TL; DR - porting was quick and easy.  In total, it took less than one working man-week from downloading Sailfish OS SDK to removing the first video with a demonstration of document recognition on the INOI R7 device (the video will be at the end of the article). </p><br><h3 id="ustanovka-instrumentariya">  Installation toolkit </h3><br><p>  The first step was to install the Sailfish OS SDK.  You can download the installation package from the <a href="https://sailfishos.org/wiki/Application_SDK">official site</a> , but we chose an even simpler method and installed the SDK from AUR, the Arch Linux user repository (the most popular Linux distribution among Smart Engines developers), in which, as usual, everything is there and installed in one command: </p><br><pre><code class="bash hljs">yaourt -S sailfishos-sdk-bin</code> </pre> <br><p>  Development tools include three main components: </p><br><ol><li>  Environment and build system - Oracle VM VirtualBox image containing installed compilers and libraries for building applications for a device or emulator. </li><li>  SailfishOS Emulator, similar to emulators for other mobile platforms (iOS, Android, ...) </li><li>  IDE is a well-known Qt Creator, completed to support interaction with the build system and launch the program on a device or emulator. </li></ol><br><p>  The connection to the virtual machine for building occurs via SSH.  The only problem was that when installing the SDK for the virtual machine and IDE, port <code>2222</code> hard-coded, which was already used for other purposes on the developer's computer.  In VirtualBox, this port changes in an understandable way, but in the IDE it was impossible to change it from the GUI.  Fortunately, it could be changed in the local settings <code>mersdk.xml</code> file: </p><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- ~/.config/SailfishOS-SDK/qtcreator/mersdk.xml --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"QString"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SshPort"</span></span></span><span class="hljs-tag">&gt;</span></span>2222<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  After solving this problem, Cyril was informed about this problem, and there were no further problems with the toolkit. </p><br><h3 id="sborka-s-yadra-raspoznavaniya">  Build C ++ Core Recognition </h3><br><p>  Our recognition engine is written in C ++, and in this case, the obvious choice for porting to Sailfish OS was to build the kernel in the form of static libraries. </p><br><p>  A short but informative manual for assembling libraries is on the <a href="https://sailfishos.org/develop/tutorials/building-sailfish-os-packages-manually/">Building Sailfish OS packages manually pages of</a> official documentation.  By it, it became clear that you just need to connect via SSH to a virtual machine, and then call the usual build commands indicating the correct architecture.  We describe the process in steps. </p><br><ol><li>  We start the Sailfish OS Build Engine virtual machine (rather headless mode) </li><li><p>  Connect to it: </p><br><pre> <code class="bash hljs">ssh -p 2222 -i /opt/SailfishOS/SDK/vmshare/ssh/private_keys/engine/mersdk mersdk@localhost</code> </pre> <br><p>  By the way, the default external user home directory is available in the virtual machine at <code>/home/src1</code> . </p><br></li><li><p>  We get a list of supported platforms: </p><br><pre> <code class="bash hljs">[mersdk@SailfishSDK ~]$ sdk-assistant list Toolings: SailfishOS-2.1.3.7 Targets: SailfishOS-2.1.3.7-armv7hl <span class="hljs-comment"><span class="hljs-comment">#  SailfishOS-2.1.3.7-i486 # </span></span></code> </pre> <br><p>  Unlike the example on the site, in the names of the platforms there may be a version number that must also be taken into account.  Further, the assembly will be carried out for the device (SailfishOS-2.1.3.7-armv7hl), but for the emulator the whole process is similar. </p><br><p>  For the required architecture, the corresponding environment is provided by the <code>sb2</code> (Scratchbox2) command, so everything needs to be done through it: </p><br><pre> <code class="bash hljs">sb2 -t SailfishOS-2.1.3.7-armv7hl &lt;args....&gt;</code> </pre> <br></li><li><p>  Install the necessary packages for the assembly.  In our case, these were CMake, GCC, G ++ and Zip: </p><br><pre> <code class="bash hljs">sb2 -t SailfishOS-2.1.3.7-armv7hl -m sdk-install -R zypper <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cmake gcc gcc-c++ zip</code> </pre> <br></li><li><p>  Create a build folder and call <code>CMake</code> , and pass it the correct <code>CMAKE_SYSROOT</code> so that the compilers are searched for the right place for us: </p><br><pre> <code class="bash hljs">mkdir build &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build sb2 -t SailfishOS-2.1.3.7-armv7hl -m sdk-build cmake -DCMAKE_SYSROOT=/srv/mer/targets/SailfishOS-2.1.3.7-armv7hl ..</code> </pre> <br></li><li><p>  We collect the project: </p><br><pre> <code class="bash hljs">sb2 -t SailfishOS-2.1.3.7-armv7hl -m sdk-build make install -j8</code> </pre> <br></li></ol><br><p>  That's all!  Thus, the build under Sailfish OS is practically no different from the build under Linux - you just need to connect to the virtual machine and invoke commands with the correct environment. </p><br><h3 id="sozdanie-i-nastroyka-qt-proekta">  Creating and configuring a Qt project </h3><br><p>  The process of creating a project is trivial and you can read about it, for example, in the Sailfish OS <a href="https://habrahabr.ru/post/305510/">hub</a> in Habrahabr.  After that, it was necessary to do only one thing - add paths to header files and static libraries in the .pro file as follows: </p><br><pre> <code class="bash hljs">INCLUDEPATH += /path/to/install.armv7-linux.release/include LIBS += -L/path/to/install.armv7-linux.release/lib \ -lsomeStaticLibrary \ -lanotherStaticLibrary</code> </pre> <br><p>  After that, the project with the call of our C ++ recognition kernel was successfully compiled and launched. </p><br><h3 id="napisanie-gui-s-qml-i-sailfish-silica">  Writing GUI with QML and Sailfish Silica </h3><br><p>  GUI applications for Sailfish OS are written using Qt in C ++ and QML: both with the standard QtQuick library and the special <a href="https://sailfishos.org/develop/docs/silica/">Sailfish SIlica</a> . </p><br><p>  Almost all the required information on these technologies is present in their official documentation.  Additional useful links include the <a href="https://habrahabr.ru/hub/Sailfish_dev/">Sailfish OS development hub</a> on Habr√©, cribs for <a href="">colors and indents</a> , <a href="">icons</a> and <a href="">main components</a> , as well as a free <a href="http://stepik.org/course2341">introductory course</a> for Stepik. </p><br><p>  To draw graphic primitives, we used the <a href="http://doc.qt.io/qt-5/qml-qtquick-canvas.html">Canvas</a> and its <code>onPaint</code> method.  Selection of a document by horizontal scrolling - SlideshowView (thanks to Alexey for the implementation example).  Display recognition results - <a href="https://sailfishos.org/develop/docs/silica/qml-sailfishsilica-sailfish-silica-silicalistview.html/">SilicaListView</a> with ListModel. </p><br><p>  In addition to writing basic GUI elements, it is important to learn how to call C ++ classes from QML code, which is quite simply and clearly described on the <a href="http://doc.qt.io/qt-5/qtqml-cppintegration-topic.html">Integrating QML and C ++</a> page of Qt official documentation: we make C ++ class, register it in C ++, import it into QML.  For wrapping C ++ structures in QML, the most obvious way was to use <code>Q_GADGET</code> , about which there is even an <a href="https://habrahabr.ru/post/307816/">article</a> on Habr√©. </p><br><h3 id="vzaimodeystvie-s-kameroy-ustroystva-detektivno-nauchnoe-rassledovanie">  Interaction with the camera device: a detective-scientific investigation </h3><br><p>  Understanding how to properly interact with the camera API was the only difficulty in the whole process of developing a demo application and deserves a separate point - it took a little research with brainstorming, hypotheses and experiments. </p><br><p>  The scenario of using our real-time video stream recognition libraries is usually this: as long as the user sees the camera preview and holds an object in front of it (for example, a Russian passport or bank card), the frames coming from the camera are recognized one by one and recognized by the recognition library.  At the same time, during the recognition of each frame, the user is shown intermediate information about the location of the document, its fields, etc.  Thus, it is required to simultaneously capture frames from the camera and show previews to the user. </p><br><p>  When creating the camera and the preview in QML, there were no questions: create a <a href="http://doc.qt.io/qt-5/qml-qtmultimedia-camera.html">Camera</a> and refer to it in <a href="http://doc.qt.io/qt-5/qml-qtmultimedia-videooutput.html">VideoOutput</a> : </p><br><pre> <code class="javascript hljs">Camera { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: camera position: Camera.BackFace <span class="hljs-comment"><span class="hljs-comment">// ... } VideoOutput { anchors.fill: parent source: camera }</span></span></code> </pre> <br><p>  It remains to find a way to intercept the frames coming from the camera and transfer them to C ++ for recognition. </p><br><p>  As a first method, we tried the standard <a href="http://doc.qt.io/qt-5/qvideoprobe.html">QVideoProbe</a> , which exists specifically for receiving frames coming from the camera.  However, the call to <code>probe.setSource(camera)</code> returned <code>false</code> , after which nothing came to the callback to intercept frames.  Judging by the information on the Internet, this problem is also relevant for Android devices, which may indicate a simple lack of implementation of QVideoProbe for Sailfish OS.  We hope that soon it will be fixed. </p><br><p>  The second method is the inheritance from <a href="http://doc.qt.io/qt-5/qabstractvideosurface.html">QAbstractVideoSurface</a> and the implementation of the <code>present(const QVideoFrame &amp;frame)</code> method <code>present(const QVideoFrame &amp;frame)</code> , which passes the <code>present(const QVideoFrame &amp;frame)</code> frame to recognition.  After calling <code>camera.setViewFinder(&amp;videoSurface)</code> frames really began to arrive (in NV21 format) and even be recognized if you hold the document in front of the camera ... that's just the preview in VideoOutput was lost and the user lost the opportunity to see what his camera was shooting.  It was not possible to quickly defeat this problem, and we, along with Kirill and Alexey from the OMP, began to look for a third alternative. </p><br><p>  Fortunately, the third way of collective effort was found fairly quickly.  It turned out to be a bunch of <a href="https://doc.qt.io/qt-5.10/qabstractvideofilter.html">QAbstractVideoFilter</a> , which by <code>createFilterRunnable()</code> method creates <a href="https://doc.qt.io/qt-5.10/qvideofilterrunnable.html">QVideoFilterRunnable</a> , which in turn implements the frame processing functionality.  After that, the implemented filter should be added to QML and referenced in the existing VideoOutput: </p><br><pre> <code class="javascript hljs">RecognitionVideoFilter { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: recognitionVideoFilter <span class="hljs-comment"><span class="hljs-comment">// ... } VideoOutput { anchors.fill: parent source: camera filters: [ recognitionVideoFilter ] }</span></span></code> </pre> <br><p>  Compiled, run.  There are video previews, but still no frames.  And suddenly, Cyril shared <del>  insider </del>  information that for the operation of the filters on the device, you need to update the QtMultimedia plugin, which turned out to be available via the <a href="http://repo.merproject.org/obs/home:/minlexx/sailfish_latest_armv7hl/armv7hl/">link</a> .  After that, everything worked - frames in the BGRA format started coming to the core.  A small detail - the <code>QAbstractVideoSurface::run</code> function blocks the camera preview (which is logical, because the filter involves changing the frame, and we only need to read and recognize it), so for a smooth preview it was necessary to run the recognition in a separate stream - for example, through <a href="http://doc.qt.io/qt-5/qtconcurrentrun.html">QtConcurrent :: run (...)</a> . </p><br><p>  That's all!  It only remained to add the GUI of the application, which was not difficult. </p><br><h3 id="demonstraciya-na-mobile-world-congress-2018-v-barselone-i-drugie-video">  Demonstration at the Mobile World Congress 2018 in Barcelona and other videos </h3><br><p>  This year, our company <a href="http://smartengines.ru/news59/">presented</a> its recognition technology for the second time at the annual Mobile World Congress 2018 in Barcelona, ‚Äã‚Äãwhich again impressed us with its scale: more than 107,000 visitors from 205 countries, 2400 stands of companies located on 120,000 square meters of pavilions.  Like <a href="https://habrahabr.ru/company/smartengines/blog/322400/">last year</a> , it made a very positive impression on us. </p><br><p>  Of course, we did not miss the opportunity to go bragging our demo at the booth of the Finnish company Jolla, the original developer of Sailfish OS, and to show the work of the program "live" to colleagues from the Open Mobile Platform, who even shot several videos and <a href="https://vk.com/wall-40681615_13027">posted them on VKontakte</a> : </p><br><ul><li>  <a href="https://vk.com/wall-40681615_13027%3Fz%3Dvideo-40681615_456239058%252Fc8289b04eeba5f5b74%252Fpl_post_-40681615_13027">First video</a> </li><li>  <a href="https://vk.com/wall-40681615_13027%3Fz%3Dvideo-40681615_456239059%252F7aaabf72d4e37f7cb3%252Fpl_post_-40681615_13027">Second video</a> </li><li>  <a href="https://vk.com/wall-40681615_13027%3Fz%3Dvideo-40681615_456239060%252Fbcfdd0d4cfaf70aee8%252Fpl_post_-40681615_13027">Third video</a> </li></ul><br><p>  But the video from the first working version of the program: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mRIfHtjlA_Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Many other videos with demonstrations of Smart Engines technology can be viewed on <a href="https://www.youtube.com/channel/UCAhRdZxFYK0kmjnqdmNGePA/videos">our YouTube channel</a> . </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  In this article, we talked about our experience of porting the Smart IDReader recognition library to Sailfish OS, including writing a demo application.  We were pleasantly surprised by the amount of relevant official documentation and the quality of the toolkit.  Of course, a couple of technical issues arose, but they managed to win quickly.  We hope that our experience will be useful to others. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/352512/">https://habr.com/ru/post/352512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352498/index.html">Learning is light, or how to organize a master class in 2 days</a></li>
<li><a href="../352500/index.html">For beginners: 5 tips on github</a></li>
<li><a href="../352502/index.html">What's new in Swift 4.1?</a></li>
<li><a href="../352508/index.html">Heading "We read articles for you." December 2017 - January 2018</a></li>
<li><a href="../352510/index.html">Security Trends: why attackers attack non-financial accounts to steal money</a></li>
<li><a href="../352514/index.html">What's new in Swift 4.1</a></li>
<li><a href="../352516/index.html">Alternative approaches to the development of new IT products</a></li>
<li><a href="../352518/index.html">Heading "We read articles for you." February - March 2018</a></li>
<li><a href="../352520/index.html">Java Learning Framework for Deep Learning</a></li>
<li><a href="../352524/index.html">Conference DEFCON 16. "Cisco iOS Development Crime." Felix Lindner, head of Recurity Labs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>