<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Network access to libraries and runtime-formation of function calls</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share a story from professional activities that can be deservedly put on a blog named crazydev :) This is a story about unusual decisions (t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Network access to libraries and runtime-formation of function calls</h1><div class="post__text post__text-html js-mediator-article">  I want to share a story from professional activities that can be deservedly put on a blog named <b>crazydev</b> :) This is a story about unusual decisions (those that I tried to describe in two words in the title), to which I was forced to come even more unusual restrictions and requirements. <br><br><img src="https://habrastorage.org/storage2/4a6/b2c/d9c/4a6b2cd9c2f30a8cecfb4e9a36fbd9f4.jpg"><br>  <i>And somehow, through the cleverly twisted *** y, it works ¬©</i> <br><a name="habracut"></a><br><h4>  Formulation of the problem </h4><br>  A few years ago we were working on a system designed for the <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D0%25BE%25D0%25B1%25D0%25B8%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D0%25B0_%25D0%2592%25D0%25BE%25D0%25BE%25D1%2580%25D1%2583%25D0%25B6%25D1%2591%25D0%25BD%25D0%25BD%25D1%258B%25D1%2585_%25D0%25A1%25D0%25B8%25D0%25BB">platform of our valiant Armed Forces</a> .  A significant part of the work proceeded in porting (with windows) already existing software.  And here it turns out: an important component of the system (let's call it <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B5%25D0%25BF%25D1%2583%25D0%25BB%25D1%258C%25D0%25BA%25D0%25B8">the sepulenium library</a> ) provided by the partner simply does not have a linux version, and its developer is not in a hurry with the port, since  no such arrangements.  Swearing with his superiors, who made this mistake with the planned works, is meaningless - if, as a result, the sepulkaries stand, then this is an unclosed TK, and we, as performers, will be the first to blame. <br><br><h4>  Searching of decisions </h4><br>  <i>Initially, there was a wall of text about iterated solutions, which included porting source codes on their own, and using a virtual machine with a <a href="http://www.reactos.org/">Reactive Axis</a> (in order not to use the proprietary software of a <b>potential enemy</b> ), and the inclusion of a sistemnik in the local network in the Mini-ITX form factor with the same ReactOS on board.</i>  <i>And the intense search for a more or less stable version of wine (the system libraries are quite old, and it is impossible to update - it threatens to <b>lose</b> OS <b>certification</b> ).</i> <br>  On the version of emulation using Wine (which, as you know, is not an emulator at all), we stopped.  It remained to think about how sepulcaria launched inside the server software process will get access to the separation algorithms, forced to be under the jurisdiction of the wine-process.  Then an idea comes to my mind - to organize a <i>network translator of accessing libraries</i> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Translator </h4><br>  In general, it looks like this: <br><img src="https://habrastorage.org/storage2/c69/c8b/225/c69c8b2256477c9b4e181087623dd5f2.png"><br>  (by the way, it seems that one of the variations of the Program as a Service model ( <a href="http://en.wikipedia.org/wiki/Software_as_a_service">Soft as a service</a> ) is obtained, but this is a topic for another story) <br>  What seems to me interesting in such a scheme is the fact that clients can work both in different instances of the selected library and <i>in the same one</i> . <br>  To implement there are two ways: <br>  1) Teach the translator to work with the set of libraries that are needed now and then, in the case of replenishing this set, add its code each time (or connect via adapters, it does not matter), providing pairing with each new library. <br>  2) To ensure the universality of the translator, making it really just <i>a</i> query <i>translator</i> , shifting the function of generating the necessary requests to new libraries on the client part. <br>  Obviously, if I had gone the first way, I would have nothing to write to <b>crazydev</b> :) <br><br><h4>  Universality everywhere </h4><br><br>  A simple example of connecting a library and calling functions from it. <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">double</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*myfunc_type)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *mylib; myfunc_type myfunc; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> res; ... mylib = dlopen(<span class="hljs-string"><span class="hljs-string">"mylib.dll"</span></span>, RTLD_LAZY); myfunc = dlsym(mylib, <span class="hljs-string"><span class="hljs-string">"my_func_name"</span></span>); res = (*myfunc)(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>);</code> </pre> <br><br>  As we can see, in order to access any function, we must first describe its type: <br> <code>typedef double (*myfunc_type)(long, long);</code> <br> <br>  And what to do when the types of functions to which we will refer are <b>unknown at the design stage</b> ? <br><br>  That's right, we come to the aid of the good old assembler.  What is essentially a function call?  Putting arguments on the stack, passing control to the address, then getting the result, and, depending on the calling convention, clearing the stack. <br>  Here is a piece of code (in Delphi) that was just performing similar operations in my translator (I made additional comments to eliminate unclear moments): <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    , //    TDLL_Function //  ,    (  ) function TDLL_Function.Execute(): TByteAr; var i: Integer; //   len : Integer; //      B1 : Byte; //    B2 : Word; //    B4 : Cardinal; //  4-  B8 : Double; //   8-  StackPos : Integer; //     begin //ParamBytes   ,      , //      len:=Length(ParamBytes); asm //    (  esp) mov StackPos, esp end; //ParamType   ,     : //TParamType = (ptOne=1, ptTwo=2, ptFour=4, ptEight=8, ptVoid=0, ptPointer=-1); //  ,       //   , ..         for i := Length(ParamType)-1 downto 0 do begin case ParamType[i] of //      ptOne:begin dec(len,1); //  ParamBytes    ( ),    Move(ParamBytes[len],B1,1); asm //  ,     MOVSX EAX,B1 PUSH EAX end; end; ptTwo:begin //     dec(len,2); Move(ParamBytes[len],B2,2); asm MOVSX EAX,B2 PUSH EAX end; end; ptFour:begin //     dec(len,4); Move(ParamBytes[len],B4,4); asm MOV EAX,B4 PUSH EAX end; end; //        ,    //64-  (8   )    ptPointer:begin dec(len,4); Move(ParamBytes[len],B4,4); asm MOV EAX,B4 PUSH EAX end; end; ptEight:begin dec(len,8); Move(ParamBytes[len],B8,8); asm //        PUSH DWORD PTR [B8]+$04 PUSH DWORD PTR B8 end; end; ptVoid: begin end; end; end; // B4       case fCallingConv of //       ccStdcall: begin TStdCall(Proc)(); //Proc -     asm //    MOV B4,EAX end; end; ccCdecl:begin TCdeclCall(Proc)(); //   Cdecl          asm MOV B4,EAX mov esp, StackPos; end; end; end; //   ,     case ResultType of //     ptOne:begin //   Result      B4 SetLength(Result,1); Move(Byte(B4),Result[0],1); end; ptTwo:begin SetLength(Result,2); Move(Word(B4),Result[0],2); end; ptFour:begin SetLength(Result,4); Move(B4,Result[0],4); end; ptPointer:begin SetLength(Result,4); Move(B4,Result[0],4); end; ptEight:begin //    ,  B8    asm FSTP B8 end; SetLength(Result,8); Move(B8,Result[0],8); end; ptVoid:begin SetLength(Result,0); end; end; end;</span></span></code> </pre><br><br>  <i>Please do not kick with the code, it definitely requires optimization.</i> <br>  About implementation features: <br>  1) Only made stdcall and cdecl conventions available <br>  2) There are no guarantees that assembly inserts will also work on architectures other than those for which this was done. <br>  1) There is no support for 64-bit code, although in general, some ways to ensure I laid <br>  2) If a pointer is passed to a function, for example, to an array, then the client had to forward the entire array so that the translator would deploy it and send a pointer to it to the function.  If this array had to be returned, then its return was organized in the same way. <br><br>  In general, the protocol for client and translator communication turned out to be quite complicated and confusing, and I don‚Äôt know if it makes sense to describe it.  I can only say that it was <a href="http://habrahabr.ru/blogs/programming/138533/">binary</a> :) <br><br>  The general sequence of actions for the call looked like this: <br>  1) The client connects to the broadcaster <br>  2) The client sends the name of the library to which it wants to connect. <br>  3) The client sends a description of the library function that it wants to call. <br>  4) The client packs and sends the parameters to call the library function. <br>  5) The translator expands the parameters in accordance with the received description of the function. <br>  6) The translator calls the above Execute () <br>  7) The translator packs the necessary results of work (as described in the function) and sends them to the client. <br><br>  Here is such a <b>crazydev</b> :) In defense of my crafts, I‚Äôll say that in this form it worked smoothly for a year, and taking advantage of this versatility, we managed to reduce the time for porting some other libraries as well.  And a year later, during the planned update, the ported version of the sepulic libraries had already ripened, and everything ended well. <br><br>  <b>UPD.</b>  Added the ‚Äúcrutches‚Äù tag so that there are no misunderstandings with the self-identification of the solutions described. </div><p>Source: <a href="https://habr.com/ru/post/138633/">https://habr.com/ru/post/138633/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138628/index.html">Black holes and gold mines on the web development market</a></li>
<li><a href="../138629/index.html">Development of a WEB project on Node.JS: Part 2</a></li>
<li><a href="../138630/index.html">Embedded Systems: Windows Special Purpose</a></li>
<li><a href="../138631/index.html">Be the center of attention!</a></li>
<li><a href="../138632/index.html">A unified look at communities and social networks</a></li>
<li><a href="../138634/index.html">What to expect from MWC 2012?</a></li>
<li><a href="../138635/index.html">Why I choose D</a></li>
<li><a href="../138637/index.html">Radio Survey (Site Survey) Wi-Fi Coverage</a></li>
<li><a href="../138638/index.html">BlackBerry PlayBook OS 2.0 is now available.</a></li>
<li><a href="../138639/index.html">Change phone settings for time and location (no gps, operator towers)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>