<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pillow 2.7 - Significant improvement in quality and performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On January 1, 2015, a new version of the library for working with images Pillow 2.7 was released . Since many changes in it were made by the Uploadcar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pillow 2.7 - Significant improvement in quality and performance</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/files/652/911/ebb/652911ebbe334680a1baf15dd6815a29.png">  On January 1, 2015, a new version of the library for working with images <a href="">Pillow 2.7 was released</a> .  Since many changes in it were made by the <a href="https://uploadcare.com/">Uploadcare</a> team, we are pleased to present you an extended version of the release notes for this version. <br><br>  To begin, remember how it all began.  Pillow is a friendly fork (as the authors call it) of the popular PIL library, the Python Imaging Library.  The latest version of PIL 1.1.7 was released in 2009 and mainly contained bug fixes.  Initially, Pillow was conceived as a project only for putting in order the PIL assemblies, and the developers recommended sending all the bugs not related to the assembly to the original PIL.  But as time went on, the PIL rapidly became obsolete, the bugs did not decrease, there still Python 3 loomed on the horizon.  Therefore, everything changed with the Pillow 2.0 version.  ‚ÄúPillow 2.0.0 adds support for Python 3 and includes many bug fixes from around the Internet,‚Äù reads the <a href="">project description</a> in PyPI.  And since then it started.  Every three months there were versions with a huge number of bug fixes and other improvements from various developers.  The most significant innovation during this time was, perhaps, support for WebP and JPEG2000 formats.  Now it's time for the next big step. <br><a name="habracut"></a><br><h2>  Image resize filters </h2><br>  The image <code>Image.resize()</code> functions Image.resize <code>Image.resize()</code> and <code>Image.thumbnail()</code> as one of the arguments the filter used for resizing - <code>resample</code> .  Its possible values ‚Äã‚Äãare <code>NEAREST</code> , <code>BILINEAR</code> , <code>BICUBIC</code> and <code>ANTIALIAS</code> .  The behavior of almost every one of them has changed in the new version. <br><br><h3>  Image reduction with bilinear and bicubic filters </h3><br>  One of the problems in PIL, and later in Pillow, was that for resizing using a bilinear and bicubic filter, an <a href="http://habrahabr.ru/post/243285/">affine transformation</a> method was used, which uses the same number of pixels of the original image to form one pixel of the final (2x2 pixel for bilinear, 4x4 for bicubic) and fixed filter size.  This led to unsatisfactory results to reduce the image, almost no different from the method of the <a href="http://habrahabr.ru/post/243285/">nearest neighbor</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/5de/5ab/390/5de5ab390d9341c68bce924c1cf86bb8.jpg" alt="nearest"><img src="https://habrastorage.org/files/4bb/ab7/9cb/4bbab79cbb1445e4ab1e1d39e9066438.jpg" alt="affine"><br><img src="https://habrastorage.org/files/9ef/e08/be1/9efe08be1c7947ab9d62bed21fd21c30.jpg" alt="nearest"><img src="https://habrastorage.org/files/6da/8c9/84c/6da8c984c1d44d76bcdecd84db250491.jpg" alt="affine"><br><br>  On the left is the nearest neighbor method, on the right is the bicubic filter of affine transformations.  The first sample is a decrease of 5.8 times, there are practically no differences.  The second one is 1.8 times, the differences are minimal, on a sharp diagonal lines a ladder is visible. <br><br>  At the same time, a high quality <a href="http://habrahabr.ru/post/243285/">convolution based algorithm was</a> used for the <code>ANTIALIAS</code> filter, which gave an equally good result for both reduction and increase. <br><br>  Starting with Pillow 2.7.0, a high quality convolution based algorithm is used for all three filters. <br><br><img src="https://habrastorage.org/files/4bb/ab7/9cb/4bbab79cbb1445e4ab1e1d39e9066438.jpg" alt="affine"><img src="https://habrastorage.org/files/377/b37/de6/377b37de67134e5ebf3753fcbe234b31.jpg" alt="convolution"><br><img src="https://habrastorage.org/files/6da/8c9/84c/6da8c984c1d44d76bcdecd84db250491.jpg" alt="affine"><img src="https://habrastorage.org/files/e0d/829/e99/e0d829e9993442b0add881cf624dd411.jpg" alt="convolution"><br><br>  On the left is a bicubic filter based on affine transformations, on the right - convolutions.  Convolutions definitely win. <br><br>  If before you used any tricks to improve the quality when using a bilinear or bicubic filter (for example, reducing the image in several steps or preliminary blurring), now they are not necessary. <br><br><h3>  Antialias renamed to Lanczos </h3><br>  A new <code>Image.LANCZOS</code> constant <code>Image.LANCZOS</code> been added to replace <code>Image.ANTIALIAS</code> . <br><br>  When the <code>ANTIALIAS</code> method was first introduced, it was the only high-quality method based on convolutions.  And his name reflected this fact.  Now that all methods are based on convolutions, they have all become "smoothing."  And the real name of the filter used earlier for this constant is the Lanczos filter. <br><br>  Of course, the old constant is left for backward compatibility and is a pseudonym for the new one.  A joke for linguists: Antialias is alias now. <br><br><h3>  Lanczos filter quality at magnification </h3><br>  Oddly enough, the quality of the reconciliations was also not all right.  In previous versions, there was a bug due to which the quality of the Lanczos filter with an increase was almost the same as that of the <code>BILINEAR</code> filter.  This bug has been fixed. <br><br><img src="https://habrastorage.org/files/e70/673/ba9/e70673ba93ed4f6b96d24c5c3b6942a1.jpg" alt="before"><img src="https://habrastorage.org/files/57d/e6e/964/57de6e9647414eb3a669dd4a3541bbf7.jpg" alt="after"><br><img src="https://habrastorage.org/files/670/665/3e5/6706653e5f364fe28dd4b4932ac0eafb.jpg" alt="before"><img src="https://habrastorage.org/files/c8c/65e/a0e/c8c65ea0e4ba4cf5b638d86289b2e5d2.jpg" alt="after"><br><br>  On the left, the result of an increase 4.3 times the previous version, on the right - Pillow 2.7.0.  Images on the left are simultaneously more blurred and pixelated. <br><br><h3>  Bicubic filter quality at magnification </h3><br>  A bicubic filter implemented for affine transformations gave a sharp, slightly pixelated image when zoomed in on.  The bicubic filter implemented for convolutions is a bit softer. <br><br><img src="https://habrastorage.org/files/9a5/428/051/9a542805186248cc9e60669705735ec7.jpg" alt="before"><img src="https://habrastorage.org/files/473/aec/5bf/473aec5bfbd74455aac5e691b84df69a.jpg" alt="after"><br><img src="https://habrastorage.org/files/93a/33d/95a/93a33d95ac0c486abdb1b70277cf6d3a.jpg" alt="before"><img src="https://habrastorage.org/files/4a0/33f/f3a/4a033ff3a2844338a0b7a86bf1cbb5f7.jpg" alt="after"><br><br>  On the left, the result of an increase 4.3 times the previous version, on the right - Pillow 2.7.0.  The pictures on the left are more pixelated (they have more perceptible pixel boundaries).  At the same time, the diagonal lines in the first example are clearer and less susceptible to the effect of a ladder.  Both are effects of the parameter ‚Äúa‚Äù in the <a href="http://en.wikipedia.org/wiki/Bicubic_interpolation">bicubic equation</a> .  Both effects can be avoided only with the help of a better Lanczos filter. <br><br><h3>  Resize performance </h3><br>  In the general case, <a href="http://habrahabr.ru/post/243285/">convolutions</a> are a more costly algorithm to reduce, because, unlike <a href="http://habrahabr.ru/post/243285/">affine transformations</a> , it takes into account all the pixels of the original image.  Because of this, the net performance of the bilinear and bicubic filters may be lower than before.  On the other hand, if you were previously satisfied with the quality of the bilinear and bicubic filters to reduce, you may need to consider using the <code>NEAREST</code> filter, which gave almost the same result.  This will significantly increase productivity. <br><br>  At the same time, one of the significant improvements of Pillow 2.7.0 is that the performance of the bundles was reduced on average by a factor of 2 compared with the previous version and even compared with ImageMagick.  The performance of the increase in convolutions for the <code>BILINEAR</code> filter was one and a half times faster, for <code>BICUBIC</code> - four times faster, and for <code>LANCZOS</code> remained at the same level. <br><br>  Since  most likely you didn‚Äôt use anything other than <code>LANCZOS</code> (formerly <code>ANTIALIAS</code> ) in your application, then the performance with decreasing for you should double on average.  If the use of Lanczos was a necessary measure for you because of the poor quality of the remaining filters, then now you can switch, for example, to a bilinear filter.  This will increase the performance by about 2 times to reduce and about 30% to increase. <br><br><h3>  Default filter for <code>Image.thumbnail()</code> </h3><br>  In Pillow 2.5, the default filter for <code>Image.thumbnail()</code> was changed from <code>NEAREST</code> to <code>ANTIALIAS</code> .  This filter was chosen for the reason that was repeatedly announced above - the low quality of the remaining filters.  In Pillow 2.7.0, the default filter is changed again, this time to <code>BICUBIC</code> , because it is slightly faster.  In fact, Lanczos does not offer any advantages after using the <code>Image.draft()</code> method inside <code>Image.thumbnail()</code> , which reduces the image using the <code>libjpeg</code> library and uses <code>Image.thumbnail()</code> for this, not convolution. <br><br><h2>  Transpose Images </h2><br>  A new method <code>Image.TRANSPOSE</code> been added for the <code>Image.transpose()</code> function in addition to the existing <code>FLIP_LEFT_RIGHT</code> , <code>FLIP_TOP_BOTTOM</code> , <code>ROTATE_90</code> , <code>ROTATE_180</code> , <code>ROTATE_270</code> .  <code>TRANSPOSE</code> is algebraic transposition, i.e.  reflection of the image relative to its main diagonal. <br><br>  The performance of the <code>ROTATE_90</code> , <code>ROTATE_270</code> and <code>TRANSPOSE</code> methods <code>ROTATE_90</code> been significantly increased for large images that do not fit in the processor cache. <br><br>  These three methods are united by the fact that the pixels in them are taken from rows, and placed in columns.  Such a memory access pattern is not very effective for large images, because data has time to be pushed out of the processor cache in one pass and they have to be re-loaded from memory for the next pass. <br><br>  In the new version, the image is divided into logical squares of 128 √ó 128 pixels in size, and operations on the pixels are performed sequentially within each square.  This allows you to significantly reduce the distance that the processor runs on each line, as a result of which the data do not have time to be pushed out of the cache (the memory required for one square is 64Kb). <br><br><a name="blur"></a><h2>  Gaussian blur and contour sharpness </h2><br>  The implementation of <code>ImageFilter.GaussianBlur</code> been replaced by the consistent use of box filters.  The new implementation is based on the article <a href="http://www.mia.uni-saarland.de/Publications/gwosdek-ssvm11.pdf">Theoretical foundations of Gaussian convolution by the extended box filtering</a> from the Mathematical Image Analysis Group.  Since the implementation of <code>ImageFilter.UnsharpMask</code> is based on Gaussian blurring, everything described in this section also applies to it. <br><br><h3>  Blur radius </h3><br>  In previous versions of Pillow, there was an error due to which the blur radius (standard deviation of Gaussians) actually set its diameter.  Therefore, for example, to blur an image by radius 5, it was necessary to specify the value 10. The error was corrected, and now the radius value is interpreted in the same way as in the rest of the software. <br><br>  If you previously used a Gaussian blur with a certain radius, you need to divide its value by two. <br><br><h3>  Blur performance </h3><br>  The calculation time of the box filter is constant relative to its radius and depends only on the size of the input image.  Since  The new implementation of Gaussian blur is based on the box filter, its calculation also does not depend on the blur radius. <br><br>  For a radius of 1 pixel, the new implementation runs 5 times faster, for a radius of 10 - 18 times, for a radius of 50 - already 85 times.  Your designer who draws iOS 8 interfaces should be pleased. <br><br><h3>  Blur quality </h3><br>  Theoretically, with Gaussian blurring, all points of the original with certain coefficients should be involved in the calculation of each point of the final image.  In practice, the coefficients of points beyond 3 √ó standard deviation are so small that it makes no sense to take them into account. <br><br>  The previous implementation took into account only pixels within a radius of 2 √ó standard deviation for each final pixel.  This was not enough, so the quality was worse compared to other implementations of Gaussian blur. <br><br>  Despite the fact that the new implementation is only a mathematical approximation, it does not contain such a bug. <br><br><img src="https://habrastorage.org/files/073/86a/19d/07386a19dce1405da6e4c1fc3b6fca96.jpg" alt="before"><img src="https://habrastorage.org/files/3eb/607/23f/3eb60723f2f042fa8cd5639b02ffa303.jpg" alt="after"><br><img src="https://habrastorage.org/files/cec/85b/ebe/cec85bebe8eb4fb9b03943e27eb0a0cc.jpg" alt="before"><img src="https://habrastorage.org/files/382/7bc/f82/3827bcf825f34d969401302c46e7a6e9.jpg" alt="after"><br><br>  On the left, the result of a blur with a radius of 5 in the previous version (including a bug with a doubling of the radius), on the right - in a new one.  On the left, sharp boundaries of objects are visible. <br><br><hr><br>  All these changes are already working on our servers.  Thanks to them, we have improved the quality and speed of the <a href="https://uploadcare.com/documentation/cdn/">API for processing images on the fly</a> .  We also implemented a <a href="https://uploadcare.com/documentation/cdn/">quick blur</a> operation.  But that is not all.  We are preparing the next big step for Pillow, which we will announce later. </div><p>Source: <a href="https://habr.com/ru/post/247219/">https://habr.com/ru/post/247219/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247205/index.html">Sound Mixing in Cubian</a></li>
<li><a href="../247207/index.html">Disadvantages when working with translations in Qt and ways to deal with them</a></li>
<li><a href="../247209/index.html">New parameter to describe distribution & x.do = in magnet link for FlylinkDC ++. Factors of the choice by the user of a file-sharing network</a></li>
<li><a href="../247211/index.html">Express Specialist</a></li>
<li><a href="../247213/index.html">How lazy calculations work</a></li>
<li><a href="../247221/index.html">PROSPECTOR inside</a></li>
<li><a href="../247223/index.html">Apple - environmental responsibility</a></li>
<li><a href="../247225/index.html">Physical and functional objects (continued)</a></li>
<li><a href="../247227/index.html">10 new year questions for the startup creator</a></li>
<li><a href="../247229/index.html">JavaScript Trends for 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>