<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mailchimp dump basket: a guide for the lazy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="First, a little ranting :) Sooner or later, before any online store there is a question of setting up an abandoned basket. Statistics and the feeling ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mailchimp dump basket: a guide for the lazy</h1><div class="post__text post__text-html js-mediator-article">  First, a little ranting :) Sooner or later, before any online store there is a question of setting up an abandoned basket.  Statistics and the feeling of missing money sucking under the spoon do not spare anyone. <br><br><h4>  Percentage of abandoned baskets from 2006 to 2017 </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/a39/77d/91a/a3977d91a0ebd3217886009fec230985.jpg" alt="Percentage of abandoned baskets from 2006 to 2017"><br>  <i><a href="http://www.statista.com/">A source</a></i> <br><br>  The percentage of abandoned baskets for the first quarter of 2018 by industry: <br><img src="https://habrastorage.org/getpro/habr/post_images/633/2b5/be6/6332b5be64d04bbd4ca0d1defe9e7b14.jpg" alt="Percentage of abandoned baskets for the first quarter of 2018 by industry"><br>  <i><a href="http://www.statista.com/">A source</a></i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the same time, despite the publicly available statistics, most online stores do not use the available features and do not connect an abandoned basket.  A recent ‚Äúhomemade‚Äù survey from EmailSoldiers clearly shows that most of the stores do not bother about it at all. <br><a name="habracut"></a><br><h4>  Current statistics for connected abandoned baskets </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/fd4/b56/83f/fd4b5683f724d5004046e14523b95f69.jpg" alt="EmailSoldiers Research"><br>  <i><a href="https://emailsoldiers.ru/blog/online-stores-and-abandoned-carts">A source</a></i> <br><br>  At the same time, everyone (and we are also not saints) are catching up on traffic, they wind up advertising and creatives, but they don‚Äôt even try to return a person who has broken at the last moment. <br><br>  But in the first iteration, you can get an increase in orders, using a letter without dynamic content, you only need to configure it.  Only once to make an effort to make money in the background - is this not a fairy tale? <br><br>  Naturally, a letter with dynamic content, which pulls goods from the basket, can work better.  Or maybe your next kitten with sad eyes will have a cooler effect on your audience.  Or you pull the recommended goods to the goods in the basket and see that from the letters they buy more often and increase the average bill.  Or you will have hands to make a series of letters, from which the conversion will be even more. <br><br>  It is possible to improve and test letters of an abandoned basket to an unattainable ideal, but any once customized letter is incomparably better than nothing. <br><br><h4>  Conversion for an abandoned basket according to RetailRocket </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/df2/2f9/684/df22f968450761e23695591fcd2931af.jpg" alt="RetailRocket abandoned basket conversion"><br>  <i><a href="https://retailrocket.ru/blog/vsya-pravda-o-broshennyih-korzinah/">A source</a></i> <br><br>  And here we are with comrade <a href="">Artem Aleksandrov</a> began the introduction of the basket from two sides. <br><br><h2>  Technical implementation </h2><br><h4>  Integration specification </h4><br>  Briefly describe the essence of the problem. <br><br>  Task: connect the abandoned shopping cart to the xxx.xx site using Mailchimp mailing service. <br><br>  We give all the necessary materials. <br><br>  API Key: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX-usXX <br><br>  Where to get the key? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f9f/511/fc0/f9f511fc0d1ff7d44d41d19463cd362e.jpg" alt="Where to get the key?"><br><br>  ‚Üí <a href="https://developer.mailchimp.com/documentation/mailchimp/reference/ecommerce/stores/carts/">Give a link to the documentation</a> <br><br>  ID of the sheet to which we connect Store: XXXXXXXXXX <br><br>  Where to get ID sheet? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/215/996/6cb/2159966cb62dc60e25079b86c5905aca.jpg" alt="Where to get ID sheet?"><br><br>  A letter must be created in the mailing service in advance.  As soon as the API request is received by the mailing service, the letter is automatically generated and the addressee is added to the queue for sending. <br><br>  For our case, we chose the following logic for sending an abandoned basket: <br>  An authorized user adds the goods to the cart, does not complete the transaction and does not complete the order, the cart remains unchanged for 1 hour.  After that, a request is sent to Mailchimp, in which the email, the composition of the user's order, the images of the goods, the price of the goods and the link to the user's basket are transmitted. <br><br><h4>  Template layout </h4><br>  When creating automation for an abandoned basket, mailmailimp immediately asks if there will be one letter or several and offers to select a connected store. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/12d/288/b80/12d288b80aed84cc9ac1b3b81b4d3d6d.jpg" alt="Creating automation for an abandoned cart in Mailchimp"><br><br>  In the basic templates mch offers a choice of three pieces: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f2/402/d62/7f2402d625f7174f3a18f42849080bea.jpg" alt="Letters of choice for Mailchimp abandoned basket"><br><ol><li>  Abandoned basket with dynamic goods </li><li>  Abandoned basket with grocery recommendations (to be configured separately) </li><li>  Abandoned basket without goods (just a text letter) </li></ol><br>  In the best traditions, if you have time, you can complete the basket yourself. <br><br>  Dynamic products without styles look something like this (forget about indents, they are ugly displayed here): <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> *|ABANDONED_CART:[$total=3]|* <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*|CART:URL|*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*|PRODUCT:TITLE|*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_blank"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*|PRODUCT:IMAGE_URL|*"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> *|PRODUCT:TITLE|* ‚Äî *|PRODUCT:PRICE|* <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> *|END:ABANDONED_CART|* <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> *|END:ABANDONED_CART|* <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  It would seem that if you change the number in the variable <b>* | ABANDONED_CART: [$ total = 3] | *</b> , then the letter will display a different quantity of goods, but no, put at least 5, at least 100, mch refuses to show a different quantity. <br><br>  And, which is also a bit strange, the variable <b>* | PRODUCT: PRICE | *</b> is replaced by the values ‚Äã‚Äãof the RUB288 format, and for some reason this cannot be changed, but more on that later. <br><br>  For a change, we tried to substitute also variables with the number of games and with the total cost of the order, which we transmit via api, but the email and then said ‚Äúno‚Äù.  Well, so be it. <br><br><h4>  A word to the programmer :) </h4><br>  Mailchimp was a historical experience of integration with their third-party service mandrill, everything is simple and clear.  Very friendly documentation (of course, in English), but there were no rough edges and it worked from the first kick. <br><br>  Also, we have implemented a subscription mechanism through special forms on our website.  It was there that we fully felt the understatement and ambiguity of mailchim documentation.  English is not a problem for an experienced developer, but knowledge of the Klingon dialect is not implied by default. <br><br>  The initial data are: the php7 language and the yii2 framework, which has already been heavily acquired by its ecosystem.  Those.  we already have 6 small projects that are trying to use common components both on the back end and on the frontend.  Accordingly, the implementation of any task requires to solve it project-independent, but this does not imply a framework-independence, since  for this one has to pay man-hours, of which there is always a shortage. <br><br>  Having received the integration task, it is necessary first of all to look around.  What is given to us?  First, the mailchimp service that you need to make friends with.  We go to the githab and see that there are quite a lot of implementations.  But the choice is simple - with the most popular package 1.5k stars ( <a href="https://github.com/drewm/mailchimp-api">drewm / mailchimp-api</a> ). <br><br>  The packet gives a simple wrapper over the rest interaction with mailchimp.  We can only grow on its own logic. <br><br>  Secondly, we are given <a href="http://developer.mailchimp.com/documentation/mailchimp/reference/ecommerce/stores/">documentation</a> .  Based on the documentation, we have a Store resource with embedded resources: Cart, Customer, Order, Product, Promo rule.  For an abandoned basket without the recommended goods, we need only Product, Cart and Customer.  Cart in turn consists of the Cart line set, and Product contains Product variants. <br><br>  We decompose the problem as follows: <br><br><ol><li>  Download store data to the resource Stores </li><li>  Download all products available for purchase in Products </li><li>  Customize the loading of baskets with users on a schedule </li></ol><br>  Ok, let's go.  First of all, we take on the essence of "shop".  We decided to immediately use the test and combat version of the store and, depending on the environment variable responsible for the dev / prod mode, we worked either with one store or with another. <br><br>  To download data for the store, we knock a post-request at / ecommerce / stores with the following set of parameters: <br><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'dev.***.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'list_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'****'</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'*** - test'</span></span>, <span class="hljs-string"><span class="hljs-string">'domain'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'dev.***.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'email_address'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin@***.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'currency_code'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'RUB'</span></span>, <span class="hljs-string"><span class="hljs-string">'primary_locale'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'money_format'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'‚ÇΩ'</span></span>, ]</code> </pre> <br>  There are a few more parameters, but it all depends on your needs.  Since  we didn‚Äôt intend to use the store‚Äôs contact details in letters, we didn‚Äôt fill in the phone, address, timezone, etc. <br>  But we were expecting a little surprise.  The money_format field seems to be specially created for the opportunity to present the price in a convenient format.  But when building a template for an abandoned basket, mailmail impersonates the RUB before the number.  Mailchimp, stop it! <br><br>  After downloading, we can check the data using a get request to the address / ecommerce / stores to see all the stores that are uploaded, or / ecommerce / stores / {id} to get data for a particular store. <br><br>  Now you can add all other data, because the Store is the root point in our data tree, because  all other data we will upload to a particular store. <br><br>  So, so that the MCH could put the goods in an abandoned basket, he needs to feed these goods.  To do this, we have the address / ecommerce / stores / {store_id} / products, where we send post-requests for the creation of products in the system. <br><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'742'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'handle'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'kastrulya'</span></span>, <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://***.ru/catalog/kastrulya/'</span></span>, <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' ‚Äî    .  ,       .  ,        !           !'</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'vendor'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-string"><span class="hljs-string">'image_url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://***.ru/images/742/product.png'</span></span>, <span class="hljs-string"><span class="hljs-string">'variants'</span></span> =&gt; [ [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'742'</span></span>, <span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://***.ru/catalog/kastrulya/'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">890</span></span>, <span class="hljs-string"><span class="hljs-string">'sku'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KA453'</span></span>, <span class="hljs-string"><span class="hljs-string">'inventory_quantity'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'image_url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://***.ru/images/742/product.png'</span></span>, <span class="hljs-string"><span class="hljs-string">'visibility'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'visible'</span></span>, ], ], ]</code> </pre><br>  What's so remarkable?  Well, firstly, each product must consist of at least one product offer.  In essence, a Product is a container for loading product offerings.  Moreover, product id and product offer can overlap, since these are different resources in api MCH. <br><br>  And here began the understatement of the documentation MCH.  I had to guess, let it was easy, but you could do it normally, and not as always. <br><br>  The handle field was described as ‚Äúthe handle of a product‚Äù.  Ok, after consulting we decided that this is part of the URL related to the product itself (cnc).  But this was confirmed only during the tests. <br><br>  Also, an array of images can be attached to the product, but we decided that it would not be useful to us and therefore we only loaded the main image both to the product and to each product offer. <br><br>  And here we had a problem, the products for some reason were not displayed in mailchimb templates. <br><br>  Started rummaging through the dock for Product.  And they found a field of visibility with a luxurious description: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/525/123/aae/525123aae8eff2a8a1a595072d92b2f6.jpg" alt="field visibility description"><br><br>  Well, ok, type String!  And what can be transferred there?  Why it is impossible to describe all possible values?  I can send there, for example, ‚Äúshow me pls!‚Äù. <br><br>  Fortunately there is an example of the request! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/57b/e08/dbe/57be08dbe97502fc302cc4de5dc0e4bf.jpg" alt="sample request"><br><br>  Well, that doesn't cancel the problem.  I don‚Äôt know what other values ‚Äã‚Äãmight be that might be useful. <br><br>  Everyone coped with it!  Now email-marketer can verify the availability of goods in the system through the construction of a template with the participation of goods or all through the same get-requests using the console. <br><br>  Next we face the task of loading abandoned baskets in the MCH.  Initially 2 options came to mind: <br><br><ol><li>  With each change of the basket (add / delete goods), we repeat this action in the MCH.  From minuses - a huge amount of requests to an external service immediately suggests itself. </li><li>  Once in n minutes to watch baskets that have not changed more than an hour ago.  Then send them to the MCH.  The problem is only one - to monitor the baskets, which were resumed after they went to the MCH. </li></ol><br>  To begin with, we make a request to our database (hereinafter ‚ÄúDB‚Äù) for our data in the window from 1 hour to 3. Why 3?  An hour after the last change, we send the cart to the system.  In the MCH, the minimum possible interval for sending the basket is 1 hour.  Therefore, in theory, in 2 hours ¬± 5 minutes, the letter will be sent.  So 3 hours is a value even with a margin. <br><br>  After receiving the data from the database, we make a get request to the address / ecommerce / stores / {store_id} / carts.  Thus, we receive all the baskets that are sitting in the e-commerce system and are waiting for their turn to be shipped (or have already been sent).  Why do we need it?  It is necessary to synchronize with our data.  We will send all baskets received from the database, but we need to remove those that are no longer in the range of 1-3 hours.  After 3x - already irrelevant data.  Up to an hour - baskets, which could resume again, or place an order. <br><br>  To delete, we just need to find the difference between the two arrays / collections of baskets. <br>  After receiving the baskets that need to be deleted, we send a delete request / ecommerce / stores / {store_id} / carts / {cart_id}. <br><br>  Then we take the baskets for loading and cycle them by post-requests to the system. <br><br>  Basket options look something like this: <br><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1207'</span></span>, <span class="hljs-string"><span class="hljs-string">'customer'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'25'</span></span>, <span class="hljs-string"><span class="hljs-string">'email_address'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'email@example.com'</span></span>, <span class="hljs-string"><span class="hljs-string">'opt_in_status'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, ], <span class="hljs-string"><span class="hljs-string">'currency_code'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'RUB'</span></span>, <span class="hljs-string"><span class="hljs-string">'order_total'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1597</span></span>, <span class="hljs-string"><span class="hljs-string">'checkout_url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://***.ru/cart/abandoned/?cart=eyJpdGVtcyI6eyI1OTgwIjoxLCIzNDA0IjoxLCI3NzMiOjEsIjkwNTgiOjEsIjkwOTEiOjEsIjE4ODciOjEsIjc4NCI6MSwiNTExMSI6MSwiODA1MyI6MSwiMTk0MSI6MSwiNTQ0NSI6MSwiNzk1NCI6MywiOTA2NyI6NCwiOTA2NSI6NCwiNzg0MyI6MSwiOTA2NiI6M30sInByb21vY29kZSI6bnVsbH0%253D'</span></span>, <span class="hljs-string"><span class="hljs-string">'lines'</span></span> =&gt; [ <span class="hljs-number"><span class="hljs-number">0</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'123'</span></span>, <span class="hljs-string"><span class="hljs-string">'product_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'5980'</span></span>, <span class="hljs-string"><span class="hljs-string">'product_variant_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'5980'</span></span>, <span class="hljs-string"><span class="hljs-string">'quantity'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">841</span></span>, ], <span class="hljs-number"><span class="hljs-number">1</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'124'</span></span>, <span class="hljs-string"><span class="hljs-string">'product_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3404'</span></span>, <span class="hljs-string"><span class="hljs-string">'product_variant_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3404'</span></span>, <span class="hljs-string"><span class="hljs-string">'quantity'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">756</span></span>, ], ], ]</code> //***.ru/cart/abandoned/ cart = eyJpdGVtcyI6eyI1OTgwIjoxLCIzNDA0IjoxLCI3NzMiOjEsIjkwNTgiOjEsIjkwOTEiOjEsIjE4ODciOjEsIjc4NCI6MSwiNTExMSI6MSwiODA1MyI6MSwiMTk0MSI6MSwiNTQ0NSI6MSwiNzk1NCI6MywiOTA2NyI6NCwiOTA2NSI6NCwiNzg0MyI6MSwiOTA2NiI6M30sInByb21vY29kZSI6bnVsbH0% 253D?', <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1207'</span></span>, <span class="hljs-string"><span class="hljs-string">'customer'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'25'</span></span>, <span class="hljs-string"><span class="hljs-string">'email_address'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'email@example.com'</span></span>, <span class="hljs-string"><span class="hljs-string">'opt_in_status'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, ], <span class="hljs-string"><span class="hljs-string">'currency_code'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'RUB'</span></span>, <span class="hljs-string"><span class="hljs-string">'order_total'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1597</span></span>, <span class="hljs-string"><span class="hljs-string">'checkout_url'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://***.ru/cart/abandoned/?cart=eyJpdGVtcyI6eyI1OTgwIjoxLCIzNDA0IjoxLCI3NzMiOjEsIjkwNTgiOjEsIjkwOTEiOjEsIjE4ODciOjEsIjc4NCI6MSwiNTExMSI6MSwiODA1MyI6MSwiMTk0MSI6MSwiNTQ0NSI6MSwiNzk1NCI6MywiOTA2NyI6NCwiOTA2NSI6NCwiNzg0MyI6MSwiOTA2NiI6M30sInByb21vY29kZSI6bnVsbH0%253D'</span></span>, <span class="hljs-string"><span class="hljs-string">'lines'</span></span> =&gt; [ <span class="hljs-number"><span class="hljs-number">0</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'123'</span></span>, <span class="hljs-string"><span class="hljs-string">'product_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'5980'</span></span>, <span class="hljs-string"><span class="hljs-string">'product_variant_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'5980'</span></span>, <span class="hljs-string"><span class="hljs-string">'quantity'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">841</span></span>, ], <span class="hljs-number"><span class="hljs-number">1</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'124'</span></span>, <span class="hljs-string"><span class="hljs-string">'product_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3404'</span></span>, <span class="hljs-string"><span class="hljs-string">'product_variant_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3404'</span></span>, <span class="hljs-string"><span class="hljs-string">'quantity'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">756</span></span>, ], ], ]</code> </pre><br>  And again our favorite rubric is ‚Äúguess how these fields work‚Äù.  For example, the method of scientific tyke revealed that it is possible not to create a buyer by a separate request.  It is necessary to transfer the minimum required set of fields, and it will automatically be created if it was not in the system.  In our case, we are limited to id, email, opt_in_status.  The last parameter is responsible for the subscription status of the user in our list.  If it is true, then this means the state is subscribed, otherwise transactional. <br><br>  The product list is easily loaded via the Cart Lines array, which in turn is the Cart entity resource.  Those.  we can separately manage this set using rest requests. <br><br>  Well, that seems to be all?  And no. <br><br>  When testing, we noticed that by sending the same basket, it is sent only once.  Although we removed it from the system and downloaded it again.  Nothing is said anywhere, not a single word!  As a result, empirically, with the help of some mother, we accepted the hypothesis that the basket with the same id can be sent only once. <br><br>  Here I fully agree with the creators that this restriction protects us from spamming users.  But write about it!  We do not need quests, we have enough of mystical errors in the code that we write. <br><br>  After we did all this, MCH began to send us beautiful letters about an abandoned basket.  And then the second question appeared.  If the user dropped the basket and returned from the letter to his account, i.e., he was authorized at the moment of clicking on the link, he will get into his basket without any problems.  And so it turns out that the letter says to you "on!  Take your basket back! ‚Äù, and when we go to him we say‚Äú Oops, something has lost everything!  We did not touch anything!  It itself! " <br><br>  It was decided to encode the composition of the basket into a string and pass it to checkout_url when sending the basket to the MCH.  And when you go to the site to catch this line, decode and throw all the goods in the basket, not forgetting to completely reset it. <br><br>  Thus, no matter what browser we send the user to, he gets his cart, as we promised.  The only negative that he can only log in.  But authorizing through a link is moveton, and indeed it‚Äôs a dangerous business, first of all for our clients. <br>  What is the result?  In principle, there were no special problems in the implementation, since the MCH very often helped out with errors associated with the validation of the transmitted fields.  But there would be even fewer if they normally described all these subtleties of the MCH in a human way and described the fields in more detail. <br><br><h2>  Setting up a report in Google. Analytics </h2><br>  To track the success of the entire operation, you will have to set up and periodically look at the report in analytics.  Imagine that we all, like adults, have ecommerce connected, otherwise the miracle will not work :) <br><br>  To collect the new report under the abandoned basket, go to "My Reports": <br><br><img src="https://habrastorage.org/getpro/habr/post_images/afe/749/f87/afe749f87d1c6bd4e5a0810dab40b4ef.jpg" alt="My reports"><br><br>  Further "Add a report": <br><br><img src="https://habrastorage.org/getpro/habr/post_images/288/8bd/ba2/2888bdba2a5749ccc90c88c3f5c80f49.jpg" alt="Add report"><br><br>  And then add the parameters that will be monitored.  We decided that we would look at an abandoned basket in the context of cities, you may have another vision. <br><br>  At mailchimp, the standard campaign for an abandoned basket is ABANDONED_CART_EMAIL, we substitute it into the filter and get a report. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ca0/a77/b25/ca0a77b256b42242851ceaed308e02c7.jpg" alt="image"><br><br>  That's all forks! <br><br>  Now you are configured to send an abandoned basket and a report on which you can watch the exhaust from it.  And test, test, test!  ;) </div><p>Source: <a href="https://habr.com/ru/post/421393/">https://habr.com/ru/post/421393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421383/index.html">Epic Growth Conference Autumn 2018 - a conference on grocery marketing in Moscow</a></li>
<li><a href="../421385/index.html">Learn OpenGL. Lesson 5.10 - Screen Space Ambient Occlusion</a></li>
<li><a href="../421387/index.html">Interview with Lennart Pottering on Linux Piter about Linux changes, systemd, and why attend conferences</a></li>
<li><a href="../421389/index.html">Separation of administrative authority in Zimbra</a></li>
<li><a href="../421391/index.html">HackThings - a big hackathon on the Internet of things September 7-9 in Skoltech</a></li>
<li><a href="../421395/index.html">Rome Club Report 2018, Chapter 3.7: ‚ÄúClimate: good news, but big problems‚Äù</a></li>
<li><a href="../421397/index.html">Launch Mini AI Cup # 3. Battle machines in tight closed spaces</a></li>
<li><a href="../421399/index.html">Turla Cybergroup Outlook Backdoor Analysis</a></li>
<li><a href="../421401/index.html">Anatomy of recommendation systems. Part two</a></li>
<li><a href="../421403/index.html">Security Week 32: Fortnite Android Drama</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>