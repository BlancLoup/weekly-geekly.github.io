<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are writing the viewer of the MS Exchange mail database (part 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, readers Habrahabr! 

 This is the completion of the post started here . 

 In principle, we have already done almost everything; a small ending...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are writing the viewer of the MS Exchange mail database (part 2)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/bafc0a44/cfc9dfa2/7c32cd1f/9ca18694.png"><br>  Hello, readers Habrahabr! <br><br>  This is the completion of the post started <a href="http://habrahabr.ru/blogs/system_programming/116308/">here</a> . <br><br>  In principle, we have already done almost everything; a small ending is left.  Let me remind you, we took the EDB database, opened it using the ESE technology, listed the available tables and started listing the columns inside these tables.  It remains for us to get the columns, get the values ‚Äã‚Äãof the columns and voila, the base is read. <br><a name="habracut"></a><br>  In the previous post, I did not add a function responsible for moving to the next column in the table, as well as a description of the SColumnInfo structure, here they are: <br><blockquote>  <font color="#0000ff">typedef</font> <font color="#0000ff">struct</font> tagColumnInfo <br>  <font color="#008000">{</font> <br>  DWORD dwId <font color="#008080">;</font> <br>  std <font color="#008080">::</font> <font color="#007788">wstring</font> sName <font color="#008080">;</font> <br>  DWORD dwType <font color="#008080">;</font> <br>  DWORD dwMaxSize <font color="#008080">;</font> <br>  <font color="#008000">}</font> SColumnInfo <font color="#008080">;</font> </blockquote><br><blockquote>  <font color="#0000ff">bool</font> CJetDBReaderCore <font color="#008080">::</font> <font color="#007788">TableEnd</font> <font color="#008000">(</font> std <font color="#008080">::</font> <font color="#007788">wstring</font> sTableName <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  std <font color="#008080">::</font> <font color="#007788">map</font> <font color="#000080">&lt;</font> std <font color="#008080">::</font> <font color="#007788">wstring</font> , JET_TABLEID <font color="#000080">&gt;</font> <font color="#008080">::</font> <font color="#007788">const_iterator</font> iter <font color="#000080">=</font> m_tables.  <font color="#007788">find</font> <font color="#008000">(</font> sTableName <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">if</font> <font color="#008000">(</font> iter <font color="#000040">!</font> <font color="#000080">=</font> m_tables. <font color="#007788">end</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  <font color="#0000ff">if</font> <font color="#008000">(</font> _JetMove <font color="#008000">(</font> m_sesid, iter <font color="#000040">-</font> <font color="#000080">&gt;</font> second, JET_MoveNext, <font color="#0000dd">0</font> <font color="#008000">)</font> <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  <font color="#0000ff">return</font> <font color="#0000ff">true</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br>  <font color="#0000ff">else</font> <font color="#0000ff">return</font> <font color="#0000ff">false</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <font color="#0000ff">return</font> <font color="#0000ff">true</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> </blockquote><br>  Accordingly, when the transition to the next element fails, this is a sign that the table has <a href="http://msdn.microsoft.com/en-us/library/gg294117(v%3DEXCHG.10).aspx">ended</a> . <br><br>  We received a list of columns and brought them into our structures, it remains to get the values. <br><br><h5>  Get cell values ‚Äã‚Äãin columns </h5><br>  We write the following function: <br><blockquote>  JET_ERR CJetDBReaderCore <font color="#008080">::</font> <font color="#007788">EnumColumnsValues</font> <font color="#008000">(</font> <br>  SDBTableInfo <font color="#000040">&amp;</font> sTableInfo, <br>  std <font color="#008080">::</font> <font color="#007788">list</font> <font color="#000080">&lt;</font> SColumnInfo <font color="#000080">&gt;</font> <font color="#000040">&amp;</font> sColumnsInfo <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  <font color="#0000ff">typedef</font> std <font color="#008080">::</font> <font color="#007788">basic_string</font> <font color="#000080">&lt;</font> byte <font color="#000080">&gt;</font> CByteArray <font color="#008080">;</font> <br>  JET_ERR jRes <font color="#000080">=</font> OpenTable <font color="#008000">(</font> sTableInfo. <font color="#007788">STableName</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">if</font> <font color="#008000">(</font> jRes <font color="#000080">==</font> JET_errSuccess <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  JET_COLUMNLIST sColumnInfo <font color="#008080">;</font> <br>  jRes <font color="#000080">=</font> GetTableColumnInfo <font color="#008000">(</font> sTableInfo. <font color="#007788">sTableName</font> , <font color="#000040">&amp;</font> sColumnInfo, FALSE <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">if</font> <font color="#008000">(</font> jRes <font color="#000040">!</font> <font color="#000080">=</font> JET_errSuccess <font color="#008000">)</font> <font color="#0000ff">return</font> jRes <font color="#008080">;</font> <br><br>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#000040">!</font> MoveToFirst <font color="#008000">(</font> sTableInfo. <font color="#007788">sTableName</font> <font color="#008000">)</font> <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  std <font color="#008080">::</font> <font color="#007788">vector</font> <font color="#000080">&lt;</font> CByteArray <font color="#000080">&gt;</font> Holders <font color="#008000">(</font> sColumnsInfo. <font color="#007788">size</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  std <font color="#008080">::</font> <font color="#007788">vector</font> <font color="#000080">&lt;</font> CByteArray <font color="#000080">&gt;</font> <font color="#008080">::</font> <font color="#007788">iterator</font> HolderIt <font color="#000080">=</font> Holders.  <font color="#007788">begin</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  std <font color="#008080">::</font> <font color="#007788">vector</font> <font color="#000080">&lt;</font> JET_RETRIEVECOLUMN <font color="#000080">&gt;</font> Row <font color="#008000">(</font> sTableInfo. <font color="#007788">sColumnInfo</font> . <font color="#007788">size</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  std <font color="#008080">::</font> <font color="#007788">vector</font> <font color="#000080">&lt;</font> JET_RETRIEVECOLUMN <font color="#000080">&gt;</font> <font color="#008080">::</font> <font color="#007788">iterator</font> It <font color="#000080">=</font> Row.  <font color="#007788">begin</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  std <font color="#008080">::</font> <font color="#007788">list</font> <font color="#000080">&lt;</font> SColumnInfo <font color="#000080">&gt;</font> <font color="#008080">::</font> <font color="#007788">const_iterator</font> ColumnInfoIt <br>  <font color="#000080">=</font> sColumnsInfo.  <font color="#007788">begin</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">for</font> <font color="#008000">(</font> <font color="#0000ff">int</font> nColNum <font color="#000080">=</font> <font color="#0000dd">0</font> <font color="#008080">;</font> ColumnInfoIt <font color="#000040">!</font> <font color="#000080">=</font> sColumnsInfo. <font color="#007788">end</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#000040">++</font> ColumnInfoIt, <font color="#000040">++</font> It, <font color="#000040">++</font> HolderIt, <font color="#000040">++</font> nColNum <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  DWORD dwMaxSize <font color="#000080">=</font> ColumnInfoIt <font color="#000040">-</font> <font color="#000080">&gt;</font> dwMaxSize <font color="#008080">?</font>  ColumnInfoIt <font color="#000040">-</font> <font color="#000080">&gt;</font> dwMaxSize <font color="#008080">:</font> <br>  MAX_BUFFER_SIZE <font color="#008080">;</font> <br>  It <font color="#000040">-</font> <font color="#000080">&gt;</font> columnid <font color="#000080">=</font> ColumnInfoIt <font color="#000040">-</font> <font color="#000080">&gt;</font> dwId <font color="#008080">;</font> <br>  It <font color="#000040">-</font> <font color="#000080">&gt;</font> cbData <font color="#000080">=</font> dwMaxSize <font color="#008080">;</font> <br>  HolderIt <font color="#000040">-</font> <font color="#000080">&gt;</font> assign <font color="#008000">(</font> dwMaxSize, <font color="#FF0000">' <font color="#006699">\ 0</font> '</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  It <font color="#000040">-</font> <font color="#000080">&gt;</font> pvData <font color="#000080">=</font> <font color="#0000ff">const_cast</font> <font color="#000080">&lt;</font> byte <font color="#000040">*</font> <font color="#000080">&gt;</font> <font color="#008000">(</font> HolderIt <font color="#000040">-</font> <font color="#000080">&gt;</font> data <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  It <font color="#000040">-</font> <font color="#000080">&gt;</font> itagSequence <font color="#000080">=</font> <font color="#0000dd">1</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br><br>  <font color="#0000ff">do</font> <br>  <font color="#008000">{</font> <br>  GetColumns <font color="#008000">(</font> <br>  sTableInfo.  <font color="#007788">sTableName</font> , <font color="#000040">&amp;</font> Row <font color="#008000">[</font> <font color="#0000dd">0</font> <font color="#008000">]</font> , <br>  <font color="#0000ff">static_cast</font> <font color="#000080">&lt;</font> int <font color="#000080">&gt;</font> <font color="#008000">(</font> Row. <font color="#007788">size</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  ColumnInfoIt <font color="#000080">=</font> sColumnsInfo.  <font color="#007788">begin</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">int</font> iSubItem <font color="#000080">=</font> <font color="#0000dd">0</font> <font color="#008080">;</font> <br>  <font color="#0000ff">for</font> <font color="#008000">(</font> It <font color="#000080">=</font> Row. <font color="#007788">begin</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> It <font color="#000040">!</font> <font color="#000080">=</font> Row. <font color="#007788">end</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <font color="#000040">++</font> It, <br>  <font color="#000040">++</font> ColumnInfoIt, <font color="#000040">++</font> iSubItem <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  <font color="#0000ff">if</font> <font color="#008000">(</font> <font color="#008000">(</font> <font color="#000040">*</font> It <font color="#008000">)</font> . <font color="#007788">cbActual</font> <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  std <font color="#008080">::</font> <font color="#007788">wstring</font> s <font color="#008080">;</font> <br>  std <font color="#008080">::</font> <font color="#007788">string</font> tmp <font color="#008080">;</font> <br>  <font color="#0000ff">wchar_t</font> buff <font color="#008000">[</font> <font color="#0000dd">16</font> <font color="#008000">]</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">switch</font> <font color="#008000">(</font> ColumnInfoIt <font color="#000040">-</font> <font color="#000080">&gt;</font> dwType <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  <font color="#0000ff">case</font> JET_coltypBit <font color="#008080">:</font> <br>  s <font color="#000080">=</font> <font color="#000040">*</font> <font color="#0000ff">reinterpret_cast</font> <font color="#000080">&lt;</font> byte <font color="#000040">*</font> <font color="#000080">&gt;</font> <font color="#008000">(</font> <font color="#008000">(</font> <font color="#000040">*</font> It <font color="#008000">)</font> . <font color="#007788">pvData</font> <font color="#008000">)</font> <font color="#008080">?</font>  L <font color="#FF0000">"True"</font> <font color="#008080">:</font> L <font color="#FF0000">"False"</font> <font color="#008080">;</font> <br>  <font color="#0000ff">break</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> JET_coltypText <font color="#008080">:</font> <br>  tmp.  <font color="#007788">assign</font> <font color="#008000">(</font> <font color="#0000ff">reinterpret_cast</font> <font color="#000080">&lt;</font> <font color="#0000ff">char</font> <font color="#000040">*</font> <font color="#000080">&gt;</font> <font color="#008000">(</font> <font color="#008000">(</font> <font color="#000040">*</font> It <font color="#008000">)</font> . <font color="#007788">pvData</font> <font color="#008000">)</font> , <font color="#008000">(</font> <font color="#000040">*</font> It <font color="#008000">)</font> . <font color="#007788">cbActual</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  s.  <font color="#007788">assign</font> <font color="#008000">(</font> tmp. <font color="#007788">begin</font> <font color="#008000">(</font> <font color="#008000">)</font> , tmp. <font color="#007788">end</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">break</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> JET_coltypLongText <font color="#008080">:</font> <br>  s.  <font color="#007788">assign</font> <font color="#008000">(</font> <font color="#0000ff">reinterpret_cast</font> <font color="#000080">&lt;</font> <font color="#0000ff">wchar_t</font> <font color="#000040">*</font> <font color="#000080">&gt;</font> <font color="#008000">(</font> <font color="#008000">(</font> <font color="#000040">*</font> It <font color="#008000">)</font> . <font color="#007788">pvData</font> <font color="#008000">)</font> , <br>  <font color="#008000">(</font> <font color="#000040">*</font> It <font color="#008000">)</font> .  <font color="#007788">cbActual</font> <font color="#000040">/</font> <font color="#0000dd">sizeof</font> <font color="#008000">(</font> <font color="#0000ff">wchar_t</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">break</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> JET_coltypUnsignedByte <font color="#008080">:</font> <br>  s <font color="#000080">=</font> _ltow <font color="#008000">(</font> <font color="#000040">*</font> <font color="#0000ff">static_cast</font> <font color="#000080">&lt;</font> byte <font color="#000040">*</font> <font color="#000080">&gt;</font> <font color="#008000">(</font> <font color="#008000">(</font> <font color="#000040">*</font> It <font color="#008000">)</font> . <font color="#007788">pvData</font> <font color="#008000">)</font> , buff, <font color="#0000dd">10</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">break</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> JET_coltypShort <font color="#008080">:</font> <br>  s <font color="#000080">=</font> _ltow <font color="#008000">(</font> <font color="#000040">*</font> <font color="#0000ff">static_cast</font> <font color="#000080">&lt;</font> <font color="#0000ff">short</font> <font color="#000040">*</font> <font color="#000080">&gt;</font> <font color="#008000">(</font> <font color="#008000">(</font> <font color="#000040">*</font> It <font color="#008000">)</font> . <font color="#007788">pvData</font> <font color="#008000">)</font> , buff, <font color="#0000dd">10</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">break</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> JET_coltypLong <font color="#008080">:</font> <br>  s <font color="#000080">=</font> _ltow <font color="#008000">(</font> <font color="#000040">*</font> <font color="#0000ff">static_cast</font> <font color="#000080">&lt;</font> <font color="#000040">*</font> <font color="#000080">&gt;</font> <font color="#008000">(</font> <font color="#008000">(</font> <font color="#000040">*</font> It <font color="#008000">)</font> . <font color="#007788">pvData</font> <font color="#008000">)</font> , buff, <font color="#0000dd">10</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">break</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> JET_coltypGUID <font color="#008080">:</font> <br>  <font color="#0000ff">wchar_t</font> wszGuid <font color="#008000">[</font> <font color="#0000dd">64</font> <font color="#008000">]</font> <font color="#008080">;</font> <br>  <font color="#008080">::</font> <font color="#007788">StringFromGUID2</font> <font color="#008000">(</font> <font color="#000040">*</font> <font color="#0000ff">reinterpret_cast</font> <font color="#000080">&lt;</font> <font color="#0000ff">const</font> GUID <font color="#000040">*</font> <font color="#000080">&gt;</font> <font color="#008000">(</font> <font color="#008000">(</font> <font color="#000040">*</font> It <font color="#008000">)</font> . <font color="#007788">PvData</font> <font color="#008000">)</font> , <br>  wszGuid, <font color="#0000dd">sizeof</font> <font color="#008000">(</font> wszGuid <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  USES_CONVERSION <font color="#008080">;</font> <br>  s <font color="#000080">=</font> wszGuid <font color="#008080">;</font> <br>  <font color="#0000ff">break</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br><br>  sTableInfo.  <font color="#007788">sColumnInfo</font> <font color="#008000">[</font> iSubItem <font color="#008000">]</font> .  <font color="#007788">sColumnValues</font> .  <font color="#007788">push_back</font> <font color="#008000">(</font> s <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br><br>  <font color="#0000ff">else</font> sTableInfo.  <font color="#007788">sColumnInfo</font> <font color="#008000">[</font> iSubItem <font color="#008000">]</font> .  <font color="#007788">sColumnValues</font> .  <font color="#007788">push_back</font> <font color="#008000">(</font> L <font color="#FF0000">"&lt;empty&gt;"</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#008000">}</font> <br>  <font color="#008000">}</font> <br>  <font color="#0000ff">while</font> <font color="#008000">(</font> <font color="#000040">!</font> TableEnd <font color="#008000">(</font> sTableInfo. <font color="#007788">sTableName</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br><br>  jRes <font color="#000080">=</font> CloseTable <font color="#008000">(</font> sTableInfo. <font color="#007788">sTableName</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br><br>  <font color="#0000ff">return</font> jRes <font color="#008080">;</font> <br>  <font color="#008000">}</font> </blockquote><br>  We will go through all the lines and subtract the value of the cells for each.  And let's start with the fact that we move to the first element by setting the cursor to the appropriate position (function MoveToFirst, see the previous <a href="http://habrahabr.ru/blogs/system_programming/116308/">post</a> ). <br><br>  Everything is very similar to how we enumerated table names from MSysObjects, with one exception: then we knew that the data is of string type, and here the data can be arbitrary.  Therefore, we will create special Holders byte containers where we will save future information, and since this is a normal vector, we don‚Äôt have to think about cleaning the memory, it will be destroyed when we get out of sight of this function. <br><br>  Those.: <br><ul><li>  For brevity, we declare: <blockquote>  <font color="#0000ff">typedef</font> std <font color="#008080">::</font> <font color="#007788">basic_string</font> <font color="#000080">&lt;</font> byte <font color="#000080">&gt;</font> CByteArray </blockquote></li><li>  Create Holder'y for the data, and they will get information from the database: <blockquote>  std <font color="#008080">::</font> <font color="#007788">vector</font> <font color="#000080">&lt;</font> CByteArray <font color="#000080">&gt;</font> Holders <font color="#008000">(</font> sColumnsInfo. <font color="#007788">size</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </blockquote></li><li>  And then in the cycle we link the pieces of memory where the data and our holders will be returned, and for this we first allocate enough memory for them to hold all the information (we received the maximum data size when listing the columns): <blockquote>  HolderIt <font color="#000040">-</font> <font color="#000080">&gt;</font> assign <font color="#008000">(</font> dwMaxSize, <font color="#FF0000">' <font color="#006699">\ 0</font> '</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  It <font color="#000040">-</font> <font color="#000080">&gt;</font> pvData <font color="#000080">=</font> <font color="#0000ff">const_cast</font> <font color="#000080">&lt;</font> byte <font color="#000040">*</font> <font color="#000080">&gt;</font> <font color="#008000">(</font> HolderIt <font color="#000040">-</font> <font color="#000080">&gt;</font> data <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </blockquote></li><li>  And now in the cycle we will return the information for each column to our JET_RETRIEVECOLUMN vector, which uses the memory allocated for holders: <blockquote>  GetColumns <font color="#008000">(</font> sTableInfo. <font color="#007788">STableName</font> , <font color="#000040">&amp;</font> Row <font color="#008000">[</font> <font color="#0000dd">0</font> <font color="#008000">]</font> , <font color="#0000ff">static_cast</font> <font color="#000080">&lt;</font> INT <font color="#000080">&gt;</font> <font color="#008000">(</font> Row. <font color="#007788">Size</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> </blockquote></li></ul><br><br>  As a result, we subtract one line from the table.  But since  Data is an array of bytes, it needs to be converted to something more readable, so we will try to parse the cells depending on their types.  In this example, the following types are understood (as the most obvious): <br><ul><li>  JET_coltypBit </li><li>  JET_coltypText </li><li>  JET_coltypLongText </li><li>  JET_coltypUnsignedByte </li><li>  JET_coltypShort </li><li>  JET_coltypLong </li><li>  JET_coltypGUID </li></ul><br>  Description available in ESE types can be found <a href="http://msdn.microsoft.com/en-us/library/gg269213(v%3DEXCHG.10).aspx">here</a> . <br><br><h4>  Conclusion </h4><br>  So we wrote a viewer mail base!  If you start digging through these endless tables, you can find a lot of interesting things, for example, what has changed a lot in Exchange 2010 compared to all previous versions and much, much more. <br><br>  The fact that we wrote there is a significant drawback: visibility.  We filled out a bunch of structures that didn‚Äôt display.  Those.  you need to write a GUI program, which in a visual form shows the contents of all these structures.  Write it should be easy, because  It will be a collection of simple grids, the benefit of the structure we have already prepared and completed, that is, roughly speaking, it remains only to print.  I will give a couple of examples of such tables below. <br><br>  What did it give us practically?  On the one hand, not much, because  Most of the information is in binary form <b>JET_coltypBinary</b> and you will not find a description of this format anywhere.  Here, Exchange can‚Äôt do without <b>reverse engineering</b> .  But on the other hand, we can better understand ‚ÄúHow does it really work?‚Äù, And this can be invaluable information.  Plus, it is useful material for the "start" if you have to do something similar in the future. <br><br>  Where can it come in handy?  This can be useful only in cases when another API does not work or does not satisfy some requirements, for example, a performance requirement.  Examples of such tasks can be: antivirus, audit, migration and recovery systems. <br><br>  Finally, two small examples of the data. <br>  A piece of the list of tables in the database: <br><img src="https://habrastorage.org/storage/8f5ed03f/3855c882/9a9d2a47/325cbd73.png"><br><br>  List of folders and their types: <br><img src="https://habrastorage.org/storage/ee21aa3f/9dc7a88c/45fde8dd/db23ed4a.png"><br><br>  Thank you for reading and taking your time! <br><br>  PS This code is an <b>adapted</b> and reduced version for the post.  Therefore, there are some flaws in the code, or rather gags in the field of reduced functionality.  Please do not pay attention to them this is not production, but I wanted to show <b>working</b> examples.  The code is fully working and written so that it can be placed on the Internet and at the same time not ‚Äúeat‚Äù all the space on the page.  Thank you for understanding. <br><br>  PPS I understand that in view of the specificity of this information is unlikely to be useful for a wide range of people, but if it helps, even to one person, I will be glad, and the time spent on this post will pay off. <br><br><h5>  Related Links </h5><ol><li>  <a href="http://msdn.microsoft.com/en-us/library/gg269259(v%3DEXCHG.10).aspx">Extensible Storage Engine on MSDN</a> </li><li> <a href="">Article</a> in Russian (almost the only <a href="">article</a> in the Russian Internet about the use of ESE API) </li><li>  <a href="http://www.news2news.com/vfp/%3Fgroup%3D119%26%3D0">Examples of</a> using ESE features </li></ol></div><p>Source: <a href="https://habr.com/ru/post/116511/">https://habr.com/ru/post/116511/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116504/index.html">New SMS service SMS24X7.RU</a></li>
<li><a href="../116506/index.html">Four kinds of NTFS metadata</a></li>
<li><a href="../116508/index.html">SPB Shell 3D released</a></li>
<li><a href="../116509/index.html">Avtovaz and Glonass</a></li>
<li><a href="../116510/index.html">Android Market has launched an in-app payment system.</a></li>
<li><a href="../116512/index.html">PHP and API on uCoz</a></li>
<li><a href="../116513/index.html">"LiveJournal" has undergone a DDoS attack</a></li>
<li><a href="../116514/index.html">How not to shoot yourself in the foot</a></li>
<li><a href="../116515/index.html">First Belarusian Mobile Developer Conference</a></li>
<li><a href="../116516/index.html">Startup Weekend - to Ekaterinburg to a nakhalyav</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>