<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Consider agents "Auditor"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is no secret that the automated system "Auditor" monitors the control of locks on the list of prohibited information in Russia. How it works is wel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Consider agents "Auditor"</h1><div class="post__text post__text-html js-mediator-article">  It is no secret that the automated system "Auditor" monitors the control of locks on the list of prohibited information in Russia.  How it works is well written here in this <a href="https://habr.com/ru/company/cloud4y/blog/347964/">article on Habr</a> , the picture from the same place: <br><br><img src="https://habrastorage.org/webt/su/ur/bk/suurbkltagwxo_-8ahlb4p27flu.jpeg" alt="AS Revizor"><br><br>  Directly at the provider, <a href="https://portal.rfc-revizor.ru/docs/manualHarwareAgent20160229.pdf">the Agent Inspector module is</a> installed: <br><blockquote>  The module ‚ÄúAgent Revizor‚Äù is a structural element of the automated system ‚ÄúRevizor‚Äù (AS ‚ÄúRevizor‚Äù).  This system is designed to control the fulfillment by telecom operators of the requirements to restrict access within the provisions established by Articles 15.1-15.4 of the Federal Law of July 27, 2006 No. 149- ‚ÄúOn Information, Information Technologies and Information Protection‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main purpose of creating the Auditor is to ensure that telecom operators comply with the requirements established by Articles 15.1-15.4 of the Federal Law No. 149-FZ dated July 27, 2006 ‚ÄúOn Information, Information Technologies and Information Protection‚Äù in terms of identifying access to prohibited information and obtaining supporting materials (data) on violations to restrict access to prohibited information. <br></blockquote><br>  Considering the fact that if not all, then many providers installed this device, it should have turned out to be a large network of test beacons like <a href="https://atlas.ripe.net/probes/%3Fsearch%3D%26status%3D1%26af%3D%26country%3DRU">RIPE Atlas</a> and even more, but with private access.  However, the lighthouse is the lighthouse to send signals in all directions, but what if you catch them and see what we caught and how much? <br><a name="habracut"></a><br>  Before considering, let's see why this may be possible at all. <br><br><h3>  A bit of theory </h3><br>  Agents check the availability of the resource, including through HTTP (S) requests, like this one for example: <br><br><pre><code class="bash hljs">TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[SYN] Seq=0"</span></span> TCP, 80 &gt; 14678, <span class="hljs-string"><span class="hljs-string">"[SYN, ACK] Seq=0 Ack=1"</span></span> TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[ACK] Seq=1 Ack=1"</span></span> HTTP, <span class="hljs-string"><span class="hljs-string">"GET /somepage HTTP/1.1"</span></span> TCP, 80 &gt; 14678, <span class="hljs-string"><span class="hljs-string">"[ACK] Seq=1 Ack=71"</span></span> HTTP, <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 302 Found"</span></span> TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[FIN, ACK] Seq=71 Ack=479"</span></span> TCP, 80 &gt; 14678, <span class="hljs-string"><span class="hljs-string">"[FIN, ACK] Seq=479 Ack=72"</span></span> TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[ACK] Seq=72 Ack=480"</span></span></code> </pre> <br>  In addition to the payload, the request also consists of the connection setup phase: the <code>SYN</code> and <code>SYN-ACK</code> exchange, and the call completion phase: <code>FIN-ACK</code> . <br><br>  The registry of prohibited information contains several types of locks.  Obviously, if the resource will be blocked by IP address or domain name, then we will not see any requests.  These are the most destructive types of blocking that lead to the unavailability of all resources on one IP address or all information on a domain.  There is also a type of ‚Äúby URL‚Äù lock.  In this case, the filtering system must parse the HTTP request header to determine exactly what to block.  And, as can be seen above, the connection setup phase should happen to it, which you can try to track down, since the filter will most likely pass it. <br><br>  To do this, select a suitable free domain with a blocking type ‚Äúby URL‚Äù and HTTP to facilitate the operation of the filtering system, preferably long abandoned, to minimize the ingress of unauthorized traffic except from Agents.  This task turned out to be not at all difficult, there are a lot of free domains in the registry of prohibited information and for every taste.  Therefore, the domain was acquired, tied to IP addresses on a VPS running <code>tcpdump</code> and the counting began. <br><br><h3>  Audit of "Auditors" </h3><br>  I expected to see periodic bursts of requests, which would tell in my opinion about the controlled action.  It is impossible to say that I didn‚Äôt see it at all, but there was definitely no clear picture: <br><br> <a href=""><img src="https://habrastorage.org/webt/h2/g3/km/h2g3kmutwnwd0okyaeh4n5siymw.png" alt="Source dump"></a> <br><br>  That is not surprising, even an unnecessary domain for never used IP will be sent to just a lot of unsolicited information, this is the modern Internet.  But fortunately, I needed only URL-specific requests, so all scanners and password pererabotchiki were quickly found.  Also, it was enough just to understand where the flood is in the mass of similar requests.  Then I made up the frequency of occurrence of IP addresses and walked around the top manually separating those who slipped in the previous stages.  Additionally, I cut out all the sources that were sent in one package, there were not many of them.  And it turned out this: <br><br> <a href=""><img src="https://habrastorage.org/webt/qk/ub/zq/qkubzqtbua5tty6vppqyzx-k5yw.png" alt="Requests for Auditors"></a> <br><br>  A small lyrical digression.  A little more than a day later, my hosting provider sent a letter of rather streamlined content, they say there is a resource from the forbidden list of the RKN at your facilities, so it is blocked.  At first I thought that my account was blocked, it was not.  Then I thought that I was just warned about what I already know.  But it turned out that the hoster turned on its filter in front of my domain and in the end I came under double filtering: from the providers and from the hoster.  The filter passed only the ends of the requests: <code>FIN-ACK</code> and <code>RST</code> cutting off all HTTP at the banned URL.  As can be seen from the graph above, after the first day I began to receive less data, but I still got them, which was quite enough for the task of counting the sources of requests. <br><br>  Get to the point.  In my opinion, two bursts are clearly seen every day, the first one is smaller, after midnight Moscow time, the second is closer to 6 am with the tail before 12 noon.  Peak does not occur at exactly the same time.  At first, I wanted to single out the IP addresses that fell only during these periods, and each one for all periods, assuming that the checks by the Agents are performed periodically.  But upon careful viewing, I rather quickly found periods falling into other intervals, with different frequencies, up to one request every hour.  Then I thought about time zones and what was possible in them, then I thought that in general the system might not be globally synchronized.  In addition, for sure, NAT will play its role, and the same Agent can make requests from different public IP. <br><br>  Since my original goal was not exactly, I considered in general all the addresses that were caught in a week and received - <b>2791</b> .  The number of TCP sessions established from one address is on average 4, with a median of 2. Top sessions per address: 464, 231, 149, 83, 77. The maximum of 95% of the sample is 8 sessions per address.  The median is not very high, let me remind you that the schedule shows a clear daily frequency, so you could expect something around 4 to 8 in 7 days.  If we throw out all the once-encountered sessions, then we just get the median equal to 5. But I could not exclude them on a clear sign.  On the contrary, a random test showed that they are related to requests for a prohibited resource. <br><br>  Addresses are addresses, and on the Internet, autonomous systems, AS, are <b>1510</b> , an average of 2 addresses on AS with median 1. Top addresses on AS: 288, 77, 66, 39, 27. The maximum of 95% of the sample is 4 addresses on AS.  Here the median is expected - one Agent per provider.  Top is also expected - there are big players in it.  In a large network, Agents, probably, should be located in each region of the operator‚Äôs presence, and we don‚Äôt forget about NAT.  If we take the countries, the maximums will be: 1409 - RU, 42 - UA, 23 - CZ, 36 from other regions, not the RIPE NCC.  Inquiries not from Russia draw attention to themselves.  Probably, this can be explained by geolocation errors or recorder errors when filling in the data.  Or the fact that the Russian company may have non-Russian roots, or have a foreign representation because it is easier that it is natural to deal with the foreign organization RIPE NCC.  Some part is undoubtedly superfluous, but it is authentically difficult to separate it, since the resource is under blocking, and from the second day under double blocking and most of the sessions represent only the exchange of several service packets.  We agree on the fact that this is a small part. <br><br>  These numbers can already be compared with the number of providers in Russia.  <a href="https://rkn.gov.ru/communication/register/license/">According to the ILK of</a> licenses for Data Communication Services, with the exception of voice, 6387, but this is a highly priced estimate from above, not all of these licenses are for Internet providers who need to install an Agent.  In the RIPE NCC zone, a similar number of AS are registered in Russia - 6,230, of which not all providers.  <a href="https://habr.com/ru/post/345258/">UserSide made a more rigorous calculation</a> and received 3,940 companies in 2017, and this is more of a top rating.  In any case, we have the number of illuminated AS two and a half times less.  But here it is understood that the AS is not strictly equal to the provider.  Some providers do not have their own AS, some have more than one.  If we assume that Agents still stand at all, then someone filters more strongly than the others, so their requests are indistinguishable from garbage, if at all.  But for a rough assessment it is quite tolerable, even if something is lost due to my mistake. <br><br><h3>  About DPI </h3><br>  Despite the fact that my hosting provider turned on its filter starting from the second day, according to the information for the first day, it can be concluded that the locks are working successfully.  Only 4 sources were able to break through and have fully completed HTTP and TCP sessions (as in the example above).  Another 460 can send <code>GET</code> , but the session instantly terminates on <code>RST</code> .  Pay attention to <code>TTL</code> : <br><br><pre> <code class="bash hljs">TTL 50, TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[SYN] Seq=0"</span></span> TTL 64, TCP, 80 &gt; 14678, <span class="hljs-string"><span class="hljs-string">"[SYN, ACK] Seq=0 Ack=1"</span></span> TTL 50, TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[ACK] Seq=1 Ack=1"</span></span> HTTP, <span class="hljs-string"><span class="hljs-string">"GET /filteredpage HTTP/1.1"</span></span> TTL 64, TCP, 80 &gt; 14678, <span class="hljs-string"><span class="hljs-string">"[ACK] Seq=1 Ack=294"</span></span> <span class="hljs-comment"><span class="hljs-comment">#    TTL 53, TCP, 14678 &gt; 80, "[RST] Seq=3458729893" TTL 53, TCP, 14678 &gt; 80, "[RST] Seq=3458729893" HTTP, "HTTP/1.1 302 Found" #       TTL 50, TCP ACKed unseen segment, 14678 &gt; 80, "[ACK] Seq=294 Ack=145" TTL 50, TCP, 14678 &gt; 80, "[FIN, ACK] Seq=294 Ack=145" TTL 64, TCP, 80 &gt; 14678, "[FIN, ACK] Seq=171 Ack=295" TTL 50, TCP Dup ACK 14678 &gt; 80 "[ACK] Seq=295 Ack=145" #      TTL 50, TCP, 14678 &gt; 80, "[RST] Seq=294" TTL 50, TCP, 14678 &gt; 80, "[RST] Seq=295"</span></span></code> </pre><br>  Variations of this can be different: less <code>RST</code> or more retransmitts - it also depends on what the filter sends to the source node.  In any case, this is the most reliable template from which it is clear that it was the forbidden resource that was requested.  Plus there is always an answer that appears in a session with a <code>TTL</code> larger than in the previous and subsequent packets. <br><br>  From the rest you can not even see <code>GET</code> : <br><br><pre> <code class="bash hljs">TTL 50, TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[SYN] Seq=0"</span></span> TTL 64, TCP, 80 &gt; 14678, <span class="hljs-string"><span class="hljs-string">"[SYN, ACK] Seq=0 Ack=1"</span></span> <span class="hljs-comment"><span class="hljs-comment">#    TTL 53, TCP, 14678 &gt; 80, "[RST] Seq=1"</span></span></code> </pre><br>  Or so: <br><br><pre> <code class="bash hljs">TTL 50, TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[SYN] Seq=0"</span></span> TTL 64, TCP, 80 &gt; 14678, <span class="hljs-string"><span class="hljs-string">"[SYN, ACK] Seq=0 Ack=1"</span></span> TTL 50, TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[ACK] Seq=1 Ack=1"</span></span> <span class="hljs-comment"><span class="hljs-comment">#    TTL 53, TCP, 14678 &gt; 80, "[RST, PSH] Seq=1" TTL 50, TCP ACKed unseen segment, 14678 &gt; 80, "[FIN, ACK] Seq=89 Ack=172" TTL 50, TCP ACKed unseen segment, 14678 &gt; 80, "[FIN, ACK] Seq=89 Ack=172" # ,   TTL 53, TCP, 14678 &gt; 80, "[RST, PSH] Seq=1" ...</span></span></code> </pre><br>  The difference in the <code>TTL</code> is surely visible if something arrives from the filter.  But often nothing can fly at all: <br><br><pre> <code class="bash hljs">TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[SYN] Seq=0"</span></span> TCP, 80 &gt; 14678, <span class="hljs-string"><span class="hljs-string">"[SYN, ACK] Seq=0 Ack=1"</span></span> TCP Retransmission, 80 &gt; 14678, <span class="hljs-string"><span class="hljs-string">"[SYN, ACK] Seq=0 Ack=1"</span></span> ...</code> </pre><br>  Or so: <br><br><pre> <code class="bash hljs">TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[SYN] Seq=0"</span></span> TCP, 80 &gt; 14678, <span class="hljs-string"><span class="hljs-string">"[SYN, ACK] Seq=0 Ack=1"</span></span> TCP, 14678 &gt; 80, <span class="hljs-string"><span class="hljs-string">"[ACK] Seq=1 Ack=1"</span></span> <span class="hljs-comment"><span class="hljs-comment">#     TCP, 80 &gt; 14678, "[FIN, ACK] Seq=1 Ack=1" TCP Retransmission, 80 &gt; 14678, "[FIN, ACK] Seq=1 Ack=1" ...</span></span></code> </pre><br>  And all this is repeated and is repeated and repeated, as can be seen on the graph, not just once, every day. <br><br><h3>  Pro IPv6 </h3><br>  The good news is it.  I can say for sure that from 5 different IPv6 addresses, periodic requests to the forbidden resource occur, exactly the behavior of the Agents that I expected.  And one of the IPv6 addresses does not fall under filtering and I see a full session.  From the other two I saw only one unfinished session, one of which was interrupted by the <code>RST</code> from the filter, the second in time.  Total only <b>7</b> . <br><br>  Since there are few addresses, I studied all of them in detail and it turned out that there are only 3 providers there, they can be applauded while standing!  Another address is cloud hosting in Russia (does not filter), another is a research center in Germany (there is a filter, where?).  But why they check the availability of prohibited resources is a good question.  The remaining two were made on a single request and are not in the limits of Russia, and one of them is filtered (after all, in transit?). <br><br>  Locks and Agents is a big brake on IPv6, the implementation of which is not moving very fast.  It is sad.  Those who solved this task can be fully proud of themselves. <br><br><h3>  Finally </h3><br>  I didn‚Äôt try to forgive me for 100% accuracy for this, I hope someone will want to repeat this work with more accuracy.  It was important for me to understand whether such an approach would work in principle.  The answer will be.  The obtained figures in the first approximation, I think, are quite reliable. <br><br>  What else could I do and what I was too lazy to do is to count the queries to the DNS.  They are not filtered, but they do not give much accuracy as they work only for the domain, and not for the entire URL.  The periodicity should be visible.  If you combine it with what is seen directly in the requests, then this will allow you to separate the superfluous and get more information.  It is even possible to determine the DNS developers used by providers and much more. <br><br>  I did not expect that for my VPS the hoster will also turn on its filter.  Maybe this is a common practice.  In the end, the RKN sends a request to delete the resource to the hoster.  But I was not surprised, and even somewhere played a benefit.  The filter worked very effectively by cutting off all the correct HTTP requests to the forbidden URL, but not the correct ones that passed through the filter of the providers before, even if in the form of endings: <code>FIN-ACK</code> and <code>RST</code> - a minus and a minus plus.  By the way, the IPv6 hoster is not filtered.  Of course, this affected the quality of the collected material, but still made it possible to see the frequency.  It turned out to be an important point when choosing a site for placing resources; do not forget to be interested in the organization of work with the list of prohibited sites and requests from the RKN. <br><br>  In the beginning, I compared the AU "Inspector" with <a href="https://atlas.ripe.net/">RIPE Atlas</a> .  This comparison is justified and a large network of Agents can be useful.  For example, determining the quality of resource availability from different providers in different parts of the country.  You can calculate delays, you can build graphs, you can analyze it all and see the changes occurring both locally and globally.  This is not the most direct way, but astronomers use ‚Äústandard candles‚Äù, why not use Agents?  Knowing (finding) their standard behavior, one can determine the changes that occur around them and how this affects the quality of the services provided.  And at the same time it is not necessary to independently place the probes on the network; Roskomnadzor has already supplied them. <br><br>  One more thing I want to touch on, every tool can be a weapon.  AS ‚ÄúRevizor‚Äù is a closed network, but Agents hand over all the giblets by sending requests for all resources from the prohibited list.  To have such a resource does not represent any problems.  In total, providers through Agents, unwittingly, talk about their network much more than they possibly would have: types of DPI and DNS, location of the Agent (central hub and service network?), Network markers of delays and losses - and this is only the most obvious.  Just as someone can monitor the actions of Agents to improve the availability of their resources, someone can do it for other purposes and there are no obstacles to this.  A double-edged and very versatile tool turned out, anyone can see this. </div><p>Source: <a href="https://habr.com/ru/post/450362/">https://habr.com/ru/post/450362/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45034/index.html">To start or introductory course in esoteric language</a></li>
<li><a href="../450340/index.html">How to analyze a competitor's site for free. Step-by-step instruction</a></li>
<li><a href="../450344/index.html">Under the white flag post, or How I saved your video course from appearing on the tracker</a></li>
<li><a href="../450354/index.html">Announced Windows Vision Skills (Preview)</a></li>
<li><a href="../450360/index.html">The architecture of the SPA-application exchange in 2019</a></li>
<li><a href="../450368/index.html">We get the absolute exchange rates from the paired cross-exchange rates</a></li>
<li><a href="../450372/index.html">How Amazon's algorithms determine who should fire</a></li>
<li><a href="../450374/index.html">RAM Expansion Board for Apple IIgs</a></li>
<li><a href="../45038/index.html">Test regular expressions in OnLine</a></li>
<li><a href="../450384/index.html">History of a little study of legacy code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>