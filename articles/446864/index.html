<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Energy, heat and water</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 2019 Almost in any electronics store you can buy one of the hundreds of possible sets of smart home. Take and set up in ‚Äú2 clicks‚Äù, connect...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Energy, heat and water</h1><div class="post__text post__text-html js-mediator-article"><h2>  Foreword </h2><br>  <i>2019</i>  <i>Almost in any electronics store you can buy one of the hundreds of possible sets of smart home.</i>  <i>Take and set up in ‚Äú2 clicks‚Äù, connect to the clouds, receive push events in the app / sms, and generally get all the necessary information anywhere in the world.</i> <br><br>  Ideal, but in my case did not work.  Several solutions that came to my hands actually turned out to be a limited set of certain functions, covering only part of my requests, and, moreover, imposing almost insurmountable restrictions.  And, as is usually the case, the fewer the restrictions, the more you need to dive into the subject area, to think out solutions and architectures yourself.  Therefore - the collective farm themselves :) <br><br><h2>  Tasks </h2><br>  1. obtain information about the quality of the power supply network (power surges, complete blackouts, etc.). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      2. have full UPS monitoring.  And in fact, have this very UPS based on the consequences of n2. <br><br>  3. receive information about temperature: <br><br><ol><li>  on the street </li><li>  houses </li><li>  in the attic (when the trash and tomatoes thrown there freeze) </li></ol><br>  4. Monitor the state of water consumption, alert if consumption has increased (suddenly there is a leakage, you do not weigh all the moisture sensors). <br><br>  5. Understand when someone is at home to automate the closing / opening of water. <br><br>  6. Readings of the gas meter and alert when the paid supply is over. <br>  + Other various sensors (humidity, opening, water pressure, pressure in the heating circuit, etc.). <br><br>  The global goal is to have a common interface where you can look at it all.  Get notes if something went wrong.  <s>And so that there is nothing for it</s> and give not a lot of money for it. <br><br><h2>  The composition of the complex at the moment </h2><br><ul><li>  UPS Energy PN-750 + battery per 100 Ah </li><li>  USB-&gt; RS232 converter based on PL2303 </li><li>  Router Tp-link tl-wr1043nd + </li><li>  1wire network master based on the purchased USB thermometer DS18B20 + PL-2303TA </li><li>  1wire 3 DS18B20 sensors </li><li>  1wire radioseti DS2423 based water meter module </li></ul><br>  Virtual server with Zabbix server outside the home network. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/38f/096/8dc/38f0968dcb30102ff286561853581a96.png" alt="image"><br><br><a name="habracut"></a><br><h2>  Stage 1. Infrastructure preparation </h2><br>  First of all, the question of physical reorganization arose: the router was moved to the bedside table near the vent mine, where UPS was planned to be installed.  The antenna to the Internet provider Ubiquiti Nanostation Loco M2 PoE was connected to the same outlet as the router in order to continue to be powered by UPS. <br><br>  I already had a dedicated Zabbix installation on a remote server and some experience with this application, so the theory of organizing the alert-ting, and the dashboard itself was not expected. <br><br>  The router is flashed in OpenWRT Chaos Calmer, VPN is configured to the network where the Zabbix server was located. <br><br>  I immediately added metrics in zabbix, having gotten the item template for openwrt.  Thus, I was able to monitor both the system and, for example, how many and which MAC addresses are connected to a point.  That in the future was supposed to serve as a decision to block the water in the house. <br><br><h2>  Stage 2. Choosing a UPS </h2><br>  The selection criteria were: <br><br><ul><li>  possibility of gas boiler (buderus) </li><li>  from 5 hours of boiler autonomy + internet equipment </li><li>  availability of monitoring interface </li><li>  low noise level (location - bedside table in the kitchen next to the vent shaft) </li><li>  due to limitations of placement and price - preferably one-battery design </li></ul><br>  Let us understand the possibility of meeting the criteria in order. <br><br>  <b>The ability of the gas boiler to work is</b> obsulovleny that the boiler requires pure sine, otherwise the pump engine will buzz and wear.  About this you can google a lot of articles. <br>  Ordinary (computer UPS) do not give such a sine, producing an approximated sinus. <br>  The second important factor is the presence of a ‚Äúthrough neutral‚Äù.  Everything is a bit more complicated, but it‚Äôs also easy to google, so I will not stop.  I can only say one thing - without a through neutral, the buderus did not work, or rather, fell into error, because the ionization sensor did not work and the boiler simply did not see the flame. <br><br>  As a subtotal of choosing UPS, the focus was shifted towards the online and line-interactive UPS. <br>  <b>From 5 hours of autonomy of the boiler + Internet equipment</b> give mainly UPS with external battery.  <b>Due to the limitations of the location and price - preferably one-battery design</b> .  Batteries 100ah according to calculations should have been enough for 8+ hours. <br><br>  <b>The presence of a monitoring interface</b> to at least know when the system has switched to a battery in order to go home in the winter and start a generator.  I did not have any special requirements here (as well as implementation experience).  I was looking for everything that comes with rs232 or usb interface. <br><br>  The requirement of <b>low noise</b> actually turned out to be a serious limitation and threw away a whole class of equipment ‚Äî online UPS, that is, they all work in the mode of continuous ventilation of the transformer (the fan does not turn off). <br><br>  Calling to the store "Energy", I got the last PN-750 with rs232 from the shop window.  Quite cheap, there were no wires in the kit. <br><br><h2>  Stage 3: UPS Setup </h2><br>  There are problems connecting the UPS.  I bought several USB-&gt; RS232 converters, read on the forums that energy uses the standard Megatec protocol and you can at least work with it through the Upsilon2000 software.  But how much I did not fight - there was complete silence on the serial interface.  A week later, the ordeals decided to disassemble the UPS and see what was there, spit on the warranty.  The problem turned out to be banal - the RS232 board was not connected to the UPS main board, and the connector was slightly broken.  Replaced the connector, plugged in and about a miracle, everything took off, although the firmware and issued a strange name UPS - SIN800 (it seems now I understand why the energy in the new models cut rs232). <br><br>  Under OpenWRT, there was a standard P / O for working with UPS: network ups tools, which has everything you need to display metrics to the console. <br><br><pre><code class="bash hljs">root@OpenWrt:/<span class="hljs-comment"><span class="hljs-comment"># upsc myups@127.0.0.1 battery.charge: 100 battery.voltage: 13.32 battery.voltage.high: 13.00 battery.voltage.low: 10.40 battery.voltage.nominal: 12.0 device.mfr: GERMANY device.model: SIN 800S device.type: ups driver.name: blazer_ser driver.parameter.cablepower: both driver.parameter.pollinterval: 2 driver.parameter.port: /dev/ttyUSB0 driver.parameter.protocol: megatec driver.version: 2.6.5 driver.version.internal: 1.55 input.current.nominal: 2.7 input.frequency: 50.0 input.frequency.nominal: 50 input.voltage: 225.7 input.voltage.fault: 225.7 input.voltage.nominal: 220 output.voltage: 219.6 ups.beeper.status: enabled ups.delay.shutdown: 30 ups.delay.start: 180 ups.firmware: Z1911F100 ups.load: 5 ups.mfr: GERMANY ups.model: SIN 800S ups.status: OL ups.temperature: 48.0 ups.type: online</span></span></code> </pre> <br>  And the most interesting is that under Zabbix there is a ready-made template for nut.  In general, we write a shell script from the tempate set into the zabbix-agent and we have a beautiful picture in the zabbix dynamics.  Task 1 and 2 were solved at this stage (and the idea of ‚Äã‚Äãmonitoring total energy consumption appeared in the future). <br><br><h2>  Stage 4: 1wire and temperature </h2><br>  Some time ago I bought a usb thermometer (combined converter board and sensor) on ebay. <br>  OpenWRT also turned out to be a suitable software, the digitemp_DS9097 utility.  It displayed the temperature of a single soldered sensor.  After reading that there is a 1wire, I realized that you can try not to be limited to one sensor and pick up the whole sensor bus to the purchased USB-converter.  Having taken several DS18B20 chips and ‚Äúbarrels‚Äù for a twisted pair in the store, I built a constructive with the removal of the sensor outside the barrel and an internal connection with 3 wires. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/758/029/d61/758029d613c7dfe66d3f45adee62c043.png" alt="image"><br><br>  I have known about this design for many years, we used this to take readings in data centers, but then I didn‚Äôt know about 1wire.  When connecting the barrels with each other with standard patch cords and switching this farm with a ‚ÄúUSB thermometer‚Äù, I got the values ‚Äã‚Äãfrom all 3 temperature sensors. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc2/7d5/d6f/dc27d5d6fac92cc21834fb59c6e0a759.png" alt="image"><br><br>  It remains to spread them in locations.  The total tire length was about 30 meters.  The signal does not disappear.  Placed on the street "barrel" filled with glue gun.  She lived through the winter. <br><br><h2>  Stage 5: water </h2><br>  I had to change the water meter at the inlet (it was not pulsed, without a reed switch).  Thanks to life in a country house, the plumber does not cause questions.  Bought at the nearest plumbing store and replaced.  In the new counter one pulse occurs every 10 liters of water.  Now these impulses need something to consider. <br><br>  For some reason, an interesting digital-counter chip, DS2423, was removed from production.  But it turned out that the guys from Volgograd (radioseti) have a ready-made device, which, thanks to the built-in battery, also counts the value of the number of pulses when electricity is lost.  However, the device itself was adapted to its own network architecture.  From RJ-11 connectors to a separate 12V power supply.  In my case, I wanted to limit the power supply to the existing bus (5V).  I had to bypass the ‚Äúextra‚Äù strapping and solder directly to the DS2423 pins directly.  Then the device worked, the values ‚Äã‚Äãof the registers became visible on the bus.  There are two of them, t to the device implies connection to two water meters simultaneously - Cold Water and Hot Water.  I have only one water inlet, so I only use the second register for tests. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f9b/fd5/05a/f9bfd505a9f2bcb9f93c0b9bc996c33f.png" alt="image"><br><br>  End result for 1wire topology: <br><br><pre> <code class="bash hljs">root@OpenWrt:/etc/zabbix<span class="hljs-comment"><span class="hljs-comment"># digitemp_DS9097 -c /etc/digitemp.conf -a DigiTemp v3.5.0 Copyright 1996-2007 by Brian C. Lane GNU Public License v2.0 - http://www.digitemp.com Apr 04 16:16:35 Sensor 0 C: 29.81 F: 85.66 Apr 04 16:16:36 Sensor 1 C: 14.00 F: 57.20 Apr 04 16:16:37 Sensor 2 C: 6.56 F: 43.81 Apr 04 16:16:37 Sensor 3 #0 6609 Apr 04 16:16:37 Sensor 3 #1 9</span></span></code> </pre><br><br>  By the way, since the new water meter was installed simultaneously with a digital counter of pulses, it is possible to draw conclusions about the divergence of readings / bounce of contacts.  Visually there are almost no such discrepancies (up to several hundred liters for the current reading of 60,000). <br><br><h2>  Stage 6: Alert </h2><br>  With the help of the collected information, we were able to make useful alerts: <br><br><ul><li>  temperature on the street in sms every morning (+ sensor participation in the narodmon project) </li><li>  UPS Battery Transfer Report </li><li>  low battery UPS </li><li>  low / high voltage message </li><li>  message about the heat in the nightstand with the equipment </li><li>  message about low temperature in the attic (saving tomatoes) </li><li>  message about the ‚Äúalien / new‚Äù mac address in the network </li><li>  report high water consumption (for a certain time) </li></ul><br><h2>  Stage 7: the future </h2><br>  On aliexpress, a ‚Äúdigital manometer‚Äù was bought with an rs232 output in the form of USB.  But as long as he has not fought him, he does not respond to packages.  We will think further.  I hope to doge. <br><br>  I plan to purchase a ball valve control relay (the crane itself is already there) for remote control of the crane and the possible implementation of an automatic shut-off of water in the absence of the owners home. <br><br>  Somehow to integrate the gallus digital gas meter into the scheme for notification of the ending deposit. <br><br><h3>  Finally, some graphs: </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/802/69c/2a6/80269c2a692b6c6ae3468404b106fbd7.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/fe6/6ae/85f/fe66ae85fdeb1184ed5a11a141a78d11.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/9b6/68b/a9a/9b668ba9a480320da3ad48dfab0b56fa.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/896/aa8/da6/896aa8da673ed49a69f28d4a4f39942b.png" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/446864/">https://habr.com/ru/post/446864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446852/index.html">TEMPEST and EMSEC: Is it possible to use electromagnetic waves in cyber attacks?</a></li>
<li><a href="../446854/index.html">Azure tech lab, April 11 in Moscow</a></li>
<li><a href="../446858/index.html">How to deploy SAP HANA: parse different methods</a></li>
<li><a href="../446860/index.html">History 3dfx Voodoo1</a></li>
<li><a href="../446862/index.html">What designers are waiting for at DUMP-2019: a review of the Design section</a></li>
<li><a href="../446866/index.html">Operating Systems: Three Easy Pieces. Part 2: Abstraction: The Process (Translation)</a></li>
<li><a href="../446876/index.html">Moscow, April 18 - QIWI SERVER PARTY 4.0</a></li>
<li><a href="../446880/index.html">Incorrect charts: our experience</a></li>
<li><a href="../446882/index.html">MIPT won the right to host the ICPC World Programming Championship in 2020 in Moscow</a></li>
<li><a href="../446884/index.html">What to read and see from fresh fiction: Mars, cyborg and the insurgent AI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>