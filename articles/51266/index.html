<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>(Java) Tomcat: doing cross-domain session</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task Description: 
 You are doing a java project under Tomcat. And they decided to organize the sections of their site in the form of subdomains. 
 Fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>(Java) Tomcat: doing cross-domain session</h1><div class="post__text post__text-html js-mediator-article"><h2>  Task Description: </h2><br>  You are doing a java project under Tomcat.  And they decided to organize the sections of their site in the form of subdomains. <br>  For example, on the website <em><a href="http://www.domen.xx/">www.domen.xx</a></em> make sections: <em>mail.domen.xx</em> , <em>user.domen.xx</em> , etc.  At some point in development, you will be surprised to find out that a user session, contrary to expectations, exists strictly within the same domain.  That is, the user is authorized on the main page ( <em><a href="http://www.domen.xx/">www.domen.xx</a></em> ), passing mail ( <em>mail.domen.xx</em> ), loses authorization. <br><br>  The point is that the session is attached to the client through a cookie called <em>JSESSIONID</em> and with an empty domain.  And when the domain is not specified, the browser uses the full current domain.  That is, the session is not tied to ‚Äúdomen.xx‚Äù, but to ‚Äúwww.domen.xx‚Äù.  For reasons unknown to me, there are no settings in Tomkat that allow you to control this behavior. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How to treat: </h2><br>  First, a little more about the session.  Session is obtained by calling the request.getSession () method.  Inside the method, the JSESSIONID cookie is read and the corresponding session is obtained from the ‚Äúrepository‚Äù.  If there is no session, it is created and a cookie is written to the response header with the new JSESSIONID value.  Here we appear!  All you need is to add the desired domain value ( <em>domen.xx</em> ) to the <em>cookie</em> . <br><br>  Tomcat provides the valve mechanism (Valve).  In fact, valve is a java-class that is called before each request is processed.  And as the reader guesses, it is this mechanism that will be used in the implementation.  We need to create a Valve class that will handle the session before processing each request.  And to replace the cookie if the session has just been created. <br><br><h2>  Implementation: </h2><br>  Valve class: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">package my.tomcat; <br> <br> import java.io.IOException; <br> <br> import javax.servlet.ServletException; <br> import javax.servlet.http.Cookie; <br> <br> import org.apache.catalina.Globals; <br> import org.apache.catalina.connector.Request; <br> import org.apache.catalina.connector.Response; <br> import org.apache.catalina.valves.ValveBase; <br> import org.apache.tomcat.util.http.ServerCookie; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> SubdomainSessionValve extends ValveBase { <br> <br> <font color="#008000">/**      */</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#2B91AF">String</font> DOMAIN = <font color="#A31515">"domain.xx"</font> ; <br> <br> @Override <br> <font color="#0000ff">public</font> <font color="#2B91AF">String</font> getInfo() { <br> <font color="#0000ff">return</font> <font color="#A31515">"my.tomcat.SubdomainSessionValve/1.0a"</font> ; <br> } <br> <br> @Override <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> invoke(Request req, Response res) <br> throws IOException, ServletException { <br> <br> fixSessionIdCookie(req); <br> <br> getNext().invoke(req, res); <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">void</font> fixSessionIdCookie(Request request) { <br> <font color="#0000ff">if</font> (getJsessionCookie(request.getCookies()) != <font color="#0000ff">null</font> ) <br> <font color="#0000ff">return</font> ; <br> <br> request.getSession(); <br> <br> Cookie cookie = getJsessionCookie(request.getResponse().getCookies()); <br> <font color="#0000ff">if</font> (cookie == <font color="#0000ff">null</font> ) <br> <font color="#0000ff">return</font> ; <br> <br> cookie.setDomain(DOMAIN); <br> <br> StringBuffer sb = <font color="#0000ff">new</font> StringBuffer(); <br> ServerCookie.appendCookieValue(sb, <br> cookie.getVersion(), cookie.getName(), cookie.getValue(), <br> cookie.getPath(), cookie.getDomain(), cookie.getComment(), <br> cookie.getMaxAge(), cookie.getSecure()); <br> <br> request.getResponse().setHeader( <font color="#A31515">"Set-Cookie"</font> , sb.toString()); <br> } <br> <br> <br> Cookie getJsessionCookie(Cookie[] cc) { <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; cc != <font color="#0000ff">null</font> &amp;&amp; i &lt; cc.length; i++) { <br> <font color="#0000ff">if</font> (Globals.SESSION_COOKIE_NAME.equals(cc[i].getName())) <br> <font color="#0000ff">return</font> cc[i]; <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  It remains to put the jar with this class in $ {TOMCAT_HOME} / server / lib and register in server.xml: <br><br>  &lt;Valve className = "my.tomcat.SubdomainSessionValve" /&gt; <br><br>  Or when starting the server from the application: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">org.apache.catalina.Context context; <br> <br> ....... <font color="#008000">//    </font> <br> <br> context.getPipeline().addValve( <font color="#0000ff">new</font> my.tomcat.SubdomainSessionValve());</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Thanks for attention. <br>  Good luck! </div><p>Source: <a href="https://habr.com/ru/post/51266/">https://habr.com/ru/post/51266/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../51259/index.html">Interesting coincidences. Part two.</a></li>
<li><a href="../51260/index.html">Help me choose an OS for a thin client.</a></li>
<li><a href="../51261/index.html">Brief testing of free antiviruses</a></li>
<li><a href="../51262/index.html">Commercial Twitter Spam Tool</a></li>
<li><a href="../51264/index.html">AddVenture - a crisis medicine for a Russian startup</a></li>
<li><a href="../51268/index.html">Google penetrated the body</a></li>
<li><a href="../51269/index.html">Not start, runet.</a></li>
<li><a href="../51271/index.html">Oak USB - a gift without a hint</a></li>
<li><a href="../51272/index.html">Free Acronis True Image 10 Personal Edition license</a></li>
<li><a href="../51275/index.html">Jajah turns iPod Touch into iPhone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>