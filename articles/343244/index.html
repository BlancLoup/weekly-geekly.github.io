<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Refactor with Roslyn</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Usually, refactoring seems to be hard work on bugs. Monotonous correction of past mistakes manually. But if our actions can be reduced to a transforma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Refactor with Roslyn</h1><div class="post__text post__text-html js-mediator-article"><p>  Usually, refactoring seems to be hard work on bugs.  Monotonous correction of past mistakes manually.  But if our actions can be reduced to a transformation algorithm over A to get B, then why not automate this process? </p><br><p>  There can be a lot of such cases - dependency inversion (as an example of architectural changes), adding attributes, introducing aspects (an example of adding end-to-end functionality) and various code layouts to classes and methods, as well as moving to a new version of the API - in this article we will look at this case in detail. </p><a name="habracut"></a><br><p>  All projects use API.  API modules, components, frameworks, operating systems, public API services - in most cases, these APIs are presented in the form of interfaces.  But everything is changing, changing API.  New versions appear, obsolete methods appear.  It would be cool to be able to automatically upgrade to the new version without the overhead of refactoring the project. </p><br><h2 id="vybor-instrumenta">  Tool selection </h2><br><p>  Veeam provides its developers with all the tools that the developer himself deems necessary.  And I have the best that can be useful for refactoring - ReSharper.  But‚Ä¶ </p><br><p>  In 2015, ReSharper had an <a href="https://youtrack.jetbrains.com/issue/RSRP-451569">issue</a> .  At the beginning of 2016, the issue RSRP-451569 changed its status to Submitted.  Also in 2016 the request was <a href="https://www.jetbrains.com/help/resharper/Reference__Code_Annotation_Attributes.html">updated</a> . </p><br><p>  I checked it on the last update - there is no necessary functionality, there are no prompts from the resharper or a special attribute in JetBrains.Annotations.  Instead of waiting for this functionality to appear with ReSharper, I decided to do this task on my own. </p><br><p>  The first thing that comes to mind when working on refactoring .NET code is IntelliSense.  But its API, in my opinion, is quite complex and confusing, and it is also strongly tied to Visual Studio.  Then I got my hand on such a thing as DTE (EnvDTE) - Development Tools Environment, in fact, it is an interface to all the features of the studio, which are accessible via the UI or the command line, you can use it to automate any sequence of actions that can be done in Visual Studio .  But DTE is an uncomfortable thing, it constantly requires an action context, i.e.  emulate a whole programmer.  Trivial actions, such as finding a definition of a method, were not easy.  In the process of overcoming the difficulties of working with DTE, I came across a video of the report by Alexander Kugushev: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/8stwekff5YI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  I was interested in the report, I tried and realized that solving such problems with the help of Roslyn is much more natural.  And do not forget about the useful Syntax Visualizer, which will help you understand how your code is organized at the language level. </p><br><p>  So I chose my tool .NET Compiler Platform "Roslyn". </p><br><h2 id="avtomatizuem-nashu-zadachu">  Automating our task </h2><br><p> Consider this problem on an artificial example.  Suppose we have an API with outdated methods, label them with the <code>[Obsolete]</code> attribute and indicate in the message which method should be replaced. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAppService</span></span> { [Obsolete(<span class="hljs-string"><span class="hljs-string">"Use DoSomethingNew"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomethingNew</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; [Obsolete(<span class="hljs-string"><span class="hljs-string">"Use TestNew"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestNew</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br><p>  and its untagged implementation of the attributes </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DoService</span></span> : <span class="hljs-title"><span class="hljs-title">IAppService</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"This is obsolete method. Use DoSomethingNew."</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomethingNew</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Good."</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"This is obsolete method. Use TestNew."</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestNew</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Good."</span></span>); } }</code> </pre> <br><p>  An example of using our interface, since here we turn to IAppService, we get a compiler warning that the method is outdated. </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Test</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IAppService service { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoService(); service.DoSomething(); service.Test(); } }</code> </pre> <br><p>  And here we use an instance of the implementation of this interface and no longer receive a warning. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//no warning highlighted var doService = new DoService(); doService.DoSomething(); //will be highlighted //IAppService service = doService as IAppService; //service.DoSomething(); doService.Test(); } static void Test() { var doService = new DoService(); doService.DoSomething(); doService.Test(); } }</span></span></code> </pre> <br><p>  <strong>We correct the situation</strong> </p><br><p>  The use of Roslyn entails the use of declarative programming and a functional approach, and here the main thing is to set the Main Goal and describe it carefully.  Our main goal is to replace all outdated methods with their new analogues.  We describe. </p><br><ol><li>  Replace the outdated method with a new one. <br>  How? </li><li>  Find a pair of the obsolete-new method and replace the obsolete method with a new one. <br>  Where? </li><li>  In the API class, find the outdated-new method and replace the outdated method with a new one. <br>  How? </li><li>  Find the definition of the method that has the <code>[Obsolete]</code> attribute in the API class and find the outdated-new pair and replace the outdated method with a new one. <br>  Where to get a new one? </li><li>  In the <code>[Obsolete]</code> attribute message, you will find the name of the new method for the found method definition, which has the <code>[Obsolete]</code> attribute in the API class, where you will find the outdated-new method pair and replace the outdated method with a new one. <br>  Where to replace? </li><li>  For all references to the outdated method (although you can make exceptions for some projects and classes), in the message of the <code>[Obsolete]</code> attribute you will find the name of the new method for the found definition of the method that has the <code>[Obsolete]</code> attribute in the API class where you find the outdated pair -New method and replace the outdated method with a new one. </li></ol><br><p>  The refactoring algorithm is ready, except for the lack of technical aspects of working with the three pillars of the .NET code - Document, Syntax Tree, Semantic Model.  This is all very similar to lambda.  In them we will express our main goal. </p><br><p>  <strong>Infrastructure</strong> <br>  The infrastructure for our solution is the Document, Syntax Tree, Semantic Model. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Project Project { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MSBuildWorkspace Workspace { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Solution Solution { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Refactorer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> solutionPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> projectName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// start Roslyn workspace Workspace = MSBuildWorkspace.Create(); // open solution we want to analyze Solution = Workspace.OpenSolutionAsync(solutionPath).Result; // find target project Project = Solution.Projects.FirstOrDefault(p =&gt; p.Name == projectName); } public void ReplaceObsoleteApiCalls(string interfaceClassName, string obsoleteMessagePattern) {...}</span></span></code> </pre> <br><p>  We take the missing data from the outside, you need the full path to the solution, which contains the project with the API and the projects in which it is used - with a little refinement you can place them in different solutions.  You also need to specify the class name of the API interface. If your API is built on an abstract class or something else, then use Syntax Visualizer to see what type of definition of this class is. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> solutionPath = <span class="hljs-string"><span class="hljs-string">"..\Sample.sln"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> projectName = <span class="hljs-string"><span class="hljs-string">"ObsoleteApi"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> interfaceClassName = <span class="hljs-string"><span class="hljs-string">"IAppService"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> refactorererApi = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Refactorer(solutionPath, projectName); refactorererApi.ReplaceObsoleteApiCalls(interfaceClassName, <span class="hljs-string"><span class="hljs-string">"Use "</span></span>);</code> </pre> <br><p>  private infrastructure elements will be obtained in <code>ReplaceObsoleteApiCalls</code> </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> document = GetDocument(interfaceClassName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = document.GetSemanticModelAsync().Result; SyntaxNode root = document.GetSyntaxRootAsync().Result;</code> </pre> <br><p>  We return to the algorithm and answer simple questions in it, we need to start from the end. <br>  <em>4. Find the definition of the method that has the <code>[Obsolete]</code> attribute 3. In the API class</em> </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// direction from point 3 var targetInterfaceClass = root.DescendantNodes().OfType&lt;InterfaceDeclarationSyntax&gt;() .FirstOrDefault(c =&gt; c.Identifier.Text == interfaceClassName); var methodDeclarations = targetInterfaceClass.DescendantNodes().OfType&lt;MethodDeclarationSyntax&gt;().ToList(); var obsoleteMethods = methodDeclarations .Where(m =&gt; m.AttributeLists .FirstOrDefault(a =&gt; a.Attributes .FirstOrDefault(atr =&gt; (atr.Name as IdentifierNameSyntax).Identifier.Text == "Obsolete") != null) != null).ToList();</span></span></code> </pre> <br><p>  <em>2. Find a pair of obsolete-new method</em> </p><br><pre> <code class="cs hljs">List&lt;ObsoleteReplacement&gt; replacementMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ObsoleteReplacement&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> method <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> obsoleteMethods) { <span class="hljs-comment"><span class="hljs-comment">// find new mthod for replace - explain in point 5 var methodName = GetMethodName(obsoleteMessagePattern, method); if (methodDeclarations.FirstOrDefault(m =&gt; m.Identifier.Text == methodName) != null) { // find all reference of obsolete call - explain in point 6 var usingReferences = GetUsingReferences(model, method); replacementMap.Add(new ObsoleteReplacement() { ObsoleteMethod = SyntaxFactory.IdentifierName(method.Identifier.Text), ObsoleteReferences = usingReferences, NewMethod = SyntaxFactory.IdentifierName(methodName) }); } }</span></span></code> </pre> <br><p>  <em>1. Replace the outdated method with a new one.</em> </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateSolutionWithAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List&lt;ObsoleteReplacement&gt; replacementMap, Action&lt;DocumentEditor, ObsoleteReplacement, SyntaxNode&gt; action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> workspace = MSBuildWorkspace.Create(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> replacementMap) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> solution = workspace.OpenSolutionAsync(Solution.FilePath).Result; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> project = solution.Projects.FirstOrDefault(p =&gt; p.Name == Project.Name); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reference <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> item.ObsoleteReferences) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> docs = reference.Locations.Select(l =&gt; l.Document); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> doc <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> docs) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> document = project.Documents.FirstOrDefault(d =&gt; d.Name == doc.Name); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> documentEditor = DocumentEditor.CreateAsync(document).Result; action(documentEditor, item, document.GetSyntaxRootAsync().Result); document = documentEditor.GetChangedDocument(); solution = solution.WithDocumentSyntaxRoot(document.Id, document.GetSyntaxRootAsync().Result.NormalizeWhitespace()); } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = workspace.TryApplyChanges(solution); workspace.CloseSolution(); } UpdateRefactorerEnv(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReplaceMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DocumentEditor documentEditor, ObsoleteReplacement item, SyntaxNode root</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> identifiers = root.DescendantNodes().OfType&lt;IdentifierNameSyntax&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> usingTokens = identifiers.Where(i =&gt; i.Identifier.Text == item.ObsoleteMethod.Identifier.Text); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldMethod <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> usingTokens) { <span class="hljs-comment"><span class="hljs-comment">// The Most Impotant Moment Of Point 1 documentEditor.ReplaceNode(oldMethod, item.NewMethod); } }</span></span></code> </pre> <br><p>  Answering support questions. <br>  <em>5. In the message of the <code>[Obsolete]</code> attribute you will find the name of the new method</em> </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMethodName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obsoleteMessagePattern, MethodDeclarationSyntax method</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = GetAttributeMessage(method); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = message.LastIndexOf(obsoleteMessagePattern) + obsoleteMessagePattern.Length; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.Substring(index); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAttributeMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodDeclarationSyntax method</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> obsoleteAttribute = method.AttributeLists.FirstOrDefault().Attributes.FirstOrDefault(atr =&gt; (atr.Name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IdentifierNameSyntax).Identifier.Text == <span class="hljs-string"><span class="hljs-string">"Obsolete"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageArgument = obsoleteAttribute.ArgumentList.DescendantNodes().OfType&lt;AttributeArgumentSyntax&gt;() .FirstOrDefault(arg =&gt; arg.ChildNodes().OfType&lt;LiteralExpressionSyntax&gt;().Count() != <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = messageArgument.ChildNodes().FirstOrDefault().GetText(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.ToString().Trim(<span class="hljs-string"><span class="hljs-string">'\"'</span></span>); }</code> </pre> <br><p>  <em>6. For all references to the outdated method (although you can make exceptions for some projects and classes)</em> </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerable&lt;ReferencedSymbol&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetUsingReferences</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SemanticModel model, MethodDeclarationSyntax method</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> methodSymbol = model.GetDeclaredSymbol(method); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> usingReferences = SymbolFinder.FindReferencesAsync(methodSymbol, Solution).Result.Where(r =&gt; r.Locations.Count() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> usingReferences; }</code> </pre> <br><p>  Exceptions can be clarified by the following filters. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="excludedClasses"&gt;</span></span></span><span class="hljs-comment">Exclude method declarations that using in excluded classes in current Solution</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> private bool ContainInClasses(IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ReferencedSymbol&gt;</span></span></span><span class="hljs-comment"> usingReferences, List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string&gt;</span></span></span><span class="hljs-comment"> excludedClasses) { if (excludedClasses.Count </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;= 0) { return false; } foreach (var reference in usingReferences) { foreach (var location in reference.Locations) { var node = location.Location.SourceTree.GetRoot().FindNode(location.Location.SourceSpan); ClassDeclarationSyntax classDeclaration = null; if (SyntaxNodeHelper.TryGetParentSyntax(node, out classDeclaration)) { if (excludedClasses.Contains(classDeclaration.Identifier.Text)) { return true; } } } } return false; }</span></span></span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="excludedProjects"&gt;</span></span></span><span class="hljs-comment">Exclude method declarations that using in excluded projects in current Solution</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> private bool ContainInProjects(IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ReferencedSymbol&gt;</span></span></span><span class="hljs-comment"> usingReferences, List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Microsoft.CodeAnalysis.Project&gt;</span></span></span><span class="hljs-comment"> excludedProjects) { if (excludedProjects.Count </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;= 0) { return false; } foreach (var reference in usingReferences) { if (excludedProjects.FirstOrDefault(p =&gt;</span></span></span><span class="hljs-comment"> reference.Locations.FirstOrDefault(l =&gt; l.Document.Project.Id == p.Id) != null) != null) { return true; } } return false; }</span></span></code> </pre> <br><p>  Run and get just such a beauty. <br><img src="https://habrastorage.org/webt/rk/fb/pq/rkfbpqdxyezpkuz1jzlefnon8s8.png"><br><img src="https://habrastorage.org/webt/rl/vh/v1/rlvhv1rwtm4skdit2n5zoit-w0o.png"></p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  The project can be designed as an extension of the vsix studio or, for example, put it on a version control server and used as an analyzer.  And you can run as needed as Tulu. </p><br><p>  The entire project is <a href="https://github.com/cyberkiso/QuasiRefactoring">published on github</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/343244/">https://habr.com/ru/post/343244/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343232/index.html">Eh, I do not like to write boilerplate, because there is IntelliJ IDEA and Apache Velocity</a></li>
<li><a href="../343234/index.html">Biomes painter: fill the world with content</a></li>
<li><a href="../343236/index.html">Digital events in Moscow from November 27 to December 3</a></li>
<li><a href="../343238/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ290 (November 19 - 26, 2017)</a></li>
<li><a href="../343240/index.html">Fall Creators Update: Important for Programmer</a></li>
<li><a href="../343246/index.html">Realizing the dream</a></li>
<li><a href="../343248/index.html">Dagger 2 for novice Android developers - Introduction</a></li>
<li><a href="../343250/index.html">Dagger 2 for novice Android developers. The introduction of dependencies. Part 1</a></li>
<li><a href="../343252/index.html">Review of music software code defects. Part 5. Steinberg SDKs</a></li>
<li><a href="../343254/index.html">Azure Stack: A bit of theory</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>