<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Torrent Monitoring and Auto Jump</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite recently, there were 2 articles on Habr√© on how to automate the process of downloading new episodes from torrents. The authors of both articles ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Torrent Monitoring and Auto Jump</h1><div class="post__text post__text-html js-mediator-article"><p>  Quite recently, there were 2 articles on Habr√© on how to automate the process of downloading new episodes from torrents.  The authors of both articles shared their applications.  For a year now, we have also been developing such an application, and it seems to me that the time has come to tell the habrasoobshchestvu about our small but wonderful project <strong><a href="https://github.com/werwolfby/monitorrent">Monitorrent</a></strong> , which, perhaps, will make your life as simple and convenient as ours did. </p><br><p><img src="https://cloud.githubusercontent.com/assets/705754/16709186/36bef110-4612-11e6-958a-db02bedf0dea.png" alt="Main Page"></p><br><p>  The web application is written in Python 2 (with Python 3 support).  It allows you to add new torrents for monitoring, automatically download new series and add them to the torrent client. </p><br><p>  We use it on an ongoing basis since the end of last year, and on May 1, 2016 we released the first release version, which is still spinning without any disruption on the cubietruck in the docker container. </p><br><p>  For details of how it works inside, I ask under <a name="habracut"></a>  cat </p><br><p>  I want to come home from work and, having sat down to have supper, simply open Kodi, choose the latest series of my favorite series and watch it.  Without making any effort to search for it on torrent trackers and not wasting time waiting for it to download. </p><br><p>  Solutions for this automation a lot.  At first, I used the Chrome plugin, which monitored the changes on rutracker, and downloaded the changed torrents manually and added to uTorrent via RDC, and later through their web application. </p><br><h1>  Torrentmonitor </h1><br><p>  But after I discovered TorrentMonitor, everything became much easier.  He worked for me on the router for over a year.  Even a couple of pull requests for him were.  About this application there were 2 wonderful articles on Habr√© from its author ( <a href="https://habrahabr.ru/post/157319/">one</a> , <a href="https://habrahabr.ru/post/210548/">two</a> ).  Many thanks to the author. </p><br><p>  TorrentMonitor is beautiful, but I always had one problem.  Sometimes a file of zero size was downloaded.  I had to use my hands to climb into the database and correct the information that this series has not yet been downloaded (it seems that this problem has already been fixed).  Well, in those days, he could not himself add downloaded torrents to the torrent client (in the Transmission in my case).  Now this is all good too. </p><br><h1>  FlexGet </h1><br><p>  The next discovery for me was FlexGet.  Very powerful tool.  It did not have the support of lostfilm.tv and screw it was something else an adventure.  Otherwise, he worked fine, but to teach him to follow the change in the torrent on rutracker I never did.  Probably now it can not be done.  But I had a customized rule that downloaded films of this and the previous year from rutor, with 720p quality (I didn‚Äôt allow more Internet) and imdb rating was over 6.0, while excluding films from Japan (well, I don‚Äôt like Japanese cinema, and have rating consistently high).  All this was described by just a couple of lines in yaml. </p><br><p>  For a long time both services (TorrentMonitor and FlexGet) worked alongside the router. </p><br><p>  After they gave me a cubietruck, and I installed 2.5 2.5 GB hard drive in it, it turned into a small but very practical NAS, which eats little electricity and regularly pumps torrents.  A mobile battery saves you from problems with power outages.  The file access speed of about 30 MB / s is stable, this is enough for my tasks.  TorrentMonitor and FlexGet migrated to cubietruck. </p><br><p>  However, the problem with downloading torrents of zero size has not disappeared anywhere. </p><br><h1>  Monitorrent </h1><br><p>  And I wanted to make my project to automate the download of new series.  TorrentMonitor is written in PHP and calls curl to download new torrents.  To adjust the startup time, use php via cron. </p><br><p>  I wanted everything out of the box to install - and it worked. </p><br><p>  This is how <strong>Monitorrent</strong> appeared.  Like the idea of ‚Äã‚Äãwriting something useful for yourself in python.  A small set of scripts do not count. </p><br><p>  This is a one-page web application written in Python 2. Angular 1.4 and angular-material are used as the front-end.  And the back-end is just a REST service written using <a href="https://falconframework.org/">falcon</a> . </p><br><p>  All sources are on <a href="https://github.com/werwolfby/monitorrent">github</a> , and are distributed under the license <a href="http://www.wtfpl.net/">Do.</a> </p><br><p>  The following trackers are currently supported: </p><br><ul><li>  <a href="http://www.lostfilm.tv/">Lostfilm.tv</a> c parsing the series page </li><li>  rutor.org (now <a href="http://www.rutor.is/">rutor.is</a> and <a href="http://www.rutor.info/">rutor.info</a> ) with tracking torrent changes </li><li>  <a href="http://rutracker.org/forum/index.php">rutracker.org</a> with tracking torrent changes and authorization </li><li>  <a href="http://www.free-torrents.org/">free-torrents.org</a> with tracking torrent changes </li><li>  <a href="http://tapochek.net/index.php">tapochek.net</a> with tracking torrent changes and authorization </li><li>  <a href="http://unionpeer.org/">unionpeer.org</a> with tracking torrent changes </li></ul><br><p>  Downloaded torrents can be added to the following torrent clients: </p><br><ul><li>  Transmission </li><li>  Deluge </li><li>  uTorrent </li><li>  qbittorrent </li></ul><br><p>  This covers my needs by 200% (I mainly use only 3 trackers and 2 torrent clients). </p><br><h1>  Front-end </h1><br><p>  Generally, this is a two-page application. </p><br><p>  One page for the login, the second - the rest of the application.  A separate login page is needed only so that you cannot download static files (pictures, css or js) before you log in to the system.  I'm probably paranoid, there's little point in this, but I like to think that it‚Äôs so slightly safer. </p><br><p> Both pages are generated from a single <code>index.htm</code> file, which is then transformed using the <code>gulp-preprocess</code> plugin. </p><br><p>  All external js files (frameworks and js libraries) are loaded from the CDN in order to facilitate access to the <strong>Monitorrent</strong> 'from outside when it is deployed in the home network.  If ADSL is at home, and the upload speed is only 512 kbps, then it is much faster to download js from the Internet than from the home network at a limited speed, because the channel is already filled with distribution of torrents.  All internal js files have to be downloaded from the home network, which are then perfectly cached by the browser. </p><br><p>  And since the rest of the communication is done through REST, very little data is sent between the front-end and the back-end. </p><br><p>  Authorization done via JWT.  It seems to me that this is the most optimal authorization technology.  It allows you not to store the session on the server and does not allow the client to see exactly what data is stored in it.  If you are not using JWT in your applications, then I highly recommend it.  It is especially good, as it seems to me, to use JWT in microservice architecture. </p><br><p>  The <code>gulp</code> done using <code>gulp</code> , which replaced <code>grunt</code> .  All js files are simply glued together in one big bundle, which is not even <a href="https://github.com/werwolfby/monitorrent/issues/101">minified yet</a> .  But everything sticks together correctly, because the main file is called <code>app.js</code> and the first one gets into the final js.  Everything else works thanks to angular DI. </p><br><p>  Now I would screw the webpack.  But I‚Äôm not a front-end developer and I didn‚Äôt know anything about front-end development when this project was just beginning. </p><br><h2>  Dynamic form generation </h2><br><p>  Among additional features of implementation, we can mention the angular directive we have implemented for generating dynamic forms. </p><br><p>  Settings for all plugins are simple forms, for example, this is how the connection setup form with Transmission looks like: </p><br><p><img src="https://cloud.githubusercontent.com/assets/705754/16707729/978939c8-45e1-11e6-98b2-3608784e627b.png" alt="Transmission Settings"></p><br><p>  This form consists of 2 lines, each of which has 2 text blocks.  The length of the <code>host</code> element is 80%, and the length of the <code>port</code> 20%.  Text blocks for login and password size of 50%.  Writing this form on an angular-material is a trivial task. </p><br><p>  However, we wanted to simplify the development of plug-ins and focus on writing backend-logic, and not bother with html.  The plugin should be delivered as a single file, without an additional markup file. </p><br><p>  We have developed a simple format for describing form markup in the plugin code: </p><br><pre> <code class="hljs cs">form = [{ <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'row'</span></span>, <span class="hljs-string"><span class="hljs-string">'content'</span></span>: [{ <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-string"><span class="hljs-string">'label'</span></span>: <span class="hljs-string"><span class="hljs-string">'Host'</span></span>, <span class="hljs-string"><span class="hljs-string">'model'</span></span>: <span class="hljs-string"><span class="hljs-string">'host'</span></span>, <span class="hljs-string"><span class="hljs-string">'flex'</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span> }, { <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-string"><span class="hljs-string">'label'</span></span>: <span class="hljs-string"><span class="hljs-string">'Port'</span></span>, <span class="hljs-string"><span class="hljs-string">'model'</span></span>: <span class="hljs-string"><span class="hljs-string">'port'</span></span>, <span class="hljs-string"><span class="hljs-string">'flex'</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span> }] }, { <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'row'</span></span>, <span class="hljs-string"><span class="hljs-string">'content'</span></span>: [{ <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-string"><span class="hljs-string">'label'</span></span>: <span class="hljs-string"><span class="hljs-string">'Username'</span></span>, <span class="hljs-string"><span class="hljs-string">'model'</span></span>: <span class="hljs-string"><span class="hljs-string">'username'</span></span>, <span class="hljs-string"><span class="hljs-string">'flex'</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> }, { <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'label'</span></span>: <span class="hljs-string"><span class="hljs-string">'Password'</span></span>, <span class="hljs-string"><span class="hljs-string">'model'</span></span>: <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'flex'</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> }] }]</code> </pre> <br><p>  This is a description of the form for editing settings for Transmission.  It describes 3 text blocks and one block for entering a password.  The purpose of the <code>type</code> and <code>label</code> properties is clear from their names.  The name of the <code>flex</code> property was chosen unsuccessfully, it was more correct to call it <code>width</code> - it defines the element length as a percentage within the string.  It was so named because angular-material uses flexbox to describe the layout of elements on the page. </p><br><p>  After the user enters the data in this form, and press the <code>Save</code> button.  A model of the following type will be sent to the back-end: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"myhost"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: <span class="hljs-string"><span class="hljs-string">"9091"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"username"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"******"</span></span> }</code> </pre> <br><p>  The names of the properties of this model are taken from the <code>model</code> property of the form description. </p><br><p>  This allowed us to focus on writing only the logic of the back-end plug-ins and simplified the writing of the UI.  In the mobile version of the application, all elements will be located one after another, i.e.  elements within one line will be split into several lines.  This functionality is still not implemented, but I hope to appear in the future. </p><br><p>  Naturally, dynamic generation of forms is not the most flexible solution, but I consider it correct and reasonable.  Although our front-end developer does not agree with this to this day and still argues with me about this decision. </p><br><h1>  Websocket </h1><br><p>  In one of the first versions, work with Websockets was implemented.  First, completely with your hands, then at <strong>socket.io</strong> . </p><br><p>  To work with Websockets from the python side, the python library was used to work with <strong>socket.io</strong> .  It uses <strong>gevent</strong> , to create coroutine (lightweight streams, greenlet'ov and many others, the name which I do not remember).  This is an excellent library for writing asynchronous applications, which must be applications that use Websockets. </p><br><p>  But, unfortunately, the python <strong>socket.io</strong> implementation requires the <strong>gevent</strong> library over version 1.0.  And for <strong>gevent</strong> home routers <strong>there</strong> is only version 0.13.  To exclude the possibility of running <strong>Monitorrent</strong> 'and we really didn‚Äôt want to run on routers despite the fact that I myself have been using cubietruck for a long time.  Therefore, we had to refuse Websockets and replace them with long polling requests in the REST interface.  Now they are used only in one place, to obtain the status of the current check for new series. </p><br><h1>  Back-end </h1><br><p>  Written in python 2 using <a href="https://falconframework.org/">falcon</a> .  Falcon promises very high performance and it seemed very convenient to me.  Initially, <strong>Monitorrent</strong> was written in <strong>cherrypy</strong> , then rewritten in the <strong>flask</strong> , there was an attempt to use the <strong>bottle</strong> , but it also did not work out and we stopped at <strong>falcon</strong> . </p><br><p>  Unfortunately, <strong>falcon</strong> is a framework for writing REST services in the first place, and you also need to give static.  <strong>Falcon</strong> does not provide such functionality out of the box, in contrast to the same <strong>flask</strong> and <strong>cherrypy</strong> .  I had to implement this functionality by myself.  In addition, all the tools in falcon for this. </p><br><pre> <code class="hljs pgsql">@no_auth <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> StaticFiles(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>): def __init__(self, folder=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, filename=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, redirect_to_login=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>): self.folder = folder self.filename = filename self.redirect_to_login = redirect_to_login def on_get(self, req, resp, filename=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.redirect_to_login <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> AuthMiddleware.validate_auth(req): resp.status = falcon.HTTP_FOUND resp.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span> = <span class="hljs-string"><span class="hljs-string">'/login'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file_path = filename <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> self.filename <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.folder: file_path = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(self.folder, file_path) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> os.path.isfile(file_path): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> falcon.HTTPNotFound(description=<span class="hljs-string"><span class="hljs-string">'Requested page not found'</span></span>) mime_type, encoding = mimetypes.guess_type(file_path) etag, last_modified = self._get_static_info(file_path) resp.content_type = mime_type <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span> headers = {<span class="hljs-string"><span class="hljs-string">'Date'</span></span>: formatdate(<span class="hljs-type"><span class="hljs-type">time</span></span>.time(), usegmt=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>), <span class="hljs-string"><span class="hljs-string">'ETag'</span></span>: etag, <span class="hljs-string"><span class="hljs-string">'Last-Modified'</span></span>: last_modified, <span class="hljs-string"><span class="hljs-string">'Cache-Control'</span></span>: <span class="hljs-string"><span class="hljs-string">'max-age=86400'</span></span>} resp.set_headers(headers) if_modified_since = req.get_header(<span class="hljs-string"><span class="hljs-string">'if-modified-since'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> if_modified_since <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (parsedate(if_modified_since) &gt;= parsedate(last_modified)): resp.status = falcon.HTTP_NOT_MODIFIED <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> if_none_match = req.get_header(<span class="hljs-string"><span class="hljs-string">'if-none-match'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> if_none_match <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (if_none_match == <span class="hljs-string"><span class="hljs-string">'*'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> etag <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> if_none_match): resp.status = falcon.HTTP_NOT_MODIFIED <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resp.stream_len = os.path.getsize(file_path) resp.stream = <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(file_path, mode=<span class="hljs-string"><span class="hljs-string">'rb'</span></span>) @staticmethod def _get_static_info(file_path): mtime = os.stat(file_path).st_mtime <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> str(mtime), formatdate(mtime, usegmt=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre> <br><p>  Here I had to do mimetype recognition, as well as checking <strong>if-modified-since</strong> and <strong>if-not-match</strong> headers for correct caching by the browser of statics.  I think I stole this solution from <strong>either cherrypy</strong> or <strong>flask</strong> and simply rewrote it for <strong>falcon</strong> .  I don‚Äôt think he has a place in <strong>falcon</strong> , so he didn‚Äôt send them a pull request. </p><br><p>  The solution seems terrible to me, but we have not yet found a more beautiful one. </p><br><p>  The built-in WSGI web server <strong>falcon</strong> can only be used for development, so everything is spinning on WSGI implementation from <strong>cherrypy</strong> , which, as far as I know, is very stable: </p><br><pre> <code class="hljs lua">d = wsgiserver.WSGIPathInfoDispatcher({<span class="hljs-string"><span class="hljs-string">'/'</span></span>: app}) server_start_params = (<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.ip, <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.port) server = wsgiserver.CherryPyWSGIServer(server_start_params, d)</code> </pre> <br><p>  If someone knows a good and fast WSGI server for python, please share in the comments.  You need a cross-platform solution, since <strong>Monitorrent</strong> also works under Windows. </p><br><p>  This is the first serious project in python, so many features we do not know.  Probably, getting statics can be shifted to some WSGI server, and all the work on processing REST requests can be left on <strong>falcon</strong> .  We will be grateful if someone tells you how to do it right. </p><br><h1>  Dependency Injection </h1><br><p>  It's hard for me to understand how you can live without a DI container, but in the python world it's not customary to use them.  There were already a lot of holivars on this topic.  Unfortunately, no good solution was found, so we took advantage of the explicit injection of dependencies into all classes. </p><br><h1>  Plugin system </h1><br><p>  All trackers and torrent clients are implemented as plugins.  For now, these are all types of plugins, but soon there will be plugins for notifications.  The corresponding pull request expects review and will be available in version 1.1. </p><br><p>  We did not find a beautiful system for loading plug-ins, where one could simply scan the folder and somehow download all classes from there, so the implementation idea was stolen from FlexGet. </p><br><p>  Each plugin registers itself in the system.  Although, as it seems to me, it would be more correct for the system itself to search for plugins, and not the plug-in know how to register itself in the system. </p><br><h2>  Plugin for torrent client </h2><br><p>  The plugin interface is very simple: </p><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyClientPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> name = <span class="hljs-string"><span class="hljs-string">"myclient"</span></span> form = [{ ... }] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_settings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_settings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, settings)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_connection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find_torrent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, torrent_hash)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_torrent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, torrent)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove_torrent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, torrent_hash)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> register_plugin(<span class="hljs-string"><span class="hljs-string">'client'</span></span>, <span class="hljs-string"><span class="hljs-string">'myclient'</span></span>, MyClientPlugin())</code> </pre> <br><p>  The methods can be divided into 2 groups, one group for storing client torrent settings, the other for managing torrents. </p><br><p>  The <code>set_settings()</code> and <code>get_settings()</code> methods save and read data from the database. </p><br><p>  <code>*_torrent()</code> methods manage downloads.  A torrent file can be uniquely identified by its hash code, therefore, to delete and search an already downloaded or rocking torrent, it is enough to transfer the hash of the torrent.  But to add a torrent it is logical that you need to transfer the entire torrent. </p><br><p>  The library for parsing the torrent file was taken from FlexGet.  Where she came from there I could not find out (although I did not try hard).  A couple of small modifications were made to it to support python 3 and to read a clean, unassembled byte array. </p><br><p>  The <code>form</code> field describes the form of settings for this plugin on the UI.  You can read about how this works in the section on dynamic form generation above. </p><br><p>  Plugins are quite compact and easy to implement.  For example, transmission takes only 115 lines, including a couple of comment lines and 7 import lines. </p><br><h2>  Tracker Plugin </h2><br><p>  In terms of <strong>Monitorrent,</strong> any subscription to torrent changes is called a topic.  For example, for lostfilm, we follow the changes of the series on its page, and not by parsing RSS.  After the release of the new series, we will download a new torrent file, not a modified one.  Therefore, it seems to me more reasonable to call a subscription a topic. </p><br><p>  If the contract of the plug-in for the torrent client is very simple and therefore there is no base class for it, then it‚Äôs more difficult for the tracker.  To begin, consider the simple interface of the plugin for the tracker: </p><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TrackerPluginBase</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(with_metaclass</span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"><span class="hljs-params">(abc.ABCMeta, object)</span></span></span></span><span class="hljs-class"><span class="hljs-params">)</span></span></span><span class="hljs-class">:</span></span> topic_form = [{ ... }] @abc.abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">can_parse_url</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare_add_topic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_topic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url, params)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_topics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ids)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_topic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, topic, last_update, status=Status.Ok)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_topic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_topic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id, params)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> @abc.abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, topics, engine)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p>  There are also methods for working with the settings of a specific torrent <code>*_topic()</code> and a separate method for getting all the <code>get_topics()</code> themes. </p><br><p>  Adding a new torrent for monitoring occurs on the theme URL.  For example, for rutracker is the address of the forum page, for lostfilm it is the page of the series.  In order to find out which plug-in can handle this URL, all plug-ins in turn call <code>can_parse_url()</code> method, which through regex checks whether it can work with this URL or not.  If such a plugin is not found, the user will see a message that the topic could not be added.  If a plug-in that understands this URL was found, then first it calls the <code>prepare_add_topic()</code> method, which returns a model with parsed data and allows the user to edit this data.  The form for editing data is described in the <code>topic_form</code> field.  After the user edits these topics and clicks the <strong>Add</strong> button, the <code>add_topic</code> method is <code>add_topic</code> , which is passed the edited model and it saves this topic to the monitoring base. </p><br><p>  Now there is one common feature for all themes - this is <code>display_name</code> .  The title that is visible on the main page.  For lostfilm, you can also choose the quality of the downloaded series. </p><br><p>  The largest and most important method is <code>execute(self, topics, engine)</code> .  He is responsible for checking changes and downloading new episodes.  He is given a list of his topics for verification and a special <code>engine</code> object.  The <code>engine</code> object allows you to add new torrents to the torrent client, and also provides an object for logging.  Torrent client for downloads can be only one.  And it‚Äôs not important for the plugin that this is a client, the <code>engine</code> is responsible for the client‚Äôs choice, the plugin simply transfers the downloaded torrent to the <code>engine</code> .  In the case when the series is distributed by adding new series, the <code>engine</code> deletes the previous distribution and adds a new one. </p><br><p>  Since some trackers require authorization, a separate type of plug-in is implemented for them that can store information for a <code>WithCredentialsMixin</code> login.  As the name implies, this class is a mixin (why exactly mixin is described below).  Only these types of plugins now have a UI setting.  This class adds a couple more methods to the plugin interface: </p><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WithCredentialsMixin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(with_metaclass</span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"><span class="hljs-params">(abc.ABCMeta, TrackerPluginMixinBase)</span></span></span></span><span class="hljs-class"><span class="hljs-params">)</span></span></span><span class="hljs-class">:</span></span> credentials_form = [{ ... }] @abc.abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> @abc.abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_credentials</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_credentials</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, credentials)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ids, engine)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self._execute_login(engine): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super(WithCredentialsMixin, self).execute(ids, engine) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_execute_login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, engine)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p>  Methods for storing and loading authorization data <code>*_credentials</code> .  Methods for login and validation of <code>login()</code> and <code>verify()</code> data, respectively.  He also overrides the <code>execute()</code> method in order to first log in to the tracker (by calling the <code>_execute_login()</code> method) and then check the threads for changes. </p><br><p>  To edit the settings, use a dynamically generated form from the <code>credentials_form</code> field. </p><br><p>  Now checking for changes on all trackers, except for lostfilm, is carried out by downloading the torrent file and comparing its hash with what was downloaded last time.  If the hash is different, then a new torrent is downloaded and a client is added to the torrent.  Probably it was enough to check the page itself, sending a HEAD request or something else, but this option is more reliable.  The page size, as it turned out, is larger than the torrent file itself, and simply adding a comment, without being a change in the torrent, will change the page.  In addition, rutor did not support HEAD at all. </p><br><p>  This logic has been moved to the <code>execute</code> method of the <code>ExecuteWithHashChangeMixin</code> class.  This is again a mixin, like <code>WithCredentialsMixin</code> .  This allows you to write plugins, inheriting 1 or 2 mixin depending on the tracker, and override only a couple of methods. </p><br><p>  This is how the plugin for free-torrents.org is defined: </p><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FreeTorrentsOrgPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WithCredentialsMixin, ExecuteWithHashChangeMixin, TrackerPluginBase)</span></span></span><span class="hljs-class">:</span></span> ... topic_form = [{ ... }] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">can_parse_url</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.tracker.can_parse_url(url) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_url</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.tracker.parse_url(url) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_prepare_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, topic)</span></span></span><span class="hljs-function">:</span></span> headers = {<span class="hljs-string"><span class="hljs-string">'referer'</span></span>: topic.url, <span class="hljs-string"><span class="hljs-string">'host'</span></span>: <span class="hljs-string"><span class="hljs-string">"dl.free-torrents.org"</span></span>} cookies = self.tracker.get_cookies() request = requests.Request(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, self.tracker.get_download_url(topic.url), headers=headers, cookies=cookies) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.prepare()</code> </pre> <br><p>  As a result, only a couple of methods require redefinition, and the most complex logic for checking new torrents remains unchanged and is concentrated in <code>WithCredentialsMixin</code> and <code>ExecuteWithHashChangeMixin</code> . </p><br><p>  The plugin for rutor.org uses only <code>ExecuteWithHashChangeMixin</code> : </p><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RutorOrgPlugin</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ExecuteWithHashChangeMixin</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TrackerPluginBase</span></span></span><span class="hljs-class">): pass</span></span></code> </pre> <br><p>  And the plug-in for lostfilm uses only <code>WithCredentialsMixin</code> , because it has its own implementation for finding changes: </p><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LostFilmPlugin</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WithCredentialsMixin</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TrackerPluginBase</span></span></span><span class="hljs-class">): pass</span></span></code> </pre> <br><p>  The plugin for lostfilm is quite complex, for as many as 640 lines.  Login via bogi is especially complicated, but everything has been working like a clock for more than 7 months. </p><br><p>  In other languages, this would be implemented slightly differently, but I am glad that in python you can use multiple inheritance, which is worth doing only through mixins.  And you should definitely indicate the correct order of all inherited classes.  This is probably the only case when it seems to me that multiple inheritance simplifies writing code. </p><br><p>  Unfortunately, on rutor, sometimes distributions are deleted and you have to look for a new one, <strong>Monitorrent</strong> can track remote distributions and highlight such topics on the main screen to the user.  The <code>execute()</code> method is also responsible for this logic. </p><br><h1>  Database </h1><br><p>  The database used is sqlite.  We have a <a href="https://github.com/werwolfby/monitorrent/issues/77">ticket</a> to support other databases, but I do not think that this is necessary, the system complexity will not increase much, but I will have to write a lot of tests to test various databases.  In addition, now there is a small amount of code that is strictly tied to sqlite. </p><br><p>  As ORM, <strong>sqlalchemy is</strong> used.  This is a powerful and convenient ORM that supports the inheritance of classes with their mapping to the base.  It is <strong>sqlalchemy</strong> that <strong>will</strong> simplify the transition to another database, if at some time we are going to add support for other databases. </p><br><p>  The code in <strong>Monitorrent</strong> supports data and schema migrations.  Unfortunately, the <strong>sqlalchemy</strong> out of the box does not have this functionality, but there is another project from the authors of <strong>sqlachemy</strong> - <strong>alembic</strong> , which we use for these purposes. </p><br><p>  Sqlite driver for python has a couple of limitations.  One of them is that you cannot use transactions along with modification of the data schema.  Sometimes this is critical when migrating a database to a new version.  The solution to this problem is described on the <a href="http://docs.sqlalchemy.org/en/latest/dialects/sqlite.html">sqlalchemy</a> site.  From there, this code was moved to <strong>Monitorrent</strong> .  Now migrations work without any problems. </p><br><p>  Already, almost all tracker plugins have got their migrations, from the oldest versions to the latest release.  Implemented support for migrations through the <code>upgrade</code> method, which is transmitted when registering the plugin. </p><br><p>  The <code>upgrade</code> method first determines the current version by various checks such as the existence of columns and tables, and then directly migrates from this version to the last. </p><br><p>  Sample migration code for rutor: </p><br><pre> <code class="hljs pgsql">def upgrade(engine, operations_factory): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> engine.dialect.has_table(engine.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(), RutorOrgTopic.__tablename__): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> version = get_current_version(engine) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> version == <span class="hljs-number"><span class="hljs-number">0</span></span>: upgrade_0_to_1(engine, operations_factory) version = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> version == <span class="hljs-number"><span class="hljs-number">1</span></span>: upgrade_1_to_2(operations_factory) version = <span class="hljs-number"><span class="hljs-number">2</span></span> def get_current_version(engine): m = MetaData(engine) t = <span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>(RutorOrgTopic.__tablename__, m, autoload=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'url'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> t.<span class="hljs-keyword"><span class="hljs-keyword">columns</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'hash'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> t.<span class="hljs-keyword"><span class="hljs-keyword">columns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> t.<span class="hljs-keyword"><span class="hljs-keyword">columns</span></span>[<span class="hljs-string"><span class="hljs-string">'hash'</span></span>].nullable: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> def upgrade_0_to_1(engine, operations_factory): m0 = MetaData() rutor_topic_0 = <span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>("rutororg_topics", m0, <span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-type"><span class="hljs-type">Integer</span></span>, primary_key=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, String, <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, nullable=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>, String, nullable=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(<span class="hljs-string"><span class="hljs-string">'hash'</span></span>, String, nullable=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(<span class="hljs-string"><span class="hljs-string">'last_update'</span></span>, UTCDateTime, nullable=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)) m1 = MetaData() topic_last = <span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>(<span class="hljs-string"><span class="hljs-string">'topics'</span></span>, m1, *[c.<span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Topic.__table__.<span class="hljs-keyword"><span class="hljs-keyword">columns</span></span>]) rutor_topic_1 = <span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>(<span class="hljs-string"><span class="hljs-string">'rutororg_topics1'</span></span>, m1, <span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>("id", <span class="hljs-type"><span class="hljs-type">Integer</span></span>, ForeignKey(<span class="hljs-string"><span class="hljs-string">'topics.id'</span></span>), primary_key=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>("hash", String, nullable=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>)) def topic_mapping(topic_values, raw_topic): topic_values[<span class="hljs-string"><span class="hljs-string">'display_name'</span></span>] = raw_topic[<span class="hljs-string"><span class="hljs-string">'name'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> operations_factory() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> operations: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> engine.dialect.has_table(engine.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(), topic_last.name): topic_last.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>(engine) operations.upgrade_to_base_topic(rutor_topic_0, rutor_topic_1, PLUGIN_NAME, topic_mapping=topic_mapping)</code> </pre> <br><p>  In one of the very first versions, all plugins had their own table for storing themes.  Later, common fields such as <code>url</code> and <code>display_name</code> were moved to the topics table.  In the code, this is implemented as the inheritance of all the classes of themes from the base Topic of the class. </p><br><p>       ,           topics.          ,        <code>MonitorrentOperations.upgrade_to_base_topic</code> : </p><br><pre> <code class="hljs pgsql">def upgrade_to_base_topic(self, v0, v1, polymorphic_identity, topic_mapping=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, column_renames=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .plugins <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Topic self.create_table(v1) topics = self.db.query(v0) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> topic <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> topics: raw_topic = row2dict(topic, v0) # <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> topics topic_values = {c: v <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> list(raw_topic.items()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Topic.__table__.c <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> c != <span class="hljs-string"><span class="hljs-string">'id'</span></span>} topic_values[<span class="hljs-string"><span class="hljs-string">'type'</span></span>] = polymorphic_identity <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> topic_mapping: topic_mapping(topic_values, raw_topic) result = self.db.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>(Topic.__table__.<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(), topic_values) # <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> topic.id inserted_id = result.inserted_primary_key[<span class="hljs-number"><span class="hljs-number">0</span></span>] # <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> v1 <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> concrete_topic = {c: v <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> list(raw_topic.items()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> v1.c} concrete_topic[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] = inserted_id <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> column_renames: column_renames(concrete_topic, raw_topic) self.db.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>(v1.<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(), concrete_topic) # <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> original <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> self.drop_table(v0.name) # <span class="hljs-keyword"><span class="hljs-keyword">rename</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> created <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-built_in"><span class="hljs-built_in">old</span></span> one self.rename_table(v1.name, v0.name)</code> </pre> <br><p>       ,    2.5    .          ,    .     . </p><br><p>          <code>DBSession</code>    python  with,         : </p><br><pre> <code class="hljs swift">with <span class="hljs-type"><span class="hljs-type">DBSession</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> db: cred = db.query(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.credentials_class).first() cred.c_uid = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.tracker.c_uid cred.c_pass = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.tracker.c_pass cred.c_usess = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.tracker.c_usess</code> </pre> <br><p>        FlexGet'.         <code>DBSession()</code> .        . </p><br><h1>   </h1><br><p> <strong>Monitorrent</strong>         .       2 ,     . </p><br><p>       <code>threading.Thread</code> .      <code>threading.Timer</code> ,      <code>stop()</code> ,        .       ,     .     ,      2  (   )      . </p><br><h1>   </h1><br><p>   <strong>Monitorrent</strong> '    <code>server.py</code> .     <strong>cherrypy</strong>   <a href="https://github.com/werwolfby/monitorrent/issues/84">6687</a>  . </p><br><p>      : </p><br><ul><li> <code>debug</code> ‚Äì ,     JWT     ,        .   false.        . </li><li> <code>ip</code> ‚Äì ,      .   0.0.0.0. </li><li> <code>port</code> ‚Äì ,      .   6687 </li><li> <code>db_path</code> ‚Äì     .   monitorrent.db.  Those.          . </li><li> <code>onfig</code> ‚Äì    ,      .   config.py </li></ul><br><p>    3- . </p><br><p> ,      . </p><br><p>   ‚Äî      (config.py         ).   python ,       . </p><br><p>    python <code>exec</code> .    python 3       <code>exec_</code>  <strong>six</strong> . </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(config_path) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> config_file: six.exec_(compile(config_file.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(), config_path, <span class="hljs-string"><span class="hljs-string">'exec'</span></span>), {}, parsed_config)</code> </pre> <br><p>       - ,     ,      . </p><br><p>    ‚Äî  : <code>MONITORRENT_DEBUG</code> , <code>MONITORRENT_IP</code> , <code>MONITORRENT_PORT</code>  <code>MONITORRENT_DB_PATH</code> .       . </p><br><p>     ,           ,   . </p><br><p>    docker      ,   . </p><br><p>       config.py,      . </p><br><h1>   </h1><br><p>  python      100%.     ‚Äì <code>server.py</code> .                      .   ‚Äî   .           . </p><br><p>       100%   ,     . </p><br><p>       <strong>unittest</strong>    python. </p><br><p>   ,       . Sqlite     ,     .   ,    ,    ,        ,     . </p><br><p>   ,    ,        . </p><br><p>   <strong>Monitorrent</strong> ' ‚Äì               . </p><br><p>    <strong>vcrpy</strong> ,      ,     .   monkey   <strong>requests</strong>        ,      .  Those.          back-end,    ,     ,      .     ,          back-end  .   ,            . ,      ,    . </p><br><p>       .     html     . ,  ,   404 .      <strong>httpretty</strong> .   <strong>httpretty</strong>  ,  ,       . </p><br><p>  ,    <strong>vcrpy</strong>    FlexGet'.    97%   <strong>vcrpy</strong>      <strong>httpretty</strong> . </p><br><p>   2 ,      .  <a href="https://coveralls.io/github/werwolfby/monitorrent">coveralls.io</a>  <a href="https://codecov.io/github/werwolfby/monitorrent%3Fbranch%3Ddevelop">codecov.io</a> . </p><br><p>       ,   lostfilm,     html: </p><br><pre> <code class="hljs pgsql">parser = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> # lxml have <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> issue <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> parsing lostfilm <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Windows <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sys.platform == <span class="hljs-string"><span class="hljs-string">'win32'</span></span>: parser = <span class="hljs-string"><span class="hljs-string">'html5lib'</span></span> soup = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>\_soup(r.text, <span class="hljs-keyword"><span class="hljs-keyword">parser</span></span>)</code> </pre> <br><p>   ,     Linux      100%.    coveralls.io, codecov.io         .       .      : </p><br><pre> <code class="hljs pgsql"># lxml have <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> issue <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> parsing lostfilm <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Windows, so replace it <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> html5lib <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Windows soup = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>\_soup(r.text, <span class="hljs-string"><span class="hljs-string">'html5lib'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sys.platform == <span class="hljs-string"><span class="hljs-string">'win32'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>)</code> </pre> <br><p>     python    ,     .    ,        .      .      .  codecov.io    Chrome,      github,    . </p><br><p>  front-end   .      . -      ,      . </p><br><p>          ,  <strong>vcrpy</strong> , ..     back-end'. </p><br><h1>   </h1><br><p> <strong>Monitorrent</strong> ‚Äì  .    2  :   Windows ‚Äì  <a href="https://ci.appveyor.com/project/werwolfby/monitorrent">ci.appveyor.com</a> ,  ‚Äî <a href="https://travis-ci.org/werwolfby/monitorrent">travis-ci.org</a>  Linux. Appveyor    Windows   .   ‚Äì  travis,     ,         coveralls.io  codecov.io. </p><br><p>    drone.io    docker   x86/x64   ARM.   ,   .     ,    . </p><br><h1>    </h1><br><p>         .   git flow      github.   master    ,             issue.       develop. </p><br><p>     <a href="http://semver.org/">Semantic Versioning</a> .       ‚Äî 1.0.0.    4  ,    . </p><br><p>        <a href="https://www.zenhub.com/">ZenHub</a>  Chrome &amp; Firefox,    Boards  Burndown    github     issue.      <a href="https://waffle.io/">waffle.io</a> ,    <a href="https://www.zenhub.com/">ZenHub</a> . </p><br><h1>  Conclusion </h1><br><p> <strong>Monitorrent</strong>     9    . </p><br><p>           .         .       ,     .     <strong>Monitorrent</strong>    ,    ,       requests. -     .      Windows,     cubietruck.             . </p><br><p>      .    10 ,      , UI     . </p><br><p>       (, UX      ),          ,     . </p><br><p>    ,    <a href="https://github.com/werwolfby/monitorrent/issues/59/"></a>  github.   , pull request'    ,    github'.       . </p><br><p>   ,    .    <strong>Monitorrent</strong> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/305574/">https://habr.com/ru/post/305574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305564/index.html">Elixir: Deploying Applications with Edeliver</a></li>
<li><a href="../305566/index.html">Deploying Django 1.9 on IIS 7+</a></li>
<li><a href="../305568/index.html">The work of the technical support department of the local positioning system</a></li>
<li><a href="../305570/index.html">Tour of the world fintech hubs</a></li>
<li><a href="../305572/index.html">Digest of recent advances in cryptography. First release</a></li>
<li><a href="../305576/index.html">Treatment of all js-files on the server or the definition of the encryption method in the day off</a></li>
<li><a href="../305578/index.html">Hello, TensorFlow. Google Machine Learning Library</a></li>
<li><a href="../305580/index.html">Global range of FINTECH accelerators</a></li>
<li><a href="../305582/index.html">9 Russian companies that make interesting content</a></li>
<li><a href="../305584/index.html">UltraVDS has launched a loyalty program for its VDS / VPS servers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>