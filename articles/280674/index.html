<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Quad-tree live visualization on Shader Model 2.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prologue 
 Good day! Once a friend came to my job, and I showed him my freshly written shader, at that time it was the first serious experience with t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Quad-tree live visualization on Shader Model 2.0</h1><div class="post__text post__text-html js-mediator-article"><h2>  Prologue </h2><br>  Good day!  Once a friend came to my job, and I showed him my freshly written shader, at that time it was the first serious experience with them.  This firmware converted the image from the camera into the image of a knitted sweater. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Wjmnh9lIuEM%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgtXTtThMqw6WzYgScJ6w4l0FkBbw" frameborder="0" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  At the time of development, the image was taken from the camera of the phone and displayed in a knitted form, the effect was unusual.  And a friend threw an idea to make a filter for the camera in the form of a quadratic tree. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4f5/304/d1e/4f5304d1ec6a4e0a9144afd57d45e73f.png"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, from that moment I sat down to study the methods of quickly constructing a quadratic tree, and stopped at the idea of <a href="http://folk.uio.no/erikd/histo/hpmarchertalk.pdf">HistoPyramid</a> . <br><br><h2>  Implementation </h2><br>  Initially, you need to prepare the input parameters for the shader.  I used Unity3D, so C # code samples. <br><br>  The process of the algorithm is divided into two stages: <br><br><ol><li>  Building a tree </li><li>  but.  Shader Parameters Preparation <br>  b.  Shader implementation <br></li><li>  Creating an image from a tree </li></ol><br><h3>  Building a tree </h3><br><h4>  Shader Parameters Preparation </h4><br>  All calculations will be conducted on the conditions that the maximum size of the square should be equal to 256 pixels. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> quadSize = <span class="hljs-number"><span class="hljs-number">256</span></span>;</code> </pre> <br>  Initially, I will give an example of a built tree: <br><br><img src="https://habrastorage.org/files/0e2/352/d80/0e2352d800b3406f807d7391ded33a54.png"><br><br>  The number of levels in the tree is calculated as follows: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> levelsAmount = Mathf.Log(quadSize, <span class="hljs-number"><span class="hljs-number">2f</span></span>);</code> </pre><br>  Each next level is two times less than the previous one.  Since the tree elements will be located on the right, the size of the tree image will be calculated as follows: <br><br><pre> <code class="cs hljs">Vector2 histoSize = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector2((<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)quadSize + (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)quadSize / <span class="hljs-number"><span class="hljs-number">2f</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)quadSize);</code> </pre><br>  The parameters of the shader will need to pass the coordinates of the beginning of the block, the coordinates of the end of the block and the size of the block.  You will also need the same parameters for the parent block, i.e.  block larger than the current one. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> _cellSize = Mathf.Pow (<span class="hljs-number"><span class="hljs-number">2f</span></span>, levelsLog - (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)currentLevel); Vector2 size = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector2 (_cellSize / histoSize.x, _cellSize / histoSize.y); Vector2 start = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector2 (<span class="hljs-number"><span class="hljs-number">0.6666666667f</span></span>, size.y); Vector2 end = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector2 (<span class="hljs-number"><span class="hljs-number">0.6666666667f</span></span> + size.x, <span class="hljs-number"><span class="hljs-number">2f</span></span> *size.y); builderMaterial [i].SetVector (<span class="hljs-string"><span class="hljs-string">"_startBlock"</span></span>, start); builderMaterial [i].SetVector (<span class="hljs-string"><span class="hljs-string">"_endBlock"</span></span>, end); builderMaterial [i].SetVector (<span class="hljs-string"><span class="hljs-string">"_sizeBlock"</span></span>, size);</code> </pre><br>  The specified piece of code calculates the coordinates of the beginning, end, and block size, provided that <b>currentLevel is</b> greater than 0, i.e.  all elements of the tree to the right of the original image.  From this in the coordinates of the beginning and end are "magic numbers" 0.6666666667f (2/3 occupies the original image).  <b>_cellSize</b> will store the block size in pixels, after which, for the beginning and end, you will need to convert to relative units. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i == <span class="hljs-number"><span class="hljs-number">1</span></span>) { parentStart = Vector4.zero; parentSize = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector4 (<span class="hljs-number"><span class="hljs-number">0.6666666667f</span></span>, <span class="hljs-number"><span class="hljs-number">1f</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _cellSize = Mathf.Pow (<span class="hljs-number"><span class="hljs-number">2f</span></span>, levelsLog - (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)currentLevel + <span class="hljs-number"><span class="hljs-number">1f</span></span>); parentSize = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector4 (_cellSize / histoSize.x, _cellSize / histoSize.y, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); parentStart = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector4 (<span class="hljs-number"><span class="hljs-number">0.6666666667f</span></span>, parentSize.y, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre><br>  In the case of the parent unit, everything is identical. <br><br><h4>  Shader implementation </h4><br>  The shader will run <b>levelsAmount</b> times.  For each level of the tree, the parameters corresponding to the current level will be transmitted. <br><br>  The parameters to the shader input are as follows: <br><br><pre> <code class="cs hljs">Properties { _MainTex (<span class="hljs-string"><span class="hljs-string">"Base (RGB)"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>D) = <span class="hljs-string"><span class="hljs-string">"white"</span></span> {} _BaseStep (<span class="hljs-string"><span class="hljs-string">"Pixel size parent block"</span></span>, Vector) = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) _Level (<span class="hljs-string"><span class="hljs-string">"Current level"</span></span>, Float) = <span class="hljs-number"><span class="hljs-number">1</span></span> _startBlock (¬´Start current block<span class="hljs-string"><span class="hljs-string">", Vector) = (0, 0, 0, 0) _endBlock (¬´End current block"</span></span>, Vector) = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) _sizeBlock (<span class="hljs-string"><span class="hljs-string">"Size current block"</span></span>, Vector) = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) _parentEndBlock (<span class="hljs-string"><span class="hljs-string">"Start parent block"</span></span>, Vector) = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) _parentSizeBlock (<span class="hljs-string"><span class="hljs-string">"Size parent block"</span></span>, Vector) = (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) }</code> </pre><br><ul><li>  <b>_MainTex</b> is the original texture, in our case 256x256 pixels; </li><li>  <b>_BaseStep</b> - relative pixel size (1 / histoSize); </li><li>  <b>_Level</b> - the current level of the tree; </li><li>  <b>_startBlock</b> - the beginning of the current block; </li><li>  <b>_endBlock</b> - the end of the current block; </li><li>  <b>_sizeBlock</b> - the size of the current block; </li><li>  <b>_parentEndBlock</b> - the end of the parent block; </li><li>  <b>_parentSizeBlock</b> - the size of the parent block; </li></ul><br>  Original image transmitted in <b>_MainTex</b> : <br><br><img src="https://habrastorage.org/files/2e5/05c/518/2e505c518d9c40f2bb290ea7e5a60f9a.png"><br><br>  The task of this shader is as follows: <br><br><ul><li>  Determine whether image processing coordinates fall into the current block </li><li>  Find the average of 4 parental pixels and calculate the difference in color relative to the parent and the new color </li><li>  If we do not hit the current block, return the color that is already on the texture </li></ul><br>  For the zero level, the texture will be created as follows: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_Level == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vo.uv.x &lt; _sizeBlock.x) { float2 uv = float2(vo.uv.x / _sizeBlock.x, vo.uv.y); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tex2D(_MainTex, uv); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fixed4(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); } }</code> </pre><br>  In proportion to the final size, we simply insert it and paint the remaining pixels in black. <br><br>  For the remaining levels, you need to check the hit in the current block: <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vo.uv.y &gt;= _startBlock.y &amp;&amp; vo.uv.y &lt;= _endBlock.y &amp;&amp; vo.uv.x &gt;= _startBlock.x &amp;&amp; vo.uv.x &lt;= _endBlock.x) {</code> </pre><br>  To simplify the calculations, the color difference from the source will be considered only at the first level.  The relative coordinates of the block are calculated as follows: <br><br><pre> <code class="hljs lisp">float2 uv = (<span class="hljs-name"><span class="hljs-name">vo</span></span>.uv - _startBlock)/_szeBlock<span class="hljs-comment"><span class="hljs-comment">; float2 suv = float2(0.6666666667 * uv.x, uv.y);</span></span></code> </pre><br>  Now you need to take the four colors of the parent unit and calculate the average value plus the error. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">fixed4</span></span> col1 = tex2D(_MainTex, suv); <span class="hljs-attribute"><span class="hljs-attribute">fixed4</span></span> col2 = tex2D(_MainTex, float2(min(suv.x + delta.x, _endBlock.x), suv.y)); <span class="hljs-attribute"><span class="hljs-attribute">fixed4</span></span> col3 = tex2D(_MainTex, float2(suv.x, min(suv.y - delta.y, _startBlock.y))); <span class="hljs-attribute"><span class="hljs-attribute">fixed4</span></span> col4 = tex2D(_MainTex, float2(suv.x, max(suv.y - delta.y, _startBlock.y))); <span class="hljs-attribute"><span class="hljs-attribute">col</span></span> = (col1 + col2 + col3 + col4)/<span class="hljs-number"><span class="hljs-number">4</span></span>;</code> </pre><br>  The error is calculated in a simple way: if the pixels differ in color, it will add (1 / n) to the error, where n is the number of color comparison combinations. <br><br>  I will give an example of one combination: <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">float</span></span> rgbError = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(DecodeFloatRGBA(col2) - DecodeFloatRGBA(col1)) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { rgbError += <span class="hljs-number"><span class="hljs-number">0.1666666667</span></span>; }</code> </pre><br>  The result of the function is the average pixel color value, where the alpha channel is an error.  This is the main simplification in my algorithm, since I didn‚Äôt have enough to calculate the color deviation through the histogram. <br><br><pre> <code class="hljs lisp">return fixed4(<span class="hljs-name"><span class="hljs-name">col</span></span>.rgb, errorColor)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br>  At the other levels, the principle is similar, only the error will be calculated from the sum of the pixels of the parent block. <br><br><pre> <code class="hljs lisp">float errorColor = min((<span class="hljs-name"><span class="hljs-name">col1</span></span>.a + col2.a + col3.a + col4.a), <span class="hljs-number"><span class="hljs-number">1.0</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br>  As a result, walking through all levels, our tree will be formed.  The next step is to display the tree on the screen, scaling it to fit the screen. <br><br><h3>  Creating an image from a tree </h3><br>  The task of this shader is as follows: determine an error for each level, and if it does not exceed the specified level, draw the required level with the color of the pixel in the tree.  Shader parameters: <br><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">Properties</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">_MainTex</span></span> (<span class="hljs-string"><span class="hljs-string">"Base (RGB)"</span></span>, 2D) = <span class="hljs-string"><span class="hljs-string">"white"</span></span> {} <span class="hljs-attribute"><span class="hljs-attribute">_TileTex</span></span> (<span class="hljs-string"><span class="hljs-string">"Tile (RGB)"</span></span>, 2D) = <span class="hljs-string"><span class="hljs-string">"white"</span></span> {} }</code> </pre><br><ul><li>  <b>_MainTex</b> - texture of the created tree; </li><li>  <b>_TileTex</b> - texture with levels of the tree, to change the style of visualization; </li></ul><br><img src="https://habrastorage.org/files/2ce/0ee/ce8/2ce0eece8ef64ea5b0bd6a4a1cc439d4.png" align="left">  The quality of the final image depends on this texture, the background is transparent, and the figure inscribed in a square can be any. <br><br>  The main function of the image output is as follows: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">fixed4</span></span> getLevelColor(float level, float2 uv, float2 cellSize, float outSize) { <span class="hljs-attribute"><span class="hljs-attribute">float2</span></span> suv = float2(<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">6666666667</span></span> + uv.x*cellSize.x, cellSize.y+uv.y*cellSize.y); <span class="hljs-attribute"><span class="hljs-attribute">fixed4</span></span> color = tex2D(_MainTex, suv); <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (color.a &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">59</span></span>-(<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">08</span></span>*(<span class="hljs-number"><span class="hljs-number">9</span></span>-level))) { <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> fixed4(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-attribute"><span class="hljs-attribute">float2</span></span> scaledUV = frac(uv/outSize); <span class="hljs-attribute"><span class="hljs-attribute">float2</span></span> patternUV = float2(<span class="hljs-number"><span class="hljs-number">2</span></span>*scaledUV.x*outSize, outSize+scaledUV.y*outSize); <span class="hljs-attribute"><span class="hljs-attribute">fixed4</span></span> tileColor = tex2D(_TileTex, patternUV) * fixed4(color.rgb, <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-attribute"><span class="hljs-attribute">fixed4</span></span> outcolor = lerp(tileColor, fixed4(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span> - tileColor.a); <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> fixed4(outcolor.rgb, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br>  Input parameters: <br><br><ul><li>  <b>cellSize</b> - relative block size; </li><li>  <b>outSize</b> - relative size in the final image; </li></ul><br>  The idea is the following, for each pixel of the final image it is necessary to pass from the smallest block of the tree to the big one (bottom to top). <br><br>  If the error is not more than the specified value (threshold): <br><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">color</span></span>.a &gt; <span class="hljs-number"><span class="hljs-number">0.59</span></span>-(<span class="hljs-number"><span class="hljs-number">0.08</span></span>*(<span class="hljs-number"><span class="hljs-number">9</span></span>-level))) <span class="hljs-comment"><span class="hljs-comment">//      .</span></span></code> </pre><br>  Then we display the desired image from the <b>_TileTex</b> texture. <br><br>  As a result, in order to run through the required levels, I had to strictly prescribe the conditions without any cycles. <br><br><pre> <code class="hljs pgsql">fixed4 <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-type"><span class="hljs-type">float4</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = getLevelColor(<span class="hljs-number"><span class="hljs-number">7</span></span>, vo.uv, float2(<span class="hljs-number"><span class="hljs-number">0.005208333333</span></span>, <span class="hljs-number"><span class="hljs-number">0.0078125</span></span>), <span class="hljs-number"><span class="hljs-number">0.5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.a &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = getLevelColor(<span class="hljs-number"><span class="hljs-number">6</span></span>, vo.uv, float2(<span class="hljs-number"><span class="hljs-number">0.01041666667</span></span>, <span class="hljs-number"><span class="hljs-number">0.015625</span></span>), <span class="hljs-number"><span class="hljs-number">0.25</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.a &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = getLevelColor(<span class="hljs-number"><span class="hljs-number">5</span></span>, vo.uv, float2(<span class="hljs-number"><span class="hljs-number">0.02083333333</span></span>, <span class="hljs-number"><span class="hljs-number">0.03125</span></span>), <span class="hljs-number"><span class="hljs-number">0.125</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.a &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = getLevelColor(<span class="hljs-number"><span class="hljs-number">4</span></span>, vo.uv, float2(<span class="hljs-number"><span class="hljs-number">0.04166666667</span></span>, <span class="hljs-number"><span class="hljs-number">0.0625</span></span>), <span class="hljs-number"><span class="hljs-number">0.0625</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.a &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = getLevelColor(<span class="hljs-number"><span class="hljs-number">3</span></span>, vo.uv, float2(<span class="hljs-number"><span class="hljs-number">0.08333333333</span></span>, <span class="hljs-number"><span class="hljs-number">0.125</span></span>), <span class="hljs-number"><span class="hljs-number">0.03125</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.a &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = getLevelColor(<span class="hljs-number"><span class="hljs-number">2</span></span>, vo.uv, float2(<span class="hljs-number"><span class="hljs-number">0.1666666667</span></span>, <span class="hljs-number"><span class="hljs-number">0.25</span></span>), <span class="hljs-number"><span class="hljs-number">0.015625</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.a &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = getLevelColor(<span class="hljs-number"><span class="hljs-number">1</span></span>, vo.uv, float2(<span class="hljs-number"><span class="hljs-number">0.3333333333</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>), <span class="hljs-number"><span class="hljs-number">0.0078125</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.a &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>;</code> </pre><br>  At the output we get the desired result: <br><br><img src="https://habrastorage.org/files/c21/9e7/c64/c219e7c64a214d93964614163f425e71.png"><br><br><h2>  Epilogue </h2><br>  As a result, we got a shader running on weak mobile devices with a frame rate of 25-30 or more.  In this article I touched upon the image processing with ‚Äúpure‚Äù colors, but you can go further and make the calculation of the color deviation error more complicated, then you can use this script in ‚Äúnoisy‚Äù images with a complex texture. <br><br>  Example (from 44 seconds): <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/p893p3gcQr4%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhj-mnqyOO9tfHM6JmxKU4u9Oq43Fg" frameborder="0" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/BGzJw2yr6Bw%3Ffeature%3Doembed%26start%3D44&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhghi8JD01yOxkbB3C_JgyciCE98Gw" frameborder="0" allowfullscreen=""></iframe><br><br>  I wanted to apologize for the many magic numbers in the article.  Thanks for attention! <br><br>  Links to materials used: <br><br><ul><li>  <b>Effcient region segmentation on compressed images using quadtree and shading representation</b> .  Kuo-Liang Chunga, Hsu-Lien Huanga, Hsueh-I Lu </li><li>  <b>RealTime QuadTree Analysis using HistoPyramids.</b>  Gernot Ziegler, Rouslan Dimitrovb, Christian Theobalta, Hans-Peter Seidela <br>  a Max-Planck-Institut f√ºr Informatik, Stuhlsatzenhausweg 85, D-66123 Saarbr√ºcken, Germany.  bInternational University Bremen GmbH, Postfach 750561, D-28725 Bremen, Germany </li><li>  <b>HistoPyramid stream compaction and expansion.</b>  Christopher Dyken and Gernot Ziegler </li><li>  <a href="http://devmag.org.za/2011/02/23/quadtrees-implementation/">Quadtrees: Implementation</a> .  Herman tulleken </li></ul></div><p>Source: <a href="https://habr.com/ru/post/280674/">https://habr.com/ru/post/280674/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280662/index.html">CLRium # 3: .NET Technology Workshop</a></li>
<li><a href="../280664/index.html">8 harmful tips to "accelerate" the site</a></li>
<li><a href="../280666/index.html">NetApp ONTAP and NAS Antivirus Protection</a></li>
<li><a href="../280668/index.html">A little bit about sockets, redis and broken eggs</a></li>
<li><a href="../280672/index.html">Attackers use a Linux / Remaiten bot to compromise embedded devices, part 2</a></li>
<li><a href="../280676/index.html">Unbelievable combinations of the Internet and real professions</a></li>
<li><a href="../280678/index.html">Mobile OCR. How it all began</a></li>
<li><a href="../280682/index.html">We can not pay so much money to PPA members</a></li>
<li><a href="../280684/index.html">We invite you to the spring UX-conference of the Russian School of Service Design on April 16</a></li>
<li><a href="../280686/index.html">Test your strength in the All-Russian Security Olympiad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>