<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We test and monitor MSTP in a heterogeneous network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 With the growth of any network, an administrator will sooner or later face three problems, among other things - the risk of accidental ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We test and monitor MSTP in a heterogeneous network</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  With the growth of any network, an administrator will sooner or later face three problems, among other things - the risk of accidental drops due to link breaks, the appearance of rings in the switch tree and the lack of performance of individual lines. <br><br>  To combat these types of evil, humanity, as is known (in particular, from <a href="http://habrahabr.ru/search/q%3Dmstp%26target_type%3Dposts">several</a> articles on Habr√©, <a href="http://en.wikipedia.org/wiki/Spanning_tree_protocol">Wikipedia</a> and much more from where), invented and uses different versions of the Spanning-Tree protocol.  The general idea of ‚Äã‚Äãwhich is reduced to the fact that switches in a network with more or less arbitrary connectivity according to some rules collectively decide which links between them to send which packets to use. <br><a name="habracut"></a><br><h4>  Pro and Contra </h4><br>  It is worth noting that from time to time people think about whether it is necessary at all ( <a href="http://habrahabr.ru/post/132312/">here, for example</a> ).  Different thoughts on this subject are reduced (ok, as far as I know) to three ideas: <br><br><ol><li>  And let's put duplicate links and all sorts of LAG / LACP aggregated pairs of wires everywhere </li><li>  Well, his second level, we will all be routed to the third </li><li>  And let's live on real or virtual switch stacks </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is clear that for each specific network there are some ‚Äúdesign considerations‚Äù and it will never hurt to think a couple of times, but there are certain drawbacks for both approaches.  The first increases the cost of infrastructure in real conditions, if necessary, maintain fault tolerance.  Example - there are ten switches in the potential "ring".  And already laid optics.  Cheap, 4 cores.  If you want to build up to each two independent links, which then make friends in some aggregated interface, you will have to turn up a bunch of new construction sites, or put several wavelengths into one fiber, which is not cheap either.  And if ‚Äúeverything is routed‚Äù, then the switches will have to be changed to routers (I exaggerate, but the point remains) and have an increase in delays out of the blue.  Alas. <br><br>  Workers and reliable distributed (up to 80 km, it seems) Juniper stacks of switches.  But they stand - like a plane.  Hang up <br><br><h4>  Experience son of difficult mistakes </h4><br>  After reading, looking at all this economy, we decided to try to run it.  And judging by the first impression from reading various manuals, everything was very rosy - the mood is as it should and it will more or less figure out and fly. <br>  In the arsenal there were Cisco-2960 and Dlink of various kinds.  I wanted happiness in the form of MSTP for a couple of VLANs.  There was no stand, everyone tried to assemble on a live network (at night, with minimal load, etc.).  Why MSTP is because some kind of standard.  There is a chance to start a system from equipment of different vendors without large losses.  And to provide partial use of blocked links, again. <br><br>  It did not work from the first run - Cisco rebuilds MSTP for quite a long time and the slightest error in the VLAN alignment according to different Instances leads to the fact that the system does not take off and with probability loses controllability. <br><br>  We realized that Spanning Tree without monitoring and a quick idea of ‚Äã‚Äãwhat state it is in now is worthless, like a RAID, for example. <br><br><h4>  Stand </h4><br>  They rolled back the configuration, put the Cisco 3750 stack into the core, which removed issues with the performance of the pair of the 2960s and pushed back capacity problems for a considerable time, leaving only the issue of line redundancy. <br><br>  We assembled a stand from 3 x 2960 and 2 dlink, uncoupled from the main network, and started to play. <br><br><h4>  Instruments </h4><br>  At first, on one of Cisco, ports were allocated for managing all other switches, and on them the control interfaces were attached to a separate VLAN, which was not planned to be driven into MSTP, in order not to lose connectivity with the equipment for the duration of the experiments. <br><br>  It has been found that some dlink models support a very limited number of MST Instances, which makes life difficult, but does not make it impossible.  Available in our economy are able to 7, alas. <br><br>  Next, the perl + Net :: Telnet syntaxes were written, which can do two key things: <br><br><ol><li>  Automatically and consistently configure switches of different models </li><li>  Remove information sufficient to display the status of the tree </li></ol><br><br>  If someone comes in handy, I‚Äôll give as an example the minimal commands for dlink <br><br><pre><code class="bash hljs">config stp version mstp config stp mst_config_id name %cfname revision_level %revision create stp instance_id 1 config stp instance_id 1 add_vlan %inst1vlans create stp instance_id 2 config stp instance_id 2 add_vlan %inst2vlans create stp instance_id 3 config stp instance_id 3 add_vlan %inst3vlans create stp instance_id 4 config stp instance_id 4 add_vlan %inst4vlans create stp instance_id 5 config stp instance_id 5 add_vlan %inst5vlans create stp instance_id 6 config stp instance_id 6 add_vlan %inst6vlans config stp ports 1:1-1:26 state <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> stp config stp <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> new_root <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> config stp <span class="hljs-built_in"><span class="hljs-built_in">trap</span></span> topo_change <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span></code> </pre> <br>  (Specifically, this example is for conditionally stackable Dlink. For non-stackable, port numbers will be without ":") <br><br>  and for cisco: <br><br><pre> <code class="bash hljs">conf t no spanning-tree mst configuration spanning-tree mode mst spanning-tree mst configuration name %cfname revision %revision instance 1 vlan %inst1vlans instance 2 vlan %inst2vlans instance 3 vlan %inst3vlans instance 4 vlan %inst4vlans instance 5 vlan %inst5vlans instance 6 vlan %inst6vlans <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre><br><br>  Instead of% cfname, substitute the name of the configuration, instead of% revision - respectively, revision (a natural number from one and above). <br>  % inst1vlans - list of VLAN tags for the first instance, separated by commas. <br><br>  For fine tuning - so that the balancing is really turned on, the traffic is spread over the links, etc.  - it is necessary to go through the ports and build priorities.  It is better with your hands. <br><br><h4>  How to look at it? </h4><br>  It would be generally ideal if you could pull different switches on SNMP and see more or less identical data in more or less of the plates.  But, despite the standard protocols (both SNMP and MSTP seem to be standardized), all vendors have their own ideas about the beautiful and there is no such freebie.  Or at least not found.  For some reason, Cisco gives data on CIST, but not on other MST Instances.  Why - it is not clear even once ... <br><br>  I had to take up the file and reinvent the wheel.  Namely - a program that climbs all the same telnet on switches and removes data from them, parses and displays.  To display this kind of data is ideal (for my subjective taste, of course), <a href="http://www.graphviz.org/">graphviz</a> is suitable - you can feed a text file of a simple format to the input, but it will decompose you and the graph, draw arrows, and even insert hyperlinks if asked affectionately. <br><br>  It turned out something like this: <br><br><img src="https://habrastorage.org/storage3/c5a/0d4/bc0/c5a0d4bc0afdd949b0786ea24aee4968.png"><br><br>  Commands to get information, respectively, for Dlink: <br><br><pre> <code class="bash hljs">show stp ports %port</code> </pre><br><br>  and for Cisco: <br><br><pre> <code class="bash hljs">show spanning-tree interface Gi %device/%port detail</code> </pre><br><br><h4>  Underwater rocks </h4><br>  Spanning tree has the right to converge up to a minute and this is normal. <br><br>  The basic setting must be identical. <br><br>  In order for all switches to have all instances, it is necessary that they also have all VLANs.  (in the picture above, however, there are switches where not all vlans are!) <br><br>  Using Spanning Tree (without service instances created exclusively for research purposes), it is impossible to determine which switch port A has switch B turned on, and which switch C is turned on if A in all MST instances is closer to Root than B and C. <br><br><h4>  Summary </h4><br>  You can make standardized protocols work if you act carefully, take your time and watch your hands and equipment. </div><p>Source: <a href="https://habr.com/ru/post/195596/">https://habr.com/ru/post/195596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195586/index.html">RailsClub'Moscow 2013. The conference has begun!</a></li>
<li><a href="../195588/index.html">[UPD] Chain.js: link synchronous and asynchronous functions in the chain</a></li>
<li><a href="../195590/index.html">Two hares - SOPA and IP4, one solution</a></li>
<li><a href="../195592/index.html">Running and using OpenWrt in VirtualBox</a></li>
<li><a href="../195594/index.html">Autonomous monitoring system with a small budget</a></li>
<li><a href="../195598/index.html">Curiosity found water!</a></li>
<li><a href="../195604/index.html">Charging station from used batteries</a></li>
<li><a href="../195608/index.html">The main mistakes in the design of the main menu of the game</a></li>
<li><a href="../195610/index.html">OSPF LSA5: Forward Address or optimal routing bypassing the ASBR</a></li>
<li><a href="../195612/index.html">Sending faxes from the User Panel to FreePBX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>