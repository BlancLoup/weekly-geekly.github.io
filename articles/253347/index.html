<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Coroutine implementation in NodeJS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The output of iojs encouraged me to study functions that have already become stable in v8, in particular, native promises and generators that can be t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Coroutine implementation in NodeJS</h1><div class="post__text post__text-html js-mediator-article">  The output of <a href="https://iojs.org/">iojs</a> encouraged me to study functions that have already become stable in v8, in particular, native promises and generators that can be turned into corutines.  I was surprised that on Habr√© there is no article devoted to how to do another implementation of coroutine yourself through generators and understand what actually happens in co / bluebird.  To start using without fear of the magic of coroutine I ask for cat. <br><a name="habracut"></a><br><br><blockquote>  Coroutine (coroutine) is a function (program) having several input points.  You can stop it at a certain point, do something else, and then return to this point again and continue with new data (not necessarily with new data but with the same condition as it was).  Fiber is one of the implementation of korutin for nodejs (for example, <a href="https://github.com/laverdet/node-fibers">node-fibers</a> ), but now we are talking about implementation without writing a plugin in C ++ or metaprogramming, using only native Javascript methods. </blockquote><br><br>  In particular, Korutin give us the opportunity to write similar code: <br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timeout</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ms, msg</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">)</span></span>{ setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(msg); resolve(msg); }, ms, msg); }); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> makeJob = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> *(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> timeout(<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> timeout(<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> getUser(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user.info; }; generatorWrapper(makeJob);</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It turns out quite briefly and more clearly.  Instead of timeout, there can be any other function that can do promises, for example, it follows the data to the database and returns the data directly to the same function, and not to then / callback, which is quite convenient, since  allows and cancels the execution of sequential asynchronous functions more conveniently than is possible in the promise chain. <br>  The whole point of the question is what this generatorWrapper looks like.  And this is my reasoning on this. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">async</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">gen</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instance = gen(); <span class="hljs-comment"><span class="hljs-comment">//  ,     return new Promise(function(resolve, reject){ //       function next(r){ if (r.done) { resolve(r.value);//     resolve'  . } if (typeof(r.value.then)=='function')//  duck typing, ..   Promise   { r.value.then(function(someRes){ next(instance.next());// next    . }, function(e){ reject(e); }); } else { console.log(r.value); next(instance.next()); } } next(instance.next());//       }); }</span></span></code> </pre><br>  This implementation is ideological to understand how it all works, but the ideology is about the same in co and bluebird. <br>  Of course, full-fledged implementations are <a href="https://github.com/tj/co">co</a> and <a href="">bluebird.coroutine</a> , they have parallel processing and the possibility of advanced processing, including working with other generators. <br><br>  From the code you can see that the generator in JS, although it allows you to write the code of the form as Korutiny, but in fact is not intended for this.  Generator, sorry for captaincy and tautology, first of all the generator and most conveniently on it all the same to do lazy calculations, and using it in this way is not quite its intended purpose, although according to my tests I did not notice any performance degradation. <br>  On the other hand, it is clear when looking at future standards such as <a href="http://www.htmlxprs.com/post/48/understanding-async-functions-in-es7">await / async</a> , that everything is not so far in principle, it is possible to safely use current generation-based Korutines using iojs + co / bluebird without fear for the stability of the product.  And considering that all the correct implementations of Corutin return the native promise, then all this is completely compatible with the upcoming standards. <br><br>  I summarize: calmly put and use it in iojs.  In the code written on promises, all this rises without any changes.  If you want to add something to the functional, you can look at the same co and add something of your own, there is nothing wrong with this processing.  If you want to make an async race, do not deny yourself this, but then you have to do it in another function on promises, not a generator, or invent your own data format, otherwise feel free with generators, they are now the same part of the standard as everything else . <br><br>  PS Sorry for the raw material, I hope for your help to improve it. </div><p>Source: <a href="https://habr.com/ru/post/253347/">https://habr.com/ru/post/253347/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253335/index.html">Your wi-fi will tell me where you live, where you work and where you travel</a></li>
<li><a href="../253337/index.html">We play the sapper in Photoshop</a></li>
<li><a href="../253341/index.html">Why is WPF alive?</a></li>
<li><a href="../253343/index.html">Most Elite IP Addresses</a></li>
<li><a href="../253345/index.html">Perl 6: Different names for different things</a></li>
<li><a href="../253349/index.html">Introduction to ASP.NET 5</a></li>
<li><a href="../253351/index.html">An example of the implementation of calls to Asterisk CLI in PHP. Asterisk response structuring</a></li>
<li><a href="../253353/index.html">CompTIA certifications for IT professionals. Part 4 of 7. CompTIA Security +</a></li>
<li><a href="../253357/index.html">We program robots - free robosimulator V-REP. The first steps</a></li>
<li><a href="../253359/index.html">Handbook of console methods in JS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>