<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting a DataContext to nested non-visual objects in WPF / Silverlight</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing DXScheduler for WPF, we received a script from the user that used the MVVM template. 
 The user object was assigned to the DataContext...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting a DataContext to nested non-visual objects in WPF / Silverlight</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/95a4b2fb/76619385/989cece8/96e0d7b8.png" alt="image" align="left"><br>  When developing <a href="http://www.devexpress.com/Products/NET/Controls/WPF/Scheduler/">DXScheduler for WPF,</a> we received a script from the user that used the <a href="http://en.wikipedia.org/wiki/MVVM">MVVM</a> template. <br>  The user object was assigned to the <a href="http://msdn.microsoft.com/en-us/library/system.windows.frameworkelement.datacontext.aspx">DataContext</a> property of our scheduler, and in the XAML markup we ‚Äúbound‚Äù to the corresponding properties of the object using <a href="http://msdn.microsoft.com/en-us/library/ms750413.aspx">Binding expressions</a> . <br>  But there was a problem - the scheduler contained some non-visual Storage object that stored a set of settings for the data.  In the form in which the Binding expressions were written, the properties of the object stack were not updated. <br><br>  How this problem was solved, you will find out below ... <br><a name="habracut"></a><br>  The article presents a simplified solution that demonstrates the scenario described above.  Therefore, I will not complicate the above code with full implementations of the MVVM template, pile up INotifyPropertyChanged interfaces, etc.  Our task is that the example as simply as possible reflects the essence of the issue. <br><br>  So, let's start with the visual control, which will be a representation of the model. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  View class </h4><br>  A visual control that contains a property for a nested DataStore object.  It will be created and assigned in XAML. <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SomeVisualControl</span></span> : <span class="hljs-title"><span class="hljs-title">Control</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DependencyProperty InnerDataStoreProperty = DependencyProperty.Register(<span class="hljs-string"><span class="hljs-string">"InnerDataStore"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DataStore), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SomeVisualControl), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyMetadata(<span class="hljs-literal"><span class="hljs-literal">null</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DataStore InnerDataStore { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (DataStore)GetValue(InnerDataStoreProperty); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SetValue(InnerDataStoreProperty, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } }</code> </pre> <br><br><h4>  Class DataStore </h4><br>  The non-visual data store is created in XAML and is contained as an internal property in SomeVisualControl. <br><br>  In DXScheduler, a similar internal object was derived from DependencyObject and, by definition, did not contain a DataContext.  As a result, Binding expressions on the properties of this object did not work.  Therefore, the first thing that comes to mind is to inherit this object from the class containing the DataContext, and the problem will be solved. <br><br>  Such a class is FrameworkElement, and we will use it as a base class. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DataStore</span></span> : <span class="hljs-title"><span class="hljs-title">FrameworkElement</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DependencyProperty ConnectionStringProperty = DependencyProperty.Register(<span class="hljs-string"><span class="hljs-string">"ConnectionString"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DataStore), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyMetadata(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty)); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionString { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)GetValue(ConnectionStringProperty); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SetValue(ConnectionStringProperty, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } }</code> </pre><br><br>  Now we define the user level objects. <br><br><h4>  Model Class </h4><br>  Defines a user object.  The <b>ConnectionString</b> property will be ‚Äúassociated‚Äù with the property of the internal storage of the visual control. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DataStoreModel</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionString { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataStoreModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connection</span></span></span><span class="hljs-function">)</span></span> { ConnectionString = connection; } }</code> </pre><br><br><h4>  ModelView class </h4><br>  Defines the representation of the user object model.  Following the requirements of the MVVM pattern, this class should implement <a href="http://msdn.microsoft.com/en-us/library/ms133020.aspx">INotifyPropertyChanged</a> , but in our example this is not necessary. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DataStoreViewModel</span></span> { DataStoreModel dataStore; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataStoreViewModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DataStoreModel dataStore</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dataStore == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"dataStore"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataStore = dataStore; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ModelConnectionString { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dataStore.ConnectionString; } } }</code> </pre><br><br>  A diagram of the resulting classes is shown below: <br><img src="https://habrastorage.org/storage/habraeffect/ca/0a/ca0a6db6a4f3688975adc6ab7280b1cd.png"><br><br>  So, we set the task: to <em>associate the property of an internal non-visual object with the property of the model</em> . <br><br>  Go to the application and create the necessary controls in the XAML markup. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">Window</font> <font color="#ff0000">x:Class</font> <font color="#0000ff">="DataContextWpfSample.MainWindow"</font> <br> <font color="#ff0000">xmlns</font> <font color="#0000ff">="http://schemas.microsoft.com/winfx/2006/xaml/presentation"</font> <br> <font color="#ff0000">xmlns:x</font> <font color="#0000ff">="http://schemas.microsoft.com/winfx/2006/xaml"</font> <br> <font color="#ff0000">xmlns:local</font> <font color="#0000ff">="clr-namespace:DataContextWpfSample"</font> <br> <font color="#ff0000">Loaded</font> <font color="#0000ff">="Window_Loaded"</font> <br> <font color="#ff0000">Title</font> <font color="#0000ff">="MainWindow"</font> <font color="#ff0000">Height</font> <font color="#0000ff">="350"</font> <font color="#ff0000">Width</font> <font color="#0000ff">="525"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">Grid</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">local:SomeVisualControl</font> <font color="#ff0000">x:Name</font> <font color="#0000ff">="MyVisualControl"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">local:SomeVisualControl.InnerDataStore</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">local:DataStore</font> <font color="#ff0000">ConnectionString</font> <font color="#0000ff">="{Binding ModelConnectionString}"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">local:SomeVisualControl.InnerDataStore</font> <font color="#0000ff">&gt;</font> <br> <br> <font color="#0000ff">&lt;</font> <font color="#800000">local:SomeVisualControl.Template</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">ControlTemplate</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">StackPanel</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">TextBlock</font> <font color="#ff0000">Text</font> <font color="#0000ff">="DataStore Connection:"</font> <font color="#ff0000">FontWeight</font> <font color="#0000ff">="Bold"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">TextBlock</font> <font color="#ff0000">Text</font> <font color="#0000ff">="{Binding Path=InnerDataStore.ConnectionString, RelativeSource={RelativeSource Mode=TemplatedParent}}"</font> <font color="#ff0000">TextWrapping</font> <font color="#0000ff">="Wrap"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">StackPanel</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">ControlTemplate</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">local:SomeVisualControl.Template</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">local:SomeVisualControl</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Grid</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">Window</font> <font color="#0000ff">&gt;</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Let's set the name MyVisualControl to our control - it will be necessary to access it from the window's code-behind file.  We define the display template and display the properties of interest to ensure that they were correctly obtained from the model object. <br><br>  The model initialization code in the window class file looks like this: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainWindow</span></span> : <span class="hljs-title"><span class="hljs-title">Window</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Window_Loaded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> connection = <span class="hljs-string"><span class="hljs-string">@"Provider=Microsoft.Jet.OLEDB.4.0;Data Source=|DataDirectory|\MyDB.mdb;Persist Security Info=True"</span></span>; DataStoreModel sourceData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataStoreModel(connection); DataStoreViewModel sourceDataModel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataStoreViewModel(sourceData); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.MyVisualControl.DataContext = sourceDataModel; }</code> </pre><br><br>  We especially note the last line - the assignment of a DataContext will thus allow ‚Äúlinking‚Äù the properties of the control with the properties of the model using binding expressions. <br><br>  Run the application, but instead of the expected connection string, we see an empty one. <br>  Let's use the <a href="http://blois.us/Snoop/">SNOOP</a> utility and make sure that the DataContext of the storage object is not assigned: <br><br><img src="https://habrastorage.org/storage/habraeffect/e7/b9/e7b9ebac32e4660e60dc5d2fd0bee10a.png"><br><br>  It seems that this is due to the fact that: <br>  <em>The DataStore object is NOT in the visual tree, and therefore the context of the parent is NOT set to it</em> . <br><br><h4>  Destination DataContext </h4><br>  Thus, we need to determine when a DataContext is assigned in a visual control, and set this value to an internal DataStore object. <br><br>  The <b>FrameworkContentElement</b> class contains a <b>DataContextChanged</b> event. <br>  Let's use this and, having written a simple code, we will receive the correct result. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SomeVisualControl</span></span> : <span class="hljs-title"><span class="hljs-title">Control</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public SomeVisualControl() { this.DataContextChanged += new DependencyPropertyChangedEventHandler(SomeVisualControl_DataContextChanged); } void SomeVisualControl_DataContextChanged(object sender, DependencyPropertyChangedEventArgs e) { InnerDataStore.DataContext = e.NewValue; } }</span></span></code> </pre><br><br>  Unfortunately, there is one BUT ... <br>  If you are using WPF, then you can use this approach.  The thing is that the current version of Silverlight does not contain a <b>DataContextChanged</b> event. <br>  And since we are writing a common code for WPF and SL controls, it was necessary to write a universal solution. <br><br>  So how do you know when the DataContext of the visual control changes? <br><br>  You can use the following approach ... <br>  Frankly, the idea is not new.  I just tried to generalize it so that it could be used in different classes and for classes with a hierarchy of nested non-visual objects. <br>  The essence of the idea is that the DependencyProperty is created and the binding is made, where the created property is associated with the DataContext property of the control in which you want to know about the context change.  However, when registering a <b>DependencyProperty,</b> you must specify a <b>PropertyChangedCallback</b> .  This callback function will be called when the value of the DataContext property changes.  And it is here that you can assign the context to all the necessary objects, in our case, the InnerDataStore object. <br><br>  Looking ahead, I‚Äôll say that we will define an interface that will report that the DataContext property has changed and should be assigned to nested objects. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IDataContextOwner</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> DataContext { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateInnerDataContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dataContext</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><br>  We implement the class described above that contains the binding on the DataContext and the PropertyChangedCallback method. <br>  In this case, we will pass an object to the class constructor that implements the IDataContextOwner interface (in our case, this will be SomeVisualControl) and call the UpdateInnerDataContext interface method to tell our visual control that it is time to update the context of its internal storage. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DataContextBinder</span></span> : <span class="hljs-title"><span class="hljs-title">DependencyObject</span></span> { IDataContextOwner owner; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataContextBinder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IDataContextOwner owner</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (owner == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"owner"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.owner = owner; InitializeBinding(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeBinding</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Binding binding = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Binding(<span class="hljs-string"><span class="hljs-string">"DataContext"</span></span>); binding.Source = owner; binding.Mode = BindingMode.OneWay; BindingOperations.SetBinding(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, DataContextProperty, binding); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> DataContext { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)GetValue(DataContextProperty); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { SetValue(DataContextProperty, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DependencyProperty DataContextProperty = DependencyProperty.Register(<span class="hljs-string"><span class="hljs-string">"DataContext"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DataContextBinder), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyMetadata(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyChangedCallback(OnDataContextChanged))); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDataContextChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DependencyObject d, DependencyPropertyChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { ((DataContextBinder)d).OnDataContextChanged(e.OldValue, e.NewValue); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDataContextChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> oldValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newValue</span></span></span><span class="hljs-function">)</span></span> { owner.UpdateInnerDataContext(newValue); } }</code> </pre><br><br>  Now we will write a fairly simple implementation of the IDataContextOwner interface in our View (SomeVisualControl): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SomeVisualControl</span></span> : <span class="hljs-title"><span class="hljs-title">Control</span></span>, <span class="hljs-title"><span class="hljs-title">IDataContextOwner</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... object IDataContextOwner.DataContext { get { return DataContext; } } void IDataContextOwner.UpdateInnerDataContext(object dataContext) { if (InnerDataStore != null) InnerDataStore.DataContext = dataContext; } }</span></span></code> </pre><br><br>  The last thing you need to do is create an instance of the DataContextBinder inside the View. <br>  This can be done directly in the class constructor: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeVisualControl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataContextBinder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataContextBinder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); }</code> </pre><br><br>  Run the application and make sure that the context is assigned to the internal object and the string from the model is correctly installed in the DataStore object.  Now the application window displays data from a user-defined model. <br><br><img src="https://habrastorage.org/storage/habraeffect/60/ef/60ef00b572238724c942dc86589c1540.png"><br><br><h4>  findings </h4><br>  This implementation is not tied to a specific class and can be applied where the need has arisen to assign a DataContext to an object that cannot receive it using ‚Äústandard‚Äù means. <br>  At the same time, when there is a need to pass the context deep into the hierarchy of non-visual objects, you simply create an object of the DataContextBinder class and implement the IDataContextOwner interface. <br>  This frees you from the cumbersome writing of dependency properties and the binding definition between them in each of the classes.  DataContextBinder encapsulates functionality in itself and at some point notifies the owner about the need to set a new context value on nested objects. <br><br>  Sample source code is available here: <br>  <a href="http://www.devexpress.com/example%3DE2991">WPF</a> and <a href="http://www.devexpress.com/example%3DE2992">Silverlight</a> </div><p>Source: <a href="https://habr.com/ru/post/115104/">https://habr.com/ru/post/115104/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115096/index.html">At every corner of the deal</a></li>
<li><a href="../115097/index.html">Warner Bros. launches online movie rental on Facebook</a></li>
<li><a href="../115099/index.html">Safety online for children (continued)</a></li>
<li><a href="../115102/index.html">YouTube buys online TV company</a></li>
<li><a href="../115103/index.html">C March 8, our favorite habravchanochki!</a></li>
<li><a href="../115106/index.html">Nokia X1-00 - a new phone for ‚Ç¨ 35</a></li>
<li><a href="../115107/index.html">Baidu cards</a></li>
<li><a href="../115108/index.html">We win ELMS Delivery Client</a></li>
<li><a href="../115109/index.html">The final version of Visual Studio 2010 Service Pack 1 and other announcements</a></li>
<li><a href="../115110/index.html">How to disable the site in Chrome</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>