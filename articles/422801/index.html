<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Understand RBAC in Kubernetes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Note trans. : The article was written by Javier Salmeron, an engineer from Bitnami‚Äôs well-known Kubernetes community, and was posted on the CNCF blog ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Understand RBAC in Kubernetes</h1><div class="post__text post__text-html js-mediator-article"> <i><b>Note</b></i>  <i><b>trans.</b></i>  <i>: The article was written by Javier Salmeron, an engineer from Bitnami‚Äôs well-known Kubernetes community, and was posted on the CNCF blog in early August.</i>  <i>The author talks about the very basics of the RBAC mechanism (role-based access control), which appeared in Kubernetes a year and a half ago.</i>  <i>The material will be especially useful for those who are familiar with the device of the key components of the K8s (see links to other similar articles at the end).</i> <br><br><img src="https://habrastorage.org/webt/tz/xm/qe/tzxmqenidfjgy8nps6myfacun2i.jpeg"><br>  <i>Slide from a <a href="https://www.slideshare.net/codedellemc/code-webinar-kubernetes-overview-and-16-update-with-matthew-de-lio">presentation</a> made by a Google employee on the occasion of the release of Kubernetes 1.6</i> <br><br>  Many experienced Kubernetes users may recall the release of Kubernetes 1.6 when authorization based on Role-Based Access Control (RBAC) received beta status.  This is how an alternative authentication mechanism appeared, which complemented the existing, but difficult to manage and understand, Attribute-Based Access Control (ABAC).  Everyone enthusiastically welcomed the new feature, but at the same time countless users were disappointed.  StackOverflow and GitHub were full of messages about RBAC restrictions, because most of the documentation and examples did not take into account RBAC (but now everything is in order).  The reference example was Helm: the simple launch of <code>helm init</code> + <code>helm install</code> no longer worked.  Suddenly, we needed to add ‚Äúweird‚Äù elements like <code>ServiceAccounts</code> or <code>RoleBindings</code> even before deploying a chart with WordPress or Redis (for more details, see the <a href="https://docs.bitnami.com/kubernetes/how-to/configure-rbac-in-your-kubernetes-cluster/">instructions</a> ). <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Leaving these unsuccessful first attempts aside, one cannot deny the enormous contribution that RBAC has made to turning Kubernetes into a production-ready platform.  Many of us managed to play with Kubernetes with full administrator privileges, and we are well aware that in a real environment it is necessary: <br><br><ul><li>  Have a lot of users with different properties that provide the necessary authentication mechanism. </li><li>  Have complete control over what operations can be performed by each user or group of users. </li><li>  Have complete control over what operations each process in the hearth can perform. </li><li>  Restrict the visibility of certain resources in namespaces. </li></ul><br>  In this respect, RBAC is a key element providing much-needed opportunities.  In the article we will quickly go through the basics <i>(for details, see <a href="https://www.youtube.com/watch%3Fv%3DCnHTCTP8d48">this video</a> ; follow the link for 1-hour webinar from Bitnami in English - <b>approx. Transl.</b> )</i> And dive a bit into the most confusing moments. <br><br><h2>  The key to understanding RBAC in Kubernetes </h2><br>  To fully understand the idea of ‚Äã‚ÄãRBAC, you need to understand that three elements are involved in it: <br><br><ul><li>  <i>Subjects</i> (subjects) - a set of users and processes that want to have access to the Kubernetes API; </li><li>  <i>Resources</i> - a collection of Kubernetes API objects available in a cluster.  Their examples (among others) are <i>Pods</i> , <i>Deployments</i> , <i>Services</i> , <i>Nodes</i> , <i>PersistentVolumes</i> ; </li><li>  <i>Verbs</i> (verbs) - a set of operations that can be performed on resources.  There are various verbs (get, watch, create, delete, etc.), but all of them are ultimately CRUD (Create, Read, Update, Delete) operations. </li></ul><br><img src="https://habrastorage.org/webt/xc/yp/cy/xcypcyyglvjo5v6igg213nbkfxo.png"><br><br>  If you keep these three elements in mind, the key idea of ‚Äã‚ÄãRBAC is: <br><br>  ‚ÄúWe want to connect actors, API resources, and operations.‚Äù  In other words, we want to specify for a given <b>user</b> what <b>operations</b> can be performed on a variety of <b>resources</b> . <br><br><h2>  Understanding RBAC objects in the API </h2><br>  In the combination of these three types of entities, RBAC objects that are available in the Kubernetes API become clear: <br><br><ul><li>  <code>Roles</code> connect resources and verbs.  They can be reused for different subjects.  They are attached to the same namespace (we cannot use patterns that represent more than one [namespace], but we can deploy the same role object into different namespaces).  If you want to apply a role to the entire cluster, there is a similar <code>ClusterRoles</code> object. </li><li>  <code>RoleBindings</code> connect the remaining entity-subjects.  Having specified the role that already links API objects with verbs, we now select the subjects who can use them.  The equivalent for the cluster level (i.e., without reference to namespaces) is <code>ClusterRoleBindings</code> . </li></ul><br>  In the example below, we give the user <i>jsalmeron the</i> right to read, retrieve a list, and create pods in the <i>test</i> namespace.  This means that <i>jsalmeron</i> will be able to execute such commands: <br><br><pre> <code class="bash hljs">kubectl get pods --namespace <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> kubectl describe pod --namespace <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> pod-name kubectl create --namespace <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -f pod.yaml <span class="hljs-comment"><span class="hljs-comment">#     </span></span></code> </pre> <br>  ... but not like this: <br><br><pre> <code class="bash hljs">kubectl get pods --namespace kube-system <span class="hljs-comment"><span class="hljs-comment">#    kubectl get pods --namespace test -w #    watch</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/rz/es/71/rzes71nhwjlob2scvnv0m5yfahy.png"><br><br>  Examples of YAML files: <br><br><pre> <code class="plaintext hljs">kind: Role apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: pod-read-create namespace: test rules: - apiGroups: [""] resources: ["pods"] verbs: ["get", "list", "create"]</code> </pre> <br><pre> <code class="plaintext hljs">kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: salme-pods namespace: test subjects: - kind: User name: jsalmeron apiGroup: rbac.authorization.k8s.io roleRef: kind: Role name: pod-read-create apiGroup: rbac.authorization.k8s.io</code> </pre> <br>  Another interesting point in the following: now that the user can create scams, can we limit how much?  This will require other objects that are not directly related to the RBAC specification and allow you to configure resource limits: <a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/"><code>ResourceQuota</code></a> and <a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/"><code>LimitRanges</code></a> .  They are definitely worth exploring with the configuration of such an important component of the cluster [as the creation of pods]. <br><br><h2>  Subjects: users and ... ServiceAccounts? </h2><br>  One of the difficulties that many Kubernetes users face in the context of subjects is the difference between regular users and <code>ServiceAccounts</code> .  In theory, everything is simple: <br><br><ul><li>  <code>Users</code> are global users, intended for people or processes outside the cluster; </li><li>  <code>ServiceAccounts</code> - limited to the namespace and intended for processes within the cluster running on the pods. </li></ul><br>  The similarity of both types is the need to authenticate with the API to perform certain operations on a variety of resources, and their subject areas look very specific.  They can also belong to groups, so <code>RoleBinding</code> allows <code>RoleBinding</code> to bind more than one subject (although only one group is allowed for <code>ServiceAccounts</code> <code>system:serviceaccounts</code> ).  However, the main difference is the cause of the headache: users do not have corresponding objects in the Kubernetes API.  It turns out that such an operation exists: <br><br><pre> <code class="bash hljs">kubectl create serviceaccount <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-service-account <span class="hljs-comment"><span class="hljs-comment"># OK</span></span></code> </pre> <br>  ... but this one is already gone: <br><br><pre> <code class="bash hljs">kubectl create user jsalmeron <span class="hljs-comment"><span class="hljs-comment"># !</span></span></code> </pre> <br>  This situation has a serious consequence: if the cluster does not store information about users, the administrator will have to manage accounts outside the cluster.  There are various ways to solve the problem: TLS-certificates, tokens, OAuth2, etc. <br><br>  In addition, you will need to create <code>kubectl</code> contexts <code>kubectl</code> that we can access the cluster through these new accounts.  To create files with them, you can use the <code>kubectl config</code> commands (which do not require access to the Kubernetes API, so they can be executed by any user).  In the video above, there is an example of creating a user with TLS certificates. <br><br><h2>  RBAC in Deployments: an example </h2><br>  We have seen an example in which the specified user is granted rights to operations in the cluster.  But what about <i>Deployments</i> that require access to the Kubernetes API?  Consider a specific scenario to get a better look. <br><br>  Take for example the popular infrastructure application - RabbitMQ.  We will use the <a href="https://github.com/kubernetes/charts/tree/master/stable/rabbitmq">Helm-chart for RabbitMQ</a> from Bitnami (from the official helm / charts repository), which uses the <a href="https://bitnami.com/stack/rabbitmq/containers">bitnami / rabbitmq container</a> .  The container contains a plugin for Kubernetes, which is responsible for detecting other members of the RabbitMQ cluster.  Because of this, the process inside the container requires access to the Kubernetes API, and we will need to configure <code>ServiceAccount</code> with the correct RBAC privileges. <br><br>  When it comes to <code>ServiceAccounts</code> , follow this good practice: <br><br>  - Customize <b>ServiceAccounts for each Deployment</b> with a <b>minimum set of privileges</b> . <br><br>  In the case of applications that require access to the Kubernetes API, you may be tempted to create some kind of ‚Äúprivileged <code>ServiceAccount</code> ‚Äù that can do almost everything in a cluster.  Although this seems like a simpler solution, it can ultimately lead to security vulnerabilities allowing unwanted operations to be performed.  (The video shows an example of Tiller [component Helm] and the consequences of having <code>ServiceAccounts</code> with high privileges.) <br><br>  In addition, different <i>Deployments</i> will have different needs in terms of accessing the API, so it is reasonable for each <i>Deployment</i> to have different <code>ServiceAccounts</code> . <br><br>  Without forgetting this, let's see which RBAC configuration will be correct for the case of <i>Deployment</i> 's with RabbitMQ. <br><br>  You can see in the <a href="https://github.com/rabbitmq/rabbitmq-peer-discovery-k8s/tree/master/examples/k8s_statefulsets">plug-</a> in <a href="https://github.com/rabbitmq/rabbitmq-peer-discovery-k8s/tree/master/examples/k8s_statefulsets">documentation</a> and <a href="">its source code</a> that it requests the <i>Endpoints</i> list from the Kubernetes API.  This is how the remaining members of the RabbitMQ cluster are detected.  Therefore, the RabbitMQ Chart from Bitnami creates: <br><br><ul><li>  <a href=""><b>ServiceAccount</b></a> for hearths with RabbitMQ: <br><br><pre> <code class="plaintext hljs">{{- if .Values.rbacEnabled }} apiVersion: v1 kind: ServiceAccount metadata: name: {{ template "rabbitmq.fullname" . }} labels: app: {{ template "rabbitmq.name" . }} chart: {{ template "rabbitmq.chart" . }} release: "{{ .Release.Name }}" heritage: "{{ .Release.Service }}" {{- end }}</code> </pre> </li><li>  <a href=""><b>Role</b></a> (we assume that the entire RabbitMQ cluster is deployed in a single namespace) resolving the <i>get</i> verb for the <i>Endpoint</i> resource: <br><br><pre> <code class="plaintext hljs">{{- if .Values.rbacEnabled }} kind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: name: {{ template "rabbitmq.fullname" . }}-endpoint-reader labels: app: {{ template "rabbitmq.name" . }} chart: {{ template "rabbitmq.chart" . }} release: "{{ .Release.Name }}" heritage: "{{ .Release.Service }}" rules: - apiGroups: [""] resources: ["endpoints"] verbs: ["get"] {{- end }}</code> </pre> </li><li>  <a href=""><b>RoleBinding</b></a> , connecting <code>ServiceAccount</code> with the role: <br><br><pre> <code class="plaintext hljs">{{- if .Values.rbacEnabled }} kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: {{ template "rabbitmq.fullname" . }}-endpoint-reader labels: app: {{ template "rabbitmq.name" . }} chart: {{ template "rabbitmq.chart" . }} release: "{{ .Release.Name }}" heritage: "{{ .Release.Service }}" subjects: - kind: ServiceAccount name: {{ template "rabbitmq.fullname" . }} roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: {{ template "rabbitmq.fullname" . }}-endpoint-reader {{- end }}</code> </pre> </li></ul><br><img src="https://habrastorage.org/webt/lx/uw/vg/lxuwvgvlcluwmoln2mx0wgkxdyk.png"><br><br>  The diagram shows that we have allowed processes running in RabbitMQ to perform <i>get</i> operations on <i>Endpoint</i> objects.  This is the minimum set of operations required for everything to work.  At the same time, we know that the expanded chart is safe and will not perform unwanted actions within the Kubernetes cluster. <br><br><h2>  Final thoughts </h2><br>  To work with Kubernetes in production, RBAC policies are not optional.  They should not be treated as a set of API objects that only administrators should know.  They are actually needed by developers to deploy secure applications and take full advantage of the potential offered by the Kubernetes API for cloud (cloud native) applications.  More information on RBAC is available at these links: <br><br><ul><li>  Bitnami Documentation: ‚Äú <a href="https://docs.bitnami.com/kubernetes/how-to/configure-rbac-in-your-kubernetes-cluster/">Configure RBAC in your Kubernetes Cluster</a> ‚Äù; </li><li>  Kubernetes documentation: ‚Äú <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Using RBAC authorization</a> ‚Äù. </li></ul><br><h2>  PS from translator </h2><br>  Read also in our blog: <br><br><ul><li>  ‚Äú <a href="https://habr.com/company/flant/blog/417905/">11 ways to (not) become a victim of hacking at Kubernetes</a> ‚Äù; </li><li>  ‚Äú <a href="https://habr.com/company/flant/blog/417905/">What happens in Kubernetes when starting the kubectl run?</a>  <a href="https://habr.com/company/flant/blog/417905/">Part 1</a> "; </li><li>  ‚Äú <a href="https://habr.com/company/flant/blog/335552/">How does the Kubernetes scheduler actually work?</a>  "; </li><li>  " <a href="https://habr.com/company/flant/blog/420813/">Behind the scenes of the network in Kubernetes</a> "; </li><li>  " <a href="https://habr.com/company/flant/blog/331188/">Our experience with Kubernetes in small projects</a> " <i>(video of the report, which includes an introduction to the technical device Kubernetes)</i> . </li></ul></div><p>Source: <a href="https://habr.com/ru/post/422801/">https://habr.com/ru/post/422801/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422791/index.html">How not to learn English: common mistakes</a></li>
<li><a href="../422793/index.html">Conference DEFCON 22. Andrew "Zoz" Brooks. Don't screw it up! Part 2</a></li>
<li><a href="../422795/index.html">Technology and business: a new model of cooperation with Zyxel in Russia</a></li>
<li><a href="../422797/index.html">How we made a small-sized cloud DVR from a regular IP camera</a></li>
<li><a href="../422799/index.html">How Microsoft hid the whole server and how to find it</a></li>
<li><a href="../422803/index.html">Storage Cost Calculator, or How We Opened the Black Box</a></li>
<li><a href="../422805/index.html">Quick unsubscribe from mailings in Mail.Ru Mail</a></li>
<li><a href="../422807/index.html">AliceVision: command line photogrammetry</a></li>
<li><a href="../422809/index.html">My address is not a house or a street: what will be the address of the XXI century</a></li>
<li><a href="../422811/index.html">Reaching Heaven: Managing Cloud Purchases with SAP Ariba</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>