<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Magic Ctrl-C Ctrl-V, or how to stop saving pictures and start living</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the few standard Windows utilities that I use almost every day is snippingtool , or, simply speaking, Scissors. It performs its task with a ban...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Magic Ctrl-C Ctrl-V, or how to stop saving pictures and start living</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a1e/060/6e5/a1e0606e51716ddb272b4aae52317a59.png" alt="image"><br><br>  One of the few standard Windows utilities that I use almost every day is <a href="https://en.wikipedia.org/wiki/Snipping_Tool">snippingtool</a> , or, simply speaking, Scissors.  It performs its task with a bang (however, I don‚Äôt need much from it), and among other useful things, you can mark the insertion of the selected region directly into Skype, without having to save the image to a file - just press Ctrl-V in the message input window.  It's nice that the name of the file in this case will consist of the date and time instead of, for example, a hash. <br><br>  Despite the fact that in the Snipping Tool it is possible to trace certain parts of the image, sometimes this is not enough: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  First, ‚ÄúScissors‚Äù do not know how to handle the key combination Ctrl-Z, i.e.  to make Undo in them will not work, in connection with which a single error in editing can make everything start from the beginning </li><li>  Secondly, you can trace the image only with the help of Pen and Highlighter, which is not very convenient when, for example, you need to point to a rectangular area. </li></ul><br>  It is for these reasons that I often refer to <a href="https://en.wikipedia.org/wiki/Paint_(software)">mspaint</a> .  But he has a reverse flaw - paste the image directly from the clipboard in Skype will not work. <br><br>  What is the reason for this behavior?  Can I fix it?  Let's figure it out. <br><br>  How was the process, and what came of it, read under the cut. <br><a name="habracut"></a><br>  I suggest starting with comparing the contents of the clipboard in case of copying an image from snippingtool and from mspaint.  To do this, you can use a program called <a href="http://www.nirsoft.net/utils/inside_clipboard.html">InsideClipboard</a> .  Download, unzip and run InsideClipboard, open Scissors (Win-R -&gt; snippingtool), select a region (in my case it is a small part of the black background on the desktop), click F5 on InsideClipboard and see the following picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aa5/404/784/aa54047848233aedd8529c13fd4dc0cf.png" alt="image"><br><br>  Save the same image somewhere to disk, open it in mspaint (Win-R -&gt; mspaint), select it completely (Select -&gt; Select all), copy to the clipboard using Ctrl-C, update the state InsideClipboard again and see what happened on the clipboard this time: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d04/93b/dcc/d0493bdcc2afc355f6ea677b5d65e153.png" alt="image"><br><br>  In addition to the bitmap itself, in this case we can observe some additional information in the clipboard.  Maybe it was she who interferes with Skype when inserting an image? <br><br>  Since  A self-proprietary protection was attached to the Skype client; for this task, it would be much easier to use some WinAPI function interceptor to see how Skype ‚Äúlooks‚Äù into the clipboard.  Download and run <a href="http://jacquelin.potier.free.fr/winapioverride32/">WinAPIOverride</a> , specify Skype PID in the ‚ÄúProcess ID‚Äù field and click on the ‚ÄúStart‚Äù button: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a2f/06a/c77/a2f06ac772ed0a8388ed9ae272dcb0d1.png" alt="image"><br><br>  Great, click on the button "Monitoring Files Library" <br><br><img src="https://habrastorage.org/getpro/habr/post_images/435/5a8/086/4355a8086b1ea1da1aab5b3466eea570.png" alt="image"><br><br>  and start ticking next to the functions associated with working with the clipboard.  A complete list of them can be <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ff468802(v%3Dvs.85).aspx">found</a> , for example, on MSDN: <br><br><blockquote>  AddClipboardFormatListener <br>  ChangeClipboardChain <br>  CloseClipboard <br>  CountClipboardFormats <br>  EmptyClipboard <br>  EnumClipboardFormats <br>  GetClipboarddata <br>  GetClipboardFormatName <br>  GetClipboardOwner <br>  GetClipboardSequenceNumber <br>  GetClipboardViewer <br>  GetOpenClipboardWindow <br>  GetPriorityClipboardFormat <br>  GetUpdatedClipboardFormats <br>  IsClipboardFormatAvailable <br>  Openclipboard <br>  RegisterClipboardFormat <br>  RemoveClipboardFormatListener <br>  SetClipboardData <br>  SetClipboardViewer </blockquote><br>  Go to the documentation for any of them and note that the work with the clipboard is carried out using the User32 module.  Put a tick next to it and the corresponding functions and click on the ‚ÄúOK‚Äù button: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/34d/66c/1fa/34d66c1fa2221d7293d402de882495ab.png" alt="image"><br><br>  Insert an image from the snippingtool into the Skype message input window and look at the call chain: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/17d/905/c13/17d905c136bd840d9b1febabaa8b06c7.png" alt="image"><br><br>  Now do the same with mspaint: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/461/ef0/5f6/461ef05f60ed38aa25b32fec47def155.png" alt="image"><br><br>  Notice that the <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms649047(v%3Dvs.85).aspx">IsClipboardFormatAvailable</a> function, called with argument 0x0000C013, returns different results in the two cases we have considered.  This argument indicates the format, the presence of which, in fact, you want to check: <br><br><blockquote>  format [in] <br>  Type: UINT <br>  A standard or registered clipboard format.  For a description of the standard clipboard formats, see Standard Clipboard Formats </blockquote><br>  Let's take a look at the definition of predefined formats in the WinUser.h header file: <br><br><pre><code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/* * Predefined Clipboard Formats */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_TEXT 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_BITMAP 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_METAFILEPICT 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_SYLK 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_DIF 5 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_TIFF 6 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_OEMTEXT 7 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_DIB 8 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_PALETTE 9 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_PENDATA 10 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_RIFF 11 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_WAVE 12 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_UNICODETEXT 13 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_ENHMETAFILE 14 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(WINVER &gt;= 0x0400) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_HDROP 15 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_LOCALE 16 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* WINVER &gt;= 0x0400 */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(WINVER &gt;= 0x0500) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_DIBV5 17 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* WINVER &gt;= 0x0500 */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(WINVER &gt;= 0x0500) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_MAX 18 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta">(WINVER &gt;= 0x0400) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_MAX 17 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_MAX 15 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_OWNERDISPLAY 0x0080 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_DSPTEXT 0x0081 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_DSPBITMAP 0x0082 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_DSPMETAFILEPICT 0x0083 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_DSPENHMETAFILE 0x008E </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* * "Private" formats don't get GlobalFree()'d */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_PRIVATEFIRST 0x0200 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_PRIVATELAST 0x02FF </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* * "GDIOBJ" formats do get DeleteObject()'d */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_GDIOBJFIRST 0x0300 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CF_GDIOBJLAST 0x03FF</span></span></code> </pre> <br>  As you can see, 0x0000C013 that interests us is, unfortunately, not among them.  Googling a bit, I came across several sources (for example, <a href="http://www.dfrws.org/2011/proceedings/18-350.pdf">here</a> ), which say that this format is associated with <a href="https://en.wikipedia.org/wiki/Object_Linking_and_Embedding">OLE</a> : <br><br><blockquote>  The Windows clipboard is the mechanism that Microsoft <br>  Windows operating systems <br>  between applications.  It first appeared in Windows 3.1, <br>  although its functionality has greatly increased since then. <br>  Table 1 shows the standard formats used by the clipboard <br>  (Petzold, 1999).  However, Microsoft also provides the ability <br>  for ‚Äúprivate data formats‚Äù, formats that are application <br>  specific (for example, fonts in a word processing program), <br>  couldn‚Äôt have been registered <br>  transfer data in these formats (Petzold, 1999).  Two private data <br>  formats that are used extensively are object link embedding <br>  (OLE) (0xC013) and dataobjects (0xC009) </blockquote><br>  If we load mspaint into OllyDbg and set the breakpoint at the beginning of the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms649051(v%3Dvs.85).aspx">SetClipboardData</a> function, then when copying the image or its part to the clipboard, we will see by Call Stack that we were really called from OLE-related functions: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/42d/500/513/42d500513328fdc000cc82860614ecdf.png" alt="image"><br><br>  Apparently, Skype is really at a meeting in the clipboard data associated with OLE, ceases to think that it is a full image.  I can not say whether this is a bug or a feature, but this behavior obviously does not suit me. <br><br>  By the way, did you notice that InsideClipboard did not show data with the format 0x0000C013?  If you download any other viewer clipboard (for example, <a href="http://www.freeclipboardviewer.com/">Free Clipboard Viewer</a> ), then we will see these ‚ÄúOle Private Data‚Äù: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ef6/f6e/618/ef6f6e61888b1fbb35e6067b4ad08c15.png" alt="image"><br><br>  But wait!  After all, there really is an image in the clipboard, since we can copy it, for example, on the same mspaint.  Let's try to get it, clear the current contents of the clipboard and ‚Äúcompose‚Äù it again, so that there is not the slightest mention of OLE in it. <br><br>  We write the following code in C # <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows.Forms; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">clipboard_helper</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { [STAThread] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Clipboard.ContainsData(DataFormats.Bitmap)) { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> data = Clipboard.GetData(DataFormats.Bitmap); Clipboard.SetData(DataFormats.Dib, data); } } } }</code> </pre><br>  copy the image from mspaint to the clipboard, look at the output of InsideClipboard <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a41/8f3/afc/a418f3afc1d38174f95bdbfc38b49b06.png" alt="image"><br><br>  , run our application and look at the contents of the clipboard again: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/29b/385/809/29b385809c9f6a3de4b205c60f762cfc.png" alt="image"><br><br>  We try to insert the image in Skype, and ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/69f/e7c/40a/69fe7c40a7110130b338bc5b2ea577eb.png" alt="image"><br><br>  Great! <br><br>  Of course, manually launching a separate executable file every time you copy is not a good idea, so I suggest that you arm <a href="http://www.ollydbg.de/">yourself</a> with <a href="http://www.ollydbg.de/">OllyDbg</a> and start doing it automatically.  Yes, you can call the appropriate code directly from the OllyDbg module, but why, if we already have a ready-made program? <br><br>  Copy mspaint.exe from "% WINDIR% \ System32" to any other directory, remove the use of ASLR technology using <a href="http://sourceforge.net/projects/pe-tools/">PE Tools</a> (this process has already been described several times in previous articles - for example, <a href="http://habrahabr.ru/post/261507/">here</a> ), run Paint in OllyDbg and see the following message : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f33/e89/cf9/f33e89cf95624cb7fffde65df26051d7.png" alt="image"><br><br>  Well, we have previously <a href="http://habrahabr.ru/post/262207/">dealt</a> with changing the behavior of the application in the event of a change in its environment, so let's create a directory called ‚Äúen-US‚Äù (in your case, of course, it can be different), and put the mspaint.exe file there. mui. <br><br>  Yes, now Paint starts correctly: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/267/0e3/d62/2670e3d62ce21535539810d68edda2c8.png" alt="image"><br><br>  Go to the User32 module (right-click on the window CPU -&gt; View -&gt; Module 'USER32'), press Ctrl-N and look for SetClipboardData in the list of names: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f2e/c36/eee/f2ec36eee1b2628061ee398ac03a8741.png" alt="image"><br><br>  Put the breakpoint on the beginning of this function, copy something to the clipboard from the mspaint window and look at the call stack: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/420/28b/32b/42028b32bbad392c6723e2874de1e449.png" alt="image"><br><br>  We jump to the nearest "user" code, which in this case is located at <b>0x104FDE3</b> , and look at the "environment": <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dab/74f/12a/dab74f12a56000cac472cc9e13d91d7e.png" alt="image"><br><br>  Ok, at the address <b>0x0104FDE8</b> you can position the jump on our code cave.  Let's think about how it will look like: <br><br><pre> <code class="hljs 1c">;  <span class="hljs-built_in"><span class="hljs-built_in"></span></span>    PUSHAD PUSHFD ;   ShellExecuteA PUSH <span class="hljs-number"><span class="hljs-number">0</span></span> ; nShowCmd PUSH <span class="hljs-number"><span class="hljs-number">0</span></span> ; lpDirectory PUSH <span class="hljs-number"><span class="hljs-number">0</span></span> ; lpParameters PUSH <span class="hljs-string"><span class="hljs-string">"cb_helper.exe"</span></span> ; lpFile PUSH <span class="hljs-string"><span class="hljs-string">"open"</span></span> ; lpOperation PUSH <span class="hljs-number"><span class="hljs-number">0</span></span> ; hwnd CALL ShellExecuteA ;  <span class="hljs-built_in"><span class="hljs-built_in"></span></span>   <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-built_in"><span class="hljs-built_in"></span></span> POPFD POPAD ;  ,       code cave' MOV EAX,DWORD PTR DS:[ESI] PUSH EDI MOV ECX,ESI JMP 0x<span class="hljs-number"><span class="hljs-number">0104</span></span>FDFD</code> </pre><br>  Now you need to know the address in the IAT, which is the address of the ShellExecuteA function.  We load mspaint.exe into PE Tools, click on the ‚ÄúDirectories‚Äù button, open the ‚ÄúImport Directory‚Äù item and click on SHELL32.dll (exactly there, according to the documentation, the implementation of this function is found): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/402/f8e/a6c/402f8ea6c5e98cfd69da047543df840e.png" alt="image"><br><br>  Unfortunately, among the functions imported from SHELL32.dll there is neither the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb762153(v%3Dvs.85).aspx">ShellExecute</a> name, nor <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682425(v%3Dvs.85).aspx">CreateProcess</a> , nor the <a href="https://msdn.microsoft.com/en-us/library/277bwbdz.aspx">system</a> (however, there is an import of the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb762154(v%3Dvs.85).aspx">ShellExecuteExW</a> function, but in our case it is somewhat redundant).  Maybe it is imported by ordinal? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/12b/740/952/12b7409520ef5e996773cf21382d1a1c.png" alt="image"><br><br>  Let's find out which ordinal corresponds to it.  To solve this problem, I used the <a href="https://msdn.microsoft.com/en-us/library/c1h23y6c.aspx">dumpbin</a> utility, available from VS Command Prompt: <br><br><pre> dumpbin / exports shell32.dll<font></font>
<font></font>
 Microsoft (R) COFF / PE Dumper Version 11.00.60610.1
 Copyright (C) Microsoft Corporation.  All rights reserved.<font></font>
<font></font>
<font></font>
 Dump of file shell32.dll<font></font>
<font></font>
 File Type: DLL<font></font>
<font></font>
   Section contains the following exports for SHELL32.dll<font></font>
<font></font>
     00000000 characteristics
     505A94F2 time date stamp Thu Sep 20 08:00:50 2012
         0.00 version
            2 ordinal base
          930 number of functions
          349 number of names<font></font>
<font></font>
     ordinal hint RVA name
         [...]
         451 12E 0027CF17 ShellExecuteA
         452 12F 0027CFA0 ShellExecuteEx
         453 130 0027CFA0 ShellExecuteExA
         454 131 0006CD23 ShellExecuteExW
         455 132 001F8CAB ShellExecuteW
</pre><br>  As you can see, it cannot be imported by the ordinal either. <br><br>  Well, then we have the following options: <br><ul><li>  Rewrite code from C # to WinAPI and call the WinAPI functions necessary for working with the clipboard directly from the mspaint module </li><li>  Get the address of the ShellExecuteA function using a bunch of <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684175(v%3Dvs.85).aspx">LoadLibrary</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms683212(v%3Dvs.85).aspx">GetProcAddress</a> functions that are in the IAT </li><li>  Add ShellExecuteA function to IAT yourself </li></ul><br>  The first solution will turn into approximately the same problem that we are dealing with right now - none of the WinAPI functions required to work with the clipboard are currently directly imported into the application under study.  Interaction with the clipboard is carried out through OLE, which, in my opinion, is not the most convenient option for patching. <br>  The second solution will work, however, in my opinion, does not look very elegant. <br>  But the third solution looks pretty tempting. <br><br>  To add a new feature to IAT, I decided to use a program called CFF Explorer, part of the <a href="http://www.ntcore.com/exsuite.php">Explorer Suite</a> .  Open mspaint.exe in it, go to the ‚ÄúImport Adder‚Äù tab, click on the ‚ÄúAdd‚Äù button, specify the path to the shell32.dll file ("% WINDIR% \ System32 \ shell32.dll"), select the ShellExecuteA function from the list that appears click on the ‚ÄúImport By Name‚Äù and ‚ÄúRebuild Import Table‚Äù buttons, then save the changes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b2/85c/dd6/0b285cdd6ccff7bb096f9b50304bd19b.png" alt="image"><br><br>  As a result of our actions in the Import Directory tab of the same tool, the following entry should appear: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f33/044/4fe/f330444fee106ba0be832b8098891d07.png" alt="image"><br><br>  Strange, but the execution of these steps led to different results on different versions of Windows.  As a result of doing these operations on Windows 7, we get a binary that contains instead of the address of the ShellExecuteA function some kind of nonsense, but if you perform all these actions on Windows XP, then everything works as expected.  At the time of this writing, I was in the process of communicating with the user <b>- = AkaBOSS = -</b> with <a href="https://exelab.ru/">exelab</a> to find out the reason for this behavior. <br><br>  Taking the binary from the CFF Explorer program on Windows XP, I opened it on my main system in OllyDbg and looked at the address <b>0x01617198</b> .  Why this particular address?  Because the mspaint module was loaded at <b>0x01000000</b> (however, it could not be loaded on any other database, because we have disabled ASLR earlier) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa5/ff9/3de/fa5ff93deae1932fa7db49cd67505938.png" alt="image"><br><br>  , and CFF Explorer told us to look at the offset <b>0x00617198</b> .  <b>0x01000000</b> + <b>0x00617198</b> = <b>0x01617198</b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/665/258/250/6652582509aabe7f6b7d878d0f8e20ff.png" alt="image"><br><br>  As you can see, the address of the ShellExecuteA function is indeed located here. <br><br>  We are looking for a place for code cave and write the following code (of course, addresses may differ): <br><br><pre> <code class="hljs objectivec"><span class="hljs-number"><span class="hljs-number">0108977</span></span>D . <span class="hljs-number"><span class="hljs-number">6</span></span>F <span class="hljs-number"><span class="hljs-number">70</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>E <span class="hljs-number"><span class="hljs-number">00</span></span> ASCII <span class="hljs-string"><span class="hljs-string">"open"</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">01089782</span></span> . <span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-number"><span class="hljs-number">62</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>F <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>C <span class="hljs-number"><span class="hljs-number">70</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>E <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">78</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ASCII <span class="hljs-string"><span class="hljs-string">"cb_helper.exe"</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">01089790</span></span> &gt; <span class="hljs-number"><span class="hljs-number">60</span></span> PUSHAD <span class="hljs-number"><span class="hljs-number">01089791</span></span> . <span class="hljs-number"><span class="hljs-number">9</span></span>C PUSHFD <span class="hljs-number"><span class="hljs-number">01089792</span></span> . <span class="hljs-number"><span class="hljs-number">6</span></span>A <span class="hljs-number"><span class="hljs-number">00</span></span> PUSH <span class="hljs-number"><span class="hljs-number">0</span></span> ; /IsShown = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">01089794</span></span> . <span class="hljs-number"><span class="hljs-number">6</span></span>A <span class="hljs-number"><span class="hljs-number">00</span></span> PUSH <span class="hljs-number"><span class="hljs-number">0</span></span> ; |DefDir = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-number"><span class="hljs-number">01089796</span></span> . <span class="hljs-number"><span class="hljs-number">6</span></span>A <span class="hljs-number"><span class="hljs-number">00</span></span> PUSH <span class="hljs-number"><span class="hljs-number">0</span></span> ; |Parameters = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-number"><span class="hljs-number">01089798</span></span> . <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">82970801</span></span> PUSH mspaint<span class="hljs-number"><span class="hljs-number">.01089782</span></span> ; |FileName = <span class="hljs-string"><span class="hljs-string">"cb_helper.exe"</span></span> <span class="hljs-number"><span class="hljs-number">0108979</span></span>D . <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>D970801 PUSH mspaint<span class="hljs-number"><span class="hljs-number">.0108977</span></span>D ; |Operation = <span class="hljs-string"><span class="hljs-string">"open"</span></span> <span class="hljs-number"><span class="hljs-number">010897</span></span>A2 . <span class="hljs-number"><span class="hljs-number">6</span></span>A <span class="hljs-number"><span class="hljs-number">00</span></span> PUSH <span class="hljs-number"><span class="hljs-number">0</span></span> ; |hWnd = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-number"><span class="hljs-number">010897</span></span>A4 . FF15 <span class="hljs-number"><span class="hljs-number">98716101</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CALL</span></span> DWORD PTR DS:[&lt;&amp;shell32.ShellExecuteA&gt;] ; \ShellExecuteA <span class="hljs-number"><span class="hljs-number">010897</span></span>AA . <span class="hljs-number"><span class="hljs-number">9</span></span>D POPFD <span class="hljs-number"><span class="hljs-number">010897</span></span>AB . <span class="hljs-number"><span class="hljs-number">61</span></span> POPAD <span class="hljs-number"><span class="hljs-number">010897</span></span>AC . <span class="hljs-number"><span class="hljs-number">8</span></span>B06 MOV EAX,DWORD PTR DS:[ESI] <span class="hljs-number"><span class="hljs-number">010897</span></span>AE . <span class="hljs-number"><span class="hljs-number">57</span></span> PUSH EDI <span class="hljs-number"><span class="hljs-number">010897</span></span>AF . <span class="hljs-number"><span class="hljs-number">8</span></span>BCE MOV ECX,ESI <span class="hljs-number"><span class="hljs-number">010897</span></span>B1 .^ E9 <span class="hljs-number"><span class="hljs-number">4766</span></span>FCFF JMP mspaint<span class="hljs-number"><span class="hljs-number">.0104</span></span>FDFD</code> </pre><br>  Now add a jump to our code cave after calling the procedure responsible for adding data to the clipboard: <br><br><pre> <code class="hljs css">0104<span class="hljs-selector-tag"><span class="hljs-selector-tag">FDE3</span></span> . <span class="hljs-selector-tag"><span class="hljs-selector-tag">E8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">B6A70100</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CALL</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">JMP</span></span>.&amp;<span class="hljs-selector-tag"><span class="hljs-selector-tag">MFC42u</span></span>.<span class="hljs-selector-id"><span class="hljs-selector-id">#2066</span></span>&gt; 0104<span class="hljs-selector-tag"><span class="hljs-selector-tag">FDE8</span></span> . <span class="hljs-selector-tag"><span class="hljs-selector-tag">E9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">A3990300</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">JMP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mspaint</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.01089790</span></span> 0104<span class="hljs-selector-tag"><span class="hljs-selector-tag">FDED</span></span> . <span class="hljs-selector-tag"><span class="hljs-selector-tag">EB</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">E</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">JMP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SHORT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mspaint</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0104FDFD</span></span></code> </pre><br>  We save our changes to the executable file and enjoy directly pasting the contents of the clipboard from mspaint to Skype. <br><br><h3>  Afterword </h3><br>  It's time to say goodbye to the files "2.PNG" and "3.PNG" from the creators of "1.PNG", who just wanted to send images to their interlocutors in Skype.  Do not be lazy to come up with random names for your files?  Then do not be lazy and open OllyDbg. <br><br>  Thank you for your attention, and again I hope that the article was useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/263175/">https://habr.com/ru/post/263175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263163/index.html">We connect the backup channel of the Internet in a router with firmware dd-wrt</a></li>
<li><a href="../263165/index.html">Budget Failover Solution for Remote Offices for Microsoft UC</a></li>
<li><a href="../263167/index.html">OData REST API - minor tricks (part 2)</a></li>
<li><a href="../263169/index.html">12 little-known facts about CSS</a></li>
<li><a href="../263171/index.html">Automatic textual key detection (Sentiment Analysis)</a></li>
<li><a href="../263179/index.html">Days of field testing technology iBeacon in Luzhniki</a></li>
<li><a href="../263181/index.html">How to lose and find your account on AWS</a></li>
<li><a href="../263183/index.html">Microsoft advised Skype users to change passwords</a></li>
<li><a href="../263187/index.html">Historical budgets from 1866 and a long way to turn them into open data</a></li>
<li><a href="../263189/index.html">7 simple tips for optimizing emails for mobile devices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>