<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Freeswitch Phonebook</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 It so happens that Freeswitch is my little weakness. Yes, Asterisk is more common in the world now, and I also know it pretty well, but...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Freeswitch Phonebook</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/0a3/ab4/d74/0a3ab4d74aa04b0ab913569836ea4208.jpg"><br><br><h3>  Introduction </h3><br>  It so happens that Freeswitch is my little weakness.  Yes, Asterisk is more common in the world now, and I also know it pretty well, but ... It is Freeswitch that attracts me with something.  It can be a set of possibilities, it can be super-stable, it can be a small resource consumption and a more logical device.  Or maybe I'm just a hipster from the IT world and I want to be not like everyone else.  How to know.  We are not psychologists to dig into the darkness of the human soul, so we just take it for granted and deal with things more practical.  We will improve customer service.  On the agenda is improved customer personalization through recognition. <a name="habracut"></a><br><br><h3>  Trivia </h3><br>  The phone book is an extremely utilitarian thing.  Present in all more or less decent add-on IP-telephony systems.  Allows for incoming calls to identify the customer by phone number.  Of course, we are not a sales department, we don‚Äôt write to everyone in CRM, but even an employee of a customer who calls technical support with their problems is pleased to be recognized right away.  At the application level, the phone book is usually connected as a plug-in, allowing you to use a certain information store, most often a database, as a data source.  Not escaped a similar fate and Freeswitch.  At different times, we used two phonebook options: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  based on the plugin and SQLite database; </li><li>  based on the self-written REST connector on Lua (still in use today). </li></ul><br>  I will tell about the implementation of both options.  Each has its own advantages and disadvantages. <br><br>  The phone book based on the database is simpler in the device and more standard.  On the official website of Freeswitch there is a good dock, for its installation and configuration.  But since there is no web interface on the telephony server (I‚Äôm a principled opponent of web interfaces to telephone exchanges, but this is a completely different story, some time next), then a limited number of unlimited people who are not afraid of the word <i>base</i> can tune the phone book <i>data</i> , <i>query</i> and others like them.  And then the <i>console</i> , as in my case.  You ask, why not MySQL?  Because it was not necessary.  We do not have all of Russia in the phone book, but only about 500 contacts.  For this, SQLite turned out to be behind the eyes.  The second difficulty was the process of adding information.  It is necessary to add to several tables, take into account the connection and do not forget about duplicates.  I still have a document somewhere in the order of fulfilling requests to add and update information in the phone book.  The advantages are obvious - the database engine does not require the installation and integration of additional software and is in itself as simple as mooing.  The entire phone book is in one file, easily backed up and saved.  The tables inside are extremely simple and understanding their structure does not require a special thought process.  <s>It is enough to raise the stick heavier and knock the neighbor to the left.</s>  <s>Let him think yes.</s> <br><br>  The second version of the phone book was less trivial in implementation.  Since we are now actively trying to master CMDB iTop, the idea has appeared to cross the phone book with it.  Fortunately, the standard contact storage module in the CMDB is present and corresponds.  Standard methods failed to do this.  Lua came to the rescue, everything turned out clean and tidy with her.  Among the advantages of this approach, it is possible to note the presence of a convenient interface for adding and editing contacts, the ability to save any data in the CMDB, transfer it to the telephone exchange and use it when routing a call (not yet used, but planned).  Among the shortcomings, of course, are the transmission delays over the network, dependence on external service, the need for programming and adjustment of this entire enterprise.  But the result is worth it.  And, by the way, I do not persuade you to use just such an option, just by his example I would like to show how to organize interaction with external services. <br><br><h3>  Piece of cake </h3><br>  According to the old IT tradition, let's go from simple to complex.  Let's start with the fact that we lay down on the sofa and do procrastination.  See how easy it is.  But the work is not a wolf, you will not kick the legs, and therefore we move the body to a vertical position and move closer to the telephone station console ... <br>  The phonebook module in Freeswitch is called mod_cidlookup <a href="https://wiki.freeswitch.org/wiki/Mod_cidlookup">Description on the old site</a> <a href="https://freeswitch.org/confluence/display/FREESWITCH/mod_cidlookup">Description on the new site</a> .  First you need to decide whether the module is with us.  Who knows, suddenly leaked out imperceptibly. <br><br>  We look at the presence of a module in the modules folder. <br><br><pre><code class="bash hljs">ls -la /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch/mod/ | grep mod_cidlookup</code> </pre> <br>  If there are no files, then I have bad news for you.  The module must be assembled or installed.  I prefer to build Freeswitch myself, so the source tree ready for building is always at hand.  A description of how to assemble a module for Freeswitch is beyond the scope of this article, so leave it there and just accept that the module already lies in the folder we need.  Now it needs to be configured and prepared for it.  The main configuration of the module settings is located in the file. <br><br>  /usr/local/freeswitch/conf/autoload_configs/cidlookup.conf.xml <br>  The minimum working config looks like this. <br><br><div class="spoiler">  <b class="spoiler_title">Working config</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cidlookup.conf"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cidlookup Configuration"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">settings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cache"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--      - . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cache-expire"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"86400"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  .    3 (, !)    .   ,    ,  .    ,     . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"odbc-dsn"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sqlite:///usr/local/freeswitch/db/phonebook.db"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    .      .      . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" SELECT (name || (CASE WHEN comment != '' THEN ' (' || comment || ')' ELSE '' END)) AS name FROM numbers n JOIN phonebook p ON n.pid = p.id WHERE n.number='${caller_id_number}' LIMIT 1 "</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">settings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Notice the conditional expression in SELECT.  It allows you to extract the client‚Äôs company from the database and its position from the comment field.  If the field is empty, then only the last name and first name are returned, as it should be.  Due to the fact that only one line is always returned, duplicates are ignored, and the earliest entry from the phone book is returned.  Therefore, before adding data, it is necessary to check that they are not in the database.  Linking in the phone book is used to support multiple phone numbers for one user. <br><br>  We proceed to create a database for our phone book. <br><br><pre> <code class="bash hljs">sudo -u freeswitch sqlite3 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch/db/phonebook.db</code> </pre> <br><pre> <code class="hljs delphi">--     . -- . CREATE TABLE phonebook ( id INTEGER PRIMARY KEY AUTOINCREMENT <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> NULL UNIQUE, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> VARCHAR (<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> NULL, comment VARCHAR (<span class="hljs-number"><span class="hljs-number">256</span></span>) ); CREATE <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> phonebook (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>); --  . CREATE TABLE numbers ( id INTEGER PRIMARY KEY AUTOINCREMENT <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> NULL, pid INTEGER REFERENCES phonebook (id) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> DELETE CASCADE <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> NULL, NUMBER VARCHAR (<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> NULL ); CREATE <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> NUMBER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> numbers (NUMBER); --     . INSERT INTO `phonebook` (`<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>`, `comment`) VALUES (<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'  , '</span></span>); INSERT INTO `numbers` (`pid`, `number`) VALUES (LAST_INSERT_ROWID(), <span class="hljs-string"><span class="hljs-string">'79152323245'</span></span>); INSERT INTO `phonebook` (`<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>`) VALUES (<span class="hljs-string"><span class="hljs-string">' '</span></span>); INSERT INTO `numbers` (`pid`, `number`) VALUES (LAST_INSERT_ROWID(), <span class="hljs-string"><span class="hljs-string">'74953462323'</span></span>);</code> </pre><br>  We leave from the console SQLite. <br><br><pre> <code class="hljs pgsql">.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre> <br>  Now you need to load the module and set it on the newly created phone book.  Go to the console Freeswitch. <br><br><pre> <code class="bash hljs">fs_cli</code> </pre> <br>  We are looking for a loaded phone book module. <br><br><pre> <code class="hljs pgsql">freeswitch@<span class="hljs-type"><span class="hljs-type">internal</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> modules mod_cidlookup <span class="hljs-number"><span class="hljs-number">0</span></span> total.</code> </pre><br>  Yeah, there is no module.  We try to download it. <br><br><pre> <code class="hljs pgsql">freeswitch@<span class="hljs-type"><span class="hljs-type">internal</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> mod_cidlookup +OK Reloading <span class="hljs-type"><span class="hljs-type">XML</span></span> +OK <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-29</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">33.890548</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span>] mod_cidlookup.c:<span class="hljs-number"><span class="hljs-number">122</span></span> Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> dsn: sqlite:///usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/freeswitch/db/phonebook.db <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-29</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">33.890548</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span>] mod_enum.c:<span class="hljs-number"><span class="hljs-number">880</span></span> ENUM Reloaded <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-29</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">33.890548</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span>] switch_time.c:<span class="hljs-number"><span class="hljs-number">1415</span></span> Timezone reloaded <span class="hljs-number"><span class="hljs-number">1781</span></span> definitions <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-29</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">33.890548</span></span> [CONSOLE] switch_loadable_module.c:<span class="hljs-number"><span class="hljs-number">1538</span></span> Successfully Loaded [mod_cidlookup] <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-29</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">33.890548</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">NOTICE</span></span>] switch_loadable_module.c:<span class="hljs-number"><span class="hljs-number">292</span></span> Adding Application <span class="hljs-string"><span class="hljs-string">'cidlookup'</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-29</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">33.890548</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">NOTICE</span></span>] switch_loadable_module.c:<span class="hljs-number"><span class="hljs-number">338</span></span> Adding API <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-string"><span class="hljs-string">'cidlookup'</span></span> .</code> </pre><br>  Ok, the module is loaded.  If you have problems connecting to the database, they will appear in the log.  We are looking for it again among the loaded modules. <br><br><pre> <code class="hljs pgsql">freeswitch@<span class="hljs-type"><span class="hljs-type">internal</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> modules mod_cidlookup <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>,<span class="hljs-type"><span class="hljs-type">name</span></span>,ikey,filename api,cidlookup,mod_cidlookup,/usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/freeswitch/mod/mod_cidlookup.so application,cidlookup,mod_cidlookup,/usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/freeswitch/mod/mod_cidlookup.so <span class="hljs-number"><span class="hljs-number">2</span></span> total.</code> </pre> <br>  Now you need to test the performance of the module.  This can also be done via the console using the cidlookup API function.  We look at its syntax. <br><br><pre> <code class="hljs pgsql">freeswitch@<span class="hljs-type"><span class="hljs-type">internal</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> api cidlookup <span class="hljs-type"><span class="hljs-type">name</span></span>,description,syntax,ikey cidlookup,cidlookup API,cidlookup status|number [skipurl] [skipcitystate] [<span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span>],mod_cidlookup <span class="hljs-number"><span class="hljs-number">1</span></span> total.</code> </pre> <br>  We recall the data that we added to the phone book and test the work of the API. <br><br><pre> <code class="hljs kotlin"><span class="hljs-symbol"><span class="hljs-symbol">freeswitch@</span></span><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span>&gt; cidlookup <span class="hljs-number"><span class="hljs-number">79152323245</span></span>   (  , ) <span class="hljs-symbol"><span class="hljs-symbol">freeswitch@</span></span><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span>&gt; cidlookup <span class="hljs-number"><span class="hljs-number">74953462323</span></span>  </code> </pre> <br>  As you can see, the function returns the correct contact data from the phone book.  Moreover, if there is a comment, it is also returned in brackets.  Now we need to add this function to the dialplan in order to bring light and joy to people.  Since the dialplan is arranged differently for everyone, I will show only its part, which concerns the phone book and I will indicate its approximate location.  I have it located in the /usr/local/freeswitch/conf/dialplan/public.xml file. <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--     . --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--       . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cid_number_cleanup"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">continue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"caller_id_number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(\d+)$"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">application</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"set"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"effective_caller_id_number=$1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">inline</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--       . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cid_name_cleanup"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">continue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"caller_id_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(\d+)$"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">application</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"set"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"effective_caller_id_name=$1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">inline</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--       ,       ,   ,    .           . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cid_lookup"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">continue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${module_exists(mod_cidlookup)}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"caller_id_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(\d+)$|^$"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"caller_id_number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(\d+)$"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">application</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cidlookup"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$1"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Save the file, reload the dialplan with the command <br><br><pre> <code class="bash hljs">fs_cli -x reloadxml</code> </pre> <br>  If there are no errors, you can check the operation of the module.  After playing enough, we add the module to autoload.  This is done in the /usr/local/freeswitch/conf/autoload_configs/modules.conf.xml file.  We are looking for a line there <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">load</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">module</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mod_cidlookup"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  and uncomment it.  If it is missing, then simply add it to the end of the file. <br><br>  That's it, the phone book is set up.  But admins would not be admins if they didn't want to constantly improve something.  And the hike along this road leads to the next part of our story. <br><br><h3>  Let's rock </h3><br>  The interaction of Freeswitch and iTop is arranged in a completely standard way, through the REST interface described on the <a href="https://wiki.openitop.org/doku.php%3Fid%3D2_3_0:advancedtopics:rest_json">official website</a> .  What is the difficulty?  In that it will not work directly with him, it is necessary to call for help the power of the <s>swan</s> plug-ins.  It was originally planned to use <a href="https://wiki.freeswitch.org/wiki/Mod_curl">mod_curl</a> , but somehow it did not work out with it.  It was decided to write my own small Lua script and call it via <a href="https://freeswitch.org/confluence/display/FREESWITCH/mod_lua">mod_lua</a> .  First of all, you need to prepare the phone book itself, that is, in one way or another, upload contacts to iTop.  Your choice - sources of synchronization, download CSV or filling the phone book manually.  Since we have a sandbox here and we don‚Äôt need a lot of contacts, let's create one organization and add several contacts to it.  To make changes to the CMDB, you must have the appropriate rights or be an administrator. <br><br><ul><li>  Open iTop, in the side menu, go to <b>Data Administration ‚Üí Organizations</b> and click the ‚Äú <b>New ...</b> ‚Äù button on the right. </li></ul><br><img src="https://habrastorage.org/web/91f/6d8/1f0/91f6d81f03a54ef690517822f307d9ae.png"><br><br><ul><li>  Fill in the required fields and click the button " <b>Create</b> ". </li></ul><br><img src="https://habrastorage.org/web/6b4/b67/222/6b4b672220914d2e982fd17a18c32f95.png"><br><br><ul><li>  If everything is done correctly, we will transfer to the page of the created organization. </li></ul><br><img src="https://habrastorage.org/web/ba2/1c6/238/ba21c623842a4f8ebc444cfb929d6175.png"><br><br><ul><li>  Now go to the menu at <b>Configuration Management ‚Üí Contacts ‚Üí Create a contact</b> .  In the window that opens, select the type of contact " <b>Person</b> " and click " <b>Apply</b> ". </li></ul><br><img src="https://habrastorage.org/web/573/12a/56e/57312a56e4bf4a70b5f2d3ec1da41137.png"><br><br><ul><li>  The add contact window opens.  Fill in all the required fields and click the " <b>Create</b> " button.  Please note that in the standard iTop installation there are no parts of the fields with additional phones, they were added by me by editing the model to solve the problem with several phones.  Editing the model is beyond the scope of the article, read more about it <a href="https://wiki.openitop.org/doku.php%3Fid%3D2_3_0:customization:start">here.</a> </li></ul>  . <br><img src="https://habrastorage.org/web/6ca/e5b/d05/6cae5bd05e844affa4d5a1be7f2d0030.png"><br><ul><li>  If you are transferred to the contact page, then everything is done correctly. </li></ul><br><img src="https://habrastorage.org/web/ede/7f9/ab5/ede7f9ab55a04fbcb9fa2fcd35da5434.png"><br>  Similarly, add a few more contacts.  Now we have where to look and you can proceed to setting up a telephone exchange.  As I said, we will request via iTop REST interface.  His listing and thoughtful taste resulted in the next request. <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"core/get"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"class"</span></span>: <span class="hljs-string"><span class="hljs-string">"Person"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"SELECT Person AS P WHERE P.phone = '79101001122' OR P.add_phone = '79101001122' OR P.add_phone_2 = '79101001122' OR P.mobile_phone = '79101001122' OR P.add_mobile_phone = '79101001122'"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"output_fields"</span></span>: <span class="hljs-string"><span class="hljs-string">"friendlyname,org_id_friendlyname,function"</span></span> }</code> </pre> <br>  Let's try to do it with Curl. <br><br><pre> <code class="bash hljs">curl -XPOST <span class="hljs-string"><span class="hljs-string">'https://&lt;itop_address&gt;/webservices/rest.php?version=1.0'</span></span> -d <span class="hljs-string"><span class="hljs-string">'auth_user=admin&amp;auth_pwd=password&amp;json_data=%7B%22operation%22%3A%22core%2Fget%22%2C%22class%22%3A%22Person%22%2C%22key%22%3A%22SELECT%20Person%20AS%20P%20WHERE%20P.phone%20%3D%20%2779101001122%27%20OR%20P.add_phone%20%3D%20%2779101001122%27%20OR%20P.add_phone_2%20%3D%20%2779101001122%27%20OR%20P.mobile_phone%20%3D%20%2779101001122%27%20OR%20P.add_mobile_phone%20%3D%20%2779101001122%27%22%2C%22output_fields%22%3A%22friendlyname%2Corg_id_friendlyname%2Cfunction%22%7D'</span></span></code> </pre> <br>  As you can see, the request requires authentication.  The user in iTop must exist and have the necessary rights to execute requests. <br><br>  In response, we get the found user: <br><br><pre> <code class="hljs tex">{ "objects": { "Person::486": { "code": 0, "message": "", "class": "Person", "key": "486", "fields": { "friendlyname": "<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0412<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0430<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0441<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0438<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043b<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0438<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0439 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>041f<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0443<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043f<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043a<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0435<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0432<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0438<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0447", "org_id_friendlyname": "<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0420<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043e<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0433<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0430 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0438 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043a<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043e<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043f<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>044b<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0442<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0430", "function": "<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0421<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0443<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043f<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0435<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0440<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>0445<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043e<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043c<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>044f<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span></span>043a" } } }, "code": 0, "message": "Found: 1" }</code> </pre> <br>  In a more readable version <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"objects"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Person::486"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"class"</span></span>: <span class="hljs-string"><span class="hljs-string">"Person"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"486"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"friendlyname"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"org_id_friendlyname"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"function"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"Found: 1"</span></span> }</code> </pre> <br>  So, the data is received and transmitted, users are searched.  It's time to uncover your favorite IDE and write something inspired.  Create a separate folder for Freeswitch scripts. <br><br><pre> <code class="bash hljs">mkdir /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch/scripts</code> </pre> <br>  In this folder we create a subfolder lib in which we will store shared libraries. <br><br><pre> <code class="bash hljs">mkdir /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/freeswitch/scripts/lib</code> </pre> <br>  We need standard libraries for working with sockets and SSL. <br><pre> <code class="hljs swift">sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install lua-socket lua-sec</code> </pre> <br>  Also useful library for encoding and decoding JSON.  I chose the library <a href="http://regex.info/blog/lua/json">http://regex.info/blog/lua/json</a> .  Download it and place it in the appropriate folder. <br><pre> <code class="bash hljs">wget http://regex.info/code/JSON.lua -O lib/json.lua</code> </pre> <br>  And now everything is ready for our code to come to this world.  In the scripts folder, create the file cidlookup.lua and use the hard keyboard to enter the following code there: <br><br><div class="spoiler">  <b class="spoiler_title">/usr/local/freeswitch/scripts/cidlookup.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--    iTop. local itop_addr = 'https://&lt;itop_address:port&gt;'; local itop_user = 'admin'; local itop_pass = 'password'; --  . local json = (loadfile '/usr/local/freeswitch/scripts/lib/json.lua')(); --    . --[[      .               Freeswitch.            .  . ,  ,      .       Lua,    .  -. ]]-- -- local phone = arg[1]; local phone = argv[1]; --  . local command = { operation = 'core/get', class = 'Person', key = 'SELECT Person AS P WHERE P.phone = "' .. phone .. '" OR P.add_phone = "' .. phone .. '" OR P.add_phone_2 = "' .. phone .. '" OR P.mobile_phone = "' .. phone .. '" OR P.add_mobile_phone = "' .. phone .. '"', output_fields = 'friendlyname,org_id_friendlyname,function' }; --   iTop. local http = require 'socket.http'; local https = require 'ssl.https'; local ltn12 = require 'ltn12'; local request = 'auth_user=' .. itop_user .. '&amp;auth_pwd=' .. itop_pass .. '&amp;json_data=' .. json:encode(command); local respbody = {}; --  ,     ,    iTop  -   . --      - ,  . http.TIMEOUT = 3; local body, code, headers, status = https.request { protocol = 'tlsv1', method = 'POST', url = 'https://' .. itop_addr .. '/webservices/rest.php?version=1.0', source = ltn12.source.string(request), headers = { ["Accept"] = "*/*", ["Accept-Encoding"] = "gzip, deflate", ["Accept-Language"] = "en-us", ["Content-Type"] = "application/x-www-form-urlencoded", ["content-length"] = string.len(request) }, sink = ltn12.sink.table(respbody) }; --    ,    . caller_id = phone; --  JSON. local response = json:decode(tostring(table.concat(respbody))); -- ,   - . if(not((response == nil) or (response["objects"] == nil))) then local index = next(response["objects"]); local contact = response.objects[index]["fields"]; --   . caller_id = contact.friendlyname .. "(".. contact.org_id_friendlyname .. (not(contact["function"] == "") and ", " .. contact["function"] or "") .. ")"; end --[[             Freeswitch.             .  . ]]-- stream:write(caller_id); -- io.write(caller_id .. "\n");</span></span></code> </pre><br></div></div><br>  It is time to test our creation in battle.  We edit the script for its work from the command line and check for operability. <br><br><pre> <code class="bash hljs">lua cidlookup.lua 79101001122  (  , )</code> </pre> <br>  Great, everything works as it should.  We edit the script, disabling work from the command line.  Now connect the script to the Freeswitch.  First you need to make sure that we have the appropriate module.  Go to the console Freeswitch. <br><br><pre> <code class="hljs">fs_cli</code> </pre> <br>  Check the load module Lua. <br><br><pre> <code class="hljs ruby">freeswitch@internal&gt; show modules mod_lua type,name,ikey,filename api,lua,mod_lua,<span class="hljs-regexp"><span class="hljs-regexp">/usr/local</span></span><span class="hljs-regexp"><span class="hljs-regexp">/freeswitch/mod</span></span><span class="hljs-regexp"><span class="hljs-regexp">/mod_lua.so api,luarun,mod_lua,/usr</span></span><span class="hljs-regexp"><span class="hljs-regexp">/local/freeswitch</span></span><span class="hljs-regexp"><span class="hljs-regexp">/mod/mod</span></span>_lua.so application,lua,mod_lua,<span class="hljs-regexp"><span class="hljs-regexp">/usr/local</span></span><span class="hljs-regexp"><span class="hljs-regexp">/freeswitch/mod</span></span><span class="hljs-regexp"><span class="hljs-regexp">/mod_lua.so dialplan,LUA,mod_lua,/usr</span></span><span class="hljs-regexp"><span class="hljs-regexp">/local/freeswitch</span></span><span class="hljs-regexp"><span class="hljs-regexp">/mod/mod</span></span>_lua.so <span class="hljs-number"><span class="hljs-number">4</span></span> total.</code> </pre> <br>  If you see these lines, then everything is in order, the module is loaded.  If they are not there, the module may be assembled, but not launched.  We are trying to run it. <br><br><pre> <code class="hljs pgsql">freeswitch@<span class="hljs-type"><span class="hljs-type">internal</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> mod_lua</code> </pre> <br>  If Freeswitch cannot find a module to run, then it will be necessary to assemble and upgrade it.  We will assume that you have successfully solved this problem and loaded the module.  We try to execute our script: <br><br><pre> <code class="hljs kotlin"><span class="hljs-symbol"><span class="hljs-symbol">freeswitch@</span></span><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span>&gt; lua cidlookup.lua <span class="hljs-number"><span class="hljs-number">79101001122</span></span>  (  , )</code> </pre> <br>  Well, as you can see, the script works successfully and gets everything it needs.  It remains to add it to the dialplan.  As in the first part of the article, I will not tell you where to put it, just bring the part of the dialplan responsible for its work. <br><br><pre> <code class="hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!--     . --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--       . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cid_number_cleanup"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">continue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"caller_id_number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(\d+)$"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">application</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"set"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"effective_caller_id_number=$1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">inline</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--       . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cid_name_cleanup"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">continue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"caller_id_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(\d+)$"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">application</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"set"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"effective_caller_id_name=$1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">inline</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--       ,       ,       .           . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cid_lookup"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">continue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${module_exists(mod_lua)}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"caller_id_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(\d+)$|^$"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"caller_id_number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(\d+)$"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">application</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"set"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"effective_caller_id_name=${lua(cidlookup.lua ${caller_id_name})}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  We reload the dialplan with the command <br><br><pre> <code class="bash hljs">fs_cli -x reloadxml</code> </pre> <br>  And enjoy the result. <br><br><h3>  Taking out </h3><br>  Yes, I know, you can improve and improve.  You can connect with mod_curl and simplify the code, you can finish and optimize the script, I do not argue with that.  There is no limit to perfection.  But any road begins with the first step, and if this article is useful to someone in his difficult work, it means that it was not written in vain.  =) So I wish you health. <br><br>  PS I hope someone will come in handy.  I will be glad to your comments. </div><p>Source: <a href="https://habr.com/ru/post/330360/">https://habr.com/ru/post/330360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330350/index.html">Five steps to save the Linux server that crashed</a></li>
<li><a href="../330352/index.html">We provide the PVS-Studio analyzer to security experts</a></li>
<li><a href="../330354/index.html">Video: indie developers about failure, success and monetization</a></li>
<li><a href="../330356/index.html">Chromium based browsers - now also in ReactOS</a></li>
<li><a href="../330358/index.html">Rapid STP</a></li>
<li><a href="../330362/index.html">Mikrotik. QoS for home</a></li>
<li><a href="../330364/index.html">On the road with clouds. Relational databases in a new technological context</a></li>
<li><a href="../330366/index.html">We are building the development process and the CI pipeline, or How can a developer become DevOps for QA</a></li>
<li><a href="../330368/index.html">‚ÄúBreak the vote on RHS ++‚Äù. Give us 1,000,000 RPS</a></li>
<li><a href="../330370/index.html">What is exclusive blockchains?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>