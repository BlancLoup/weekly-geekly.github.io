<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We play APK golf. Reduce the size of Android APK files by 99.9%</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In golf, he wins the one who has less points. 

 Apply this principle in Android. We're going to play APK golf and create an application of the smalle...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We play APK golf. Reduce the size of Android APK files by 99.9%</h1><div class="post__text post__text-html js-mediator-article">  In golf, he wins the one who has less points. <br><br>  Apply this principle in Android.  We're going to play APK golf and create an application of the smallest possible size that can be installed on Android 8.0 Oreo. <br><br><h2>  A basic level of </h2><br>  Let's start with the default application that Android Studio generates.  <a href="https://developer.android.com/studio/publish/app-signing.html">Create a keystore</a> , sign the application, and measure the file size in bytes with the <code>stat -f%z $filename</code> command <code>stat -f%z $filename</code> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then install the APK on your Nexus 5x smartphone under Oreo to make sure everything works. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/df/02/59df0271a500a108982329.png"></div><br><br>  Perfectly.  Our apk weighs about one and a half megabyte. <br><a name="habracut"></a><br><h2>  APK Analyzer </h2><br>  One and a half megabyte seems too large in size to take into account what our application does (and it does not do anything), so let's examine the project and look for where to save money on volume.  This is what Android Studio generated: <br><br><ul><li>  <code>MainActivity</code> , which extends <code>AppCompatActivity</code> . </li><li>  Layout file with <code>ConstraintLayout</code> for the main window. </li><li>  Resource files with three colors, one string resource, and a theme. </li><li>  Support libraries <code>AppCompat</code> and <code>ConstraintLayout</code> . </li><li>  One <code>AndroidManifest.xml</code> . </li><li>  PNG files for square, round and background icons. </li></ul><br>  Perhaps the easiest way to deal with the icons, given that there are a total of 15 images and two XML files under <code>mipmap-anydpi-v26</code> .  Let's count all this in <a href="https://developer.android.com/studio/build/apk-analyzer.html">APK Analyzer</a> from Android Studio. <br><br><img src="https://habrastorage.org/webt/59/df/02/59df02b5087ae231553166.jpeg"><br><br>  Contrary to our initial assumptions, it seems that the largest file is Dex, and resources account for only 20% of the size of the APK. <br><br><table width="230"><tbody><tr><th width="190">  File </th><th width="40">  The size </th></tr><tr><td> <code>classes.dex</code> </td> <td>  74% </td></tr><tr><td> <code>res</code> </td> <td>  20% </td></tr><tr><td> <code>resources.arsc</code> </td> <td>  four% </td></tr><tr><td> <code>META-INF</code> </td> <td>  2% </td></tr><tr><td> <code>AndroidManifest.xml</code> </td> <td>  &lt;1% </td></tr></tbody></table><br>  Examine separately what each file does. <br><br><h3>  Dex file </h3><br>  <code>classes.dex</code> is the main culprit of the bloated APK, it occupies 73% of the total volume and therefore will be the first optimization goal.  This file contains all our compiled code in Dex format, as well as a list of external methods in the Android framework and the support library. <br><br>  The <code>android.support</code> package lists over 13,000 methods, which seems unnecessary for an application like "Hello World". <br><br><h3>  Resources </h3><br>  In the res directory there is a large number of template files, drawables and animations that are not immediately visible in the Android Studio interface.  Again, they are pulled from the library of support and occupy about 20% of the size of the APK. <br><br><img src="https://habrastorage.org/webt/59/df/12/59df12e586c37570122966.jpeg"><br><br>  The <code>resources.arsc</code> file also contains a list of all these resources. <br><br><h3>  Signature </h3><br>  The <code>META-INF</code> folder contains the files <code>CERT.SF</code> , <code>MANIFEST.MF</code> and <code>CERT.RSA</code> , which are needed for <a href="https://source.android.com/security/apksigning/v2">signing v1 APK</a> .  If an attacker changes the code inside the APK, then the signatures will not match, which protects the user from launching an outsider malware. <br><br>  <code>MANIFEST.MF</code> lists files from the APK, and <code>CERT.SF</code> contains the checksums of the manifest and each individual file.  <code>CERT.RSA</code> stores the public key that verifies the integrity of <code>CERT.SF</code> <br><br><img src="https://habrastorage.org/webt/59/df/14/59df14283b376341033351.jpeg"><br><br>  There are no obvious targets for optimization. <br><br><h3>  AndroidManifest </h3><br>  AndroidManifest is very similar to our original file.  The only difference is that instead of resources like strings and drawables, their integer identifiers are shown here, starting at <code>0x7F</code> . <br><br><h2>  Turn on minification </h2><br>  We have not tried to enable the option of minification and compression of resources in the file <code>build.gradle</code> for our application.  Let's do it. <br><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">android</span></span> { <span class="hljs-section"><span class="hljs-section">buildTypes</span></span> { <span class="hljs-section"><span class="hljs-section">release</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">minifyEnabled</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> shrinkResources <span class="hljs-literal"><span class="hljs-literal">true</span></span> proguardFiles getDefaultProguardFile( <span class="hljs-string"><span class="hljs-string">'proguard-android.txt'</span></span>), <span class="hljs-string"><span class="hljs-string">'proguard-rules.pro'</span></span> } } }</code> </pre> <br><pre> <code class="hljs swift">-keep <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fractalwrench</span></span></span><span class="hljs-class">.** </span></span>{ *; }</code> </pre> <br>  If you set <code>minifyEnabled</code> to <code>true</code> , then <a href="https://www.guardsquare.com/en/proguard">Proguard is</a> activated, which clears the application of unnecessary code.  It also obfusts the names of characters, making it difficult to reverse engineer an application. <br><br>  <code>shrinkResources</code> will remove any resources from the APK that are not directly referenced.  There may be problems if you do not directly access resources, but this does not apply to our application. <br><br><h2>  786 KB (decrease by 50%) </h2><br>  We have reduced the size of the APK by half without any visible changes in the program. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/df/02/59df0271a500a108982329.png"></div><br><br>  If you have not yet included <code>minifyEnabled</code> and <code>shrinkResources</code> in your application, this is the main thing that should be learned from this article.  You can easily save a few megabytes by spending just a couple of hours on configuration and testing. <br><br><h2>  Goodbye, AppCompat, we barely recognized you </h2><br>  <code>classes.dex</code> now occupies 57% of the total APK.  The main part of the list of methods from the Dex file belongs to the <code>android.support</code> package, so we're going to remove the support library.  To do this, do the following: <br><br><ul><li>  Completely remove the dependency block from <code>build.gradle</code> . <br><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">dependencies</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">implementation</span></span> <span class="hljs-string"><span class="hljs-string">'com.android.support:appcompat-v7:26.1.0'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'com.android.support.constraint:constraint-layout:1.0.2'</span></span> }</code> </pre> </li><li>  Update MainActivity to extend the <code>android.app.Activity</code> class. <br><br><pre> <code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span></span></code> </pre> </li><li>  Update our template to use a single <code>TextView</code> . <br><br><pre> <code class="hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"match_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:gravity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"center"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Hello World!"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> </li><li>  Remove <code>styles.xml</code> and the <code>android:theme</code> attribute from the <code>&lt;application&gt;</code> element in <code>AndroidManifest</code> . </li><li>  Remove <code>colors.xml</code> . </li><li>  Do 50 pushups while Gradle syncs. </li></ul><br><h2>  108 KB (87% reduction) </h2><br>  Mother of God, the file has decreased almost tenfold: from 786 KB to 108 KB.  The only noticeable change was only a change in the color of the toolbar, which was painted in the default OS theme. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/df/1d/59df1d6713703534590706.png"></div><br><br>  The res directory now accounts for 95% of the size of the APK because of all these launcher icons.  If these icons were made by our designer, we would try to <a href="https://developer.android.com/studio/write/convert-webp.html">convert them to WebP</a> , a more efficient format that is supported in API 15 and later versions. <br><br>  Fortunately, Google has already optimized our drawables, although otherwise we would have been able to optimize them ourselves and remove unnecessary metadata from PNG using <a href="https://imageoptim.com/mac">ImageOptim</a> . <br><br>  Let's do it unconventionally - and replace all our launch icons with a single, single-pixel black dot in the <code>res/drawable</code> .  This picture weighs 67 bytes. <br><br><h2>  6808 bytes (a decrease of 94%) </h2><br>  We got rid of almost all resources, so it‚Äôs not surprising that the size of the APK decreased by about 95%.  The following resources are still mentioned in the resources.arsc file: <br><br><ul><li>  1 template file </li><li>  1 string resource </li><li>  1 launcher icon </li></ul><br>  Let's go from the top down. <br><br><h3>  Template file (6262 bytes, 9% reduction) </h3><br>  The Android framework <a href="https://developer.android.com/reference/android/view/LayoutInflater.html">inflates our XML file</a> and automatically creates a <code>TextView</code> object that is used as the <code>contentView</code> for the <code>Activity</code> . <br><br>  Let's try to do without this broker by deleting the XML file and programmatically setting the contentView.  The resource size will decrease because the XML file disappears, but the size of the Dex file will increase as we mention additional <code>TextView</code> methods there. <br><br><pre> <code class="hljs cs">TextView textView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextView(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); textView.setText(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>); setContentView(textView);</code> </pre> <br>  Looks like a nice exchange. <br><br><h3>  Application name (6034 bytes, 4% reduction) </h3><br>  Let's remove the <code>strings.xml</code> and replace the <code>android:label</code> in the AndroidManifest manifest with the letter "A".  This seems like a small change, but deleting a record from <code>resources.arsc</code> reduces the number of characters in the manifest and deletes the file from the res directory.  Every little thing is good - we just saved 228 bytes. <br><br><h3>  Launcher Icon (5300 bytes, down 13%) </h3><br>  <a href="https://android.googlesource.com/platform/frameworks/native/%2B/jb-dev/libs/utils/README">The documentation for resources.arsc</a> in the Android Platform repository explains that each APK resource is mentioned in <code>resources.arsc</code> with an integer identifier.  These IDs have two namespaces: <br><br><blockquote>  <i>0x01: system resources (pre-installed in framework-res.apk)</i> <i><br><br></i>  <i>0x7f: application resources (in the application .apk file)</i> </blockquote><br>  So what will happen to our APK if we put a link to a resource in the namespace 0x01?  In theory, we will get a more beautiful icon and at the same time reduce the size of your file. <br><br><pre> <code class="hljs perl">android:icon=<span class="hljs-string"><span class="hljs-string">"@android:drawable/btn_star"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/59/df/25/59df250448b6f552077057.jpeg"><br><br>  Of course, you <b>should never trust system resources</b> like icons in a real working application.  This method will fail validation on Google Play, and some manufacturers also <a href="https://www.reddit.com/r/androiddev/comments/71fpru/android_color_resources_not_safe/">define white color in their own way</a> , so proceed carefully. <br><br><h3>  Manifest (5252 bytes, down 1%) </h3><br>  We have not touched the manifesto. <br><br><pre> <code class="hljs objectivec">android:allowBackup=<span class="hljs-string"><span class="hljs-string">"true"</span></span> android:supportsRtl=<span class="hljs-string"><span class="hljs-string">"true"</span></span></code> </pre> <br>  Deleting these attributes saves 48 bytes. <br><br><h3>  Proguard Hack (4984 bytes, down 5%) </h3><br>  It seems that the <code>BuildConfig</code> and <code>R</code> classes still remain in the Dex file. <br><br><pre> <code class="hljs swift">-keep <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fractalwrench</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span></span>{ *; }</code> </pre> <br>  Refining a Proguard rule will remove unnecessary classes. <br><br><h3>  Obfuscation (4936 bytes, reduction by 1%) </h3><br>  Obfuscate the name for the class Activity.  For normal classes, Proguard automatically does this, but since the class name Activity is called through Intents, it is not obfuscated by default. <br><br><blockquote>  <i>MainActivity -&gt; c.java</i> <i><br><br></i>  <i>com.fractalwrench.apkgolf -&gt; cc</i> </blockquote><br><h2>  META-INF (3307 bytes, down 33%) </h2><br>  At the moment we are signing the application simultaneously with the signatures of v1 and v2.  This seems like a waste of resources, because v2 provides <a href="https://source.android.com/security/apksigning/">excellent protection and performance</a> by hashing the entire APK. <br><br>  The signature of v2 is not visible from APK Analyzer, since it is included in the binary block in the APK file itself.  The signature v1 is visible, in the form of files <code>CERT.RSA</code> and <code>CERT.SF</code> <br><br>  Let's remove the check mark for the signature v1 in the Android Studio interface and generate the signed APK.  Let's try to do it and vice versa. <br><br><table width="180"><tbody><tr><th>  Signature </th><th>  The size </th></tr><tr><td>  v1 </td><td>  3511 </td></tr><tr><td>  v2 </td><td>  3307 </td></tr></tbody></table><br>  Looks like now we'll use v2. <br><br><h1>  Where are we going - there are no IDE needed </h1><br>  It's time to edit the apk manually.  Use the following commands: <br><br><pre> <code class="hljs cpp"># <span class="hljs-number"><span class="hljs-number">1.</span></span>   apk ./gradlew assembleRelease # <span class="hljs-number"><span class="hljs-number">2.</span></span>   unzip app-release-<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span>.apk -d app #    # <span class="hljs-number"><span class="hljs-number">3.</span></span>   zip -r app app.zip # <span class="hljs-number"><span class="hljs-number">4.</span></span>  zipalign zipalign -v -p <span class="hljs-number"><span class="hljs-number">4</span></span> app-release-<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span>.apk app-release-aligned.apk # <span class="hljs-number"><span class="hljs-number">5.</span></span>  apksigner   v2 apksigner sign --v1-signing-enabled <span class="hljs-literal"><span class="hljs-literal">false</span></span> --ks $HOME/fake.jks --out <span class="hljs-keyword"><span class="hljs-keyword">signed</span></span>-release.apk app-release-<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span>.apk # <span class="hljs-number"><span class="hljs-number">6.</span></span>   apksigner verify <span class="hljs-keyword"><span class="hljs-keyword">signed</span></span>-release.apk</code> </pre> <br>  A detailed overview of the process of signing the APK, see <a href="https://developer.android.com/studio/publish/app-signing.html">here</a> .  In general, Gradle generates an unsigned archive, zipalign does byte-byte alignment for uncompressed resources to optimize RAM consumption after downloading an APK, and at the end the cryptographic procedure for signing an APK is started. <br><br>  Unsigned and unallocated APK weighs 1902 bytes, that is, the procedure adds about 1 kilobyte. <br><br><h2>  File size mismatch (2608 bytes, compression by 21%) </h2><br>  Strange!  If you unzip an un-aligned APK and manually sign it, then the <code>META-INF/MANIFEST.MF</code> file disappears, which saves 543 bytes.  If someone knows why this is happening, then let me know! <br><br>  Now we have three files in the signed APK.  But we can still get rid of the <code>resources.arsc</code> file, because we do not install any resources! <br><br>  After that, only the manifest and the <code>classes.dex</code> file <code>classes.dex</code> , both of about the same size. <br><br><h2>  Khaki with compression (2599 bytes, a decrease of 0.5%) </h2><br>  Now we will change all the remaining lines to 'c', updating versions to 26, and then generate the signed APK. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">compileSdkVersion</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> buildToolsVersion <span class="hljs-string"><span class="hljs-string">"26.0.1"</span></span> defaultConfig { <span class="hljs-attribute"><span class="hljs-attribute">applicationId</span></span> <span class="hljs-string"><span class="hljs-string">"cc"</span></span> minSdkVersion <span class="hljs-number"><span class="hljs-number">26</span></span> targetSdkVersion <span class="hljs-number"><span class="hljs-number">26</span></span> versionCode <span class="hljs-number"><span class="hljs-number">26</span></span> versionName <span class="hljs-string"><span class="hljs-string">"26"</span></span> }</code> </pre> <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cc"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:icon</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@android:drawable/btn_star"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"c"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ccc"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  This reduces the size by another 9 bytes. <br><br>  Although the number of characters in the file has not changed, the fact is that the frequency of the 'c' symbol has increased.  As a result, the compression algorithm worked more efficiently. <br><br><h2>  Hi, ADB (2462 bytes, down 5%) </h2><br>  You can further optimize the manifest by removing the Launch intent filter for the Activity class.  From now on, we will launch the application with the following command: <br><br> <code>adb shell am start -a android.intent.action.MAIN -n cc/.c</code> <br> <br>  Here is the new manifesto: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cc"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"c"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  We also got rid of the launcher icon. <br><br><h2>  Clearing method references (2179 bytes, down 12%) </h2><br>  By initial conditions, we must prepare an APK, which is able to install on the device. <br><br>  Our application lists methods in the <code>TextView</code> , <code>Bundle</code> and <code>Activity</code> classes.  You can reduce the size of the Dex file by removing these links and replacing them with the new <code>Application</code> class.  Thus, the Dex file will now refer to a single method ‚Äî the constructor of the <code>Application</code> class. <br><br>  Source files now look like this: <br><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> cc; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.<span class="hljs-type"><span class="hljs-type">Application</span></span>; public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cc"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".c"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  We use adb to check that the APK was successfully installed, it can also be checked through the ‚ÄúSettings‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/df/31/59df31295093f844042232.jpeg"></div><br><br><h2>  Dex Optimization (1961 bytes, down 10%) </h2><br>  I spent several hours studying the format of the Dex file for the sake of this optimization, since different mechanisms like checksums and offsets make manual editing difficult. <br><br>  In short, it turned out that the only requirement for installing an APK is the existence of the <code>classes.dex</code> file.  Therefore, we simply delete the original file, run <code>touch classes.dex</code> in the console and save 10% of the size using an empty file. <br><br>  Sometimes the silliest solution is the best. <br><br><h2>  Understanding the manifest (1961 bytes, 0% reduction) </h2><br>  The unsigned APK manifest is a binary XML file that does not seem to be officially documented.  You can change the contents of the file using the <a href="https://github.com/ridiculousfish/HexFiend">HexFiend</a> editor. <br><br>  Some interesting elements are guessed in the file header - the first four bytes encode <code>38</code> , which coincides with the version number of the Dex file.  The next two bytes encode <code>660</code> , which is the same as the file size. <br><br>  Let's try to delete one byte by setting targetSdkVersion to <code>1</code> , and changing the file size in the header to <code>659</code> .  Unfortunately, the Android system rejects the new file as an incorrect APK.  It seems that everything is more complicated here ... <br><br><h2>  Misunderstanding of the manifesto (1777 bytes, reduction by 9%) </h2><br>  And we will try to scribble random characters all over the file, and then install the APK without changing the specified file size.  This way we will check if the checksum is checked and how our changes will affect the offset in the file header. <br><br>  Surprisingly, such a manifesto is perceived as a valid APK on Nexus 5X under Oreo: <br><br><img src="https://habrastorage.org/webt/59/df/33/59df3364d962f868623608.jpeg"><br><br>  I think I‚Äôve just heard how the Android framework developer responsible for supporting <code>BinaryXMLParser.java</code> screamed very loudly into the pillow. <br><br>  For maximum benefit, you need to replace all these stupid characters with zero bytes.  This will help recognize the important parts of the file in HexFiend, as well as reduce several bytes thanks to the compression hack mentioned above. <br><br><h3>  UTF-8 Manifesto </h3><br>  Here are the important components of Manifest, without which the APK will not be installed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/df/36/59df3683b4160222009907.png"></div><br><br>  Some things are obvious, such as manifest and package tags.  In the string pool, the versionCode and the package name are visible. <br><br><h3>  Hex manifest </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/df/36/59df3683ea330800960684.png"></div><br><br>  Viewing the file in hexadecimal format shows the values ‚Äã‚Äãin the file header, which describe a pool of strings and other values, such as file size <code>0x9402</code> .  Strings are also interestingly encoded - if they are larger than 8 bytes, then the total length is indicated in the two previous bytes. <br><br>  But you can hardly find other options for optimization here. <br><br><h2>  Is it done?  (1757 bytes, reduction of 1%) </h2><br>  Examine the final APK. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/df/36/59df3683e9441068614367.png"></div><br><br>  Throughout this name in the APK, my name was indicated in the signature of v2.  Create a new keystore, which uses a hack for compression. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/df/36/59df3683b8f4d589498518.png"></div><br><br>  We saved 20 bytes. <br><br><h2>  Step 5: Recognition </h2><br>  <code>1757</code> bytes - this is very little, damn it.  And as far as I know, this is the smallest existing APK. <br><br>  However, I reasonably believe that someone from the Android community is able to perform further optimizations and further improve the result.  If you manage to reduce the file from the current <code>1757</code> bytes, <a href="https://github.com/fractalwrench/ApkGolf">send a pull-request to the repository</a> , where the smallest APK is hosted, or <a href="https://twitter.com/fractalwrench">tell on twitter</a> .  <font color="gray">(Since the publication of the article, the file has already been reduced to 820 bytes - approx. Lane.)</font> </div><p>Source: <a href="https://habr.com/ru/post/339938/">https://habr.com/ru/post/339938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339926/index.html">A practical guide to analyzing application performance</a></li>
<li><a href="../339928/index.html">How to maintain a Telegram channel with 20,000 subscribers? Interview with the creator of All-in-One Person</a></li>
<li><a href="../339930/index.html">Development for Sailfish OS: displaying graphs using D3.js and QML Canvas</a></li>
<li><a href="../339932/index.html">Development for Sailfish OS: working with maps and geolocation</a></li>
<li><a href="../339936/index.html">We are looking for treasures in the source code Aladdin</a></li>
<li><a href="../339940/index.html">A minute of Black Magic</a></li>
<li><a href="../339942/index.html">SuperJob Meetup. System business analysis. Live broadcast</a></li>
<li><a href="../339950/index.html">Dow Jones Financial Information Agency mistakenly reported merging Apple and Google</a></li>
<li><a href="../339952/index.html">Dynamic analysis of iOS applications without Jailbreak</a></li>
<li><a href="../339954/index.html">How to teach your neural network to analyze morphology</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>