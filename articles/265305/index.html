<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Wake on Lan Telegram bot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After the opening of the API bots for Telegram, their population began to grow rapidly. I decided to keep up and get my own to be able to remotely tur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Wake on Lan Telegram bot</h1><div class="post__text post__text-html js-mediator-article">  After the opening of the <a href="https://core.telegram.org/bots/api">API bots</a> for Telegram, their population began to grow rapidly.  I decided to keep up and get my own to be able to remotely turn on the computer.  C # was chosen for development, and Azure was chosen as the hosting. <br><br><h4>  <b>Task</b> </h4>  Write a bot that can send "magic packets" to turn on the computer to the specified address and port. <br><br>  Note: the article does not consider getting a token for a bot and deploying a site on Azure.  These questions are easily <a href="http://habrahabr.ru/post/262247/">answered on Habr√©</a> or Google. <br><a name="habracut"></a><br><h4>  <b>A bit of theory and network settings</b> </h4><br>  To turn on the computer will use the technology <a href="https://ru.wikipedia.org/wiki/Wake-on-LAN">Wake on Lan</a> .  Since the bot will be in the cloud, we need to send the packet to an external address.  In this regard, you need to make sure that the package eventually got into the local network and reached the desired network card.  To do this, forward the port on the router: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/337/d02/ab3/337d02ab31924985a8cbcc7085fb3e9c.png"><br><br><div class="spoiler">  <b class="spoiler_title">Why port 7 and such an address?</b> <div class="spoiler_text">  Usually, to turn on a computer on a local network using Wake on Lan, you need to send a ‚Äúmagic packet‚Äù to the broadcast address of the local network, to port 7 / UDP (in some cases other ports can be used).  When the network card receives ‚Äúits‚Äù packet, it sends a signal to turn on the computer. <br><br>  A packet consists of a set of bytes in the following order: the first 6 bytes are zero, then there is a sequence of bytes from the MAC address of the network card, which is repeated 16 times.  Actually, it is for the MAC address of the network card and understands that it is necessary to turn on her computer. <br><br>  We will form such a packet and send it to our external address (for example, to the address of the home router), after which the packet will have to be routed to the broadcast address of the local network. <br><br>  In my case, port 7 is forwarded (accessible from the Internet) to the broadcast network address (10.10.10.255). <br></div></div><br><br><h4>  <b>Write the code</b> </h4><br>  To work with the bot API, the <a href="">Telegram.Bot</a> library was chosen.  For updates, we will use the <a href="https://core.telegram.org/bots/api">option with a webhuk</a> .  In this case, each message or event that the bot will receive will be sent to the specified URL. <br><br>  As a hosting, it was decided to use Azure, as it is suitable in all respects: <br><ul><li>  always available </li><li>  There is a certificate on the free tariff that allows you to access the site via HTTPS (bots can only send updates via encrypted connections) </li><li>  quick and easy site publishing right from Visual Studio </li></ul><br>  To begin with, we create a class that will return us an object for working with the bot: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Bot</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Api _bot; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  ,     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   -  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public static Api Get() { if (_bot != null) return _bot; _bot = new Api(Config.BotApiKey); _bot.SetWebhook(Config.WebHookUrl); return _bot; } }</span></span></code> </pre> <br>  Settings get out of the class Config <br><div class="spoiler">  <b class="spoiler_title">Config.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Config</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">        </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private static readonly NameValueCollection Appsettings = ConfigurationManager.AppSettings; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public static string BotApiKey { get { return Appsettings["BotApiKey"]; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> URL,         </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public static string WebHookUrl { get { return Appsettings["WebHookUrl"]; } } }</span></span></code> </pre><br></div></div><br>  Now we need to form and send a packet.  The WakeOnLan class will be responsible for this. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   ""      </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public static class WakeOnLan { public static void Up(string ip, string mac, int? port = null) { var client = new UdpClient(); var data = new byte[102]; for (var i = 0; i </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;= 5; i++) //    -  data[i] = 0xff; var macDigits = GetMacDigits(mac); if (macDigits.Length != 6) throw new ArgumentException("Incorrect MAC address supplied!"); const int start = 6; for (var i = 0; i &lt; 16; i++) //       for (var x = 0; x &lt; 6; x++) data[start + i * 6 + x] = (byte)Convert.ToInt32(macDigits[x], 16); client.Send(data, data.Length, ip, port ?? 7); //   } private static string[] GetMacDigits(string mac) //  MAC { return mac.Split(mac.Contains("-") ? '-' : ':'); } public static bool ValidateMac(string mac) //     MAC  { return GetMacDigits(mac).Length == 6; } }</span></span></span></span></code> </pre><br><br>  We form packets and are able to send.  It remains to teach the bot to respond to the command, for example, / wol. <br>  For simplicity, a command with parameters is implemented, i.e.  the user will have to enter something like <br> <code>/wol 1.2.3.4 01:02:03:04:05:06 7 <br></code> <br>  in order to send the packet to the address 1.2.3.4, to port 7 and wake up the computer with the MAC address 01: 02: 03: 04: 05: 06 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Handle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> text = message.Text.Split(<span class="hljs-string"><span class="hljs-string">' '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (text.First() != <span class="hljs-string"><span class="hljs-string">"/wol"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (text.Count()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _bot.SendTextMessage(message.Chat.Id, <span class="hljs-string"><span class="hljs-string">" : /wol 1.2.3.4 01:02:03:04:05:06 7"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!WakeOnLan.ValidateMac(text[<span class="hljs-number"><span class="hljs-number">2</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _bot.SendTextMessage(message.Chat.Id, <span class="hljs-string"><span class="hljs-string">" MAC "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { WakeOnLan.Up(text[<span class="hljs-number"><span class="hljs-number">1</span></span>], text[<span class="hljs-number"><span class="hljs-number">2</span></span>], GetPort(text)); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _bot.SendTextMessage(message.Chat.Id, <span class="hljs-string"><span class="hljs-string">" !"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _bot.SendTextMessage(message.Chat.Id, <span class="hljs-string"><span class="hljs-string">"  :("</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private static int? GetPort(IReadOnlyList</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string&gt;</span></span></span><span class="hljs-comment"> text) { int port; if (text.Count == 4 &amp;&amp; int.TryParse(text[3], out port)) return port; return null; }</span></span></code> </pre><br>  Great, it remains only to create a controller that will receive updates from the bot: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { [Route(<span class="hljs-string"><span class="hljs-string">@"api/message/wol"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> OkResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromBody]Update </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { Task.Run(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler().Handle(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.Message)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(); } }</code> </pre><br>  After ‚Äúfilling‚Äù the application in Azure, we check the <a href="https://telegram.me/wol_bot">bot</a> : <br><img src="https://habrastorage.org/files/6e4/4e1/bcc/6e44e1bcc47a4ccd81739500d82e8808.PNG"><br><br>  <b>References:</b> <br>  <a href="https://telegram.me/wol_bot">WoL bot in Telegram</a> <br>  <a href="https://github.com/spoofi/WolBot">GitHub project</a> <br>  <a href="https://core.telegram.org/bots/api">API bots Telegram</a> <br>  <a href="">Library Telegram.Bot (GitHub)</a> </div><p>Source: <a href="https://habr.com/ru/post/265305/">https://habr.com/ru/post/265305/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265291/index.html">PHP Digest number 68 - interesting news, materials and tools (July 27 - August 24, 2015)</a></li>
<li><a href="../265293/index.html">Frontend Union Conf conference this Saturday</a></li>
<li><a href="../265295/index.html">PostgreSQL support in Meteor</a></li>
<li><a href="../265301/index.html">Single-layer perceptron for beginners</a></li>
<li><a href="../265303/index.html">Work with a SQLite database using SQLitePCL wrapper</a></li>
<li><a href="../265307/index.html">Writing a Labyrinth on XNA 4.0 C #</a></li>
<li><a href="../265309/index.html">Python cryptography: encrypting information and creating digital signatures with the PyCrypto package</a></li>
<li><a href="../265311/index.html">Safe as in a safe</a></li>
<li><a href="../265313/index.html">How to configure the iOS device and RAD Studio XE8 (Delphi, C ++ Builder)</a></li>
<li><a href="../265315/index.html">Who is a designer?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>