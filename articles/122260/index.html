<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experienced trivia-6, or ‚ÄúAccounting and control of the printer Ivan Fedorov‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The continuation of "experienced trifles." Previous parts: one , two , three , four , five . 

 In this post I will talk about a small, but in my own ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experienced trivia-6, or ‚ÄúAccounting and control of the printer Ivan Fedorov‚Äù</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/b34cb080/4075188f/e0635ef7/f1052854.jpg" alt="image" align="left">  The continuation of "experienced trifles."  Previous parts: <a href="http://habrahabr.ru/blogs/sysadm/121801/">one</a> , <a href="http://habrahabr.ru/blogs/sysadm/121917/">two</a> , <a href="http://habrahabr.ru/blogs/sysadm/121946/">three</a> , <a href="http://habrahabr.ru/blogs/sysadm/122184/">four</a> , <a href="http://habrahabr.ru/blogs/sysadm/122200/">five</a> . <br><br>  In this post I will talk about a small, but in my own interesting experience using the SNMP protocol to collect print statistics in an organization. <br><br>  In the company in question, they print quite a lot.  There are large, powerful printers (such as the HP 9000) and medium-sized ones, and very much Home class.  Fortunately, they are all networked, and the range of manufacturers is narrow, only two: HP and Ricoh (in different guises, from NRG to MB).  And then one fine spring day, looking at the accounts for the office, the careful management was given the task: to regularly collect print statistics, <i>‚Äúso that they could be analyzed later‚Äù</i> .  And they didn‚Äôt bother much: <i>‚ÄúAll printers are networked, they have a statistics page, in the morning they got around by a list, recorded digits in Excel, that's all - business</i> ! <i>‚Äù</i> <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Naturally, in our opinion, it was uninteresting, stupid and "tiring", because  There are a lot of printers in the organization.  And we began to think "how to make it work itself."  In general, it seems to me that this desire (‚Äúso that it works itself‚Äù) is key and necessary for each system administrator, and those who succeed over and over again always make me feel good, white envy. <br><br>  With the move rejecting the web page parsers (this is wrong, and, for example, Ricoh pages were dynamic, there was no hard URL where to go), we turned to the good old SNMP.  And that's what came out of it. <br><br>  Here you should probably make a small digression for those for whom the abbreviation SNMP does not mean anything yet.  Gentlemen, you are missing a lot!  I urgently recommend that you spend the evening different and study the question at least at a basic level.  In short, SNMP is a management and monitoring protocol based on UDP.  The overwhelming majority of devices (if not all) that have a network interface support this protocol and allow using it not only to collect data on the operation of the device, but also to control the device itself.  Data (objects) that are available via the SNMP protocol, the so-called  OIDs are organized hierarchically.  On the domestic plan, this means that if you ask the device for the OID value with a ‚Äúnumber‚Äù .1.3.6.1.4.1.11, the device will respond and transmit this value.  And knowing which OID corresponds to the value we need, you can write a small script that will poll the devices and collect their answers into the database.  You can interrogate devices, for example, with the help of these wonderful and free <a href="http://www.snmpsoft.com/freetools/index.html">utilities</a> .  Looking ahead, I‚Äôll say that <b>Snmpget</b> and <b>SnmpWalk were</b> useful in our particular case. <br><br>  The algorithm as a whole was clear, the utilities were at hand, the only thing left was to understand which OIDs mean what we need: a counter of printed pages.  Full description of device variables, so-called.  MIB-base is quite difficult to find (you can try to search <a href="http://www.mibsearch.com/">here</a> ), but you can go the other way. <br><br>  With the help of the <b>SnmpWalk</b> utility, once having interrogated the device, you get ALL the OID from it with their values, which it is able to issue.  For our part, we clearly know what exactly the VALUES we need (after all, we can find out their current status on the web page).  Next is the case for small: <br><ul><li>  We <b>assemble</b> a complete device map into a text file using <b>SnmpWalk</b> . </li><li>  We learn via the web interface the current number of printed pages that we need </li><li>  We are looking for the number of printed pages in the file, and thus find out the OID code. </li><li>  Use the received OID in our script. </li></ul><br><img src="http://s1.ipicture.ru/uploads/20110621/CliM1BtQ.jpg" alt="image" align="left"><h5>  A few notes </h5><br><ul><li>  Each manufacturer in the same type of device almost always adheres to a single MIB structure.  Accordingly, the OID number corresponding to, for example, the Total Pages Number counter will be the same for all HP printers (with rare exceptions).  This allows you to write a "survey template", which will correspond to many printers from the same manufacturer. </li><li>  Sometimes in the process of analyzing a snmpwalk file there are several desired values.  Here you can either print another page and, once again collecting data, determine which OID contains the counter we need, or simply choose a little thought logically (remember the hierarchy of the structure!). </li><li>  Some printers do not show certain counters on a web page, however, they allow them to be collected via SNMP.  For example, on a web page there is only Total page count, but with the help of SNMP you can get more detailed values ‚Äã‚Äã(duplex, A3, number of ‚Äúprint requests‚Äù, etc.) </li><li>  It is better to collect data right away somewhere in the database "for further analysis."  In our case, at the insistence of business executives, I wrote everything into a text file, which was then automatically opened in Excel, and decomposed into cells using a macro.  Business executives were easier to work with Excel than with SQL, but I personally didn‚Äôt mind. </li><li>  With the help of this simple method for several months we have built quite good print statistics in the company, it is reasonable, with the numbers on hand we got the budget for more powerful printers in a number of departments, and found out the relationship with the company of the cartridge refiner, when it turned out that a number of their products 15,000 pages gives out at a single charge of 6000. </li></ul><br><br>  As a bonus, I will cite the text of the <a href="http://pastebin.com/WtPGhHu7">script</a> , the <a href="http://pastebin.com/3VXsiHJB">Excel macro,</a> and give a few explanations: <br><br><ul><li>  At the beginning of the script code, the settings are described (a pool of IP addresses of the equipment, and polling templates). </li><li>  despite the fact that manufacturers usually have a single MIB structure, in some cases, equipment of a different class still has different OIDs for the same data (for example, for HP printers below 2XXX OID series for obtaining a serial number - one and above - another . </li><li>  for more powerful printers, we collect not only TotalPagesCount, but also all sorts of other counters (copier, A3, duplex, etc.) </li><li>  HP has such a concept TotalpagesCountEquivalent - this is the number of exactly the printed pages, i.e.  completely passed along the printing path.  While just TotalPagesCount for HP is the number of sheets taken from the paper feeder.  The difference between them is actually equal to the jams. </li><li>  the script collects the serial numbers of the printers so that they can then bind to them in Excel, as well as the IP, the date and the network name - this is just so for clarity. </li><li>  at the end, the script starts the Excel file next to it, which, in turn, when opened, launches a macro, which already scatters everything.  Quite a messy system, but this is the result of the division of labor, because  I wanted naked data from me, but we will write ‚Äúanalytics ourselves‚Äù.  So they wrote.  In it, I will not be able to explain something in detail, but I will try. </li><li>  The macro works like this: opens a file with statistics, takes all the data from it, copies statistics numbers to the required columns of the table, attaches to the serial number of the equipment, renames today's statistics file to * .bak, closes Excel. </li><li>  The macro had to be signed with an internal certificate, since  I didn‚Äôt want to disable macro security in Excel, and without this, the macro will not automatically start.  And, by the way, it was a natural quest, because  how and what to sign the macro, neither I nor its authors at that time had a clue :) </li></ul><br><br>  To <a href="http://habrahabr.ru/blogs/sysadm/122668/">be</a> continued </div><p>Source: <a href="https://habr.com/ru/post/122260/">https://habr.com/ru/post/122260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122252/index.html">How is your testing process?</a></li>
<li><a href="../122255/index.html">Lecture "The Demoscene Today: Computer Art in Real Time"</a></li>
<li><a href="../122257/index.html">Domain Google.ua did not belong to Google</a></li>
<li><a href="../122258/index.html">Blackberry Playbook - almost officially</a></li>
<li><a href="../122259/index.html">Haskell Quest Tutorial - Glade</a></li>
<li><a href="../122261/index.html">Haiku OS has just been released - R1 / Alpha 3</a></li>
<li><a href="../122262/index.html">The Pentagon wants to get a simulator "cyberwar" to conduct exercises</a></li>
<li><a href="../122263/index.html">Records Startup Weekend</a></li>
<li><a href="../122265/index.html">Overview of the new Nokia N9 smartphone</a></li>
<li><a href="../122266/index.html">Rumors: the new Mac Pro and Mac Mini are already in August</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>