<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multi-exclusion or Want to share one interesting architectural trick</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have never liked working with bugs in PHP frameworks. And even the use of this word did not like. To clarify right away, I'm not talking about fatal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multi-exclusion or Want to share one interesting architectural trick</h1><div class="post__text post__text-html js-mediator-article">  I have never liked working with bugs in PHP frameworks.  And even the use of this word did not like.  To clarify right away, I'm not talking about fatal errors, not about error_reporting, I'm talking about what they call validation errors.  That in models, in forms - it depends on the framework. <br><br>  Just look.  For example, Yii and Yii2, getting model validation errors: <br><pre><code class="php hljs">$errors = $model-&gt;getErrors();</code> </pre> <br>  Symfony form errors: <br><pre> <code class="php hljs">$errors = $form-&gt;getErrors();</code> </pre><br>  Actively advertised Pixie (there was nothing about him for quite a while): <br><pre> <code class="php hljs">$result = $validator-&gt;validate($data); $errors = $result-&gt;errors();</code> </pre><br><br>  What is wrong here? <br>  Yes all.  All wrong.  All this code smells really bad, it smells like PHP4 at times, spaghetti architecture and wild mix of concepts. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What to do? <br><br><a name="habracut"></a><br>  Start to figure it out.  From the very beginning. <br><br><h3>  We define important concepts. </h3><br><br>  1. <b>Validity</b> is the answer to the question "is the value valid, in other words <b>valid</b> , in this context."  The context can be different, it is a field in the form, and a property of the object.  Interestingly, the answer ‚Äúyes‚Äù to the question of validity does not imply any additional information, but the answer ‚Äúno‚Äù needs clarification.  For example: the password is invalid BECAUSE its length is less than 6 characters. <br><br>  2. <b>Validation</b> - <b>validation</b> process.  We have with you some meaning and there is a context.  <b>The validator</b> (the process performing the validation) must unambiguously answer whether the value is valid in this context, and if not, then why. <br><br>  3. ‚ÄúWhy‚Äù from the previous paragraph is called the ‚Äú <b>validation error</b> ‚Äù.  <b>Validation errors</b> - detailed information about what exactly caused the false response to the question about the validity of the data, that is, the reason for the failure to validate.  In fact, these are not errors in the sense of ‚Äúboss, everything is lost!‚Äù, But simply some kind of validator report, but the word ‚Äúerror‚Äù has already taken root among the developers. <br><br>  4. <b>Validation rules</b> are functions that take a context and a value as input and return a validity response.  The answer must include both true / false and a validation report, that is, a set of errors, if any. <br><br>  <i>With validation, quite often (especially in some frameworks that still support PHP 5.2, we won‚Äôt point a finger at them) to confuse sanitize (or ‚Äúcleaning‚Äù in Russian) values.</i>  <i>Do not confuse the concept of "validation" and "cleaning" (or leading to the canonical form), these are two completely different processes.</i> <i><br></i>  <i>A good example that I like: entering a Russian phone number.</i>  <i>For validation, it is sufficient (in general) to have 11 digits in the entered string, the first of which is 7, with an arbitrary number and positions of other characters.</i>  <i>If not, validation fails.</i>  <i>The task of the sanitizer is to remove everything from this value except digits, so that we can save the standardized msisdn in the database.</i> <i><br></i>  <i>Read to finally understand the difference: <a href="http://php.net/manual/ru/filter.filters.php">php.net/manual/ru/filter.filters.php</a></i> <br><br><h3>  Well, but what's wrong? </h3><br>  <b>That the collection of validation errors is no exception.</b> <br><br>  All these are wonderful <pre> <code class="php hljs">-&gt;getErrors()</code> </pre>  no exceptions.  Therefore, we lack many advantages: <br><br><ol><li>  Exceptions are typed.  In frameworks similar to the above, I cannot create a FormException -&gt; FormFieldException -&gt; FormPasswordFieldException -&gt; FormPasswordFieldNotSameException hierarchy.  This is very important, especially with the release of PHP 7, which makes tip-hintings finally the norm and standard </li><li>  Exceptions encapsulate a lot of necessary.  This is the PLO!  For example: on which page (URL) did a validation error occur?  Who is the user?  What is the specific form field?  What validation rule worked?  Finally, "but give me the translation of this message into Estonian."  Can this all make a simple array of error messages?  Of course not.  (By the way, it suffices to implement the __toString () method and the exception in the template will continue to behave like a simple error message) </li><li>  Exceptions control the flow.  I can quit it.  It pops up.  I can catch him, but I can catch him and throw further.  The $ errors array is deprived of the right to control the flow of code, so it is very inconvenient.  How can I use $ errors to escalate validation error handling from the model above, for example, to the controller or application component? </li></ol><br><br><h3>  And what to do? </h3><br>  Let's try to set a task.  What would you like to see in the code?  Well, let's say something like this: <br><br>  Somewhere in the active code: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User; $user-&gt;fill($_POST); $user-&gt;save(); redirect(<span class="hljs-string"><span class="hljs-string">'hello.php'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ValidationErrors $e) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view-&gt;assign(<span class="hljs-string"><span class="hljs-string">'errors'</span></span>, $e); }</code> </pre><br><br>  Somewhere in the template: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($errors <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $error): <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alert</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">alert</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">danger</span></span></span><span class="hljs-class">"&gt;&lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">echo</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getMessage</span></span></span><span class="hljs-class">(); ?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endforeach</span></span></span><span class="hljs-class">; ?&gt;</span></span></code> </pre><br><br>  The essence of the proposed architectural template can be expressed very briefly: <b>Multi-exclusion.</b>  <b>An exception that is a collection of other exceptions.</b> <br><br>  How to achieve this?  Fortunately, modern PHP allows us to not such tricks. <br><br><h4>  We turn an exception into a collection </h4><br><br><div class="spoiler">  <b class="spoiler_title">All the fun is here!</b> <div class="spoiler_text">  An interface that inherits all the useful interfaces for turning an object into an array: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IArrayAccess</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayAccess</span></span></span><span class="hljs-class">, \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Countable</span></span></span><span class="hljs-class">, \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IteratorAggregate</span></span></span><span class="hljs-class">, \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre><br><br>  Trait that implements this interface: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">trait</span></span> TArrayAccess { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $storage = []; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">innerIsset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($offset)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> array_key_exists($offset, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">innerGet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($offset)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage[$offset]) ? <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage[$offset] : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">innerSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($offset, $value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span> == $offset) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage)) { $offset = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $offset = max(array_keys(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage))+<span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage[$offset] = $value; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">innerUnset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($offset)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage[$offset]); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offsetExists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($offset)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;innerIsset($offset); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offsetGet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($offset)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;innerGet($offset); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offsetSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($offset, $value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;innerSet($offset, $value); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offsetUnset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($offset)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;innerUnset($offset); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> count(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isEmpty</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;storage); } } <span class="hljs-comment"><span class="hljs-comment">//   .       IArrayAccess //             -     innerIsset(),   true,    ,   null. ,    .</span></span></code> </pre><br><br>  I personally add one more useful interface and its implementation by treyt, but it, of course, is completely optional: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ICollection</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepend</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">append</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">slice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($offset, $length=null)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">existsElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $attributes)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAllByAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $attributes)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $attributes)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ksort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uasort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(callable $callback)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uksort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(callable $callback)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">natsort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">natcasesort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(callable $callback)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(callable $callback)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(callable $callback)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reduce</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($start, callable $callback)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">collect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($what)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">group</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($by)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($method, array $params = [])</span></span></span></span>; }</code> </pre><br><br>  and finally, we put everything together: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MultiException</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Exception</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IArrayAccess</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">TArrayAccess</span></span>; }</code> </pre><br></div></div><br><br><h3>  Simple application example </h3><br><br><h4>  The method of filling the model with data. </h4><br>  The model creates validation rules.  They throw exceptions every time a value fails validation when assigned to a model field.  For example: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validatePassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strlen($value) &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'  '</span></span>); } ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre><br><br>  Create a magic setter that will automatically call the validator for the field.  And at the same time convert the thrown exception to another type, which contains not only the validation error message, but also the field name: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($key, $val)</span></span></span><span class="hljs-function"> </span></span>{ $validator = <span class="hljs-string"><span class="hljs-string">'validate'</span></span> . ucfirst($key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method_exists(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, $validator)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$validator($value)) { <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__set($key, $val); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModelColumnException($key, $e-&gt;getMessage()); } } }</code> </pre><br><br>  Create a method fill ($ data), which will try to fill the model with data and accurately collect all validation errors for individual fields into one: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fill</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data)</span></span></span><span class="hljs-function"> </span></span>{ $errors = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Multiexception; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($data <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $val) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$key = $val; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ModelColumnException $e) { $errors[] = $e; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$errors-&gt;isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> $errors; } }</code> </pre><br><br>  Actually, everything.  You can apply.  A bunch of pluses: <br><ul><li>  This exception means you can catch it in the right place. </li><li>  This is an array of exceptions, so that we can at any time add a new exception to it or delete an already processed one. </li><li>  This is an exception, so after some processing phase it can be thrown further. </li><li>  This is an object, so we can easily pass it anywhere </li><li>  This is a class, so we build our own class hierarchy. </li><li>  And finally, this is still an exception, which means that all its standard properties and methods are available to us.  Yes, yes, and even getTrace ()! </li></ul><br><br><h3>  Instead of conclusion </h3><br>  This is all, with a few nuances, quite a combat code, which I have been using for a long time, and even teach my students to use.  I am surprised that I have never seen such a simple concept before.  If, all of a sudden, I‚Äôm the first, I‚Äôm transferring the idea and code in this article to the public domain.  If not the first - forgive the author of his error (s) <br><br>  <b>UPD based on comments</b> <br>  I thank all the commentators for valuable thoughts and opinions. <br><br>  The essence of the article is not validation.  At all.  Validation is just an unfortunate holivorn example, I just could not think of a better one. <br><br>  The point is very simple.  In PHP, there may be an object that is both an exception and a collection of other exceptions at the same time.  And it is convenient. </div><p>Source: <a href="https://habr.com/ru/post/279501/">https://habr.com/ru/post/279501/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279491/index.html">We build reliable data processing - lambda architecture inside Google BigQuery</a></li>
<li><a href="../279493/index.html">The main tool of every UX expert</a></li>
<li><a href="../279495/index.html">Prototypes as a product presentiment</a></li>
<li><a href="../279497/index.html">Pwn2Own 2016: first results</a></li>
<li><a href="../279499/index.html">My bike or how I saved my nerve cells</a></li>
<li><a href="../279503/index.html">Critical vulnerabilities of the BIND DNS server allow you to remotely disable it and conduct DoS attacks</a></li>
<li><a href="../279505/index.html">Setting up a repository server based on SCM-Manager under Debian</a></li>
<li><a href="../279507/index.html">Entertaining analysis of one expression with square brackets</a></li>
<li><a href="../279509/index.html">Programmatic process lookup by name in QNX 6.5.0</a></li>
<li><a href="../279511/index.html">How to write an email to IT professionals: 5 tips</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>