<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Embedded Sphinx, or search on a router</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The search server Sphinx (sphinxsearch) is positioned as a system, very well scalable for high loads and large volumes of indices. In general, this is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Embedded Sphinx, or search on a router</h1><div class="post__text post__text-html js-mediator-article">  The search server Sphinx (sphinxsearch) is positioned as a system, very well scalable for high loads and large volumes of indices.  In general, this is not bad - but sometimes there is no machine with a 16-core processor and 256GB of RAM on hand.  And what if the core is only one?  And if with not so much memory?  And if this is not a server or even an average PC, but generally a SoC router, with far from being the fastest ‚Äústone‚Äù, and where is only 32MB of RAM, and that one should be shared with other processes and system?  Will the search engine soar?  Will it work?  Is it justified? <br>  Yes, take off.  Yes, it will work.  Yes, it is quite justified. <br><a name="habracut"></a><br><br><div class="spoiler">  <b class="spoiler_title">Prehistory</b> <div class="spoiler_text">  I work in one small educational library.  No, this is not a .dll or .so file, but the most common - a room with shelves and a lot of books, about 30 thousand.  The library is not even twenty years old;  once it began with a pair of shelves, and there were only a few dozen books, and they were all known to do everything.  Then the library began to develop, there were more and more books;  in the old room there was no room for them and the move took place.  At that time, when I started working there, there were about 15 thousand books in the collection (or, more officially, ‚Äústorage units‚Äù), and the total length of all the shelves on all shelves was about a kilometer. <br>  Although ... no, it was not a library.  It was a huge dump! <br>  Books on incomprehensible signs were placed on different racks;  no ‚Äúofficial‚Äù library management systems were used; everything was done ‚Äúon the knee‚Äù.  I inherited this landfill, as well as the ‚Äúdatabase‚Äù ‚Äîthe MS Access file in which the only table proudly flaunted with everything ‚Äî everything (with the same success it could exist as an excel table or even a list in the word ‚Äî no ‚Äú there were no baseline features like normalizations or relationships between tables in it).  Taking the book, the reader had to write his name and the name of the book on a lined letterhead. <br>  Search for books in the "database" was carried out by opening the table and pressing Ctrl + F. <br>  The search for a real book in the "dump" ... oh, this was the main work, which sometimes takes up the whole working day.  By brute force, cho ... After a few months of work, I already had an idea about where to look for this or that book, but this only slightly accelerated the process.  I finally got tired of this meaningless exercise, and I took up the task of ‚Äúeverything‚Äù. <br>  After about a year (most of the time was spent directly on the inventory of books), I had a decent base, where all the ‚Äústorage units‚Äù were numbered, equipped with bar codes and tied to specific shelves.  The issuance of books has been reduced to searching a book in the database to find out on which shelf it is, and then entering the book number (with a scanner, from a barcode) into a virtual card reader.  Delivery - again, scanning the barcode, after which the book is automatically removed from the card reader, and the database kindly offers to carry it to a specific shelf.  The lesson, which used to take full time, now began to take a few minutes.  Hooray! <br>  What next?  Normalize database?  Yes done. <br>  ABOUT!  Well, let's drag it from MS Access somewhere to the ‚Äúlooser‚Äù software?  Ok, done dragging into mysql.  And the original database did not suffer - it just put the ODBC driver and replaced the internal tables with links to the now external ones. <br>  Now nothing stops you from letting readers search for books themselves!  (before that, too, no one interfered - but this was done by creating a copy of the .mdb database, deleting sensitive data such as a list to whom and what was issued, and then distributing it as an archive. I entered hundreds of new books - and be kind, do the whole routine again ...).  A modest php application with the simplest search form was attributed to the database - and now, now you don‚Äôt even need to search for books :).  Readers find them themselves, take them from the shelves and carry me only to scan the code and get it in their hands.  Robots injected, happy man! <br>  What are the costs?  Well, what, base, form, search - full LAMPS-stack (= LAMP + S [phinx]), everything revolves on your home desktop with an external IP address. <br>  UNABLE! <br>  Well, let it be.  In the end, this is not a bank site for servicing half of the country‚Äôs real-time transactions. <br>  But damn, the included 24/7 computer also eats electricity.  And it makes a noise ... And if you think about it, then apart from the library website there are no other reasons to keep it on and not ... <br></div></div><br><br><h4>  What if you use a router? </h4><br>  The time has come when I was quite-quite bored with the periodic hang-ups of an old router (DI-624) and I changed it to WRT-160NL.  I felt the Internet, looked for descriptions of the features of the upgrade ... And the very next day I replaced the stock firmware with dd-wrt.  I hooked up the external hdd, poshamanil - and got a modest NAS-file dump.  I rummaged around on the Internet, read about optware, tried it - and on the same external hdd I started additional software for the router itself.  Transmission - please;  lighttpd - easily!  php?  No problem!  Hmm ... does the library website take off?  Yes, it took off.  And if its base mysql directly into the router shove?  Wow, it turned out!  True, the assembly mysql strongly chewed;  from the tables only MyISAM - but still, it works! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  And the search? </h5><br>  This is what comes out - the router itself now pumps the torrents;  file dumping and even the site it serves the same ... The only thing missing is sphinx search.  It still spins on the desktop.  And what if his on the router? .. <br>  Yes.  As it turned out - going, running, working.  Works well! <br>  I later changed the router to Asus RT-N16, and now to NetGear WNDR-4300.  I replaced the firmware from dd-wrt with openwrt.  But sphinx still lives on it. <br><br><h4>  How to build your software under the router? </h4><br>  Of course, as long as there is a console and the ability to build scripts, you can create a program in many different ways.  Some of them are very die-hard.  Approximately how to install a program from sources on a deb or rpm-based distribution using ./configure &amp;&amp; make &amp;&amp; make install: it is possible that it will build and even fly - but the scalability and adaptability to support is almost zero.  Therefore, more civilized methods are used.  I dealt with two systems of assembly / publication under the router.  I will describe them. <br><br><h5>  Optware </h5><br>  It started my acquaintance with an alternative software for third-party firmware. <br>  In short, <i>optware</i> is software, entirely concentrated in the / opt.  Hence the name.  For example, a daemon installed in optware will be located somewhere in / opt / usr / sbin, the fumbled libraries will be thrown into / opt / usr / lib, configs will be expected in / opt / etc, and launch scripts will be thrown in / opt / etc /init.d.  If the target system is only 4MB of flash memory, and all are clogged with firmware - it does not matter!  You just need to mount / opt from another place in some way - and we are in chocolate!  We can install optware and work!  This other place can be, for example, an external flash drive (inserted into an existing usb port).  Or even an SD card soldered ‚Äúon the knee‚Äù to any contacts inside the router, the state of which we are able to programmatically control (for example, the power, activity, output LEDs; the output; the wps and reset buttons ‚Äî to the input. Then everything is approximately like in Ardwin or another MK - we ‚Äúblink‚Äù the specified contacts in the right order, depicting the SPI bus operation, and read the ‚Äúbutton presses.‚Äù And the SD card understands this, and so we access its content literally ‚Äú <a href="http://tinyhack.com/2010/04/04/d-link-dir-300-serial-port-and-sd-mod/">through the LEDs and the button</a> .‚Äù).  Well, or even an external network FS, mounted to a router from running Windows using the SMB protocol.  However, in this case, the meaning of the router disappears as a small stand-alone computer that can fully serve its services. <br>  Optware was once part of the development of openwrt free firmware, but later separated into an independent project, due to the fact that the packages collected there are completely independent and self-sufficient.  The standard libraries necessary for their work (libc in the form of uclibc) are also assembled and located in optware.  This allows you to run very many applications, almost without worrying about the features and features of the firmware specific device. <br>  The downside of this approach is that <i>not everything will work</i> .  For example, it‚Äôs not possible to build and connect kernel modules.  Also, linking to your own standard libraries implies loading them into memory along with the existing stock libraries of the firmware, which means increased requirements for RAM, which is not very much on the router.  Finally, we get an assembly not sharpened for a specific piece of hardware, but a package for a ‚Äúuniversal average router‚Äù - this is about as a program for i386 (which you run on your cool core i7): many features of a specific processor / platform are ignored and rolled back to legacy .  And nevertheless, optware is quite a working solution. <br>  Optware is usually compiled by a cross-compiler on a linux-based host (for example, I compile on ubuntu 12.04).  Zachekautiv <a href="http://svn.nslu2-linux.org/svnroot/optware/trunk/">svn-repository of the</a> project, you will immediately receive the source code, and the README file with further instructions (curious - go ahead!). <br><br><h5>  Openwrt </h5><br>  This is a whole separate firmware, which completely replaces the original stock.  I had to contact OpenWrt when it became clear that the capabilities of ddwrt + optware are not enough.  Having read the Habrow articles about ‚Äúsmart home‚Äù, I decided to gradually automate various household electrics.  I chose z-wave, bought a ‚Äúwhistle‚Äù and joined the cloud z-wave.me.  However, keeping the desktop on for the sake of connecting home automation to the cloud is too wasteful.  Moreover, in my router there was not one, but two whole usb-ports!  But ... the whistle did not start.  The necessary kernel module (cp21xx) was not found in the firmware.  It was impossible to assemble software of this kind in optware.  Rebuilding all dd-wrt firmware is also a completely non-trivial task (terrible system! My patience was not enough to set up the toolchain, satisfy all dependencies and achieve a successful build!).  Openwrt for my router (rt-n16) was not initially supported, but at that moment there were already patches that allowed me to make a completely working firmware.  So, I said goodbye to dd-wrt in favor of an ‚Äúeven more free‚Äù firmware. <br>  What is good openwrt?  Yes, that <i>everything is</i> configured.  We look at the minuses of optware, and throw them out of my head.  There are no duplicate libraries (we collect software directly under the existing firmware).  No problems with the kernel modules (the usual full-fledged linux. Wanted an exotic ‚Äúwhistle‚Äù? Please! Wanted to plug in a 3G modem and take the Internet out of it? Easily!).  The software can be optimized for the existing platform (and the compiler in the assembly will use the capabilities that are in the chip specifically your router, and not roll back to legacy). <br>  Finally, it is worth saying that openwrt doesn‚Äôt actually contradict optware.  Simply, it is more flexible and more convenient.  However, if the / opt partition has been preserved from the previous firmware, then the software available there will probably start perfectly in the new openwrt.  Rebuild does not need anything!  (although all the disadvantages of its isolation optware will remain). <br><br><h4>  Embedded Sphinx - what do you need from it? </h4><br>  Sphinx's scalability is impressive!  It is enough to review and evaluate the achievements on the project‚Äôs 'powered by' page.  Indices for billions of documents;  the load of half a billion requests per day is quite a working number.  But this is all High Load on serious machines or even clusters, with nimble processors and a sea of ‚Äã‚ÄãRAM.  What about scalability in a different direction?  Low memory, incomprehensible processor and disk?  It turns out not so bad.  On a native non-x86 platform, the Sphinx is quite normally assembled (and passes internal tests) on the Raspberry Pi.  However, if we look at the details, then apart from the <i>other</i> architecture, everything else in Malinka is very good.  As many as 256-512MB of RAM!  And the sphinx need it!  After all, almost all of his "secret of success" is the maximum use of available iron.  He is not at all focused on the ‚Äú640Kb enough for everyone‚Äù philosophy, but quite the opposite;  seeks to maximally follow the ‚Äúfashionable‚Äù configurations and use their capabilities to the fullest <br>  Memory cheap?  Let's forget about and load the whole index into it! <br>  Have new fashion SSDs come into fashion in production with impressive access times?  Okay, let's play, try - and, maybe, shake up the internal strategies and formats again, ‚Äúeverything went flying‚Äù. <br>  Moreover, this is not at all a waste of the form ‚Äúsince we have a new smart percent, then we can afford to sort these three gigabyte lines with a bubble from a script written in BASIC,‚Äù but quite the opposite;  reasonable optimizations implemented by experienced (ex) game dev developers and tested by benchs. <br>  And where, it is asked, is there to be thrust with his antediluvian ‚Äúnedocomputer‚Äù, which only Baitik can send from one cable to another?  Well, actually, why not? <br>  Of course, cross-compilation is implied (some manage to build and run the native tool directly on the router - but I'm not very ready for this approach).  Once a cross-compilation means that many internal tests of autotouls (the Sphinx is configured by them) will stand aside and it will be necessary to somehow prompt the tulchein that we have glands on board. <br>  So, to run a sphinx on a small piece of iron, you first need to think about some points related to the ‚Äúminiature‚Äù of the target platform. <br><br><h5>  Optimizing memory requirements </h5><br>  How to satisfy the gluttony (or rather, the "large-scale attitude") of the sphinx to the RAM?  It's all quite simple.  Sphinx does not spend resources "just like that";  its ‚Äúvoracity‚Äù directly depends on the task and on the index volume.  It is he, for the most part, takes place in the memory.  This means that the lower the index, the lower the memory requirements. <br>  The dictionary (file .spi) and attribute blobs (files .spa, .sps, .spm) are loaded into the RAM.  Evaluating the size of these files, you can make a fairly accurate prediction of future "gluttony". <br>  If it is very tight - you can get rid of the attributes and enable the option "dictionary-on-disk".  Then everything will be slow and sad, but entirely on the disk.  However, you can not disconnect anything, but simply connect the swap-partition.  It gets in the memory - it will ‚Äúfly‚Äù.  It will not fit - it will automatically go to the swap and will come to the option ‚Äúslowly and sadly, but it works!‚Äù <br><br><h5>  Index type? </h5><br>  I took the usual.  With the keywords dictionary (just crc is already outdated).  RT is not needed, if only because the data itself does not need to be changed in real-time;  periodical reindexing is enough (and so yes, if necessary, it will ‚Äúfly up‚Äù and rt).  This means that a single searchd daemon is not enough, but an indexer is also needed. <br><br><h5>  Link to data source? </h5><br>  What else?  Need support for the desired data source (in our case - mysql).  Until recently, with this support there were certain ‚Äúrakes‚Äù associated with the architecture of the Sphinx itself - namely, the fact that it consists of the libsphinx megablibrary and small sources that implement the immediate indexer, searchd, etc. tools.  At the same time, almost all the functionality of working with indexes (including their creation from data sources) is in libsphinx.  The ‚Äúrake‚Äù of supporting sources lies in the fact that when they assemble a sphinx with the support of mysql, all the sphinx binaries through a common megalibu are dependent on libmysqlclient.  On a serious machine, this is not a problem, but on a router, having a dependency on a library that is linked ‚Äújust like that‚Äù but completely unnecessary for work is wasteful!  There are two options: make two assemblies;  one with mysql support, the second with no indexing support at all.  From the first to take the indexer, from the second - everything else.  The second option appeared recently - it simply loads all the necessary external libraries explicitly (via dlopen).  In this case, you can forget about unnecessary dependencies: indexer will load the library when it needs it;  searchd won't touch it at all. <br><br><h5>  How to run a demon? </h5><br>  The classic method is implemented in the Sphinx itself.  This is a double fork - first we unhook from the active terminal, then we create a new working session - and now we live in the background, we don‚Äôt have a console and do not respond to pressing Ctrl + C in the terminal.  We write our pid to the pid-file - and that‚Äôs it, we became a full-fledged daemon.  It seems everything is OK, but it has to be implemented by EVERY demon in the system.  Why duplicate code on an open-source system?  So the smart men thought and thought and invented an upstart - he doesn‚Äôt need to be able to become a demon from the ‚Äúexperimental‚Äù process, but simply keeps it in the background, stores the pid-file in the standard place and at the same time implements the ‚Äúguard dog‚Äù restarting the demon in the result of a sudden fall.  By the way, at one time because of this, there were problems running the sphinx through upstart - two too clever programs still could not agree.  As a result, the correct option from under the upstart is to run with the option '--nodetach' and monitor the running process (and not its forks).  At the same time, the sphinx does not consider itself a demon, but the entire background control falls on upstart). <br>  In the case of embedded, however, there are no problems with upstart, as long as it is optware, that openwrt use classic rc.d-scripts.  In other words - no special flags are needed;  Sphynx will manage its life itself. <br><br><h5>  Where to put the logs? </h5><br>  Initially, the Sphinx keeps a general log of the daemon (fell-rose-rotated), as well as a separate log of all requests.  It is clear that writing something to the flash memory on the router, and even without size control, will be like suicide.  Therefore, we specify as 'syslog' as the logs, and also do not forget to add --with-syslog (however, it is now enabled by default) when configuring the assembly.  As a result, the entire output will be strewn into the system log, which we will already steer at the system level of the router itself.  And then there are several options, depending on the capabilities of the firmware.  On some (like the old DIR-300 with a very small flash) it is easier not to log at all.  On others, a piece is stored in a ring buffer directly in memory, and can be read from the console with the logread command.  On the third one is redirected via udp to the server in ‚Äúwhich can‚Äù.  But in any case - it is no longer a sphinx problem! <br><br><h4>  Configuring and collecting! </h4><br>  All questions of the work of the demon on the router like decided.  Now it's time to do the build! <br><br><h5>  Cheating autotools </h5><br>  Sphinx is configured using autotools.  ./configure- the script that runs before the build will honestly run through our build system and find out what our compiler is, what functions are supported, what is the architecture, what is the byte order (LSB or MSB).  The problem is that almost all these tests will affect not the target router, but the system where we run the toolchain.  Therefore, there is only one way - to prompt the configuration ‚Äúcorrect answers‚Äù.  This is done using environment variables.  For example, if ./configure checks the availability of the qsort function, then you can give the necessary ‚Äúhint‚Äù by defining the variable ac_cv_func_qsort before starting ./configure.  For example, executing <code>export ac_cv_func_qsort=no</code> - ./configure before <code>export ac_cv_func_qsort=no</code> will assume that you do not have the qsort function.  Accordingly, a package configured in this way will either use its own implementation, or it will break at all during assembly (ha-ha!). <br>  To build embedded sphinx "explicit hints" you need quite a bit.  Here they are all ... <br><ul><li>  <b>sphinx_cv_unaligned_ram_access</b> (yes / no) - the name speaks for itself.  In short, the internal index format of the Sphinx is compressed, aligned by one byte.  If you suddenly need to take a DWORD from such a file (loaded into memory), and it will be lying at an odd address - on some architectures (for example, sparc) this will lead to crash!  You can recognize the situation either by reading the datasheet on the target platform;  or by the ‚Äúscientific spear‚Äù method - by collecting all the possible (as many as two!) options and trying to run on the target system.  (Technical details: if unaligned access is not possible, then instead of simply taking a DWORD from the desired pointer, the memcpy call will be used to copy the necessary 4 bytes from a random address).  In practice, on my mips (el) unaligned works. </li><li>  <b>sphinx_cv_interlocked</b> (yes / no) - just the build costs for legacy i386.  For example, in optware for dd-wrt you have to put 'no', otherwise the build fails.  In a more tuned openwrt assembly, the same flag can be left intact;  The default 'yes' gives a completely working version.  (Technical details: depending on the flag inside, either the atomic lock-free operation __sync_fetch_and_add is used, or the structure of the variable + mutex, which does the same work, but is already locked) </li><li>  <b>ac_cv_c_bigendian</b> (yes / no) is the funniest variable.  If you do not publish indexes anywhere "to the outside world" - this variable can be ignored.  How the demon keeps blobs inside it doesn‚Äôt matter;  The main thing is to correctly respond to requests.  And communication over the network, as expected, is surrounded by calls to hton / ntoh and the like, and therefore endianess is not affected.  However, as soon as you try, say, to create an index on your desktop, and then throw it into the router ‚Äúshob worked‚Äù - this is where the differences come out.  In short, loading an index with another endianess is currently IMPOSSIBLE.  In principle, the problem can be fixed and repaired, but there is not much point in this (as long as there is no ‚Äúhuge crowd of users‚Äù who load indexes between platforms).  The difference between the indices is easy to see by opening the .sph file for viewing (directly with a dump, F3 in mc).  On the index created on little-endian in the title you will see the magic-signature "SPHX".  On big-endian - "XHPS". <br>  Find out the target correct value in several ways.  First of all - the already mentioned "scientific tyk."  The sphinx has a built-in runtime check, which, if the actual capabilities do not match the ones specified during the compilation, politely curses and prompts the correct value.  Secondly, you can see the characteristics of the compiled binary using the file command (implicitly - by pressing F3 on the file in mc on ubunt).  Having seen the ‚ÄúELF 32-bit MSB executable‚Äù there, we understand that we are dealing with big endian.  And "ELF 32-bit LSB executable" says little-endian.  In this case, you are lucky - you can create indexes on the desktop :).  Finally, the third and easiest way is to look at the name of the compiler.  'mips' is big-endian, 'mipsel' is little endian.  The correct endianess is of critical importance if you decide to use the aot lemmatizer (included in the config as stemmer = lemmatize_aot_ru, lemmatize_aot_en, lemmatize_aot_de or all together).  Blocks of aot dictionaries are created on a ‚Äúnormal‚Äù PC with little-endian, so the ‚Äúenemy‚Äù architecture needs to be converted (which is done on the fly right at boot, but for this endianess must be correctly set during configuration). </li><li>  <b>ac_cv_func_realloc_0_nonnull</b> = yes </li><li>  <b>ac_cv_func_malloc_0_nonnull</b> = yes - I‚Äôll just mention for completeness.  "Bzik" avtotulz, in the Sphinx are not used.  But without them, the assembly produces an error, which leads to such a decision, a ‚Äúgag‚Äù. </li></ul><br>  Yes, by the way - the variables mentioned (naming style, the way of prompting ‚Äúcorrect answers‚Äù) are, as you understand, not a special feature of the sphinx, but an attribute of autotouls.  Exactly the same way you can "prompt" the answers when configuring any other software written using autotouch. <br><br><h5>  Sphinx in optware </h5><br>  In the target platform folder (I compiled for ddwrt), go to the make folder and copy template.mk into sphinxsearch.mk.  Then edit the copy, following the instructions in the file itself.  This, in fact, is the only necessary (and often sufficient) script for adding your software to optware.  Here is the key piece of this script that configures the main build: <br><br><pre> <code class="hljs javascript">(SPHINXSEARCH_BUILD_DIR)/.configured: sphinxsearch-source make/sphinxsearch.mk $(MAKE) libstdc++-stage $(MAKE) expat-stage $(MAKE) mysql5-stage rm -rf $(BUILD_DIR)/$(SPHINXSEARCH_DIR) $(@D) $(SPHINXSEARCH_UNZIP) $(DL_DIR)/$(SPHINXSEARCH_SOURCE) | tar -C $(BUILD_DIR) -xvf - $(LIBSTEMMER_UNZIP) $(DL_DIR)/$(LIBSTEMMER_SOURCE) | tar -C $(BUILD_DIR)/$(SPHINXSEARCH_DIR) -xvf - <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> test -n <span class="hljs-string"><span class="hljs-string">"$(SPHINXSEARCH_PATCHES)"</span></span> ; \ then cat $(SPHINXSEARCH_PATCHES) | \ patch -d $(BUILD_DIR)/$(SPHINXSEARCH_DIR) -p0 ; \ fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> test <span class="hljs-string"><span class="hljs-string">"$(BUILD_DIR)/$(SPHINXSEARCH_DIR)"</span></span> != <span class="hljs-string"><span class="hljs-string">"$(@D)"</span></span> ; \ then mv $(BUILD_DIR)/$(SPHINXSEARCH_DIR) $(@D) ; \ fi (cd $(@D); \ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> ac_cv_func_realloc_0_nonnull=yes; \ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> ac_cv_func_malloc_0_nonnull=yes; \ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> sphinx_cv_unaligned_ram_access=yes; \ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> ac_cv_c_bigendian=no; \ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> sphinx_cv_interlocked=no; \ $(TARGET_CONFIGURE_OPTS) \ CPPFLAGS=<span class="hljs-string"><span class="hljs-string">"$(STAGING_CPPFLAGS) $(SPHINXSEARCH_CPPFLAGS)"</span></span> \ LDFLAGS=<span class="hljs-string"><span class="hljs-string">"$(STAGING_LDFLAGS) $(SPHINXSEARCH_LDFLAGS)"</span></span> \ ./configure \ --build=$(GNU_HOST_NAME) \ --host=$(GNU_TARGET_NAME) \ --target=$(GNU_TARGET_NAME) \ --prefix=<span class="hljs-regexp"><span class="hljs-regexp">/opt \ --sysconfdir=/</span></span>opt/etc/sphinxsearch \ --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-libstemmer \ --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-mysql=$(STAGING_PREFIX) \ --without-unixodbc \ --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-syslog \ --enable-dl \ ) touch $@</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The rest of the build is trivial (make, strip, packaging). </font><font style="vertical-align: inherit;">In addition to sphinx sources, libstemmer sources are also required (they will be pulled when building directly from their site). </font><font style="vertical-align: inherit;">Also collected expat and mysql are required (as long as we depend on them; they will be collected as dependencies). </font><font style="vertical-align: inherit;">In addition to the main makefile (lying in ./make), the optware source folder folder structure also uses the ./sources/sphinxsearch folder. </font><font style="vertical-align: inherit;">It contains the init-script for the daemon, which will be packaged and later found in /opt/etc/init.d during installation. </font><font style="vertical-align: inherit;">The build is done from the root folder, and certain suffixes are added to the package name:</font></font><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make sphinxsearch</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - just gather the sphinx in cross-tachyne. </font><font style="vertical-align: inherit;">Useful for debugging.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make sphinxsearch-ipk</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - will assemble a sphinx, after which it will create an .ipk package</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make sphinxsearch-clean</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - we clean up trash (after the build).</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result of the assembly with the suffix -ipk, we get the ‚Äúready-to-use‚Äù package sphinxsearch.ipk, which we install into optware using ipkg. </font><font style="vertical-align: inherit;">Then everything is as usual - we write the config, we index (and as long as the dd-wrt builds on the default LSB - we can index it on the desktop) - and take off.</font></font> Voila!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you wish, you can remove the dependency on mysql (see the SPHINXSEARCH_DEPENDS directive in full config) - as long as you do not need this library to start the daemon itself (and if you create an index on the side, then you DO NOT need it on the router). </font><font style="vertical-align: inherit;">It may be necessary to slightly correct the ac_cv_ variables ... and sphinx_cv_ ... In the above script, they are set based on the build for optware for dd-wrt (and this is the mipsel architecture, i.e. little-endian, and at the same time the maximum set of chip features is reduced)</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sphinx in openwrt </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the target openwrt on mips does not succeed in running optware from ddwrt (there is mipsel). If, however, also on mipsel - you can run sphinx from optware, however, in this case it is much more justified in terms of careful use of resources, you will use the full openwrt openness and build it under the target system - this will get rid of legacy restrictions, and also get a more optimal code, which will not load into memory one more ‚Äúslightly different‚Äù copy of the standard library.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For assembly in openwrt, makefiles are also used, only their format and location are different. The necessary files are located in a separate folder created somewhere in the package tree from the root of the build environment. For example, I chose package / network / services / sphinx. In the specified folder, the Makefile is the minimum required, and there may also be other files and folders with predefined names. In addition to the Makefile, I also use Config.in (it creates a submenu in the main menuconfig), as well as the file / folder where the sample config and the init script lie (by the way, much shorter than in optware). The key part of the configuration for openwrt looks like this:</font></font><br><pre> <code class="hljs javascript">CONFIGURE_VARS += \ ac_cv_func_realloc_0_nonnull=yes \ ac_cv_func_malloc_0_nunnul=yes \ ac_cv_c_bigendian=yes \ sphinx_cv_unaligned_ram_access=yes CONFIGURE_ARGS += \ --prefix=<span class="hljs-regexp"><span class="hljs-regexp">/ \ --sysconfdir=/</span></span>etc/sphinx \ $(<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $(CONFIG_SPHINX_MYSQL_SUPPORT),--<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-mysql,--without-mysql) \ $(<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $(CONFIG_SPHINX_PGSQL_SUPPORT),--<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-pgsql,--without-pgsql) \ $(<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $(CONFIG_SPHINX_UNIXODBC_SUPPORT),--<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-unixodbc,--without-unixodbc) \ $(<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $(CONFIG_SPHINX_EXPAT_SUPPORT),--<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-libexpat,--without-libexpat) \ $(<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $(CONFIG_SPHINX_DYNAMIC_LOAD),--enable-dl,,) \ --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-syslog \ --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-libstemmer</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Even visually, it is shorter than in optware (the entire script itself is also significantly shorter - only 84 lines, most of which are patterned). This involves variables that are configured from the menu. In this version, you may need to correct ac_cv_c_bigendian for your needs (I built a NetGear WNDR4300 router, which is MIPS, that is, big-endian). Also in this version, I did not load libstemmer separately when building. Instead, you need to download it yourself in advance and package it into a tarball with the source code (and fix PKG_MD5SUM for the one that the tarball has received).</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build a package in openwrt is carried out in two stages. First, we launch menuconfig in the root folder and configure the firmware as a whole. There you NEED to go to the Network / Web Servers / Proxies section - and already there choose sphinx as a module (M). You can also go to the configuration submenu and build an assembly with the support of the necessary data sources. Then we exit the menuconfig, saving the changes - and finally, run the assembly of the entire firmware: </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or just one sphinx (of course, with dependencies, if needed) </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make package / network / services / sphinx / compile</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The received packages are added to the folder ./bin/ARCH/packages (in my case it is ./bin/ar71xx/packages). You can install the package either directly by finding it and copying it to the router (and then setting an opkg on it), or publishing the assembly folder on the local web server and writing the path to it in /etc/opkg.conf on the router, and then opkg update; opkg install sphinx.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To index on the router, you may need to separately install the mysql client library (I did not prescribe it depending on the installation in the case of configuration with dynamic loading of the required libs). </font><font style="vertical-align: inherit;">And also - manually create a symlink for it (using the ln -s libmysqlclient.so.16.0.0 command libmysqlclient.so in the folder where the lib lies). </font><font style="vertical-align: inherit;">Otherwise, everything works out of the box. </font><font style="vertical-align: inherit;">My application uses sphinx using the sphinxql protocol (i.e., the same libmysqlclient is used not only by the sphinx to index mysql, but also by clients to work with the sphinx itself), but the legacy protocol of the sphinx (sphinx api, which is strongly recommended not to touch client applications) is also quite functional. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally - configs and scripts. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For optware:</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembly script</font></font></b> <div class="spoiler_text">    sphinxsearch.mk     make  optware <br><pre> <code class="hljs mel">########################################################### # # sphinxsearch # ########################################################### # You must replace <span class="hljs-string"><span class="hljs-string">"sphinxsearch"</span></span> and <span class="hljs-string"><span class="hljs-string">"SPHINXSEARCH"</span></span> with the lower <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> name and # upper <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> name of your new package. Some places below will say # <span class="hljs-string"><span class="hljs-string">"Do not change this"</span></span> - that does not include this <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> change, # which must always be done to ensure we have unique names. # # SPHINXSEARCH_VERSION, SPHINXSEARCH_SITE and SPHINXSEARCH_SOURCE define # the upstream location of the <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the package. # SPHINXSEARCH_DIR is the directory which is created when the <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> # archive is unpacked. # SPHINXSEARCH_UNZIP is the command used to unzip the <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>. # It is usually <span class="hljs-string"><span class="hljs-string">"zcat"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> .gz) or <span class="hljs-string"><span class="hljs-string">"bzcat"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> .bz2) # # You should change all these variables to suit your package. # Please make sure that you add a description, and that you # list all your packages<span class="hljs-string"><span class="hljs-string">' dependencies, seperated by commas. # # If you list yourself as MAINTAINER, please give a valid email # address, and indicate your irc nick if it cannot be easily deduced # from your name or email address. If you leave MAINTAINER set to # "NSLU2 Linux" other developers will feel free to edit. # http://sphinxsearch.com/files/sphinx-2.0.5-release.tar.gz #SPHINXSEARCH_SITE=http://sphinxsearch.com/files SPHINXSEARCH_SITE=http://192.168.1.5:65080/r/sphinxsearch SPHINXSEARCH_VERSION=2.2.2-4470 SPHINXSEARCH_SOURCE=sphinx-$(SPHINXSEARCH_VERSION).tar.gz SPHINXSEARCH_DIR=sphinx-$(SPHINXSEARCH_VERSION) SPHINXSEARCH_UNZIP=zcat SPHINXSEARCH_MAINTAINER=NSLU2 Linux &lt;nslu2-linux@yahoogroups.com&gt; SPHINXSEARCH_DESCRIPTION=Sphinx is free open-source SQL full-text search engine. SPHINXSEARCH_SECTION=misc SPHINXSEARCH_PRIORITY=optional SPHINXSEARCH_DEPENDS=libstdc++, expat, mysql5 SPHINXSEARCH_SUGGESTS= SPHINXSEARCH_CONFLICTS= LIBSTEMMER_SITE=http://snowball.tartarus.org/dist LIBSTEMMER_SOURCE=libstemmer_c.tgz LIBSTEMMER_UNZIP=zcat # # SPHINXSEARCH_IPK_VERSION should be incremented when the ipk changes. # SPHINXSEARCH_IPK_VERSION=2 # # SPHINXSEARCH_CONFFILES should be a list of user-editable files SPHINXSEARCH_CONFFILES=/opt/etc/sphinxsearch/sphinx.conf # # SPHINXSEARCH_PATCHES should list any patches, in the the order in # which they should be applied to the source code. # #SPHINXSEARCH_PATCHES=$(SPHINXSEARCH_SOURCE_DIR)/configure.patch SPHINXSEARCH_PATCHES= # # If the compilation of the package requires additional # compilation or linking flags, then list them here. # SPHINXSEARCH_CPPFLAGS= SPHINXSEARCH_LDFLAGS= # # SPHINXSEARCH_BUILD_DIR is the directory in which the build is done. # SPHINXSEARCH_SOURCE_DIR is the directory which holds all the # patches and ipkg control files. # SPHINXSEARCH_IPK_DIR is the directory in which the ipk is built. # SPHINXSEARCH_IPK is the name of the resulting ipk files. # # You should not change any of these variables. # SPHINXSEARCH_BUILD_DIR=$(BUILD_DIR)/sphinxsearch SPHINXSEARCH_SOURCE_DIR=$(SOURCE_DIR)/sphinxsearch SPHINXSEARCH_IPK_DIR=$(BUILD_DIR)/sphinxsearch-$(SPHINXSEARCH_VERSION)-ipk SPHINXSEARCH_IPK=$(BUILD_DIR)/sphinxsearch_$(SPHINXSEARCH_VERSION)-$(SPHINXSEARCH_IPK_VERSION)_$(TARGET_ARCH).ipk .PHONY: sphinxsearch-source sphinxsearch-unpack sphinxsearch sphinxsearch-stage sphinxsearch-ipk sphinxsearch-clean sphinxsearch-dirclean sphinxsearch-check # # This is the dependency on the source code. If the source is missing, # then it will be fetched from the site using wget. # $(DL_DIR)/$(SPHINXSEARCH_SOURCE): $(WGET) -P $(@D) $(SPHINXSEARCH_SITE)/$(@F) || \ $(WGET) -P $(@D) $(SOURCES_NLO_SITE)/$(@F) $(DL_DIR)/$(LIBSTEMMER_SOURCE): $(WGET) -P $(@D) $(LIBSTEMMER_SITE)/$(@F) || \ $(WGET) -P $(@D) $(SOURCES_NLO_SITE)/$(@F) # # The source code depends on it existing within the download directory. # This target will be called by the top level Makefile to download the # source code'</span></span>s archive (.tar.gz, .bz2, etc.) # sphinxsearch-<span class="hljs-keyword"><span class="hljs-keyword">source</span></span>: $(DL_DIR)/$(SPHINXSEARCH_SOURCE) $(DL_DIR)/$(LIBSTEMMER_SOURCE) $(SPHINXSEARCH_PATCHES) # # This target unpacks the <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the build directory. # If the <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> archive is not .tar.gz or .tar.bz2, then you will need # to change the commands here. Patches to the <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> code are also # applied <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> this target as required. # # This target also configures the build within the build directory. # Flags such as LDFLAGS and CPPFLAGS should be passed into configure # and NOT $(MAKE) below. Passing it to configure causes configure to # correctly BUILD the Makefile with the right paths, where passing it # to Make causes it to override the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> search paths of the compiler. # # If the compilation of the package <span class="hljs-keyword"><span class="hljs-keyword">requires</span></span> other packages to be staged # first, then <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> that first (eg <span class="hljs-string"><span class="hljs-string">"$(MAKE) &lt;bar&gt;-stage &lt;baz&gt;-stage"</span></span>). # # If the package uses GNU libtool, you should invoke $(PATCH_LIBTOOL) as # shown below to make various patches to it. # $(SPHINXSEARCH_BUILD_DIR)/.configured: sphinxsearch-<span class="hljs-keyword"><span class="hljs-keyword">source</span></span> make/sphinxsearch.mk $(MAKE) libstdc++-stage $(MAKE) expat-stage $(MAKE) mysql5-stage rm -rf $(BUILD_DIR)/$(SPHINXSEARCH_DIR) $(@D) $(SPHINXSEARCH_UNZIP) $(DL_DIR)/$(SPHINXSEARCH_SOURCE) | tar -C $(BUILD_DIR) -xvf - $(LIBSTEMMER_UNZIP) $(DL_DIR)/$(LIBSTEMMER_SOURCE) | tar -C $(BUILD_DIR)/$(SPHINXSEARCH_DIR) -xvf - <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> test -n <span class="hljs-string"><span class="hljs-string">"$(SPHINXSEARCH_PATCHES)"</span></span> ; \ then cat $(SPHINXSEARCH_PATCHES) | \ patch -d $(BUILD_DIR)/$(SPHINXSEARCH_DIR) -p0 ; \ fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> test <span class="hljs-string"><span class="hljs-string">"$(BUILD_DIR)/$(SPHINXSEARCH_DIR)"</span></span> != <span class="hljs-string"><span class="hljs-string">"$(@D)"</span></span> ; \ then mv $(BUILD_DIR)/$(SPHINXSEARCH_DIR) $(@D) ; \ fi (cd $(@D); \ export ac_cv_func_realloc_0_nonnull=yes; \ export ac_cv_func_malloc_0_nonnull=yes; \ export sphinx_cv_unaligned_ram_access=yes; \ export sphinx_cv_interlocked=no; \ $(TARGET_CONFIGURE_OPTS) \ CPPFLAGS=<span class="hljs-string"><span class="hljs-string">"$(STAGING_CPPFLAGS) $(SPHINXSEARCH_CPPFLAGS)"</span></span> \ LDFLAGS=<span class="hljs-string"><span class="hljs-string">"$(STAGING_LDFLAGS) $(SPHINXSEARCH_LDFLAGS)"</span></span> \ ./configure \ --build=$(GNU_HOST_NAME) \ --host=$(GNU_TARGET_NAME) \ --target=$(GNU_TARGET_NAME) \ --prefix=/opt \ --sysconfdir=/opt/etc/sphinxsearch \ --with-libstemmer \ --with-mysql=$(STAGING_PREFIX) \ --without-unixodbc \ --with-syslog \ --enable-dl \ ) # $(PATCH_LIBTOOL) $(@D)/libtool touch $@ sphinxsearch-unpack: $(SPHINXSEARCH_BUILD_DIR)/.configured # # This builds the actual binary. # $(SPHINXSEARCH_BUILD_DIR)/.built: $(SPHINXSEARCH_BUILD_DIR)/.configured rm -f $@ $(MAKE) -C $(@D) touch $@ # # This is the build convenience target. # sphinxsearch: $(SPHINXSEARCH_BUILD_DIR)/.built # # If you are building a library, then you need to stage it too. # $(SPHINXSEARCH_BUILD_DIR)/.staged: $(SPHINXSEARCH_BUILD_DIR)/.built rm -f $@ $(MAKE) -C $(@D) DESTDIR=$(STAGING_DIR) install touch $@ sphinxsearch-stage: $(SPHINXSEARCH_BUILD_DIR)/.staged # # This rule creates a <span class="hljs-keyword"><span class="hljs-keyword">control</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ipkg. It is no longer # necessary to create a seperate <span class="hljs-keyword"><span class="hljs-keyword">control</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> under sources/sphinxsearch # $(SPHINXSEARCH_IPK_DIR)/CONTROL/<span class="hljs-keyword"><span class="hljs-keyword">control</span></span>: @install -d $(@D) @rm -f $@ @echo <span class="hljs-string"><span class="hljs-string">"Package: sphinxsearch"</span></span> &gt;&gt;$@ @echo <span class="hljs-string"><span class="hljs-string">"Architecture: $(TARGET_ARCH)"</span></span> &gt;&gt;$@ @echo <span class="hljs-string"><span class="hljs-string">"Priority: $(SPHINXSEARCH_PRIORITY)"</span></span> &gt;&gt;$@ @echo <span class="hljs-string"><span class="hljs-string">"Section: $(SPHINXSEARCH_SECTION)"</span></span> &gt;&gt;$@ @echo <span class="hljs-string"><span class="hljs-string">"Version: $(SPHINXSEARCH_VERSION)-$(SPHINXSEARCH_IPK_VERSION)"</span></span> &gt;&gt;$@ @echo <span class="hljs-string"><span class="hljs-string">"Maintainer: $(SPHINXSEARCH_MAINTAINER)"</span></span> &gt;&gt;$@ @echo <span class="hljs-string"><span class="hljs-string">"Source: $(SPHINXSEARCH_SITE)/$(SPHINXSEARCH_SOURCE)"</span></span> &gt;&gt;$@ @echo <span class="hljs-string"><span class="hljs-string">"Description: $(SPHINXSEARCH_DESCRIPTION)"</span></span> &gt;&gt;$@ @echo <span class="hljs-string"><span class="hljs-string">"Depends: $(SPHINXSEARCH_DEPENDS)"</span></span> &gt;&gt;$@ @echo <span class="hljs-string"><span class="hljs-string">"Suggests: $(SPHINXSEARCH_SUGGESTS)"</span></span> &gt;&gt;$@ @echo <span class="hljs-string"><span class="hljs-string">"Conflicts: $(SPHINXSEARCH_CONFLICTS)"</span></span> &gt;&gt;$@ # # This builds the IPK <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>. # # Binaries should be installed into $(SPHINXSEARCH_IPK_DIR)/opt/sbin or $(SPHINXSEARCH_IPK_DIR)/opt/bin # (use the location <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a well-known Linux distro as a guide <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> choosing sbin or bin). # Libraries and include files should be installed into $(SPHINXSEARCH_IPK_DIR)/opt/{lib,include} # Configuration files should be installed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(SPHINXSEARCH_IPK_DIR)/opt/etc/sphinxsearch/... # Documentation files should be installed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(SPHINXSEARCH_IPK_DIR)/opt/doc/sphinxsearch/... # Daemon startup scripts should be installed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(SPHINXSEARCH_IPK_DIR)/opt/etc/init.d/S??sphinxsearch # # You may need to patch your application to make it use these locations. # $(SPHINXSEARCH_IPK): $(SPHINXSEARCH_BUILD_DIR)/.built rm -rf $(SPHINXSEARCH_IPK_DIR) $(BUILD_DIR)/sphinxsearch_*_$(TARGET_ARCH).ipk $(MAKE) -C $(SPHINXSEARCH_BUILD_DIR) DESTDIR=$(SPHINXSEARCH_IPK_DIR) install-<span class="hljs-keyword"><span class="hljs-keyword">strip</span></span> install -d $(SPHINXSEARCH_IPK_DIR)/opt/etc/sphinxsearch install -m <span class="hljs-number"><span class="hljs-number">644</span></span> $(SPHINXSEARCH_BUILD_DIR)/sphinx-<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>.conf.dist $(SPHINXSEARCH_IPK_DIR)/opt/etc/sphinxsearch/sphinx.conf install -d $(SPHINXSEARCH_IPK_DIR)/opt/doc/sphinxsearch install -m <span class="hljs-number"><span class="hljs-number">644</span></span> $(SPHINXSEARCH_BUILD_DIR)/doc/sphinx.txt $(SPHINXSEARCH_IPK_DIR)/opt/doc/sphinxsearch/sphinx.txt rm $(SPHINXSEARCH_IPK_DIR)/opt/etc/sphinxsearch/sphinx.conf.dist rm $(SPHINXSEARCH_IPK_DIR)/opt/etc/sphinxsearch/example.sql rm $(SPHINXSEARCH_IPK_DIR)/opt/etc/sphinxsearch/sphinx-<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>.conf.dist install -d $(SPHINXSEARCH_IPK_DIR)/opt/etc/init.d install -m <span class="hljs-number"><span class="hljs-number">755</span></span> $(SPHINXSEARCH_SOURCE_DIR)/rc.sphinxsearch $(SPHINXSEARCH_IPK_DIR)/opt/etc/init.d/S90sphinxsearch ln -s S90sphinxsearch $(SPHINXSEARCH_IPK_DIR)/opt/etc/init.d/K70sphinxsearch # sed -i -e <span class="hljs-string"><span class="hljs-string">'/^#!/aOPTWARE_TARGET=${OPTWARE_TARGET}'</span></span> $(SPHINXSEARCH_IPK_DIR)/opt/etc/init.d/SXXsphinxsearch $(MAKE) $(SPHINXSEARCH_IPK_DIR)/CONTROL/<span class="hljs-keyword"><span class="hljs-keyword">control</span></span> # install -m <span class="hljs-number"><span class="hljs-number">755</span></span> $(SPHINXSEARCH_SOURCE_DIR)/postinst $(SPHINXSEARCH_IPK_DIR)/CONTROL/postinst # sed -i -e <span class="hljs-string"><span class="hljs-string">'/^#!/aOPTWARE_TARGET=${OPTWARE_TARGET}'</span></span> $(SPHINXSEARCH_IPK_DIR)/CONTROL/postinst # install -m <span class="hljs-number"><span class="hljs-number">755</span></span> $(SPHINXSEARCH_SOURCE_DIR)/prerm $(SPHINXSEARCH_IPK_DIR)/CONTROL/prerm # sed -i -e <span class="hljs-string"><span class="hljs-string">'/^#!/aOPTWARE_TARGET=${OPTWARE_TARGET}'</span></span> $(SPHINXSEARCH_IPK_DIR)/CONTROL/prerm # <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> test -n <span class="hljs-string"><span class="hljs-string">"$(UPD-ALT_PREFIX)"</span></span>; then \ sed -i -e <span class="hljs-string"><span class="hljs-string">'/^[ ]*update-alternatives /s|update-alternatives|$(UPD-ALT_PREFIX)/bin/&amp;|'</span></span> \ $(SPHINXSEARCH_IPK_DIR)/CONTROL/postinst $(SPHINXSEARCH_IPK_DIR)/CONTROL/prerm; \ fi echo $(SPHINXSEARCH_CONFFILES) | sed -e <span class="hljs-string"><span class="hljs-string">'s/ /\n/g'</span></span> &gt; $(SPHINXSEARCH_IPK_DIR)/CONTROL/conffiles cd $(BUILD_DIR); $(IPKG_BUILD) $(SPHINXSEARCH_IPK_DIR) $(WHAT_TO_DO_WITH_IPK_DIR) $(SPHINXSEARCH_IPK_DIR) # # This is called from the top level makefile to create the IPK <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>. # sphinxsearch-ipk: $(SPHINXSEARCH_IPK) # # This is called from the top level makefile to clean all of the built files. # sphinxsearch-clean: rm -f $(SPHINXSEARCH_BUILD_DIR)/.built -$(MAKE) -C $(SPHINXSEARCH_BUILD_DIR) clean # # This is called from the top level makefile to clean all dynamically created # directories. # sphinxsearch-dirclean: rm -rf $(BUILD_DIR)/$(SPHINXSEARCH_DIR) $(SPHINXSEARCH_BUILD_DIR) $(SPHINXSEARCH_IPK_DIR) $(SPHINXSEARCH_IPK) # # # Some sanity check <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the package. # sphinxsearch-check: $(SPHINXSEARCH_IPK) perl scripts/optware-check-package.pl --target=$(OPTWARE_TARGET) $^</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">init script</font></font></b> <div class="spoiler_text">    rc.sphinxsearch     sources/sphinxsearch  optware (   ).       . <br><pre> <code class="hljs kotlin">#!/bin/sh NAME=sphinxsearch DAEMON=searchd # only used <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> virgin run DATA_PART=/mnt [ -d /mnt/C ] &amp;&amp; DATA_PART=/mnt/C prefix=<span class="hljs-string"><span class="hljs-string">"/opt"</span></span> export PATH=${prefix}/bin:${prefix}/sbin:/bin:/usr/bin:/sbin:/usr/sbin:${PATH} DAEMON=${prefix}/bin/${DAEMON} SCRIPT=<span class="hljs-string"><span class="hljs-string">"`basename $0`"</span></span> test -x $DAEMON || exit <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"$1"</span></span> ] ; then case `echo <span class="hljs-string"><span class="hljs-string">"$0"</span></span> | sed <span class="hljs-string"><span class="hljs-string">'s:^.*/\(.*\):\1:g'</span></span>` <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> S??*) rc=<span class="hljs-string"><span class="hljs-string">"start"</span></span> ;; K??*) rc=<span class="hljs-string"><span class="hljs-string">"stop"</span></span> ;; *) rc=<span class="hljs-string"><span class="hljs-string">"usage"</span></span> ;; esac <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> rc=<span class="hljs-string"><span class="hljs-string">"$1"</span></span> fi case <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$rc</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> start) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -n <span class="hljs-string"><span class="hljs-string">"`pidof </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DAEMON</span></span></span><span class="hljs-string">`"</span></span> ]; then echo <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NAME</span></span></span><span class="hljs-string"> is already running"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> echo <span class="hljs-string"><span class="hljs-string">"Starting SphinxSearch daemon: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NAME</span></span></span><span class="hljs-string">"</span></span> export LD_LIBRARY_PATH=/opt/lib:$LD_LIBRARY_PATH pth=`pwd` $DAEMON cd <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pth</span></span></span><span class="hljs-string">"</span></span> export LD_LIBRARY_PATH=$OLD_LIBRARY_PATH fi ;; stop) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -n <span class="hljs-string"><span class="hljs-string">"`pidof </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DAEMON</span></span></span><span class="hljs-string">`"</span></span> ]; then echo <span class="hljs-string"><span class="hljs-string">"Stopping SphinxSearch daemon: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NAME</span></span></span><span class="hljs-string">"</span></span> pth=`pwd` n=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> $DAEMON --stop sleep <span class="hljs-number"><span class="hljs-number">1</span></span> [ ! -n <span class="hljs-string"><span class="hljs-string">"`pidof </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DAEMON</span></span></span><span class="hljs-string">`"</span></span> ] &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> sleep <span class="hljs-number"><span class="hljs-number">5</span></span> [ $n -gt <span class="hljs-number"><span class="hljs-number">3</span></span> ] &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> let n+=<span class="hljs-number"><span class="hljs-number">1</span></span> done n=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> killall -<span class="hljs-number"><span class="hljs-number">9</span></span> $NAME <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;/dev/<span class="hljs-literal"><span class="hljs-literal">null</span></span> sleep <span class="hljs-number"><span class="hljs-number">1</span></span> [ ! -n <span class="hljs-string"><span class="hljs-string">"`pidof </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DAEMON</span></span></span><span class="hljs-string">`"</span></span> ] &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> sleep <span class="hljs-number"><span class="hljs-number">2</span></span> [ $n -gt <span class="hljs-number"><span class="hljs-number">10</span></span> ] &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> let n+=<span class="hljs-number"><span class="hljs-number">1</span></span> done <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -n <span class="hljs-string"><span class="hljs-string">"`pidof </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DAEMON</span></span></span><span class="hljs-string">`"</span></span> ]; then echo <span class="hljs-string"><span class="hljs-string">"Termination of </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NAME</span></span></span><span class="hljs-string"> was not successful, it keeps running"</span></span> sleep <span class="hljs-number"><span class="hljs-number">1</span></span> fi cd <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pth</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> echo <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NAME</span></span></span><span class="hljs-string"> already stopped"</span></span> fi ;; status) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -n <span class="hljs-string"><span class="hljs-string">"`pidof </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DAEMON</span></span></span><span class="hljs-string">`"</span></span> ]; then echo <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NAME</span></span></span><span class="hljs-string"> is running"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> echo <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NAME</span></span></span><span class="hljs-string"> is not running"</span></span> fi ;; restart) <span class="hljs-string"><span class="hljs-string">"$0"</span></span> stop <span class="hljs-string"><span class="hljs-string">"$0"</span></span> start ;; *) echo <span class="hljs-string"><span class="hljs-string">"Usage: $0 (start|stop|restart|usage)"</span></span> ;; esac exit <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For openwrt: </font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembly script</font></font></b> <div class="spoiler_text">    Makefile     package/network/services/sphinx (   ). <br><pre> <code class="hljs smalltalk">include <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">TOPDIR</span></span>)/rules.mk <span class="hljs-type"><span class="hljs-type">PKG_NAME</span></span>:=sphinx <span class="hljs-type"><span class="hljs-type">PKG_VERSION</span></span>:=<span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-type"><span class="hljs-type">PKG_REVISION</span></span>:=<span class="hljs-number"><span class="hljs-number">4470</span></span> <span class="hljs-type"><span class="hljs-type">PKG_SUFFIX</span></span>:=stemmer <span class="hljs-type"><span class="hljs-type">PKG_RELEASE</span></span>:=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#PKG_MD5SUM</span></span>:=<span class="hljs-number"><span class="hljs-number">3119</span></span>bbeafc9e32637339c6e95a3317ef <span class="hljs-type"><span class="hljs-type">PKG_SOURCE</span></span>:=<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_NAME</span></span>)-<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_VERSION</span></span>)-<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_REVISION</span></span>)-<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_SUFFIX</span></span>).tar.gz <span class="hljs-type"><span class="hljs-type">PKG_MAINTAINER</span></span>:=<span class="hljs-type"><span class="hljs-type">Aleksey</span></span> <span class="hljs-type"><span class="hljs-type">Vinogradov</span></span> &lt;klirichek@sphinxsearch.com&gt; <span class="hljs-type"><span class="hljs-type">PKG_SOURCE_URL</span></span>:=http://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>:<span class="hljs-number"><span class="hljs-number">65080</span></span>/r/sphinxsearch <span class="hljs-type"><span class="hljs-type">PKG_BUILD_DIR</span></span>:=<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">BUILD_DIR</span></span>)/<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_NAME</span></span>)-<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_VERSION</span></span>)-<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_REVISION</span></span>)-<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_SUFFIX</span></span>) <span class="hljs-type"><span class="hljs-type">PKG_BUILD_PARALLEL</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">PKG_DPNDS</span></span>:= +<span class="hljs-type"><span class="hljs-type">SPHINX_MYSQL_SUPPORT</span></span>:libmysqlclient +<span class="hljs-type"><span class="hljs-type">SPHINX_PGSQL_SUPPORT</span></span>:libpq +<span class="hljs-type"><span class="hljs-type">SPHINX_UNIXODBC_SUPPORT</span></span>:unixodbc +<span class="hljs-type"><span class="hljs-type">SPHINX_EXPAT_SUPPORT</span></span>:libexpat ifeq (<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CONFIG_SPHINX_DYNAMIC_LOAD</span></span>),y) <span class="hljs-type"><span class="hljs-type">PKG_BUILD_DEPENDS</span></span>:= <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_DEPENDS</span></span>) endif include <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCLUDE_DIR</span></span>)/package.mk define <span class="hljs-type"><span class="hljs-type">Package</span></span>/sphinx <span class="hljs-type"><span class="hljs-type">SECTION</span></span>:=net <span class="hljs-type"><span class="hljs-type">CATEGORY</span></span>:=<span class="hljs-type"><span class="hljs-type">Network</span></span> <span class="hljs-type"><span class="hljs-type">SUBMENU</span></span>:=<span class="hljs-type"><span class="hljs-type">Web</span></span> <span class="hljs-type"><span class="hljs-type">Servers</span></span>/<span class="hljs-type"><span class="hljs-type">Proxies</span></span> <span class="hljs-type"><span class="hljs-type">TITLE</span></span>:=sphinxsearch - fast <span class="hljs-type"><span class="hljs-type">FT</span></span> search engine server <span class="hljs-type"><span class="hljs-type">DEPENDS</span></span>:=+libstdcpp +librt +libpthread +zlib ifneq (<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CONFIG_SPHINX_DYNAMIC_LOAD</span></span>),y) <span class="hljs-type"><span class="hljs-type">DEPENDS</span></span>+= <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_DPNDS</span></span>) endif <span class="hljs-type"><span class="hljs-type">MENU</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span> endef define <span class="hljs-type"><span class="hljs-type">Package</span></span>/sphinx/config source <span class="hljs-comment"><span class="hljs-comment">"$(SOURCE)/Config.in"</span></span> endef define <span class="hljs-type"><span class="hljs-type">Package</span></span>/sphinx/conffiles /etc/sphinx/sphinx.conf endef #    :) define <span class="hljs-type"><span class="hljs-type">Package</span></span>/sphinx/description <span class="hljs-type"><span class="hljs-type">This</span></span> is placeholder for sphinxsearch description endef <span class="hljs-type"><span class="hljs-type">CONFIGURE_VARS</span></span> += \ ac_cv_func_realloc_0_nonnull=yes \ ac_cv_func_malloc_0_nunnul=yes \ ac_cv_c_bigendian=yes \ sphinx_cv_unaligned_ram_access=yes <span class="hljs-type"><span class="hljs-type">CONFIGURE_ARGS</span></span> += \ --prefix=/ \ --sysconfdir=/etc/sphinx \ <span class="hljs-string"><span class="hljs-string">$(</span></span>if <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CONFIG_SPHINX_MYSQL_SUPPORT</span></span>),--with-mysql,--without-mysql) \ <span class="hljs-string"><span class="hljs-string">$(</span></span>if <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CONFIG_SPHINX_PGSQL_SUPPORT</span></span>),--with-pgsql,--without-pgsql) \ <span class="hljs-string"><span class="hljs-string">$(</span></span>if <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CONFIG_SPHINX_UNIXODBC_SUPPORT</span></span>),--with-unixodbc,--without-unixodbc) \ <span class="hljs-string"><span class="hljs-string">$(</span></span>if <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CONFIG_SPHINX_EXPAT_SUPPORT</span></span>),--with-libexpat,--without-libexpat) \ <span class="hljs-string"><span class="hljs-string">$(</span></span>if <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CONFIG_SPHINX_DYNAMIC_LOAD</span></span>),--enable-dl,,) \ --with-syslog \ --with-libstemmer define <span class="hljs-type"><span class="hljs-type">Package</span></span>/sphinx/install <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INSTALL_DIR</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>)/etc/sphinx <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INSTALL_DATA</span></span>) ./files/sphinx.conf <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>)/etc/sphinx/sphinx.conf <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INSTALL_DIR</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>)/etc/init.d <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INSTALL_BIN</span></span>) ./files/sphinx.init <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>)/etc/init.d/sphinx <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INSTALL_DIR</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>)/usr/sbin <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INSTALL_BIN</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_BUILD_DIR</span></span>)/src/searchd <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>)/usr/sbin/ <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INSTALL_BIN</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_BUILD_DIR</span></span>)/src/indexer <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>)/usr/sbin/ #     -   . # <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INSTALL_BIN</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_BUILD_DIR</span></span>)/src/indextool <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>)/usr/sbin/ # <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INSTALL_BIN</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">PKG_BUILD_DIR</span></span>)/src/spelldump <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>)/usr/sbin/ endef <span class="hljs-string"><span class="hljs-string">$(</span></span>eval <span class="hljs-string"><span class="hljs-string">$(</span></span>call <span class="hljs-type"><span class="hljs-type">BuildPackage</span></span>,sphinx))</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menu configuration</font></font></b> <div class="spoiler_text">    Config.in     Makefile   package/network/services/sphinx <br><pre> <code class="hljs pgsql"># sphinx config menu "Configuration" <span class="hljs-keyword"><span class="hljs-keyword">depends</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> PACKAGE_sphinx config SPHINX_DYNAMIC_LOAD <span class="hljs-type"><span class="hljs-type">bool</span></span> "Load all client libs for accessing sources dynamically" <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> y help This will force the sphinx <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> necessary db libs <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> actually <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> db sources (otherwize they will be linked statically <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> will be dependencies <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the sphinx package) config SPHINX_MYSQL_SUPPORT <span class="hljs-type"><span class="hljs-type">bool</span></span> "Enable indexing of mysql databases" <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> PACKAGE_libmysqlclient <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> n help This will build the sphinx <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> supporting <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> mysql db indexing. It will allow <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> use source <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=mysql, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">also</span></span> need libmysqlclient library <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>. config SPHINX_PGSQL_SUPPORT <span class="hljs-type"><span class="hljs-type">bool</span></span> "Enable indexing of posgresql databases" <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> PACKAGE_libpq <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> n help This will build the sphinx <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> supporting <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> posgresql db indexing. It will allow <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> use source <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=pgsql, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">also</span></span> need libpq library <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>. config SPHINX_UNIXODBC_SUPPORT <span class="hljs-type"><span class="hljs-type">bool</span></span> "Enable indexing of odbc sources" <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> PACKAGE_unixodbc <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> n help This will build the sphinx <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> supporting <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> indexing odbc sources. It will allow <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> use source <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=odbc, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">also</span></span> need unixodbc library <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>. config SPHINX_EXPAT_SUPPORT <span class="hljs-type"><span class="hljs-type">bool</span></span> "Enable indexing of xmlpipe sources" <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> PACKAGE_libexpat <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> n help This will build the sphinx <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> supporting <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> indexing xmlpipes. It will allow <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> use source <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=xmlpipe2, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">also</span></span> need libexpat library <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>. endmenu</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Init script</font></font></b> <div class="spoiler_text">    sphinx.init     package/network/services/sphinx/files (   ) <br><pre> <code class="hljs vbscript">#!/bin/sh /etc/rc.common # Copyright (C) <span class="hljs-number"><span class="hljs-number">2010</span></span><span class="hljs-number"><span class="hljs-number">-2011</span></span> OpenWrt.org START=<span class="hljs-number"><span class="hljs-number">95</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STOP</span></span>=<span class="hljs-number"><span class="hljs-number">10</span></span> SERVICE_STOP_TIME=<span class="hljs-number"><span class="hljs-number">9</span></span> #PREFIX=/opt PREFIX=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>() { echo <span class="hljs-string"><span class="hljs-string">"${initscript}:"</span></span> <span class="hljs-string"><span class="hljs-string">"$@"</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">2</span></span> } start() { $PREFIX/usr/sbin/searchd } <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span>() { $PREFIX/usr/sbin/searchd --<span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> }</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Config example</font></font></b> <div class="spoiler_text">    sphinx.conf     sphinx.init   package/network/services/sphinx/files <br>     ;          . <br><pre> <code class="hljs pgsql"># # Sphinx <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> library (clean, simple, functional) # source ltslibrary_src { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = mysql sql_host = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> sql_user = #wiped sql_pass = #wiped sql_db = my_lib sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">SET NAMES</span></span> utf8 sql_query = <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sphinx_main_index sql_joined_field = title <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> QUERY; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> all_titles_sphinx_un sql_attr_timestamp = entered sql_attr_uint = pages sql_attr_float = price sql_attr_float = thickness sql_attr_uint = crcyear sql_attr_string = year } <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> ltslib { source = ltslibrary_src <span class="hljs-type"><span class="hljs-type">path</span></span> = /mnt/sphinx/<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>/ltsidx preopen = <span class="hljs-number"><span class="hljs-number">1</span></span> morphology = lemmatize_ru_all, lemmatize_en_all, lemmatize_de_all, libstemmer_fr expand_keywords = <span class="hljs-number"><span class="hljs-number">1</span></span> index_exact_words = <span class="hljs-number"><span class="hljs-number">1</span></span> min_prefix_len = <span class="hljs-number"><span class="hljs-number">2</span></span> min_word_len = <span class="hljs-number"><span class="hljs-number">2</span></span> dict = keywords stopwords = /mnt/sphinx/stopwords-en.txt wordforms = /mnt/bigstore/library/sphinx/wordforms.txt } indexer { mem_limit = <span class="hljs-number"><span class="hljs-number">32</span></span>M } common { lemmatizer_base = /mnt/sphinx/aot } searchd { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> = localhost:<span class="hljs-number"><span class="hljs-number">9306</span></span>:mysql41 <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> = syslog query_log = syslog read_timeout = <span class="hljs-number"><span class="hljs-number">5</span></span> max_children = <span class="hljs-number"><span class="hljs-number">30</span></span> pid_file = /mnt/sphinx/searchd.pid max_matches = <span class="hljs-number"><span class="hljs-number">1000</span></span> seamless_rotate = <span class="hljs-number"><span class="hljs-number">1</span></span> preopen_indexes = <span class="hljs-number"><span class="hljs-number">0</span></span> unlink_old = <span class="hljs-number"><span class="hljs-number">1</span></span> workers = threads # <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> RT <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span> binlog_path = subtree_docs_cache = <span class="hljs-number"><span class="hljs-number">1</span></span>M subtree_hits_cache = <span class="hljs-number"><span class="hljs-number">1</span></span>M }</code> </pre></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, a couple of pre-built. </font></font><br> <a href="http://yadi.sk/d/ujIJ0bVzG7B5b"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sphinxsearch_2.2.2-4470-2_mipsel.ipk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for optware in dd-wrt, mipsel platform (LSB) </font></font><br> <a href="http://yadi.sk/d/fFFFvG_8G7AyE"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sphinx_2.2.2-2_ar71xx.ipk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> under openwrt on NetGear WNDR4300, platform mips (MSB).</font></font></div><p>Source: <a href="https://habr.com/ru/post/209184/">https://habr.com/ru/post/209184/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209166/index.html">String distribution and access to Teradata (Primary Index)</a></li>
<li><a href="../209170/index.html">"Data center for beginners" or criteria for evaluating the project of an effective data center</a></li>
<li><a href="../209178/index.html">Hole VKontakte, leakage of users' personal data</a></li>
<li><a href="../209180/index.html">Google Nexus 7 Review (2013)</a></li>
<li><a href="../209182/index.html">About stable data center wetting</a></li>
<li><a href="../209190/index.html">Microsoft, to the blackboard! Or what Office365 can learn from the editor on Canvas</a></li>
<li><a href="../209192/index.html">Overview of the market for providers of Windows VPS servers with a focus on disk I / O</a></li>
<li><a href="../209194/index.html">IBM Watson supercomputer will be a separate division of the corporation with a budget of $ 1 billion</a></li>
<li><a href="../209196/index.html">To implement an ERP system in production</a></li>
<li><a href="../209198/index.html">How I did a tester optimizer for finding profitable strategies on the stock exchange</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>