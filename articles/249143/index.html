<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automate and speed up the process of setting up cloud servers with Ansible. Part 1: Introduction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ansible is a popular tool for automating the configuration and deployment of IT infrastructure. 

 The main tasks that Ansible solves: 


- Configurat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automate and speed up the process of setting up cloud servers with Ansible. Part 1: Introduction</h1><div class="post__text post__text-html js-mediator-article">  Ansible is a popular tool for automating the configuration and deployment of IT infrastructure. <br><br>  The main tasks that Ansible solves: <br><ul><li>  <strong>Configuration management</strong> .  The fastest and correct setup of servers to the described configuration. </li><li>  <strong>Provisioning</strong> .  Managing the deployment of new cloud servers (for example, through an API, using Docker or LXC). </li><li>  <strong>Deploy</strong> .  Installing and updating your applications without downtime. </li><li>  <strong>Orchestration</strong> .  Coordinating components of your infrastructure for deployment.  For example, checking that the web server is disconnected from the load balancer before the software upgrade on the server. </li><li>  <strong>Monitoring and notifications</strong> . </li><li>  <strong>Logging</strong>  Centralized collection of logs. </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/f6a/816/c99/f6a816c9949a7f826f18a2993a12b031.png" width="200"><br><br>  Compared to other popular IT infrastructure automation tools, Ansible does not require installation of client applications on serviced servers, which can reduce setup time before infrastructure deployment.  To work Ansible connects to serviced servers via SSH. <br><a name="habracut"></a><br>  The importance of such tools only increases in the cloud with the advent of the ability to quickly create the necessary servers, deploy the necessary software, use and delete when the need has disappeared, paying only for the resources used.  In our article we will consider the main Ansible functionality in the context of practical use on cloud servers in <a href="http://infoboxcloud.ru/">InfoboxCloud</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>What we need to configure</b> </h4><br>  We hope that you already have an account on <a href="http://infoboxcloud.ru/">InfoboxCloud</a> .  If not yet, <a href="http://help.sandbox.infoboxcloud.ru/content/ru/cloud_infrastructure/order_cloud/order_cloud.html">create it</a> . <br><br>  For Ansible, we need a control server.  Create it (it is recommended to use Ubuntu 14.04 or CentOS 7).  Also create at least a couple of servers with Linux, which will be configured using Ansible.  Data for access to the servers will be sent to your email. <br><br>  Connect to the management server <a href="https://helpdesk.infobox.ru/Knowledgebase/Article/View/400/">via SSH</a> . <br><br><h4>  <b>Ansible installation</b> </h4><br><h5>  <b>Ubuntu 14.04 LTS</b> </h5><br>  To install, on the management server, enter: <br><pre><code class="bash hljs">apt-key update &amp;&amp; apt-get update &amp;&amp; apt-get -y upgrade &amp;&amp; apt-get -y install python-software-properties &amp;&amp; apt-get -y install software-properties-common &amp;&amp; apt-add-repository -y ppa:rquillo/ansible &amp;&amp; apt-get update &amp;&amp; apt-get -y install ansible</code> </pre> <br><h5>  <b>CentOS 7</b> </h5><br>  To install, on the management server, enter: <br><pre> <code class="bash hljs">yum -y update &amp;&amp; yum -y install epel-release &amp;&amp; yum -y install ansible</code> </pre><br><br><h4>  <b>How Ansible Works</b> </h4><br>  The main idea of ‚Äã‚ÄãAnsible is the presence of one or several control servers from which you can send commands or sets of consecutive instructions (playbooks) to remote servers by connecting to them via SSH. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/919/618/c14/919618c14318dea2144a0d1337779d72.jpg" width="800"><br>  The <strong>Host inventory</strong> file contains information about the serviced servers where the commands will be executed.  <strong>The</strong> Ansible <strong>configuration file</strong> can be useful for specifying the settings for your environment. <br><br>  <strong>Instructions (playbooks)</strong> consist of one or more tasks, which are described using the functionality of the Ansible kernel module or third-party modules that may be required in specific situations.  In itself, instruction sets are sequential sets of instructions in which conditions can be checked: if a condition is not met, certain instructions can be skipped. <br><br>  You can also use the <strong>Ansible API</strong> to run scripts.  If the wrapper script may need to launch a playbook, this can be done through the API.  The playbooks themselves are described declaratively in the <strong><a href="http://ru.wikipedia.org/wiki/YAML">YAML</a></strong> format.  Ansible supports deployment of new cloud servers and configuration based on <strong>roles</strong> .  Part of the work can be carried out in local mode on the management server, and the rest on the created server after its first boot.  Work is underway on the provisioning module for <a href="http://infoboxcloud.ru/">InfoboxCloud</a> . <br><br><h4>  <b>Ansible setting</b> </h4><br>  The configuration file is described in the <a href="http://en.wikipedia.org/wiki/INI_file">INI format</a> .  You can override some or all of the configuration in the playbook parameters or environment variables. <br>  When executing commands, Ansible checks for the presence of a configuration file in the following locations: <br><ol><li>  The environment variable ANSIBLE_CONFIG is checked, which may point to a configuration file. </li><li>  ./ansible.cfg - in the current directory </li><li>  ~ / .ansible.cfg - in your home directory </li><li>  /etc/ansible/ansible.cfg - in the directory generated during the installation of ansible via the package manager. </li></ol><br><h5>  <b>Setting through variable environments</b> </h5><br>  Most configuration parameters can be set via environment variables using the ANSIBLE_ prefix before the configuration parameter name (in capital letters). <br>  For example: <br>  export ANSIBLE_SUDO_USER = root <br>  After that, the variable ANSIBLE_SUDO_USER can be used in the playbook. <br><br><h5>  <b>Setup in ansible.cfg</b> </h5><br>  Ansible configuration options <a href="http://docs.ansible.com/intro_configuration.html">set</a> .  Let's look at some of them: <br><ul><li>  <strong>hostfile</strong> : The parameter points to the path to the <strong>inventory file</strong> , which contains a list of host addresses to which Ansible can connect. <br>  For example: <strong>hostfile = / etc / ansible / hosts</strong> </li><li>  <strong>library</strong> : Path to the directory where the Ansible modules are stored.  For example: <strong>library = / usr / share / ansible</strong> </li><li>  <strong>forks</strong> : The number of processes that Ansible can spawn.  The default is 5 processes. <br>  For example: <strong>forks = 5</strong> </li><li>  <strong>sudo_user</strong> : The default user from which Ansible runs commands on remote servers. <br>  For example: <strong>sudo_user = root</strong> </li><li>  <strong>remote_port</strong> : Port for an SSH connection (default is 22). <br>  For example: <strong>remote_port = 22</strong> </li><li>  <strong>host_key_checking</strong> : This parameter allows you to disable the SSH ‚Äì key check on the host.  By default, the check is performed. <br>  For example: <strong>host_key_checking = False</strong> </li><li>  <strong>timeout</strong> : The timeout value of the SSH connection attempt. <br>  For example: <strong>timeout = 60</strong> </li><li>  <strong>log_path</strong> : Path to store log files.  By default, Ansible does not store them at all, but by specifying this option, you can activate logging. <br>  For example: <strong>log_path = /var/log/ansible.log</strong> </li></ul><br><h5>  <b>Writing the first Ansible configuration file</b> </h5><br>  Let's create our first Ansible configuration file in InfoboxCloud.  Connect via SSH to the created management server with Ansible installed.  Create a directory for our experiments 'ansible' and go into it: <br><pre> <code class="bash hljs">mkdir ~/ansible <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/ansible</code> </pre><br>  Also create a folder for storing the Ansible modules and a folder for storing the logs: <br><pre> <code class="bash hljs">mkdir ~/ansible/modules mkdir ~/ansible/logs</code> </pre><br>  Create a file, ansible.cfg with the following contents: <br><pre> <code class="bash hljs">[defaults] hostfile = ~/ansible/inventory sudo_user = root log_path = ~/ansible/logs/ansible.log</code> </pre><br><h5>  <b>We specify serviced servers in host inventory</b> </h5><br>  For experiments, we created a couple of servers earlier, which we will configure.  It is necessary to inform Ansible of their addresses and group them.  To do this, create an inventory file in our ~ / ansible / inventory directory with the following contents: <br><pre> <code class="bash hljs">[experiments] ip__ ip__</code> </pre><br>  ip_address of servers can be viewed in the <a href="http://infoboxcloud.ru/">InfoboxCloud</a> control <a href="http://infoboxcloud.ru/">panel</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/df7/a4d/37e/df7a4d37e9cf0bdb960e642582f9d85d.jpg" width="800"><br>  Please note that to use the Ansible control server with servers in the same region, you can specify local IP addresses and work on the internal network. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f41/f00/68a/f41f0068ac6215d0a0b07c8b7461d4cf.jpg" width="400"><br><br>  You need to generate a key on the management server that will be used to access custom servers. <br>  This is done using the command: <br><pre> <code class="bash hljs">ssh-keygen</code> </pre><br>  For all questions, you can simply press Enter. <br><br>  Now you need to copy the public key to custom servers.  This can be done using the ssh-copy-id utility from the Ansible managing server for each configured server: <br><pre> <code class="bash hljs">ssh-copy-id root@ip___</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/89c/958/c30/89c958c300dade8a2d1555a99b4f5f8f.jpg" width="700"><br><br>  You can verify the correctness by logging into a custom server with a manager via SSH.  If the password is no longer asked - everything is in order. <br><br>  In <a href="http://infoboxcloud.ru/">InfoboxCloud,</a> you can create new servers with the public key already specified.  To do this, create a clean server.  Copy the public SSH key to it, as shown above.  Next, create an OS image: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e6d/5b8/297/e6d5b8297497112dd396683690e4a461.jpg" width="800"><br><br>  Now, in the ‚ÄúServer images‚Äù section of the control panel, you can, if necessary, click ‚ÄúCreate server‚Äù on our image and get the machine ready for configuration for Ansible. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f04/01b/467/f0401b467c5c97aa64b7846e288dc68c.jpg" width="800"><br><br>  Let's now check the correctness of Ansible settings completely. <br>  You can ping serviced servers: <br><pre> <code class="bash hljs">ansible experiments -m ping</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/ce3/3f0/b4c/ce33f0b4cc6faf5ae5a0cf2d343bcbcf.jpg" width="700"><br><br>  or send to echo "Hello World": <br><pre> <code class="bash hljs">ansible experiments -a <span class="hljs-string"><span class="hljs-string">"/bin/echo Hello, World!"</span></span></code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/95d/cad/3da/95dcad3da950dac562e2d140c9fca8ea.jpg" width="700"><br><br><h4>  <b>Configuration Management</b> </h4><br><h5>  <b>We work with playbooks</b> </h5><br>  Playbooks execution is one of the Ansible main tasks.  Playbooks contain task lists.  Each task inside Ansible uses a piece of module code.  The Playbooks themselves are described in YAML format, but the modules can be written in any programming language.  It is important that the format of the messages from the modules be in JSON. <br><br><h6>  <b>Yaml</b> </h6><br>  Playbook is written in YAML.  Let's look at the basic rules for writing YAML files. <br><br>  For Ansible, almost every YAML file starts with a list.  Each item in the list is a list of key-value pairs, often called a dictionary. <br><br>  All YAML files must begin with "---".  This is part of the YAML format and marks the beginning of the document. <br><br>  All list members must be equally spaced from the beginning of the line, and must begin with a space or "-".  Comments begin with "#". <br>  For example: <br><pre> <code class="bash hljs">--- <span class="hljs-comment"><span class="hljs-comment">#Message - Hosting ‚Äì Cloud</span></span></code> </pre><br>  The dictionary is presented in the form of "key:" (colon and space) "value": <br><pre> <code class="bash hljs">--- <span class="hljs-comment"><span class="hljs-comment">#Message site: habr blog: infobox</span></span></code> </pre><br>  If necessary, dictionaries can be presented in abbreviated form: <br><pre> <code class="bash hljs">--- <span class="hljs-comment"><span class="hljs-comment">#Comment {site: habr, blog: infobox}</span></span></code> </pre><br>  You can specify a logical value (true / false) like this: <br><pre> <code class="bash hljs">--- need_access: no use_service: yes file_conf: TRUE read_value: True kill_process: <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre><br>  Our entire example YAML file will look like this: <br><pre> <code class="bash hljs">--- <span class="hljs-comment"><span class="hljs-comment">#About blog site: habr blog: infobox must_read: True themes: - hosting - cloud - it - geeks brands: - infobox - infoboxcloud</span></span></code> </pre><br>  For variables, Ansible uses "{{var}}".  If the value after the colon begins with "{", then YAML will think it is to say. <br>  To use variables, you must enclose the brackets in quotes: <br><pre> <code class="bash hljs">word: <span class="hljs-string"><span class="hljs-string">"{{ variable }}"</span></span></code> </pre><br>  This is enough to start writing playbooks. <br><br><h6>  <b>Writing our first playbook</b> </h6><br>  Playbooks can consist of a list of serviced servers, user variables, tasks, handlers (handlers), etc.  Most configuration settings can be overridden in the playbook.  Each playbook consists of one or more actions (games) in the list. <br><br>  The goal of the game is to associate a group of hosts with predefined roles, represented as the Ansible task call. <br><br>  As an example, let's take a look at the nginx installation process. <br>  Create a directory where the playbooks will be stored: <br><pre> <code class="bash hljs">mkdir ~/ansible/playbooks</code> </pre><br>  Create a file setup_nginx.yml in the playbooks directory with the following contents: <br><pre> <code class="bash hljs">--- - hosts: experiments tasks: - name: Install nginx package apt: name=nginx update_cache=yes sudo: yes - name: Starting nginx service service: name=nginx state=started sudo: yes</code> </pre><br>  Let's look at the contents: <br><ul><li>  <strong>hosts</strong> : The list of hosts or group on which you run the task.  This field is required and every playbook must have one, with the exception of roles.  If a host group is specified, Ansible first searches for it in the playbook, and then in the inventory file.  You can find out which hosts will work on with the command: <code>ansible-playbook --list-host,  ‚Äì    playbook (playbooks/setup_nginx.yml). <br></code> <code>ansible-playbook --list-host,  ‚Äì    playbook (playbooks/setup_nginx.yml). <br></code> <br>  <strong>tasks</strong> : Tasks.  All playbooks contain tasks.  A task is a list of actions that you want to perform.  The task field contains the name of the task (task reference information for the playbook user), the module to be executed and the arguments required for the module.  The "name" parameter is optional, but recommended. <br></li><br><br>  Successful work! </ul></div><p>Source: <a href="https://habr.com/ru/post/249143/">https://habr.com/ru/post/249143/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249131/index.html">Three words that can change the world</a></li>
<li><a href="../249135/index.html">CLR bug: how to drag an object into a sandbox without marshalling and call a callback</a></li>
<li><a href="../249137/index.html">GHOST (dot) WEB: First Blood</a></li>
<li><a href="../249139/index.html">A brief course of computer graphics: we write a simplified OpenGL do it yourself, article 6 of 6</a></li>
<li><a href="../249141/index.html">Building crosswords using the Wolfram Language (Mathematica)</a></li>
<li><a href="../249145/index.html">2014 dotGo conference in Paris</a></li>
<li><a href="../249151/index.html">Free internet for tablet from Beeline and MTS</a></li>
<li><a href="../249155/index.html">Analytics for December, plans for a new iPhone, Roskomnadzor measures - and other news of the week for a mobile developer</a></li>
<li><a href="../249159/index.html">Apple fixed important OS X vulnerabilities</a></li>
<li><a href="../249163/index.html">Introduction to topological spaces. Java finite topology programming. Part 2: Base topology. Continuous display</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>