<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we set up Continuous Delivery at Kubernetes using TFS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue our journey to Continuous Delivery (CD) and High Availability (HA), based on redundancy. In the previous series, we translated the mobile ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we set up Continuous Delivery at Kubernetes using TFS</h1><div class="post__text post__text-html js-mediator-article"><p>  We continue our journey to Continuous Delivery (CD) and High Availability (HA), based on redundancy.  In the previous series, we <a href="https://habrahabr.ru/company/eastbanctech/blog/348590/">translated the mobile API to .NET Core</a> .  The next logical step to achieve the CD is to configure the assembly in the Docker container. </p><br><p>  Today we will share our getting-started guide on how to configure the build of docker images and deploy to Kubernetes in TFS for .NET developers. </p><br><p>  (It is assumed that by this time you have already migrated your ASP.NET application to an ASP.NET Core, and if not, read our <a href="https://habrahabr.ru/company/eastbanctech/blog/348590/">previous article</a> ). </p><br><p><img src="https://habrastorage.org/webt/31/sb/g4/31sbg4hscjrlzb9tv-lxoaighn0.jpeg"></p><a name="habracut"></a><br><h3 id="nastroyka-aspnet-prilozheniya-na-rabotu-s-docker">  Setting up an ASP.NET application to work with Docker </h3><br><ol><li>  In Visual Studio 2017, right-click on a web project -&gt; Add -&gt; Docker Support; </li><li>  For VS2015, you need to add an <a href="https://marketplace.visualstudio.com/items%3FitemName%3DMicrosoftCloudExplorer.VisualStudioToolsforDocker-Preview">extension</a> . </li><li>  The Dockerfile file is added to the project folder - this is the config for creating the image of our application. </li><li>  Read more about <a href="https://habrahabr.ru/post/346634/">Docker</a> here. </li><li>  A new <em>docker-compose</em> project will be added. </li><li>  By itself, <a href="https://docs.docker.com/compose/">docker-compose</a> is a utility for managing multi-container applications.  For example, you run the application and the DBMS to it. </li><li>  Files in the project: <br>  a.  <em>docker-compose.yml</em> - description of your services / dependencies. <br>  Here is an example of an ASP.NET application in conjunction with SQL Server: </li></ol><br><pre><code class="plaintext hljs">version: '3' services: agentrequests.webapp: image: agentrequests.webapp build: context: . dockerfile: AgentRequests.WebApp/Dockerfile depends_on: - agentrequests-db agentrequests-db: image: microsoft/mssql-server-linux environment: SA_PASSWORD: "&lt;YourStrong!Passw0rd&gt;1" ACCEPT_EULA: "Y" ports: - "1401:1433" volumes: - agent-requests-db-data:/var/opt/mssql volumes: agent-requests-db-data:</code> </pre> <br><p>  Service names (in the example database, agentrequests-db) can be used directly in your application, such as Server Side Service Discovery. </p><br><p>  For example, the connection string to the base is "Server = agentrequests-db; Database = AgentRequests; User = sa; Password = &lt;YourStrong! Passw0rd&gt; 1;" </p><br><p>  b.  <em>docker-compose.override.yml</em> - this file is used during development.  Visual Studio merges these files when you press F5. </p><br><p>  HINT: Each time docker-compose.yml changes, the application will be assigned a new local port, which quickly becomes boring during debugging.  Therefore, in docker-compose.override.yml it is useful to fix the port of your application: </p><br><pre> <code class="plaintext hljs">version: '3' services: agentrequests.webapp: environment: - ASPNETCORE_ENVIRONMENT=Development ports: - "40005:80"</code> </pre> <br><p>  c.  <em>docker-compose.ci.build.yml</em> - with this config you can crash your application on CI, and the result will be similar to the local build.  This file is needed if you simply deploy ready files, for example, in IIS.  We are going to supply ready-made docker images and will use Dockerfile directly. </p><br><p>  The intermediate result: we do the docker-compose project starting, we press F5 and we rejoice. <br>  NOTE: The first launch may be long, since the docker needs to download the SQL / ASP.Net Core images. </p><br><p>  Also, when debugging, Visual Studio does not create a new docker-image each time the application code changes - in fact, only one container is created from your Dockerfile to which the folder with your sources on the host machine is mounted.  Thus, every change, for example, js-file, will instantly affect even the running container. </p><br><h3 id="sborka-i-deploy-docker-obrazov-v-tfs">  Build and Deploy Docker Images in TFS </h3><br><p>  CI assumes that we have a build machine for performing automated builds independently of the developer.  Developers upload their changes to the version control system, the build machine takes the latest changes and recompiles the project.  Thus, the build machine should have all the necessary tools for building the project.  In our case, it must have access to the Docker in order to build Docker images. </p><br><p>  There are several options: </p><br><ol><li><p>  We can deliver Docker directly to a build machine or remotely connect to Docker on another machine via the Docker client.  Initially, we had a standard .Net development on Windows, so all the build machines were Windows virtual machines with one or more build agents.  So that Docker can build Linux containers on a Windows machine, the docker installs a Linux virtual machine.  It turns out that we will have several virtual machines nested in each other.  But I don‚Äôt want to start fussing, and Docker <a href="https://docs.docker.com/docker-for-windows/troubleshoot/">doesn‚Äôt</a> officially <a href="https://docs.docker.com/docker-for-windows/troubleshoot/">support</a> this mode. </p><br></li><li><p>  To connect to Docker on another machine, you need to configure <a href="https://docs.docker.com/engine/reference/commandline/dockerd/">remote access</a> , by default it is turned off.  It is also recommended to ensure the <a href="https/">security of TLS certificates</a> .  There is also a <a href="https://docs.microsoft.com/ru-ru/virtualization/windowscontainers/management/manage_remotehost">manual from Microsoft</a> , which offers a simplified configuration option using a windows container preloaded with LibreSSL. </p><br></li><li><p>  The easiest way: you can run the build agent directly in the Docker container, and it will have access to the Docker that is running.  Simply select the desired container from the <a href="https://hub.docker.com/u/microsoft/">microsoft</a> / <a href="https://hub.docker.com/r/microsoft/vsts-agent/">vsts-agent</a> repository. </p><br></li></ol><br><h3 id="nastroyka-bild-agenta">  Setting up the build agent </h3><br><ol><li>  <a href="https://hub.docker.com/r/microsoft/vsts-agent/">Download</a> build agent. </li><li>  About the differences in the versions of images and parameters can be found <a href="https://github.com/Microsoft/vsts-agent-docker">here</a> . </li><li>  You need a version with docker on board, for example: <br>  docker pull microsoft / vsts-agent: ubuntu-16.04-tfs-2017-u1-docker-17.12.0-ce </li><li>  Generate Personal Access Token (PAT) on the TFS Security page: <br><br><img src="https://habrastorage.org/webt/zs/sr/zf/zssrzfhqc6agl55asetshvtqc2o.png"></li><li>  You can add a new Agent Pool for docker assemblies.  This is done here: <br><br><img src="https://habrastorage.org/webt/8s/qv/t8/8sqvt8gq8u5vnkxtgtwa8uzo9ys.png"></li><li>  We start the container: <br><pre> <code class="bash hljs">docker run \ -e TFS_URL=&lt;YOUR_TFS_URL&gt; \ -e VSTS_TOKEN=&lt;PAT&gt; \ -e VSTS_POOL=&lt;POOL&gt; \ -e VSTS_AGENT=$(hostname)-agent \ -v /var/run/docker.sock:/var/run/docker.sock \ --restart=always \ -it microsoft/vsts-agent:ubuntu-16.04-tfs-2017-u1-docker-17.12.0-ce</code> </pre> </li></ol><br><h3 id="nastroyka-ci">  CI Setup </h3><br><ol><li>  In the project in TFS we add a new Build Definition with a template - Container (PREVIEW) </li><li>  Taska build image: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      a.  Container Registry Type - Container Registry; <br>  b.  Docker Registry Connection - here we set up the path to your image registry.  You can use the Docker Hub, but we in the company use the Nexus Registry; <br>  c.  Docker File - the path to the docker file.  It is better to specify the path clearly, without a mask; <br>  d.  Use Default Build Context - uncheck; <br>  e.  Build Context - the path to the folder where your .sln file is located; <br>  f.  Image-name - it is better to set it explicitly, all the characters in lower case.  Example: groups / agent-requests: $ (Build.BuildId); <br>  g.  You can put include latest tag - the latest tag in the registry will be updated. </li><li>  Push an image - similar to the second paragraph.  The main thing is not to forget to change the image name. </li><li>  Add a tusk with Publish Build Artifacts template.  Since we are planning to deploy to kubernetes, our artifact will be the config for kubectl: <br><br>  a.  Path to Publish - the path to your yaml file with the kubernetes config.  You can specify a folder if there are several configs; <br>  b.  Artifact Name - to your taste.  For example, kubernetes; <br>  c.  Artifact Type - Server. </li></ol><br><h3 id="nastroyka-cd-i-kubernetes">  CD and Kubernetes Setup </h3><br><p>  At first, a small digression.  Roughly speaking, docker-compose (swarm) is a competitor to kubernetes.  But since VS does not have a convenient tuling for build and debug in kubernetes, we use both options: compose when developing, kubernetes in combat. </p><br><p>  The good news is that there is a utility <a href="http://kompose.io/">Kompose</a> - it can convert Kubernetes configs to / from docker-compose.yaml files. </p><br><p>  However, it is not necessary for a developer to use docker / compose in general - you can configure everything in the old manner and use your hands to change urls / configs or store ten web.config for different environments. </p><br><div class="spoiler">  <b class="spoiler_title">Example service.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">apiVersion: v1 kind: Service metadata: name: webapp spec: type: LoadBalancer selector: app: webapp ports: - port: 80  deployment.yaml: apiVersion: extensions/v1beta1 kind: Deployment metadata: name: webapp spec: replicas: 1 template: metadata: labels: app: webapp spec: imagePullSecrets: - name: &lt;   Docker Registry&gt; containers: - image: webapp name: webapp env: - name: DB_USER valueFrom: secretKeyRef: name: database-secret key: username - name: DB_PASSWORD valueFrom: secretKeyRef: name: database-secret key: password - name: SQLCONNSTR_&lt;  &gt; # SQLCONNSTR_DefaultConnection value: "Server=&lt; SQL &gt;;Initial Catalog=&lt; &gt;;Persist Security Info=False;User ID=$(DB_USER);Password=$(DB_PASSWORD);" ports: - containerPort: 80</code> </pre> </div></div><br><p>  To configure the CD, we used the <a href="https://marketplace.visualstudio.com/items%3FitemName%3Dtsuyoshiushio.k8s-endpoint">Kubernetes extension</a> for our TFS server, since the standard Deploy to Kubernetes task, which comes out of the box, turned out to be inactive in our version of TFS. </p><br><ol><li><p>  Add connection settings to our Docker Registry in Kubernetes <br><br></p><br><pre> <code class="bash hljs">kubectl create secret docker-registry\ &lt;   Docker Registry&gt;\ --docker-server=&lt; &gt;\ --docker-username=&lt;&gt;\ --docker-password=&lt;&gt;\ --docker-email=&lt;&gt;</code> </pre> <br></li><li><p>  Add login and password to connect to the database </p><br><pre> <code class="bash hljs">kubectl create secret generic database-secret\ --from-literal=username=&lt;&gt;\ --from-literal=password=&lt;&gt;</code> </pre> <br><p>  Note: Steps 1 and 2 can also be automated via TFS. </p><br></li><li><p>  Add Kubernetes endpoint to TFS: <br><br><img src="https://habrastorage.org/webt/b_/g8/ob/b_g8ob6ifjo2ynohpozqb4ym-mg.png"><br><img src="https://habrastorage.org/webt/eq/pz/qc/eqpzqcqein5sxc5ueynjh9hqw1i.png"></p><br></li><li><p>  Create a new Release Defenition: <br><br>  a.  Select a project and Build definition <br>  b.  Tick ‚Äã‚ÄãContinuous deployment <br><img src="https://habrastorage.org/webt/me/kj/y5/mekjy5i407wt0qiutzy-qyo_tzs.png"></p><br></li><li><p>  Add a kasu kubernetes downloader: <br><br>  a.  In the ‚Äúkubernetes end point‚Äù field, select your kubernetes endpoint <br>  b.  In the ‚Äúkubectl download version‚Äù field, specify the required version or leave the field blank, in which case the latest version of the client will be installed. <br><br><img src="https://habrastorage.org/webt/kf/vv/7o/kfvv7ov4l_nsykmz-0g74hje75a.png"></p><br></li><li><p>  Add the kaspek exec task: <br><br>  a.  In the field ‚ÄúSub Command‚Äù we write: apply <br>  b.  In the field ‚ÄúArguments‚Äù we write: -f $ (System.DefaultWorkingDirectory) / &lt;path to the folder with configs&gt; /deployment.yaml <br><br><img src="https://habrastorage.org/webt/n5/l-/xu/n5l-xuhvm3vcluwklo8kdd3sdhm.png"></p><br></li><li><p>  Add the kaspek exec task: <br><br>  a.  In the field ‚ÄúSub Command‚Äù we write: apply <br>  b.  In the field ‚ÄúArguments‚Äù we write: image -f $ (System.DefaultWorkingDirectory) / &lt;path to the folder with configs&gt; /service.yaml </p><br></li><li><p>  Add the kaspek exec task: <br><br>  a.  In the ‚ÄúSub Command‚Äù field we write: set <br>  b.  In the field ‚ÄúArguments‚Äù we write: image -f $ (System.DefaultWorkingDirectory) / &lt;path to the folder with configs&gt; /deployment.yaml webapp = webapp: $ (Build.BuildID) </p><br></li></ol><br><h3 id="itogi">  Results </h3><br><p>  Behind this all.  Use docker, automate the deployment and enjoy a light release even on a Friday night, even before your vacation. </p><br><div class="spoiler">  <b class="spoiler_title">Finally, a few links that we found very useful.</b> <div class="spoiler_text"><ul><li>  <a href="https://store.docker.com/editions/community/docker-ce-desktop-windows">Docker Community Edition for Windows</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/337626/">DevOps with Kubernetes and VSTS</a> </li><li>  <a href="https://blogs.msdn.microsoft.com/wasimbloch/2017/01/23/setting-up-kubernetes-on-windows10-laptop-with-minikube/">Setting up Kubernetes on Windows10 Laptop with Minikube</a> </li><li>  <a href="https://www.youtube.com/watch%3Fv%3Dngcigr_8oxw">ASP.NET Core Linux Applications in Production</a> </li></ul><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/349510/">https://habr.com/ru/post/349510/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349496/index.html">Conduit - lightweight service mesh for Kubernetes</a></li>
<li><a href="../349500/index.html">How many developers and how few programmers ...</a></li>
<li><a href="../349502/index.html">Zane Lackey: ‚ÄúYou should not invest in security, just to meet the requirements of the law‚Äù</a></li>
<li><a href="../349504/index.html">tdlib-ruby: how to build a telegram client in ruby</a></li>
<li><a href="../349508/index.html">Java time machine</a></li>
<li><a href="../349512/index.html">Browser! = Browser engine</a></li>
<li><a href="../349514/index.html">Announcement of Serverless Moscow Meetup # 1</a></li>
<li><a href="../349516/index.html">Dagaz: Faster, Better, Smarter ...</a></li>
<li><a href="../349518/index.html">A new version of RMM-solution Panda Systems Management has been released.</a></li>
<li><a href="../349520/index.html">What it is - BPM, and how companies build it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>