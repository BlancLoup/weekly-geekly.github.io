<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuration Management</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Topic spawned human laziness :) 
 Many times we had to deal with the situation when you need to change a parameter that appears in several configs at ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuration Management</h1><div class="post__text post__text-html js-mediator-article">  Topic spawned human laziness :) <br>  Many times we had to deal with the situation when you need to change a parameter that appears in several configs at once, for example, the ip address of the interface.  And, as it is logical to guess, remembering ‚Äúimmediately‚Äù what files it turned out to be difficult. <br>  The idea is not new and is based on the use of templates;  language is ruby. <br><a name="habracut"></a><br>  I decided to choose <a href="http://ru.wikipedia.org/wiki/Xml">XML</a> as the type of the original configuration file, it is quite good for this;  You can look towards <a href="http://ru.wikipedia.org/wiki/Yaml">YAML</a> and others. <br><pre>  &lt;xml&gt;
   &lt;config name = 'rc.conf'&gt;
   &lt;interfaces&gt;
     &lt;iface name = 're0' tag = 'internal'&gt;
     &lt;ip&gt; 172.16.0.1 &lt;/ ip&gt;
     &lt;netmask&gt; 255.255.255.240 &lt;/ netmask&gt;
     &lt;media&gt; 1000baseTX &lt;/ media&gt;
     &lt;mediaopt&gt; full-duplex &lt;/ mediaopt&gt;
     &lt;opts&gt; polling &lt;/ opts&gt;
     &lt;/ iface&gt;
     &lt;iface name = 're1' tag = 'external'&gt;
       &lt;ip&gt; 172.16.0.17 &lt;/ ip&gt;
       &lt;netmask&gt; 255.255.255.228 &lt;/ netmask&gt;
     &lt;/ iface&gt;
     &lt;iface name = 'fxp0'&gt;
       &lt;dhcp&gt; true &lt;/ dhcp&gt;
       &lt;opts&gt; polling &lt;/ opts&gt;
     &lt;/ iface&gt;
     &lt;alias iface = 're0' num = '0'&gt;
       &lt;ip&gt; 10.0.0.1 &lt;/ ip&gt;
       &lt;netmask&gt; 255.255.255.0 &lt;/ netmask&gt;
     &lt;/ alias&gt;
     &lt;cloned&gt;
       vlan101
       vlan110
       vlan111
     &lt;/ cloned&gt;
   &lt;/ interfaces&gt;
   &lt;/ config&gt;
 &lt;/ xml&gt; </pre><br>  Parse faster using <a href="http://libxml.rubyforge.org/">LibXML</a> , and chose it.  As an analogue, you can consider <a href="http://www.ruby-doc.org/stdlib/libdoc/rexml/rdoc/index.html">REXML</a> or a ready-made alternative to <a href="http://xml-simple.rubyforge.org/">XmlSimple</a> , which creates a hash from an xml-file, but this will be slower, this point will be discussed below. <br>  For work with templates I chose <a href="http://www.kuwata-lab.com/erubis/">erubis</a> . <br>  According to the tests, he seems to be <a href="http://raa.ruby-lang.org/project/eruby/">faster than</a> <a href="http://www.ruby-doc.org/stdlib/libdoc/erb/rdoc/index.html">ERB</a> and <a href="http://raa.ruby-lang.org/project/eruby/">eruby</a> . <br><br>  Actually the code itself: <br><pre>  require 'rubygems'
 require 'erubis'
 require 'xml'

 def xml2hash (xml = nil)
   raise "missed 'xml' param" if xml.nil?

   v = [];  h = {}

   loop do
     xml.read
     break if (xml.node_type == XML :: Reader :: TYPE_END_ELEMENT || xml.empty_element?)
     if (xml.node_type == XML :: Reader :: TYPE_ELEMENT)
       name = xml.name
       h [name] || = []
       attrib = {}
       if (xml.attribute_count&gt; 0) then
         count = xml.attribute_count
         while (count&gt; 0) do
           count - = 1
           xml.move_to_attribute (count)
           attrib.merge! ({xml.name =&gt; xml.value})
         end
       end
       r = xml2hash (xml)
       case r
         when Hash
           r.merge! (attrib) unless attrib.empty?
           h [name] .push (r)
         when Array
           h [name] .push (attrib) unless attrib.empty?
           h [name] .push (* r)
         else
           h [name] .push (attrib) unless attrib.empty?
           h [name] .push (r)
       end unless r.nil?
     elsif (xml.node_type == XML :: Reader :: TYPE_TEXT &amp;&amp;! xml.value.nil?)
       xml.value.split ("\ n"). each {| i |  i.gsub! (/ ^ \ s *? (\ S +) \ s * $ /, '\ 1');  v.push (i) unless (i.empty? || i = ~ / ^ \ s * $ /);  }
     end
   end

   r = []
   r.push (h) unless (h.nil? || h.empty?)
   r.push (* v) unless (v.nil? || v.empty?)
   return * r

   rescue =&gt; e
     puts "# {e.class}: # {e} (method: xml2hash)"

 end

 begin
   xml = XML :: Reader.file ('params.xml')
   r = xml2hash (xml)
   xml.close

   r ['xml']. first ['config']. each do | i |
     template = File.read (i ['name'] + ".eruby")
     eruby = Erubis :: Eruby.new (template)
     File.open (i ['name'], "w") {| file |  file.puts eruby.evaluate ({: list =&gt; i})}
   end
	
   rescue =&gt; e
     puts "# {e.class}: # {e} (method: main)"
 end </pre><br>  I will not describe the code in detail, I will say only that the recursive method call xml2hash is used - if the beginning of the block, then we fall deeper, if the end of the block or further empty element / block, then return above. <br>  The template file is config_name from xml + '.eruby', i.e.  in my case rc.conf.eruby. <br>  The output is done in config_name (rc.conf). <br><br>  Template content: <br> <code>&lt;% for item in @list['interfaces'].first['iface'] %&gt; <br> ifconfig_&lt;%= item['name'] %&gt;="&lt;% unless item['dhcp'] %&gt;inet &lt;%= item['ip'].first %&gt; netmask &lt;%= item['netmask'].first %&gt;&lt;% else %&gt;DHCP&lt;% end %&gt;&lt;% unless (item['media'].nil? || item['media'].empty?) %&gt; media &lt;%= item['media'].first %&gt;&lt;% end %&gt;&lt;% unless (item['mediaopt'].nil? || item['mediaopt'].empty?) %&gt; mediaopt &lt;%= item['mediaopt'].first %&gt;&lt;% end %&gt;&lt;% unless (item['opts'].nil? || item['opts'].empty?) %&gt; &lt;%= item['opts'].first %&gt;&lt;% end %&gt;" <br> &lt;% end %&gt; <br> &lt;% for item in @list['interfaces'].first['alias'] %&gt; <br> ifconfig_&lt;%= item['iface'] %&gt;_alias&lt;%= item['num'] %&gt;="inet &lt;%= item['ip'].first %&gt; netmask &lt;%= item['netmask'].first %&gt;" <br> &lt;% end %&gt; <br> &lt;% if @list['interfaces'].first.key?('cloned') &amp;&amp; !@list['interfaces'].first['cloned'].empty? %&gt;cloned_interfaces="&lt;%= @list['interfaces'].first['cloned'].join(' ') %&gt;"&lt;% end %&gt;</code> <br>  Yes, it looks somewhat unreadable, but it is only at first glance :) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As promised, let's move on to the tests 'code above' vs XmlSimple. <br>  xml_test.rb: <br><pre>  require 'rubygems'
 require 'xml'
 require 'benchmark'

 def xml2hash (xml = nil)
   # method definition see above
 end

 begin
   xml = ""
   Benchmark.bm do | x |
     x.report {100.times do
       xml_read = XML :: Reader.file ('params.xml')
       xml = xml2hash (xml_read)
       xml_read.close 
     end}
   end
   p xml

   rescue =&gt; e
     puts "# {e.class}: # {e} (method: main)"
 end </pre><br><br><pre>  ezhik @ pollux: ~ $ time ruby ‚Äã‚Äãxml_test.rb 
       user system total real
   0.210000 0.010000 0.220000 (0.253391)
 {"xml" =&gt; [{"config" =&gt; [{"name" =&gt; "rc.conf", "interfaces" =&gt; [{"alias" =&gt; [{"netmask" =&gt; ["255.255.255.0 "]," num "=&gt;" 0 "," ip "=&gt; [" 10.0.0.1 "]," iface "=&gt;" re0 "}]," iface "=&gt; [{" name "=&gt;" re0 "," netmask "=&gt; [" 255.255.255.240 "]," opts "=&gt; [" polling "]," tag "=&gt;" internal "," mediaopt "=&gt; [" full-duplex "]," media "=&gt; [" 1000baseTX "]," ip "=&gt; [" 172.16.0.1 "]}, {" name "=&gt;" re1 "," netmask "=&gt; [" 255.255.255.228 "]," tag "= &gt; "external", "ip" =&gt; ["172.16.0.17"]}, {"name" =&gt; "fxp0", "opts" =&gt; ["polling"], "dhcp" =&gt; ["true"] }], "cloned" =&gt; ["vlan101", "vlan110", "vlan111"]}]}]}]}

 real 0m0.447s
 user 0m0.344s
 sys 0m0.036s </pre><br><br>  xml_simple.rb: <br><pre>  require 'rubygems'
 require 'xmlsimple'
 require 'benchmark'

 xml = ""
 Benchmark.bm do | x |
   x.report {100.times do
     xml = XmlSimple.xml_in ('params.xml')
   end}
 end
 p xml </pre><br><br><pre>  ezhik @ pollux: ~ $ time ruby ‚Äã‚Äãxml_simple.rb 
       user system total real
   1.770000 0.100000 1.870000 (1.956282)
 {"config" =&gt; [{"name" =&gt; "rc.conf", "interfaces" =&gt; [{"alias" =&gt; [{"netmask" =&gt; ["255.255.255.0"], "num" = &gt; "0", "ip" =&gt; ["10.0.0.1"], "iface" =&gt; "re0"}], "iface" =&gt; [{"netmask" =&gt; ["255.255.255.240"], " name "=&gt;" re0 "," opts "=&gt; [" polling "]," tag "=&gt;" internal "," mediaopt "=&gt; [" full-duplex "]," media "=&gt; [" 1000baseTX " ], "ip" =&gt; ["172.16.0.1"]}, {"netmask" =&gt; ["255.255.255.228"], "name" =&gt; "re1", "tag" =&gt; "external", "ip "=&gt; [" 172.16.0.17 "]}, {" name "=&gt;" fxp0 "," opts "=&gt; [" polling "]," dhcp "=&gt; [" true "]}]," cloned "= &gt; ["\ n vlan101 \ n vlan110 \ n vlan111 \ n"]}]}]}

 real 0m2.279s
 user 0m2.012s
 sys 0m0.124s </pre><br><br>  Yes, this is exactly what the hash looks like on the output after parsing xml. <br>  Although there is a time difference, but I think it is not so critical for this task, so the choice is yours. <br><br>  As a result, the output I got: <br><pre>  ifconfig_re0 = "inet 172.16.0.1 netmask 255.255.255.240 media 1000baseTX mediaopt full-duplex polling"
 ifconfig_re1 = "inet 172.16.0.17 netmask 255.255.255.228"
 ifconfig_fxp0 = "DHCP polling"
 ifconfig_re0_alias0 = "inet 10.0.0.1 netmask 255.255.255.0"
 cloned_interfaces = "vlan101 vlan110 vlan111" </pre><br><br>  The end. </div><p>Source: <a href="https://habr.com/ru/post/73258/">https://habr.com/ru/post/73258/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../73250/index.html">Apple closes open source ZFS project</a></li>
<li><a href="../73251/index.html">Browsera - a new site testing tool</a></li>
<li><a href="../73253/index.html">Google Wave - distribution of invites has begun!</a></li>
<li><a href="../73255/index.html">Troll Control</a></li>
<li><a href="../73257/index.html">Gateway + Shaper for Ubuntu's Home Network</a></li>
<li><a href="../73263/index.html">One step to the perfect team</a></li>
<li><a href="../73265/index.html">Daos. New advertising engine for sites</a></li>
<li><a href="../73266/index.html">REPL WebPart for SharePoint</a></li>
<li><a href="../73268/index.html">Create an image of Windows XP SP3 for deployment over the network via WDS</a></li>
<li><a href="../73269/index.html">Are you already on Google Wave?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>