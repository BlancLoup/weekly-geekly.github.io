<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I wrote my own ERP system and what came of it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I was approached by an acquaintance, the owner of one of the branches of a large network for the delivery of sushi and pizzas. Their cur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I wrote my own ERP system and what came of it</h1><div class="post__text post__text-html js-mediator-article">  Some time ago I was approached by an acquaintance, the owner of one of the branches of a large network for the delivery of sushi and pizzas.  Their current ERP did not suit him at all, since there was no control over the kitchen and the delivery men, and since he has 5 kitchens in the city, this was a serious problem.  He suggested that I write a new system for it. <a name="habracut"></a>  The only condition is that since he was in a franchise, and especially with golovnikov, he did not want to spoil relations, it is necessary to integrate with the existing system as covertly as possible. <br><br>  The first question I have is the development tool.  It was possible to take something new-fashioned NodeJS type for the server, and to give the web-interface to the clients - the easiest, but the most brake version (similar solutions require i3).  You can register separately the server part, separately each application (windows / android / ios).  Or NodeJS server, and C # (xamarin if more precisely) for all clients a single code.  Or take the latest Rad studio and write everything on a single code base.  Since I understood that different code describing the same things is a potential problem, and that I will be working on the project alone, I chose the latter option. <br><br>  The second question is architecture.  You can quickly type components on the form, with pens or through LiveBindings, to link everything together, and quickly get the result.  But any small change in some algorithm requires rebuilding and updating of all programs, and this is a big time cost for testing, so that in another place nothing will break.  So I decided to use xml to describe all the tables and interfaces, and remove all the logic in the scripts. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To do this, I wrote my own form editor, through RTTI I turned to all the properties and sub-properties. <br><br><img src="https://habrastorage.org/webt/q4/d_/un/q4d_ungpmpb62qlt2nmhmdj-0vm.jpeg" alt="image"><br><br>  The screenshot shows that the element is associated with the Orders table, but does not display its contents, but a link to the customer, the FirstName column (customer name).  Also, when clicked, the atApplyChanges handler will be called, which will apply all changes on the form and close it.  Without a single line of code!  Naturally, when something changes in the Orders table, a script is called that checks the correctness of the change.  Something like: <br><br><div class="spoiler">  <b class="spoiler_title">Little script</b> <div class="spoiler_text"><pre><code class="delphi hljs">CurOrderState := GetNewValueF(<span class="hljs-string"><span class="hljs-string">'Orders'</span></span>,<span class="hljs-string"><span class="hljs-string">'OrderState'</span></span>); LastOrderState := GetOldValueF(<span class="hljs-string"><span class="hljs-string">'Orders'</span></span>,<span class="hljs-string"><span class="hljs-string">'OrderState'</span></span>); IsCashbackOnCurier := GetNewValue(<span class="hljs-string"><span class="hljs-string">'Orders'</span></span>,<span class="hljs-string"><span class="hljs-string">'CashbackOnDeliverer'</span></span>) = <span class="hljs-string"><span class="hljs-string">'True'</span></span>; PayType := GetNewValueF(<span class="hljs-string"><span class="hljs-string">'Orders'</span></span>,<span class="hljs-string"><span class="hljs-string">'PayType'</span></span>); OldPayType := GetOldValueF(<span class="hljs-string"><span class="hljs-string">'Orders'</span></span>,<span class="hljs-string"><span class="hljs-string">'PayType'</span></span>); OrderTurn := GetNewValueF(<span class="hljs-string"><span class="hljs-string">'Orders'</span></span>,<span class="hljs-string"><span class="hljs-string">'Turn'</span></span>); CurTurn := GetConstantValue(<span class="hljs-string"><span class="hljs-string">'CurrentTurn'</span></span>); OrderNo := GetNewValue(<span class="hljs-string"><span class="hljs-string">'Orders'</span></span>,<span class="hljs-string"><span class="hljs-string">'OrderNo'</span></span>); OrderPrice := GetNewValueF(<span class="hljs-string"><span class="hljs-string">'Orders'</span></span>,<span class="hljs-string"><span class="hljs-string">'Price'</span></span>); PaySum := GetNewValueF(<span class="hljs-string"><span class="hljs-string">'Orders'</span></span>,<span class="hljs-string"><span class="hljs-string">'PaySum'</span></span>); LastPaySum := GetOldValueF(<span class="hljs-string"><span class="hljs-string">'Orders'</span></span>,<span class="hljs-string"><span class="hljs-string">'PaySum'</span></span>); CurTurn := GetConstantValue(<span class="hljs-string"><span class="hljs-string">'CurrentTurn'</span></span>); CurCashbox := GetConstantValue(<span class="hljs-string"><span class="hljs-string">'CurrentCashbox'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OrderTurn &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (OrderTurn &lt;&gt; CurTurn) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(<span class="hljs-string"><span class="hljs-string">'      .  ‚Ññ'</span></span>+IntToStr(OrderNo)); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LastOrderState = <span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(<span class="hljs-string"><span class="hljs-string">'     '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LastOrderState = <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(<span class="hljs-string"><span class="hljs-string">'     '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LastOrderState &lt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (CurOrderState = <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> TransactionCanAccept; <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CurOrderState &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (CurTurn &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(<span class="hljs-string"><span class="hljs-string">'  .     '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CurOrderState &gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (CurCashbox &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (CurOrderState &lt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(<span class="hljs-string"><span class="hljs-string">'  .     '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  ,     . if IsCashbackOnCurier then begin if PaySum &lt;&gt; LastPaySum then begin ShowMessage('    '); exit; end; Price := GetNewValueF('Orders','Price'); LastPrice := GetOldValueF('Orders','Price'); if Price &lt;&gt; LastPrice then begin ShowMessage('    '); exit; end; end; //   if (CurOrderState &gt;= 6) and (CurOrderState &lt; 8) and (PayType = 1) and (not IsCashbackOnCurier) then begin if (PaySum - OrderPrice) &gt; 0 then begin ss := '    ‚Ññ'+IntToStr(OrderNo); CreateCashboxDoc(ss,1,OrderPrice - PaySum); IsCashbackOnCurier := True; SetValue('Orders','CashbackOnDeliverer',True); end; end; //      if (CurOrderState &lt; 6) and IsCashbackOnCurier then begin if (PaySum - OrderPrice) &gt; 0 then begin CreateCashboxDoc('     ‚Ññ'+IntToStr(OrderNo),1,PaySum - OrderPrice); IsCashbackOnCurier := False; SetValue('Orders','CashbackOnDeliverer',False); end; end; //    if (CurOrderState &gt;= 8) and IsCashbackOnCurier then begin if (PaySum - OrderPrice) &gt; 0 then begin ss := '    ‚Ññ'+IntToStr(OrderNo); CreateCashboxDoc(ss,1,PaySum - OrderPrice); IsCashbackOnCurier := False; SetValue('Orders','CashbackOnDeliverer',False); end; end; //      if (CurOrderState = 9) and (LastOrderState &lt;&gt; 9) and (PayType = 1) then begin ss := '    ‚Ññ'+IntToStr(OrderNo); CreateCashboxDoc(ss,2,OrderPrice); end; //           if (LastOrderState &lt; 3) and (CurOrderState &gt;= 3) then begin if CurTurn &lt;= 0 then begin ShowMessage('  .    .'); exit; end; SetValue('Orders','Turn',CurTurn); CurFilial := GetConstantValue('FilialID'); SetValue('Orders','Filial',CurFilial); end; if (CurOrderState &lt;= 2) and (LastOrderState &gt; 2) then begin SetValue('Orders','Turn',0); end; TransactionCanAccept;</span></span></code> </pre> <br></div></div><br>  That is, there will be a check of the shift, the ticket office, if necessary, the wards / consumables will be discharged, etc.  Also, if you change something in this algorithm, you do not need to re-recompile the program and update everything everywhere.  Enough for the client to re-sign. <br><br>  The next point, which is incredibly annoying in all current decisions, is latency.  Any action results in a select from the base.  Those.  ping time + packet transfer + select + gzip is the minimum time after which something will happen for the operator.  And when the holidays and not only that the increased load on the operator and even the server begins to slow down, this is where the real monetary losses begin.  To prevent this from happening, I cached all the necessary data in RAM, and fetched it from there through requests.  The server is strained only by update / insert transactions, and then it sends new and updated data to all subscribers. <br><br>  With the display of information, I also had to make some interesting optimization.  Since we do not have a select from 10 tables, how, for example, from the table of delivery details, find out where to take the order (my point is stored in the FIAS house table)?  Like this: <br><br><pre> <code class="delphi hljs"> fids := CComponentBaseLink.ClassGetPrintValue(<span class="hljs-string"><span class="hljs-string">'Orders_Delivery_Details'</span></span>,<span class="hljs-string"><span class="hljs-string">'Order|Orders-&gt;CustomerAddress|Customer_address-&gt;FiasHouse|Fias_Houses-&gt;ID'</span></span>,orid); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> StrToInteger(fids,fid) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Continue</span></span>; las := g_Base.GetTblValueByID(<span class="hljs-string"><span class="hljs-string">'Fias_Houses'</span></span>,<span class="hljs-string"><span class="hljs-string">'PointLatitude'</span></span>,fid); los := g_Base.GetTblValueByID(<span class="hljs-string"><span class="hljs-string">'Fias_Houses'</span></span>,<span class="hljs-string"><span class="hljs-string">'PointLongitude'</span></span>,fid);</code> </pre> <br>  Those.  We went through 3 intermediate tables and compared the order with a point on the map to draw it.  Everything is very fast, and without a single request to the server.  And drawn in the browser with pens through the appropriate api.  That is, since Google has big problems with maps in Russia ‚Äúin lock‚Äù, on android I use Yandex, in which these problems are much less pronounced.  Through api 1.1, you don‚Äôt even need to receive developer code to display destination points and traffic jams for example. <br><br>  Naturally, all this had to be somehow mated with (so far) the main business system.  The main business system (I will not call it) prints orders to the printer.  A small use of the sniffer showed that pdf is printed.  After half a day, my program was ready, which completely copied the original protocol (up to a byte, thanks that the source code for the delphi component is available and there you can easily correct the header without bothering with the raw socket), but besides printing a parsil printer, read these pdf and read out the order, loading it into the database.  But this method carried some limitations.  Firstly, not all the necessary information was unloaded, and the operator had to refill a couple of fields, and secondly, it was only order synchronization.  For example, delivery flights had to be formed both there and there.  Therefore, a proxy was written that analyzed all the information passing through it and this problem was solved. <br><br><h3>  Courier application. </h3><br><img src="https://habrastorage.org/webt/ah/p4/q9/ahp4q9etbkoxs8xd_-kqnu6qlqm.jpeg" alt="image"><br><br>  It sends the track to the server in the background.  That is, the operator can observe the movement of couriers in real time.  Also, to confirm delivery of the order, the courier must be within a certain radius from the point of delivery.  But while this may be missing the Internet.  And then the program will transmit information that the order is delivered as soon as the Internet appears.  Naturally, you can run the Yandex-navigator from the program, which will automatically pave the way to the address;  You can view all the addresses on the map, or call the customer by pressing 2 buttons, and so on. <br><br>  In general, the system turned out to be very powerful, with a large number of features implemented, and with even more pledged.  And ... was not needed.  At the last moment, the customer began to change the initial requirements: he began to speak in an orderly tone, so that I would do this and that, because otherwise it would not work (by the way, these are requirements of completely rewriting everything on another PL, just "so that ") ... To the reasonable question," but it works, "" works faster than the current system, "etc.  if I did not hear.  On this we parted.  In general, now I have an interesting, almost ready, ERP system.  There are not enough reports, it would be good to finish (if it is needed) the functionality of the automatic scatter of orders across kitchens, depending on traffic jams and current load of points, etc.  To finalize this, as well as to implement additional functionality, is not at all difficult.  Until then, my ERP system is looking for a new customer, and I'm a new job.  :) <br><br>  <b>PS</b> Many people, I think, will be interested to know how to develop cross-platform applications in general at RAD Studio.  I will express my subjective and biased opinion: it is possible to work with the last studio, with all the updates.  There are some problematic components like TWebBrowser, which has difficulty removing itself under all OSs.  Or problems with components like TGrid on touch devices.  But this is all solved.  There is also a big problem that the installed apk ~ is 100Mb.  Yes, tin, I agree, but otherwise only benefits.  A single code base, a bunch of components out of the box for all occasions, and under FireMonkey they have become much more flexible than vcl.  So the main problem of the current Rad studio is the price.  Everything else in it is very worthy. </div><p>Source: <a href="https://habr.com/ru/post/345274/">https://habr.com/ru/post/345274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345262/index.html">How does it feel to create a game for Game Boy in 2017</a></li>
<li><a href="../345264/index.html">The effectiveness of advertising formats and networks in 2017: an analysis of 69 billion advertising hits</a></li>
<li><a href="../345266/index.html">Organization of musical accompaniment of the trading hall</a></li>
<li><a href="../345268/index.html">What to recognize on mobile platforms?</a></li>
<li><a href="../345270/index.html">Networks for the smallest. Part fourteen. Package path</a></li>
<li><a href="../345276/index.html">One ordinary funny monday</a></li>
<li><a href="../345278/index.html">Implementing Search Using RxJava</a></li>
<li><a href="../345282/index.html">Devops in a bloody enterprise</a></li>
<li><a href="../345284/index.html">Selection of resources for a job seeker programmer</a></li>
<li><a href="../345286/index.html">Severe Siberian and Kazakh microelectronics 2017: Verilog, ASIC and FPGA in Tomsk, Novosibirsk and Astana</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>