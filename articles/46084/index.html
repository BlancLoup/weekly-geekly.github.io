<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zend Framework Tuning + Doctrine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We cross two "animals" 

 Basically, crossing Zend Framework with Doctrine is not that difficult. But first, let's talk about the preparatory work. Ac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zend Framework Tuning + Doctrine</h1><div class="post__text post__text-html js-mediator-article"><h2>  We cross two "animals" </h2><br><br>  Basically, crossing Zend Framework with Doctrine is not that difficult.  But first, let's talk about the preparatory work.  According to the author, the default file structure of the Zend Framework project can be made slightly more optimal. <br><br>  This is the default file structure for the Zend Framework project: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote><pre>  /
   application /
     default /
       controllers /
       layouts /
       models /
       views /
   html /
   library / </pre></blockquote><br><a name="habracut"></a><br>  Often it may turn out that you will have several applications (for example, frontend / and backend /), and you will use the same model.  In this case it would be reasonable to move your models / to the library / folder, in this case the new structure would look like this: <br><br><blockquote><pre>  /
   application /
     default /
       controllers /
       layouts /
       views /
   html /
   library /
     Model / </pre></blockquote><br><br>  In addition, as can be seen, the models / folder was renamed to Model.  Further we act like this. <br><br><ol><li>  Download the latest distribution Doctrine-xxx-Sandbox.tgz from the <a href="http://www.doctrine-project.org/download">official site</a> . </li><li>  Copy the contents of the lib / folder from the archive into the library / folder of our project </li><li>  We create another bin / sandbox / folder in the root of our project and copy the rest of the archive into it (except for the models / folder and the index.php file - we don‚Äôt need them). </li></ol><br><br>  Now the files of our project should look like this: <br><br><blockquote><pre>  /
   application /
     default /
       controllers /
       layouts /
       views /
   bin /
     sandbox /
       data /
       lib /
       migrations /
       schema /
       config.php
       doctrine
       doctrine.php
   html /
   library /
     Doctrine /
     Model /
     Doctrine.php </pre></blockquote><br><br>  We clear the bin / sandbox / lib / folder from the contents - the library is now in another place. <br><br>  It's time to configure Doctrine to work within the new file structure. <br><br>  Change the value of the MODELS_PATH constant in the file bin / sandbox / config.php to: <br><br><blockquote><pre>  SANDBOX_PATH.  DIRECTORY_SEPARATOR.  '..'.  DIRECTORY_SEPARATOR.  '..'.  DIRECTORY_SEPARATOR.  'library'.  DIRECTORY_SEPARATOR.  'Model' </pre></blockquote><br><br>  Next, change the settings for connecting to the database.  Change the value of the DSN constant to what is needed.  For example, if you are using MySQL DBMS, the DSN might look like this: <br><br><blockquote><pre>  'mysql: // root: 123 @ localhost / mydbname' </pre></blockquote><br><br>  Configuring include_paths with the first urgent in the config so that our scripts can find files in new places: <br><br><blockquote><pre>  set_include_path ('.'. PATH_SEPARATOR. '...' </pre></blockquote><br><br>  Next, we include the main Doctrine library file, immediately after installing the paths, and install the autoload function: <br><br><blockquote><pre>  &lt;? php
 require_once 'Doctrine.php';

 / **
  * Setup autoload function
  * /
 spl_autoload_register (array (
     'Doctrine',
     'autoload'
 ))
 ?&gt; </pre></blockquote><br><br>  Ie, in general, our config should look something like this: <br><br><blockquote><pre>  &lt;? php
 set_include_path ('.'. PATH_SEPARATOR. '...'

 require_once 'Doctrine.php';

 / **
  * Setup autoload function
  * /
 spl_autoload_register (array (
	 'Doctrine',
	 'autoload'
 ))

 define ('SANDBOX_PATH', dirname (__ FILE__));
 define ('DATA_FIXTURES_PATH', SANDBOX_PATH. DIRECTORY_SEPARATOR. 'data'. DIRECTORY_SEPARATOR. 'fixtures');
 define ('MODELS_PATH', SANDBOX_PATH. DIRECTORY_SEPARATOR. '..'. DIRECTORY_SEPARATOR. '..'. DIRECTORY_SEPARATOR. 'library'. DIRECTORY_SEPARATOR. 'Model');
 define ('MIGRATIONS_PATH', SANDBOX_PATH. DIRECTORY_SEPARATOR. 'migrations');
 define ('SQL_PATH', SANDBOX_PATH. DIRECTORY_SEPARATOR. 'data'. DIRECTORY_SEPARATOR. 'sql');
 define ('YAML_SCHEMA_PATH', SANDBOX_PATH. DIRECTORY_SEPARATOR. 'schema');
 define ('DB_PATH', SANDBOX_PATH. DIRECTORY_SEPARATOR. 'sandbox.db');
 define ('DSN', 'mysql: // root: 123 @ localhost / mydbname');

 Doctrine_Manager :: connection (DSN, 'sandbox');

 Doctrine_Manager :: getInstance () -&gt; setAttribute ('model_loading', 'conservative');
 ?&gt; </pre></blockquote><br><br>  Now we will focus on a very interesting point. <br><br>  The fact is that Doctrine does not generate set () and get () methods for object properties, but uses automatic methods __get () and __set ().  And since the properties themselves are hidden within a single class-parent property, no development environment will ever tell you in autocomplex.  But this is just an inconvenience from which we can easily get rid of, and plus to this get some additional amenities.  Now we will demonstrate how to do it. <br><br><h3>  Tuning Doctrine Sandbox </h3><br><br>  The Doctrine class for the console application for Doctrine includes the Doctrine_Cli class, which, in fact, implements its functionality.  We will inherit it and expand this functionality as follows.  Create your own SandboxCli class: <br><br><blockquote><pre>  &lt;? php

 / **
  * Class SandboxCli
  * Extends default Doctrine Client functionality
  *
  * @package Sandbox
  * /
 class SandboxCli extends Doctrine_Cli {

	 / **
	  * Public function
	  *
	  * @param array $ args
	  * @return void
	  * /
	 public function run ($ args) {
		 ob_start ();
		 parent :: run ($ args);
		 $ msg = ob_get_clean ();
		 $ this -&gt; _ chmod ();

		 if (isset ($ args [1]) &amp;&amp; ($ args [1] == 'generate-models-yaml')) {
			 $ this -&gt; _ genBaseClasses ();
			 $ this -&gt; _ genSgMethods ();
			 $ this -&gt; _ chmod ();
		 }
		 echo $ msg;
	 }

	 / **
	  If they are not there
	  *
	  * @param void
	  * @return void
	  * /
	 protected function _genBaseClasses () {
		 $ dir = $ this -&gt; _ config ['models_path'].  DIRECTORY_SEPARATOR.  'Base'.  DIRECTORY_SEPARATOR;
		 if (! is_dir ($ dir)) {
			 mkdir ($ dir);
		 }
		 if (! file_exists ($ dir. 'Table.php')) {
			 file_put_contents ($ dir. 'Table.php', 'load ($ this -&gt; _ config [' yaml_schema_path ']. DIRECTORY_SEPARATOR.' schema.yml ',' yml ');

		 foreach ($ result as $ class =&gt; $ data) {
			 require_once $ this -&gt; _ config ['models_path'].  DIRECTORY_SEPARATOR.  $ class.  '.php';
			 $ rClass = new ReflectionClass ($ class);
			 foreach ($ data ['columns'] as $ column =&gt; $ options) {
				 $ methods = $ this -&gt; _ buildMethodName ($ column);
				 foreach ($ methods as $ k =&gt; $ name) {
					 if (! $ rClass-&gt; hasMethod ($ name)) {
						 $ this -&gt; _ addMethod ($ class, $ name, $ column, $ k, $ options ['type']);
					 }
				 }
			 }
			 $ this -&gt; _ fixParents ($ class);
			 $ this -&gt; _ createTableClass ($ class);
		 }
	 }

	 / **
	  * Fixes parent to base_class_Record from Doctrine_Record to Model_Base_Record
	  *
	  * @param string $ class - original class name
	  * @return void
	  * /
	 protected function _fixParents ($ class) {
		 $ dir = $ this -&gt; _ config ['models_path'].  DIRECTORY_SEPARATOR.  'generated'.  DIRECTORY_SEPARATOR;
		 $ baseClass = 'Base'.  $ class;
		 if (file_exists ($ dir. $ baseClass. '.php')) {
			 $ content = file_get_contents ($ dir. $ baseClass. '.php');
			 $ content = preg_replace ('/ extends \ s + Doctrine_Record \ s + {/ is', 'extends Model_Base_Record {', $ content);
			 file_put_contents ($ dir. $ baseClass. '.php', $ content);
		 }
	 }

	 / **
	  * Creates table classes
	  *
	  * @param string $ class - original class name
	  * @return void
	  * /
	 protected function _createTableClass ($ class) {
		 $ dir = $ this -&gt; _ config ['models_path'].  DIRECTORY_SEPARATOR.  'Tables'.  DIRECTORY_SEPARATOR;
		 if (! is_dir ($ dir)) {
			 mkdir ($ dir);
		 }
		 $ tblClass = $ class.  'Table';
		 if (! file_exists ($ dir. $ tblClass. '.php')) {
			 $ content = "_config ['models_path']. DIRECTORY_SEPARATOR. $ class. '.php');

		 $ propType = $ this -&gt; _ type2php ($ propertyType);

		 if ($ methodType == 'get') {
			 $ comment = "Returns a value of '$ propertyName' field";
			 $ args = ";
			 $ implementation = "return \ $ this -&gt; $ propertyName;";
			 $ prms = 'void';
			 $ rets = "$ propType \ $$ propertyName $ propertyType";
		 } elseif ($ methodType == 'set') {
			 $ comment = "Sets '$ propertyName' field to a given value";
			 $ args = '$'.  $ propertyName;
			 $ implementation = '$ this-&gt;'.  $ propertyName.  '= $'.  $ propertyName.  ';
		 return $ this; ';
			 $ prms = $ args;
			 $ rets = $ class;
		 } else {
			 return;
		 }

		 $ addCode = "/ **
	  * $ comment
	  *
	  * @param $ prms
	  * @return $ rets
	  * /
	 public function $ methodName ($ args) {
		 $ implementation
	 }

 ";

		 $ content = preg_replace ('/ (class \ s +'. preg_quote ($ class). '\ s +. *? \ {. *?) (\}) ([^}] *) $ / is', '$ 1' . $ addCode. '$ 2 $ 3', $ content);
		 file_put_contents ($ this -&gt; _ config ['models_path']. DIRECTORY_SEPARATOR. $ class. '.php', $ content);
	 }

	 / **
	  * Returns PHP type from YAML definition type
	  *
	  * @param string $ type - YAML type
	  * @return string PHP type
	  * /
	 protected function _type2php ($ type) {
		 $ type = explode ('(', $ type);
		 $ type = $ type [0];

		 $ types = array (
			 'boolean' =&gt; 'bool',
			 'integer' =&gt; 'int',
			 'float' =&gt; 'float',
			 'decimal' =&gt; 'float',
			 'string' =&gt; 'string',
			 'array' =&gt; 'array',
			 'object' =&gt; 'string',
			 'blob' =&gt; 'string',
			 'clob' =&gt; 'string',
			 'timestamp' =&gt; 'string',
			 'time' =&gt; 'string',
			 'date' =&gt; 'string',
			 'enum' =&gt; 'string',
			 'gzip' =&gt; 'string'
		 );

		 return $ types [$ type];
	 }

	 / **
	  * Builds method names from a property name
	  *
	  * @param string $ column_name - original property name
	  * @return array
	  * /
	 protected function _buildMethodName ($ column_name) {
		 $ method = preg_split ('/ _ + /', $ column_name, - 1, PREG_SPLIT_NO_EMPTY);
		 foreach ($ method as $ k =&gt; $ part) {
			 $ method [$ k] = ucfirst ($ part);
		 }
		 $ method = join ('', $ method);
		 $ return = array (
			 'get' =&gt; "get $ method",
			 'set' =&gt; "set $ method"
		 );
		 return $ return;
	 }

	 / **
	  * Fixes group permissions for generated files
	  *
	  * @param void
	  * @return void
	  * /
	 protected function _chmod () {
		 $ cmd = 'chmod -R g + w'.  MODELS_PATH;
		 echo `$ cmd`;
	 }

 }
 ?&gt; </pre></blockquote><br><br>  And put it in the bin / sandbix / lib / folder. <br><br>  Great, our extra functionality is ready.  What does it give us: <br><br><ul><li>  Automatically creates base classes for table objects and records that you can edit with your hands (you don‚Äôt want to edit Doctrine_Table and Doctrine_Record, do you?).  This is useful if you want to extend their functionality.  For example, you can implement logging of all changes to records in database tables - and this is exactly the place. </li><li>  Automatically creates all the necessary table classes that are inherited from the base class we created. </li><li>  Automatically adds getProperty () and setProperty ($ property) methods for all properties of record classes.  Now you will have autocomplete work if you use Zend Studio while developing, and also can expand the functionality of access methods to the class properties as you wish. </li></ul><br>  As you can see, such an uncomplicated solution significantly improves the flexibility of the framework of your application, and also does not preclude updating the libraries themselves. <br><br>  Now we‚Äôll get Sandbox to work with our client.  Correct the file bin / sandbox / doctrine.php: <br><br><blockquote><pre>  &lt;? php
 require_once ('config.php');
 require_once 'SandboxCli.php';

 // Configure Doctrine Cli
 This will be auto-filled.
 $ config = array ('data_fixtures_path' =&gt; DATA_FIXTURES_PATH,
                 'models_path' =&gt; MODELS_PATH,
                 'migrations_path' =&gt; MIGRATIONS_PATH,
                 'sql_path' =&gt; SQL_PATH,
                 'yaml_schema_path' =&gt; YAML_SCHEMA_PATH);

 $ cli = new SandboxCli ($ config);
 $ cli-&gt; run ($ _SERVER ['argv']);
 ?&gt; </pre></blockquote><br><br>  Voila!  We can try.  Create several related tables in your database, for example: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5b3/e14/4a0/5b3e144a0ab0436d8e1fa89d5627a80a.png"><br><br>  And run the commands: <br><br><blockquote><pre>  ./doctrine generate-yaml-db
 ./doctrine generate-models-yaml </pre></blockquote><br><br>  In the future, you can use the second command to update your model. <br><br>  Check if all necessary files are created in the library / Model / folder. <br><br><h3>  Tuning the Zend Framework to work with a new model </h3><br><br>  First of all, let's create the application / default / run / folder and the bootstrap.php file in it, and transfer the contents of the html / index.php file to it.  And in the file html / index.php we will write: <br><br><blockquote><pre>  require '..'.  DIRECTORY_SEPARATOR.  'application'.  DIRECTORY_SEPARATOR.  'default'.  DIRECTORY_SEPARATOR.  'run'.  DIRECTORY_SEPARATOR.  'bootstrap.php'; </pre></blockquote><br><br>  This will make it impossible to view the code, even if the web server crashes.  In the worst case, you will only see the connection of another file. <br><br>  Now we‚Äôll make the necessary changes to our bootstrap.php, it should look something like this: <br><br><blockquote><pre>  &lt;? php
 setAttribute (Doctrine :: ATTR_AUTOLOAD_TABLE_CLASSES, true);

 / **
  * Turn all Doctrine validators on
  * /
 Doctrine_Manager :: getInstance () -&gt; setAttribute (Doctrine :: ATTR_VALIDATE, Doctrine :: VALIDATE_ALL);

 / **
  * Setup Doctrine connection
  * /
 Doctrine_Manager :: connection ('mysql: // root: 123 @ localhost / mydbname');

 / **
  * Set the model loading to conservative / lazy loading
  * /
 Doctrine_Manager :: getInstance () -&gt; setAttribute ('model_loading', 'conservative');

 / **
  * Load the models for the autoloader
  * /
 Doctrine :: loadModels ('..'. DIRECTORY_SEPARATOR. 'Library'. DIRECTORY_SEPARATOR. 'Model');

 / **
  * Setup controller
  * /
 $ controller = Zend_Controller_Front :: getInstance ();
 $ controller-&gt; setControllerDirectory ('../application/default/controllers');
 $ controller-&gt; throwExceptions (true);  // should be turned on in development time 

 / **
  * bootstrap layouts
  * /
 Zend_Layout :: startMvc (array (
     'layoutPath' =&gt; '../application/default/layouts',
     'layout' =&gt; 'main'
 ))

 / **
  * Run front controller
  * /
 $ controller-&gt; dispatch ();
 ?&gt; </pre></blockquote><br><br>  Everything, we crossed two "animals".  Now we can try our model in action, for example, in application / default / controllers / IndexController.php: <br><br><blockquote><pre>  &lt;? php
 public function indexAction () {
     $ artist = new artist ();
     $ artist-&gt; setName ('DDT')
              -&gt; setDescription ('Very cool russian rock-band')
              -&gt; save ();

     $ artist = Doctrine :: getTable ('Artist') -&gt; find (1);    

     echo '&lt;pre&gt;';
     print_r ($ artist);
     echo '&lt;/ pre&gt;';
 }
 ?&gt; </pre></blockquote><br><br>  You can <a href="">download the full example in source codes</a> (4.53 MB) <br><br>  PS Cross-post from the author's blog: <a href="http://mikhailstadnik.com/tuning-zf-with-doctrine">mikhailstadnik.com/tuning-zf-with-doctrine</a> </div><p>Source: <a href="https://habr.com/ru/post/46084/">https://habr.com/ru/post/46084/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46072/index.html">IMHO happy 3D :)</a></li>
<li><a href="../46074/index.html">Civic journalism in the blogosphere</a></li>
<li><a href="../46078/index.html">Erotic social networks Ning left month</a></li>
<li><a href="../46079/index.html">Office behind the glass - now on the Internet</a></li>
<li><a href="../46081/index.html">Data encryption in php with public key</a></li>
<li><a href="../46086/index.html">Non-working Enterprise 2.0 and Five Million for one comment</a></li>
<li><a href="../46087/index.html">Russian application names in Django</a></li>
<li><a href="../46091/index.html">Icons for your software products. Selected.</a></li>
<li><a href="../46096/index.html">Play Pong ... with your browser windows!</a></li>
<li><a href="../46097/index.html">Debian stuff - apt-build</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>