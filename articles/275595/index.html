<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux in your pocket - in the service of the photographer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that photography is my main professional activity, and programming is a hobby that sometimes allows us to stretch the brain. In additio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux in your pocket - in the service of the photographer</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/files/3d2/f39/c60/3d2f39c605de4fda954bec52724d35b5.jpg">  It so happened that photography is my main professional activity, and programming is a hobby that sometimes allows us to stretch the brain.  In addition to directly warming up for the brain, programming helps in work.  For example, wrote useful things, such as <a href="https://habrahabr.ru/post/216039/">this</a> or <a href="https://habrahabr.ru/post/149898/">this</a> , or <a href="https://habrahabr.ru/post/162085/">this</a> . <br><br>  Recently I set myself a task, how to please my clients.  He recalled the numerous requests from customers for the wedding shooting: ‚ÄúHow good it would be if at a banquet you could show a short slideshow of photos that were shot in a day.‚Äù  These requests had to be refused, for several reasons: too lazy to carry a laptop to assemble a slideshow with them, there is no time to select a couple of dozens of shots from hundreds, again you need to convert from raw, and most importantly - all this takes time, which is not. <br><br>  This is a story about how I managed to make a tool for myself that, with my minimum participation and minimal additional weight in my backpack, helps to make beautiful slideshows.  And of course the story about python, ffmpeg and linux on android. <br><a name="habracut"></a><br><h4>  Unexpected iron selection </h4><br>  The first problem is overweight.  I needed a full linux on a fairly decent hardware.  Initially, my choice fell on the Orange PI PC, which I heard about on <a href="http://geektimes.ru/post/260912/">gigtimes</a> .  The piece of iron was ordered and delivered.  It seemed to me that this is what you need - 4 cores of 1.5 GHz each, 1 GB of RAM and full USB.  But in fact, once again convinced that without normal support, all the ‚Äúraspberry clones‚Äù are worth nothing.  Very buggy OS images, constantly falling off kernels under load, a problem with the work of libraries, for example, to connect an lcd display. <br>  And the main problem is the unexpected killed, with a free 800 MB of RAM, in the area of ‚Äã‚Äãthe type code: <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image img=Image.new(<span class="hljs-string"><span class="hljs-string">'RGB'</span></span>,(<span class="hljs-number"><span class="hljs-number">6000</span></span>,<span class="hljs-number"><span class="hljs-number">4000</span></span>)) <span class="hljs-comment"><span class="hljs-comment">#      ,    img.rotate()</span></span></code> </pre> <br>  And the same thing worked perfectly on a netbook with 1GB of RAM without a swap, as well as on the first Raspberry PI.  And even more so, there could be no talk to do the same, but on 4 cores at the same time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The solution came unexpectedly when I picked up a smartphone to read the message that came: <br>  And in the pocket there is always a piece of iron with a 2.2 GHz 4-core processor, 2GB of RAM + USB-otg is available (Nexus 5).  It remains to find a way to fully launch the Linux environment.  After discarding various options with a flashing (I wanted to use it fully and as a smartphone), the solution was found - <a href="https://play.google.com/store/apps/details%3Fid%3Dru.meefik.linuxdeploy%26hl%3Dru">Linux Deploy</a> .  In short, Linux Deploy launches a full-fledged linux environment in chroot (more information about the program can be found <a href="http://meefik.ru/">on the blog</a> of our compatriot developer), and the most important thing for me is to mount an arbitrary directory from fs android to my environment.  Without this, it would not be possible to work with an SD card reader inserted into the OTG connector. <br><br><h4>  Photo selection </h4><br>  A slideshow of hundreds of photos would take a couple of hours to complete.  We needed a way to quickly and easily select 20-40 photos.  Scrolling through even 100 photos from a smartphone is still a pleasure, and the number can reach up to a thousand in the evening (duplicates from serial shooting, marriage, sighting photos, a report, etc.) <br>  Looking at the camera, I remembered the button I never used - the ‚Äúrate‚Äù button was the savior, which assigns a photo rating: <br><br><img src="https://habrastorage.org/files/6fc/01d/dcf/6fc01ddcf3ce425f9127e3a467f302b0.jpg"><br><br>  The scroll wheel on the right quickly scrolls images, and the rate button is pressed on the desired one.  Since you already know that you successfully shot today, it takes no more than a couple of minutes.  It remains to force the program to find and select those images that have been assigned at least some rating. <br><br>  Since the rating gets into exif, you need a wonderful <a href="http://www.sno.phy.queensu.ca/~phil/exiftool/">exiftool</a> package (sudo apt-get install libimage-exiftool-perl) and a <a href="https://smarnach.github.io/pyexiftool/">wrapper for it</a> for python.  And then everything is simple: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> exiftool all_files=[] <span class="hljs-string"><span class="hljs-string">"""     SD  """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> directory, dirnames, filenames <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.walk(PATH_TO_SD_ROOT): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filenames: f=os.path.join(directory, name) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> f.lower().endswith(<span class="hljs-string"><span class="hljs-string">'.cr2'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> f.lower().endswith(<span class="hljs-string"><span class="hljs-string">'.jpg'</span></span>): <span class="hljs-comment"><span class="hljs-comment">#    jpg  raw  all_files.append(f) tool=exiftool.ExifTool() tool.start() # exiftool #         result=tool.get_tags_batch(['XMP:Rating'],all_files) rated_files=[] for x in result: if x['XMP:Rating']&gt;0: rated_files.append(x['SourceFile']) #        rated_files.sort()</span></span></code> </pre><br><br>  The next stage is quite trivial - copying the necessary photos into a temporary directory and re-recording in several streams for further work.  The only thing I would like to focus on is raw, which I shoot.  Conversion is handled by the dcraw utility (although this is not a full conversion, but only pulling out jpg embedded into a raw file, but in this case, it is more than enough. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n,x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(self.rated_files): dcraw_opts = [<span class="hljs-string"><span class="hljs-string">"dcraw"</span></span>, <span class="hljs-string"><span class="hljs-string">"-e"</span></span>, <span class="hljs-string"><span class="hljs-string">"-c"</span></span>, x] <span class="hljs-comment"><span class="hljs-comment"># -e -   jpg, -     stdout dcraw_proc = subprocess.Popen(dcraw_opts, stdout=subprocess.PIPE) image = StringIO.StringIO(dcraw_proc.communicate()[0]) #    stdout image.seek(0) open('input/%02d.jpg'%(n),'wb').write(image.read()) #     .</span></span></code> </pre><br><br><h4>  Make me beautiful! </h4><br><br>  At the previous stage, one could stop by taking photos and launching them as a slideshow on a DJ's laptop connected to the projector, but I want it all to look beautiful. <br>  Such a wonderful thing as ffmpeg (avconv) comes to the rescue.  I am not a fan of any bright special effects, I have a rather light dynamic, in the form of a zoom photo and a crossfade transition between slides.  I will say right away, despite the enormous possibilities of ffmpeg, I did not succeed.  For example, a zoompan filter, gave a terrible quality and a shaky picture.  After a week spent reading manuals and forums, it was decided to do it "in the forehead": <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numb)</span></span></span><span class="hljs-function">:</span></span> img=Image.open(<span class="hljs-string"><span class="hljs-string">'input_temp/%02d.jpg'</span></span>%numb) <span class="hljs-comment"><span class="hljs-comment">#    #   crossfade   ,    ,   try:next_img=Image.open('input_temp/%02d.jpg'%(numb+1)).resize((1280,720),Image.ANTIALIAS) except:next_img=Image.new('RGB',(1280,720),'black') #       ,  ffmpeg   stdin  #        p = subprocess.Popen(['avconv', '-y', '-f', 'image2pipe', '-vcodec', 'mjpeg', '-r', '25', '-i', '-', '-vcodec', 'mjpeg','-q:v', '3' , '-r', '25', 'output/%02d.mjpg'%(numb)], stdin=subprocess.PIPE) # 100   25 /c - 4     for x in xrange(100): #            16:9 n=img.crop((int(float(x)*16.0/9.0),x,int(1920.0-float(x)*16.0/9.0),1080-x)) #       n=n.resize((1280,720),Image.ANTIALIAS) #   ,  ""   if x&gt;75: n=Image.blend(n,next_img,float(x-75)/25) #   ffmpeg' n.save(p.stdin,'JPEG') p.stdin.close() p.wait()</span></span></code> </pre><br><br>  Oh yeah, I said something about the processor cores.  I would like to parallel this process so that all cores are busy.  In python, this is done very very simply: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> multiprocessing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Pool s=len(glob.glob(<span class="hljs-string"><span class="hljs-string">'input_temp/*.jpg'</span></span>)) <span class="hljs-comment"><span class="hljs-comment">#   pool = Pool() pool.map(processImage, xrange(s)) #    ,        pool.close() pool.join()</span></span></code> </pre><br><br>  As a result, we have a lot of mjpeg video segments that need to be put together by inserting music. <br>  Googling, did not find a better way how to first directly connect the video using cat: <br><pre> <code class="bash hljs">cat 00.mjpg 01.mjpg ..... &gt; out.mjpg</code> </pre><br>  It remains only to convert it to the desired format by adding music: <br><pre> <code class="bash hljs">avconv -threads 4 -framerate 25 -i out.mjpg -i audio.mp3 -shortest -y -r 25 -preset veryfast out.mp4</code> </pre><br><br>  In order not to mess around each time in the console, but it was necessary to choose a music track, enter a name for the slideshow (for the first frame), etc., raised a simple web server that starts when Linux Deploy starts.  I used a simple framework bottle.  It looks like this: <br><br><table><tbody><tr><td><img src="https://habrastorage.org/files/286/604/fa8/286604fa862a49a9ab14f755e1034805.png"></td><td><img src="https://habrastorage.org/files/e47/a0f/be6/e47a0fbe651d4537880c47793ae09dca.png"></td><td><img src="https://habrastorage.org/files/583/b4d/4b0/583b4d4b0bf64497bfe6b5d852485175.png"></td><td><img src="https://habrastorage.org/files/13b/59b/d6f/13b59bd6f93547dc974aed257661575e.png"></td></tr></tbody></table><br><br><h4>  Total </h4><br>  2-3 minutes selection of photos, launch Linux Deploy, localhost in the browser, a couple of seconds to enter the title and click on START.  Next, 10-15 minutes of the smartphone, and the video is ready: <br><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/152504045&amp;xid=25657,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhiqncEP5u7FCmY-5U7jQw76hZL2iw" width="560" height="315" frameborder="0" title="test" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br><br>  In the same way, you can make not only a slideshow from photos, but also glue together the video: mark the necessary passages in the camera with the rate button and then glue them together with ffmpeg. <br><br><h5>  And a small announcement </h5><br>  If this topic turns out to be interesting, I will make some more publications.  For example, next in line is an article on how to make such a nice and functional photo booth: <br><img src="https://habrastorage.org/files/879/844/1dc/8798441dca5f4c4a9abc17a5311a46a9.jpg"></div><p>Source: <a href="https://habr.com/ru/post/275595/">https://habr.com/ru/post/275595/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275579/index.html">Fighting geolocation services</a></li>
<li><a href="../275587/index.html">go-script that makes an audiobook from a text file using one of the best speech synthesizers - Ivona from Amazon</a></li>
<li><a href="../275589/index.html">Technology is changing the world now</a></li>
<li><a href="../275591/index.html">A look inside the cyber fraudulent call centers</a></li>
<li><a href="../275593/index.html">Rust 1.6 Preview</a></li>
<li><a href="../275599/index.html">Entity vs Value Object: full list of differences</a></li>
<li><a href="../275601/index.html">Engineer's opinion: Why not use Docker anytime and anywhere</a></li>
<li><a href="../275603/index.html">Selection: 40+ useful tools, resources and research on working with email</a></li>
<li><a href="../275605/index.html">OpenShift: some gear internals</a></li>
<li><a href="../275607/index.html">Entity Framework in WinForms. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>