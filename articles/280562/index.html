<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>16 cores and 30 GB under the hood of your Jupyter for $ 0.25 per hour</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are not very lucky, and there is no n-nuclear monster at work that you can load with your scripts, then this article is for you. Also, if you a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>16 cores and 30 GB under the hood of your Jupyter for $ 0.25 per hour</h1><div class="post__text post__text-html js-mediator-article">  If you are not very lucky, and there is no n-nuclear monster at work that you can load with your scripts, then this article is for you.  Also, if you are used to running scripts for the whole night (and in the morning to read that you forgot your brace somewhere, and 6 hours of calculations were gone) - you have a chance to finally get acquainted with Amazon Web Services. <br><br><img src="https://habrastorage.org/files/0c5/9fe/58c/0c59fe58ce894a98a99714e313156428.jpg"><br><br>  In this article I will tell you how to start working with the EC2 service.  In essence, this is a step-by-step instruction on the semi-automatic lease of an AWS spot instance for working with Jupyter notebooks and building Anaconda libraries.  It will be useful, for example, to those who are still using their toy poppy in Kaggle competitions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Probably, the reaction of everyone who visited Amazon Web Services for the first time is the confusion of the abundance of services offered and virtual machines (which are called instances there). <br>  In this tutorial, I‚Äôll show you how inexpensively to rent an AWS computing instance and quickly set up a Jupyter server on it to use your favorite notebooks.  We will focus on the Anaconda assembly and machine learning tasks, but it is clear that the server can be used for various purposes, even if bitcoins are mine :) <br><br>  <b>Motivation</b> : we want to quickly (within 5-7 minutes) access from Jupyter notebooks to computing resources more seriously than from a home computer. <br>  In general, there is a good <a href="https://gist.github.com/iamatypeofwalrus/5183133">tutorial</a> for this business.  The article you are reading is a free translation with additions.  We will also write a script that will run every time you rent a car.  And here is the <a href="https://github.com/Yorko/aws_jupyter_anaconda">result</a> for those who are in a hurry. <br><br>  We will rent a spot instance with 3.4xlarge with 16 cores and 30 GB of RAM. <br>  ‚ÄúSpot‚Äù means that in essence we will participate in the auction and, having set the price per hour of using the machine, have access to it until demand increases.  If demand increases, and the market price exceeds the one we have appointed, the car will ‚Äúrun away‚Äù from us, and all of a sudden.  It is for this reason (instability) that many are afraid to use spot instances, although you can save a lot on them compared to on-demand instances.  The same machine, but in a more ‚Äústable‚Äù mode, <a href="https://aws.amazon.com/ru/ec2/pricing/">will cost</a> about $ 0.85 / hour, but we will spend four times less. <br><br>  Now about the types of machines.  They are well <a href="https://aws.amazon.com/ru/ec2/instance-types/">described</a> in the AWS documentation, so we choose type C - machines optimized for calculations. <br><br><h2>  Car rental </h2><br><br>  To get started, sign up at Amazon Web Services.  I will not write instructions here - everything is as usual, it will only be necessary to confirm both by phone and by e-mail.  You will need to link a credit card to your account, but if you are afraid of spending, you can <i>take the m4large</i> instance (2 CPU, 8 Gb RAM) for $ 0.05 / hour. <br><br>  Go to your AWS console and find EC2 (Elastic Compute Cloud) in Services <br><br><img src="https://habrastorage.org/files/143/eaa/fd8/143eaafd898d462a8adba03d625fcdd6.png"><br><br>  In the Spot Requests section, click ‚ÄúRequest Spot Instance‚Äù. <br><br><img src="https://habrastorage.org/files/aa7/2af/e05/aa72afe0556a4534829ad66208e42951.png"><br><br>  Select the type of OS that will be in the virtual machine.  In general: Windows is more expensive, among * Nix it is not so important which one to choose, let it be Ubuntu. <br><br><img src="https://habrastorage.org/files/554/a9d/d9b/554a9dd9b2f046fe82539e8a344555a9.png"><br><br>  On the next tab we are offered to choose the instance itself.  Here we pop, level ( <a href="https://aws.amazon.com/ru/ec2/instance-types/">here</a> everything is described in more detail) and scroll to c3.4xlarge. <br><br><img src="https://habrastorage.org/files/1ef/90f/191/1ef90f191bab40a5a9dea041eef8e43f.png"><br><br>  Then the most important thing is to set the price per hour of using the virtual machine.  We see current prices in selected regions. <br><br><img src="https://habrastorage.org/files/24e/b25/bf9/24eb25bf9aac460994693a752139859f.png"><br><br>  If you see that your prices are much higher than in the screenshot, it means that there is a surge in the current region - change the region (in the upper right corner next to your name).  I still successfully use the Frankfurt region, but you can study the statistics, see which regions are cheaper and with stable prices. <br><br>  The price is best set at 1.5 times the current market value of the instance in the region.  In this situation, the price will fluctuate a little, but rarely exceed what you declared.  Accordingly, so the car will not often fall off. <br><br>  Now we connect the repository.  Amazon treats thirty GB, so why not take all 30 ... <br><br><img src="https://habrastorage.org/files/a58/a16/252/a58a1625229f445a9ad976e22cdd74af.png"><br><br>  Instance tagging can be skipped.  And further port setting.  The main thing here is to open the port that we will use under the Jupyter server.  Let it be traditionally 8888. Click ‚ÄúAdd rule‚Äù, leave the option ‚ÄúCustom TCP rule‚Äù and specify port 8888. We also add the HTTP and HTTPS protocols and say who can listen on the ports.  It is enough to choose My IP daws on the right. <br><br><img src="https://habrastorage.org/files/61f/813/212/61f813212feb4f7f953d9acbc0243d0b.png"><br><br>  In the next step, we create a key (pem-file) that will identify us when remotely connecting to the machine via the SSH protocol.  You can call it whatever you like - the main thing after downloading is to know where it lies and <b>in no case (!!!)</b> do not upload it on GitHub or anywhere else online.  Treat this file almost like a password from a bank card.  Amazon recommends updating pem files periodically (you can have 2 in each region; you can‚Äôt download the same key a second time). <br><br><img src="https://habrastorage.org/files/bfc/8bb/db5/bfc8bbdb52b04a698bb7899518d875f8.png"><br><br>  Finally, we confirm everything, wait a couple of minutes for the instance to start, and in EC2 on the ‚ÄúInstances‚Äù tab, we notice that something has appeared. <br><br><img src="https://habrastorage.org/files/95b/889/2fa/95b8892faf6a4477aa90e46c2ed55d7a.png"><br><br>  Select the instance that appears and click Connect.  Amazon gives instructions on what to do next. <br><br>  If you are sitting under Windows, then the reading of the article does not end for you (usually at this place in the tutorials you can read ‚ÄúWindows? Good luck!‚Äù).  All you need to do is read Amazon‚Äôs instructions on how to connect using Putty. <br>  If you are under * NIX, then we execute the following 2 commands: <br><br><pre><code class="bash hljs">chmod 400 &lt;PEM-file name&gt;.pem ssh -i &lt;PEM-file name&gt;.pem ubuntu@&lt;HOST&gt;</code> </pre> <br>  The first is to ensure that not everyone who is passing has access to your pem-file.  The second is the actual connection to the virtual machine with its unique host. <br><br><h2>  Machine setup </h2><br><br>  If everything went smoothly, you, as a user of ubuntu, will get to the terminal of the remote machine. <br>  We can do anything, run any scripts, but we will focus on setting up the instance for machine learning tasks with Jupyter.  All the commands are described below to make them easier to understand (and to make sure that everything went without <i>rum-rf /</i> jokes), but in general we will run it a bash script a second time. <br><br>  Download and install Miniconda.  It is still much easier than Anaconda, and we will install the necessary libraries (however, seaborn is not good for me, but everything is fine with Anaconda).  We are with the machine for a short time, hardly for more than a few hours, so without perfectionism - we set everything up in the home directory. <br><br><pre> <code class="bash hljs">wget -c http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh bash Miniconda-latest-Linux-x86_64.sh -b -p ~/miniconda <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=~/miniconda/bin:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre><br>  Now install all the libraries that we want. <br><pre> <code class="bash hljs">conda install -y numpy scipy pandas scikit-learn jupyter</code> </pre><br>  It is possible, for example, to put <a href="https://github.com/JohnLangford/vowpal_wabbit/wiki">Vabpal Wabbit</a> (nimble linear models, which on large samples are sometimes considered faster MapReduce-implementations). <br><pre> <code class="bash hljs">sudo apt-get -qq install vowpal-wabbit</code> </pre><br>  Git won't hurt either - you can download the necessary repository right away (I don‚Äôt consider using Amazon S3 in this tutorial). <br><pre> <code class="bash hljs">sudo apt-get -qq install git</code> </pre><br>  Creating a certificate to log in to Jupyter with a password is so much safer.  Now we‚Äôll do this with our hands; the second time this generated certificate will be used by the script. <br><br><pre> <code class="bash hljs">openssl req -x509 -nodes -days 365 rsa:2048 -keyout jupyter.pem -out jupyter.pem</code> </pre><br><br>  You will be prompted for user information.  In principle, it is not necessary to fill out. <br><br>  Now create a password to log in to the Jupyter server. <br>  You can use the passwd function from ipython <br><pre> <code class="bash hljs">python &gt;&gt;&gt; from IPython.lib import passwd &gt;&gt;&gt; passwd(<span class="hljs-string"><span class="hljs-string">'Sample password'</span></span>)</code> </pre><br>  Your password hash will appear.  We copy it. <br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">'sha1:d0c0b7eb515e:f0e59fcd04aec7bb50886084ae8e1fa9a273f88e'</span></span></code> </pre><br>  Finally, we create an IPython profile and start the server by first specifying in the settings file which port we want to use and from which addresses access is allowed.  We specify the hashed password.  Your password will be different - you need to insert your own. <br><pre> <code class="bash hljs">ipython profile create nbserver <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> <span class="hljs-string"><span class="hljs-string">"\n# Configuration file for ipython-notebook.\n c = get_config()\n # Notebook config\n c.NotebookApp.ip = '*'\n c.NotebookApp.password = u''sha1:d0c0b7eb515e:f0e59fcd04aec7bb50886084ae8e1fa9a273f88e''\n c.NotebookApp.open_browser = False\n c.NotebookApp.port = 8888\n"</span></span> &gt;&gt; ~/.ipython/profile_nbserver/ipython_notebook_config.py</code> </pre><br>  The last thing we do only on a remote machine is to start the IPython server. <br>  (Why IPython, but not Jupyter? .. Why is certfile explicitly specified? The answer is simple: crutches. Jupyter did not want to see the config file, and then did not want to see the certificate file settings in it. Check if it can start with the jupyter command , and without explicitly specifying the configuration file and certificate). <br><pre> <code class="bash hljs">ipython notebook --config=<span class="hljs-string"><span class="hljs-string">"~/.ipython/profile_nbserver/ipython_notebook_config.py"</span></span> --certfile=jupyter.pem</code> </pre><br>  If everything went well, you will see at the end read something like this. <br><pre> <code class="bash hljs">[I 10:09:08.774 NotebookApp] Serving notebooks from <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> directory: /home/ubuntu [I 10:09:08.775 NotebookApp] 0 active kernels [I 10:09:08.775 NotebookApp] The Jupyter Notebook is running at: https://[all ip addresses on your system]:8888/ [I 10:09:08.775 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).</code> </pre><br><h2>  Profit </h2><br>  Now go to the browser on <a href="https://host/">HOST</a> : 8888, where HOST is still the address of your instance.  <b>Attention!</b>  The protocol must be HTTPS, you may also need to confirm the certificate.  (For example, in Chrome you need to poke "Advanced" and confirm the transition to the site). <br><br>  We enter our password (here, of course, not hashed, but ‚Äúnormal‚Äù) and see a nice picture - the file system from Jupyter. <br><br><img src="https://habrastorage.org/files/4af/81f/ae4/4af81fae474b41cb96fcfd08d473835e.png"><br><br>  Create a new notebook and enjoy the abundance of cores under the hood. <br><br><img src="https://habrastorage.org/files/3ee/9f3/5be/3ee9f35be2564b9380eeebbbcd4d06a7.png"><br><br>  Now let's go back to the terminal (our company, not the remote machine) and drop some data set on our instance.  For example, from the Kaggle competition " <a href="https://www.kaggle.com/c/forest-cover-type-prediction">Forest Cover Type Prediction</a> ". <br><pre> <code class="bash hljs">scp -i &lt;PEM-file name&gt;.pem &lt;LOCAL_PATH_TO_DATA&gt; ubuntu@&lt;HOST&gt;:/~</code> </pre><br>  About machine learning, of course, it's interesting to talk, but here we just run the random Sklearn forest on raw data. <br><br><img src="https://habrastorage.org/files/5d5/863/048/5d5863048b6447e5ab97744dfaae3ea5.png"><br>  Pay attention to the parameter n_jobs - here we just use all 16 cores. <br>  1000 trees with a maximum depth of 15 learned ~ in 5 seconds - 3 times faster than on my MacBook Air with 4 cores and 4 GB of memory.  On large samples, the difference, of course, will be more significant. <br><br><img src="https://habrastorage.org/files/f1c/c90/1cf/f1cc901cf79947ac8ce818500ce5a586.png"><br><br><h2>  Same script </h2><br><br>  The process can be automated.  Using the Python Amazon SDK by the name of <a href="https://github.com/boto/boto">boto,</a> you can do a backup instance instance with a script.  But for now, we will look at the scripts that prepare the machine for working with Jupyter after it has been launched. <br><br>  All this is in <a href="https://github.com/Yorko/aws_jupyter_anaconda">the</a> Github <a href="https://github.com/Yorko/aws_jupyter_anaconda">repository</a> . <br><br>  In total, you will need 3 files: <br><ul><li>  In config.txt, write the path to your pem-file, the host of the newly issued instance, as well as the hashed password to access the Jupyter server, which we created a little earlier. <br><pre> <code class="bash hljs">pemfile=<span class="hljs-string"><span class="hljs-string">'&lt;PEM-file&gt;.pem'</span></span> host=<span class="hljs-string"><span class="hljs-string">'&lt;HOST&gt;'</span></span> jupyter_password=<span class="hljs-string"><span class="hljs-string">'&lt;JUPYTER_PASSWORD&gt;'</span></span></code> </pre><br></li><li>  In remote_setup.sh, you add everything you want to do on a remote machine. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Installing Miniconda wget -c http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh bash Miniconda-latest-Linux-x86_64.sh -b -p /home/ubuntu/miniconda export PATH=/home/ubuntu/miniconda/bin:$PATH #Installing neccesary libraries conda install -y numpy scipy pandas scikit-learn jupyter #Can add whatever you want to install #sudo apt-get -qq install vowpal-wabbit #sudo apt-get -qq install git ipython profile create nbserver printf "\n# Configuration file for ipython-notebook.\n c = get_config()\n # Notebook config\n c.NotebookApp.password = u'"$1"'\n c.NotebookApp.ip = '*'\n c.NotebookApp.open_browser = False\n c.NotebookApp.port = 8888\n" &gt; ~/.ipython/profile_nbserver/ipython_notebook_config.py ipython notebook --config="~/.ipython/profile_nbserver/ipython_notebook_config.py" --certfile=jupyter.pem</span></span></code> </pre><br></li><li>  The launch_remote_setup.sh script simply executes remote_setup.sh with the necessary parameters on the remote machine. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">source</span></span> <span class="hljs-string"><span class="hljs-string">'config.txt'</span></span> scp -i <span class="hljs-variable"><span class="hljs-variable">$pemfile</span></span> ./ipython.pem ubuntu@<span class="hljs-variable"><span class="hljs-variable">$remote_host</span></span>:~ ssh -i <span class="hljs-variable"><span class="hljs-variable">$pemfile</span></span> ubuntu@<span class="hljs-variable"><span class="hljs-variable">$remote_host</span></span> <span class="hljs-string"><span class="hljs-string">'bash -s'</span></span> &lt; remote_setup.sh <span class="hljs-variable"><span class="hljs-variable">$jupyter_password</span></span></code> </pre><br></li></ul><br><br>  In the desired directory run: <br><pre> <code class="bash hljs">sh launch_remote_setup.sh</code> </pre><br><br>  5-7 minutes and that's it!  You can work with Jupyter server. <br><br>  Already I was about to pour tea.  <b>But!</b>  <b>Very important moment!</b> <br>  At the end of the work, stop your instance. <br>  EC2 -&gt; Instances -&gt; Actions -&gt; Instance State -&gt; Terminate. <br><br>  It is the terminate, not the stop (although this is only available for the spot ones).  But in the case of instances running on demand, stop does not completely turn off the machine, they can run into money for data exchange. <br><br><img src="https://habrastorage.org/files/3f2/343/3f3/3f23433f39d3497a8283156549f40c54.png"><br><br>  Finally, you can discuss a little finance.  The current account is checked at Amazon when you click on your name and then on ‚ÄúBilling &amp; Cost Management‚Äù. <br>  $ 0.25 / hour is about $ 25 per month, if you use for 4 hours every weekday.  Then everyone decides for himself whether he is ready for such expenses. <br><br>  You can advertise here and the <a href="https://education.github.com/pack">GitHub Student Developer's Pack</a> - I personally got the Amazon certificate for $ 110 with them, I still use it.  In addition, you can get an Amazon grant for serious research projects. <br><br><h2>  Conclusion </h2><br>  That's all for now.  I think for some it was a jump-start in Amazon Web Services EC2.  Let our cars rest at night! <br><br>  Ps.  Comments / tips / experience sharing / pull requests are welcome. </div><p>Source: <a href="https://habr.com/ru/post/280562/">https://habr.com/ru/post/280562/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280550/index.html">To help DevOps: a firmware builder for network devices on Debian for 1008 hours</a></li>
<li><a href="../280552/index.html">Logeek Night meeting for Java specialists from Kazan</a></li>
<li><a href="../280554/index.html">Parsing qualifying rounds Technocup</a></li>
<li><a href="../280556/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 33. "Exit Strategy"</a></li>
<li><a href="../280560/index.html">Ubuntu integrated into Windows 10</a></li>
<li><a href="../280564/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 35. "Verdict"</a></li>
<li><a href="../280574/index.html">Processing sms on a heap of identical gsm modems without violence against udev</a></li>
<li><a href="../280576/index.html">‚ÄúPublic organizations and IT community: ideas and cooperation‚Äù. We invite you to Metap in Petersburg</a></li>
<li><a href="../280578/index.html">More than 60 tools for monitoring Windows</a></li>
<li><a href="../280580/index.html">Ostro Pot - open source multi-cooker based on OS Ostro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>