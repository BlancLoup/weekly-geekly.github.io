<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pg_variables extension</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pg_variables extension 


 Often, when developing application software, you may encounter a problem of this kind - for intermediate data, you need to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pg_variables extension</h1><div class="post__text post__text-html js-mediator-article"><h1>  Pg_variables extension </h1><br><p>  Often, when developing application software, you may encounter a problem of this kind - for intermediate data, you need to obtain several result sets, for example, for some products you must be able to obtain their presence in current orders and the amount of discounts issued for them earlier;  or for some users, get a list of their friends and messages of these users in social networks, etc., etc. </p><br><p>  The solution usually looks quite straightforward - first we get a list of, say, users, then for them we build the required result set;  then again we get a list of users and build the second set;  and everything would be fine if building such a list would not turn out to be a rather costly operation - and thus, if several results are to be built on the basis of this list, then it turns out that this list should be obtained several times with all associated overhead costs.  Temporary tables seem to be the obvious solution to this problem, and this is true;  unfortunately, a number of not very pleasant features are associated with them - for each temporary table it is required to create a file (and when deleting a table, delete it).  In addition, these tables, of course, are not visible for the processes of auto-vacuum and, therefore, are not cleared automatically, and statistics are not collected for them.  Worse yet, with long active transactions, unlimited growth of the system catalog can occur;  moreover, the operating system cache is filled with data about the created files for temporary tables, which leads to a general performance degradation. </p><br><p>  It should also be noted that since the name of the table should be known when compiling a query, the use of different tables can be quite awkward and makes it necessary to resort to the dynamic formation of queries with all the ensuing consequences;  if we recall that plpgsql for dynamic queries does not save the plan, then in cases of complex queries this can be a significant problem. </p><a name="habracut"></a><br><p>  Another obvious solution is arrays, but they also have a number of drawbacks.  First, arrays are immutable;  for small arrays it is not scary, but for large ones it can be quite unpleasant;  secondly, arrays exist only during the execution of the query, and not the entire lifetime of the session;  and, thirdly, arrays do not allow searching by key. </p><br><p>  Even for the session often requires temporary data available to all functions for the duration of the request - the current user, rights, etc. </p><br><p>  Finally, when executing read-only requests on a replica, it is often necessary to store temporary data somewhere. </p><br><p>  To avoid such problems, the intended extension is intended. </p><br><p>  What does it do? </p><br><p>  First, it allows you to define scalar session variables, which in itself can be very valuable - for example, you can store the identifier of the user on whose behalf the request is being made, his, the user, various attributes.  For example: </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pgv_set_int(<span class="hljs-string"><span class="hljs-string">'package'</span></span>,<span class="hljs-string"><span class="hljs-string">'usr_id'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  and then: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pgv_get_int(<span class="hljs-string"><span class="hljs-string">'package'</span></span>,<span class="hljs-string"><span class="hljs-string">'usr_id'</span></span>)</code> </pre> <br><p>  Here (and further) <code>package</code> is the name of the package, <code>usr_id</code> is the name of the variable in this package.  Of course, there can be many such variables: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pgv_set_int(<span class="hljs-string"><span class="hljs-string">'package'</span></span>,<span class="hljs-string"><span class="hljs-string">'#'</span></span>||n,n), n <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1000000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs(n)</code> </pre> <br><p>  In addition to the type of <code>integer</code> may be others - <code>text</code> , <code>numeric</code> , <code>timestamp</code> , <code>timestamptz</code> , <code>date</code> and <code>jsonb</code> .  All of these variables exist during the life of the session that set them, and are not available to others. </p><br><p>  In addition to scalar variables, this extension also supports sets. </p><br><p>  Hereinafter, a test database of three tables is used, representing hypothetical users ( <code>ord.usr</code> ), products ( <code>ord.goods</code> ) and discounts for users on goods ( <code>ord.discount</code> ).  The database was created using the <code>datafiller</code> utility ( <a href="https://www.cri.ensmp.fr/people/coelho/datafiller.html">https://www.cri.ensmp.fr/people/coelho/datafiller.html</a> ) with the following settings file: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ord.goods( <span class="hljs-comment"><span class="hljs-comment">-- df: mult=1000.0 id SERIAL primary key, name TEXT NOT NULL, -- df: lenmin=3 lenmax=30 chars='af ' sub=uniform price numeric, -- df: float=gauss alpha=100.0 beta=30 in_stock_qty int -- df: size=1000 ); create table ord.usr( -- df: mult=100 id serial primary key, email text -- df: pattern='[az]{3,16}\.[az]{3,8}@((gmail|yahoo|mail)\.com|(mail|yandex|inbox)\.ru)' ); create table ord.discount( -- df: mult=100 goods_id int not null references ord.goods(id), usr_id int not null references ord.usr(id), pct numeric not null, -- df: alpha=0.01 beta=0.07 from_date date not null, -- df: start=2010-01-01 end=2016-04-01 duration integer not null -- df: offset=1 size=361 step=30 )</span></span></code> </pre> <br><p>  Let's look in more detail.  First, build a list of all mail.ru users: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pgv_insert(<span class="hljs-string"><span class="hljs-string">'package'</span></span>, <span class="hljs-string"><span class="hljs-string">'set'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>(u.id, u.email)) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ord.usr u <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> u.email <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%@mail.ru'</span></span></code> </pre> <br><p>  How expensive is it? </p><br><pre> <code class="hljs pgsql"> QUERY PLAN Seq Scan <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> usr u (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.2041</span></span><span class="hljs-number"><span class="hljs-number">.96</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">23984</span></span> width=<span class="hljs-number"><span class="hljs-number">30</span></span>) (actual <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.022</span></span>.<span class="hljs-number"><span class="hljs-number">.24</span></span><span class="hljs-number"><span class="hljs-number">.893</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Filter</span></span>: (email ~~ <span class="hljs-string"><span class="hljs-string">'%@mail.ru'</span></span>::<span class="hljs-type"><span class="hljs-type">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span> Removed <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Filter</span></span>: <span class="hljs-number"><span class="hljs-number">83574</span></span> Planning <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">0.070</span></span> ms Execution <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">25.404</span></span> ms (<span class="hljs-number"><span class="hljs-number">5</span></span> )</code> </pre> <br><p>  They can be obtained as: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgv_select(<span class="hljs-string"><span class="hljs-string">'package'</span></span>,<span class="hljs-string"><span class="hljs-string">'set'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> usr(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, email <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>)</code> </pre> <br><p>  What is the performance of this operation?  Let's get a look: </p><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> Scan <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pgv_select usr (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1000</span></span> width=<span class="hljs-number"><span class="hljs-number">36</span></span>) (actual <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">4.692</span></span>.<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.503</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) Planning <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">0.026</span></span> ms Execution <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">10.733</span></span> ms (<span class="hljs-number"><span class="hljs-number">3</span></span> )</code> </pre> <br><p>  Compare with normal sampling: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> usr_id_email( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, email <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> );</code> </pre> <br><p>  and </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> usr_id_email <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> u.id, u.email <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ord.usr u <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> u.email <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%@mail.ru'</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">Insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> usr_id_email (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.1982</span></span><span class="hljs-number"><span class="hljs-number">.00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">23984</span></span> width=<span class="hljs-number"><span class="hljs-number">30</span></span>) (actual <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">31.244</span></span>.<span class="hljs-number"><span class="hljs-number">.31</span></span><span class="hljs-number"><span class="hljs-number">.244</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; Seq Scan <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> usr u (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.1982</span></span><span class="hljs-number"><span class="hljs-number">.00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">23984</span></span> width=<span class="hljs-number"><span class="hljs-number">30</span></span>) (actual <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.007</span></span>.<span class="hljs-number"><span class="hljs-number">.16</span></span><span class="hljs-number"><span class="hljs-number">.220</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Filter</span></span>: (email ~~ <span class="hljs-string"><span class="hljs-string">'%@mail.ru'</span></span>::<span class="hljs-type"><span class="hljs-type">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span> Removed <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Filter</span></span>: <span class="hljs-number"><span class="hljs-number">83574</span></span> Planning <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">0.069</span></span> ms Execution <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">31.285</span></span> ms</code> </pre> <br><p>  As you can see, the <code>pgv_insert</code> execution time is noticeably less than the variant with the temporary table;  In addition, the execution time of a variant with a temporary table largely depends on the state of the OS cache, since, as noted above, a file is created for each temporary table (and when deleted, respectively, it is deleted). </p><br><p>  If you look closely at the code above, you can make quite a fair remark - in the variant with a temporary table, the id column is the primary key;  how fair is it with <code>pgv_insert</code> ?  In general, quite honestly: from the result constructed by <code>pgv_insert</code> you can also get a string by user id: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgv_select(<span class="hljs-string"><span class="hljs-string">'package'</span></span>,<span class="hljs-string"><span class="hljs-string">'set'</span></span>,<span class="hljs-number"><span class="hljs-number">9545</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, email <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>)</code> </pre> <br><p>  When saving the result set, the first column in the added rows is the primary key.  Accordingly, it must, firstly, be unique, and, secondly, it can be used to quickly find strings. </p><br><p>  How fast is the sample in relation to the time table?  Compare: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs(n) <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> pgv_select(<span class="hljs-string"><span class="hljs-string">'package'</span></span>,<span class="hljs-string"><span class="hljs-string">'set'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, email <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">Nested</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Join</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.01</span></span>.<span class="hljs-number"><span class="hljs-number">.20010</span></span><span class="hljs-number"><span class="hljs-number">.01</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1000000</span></span> width=<span class="hljs-number"><span class="hljs-number">40</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">10.282</span></span>.<span class="hljs-number"><span class="hljs-number">.2495</span></span><span class="hljs-number"><span class="hljs-number">.984</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426000</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Scan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> generate_series gs (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1000</span></span> width=<span class="hljs-number"><span class="hljs-number">4</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.171</span></span>.<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.279</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1000</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Scan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pgv_select t (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1000</span></span> width=<span class="hljs-number"><span class="hljs-number">36</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.010</span></span>.<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.817</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1000</span></span>) Planning <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-number"><span class="hljs-number">0.061</span></span> ms Execution <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-number"><span class="hljs-number">2991.351</span></span> ms</code> </pre> <br><p>  and </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs(n) <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> usr_id_email <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">Nested</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Join</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.189230</span></span><span class="hljs-number"><span class="hljs-number">.42</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">15113000</span></span> width=<span class="hljs-number"><span class="hljs-number">40</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.172</span></span>.<span class="hljs-number"><span class="hljs-number">.2390</span></span><span class="hljs-number"><span class="hljs-number">.766</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426000</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">' -&gt; Function Scan on generate_series gs (cost=0.00..10.00 rows=1000 width=4) (actual time=0.159..0.288 rows=1000 loops=1) -&gt; Materialize (cost=0.00..345.69 rows=15113 width=36) (actual time=0.000..0.738 rows=16426 loops=1000) -&gt; Seq Scan on usr_id_email (cost=0.00..270.13 rows=15113 width=36) (actual time=0.010..2.660 rows=16426 loops=1) Planning time: 0.076 ms Execution time: 2874.250 ms</span></span></code> </pre> <br><p>  As you can see, the time is quite comparable - one operation is slower compared to the temporary table by about 0.1 ms. <br>  What is the speed of access to a particular row compared to temporary tables?  We'll see: </p><br><p>  In one case of pgv_select, you can specify the primary key of the string that we need: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> usr_id_email uie <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgv_select(<span class="hljs-string"><span class="hljs-string">'package'</span></span>,<span class="hljs-string"><span class="hljs-string">'set'</span></span>,uie.id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, email <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>)) : Seq <span class="hljs-keyword"><span class="hljs-keyword">Scan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> usr_id_email uie (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.459</span></span><span class="hljs-number"><span class="hljs-number">.04</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">7556</span></span> width=<span class="hljs-number"><span class="hljs-number">36</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.021</span></span>.<span class="hljs-number"><span class="hljs-number">.19</span></span><span class="hljs-number"><span class="hljs-number">.947</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) Filter: (SubPlan <span class="hljs-number"><span class="hljs-number">1</span></span>) SubPlan <span class="hljs-number"><span class="hljs-number">1</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Scan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pgv_select t (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.1000</span></span><span class="hljs-number"><span class="hljs-number">.00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">100000</span></span> width=<span class="hljs-number"><span class="hljs-number">0</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.001</span></span>.<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.001</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> loops=<span class="hljs-number"><span class="hljs-number">16426</span></span>) Planning <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-number"><span class="hljs-number">0.047</span></span> ms Execution <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-number"><span class="hljs-number">20.704</span></span> ms</code> </pre> <br><p>  Compare with our temporary table: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> enable_hashjoin=<span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> enable_mergejoin=<span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> usr_id_email uie <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> usr_id_email uie2 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> uie.id=uie2.id) <span class="hljs-keyword"><span class="hljs-keyword">Nested</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> Semi <span class="hljs-keyword"><span class="hljs-keyword">Join</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.29</span></span>.<span class="hljs-number"><span class="hljs-number">.5620</span></span><span class="hljs-number"><span class="hljs-number">.94</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">15113</span></span> width=<span class="hljs-number"><span class="hljs-number">36</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.016</span></span>.<span class="hljs-number"><span class="hljs-number">.17</span></span><span class="hljs-number"><span class="hljs-number">.227</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; Seq <span class="hljs-keyword"><span class="hljs-keyword">Scan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> usr_id_email uie (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.270</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">15113</span></span> width=<span class="hljs-number"><span class="hljs-number">36</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.007</span></span>.<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.130</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Only</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Scan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> usr_id_email_pkey <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> usr_id_email uie2 (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.29</span></span>.<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.34</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> width=<span class="hljs-number"><span class="hljs-number">4</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.001</span></span>.<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.001</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> loops=<span class="hljs-number"><span class="hljs-number">16426</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> Cond: (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = uie.id) <span class="hljs-keyword"><span class="hljs-keyword">Heap</span></span> Fetches: <span class="hljs-number"><span class="hljs-number">16426</span></span> Planning <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-number"><span class="hljs-number">0.082</span></span> ms Execution <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-number"><span class="hljs-number">17.976</span></span> ms</code> </pre> <br><p>  As we see, time is quite comparable;  however, I had to disable some connection methods.  By the way, if you turn them on, you can consider another option, and its result in our case is much better: </p><br><pre> <code class="hljs pgsql">Hash Semi <span class="hljs-keyword"><span class="hljs-keyword">Join</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">459.04</span></span>.<span class="hljs-number"><span class="hljs-number">.936</span></span><span class="hljs-number"><span class="hljs-number">.98</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">15113</span></span> width=<span class="hljs-number"><span class="hljs-number">36</span></span>) (actual <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">5.171</span></span>.<span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.703</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) Hash Cond: (uie.id = uie2.id) -&gt; Seq Scan <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> usr_id_email uie (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.270</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">15113</span></span> width=<span class="hljs-number"><span class="hljs-number">36</span></span>) (actual <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.008</span></span>.<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.857</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; Hash (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">270.13</span></span>.<span class="hljs-number"><span class="hljs-number">.270</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">15113</span></span> width=<span class="hljs-number"><span class="hljs-number">4</span></span>) (actual <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">5.150</span></span>.<span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.150</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) Buckets: <span class="hljs-number"><span class="hljs-number">32768</span></span> (originally <span class="hljs-number"><span class="hljs-number">16384</span></span>) Batches: <span class="hljs-number"><span class="hljs-number">1</span></span> (originally <span class="hljs-number"><span class="hljs-number">1</span></span>) Memory <span class="hljs-keyword"><span class="hljs-keyword">Usage</span></span>: <span class="hljs-number"><span class="hljs-number">513</span></span>kB -&gt; Seq Scan <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> usr_id_email uie2 (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.270</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">15113</span></span> width=<span class="hljs-number"><span class="hljs-number">4</span></span>) (actual <span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.003</span></span>.<span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.417</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">16426</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) Planning <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">0.107</span></span> ms Execution <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">13.603</span></span> ms</code> </pre><br><p>  But these are all largely theoretical reflections, and it is worth seeing what will happen in the case of more or less real workload.  We will use the <code>pgbench</code> utility for this, but first we will create the following functions.  Simple request: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.get_mailru_discounts_plain() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span>(usr_cnt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, discounts_cnt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> usr_cnt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ord.usr u <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> u.email <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'ab%@mail.ru'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> discounts_cnt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ord.discount d, ord.usr u <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> u.email <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'ab%@mail.ru'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> d.usr_id=u.id; return next; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; $BODY$ LANGUAGE plpgsql;</code> </pre> <br><p>  Using a temporary table: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.get_mailru_discounts_array() <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span>(usr_cnt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, discounts_cnt <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> ids <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>[]; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> array_agg(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ids <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ord.usr u <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> u.email <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'ab%@mail.ru'</span></span>; get diagnostics usr_cnt = row_count; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> discounts_cnt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ord.discount d <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> d.usr_id=<span class="hljs-keyword"><span class="hljs-keyword">any</span></span>(ids); return next; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; $BODY$ LANGUAGE plpgsql VOLATILE COST 100 ROWS 1000;</code> </pre> <br><p>  Using extensions: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> get_mailru_discounts_pgvariables() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(usr_cnt <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, discounts_cnt <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $code$ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgv_list() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span>=<span class="hljs-string"><span class="hljs-string">'package'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=<span class="hljs-string"><span class="hljs-string">'set'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> perform pgv_remove(<span class="hljs-string"><span class="hljs-string">'package'</span></span>,<span class="hljs-string"><span class="hljs-string">'set'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; perform pgv_insert('package', '<span class="hljs-keyword"><span class="hljs-keyword">set</span></span><span class="hljs-string"><span class="hljs-string">', row(id)) from ord.usr u where u.email like '</span></span>%@mail.ru<span class="hljs-string"><span class="hljs-string">'; get diagnostics usr_cnt = row_count; select count(*) into discounts_cnt from ord.discount d, pgv_select('</span></span><span class="hljs-keyword"><span class="hljs-keyword">package</span></span><span class="hljs-string"><span class="hljs-string">','</span></span><span class="hljs-keyword"><span class="hljs-keyword">set</span></span><span class="hljs-string"><span class="hljs-string">') u(id int) where d.usr_id=u.id; return next; end; $code$ language plpgsql;</span></span></code> </pre> <br><p>  Request files are simple: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_mailru_discounts_plain</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_mailru_discounts_temptable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_mailru_discounts_pgvariables</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;</code> </pre> <br><p>  Starting pgbench: </p><br><pre> <code class="hljs pgsql">pgbench -h localhost -p <span class="hljs-number"><span class="hljs-number">5433</span></span> -U postgres -M <span class="hljs-keyword"><span class="hljs-keyword">prepared</span></span>-c <span class="hljs-number"><span class="hljs-number">32</span></span> -j <span class="hljs-number"><span class="hljs-number">2</span></span> -n -f /tmp/test.pgb <span class="hljs-keyword"><span class="hljs-keyword">work</span></span></code> </pre> <br><p>  The results are presented in the table: </p><br><table><thead><tr><th>  Option - Transaction </th><th>  100 </th><th>  1000 </th><th>  5000 </th><th>  10,000 </th><th>  20,000 </th></tr></thead><tbody><tr><td>  plain </td><td>  10170 </td><td>  11349 </td><td>  11537 </td><td>  11560 </td><td>  11639 </td></tr><tr><td>  temptable </td><td>  3364 </td><td>  3380 </td><td>  561 </td><td>  678 </td><td>  378 </td></tr><tr><td>  pg_variables </td><td>  11852 </td><td>  15944 </td><td>  16634 </td><td>  16748 </td><td>  16719 </td></tr></tbody></table><br><p>  As you can see, after a while the already low performance of the procedure using a temporary table drops even more;  this is connected, as noted above, with filling the OS cache with garbage data about temporary tables that become unnecessary files.  It is curious to follow the output of pgbench (run on 5000 transactions): </p><br><pre> <code class="hljs css">... <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 1<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 2205<span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 11<span class="hljs-selector-class"><span class="hljs-selector-class">.907</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 13<span class="hljs-selector-class"><span class="hljs-selector-class">.122</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 2<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 2497<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 12<span class="hljs-selector-class"><span class="hljs-selector-class">.237</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 14<span class="hljs-selector-class"><span class="hljs-selector-class">.372</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 3<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 1945<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 15<span class="hljs-selector-class"><span class="hljs-selector-class">.882</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 22<span class="hljs-selector-class"><span class="hljs-selector-class">.674</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 4<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 2746<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 12<span class="hljs-selector-class"><span class="hljs-selector-class">.569</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 16<span class="hljs-selector-class"><span class="hljs-selector-class">.776</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 5<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 1814<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 16<span class="hljs-selector-class"><span class="hljs-selector-class">.601</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 27<span class="hljs-selector-class"><span class="hljs-selector-class">.144</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 6<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 2067<span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 15<span class="hljs-selector-class"><span class="hljs-selector-class">.629</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 24<span class="hljs-selector-class"><span class="hljs-selector-class">.284</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 7<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 1535<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 20<span class="hljs-selector-class"><span class="hljs-selector-class">.828</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 30<span class="hljs-selector-class"><span class="hljs-selector-class">.302</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 8<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 862<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 37<span class="hljs-selector-class"><span class="hljs-selector-class">.671</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 45<span class="hljs-selector-class"><span class="hljs-selector-class">.891</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 9<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 1312<span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 25<span class="hljs-selector-class"><span class="hljs-selector-class">.218</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 35<span class="hljs-selector-class"><span class="hljs-selector-class">.340</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 1213<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 25<span class="hljs-selector-class"><span class="hljs-selector-class">.686</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 37<span class="hljs-selector-class"><span class="hljs-selector-class">.921</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 11<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 962<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 33<span class="hljs-selector-class"><span class="hljs-selector-class">.685</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 37<span class="hljs-selector-class"><span class="hljs-selector-class">.641</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 12<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 1455<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 22<span class="hljs-selector-class"><span class="hljs-selector-class">.055</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 27<span class="hljs-selector-class"><span class="hljs-selector-class">.562</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 13<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 1146<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 28<span class="hljs-selector-class"><span class="hljs-selector-class">.127</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 33<span class="hljs-selector-class"><span class="hljs-selector-class">.272</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 14<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 791<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 37<span class="hljs-selector-class"><span class="hljs-selector-class">.760</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 41<span class="hljs-selector-class"><span class="hljs-selector-class">.861</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">progress</span></span>: 15<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s</span></span>, 659<span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tps</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">lat</span></span> 42<span class="hljs-selector-class"><span class="hljs-selector-class">.713</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stddev</span></span> 51<span class="hljs-selector-class"><span class="hljs-selector-class">.816</span></span> ...</code> </pre> <br><p>  You can clearly see how the performance fluctuates - starting relatively quickly from 2205 tps, it quickly rolls down to half a thousand, and then drops even more.  Command execution </p><br><pre> <code class="hljs ruby">/bin/echo <span class="hljs-number"><span class="hljs-number">3</span></span> &gt;<span class="hljs-regexp"><span class="hljs-regexp">/proc/sys</span></span><span class="hljs-regexp"><span class="hljs-regexp">/vm/drop</span></span>_caches</code> </pre> <br><p>  improves the situation somewhat, but not for long. </p><br><p>  From the above tests, it is clear that, as a temporary data warehouse, the pg_variables module is much more efficient than temporary tables, and more convenient ‚Äî in fact, the data set is defined by a packet-variable pair, which can be passed as parameters, returned from etc. </p><br><p>  Partly, unfortunately, the data saved by the extension means exists outside the transaction ‚Äî it is saved both in the case of a committed transaction and in the case of a rollback;  Moreover, even with the execution of a separate command, partial data can be obtained: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">work</span></span>=# <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pgv_insert(<span class="hljs-string"><span class="hljs-string">'package'</span></span>, <span class="hljs-string"><span class="hljs-string">'errs'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>(n)) <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>-# <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs(n) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span>/(n<span class="hljs-number"><span class="hljs-number">-3</span></span>)&lt;&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>; :    <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>=# <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgv_select(<span class="hljs-string"><span class="hljs-string">'package'</span></span>,<span class="hljs-string"><span class="hljs-string">'errs'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> r(i <span class="hljs-type"><span class="hljs-type">int</span></span>); i <span class="hljs-comment"><span class="hljs-comment">--- 1 2 (2 )</span></span></code> </pre> <br><p>  On the one hand, this is not very convenient - in some cases it is necessary to provide for the deletion of incorrectly entered data, but in others it can be very useful - for example, to save some data even in case of a rollback of a transaction. </p><br><p>  Of course, the presented module has drawbacks - for example, it will not be the most successful solution if you need to perform some complex search in a large amount of temporary data - it will be more convenient and productive to create a temporary table, insert data there, build indices (any! And not just a hash in one column), collect statistics and execute the required query with it. </p><br><p>  At the same time, it is probably worth noting that in some cases temporary tables can also be quite a reasonable solution - when the flow of transactions is not too large.  In fact, with a load of 10 tps, the option with temporary tables will behave fairly acceptable, unless you remember that lengthy transactions in other sessions may lead to an increase in the size of the system catalog. </p><br><p>  Full documentation of the module can be viewed at the link: <a href="https://github.com/postgrespro/pg_variables">https://github.com/postgrespro/pg_variables</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/302200/">https://habr.com/ru/post/302200/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302188/index.html">DevConf :: JavaScript - support your favorite JS framework</a></li>
<li><a href="../302192/index.html">Workshops to identify requirements for IT-projects: how and why to carry them out?</a></li>
<li><a href="../302194/index.html">Smart Transport: New Information Security Challenges</a></li>
<li><a href="../302196/index.html">Lasers for Guidance and Geodesy: Innovations from ITMO University</a></li>
<li><a href="../302198/index.html">Analysis of VoIP calls in Wireshark</a></li>
<li><a href="../302202/index.html">Google I / O 2016: Test and Application Improvements</a></li>
<li><a href="../302204/index.html">Extending the Kivy Framework with the XPopup Package (Part 2)</a></li>
<li><a href="../302206/index.html">Paul Graham: ‚ÄúBe relentlessly resourceful‚Äù (relentlessly resourceful)</a></li>
<li><a href="../302208/index.html">Robots and Robotics: ITMO University Digest</a></li>
<li><a href="../302212/index.html">How and what to choose the mobile Internet? GSM decoding</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>