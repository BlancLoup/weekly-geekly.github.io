<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We communicate with the SIM card at a low level</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="f: I can‚Äôt imagine how a cruiser can work) Our students usually gather somewhere on the shelves 
 m: Here I have a fee. You need to get a SIM card for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We communicate with the SIM card at a low level</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/975/c19/26b/975c1926ba69b3af608a08a9915c0e26.jpg"><br>  <em>f: I can‚Äôt imagine how a cruiser can work) Our students usually gather somewhere on the shelves</em> <em><br></em>  <em>m: Here I have a fee.</em>  <em>You need to get a SIM card for it, and this card should read SMS from there)</em> <em><br></em>  <em>m: purchase fee, but we program it)</em> <em><br></em>  <em>f: can you not read the SMS from the phone?</em> <br>  - from life, spelling preserved <br><br><br><br>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Well, if you are still interested to learn more about SIM cards, transfer protocols and their file structure, I ask for cat.  Well, where without the code ... <br><br><a name="habracut"></a><br><br><h1>  1. Introduction </h1><br>  You should start with the fact that the SIM card is a kind of smart card, so it fully complies with the ISO-7816 standard.  I will not say what conclusions it has (this was already discussed in detail in the <a href="http://habrahabr.ru/company/beeline/blog/133388/">previous article</a> ). <br><br>  Some SIM cards (more precisely, smart cards) can supply a clock signal up to 20 MHz.  But after all, when the SIM card is turned on, the terminal does not know its parameters, therefore, communication begins with a maximum of 4 MHz.  Subsequently, the terminal recognizes Simka better and can change the transmission parameters. <br><br>  A pull-up resistor of 20 KŒ© must be connected to the I / O pin.  In those moments when the terminal and SIM card have nothing to say to each other (i.e., they are both in the Z-state), this resistor will provide a logical unit at the output. <br><br><h1>  2. Activation / Deactivation </h1><br><h4>  SIM card activation and subsequent cold reset </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/c53/279/d32/c53279d32fd77b8e38950c9fef973acc.png"><br><br>  The diagram is quite simple, cold reset starts from the time point T <sub>a</sub> .  It is only necessary to note that I / O is controlled here only by a sim card.  The terminal should ignore any signal on it while RST is at zero.  After Simka is obliged to give an answer (Answer to reset). <br><br><h4>  Deactivation </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/6e2/f47/3fa/6e2f473fafdbe194a18a1d2c9d58b7ad.png"><br><br>  There is no definite time frame, I / O is also controlled by a sim card. <br><br><h1>  3. Transmission protocols </h1><br>  All smart cards and, accordingly, SIM cards, there are two types of transmission protocols - byte T0 and block T1.  I will consider only T0. <br><br>  At once I will say that T0 is like two peas in a pod like UART (it is used in the transmission on the COM port).  But with a few reservations.  Let's start from the beginning. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/542/bc9/7b7/542bc97b79dab5d47bd40303b42f9397.png"><br><br>  The time in the T0 protocol is called the elementary unit of time (etu), which is equal to: <br><img src="https://habrastorage.org/getpro/habr/post_images/309/cd3/ba0/309cd3ba0502658fee56a34e54d06f91.png"><br><br>  where F (clock conversion rate) and D (bit rate control factor) are set based on the ATR, and f is the clock frequency for the card.  By default, F = 372, and D = 1. <br><br>  The transfer on the I / O pin begins with the advent of the start bit - the decay from the logical one.  The time allotted to each bit is etu.  Next come 8 data bits, 1 parity bit and at least 2 stop bits.  The time interval between two start bits must always be greater than or equal to 12 etu and less than or equal to 9,600 etu. <br><br><h1>  4. Answer to reset </h1><br>  As I said, Simka sends an ATR after a cold reset.  It contains information with the recommended value of the synchronization frequency, a list of supporting transmission protocols, etc. <br><br>  The very first byte in ATR is TS.  It shows which encoding is applied, direct or inverse. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d9c/05d/816/d9c05d8168102127d534dede8f73dc37.png"><br><br>  Forward encoding: if TS is HHLH HHLL, then the high voltage level in the I / O circuit encodes a logical unit, and time 2 in the figure encodes the <strong>least significant bit</strong> .  With this encoding, the TS byte value is 0x3B. <br><br>  Reverse coding: if TS is HHLL LLLL, then the low voltage level in the I / O circuit encodes a logical one, and H is a logical zero.  Time 2 in the figure encodes the <strong>most significant bit</strong> .  With this encoding, the TS byte value is 0x3F. <br><br>  The remaining bytes contain service information, for example, the recommended values ‚Äã‚Äãof F and D, affecting the value of etu. <br><br><h1>  5. Command structure </h1><br>  Commands are divided into two types: Command Transport Data Unit (C-TPDU) and Response Transport Data Unit (R-TPDU), i.e.  team and the answer to it.  Teams always make up a pair: R-TPDU will respond to any command transmitted to the card.  R-TPDU always ends with a status byte characterizing the success of a command. <br><br>  C-TPDU structure: <table cellpadding="10"><caption>  <font>table 1</font> </caption><tbody><tr><td>  Code </td><td>  Length </td><td>  Description </td><td></td></tr><tr><td>  CLA </td><td>  one </td><td>  Instruction class </td><td rowspan="5">  Headline </td></tr><tr><td>  INS </td><td>  one </td><td>  Instruction code </td></tr><tr><td>  P1 </td><td>  one </td><td>  Parameter instructions 1 </td></tr><tr><td>  P2 </td><td>  one </td><td>  Parameter instructions 2 </td></tr><tr><td>  Lc </td><td>  0 or 1 </td><td>  The number of bytes in the Data field </td></tr><tr><td>  Data </td><td>  Lc </td><td>  Command data </td><td rowspan="2">  Body </td></tr><tr><td>  Le </td><td>  0 or 1 </td><td>  Maximum number of bytes expected in response </td></tr></tbody></table><br><br>  Not all cards can immediately take the header and body of the team, in this case, you must first send the header, wait for the response status byte, and then send the body of the command. <br><br>  It is worth noting that if we make a mistake in any parameter of the command, Simka will report this in the status byte, but she has the right to ignore the command if it was absolutely incorrect (for example, it consisted of one byte). <br><br>  R-TPDU structure: <table cellpadding="10"><caption>  <font>table 2</font> </caption><tbody><tr><td>  Code </td><td>  Length </td><td>  Description </td></tr><tr><td>  Data </td><td>  Lr </td><td>  Response data </td></tr><tr><td>  SW1 </td><td>  one </td><td>  Status byte 1 </td></tr><tr><td>  SW2 </td><td>  one </td><td>  Status byte 2 </td></tr></tbody></table><br><br><h1>  6. File structure </h1><br>  File types: <br><br>  1. Master file (MF) - root. <br>  2. Dedicated files (DF) - ordinary folders. <br>  3. Elementary files (EF) are divided into: <br>  - Transparent EF - consist of a sequence of bytes, <br>  - Linear fixed EF - consist of a sequence of records of the same size, <br>  - Cyclic EF is the same, but when the end of the file is reached, the next entry starts with a zero entry, in a circle. <br><br><h1>  7. Examples of commands </h1><br>  Let's try to read and write the SMS message in the EF <sub>SMS</sub> file in the DF <sub>TELECOM</sub> folder. <br><img src="https://habrastorage.org/getpro/habr/post_images/5df/92f/44e/5df92f44e332088960fd9a127ffdf55b.png"><br><br>  1) <strong>SELECT</strong> <br><br>  Before performing a file operation, you must first select it.  First you need to select the folder DF <sub>TELECOM</sub> . <br><br>  Sending a SELECT command header: <br><br>  A0 A4 00 00 02 <br><br>  Answer - status byte: <br><br>  A4 (repeats byte instructions) <br><br>  Sending command body: <br><br>  7F 10 (ID of this folder) <br><br>  Similarly, choose EF <sub>SMS</sub> . <br><br>  2) <strong>READ RECORD</strong> <br><br>  After we have selected the file containing all the sms, you can try to read one of them. <br><br>  Sending the READ RECORD command header: <br><br>  A0 B2 01 04 B0 (01 is the sequence number of SMS) <br><br>  Answer: <br><br>  B2 07 07 91 97 62 92 90 90 F0 11 FF 04 81 21 43 00 08 FF 08 04 45 04 30 04 31 04 40 FF FF FF <br>  FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF <br>  FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF <br>  FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF <br>  FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF <br>  FF FF FF FF FF FF FF FF FF FF FF 90 00 <br><br>  All but the first and last two bytes (B2, 07, 90, 00) is a message record.  We analyze it. <br><br><table cellpadding="10"><caption>  <font>table 3</font> </caption><tbody><tr><td>  07 </td><td>  The length of the SMS center number in bytes. </td></tr><tr><td>  91 </td><td>  Type of SMS center number (in this case, it is presented in the international format). </td></tr><tr><td>  97 62 92 90 90 F0 </td><td>  SMS center number - + 7-926-290-90-90 (read from the end of the byte).  The symbol F is needed for alignment. </td></tr><tr><td>  eleven </td><td>  The length of the SMS center. </td></tr><tr><td>  04 </td><td>  The length of the number of the sender. </td></tr><tr><td>  81 </td><td>  Type of sender number. </td></tr><tr><td>  21 43 </td><td>  The number of the sender is 1234 (again read from the end of the byte). </td></tr><tr><td>  00 </td><td>  Protocol identifier </td></tr><tr><td>  08 </td><td>  Encoding (00 - only Latin, 08 - with Cyrillic). </td></tr><tr><td>  08 </td><td>  The length of the message in bytes. </td></tr><tr><td>  04 45 04 30 04 31 04 40 </td><td>  The message is ‚ÄúHabr.‚Äù  Encoded in UTF-16. </td></tr></tbody></table><br><br>  It is important to note that when the message contains only Latin characters, a special 7-bit GSM encoding is used. <br><br>  Take the word "hi". <br><br><table cellpadding="10"><caption>  <font>tab.4</font> </caption><tbody><tr><td>  h </td><td>  i </td><td></td></tr><tr><td>  68 </td><td>  69 </td><td>  We look in UTF-8. </td></tr><tr><td>  <u>0</u> 110 1000 </td><td>  0110 100 <u>1</u> </td><td>  Convert to binary. </td></tr><tr><td>  1110 1000 </td><td>  0011 0100 </td><td>  We supplement the high byte with the low bits of the next byte. </td></tr><tr><td>  E8 </td><td>  34 </td><td>  This is exactly what hi will look like in 7-bit encoding. </td></tr></tbody></table><br><br>  3) <strong>UPDATE RECORD</strong> <br><br>  Sending UPDATE RECORD command header: <br><br>  A0 DC 02 04 B0 (02 is the sequence number of SMS) <br><br>  Answer - status byte: <br><br>  DC (repeats byte instructions) <br><br>  Next, the command body is sent in accordance with Table 3. <br><br><h1>  8. Software and hardware implementation </h1><br>  As a hardware implementation was chosen FPGA Altera DE1, because  <s>Kurchach need to take</s> this great fee for small projects.  The entire project was written by me and <a href="http://geektimes.ru/users/breaknus/" class="user_link">Breaknus</a> , on VHDL and C. The development environments are Quartus II and Eclipse. <br><br>  The SIM card connector is soldered to the five wires of the IDE bus.  The board has internal pull-up resistors. <br><br>  Brief scheme of the project: <br><br>  For I / O data was assembled NIOS II processor.  After entering the command in the NIOS console, it is converted to hexadecimal code and transmitted byte-by-byte to the vhdl block.  In this block, the command is transmitted according to the T0 protocol on the SIM card I / O.  After receiving the response, the block transmits it to the NIOS, and the response is output to the NIOS console.  Card activation / deactivation is selected by a switch on the board.  The necessary timeframes for activation / deactivation, as well as the frequency of card synchronization are provided by the vhdl-block. <br><br>  <a href="http://www.mediafire.com/download.php%3Ftvdgdt269cadp3y">Download project</a> <br><br><h1>  Acknowledgments </h1><br>  I want to express my gratitude to Sukhinin Boris Mikhailovich.  It was he who introduced us to the world of FPGAs on wonderful laboratory and found time to answer our questions. <br><br><h1>  Useful information </h1><br>  1. <a href="http://en.wikipedia.org/wiki/ISO/IEC_7816">ISO-7816</a> (Wikipedia) <br>  2. <a href="http://www.etsi.org/deliver/etsi_ts/100900_100999/100977/08.14.00_60/ts_100977v081400p.pdf">ETSI TS 100 977</a> - Mobile Equipment (SIM-ME) Interface <br>  3. <a href="http://www.etsi.eu/deliver/etsi_ts/102200_102299/102221/08.02.00_60/ts_102221v080200p.pdf">ETSI TS 102 221</a> - UICC-Terminal interface </div><p>Source: <a href="https://habr.com/ru/post/137963/">https://habr.com/ru/post/137963/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137955/index.html">Payment interface, as a direct communication channel with developers</a></li>
<li><a href="../137956/index.html">Tighten the TCP / IP nuts on Solaris</a></li>
<li><a href="../137960/index.html">Some details about Class Based Views, part 4</a></li>
<li><a href="../137961/index.html">Protection against bots, based on differences in working with large numbers in JavaScript and PHP</a></li>
<li><a href="../137962/index.html">How to buy low customer loyalty?</a></li>
<li><a href="../137964/index.html">Free xml-source of cash exchange rates, as well as 3 convenient updates from the portal FINANCE.UA</a></li>
<li><a href="../137966/index.html">Filtering Input Characters in Ext.form.field.Number</a></li>
<li><a href="../137968/index.html">Joint promotion of Vodafone AU and Dropbox. + 2GB for your account</a></li>
<li><a href="../137969/index.html">DynLib: library for creating and working with DLL</a></li>
<li><a href="../137970/index.html">Apple is worth more than Google and Microsoft together</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>