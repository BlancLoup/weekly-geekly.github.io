<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write the extension for Chrome "download audio recordings from Vkontakte", part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to write our extension for Chrome, which adds a ‚ÄúDownload‚Äù link for each audio recording on VKontakte. 
 Last time, we changed our section...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write the extension for Chrome "download audio recordings from Vkontakte", part 2</h1><div class="post__text post__text-html js-mediator-article">  We continue to write our extension for Chrome, which adds a ‚ÄúDownload‚Äù link for each audio recording on VKontakte. <br>  <a href="http://habrahabr.ru/post/254005/">Last</a> time, we changed our section <i>My Audio Records</i> so. <br><table><thead><tr><td>  It was originally: </td><td>  Became with the extension: </td></tr></thead><tbody><tr><td><img src="https://habrastorage.org/files/18a/108/93a/18a10893a4204c7ead967d7be584477b.png" alt="Original"></td><td><img src="https://habrastorage.org/files/cdf/a24/806/cdfa248064404283a1463ecd5fbb2aec.png" alt="Result"></td></tr></tbody></table><br><br>  But, at that time, our expansion had a significant drawback: it did not work when going from page to page. <br>  If you go to the main page, then go to My Audio Records, then the links from the songs did not appear. <br>  I recall, VKontakte when moving from page to page does not update the page in the classical sense, but programmatically changes the page layout, and updates the address bar.  This is not a classic browser transition to a new page, and therefore our extension has not been updated. <br>  Let's fix it. <br><br>  As before, our extension will consist of three files - a description file (manifest.json), an injected js script (vk_inject.js), and an inline style file (vk_styles.css). <br><a name="habracut"></a><br>  Here is the main file extension: manifest.json.  It contains the extension descriptor and links to the embedded files. <br><div class="spoiler">  <b class="spoiler_title">manifest.json</b> <div class="spoiler_text"><pre><code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"manifest_version"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"       ."</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"content_scripts"</span></span>: [{ <span class="hljs-string"><span class="hljs-string">"matches"</span></span>: [<span class="hljs-string"><span class="hljs-string">"*://vk.com/*"</span></span>], <span class="hljs-string"><span class="hljs-string">"js"</span></span>: [<span class="hljs-string"><span class="hljs-string">"vk_inject.js"</span></span>], <span class="hljs-string"><span class="hljs-string">"css"</span></span>: [<span class="hljs-string"><span class="hljs-string">"vk_styles.css"</span></span>] }] }</code> </pre> <br></div></div><br>  The ‚Äúcontent_scripts‚Äù tag in the manifest determines which js and css files will be embedded in the page. <br>  Our extension will embed <i>vk_inject.js</i> and <i>vk_styles.css files</i> on every <i>VKontakte</i> page - http://vk.com/* or https://vk.com/*. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The style file (vk_styles.css) contains styles for the embedded link.  The link will have a css <i>downloadLink</i> class. <br>  Be sure to ensure that the class does not overlap with the styles of the original page. <br>  Let's make a border for our link and highlight when hovering.  Unlike the first version, we will make our link smaller, <br>  so that it is more often placed in the space defined for the song. <br><br><img src="https://habrastorage.org/files/23d/367/1b3/23d3671b3fc742a5969fe75fe5ef3fa6.png"><br>  You can, of course, override styles if you like. <br><div class="spoiler">  <b class="spoiler_title">vk_styles.css</b> <div class="spoiler_text"><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.downloadLink</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">float</span></span>: right; <span class="hljs-attribute"><span class="hljs-attribute">cursor</span></span>: copy; <span class="hljs-attribute"><span class="hljs-attribute">border</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> dotted <span class="hljs-number"><span class="hljs-number">#CED8DB</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-radius</span></span>: <span class="hljs-number"><span class="hljs-number">2px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">4px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.downloadLink</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:hover</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#d0e6ff</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-color</span></span>: <span class="hljs-number"><span class="hljs-number">#9DA5AE</span></span>; }</code> </pre><br></div></div><br>  All the main actions of the extension will occur in the embedded code vk_inject.js. <br>  So, what shall we do: <br><br>  For each song in the list of audio recordings we will implement the link ‚ÄúDownload‚Äù. <br><br>  We will search for items on the page with id 'pad_playlist', 'pad_search_list', 'initial_list', 'search_list', 'choose_audio_rows'. <br>  It is in them are lists of audio recordings.  But, each of the elements may initially be present on the page, and <br>  dynamically created / deleted.  Therefore, we need to monitor the addition of elements to the DOM page. <br><br>  Our embedded script is executed in a separate virtual machine, and can not interact with the script on the village. <br>  Therefore, we cannot override the source functions or otherwise intercept the js code on the source page. <br>  But, both of these scripts share a DOM tree.  So we will keep track of DOM updates on the list items with MutationObserver. <br><div class="spoiler">  <b class="spoiler_title">vk_inject.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     ,      //  observer          var trackObserver = new MutationObserver(listModified); // , ,         var list_ids = ['pad_playlist', 'pad_search_list', 'initial_list', 'search_list', 'choose_audio_rows']; for (var i= 0 ; i &lt; list_ids.length; i++) { var list = document.getElementById(list_ids[i]); if (list) { //   ""   ,        trackObserver listFound(list); } } //     ,      css  list = document.getElementById('results'); if (list &amp;&amp; list.classList.contains('audio_results')) { listFound(list); } //  observer         var listObserver = new MutationObserver(elementAdded); //    body,      listObserver.observe(document.body, {childList: true, subtree: true}); //     DOM  function elementAdded(mutations) { for (var i = 0; i &lt; mutations.length; i++) { var added = mutations[i].addedNodes; //        for (var j = 0; j &lt; added.length; j++) { findAudioLists(added[j]); } } } //             function findAudioLists(node) { if (node.id) //     id { for (var i = 0; i &lt; list_ids.length; i++) // ,   id   { if (list_ids[i] == node.id) { listFound(node); return; //        } } if (node.id == 'results') //    '#results.audio_results' -   { if (node.classList.contains('audio_results')) { listFound(node); return; } } } //      var child = node.firstElementChild; while (child) { findAudioLists(child); //       child = child.nextElementSibling; } } //    ,     function listFound(listNode) { if (listNode.children.length) //       { for (var j = 0; j &lt; listNode.children.length; j++) { addDownloadLink(listNode.children[j]); //      "" } } trackObserver.observe(listNode, {childList: true}); //      -&gt; listModified() } // ,      ( )  function listModified(mutations) { for (var i = 0; i &lt; mutations.length; i++) { var mut = mutations[i]; //     for (var j = 0; j &lt; mut.addedNodes.length; j++) { addDownloadLink(mut.addedNodes[j]); } //   - mut.removedNodes  } } //   ""    function addDownloadLink(row) { //  -    ,    ,   if (!row.classList.contains('audio')) { // ,     " " row = row.querySelector('div.audio'); //    'div.audio',      if (!row) { return; } } var titleNode = row.querySelector('div.title_wrap'); //   +  if (!titleNode) //     -  (,   ?) { return; } // ,    ?  ,          if (titleNode.querySelector('a.downloadLink')) { return; //      } var input = row.querySelector('div.play_btn &gt; input'); //  input,    url if (!input) { input = row.querySelector('div.play_btn_wrap + input'); //     if (!input) { return; //    } } var ref = input.getAttribute('value'); //  URL ref = ref.substr(0, ref.indexOf('?')); //    '?',      mp3 var link = document.createElement('a'); link.className = 'downloadLink'; //   'downloadLink'    link.textContent = "^"; link.setAttribute('title', ""); link.setAttribute('download', titleNode.textContent + '.mp3'); //     link.setAttribute('href', ref); link.addEventListener('click', function(event){ //     ,    event.stopPropagation(); }); titleNode.appendChild(link); } })();</span></span></code> </pre><br></div></div><br><h2>  Install the extension </h2><br>  So, our three files are ready. <br>  You can copy them from the post or <a href="">download the archive</a> . <br>  In chrome, go to the settings page, select the <i>Extensions</i> tab (or just type ‚Äúchrome: // extensions‚Äù in the address bar). <br>  Turn on <i>Developer Mode</i> .  Then click <i>Download unpacked extension ....</i> <br><br><img src="https://habrastorage.org/files/fee/67a/d43/fee67ad438934b82a974d79937bc51f6.png" alt="Extensions"><br><br>  Select the folder where you saved these three files.  In my case, this is D: \ Droopy \ work \ habr \ plugin. <br>  The extension should appear in the list.  Turn it on. <br><br><img src="https://habrastorage.org/files/709/35b/466/70935b466baf4a92a4f0120680b237a0.png"><br><br>  Let's check how it works.  To do this, let's go to VKontakte, select the <i>Music</i> section in the top panel. <br><br><img src="https://habrastorage.org/files/72e/2a7/cc3/72e2a7cc3e864e5f85f6ec05fee28506.png"><br><br>  Hurray, links "Download" appeared!  Moreover, if we start searching for audio recordings on the same page, then for each song found there will also be a download link.  The extension works. <br><br>  But, as I said in the last post, there is one difficulty with the name of the song being downloaded.  When you click on the ‚ÄúDownload‚Äù link, in the file saving dialog you will be offered not the file name that was specified in the ‚Äúdownload‚Äù attribute, but the file name on the server.  The fact is that VKontakte stores audio recordings on a separate domain, and chrome for this case will use the file name on the server instead of the one suggested in the link. <br>  In the chrome bug tracker, <a href="https://code.google.com/p/chromium/issues/detail%3Fid%3D366370">it says</a> that in this case you need to select the <i>Save link as</i> item in the context menu.  Then we will be offered the normal name of the audio. <br><br><img src="https://habrastorage.org/files/ee0/059/a99/ee0059a998fe4868bb18a1d5b0cd661b.png"><br><br>  Our extension is ready.  For each audio recording, a download link appears. <br><br>  Since it is unpacked (that is, in development mode), each time the browser is restarted, it will be suggested to disable it. <br>  In principle, it's better to do it this way, and turn it on as needed when you want to download songs.  Or you can download it in Chrome webstore to use all the time. <br></div><p>Source: <a href="https://habr.com/ru/post/254979/">https://habr.com/ru/post/254979/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254965/index.html">FAMP on pfsense using PHP-FPM</a></li>
<li><a href="../254969/index.html">The killer bundle of NSCache and UINib</a></li>
<li><a href="../254971/index.html">To help the teacher-teacher. Instant test validation</a></li>
<li><a href="../254973/index.html">Convert svg to png</a></li>
<li><a href="../254975/index.html">Presentations 27 reports of our conferences on C #</a></li>
<li><a href="../254981/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ154 (March 30 - April 5, 2015)</a></li>
<li><a href="../254983/index.html">Product Design Digest March 2015</a></li>
<li><a href="../254985/index.html">User videos: Windows 3.11 inside ReactOS</a></li>
<li><a href="../254989/index.html">Android Volley Loader. Moving toward the library</a></li>
<li><a href="../254991/index.html">Digital archeology: how long-lost data is saved</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>