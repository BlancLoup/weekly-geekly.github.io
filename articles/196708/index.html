<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unlock the Android screen using NFC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To protect against unauthorized access to my Nexus 4, I use a standard screen lock with a password. But you have to constantly enter the password manu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unlock the Android screen using NFC</h1><div class="post__text post__text-html js-mediator-article">  To protect against unauthorized access to my Nexus 4, I use a standard screen lock with a password.  But you have to constantly enter the password manually, and this is a bit annoying.  The lock with the pattern key did <a href="http://habrahabr.ru/post/174773/">not impress</a> me, as did the PIN (too few possible combinations).  I wanted a strong defense, while maintaining the unlock speed.  It is for this reason that I decided to look at NFC technology. <br><a name="habracut"></a><br><h4>  Turnkey solutions </h4><br>  The only ready-made solution I found to implement unlocking the device using a tag is the <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.t3hh4xx0r.nfcsecure">NFCSecure</a> program.  It is paid, but there is no free version.  After watching the video on his page on Google Play, I immediately decided for myself that IT was not worth the money.  Everything is implemented in the simplest way: <br><ol><li>  The user turns on the device screen and sees the standard screen blocker. </li><li>  He unlocks it. </li><li>  An NFCSecure Activity appears, which pretends to securely block access to the device (for some reason, when you click on the unlock icon, the page blinks, which does not inspire confidence). </li><li>  We attach the label and the window closes. </li></ol><br>  Even if we assume that this window blocks any attempts to physically get to the standard launcher (touch buttons, physical buttons, a gesture on the status line), it in no way implements all the protection provided by the standard lock screen.  Standard locking is much more functional and even blocks access to the device as a drive, i.e.  until you unlock the screen - you will not get access to the files. <br>  In general, this application is quite leaky and does not provide protection comparable to the standard lock screen. <br><br><h4>  We will make our implementation </h4><br>  The most ideal option for me was integration with a standard lock screen.  I wanted to be able to scan tags directly from it and log in, and if there are no tags, then you could use the password as a backup option. <br>  Before starting to do my implementation, I identified two reasons why the author of NFCSecure made his application exactly as it works now, and not as I intended.  We describe these problems and their solutions in the application developed by me. <br><br><h5>  Tag scanner does not always work </h5><br>  Or rather, it does not work in at least two cases that interest us: <br><ol><li>  When the screen is off. </li><li>  When we are on the lock screen. </li></ol><br>  I assume that in these cases the scanner does not work for security reasons.  After scanning the tags, the most suitable application is launched, and it is not known what this application will want to do.  For example, Google Wallet (judging by the video) requires a pin code and card selection before attaching the device to the terminal. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The rules of the scanner are in the system application NfcNci.apk.  There is a constant that determines the state of the device for the scan to work (you can read it <a href="http://forum.xda-developers.com/showpost.php%3Fp%3D45078500%26postcount%3D162">here</a> ).  Naturally this constant needs to be changed.  Many developers upload already prepared modified NfcNci.apk files to the xda-developers for the device you need, so I just took the finished file and replaced it with an application on my device. <br>  A constant can be set to at least one of two values ‚Äã‚Äãthat will allow the scanner to read marks when the screen is locked: <br><ol><li>  The scanner works when the screen is off. </li><li>  The scanner works when the screen is on and even with active blocking. </li></ol><br>  The first decision <a href="http://forum.xda-developers.com/showpost.php%3Fp%3D34974004%26postcount%3D10">according to the members of the forum is</a> eating about 35% of the battery in 3 hours, despite the fact that the phone was just lying idle.  Therefore, it is better to choose the second option, since it does not spend the charge at all + will prevent accidental unlocking and turning on the screen if the label is very close. <br>  Of course, this solution dramatically reduces the threshold for the entry of regular users, since now a rooted device and some gestures will be needed to replace the original application.  But since the application is not focused on large masses, then you can put up with it. <br><br><h5>  No easy unlock </h5><br>  Again, for security reasons, the application on the device cannot simply take and unlock the screen protected by any method (password, pin, pattern, etc.).  At the moment there are 2 standard solutions that allow you to unlock the screen: <br><ol><li>  Class <a href="http://developer.android.com/reference/android/app/KeyguardManager.KeyguardLock.html">KeyguardManager.KeyguardLock</a> . </li><li>  The flags of the window are <a href="http://developer.android.com/reference/android/view/WindowManager.LayoutParams.html">FLAG_DISMISS_KEYGUARD</a> and <a href="http://developer.android.com/reference/android/view/WindowManager.LayoutParams.html">FLAG_SHOW_WHEN_LOCKED</a> . </li></ol><br><h6>  KeyguardManager.KeyguardLock </h6><br>  This class contains 2 methods: disableKeyguard () and reenableKeyguard ().  The first method only unlocks the unprotected screen.  If the screen is protected by any method, then the call will be ignored.  The reenableKeyguard () method must be called to relock the screen, otherwise the blocker will not start after it is turned off. <br>  The disadvantages of this solution are: you cannot unlock a screen that is protected, say, with a password, and you also need to restart the lock screen on some event.  In addition, this class is obsolete since API 13, so you should not hope for it. <br><br><h6>  Window flags </h6><br>  Flags need to be installed on the parent Activity window.  FLAG_DISMISS_KEYGUARD only unlocks the screen if it is not protected.  After closing the window, the blocker will not recover until the screen turns off.  FLAG_SHOW_WHEN_LOCKED will only hide the blocker (even the protected one) and it will immediately come to the fore after the window is closed. <br>  That is, again, these flags will not be able to unlock the protected screen.  The maximum that can be done is to show your window on top of it. <br><br>  In this case, the less opportunities are given to the developer, the more the security of the OS itself increases.  The capabilities of the flags, especially FLAG_SHOW_WHEN_LOCKED, allow you to display your application on top of the blocker without compromising the security of the system.  But, unfortunately, it does not suit us. <br><br><h4>  We write workarounds </h4><br>  Since the Android API does not provide us with beautiful solutions to unlock, you have to write <s>crutches</s> workarounds. <br>  As a result, it was written a basic application that implements 3 methods of unlocking.  I decided to call it NFC Unlocker (links to Google Play and the source at the end of the post).  Implemented workarounds may not be stable, but this is understandable based on their name.  All these methods require the user to enter a password in the application settings, and not in the system.  This is done so that we can recover / enter (depending on the method) the password instead of the user. <br>  After reading the label, the OS should start the most appropriate Activity.  Therefore, using BroadcastReceiver will not work.  Next, I will describe these methods. <br><br><h5>  Setting the flag for the Activity window </h5><br>  Still, the flag can help us in the implementation of our plans.  This solution is the cleanest, since it does not require root and uses window flags, which are quite allowed for themselves.  In order for the flags to work, you will have to clear the password using the DevicePolicyManager.resetPassword () method.  To do this, we will need administrator rights that the application requests from the user on the settings page. <br>  The unlock algorithm is as follows: <br><ol><li>  The user is scanning the tag, our Activity is launched. </li><li> We clean the password: <br> <code>((DevicePolicyManager) context.getSystemService(Context.DEVICE_POLICY_SERVICE)).resetPassword("", 0);</code> <br> </li><li>  Put a flag to the window of our Activity: <br> <code>getActivity().getWindow().addFlags(WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD);</code> </li> <li>  Finish the Activity in the onAttachedToWindow method, since it is in it that our flag is already applied to the window. </li><li>  In the onDestroy method, we reset the user's password. </li></ol><br><h5>  Using KeyguardLock </h5><br>  The following method uses the outdated API, but nevertheless successfully performs its task on Android 4.3.  As in the previous method, we will have to clear the password for the unlocking to work. <br>  Here the algorithm is more complicated and, at first glance, not stable enough (in practice, everything is much better): <br><ol><li>  The user is scanning the tag, our Activity is launched. </li><li>  We clean the password: <br> <code>((DevicePolicyManager) context.getSystemService(Context.DEVICE_POLICY_SERVICE)).resetPassword("", 0).</code> </li> <li>  Unlock the screen: <br> <code>KeyguardManager keyguardManager = (KeyguardManager) context.getSystemService(Activity.KEYGUARD_SERVICE);</code> <br> <code>KeyguardLock keyguardLock = keyguardManager.newKeyguardLock("nfcunlocker");</code> <br> <code>keyguardLock.disableKeyguard();</code> </li> <li>  We start the service, which in the background will create a BroadcastReceiver, which will receive a screen-off event: <br> <code>ScreenReceiver screenReceiver = new ScreenReceiver();</code> <br> <code>IntentFilter filter = new IntentFilter(Intent.ACTION_SCREEN_OFF);</code> <br> <code>registerReceiver(mReceiver, filter);</code> </li> <li>  As soon as an event is received informing you that the screen is turned off, we turn on the lock and reset the password. </li></ol><br>  This method works quite stably, but uses an obsolete API. <br><br><h5>  Entering the password through the shell </h5><br>  I came up with this method first because it is quite simple, but requires root.  In Android with a shell, you can call the "input" command, which allows you to enter text and emulate keystrokes.  To enter text, use the following syntax: <br> <code>input text "type your text here"</code> <br>  Keystroke emulation is performed using the following command: <br> <code>input keyevent KEYCODE</code> <br>  A list of key codes can be found <a href="http://thecodeartist.blogspot.com/2011/03/simulating-keyevents-on-android-device.html">here</a> . <br>  The unlock algorithm for this method is very simple: <br><ol><li>  The user is scanning the tag, our Activity is launched. </li><li>  Enter the password using the ‚Äúinput‚Äù shell command, and with its help send the Enter key code. </li></ol><br><h4>  A little about the tags themselves </h4><br>  You can read about the algorithm for selecting an Activity when scanning a tag <a href="http://developer.android.com/intl/ru/guide/topics/connectivity/nfc/nfc.html">here</a> .  In short, we can say that the OS selects an Activity based on the contents of the tag.  To guarantee the launch of our Activity, you need to use <a href="http://developer.android.com/intl/ru/guide/topics/connectivity/nfc/nfc.html">AAR</a> (Android Application Records), which simply means writing the name of the application package to the label.  With this method, it would be possible to launch an unlock, guaranteed, but I did not have handy tags that support the NDEF standard.  Therefore, I identify them by a unique <a href="http://developer.android.com/intl/ru/reference/android/nfc/NfcAdapter.html">identifier</a> . <br><br><h4>  Total </h4><br>  And now let's summarize the pros and cons of integration with the native blocker. <br>  <b>Pros:</b> <br><ol><li>  Do not violate OS protection. </li><li>  Unlock the device by simply attaching a label to the device. </li><li>  If the tags are not nearby, then you can enter the password manually. </li></ol><br>  <b>Minuses:</b> <br><ol><li>  High entry threshold for users.  Need root and modified NfcNci.apk. </li><li>  Unlock methods may not work stably.  You need to choose the right one. </li></ol><br>  The link to Github has links to modified NfcNci.apk files for some popular smartphones. <br><br>  To demonstrate the settings and operation of the application, I recorded a video: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/rPE6clanMaY%3Ffeature%3Doembed&amp;xid=17259,1500004,15700023,15700186,15700191,15700253,15700255&amp;usg=ALkJrhiSKvNESzjz_rFesDNlrWSZUJiImg" frameborder="0" allowfullscreen=""></iframe><br><br>  <b>References:</b> <br>  <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.steelrat.nfcunlocker">Google play</a> <br>  <a href="https://github.com/PaulAnnekov/nfcunlocker">Github</a> <br><br>  PS For the quality of the code please do not kick.  I am not a Java developer. </div><p>Source: <a href="https://habr.com/ru/post/196708/">https://habr.com/ru/post/196708/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196696/index.html">Nokia closes reception of new Symbian and MeeGo-applications in Nokia Store</a></li>
<li><a href="../196698/index.html">2x Intel Quad-Core Xeon E5620 / 32GB DDR3 / 24x2TB SATA2 to NL / US with 1 or 10 Gbps Internet at ultra-low prices!</a></li>
<li><a href="../196700/index.html">Geolocation - how to earn us</a></li>
<li><a href="../196702/index.html">Runnable: search engine code with its execution in the VM</a></li>
<li><a href="../196704/index.html">NASA continues to work on a number of projects during the budget crisis, as an exception to the rules</a></li>
<li><a href="../196710/index.html">3CX Phone System Pro Edition has been released.</a></li>
<li><a href="../196712/index.html">An example of developing a simple blog on CleverStyle CMS</a></li>
<li><a href="../196714/index.html">3CX Hotel Module - hotel module for 3CX Phone System 12</a></li>
<li><a href="../196716/index.html">Step into the future for Yandex.Market</a></li>
<li><a href="../196718/index.html">Prerender</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>