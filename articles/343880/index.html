<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we made an application under Windows 10 with Fluent Design (UWP / C #)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We in ivi long ago were going to update our application under Windows 10 (which is for PC and tablets). We wanted to make it a kind of "cozy" area for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we made an application under Windows 10 with Fluent Design (UWP / C #)</h1><div class="post__text post__text-html js-mediator-article">  We in ivi long ago were going to update our application under Windows 10 (which is for PC and tablets).  We wanted to make it a kind of "cozy" area for recreation.  And so the recently announced concept of <a href="https://fluent.microsoft.com/">fluent design by</a> Microsoft came in very handy. <br><br>  But I will not talk here about standard components, we offer Microsoft for fluent design ( <a href="https://docs.microsoft.com/en-us/windows/uwp/design/style/acrylic">Acrylic</a> , <a href="https://docs.microsoft.com/en-us/windows/uwp/design/style/reveal">Reveal</a> , <a href="https://docs.microsoft.com/en-us/windows/uwp/design/motion/connected-animation">Connected-animation</a> , etc.), although we, of course, use them too.  Everything is simple and clear with them - take the documentation and use it. <br><br>  But adventures usually begin when you leave the beaten track.  Therefore, I'd rather tell you about how we did one custom control, which caused us a lot of trouble.  Here is this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/s2/_2/67/s2_267wfn0gm9qrfiemllv2yzti.gif" alt="image"><br><br>  The idea is that we use depth and motion from the fluent design system.  The central element as if slightly rises above all others.  This is achieved by animating its size and shadow during the scroll. <br><a name="habracut"></a><br>  <a href="https://docs.microsoft.com/en-us/windows/uwp/design/controls-and-patterns/flipview">FlipView</a> didn‚Äôt fit right away.  he does not know how to show pieces of the next and previous elements (we call them "ears").  And we began to search for solutions. <br><br><h2>  <font color="#fd004c">Path 1. Try using a GridView.</font> </h2><br>  The logical solution was to try using a <a href="https://docs.microsoft.com/en-us/windows/uwp/design/controls-and-patterns/listview-and-gridview">GridView</a> .  To build elements into a horizontal line, set the ItemsPanel as the following: <br><br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemsStackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  To center the current element, use the ScrollViewer properties in the GridView template: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ScrollViewer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">HorizontalSnapPointsType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MandatorySingle"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">HorizontalSnapPointsAlignment</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Center"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  An example of such an implementation can be found, for example, <a href="http://fruitfulcoding.com/horizontal-swiping-in-listviewbase-control-with-mandatory-centered-snap-points/">here</a> . <br><br>  It seems everything is OK, but there are problems. <br><br><h3>  <font color="#fd004c">Gridview.</font>  <font color="#fd004c">Problem 1. scaling the control to the full width of the screen.</font> </h3><br>  As planned by the designers, our control should go for the entire width of the window.  This is not a problem in itself.  But when changing the size of the control, the sizes of all its child elements (Items) should also change simultaneously: <br><br><ul><li>  The width of the elements must be set to 90% of the width of the control (10% is left on the "ears"); <br></li><li>  The height of the elements must be calculated based on the width and proportions of the image; <br></li><li>  At the same time on the small width of the screen you need to crop the image to the left and to the right so that it does not become too small after scaling. <br></li></ul><br><img src="https://habrastorage.org/webt/ua/lo/xr/ualoxruqcxfkgzu4esxyuqmtr90.jpeg" alt="image"><br><br>  Out of the box GridView is not able to.  We <a href="https://docs.microsoft.com/en-us/windows/uwpcommunitytoolkit/controls/adaptivegridview">spotted the</a> solution in the implementation of <a href="https://docs.microsoft.com/en-us/windows/uwpcommunitytoolkit/controls/adaptivegridview">AdaptiveGridView from UWPToolkit</a> : <br><br><ul><li>  Inherit from GridView and add two properties: ItemWidth and ItemHeight; <br></li><li>  In the event handler for the SizeChanged event, we calculate these properties depending on the width of the GridView; <br></li><li>  Override the PrepareContainerForItemOverride method of the GridView.  It is called for each ItemContainer before it is displayed to the user.  And we add for each item a binding on the ItemWidth and ItemHeight created by us: <br></li></ul><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrepareContainerForItemOverride</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DependencyObject obj, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> item</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.PrepareContainerForItemOverride(obj, item); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> FrameworkElement element) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> heightBinding = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Binding() { Source = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Path = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyPath(<span class="hljs-string"><span class="hljs-string">"ItemHeight"</span></span>), Mode = BindingMode.TwoWay }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> widthBinding = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Binding() { Source = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Path = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PropertyPath(<span class="hljs-string"><span class="hljs-string">"ItemWidth"</span></span>), Mode = BindingMode.TwoWay }; element.SetBinding(HeightProperty, heightBinding); element.SetBinding(WidthProperty, widthBinding); } }</code> </pre> <br>  In more detail implementation can be looked <a href="https://github.com/Microsoft/UWPCommunityToolkit/tree/master/Microsoft.Toolkit.Uwp.UI.Controls/AdaptiveGridView">in source codes of UWPToolkit</a> . <br><br>  It seems everything is OK, it works.  But‚Ä¶ <br><br><h3>  <font color="#fd004c">Gridview.</font>  <font color="#fd004c">Problem 2. When resizing item, the current item goes out of scope.</font> </h3><br>  But as soon as we begin to dynamically change the width of the elements inside the GridView, we are faced with the following problem.  At this moment, a completely different element begins to fall into the visible region.  This is due to the fact that the ScrollViewer's HorizontalOffset inside the GridView remains unchanged.  GridView does not involve such a trick from us. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cf/zb/hr/cfzbhrqnk-q4owqrz8odr89uv-m.png" alt="image"></div><br>  The effect is especially noticeable when the window is maximized (due to a sharp resizing).  And even with just large values ‚Äã‚Äãof HorizontalOffset. <br><br>  It would seem that one could solve this problem by asking the GridView to scroll to the desired element: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSizeChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, SizeChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { ... <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.Yield(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ScrollIntoView(getCurrentItem(), ScrollIntoViewAlignment.Default); }</code> </pre> <br>  But no: <br><br><ul><li>  Without using Task.Yield () this does not work.  And with it - leads to ugly visual twitching - because  another element has time to be displayed before the ScrollIntoView runs. <br></li><li>  And with SnapPoints ScrollIntoView turned on for some reason, it basically does not work correctly.  As if stuck on them. <br></li></ul><br>  It could also be solved by manually calculating and setting the new HorizontalOffset value of the ScrollViewer with each change in the size of our GridView: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSizeChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, SizeChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scrollViewer = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.FindDescendant&lt;ScrollViewer&gt;(); scrollViewer.ChangeView(calculateNewHorizontalOffset(...), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  But this only works with a gradual resizing of the window.  When maximizing a window, it often gives the wrong result.  Most likely, the reason is that the new HorizontalOffset value we calculated is too large and goes beyond the ExtentWidth (content widths inside the ScrollViewer).  And since  Since GridView uses <a href="https://docs.microsoft.com/en-us/windows/uwp/debug-test-perf/optimize-gridview-and-listview">UI virtualization</a> , then automatically after changing the width of an Item, ExtentWidth may not be recalculated. <br><br>  In general, an adequate solution to this problem was not found. <br><br>  We could stop at this and start searching for the next solution.  But I will describe another problem with this approach. <br><br><h3>  <font color="#fd004c">Gridview.</font>  <font color="#fd004c">Problem 3. Nested ScrollViewers break horizontal scrolling with the mouse</font> </h3><br>  We want the mouse wheel to always scroll vertically.  Is always.  Vertically. <br><br>  But if we put a horizontal scrolling GridView on the page, then the ScrollViewer located in its depths captures the mouse wheel events to itself and does not skip above.  As a result, if the mouse cursor is over our control list, the mouse wheel makes a horizontal scroll in it.  This is inconvenient and confuses users: <br><br><img src="https://habrastorage.org/webt/yh/al/ka/yhalkan0vujpd5ighiew987ahr8.jpeg" alt="image"><br><br>  There are two solutions to this problem: <br><br><ul><li>  Catch the PointerWheelChanged event before it hits the horizontal ScrollViewer and call ChangeView () on the vertical ScrollViewer in response.  Peeped <a href="https://stackoverflow.com/questions/37122576/uwp-disable-mouse-scroll-in-grid-view">here</a> .  It works, but noticeably slows down when the mouse wheel is spinning fast.  It didn‚Äôt suit us - spoiling the scroll with the mouse for the sake of rare users with a touch screen is not an option. <br></li><li>  Set <code>HorizontalScrollMode="Disabled"</code> .  It helps, but it disables not only the mouse wheel, but scrolling through the touch screen. <br><br><pre> <code class="hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GridView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ScrollViewer.HorizontalScrollMode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Disabled"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> </li></ul><br>  Touch screen did not want to lose and we continued to search for a better solution. <br><br><h2>  <font color="#fd004c">Path 2. Carousel from UWPToolkit</font> </h2><br>  The next solution was the <a href="https://docs.microsoft.com/en-us/windows/uwpcommunitytoolkit/controls/carousel">Carousel</a> control <a href="https://docs.microsoft.com/en-us/windows/uwpcommunitytoolkit/controls/carousel">from UWPToolkit</a> .  From all sides very interesting and informative control.  I recommend everyone to study its implementation. <br><br>  He pretty well covered our needs.  But in the end, too, did not fit: <br><br><ul><li>  There is no scaling of elements when changing width (see above): <br><br><ul><li>  This is solved by the problem.  Since  he is open source.  And adding scaling to it will not be difficult. </li><li>  And even the problem of maintaining the current element in scope after scaling is also solved, again thanks to the open source implementation. <br></li></ul></li><li>  Missing <a href="https://docs.microsoft.com/en-us/windows/uwp/debug-test-perf/optimize-gridview-and-listview">UI Virtualization</a> : <br><br><ul><li>  Carousel uses its own implementation of ItemsPanel.  And there is no support for UI virtualization; </li><li>  This is quite a critical thing for us, because  We can have quite a lot of promotional materials in our list and this greatly affects the page load time; </li><li>  Yes, it is probably also realizable.  But no longer looks simple. <br></li></ul></li><li>  It uses animations on the UI stream (Storyboards and Manipulation events *), which, by definition, is not always smooth enough. <br></li></ul><br>  Those.  it turns out that you need to spend quite a lot of time to refine this control for our needs (one UI virtualization is worth it).  In this case, we will get a piece with potentially slowing down animations. <br><br>  In general, we also decided to abandon this approach.  If we are wasting time, we will do it by the mind. <br><br><h2>  <font color="#fd004c">Path 3. Our implementation</font> </h2><br><h3>  <font color="#fd004c">Making ‚ÄúTOUCH ONLY‚Äù ScrollViewer</font> </h3><br>  Let me remind you that we do not want to use the standard ScrollViewer, because it captures all the events from the mouse wheel (see above the section "GridView. Problem 3"). <br><br>  We don‚Äôt like the implementation of Carousel because  It uses animations on the UI stream, and the preferred way for UWP applications to create animations is <a href="https://docs.microsoft.com/en-us/windows/uwp/composition/composition-animation">Composition animations</a> .  Their difference from the more familiar Storyboards is that they work on a separate Composition stream and due to this provide 60 frames / sec even when the UI stream is busy with something. <br><br>  To accomplish our task, we need <a href="https://docs.microsoft.com/en-us/windows/uwp/composition/interaction-tracker-manipulations">InteractionTracker</a> , a component that allows using touch input as a source for animations.  Actually, the first thing we need to learn to do is to move the UI elements horizontally, depending on the movement of the finger on the screen.  In fact, we have to start by implementing our custom ScrollViewer.  So let's call it TouchOnlyScrollViewer: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> TouchOnlyScrollerViewer : ContentControl { private Visual _thisVisual; private Compositor _compositor; private InteractionTracker _tracker; private VisualInteractionSource _interactionSource; private ExpressionAnimation _positionExpression; private InteractionTrackerOwner _interactionTrackerOwner; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> HorizontalOffset { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> event Action&lt;<span class="hljs-type"><span class="hljs-type">double</span></span>&gt; ViewChanging; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> event Action&lt;<span class="hljs-type"><span class="hljs-type">double</span></span>&gt; ViewChanged; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> TouchOnlyScrollerViewer() { initInteractionTracker(); Loaded += onLoaded; PointerPressed += onPointerPressed; } private <span class="hljs-type"><span class="hljs-type">void</span></span> initInteractionTracker() { //  InteractionTracker  VisualInteractionSource _thisVisual = ElementCompositionPreview.GetElementVisual(this); _compositor = _thisVisual.Compositor; _tracker = InteractionTracker.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(_compositor); _interactionSource = VisualInteractionSource.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(_thisVisual); _interactionSource.PositionXSourceMode = InteractionSourceMode.EnabledWithInertia; _tracker.InteractionSources.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(_interactionSource); //   Expression-,     //  touch-  InteractionTracker _positionExpression = _compositor.CreateExpressionAnimation("-tracker.Position"); _positionExpression.SetReferenceParameter("tracker", _tracker); } private <span class="hljs-type"><span class="hljs-type">void</span></span> onLoaded(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, RoutedEventArgs e) { //      <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span>  UIElement- var visual = ElementCompositionPreview.GetElementVisual((UIElement)Content); visual.StartAnimation("Offset", _positionExpression); } private <span class="hljs-type"><span class="hljs-type">void</span></span> onPointerPressed(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, PointerRoutedEventArgs e) { //  touch-  composition- <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.Pointer.PointerDeviceType == PointerDeviceType.Touch) { try { _interactionSource.TryRedirectForManipulation(e.GetCurrentPoint(this)); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.WriteLine("TryRedirectForManipulation: " + ex.ToString()); } } } }</code> </pre> <br>  Here, so far everything is strictly according to the dock from Mircosoft.  Unless TryRedirectForManipulation had to be wrapped in try-catch because it sometimes throws sudden exceptions.  This happens quite rarely (offhand, in about 2-5% of cases) and we could not find out the reason.  Why this is not said in the documentation and official examples of Microsoft - we do not know;) <br><br><h3>  <font color="#fd004c">TOUCH ONLY ScrollViewer.</font>  <font color="#fd004c">We form HorizontalOffset and ViewChanging and ViewChanged events</font> </h3><br>  Once we make a similarity to the ScrollViewer, we will need the HorizontalOffset property and the ViewChanging and ViewChanged events.  We will implement them through the processing of InteractionTracker callbacks.  To get them, when you create an InteractionTracker, you need to specify an object that implements the IInteractionTrackerOwner, which will receive these callbacks: <br><br><pre> <code class="hljs cs">_interactionTrackerOwner = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InteractionTrackerOwner(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); _tracker = InteractionTracker.CreateWithOwner(_compositor, _interactionTrackerOwner);</code> </pre> <br>  For completeness, let me copy a picture from the documentation with the states and events of InteractionTracker: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8k/ge/jt/8kgejtgpmbv81vko6j5clcdy-wk.png" alt="image"></div><br>  The ViewChanged event will be thrown upon entering the Idle state. <br><br>  The ViewChanging event will be thrown by triggering IInteractionTrackerOwner.ValuesChanged. <br>  I‚Äôll say right away that ValuesChanged can happen when InteractionTracker is in the Idle state.  This happens after a call to InteractionTracker's TryUpdatePosition.  And it looks like a bug in the UWP platform. <br><br>  Well, this will have to be tolerated.  Fortunately, it‚Äôs not difficult for us - in response to ValuesChanged, we will throw out either ViewChanging or ValuesChanged, depending on the current state: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InteractionTrackerOwner</span></span> : <span class="hljs-title"><span class="hljs-title">IInteractionTrackerOwner</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> TouchOnlyScrollerViewer _scrollViewer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValuesChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">InteractionTracker sender, InteractionTrackerValuesChangedArgs args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   .    . _scrollViewer.HorizontalOffset = args.Position.X; if (_interactionTrackerState != InteractionTrackerState.Idle) { _scrollViewer.ViewChanging?.Invoke(args.Position.X); } else { _scrollViewer.ViewChanged?.Invoke(args.Position.X); } } public void IdleStateEntered(InteractionTracker sender, InteractionTrackerIdleStateEnteredArgs args) { //    _scrollViewer._tracker.Position. //  Windows 14393 (Anniversary Update)  -  0 _scrollViewer.ViewChanged?.Invoke(_scrollViewer.HorizontalOffset, requestType); } }</span></span></code> </pre> <br><h3>  <font color="#fd004c">TOUCH ONLY ScrollViewer.</font>  <font color="#fd004c">Snap Points to flip through exactly 1 item</font> </h3><br>  For ensuring scrolling exactly on 1 element there is a remarkable decision - " <a href="https://docs.microsoft.com/en-us/windows/uwp/composition/inertia-modifiers">snap points with inertia modifiers</a> ". <br><br>  The point is that we set the points at which the scrolling has the right to stop after performing the swipe on the touch screen.  And the rest of the logic takes InteractionTracker.  In fact, it modifies the deceleration rate so that the stop after the svayp occurs smoothly and at the same time exactly in the place where we need it. <br><br>  Our implementation is slightly different from the one described in the example in the <a href="https://docs.microsoft.com/en-us/windows/uwp/composition/inertia-modifiers">documentation</a> .  Because we don‚Äôt want to scroll more than one element at a time, even if the user ‚Äúspun‚Äù our list too quickly. <br><br>  Therefore, we add only three snap-points - ‚Äúone step to the left‚Äù, ‚Äúone step to the right‚Äù and ‚Äústay in the current position‚Äù.  And after each scrolling, we will update them. <br><br>  And in order not to recreate the snap points every time after scrolling, we will make them parameterized.  To do this, we start a PropertySet with three properties: <br><br><pre> <code class="hljs objectivec"> _snapPointProps = _compositor.CreatePropertySet(); _snapPointProps.InsertScalar(<span class="hljs-string"><span class="hljs-string">"offsetLeft"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); _snapPointProps.InsertScalar(<span class="hljs-string"><span class="hljs-string">"offsetCurrent"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); _snapPointProps.InsertScalar(<span class="hljs-string"><span class="hljs-string">"offsetRight"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br>  And in the formulas for Condition and RestingValue we use the properties from this PropertySet: <br><br><pre> <code class="hljs pgsql"> //    ¬´   ¬ª var leftSnap = InteractionTrackerInertiaRestingValue.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(_compositor); leftSnap.Condition = _compositor.CreateExpressionAnimation( "this.Target.NaturalRestingPosition.x &lt; " + "props.offsetLeft * 0.25 + props.offsetCurrent * 0.75"); leftSnap.Condition.SetReferenceParameter("props", _snapPointProps); leftSnap.RestingValue = _compositor.CreateExpressionAnimation("props.offsetLeft"); leftSnap.RestingValue.SetReferenceParameter("props", _snapPointProps); //    ¬´   ¬ª var currentSnap = InteractionTrackerInertiaRestingValue.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(_compositor); currentSnap.Condition = _compositor.CreateExpressionAnimation( "this.Target.NaturalRestingPosition.x &gt;= " + "props.offsetLeft * 0.25 + props.offsetCurrent * 0.75 &amp;&amp; " + "this.Target.NaturalRestingPosition.x &lt; " + "props.offsetCurrent * 0.75 + props.offsetRight * 0.25"); currentSnap.Condition.SetReferenceParameter("props", _snapPointProps); currentSnap.RestingValue = _compositor.CreateExpressionAnimation("props.offsetCurrent"); currentSnap.RestingValue.SetReferenceParameter("props", _snapPointProps); //   ¬´   ¬ª var rightSnap = InteractionTrackerInertiaRestingValue.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(_compositor); rightSnap.Condition = _compositor.CreateExpressionAnimation( "this.Target.NaturalRestingPosition.x &gt;= " + "props.offsetCurrent * 0.75 + props.offsetRight * 0.25"); rightSnap.Condition.SetReferenceParameter("props", _snapPointProps); rightSnap.RestingValue = _compositor.CreateExpressionAnimation("props.offsetRight"); rightSnap.RestingValue.SetReferenceParameter("props", _snapPointProps); _tracker.ConfigurePositionXInertiaModifiers( <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> InteractionTrackerInertiaModifier[] { leftSnap, currentSnap, rightSnap }); }</code> </pre> <br>  Here: <br><br><ul><li>  NaturalRestingPosition.X is the offset at which the inertia would have ended if there were no snap points; <br></li><li>  SnapPoint.RestingValue is the offset at which a stop is allowed when the condition of SnapPoint.Condition is met. <br></li></ul><br>  At first we tried to put the border in Condition in the middle between the snap points, but users noticed that for some reason, not every svayp caused scrolling to the next element.  Some svaypas were not fast enough and there was a rollback. <br><br>  Therefore, in the formulas for Contition, we use the coefficients of 0.25 and 0.75 so that even the ‚Äúslow‚Äù swipe scrolls to the neighboring element. <br><br>  Well, after each scroll to the next element we will call this method to update the parameters of the snap points: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SetSnapPoints(<span class="hljs-type"><span class="hljs-type">double</span></span> left, <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>, <span class="hljs-type"><span class="hljs-type">double</span></span> right) { _snapPointProps.InsertScalar("offsetLeft", (<span class="hljs-type"><span class="hljs-type">float</span></span>)Math.Max(left, <span class="hljs-number"><span class="hljs-number">0</span></span>)); _snapPointProps.InsertScalar("offsetCurrent", (<span class="hljs-type"><span class="hljs-type">float</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">current</span></span>); _snapPointProps.InsertScalar("offsetRight", (<span class="hljs-type"><span class="hljs-type">float</span></span>)Math.Min(right, _tracker.MaxPosition.X)); }</code> </pre> <br><h3>  <font color="#fd004c">UI Virtualization Panel</font> </h3><br>  The next step we needed to build a full-fledged ItemsControl based on our TouchOnlyScrollerViewer. <br><br>  <i>For reference.</i>  <i><a href="https://docs.microsoft.com/en-us/windows/uwp/debug-test-perf/optimize-gridview-and-listview">UI virtualization</a> is when a control list instead of, say, 1000 child elements creates only those that are visible on the screen.</i>  <i>And reuse them as scrolling, binding to new data objects.</i>  <i>This reduces the page load time with a large number of items in the list.</i> <br><br>  Since  I really didn‚Äôt want to implement my UI virtualization, the first thing we tried to do, of course, was to use the standard <a href="https://docs.microsoft.com/en-us/uwp/api/windows.ui.xaml.controls.itemsstackpanel">ItemsStackPanel</a> panel. <br><br>  I wanted to make friends with our TouchOnlyScrollerViewer.  Unfortunately, we could not find any documentation about its internal structure or source code.  But a series of experiments suggested that ItemsStackPanel is looking for a ScrollViewer in the Visual Tree in the list of parent elements.  And somehow to override this method, so that instead of the standard ScrollViewer, it would look for ours, we did not find. <br><br>  Well.  So the panel with UI-virtualization will still have to do it yourself.  The best that was found on this topic is this series of articles already 11 years old: <a href="https://blogs.msdn.microsoft.com/dancre/2006/02/06/implementing-a-virtualized-panel-in-wpf-avalon/">one</a> , <a href="https://blogs.msdn.microsoft.com/dancre/2006/02/13/implementing-a-virtualizingpanel-part-2-iitemcontainergenerator/">two</a> , <a href="https://blogs.msdn.microsoft.com/dancre/2006/02/15/implementing-a-virtualizingpanel-part-3-measurecore/">three</a> , <a href="https://blogs.msdn.microsoft.com/dancre/2006/02/17/implementing-a-virtualizingpanel-part-4-the-goods/">four</a> .  True, it is about WPF, and not about UWP, but it conveys the idea very well.  We took advantage of it. <br><br>  Actually, the idea is simple: <br><br><ul><li>  Such a panel is embedded inside our TouchOnlyScrollerViewer and subscribes to its ViewChanging and ViewChanged events; <br></li><li>  The panel creates a limited number of child UI elements.  In our case, it is 5 (one in the center, two - on the ‚Äúears‚Äù sticking to the left and right, and another 2 - for the cache of the elements following the ‚Äúears‚Äù); <br></li><li>  UI elements are positioned based on TouchOnlyScrollerViewer.HorizontalOffset and re-attached to the desired date objects as they scroll. <br></li></ul><br>  I will not show the implementation, because  it turned out quite complicated.  It is rather a topic for a separate article. <br><br><h3>  <font color="#fd004c">We are looking for Tapped events that are lost after redirecting the touch input to the composition stream.</font> </h3><br>  After we gathered it, another interesting problem came to light.  Sometimes a user tapes on the elements inside our control in the process while touch input is redirected to InteractionTracker.  This happens when scrolling occurs by inertia.  In this case, the PointerPressed, PointerReleased, and Tapped events simply do not occur.  And this is not an artificial problem, because  The inertia of InteractionTracker is rather long.  And even when visually scrolling is almost over, in fact it can happen that the last few pixels are slowly scrolling. <br><br>  As a result, the user is upset - he expects that the page of the selected movie will open by tap.  But this is not happening. <br><br>  Therefore, we will identify tap by a pair of events from InteractionTracker: <br><br><ul><li>  Transition to Interacting state (finger touched the screen); <br></li><li>  Then immediately (less than 150ms), the transition to the state of Inertia (finger released the screen).  And while the scrolling speed should be zero (otherwise it is no longer a tap, but a swipe): <br></li></ul><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InertiaStateEntered</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">InteractionTracker sender, InteractionTrackerInertiaStateEnteredArgs args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_interactionTrackerState == InteractionTrackerState.Interacting &amp;&amp; (DateTime.Now - _lastStateTime) &lt; TimeSpan.FromMilliseconds(<span class="hljs-number"><span class="hljs-number">150</span></span>) &amp;&amp; Math.Abs(args.PositionVelocityInPixelsPerSecond.X) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 1px/sec */</span></span>) { _scrollViewer.TappedCustom?.Invoke(_scrollViewer.HorizontalOffset); } _interactionTrackerState = InteractionTrackerState.Inertia; _lastStateTime = DateTime.Now; }</code> </pre> <br>  It works.  But, the truth, does not allow to know the element on which the tap was carried out.  In our case, this is not critical, since  our elements occupy almost the entire visible width of the TouchOnlyScrollViewer.  Therefore, we simply choose the one that is closer to the center.  In most cases - this is exactly what you need.  So far, no one has even noticed that sometimes taping during scrolling can lead to the wrong place.  It's not easy to catch, even if you know about it;) <br><br>  Although in the general case, this is certainly not a complete solution.  For a full-fledged implementation, I would have to fence my own hit testing.  But it is not clear how to do it, because  Tapa's coordinates are unknown ... <br><br><h3>  <font color="#fd004c">Bonus</font>  <font color="#fd004c">Expression animations for opacity, scale and shadows.</font>  <font color="#fd004c">To make it finally beautiful</font> </h3><br>  And finally, the cherry on the cake is what it was all about.  As we scroll, we want to change the size, shadow, and transparency of the elements.  To create the feeling that the one in the center is slightly raised. <br><br>  To do this, we will use <a href="https://docs.microsoft.com/en-us/uwp/api/windows.ui.composition.expressionanimation">Expression animations</a> .  They are also part of the Composition subsystem, run on a separate thread and therefore do not slow down when the UI thread is busy. <br><br>  They are created like this.  For the property to be animated we set the formula (expression), which determines the dependence of this property on any other properties.  The formula is defined as a text string. <br><br>  Another of their charm is that they can be built in chains.  We will take advantage of this: <br><img src="https://habrastorage.org/webt/5a/qj/lm/5aqjlmdajxyzkrkzcvp5xuh4zci.png" alt="image"><br><br>  The source for all animations will be the offset from InteractionTracker in pixels.        UI-   progress,        0  1.     progress-      . <br><br> ,  _progressExpression  ,    : <br><br><ul><li> 0 ‚Äî              ; <br></li><li> 1 ‚Äî        ,       ,   ,     : <br></li></ul><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">_progressExpression</span></span> = _compositor.CreateExpressionAnimation( <span class="hljs-string"><span class="hljs-string">"1 - "</span></span> + <span class="hljs-string"><span class="hljs-string">"Clamp(Abs(tracker.Position.X - props.offsetWhenSelected), 0, props.maxDistance)"</span></span> + <span class="hljs-string"><span class="hljs-string">" / props.maxDistance"</span></span>);</code> </pre> <br>  Here: <br><br><ul><li> Clamp(val, min, max) ‚Äî  .  val     min/max,   min/max.    ‚Äî  val. </li><li> offsetWhenSelected ‚Äî  InteractionTracker-,          ; </li><li> maxDistance ‚Äî ,        ; </li><li> tracker ‚Äî  InteractionTracker. </li></ul><br>       Expression-: <br><br><pre> <code class="hljs objectivec">_progressExpression.SetReferenceParameter(<span class="hljs-string"><span class="hljs-string">"tracker"</span></span>, tracker); _props = _compositor.CreatePropertySet(); _props.InsertScalar(<span class="hljs-string"><span class="hljs-string">"offsetWhenSelected"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)offsetWhenSelected); _props.InsertScalar(<span class="hljs-string"><span class="hljs-string">"maxDistance"</span></span>, getMaxDistanceParam()); _progressExpression.SetReferenceParameter(<span class="hljs-string"><span class="hljs-string">"props"</span></span>, _props);</code> </pre> <br>   PropertySet   progress,      _progressExpression.  ,        : <br><br><pre> <code class="hljs go">_progressProps = _compositor.CreatePropertySet(); _progressProps.InsertScalar(<span class="hljs-string"><span class="hljs-string">"progress"</span></span>, <span class="hljs-number"><span class="hljs-number">0f</span></span>); _progressProps.StartAnimation(<span class="hljs-string"><span class="hljs-string">"progress"</span></span>, _progressExpression);</code> </pre> <br>      progress    ¬´¬ª      (  Lerp  ColorLerp).   ,     Expression-   <a href="https://docs.microsoft.com/en-us/uwp/api/windows.ui.composition.expressionanimation"></a> . <br><br> : <br><br><pre> <code class="hljs objectivec">_scaleExpression = _compositor.CreateExpressionAnimation( <span class="hljs-string"><span class="hljs-string">"Vector3(Lerp(earUnfocusScale, 1, props.progress), "</span></span> + <span class="hljs-string"><span class="hljs-string">"Lerp(earUnfocusScale, 1, props.progress), 1)"</span></span>); _scaleExpression.SetScalarParameter(<span class="hljs-string"><span class="hljs-string">"earUnfocusScale"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)_earUnfocusScale); _scaleExpression.SetReferenceParameter(<span class="hljs-string"><span class="hljs-string">"props"</span></span>, _progressProps); _thisVisual.StartAnimation(<span class="hljs-string"><span class="hljs-string">"Scale"</span></span>, _scaleExpression);</code> </pre> <br>  : <br><br><pre> <code class="hljs objectivec">_shadowBlurRadiusExpression = _compositor.CreateExpressionAnimation( <span class="hljs-string"><span class="hljs-string">"Lerp(blur1, blur2, props.progress)"</span></span>); _shadowBlurRadiusExpression.SetScalarParameter(<span class="hljs-string"><span class="hljs-string">"blur1"</span></span>, ShadowBlurRadius1); _shadowBlurRadiusExpression.SetScalarParameter(<span class="hljs-string"><span class="hljs-string">"blur2"</span></span>, ShadowBlurRadius2); _shadowBlurRadiusExpression.SetReferenceParameter(<span class="hljs-string"><span class="hljs-string">"props"</span></span>, _progressProps); _dropShadow.StartAnimation(<span class="hljs-string"><span class="hljs-string">"BlurRadius"</span></span>, _shadowBlurRadiusExpression);</code> </pre> <br>  : <br><br><pre> <code class="hljs objectivec">_shadowColorExpression = _compositor.CreateExpressionAnimation( <span class="hljs-string"><span class="hljs-string">"ColorLerp(color1, color2, props.progress)"</span></span>)) _shadowColorExpression.SetColorParameter(<span class="hljs-string"><span class="hljs-string">"color1"</span></span>, ShadowColor1); _shadowColorExpression.SetColorParameter(<span class="hljs-string"><span class="hljs-string">"color2"</span></span>, ShadowColor2); _shadowColorExpression.SetReferenceParameter(<span class="hljs-string"><span class="hljs-string">"props"</span></span>, _progressProps); _dropShadow.StartAnimation(<span class="hljs-string"><span class="hljs-string">"Color"</span></span>, _shadowColorExpression);</code> </pre> <br>       . <br><br><h2> <font color="#fd004c"></font> </h2><br>  That's all.  ,  ,    , ,         .  fluent design    :) <br><br> ‚Üí ,     , <a href="https://www.microsoft.com/store/apps/9nblggh43kx3%3Fcid%3Dhabr_fluent_design"> </a> . </div><p>Source: <a href="https://habr.com/ru/post/343880/">https://habr.com/ru/post/343880/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343870/index.html">Most Popular Books on Reddit Programming</a></li>
<li><a href="../343872/index.html">GraphQL - a new look at the API. Part 1</a></li>
<li><a href="../343874/index.html">Installing Solaris 10 on a SunFire V240 over a network using a Debian Stretch-based boot server</a></li>
<li><a href="../343876/index.html">Real-time anti-aliasing algorithms</a></li>
<li><a href="../343878/index.html">Good bot for Slack</a></li>
<li><a href="../343882/index.html">Undefined behavior! = Insecure programming</a></li>
<li><a href="../343884/index.html">Automation of development processes: how we in Positive Technologies implemented DevOps ideas</a></li>
<li><a href="../343888/index.html">Performance analysis of React 16 applications using Chrome developer tools</a></li>
<li><a href="../343890/index.html">Great Java Application Server Debate with Tomcat, Jboss, GlassFish, Jetty and Liberty Profile</a></li>
<li><a href="../343892/index.html">Twelve Linux Security Tips</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>