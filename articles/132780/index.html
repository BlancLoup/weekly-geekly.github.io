<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OPC DA 2 cheat sheet in .NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The other day I had to tinker with setting up a call to a remote server using the OPC DA 2.05a protocol, and this information would be very useful if ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OPC DA 2 cheat sheet in .NET</h1><div class="post__text post__text-html js-mediator-article">  The other day I had to tinker with setting up a call to a remote server using the OPC DA 2.05a protocol, and this information would be very useful if I knew it in advance. <br><br><h4>  1. What is OPC DA and in particular OPC DA 2.05a </h4><br>  In the general case, OPC is a set of open protocols that regulate the interaction between various automation objects, such as SCADA systems, for example.  OPC DA (Data Access) is one of these protocols, it provides data exchange with devices or software components.  In my case, according to this protocol, it was necessary to periodically collect data from the SCADA system.  And the most important thing is that OPC DA works on the basis of COM technology, so that interaction with the OPC server is essentially reduced to interaction with the COM server. <br><br><h4>  2. What are the libraries </h4><br><a name="habracut"></a><br><h5>  Binaries from <a href="http://www.opcfoundation.org/">Opc Foundation</a> </h5><br>  They are called <a href="http://www.opcfoundation.org/DownloadFile.aspx%3FCM%3D3%26RI%3D560%26CN%3DKEY%26CI%3D285%26CU%3D7">OPC .NET API 2.00 Redistributable</a> - they cannot be downloaded just like that, you need to be a "membrane" (= register and enter some money).  In the same place and OPC Core Components on which this library depends.  On the rutreker, you can find both.  In general, it is not entirely clear why to get a library from the Opc Foundation - a company that promotes an ‚Äúopen standard‚Äù - you have to pay something. <br>  What can I say about this library.  There is no documentation for it anywhere, and the API is not built in the best way (for example, there are several interfaces and classes with the same name, but in different namespaces, it is terribly inconvenient, you constantly need to go to the Object Browser and see which class is needed) However, the functionality is full - you can do anything you like, which can only be done with OPC servers.  By the way, for convenience, I drove the assemblies with a reflector and worked with the source code - all problems of decompilation, by happy coincidence, arose in other protocols (OPC AE, OPC HDA) and I simply threw them away as unnecessary.  I can send a solution, if anyone is interested, write. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <a href="http://www.advosol.us/pc-1-3-opcdanet.aspx">Components from Advasol</a> </h5><br>  Paid components (and very expensive).  I downloaded the Evaluation version - the installer, which demanded a password (!), But the password came by mail.  The most useful component in this set is test clients for OPC ‚Äî winforms applications that allow you to try to connect and see what is inside the OPC server.  I did not look at the libraries themselves, they are obfuscated and they have a time limit of half an hour, then the program must be restarted.  But I fumbled with the test client for a long time, since I had a 64bit system, and the test client build, as it turned out, was built under Target Platform = AnyCPU, and in 32bit Windows it was launched as a 32bit application (and everything worked as it should), and in 64bit one - as 64bit.  That led to an error in the COM interop code like "CLSID is not registered".  And I thought that I had something wrong configured and killed 2 days for digging into secpol.msc, dcomcnfg and compmgmt.msc.  By a lucky chance, I guessed to start the client from another car and everything became clear.  Using ILDASM and a Hex editor, I determined the TargetPlatform flag offset (from the beginning of the CLR Header), added the second bit 32BITREQUIRED, and it all worked.  Conclusion - if COM Interop is not working for you, first check the platform for compliance.  By the way, the client was also obfuscated (using SmartAssembly), and its CLR Header was located at the end. <br><br><h5>  <a href="http://www.codeproject.com/KB/COM/opcdotnet.aspx">OPCDOTNET</a> library </h5><br>  The library from the enthusiast on codeproject.com.  I can not say anything, but it was her code that was used by my predecessor, who implemented local interaction with the OPC server.  Judging by what is written in the article, it is intended for local interaction.  Pluses - available sources, test client availability, no dependencies. <br><br><h4>  3. Can I write code without using libraries? </h4><br>  In principle, there is nothing difficult about this if you have had experience with COM / DCOM applications.  And for those who, like me, do not really understand these technologies, I can recommend writing code, looking at the decompiled source of the library from the OPC Foundation.  In fact, to interact with the OPC server, all you need to do is interop on the required interfaces, get them and pull methods. <br><br><h4>  4. Problems </h4><br>  - The test client does not connect with an RPC server error is not available - check the availability of ports, port number 135 at a minimum (primary DCOM port). <br><br>  - Access Denied - will have to tinker with setting up both the server and the client.  See the links below. <br><br>  - CLSID is not registered - check if you have Core Components installed, perhaps there are not enough of them.  Or, check the Target Platform of the interop assembly.  Maybe there AnyCPU should be x86. <br><br>  - CoCreateInstanceEx returns a valid COM object, but when casted to COM interfaces, Access Denied (0x80070001) falls out.  I spent half a day with this problem.  This thing happens when you need to specify a user and password to access the server.  You call CoCreateInstanceEx by filling in a SERVER_INFO before this, and you get a reference to the object.  However, the following QueryInterface calls do not save the access parameters that you specified when getting the object, and this results in Access Denied.  The solution is to call the magic function CoInitializeSecurity, which sets default security parameters for COM calls.  Code: <br><br><pre><code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ole32.dll"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CoInitializeSecurity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr pSecDesc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cAuthSvc, SOLE_AUTHENTICATION_SERVICE[] asAuthSvc, IntPtr pReserved1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwAuthnLevel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwImpLevel, IntPtr pAuthList, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwCapabilities, IntPtr pReserved3</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeSecurity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> errorCode = CoInitializeSecurity(IntPtr.Zero, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, IntPtr.Zero, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, IntPtr.Zero, <span class="hljs-number"><span class="hljs-number">0</span></span>, IntPtr.Zero); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorCode != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExternalException(<span class="hljs-string"><span class="hljs-string">"CoInitializeSecurity: "</span></span> + GetSystemMessage(errorCode), errorCode); } }</code> </pre> <br><br>  When calling this function, an error RPC_E_TOO_LATE may occur.  This error usually occurs because of the Visual Studio host process, which implicitly calls CoInitializeSecurity on startup.  To solve the problem, simply disable the use of the host process in the project settings. <br><br>  On this issue there are several links with useful information: <br>  <a href="http://stackoverflow.com/questions/6123301/how-does-impersonation-in-dcom-work">How people with stackoverflow helped myself figure it out</a> <br>  <a href="http://pinvoke.net/default.aspx/ole32.CoInitializeSecurity">Ready interop functions with remarks</a> <br>  <a href="http://connect.microsoft.com/VisualStudio/feedback/details/98268/no-way-to-set-com-security-level-cannot-call-coinitializesecurity-in-2-0">Mayrosoft offers from developers on this issue.</a> <br><br><h4>  5. Related Links </h4><br>  <a href="http://www.opcti.com/">OPC Training Institute</a> - a site with many well-designed articles that help in case of problems.  For example, how to configure DCOM, what possible causes of an RPC error server is not available and so on.  Requires registration, registration is free. <br><br>  <a href="http://www.opcactivex.com/Support/Tutorials/DCOM_Tutorial_-_Configuring_th/dcom_tutorial_-_configuring_th.html">Tutorials on DCOM configuration</a> - another 1 well-designed tutorial for tuning. </div><p>Source: <a href="https://habr.com/ru/post/132780/">https://habr.com/ru/post/132780/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132775/index.html">Google introduced Verbatim option in advanced search settings</a></li>
<li><a href="../132776/index.html">AI Challenge: Ants AI Challenge: liven up the "ants"</a></li>
<li><a href="../132777/index.html">We implement namespace in the existing php-code</a></li>
<li><a href="../132778/index.html">Another way of blowing money, a recipe from Kyivstar</a></li>
<li><a href="../132779/index.html">Bash script for sparkles</a></li>
<li><a href="../132781/index.html">Release of the openSUSE 12.1 Linux distribution</a></li>
<li><a href="../132782/index.html">How to become Microsoft Certified Professional? And for what?</a></li>
<li><a href="../132784/index.html">FITS (Flexible Image Transport System) format in Octave</a></li>
<li><a href="../132785/index.html">HTML5: Web Workers and AJAX</a></li>
<li><a href="../132786/index.html">What search engine do you use most often?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>