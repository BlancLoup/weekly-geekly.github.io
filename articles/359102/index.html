<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Selectel IPv4 prefix route leaking</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On the night of July 15/16, 2017, one of the most memorable events happened on the Selectel network, which led to a deterioration (up to complete inac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Selectel IPv4 prefix route leaking</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/l_/th/gt/l_thgtnhyuinwkfljuznvncsuti.png"><br><br>  On the night of July 15/16, 2017, one of the most memorable events happened on the Selectel network, which led to a deterioration (up to complete inaccessibility) of the connectivity of the Selectel network with the foreign Internet segment.  And it was so remembered that the presentation of the Selectel technical director at the conference of network operators ENOG-14 was devoted to this occasion. <br><a name="habracut"></a><br>  But first things first. <br><br><h2>  Network description </h2><br>  At that time, the Selectel network looked like this.  Selectel is present in two cities of the Russian Federation - St. Petersburg and Moscow, in each city there are two border routers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/bn/ur/rr/bnurrrb9vkloxnt_elzhdo6eux8.png"><br><br>  Each of the routers announces ‚Äúto the world‚Äù the Selectel network from the autonomous system AS 49505. Uplinks and peerings are connected to each of the routers. <br><br><img src="https://habrastorage.org/webt/4e/vv/l9/4evvl9qk0bjf--novigthmbyr9a.png"><br><br>  The largest uplinks to Selectel are TransTelecom, RETN and Rask. <br>  The largest peering points to which the Selectel network is connected are MSK-IX, DATA-IX, DE-CIX. <br><br>  At some peering points (in particular, MSK-IX, DATA-IX and others), more-specific prefixes were used to increase the volume of incoming traffic through these exchange points.  DE-CIX did not use more-specific prefixes. <br><br><img src="https://habrastorage.org/webt/iz/du/xc/izduxcwuzlkmrkxi0t2e4bd9yxu.png"><br><br>  The autonomous system 49505 is also used to provide a distributed network of DNS servers.  Servers are located in several countries on different uplinks; two / 24 subnets are announced from servers using BGP anycast. <br><br><h2>  Internet Exchange </h2><br>  Internet Exchange (IX), a traffic exchange point is a peer-to-peer network for different network operators, which is one logical switch that all operators are connected to, and a pair of servers that provide general distribution of routing information between participants of the traffic exchange point (routing servers, RS ). <br><br><img src="https://habrastorage.org/webt/jf/qi/3x/jfqi3xkrtnnbt58beopyfpdcnds.png"><br><br>  Responsibility IX, as a rule, manifests itself in two forms - passing traffic from one participant to another through packet switching, and ensuring the correct functioning of routing servers at the traffic exchange point - filtering the received routes, if one of the participants announces incorrect routes, the transmission is correct information from one participant to another and, which is especially important for large traffic exchange points, the organization of a blackhole for routes marked by a special community. <br><br><h2>  Blackhole </h2><br>  Blackhole, in translation ‚Äúblack hole‚Äù, is a mechanism that allows telecom operators to protect themselves from DDoS on their networks.  This mechanism does not allow to preserve the availability of the attacked resource, but, at least, it is aimed at preserving the operability of the operator‚Äôs network that has this resource located or through which this resource is available. <br><br>  To determine the resources to which the traffic should not be transmitted, the operators use the so-called blackhole community.  At the end of 2016, this community was included in RFC 7999 in the list of well-known communities ( <a href="https://tools.ietf.org/html/rfc7999" rel="nofollow noopener noreferrer">https://tools.ietf.org/html/rfc7999</a> ). <br><br>  Usually, operators very carefully apply the blackhole community, and, as a rule, this community only applies to / 32 prefixes.  But the settings for some traffic exchange points and some operators allow reception of blackhole routes with a subnet mask other than / 32. <br><br><blockquote>  Alexander Ilyin, Technical Director, MSK-IX </blockquote><br><img src="https://habrastorage.org/webt/ym/zk/6w/ymzk6wdgbcygrbvmtjxfrd7iihq.png" alt="Alexander Ilyin, Technical Director, MSK-IX" width="120" height="120" align="left" hspace="15" vspace="15"><br>  <em>MSK-IX introduced BGP Blackholing service one of the first in the world traffic exchange points.</em>  <em>The problem described by the colleagues from Selectel did not affect our infrastructure, since according to the rules of providing Blackhole on our Route Servers, only routes from / 25 to / 32 are permissible.</em>  <em>In accordance with the policies of the regional Internet registries RIR (RIPE, RADB, etc.), the Blackhole community can only be installed on the networks already announced by the Member.</em>  <em>RS accepts from the Participant network announcements only if these networks are also announced by the Participant without an attribute and such errors will be filtered at the input.</em>  <em>We also maintain an up-to-date database of contacts of the participants and in such cases we block the violators promptly.</em> <br><br><h2>  Incident: First Blood </h2><br>  So, everything happened on the night of July 15-16.  That is, from Saturday to Sunday.  Most network engineers, I daresay, on the night from Saturday to Sunday in the summer all the same rest.  At 0:30 (time here and later Moscow time) the technical director received a call from the Selectel technical support engineers on the mobile phone: ‚ÄúSomething strange is happening, we do not yet know what, but the symptoms - customers complain about the inaccessibility of foreign servers from Selectel servers , or servers in Selectel from foreign servers.  Plus, the Slack messenger has stopped working in the office network. ‚Äù <br><br>  In response, technical support officers were instructed to collect problem routes from complaining customers.  An analysis of the logs and messages of the monitoring system revealed no obvious problems.  The Selectel network from the networks of mobile operators was normally accessible, remote access worked without problems.  A deeper analysis showed a drop in traffic on one of the uplinks, TransTelecom, without increasing the amount of traffic on other uplinks. <br><br><img src="https://habrastorage.org/webt/fh/rq/ri/fhrqriggl6htinnx8vowheky9yy.png"><br><br>  0:30 - a very unfortunate time to search for anomalies on the graphs download Internet channels.  At this time, as a rule, CHNN (busy hour) on Internet networks ends, and the drop in traffic can be caused not only by emergency reasons, but also by normal behavior during the day, and generally not very noticeable. <br><br>  Taking into account the insufficiency of the collected material and the short time of diagnosing the problem, the conclusion was made "probably something broke in the TTC".  After that, the BGP session with the TTC was deactivated.  The restructuring of the routes led to the correction of the problem, Slack started working, the connectivity was restored, the clients began to confirm the full serviceability of the service.  Technical support sent to contact technical support for TransTelecom. <br><br>  The interrupted night's sleep was continued. <br><br><h2>  Incident: main part </h2><br>  Around 02:00, the Slack messenger from the office network stopped working again, the situation with the inaccessibility of a significant part of foreign resources again repeated.  This is when the channel from TransTelecom is disconnected, that is, or the first assumption was wrong (but then why did everything work after disconnecting the BGP session from TTC?), Or the problem was further spread.  Technical support engineers on duty reported mass customer calls with complaints about resource inaccessibility.  The mass of calls and analysis of the subnets issued to customers showed that the problems concern most of the IP prefixes used in the Selectel network, that is, the problem is global in nature, and is not grouped on any single prefix. <br><br>  Technical support again began to collect the results of running the traceroute command, both from servers from inside Selectel, and from servers outside. <br>  The study of traces showed that problems are localized in the area of ‚Äã‚ÄãDE-CIX.  Moreover, there is a significant asymmetry of problem traffic flows.  If the route from Selectel to the end resource passes through DE-CIX, then there may be no problems.  But if the return route passes through the DE-CIX, then the problem of inaccessibility is clearly manifested.  Diagnosing such problems is often complicated by the asymmetry of traffic and the use of ECMP by operators.  For example, one packet from the network of operator A to the network Selectel can be sent via DE-CIX, the second - via DATA-IX, and the third via Cloud-IX. <br><br><img src="https://habrastorage.org/webt/it/oe/ns/itoensemwnw1zcyrtdkxdbte1qy.png"><br><br>  During attempts to localize and diagnose the problem, the session with TransTelecom was enabled. <br><br>  Then the engineers began to carefully analyze the information on the looking glass of various operators.  The eye caught the output of information from the TransTelecom routers. <br><br><img src="https://habrastorage.org/webt/ye/uf/do/yeufdoexsgmucie_inpvhplpni4.png"><br><br>  Selectel announces the prefix 188.93.16.0/21 to its uplinks and the more-specific prefix 188.93.16.0/22 ‚Äã‚Äãto some of the traffic exchange points.  In order for uplinks to not take more-specific prefixes ‚Äúoutside‚Äù, the same more-specific prefixes from the no-export community are announced to all uplinks;  within uplink networks, these prefixes must be present in the RIB with the best route to the client session.  But with a raised session with TransTelecom, it was found that at the Moscow TTC router (with which Selectel did not have a direct session at that moment) there is a selector more-specific prefix, leading through some autonomous system 2854. <br><br>  The autonomous system 2854 is not listed in Selectel uplinks or peers, i.e.  it should not be a transit autonomous system for Selectel prefixes.  Where did this prefix come from in TTK?  Unclear. <br><br>  We look at the DE-CIX looking glass.  Here is the route server, all the information meets expectations. <br><br><img src="https://habrastorage.org/webt/6t/e0/aq/6te0aq0hdmaxfoepbuxdi1jereo.png"><br><br>  As expected, the prefix on the route server points directly to the Selectel router.  There is no more-specific prefix, Selectel does not announce more-specific on DE-CIX.  But something stopped from moving to the next looking glass, and itinerary information was requested from route server # 2. <br><img src="https://habrastorage.org/webt/jv/cl/x0/jvclx0-0hzlsvcfdasjixf1rjsi.png"><br><br><h3>  Oh! </h3><br>  First, on route-server No. 2 from somewhere, a more-specific prefix of 188.93.16.0/22 ‚Äã‚Äãcame from.  Where did he come from?  AS path 2854 49505. That is, again AS 2854 suddenly announces the prefixes Selectel through itself.  Secondly, the community was alerted (65535, 666).  This is the blackhole community!  AS 2854 from somewhere takes more-specific Selectel prefixes, and then gives them away to the DE-CIX Route Server No. 2 with the blackhole community installed! <br><br>  Compare the output from PC1 and PC2 to DE-CIX: <br><br><img src="https://habrastorage.org/webt/s6/d_/eq/s6d_eqdmy4oinzkpr68uxiuuetm.png"><br><br>  Yes.  There is no more-specific on the PC1, and the route goes immediately to Selectel, as it should be.  The PC2 has more-specific of 2854 with the blackhole community installed. <br><br>  It is logical that the routers of the operators who take the routes from the DE-CIX route servers ‚Äúsee‚Äù the route in Selectel as the best with a more-specific prefix whose traffic is filtered by the DE-CIX itself. <br><br>  When it became clear about what the problem of routing through DE-CIX is, the chat group of telecom operators in St. Petersburg had questions ‚Äúwhy do we also have no connection with some foreign resources‚Äù.  Diagnostics ‚Äúon the beaten track‚Äù showed that again there is a problem with AS 2854, which announces through itself a lot of routes, including to operators of St. Petersburg, using the blackhole community.  Broadband operators have complaints from subscribers began to acquire a mass character only by morning, this is the specificity of broadband access for individuals and the time of occurrence of problems (I remind you, the night from Saturday to Sunday, summer - many home users at this time in summer cottages, on vacation, sleep). <br><br><h2>  Who is guilty </h2><br>  During the diagnostics, the autonomous system number is determined, which announces incorrect routes on the PC2 DE-CIX, AS 2854. Who is this?  This information is needed in order to be able to quickly contact them and say that they are doing "no business."  AS 2854 is the Russian subsidiary of the global operator Equant (also known as Orange Business Services), previously in the Russian Federation this company was called Rosprint. <br><br><img src="https://habrastorage.org/webt/g-/ek/4v/g-ek4vx4qmpogvurlklsjasrg7a.png"><br><br>  Naturally, a letter was sent to noc@rosprint.net with a description of the problem, and technical support engineers began to call these phones.  Among the technical contacts was even found a mobile phone of one of the engineers.  A call to a mobile phone engineer did not give the desired results.  The engineer of the Rosprint was on vacation and generally somewhere near Lake Baikal, and not at the computer.  Calls to the technical support of Rosprint first ended with a proposal to write them a letter describing the problem, and on Monday "networkers will come and maybe they will figure it out."  The mailbox of noc@rosprint.net during off-hours is apparently ignored.  It got to the point that technical support Rosprint, hearing "I am from the company Selectel", was just to hang up. <br><br><h2>  What to do </h2><br>  Apart from the fact that we were trying in every way to get in touch with the engineers of Rosprint, attempts were made to somehow fix the situation or reduce problems. <br>  The first attempt to rectify the situation from the very Selectel.  It is necessary to disable more-specific, then they will not fall on the PC2 DE-CIX, where 100% become the best routes for DE-CIX participants.  Disabled.  Yes, these routes have stopped falling on the PC2, but now on the PC2 there were aggregated routes to the Selectel networks.  On PC1 there was a route 188.93.16.0/21 through AS 49505 (the correct route from Selectel), but on PC2 there was a route 188.93.16.0/21 with AS path 2854 49505 and the blackhole community. <br><br>  Partially, the connectivity has been restored, now DE-CIX has not become more-specific routes to the Selectel networks.  Connectivity has not recovered from those operators and from those resources that used routes with the PC2 as the best, despite the AS path. <br><br>  OK.  We can not reach the engineers Rosprint.  We will knock to other engineers. <br><br>  Attempting to write a letter describing the problem and then calling to increase the priority of contacting DE-CIX technical support was not successful. <br><br><img src="https://habrastorage.org/webt/nj/c5/kb/njc5kbs95umpp5kemrdybhv82sw.png"><br><br>  DE-CIX technical support engineers began to deny their involvement in managing route information on route servers.  We asked to disable Rosprint from the DE-CIX routing servers, since they send incorrect information to the routing server, and we cannot reach the Rosprint engineers. <br><br>  Then we began to write letters to MSK-IX and DATA-IX with a request to disable Rosprint (since they perform incorrect actions with prefixes with IX).  And it was calculated that when two large channels fell on traffic exchange points, Rosprint technical support would be obliged to inform network engineers about this incident, and those will begin to understand. <br><br><h2>  The night has passed </h2><br>  So, in the diagnosis and attempts to contact Rosprint night passed.  Suddenly, at 11:26 (when MSK-IX and DATA-IX were also convinced of the incorrectness of the Rosprint actions and were ready to disconnect them from the routing servers), a message arrived from Rosprint: <br><br><img src="https://habrastorage.org/webt/q7/xh/jq/q7xhjqtc6qjifolhu5hhch8eq34.png"><br><br>  That's all.  No excuse, no contact, nothing ... <br><br><h2>  Lessons </h2><br>  From what happened we learned a few lessons.  Unfortunately, these lessons were achieved in my experience in dealing with our problems, but I hope this text will help other operators in the future as well: <br><br><ul><li>  On IX you should always watch two routing servers. </li><li>  Connectivity to your network must be monitored outside.  Using not just ping / HTTP GET to monitor connectivity, but various API services, including stat.ripe.net. </li><li>  The presence of more-specific prefixes to us, contrary to the common opinion among operators about their harmfulness, helped diagnose the problem. </li><li>  Concluding contracts for the bandwidth of Internet traffic with uplinks, it is desirable to provide for the possibility of working using only one operator, and not just to provide the necessary redundancy in case of failure of one of the border routers. </li><li>  Anycast, if there are any segments, it is desirable to separate the autonomous system from the main network. </li></ul><br><br>  Why did the PC on DE-CIX accept routes on the Selectel network from AS 2854? <br><br><img src="https://habrastorage.org/webt/i5/w7/x6/i5w7x65gnb9xtzpevq1nkzfxms0.png"><br><br>  Because AS 49505 is an AS-SET AS-URAL member for anycast prefixes.  And already AS 2854 can announce prefixes from AS-URAL. <br><br><blockquote>  Alexey Kuznetsov, Deputy Head, UIT, St. Petersburg State University </blockquote><br><img src="https://habrastorage.org/webt/kd/1a/-h/kd1a-hawjvh7qaih4jcotb7k8dc.jpeg" alt="Alexey Kuznetsov, Deputy Head, UIT, St. Petersburg State University" width="120" align="left" hspace="15" vspace="15"><br>  <em>Modern IT systems and communication networks are a constant interaction of users and various IT services, which in turn depend / interact with other IT services both directly from the user (social network authentication, etc.) and directly between themselves.</em>  <em>Disruption of IT services, their connection with users or between themselves immediately affects users, and often in an unobvious way.</em>  <em>The option ‚Äúdoes not work at all‚Äù is the simplest method of malfunction, while other cases require ‚Äútroubleshooting‚Äù both by technical support staff who interact directly with service users / owners and engineers.</em>  <em>What is easier, to understand in detail, or to answer, ‚Äúthe error is not in our area of ‚Äã‚Äãresponsibility,‚Äù ‚Äúthis is the Internet, no one here is responsible for anything‚Äù?</em>  <em>Yes, errors / problems of some telecoms operators can affect the work of users / services that are owned by other telecoms operators who do not have any direct relationship with the ‚Äúsource of the problem‚Äù, through whose networks traffic is not even transited.</em>  <em>A separate problem is that telecom operators have personnel of different skill levels, not to mention staff working at night and on weekends, different policies for escalating the problem, since</em>  <em>for the telecom operator, the users / services connected to it are primary, and the decision to escalate an ‚Äúalien‚Äù problem by their system administrator, and maybe first by the Management, at night depends on the person on duty, on the reaction of his colleagues to previous escalations, etc.</em>  <em>Often, the only option for rapid escalation of the problem is direct contact between managers and administrators of telecom operators, the ability to go through the chain of contacts and reach the right employee.</em>  <em>It is not accepted to go to a foreign monastery with its own charter, so either national organizations or already recognized international organizations, such as the RIPE for the Europe-Russia region, can take the initiative by setting the ‚Äúrules of the game‚Äù common for all their members.</em> </div><p>Source: <a href="https://habr.com/ru/post/359102/">https://habr.com/ru/post/359102/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../359088/index.html">Information systems with conceptual models. Part two</a></li>
<li><a href="../359090/index.html">How to programmer move to Cyprus</a></li>
<li><a href="../359092/index.html">Mobile-first indexing - Google's search revolution</a></li>
<li><a href="../359094/index.html">CTF from the Ministry of Education and Science: analysis of information security challenges</a></li>
<li><a href="../359096/index.html">Understanding of homogeneous space-time</a></li>
<li><a href="../359104/index.html">How to deploy the infrastructure for Pivotal CF, or Puff Pie Recipe in pictures</a></li>
<li><a href="../359106/index.html">Work with EventSystem in Unity. Basic things in working with UI</a></li>
<li><a href="../359108/index.html">How do we hire using the bootcamp. Experience of the department of search interfaces</a></li>
<li><a href="../359110/index.html">New attack technique based on Meltdown. Using speculative instructions for detecting virtualization</a></li>
<li><a href="../359114/index.html">What is business: a conversation on concepts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>