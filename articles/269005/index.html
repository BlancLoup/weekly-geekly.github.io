<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HAProxy turned 1.6</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I welcome categorically. 
 I hasten to inform the good news that after one and a half years (and not four), a stable version of HAProxy 1.6 with inter...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HAProxy turned 1.6</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/276/56b/261/27656b2613b145838434e801bd064b83.jpg" alt="HAProxy Logo" align="left"><br>  I welcome categorically. <br>  I hasten to inform the good news that after one and a half years (and not four), a stable version of <b>HAProxy 1.6</b> with interesting functionality appeared. <br><br>  Let me remind you that this is an ultra-fast solution that guarantees fault tolerance and ensures balancing and proxying of TCP and HTTP requests. <br><div class="spoiler">  <b class="spoiler_title">What can</b> <div class="spoiler_text">  <a href="http://habrahabr.ru/post/244027/">Many query balancing algorithms</a> <br>  Routing and filtering requests for many criteria <br>  SSL termination with SNI / NPN / ALPN and OCSP stapling included <br>  Manipulations with HTTP headers and ACL support <br>  Monitoring of HTTP and TCP backend servers with checks <br>  Easy integration with VRRP (keepalived) <br>  Compression (gzip, deflate) <br>  Syslog support, flexible log format <br>  Almost unlimited number of servers, farms, services <br>  Security (no hacking for 13 years) <br>  IPv6 and UNIX socket support <br>  ... and many other features <br></div></div><br><br>  <font color="#dddddd">I kindly ask you to write about all found inaccuracies and errors in the LAN ‚Äî I will promptly correct it.</font> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I will share what is remarkable about the release of version numbered <b>1.6</b> , which innovations you should pay attention to and briefly describe how to try these innovations.  Examples in the article are present for familiarization, and their use does not relieve from the need to refer <a href="https://cbonte.github.io/haproxy-dconv/configuration-1.6.html">to the page of constantly updated documentation</a> . <br><a name="habracut"></a><br><br><h1>  <font color="#cc0000">Finally, you can use quotes in arguments.</font> </h1><br>  This is really good news.  Now it is not necessary, when inserting into the configuration file, for example, headers, to escape spaces with a backslash. <br><br><blockquote><pre><code class="bash hljs">reqirep <span class="hljs-string"><span class="hljs-string">"^Host: www.(.*)"</span></span> <span class="hljs-string"><span class="hljs-string">"Host: foobar\1"</span></span></code> </pre> <br><pre> <code class="bash hljs">option httpchk GET / <span class="hljs-string"><span class="hljs-string">"HTTP/1.1\r\nHost: www.domain.com\r\nConnection: close"</span></span></code> </pre> </blockquote><br><h1>  <font color="#cc0000">Lua</font> </h1><br>  Apparently, April Fools' joke of the developers that they decided to rewrite the entire HAProxy to LUA had a positive effect on the functionality.  And this may have become a major change in 1.6, like SSL was once in 1.5. <br>  For example, take a look at the implementation of a ‚Äúmirror‚Äù web server.  He will return our headlines in the response body without any changes. <br><br><blockquote><pre> <code class="bash hljs">global lua-load ./webmirror.lua frontend fe_habrahabr <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> :81 name frontend_name http-request lua mirror default_backend be_habrahabr backend be_habrahabr server main_nginx 127.0.0.1:82</code> </pre><br><br>  - <b>webmirror.lua</b> <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mirror</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(txn)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> buffer = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> response = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> mydate = txn.sc:http_date(txn.f:<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>()) buffer = buffer .. <span class="hljs-string"><span class="hljs-string">"You sent the following headers/r/n"</span></span> buffer = buffer .. <span class="hljs-string"><span class="hljs-string">"===============================================/r/n"</span></span> buffer = buffer .. txn.req:dup() buffer = buffer .. <span class="hljs-string"><span class="hljs-string">"===============================================/r/n"</span></span> response = response .. <span class="hljs-string"><span class="hljs-string">"HTTP/1.0 200 OK/r/n"</span></span> response = response .. <span class="hljs-string"><span class="hljs-string">"Server: haproxy-lua/mirror/r/n"</span></span> response = response .. <span class="hljs-string"><span class="hljs-string">"Content-Type: text/html/r/n"</span></span> response = response .. <span class="hljs-string"><span class="hljs-string">"Date: "</span></span> .. mydate .. <span class="hljs-string"><span class="hljs-string">"/r/n"</span></span> response = response .. <span class="hljs-string"><span class="hljs-string">"Content-Length: "</span></span> .. buffer:<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>() .. <span class="hljs-string"><span class="hljs-string">"/r/n"</span></span> response = response .. <span class="hljs-string"><span class="hljs-string">"Connection: close/r/n"</span></span> response = response .. <span class="hljs-string"><span class="hljs-string">"/r/n"</span></span> response = response .. buffer txn.res:send(response) txn:<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br><pre> <code class="bash hljs">$ curl -v 127.0.0.1:82 HTTP/1.0 200 OK Server: haproxy-lua/mirror Content-Type: text/html Date: Fri, 12 Mar 2015 13:06:44 GMT Content-Length: 208 Connection: keep-alive You sent the following headers =============================================== GET / HTTP/1.1 User-Agent: curl/7.41.0 Host: 127.0.0.1:82 Accept: */* ===============================================</code> </pre> </blockquote><br><br>  Or, for example, a tcp server: <br><br><blockquote><pre> <code class="bash hljs">global lua-load hello_world.lua listen proxy <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> 127.0.0.1:10001 tcp-request content use-service lua.hello_world</code> </pre><br><br>  - <b>hello_world.lua</b> <br><pre> <code class="lua hljs">core.register_service(<span class="hljs-string"><span class="hljs-string">"hello_world"</span></span>, <span class="hljs-string"><span class="hljs-string">"tcp"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(applet)</span></span></span></span> applet:send(<span class="hljs-string"><span class="hljs-string">"hello world\n"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>)</code> </pre></blockquote><br><br><h1>  <font color="#cc0000">Transfer Headers Between Sections (Contexts)</font> </h1><br>  Previously, each context was isolated.  In other words, it was not possible to use request headers for a response.  But now you can. <br><blockquote><pre> <code class="bash hljs">defaults mode http frontend fe_habr <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> :9001 <span class="hljs-built_in"><span class="hljs-built_in">declare</span></span> capture request len 32 <span class="hljs-comment"><span class="hljs-comment"># id=0 to store Host header declare capture request len 64 # id=1 to store User-Agent header http-request capture req.hdr(Host) id 0 http-request capture req.hdr(User-Agent) id 1 default_backend be_habr backend be_habr http-response set-header Your-Host %[capture.req.hdr(0)] http-response set-header Your-User-Agent %[capture.req.hdr(1)] server nginx1 10.0.0.3:4444 check</span></span></code> </pre></blockquote><br><br><h1>  <font color="#cc0000">Multiprocessing, peers and stick-tables</font> </h1><br>  <b>peer</b> is another haproxy instance.  For example, on another VM, in another DC. <br>  <b>stick-table</b> is a flat database for storing information, for example, about the number of requests per second from one IP address, number of simultaneous sessions, error rate, session identifier for a cookie, etc. <br><br>  In 1.5 there existed (in 1.6 remained) such a parameter as <b>peers</b> .  Designed to synchronize <b>stick-tables</b> between balancers.  And, unfortunately, when multiprocessing was enabled in haproxy (the nbproc parameter), this functionality started to work incorrectly due to its own table for each process in memory. <br>  The solution came in the form of the <code>bind-process</code> parameter, an example will vividly show its use: <br><br><blockquote><pre> <code class="bash hljs">peers article peer itchy 127.0.0.1:1023 global pidfile /tmp/haproxy.pid nbproc 3 defaults mode http frontend f_scalessl <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-process 1,2 <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> :9001 ssl crt /home/bassmann/haproxy/ssl/server.pem default_backend bk_lo backend bk_lo <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-process 1,2 server f_myapp unix@/tmp/f_myapp send-proxy-v2 frontend f_myapp <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-process 3 <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> unix@/tmp/f_myapp accept-proxy default_backend b_myapp backend b_myapp <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-process 3 stick-table <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> ip size 10k peers article stick on src server s1 10.0.0.3:4444 check</code> </pre></blockquote><br><br><h1>  <font color="#cc0000">Logs: syslog tags and new variables</font> </h1><br>  From now on, for the convenience of filtering logs, you can apply different syslog tags for each frontend, backend, and process.  If the parameter is not specified, the word haproxy will be used. <br><blockquote><pre> <code class="bash hljs">frontend fe_habr_ssl <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-tag SSL [...] frontend fe_habr <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-tag CLEAR [...]</code> </pre></blockquote><br><br>  New variables that can be used in the log-format parameter: <br><br><blockquote><pre> <code class="bash hljs">%HM: HTTP method (ex: POST) %HP: HTTP request URI without query string (path) %HQ: HTTP request URI query string (ex: ?bar=baz) %HU: HTTP request URI (ex: /foo?bar=baz) %HV: HTTP version (ex: HTTP/1.0)</code> </pre></blockquote><br><br><h1>  <font color="#cc0000">DNS server names</font> </h1><br>  In version 1.5 and earlier, if the DNS name was specified as a backend, HAProxy received the IP address at the start and used glibc (/etc/resolv.conf) <br><br>  In 1.6, HAProxy asynchronously checks that the name matches the IP address on the fly and uses the explicitly specified DNS server.  This eliminates the need to restart the balancer if the IP address of the server in the backend has changed (which often happens in Docker or Amazon Web Service environments). <br><br>  Configuration example for Docker: <br><blockquote><pre> <code class="bash hljs">resolvers docker nameserver dnsmasq 127.0.0.1:53 defaults mode http <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> global option httplog frontend fe_habr <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> :80 default_backend be_habr backend be_habr server s1 nginx1:80 check resolvers docker resolve-prefer ipv4</code> </pre></blockquote><br><br>  Now, if we restart the container with nginx with the ‚Äúdocker restart nginx1‚Äù command, we will see evidence of the functionality of this functionality in the logs: <br><blockquote> <code>(...) haproxy[15]: b_myapp/nginx1 changed its IP from 172.16.0.4 to 172.16.0.6 by docker/dnsmasq. <br></code> </blockquote><br><br><h1>  <font color="#cc0000">HTTP request processing rules</font> </h1><br><br>  There are new rules for processing HTTP requests. <br><blockquote>  http-request: capture, set-method, set-uri, set-map, set-var, track-scX, sc-in-gpc0, sc-inc-gpt0, silent-drop <br>  http-response: capture, set-map, set-var, sc-inc-gpc0, sc-set-gpt0, silent-drop, redirect </blockquote><br><br>  Wrestlers with DDoS should pay attention to an interesting parameter <code>silent-drop</code> .  It can replace the <code>reqtarpit/reqitarpit</code> . <br>  The effect is that the connection established by the client (ESTABLISHED) after applying <code>silent-drop</code> on HAProxy disappears from the netlist on the balancer, freeing resources.  Thus, it is possible to repel attacks of much greater power without spending the precious balancer resources on it.  But it is worth remembering that all firewalls, proxies, balancers through which this connection has passed will continue to hold this connection and may become a bottleneck (‚Äúbottleneck‚Äù) in protection. <br><br><h1>  <font color="#cc0000">Variables</font> </h1><br>  Previously, HTTP headers were used to store temporary data in HAProxy.  A striking example is the <a href="">limitation of the number of requests per second in 1.5</a> . <br>  Now there are variables. <br><br><blockquote>  Write the User-agent in lower case: <br><pre> <code class="bash hljs">http-request <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-var(req.my_var) req.fhdr(user-agent),lower</code> </pre><br><br>  An example with contexts rewritten using variables <br><pre> <code class="bash hljs">global <span class="hljs-comment"><span class="hljs-comment"># variables memory consumption, in bytes tune.vars.global-max-size 1048576 tune.vars.reqres-max-size 512 tune.vars.sess-max-size 2048 tune.vars.txn-max-size 256 defaults mode http frontend f_myapp bind :9001 http-request set-var(txn.host) req.hdr(Host) http-request set-var(txn.ua) req.hdr(User-Agent) default_backend b_myapp backend b_myapp http-response set-header Your-Host %[var(txn.host)] http-response set-header Your-User-Agent %[var(txn.ua)] server s1 10.0.0.3:4444 check</span></span></code> </pre></blockquote><br><br><h1>  <font color="#cc0000">post office</font> </h1><br>  HAProxy learned to send letters.  For example, that the backend has stopped responding. <br>  The example below probably covers all the features of this innovation.  No authorization support. <br><br><blockquote><pre> <code class="bash hljs">mailers mymailers mailer smtp1 192.168.0.1:587 mailer smtp2 192.168.0.2:587 backend be_habr mode tcp balance roundrobin email-alert mailers mymailers email-alert from haproxy@habrahabr.ru email-alert to admin@habrahabr.ru server srv1 192.168.0.30:80 server srv2 192.168.0.31:80</code> </pre></blockquote><br><br><h1>  <font color="#cc0000">HTTP request body processing</font> </h1><br>  Now, in addition to processing HTTP headers, it is possible to process the request body. <br>  Enabled in the frontend or backend section with the <code>option http-buffer-request</code> parameter <br><br>  In version 1.5, it was possible to fight an attack like slowloris, in which the request headers from the attacker are transmitted as slowly as possible, on the verge of a connection timeout, <br>  But no one interfered with the slowest transfer of the POST request body.  Version 1.6 allows you to deprive the attacker and this opportunity. <br><br>  By the way, using the option <code>http-buffer-request</code> it becomes possible to use methods such as req.body, req.body_param, req.body_len, req.body_size, etc. <br><br>  Here is an example of how to block any mention of the ‚ÄúSELECT *‚Äù line in the body of POST requests: <br><br><blockquote><pre> <code class="bash hljs">defaults mode http frontend f_mywaf <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> :9001 option http-buffer-request http-request deny <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> { req.body -m reg <span class="hljs-string"><span class="hljs-string">"SELECT \*"</span></span> } default_backend b_myapp backend b_myapp server s1 10.0.0.3:4444 check</code> </pre></blockquote><br><br><h1>  <font color="#cc0000">Converters</font> </h1><br><br>  Used in ACLs and in every possible way simplified the configuration.  For example, request routing without them: <br><blockquote><pre> <code class="bash hljs">frontend ft_allapps [...] use_backend bk_app1 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> { hdr(Host) -i app1.domain1.com app1.domain2.com } use_backend bk_app2 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> { hdr(Host) -i app2.domain1.com app2.domain2.com } default_backend bk_default</code> </pre></blockquote><br><br>  With converters: <br><blockquote><pre> <code class="bash hljs">frontend ft_allapps [...] use_backend %[req.hdr(host),lower,map(/etc/haproxy/domain2backend.map,bk_default)]</code> </pre><br><br>  - <b>domain2backend.map</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#domainname backendname app1.domain1.com bk_app1 app1.domain2.com bk_app1 app2.domain1.com bk_app2 app2.domain2.com bk_app2</span></span></code> </pre></blockquote><br><br>  Convenient, isn't it? <br>  So, in 1.6 there are even more of them and I will be grateful for someone's example in the comments. <br><br><h1>  <font color="#cc0000">Determining the client device</font> </h1><br><br>  Quite unexpectedly for me, HAProxy was able to work with <a href="https://deviceatlas.com/">DeviceAtlas</a> and <a href="https://51degrees.com/">51Degrees</a> to determine the type of device and transfer the backend result. <br><br><h5>  <font color="#cc0000">Configuration example for DeviceAtlas:</font> </h5><br><br><blockquote><pre> <code class="bash hljs">global deviceatlas-json-file &lt;path to json file&gt; frontend www-only-ua <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> *:8881 default_backend servers <span class="hljs-comment"><span class="hljs-comment">#   User-agent http-request set-header X-DeviceAtlas-Data %[req.fhdr(User-Agent),da-csv-conv(primaryHardwareType,osName,osVersion,browserName,browserVersion)] deviceatlas-json-file &lt;path&gt; frontend www-all-headers bind *:8882 default_backend servers #     http-request set-header X-DeviceAtlas-Data %[da-csv-fetch(primaryHardwareType,osName,osVersion,browserName,browserVersion)]</span></span></code> </pre></blockquote><br><br><h5>  <font color="#cc0000">For 51Degrees:</font> </h5><br><br><blockquote><pre> <code class="bash hljs">global 51degrees-data-file <span class="hljs-string"><span class="hljs-string">'51D_REPO_PATH'</span></span>/data/51Degrees-LiteV3.2.dat 51degrees-property-name-list IsTablet DeviceType IsMobile 51degrees-property-separator , 51degrees-cache-size 10000 frontend www-only-ua <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> *:8082 default_backend servers <span class="hljs-comment"><span class="hljs-comment">#   User-agent http-request set-header X-51D-DeviceTypeMobileTablet %[req.fhdr(User-Agent),51d.single(DeviceType,IsMobile,IsTablet)] frontend www-all-headers bind *:8081 default_backend servers #      http-request set-header X-51D-DeviceTypeMobileTablet %[51d.all(DeviceType,IsMobile,IsTablet)] http-request set-header X-51D-Tablet %[51d.all(IsTablet)] # ,   51Degrees   http-request set-header X-51D-Stats %[51d.all(Method,Difference,Rank)]</span></span></code> </pre></blockquote><br><br>  Attention!  Support is not enabled by default.  To work with it you need: <br><br><h5>  <font color="#cc0000">For DeviceAtlas:</font> </h5><br><br>  Download API source code from <a href="https://deviceatlas.com/deviceatlas-haproxy-module">DeviceAtlas</a> <br>  Compile HAProxy with the following parameters: <br><pre> <code class="bash hljs">$ make TARGET=&lt;target&gt; USE_PCRE=1 USE_DEVICEATLAS=1 DEVICEATLAS_SRC=&lt;path to the API root folder&gt;</code> </pre><br><br><h5>  <font color="#cc0000">For 51Degrees:</font> </h5><br><br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/51Degrees/Device-Detection</code> </pre><br>  Choose a method of work: <br>  * Pattern - uses memory and processor evenly for work. <br><pre> <code class="bash hljs"> $ make TARGET=linux26 USE_51DEGREES=1 51DEGREES_SRC=<span class="hljs-string"><span class="hljs-string">'51D_REPO_PATH'</span></span>/src/pattern</code> </pre> <br>  * Trie is a high-performance algorithm that uses significantly more memory than Pattern <br><pre> <code class="bash hljs"> $ make TARGET=linux26 USE_51DEGREES=1 51DEGREES_SRC=<span class="hljs-string"><span class="hljs-string">'51D_REPO_PATH'</span></span>/src/trie</code> </pre> <br><br><h1>  <font color="#cc0000">Saving the state of the backend servers</font> </h1><br>  In 1.5, when, after receiving the reload or restart command, HAProxy assigned the UP status to all servers before performing the first check.  What is unacceptable if the road is every second uptime service.  In 1.6 it is possible to specify the path to the file where the backend information will be stored during the reboot. <br><blockquote><pre> <code class="bash hljs">global stats socket /tmp/socket server-state-file /tmp/server_state backend bk load-server-state-from-file global server s1 10.0.0.3:4444 check weight 11 server s2 10.0.0.4:4444 check weight 12</code> </pre><br><br>  Before restarting, we save the state of the backends: <br><br><pre> <code class="bash hljs">socat /tmp/socket - &lt;&lt;&lt; <span class="hljs-string"><span class="hljs-string">"show servers state"</span></span> &gt; /tmp/server_state</code> </pre></blockquote><br><br>  The task is completed, at the start haproxy will read the file and instantly take note of it. <br><br><h1>  <font color="#cc0000">External checks</font> </h1><br>  In 1.5, you can check the status of the backend servers by periodically connecting to the specified port. <br>  In 1.6, for this purpose, you can additionally use third-party scripts: <br><blockquote><pre> <code class="bash hljs">global external-check backend b_myapp external-check path <span class="hljs-string"><span class="hljs-string">"/usr/bin:/bin"</span></span> external-check <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> /bin/<span class="hljs-literal"><span class="hljs-literal">true</span></span> server s1 10.0.0.3:4444 check</code> </pre></blockquote><br><br><h1>  <font color="#cc0000">TLS / SSL</font> </h1><br><br><h5>  <font color="#cc0000">ECC and RSA support on the same IP address</font> <font color="#cc0000"><br></font> </h5><br>  It is believed that ECC protects content as well as RSA, but with a smaller key size, which means less time to process a request on the server.  Unfortunately, not all clients support ECC, but I want to have compatibility with everyone. <br>  For implementation, you need: ECC and RSA certificates for the domain, HAProxy version 1.6, and the following configuration: <br><blockquote><pre> <code class="bash hljs">frontend ssl-relay mode tcp <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> 0.0.0.0:443 use_backend ssl-ecc <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> { req.ssl_ec_ext 1 } default_backend ssl-rsa backend ssl-ecc mode tcp server ecc unix@/var/run/haproxy_ssl_ecc.sock send-proxy-v2 backend ssl-rsa mode tcp server rsa unix@/var/run/haproxy_ssl_rsa.sock send-proxy-v2 listen all-ssl <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> unix@/var/run/haproxy_ssl_ecc.sock accept-proxy ssl crt /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/haproxy/ecc.www.foo.com.pem user nobody <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> unix@/var/run/haproxy_ssl_rsa.sock accept-proxy ssl crt /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/haproxy/www.foo.com.pem user nobody mode http server backend_1 192.168.1.1:8000 check</code> </pre><br></blockquote><br>  There is a benchmark result on the E5-2680v3 CPU and OpenSSL 1.0.2: <br><pre> <code class="bash hljs">256bit ECDSA: sign verify sign/s verify/s 0.0000s 0.0001s 24453.3 9866.9 2048bit RSA: sign verify sign/s verify/s 0.000682s 0.000028s 1466.4 35225.1</code> </pre><br>  Almost 15-fold increase when signing a response. <br><br><h5>  <font color="#cc0000">Forgery of SSL certificates on the fly</font> <font color="#cc0000"><br></font> </h5>  That allows you to use HAProxy in enterprises for analyzing the contents of requests. <br><br><h5>  <font color="#cc0000">Certificate Transparency Support (RFC6962)</font> <font color="#cc0000"><br></font> </h5>  When uploading .pem files (certificate chains with a key), HAProxy will try to find a file with the same name and the .sctl suffix in the same way.  When it is detected, support for TLS Certificate Transparency is enabled.  Requires OpenSSL version 1.0.2 and higher.  Currently, the Certificate Transparency extension requires Chrome for EV certificates issued in 2015. <br><br><h5>  <font color="#cc0000">SNI support when connecting to backend with SSL</font> <font color="#cc0000"><br></font> </h5><br><blockquote><pre> <code class="bash hljs">backend b_myapp_ssl mode http server s1 10.0.0.3:4444 check ssl sni req.hdr(Host)</code> </pre></blockquote><br><br><h1>  <font color="#cc0000">HTTP reuse</font> <font color="#cc0000"><br></font> </h1><br>  By default, the connection established between HAProxy and the backend server belongs to the session that initiated it.  The disadvantage of this approach is that this connection is idle between requests.  In most cases, the reuse of these connections by other sessions will increase the performance of the backend. <br>  Option <pre> <code class="bash hljs">http-reuse</code> </pre>  in 4 different modes provides the ability to use these idle connections. <br><br><h1>  <font color="#cc0000">Error 408</font> <font color="#cc0000"><br></font> </h1><br>  This error occurred in browsers due to a pre-connect connection timeout, designed to speed up surfing on the Internet. <br>  In 1.5, it was treated with the line <code>errorfile 408 /dev/null</code> in the <code>defaults</code> section. <br>  1.6 should use the option <code>http-ignore-probes</code> <br><br><hr><br><br>  In conclusion, I want to remind you that all new versions have full backward compatibility with old configuration files, and updating to the new version will not cause any headaches.  And the possibilities presented above are only a small part of the work that has been done by the developers over the past year and a half. <br><br>  Thank you for your attention to this review.  I will be glad to answer questions in the comments and drugs. </div><p>Source: <a href="https://habr.com/ru/post/269005/">https://habr.com/ru/post/269005/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268999/index.html">How did Cisco Security Ninja teach 20,000 employees to secure programming?</a></li>
<li><a href="../269/index.html">DDos, karma and limitations</a></li>
<li><a href="../2690/index.html">Orkut will be closer to offline</a></li>
<li><a href="../269001/index.html">The digest of interesting materials for the mobile # 125 developer (October 12-18)</a></li>
<li><a href="../269003/index.html">Script shipping management online store</a></li>
<li><a href="../269007/index.html">Virtual quadrocopter on Unity + OpenCV (Part 2)</a></li>
<li><a href="../269009/index.html">Altera + OpenCL: we program under FPGA without knowledge of VHDL / Verilog</a></li>
<li><a href="../26901/index.html">HP Monster Laptop</a></li>
<li><a href="../269013/index.html">"Tomato" vs # FF6347 - the tragicomic history of color names in CSS</a></li>
<li><a href="../269015/index.html">Office as Platform, edition 8 - contextual Office application with Visual Studio Code on OS X, Linux and Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>