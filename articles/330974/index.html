<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Run Bare-metal application on Cyclone V SoC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 For some people, the FPGA SoC is something inaccessible to understanding, and this article should correct this misunderstanding. Let us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Run Bare-metal application on Cyclone V SoC</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b16/26b/e30/b1626be30781282607cfeae2e21d121d.jpg"><br><h2>  Introduction </h2><br>  For some people, the FPGA SoC is something inaccessible to understanding, and this article should correct this misunderstanding.  Let us analyze the creation of a program from scratch, from an empty project to a burning LED.  To begin with, I will say that the project was carried out on the DE1-SoC debug board, and you can easily adapt it to other boards with Altera plisses if you understand this manual.  Let's start! <a name="habracut"></a><br><br><h2>  Creating FPGA Firmware </h2><br>  To create the firmware, we obviously need a project Quartus.  But let's create this project not in the standard way (through the project wizard), but through the utility that came with the DE1-SoC board <br><br><img src="https://habrastorage.org/web/3fb/8ff/ca4/3fb8ffca4d4a4794839c48ae9cfb2621.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This utility generates a top-level file written in Verilog with ads of selected items.  We need CLOCK, HPS (SoC), buttons, LEDs.  Pressing Generate we receive the Quartus project.  The main advantage of creating a project in this way is that we do not have to assign FPGA pins to Pin Planner, because the utility did it for us, thereby saving a lot of time. <br><br><img src="https://habrastorage.org/web/2d7/8a6/cf6/2d78a6cf63a54840b408e873f82d9115.png"><br><br>  Add the generated file to the project. <br><br>  The next step is to create a system in QSYS.  Just in case, briefly explain the essence of what is happening.  Cyclone V SoC is not just an FPGA, inside its structure is a dual-core Cortex-A9 processor with different modules, such as USB ports, Ethernet, SPI, SD / MMC, etc.  In simple terms, you can think of it as a microcontroller inside an FPGA.  Creating a system in QSYS we associate a HPS (hard processor system) system with elements synthesized in FPGA using ready-made cores (IP cores).  QSYS allows you to connect different kernels through Avalon-MM or AMBA AXI buses without unnecessary worries, we don‚Äôt need to write code manually, QSYS generates it for us.  Go to QSYS and select our HPS system in the IP cores tab.  In the system settings, we need only Lightweight H2F Bridge in the FPGA interfaces tab. <br><br><img src="https://habrastorage.org/web/108/c8e/587/108c8e587aeb46f79b9b48bd28bcfb59.png"><br><br>  In the Peripheral Pins tab, select SD / MMC (we will load the program from the card) and UART.  Later we will tell about it in more detail. <br><br><img src="https://habrastorage.org/web/5df/ee1/d09/5dfee1d09d4f4abb8613a1c139d9958f.png"><br><br>  In the HPS clocks tab, leave everything by default.  In the SDRAM tab, you must fill all fields with skew values ‚Äã‚Äãand so on.  As far as I understand, they depend on the trace lines from the chip to SDRAM.  I could not find any document that has this data for the DE1-SoC, so I took it from the finished project for my board (it was SOC-Computer in the examples of Altera University Program).  I saved these settings as a perset, so as not to fill them in anymore, you can see it in the right column.  Next in the IP cores find the PIO, it will be our LEDs and buttons. <br><br><img src="https://habrastorage.org/web/879/840/332/879840332e5e413d81fb4cf832b81423.png"><br><br>  For the button settings, select Input and 4 bit width as 4 buttons in total <br><br><img src="https://habrastorage.org/web/2c2/b68/8c8/2c2b688c8fbe441b9db227db34032275.png"><br><br>  For LEDs, respectively, Output and width 10. <br><br><img src="https://habrastorage.org/web/f54/aab/7a9/f54aab7a93524a3baa6185804c49a8b4.png"><br><br>  We connect the resulting system as shown in the figure.  We can change the names of PIO to make it clearer and more beautiful.  The LWH2F bridge is the link between the HPS and the FPGA (it also appoints the HPS master), since the PIO are elements running in the FPGA ‚Äúfabric‚Äù.  We double-click on the inscription ‚ÄúDouble click for export‚Äù opposite the external connection, in order to remove the PIO LEDs and buttons from the system.  Later you will see these pins in the top-level code of the generated system file.  Since access to the PIO, and to all other cores, in the HPS is carried out by addresses, it is necessary to assign them.  This can be done automatically by clicking Assign base addresses. <br><br>  After that, you can generate a system code. <br><br><img src="https://habrastorage.org/web/b77/11a/d98/b7711ad980cf4759ade249c065ea7160.png"><br><br><img src="https://habrastorage.org/web/b29/f08/a9f/b29f08a9fb3b47cd945e948c9b9a2912.png"><br><br>  Specify the path and the desired language code.  I prefer Verilog.  After that, QSYS can be closed.  The following message appears in the Quartus window: <br><br><img src="https://habrastorage.org/web/592/b66/904/592b66904af144249f385b182e9b3850.png"><br><br>  Let's do what we are asked. <br><br><img src="https://habrastorage.org/web/643/d19/0d4/643d190d4b774287be930538ad1a64a3.png"><br><br>  In the Files window we see our hps_system.qip.  Open it and see the top-level system file. <br><br><img src="https://habrastorage.org/web/bfb/161/995/bfb1619954764bdd84409329fdc5aec5.png"><br><br>  All that we have chosen in the QSYS system is now in this file.  Now you just need to insert this module into the original file.  This will be the top-level file of our FPGA firmware. <br><br><img src="https://habrastorage.org/web/b3d/538/f95/b3d538f95fcc47abac64f920b837a483.png"><br><br>  In it, we attribute the initial I / O pins of this file to the HPS system pins.  I remind you that you do not need to assign anything to Pin Planner, everything has already been done when the project was created by the utility.  But you need to assign pins HPS, it is done as follows: <br><br><img src="https://habrastorage.org/web/88f/f7b/b68/88ff7bb68b36435bb99f04feed69b9b6.png"><br><br><img src="https://habrastorage.org/web/692/b36/16f/692b3616f547467f8ab566389e2c8930.png"><br><br>  Once this is done you can compile the firmware.  It is important to note that if any mistakes were made (for example, I forgot to put an end to the hps_system declaration near the slk_clk and hps_io_hps_io_ ... you can see from the figure) you need to re-execute the tcl scripts.  Even if everything is written correctly, and you run the tcl scripts, but after running the compilation you get an error, it is worth trying again to run the scripts without changing anything in the code.  It helped me, I do not know how to explain this feature. <br><br><img src="https://habrastorage.org/web/be2/cb8/80e/be2cb880eefe4c1f94b0c94b56d27956.png"><br><br>  And so, with the firmware finished!  Now proceed to the creation of Preloader. <br><br><h2>  Create Preloader </h2><br>  The process of loading HPS has several stages, try to understand them.  It is worth noting that the Cortex-A9 is a processor for applications, the letter "A" in the name means Application, and is primarily designed to work using the OS, for example Linux.  Therefore, strictly speaking, the idea of ‚Äã‚Äãlaunching Bare-Metal programs may seem strange, but in some cases this is necessary.  In addition, of course, there is such an opportunity, but the developer needs to understand the loading process at least at a basic level. <br><br>  Immediately after switching on, the code located directly on the Flash memory Cortex-A9 called BootRom is executed.  You cannot change it or even view its content.  It serves for the initial initialization and in the next stage transfers the boot process to the SSBL (Second Stage Boot Loader called Preloader for short).  What you need to know to understand the process is that the BootRom code, first of all, selects the Preloader boot source, focusing on external BSEL physical pins.  In the DE1-SoC, the pin configuration was initially selected for loading from an SD card, and it is impossible to change this to, for example, QSPI or NAND flash, without soldering an additional switch and a pair of resistors.  Therefore, in QSYS we selected the pins of the SD card in the Peripheral Pins tab.  There is also the option of loading not from external sources, but from memory created in FPGA, with the code preloaded there. <br><br>  And so, after the BootRom code has been executed, the Preloader, which is required to configure Clock, SDRAM and other things, starts loading.  After the program starts to run. <br><br>  To create a Preloader, you need SoC EDS, I'm sure you already downloaded it from the Intel FPGA website. <br><br><img src="https://habrastorage.org/web/4b5/a56/c7c/4b5a56c7cc5942eabdabbbe043ecb29c.png"><br><br>  The program runs from the command line.  To begin with, let's create a BSP by writing the appropriate bsp-editor command. <br><br><img src="https://habrastorage.org/web/bc3/a46/3c7/bc3a463c765e4491aca7013f60cdbc49.png"><br><br>  In this window, click New HPS BSP. <br><br><img src="https://habrastorage.org/web/26a/42f/ef0/26a42fef0e7643c5ad62bbca9a56d27f.png"><br><br>  You must specify the path to {Project directory} / hps_isw_handoff / and click OK, you do not need to change the other parameters. <br><br><img src="https://habrastorage.org/web/6c8/85e/b36/6c885eb36a0c4596a797db2a23d4234d.png"><br><br>  Select the spl.boot settings in which we indicate the source from where the Preloader will be loaded.  In our case, this is an SD card, so choose BOOT_FROM_SDMMC.  We will use the option of downloading Preloader and our program in which there are at least 2 partitions on the flash drive - a partition not formatted with id = A2, for Preloader, and a partition with the FAT32 system, for the program.  There is another option without dividing the flash drive into sections, the so-called RAW format, but in our opinion, our option is simpler.  You can format the flash drive in this way with any program (I used Mini partition tools 9.2).  Or you can use the already assembled image in the folder ... \ embedded \ embeddedsw \ socfpga \ prebuilt_images \ sd_card_linux_boot_image.tar.gz and write it to the USB flash drive via Win32DiskImager. <br><br><img src="https://habrastorage.org/web/f61/bf9/80b/f61bf980bcf04f908298c6129ed03411.png"><br><br>  Choose FAT_SUPPORT, FAT_BOOT_PARTITION 1, FAT_LOAD_PAYLOAD_NAME .img.  We will not use WATCHDOG_ENABLE and EXE_ON_FPGA (we are not going to load the Preloader with FPGA). <br><br><img src="https://habrastorage.org/web/044/03c/663/04403c66317a4256a08e8fd7a66843fb.png"><br><br>  Here is a very subtle point where I got caught and spent a whole month looking for a problem when I first became acquainted with SoC.  Serial Support means that Preloader will already use the UART module to display diagnostic messages right at boot time.  Semihosting means that when these diagnostic messages are displayed, they will be automatically displayed in the debugger window when debugging.  Using this function in the program itself is very convenient, it allows you to display everything that is written in the printf function into the debugger window without writing any additional code.  If you do not specify the use of a UART in the QSYS settings in HPS, but tick the Serial Support checkbox in BSP, this Preloader will not work.  If you remove Serial Support, while leaving Semihosting, nothing will work either, at least for me.  So you can experiment or just leave a tick, if you want everything to work.  Click Generate, then Exit. <br><br><img src="https://habrastorage.org/web/cd7/e1a/256/cd7e1a2563fc422a8fe49a5c244d6522.png"><br><br>  Now we change the working folder of the SoC EDS with the command cd "&lt;specify the full path to the generated BSP files (by default this is ... software / spl-bsp)&gt;" To build the Preloader, execute the make command.  Expect.  At the end of the process in the pack, we get the desired preloader-mkpimage.bin file. <br><br>  This is a compiled file containing the same 4 Preloader images.  Using the mkpimage command executed in the SoC EDS, you can parse this file into its components (separate images), and then assemble it from other configurations (with different Preloader images).  Other configurations can be completely different (different systems in QSYS), that is, we get separate preloader-mkpimage.bin files with 4 identical images (64kb each), disassemble them into components and now you can build a new preloader-mkpimage.bin with different images (for example, with different download sources).  This is done for reliability.  Suppose it so happened that some force did not allow to boot from the first attempt, from the first image.  Then the loading of the second image begins, and he, for example, is slightly different for an emergency.  If this failed to load, then go to the third and so on.  But this is no longer the subject of our task, rather a lyrical digression from the topic, so we continue! <br><br>  Insert a flash drive with an already prepared partition A2 and write our preloader-mkpimage.bin to it with the command "alt-boot-disk-util -p -a write ‚Äìd".  SoC EDS should point to the path to the folder where the Preloader file is located.  Everything is almost ready to write the program!  Just create header files with defaults QSYS elements for convenience.  Change the path of the SoC EDS, pointing to the firmware file, and execute the command sopc-create-header-files .sopcinfo.  At the output we get several files, looking at the contents of which it becomes clear why they are. <br><br><img src="https://habrastorage.org/web/49d/975/274/49d9752742ca49d190add23a4e6c1b3f.png"><br><br><h2>  Program </h2><br>  For writing and debugging the program, the manufacturer recommends using the DS-5 Eclipse environment.  It is recommended to run Eclipse through SoC EDS with the ‚Äúeclipse &amp;‚Äù command (the "&amp;" sign at the end of the command is placed so that the EDS SoC window is active after opening Eclipse). <br>  For those who are already familiar with ARM and have ever written a program for such an architecture, the difficulties end.  For those unfamiliar with ARM, the difficulty continues. <br><br>  Create an empty "C" project.  There will be a compiler selection window, here everyone is free to choose and deal with what suits him best.  I, as a newcomer to ARM, liked Arm Compiler 5 more, mainly because of the relatively simple synctic scatter files used to place the written program in different parts of the program (the GCC linker script syntax only scares me).  In the settings of the project, everything looks trivial.  I will point only to this command. <br><br><img src="https://habrastorage.org/web/32a/5cb/23f/32a5cb23fb45413e8c1ff37ad3bbaeb5.png"><br><br>  Do the same.  This converts the axf format to the bin format.  We will need this later to write the program to the USB flash drive.  We finally write it. <br><br><img src="https://habrastorage.org/web/204/d48/16a/204d4816ad104506a11c58d5e832fda8.png"><br><br>  Here even stdio.h is not required.  This program simply assigns the contents in memory at KEYS_BASE to the address LEDS_BASE.  By pressing a button on the board, the LED will turn off that hour. <br><br><img src="https://habrastorage.org/web/a5b/849/518/a5b8495188cf482bb5eae827ad951c30.png"><br><br>  The contents of the scatter file. <br>  To debug debugger you need to write a script.  As you remember the boot process is not easy.  The script stops Preloader execution at the stage of downloading the application from the source and transfers this task to the computer. <br><br><img src="https://habrastorage.org/web/7e7/6b1/383/7e76b1383d4a4b768972133dfd5909c9.png"><br><br>  Do not forget to flash the board before downloading the program and debug it! <br><br><img src="https://habrastorage.org/web/6eb/dee/ecd/6ebdeeecded042219bc3a61e72ad0236.png"><br><br>  In the debug window, you need to create a new task, this is done in the Debug control.  I forgot to take screenshots at this stage, so I borrowed them.  Apply the settings by analogy with those in the pictures below. <br><br><img src="https://habrastorage.org/web/dd7/ec7/02f/dd7ec702fb13407b8eeaa4ff83cac025.jpg"><br><br><img src="https://habrastorage.org/web/3bd/4fd/d71/3bd4fdd718e34969a4f44b0dcd1833e3.jpg"><br><br><img src="https://habrastorage.org/web/275/a7a/682/275a7a682b0a41729eda9b240cb85593.jpg"><br><br>  Now, after compiling, you can debug the program, view the contents of the registers and do a lot of interesting things. <br><br><img src="https://habrastorage.org/web/b10/39d/b69/b1039db69fa944f085f4c562eb8df3c2.png"><br><br>  Once you have verified that the program is working correctly, you can create an image of the program for self-loading.  To do this, from the Debug folder with the DS-5 project, take the &lt;prj_name&gt; .bin file and convert it into the .img format using SoC EDS.  This is done with the command "mkimage -A arm -O u-boot -T standalone -C none -a 0x00100000 -e 0x00100000 -n" baremetal image "-d .bin .img." Where "-a" is the address to download, and " -e "program entry point. <br><br>  The entry point can also be set in the project itself, if interrupt vectors are used, they are not used here, therefore we do not specify.  I am guided by what addresses I set in the scatter file, and write the same in this command.  Before execution, do not forget to specify the path to the bin file in the SoC EDS with the cd command "&lt;folder with file&gt;".  The name of the img file should match the one you specified in the BSP editor in FAT_LOAD_PAYLOAD_NAME. <br><br>  Now just copy the file to the USB flash drive in the fat section, just like a regular file.  By inserting a USB flash drive into the DE1-SoC, you can see the execution of the program. <br><br><h2>  Conclusion </h2><br>  In this article, many points could be considered in more detail, since the described process has many stages, and each has alternative options for implementation and its own characteristics.  But I think that the list of references will perfectly answer all other questions for me.  Read the following article <a href="https://habrahabr.ru/post/332456/">Running AMP Applications on Cyclone V SoC</a> <br><br><h3>  Bibliography </h3><br><ol><li>  <a href="https://www.altera.com/documentation/sfo1410143707420.html">Cyclone V Hard Processor System Technical Reference Manual</a> </li><li>  <a href="https://www.altera.com/literature/ug/ug_soc_eds.pdf">Altera SoC Embedded Design Suite User Guide</a> </li><li>  <a href="https://www.altera.com/content/dam/altera-www/global/en_US/pdfs/literature/an/an709.pdf">HPS SoC Boot Guide - Cyclone V SoC Development Kit</a> </li><li>  <a href="https://www.altera.com/documentation/lro1424280108409.html">Bare Metal User Guide</a> </li><li>  <a href="https://people.ece.cornell.edu/land/courses/ece5760/DE1_SOC/SoC-FPGA%2520Design%2520Guide_EPFL.pdf">SoC-FPGA Design Guide</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/330974/">https://habr.com/ru/post/330974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330964/index.html">FSTEC gives "good"</a></li>
<li><a href="../330966/index.html">Southeast Asian countries are switching to a hybrid storage model</a></li>
<li><a href="../330968/index.html">How does Malay differ from Indonesian, or a story about how we translated the application into 35 languages</a></li>
<li><a href="../330970/index.html">Mobile Retargeting: How to Measure Performance</a></li>
<li><a href="../330972/index.html">For the first time in Russia at the robotic Olympiad will be held competitions drone</a></li>
<li><a href="../330976/index.html">Career in Digital: what is it, who needs it, where to start</a></li>
<li><a href="../330978/index.html">You have the right to anonymity. Part 3. Law enforcement struggle with anonymity tools</a></li>
<li><a href="../330980/index.html">Energy accounting as part of the shopping center SCADA system</a></li>
<li><a href="../330982/index.html">Analytics in recruitment: it is not your bigdata</a></li>
<li><a href="../330984/index.html">How I passed the CISSP certificate exam</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>