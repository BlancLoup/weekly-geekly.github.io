<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing from scratch a quest for ASP.NET 5 (vNext) and Angular.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the release of the new version of ASP.NET, I want to try what it is in practice. And in order not to write another chat \ social. network \ blog ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing from scratch a quest for ASP.NET 5 (vNext) and Angular.js</h1><div class="post__text post__text-html js-mediator-article">  With the release of the new version of ASP.NET, I want to try what it is in practice.  And in order not to write another chat \ social.  network \ blog ..., for the pilot project, we will choose a logical quest - and we'll look at the framework, and we can play. <br>  Result: <br>  - <a href="https://github.com/gbdrm/HabraQuest">sorts on githaba</a> for those who are interested to play with the new ASP.NET <br>  - <a href="http://habraquest.azurewebsites.net/">Link to the quest</a> for those who are interested in what happened or spend their time on another logical quest. <br><img src="https://habrastorage.org/files/b7f/325/497/b7f32549705e424db4e7f2f9d67cccb5.png"><br><a name="habracut"></a><br><br><h3>  Prerequisites </h3><br>  To work with the new version of ASP.NET, you need Visual Studio 2015 - at the moment a preview version is available, you can download it here: <br>  <a href="http://www.visualstudio.com/en-us/downloads/visual-studio-2015-downloads-vs.aspx">www.visualstudio.com/en-us/downloads/visual-studio-2015-downloads-vs.aspx</a> <br>  There should be no problems with the installation in parallel with other versions of the studio. <br>  In fact, no other software besides the studio is needed for basic development on the .NET stack. <br><br><h3>  Create a project </h3><br>  To create a new ASP.NET application, we use, as always, File-&gt; New-&gt; Project (by the way, the menu in the new studio was again made with normal font, and not ALL CAPSOM, and personally it seems unusual to me now) <br>  Select the type of project ASP.NET Web Application.  The structure of project templates and pictures are again confused - the fact that there is no vNext icon on our type of project does not mean that our project will not be on a new version.  Perhaps in the final version of 2015 this will be fixed. <br><img src="https://habrastorage.org/files/e4d/ab2/9d3/e4dab29d3fd946308d0a19d45d2fe94b.png"><br>  If you want to add your project to the version control system - you can put a tick at the bottom (Add to source control). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the next window, you can select the starting template for web applications of the new version, where there will already be several standard pages and authorization, as well as MVC is already connected, the basic framework of the project is created. <br><img src="https://habrastorage.org/files/8f9/176/099/8f9176099d6e457fbd8f3d303fead4e9.png"><br><br>  When creating a project, if a mark was added to add to the version control system - you can specify which system the version interests us.  TFS and Git supported. <br><img src="https://habrastorage.org/files/ac9/cdb/925/ac9cdb9256dc434997b38cfc5b2f8a1d.png"><br><br>  When you first push (if you use Git, you can immediately specify an external repository) <br><img src="https://habrastorage.org/files/430/5cf/20c/4305cf20c1fb4e7ca8202adaf9adaf9b.png"><br><br><h3>  What's new in the template project </h3><br>  Probably for a .NET programmer that for the first time created ASP.NET 5 a new project will be quite a lot.  Even if you look at the structure of the launch project: <br><img src="https://habrastorage.org/files/773/7ee/fea/7737eefeabd8485589897ee7ad41fcda.png"><br><br>  Go through the innovations. <br><ul><li>  Any xml-configs.  Now all the configuration in json.  Even for those who are not familiar with the syntax, this change will be absolutely comfortable - the configuration has become shorter and clearer.  The project file remained in xml, now the project file extension is * .kporj if this is a project that is being executed on a new runtime - K runtime. </li><li>  global.json - configuration file for the whole solution.  Initially, it has one line - ‚Äúsources‚Äù: [‚Äúsrc‚Äù, ‚Äútest‚Äù] <br>  Which indicates where the weights are.  You can also specify a specific path to nuget packages. </li><li>  debugSettings.json - Run / Debug settings for a single project. </li><li>  wwwroot is the root folder of the site, intended for static files (html, css, img, js). </li><li>  Dependencies - to be honest, I didn‚Äôt understand until the end, it seems that NPM and Bower dependencies are highlighted separately in this folder. </li><li>  References - now the libraries are not reference libraries, rather convenient for navigation and search. </li><li>  bower.json - Bower packages (front-end packages). </li><li>  config.json is something like the past Web.config, only now is short and straightforward. </li><li>  gruntfile.js - configuration for Grunt (javascript build tool). </li><li>  package.json - NPM packages. </li><li>  project.json is one of the main project files, includes nuget packages and project settings. </li></ul><br>  First impression - sketched all that is possible in a heap.  Perhaps somewhere the way it is.  On the other hand, you can simply and quickly add any package, see all the dependencies.  Although it is not yet completely clear, for example, that besides Grunt it is worthwhile to include NPM in packages.  And, again, maybe in the final version everything will be somehow neater, while it is quite interesting to see web development tools from other platforms inside Visual Studio. <br><br><h3>  Begin to code.  Architecture, front-end. </h3><br>  The structure of the project is logical to do the following: all static files (one-page website on AngularJs) are placed in the wwwroot folder, and for the back-up we will create a new controller that will act as an API for the site.  By the way, in the new version of ASP.NET, the MVC and WebAPI controllers no longer differ. <br>  Out of habit, I create in wwwroot the index.html page and the app folder.  In the app, I have all the views, controllers, angular services.  And in index.html - links to all js files and layout. <br>  Since our main page is index.html, then the default route (route) in Startup.cs needs to be removed (so that when we go to the site, we visit index.html, and not Home / Index). <br><br>  Add a standard bootstrap page and a set of scripts to index.html <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.12/angular.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ajax.googleapis.com/ajax/libs/angularjs/1.3.12/angular-animate.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ajax.googleapis.com/ajax/libs/angularjs/1.3.12/angular-resource.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ajax.googleapis.com/ajax/libs/angularjs/1.3.12/angular-route.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.12.0/ui-bootstrap-tpls.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/angular-loading-bar/0.6.0/loading-bar.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"app/app.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"app/config.route.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"app/start/start.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"app/home/home.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"app/services/mainquest.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  as well as the starting view - home.html and the start.html "working" page. <br>  More <a href="https://github.com/gbdrm/HabraQuest/commit/007caa268838583a00555a2ef50581176090deba">details</a> can be found in <a href="https://github.com/gbdrm/HabraQuest/commit/007caa268838583a00555a2ef50581176090deba">commit</a> . <br><br><h3>  Back-end  Model </h3><br>  First we need to store our data somewhere.  Our project has already created a context for working with the database - ApplicationDbContext.  Let's add to it the model of our application. <br>  First of all, we need the tasks themselves - let's call them QuestTask.  It will store information about the task - number, title, content, answer. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabraQuest.Models</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">QuestTask</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Title { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Content { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Number { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Answer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre><br><br>  Well, in order for the information about the user‚Äôs levels passed, add the Progress table where the user's token and the number of his last completed task will be stored.  Tokens will be issued at the first access to the page and stored in cookies. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabraQuest.Models</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Progress</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Token { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TaskNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre><br><br>  In general, our model is ready - we will add these properties to the context. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ApplicationDbContext</span></span> : <span class="hljs-title"><span class="hljs-title">IdentityDbContext</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ApplicationUser</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;QuestTask&gt; Tasks { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Progress&gt; Progress { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } ...</code> </pre><br><br>  And then I realized that the new EntityFramework does not yet support migration, and in the code for creating the database there is a crutch. <br>  (Then I learned that there are still migrations and you can try them through the k ef migration commands, which will be described below) <br>  But since there are already some migrations there, you can try to add your tables to the database through the same crutch.  And for one thing and find out whether backward compatibility works for migrations.  So, quickly create an application in Studio 2013, add migrations, add the same classes to the model.  We are copying the migration file to the studio in 2015. It turned out that it is impossible to copy it in its pure form, since some class names and methods have changed.  But for 2 simple tables, this is fixed in 2 minutes.  Launched, earned nothing <br>  There is no need for a relational store to use. <br><br>  Googled, looked at the code, I realized that now for migrations I still have to implement IMigrationMetadata.  Sketched implementation.  Error again. <br>  I looked at the code again ... <br><br>  After 5 such iterations, I realized that in one place I have a table called dbo.Progress in another just Progress.  I wrote the same name and it all worked.  It's nice that you can actually write migrations yourself, although, of course, such things are better done with standard tools. <br>  The result of the game with migrations can be viewed on the <a href="https://github.com/gbdrm/HabraQuest/commit/8b8563dd7a6b0ec7f7d1027d9ec0591f450ad75d">githaba</a> . <br>  So we have a front-end model.  It remains to create an API. <br><br><h3>  Back-end  Controllers </h3><br>  !  The code does not carry any practical value, not refactored, written on the knee. <br>  !  basically I wanted to try C # 6 innovations, such as property initialization, an operator? .. <br>  Let's call our controller for working with quests of the quest - QuestController and implement the method on a get request to check the answer and post a request for the functionality ‚Äústart from the beginning‚Äù. <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AllowAnonymous</span></span>] [Route(<span class="hljs-string"><span class="hljs-string">"api/[controller]"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">QuestController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-comment"><span class="hljs-comment">// GET api/MainQuest [HttpGet] public MainQuestViewModel Get(string token, string taskNumberString, string answer) { // ... } // POST api/MainQuest [HttpPost] public void Post(string token, bool startAgaing) { if (startAgaing) { using (var db = new ApplicationDbContext()) { var progress = db.Progress.Single(_ =&gt; _.Token == token); progress.TaskNumber = 1; db.SaveChanges(); } } } }</span></span></code> </pre><br><br>  and a controller for statistics (get - how many people viewed the current task passed, post - add your name to the table of the finishers): <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AllowAnonymous</span></span>] [Route(<span class="hljs-string"><span class="hljs-string">"api/[controller]"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StatisticsController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-comment"><span class="hljs-comment">// GET api/Statistics [HttpGet] public StatisticsResult Get(string token) { using (ApplicationDbContext db = new ApplicationDbContext()) { var current = db.Progress.FirstOrDefault(_ =&gt; _.Token == token); int taskNumber = current?.TaskNumber ?? 1; //    C# return new StatisticsResult { Watched = db.Progress.Count(_ =&gt; _.TaskNumber &gt;= taskNumber), Done = db.Progress.Count(_ =&gt; _.TaskNumber &gt; taskNumber) }; } } // POST api/Statistics [HttpPost] public Finisher[] Post(string token, string name) { //... } } public class Finisher { public int Id { get; set; } public string Name { get; set; } public DateTime Time { get; set; } } public class StatisticsResult { public string Ok { get; } = "OK"; //    C# public int Watched { get; set; } public int Done { get; set; } }</span></span></code> </pre><br><br>  In order for the data from the server to come in a convenient javascript camelCase you need to add the following code to Startup.ConfigureServices: <br><pre> <code class="cs hljs">services.AddMvc().Configure&lt;MvcOptions&gt;(options =&gt; { options.OutputFormatters .Where(f =&gt; f.Instance <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> JsonOutputFormatter) .Select(f =&gt; f.Instance <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> JsonOutputFormatter) .First() .SerializerSettings .ContractResolver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CamelCasePropertyNamesContractResolver(); });</code> </pre><br><br><h3>  Change the model.  EF teams. </h3><br>  After I learned about the new approach for migrations, of course I wanted to try it.  Add another model - a list of people that have completed the quest and left their name at the end.  The model is quite simple: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabraQuest.Models</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Finisher</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Token { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre><br><br>  EF commands can be run from the console if connected <br>  "EntityFramework.SqlServer": "7.0.0-beta2", <br>  "EntityFramework.Commands": "7.0.0-beta2", <br><br>  This is what the command window looks like: <br><img src="https://habrastorage.org/files/6d9/479/f59/6d9479f591ba4f79998ace6f9a33c64f.png"><br><br>  I'm not sure why yet, but I failed to create the migration the first time, perhaps due to my configuration changes.  In order for it to work, you had to inherit the context from DbContext and create a configuration object inside the OnConfiguring context. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConfiguring</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContextOptions options</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> efConfiguration = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Microsoft.Framework.ConfigurationModel.Configuration() .AddJsonFile(<span class="hljs-string"><span class="hljs-string">"config.json"</span></span>) .AddEnvironmentVariables(); options.UseSqlServer(efConfiguration.Get(<span class="hljs-string"><span class="hljs-string">"Data:DefaultConnection:ConnectionString"</span></span>)); }</code> </pre><br><br>  But this way the previous migrations didn‚Äôt catch up, it‚Äôs time to delete a part of the generated code. <br>  By the way, it‚Äôs time to get into azure from 10. It‚Äôs still not clear what the problems were. <br><br><h3>  Host in Azure ... 3 days </h3><br>  It would seem that everything is simple.  Create a site in Azure, download a profile for publication, 2 clicks in the studio and that's it.  Not here it was ... I guess these attempts I will remember for a lifetime.  I spent 5 times more time than anything else to kill a site in Azure.  An internal error (500) took off at some very early stage and could not even see because of what.  At first I decided that some kind of functional is not yet supported.  Began to try to host as basic functionality as possible.  But all the other examples turned out well.  I thought maybe some kind of problem with the base or migrations, but again, with simple examples, everything worked.  In the end, began to look for a method of adding functionality a little bit.  It turned out that everything falls due to: <br><pre> <code class="cs hljs">Array.Empty&lt;Finisher&gt;()</code> </pre><br>  I still do not understand - is (Empty &lt;&gt;) a new method from Core .NET or from somewhere else?  And why Azure cannot work with it (most likely the version of the framework on Azure just does not know what it is). <br><br><h3>  Findings. </h3><br>  In general, I liked it.  Of course there are moments that are damp.  But I expected this.  Also, instead of the expected several hours, it took much longer to write.  Quite a bit has been written and documented what and how to use.  There are a number of open questions: <br><ul><li>  Will the migration work with the nuget manager console, and not with a regular console like this? </li><li>  What is logical to add to NPM packages, except grunt? </li><li>  What could be in Dependencies other than NPM and Bower packages? </li><li>  Why does Array.Empty &lt;&gt; work locally, but not work in Azure? </li></ul><br>  Maybe someone will help with the answers. <br>  All innovations seem logical and enjoyable to develop.  So let's hope that before the release all the little things will be finalized. <br><br>  <a href="https://github.com/gbdrm/HabraQuest">The sorts on the githaba.</a> <br>  <a href="http://habraquest.azurewebsites.net/">Link to the demo.</a> <br><br>  <b>UPD</b> <br>  I will write again: <br>  !  The code does not carry any practical value, not refactored, written on the knee. </div><p>Source: <a href="https://habr.com/ru/post/250009/">https://habr.com/ru/post/250009/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249993/index.html">How to advertise an online game</a></li>
<li><a href="../249999/index.html">I used dictation and voice control for a week and this is what happened</a></li>
<li><a href="../250001/index.html">The effect of drip transform in CSS</a></li>
<li><a href="../250005/index.html">Sticky effect</a></li>
<li><a href="../250007/index.html">10 bugs in Ruby / Ruby on Rails that are easy to fix</a></li>
<li><a href="../250011/index.html">Automating Android Development: the Beginning</a></li>
<li><a href="../250015/index.html">Stop using passwords in Plesk</a></li>
<li><a href="../250021/index.html">Getting rid of JavaScript in social buttons (Facebook, VK, Twitter, etc.)</a></li>
<li><a href="../250023/index.html">Limiting the number of attempts to enter a password in the authorization web form using Nginx or HAProxy using the example of WordPress</a></li>
<li><a href="../250025/index.html">Git game or in search of Linus Torvalds</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>