<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python in a box - venv in python 3.3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surely, most of those who develop or deploy Python applications use virtual environments. In particular through virtualenv , written by Ian Bicking. 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python in a box - venv in python 3.3</h1><div class="post__text post__text-html js-mediator-article">  Surely, most of those who develop or deploy Python applications use virtual environments.  In particular through <a href="http://www.virtualenv.org/en/latest/">virtualenv</a> , written by Ian Bicking. <br><br>  The idea turned out to be so good and common that something similar is now present in Python 3.3 from the box as a module <b>venv</b> .  It is almost the same as virtualenv, only <b>slightly better</b> . <a name="habracut"></a><br><br><h4>  How it works? </h4><br>  The main difference between venv is that it is built into the interpreter and can be processed even before loading the system modules.  To do this, when defining the base directory with libraries, the following algorithm is used: <br><ul><li> in the directory with the interpreter or a higher level, a file with the name <code>pyvenv.cfg</code> ; </li><li>  if the file is found, the home key is searched for in it, the value of which will be the base directory; </li><li>  In the base directory, the system library is searched (by the special <code>os.py</code> marker); </li><li>  if something went wrong, everything is rolled back to the value that is hard-coded in the binary. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      That's the whole essence of venv, everything else is already a wrapper over it. <br><br><h4>  How to create? </h4><br>  It's very simple, you need to call the <code>venv</code> module with the <code>-m</code> key, or use the pyvenv built-in script: <br><pre> <code class="bash hljs">pyvenv /path/to/new/venv</code> </pre><br><br>  The script will create the specified directory, along with all parent directories, if necessary, and build a virtual environment.  This can be done in Windows, only the call will be a bit more verbose: <br><pre> <code class="hljs pgsql">c:\Python33\python -m venv /<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>/venv</code> </pre><br><br>  When creating, you can add various parameters, such as enabling system site-packages or using symlink instead of copying the interpreter. <br><br>  Unlike virtualenv, the new venv requires that the directory being created does not exist, or is empty.  <s>This is probably done to prevent conflicts with existing files.</s>  This bug in python 3.3, in 3.4 already fixed.  (Thank you, <a href="https://habrahabr.ru/users/svetlov/" class="user_link">svetlov</a> ). <br><br><h4>  How to use? </h4><br>  You can use the good old activation method through bin / activate (Scripts / activate in windows): <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/new/venv . bin/activate python3 some_script.py</code> </pre><br><br>  Or you may <b>not use it</b> ; you just need to call the interpreter from the environment and everything will work automatically: <br><pre> <code class="bash hljs">/path/to/new/venv/bin/python3 some_script.py</code> </pre><br><br>  This of course does not work for scripts that are run directly through <code>#!/usr/bin/env python3</code> , for them you still need to, as before, do the activation.  The solution is - about it just below. <br><br><h4>  Update </h4><br>  If your system has updated version of python, the virtual environment sometimes also needs to be updated. <br>  Everything is simple - we call venv in the same way as creating an environment by adding the <code>--upgrade</code> key: <br><pre> <code class="bash hljs">pyvenv --upgrade /path/to/new/venv</code> </pre><br><br>  This will happen automatically if you use symlink, but if you want to make a fixation of the python version and libraries apart from isolation, I would recommend doing the update manually. <br><br><h4>  EnvBuilder extension </h4><br>  All work on creating the environment falls on the class <code>venv.EnvBuilder</code> , this class is written so that it can be expanded. <br><br>  For example, you can <code>distribute</code> , <code>pip</code> and the necessary initial dependencies from <code>requirements.txt</code> when initializing the environment.  It is better to leave more complicated logic on the conscience of more tools designed for this, such as buildout or make, but the initial setup can be done at the EnvBuilder level. <br><br>  When creating the environment, the <code>create(self, env_dir)</code> method is used, in the <a href="http://hg.python.org/cpython/file/bd8afb90ebf2/Lib/venv/__init__.py">source class</a> it looks like this: <br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, env_dir)</span></span></span><span class="hljs-function">:</span></span> env_dir = os.path.abspath(env_dir) context = self.ensure_directories(env_dir) self.create_configuration(context) self.setup_python(context) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.upgrade: self.setup_scripts(context) self.post_setup(context)</code> </pre><br><br>  The method describes the essence of the whole process: creating a directory ( <code>ensure_directories</code> ), configuration ( <code>create_configuration</code> ), adding python binaries ( <code>setup_python</code> ) and adding activation scripts ( <code>setup_scripts</code> ). <br><br>  At the end, the <code>post_setup</code> hook is <code>post_setup</code> , into which you can add your actions.  It can be seen that <code>post_setup</code> is executed only when creating the environment, and during - <code>upgrade</code> it will not be executed.  This is easy to fix by adding another hook: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImprovedEnvBuilder</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(venv.EnvBuilder)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, env_dir)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Overwrite create method (add more hooks)"""</span></span> env_dir = path.abspath(env_dir) context = self.ensure_directories(env_dir) self.create_configuration(context) self.setup_python(context) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.upgrade: self.setup_scripts(context) self.post_setup(context) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.post_upgrade(context) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_upgrade</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, context)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br><br>  As parameters, when calling methods after <code>ensure_directories</code> , the <code>context</code> will be passed to an object containing all necessary information about the created environment in the form of attributes.  For some reason, the documentation does not yet describe these keys, but you can easily understand everything yourself by looking at the code of the <code>ensure_directories</code> method in the base class.  I will cite the most useful attributes: <br><ul><li>  context.bin_path - path to the directory with binaries and executable scripts </li><li>  context.env_dir - path to the directory with the created environment, </li><li>  context.env_exe - the path to the binary inside the environment. </li></ul><br><br>  Accordingly, to run the python script inside the environment, you can do: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> venv <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyEnvBuilder</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(venv.EnvBuilder)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post_setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, context)</span></span></span><span class="hljs-function">:</span></span> script = <span class="hljs-string"><span class="hljs-string">'/path/to/some_script.py'</span></span> subprocess.call([context.env_exe, script])</code> </pre><br><br><h4>  Executable scripts inside the venv </h4><br>  Let's return to the problem with executable scripts inside the virtual environment. <br><br>  In virtualenv, it was enough for them to specify the interpreter via <code>#/usr/bin/env python3</code> and use, remembering to do <code>. bin/activate</code>  <code>. bin/activate</code> .  If you are satisfied with this approach, then you can continue to use it in <code>venv</code> . <br><br>  There is a new path.  Inside EnvBuilder, the <code>install_scripts(self, context, path)</code> method is implemented, which automates the copying of scripts and binaries to the created environment.  In <code>path</code> you must pass the path to a directory with nested subdirectories ‚Äúcommon‚Äù, ‚Äúnt‚Äù, ‚Äúposix‚Äù, etc.  In the subdirectory, in turn, put the necessary scripts or binaries.  In ‚Äúcommon‚Äù scripts for all platforms, in ‚Äúnt‚Äù - for Windows, ‚Äúposix‚Äù - for Linux, Mac OS X and other posix systems. <br><br>  In addition, for text files, setting values ‚Äã‚Äãis performed.  Out of the box are supported: <br><ul><li> <code>__VENV_DIR__</code> </li> <li> <code>__VENV_NAME__</code> </li> <li> <code>__VENV_BIN_NAME__</code> </li> <li> <code>__VENV_PYTHON__</code> </li> </ul><br><br>  An example of a python script to run: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!__VENV_PYTHON__ import sys import my_module if __name__ == '__main__': sys.exit(my_module.run(sys.argv))</span></span></code> </pre><br><br>  <code>__VENV_PYTHON__</code> will be replaced with the full path to the python interpreter in the virtual environment. <br><br>  After installing such a script via <code>install_scripts</code> , it can be launched without the need to activate the environment through bin / activate. <br><br><h4>  ... </h4><br><ul><li>  <a href="http://docs.python.org/3.3/library/venv.html">Documentation for the venv module</a> </li><li>  <a href="http://www.python.org/dev/peps/pep-0405/">PEP-405 - Python Virtual Environments</a> </li><li>  <a href="https://github.com/maizy/venv-experiments">A small repository on github</a> , in which I made an example of an EnvBuilder add-on auto-installing distribute, a pip, a dependency list from requirements.txt, and a set of executable scripts. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/157287/">https://habr.com/ru/post/157287/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157275/index.html">Minix NEO G4 - a miniature PC with a dual-core processor for 76 $.</a></li>
<li><a href="../157279/index.html">A selection of tools for creating web interfaces in the style of Metro</a></li>
<li><a href="../157281/index.html">OpenCV 2.4.3</a></li>
<li><a href="../157283/index.html">About different Linux and Unix shells</a></li>
<li><a href="../157285/index.html">IDC excluded Nokia from the top manufacturers of smartphones</a></li>
<li><a href="../157289/index.html">Opening Galaxy Note II - all about hardware</a></li>
<li><a href="../157291/index.html">Club of anonymous Santa Clauses already on Habr√©</a></li>
<li><a href="../157293/index.html">Two crazy ways to finish the chips</a></li>
<li><a href="../157295/index.html">Embed agile how to make pies</a></li>
<li><a href="../157299/index.html">Antiphishing.ru - global base of fraudulent Internet resources</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>