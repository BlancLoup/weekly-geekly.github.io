<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Win NPE hell in Java without using IntelliJ IDEA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Denial of responsibility 
 First, the material appeared because I wanted to quickly explain to Hindus colleagues what null analysis is, what it is goo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Win NPE hell in Java without using IntelliJ IDEA</h1><div class="post__text post__text-html js-mediator-article"><h2>  Denial of responsibility </h2><br>  First, the material appeared because I wanted to quickly explain to <s>Hindus</s> colleagues what <code>null</code> analysis is, what it is good for, and why it is necessary to overcome corporate laziness right now and start using this analysis in projects.  There was no article containing complete systematized information about the item without reference to the IDE, so I had to write it myself.  And although, as a result of complete systematization, it did not work out, I still wanted to share the material with a wider audience.  There will be a minimum of text and a lot of images. <br><br>  Secondly, the resource already has <a href="http://habrahabr.ru/post/237843/">an excellent article</a> <a href="https://habrahabr.ru/users/tr1cks/" class="user_link">tr1cks</a> , dedicated to IntelliJ IDEA, which reinforces the already persistent impression that <a href="https://www.youtube.com/watch%3Fv%3DZS6t7p2gZW8">IDEA is very good, and Eclipse is for the poor</a> (which has become the talk of the town).  To keep balance, I'll focus on Eclipse. <a name="habracut"></a><br><br>  I will use the FindBugs project annotations (also known as <a href="https://jcp.org/en/jsr/detail%3Fid%3D305">JSR 305</a> annotations) due to the lack of linking them to a specific development environment (fans can use <code>org.eclipse.jdt.annotation.*</code> And <code>org.jetbrains.annotations.*</code> ), As well as because they <a href="http://search.maven.org/">are available</a> at Maven Central.  For those who use Maven, just add the following to the <code>&lt;dependencies/&gt;</code> section: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.google.code.findbugs<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>jsr305<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>3.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Just in case, I stipulate that <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  and <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  - these are two absolutely equivalent constructions, although in some cases two variants of the obtained bytecode may differ by exactly 1 byte (by the way, how do you think - why?) <br><br><h2>  Eclipse </h2><br>  All of the following has been tested on Eclipse 4.4 (Luna).  At the same time, if my memory serves me, the described functionality was already present in 3.8 (and possibly even earlier). <br><br><h3>  Customization </h3><br><ul><li>  If you use the <a href="http://eclipse.org/m2e/">M2Eclipse</a> module, adding annotations happens instantly: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c9d/e19/cde/c9de19cde3d44f7a8a42d571a36b66ed.png"></div><br></li><li>  Next, you need to climb into the global settings or the project settings, select <b>Java</b> -&gt; <b>Compiler</b> -&gt; <b>Errors / Warnings</b> -&gt; <b>Null analysis</b> and enable <b>Enable annotation-based null analysis</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f5b/fa3/ac8/f5bfa3ac829e4b3596085621409d4f81.png"></div><br></li><li>  After that, Eclipse will ask whether to raise the level of <b>Null pointer access</b> and <b>Potential null pointer access</b> problems to ‚ÄúError‚Äù.  Here it is worth bearing in mind that by agreeing, you will receive many compilation errors for existing code, so I would recommend doing this only for new projects, and otherwise leave the ‚ÄúWarning‚Äù level. </li><li>  Now you can remove the flag <b>Use default annotations for null specifications</b> and choose JSR 305 annotations instead of the factory ones: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/070/598/cd3/070598cd397b429b863417e3f70ff147.png"></div><br></li><li>  The flag <b>Enable syntactic null analysis for fields</b> should be chosen: in this case, the number of false positives (and they will be) decreases. </li><li>  The <b>Missing '@NonNullByDefault' annotation on package</b> flag is also worth choosing (the presence of this flag favorably distinguishes Eclipse from IDEA), but <i>annotate</i> using <code>@NonNullByDefault</code> or <code>@ParametersAreNonnullByDefault</code> only new packages that are created (a huge amount of already written code, including JDK offal, tritely does not meet the requirement of "non-zero parameters" and will lead to compilation errors).  Just in case - the annotations on the package as a whole (in the file ‚Äúpackage-info.java‚Äù) are ‚Äúhung up‚Äù like this: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ParametersAreNonnullByDefault</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.annotation.ParametersAreNonnullByDefault;</code> </pre></li></ul><br><br><h3>  False positive diagnosis </h3><br>  Few people will be glad if the diagnosis is wrong.  Fortunately, it is possible to say: "Doctor, you were drunk and analyzed someone else's blood!" <br><br><h4>  Problem </h4><br>  The picture shows that Eclipse is unable to determine that (in a single-threaded scenario, of course) the <code>field</code> cannot be <code>null</code> at the time of the <code>hashCode()</code> call: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/bb3/760/ddb/bb3760ddbf024792a9bee60e15d33125.png"></div><br>  Yes, of course, we can mark the entire method with <code>@SuppressWarnings("null")</code> , but this will <code>@SuppressWarnings("null")</code> all the benefits of null analysis. <br><br><h4>  Workaround 0 </h4><br>  Add <code>assert</code> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4b3/12a/be2/4b312abe2a1548aca48a68bea99d1d18.png"></div><br><h4>  Workaround 1 </h4><br>  Longer, but also possible.  Let's pull out the field value into a local variable, mark it as <code>@Nonnull</code> and continue to work with it: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/429/a14/e4c/429a14e4c4f9420e99f4cc51ccc982fb.png"></div><br><h3>  Underwater rocks </h3><br>  Starting with Java 1.8, a new type of metadata is supported - <i>type annotations</i> (see <a href="https://jcp.org/en/jsr/detail%3Fid%3D308">JSR 308</a> ) - and, accordingly, annotations are required to explicitly specify <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Target.html"><code>@Target</code></a> .  FindBugs annotations do not meet this requirement.  Therefore, if you use Eclipse up to <b>4.4</b> inclusive (Luna) and Java 1.8, then <code>null</code> analysis using FindBugs annotations will not work ( <s><a href="https://bugs.eclipse.org/bugs/show_bug.cgi%3Fid%3D435805">bug # 435805</a></s> ).  In general, in this case, go better to Eclipse <b>4.5</b> (Mars). <br><br><h3>  Reading at home </h3><br><ul><li>  <a href="http://wiki.eclipse.org/JDT_Core/Null_Analysis">Null Analysis status in Eclipse JDT Core</a> <sup>Eng.</sup> </li><li>  <a href="http://www.scottlogic.com/blog/2013/09/09/nullable-in-kepler.html">Eclipse Kepler and @Nullable</a> <sup>English</sup> </li></ul><br><br><h2>  IDEA </h2><br>  IntelliJ IDEA supports <code>null</code> analysis, it seems, since the beginning of time (check <b>Constant conditions &amp; exceptions</b> and <b>@</b> <b>NotNull / @Nullable problems</b> ). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a1f/f94/558/a1ff94558fcc4f7193165275dafc1f56.png"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b2c/80d/737/b2c80d7376ff4b13ac3a76e7ac10cd3e.png"></div><br>  What is nice is that the medium out of the box knows about a number of suitable annotations, including JSR 305: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/8d2/63f/8a0/8d263f8a053e423faa93b7673888adaf.png"></div><br>  The only pity is that, unlike Eclipse, annotations on the entire package (like <code>@NonNullByDefault</code> or <code>@ParametersAreNonnullByDefault</code> ) are not supported. <br><br><h4>  Update </h4><br>  Starting with build 138.1372 ( <s><a href="https://youtrack.jetbrains.com/issue/IDEA-125281">IDEA-125281</a></s> ), <code>@ParametersAreNonnullByDefault</code> and <code>@ParametersAreNullableByDefault</code> at the package level are recognized and analyzed, although they do not appear anywhere in the settings (thanks to <a href="https://habrahabr.ru/users/borz/" class="user_link">Borz</a> ).  Moreover, the functionality appears to be present in IDEA 13.1.6 (build 135.1306). <br><br><h2>  Netbeans </h2><br>  NetBeans has been supporting <code>null</code> analysis since 7.3, see next.  <a href="https://blogs.oracle.com/geertjan/entry/netbeans_ide_7_3_knows">article</a> <sup>english</sup>  . <br><br><h2>  Remarks </h2><br>  If you use not only IDE, but also FindBugs, then methods that potentially return <code>null</code> should be marked not only as <code>@Nullable</code> , but also as <a href="https://jsr-305.googlecode.com/svn/trunk/javadoc/javax/annotation/CheckForNull.html"><code>@CheckForNull</code></a> ‚Äî FindBugs will ‚Äúcalm down‚Äù only if it sees <code>@CheckForNull</code> . <br><br><h2>  Nice <font color="white"><s>bonuses</s></font> <font color="white"><s>nishtyaki</s></font> side effects </h2><br>  This is a lyrical deviation from the topic, but it tells about the immediate benefits that the introduction of analysis in project X has brought. More precisely, it has helped to identify the giants of the unit tests. <br><br>  Long ago, there were tests that did not fall, but were not very cleverly written.  Yes, you were not mistaken, this is JUnit 3: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Calendar calendar = myVeryCleverNonStandardApiCall(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> year = calendar.get(Calendar.YEAR); assertEquals(<span class="hljs-number"><span class="hljs-number">1997</span></span>, year); assertEquals(<span class="hljs-string"><span class="hljs-string">"1.1"</span></span>, System.getProperty(<span class="hljs-string"><span class="hljs-string">"java.specification.version"</span></span>)); }</code> </pre><br>  It took only a few years, and it was noticed that the tests broke.  That is, it is still compiled, but does not work anymore.  The tests were "repaired", so much so that the mosquito of the nose is not undermined.  In short, no one noticed: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Calendar calendar = myVeryCleverNonStandardApiCall(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> year = calendar.get(Calendar.YEAR); <span class="hljs-comment"><span class="hljs-comment">// assertEquals(1997, year); // assertEquals("1.1", System.getProperty("java.specification.version")); }</span></span></code> </pre><br>  After a few more years, it even stopped compiling, and good statistics were still needed.  The tests were ‚Äúrepaired‚Äù again.  Since it was impossible to get rid of NPE, and throwing out a large piece of code would have attracted attention, the old test was disguised, and a new one was introduced with a second delay to distract eyes: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Thread.sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Calendar calendar = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">//myVeryCleverNonStandardApiCall(); final int year = calendar.get(Calendar.YEAR); // assertEquals(1997, year); // assertEquals("1.1", System.getProperty("java.specification.version")); }</span></span></code> </pre><br>  Conclusion? <br><br>  Sometimes it makes sense to raise the level of <b>Null pointer access</b> and <b>Potential null pointer access</b> to ‚ÄúError‚Äù even for legacy code.  <b>Especially</b> for legacy code.  You can‚Äôt even imagine what the bison who have created your product literally from scratch <i>twenty</i> years ago and safely gone into some Google or Amazon <i>ten</i> years ago are capable of. <br><br><h2>  Wishes </h2><br>  If there are people among readers who use C #, please comment, is the problem for C # relevant in the light of having such a nice thing as <a href="https://msdn.microsoft.com/en-us/library/1t3y8s4s.aspx">Nullable</a> , and, if so, by what means? </div><p>Source: <a href="https://habr.com/ru/post/204518/">https://habr.com/ru/post/204518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204506/index.html">kidomi: building DOM objects on the fly</a></li>
<li><a href="../204508/index.html">Optimal DDoS protection with netstat and iptables</a></li>
<li><a href="../204510/index.html">How we did the API for the social network (REST API for WEB)</a></li>
<li><a href="../204512/index.html">Introduction to Windows 8.1 Upgrade</a></li>
<li><a href="../204514/index.html">We program under Pebble. Lesson two: Pebble giving answers, dice and sex cubes</a></li>
<li><a href="../204520/index.html">Acquaintance and date: ratings and reviews of users and users. (Comic ideas continue to be embodied on smartphones.)</a></li>
<li><a href="../204522/index.html">Percona service for creating optimal configuration of MySQL servers and analyzing SQL queries</a></li>
<li><a href="../204524/index.html">Enhance development convenience and efficiency with Alfred (OSX)</a></li>
<li><a href="../204526/index.html">Sending python packages to ppa without ‚Äúlife pain‚Äù</a></li>
<li><a href="../204530/index.html">Inplace Upgrade Windows Server 2012 to Windows Server 2012 R2 with Exchange 2013 CU3 installed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>