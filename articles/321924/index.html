<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web push notifications quick and easy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. In this small article I want to tell you how to quickly and easily set up push notifications on your site. This article does not in any way ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Web push notifications quick and easy</h1><div class="post__text post__text-html js-mediator-article"><p>  Good day.  In this small article I want to tell you how to quickly and easily set up push notifications on your site.  This article does not in any way claim to be an exhaustive guide, but I hope that it will give a starting point for further study. </p><br><p>  Information on this topic on the Internet is complete, but it is fragmented, scattered across various resources and mixed with mobile notifications with examples in Java, C ++ and Python.  We, as web developers, are interested in JavaScript.  In this article I will try to accumulate all the necessary and useful information. </p><br><p><img src="https://habrastorage.org/files/3d7/7de/9cb/3d77de9cbbdf47bca4132ae7e2ac7ac4.png" alt="Web push notifications"></p><br><p>  I think you already know what <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D1%258F_push">push notifications are</a> , but I will still write briefly about the main thing. </p><br><p>  The user, entering the site, pulls out (pull) data from it.  This is convenient and secure, but with the development of Internet resources, there is a need to promptly deliver information to users without waiting for them to make a request.  And the technology of forced delivery (push) of data from the server to the client appeared. </p><br><a name="habracut"></a><br><blockquote>  <strong>Important</strong> <br><br>  Push notifications only work if you have <a href="https://ru.wikipedia.org/wiki/HTTPS">HTTPS</a> on your site. <br>  Without a valid SSL certificate, it will not work.  So if you don‚Äôt have HTTPS support yet, then it‚Äôs time to do it.  I recommend to use <a href="https://letsencrypt.org/">Let's Encrypt</a> . <br>  To run on localhost you need to resort to <a href="https://www.chromium.org/blink/serviceworker/service-worker-faq">tricks</a> .  I tested the scripts on <a href="https://habr.com/ru/post/321924/">Github Pages</a> . </blockquote><br><h1 id="oglavlenie">  Table of contents </h1><br><ul><li>  <a href="https://habr.com/ru/post/321924/">Good notices</a> </li><li>  <a href="https://habr.com/ru/post/321924/">Theory</a> <br><ul><li>  <a href="https://habr.com/ru/post/321924/">What happens on the client side?</a> </li><li>  <a href="https://habr.com/ru/post/321924/">Difficulties on the server side</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/321924/">Practice</a> <br><ul><li>  <a href="https://habr.com/ru/post/321924/">Start writing client</a> </li><li>  <a href="https://habr.com/ru/post/321924/">Sending notifications from the server</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/321924/">TTL and additional notification control</a> </li><li>  <a href="https://habr.com/ru/post/321924/">Conclusion</a> </li><li>  <a href="https://habr.com/ru/post/321924/">Play around</a> <br><ul><li>  <a href="https://habr.com/ru/post/321924/">Project on GitHub Pages</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/321924/">Links</a> </li></ul><br><h2 id="horoshie-uvedomleniya">  Good notices </h2><br><p>  Just want to make a reservation that the push-notifications are not for promotional mailings.  You only need to send what the specific user really needs and to which he really should respond promptly. </p><br><p>  Good example: </p><br><ul><li>  Sending a notification about the change in the status of the user's call to the technical support service; </li><li>  Sending notification of changes in the status of the order; </li><li>  The appearance in the warehouse of goods that the user was waiting for; </li><li>  Answered a user comment on the article; </li><li>  New task in bug tracker with Bug or Critical status. </li></ul><br><p>  Bad example: </p><br><ul><li>  New arrivals to the warehouse; </li><li>  Discounts and promotions for goods; </li><li>  New article on the site; </li><li>  Answered a user comment on an article he wrote a year ago. </li></ul><br><p>  Bad examples also require notification, but they do not need to respond quickly.  These notifications can be sent by mail.  In general, it is recommended to duplicate all important notifications to the mail, since push notifications may not reach the user for various reasons beyond your control.  Also important is the relevance of the event.  I will talk about this a little later.  I recommend reading: </p><br><ul><li>  <a href="https://developers.google.com/web/fundamentals/engage-and-retain/push-notifications/good-notification">Good notices according to Google</a> </li><li>  <a href="https://pushall.ru/blog/whatispushnotifications">Promotional article from PushAll</a> </li></ul><br><p>  Let's return to our sheep.  So how does all this work?  First, a little theory. </p><br><h2 id="teoriya">  Theory </h2><br><p>  Among the uninitiated, there is a perception that push notifications are a simple technology that does not require special resources to implement.  In fact, this is a whole pool of technologies. </p><br><p>  First, a small diagram of how it all works ( <a href="">animated diagram</a> ): </p><br><p><img src="https://habrastorage.org/files/7d4/f51/82d/7d4f5182d7ef455281500be406cf40ac.jpg" alt="Interaction scheme in push notifications"></p><br><ol><li>  The server gives the page to the user; </li><li>  The client connects to the message server, registers and receives an ID; </li><li>  The client sends the received ID to the server and the server binds a specific user to a specific device using the device ID; </li><li>  The server sends the message to the client via the message server using the previously received ID. </li></ol><br><p>  <em>Unfortunately, I was not able to figure out who and how creates the device ID and how the message server is tied to a specific device.</em>  <em>I used Google's <a href="https://firebase.google.com/docs/cloud-messaging/">Firebase Cloud Messaging</a> message server and its library.</em>  <em>Unfortunately, I could not find out whether it is possible to replace it with my server and how to do it.</em> </p><br><blockquote>  <strong>Funny fact</strong> <br><br>  Initially used to send messages: <br>  Cloud to Device Messaging 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then it was replaced by: <br>  Google Cloud Messaging <br><br>  And then again changed to: <br>  Firebase cloud messaging <br><br>  I wonder what's next. </blockquote><br><h3 id="chto-zhe-proishodit-na-storone-klienta">  What happens on the client side? </h3><br><ul><li>  JavaScript prompts the user for permission to display notifications; </li><li>  If the user has approved, then connect to the message server and get the device ID; </li><li>  We send the identifier to our server so that we identify the user; </li><li>  We initialize a JavaScript <a href="https://developer.mozilla.org/ru/docs/Web/API/ServiceWorker">worker</a> who will work in the background, receive messages from the message server and show them to the user; </li><li>  Connect to the message server and wait for new arrivals. </li></ul><br><p><img src="https://habrastorage.org/files/cb7/259/979/cb7259979db64e848886ad30898ef1b9.png" alt="Request rights to display notifications"></p><br><blockquote>  <strong>The note</strong> <br><br>  Google <a href="https://developers.google.com/web/fundamentals/engage-and-retain/push-notifications/permissions-subscriptions">recommends</a> using the switch to subscribe and unsubscribe from notifications.  Thus, the initiation of the notification subscription procedure comes from the user, and not from the site.  Signing up for notifications for every incoming user is a bad practice. </blockquote><p>  It all looks very difficult, but everything is not easier on the server. </p><br><h3 id="slozhnosti-na-servernoy-storone">  Difficulties on the server side </h3><br><ul><li>  It is clear that the device ID, sent by the user, we save in the database; </li><li>  A device identifier would be good to link to the user in order to send personalized messages; </li><li>  It is worth remembering that we have one user, but he can have several devices, and several users can use one device; </li><li>  Sending notifications to users is not the cheapest operation and therefore the event initiating the sending of a notification must be queued for sending; </li><li>  Only small projects with a small number of recipients can afford to send notifications on the event, during the same HTTP request; </li><li>  So we have a queue system on RabbitMQ, Redis, etc .; </li><li>  Demons / workers appear that parse the queue and other queue support tools; </li><li>  To increase the speed of sending, you can parallelize the process and spread it across several nodes. </li></ul><br><h2 id="praktika">  Practice </h2><br><p>  Finally, we have moved to the most important thing.  As I said earlier, we‚Äôll use <strong>Firebase Cloud Messaging</strong> as a messaging server, so we start by registering and creating a project on Firebase. </p><br><p>  Everything is simple: </p><br><ul><li>  We go to the <a href="https://console.firebase.google.com/">site</a> ; </li><li>  Register; </li><li>  We press the button <em>Create new project</em> or <em>Import Google project</em> , if you already have a project; </li><li>  When creating, specify the project name and country; </li><li>  After creating the project, we get to its dashboard; </li><li>  In the menu, we point at the wheel next to <em>Overview</em> and select <em>Project settings</em> ; </li><li>  On the page that opens, go to the <em>Cloud Messaging</em> tab; </li><li>  We are interested in the <strong>Server key</strong> , which will be used to send messages from the server and the <strong>Sender ID</strong> that will be used to receive messages on the client side. </li></ul><br><p>  You can still delve into the settings and play with the separation of access rights, but, in general, the work with the Firebase site is over. </p><br><h3 id="pristupaem-k-napisaniyu-klienta">  Start writing client </h3><br><p>  Let's start by creating a <a href="https://developer.mozilla.org/ru/docs/Web/API/ServiceWorker">Service Worker</a> to receive push notifications. <br>  Create a <em>firebase-messaging-sw.js file</em> with the following contents. </p><br><pre><code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ firebase-messaging-sw.js importScripts('https:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/www.gstatic.com/firebasejs</span></span><span class="hljs-regexp"><span class="hljs-regexp">/3.6.8/firebase</span></span>-app.js<span class="hljs-string"><span class="hljs-string">'); importScripts('</span></span><span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/www.gstatic.com/firebasejs</span></span><span class="hljs-regexp"><span class="hljs-regexp">/3.6.8/firebase</span></span>-messaging.js<span class="hljs-string"><span class="hljs-string">'); firebase.initializeApp({ messagingSenderId: '</span></span>&lt;SENDER_ID&gt;<span class="hljs-string"><span class="hljs-string">' }); const messaging = firebase.messaging();</span></span></code> </pre> <br><p>  Where, </p><br><ul><li>  <code>&lt;SENDER_ID&gt;</code> is the <strong>Sender ID</strong> we received after registering with Firebase. </li></ul><br><blockquote>  <strong>Important note</strong> <br><br>  The Service Worker file must be called <em>firebase-messaging-sw.js</em> and must be in the project root, that is, available at <em><a href="">https://example.com/firebase-messaging-sw.js</a></em> .  The path to this file is fixed in <a href="">the</a> Firebase <a href="">library</a> . </blockquote><p>  Writing code is enough to show notifications.  We'll talk about additional features later.  Now add the Firebase library and the subscription script to our page template. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//www.gstatic.com/firebasejs/3.6.8/firebase.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/firebase_subscribe.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Add a button to subscribe to notifications on the page. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"subscribe"</span></span></span><span class="hljs-tag">&gt;</span></span>  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Subscribe to notifications </p><br><pre> <code class="hljs lua">// firebase_subscribe.js firebase.initializeApp({ messagingSenderId: <span class="hljs-string"><span class="hljs-string">'&lt;SENDER_ID&gt;'</span></span> }); //    // ,      Firebase,      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">'Notification'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> window) { var messaging = firebase.messaging(); //      //        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Notification.permission === <span class="hljs-string"><span class="hljs-string">'granted'</span></span>) { subscribe(); } //  ,       //    $(<span class="hljs-string"><span class="hljs-string">'#subscribe'</span></span>).on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscribe(); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">subscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { //      messaging.requestPermission() .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { //  ID  messaging.getToken() .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(currentToken)</span></span></span></span> { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(currentToken); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentToken) { sendTokenToServer(currentToken); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.warn(<span class="hljs-string"><span class="hljs-string">'   .'</span></span>); setTokenSentToServer(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); } }) .catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err)</span></span></span></span> { console.warn(<span class="hljs-string"><span class="hljs-string">'    .'</span></span>, err); setTokenSentToServer(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); }); }) .catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err)</span></span></span></span> { console.warn(<span class="hljs-string"><span class="hljs-string">'      .'</span></span>, err); }); } //  ID   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendTokenToServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(currentToken)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isTokenSentToServer(currentToken)) { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'   ...'</span></span>); var url = <span class="hljs-string"><span class="hljs-string">''</span></span>; //       ID  $.post(url, { token: currentToken }); setTokenSentToServer(currentToken); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'    .'</span></span>); } } //  localStorage   , //       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isTokenSentToServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(currentToken)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> window.localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'sentFirebaseMessagingToken'</span></span>) == currentToken; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTokenSentToServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(currentToken)</span></span></span></span> { window.localStorage.setItem( <span class="hljs-string"><span class="hljs-string">'sentFirebaseMessagingToken'</span></span>, currentToken ? currentToken : <span class="hljs-string"><span class="hljs-string">''</span></span> ); }</code> </pre> <br><p>  That's all.  This is all the code that is required to receive push notifications. </p><br><h3 id="otpravka-uvedomleniy-s-servera">  Sending notifications from the server </h3><br><p>  In general, sending a notification looks like this: </p><br><pre> <code class="hljs pgsql">POST /fcm/send HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> Host: fcm.googleapis.com <span class="hljs-keyword"><span class="hljs-keyword">Authorization</span></span>: key=YOUR-<span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>-KEY Content-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: application/<span class="hljs-type"><span class="hljs-type">json</span></span> { "notification": { "title": "", "body": "  21:00", "icon": "https://eralash.ru.rsz.io/sites/all/themes/eralash_v5/logo.png?width=40&amp;height=40", "click_action": "http://eralash.ru/" }, "to": "YOUR-TOKEN-ID" }</code> </pre> <br><p>  Where, </p><br><ul><li>  <code>YOUR-SERVER-KEY</code> is the <strong>Server key</strong> that we received when registering with Firebase; </li><li>  <code>YOUR-TOKEN-ID</code> is the device ID of a specific user. </li></ul><br><p>  All fields in order: </p><br><ul><li>  <code>notification</code> - <code>notification</code> parameters; </li><li>  <code>title</code> - the title of the notification.  30 character limit; </li><li>  <code>body</code> - text notification.  120 characters limit; </li><li>  <code>icon</code> - notification icon.  There are some <a href="https://resizeappicon.com/sizes">standards for</a> icon sizes, but I use 192x192.  Smaller icons do not look good on mobile devices; </li><li>  <code>click_action</code> - URL address of the page to which the user will click on the notification; </li><li>  <code>to</code> - device ID of the notification recipient; </li><li>  Full list of options <a href="http-server-ref">here</a> . </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e65/0ea/a99/e650eaa99e3142deb27aefc77ae09cd6.png" alt="Notification"></div><br><p>  This is an example of sending one notification to one recipient.  You can send one notification to multiple recipients at once.  Up to <strong>1000</strong> recipients at a time. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"notification"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>: <span class="hljs-string"><span class="hljs-string">"  21:00"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"icon"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://eralash.ru.rsz.io/sites/all/themes/eralash_v5/logo.png?width=192&amp;height=192"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"click_action"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://eralash.ru/"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"registration_ids"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"YOUR-TOKEN-ID-1"</span></span>, <span class="hljs-string"><span class="hljs-string">"YOUR-TOKEN-ID-2"</span></span> <span class="hljs-string"><span class="hljs-string">"YOUR-TOKEN-ID-3"</span></span> ] }</code> </pre> <br><p>  Sample responses from the message server: </p><br><div class="spoiler">  <b class="spoiler_title">Send a notification in Chrome</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"multicast_id"</span></span>: <span class="hljs-number"><span class="hljs-number">6407277574671070000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"success"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"failure"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"canonical_ids"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"results"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"message_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"0:1489072146895227%e609af1cf9fd7ecd"</span></span> } ] }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Send notification to FireFox</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"multicast_id"</span></span>: <span class="hljs-number"><span class="hljs-number">7867877497742898000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"success"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"failure"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"canonical_ids"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"results"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"message_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://updates.push.services.mozilla.com/m/gAAAAABYwWmlTCKje5OLwedhNUQr9LbOCmZ0evAF9HJBnR-v7DF2KEkZY3zsT8AbrqB6JfJO6Z6vsotLJMmiIvJs9Pt1Q9oc980BRX2IU1-jlzRLIhSVVBLo2i80kBvTMYadVAMIlSIyFkWm-qg_DfLbenlO9z1S4TGMJl0XbN5gKMUlfaIjnX2FBG4XsQjDKasiw8-1L38v"</span></span> } ] }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Error sending notification</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"multicast_id"</span></span>: <span class="hljs-number"><span class="hljs-number">8165639692561075000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"success"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"failure"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"canonical_ids"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"results"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"error"</span></span>: <span class="hljs-string"><span class="hljs-string">"InvalidRegistration"</span></span> } ] }</code> </pre> </div></div><br><p>  Full list <a href="http-server-ref">of error codes</a> . </p><br><p>  We are not tied to any specific programming language and for simplicity of example we will use PHP with the cURL extension.  The script to send a notification to run from the console. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env php &lt;?php $url = 'https://fcm.googleapis.com/fcm/send'; $YOUR_API_KEY = ''; // Server key $YOUR_TOKEN_ID = ''; // Client token id $request_body = [ 'to' =&gt; $YOUR_TOKEN_ID, 'notification' =&gt; [ 'title' =&gt; '', 'body' =&gt; sprintf('  %s.', date('H:i')), 'icon' =&gt; 'https://eralash.ru.rsz.io/sites/all/themes/eralash_v5/logo.png?width=192&amp;height=192', 'click_action' =&gt; 'http://eralash.ru/', ], ]; $fields = json_encode($request_body); $request_headers = [ 'Content-Type: application/json', 'Authorization: key=' . $YOUR_API_KEY, ]; $ch = curl_init(); curl_setopt($ch, CURLOPT_URL, $url); curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST'); curl_setopt($ch, CURLOPT_HTTPHEADER, $request_headers); curl_setopt($ch, CURLOPT_POSTFIELDS, $fields); curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true); $response = curl_exec($ch); curl_close($ch); echo $response;</span></span></code> </pre> <br><h3 id="messagingonmessage">  messaging.onMessage </h3><br><p>  The <code>messaging.onMessage</code> handler is worth a separate mention, as it falls into the category of pitfalls.  In the examples from Firebase, I did not see an example using this handler.  <a href="https://habr.com/users/fluorescenthallucinogen/" class="user_link">FluorescentHallucinogen</a> told me about it, for which a special thanks to him, but he did not mention some features of its use. </p><br><p>  What is this handler and how does it work.  From the <a href="https://firebase.google.com/docs/reference/js/firebase.messaging.Messaging">documentation,</a> we know that this handler is called if we receive a push notification and are at that moment on the page the site from which the notification was sent <em>(those who want to use the native solution can see the <a href="https://web-push-book.gauntface.com/chapter-05/04-common-notification-patterns/">implementation example</a> )</em> .  This functionality is very useful in that we can display a notification on the page by making a beautiful modalke or something else.  I have no such need, because I just display the <a href="https://developer.mozilla.org/en-US/docs/Web/API/notification">standard notification</a> . </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">'Notification'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messaging = firebase.messaging(); messaging.onMessage(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">payload</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Message received. '</span></span>, payload); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Notification(payload.notification.title, payload.notification); }); <span class="hljs-comment"><span class="hljs-comment">// ... } // ...</span></span></code> </pre> <br><p>  It seems simple, but there is a pitfall.  The thing is that on mobile devices it is <a href="https://groups.google.com/a/chromium.org/forum/">forbidden to</a> use the Notification constructor.  And to solve this problem, you need to use <code>ServiceWorkerRegistration.showNotification()</code> and the handler in this case will have the form: </p><br><pre> <code class="hljs lua">// ... messaging.onMessage(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(payload)</span></span></span></span> { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Message received. '</span></span>, payload); //   ServiceWorker   navigator.serviceWorker.register(<span class="hljs-string"><span class="hljs-string">'messaging-sw.js'</span></span>); //           Notification.requestPermission(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result === <span class="hljs-string"><span class="hljs-string">'granted'</span></span>) { navigator.serviceWorker.ready.<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(registration)</span></span></span></span> { //      <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> registration.showNotification(payload.notification.title, payload.notification); }).catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'ServiceWorker registration failed'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); }); } }); }); // ...</code> </pre> <br><p>  Now notifications work on mobile devices.  It would seem that everything, but no.  Despite the <a href="http://stackoverflow.com/questions/31512504/html5-notification-not-working-in-mobile-chrome/31787926">assurances of some</a> , ServiceWorker should not be empty.  We want the user to click on the page we need on click.  To do this, we need to add a click handler for the notification to the ServiceWorker. </p><br><p>  <code>click_action</code> notification settings for access to the <code>click_action</code> property in ServiceWorker. </p><br><pre> <code class="hljs lua">// ... navigator.serviceWorker.ready.<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(registration)</span></span></span></span> { payload.notification.data = payload.notification; //   registration.showNotification(payload.notification.title, payload.notification); }).catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'ServiceWorker registration failed'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); }); // ...</code> </pre> <br><p>  We process click on the notification in ServiceWorker. </p><br><pre> <code class="hljs lua">// messaging-sw.js self.addEventListener(<span class="hljs-string"><span class="hljs-string">'notificationclick'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { const target = event.notification.data.click_action || <span class="hljs-string"><span class="hljs-string">'/'</span></span>; event.notification.<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(); //            //      ,     event.waitUntil(clients.matchAll({ <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: <span class="hljs-string"><span class="hljs-string">'window'</span></span>, includeUncontrolled: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }).<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(clientList)</span></span></span></span> { // clientList -  !? <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; clientList.length; i++) { var client = clientList[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.url == target &amp;&amp; <span class="hljs-string"><span class="hljs-string">'focus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> client) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.focus(); } } //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> clients.openWindow(target); })); });</code> </pre> <br><h2 id="ttl-i-dopolnitelnyy-kontrol-nad-uvedomleniem">  TTL and additional notification control </h2><br><p>  An important property for notification may be the time of its relevance.  It depends on your business processes.  By default, the notification lifetime is 4 weeks.  This is a lot of notifications of this nature.  For example, the notice "Your favorite show starts in 15 minutes" is relevant for 15 minutes.  After that, the message is no longer relevant and should not be shown.  The <code>time_to_live</code> property with a value from 0 to 2419200 seconds is responsible for controlling the lifetime.  Read more in the <a href="https://firebase.google.com/docs/cloud-messaging/concept-options">documentation</a> .  The message with the specified TTL will be: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"notification"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>: <span class="hljs-string"><span class="hljs-string">"  15 "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"icon"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://eralash.ru.rsz.io/sites/all/themes/eralash_v5/logo.png?width=192&amp;height=192"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"click_action"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://eralash.ru/"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"time_to_live"</span></span>: <span class="hljs-number"><span class="hljs-number">900</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-string"><span class="hljs-string">"YOUR-TOKEN-ID"</span></span> }</code> </pre> <br><p>  The message of the form "Your favorite program starts in 15 minutes" is relevant within 15 minutes, but within a minute after sending it will not be correct.  Because the transfer will not begin after 15 minutes, but after 14. It is necessary to control such situations on the client side. </p><br><p>  To do this, we will change the message sent from the server: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time"</span></span>: <span class="hljs-number"><span class="hljs-number">1489006800</span></span>, <span class="hljs-attr"><span class="hljs-attr">"icon"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://eralash.ru.rsz.io/sites/all/themes/eralash_v5/logo.png?width=192&amp;height=192"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"click_action"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://eralash.ru/"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"time_to_live"</span></span>: <span class="hljs-number"><span class="hljs-number">900</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-string"><span class="hljs-string">"YOUR-TOKEN-ID"</span></span> }</code> </pre> <br><p>  Please note that the <code>notification</code> field has changed to <code>data</code> .  Now the Firebase default handler will not be called and we need to do it ourselves.  Add the following lines to the end of the <code>firebase-messaging-sw.js</code> : </p><br><pre> <code class="hljs pgsql">//     messaging.setBackgroundMessageHandler(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(payload) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (typeof payload.data.time != <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { var <span class="hljs-type"><span class="hljs-type">time</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Date</span></span>(payload.data.time * <span class="hljs-number"><span class="hljs-number">1000</span></span>); var now = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Date</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-type"><span class="hljs-type">time</span></span> &lt; now) { //     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } var diff = Math.round((<span class="hljs-type"><span class="hljs-type">time</span></span>.getTime() - now.getTime()) / <span class="hljs-number"><span class="hljs-number">1000</span></span>); //      //    : "  14 ,  21:00" payload.data.body = <span class="hljs-string"><span class="hljs-string">'  '</span></span> + Math.round(diff / <span class="hljs-number"><span class="hljs-number">60</span></span>) + <span class="hljs-string"><span class="hljs-string">' ,  '</span></span> + <span class="hljs-type"><span class="hljs-type">time</span></span>.getHours() + <span class="hljs-string"><span class="hljs-string">':'</span></span> + (<span class="hljs-type"><span class="hljs-type">time</span></span>.getMinutes() &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? <span class="hljs-type"><span class="hljs-type">time</span></span>.getMinutes() : <span class="hljs-string"><span class="hljs-string">'0'</span></span> + <span class="hljs-type"><span class="hljs-type">time</span></span>.getMinutes()) ; } //  data       payload.data.data = payload.data; //   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.registration.showNotification(payload.data.title, payload.data); }); //      self.addEventListener(<span class="hljs-string"><span class="hljs-string">'notificationclick'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(event) { //       const target = event.notification.data.click_action || <span class="hljs-string"><span class="hljs-string">'/'</span></span>; event.notification.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(); //            //      ,     event.waitUntil(clients.matchAll({ <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'window'</span></span>, includeUncontrolled: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }).<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(clientList) { // clientList -  !? <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; clientList.length; i++) { var client = clientList[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.url == target &amp;&amp; <span class="hljs-string"><span class="hljs-string">'focus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> client) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.focus(); } } //    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> clients.openWindow(target); })); });</code> </pre> <br><p>  It is in this uncomplicated way that we have full control over the notification.  What is most interesting, we show the user a notification time in his time zone.  This is true for services that work around the world or regions with a wide variation of time zones as in Mother Russia. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Now let's talk about sad things.  Despite all the delights of technology, it has several disadvantages: </p><br><ol><li>  The main problem is, as always, <a href="http://caniuse.com/">support in browsers</a> .  Full support is in Chrome, Firefox and Opera latest versions.  IE, Safari, Opera Mini, UC Browser, Dolphin and other brethren remain behind.  But it works in mobile versions of Chrome, Firefox and Opera browsers. </li><li>  The open site and the working Service Worker do not guarantee the delivery of the message.  Although notifications can be reached with the browser closed. </li></ol><br><p>  The Firebase library hides many secrets and its research could provide answers to some questions, but this is beyond the scope of this article. </p><br><h2 id="poigratsya">  Play around </h2><br><h3 id="proekt-na-github-pages">  Project on GitHub Pages </h3><br><p>  Since HTTPS is needed to start the Service Worker, the simplest solution was to place the project on <a href="https://pages.github.com/">GitHub Pages</a> , which I did. </p><br><p>  The project is available at: <a href="https://github.com/peter-gribanov/serviceworker">https://github.com/peter-gribanov/serviceworker</a> <br>  Project sources: <a href="https://peter-gribanov.github.io/serviceworker/">https://peter-gribanov.github.io/serviceworker/</a> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0d4/968/112/0d49681123e74eb08f56d48386441073.gif"></div><br><p>  The project is a complete application for sending and receiving notifications.  In order to get the notification you need: </p><br><ul><li>  Go to the <a href="https://github.com/peter-gribanov/serviceworker">page</a> ; </li><li>  Click the <strong>Register</strong> button; </li><li>  The browser will request permission to display notifications; </li><li>  We confirm the permission; </li><li>  Your device‚Äôs ID and page will be printed on the browser page and console; </li><li>  The <strong>Delete Token</strong> button will appear to delete the existing token and re-register; </li><li>  A form will appear with the parameters of the notification that can be sent by clicking on the <strong>Send</strong> button; </li><li>  We change parameters at our discretion and receive different notifications. </li></ul><br><p>  You can send a notification through any tool to send HTTP requests.  <em>Can be used with CURL, I prefer the <a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop">Postman</a> app for Chrome.</em> </p><br><p>  The request is the same as described earlier: </p><br><pre> <code class="hljs pgsql">POST /fcm/send HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> Host: fcm.googleapis.com <span class="hljs-keyword"><span class="hljs-keyword">Authorization</span></span>: key=AAAAaGQ_q2M:APA91bGCEOduj8HM6gP24w2LEnesqM2zkL_qx2PJUSBjjeGSdJhCrDoJf_WbT7wpQZrynHlESAoZ1VHX9Nro6W_tqpJ3Aw-A292SVe_4Ho7tJQCQxSezDCoJsnqXjoaouMYIwr34vZTs Content-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: application/<span class="hljs-type"><span class="hljs-type">json</span></span> { "data": { "title": "", "body": "  21:00", "icon": "https://eralash.ru.rsz.io/sites/all/themes/eralash_v5/logo.png?width=192&amp;height=192", "click_action": "http://eralash.ru/" }, "to": "YOUR-TOKEN-ID" }</code> </pre> <br><p>  Where, </p><br><ul><li>  <code>YOUR-TOKEN-ID</code> is the device ID that you received on the <a href="https://peter-gribanov.github.io/serviceworker/">application</a> page. </li></ul><br><p>  That's all.  Receive notification and enjoy life. </p><br><h2 id="ssylki">  Links </h2><br><div class="spoiler">  <b class="spoiler_title">List of related links</b> <div class="spoiler_text"><ul><li>  Pro PUSH <br><ul><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D1%258F_push">PUSH Technology Wikipedia</a> </li><li>  <a href="https://developers.google.com/web/fundamentals/engage-and-retain/push-notifications/good-notification">Good notices according to Google</a> </li><li>  <a href="https://pushall.ru/blog/whatispushnotifications">Promotional article from PushAll</a> </li><li>  <a href="https://web-push-book.gauntface.com/">Web Push Book</a> </li><li>  <a href="https://serviceworke.rs/web-push.html">Web Push from ServiceWorker</a> </li><li>  <a href="http://caniuse.com/">Browser support</a> </li></ul></li><li>  SSL <br><ul><li>  <a href="https://www.chromium.org/blink/serviceworker/service-worker-faq">Https on localhost</a> </li><li>  <a href="https://www.ssllabs.com/">SSL certificate testing</a> </li><li>  <a href="https://letsencrypt.org/">Let's Encrypt</a> </li><li>  <a href="https://habrahabr.ru/post/318952/">The article on setting up Let's Encrypt</a> </li></ul></li><li>  Ui <br><ul><li>  <a href="https://developers.google.com/web/fundamentals/engage-and-retain/push-notifications/permissions-subscriptions">Subscribe to notifications</a> </li><li>  <a href="https://developers.google.com/web/updates/2015/03/push-notifications-on-the-open-web">Flagship status strategy for subscription</a> </li></ul></li><li>  Javascript api <br><ul><li>  <a href="https://www.youtube.com/watch%3Fv%3DBsCBCudx58g">Video instruction on how to configure Firebase</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Web/API/notification">Notification</a> </li><li>  <a href="https://developer.mozilla.org/ru/docs/Web/API/ServiceWorker">ServiceWorker</a> </li><li>  <a href="https://developer.mozilla.org/ru/docs/Web/API/Service_Worker_API/Using_Service_Workers">Using Service Worker</a> </li><li>  <a href="https://developer.mozilla.org/ru/docs/Web/API/Window/localStorage">localStorage</a> </li><li>  <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Web/Events/notificationclick">Focusing on an open window by clicking on a notification.</a> </li></ul></li><li>  Sending Notifications <br><ul><li>  <a href="https://firebase.google.com/docs/cloud-messaging/server">Manual</a> </li><li>  <a href="https://github.com/firebase/quickstart-js/tree/master/messaging">Project from the documentation</a> </li><li>  <a href="http-server-ref">Message options</a> </li><li>  <a href="http-server-ref">Error Code List</a> </li><li>  <a href="https://firebase.google.com/docs/cloud-messaging/concept-options">TTL</a> </li><li>  <a href="https://resizeappicon.com/sizes">Size icons</a> </li><li>  <a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop">Chrome Postman app</a> </li></ul></li><li>  Play around <br><ul><li>  Firebase quickstart <br><ul><li>  <a href="https://github.com/firebase/quickstart-js/tree/master/messaging">Original</a> </li><li>  <a href="https://github.com/peter-gribanov/firebase-quickstart-js">My fork</a> </li><li>  <a href="https://peter-gribanov.github.io/firebase-quickstart-js/messaging/">On GitHub Pages</a> </li></ul></li><li>  On GitHub Pages <br><ul><li>  <a href="https://peter-gribanov.github.io/serviceworker/">Project</a> </li><li>  <a href="https://github.com/peter-gribanov/serviceworker">Sources</a> </li></ul></li><li>  On my site <br><ul><li>  <a href="https://push.peter-gribanov.ru/">Project</a> </li><li>  <a href="https://github.com/peter-gribanov/article-push">Sources</a> </li></ul></li></ul></li></ul></div></div><br><h2 id="updated-at-2018-06-09">  Updated at 2018-06-09 </h2><br><p>  Found some "features" in the work of notifications. </p><br><h3 id="dublikaty-uvedomleniy">  Duplicate Notifications </h3><br><p>  I was asked several times with the question: <em>"How to fix duplicate notifications?"</em> </p><br><p>  This problem manifests itself if you open the site sending notifications simultaneously in several tabs.  In this case, the Service Worker sends a notification to both tabs and in both tabs the method of <a href="https://habr.com/ru/post/321924/">messaging.onMessage</a> works.  You can watch this problem on my <a href="https://peter-gribanov.github.io/serviceworker/">Demo project</a> . </p><br><p>  To solve this problem, you need to know in the <code>messaging.onMessage</code> method that the notification has already been shown in another tab.  <code>localStorage</code> can be used as a single repository, and you can identify notifications by hash sum of the notification or assign a unique id.  Only it is worth remembering that <code>localStorage</code> not rubber and the id of the already shown notifications should be cleared after a while. </p><br><p>  I can recommend for this purpose the <a href="https://github.com/pamelafox/lscache">pamelafox / lscache library</a> . <br>  If you have another method of solving the problem, write in the comments. </p><br><h3 id="kartinki-v-uvedomleniyah">  Pictures in notifications </h3><br><p>  Today a <a href="https://habr.com/users/ctterorist/" class="user_link">CTterorist</a> user addressed me, noticing that <a href="https://developer.mozilla.org/en-US/docs/Web/API/Notification/image">images (image) are</a> not displayed in notifications. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ak/n8/ts/akn8tsa2yurekggqnfjsk8dpu5g.png"></div><br><p>  Having tested a little bit, I managed to figure it out.  Although the <code>image</code> field is sent to Firebase, along with other notification options, the <code>image</code> field does not come back from Firebase.  The problem is solved very simply.  You can send a card in the <code>data</code> field, and in the handler for displaying a notification, draw a picture from <code>data</code> and insert it into place in the notification. </p><br><p>  That is, if you send a message in this form, then Firebase will lose the picture. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"notification"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bubble Nebula"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>: <span class="hljs-string"><span class="hljs-string">"It's found today at 21:00"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"icon"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://peter-gribanov.github.io/serviceworker/Bubble-Nebula.jpg"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"image"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://peter-gribanov.github.io/serviceworker/Bubble-Nebula_big.jpg"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"click_action"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://www.nasa.gov/feature/goddard/2016/hubble-sees-a-star-inflating-a-giant-bubble"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-string"><span class="hljs-string">"YOUR-TOKEN-ID"</span></span> }</code> </pre> <br><p>  But if to transfer the picture in <code>data</code> , then it will reach. </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bubble Nebula"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>: <span class="hljs-string"><span class="hljs-string">"It's found today at 21:00"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"icon"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://peter-gribanov.github.io/serviceworker/Bubble-Nebula.jpg"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"image"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://peter-gribanov.github.io/serviceworker/Bubble-Nebula_big.jpg"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"click_action"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://www.nasa.gov/feature/goddard/2016/hubble-sees-a-star-inflating-a-giant-bubble"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-string"><span class="hljs-string">"YOUR-TOKEN-ID"</span></span> }</code> </pre> <br><p>  Handlers for displaying notifications are the same as in the examples above. </p><br><pre> <code class="hljs lua">messaging.onMessage(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(payload)</span></span></span></span> { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Message received. '</span></span>, payload); //   ServiceWorker   navigator.serviceWorker.register(<span class="hljs-string"><span class="hljs-string">'firebase-messaging-sw.js'</span></span>); //           Notification.requestPermission(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result === <span class="hljs-string"><span class="hljs-string">'granted'</span></span>) { navigator.serviceWorker.ready.<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(registration)</span></span></span></span> { //       TTL  .. //   data payload.data.data = JSON.parse(JSON.stringify(payload.data)); registration.showNotification(payload.data.title, payload.data); }).catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'ServiceWorker registration failed'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">error</span></span>); }); } }); });</code> </pre> <br><p>  Similarly in the Service Worker ( <code>firebase-messaging-sw.js</code> ) </p><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">messaging</span></span>.setBackgroundMessageHandler(function(payload) { console.log('<span class="hljs-type"><span class="hljs-type">Handling</span></span> background message', payload); //       <span class="hljs-type"><span class="hljs-type">TTL</span></span>  .. //   <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> payload.</span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">.</span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">JSON</span></span></span><span class="hljs-class">.parse(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">JSON</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stringify</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payload</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">)); registration.showNotification(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payload</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">title</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payload</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">); });</span></span></code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/321924/">https://habr.com/ru/post/321924/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321914/index.html">The report on the results of "My Circle" for January 2017 and the most popular vacancies of the month</a></li>
<li><a href="../321916/index.html">Network Security Status 2016, Qrator Labs and Wallarm Detailed Report</a></li>
<li><a href="../321918/index.html">Data is better than oil, or the sixth set per program by big data</a></li>
<li><a href="../321920/index.html">Nutanix AOS 5.0 - Big Update</a></li>
<li><a href="../321922/index.html">How to make your games for free? T3 indie games development guide</a></li>
<li><a href="../321926/index.html">Security Week 07: RSA and Artificial Intelligence, Android Security, State Regulation IoT</a></li>
<li><a href="../321928/index.html">Console to the masses. Go to the bright side. Automate routine tasks</a></li>
<li><a href="../321932/index.html">The secret of fast programming: do not hesitate</a></li>
<li><a href="../321934/index.html">Pass pointers to member functions in the C API</a></li>
<li><a href="../321936/index.html">Octodon tries his hand at MotoModoStroenii</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>