<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>InnoDB cluster - it works, and it seems to be exactly as promised</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I do ATSkami. And somehow it happened that from the very first order they wanted fault tolerance from me. One of the key components of a modern PBX (l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>InnoDB cluster - it works, and it seems to be exactly as promised</h1><div class="post__text post__text-html js-mediator-article"><p>  I do ATSkami.  And somehow it happened that from the very first order they wanted fault tolerance from me.  One of the key components of a modern PBX (like any information system, probably) is the database, which stores both data on the current state of the system, as well as any configuration parameters.  Naturally, the fall of the database leads to the breakdown of the entire system.  It all started with MASTER-MASTER replication in MySQL (exclusively for switching speed), then there were experiments with MySQL over DRBD.  It all lived in the pacemaker / corosync infrastructure.  There went IP-addresses, gateways and other Labudi.  In due course it even began to work somehow more or less steadily.  But then I came across a couple of servers where DRBD couldn‚Äôt be done, I was disappointed with MASTER-MASTER for a long time (it always breaks at me, such replication), and without a fault-tolerant database the whole point of the solution was lost.  I came across the name of the InnoDB cluster and I decided: ‚Äúwas-was-was‚Äù.  What came out of it - look under the cut. </p><a name="habracut"></a><br><p>  I do everything on Debian Jessie.  In other systems, the differences will be, but not very significant. </p><br><p>  We will need: </p><br><ul><li>  <a href="https://dev.mysql.com/doc/mysql-apt-repo-quick-guide/en/">MySQL APT repository</a> </li><li>  <a href="https://dev.mysql.com/doc/refman/5.7/en/installing-mysql-shell-linux-quick.html">MySQL Shell</a> - for Debain users at the very bottom there is a link where you can download compiled binaries, for what reason they did not fall into the package just for Debain for me it remains a mystery </li><li>  patience </li><li>  patience </li><li>  and once again patience </li></ul><br><p>  Download (this can only be done manually, after registering on the Orakla website) and install the repository file, update our cache, install the MySQL Router (interesting beast, let's get acquainted below) and MySQL Client: </p><br><pre><code class="hljs sql">dpkg -i mysql-apt-config_0.8.6-1_all.deb apt-get <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> mysql-router apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> mysql-<span class="hljs-keyword"><span class="hljs-keyword">client</span></span></code> </pre> <br><p>  Unpack and decompose the MySQL Shell from the archive.  Moving on, set the server: </p><br><pre> <code class="hljs pgsql">apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install mysql-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span></code> </pre> <br><p>  Here we install ALL the proposed components (note that the third component in the list is not selected by default, but it will be needed).  And we stop the server started right away by the zealous installer: </p><br><pre> <code class="hljs sql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> mysql</code> </pre> <br><p>  Next, go to <br>  <code>/etc/mysql/mysql.conf.d/mysqld.cnf</code> and write something like this: </p><br><pre> <code class="hljs pgsql">[mysqld] pid-file = /var/run/mysqld/mysqld.pid socket = /var/run/mysqld/mysqld.sock datadir = /var/lib/mysql <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-error = /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/mysql/error.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> bind-address = <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> port = <span class="hljs-number"><span class="hljs-number">3300</span></span> symbolic-links=<span class="hljs-number"><span class="hljs-number">0</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">Replication</span></span> part server_id=<span class="hljs-number"><span class="hljs-number">3</span></span> gtid_mode=<span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> enforce_gtid_consistency=<span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> master_info_repository=<span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> relay_log_info_repository=<span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> binlog_checksum=<span class="hljs-keyword"><span class="hljs-keyword">NONE</span></span> log_slave_updates=<span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> log_bin=binlog binlog_format=<span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">Group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span> part transaction_write_set_extraction=XXHASH64 loose-group_replication_group_name="aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa" loose-group_replication_start_on_boot=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> loose-group_replication_local_address= "1.1.1.1:33061" loose-group_replication_group_seeds= "1.1.1.1:33061,1.1.1.2:33061,1.1.1.3:33061" loose-group_replication_bootstrap_group= <span class="hljs-keyword"><span class="hljs-keyword">off</span></span></code> </pre><br><p>  Here it is necessary to stop in more detail. </p><br><p>  The first option that deserves our attention is the <em>port. I</em> recommend setting its value to be different from 3306. Why - it will become clear below (we will hang something else at 3306) </p><br><p>  Next: <em>server_id</em> .  For each mysql server in the cluster, this value must be unique. </p><br><p>  The option that ate a couple of hours of my time is innocuous (seemingly) <code>group_replication_local_address</code> .  This option tells you on which address / port to listen to requests for replicas from the local database.  The algorithm by which MySQL determines whether the IP address specified in this field is local, I could not guess.  On a machine with 2 active interfaces and three IP addresses suspended on these interfaces, only one address arranged MySQL. </p><br><p>  And the last: <em>group_replication_group_seeds</em> - it lists the sockets to which you need to apply (in the specified order) with attempts to order replicas of actual data when connecting. </p><br><p>  For details, please refer to the official <a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication.html">GROUP REPLICATION</a> documentation page. </p><br><p>  So, deploying on the MySQL machine and configuring it in this way we move on.  Delete all contents of <code>/var/lib/mysql</code> I'm serious.  Got themselves together, went and removed.  If there is something that is dear to you as a memory - make a backup beforehand.  Can.  We start mysql: </p><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> mysql</code> </pre> <br><p>  In general, all preparatory manipulations are completed.  The described procedure will need to be repeated on all servers that are planned to be clustered. </p><br><p>  Now features for the first server.  First, we declare root: </p><br><pre> <code class="hljs pgsql">mysql &gt; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-string"><span class="hljs-string">'root'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span> identified <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">'ochen-strashniy-parol'</span></span>; &gt; <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-string"><span class="hljs-string">'root'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> *.* <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span>; &gt; flush <span class="hljs-keyword"><span class="hljs-keyword">privileges</span></span>; &gt; \q</code> </pre> <br><p>  I know, I know, I know ... Seeky.  But, believe me, the privilege set specified in the <a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-working-with-production-deployment.html">documentation</a> cannot be trusted (checked: does not work), and it won't be possible to connect from the local host either.  A more accurate option with the selection of an individual user the next time, as will be the "hour and time". </p><br><p>  Then we load the module X. Honestly, that is exactly what his name is: </p><br><pre> <code class="hljs pgsql">mysqlsh <span class="hljs-comment"><span class="hljs-comment">--classic --dba enableXProtocol</span></span></code> </pre> <br><p>  And at this moment fashionable pants are turning ... turning ... turning into elegant shorts.  I mean, MySQL is not quite SQL, and even the <a href="https://dev.mysql.com/doc/refman/5.7/en/document-store.html">Document Store</a> </p><br><p>  But this does not upset us in any way, so we move on: </p><br><pre> <code class="hljs">mysqlsh</code> </pre> <br><p>  Now we can communicate with MySQL in javascript.  First, let's connect to our server: </p><br><pre> <code class="hljs swift">\<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> root@<span class="hljs-number"><span class="hljs-number">1.1</span></span>.<span class="hljs-number"><span class="hljs-number">1.1</span></span>:<span class="hljs-number"><span class="hljs-number">3300</span></span></code> </pre> <br><p>  We will enter the password and check whether everything is in order with our server, whether its configuration is suitable for clustering: </p><br><pre> <code class="hljs 1c">dba.checkInstanceConfiguration('root@1.1.1.1:<span class="hljs-number"><span class="hljs-number">3300</span></span>')</code> </pre> <br><p>  If everything is done according to the instructions, then there should be no questions.  If there are questions - correct, <a href="https://dev.mysql.com/doc/refman/5.7/en/">dock</a> to help you.  In principle, there is even an opportunity to generate the configuration yourself: </p><br><pre> <code class="hljs pgsql">dba.configureLocalInstance(<span class="hljs-string"><span class="hljs-string">'localhost:3300'</span></span>, {<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>:<span class="hljs-string"><span class="hljs-string">'somePwd'</span></span>, mycnfPath:<span class="hljs-string"><span class="hljs-string">'some path'</span></span>})</code> </pre> <br><p>  However, this option did not work right away, it took me to finish config file to the state specified in the beginning of the note.  Naturally, after each file rewinding the config, the server must be restarted.  For example, using <code>systemctl restart mysq</code> .  Well, or whatever you like ... <br>  Create a cluster (I assume that you are still in mysqlsh and the session did not terminate): </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cl = dba.createCluster(<span class="hljs-string"><span class="hljs-string">'moyCluster'</span></span>)</code> </pre> <br><p>  Well, add to it the newly configured server: </p><br><pre> <code class="hljs 1c">cl.addInstance('root@1.1.1.1:<span class="hljs-number"><span class="hljs-number">3300</span></span>')</code> </pre> <br><p>  From now on, I recommend to keep </p><br><pre> <code class="hljs vbscript">tail -f /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/mysql/<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p>  and when any errors appear there glances.  The conclusion from mysqlsh is not very informative, but the log has everything you need.  In the <a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-working-with-production-deployment.html">dock,</a> they say that you can increase the level of debug output, but I have not tried. </p><br><p>  If no errors were observed up to this point, then we have a cluster of one machine. <br>  Last manipulation on this server: </p><br><pre> <code class="hljs swift">mysqldump --all-databases --triggers --routines --events &gt; <span class="hljs-built_in"><span class="hljs-built_in">dump</span></span>.sql</code> </pre> <br><p>  Now let's do the rest.  To do this, on all the machines we repeat the manipulations described from the beginning of the article to </p><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> mysql</code> </pre> <br><p>  Do not forget to correct the <code>server_id</code> and <code>group_replication_local_address</code> .  Thereafter: </p><br><pre> <code class="hljs pgsql">mysql &gt; <span class="hljs-keyword"><span class="hljs-keyword">reset</span></span> master; mysql &lt; dump.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span></code> </pre> <br><p>  Yes, yes, we upload a dump from a server running in a cluster into the machine.  Now <em>from the local machine</em> (the one on which the mysql-server instance is going to be connected to the cluster) we do: </p><br><pre> <code class="hljs pgsql">mysql &gt; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GLOBAL</span></span> group_replication_allow_local_disjoint_gtids_join=<span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; mysqlsh &gt; dba.checkInstanceConfiguration(<span class="hljs-string"><span class="hljs-string">'root@1.1.1.2:3300'</span></span>) &gt; \c root@<span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3300</span></span> &gt; var cl = getCluster(<span class="hljs-string"><span class="hljs-string">'moyCluster'</span></span>) &gt; cl.addInstance(<span class="hljs-string"><span class="hljs-string">'root@1.1.1.2:3300'</span></span>,{ipWhitelist: <span class="hljs-string"><span class="hljs-string">'1.1.1.0/24, 127.0.0.1/8'</span></span>})</code> </pre> <br><p>  If we didn‚Äôt confuse anything, then at this moment we already have two cars in the cluster.  Similarly, add the third. </p><br><p>  At the moment we have a cluster that looks after itself, selects the master and replicates to the slaves.  Each server can be accessed on its port 3300 and, if you contact the master, you can read and write, and if you go to the slave, you can only read.  You can find out if the master is a server or a slave can be made from the output of cluster.status ().  But this is not very convenient.  I would like to always go to the same place, to the same ip / port and not to depend on the internal state of the cluster.  For this we use the <a href="https://dev.mysql.com/doc/mysql-router/2.1/en/">MySQL Router.</a> Right in the dock there is an example of its initial configuration, which does almost everything we need.  Change it a bit: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">mysqlrouter</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--bootstrap</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3300</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--user</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mysqlrouter</span></span></code> </pre> <br><p>  Now we go to <code>/etc/mysqlrouter/mysqlrouter.conf</code> and fix the ports there somehow: </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">routing:moyCluster_default_rw</span></span>] ... bind_port=<span class="hljs-number"><span class="hljs-number">3306</span></span> ... [routing:moyCluster_default_ro] ... bind_port=<span class="hljs-number"><span class="hljs-number">3307</span></span> ...</code> </pre> <br><p>  After that you can do </p><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> mysqlrouter</code> </pre> <br><p>  And now your port 3306 is answered by the usual mysql with read / write support, regardless of which of the cluster machines is now master and which is slave.  On 3307 - always read-only.  The number of instances of mysqlrouter is in no way limited, you can run your own instance on each client machine and hang it on the internal interface 127.0.0.1.73306.  mysqlrouter itself keeps track of changes in the cluster (both adding and disappearing nodes in it) and updates the routing.  This happens every five minutes (if you believe the logs).  If an appeal occurs in this interval that cannot be processed (the node fell out or was deliberately removed from the cluster), then the router refuses to execute the transaction and rereads the state of the cluster in an extraordinary order. </p><br><p>  By the way, if for some reason the node has fallen off from the cluster, it can be returned to the family by the command </p><br><pre> <code class="hljs scala">mysqlsh &gt; \c root@&lt;ip:port-_&gt; &gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cl = dba.getCluster(<span class="hljs-symbol"><span class="hljs-symbol">'moyCluste</span></span>r') &gt; cl.rejoinInstance(<span class="hljs-symbol"><span class="hljs-symbol">'root</span></span><span class="hljs-meta"><span class="hljs-meta">@ip</span></span>:port-_')</code> </pre> <br><p>  Thank you for reading.  Hope this will be useful.  If you notice inaccuracies in the text - write in the comments, wrote on the hot, but from memory, so that could make a mess. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/332518/">https://habr.com/ru/post/332518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332502/index.html">Linux log files in order</a></li>
<li><a href="../332504/index.html">Who owns the data generated by devices from the Internet of things?</a></li>
<li><a href="../332506/index.html">How to confuse the analyst. Part Three Verbs and numerals</a></li>
<li><a href="../332508/index.html">Automata programming. Part 2. State and transition diagrams</a></li>
<li><a href="../332516/index.html">Generalized copying of connected object graphs in C # and nuances of their serialization</a></li>
<li><a href="../332520/index.html">Moneyball on the exchange: how new technologies change not only trading, but also the work of hedge funds</a></li>
<li><a href="../332522/index.html">Amazon, Apple, and Microsoft Shares Equal to Due to Technical Failure</a></li>
<li><a href="../332524/index.html">On the role of interfaces in the context of existentialism</a></li>
<li><a href="../332526/index.html">You are a big brother, or try yourself as an all-seeing eye.</a></li>
<li><a href="../332528/index.html">AWS EC2 Apache CloudStack-style public cloud using KVM hypervisor and NFS storage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>