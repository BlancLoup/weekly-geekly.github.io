<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use backbone.js under node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, dear readers of Habrahabr. I want to share with you my experience of using backbone.js under node.js. Earlier, I actively worked with backb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use backbone.js under node.js</h1><div class="post__text post__text-html js-mediator-article">  Greetings, dear readers of Habrahabr.  I want to share with you my experience of using <a href="http://backbonejs.org/">backbone.js</a> under <a href="http://nodejs.org/">node.js.</a>  Earlier, I actively worked with backbone.js on the client, and this library turned out to be extremely convenient for structuring code. <br><br>  A service without working with any database is not a service.  In my case, <a href="http://mongodb.org/">mongodb</a> was chosen as the DBMS.  I looked at the existing ORM solutions for mongodb, and it seemed to me more convenient to use familiar tools, the more they will be used on the client, so it was decided to try using the Backbone.Model class for the models and check how all this can be customized for mongodb. <br><br><a name="habracut"></a><br>  So, the task.  There is a certain service using the mongodb base.  It is necessary to be able to create new objects and save them to the database, to get the necessary objects from a certain collection.  After changing the object, it should be possible to save and delete it from the database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Backbone.js provides us with 2 basic objects - a model and a collection.  We will write a layer from which we will further inherit all of our future classes.  At once I will make a reservation that we will set aside the code for connecting to the database and receiving the collection, and we will assume that everything is fine with it.  Also neglect error handling.  Almost everywhere I use Deferred.  Therefore, who do not know what kind of beast, you can read about him <a href="http://habrahabr.ru/post/113073/">here</a> in detail.  Requests to mongodb are made through <a href="https://github.com/mongodb/node-mongodb-native">this</a> node.js module - which is not at all important.  The code is simplified in some places, so if you use it in your project, something may not be entirely true. <br><br><h5>  Basic model </h5><br>  We need to somehow get a single model from the base, I think this method fits well with the static part of the class: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BaseModel = Backbone.Model.extend({ <span class="hljs-attr"><span class="hljs-attr">idAttribute</span></span>: <span class="hljs-string"><span class="hljs-string">"_id"</span></span>, },{ <span class="hljs-attr"><span class="hljs-attr">db_collection</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-comment"><span class="hljs-comment">//     fetchFromDb: function(filter, options){ var deferred = new Deferred(); if (typeof options === 'undefined') options = {}; db.getCollection(this.db_collection, function(err, collection){ collection.find(filter).toArray(function(err, items) { ret = new this(_.defaults(items[0], options)); } deferred.resolve(ret); }.bind(this)); ); return deferred.promise; } });</span></span></code> </pre> <br>  The code also shows that we have redefined the base field of the Backbone.Model class, which defines the name of the key field in the list of object fields, and in the static db_collection field of the class we defined the collection to which the object will belong. <br><br>  After that, if we, for example, define a user class: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> User = BaseModel.extend({},{ <span class="hljs-attr"><span class="hljs-attr">db_collection</span></span>:<span class="hljs-string"><span class="hljs-string">"users"</span></span>});</code> </pre><br>  we can get a specific user, like this: <br><pre> <code class="javascript hljs">User.fetchFromDb({<span class="hljs-attr"><span class="hljs-attr">_id</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>});</code> </pre><br>  Now you need to learn how to save the created model.  To do this, backbone.js provides a special sync method, the signature of which looks like this: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method, model, options</span></span></span><span class="hljs-function">)</span></span></code> </pre><br>  Where: <br><ul><li>  method - the save method, depending on the situation may be returned: <br><ul><li>  create - create a new model in the database; </li><li>  update - save the data of the existing model in the database; </li><li>  read - update the existing model from the database; </li><li>  delete - delete an object from the database. </li></ul><br></li><li>  model is our object to save; </li><li>  options is what we passed with additional parameters at the moment of saving. </li></ul><br><pre> <code class="javascript hljs">sync: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method, model, options</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fltr = {}; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deferred = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Deferred(); db.getCollection(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.constructor.db_collection, collectionReady.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> deferred.promise; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">collectionReady</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, collection</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">done</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, result</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (options.success) options.success(result); <span class="hljs-comment"><span class="hljs-comment">//    backbone.js     deferred.resolve({context: this, result: true}); } fltr[this.idAttribute] = this.get(this.idAttribute); switch (method){ case "update": collection.update( fltr, this.toJSON(), {multi:false, upsert: true}, done.bind(this) ); break; case "create": collection.insert( this.toJSON(), {safe:true}, done.bind(this) ); break; case "read": collection.find(fltr).toArray(function(err, items) { done.call(this, false, items[0]); } }.bind(this)); break; case "delete": collection.findAndModify(fltr, [], {}, {remove:true}, function(err, items) { deferred.resolve(); }); } } },</span></span></code> </pre><br>  Here, too, nothing complicated.  For each specific method of changing the model, we hang handlers who can do this action in the database itself. <br><br>  Now, after creating the user object, for example, like this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User({<span class="hljs-attr"><span class="hljs-attr">name</span></span>:<span class="hljs-string"><span class="hljs-string">"Danil"</span></span>});</code> </pre><br>  we can safely keep it: <br><pre> <code class="javascript hljs">user.save()</code> </pre><br>  and also delete after saving: <br><pre> <code class="javascript hljs">user.delete()</code> </pre><br><h5>  Basic collection </h5><br>  Working with single models is quite boring, so we implement collections, however, the more basic class in backbone.js is for that.  By analogy with the model, we will redefine the base class of the collection.  All our future collections will be inherited from it.  First, let's write the extraction of the list of ‚Äúraw data‚Äù from the database: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BaseCollection = Backbone.Collection.extend({ },{ <span class="hljs-attr"><span class="hljs-attr">db_collection</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">__fetchCollection</span></span>:<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">filter, collection</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deferred = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Deferred(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">collectionReady</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, collection</span></span></span><span class="hljs-function">)</span></span>{ collection.find(filter).toArray(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, items</span></span></span><span class="hljs-function">) </span></span>{ deferred.resolve(items); }.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } db.getCollection(collection_db, collectionReady, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> deferred.promise; } });</code> </pre><br>  Here we create a static class method that will allow us to retrieve the list of ‚Äúraw data‚Äù from the database, and also add a static db_collection field, which the heirs will override, indicating which collection in mongodb this class belongs to. <br><br>  It remains to add the initialization of the necessary models, add another static method to our base collection class: <br><pre> <code class="javascript hljs">fetchFromDb:<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">filter</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deferred = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Deferred(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__fetchCollection(filter, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.db_collection).then( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">models</span></span></span><span class="hljs-function">)</span></span>{ deferred.resolve(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(models)); }.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> deferred.promise; },</code> </pre><br>  Here we just get the ‚Äúraw data‚Äù and initialize the models associated with this collection with data from the database.  Of course, the very name of the collection in mongodb we can get from the associated model, but we will consider it a simplification. <br><br>  Now, having defined a collection of users, we can make requests to the database, receiving objects with users: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Users = BaseCollection.extend({<span class="hljs-attr"><span class="hljs-attr">model</span></span>:User}, {<span class="hljs-attr"><span class="hljs-attr">db_collection</span></span>: <span class="hljs-string"><span class="hljs-string">"users"</span></span>}); Users.fetchFromDb({<span class="hljs-attr"><span class="hljs-attr">name</span></span>:<span class="hljs-string"><span class="hljs-string">"Danil"</span></span>}).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">users</span></span></span><span class="hljs-function">)</span></span>{ _.each(users,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(user.id)}); });</code> </pre><br><br>  As a result, we got all the necessary minimum for working with mongodb and we can continue to use other opportunities that backbone.js gives us. </div><p>Source: <a href="https://habr.com/ru/post/158569/">https://habr.com/ru/post/158569/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158555/index.html">Light - an advanced lamp with Linux on board</a></li>
<li><a href="../158559/index.html">How do you have forbidden content on your site and not get into the registry of locks?</a></li>
<li><a href="../158561/index.html">WPF: Custom Window</a></li>
<li><a href="../158565/index.html">Opportunity - forgotten record</a></li>
<li><a href="../158567/index.html">We sign the installer Developer ID certificate</a></li>
<li><a href="../158573/index.html">[Translation] Microcontrollers out of date?</a></li>
<li><a href="../158575/index.html">Comprehensive automation of Firebird / InterBase database backup on Windows servers</a></li>
<li><a href="../158577/index.html">jQuery snippets and plugins for iPad</a></li>
<li><a href="../158579/index.html">Less and less and less ... Micro servers - a solution for macro tasks</a></li>
<li><a href="../158583/index.html">Vuzix Smart Glasses M100, a competitor to Google Glass, will go on sale in early 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>