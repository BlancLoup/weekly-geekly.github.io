<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Remote control of the heating system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Internet of Things (IoT, Internet of Things) is a promising area, as analysts say. One of the main trends of IoT is home automation or, as markete...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Remote control of the heating system</h1><div class="post__text post__text-html js-mediator-article">  The Internet of Things (IoT, Internet of Things) is a promising area, as analysts say.  One of the main trends of IoT is home automation or, as marketers like to say, the creation of a ‚Äúsmart home‚Äù. <br><br>  Let's leave the verbal exercises alone and consider a specific project. <br><a name="habracut"></a><br><h3>  Formulation of the problem </h3><br>  I live in my own home near Moscow.  In addition to the obvious advantages of this accommodation option, there are some nuances.  If in an apartment building the majority of utility tasks are taken over by the management company, then in their own home they have to be solved independently. <br><br>  One of these tasks for me was the need for remote monitoring and control of the heating system.  It is true that in central Russia heating in the winter is not a matter of comfort, but of survival.  According to the repeatedly confirmed empirical law, all troubles happen at the most inappropriate time.  For more than a decade of experience in my own home, I also became convinced of the validity of this law. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But if, for example, the failure of the water supply pump in a 30-degree frost can somehow be survived, then the failure of the heating boiler turns into a catastrophe.  In such a frost, a normally warmed house is wiped out in less than a day. <br><br>  I often have to leave home for a long time, including in winter.  Therefore, the possibility of remote monitoring of the state of the heating system and its management has become an urgent task for me. <br><br>  In my house, the heating system has two boilers, solar (alas, there is no gas and is not foreseen) and electric.  This choice is due not only to issues of reservation, but also to optimize the cost of heating.  At night, with the exception of severe frosts, the electric boiler works, as the house has a double tariff meter.  The power of this boiler is enough for a comfortable night temperature (18-19 degrees).  In the daytime, the solar boiler enters the work, raising the temperature to 22-23 degrees.  In this mode, the heating system has been operating for several years and allows us to conclude that this option is economical. <br><br>  It is clear that the daily manual switching of the heating system operation modes is not the most reasonable choice, so the decision was made to automate this process and, at the same time, provide for the possibility of remote control. <br><br><h3>  Technical task </h3><br>  Following the developer‚Äôs habit, the first thing I did was to systematize the requirements for the control system being created and put something like a technical task for myself. <br><br>  Here is a brief list of the basic requirements for the projected solution: <br><br><ul><li>  control the temperature in the house and outside </li><li>  provide three modes of choice of heating boilers (more details below) </li><li>  provide remote monitoring of the state of the system and its management </li></ul><br>  Initially, the list had a few more items, but then they were excluded for various reasons.  For example, I planned to equip the system with a screen with an indication of the current parameters and the ability to control through the touchscreen.  But it seemed to me not necessary duplication of remote control via the Internet.  Of course, you can come up with quite life situations when local indication and control are necessary.  I do not argue, but do not forget that this opportunity would require additional complication and increase in the cost of the system. <br><br>  The algorithm of control of the heating system contains the apocalypse scenario associated with a complete power outage.  It is clear, in this case it is not necessary to talk about remote control.  But those who are in the house can go into emergency heating mode with a few simple manipulations.  It is enough to switch one external four-pole toggle switch and start the backup gasoline electric generator.  This will ensure the operation of the solar boiler offline.  In practice, this has already happened a couple of times, when the freezing rain has led to a massive break in the power lines. <br><br>  Modern heating boilers, as a rule, have remote control units that are connected by a conventional twin wire.  In order not to get into the factory control schemes, it was decided to switch these wires themselves.  A wire break caused by a conventional electromechanical relay causes the boiler to stop working. <br><br><h3>  IoT security method </h3><br>  Having read horror stories about the consequences of hacking smart homes, I decided to insure and minimize the possibility of external hacking.  Someone will say, they say, who needs to break open your smart home.  I agree, the probability is minimal, but watching regular attempts at hacking my web servers, I decided to act according to the principle: it is better to sleep than not to finish.  Joke. <br><br>  For this, I abandoned the common paradigm, when the central server is the initiator of managing distributed smart sensors (devices).  It was decided to use the classic client-server scheme, where the client is a smart sensor. <br>  The choice of such an architecture is not always possible in IoT, but in this case it is quite acceptable, since the heating systems have a sufficiently large inertia.  Even the presence of the possibility of instantaneous and arbitrary change of settings in the system, for example, the value of the temperature in the room, does not lead to an instantaneous achievement of the specified parameters. <br><br>  The transfer of initiative in the exchange of data to the side of the smart sensor makes it possible to almost completely eliminate its hacking by unauthorized persons.  After all, the sensor only receives a response from the server to its request.  Theoretically, you can intercept such a request and replace the answer, but this threat is minimized, for example, with the https protocol.  If there is no desire to raise this protocol in the sensor, then there is an option with the calculation of checksums taking into account the parameters, a priori unknown to the attacker.  But this cryptographic question is beyond the scope of this topic. <br><br>  If the request was not received a response from the server, the smart sensor, after waiting for a certain time-out, continues to work in the previously set mode. <br><br>  As a server, it was decided to create a small website with a MySQL database, which was deployed on a third-level domain of one of my sites.  The site was written using an adaptive layout that allows you to comfortably work with your smartphone. <br>  For the exchange of information with the server was selected a five-minute period. <br><br>  In part, this choice is due to one nuance of the electric boiler.  To exclude boiling of water in the heater flask from residual heat of heating elements, the so-called boiler run-down is used.  In other words, after turning off the heating element, the circular pump continues to operate for a while.  In my boiler, the default run is 4 minutes, although it can be increased for a longer time.  Therefore, the five-minute interval of exchange is well within the logic of the heating system.  Yes, and more frequent data exchange did not give any benefit, only led to an increase in the number of records in the server database. <br><br><h3>  Work algorithm </h3><br>  The operation of the smart sensor, called the weather module, does not contain anything unusual.  In the cycle temperature and humidity sensors are polled.  It takes about 4.5 minutes.  Then a GET request to the server is generated and the received response is processed.  As a result, the period (main cycle) is obtained with a duration of about 5 minutes.  It does not require perfect accuracy, in practice, the period was less than a few seconds, which leads to a gradual shift.  With an ideal five-minute period per day, 288 samples would be transmitted, in reality, 289‚Äì290 of them appear.  This does not affect the system at all. <br><br>  The main sketch of the program with detailed comments is given in the listing.  Due to the vast amount of code I did not publish the implementation of the used subroutines.  The listing left diagnostic messages for output to the terminal. <br><br><div class="spoiler">  <b class="spoiler_title">The main sketch of the program</b> <div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/* * Sketch Meteo Control Mega2560 * ver. 13.0 *     - ,  - .   21 ,  - 0,5  *     http 1.0 */</span></span> // libs #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;Wire.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "DHT.h" // wired connections //     I2C,    <span class="hljs-number"><span class="hljs-number">104</span></span> #define DS3231_I2C_ADDRESS <span class="hljs-number"><span class="hljs-number">104</span></span> // define #define HYSTERESIS <span class="hljs-number"><span class="hljs-number">0.5</span></span> //   ,  #define LONG_CYCLE <span class="hljs-number"><span class="hljs-number">9</span></span> //   , <span class="hljs-number"><span class="hljs-number">9</span></span> -  <span class="hljs-number"><span class="hljs-number">5</span></span>        #define SHORT_CYCLE <span class="hljs-number"><span class="hljs-number">13</span></span> //    , <span class="hljs-number"><span class="hljs-number">13</span></span> .            <span class="hljs-number"><span class="hljs-number">30</span></span>  #define DAY_BEGIN <span class="hljs-number"><span class="hljs-number">6</span></span> //     #define DAY_END <span class="hljs-number"><span class="hljs-number">22</span></span> //     #define MIN_INTERVAL <span class="hljs-number"><span class="hljs-number">3000</span></span> //     <span class="hljs-number"><span class="hljs-number">3</span></span>  #define PIN_DHT_IN <span class="hljs-number"><span class="hljs-number">23</span></span> //       AM2301 #define PIN_DHT_OUT <span class="hljs-number"><span class="hljs-number">22</span></span> //       AM2301 #define DHTTYPE DHT21 DHT dhtin(PIN_DHT_IN, DHTTYPE); DHT dhtout(PIN_DHT_OUT, DHTTYPE); #define RELAY_E <span class="hljs-number"><span class="hljs-number">25</span></span> //     #define RELAY_D <span class="hljs-number"><span class="hljs-number">24</span></span> //      #define LED_R <span class="hljs-number"><span class="hljs-number">27</span></span> // LED RGB #define LED_G <span class="hljs-number"><span class="hljs-number">29</span></span> // LED RGB #define LED_B <span class="hljs-number"><span class="hljs-number">31</span></span> // LED RGB #define LED <span class="hljs-number"><span class="hljs-number">13</span></span> //   #define LEAP_YEAR(_year) ((_year%<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-number"><span class="hljs-number">0</span></span>) //     // vars uint32_t workTime; //        <span class="hljs-type"><span class="hljs-type">float</span></span> hIn; //   <span class="hljs-type"><span class="hljs-type">float</span></span> tIn; //   <span class="hljs-type"><span class="hljs-type">float</span></span> hOut; //   <span class="hljs-type"><span class="hljs-type">float</span></span> tOut; //   <span class="hljs-type"><span class="hljs-type">float</span></span> tModule; //    <span class="hljs-type"><span class="hljs-type">float</span></span> tInSet; //     <span class="hljs-type"><span class="hljs-type">float</span></span> tOutSet; //    .     .     byte seconds, minutes, hours, day, <span class="hljs-type"><span class="hljs-type">date</span></span>, month, year; byte del; //   ,     <span class="hljs-type"><span class="hljs-type">char</span></span> weekDay[<span class="hljs-number"><span class="hljs-number">4</span></span>]; byte tMSB, tLSB; <span class="hljs-type"><span class="hljs-type">float</span></span> temp3231; static byte monthDays[] = {<span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>}; uint32_t unixSeconds; //   UNIX uint16_t timeWorkElectro; //   ()       uint16_t timeWorkDiesel; //   ()        uint32_t unixSecondsStartCycle; //   UNIX        <span class="hljs-type"><span class="hljs-type">int</span></span> modeWork; //   , <span class="hljs-number"><span class="hljs-number">0</span></span> - auto, <span class="hljs-number"><span class="hljs-number">1</span></span> - -, <span class="hljs-number"><span class="hljs-number">2</span></span> - -, <span class="hljs-number"><span class="hljs-number">3</span></span> - -, <span class="hljs-number"><span class="hljs-number">4</span></span> - -, <span class="hljs-number"><span class="hljs-number">5</span></span> - - byte typeBoiler; //   , <span class="hljs-number"><span class="hljs-number">0</span></span> -   , <span class="hljs-number"><span class="hljs-number">1</span></span> - , <span class="hljs-number"><span class="hljs-number">2</span></span> -  <span class="hljs-type"><span class="hljs-type">char</span></span> statusBoiler; //      <span class="hljs-type"><span class="hljs-type">char</span></span> unit = <span class="hljs-string"><span class="hljs-string">'1'</span></span>; // id  <span class="hljs-type"><span class="hljs-type">char</span></span> mode; //       String message; //      <span class="hljs-type"><span class="hljs-type">char</span></span> ans; //    String answerServer; //     String tInSer; //    =    String tOutSer; //    =    String timeSer; //    =   <span class="hljs-type"><span class="hljs-type">char</span></span> datetime[<span class="hljs-number"><span class="hljs-number">15</span></span>]; //      <span class="hljs-type"><span class="hljs-type">void</span></span> setup() { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(<span class="hljs-number"><span class="hljs-number">115200</span></span>); //   COM    <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Start setup()"); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Meteo Module. Ver.13.0 Unit Number: " + String(unit)); pinMode(LED, OUTPUT); //LED flash pinMode(LED_R, OUTPUT); //LED_R pinMode(LED_G, OUTPUT); //LED_G pinMode(LED_B, OUTPUT); //LED_B //    Wire.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(); //<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> control register <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> output square wave <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pin <span class="hljs-number"><span class="hljs-number">3</span></span> at <span class="hljs-number"><span class="hljs-number">1</span></span>Hz Wire.beginTransmission(DS3231_I2C_ADDRESS); // <span class="hljs-number"><span class="hljs-number">104</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> DS3231 device address Wire.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(<span class="hljs-number"><span class="hljs-number">0x0E</span></span>); Wire.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(B00000000); Wire.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(B10001000); Wire.endTransmission(); //      tInSet = <span class="hljs-number"><span class="hljs-number">21</span></span>; tOutSet = <span class="hljs-number"><span class="hljs-number">-15</span></span>; //    pinMode(PIN_DHT_OUT, INPUT_PULLUP); dhtout.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(); //    pinMode(PIN_DHT_IN, INPUT_PULLUP); dhtin.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(); //       pinMode(RELAY_E, OUTPUT); pinMode(RELAY_D, OUTPUT); modeWork = <span class="hljs-number"><span class="hljs-number">0</span></span>; //   //     relayElectroSwitchOff(); relayDieselSwitchOff(); timeWorkElectro = <span class="hljs-number"><span class="hljs-number">0</span></span>; //     timeWorkDiesel = <span class="hljs-number"><span class="hljs-number">0</span></span>; unixSecondsStartCycle = <span class="hljs-number"><span class="hljs-number">0</span></span>; //      typeBoiler = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("All Boilers Off"); digitalWrite(LED_G, HIGH); //    RGB-.  ,   // <span class="hljs-type"><span class="hljs-type">serial</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> esp8266 Serial1.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(<span class="hljs-number"><span class="hljs-number">115200</span></span>); //    ESP8266 Serial1.setTimeout(<span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!Serial1); String startcommand = "AT+CWMODE=1"; //  ESP8266    Serial1.println(startcommand); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println(startcommand); delay(<span class="hljs-number"><span class="hljs-number">2000</span></span>); del = <span class="hljs-number"><span class="hljs-number">0</span></span>; //     } <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>() { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("Start loop(). "); //     get3231Date(); //    unixSeconds = timeUnix(seconds, minutes, hours, <span class="hljs-type"><span class="hljs-type">date</span></span>, month, year); // UNIX-   <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("Current datetime: "); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(weekDay); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(", "); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-type"><span class="hljs-type">date</span></span> &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("0"); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(<span class="hljs-type"><span class="hljs-type">date</span></span>, <span class="hljs-type"><span class="hljs-type">DEC</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("."); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (month &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("0"); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(month, <span class="hljs-type"><span class="hljs-type">DEC</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("."); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(year, <span class="hljs-type"><span class="hljs-type">DEC</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(" - "); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hours &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("0"); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(hours, <span class="hljs-type"><span class="hljs-type">DEC</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(":"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (minutes &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("0"); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(minutes, <span class="hljs-type"><span class="hljs-type">DEC</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print(":"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (seconds &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("0"); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println(seconds, <span class="hljs-type"><span class="hljs-type">DEC</span></span>); //     <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Getting temperature and himidity"); getSensors(); //       collectServerData(); //       //         <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Send data to server"); connectServer(); //        controlServer(); //         switch(modeWork){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: //   <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Current Mode: Auto"); autoMode(); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: //   <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Manual Mode"); manualMode1(); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: //   <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Manual Mode"); manualMode2(); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: //   <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Manual Mode"); manualMode3(); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: //   <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Semi Auto Mode Electro"); semiAutoMode4(); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: //   <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Semi Auto Mode Diesel"); semiAutoMode5(); break; } del = LONG_CYCLE; //     <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (del &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.print("Start short cycle #"); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println(del); //     mDelay(SHORT_CYCLE); //     <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println("Getting temperature and himidity"); getSensors(); del<span class="hljs-comment"><span class="hljs-comment">--; //      } }</span></span></code> </pre> <br></div></div><br>  As I mentioned above, there are three modes of operation in the weather module: <br><br><ul><li>  auto </li><li>  semi-automatic </li><li>  manual </li></ul><br>  In automatic mode, the weather module selects which boiler to turn on at one time or another according to the built-in real-time clock.  At the time of a reduced tariff for electricity, an electric boiler is started. <br><br>  In the original version of the system, it was possible to operate the electric boiler in the same daytime period in order to save diesel fuel.  In this variant, the weather module tracked the operation time of the electric boiler during the day.  If within an hour it was not possible to reach the set temperature in the house, then the electric boiler was turned off and after a pause to run out, the solar boiler was turned on. <br><br>  According to the experience of the first winter, this option was removed.  The reason was the lack of power of the electric boiler, which could not in relatively severe frosts (below -10 degrees) ensure the achievement of a given comfortable temperature.  Therefore, it was decided during the day to launch the solar boiler unambiguously in automatic mode. <br><br>  Semi-automatic mode implies a hard choice of one or another boiler with maintaining automatic adjustment of its operation according to the temperature sensors of the weather module.  This mode has proven useful in several cases.  Firstly, when one boiler fails, the operation of another boiler is forcibly set, regardless of the time of day.  Secondly, in weak frosts and thaws, the electric boiler can be turned on around the clock, or, conversely, only solar boilers can be started at very cold frosts. <br><br>  I practically do not use manual mode.  It implies not only the selection of a specific boiler for operation, but also the transfer of control to the staff remote unit.  In other words, the boiler will be controlled by the specified temperature parameters on this unit.  The weather module in this mode continues to operate only as a station for monitoring temperature and humidity. <br><br>  In its request to the server, the weather module transmits a data packet that includes information about the current state of the boilers (which boiler is selected, running or not), the current local time of the weather module, the duration of boiler operation in the preceding five-minute period, the current temperature and humidity inside and outside the house.  Also, the request includes the identifier of the weather module.  In my case, this is unnecessary, but the habit of designing for scaling has made itself felt. <br><br>  After sending the request, the weather module waits for the server to respond for 20 seconds.  The resulting response is parsed using regular expressions.  There are four parameters in the server response: <br><br><ul><li>  inside temperature threshold </li><li>  threshold temperature outside the house </li><li>  set mode </li><li>  initial setup time for a real-time clock module </li></ul><br>  In the current version, the outside temperature threshold is not used.  This possibility was provided for the implementation of the choice of heating patterns, depending on the temperature "overboard".  Probably, this function sometime I implement. <br><br>  The last parameter is required quite rarely.  I asked him only twice.  During the initial launch of the module and after replacing the battery in the real time clock module.  If the temporary settings do not require a change, then this parameter is zero. <br><br>  After parsing the response from the server, the current timers for the boilers are reset.  After all, the previous value has already been sent to the server.  The reset takes into account the pause time waiting for a response from the server. <br><br>  It should be noted that the transmitted time of the boiler has an estimated value.  According to this parameter it is impossible to judge, say, the consumed electricity.  This is due to the peculiarities of the heating boilers.  For example, when the temperature in the boiler reaches 80 degrees, it switches off, but the circular pump continues to operate.  By reducing the temperature of the coolant to 60 degrees, the boiler is again included in the work.  The weather module only measures the total time it took for the boiler to reach the temperature threshold inside the house. <br><br>  After reaching the set temperature, the boiler is turned off, and the meteorological module continues to read temperature indicators with a frequency of 30 seconds.  When the temperature drops by more than 0.5 degrees, the heating boiler is re-activated.  This hysteresis was chosen experimentally, taking into account the inertia of the heating system. <br><br>  For visual indication of the performance of the weather module in the subroutine of the delay between cycles of temperature measurement, the flashing of the built-in LED has been added. <br><br>  I want to note that the choice of the mode of operation of the boiler occurs at the end of a five-minute period.  When the module is initially turned on or when it is restarted, the default mode is automatic. <br><br><h3>  Implementation </h3><br>  To translate the idea, I used what was at hand.  It was decided to build a weather module using Arduino modules.  Mega 2560, which remained from previous experiments, was taken as a processor board.  This fee is obviously redundant for this task, but it was available.  In addition to it was the layout of the layout, which housed almost all the other modules.  This is a DS3231 real-time clock and ESP8266 WiFi module (01).  A switching unit with two relays was purchased for separate control of electric and solar boilers. <br><br>  As the power source used the existing computer power supply.  As is known, in such a unit there is a wide choice of secondary supply voltage.  There is + 5V and, which is especially important when working with the ESP8266 WiFi module, + 3.3V.  In addition, these units are very reliable, taking into account the continuous nature of the weather module. <br><br><img src="https://habrastorage.org/webt/ht/5s/0x/ht5s0xvzlsbppxjw6gkzrbp8vnk.png"><br><br>  The figure shows the circuit switching boards.  The schematic diagram was not drawn in view of its obviousness.  The figure has an RGB-LED for visual indication of the operating modes of the weather module.  Green color indicates that the boilers are switched off, red means the operation of the solar boiler, blue - electric.  I did not have 220 Ohm resistors at hand, so the RGB-LED was connected directly to the outputs of the board, without current-limiting resistors.  I repent, I was wrong, but I took the risk consciously.  The current consumption of each output LED is only 20 mA, the output of the board allows you to connect up to 40 mA.  For three years of operation, while there were no problems. <br><br>  DHT21 (AM2301) were used as temperature sensors.  Initially, the DHT11 sensor was used to measure the temperature inside the house, but it has very poor measurement accuracy and, for an unexplained reason, the DTH.h library did not work correctly when using two different types of sensors in the circuit.  But since the replacement of the DHT11 due to its excessive error was obvious, I did not begin to deal with the library problem. <br><br>  The numbers in the boxes mean the numbers of the wires that connect external devices to the main board. <br><br><img src="https://habrastorage.org/webt/gp/dp/xt/gpdpxtfxha5ojhmz9elswu8u3_m.jpeg"><br><br>  The entire scheme was assembled in a hinged metal shield used for the installation of electrical wiring.  The choice of such a body was also related to what was at hand. <br><br>  But here I was expecting quite predictable surprise.  With the door completely closed, the casing body shielded the WiFi signal.  I had to leave the door ajar, as there was no desire to look for another suitable case and re-mount everything.  So I live for three years with the door ajar. <br><br><h3>  Management server </h3><br>  The web server used for monitoring and management is written in pure PHP and has an adaptive layout.  Initially, there was an idea to write an application for Android, but I refused this idea, as all the same the server would be necessary. <br><br>  After authorization, several pages with information become available.  This is the current state of the system according to the last received request from the weather module, a table of values ‚Äã‚Äãin the current hour and a graphical representation of the summary information for an arbitrary period of time.  There is also a page with a choice of settings for controlling the weather module. <br><br>  At the time of this writing, the meteorological module was already turned off, because the heating season was over.  Therefore, all the parameters on the main page of the site are relevant at the time of shutdown.  An attentive reader will notice that it was May 2nd. <br><br><img src="https://habrastorage.org/webt/vc/zr/y0/vczry0moatvofjpvneye1wrdcmo.png"><br><br><img src="https://habrastorage.org/webt/a6/7x/xu/a67xxuc9cef1v3-esnppgjwgu5o.png"><br><br>  As an example of graphs, the values ‚Äã‚Äãfor January 25, 2018 are given.  Histograms show boilers running time. <br><br><img src="https://habrastorage.org/webt/km/i4/cz/kmi4czmt9q659njydmzx1q8c-gk.png"><br><br><img src="https://habrastorage.org/webt/94/5v/jw/945vjwwmogasv9tthsuzffbumrm.png"><br><br>  Setup Page <br><br><img src="https://habrastorage.org/webt/ag/bn/rn/agbnrnxsir1bo1gpvd1d0gqjbie.png"><br><br>  As I already mentioned, this solution for monitoring and controlling the heating system of a private house has already worked three heating seasons.  During this time there were only two freezes caused by the long-term disappearance of the channel to the Internet.  And not the whole meteorological module was hanging, but only the ESP8266 WiFi module. <br><br>  In general, the functionality of the system completely suits me, but given the apparent redundancy of the applied platform, I am thinking about expanding it. </div><p>Source: <a href="https://habr.com/ru/post/358796/">https://habr.com/ru/post/358796/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358784/index.html">Figma - we make design systematically</a></li>
<li><a href="../358786/index.html">Ship terabytes in barrels or SparkStreaming vs Spring + YARN + Java</a></li>
<li><a href="../358788/index.html">Holidays in the world of telecommunications</a></li>
<li><a href="../358790/index.html">Finding the number of commissions that "draw" integer turnout values ‚Äã‚Äãin the presidential election of the Russian Federation in 2018</a></li>
<li><a href="../358794/index.html">Mitapa in May: blockchain in Moscow and testing in St. Petersburg</a></li>
<li><a href="../358798/index.html">Inverse kinematics in two-dimensional space</a></li>
<li><a href="../358800/index.html">White spots in work with SSH</a></li>
<li><a href="../358802/index.html">USB3Vision and GenICam. View from the inside. I</a></li>
<li><a href="../358804/index.html">Protocol-Oriented Programming</a></li>
<li><a href="../358806/index.html">Red Hat Summit: The best moments of the main open source conference in 30 minutes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>