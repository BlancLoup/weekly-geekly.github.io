<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Win32 / Aibatook Banking Trojan Analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Win32 / Aibatook Trojan has been known since the end of last year and specializes in stealing user data as well as online banking data. The code f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Win32 / Aibatook Banking Trojan Analysis</h1><div class="post__text post__text-html js-mediator-article">  The <b>Win32 / Aibatook Trojan</b> has <b>been</b> known since the end of last year and specializes in stealing user data as well as online banking data.  The code for the first versions of Aibatook was written in Delphi, then the authors switched to C ++.  Our analysts have analyzed one of the versions of this Trojan, which appeared in April 2014. This version has the following features: <br><ul><li>  Malware is distributed through a special chain of operation (a set of malicious scripts), the beginning of which is posted on a compromised website. </li><li>  Aibatook targets Internet Explorer only and uses an unusual way to steal user information. </li><li>  Two different approaches to the implementation of the logic of theft of personal information.  The first of them is specially created against two large Japanese banks, and the second is more flexible and is currently being used against about 90 different Internet services. </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/771/127/8f6/7711278f6c58ff441287dda3eebf0ca9.jpg"><br><br><a name="habracut"></a>  As in many <a href="http://habrahabr.ru/company/eset/blog/185592/">other</a> malware infection situations, user compromise begins with a legitimate website that hosts the malicious content.  With this content, which is malicious JavaScript or an IFrame, the user is redirected to the malicious webpage of the exploit kit, from which the malware is installed.  But instead of using a full-fledged set of exploits, i.e. relying on several exploits to different software to automatically install malware, in the case of <a href="http://virusradar.com/en/Win32_Aibatook/detail">Win32 / Aibatook,</a> attackers rely on only one exploit for one particular vulnerability in Oracle Java software.  Despite the fact that such a strategy may look like it is not optimal for installing a malicious program, the very similar method is the attacker's focus on users of a particular bank who use Java software. <br><br>  Starting in mid-April, attackers began using an exploit for the Java vulnerability CVE-2013-2465.  To automatically install Win32 / Aibatook, several legitimate websites were compromised by malicious content.  Over the past three months, we have identified four of these websites, which are presented below. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  sokuhabo.net <br>  uravidata.com <br>  ppv.xxxurabi.com <br>  mywife.cc <br></blockquote><br>  All four resources are porn sites targeting Japanese audiences.  According to <a href="http://www.alexa.com/">Alexa</a> statistics, three of the four sites are on the list of 20 thousand most visited sites in Japan.  The resource ‚Äúmywife.cc‚Äù is even included in the list of the first 2 thousand. The image below shows the exploitation process in the case of ‚Äúppv.xxxurabi.com‚Äù (the other three use a similar infection mechanism). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/505/999/4c8/5059994c8e877f07fd66abe27558ef78.png"><br>  Fig.  The process of infecting a user with a Win32 / Aibatook trojan. <br><br>  At the first stage, the user visits the ppv.xxxurabi.com web page, which contains a link to the malicious JavaScript file hosted on google.sonovi.com.  The script itself, after removing obfuscation from it, has the form. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b5d/e55/c46/b5de55c4635df9c5164f3c01355f33bf.png"><br><br>  The script injects the IFRAME element to the 2002.jp exploit kit page, and also sets a cookie named ‚ÄúGOOGLE1‚Äù, which will remain on the user's computer for the next 24 hours.  This cookie is used as an indicator of system compromise, so its user will no longer be redirected to a set of exploits. <br><br>  The user is then redirected to the exploit kit page where he can see the following content. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ee7/01c/318/ee701c318cb4837950046976e8d00ad7.png"><br><br>  Under certain conditions, a fragment of HTML code that the user should not see will be displayed at the very beginning of the web page.  It is marked in blue in the following screenshot with the code for the HTML page. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/38c/080/8eb/38c0808ebb8e451df12781ead804fafc.png"><br><br>  Then the browser will load and execute a Java applet called ‚Äúb399.class‚Äù.  It will also perform a file request with the name ‚Äúcounter.php‚Äù.  This is probably due to the desire of cybercriminals to limit the number of attempts to install malware per day.  This script for counting the number of exploit applications is placed on another compromised resource ‚Äúccc.rejec.net‚Äù. <br><br>  At the final stage, the malicious applet exploits the CVE-2013-2465 vulnerability.  It uses integer overflow in the Java SE 2D component, which leads to memory corruption in the Abstract Window Toolkit (AWT) code.  Such a mechanism that leads to the rewriting of the SecurityManager class code allows the exploit to bypass the limitations of the Java sandbox (sandbox in which Java executes applet byte-code).  The exploit then tries to load the payload from the URL that is in the .class file.  Next, the payload is stored in the "tar.gif" file and executed.  In our case, the payload URL was "xsvx1014274.xsvr.jp". <br><br>  The following table describes the malicious .class files that are part of the exploit for CVE-2013-2465. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/91a/045/92e/91a04592e075e6d07b4c021689b3bf81.png"><br><br>  It should be noted that Win32 / Aibatook, at different times, was distributed through other exploits (for example, CVE-2014-0322). <br><br>  <b>Payload</b> <br><br>  The main purpose of Win32 / Aibatook are users of Japanese online banking services, as well as some other online services.  As we mentioned earlier, the malicious code uses two approaches to implement its functions of stealing confidential data: one of them is used to steal information from two websites, and the other from more than 90 sites for which the universal method is used.  In both cases, one approach is used, which is based on the compromise of the Internet Explorer browser. <br><br>  The malicious program compromises Internet Explorer using the <a href="http://msdn.microsoft.com/en-us/library/aa752574%2528v%3Dvs.85%2529.aspx">IHTMLDocument2</a> COM interface, which allows you to read data from a web page and write it there, that is, to modify it.  This is done using the following steps. <br><ul><li>  Gets a handle to the active user window via the <i>GetCursorPos</i> and <i>WindowFromPoint APIs</i> . </li><li>  Checks the class name of the window to match the string "Internet Explorer_Server". <br><ul><li>  In the event of a mismatch, the malware execution thread falls asleep for a few seconds and returns to the second check. </li><li>  In the case of a match, the documented features of the IHTMLDocument2 interface are used. </li></ul></li></ul><br>  This method allows attackers to access IE versions 8-11 and is limited because it does not allow working with other browsers.  However, according to <a href="http://en.wikipedia.org/wiki/Usage_share_of_web_browsers">statistics</a> , Internet Explorer is the most common for Japan.  This is another indicator of Win32 / Aibatook targeting Japanese users. <br><br>  Below will be described two approaches that are used by Win32 / Aibatook to steal the user's personal information. <br><br>  The first approach is highly specialized and is used to compromise several Internet banking services whose URLs are hardcoded into the malware code.  These addresses belong to ‚ÄúJapan Post‚Äù and ‚ÄúSBI Sumishin Net Bank‚Äù banks.  To compromise online banking webpages, Win32 / Aibatook retrieves the URL of the current webpage using the <i>IHTMLDocument2.get_url</i> method.  Next, he compares the current address with the URL from his body, as shown in the screenshot below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/45e/4f7/7e4/45e4f77e49057798c476f1618c41b3e4.png"><br><br>  It should be noted that the URLs of online banking services, as well as all other lines from the body of the malicious program, are encrypted using a special encryption algorithm.  Each encrypted string consists of two parts: <br><ul><li>  The first part is a fixed-length key that looks like a string encoded through base64.  The key is encrypted with a XOR operation with a hard-wired value. </li><li>  The second part consists of encrypted data, which is first encoded via base64, and why is it encrypted using the key specified in the first paragraph. </li></ul><br>  If a user visits one of the above bank URLs, the malware will monitor the user's login to the online banking system based on the title of the page through the <i>IHTMLDocument2.get_title</i> method and its contents via <i>IHTMLDocument2.get_nameProp</i> .  Once the login operation has been committed, Aibatook can perform the following two actions: <br><ul><li>  Get the values ‚Äã‚Äãentered by the user into the HTML form.  That is, get a bunch of login / password from the account. </li><li>  Modify the HTML code in the body of the web page that is displayed to the user.  Aibatook retrieves web page content via <i>IHTMLDocument2.get_body</i> and modifies it using <i>body.put_innerHTML</i> .  Below is an example of a Japan Post online banking web page with a form embedded in a malicious code. </li></ul><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e6e/767/f3c/e6e767f3ca75e1939665054f0c504ba0.png"><br><br>  The hieroglyphs highlighted in red are translated as an urgent request to the user to enter their personal identification number, since the online banking system needs an update (click on the button will simply redirect the user to another page of the online banking system).  As soon as Aibatook has access to the user's personal data, it sends it to a remote C &amp; C server using a URL that is hardwired into the body of the malware.  This message is an HTTP POST request that contains the stolen data as an argument.  Data is encrypted using the same algorithm that was mentioned earlier.  Aibatook also sends the MAC address of the computer's network adapter, which will help it identify the victim.  Before intercepting data from the Japan Post online banking page, the malicious code can perform the following actions. <br><ul><li>  Sets a malicious proxy in the browser settings when a user visits the Japan Post site.  It may be used as an additional tool to collect user input. </li><li>  If a user visits a special anti-phishing web page of an online banking site, the malicious code immediately redirects it to the login page. </li></ul><br>  The second approach to data theft from online banking sites allows attackers to significantly expand the range of web resources from which information is stolen.  This approach is based on the well-known technique of grabbing web page forms, which is to constantly monitor data entry fields in an HTML form.  If the form fields meet the necessary conditions, the data entered into them is stolen by malicious code.  Aibatook uses a configuration file that loads from a hard-coded URL and points to websites for compromise.  The configuration file is encrypted with the algorithm mentioned above.  After loading it into memory, the malicious code will store it already in the clear.  Part of one of the configuration files is shown below in the screenshot. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3f2/74f/0d3/3f274f0d312915b2f72e3e547a99fe70.png"><br><br>  As you can see, this file has a certain structure and consists of blocks that are labeled with tags.  The file begins with a version block followed by a set of blocks [W], each of which describes the target chosen by the attackers.  A block can contain several child blocks. <br><ul><li>  The [Web] block contains the name of the resource being compromised. </li><li>  The [CURL] block contains the URL of the resource (web page). </li><li>  The [CTI] block contains the title of the resource web page. </li><li>  The [NAME] block describes the names of the HTML fields to be analyzed. </li><li>  The [ID] block describes the ID of the HTML fields to be analyzed. </li></ul><br>  The logic of the use of this file by a malicious program is as follows: if the URL of the visited webpage victim matches the value from the [CURL] block or its title matches the string of the [CTI] block, then from each field with a name that matches [NAME] or the identifier ID] will be stolen the entered data.  The following table shows one such example. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/949/0f4/4e1/9490f44e196074049fecb0ed6192b3e2.png"><br><br>  In this example, we can see the Aibatook configuration file with one block [W], the next column is the web page visited by the user, and then the information stolen by the malicious code.  This approach to data theft is quite flexible, in particular, some blocks [CURL] and [CTI] remain empty, which helps attackers to navigate to any web page with the names of the input fields that are indicated in it.  We calculated statistics on domains targeted by Aibatook when using this method of compromising web pages.  87 domains were discovered, and for some of them it was possible to establish their purpose through the values ‚Äã‚Äãof the tags [CURL] and [CTI]. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/191/74f/191/19174f1917d5529fc952fdcde0184f87.png"><br><br>  <b>Conclusion</b> <br><br>  The Win32 / Aibatook malware family is aimed at compromising Japanese users.  Infection of a user's computer occurs through a special chain of exploitation consisting of redirecting the victim to malicious sites.  Aibatook is used by cybercriminals to steal user data through the compromise of Internet Explorer.  Two approaches are used for this, the first, more general, is aimed at stealing information from online banking sites of two large Japanese banks, and the second is used to steal data from a large number of web resources of various types. <br><br>  We have seen the constant development of Win32 / Aibatook code and capabilities over the past few months.  In the future, we can expect not only the further evolution of this family, but also its more active use by intruders. </div><p>Source: <a href="https://habr.com/ru/post/230833/">https://habr.com/ru/post/230833/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230823/index.html">FIAS or KLADR: choose the directory of addresses</a></li>
<li><a href="../230825/index.html">"Roscosmos" is going to create a lunar orbital station visited on the basis of the module for the ISS</a></li>
<li><a href="../230827/index.html">Why should you load your mind into a supercomputer?</a></li>
<li><a href="../230829/index.html">Generation of large cards in a remake of the game "Caesar III (c)"</a></li>
<li><a href="../230831/index.html">NPM 2.0.0 & passing arguments to run-script</a></li>
<li><a href="../230835/index.html">Design Lynch: Designing Applications for WP with Expert Dave Crawford</a></li>
<li><a href="../230837/index.html">Soon ICFPC 2014</a></li>
<li><a href="../230839/index.html">Firefox 31 release</a></li>
<li><a href="../230841/index.html">How to significantly increase site conversion with tiny phrases: Microcopy. Part 1</a></li>
<li><a href="../230845/index.html">In the new advertising Galaxy S5 Samsung makes fun of iPhone screen sizes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>