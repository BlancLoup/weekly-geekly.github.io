<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring a Pfsense based gateway. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What will each user always notice? That's right, the lack of internet. But how? "Vkontakte" is not loaded - it means that there is no Internet. But it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring a Pfsense based gateway. Part 1</h1><div class="post__text post__text-html js-mediator-article"> What will each user always notice?  That's right, the lack of internet.  But how?  "Vkontakte" is not loaded - it means that there is no Internet.  But it happens that the director or the brave warriors from the information security department want to ban something, collect something, check it somewhere.  And then the administrator begins to dance around the gateway to the Internet.  If the company has a lot of money, then the dances can be long and with gallant cavaliers (Mar Checkpoint, Mr. PaloAlto, Mr. SonicWall).  But what to do if there is only a lot of money for hardware, they want a lot of functionality, but they need to be done quickly?  <s>Run</s>  <s>Mr Proper</s> Pfsense, actively supported by the community free, flexible and easy to configure FreeBSD-based firewall, comes to the rescue. <br><a name="habracut"></a><br>  In the first part, we will look at the classics of the genre ‚Äî a firewall with a proxy (authentication using Active Directory credentials) and content filtering, as well as some kind of anti-virus checking of traffic on the fly.  We will separately consider the issue of setting up remote user access to the enterprise network. <br><br>  If there is interest, I can write the second part of the deployment instructions, where I will consider balancing between several providers, creating and simultaneously operating two gateways, and adding security features such as IPS / IDS, spam filtering, more kosher filtering with Dansguardian tools, IM and HTTPS sniffing content and much more interesting. <br><br>  To reduce the possible holivar: "Yes, this can be done on% yourdistrname%" and "Yes, everything can be configured from the command line."  So, all the formalities are met - you can begin. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Installation will do with a flash drive.  To do this, use the pfSense-memstick-2.2.2-RELEASE-i386.img.gz image, downloaded from one of the mirrors listed on the official website.  It is very convenient that at first we choose architecture, functionality, and then we are offered a list of mirrors.  I will not describe the installation process in detail, everything is elementary there, no additional settings are needed.  At the end of the installation, you will be prompted to assign VLANs and define interfaces, as well as their purpose.  It looks like this: <br><br><img src="https://habrastorage.org/files/975/26f/c2d/97526fc2d7bb407db56adeecc485dbfe.jpg"><br><br>  After configuring the interfaces, we get to the menu with a limited number of items, but it is possible to go to the shell.  In my opinion, the most useful menu item is the ability to reset the password on the web muzzle.  The pfsense developers strongly recommend that all configuration be done only through a graphical interface.  And it looks pretty nice, the set of widgets is wide, you can customize their set for yourself. <br><br><img src="https://habrastorage.org/files/3b8/05e/9e2/3b805e9e2ff548f5a089384387a0cc5a.jpg"><br><br>  First of all, create your internal CA on pfsense or use the existing one.  To do this, select Cert Manager in the System menu and make the necessary settings in the CA section: you need to specify the key length, the hashing algorithm, the lifetime and the full name of the CA.  We will need the configured CA to create an OpenVPN server and to work on LDAPS. <br><br><img src="https://habrastorage.org/files/269/156/b94/269156b94380468bbb3e16d873b2023e.jpg"><br><br>  Now we integrate our gateway with Active Directory.  In the Servers section of the User Manager block from the System menu, settings were made to use a domain controller.  Everything is so disgraceful - you can specify the address, transport, search area, containers with accounts, credits for creating a binding and a template for filling in Microsoft AD - you can publish users' <s>kraken</s> to the Internet. <br><br><img src="https://habrastorage.org/files/949/1a6/895/9491a68950464d9e886ff036621a607a.jpg"><br><br>  Let's proceed to setting up traffic filtering rules.  First, if any grouping of addresses, ports, URLs is required, then welcome to the Aliases tab.  Secondly, you can configure the time intervals that can be used for the operation of the rules.  By default, a rule is created that ‚Äúeverything is possible everywhere and everywhere‚Äù, as well as a rule that does not block access to the web.  Creating rules looks pretty casual: <br><br><img src="https://habrastorage.org/files/880/fa7/dab/880fa7dabe97440da8ae545c58bd99e1.jpg"><br><br>  However, there are a number of additional features, for example, allowed OS, which can be set TCP-flags, schedule work rules, as well as an inspector of application-level protocols. <br><br><img src="https://habrastorage.org/files/a53/11a/913/a5311a913fc64042850327a22c5a128c.jpg"><br><br>  Setting up OpenVPN remote access with password authentication in the local database and certificate can be found here - <a href="https://www.youtube.com/watch%3Fv%3DVdAHVSTl1ys">www.youtube.com/watch?v=VdAHVSTl1ys</a> .  The choice of remote access protocols is small - IPSec, L2TP, PPTP and OpenVPN.  When you select PPTP, pfsense itself will write to you that the protocol is not secure and it is better to choose another one. <br><br><img src="https://habrastorage.org/files/0f1/5f6/a55/0f15f6a551174b8195899cef63cbf5e6.jpg"><br><br>  Authentication in the local database was chosen in order to preserve the possibility of a remote connection in case of any problems with the directory servers. <br><br>  To export the OpenVPN settings for devices on different platforms, you need to install the OpenVPN Client Export Utility package, which is in the list of packages available for installation.  Now we return to the sources - in the Cert Manager tab, there we create a certificate for the VPN server and each client.  The only difference is in the type of certificate. <br><br><img src="https://habrastorage.org/files/1ca/676/8c9/1ca6768c9208471785d7b5764ba61c6f.jpg"><br><br>  Go to the OpenVPN server setup.  We select the server operation mode - in my case ‚ÄúRemote Access (SSL / TLS + User Auth)‚Äù, authentication server, protocol, port, necessary VPN server certificate and set the necessary encryption parameters.  What is offered by default is not the best choice. <br><br><img src="https://habrastorage.org/files/3b7/2ea/aea/3b72eaaea27547e38a8535a80f119ba9.jpg"><br><br>  Next, set up a VPN-network and set up the settings for clients.  Here we can determine whether to issue a DNS server to the client, whether to drive all client traffic into the tunnel, etc.  After that, save and go to the client export tab.  From here we export the necessary settings for the connection and user certificate. <br><br><img src="https://habrastorage.org/files/d62/060/007/d620600071ef4292b197f6bf9086ff04.jpg"><br><br>  By the way, when setting up the server, you could use the Wizard, which would lead you through all the ‚Äúsorrows and tribulations‚Äù of the OpenVPN settings.  A certain analogue of the ‚ÄúMake Good‚Äù button. <br><br>  Of course, if you have many users need remote access, then the work on issuing and revoking certificates, exporting settings, setting up users in a local database will turn into a very boring, but responsible task.  I believe that with such requirements for scaling it is necessary to have a separate CA with a CRL and a single authentication database, such as Active Directory.  But if there are few users, the option proposed above is fully functional. <br><br>  It remains for us to configure the proxy, content filtering and anti-virus scanning.  Installing a HAVP package is a proxy with a ClamAV scanner.  To configure, we specify the ClamAV mode and proxy, port, interface, settings for checking for passing traffic.  Since squid is planned to be used, our mode of operation is ‚ÄúParent for Squid‚Äù.  Separately, we configure the settings for updating the anti-virus database and its mirror. <br><br><img src="https://habrastorage.org/files/0ea/8c8/597/0ea8c859704a4d028f7a7f8b67c3ceee.jpg"><br><br>  Go to the Squid setup.  After installing the package, select the proxy mode of operation and the port, then on the tab ‚ÄúAuth Settings‚Äù specify the authentication method used.  Since we have the task of using Active Directory as a user base, we use the LDAP protocol.  Settings for integration with a domain controller are presented below. <br><br><img src="https://habrastorage.org/files/290/e9d/84c/290e9d84c9db4c7f99a7b350251db907.jpg"><br><br>  If necessary, configure the settings of the upstream proxy, cache and traffic management, and ACL.  For example, I made * microsoft.com / * to whitelist for normal updates and OS activation, and that didn‚Äôt scan.  But more about that below. <br><br>  Now filtering - set up squidGuardian.  In terms of filtering approaches, in principle, there is a good article - <a href="http://habrahabr.ru/post/188444/">‚ÄúTo-do: Filter everything and everything‚Äù</a> .  After installing squidGuardian, use the ‚ÄúProxy filter‚Äù item of the ‚ÄúServices‚Äù menu to proceed to its configuration.  On the Blacklist tab, we indicate where to download the blacklist in tar or tar.gz format, and also on the General settings tab, tick the box to enable the use of blacklist.  I used free blacklist <a href="">from here</a> .  If the content filter needs to work by time, the intervals can be set on the Times tab.  Next you are setting up public or group ACLs, the main thing is not to forget to tick the box next to the ban on the use of IP addresses in the URL.  To set up filtering rules, click ‚ÄúTarget Rules List‚Äù and select actions for the necessary categories, as well as the default action. <br><br><img src="https://habrastorage.org/files/4e2/768/b41/4e2768b41e344b74809429edcbc08196.jpg"><br><br>  If you need to create your own categories, you can use the Target Categories page.  After saving, your category will appear in the general list of rules.  I created my category to allow access to resources by IP addresses that do not have a DNS name. <br><br>  And now a fly in the ointment.  I fully admit that the problems are caused by their own curvature of the hands, but still.  If someone from the community can suggest any solutions, I will be extremely grateful. <br><br>  1. Developers have long promised, but have not yet done support for L2TP over IPSec. <br>  2. Problems attempting to grow pfsense to use AD CS certificates.  I read the discussion <a href="https://forum.pfsense.org/index.php%3Ftopic%3D63910.0">from here</a> , but I couldn‚Äôt beat the small dragon. <br>  3. The problems of the work of client-banks in case you have balancing between providers. <br>  4. If you have specified user authentication via AD, and the domain controller is unavailable, then your built-in (!!!) pfsense admin will also refuse to work.  There is a discussion on the forum, people write scripts in php to resolve the issue, but this is not a recommended solution. <br>  5. Apparently here my personal problems with the Cyrillic alphabet.  First, authentication does not work if the password is used in the Cyrillic layout.  Secondly, problems in displaying AD container names in Cyrillic. <br>  6. Despite all the efforts, from time to time there are problems with the services from Microsoft.  Most often, OS activation does not work.  I think, here nevertheless it will be necessary to correct a squid config manually. <br><br>  In conclusion, I would like to note that this distribution distribution appeals to me with broad functionality and flexibility, it is very easy to clone the settings to several gateways, it is possible to make embedded solutions.  Of course, full configuration via the web IMHO is not good, but it is precisely in this way that developers fencing novice admins from the painful blows of a rake of different heights. </div><p>Source: <a href="https://habr.com/ru/post/257787/">https://habr.com/ru/post/257787/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257771/index.html">Airbnb-flavored Aviasales</a></li>
<li><a href="../257775/index.html">Abstractions without overhead: types in Rust</a></li>
<li><a href="../257779/index.html">Programmable Wi-Fi night light bulb on ESP8266</a></li>
<li><a href="../257781/index.html">Vector replacement to sprites - we implant SVG in CSS</a></li>
<li><a href="../257783/index.html">IBM Introduces New Cyber ‚Äã‚ÄãAttack Solution</a></li>
<li><a href="../257789/index.html">But about Sphinx 3.0</a></li>
<li><a href="../257791/index.html">Cisco Company Development History: 1984-2000</a></li>
<li><a href="../257793/index.html">Format Analysis: Sound in some games on the Unreal Engine</a></li>
<li><a href="../257795/index.html">Bitrix24 CRM. Overview</a></li>
<li><a href="../257803/index.html">Another attempt to interest students</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>