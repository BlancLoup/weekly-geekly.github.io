<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Custom gestures, Kinect + Unity. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue our tutorial on the use of custom gestures in the Kinect + Unity bundle. In the first part, we looked at the process of learning gestures,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Custom gestures, Kinect + Unity. Part 2</h1><div class="post__text post__text-html js-mediator-article">  We continue our tutorial on the use of custom gestures in the Kinect + Unity bundle.  In the <a href="https://habrahabr.ru/company/singularis/blog/275451/">first part,</a> we looked at the process of learning gestures, with the result that we have a trained model in the form of a .gdb file.  Today we will use this model in Unity. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/55a/89c/84b/55a89c84b799447393e41931e866739b.png"></div><br><a name="habracut"></a><br><h2>  <font color="#2A3990">Setup Kinect + Unity</font> </h2><br>  Create a project in Unity, add the downloaded Kinect packages: Assets -&gt; Import package -&gt; Custom package ..., choose Kinect.VisualGestureBuilder.2.0.1410.19000.unitypackage and Kinect.2.0.1410.19000.unitypackage (versions may vary).  There may be a problem with the fact that some files in these packages are the same, Unity adds both files with the names File.cs and File 1.cs, in this case simply delete all files with index 1 (the list will be in error messages). <br>  The structure of an empty project with added packages: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/017/4be/0e0/0174be0e025f4697b3c4f3c74a1d080f.png"></div><br><br>  Run the finished example to make sure everything works.  In the downloaded package for Unity there are two examples: GreenScreen and KinectView.  From the KinectView example, add two folders ‚ÄúMaterials‚Äù and ‚ÄúScripts‚Äù and the file ‚ÄúMainScene.unity‚Äù.  Open the scene (MainScene.unity) and run.  You should get something like this: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/6e9/fa7/6e2/6e9fa76e262b4a758852747d37211bbe.png"></div><br><br>  If we have achieved such a result, then everything works for us, we can proceed to the main part. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First we will make sure that a message is output to the log by triggering a gesture. <br>  From the Kinect SDK we need: <br><ul><li>  <a href="https://msdn.microsoft.com/en-us/library/microsoft.kinect.kinectsensor.aspx">KinectSensor</a> - class representing the sensor Kinect; </li><li>  <a href="https://msdn.microsoft.com/en-us/library/microsoft.kinect.visualgesturebuilder.visualgesturebuilderdatabase.aspx">VisualGestureBuilderDatabase</a> - a class that represents the base of gestures; </li><li>  <a href="https://msdn.microsoft.com/en-us/library/microsoft.kinect.visualgesturebuilder.visualgesturebuilderframesource.aspx">VisualGestureBuilderFrameSource</a> - processing gestures on frames received from Kinect; </li><li>  <a href="https://msdn.microsoft.com/en-us/library/windowspreview.kinect.body.aspx">Body</a> - a class that represents a person; </li><li>  <a href="https://msdn.microsoft.com/en-us/library/microsoft.kinect.visualgesturebuilder.aspx">Gesture</a> - a class that represents a gesture; </li><li>  <a href="https://msdn.microsoft.com/en-us/library/microsoft.kinect.bodyframesource.aspx">BodyFrameSource</a> - information about the people found in frames received from Kinect. </li></ul><br>  In addition, we need two classes for processing received frames from Kinect: <a href="https://msdn.microsoft.com/en-us/library/microsoft.kinect.visualgesturebuilder.visualgesturebuilderframereader.aspx">VisualGestureBuilderFrameReader</a> and <a href="https://msdn.microsoft.com/en-us/library/windowspreview.kinect.bodyframereader.aspx">BodyFrameReader</a> . <br><br><h2>  <font color="#2A3990">Uploading gestures to Unity</font> </h2><br>  It is understood that we have at this stage an empty Unity project with imported Kinect packages, as in the example above. <br>  Create an empty object (GameObject -&gt; Create Empty), let's call it KinectManager.  Add a new script to our object with the name KinectManagerScript (in this tutorial only scripts written in C # are considered).  Open the script, add using'i: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Kinect.VisualGestureBuilder; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Kinect;</code> </pre> <br>  Inside the class, declare objects of the above mentioned classes: <br><pre> <code class="cs hljs">VisualGestureBuilderDatabase _dbGestures; Windows.Kinect.KinectSensor _kinect; VisualGestureBuilderFrameSource _gestureFrameSource; Windows.Kinect.BodyFrameSource _bodyFrameSource; VisualGestureBuilderFrameReader _gestureFrameReader; Windows.Kinect.BodyFrameReader _bodyFrameReader; Gesture _swipeUpDown; <span class="hljs-comment"><span class="hljs-comment">//   Windows.Kinect.Body[] _bodies; //  ,  Kinect' Windows.Kinect.Body _currentBody = null; // ,     public string _getsureBasePath = "upDown.gbd"; //    </span></span></code> </pre><br>  Now we need to initialize the values ‚Äã‚Äãand add event handlers.  Create the InitKinect () method and call it in the Start () method.  First, let's download gestures from our model: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitKinect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _dbGestures = VisualGestureBuilderDatabase.Create(_getsureBasePath); _bodies = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Windows.Kinect.Body[<span class="hljs-number"><span class="hljs-number">6</span></span>]; _kinect = Windows.Kinect.KinectSensor.GetDefault(); _kinect.Open(); _gestureFrameSource = VisualGestureBuilderFrameSource.Create(_kinect, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Gesture gest <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _dbGestures.AvailableGestures) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gest.Name == <span class="hljs-string"><span class="hljs-string">"UpDownSwipe_Right"</span></span>) { _gestureFrameSource.AddGesture(gest); _swipeUpDown = gest; Debug.Log(<span class="hljs-string"><span class="hljs-string">"Added:"</span></span> + gest.Name); } } }</code> </pre><br>  <i>Note: we encountered a problem when Kinect does not turn on instantly, and, therefore, the Open () method did not work.</i>  <i>It was treated by periodically checking the IsAvailable flag in Update and opening it in case Kinect is available.</i> <br><br>  We start the application, and if everything is fine, then we will see the following in the log: <br><img src="https://habrastorage.org/files/fae/6f2/137/fae6f21372c5463bb3cb7dc919f1af00.png"><br><br>  This means that we successfully opened and uploaded gestures (in our case, one) from our trained model. <br><br><h2>  <font color="#2A3990">Gesture detection</font> </h2><br>  Obviously, gestures need to be detected from a person, so we need to get a list of all the people who see Kinect.  Initialize the _bodyFrameSource object and _bodyFrameReader and add the event ‚Äúframe came‚Äù event (do all this in InitKinect): <br><pre> <code class="cs hljs">_bodyFrameSource = _kinect.BodyFrameSource; _bodyFrameReader = _bodyFrameSource.OpenReader(); _bodyFrameReader.FrameArrived += _bodyFrameReader_FrameArrived;</code> </pre><br>  Similarly, we initialize _gestureFrameSource, pause and add an event handler: <br><pre> <code class="cs hljs">_gestureFrameReader = _gestureFrameSource.OpenReader(); _gestureFrameReader.IsPaused = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; _gestureFrameReader.FrameArrived += _gestureFrameReader_FrameArrived;</code> </pre><br>  In the _bodyFrameReader_FrameArrived handler, we want to get information about people and, if there is someone in the frame, select the first person (for simplicity), whose gestures will be tracked. <br><div class="spoiler">  <b class="spoiler_title">Method source code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _bodyFrameReader_FrameArrived(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, Windows.Kinect.BodyFrameArrivedEventArgs args) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> frame = args.FrameReference; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> multiSourceFrame = frame.AcquireFrame()) { multiSourceFrame.GetAndRefreshBodyData(_bodies); <span class="hljs-comment"><span class="hljs-comment">//     _currentBody = null; foreach (var body in _bodies) { if (body != null &amp;&amp; body.IsTracked) { _currentBody = body; //       break; } } if (_currentBody != null) { Debug.Log("_currentBody is not null"); } else { Debug.Log("_currentBody is null"); } } }</span></span></code> </pre><br></div></div><br>  Run the application.  When Kinect sees at least one person, we will see "_currentBody is not null", if there is no one in the frame - "_currentBody is null".  Example log: <br><img src="https://habrastorage.org/files/196/1ea/05e/1961ea05ee4d471f86675953c65214e0.png"><br><br>  We were looking for an active person in order to recognize his gestures.  If we find a person, save their id in _gestureFrameSource and remove from pause.  Our condition will change to the following: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_currentBody != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Debug.Log(<span class="hljs-string"><span class="hljs-string">"_currentBody is not null"</span></span>); _gestureFrameSource.TrackingId = _currentBody.TrackingId; _gestureFrameReader.IsPaused = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Debug.Log(<span class="hljs-string"><span class="hljs-string">"_currentBody is null"</span></span>); _gestureFrameSource.TrackingId = <span class="hljs-number"><span class="hljs-number">0</span></span>; _gestureFrameReader.IsPaused = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br>  The last thing we need from Kinect is the handler for gestures directly.  We check the validity of our person id, we get the current frame as we did in _bodyFrameReader_FrameArrived: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_gestureFrameSource.IsTrackingIdValid) { Debug.Log(<span class="hljs-string"><span class="hljs-string">"Tracking id is valid, value = "</span></span> + _gestureFrameSource.TrackingId); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> frame = args.FrameReference.AcquireFrame()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (frame != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*‚Ä¶*/</span></span> } } }</code> </pre><br>  We get the current result recognition discrete gestures: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> results = frame.DiscreteGestureResults;</code> </pre><br>  if there are any gestures, look, our gesture or not: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (results != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; results.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { DiscreteGestureResult swipeUpDownResult; results.TryGetValue(_swipeUpDown, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> swipeUpDownResult); Debug.Log(<span class="hljs-string"><span class="hljs-string">"Result not null"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (swipeUpDownResult.Confidence &gt; <span class="hljs-number"><span class="hljs-number">0.1</span></span>) { Debug.Log(<span class="hljs-string"><span class="hljs-string">"Up Down Gesture"</span></span>); } }</code> </pre><br>  The threshold value of Confidence depends on the quality of your training, that is, it is such a value, below which is noise, and above which is a gesture (remember the herringbone from the first part), it is chosen empirically :) <br><br>  Having launched the application, we will see that multiple detection is performed on one gesture.  This is due to the fact that the results for each frame are independent, and since the gesture is not performed instantly (several frames), we get a positive result for each of the frames.  You can eliminate this by a logical flag: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> gestureDetected = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (swipeUpDownResult.Confidence &gt; <span class="hljs-number"><span class="hljs-number">0.1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!gestureDetected) { gestureDetected = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; Debug.Log(<span class="hljs-string"><span class="hljs-string">"Up Down Gesture"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { gestureDetected = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br><h2>  <font color="#2A3990">Using gestures</font> </h2><br>  The last thing we have to do with KinectManagerScript is to generate an event when we saw the gesture.  We declare: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SimpleEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> SimpleEvent OnSwipeUpDown;</code> </pre><br>  and when they found the gesture: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!gestureDetected) { gestureDetected = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; Debug.Log(<span class="hljs-string"><span class="hljs-string">"Up Down Gesture"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OnSwipeUpDown!= <span class="hljs-literal"><span class="hljs-literal">null</span></span>) OnSwipeUpDown(); }</code> </pre><br>  This concludes with KinectManagerScript.  Let's go back to our scene and create a sphere.  Let's call ‚ÄúMainSphere‚Äù, add a new script ‚ÄúMainSphereScript‚Äù.  In the Start () method, we will create an event handler, check with the help of the log that everything works: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { KinectManagerScript.OnSwipeUpDown += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KinectManagerScript.SimpleEvent(KinectManagerScript_OnSwipeUpDown); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KinectManagerScript_OnSwipeUpDown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Debug.Log(<span class="hljs-string"><span class="hljs-string">"upDown From listener"</span></span>); }</code> </pre><br>  In principle, this is the goal of our tutorial, to make our gesture some event for which we can subscribe and perform the actions that we need.  For the purity of the experiment, we will add movements of our sphere in a gesture, the result will be something like the following: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/ZCwe_P27RT0%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjLfr4c497oKtcScEC4zkEi9x3ajA" frameborder="0" allowfullscreen=""></iframe><br><br>  Scripts: <br>  <a href="https://gist.github.com/Kwentar/61e3d8a93b73da820815">MainSphereScript.cs</a> <br>  <a href="https://gist.github.com/Kwentar/44224a51e8ed5d76f628">KinectManagerScript.cs</a> </div><p>Source: <a href="https://habr.com/ru/post/276455/">https://habr.com/ru/post/276455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276445/index.html">RainyJs - as Angular, only for Ajax</a></li>
<li><a href="../276447/index.html">As I wrote the game for 3 years</a></li>
<li><a href="../276449/index.html">A small comparison of online translators</a></li>
<li><a href="../276451/index.html">Ivan Grigorov: ‚ÄúFor top baghunters $ 25K per month is not a problem‚Äù</a></li>
<li><a href="../276453/index.html">New options for opening and closing tabs in the assembly Vivaldi 1.0.385.5</a></li>
<li><a href="../276457/index.html">Create 2D tile maps in QML. Part 1</a></li>
<li><a href="../276459/index.html">Hack PayPal in 73 seconds</a></li>
<li><a href="../276461/index.html">Oracle will take part in the presentation of the program "Single frontal system"</a></li>
<li><a href="../276467/index.html">Dosimeter on the Internet of Things: we make a map of radioactive zones for ourselves and the whole world</a></li>
<li><a href="../276469/index.html">Product Design Digest, January 2016</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>