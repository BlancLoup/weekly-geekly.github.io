<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fast integer division by constant</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All CPU division operation is relatively slow, nothing can be done about it. But if the divisor is a constant, then the division can be replaced by mu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fast integer division by constant</h1><div class="post__text post__text-html js-mediator-article">  All CPU division operation is relatively slow, nothing can be done about it.  But if the divisor is a constant, then the division can be replaced by multiplication by some other constant (the inverse number, which is calculated at compile time).  Then the code will work a little faster (and consume less energy).  Many compilers (gcc, MSVC) do this optimization, but it turns out that many developers do not know how the multiplier is calculated, and this is not trivial. <br><br>  Further it will be described how the factor is calculated. <br><br><a name="habracut"></a><br><h5>  Idea and case for real numbers </h5><br>  For example, if in the code <i>double x = a / 2.5</i> , then this can be replaced by <i>x = a * (1.0 / 2.5)</i> or <i>x = a * 0.4</i> .  The code will be faster, but sometimes less accurate.  For integers such a trick in the forehead does not work, tk.  the factor will be less than one (those zero).  You can use fixed-point numbers (mantissa <i>N</i> ): <i>int x = a / b = a * B &gt;&gt; N, where B = (1 &lt;&lt; N) / b</i> .  The problem is that sometimes so calculated x will be 1 different from the correct answer, which is unacceptable for integers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Algorithm </h5><br>  For simplicity, we will work only with non-negative numbers.  Mathematical wording: <br><br>  For a known integer <b>b,</b> find such a pair of integers <b>M, B</b> so that for all integers <b>a</b> : <i>0 ‚â§ a &lt;(1 &lt;&lt; <b>N</b> )</i> , <b>x</b> = <i>[a / b] = [a * B &gt;&gt; M]</i> , where [] is an integer the part, <i>and &gt;&gt; M</i> is to divide <i>a</i> by 2 to the power of <i>M</i> (and &lt;&lt; multiply). <br><br>  We write <i>1.0 / b</i> in binary form (sometimes an infinitely long number), the first <i>M</i> bits of which we denote as integer <b>C</b> , the remaining bits (tail-remainder) as <b>D</b> , those <i>1.0 / b = C &gt;&gt; M + D, D &lt;(1&gt; &gt; M)</i> . <br><br>  Let's see what happens if <i>B = C</i> and <i>a * D ‚â§ 1</i> (those <i>N ‚â§ M</i> ): <br><br>  <i>x = [a / b] = [a * (C &gt;&gt; M + D)] = [a * C &gt;&gt; M + a * D] ‚â• [a * C &gt;&gt; M] + [a * D] = [ a * C &gt;&gt; M]</i> <br><br>  It turns out that if <i>B</i> is the first <i>M</i> bits of the number <i>1 / b</i> , and the remaining bits are discarded (replaced by zeros), then we will sometimes get the correct values, and sometimes 1 less than <i>x</i> .  This happens because <i>a * D is</i> dropped, which, although less than one, can still change the integer part. <br><br>  Let's try to increase <i>B</i> by one (those <i>B = C + 1</i> ), then: <br><br>  <i>[a * (C + 1) &gt;&gt; M] = [a * C &gt;&gt; M + a * (1 &gt;&gt; M)] ‚â• [a * C &gt;&gt; M + a * D] = [a * (C&gt; &gt; M + D)] = [a / b] = x</i> <br><br>  Now it turns out that we will sometimes get the correct answer <i>x</i> , and sometimes 1 more. <br><br>  It may seem that it is impossible to accurately calculate <i>x</i> through multiplication because at one approximation there will sometimes be numbers 1 less than necessary, with the other 1 more.  But it is not.  After all, <i>a</i> is integers, and the maximum fractional part of <i>a / b</i> is exactly <i>(b-1) / b</i> , and in the calculations of <i>x</i> it increases by <i>a * ((1 &gt;&gt; M) - D)</i> .  Yeah, so if <i>a * ((1 &gt;&gt; M) - D) &lt;1 / b</i> then the inequality turns into equality !!!  Let the number <b><i>L be</i></b> such that <i>(1 &lt;&lt; L) ‚â• b</i> , then for equality it is enough <i>(1 &gt;&gt; M) ‚â§ (1 &gt;&gt; (L + N))</i> or <i>M ‚â• L + N.</i> <br><br><h5>  Java example </h5><br>  In the example, the divisor is 127 ( <i>L</i> = 7).  The result of multiplying by JVM should fit in 32 bits, choose <i>N</i> = (32 - 7) / 2 = 12. Example: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> N = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divideBy127</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">127</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> L = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> B = ((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; (N + L)) / b) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a * B) &gt;&gt;&gt; (N + L); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size = <span class="hljs-number"><span class="hljs-number">20000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> times = <span class="hljs-number"><span class="hljs-number">10001</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[size]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; size; ++i) data[i] = (i * i) &amp; ((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; N) - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// fill by any random data for (int iteration = 0; iteration &lt; 10; ++iteration) { long time0 = System.currentTimeMillis(); // Test 1: Using div int v0 = 0; for (int j = 0; j &lt; times; ++j) for (int i = 0; i &lt; size; ++i) v0 ^= data[i] / 127; // keep result long time1 = System.currentTimeMillis(); // Test 2: Using mul int v1 = 0; for (int j = 0; j &lt; times; ++j) for (int i = 0; i &lt; size; ++i) v1 ^= divideBy127(data[i]); // keep result long time2 = System.currentTimeMillis(); System.out.println((time1 - time0) + " vs " + (time2 - time1) + " " + (v0 - v1)); } }</span></span></code> </pre> <br><br>  On my Intel Core-i5 2500, JVM 1.7.0u5 with JIT and the -XX option: + AggressiveOpts the division test works <b>2 times slower</b> than with multiplication. <br><br><h5>  Addition </h5><br><br>  The rest of the topic is not considered in this article: <br><ul><li>  the dividend may be negative; </li><li>  how to avoid overflow when multiplying; </li><li>  the result of multiplying integers by x86 takes 64-bits and under certain conditions you can remove the shift to the right; </li><li>  if it is known that the numbers are completely divided, then another algorithm can be used; </li><li>  in some cases, multiplication can be replaced by left shifts and additions; </li><li>  special cases for some dividers with even faster execution speed. </li></ul><br><h5>  Literature </h5><br>  <a href="http://gmplib.org/~tege/divcnst-pldi94.pdf">"Division by Invariant Integers using Multiplication", Torbjorn Granlund, Peter L. Montgomery</a> - formal proof and some more algorithms on the topic. </div><p>Source: <a href="https://habr.com/ru/post/147096/">https://habr.com/ru/post/147096/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147090/index.html">Customizing ProgressBar to Android</a></li>
<li><a href="../147091/index.html">Microsoft expands access to Windows Azure in Russia</a></li>
<li><a href="../147092/index.html">Rating java frameworks compiled by the developers themselves</a></li>
<li><a href="../147093/index.html">User rating by several parameters</a></li>
<li><a href="../147095/index.html">A simple bash solution for sharing music and photos on Dropbox</a></li>
<li><a href="../147097/index.html">How to make your life easier in Xcode. Shortcuts, tips & tricks</a></li>
<li><a href="../147098/index.html">11 "recipes for cooking" MySQL in Bitrix24</a></li>
<li><a href="../147100/index.html">Higgs Boson and Mass Transfer</a></li>
<li><a href="../147101/index.html">Stas Protasov from Parallels answered the questions of the habrasoobshchestva</a></li>
<li><a href="../147103/index.html">Runetology (154): Nikate Androsov, Head of Ingate</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>