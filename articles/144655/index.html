<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic server cloning to virtual machines by cron</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Formulation of the problem 
 Description of the problem 
 The work uses a large number of physical servers based on Debian GNU / Linux. Developers oft...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic server cloning to virtual machines by cron</h1><div class="post__text post__text-html js-mediator-article"><h2>  Formulation of the problem </h2><br><h4>  Description of the problem </h4><br>  The work uses a large number of physical servers based on Debian GNU / Linux.  Developers often need to be provided at the mercy of clones of these servers, each time it is inefficient to clone with their hands.  Note: the specific distribution is not important for the described method, the method is very easily adapted to any distribution. <br><br>  <i>picture for beauty</i> <br><img src="https://habrastorage.org/storage2/0d6/aae/486/0d6aae48623bd81daea628e8ef7ed274.png"><br><br><h4>  Task </h4><br>  Make an automatic cloning system of combat servers into virtual machines by crown. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  What happened </h2><br><pre><code class="bash hljs">virt_server&gt; p2v.py foo full WORKING WITH SERVER: <span class="hljs-string"><span class="hljs-string">'foo'</span></span> READING CONFIG FOR <span class="hljs-string"><span class="hljs-string">'foo'</span></span> CHECKING LOCAL CONFIG CHECKING LOCAL CONFIG FOR <span class="hljs-string"><span class="hljs-string">'foo'</span></span> COMPLETED SUCCESSFULLY CHECKING REMOTE CONFIG CHECKING NODUMP FLAG: <span class="hljs-string"><span class="hljs-string">"lsattr -d /home/backupman/dumps | egrep '[\\w-]+d[\\w-]+[ ]/data/dumps'"</span></span> CHECKING REMOTE DUMP: <span class="hljs-string"><span class="hljs-string">'sudo /sbin/dump a0f /dev/null /dev/null'</span></span> CHECKING IF WE ARE ABLE TO SSH TO: <span class="hljs-string"><span class="hljs-string">"ssh -T backupman@foo 'if [ -d /data/dumps ] ; then exit 0 ; else exit 1 ; fi'"</span></span> CHECKING REMOTE CONFIG FOR <span class="hljs-string"><span class="hljs-string">'foo'</span></span> COMPLETED SUCCESSFULLY DUMPING FILESYSTEMS GETTING THE DUMPS STOPPING VM: foo2 MAKING FS TYPE: ext3 ON PARTITION: /dev/mapper/foo RESTORING DUMPS FOR: foo INSTALLING BOOTLOADER FOR: foo RESTORING CONFIG FOR: foo STARTING VM: /etc/xen/foo.xm</code> </pre> <a name="habracut"></a><br><h2>  How come </h2><br><h4>  Battle Server Cloning Process </h4><br>  I consider the following to be the simplest and fastest way to clone a combat server without stopping it: <br><ul><li>  Creation of its dump on the server itself using the <code>dump</code> utility.  Considerations are as follows: <br><ul><li>  Possible problems when dumping a live file system for a virtual machine are not terrible, this is not a backup.  By experience, in practice, I have not yet encountered problems with beaten files. </li><li>  Server dump is done quickly, which is important </li></ul></li><li>  Copy dump to server with virtual machines.  I use <code>scp</code> , because  at our speeds, the network is still the bottleneck, and therefore the cost of encrypting files during transmission is not terrible </li><li>  Expanding a dump to a pre-allocated LVM partition using the <code>restore</code> utility </li><li>  Install the bootloader </li><li>  Copying configs relevant to a virtual machine ( <code>/etc/network/interfaces, /etc/hostname, /etc/mailname, /etc/aliases</code> , etc.) </li><li>  Running a freshly prepared virtual machine. </li></ul><br>  The virtualization system used is completely unimportant, the only requirement for it is to be able to provide the virtual machine with an LVM partition as a virtual disk.  I personally use XEN. <br><br>  For clarity, I will give an example.  Suppose that we have a virtual machine server <code>virt_server</code> , as well as a physical server that needs to be cloned, <code>server1</code> . <br><ul><li>  The XEN configuration for <code>server1</code> clone lies on <code>virt_server</code> in <code>/etc/xen/server1.xm</code> </li><li>  The LVM partition of the <code>server1</code> virtual machine is: <code>/dev/mapper/server1</code> </li><li>  We will do <code>server1:/dumps/server1/</code> in <code>server1:/dumps/server1/</code> , and copy to <code>virt_server:/dumps/server1</code> </li><li>  <code>server1</code> 'll keep the <code>virt_server:/dumps/server1/cfg/</code> in <code>virt_server:/dumps/server1/cfg/</code> </li></ul><br>  In order for everything to work, on <code>server1</code> you need to add the user <code>backupman</code> , and allow him to <code>sudo dump</code> without a password.  On <code>virt_server</code> you need to configure key authentication to <code>backupman@server1</code> .  On <code>virt_server</code> we will do everything from under root. <br><br>  With this configuration from the console, the cloning procedure looks like this: <br><br><pre> <code class="bash hljs">root@virt_server&gt; xm destroy server1 root@virt_server&gt; ssh backupman@server1 backupman@server1$ sudo dump -a0f /dumps/server1.root / backupman@server1$ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> var usr home ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> sudo dump a0f /dumps/server1.<span class="hljs-variable"><span class="hljs-variable">$i</span></span> /<span class="hljs-variable"><span class="hljs-variable">$i</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> backupman@server1$ <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> root@virt_server&gt; scp backupman@server1:/dumps/server1.* /dumps/server1/ root@virt_server&gt; mkfs.ext4 /dev/mapper/server1 root@virt_server&gt; mount /dev/mapper/server1 /mnt/server1 root@virt_server&gt; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt/server1 root@virt_server&gt; restore -rf /dumps/server1.root root@virt_server&gt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> var usr home ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt/<span class="hljs-variable"><span class="hljs-variable">$i</span></span> &amp;&amp; restore /dumps/server1.<span class="hljs-variable"><span class="hljs-variable">$i</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> root@virt_server&gt; dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/usr/share/syslinux/mbr.bin of=/dev/mapper/server1 root@virt_server&gt; extlinux --install /dev/mapper/server1 root@virt_server&gt; scp -R /dumps/server1/cfg/* /mnt/server root@virt_server&gt; xm start server1.xm</code> </pre> <br><h4>  Process automation </h4><br>  Now that the server‚Äôs cloning algorithm is clear, you can start writing a script.  Work with the script will be as follows: <br><ul><li>  The script config describes the cloning of each server. </li><li>  The script arguments specify the server name and the required action. </li><li>  Skrpit reads the config section named for the server, then does automatic cloning of the server and starting the virtual machine </li><li>  The script runs on the crown at night. </li><li>  ???? </li><li>  Benefit! </li></ul><br><h4>  Configure the virtual machine server and the cloned server </h4><br>  On the virtual machine server, do the following: <br><ul><li>  Create a disk partition for the virtual machine </li><li>  Create a virtual machine configuration file </li><li>  Create a script configuration file </li></ul><br>  On the cloned server, do the following: <br><ul><li>  Install <code>dump</code> utility </li><li>  Create <code>backupman</code> user </li><li>  Allow this user to run a dump by adding the following to / etc / sudoers: <code>backupman ALL=NOPASSWD: /sbin/dump</code> </li><li>  Create a dump directory </li><li>  Make <code>chattr +d</code> directory on this directory so that the dumps are not dumped </li><li>  Allow ssh from the north of virtual machines to the cloned server by keys </li></ul><br><h4>  Script config </h4><br>  The config in the standard .ini format is placed in the directory with the script.  It looks like this: <br><pre> <code class="bash hljs">[server1] vm_config = /etc/xen/server1.xm vm_name = server1 ssh = backupman@server1.site scp = backupman@server1.site dumps_list = /,/var,/usr,/home remote_dumps_dir = /home/bakupman/dumps local_dumps_dir = /dumps/server1 mount_dir = /mnt/server1 partition = /dev/mapper/server1 fs = ext3</code> </pre><br>  You should give a small explanation of the parameters <code>ssh</code> and <code>scp</code> .  These parameters define the format of the <code>ssh</code> and <code>scp</code> call, respectively, and both are needed because  the <code>ssh</code> port will get the <code>-p</code> key, and the <code>scp</code> key will have the <code>-P</code> key. <br><br><h4>  Script itself </h4><br>  I don‚Äôt see the point of bringing the script in full, because  I posted it on github, so I will only describe the work of the script as a whole. <br><br>  The script takes as input two parameters, namely the name of the server, which is the name of a section in the configuration file, and the required action. <br><br>  Here is the main function that allows you to specify which actions we want to take.  You can check the configuration, make a full clone, make server dumps, or deploy existing dumps. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Main function, calls all other ones"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'Usage: %s &lt;servername&gt; &lt;action&gt; (check|full|dump|get|restore)'</span></span> % sys.argv[<span class="hljs-number"><span class="hljs-number">0</span></span>]) server = sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] action = sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"\nWORKING WITH SERVER: %r\n"</span></span> % server <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> action == <span class="hljs-string"><span class="hljs-string">"check"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: conf=read_config(server) check_config_local(conf) check_config_remote(conf <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception, e: sys.exit(<span class="hljs-string"><span class="hljs-string">"\nERROR: %r\n"</span></span> % e) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> action == <span class="hljs-string"><span class="hljs-string">"full"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: conf=read_config(server) check_config_local(conf) check_config_remote(conf) stop_vm(conf) dump_physical(conf) get_dumps(conf) restore_vm(conf) install_bootloader(conf) restore_config(conf) start_vm(conf) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception, e: cleanup(conf) sys.exit(<span class="hljs-string"><span class="hljs-string">"\nERROR: %r\n"</span></span> % e) &lt;...&gt;</code> </pre><br>  All script work is structured in such a way that if some action cannot be performed, an exception is thrown and the script ends with an error message. <br><br>  The configuration specified in the configuration file is checked, and if something is wrong, the script ends.  If everything is in order, then skrpit simply executes all those commands that can be entered from the console, checking the status of their completion. <br><br>  The most "difficult" part of the script are checks.  I would like to draw attention to this fragment: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_config_local</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conf)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Checks config by trying to ssh, checking existence of local and remote folders, destination partition, mount point, and remote dump utility"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"\nCHECKING LOCAL CONFIG\n"</span></span> <span class="hljs-comment"><span class="hljs-comment"># check for ensuring we won't delete accidentaly specified host os parittion if conf['partition'] == "/dev/sda" or conf['partition'] == "/dev/sda1" or \ conf['partition'] == "/dev/sda2" or conf['partition'] == "/dev/sda3" or \ conf['partition'] == "/dev/sda4" or conf['partition'] == "/dev/sda5": raise Exception, "DON'T KILL THE SERVER! %S IS A SYSTEM PARTITION!!" % conf['partition']</span></span></code> </pre><br>  I have an operating system on the virtual machine server installed on these partitions, LVM was made for the virtual machines themselves.  Because  When a virtual machine is deployed on a partition destined for it, a new file system is created, then in order to protect against the accidental destruction of the virtual machine server, enter your system partitions here. <br><br><h2>  github </h2><br>  That's it, you can get the script here: <a href="https://github.com/sistemshik/p2v">github.com/sistemshik/p2v</a> </div><p>Source: <a href="https://habr.com/ru/post/144655/">https://habr.com/ru/post/144655/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144649/index.html">Released free professional video editor Lightworks</a></li>
<li><a href="../144651/index.html">Groupon is testing its own mobile payment terminal.</a></li>
<li><a href="../144652/index.html">How to write articles about programming for beginners</a></li>
<li><a href="../144653/index.html">Loop Sequencer for Android</a></li>
<li><a href="../144654/index.html">EPAM Open Day Cloud Computing Organizational Report</a></li>
<li><a href="../144656/index.html">Weekly Digest # 5: Simple-Science - Simple Experiments</a></li>
<li><a href="../144660/index.html">Overview of the Toshiba Portege Z830 Ultrabook based on the Intel Core i3 processor</a></li>
<li><a href="../144662/index.html">Droider Show # 42. Hidden threat</a></li>
<li><a href="../144663/index.html">Using Sandbox on Mac OS X Server to isolate custom web applications</a></li>
<li><a href="../144664/index.html">ViewSonic is preparing a 22 "tablet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>