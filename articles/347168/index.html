<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Routing in socks. Another way</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Consider another way to route a local network through a socks proxy. Unlike the previous method with ‚Äúredsocks‚Äù, this will consider the possibility of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Routing in socks. Another way</h1><div class="post__text post__text-html js-mediator-article">  Consider another way to route a local network through a socks proxy.  Unlike the <a href="http://habrahabr.ru/post/345418/">previous method</a> with ‚Äúredsocks‚Äù, this will consider the possibility of routing at the network level (the OSI network model), using the ‚Äúbadvpn-tun2socks‚Äù package.  This article focuses on the creation and continuous use of such a router based on the Debian stretch OS. <br><br>  Before proceeding to the description of the system settings, I will provide a <a href="https://code.google.com/archive/p/badvpn/downloads">link to the badvpn sources</a> (maybe someone will need it). <br><br>  So, after downloading and building the package, I suggest immediately creating a systemd service with the following content: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">cat /etc/systemd/system/tun2socks.service [Unit] Description=Start tun2socks [Service] ExecStart=///badvpn-tun2socks --tundev tun0 --netif-ipaddr 10.0.0.2 --netif-netmask 255.255.255.0 --socks-server-addr 127.0.0.1:1080 [Install] WantedBy=multi-user.target</code> </pre> <br>  Here, in the launch option " <i>--socks-server-addr 127.0.0.1:1080</i> " you can see that "tun2socks" will send requests to the address of the socks-proxy server.  (For example, ssh-tunnel from the <a href="http://habrahabr.ru/post/345418/">previous method</a> ). <br><br>  The parameters " <i>--netif-ipaddr 10.0.0.2</i> " and " <i>--netif-netmask 255.255.255.0</i> " are responsible for creating a "tun2socks router" with the address 10.0.0.2 to which requests will come from the virtual interface specified in the parameter " <i>- -tundev tun0</i> ". <br>  For understanding, I will give the modest scheme: <br><br><pre> <code class="bash hljs">+----------+ +-----------+ +----------------+ +------------+ | tun0 |____| tun2socks |___| socks |______| ssh-server | | 10.0.0.1 | | 10.0.0.2 | | 127.0.0.1:1080 | | *pubic ip* | +----------+ +-----------+ +----------------+ +------------+ | +----------+ +-----------+ +----------------+ | NAT |____| dhcpd/ |___| LAN | | iptables | | wlp6s0 | | 192.168.1.0/24 | +----------+ +-----------+ +----------------+</code> </pre> <br>  " <b>tun0</b> " is a virtual interface that needs to be configured on the system, requests from the local network \ host will come to it.  Let's make it standard for Debian: <br><a name="habracut"></a><br><pre> <code class="bash hljs">cat /etc/network/interfaces auto lo auto wlp6s0 auto tun0 <span class="hljs-comment"><span class="hljs-comment">#   iface wlp6s0 inet static address 192.168.1.2 netmask 255.255.255.0 gateway 192.168.1.1 wpa-driver wext wpa-conf /etc/wpa_supplicant.conf #   tun2socks pre-down systemctl stop tun2socks #    pre-down ip tuntap del dev tun0 mode tun #    pre-up ip tuntap add dev tun0 mode tun user root #   tun2socks pre-up systemctl start tun2socks &amp; #   iface tun0 inet manual #  ip  pre-up ip addr add dev tun0 10.0.0.1/24 #       DNS  up ip route add &lt;dns-server-ip-address&gt; via 192.168.1.1 #    SSH  up ip route add &lt;ssh-server-ip-address&gt; via 192.168.1.1 #      up ip route del default #       tun2socks up ip route add default via 10.0.0.2</span></span></code> </pre> <br>  As you can see from the listing created earlier by the ‚Äútun2socks‚Äù service, it controls the status of the ‚Äúwlp6s0‚Äù interface.  This is done because the running service ‚Äútun2socks‚Äù works in conjunction with the virtual interface ‚Äútun0‚Äù, therefore, it becomes impossible to delete the virtual interface without stopping the service and as a result of the normal operation of the system initialization of network interfaces. <br><br>  Pay attention to the lines " <i>up ip route add &lt;dns-server-ip-address&gt; via 192.168.1.1</i> " and " <i>up ip route add &lt;ssh-server-ip-address&gt; via 192.168.1.1</i> ".  In them, instead of the values ‚Äã‚Äã" <i>&lt;dns-server-ip-address&gt;</i> " and " <i>&lt;ssh-server-ip-address&gt;</i> ", specify the ip addresses of the DNS and SSH servers used, and replace the ip address of "192.168.1.1" according to the current gateway default. <br><br>  It does not hurt to include support for routing at the kernel level, in the /etc/sysctl.conf file: <br><pre> <code class="bash hljs">net.ipv4.ip_forward=1</code> </pre> <br>  And apply the changes with the command: <br><pre> <code class="bash hljs">sysctl -p /etc/sysctl.conf</code> </pre> <br>  On this, the tun2socks configuration will be completed. After restarting the network interface service, all outgoing TCP traffic from the host will be sent through a socks proxy server.  The next and final step will be the routing of the local network using the dhcp server, the installation and configuration of which I discussed in the <a href="http://habrahabr.ru/post/345418/">previous method</a> , as well as the NAT configuration using iptables. <br><br>  You must create a file with the following content: <br><br><pre> <code class="bash hljs">cat /etc/iptables.test.rules *filter -A FORWARD -i tun0 -o wlp6s0 -m state --state RELATED,ESTABLISHED -j ACCEPT -A FORWARD -i wlp6s0 -o tun0 -j ACCEPT COMMIT *nat -A POSTROUTING -o tun0 -j MASQUERADE COMMIT</code> </pre><br>  If necessary, change the names of the interfaces according to your system and use it with the command: <br><br><pre> <code class="bash hljs"> iptables-restore &lt; /etc/iptables.test.rules</code> </pre> <br>  Check the work from the local network, if everything suits, save the rules: <br><br><pre> <code class="bash hljs"> iptables-save &gt; /etc/iptables.rules</code> </pre> <br>  Add script to: <br><br><pre> <code class="bash hljs">cat /etc/network/<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-pre-up.d/iptables <span class="hljs-comment"><span class="hljs-comment">#!/bin/sh iptables-restore &lt; /etc/iptables.rules</span></span></code> </pre><br>  And make it executable: <br><br><pre> <code class="bash hljs">chmod +x /etc/network/<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-pre-up.d/iptables</code> </pre> <br>  Now these rules will be applied after booting, and you will have a Debian-based router at your disposal, excellent for circumventing censorship and / or securing LAN connections. </div><p>Source: <a href="https://habr.com/ru/post/347168/">https://habr.com/ru/post/347168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347154/index.html">Service control panel. Part 2. On the way to the frontend</a></li>
<li><a href="../347158/index.html">Even faster acceleration of WebAssembly: new streaming and layered compiler in Firefox</a></li>
<li><a href="../347160/index.html">Quantum race: 2017 developments</a></li>
<li><a href="../347162/index.html">Sales experience for recruiting in IT</a></li>
<li><a href="../347166/index.html">Why experienced developers write a stupid code and how to recognize a beginner per kilometer</a></li>
<li><a href="../347170/index.html">Making games in Python 3 and Pygame: Part 2</a></li>
<li><a href="../347174/index.html">Not a webpack</a></li>
<li><a href="../347180/index.html">Convert from Sketch to PSD</a></li>
<li><a href="../347182/index.html">Digital events in Moscow from January 22 to 28</a></li>
<li><a href="../347184/index.html">Generative Modeling and AI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>