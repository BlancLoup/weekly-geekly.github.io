<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Go sync.Pool</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Free retelling of documentation for sync.Pool 

 The garbage collector (hereinafter referred to as GC) does not constantly collect garbage, but at reg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Go sync.Pool</h1><div class="post__text post__text-html js-mediator-article"> Free retelling of documentation for <a href="https://godoc.org/sync">sync.Pool</a> <br><a name="habracut"></a><br>  The garbage collector (hereinafter referred to as GC) does not constantly collect garbage, but at regular intervals.  If your code allocates memory for some data structures, and then frees them - and so on a circle - this causes a certain pressure on the GC, including making the <code>runtime</code> turn to the OS for allocating new memory.  Imagine: select a <em>piece</em> (for example <code>[]byte</code> ), work with it, release it.  It will take some time before the GC "wakes up from sleep" and collect this <em>piece</em> .  If at this time we allocate one more such <em>piece</em> and the memory already allocated to the OS is not enough for it, then the application will have to ask the OS for more memory.  By the time the application memory request from the OS lasts forever.  And at this very time, somewhere gathering dust, the old "spent" <em>piece</em> is waiting for its time. <br>  What to do? <br><br><ul><li>  create pool </li><li>  reset the state of the <em>piece</em> </li><li>  pool the waste <em>pieces</em> </li><li>  take new <em>pieces</em> from the pool </li></ul><br><h5>  Create pool </h5><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span>( <span class="hljs-string"><span class="hljs-string">"sync"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bytesPool = sync.Pool{ New: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interface</span></span></span></span>{} { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>{} }, } <span class="hljs-comment"><span class="hljs-comment">/*     `New`  .   ,  `New`  `nil` -        .      `interace{}` -    .   -    . */</span></span></code> </pre> <br><h5>  Reset state </h5><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//  ary   []byte     ary = ary[:0] //  len,  cap</span></span></code> </pre> <br><h5>  Put in pool </h5><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">/*          ,       (    ) -  ; :   2048        500-800 ,         -        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> maxCap = <span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>(ary) &lt;= maxCap { <span class="hljs-comment"><span class="hljs-comment">//       bytesPool.Put(ary) }</span></span></code> </pre> <br><h5>  Take from the pool </h5><br><pre> <code class="go hljs">nextAry := bytesPool.Get().([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)</code> </pre> <br><h5>  Explanation about New </h5><br>  The <code>New</code> function creates an empty <code>[]byte{}</code> , and even these conversions to <code>interface{}</code> and vice versa.  In the case of <code>[]byte</code> we are likely to increase it with the help of <code>append</code> , which in principle makes such an approach unprofitable: <br><br><ul><li>  creating <code>[]byte</code> zero capacity </li><li>  double conversion to <code>interface{}</code> and back </li><li>  <code>append</code> will still create a new piece. </li><li>  <code>append</code> can be fed <code>nil</code> , <a href="http://play.golang.org/p/P6ZqGE91a2">only of type [] byte (and not interface {})</a> </li></ul><br>  It is much more convenient to make two functions that would deal with all the mess with the pool. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//  func getBytes() (b []byte) { ifc := bytesPool.Get() if ifc != nil { b = ifc.([]byte) } return } //  func putBytes(b []byte) { if cap(b) &lt;= maxCap { b = b[:0] //  bytesPool.Put(b) } }</span></span></code> </pre> <br><h5>  Remember </h5><br><ul><li>  <code>sync.Pool</code> not a panacea </li><li>  pool is gorutino-safe </li><li>  the pool will not necessarily release the data when the GC first wakes up, but it can free them at any time </li><li>  it is not possible to determine and set the size of the pool </li><li>  no need to worry about pool overflow </li><li>  There is no need to pool the pool anywhere, it was created as a shock absorber with multiple sharing of some common objects, not even just inside the package, but even more - in other packages. </li><li>  you probably have or will be situations where the need / opportunity to help the GC will be obvious </li><li>  a pool of limited size is made using a <a href="http://play.golang.org/p/c7DtgZtq0E">pipe with a buffer</a> </li></ul><br>  A good example of using a pool is the <a href="https://godoc.org/fmt">fmt</a> package.  From the <a href="">109th</a> to the 150th row. <br><br><hr></div><p>Source: <a href="https://habr.com/ru/post/277137/">https://habr.com/ru/post/277137/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277125/index.html">Results of 2015: IT industry</a></li>
<li><a href="../277127/index.html">Record of the webinar "Centralized Management with MyKerio"</a></li>
<li><a href="../277129/index.html">Understanding garbage collection and memory leak detection in Node.js</a></li>
<li><a href="../277131/index.html">A series of technical webinars: "Managing server and personal security in Kerio Connect"</a></li>
<li><a href="../277135/index.html">Fortinet framework for protection against advanced threats</a></li>
<li><a href="../277139/index.html">Cisco ASA Critical Vulnerability: What is the Problem, and How to Protect</a></li>
<li><a href="../277141/index.html">Like this - to be a software developer for cars. Part 1/2</a></li>
<li><a href="../277143/index.html">[Bookmark] Algorithms and data structures in the Linux kernel, Chromium and not only</a></li>
<li><a href="../277145/index.html">The simplest self-learning algorithms in the language "Author"</a></li>
<li><a href="../277147/index.html">An open proctoring system for remote tracking of online exams</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>