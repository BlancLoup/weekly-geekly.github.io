<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Facebook's sixth sense</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chrome extension shows when someone types 


 Some people spend too much time on social networks. So much so that they already have a dependency. One ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Facebook's sixth sense</h1><div class="post__text post__text-html js-mediator-article"><h3>  Chrome extension shows when someone types </h3><br><img src="https://habrastorage.org/files/64e/325/dfb/64e325dfbed6484bbed294822dd81311.jpg"><br><br>  Some people spend too much time on social networks.  So much so that they already have a dependency.  One of these is programmer Alexander Kirzenberg (Alexandre Kirszenberg), who also likes to dig into the guts of Facebook ‚Äî in JavaScript code that is responsible for the user interface and communication. <br><br>  ‚ÄúA couple of months ago, I thought about a small status indicator that shows when one of your friends is typing you a text, <a href="http://kirszenberg.com/facebook-sixth-sense">‚Äù</a> Alexander <a href="http://kirszenberg.com/facebook-sixth-sense">writes</a> .  - Such a small extension UI gives a lot of information about the interlocutor.  If the indicator lights up several times and goes out, this indicates indecision.  If he caught fire for a long time, someone writes you a great essay.  And there is nothing worse than that painful feeling when the indicator goes out and no longer lights up. ‚Äù <br><a name="habracut"></a><br>  First of all, Alexander decided to find out if Facebook sends notifications that someone is typing messages on Facebook Messenger, even if you do not have this Facebook Messenger running.  It turned out that sends. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All friends are sent <code>typ</code> event ‚Äúlong poll‚Äù <code>/pull</code> (long polling).  A small study showed that the event is really sent out for <i>each chat</i> , even if the recipient did not open it and never received it. <br><br>  This is how the <a href="https://chrome.google.com/webstore/detail/facebook-sixth-sense/neghghjdkheikbfclgnglicflldmejio">Facebook</a> expansion of the <a href="https://chrome.google.com/webstore/detail/facebook-sixth-sense/neghghjdkheikbfclgnglicflldmejio">Sixth Sense</a> for Chrome browser appeared.  It shows right in the browser when someone types a message on Facebook. <br><br><img src="https://habrastorage.org/files/8dd/509/92a/8dd50992aff74129af43255a3c06b566.jpg"><br><br>  The programmer used undocumented Facebook API to create this extension.  I had to deal with the JavaScript code, which Facebook ruthlessly minimizes, turning into a jumble of characters. <br><br>  First, he found out which modules Facebook imports through the program interface of the <a href="">Asynchronous Module Definition</a> module organization system for asynchronous loading (Facebook has its own implementation of AMD).  Modules and dependencies are defined by the standard function <code>__d(name, dependencies, factory)</code> .  There are also <code>require</code> and <code>requireLazy</code> for importing modules. <br><br>  The easiest way to see how this works is in the browser console (although Facebook strictly prohibits it).  It seems that serious guys work there, it‚Äôs better not to joke with them. <br><br><img src="https://habrastorage.org/files/b8e/fc1/1b3/b8efc11b31334b9ba6033ead43dc0092.png"><br><br>  But we still dare. <br><br><img src="https://habrastorage.org/files/c3b/573/528/c3b573528a934a55b11e9575f3db4fe9.png"><br><br>  As you can see, Facebook always loads the latest version of <a href="https://github.com/facebook/react">React</a> - an excellent library of user interface components.  Facebook uses React quite extensively throughout the site.  There are <a href="https://facebook.github.io/react/blog/2015/10/07/react-v0.14.html">more than 15,000 React components</a> in the Facebook code (as of October 2015). <br><br>  In the source code, you can search for <code>__d(</code> and see the list of modules available for import. For the main page there are only 3000 modules. <br><br>  The Facebook Messenger chat, of course, also uses React components.  We need to intercept typing notifications.  For a more detailed study of the code, Alexander Kirzenberg recommends using the <a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi%3Fhl%3Den">React Developer Tools</a> tool. <br><br><img src="https://habrastorage.org/files/ab3/2c9/20c/ab32c920c8794ef5a714f178e343bf4b.jpg"><br><br><img src="https://habrastorage.org/files/361/8a6/073/3618a60734db4b3988b0ab733fab5139.jpg"><br><br>  After installing this extension, a new React tab appears in the Chrome developer tools.  On it we select the chat. <br><br><img src="https://habrastorage.org/files/56d/564/273/56d56427300a4c73966ff1e2086958ac.jpg"><br><br>  Here, among the various components of Facebook Messenger, we are looking for a typing indicator, it is located between <code>&lt;ChatTabComposerContainer /&gt;</code> and <code>&lt;MercuryLastMessageIndicator /&gt;</code> . <br><br>  Search <code>__d('ChatTyping</code> in the code base React finds two modules: <code>ChatTypingIndicator.react.js</code> and <code>ChatTypingIndicators.react.js</code> . This is exactly what we need, says Kirzenberg. He notices that some modules are loaded as needed, so <code>ChatTypingIndicators.react.js</code> can only be found from the second time. <br><br>  Here is his code. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> k = c(<span class="hljs-string"><span class="hljs-string">'MercuryThreadInformer'</span></span>).getForFBID(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.viewer) , l = c(<span class="hljs-string"><span class="hljs-string">'MercuryTypingReceiver'</span></span>).getForFBID(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.viewer); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._subscriptions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (c(<span class="hljs-string"><span class="hljs-string">'SubscriptionsHandler'</span></span>))(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._subscriptions.addSubscriptions( l.addRetroactiveListener( <span class="hljs-string"><span class="hljs-string">'state-changed'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.typingStateChanged ), k.subscribe( <span class="hljs-string"><span class="hljs-string">'messages-received'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.messagesReceived ) ); },</code> </pre> <br>  Namely, we are interested in calling <code>c('MercuryTypingReceiver')</code> . <br><br>  In the console, you can see how it works. <br><br><pre> <code class="hljs lua">&gt; MercuryTypingReceiver.getForFBID // <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i)</span></span></span></span>{var j=this._getInstances();<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!j[i])j[i]=new this(i);<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> j[i];} &gt; MercuryTypingReceiver.get // <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.getForFBID(c(<span class="hljs-string"><span class="hljs-string">'CurrentUser'</span></span>).getID());}</code> </pre> <br>  To check how the status indicator works, Alexander used the Messenger application on his own smartphone to send the corresponding events to his PC and catch them in the console. <br><br>  <code>MercuryThreads</code> studying the code in more detail, he found two more useful modules <code>MercuryThreads</code> and <code>ShortProfiles</code> .  The first one gets all the information about the Messenger thread by its ID, the second one does the same for the profile. <br><br>  In general, after all the research, this is what the final extension code for Chrome looks like, just 40 lines. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fbid</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fbid.split(<span class="hljs-string"><span class="hljs-string">':'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>]; } requireLazy( [<span class="hljs-string"><span class="hljs-string">'MercuryTypingReceiver'</span></span>, <span class="hljs-string"><span class="hljs-string">'MercuryThreads'</span></span>, <span class="hljs-string"><span class="hljs-string">'ShortProfiles'</span></span>], (MercuryTypingReceiver, MercuryThreads, ShortProfiles) =&gt; { MercuryTypingReceiver .get() .addRetroactiveListener(<span class="hljs-string"><span class="hljs-string">'state-changed'</span></span>, onStateChanged); <span class="hljs-comment"><span class="hljs-comment">// Called every time a user starts or stops typing in a thread function onStateChanged(state) { // State is a dictionary that maps thread ids to the list of the // currently typing users ids' const threadIds = Object.keys(state); // Walk through all threads in order to retrieve a list of all // user ids const userIds = threadIds.reduce( (res, threadId) =&gt; res.concat(state[threadId].map(getUserId)), [] ); MercuryThreads.get().getMultiThreadMeta(threadIds, threads =&gt; { ShortProfiles.getMulti(userIds, users =&gt; { // Now that we've retrieved all the information we need // about the threads and the users, we send it to the // Chrome application to process and display it to the user. window.postMessage({ type: 'update', threads, users, state, }, '*'); }); }); } } );</span></span></code> </pre> <br>  Not a bad hack, slightly revealing the insides of Facebook. <br><br>  The source code for the extension is <a href="https://github.com/Morhaus/facebook-sixth-sense">published on Github</a> . <br><br>  By the way, you can even <a href="https://medium.com/life-tips/how-you-can-use-facebook-to-track-your-friends-sleeping-habits-505ace7fffb6">track</a> your friends' <a href="https://medium.com/life-tips/how-you-can-use-facebook-to-track-your-friends-sleeping-habits-505ace7fffb6">sleep mode</a> ( <a href="https://github.com/sqren/fb-sleep-stats">source code</a> ) by timestamps from Facebook messenger. <br><br><img src="https://habrastorage.org/files/01a/e6c/e53/01ae6ce53df84b14913666b323987743.png"></div><p>Source: <a href="https://habr.com/ru/post/302506/">https://habr.com/ru/post/302506/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302488/index.html">Multichannel successful retail</a></li>
<li><a href="../302490/index.html">PHD VI: how we hijacked the drone</a></li>
<li><a href="../302494/index.html">We make our own service to determine the WHOIS of any domain</a></li>
<li><a href="../302496/index.html">Schneider Electric Receives DCS Awards for Innovative Solutions</a></li>
<li><a href="../302498/index.html">"IT nomads": why companies still recruit saboteurs</a></li>
<li><a href="../302508/index.html">Do not deign to discuss about testing mobile applications?</a></li>
<li><a href="../302510/index.html">Participate on June 7-9 in the free dotnetConf 2016 virtual conference</a></li>
<li><a href="../302514/index.html">Algotrading: new horizons for graduates of Russian universities</a></li>
<li><a href="../302516/index.html">Uninstalling Code Contracts with Roslyn</a></li>
<li><a href="../302518/index.html">OOP in javascript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>