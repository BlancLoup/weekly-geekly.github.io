<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Attackers use Linux / Mumblehard to compromise servers, part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Mumblehard component, which deals with spamming (daemon), is also written in Perl and is located inside the ELF file of the malware. The daemon it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Attackers use Linux / Mumblehard to compromise servers, part 2</h1><div class="post__text post__text-html js-mediator-article">  The Mumblehard component, which deals with spamming (daemon), is also written in Perl and is located inside the ELF file of the malware.  The daemon itself requests spamming tasks from the C &amp; C server and supports most of the bot features that specialize in spamming: templates, reports, SMTP protocol implementation, etc. We will limit ourselves to describing those Mumblehard functions that are unique to this malware family. <br><br><img src="https://habrastorage.org/files/d99/abf/c7d/d99abfc7dea94568a20be51f7b07324f.jpeg"><br><br>  Perl scripts are cross-platform and can be executed on any platforms that are supported by this interpreter.  However, using the EWOULDBLOCK and EINPROGRESS constants, the authors limit the cross-platform nature of this component by operating systems such as Linux, FreeBSD, Windows.  Below is a fragment of a malicious script that determines the OS version. <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/a8f/506/b32/a8f506b327f74b53b5cf6829ee718061.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We observed a situation in which attackers ran a spam script through the backdoor Mumblehard.  This script works until the first reboot and does not include mechanisms for ensuring its autoload.  A bot can receive commands to send spam in two ways, through a C &amp; C server and a proxy. <br><br>  Managing C &amp; C server Mumblehard listens on port number 25 and waits for an HTTP POST request with the appropriate data as content.  This content is represented by various parameters, which are listed in the table below. <br><br><img src="https://habrastorage.org/files/35d/06d/855/35d06d8555a747889c0e7752a75767dc.png"><br>  Tab.  The format of the spam bot request to the managing C &amp; C server. <br><br>  The <i>Extra data</i> field contains additional request data, but it seems that it is used only to provide statistics to the server about how many emails were sent by the bot.  In this case, it has a special header consisting of 4-byte fields: <br><br><ul><li>  Task ID; </li><li>  number of successfully sent letters; </li><li>  Number of emails that were sent with an error due to problems with the network connection; </li><li>  number of emails that were rejected by the SMTP server. </li></ul><br>  The operator can also set the level of detail sent by the bot report (verbosity).  There are three such levels.  The lowest level corresponds to the minimum information sent about the number of emails, the next level instructs the bot to send email addresses in each of the above categories.  The third level allows the operator to receive a report on the reasons for the successful and unsuccessful execution of the operation. <br><br>  The server sends a response message with the HTTP 200 OK status and contains settings sent to the bot, a list of email addresses for distribution, and a template for mail spam messages. <br><br><img src="https://habrastorage.org/files/67a/4bd/34a/67a4bd34a0e24761b49eca83010012f8.png"><br>  Tab.  The format of the C &amp; C server response to the spam module. <br><br><img src="https://habrastorage.org/files/e6d/036/ef2/e6d036ef2e2641d0ab14427b1206d2aa.png"><br>  Tab.  The format of the C &amp; C server response to the spam module (continued). <br><br><img src="https://habrastorage.org/files/877/5cf/d3b/8775cfd3b6ab42908236f8f436d5e856.png"><br>  Tab.  The format of the C &amp; C server response to the spam module (continued). <br><br>  Most of the samples we analyzed for the Mumblehard component, which specializes in spamming, had another component in their composition that specializes in serving proxy connections.  The scheme of his work is quite simple: he opens the incoming TCP port and listens for incoming connections. <br><br>  Then it sends a special notification to the C &amp; C server with the number of this port.  Thus, it informs the server that it is ready to accept connections.  At the time of sending the notification to the C &amp; C server, only the C &amp; C server is in the list of computers allowed to connect to the proxy.  Further, the bot can be instructed to add other hosts to the list of allowed.  The bot supports only two proxy commands: add the IP address to the list of allowed hosts and create a new TCP tunnel. <br><br>  These commands have a specific structure, which is listed below in the tables. <br><br><img src="https://habrastorage.org/files/7e0/a35/4ca/7e0a354caa8c40a8b0c9aa4362812031.png"><br>  Tab.  The format of the ‚ÄúAdd authorized host‚Äù command of the proxy component. <br><br><img src="https://habrastorage.org/files/ed7/cb3/d51/ed7cb3d518a841ab8a17b2a168e78e72.png"><br>  Tab.  The format of the "Create Connection" command of the proxy component. <br><br>  The command to create a connection is actually an implementation of the SOCKS4 protocol.  Server response codes also comply with this specification.  The proxy component allows attackers to set up a tunnel to transmit the necessary traffic through a compromised computer.  However, we did not observe the use of such an operation by an attacker on an infected computer, so it‚Äôs hard to say how much the proxy function is relevant for them. <br><br>  The contents of electronic spam letters indicate their use in order to promote pharmaceutical products.  The letters contain links to various online stores with the specified subject.  An example of such a message is shown below. <br><br><img src="https://habrastorage.org/files/79d/2d7/5fe/79d2d75fe82e4d3596eaa3ef7b3a445f.png"><br>  Fig.  An example of a spam letter sent out by Mumblehard. <br><br>  The link leads to an online store specializing in the sale of drugs for erectile dysfunction. <br><br><img src="https://habrastorage.org/files/8f6/8cb/90a/8f68cb90a5d54a688233c3593b264e5a.png"><br>  Fig.  The website of the online pharmacy retailer to which the user is directed. <br><br>  This Canadian pharmaceutical site is <a href="http://spamtrackers.eu/wiki/index.php/Canadian_Health%252526Care_Mall">well documented</a> on <a href="http://spamtrackers.eu/">spamtrackers.eu</a> . <br><br>  An interesting feature of the bot's work with spam message templates is that it uses arbitrary message headers that are built using two or three random words, such as: <br><br><img src="https://habrastorage.org/files/f6d/033/0e9/f6d0330e9fc74349b61a6a469fdd674e.png"><br><br>  Perhaps such a function of using randomly chosen words was added by the authors in order to circumvent anti-spam solutions. <br><br>  <b>Statistics of infected computers</b> <br><br>  The list of C &amp; C server managers used by the Mumblehard backdoor contains domains that were busy, but now they are free and available for purchase.  We purchased one of these domains to get statistics on infected computers.  Such computers (bots) are fairly easy to identify by the User Agent line, which we mentioned above.  Two features of the backdoor that were set by the authors helped us collect statistics on the victims of this malicious program: <br><br><ul><li>  to receive the command, the bot polls each C &amp; C server from its list, the bot continues to poll the rest of the list, even if one of the servers has already answered; </li><li>  The bot sends the report back to each C &amp; C server in case of success or failure when executing a command received from one of them. </li></ul><br>  Our domain received a report from each bot four times per hour with a frequency of 15 minutes.  This corresponds to the time period with which the task scheduler runs the backdoor script in the system, as indicated above.  We collected data between September 19, 2014 and April 22, 2015, but the server itself, which received statistics, was unavailable between December 7, 2014 and January 6, 2015. During the collection time period data, we observed requests from 8,867 unique IP addresses.  Most of these IP addresses belonged to the servers hosting the websites. <br><br><img src="https://habrastorage.org/files/01a/a8f/46a/01aa8f46a33d4ad59f7f1a8e045fa4a8.png"><br>  Fig.  Statistics of the number of unique IP addresses that were observed every day. <br><br>  As we can see, the number of infected computers slowly decreased, but increased periodically.  This indicates that the attackers from time to time initiated waves of malware distribution and server compromise, instead of continuously distributing Mumblehard in a continuous mode. <br><br>  We were able to calculate the number of successful commands sent to the remote C &amp; C server bots.  As mentioned above, the command includes the URL where the executable ELF file is located.  In response to a request received from the C &amp; C server, the backdoor sent HTTP status codes to all C &amp; C servers in the User Agent line, so our registered server was also able to receive them.  Successful execution of the command by the bot corresponds to the HTTP status 200 OK. <br><br>  In fact, C &amp; C servers did not always send bots the above download-and-execute commands, that is, download and execute an ELF file.  It can be seen that most of the time they did not even listen on TCP port 80. There were also peak traffic values ‚Äã‚Äãwhen the bots showed high activity.  For example, on March 27th we observed 2,508 bots, which received 49,729 teams.  If the operators constantly sent bots download-and-execute commands at 15-minute intervals, this means that the botnet‚Äôs network was used continuously for hours.  The days when the backdoor was not involved in the work at all were also recorded.  Of the 187 days while data was being collected, the bots received commands for 120 days, which is 64% of the total time. <br><br>  Such delays are difficult to explain.  It is possible that the operators specifically limited the amount of spam sent by bots.  This was done to disguise the malicious functions of the infected servers and maintain the good reputation of their IP addresses.  On the other hand, based on the mechanisms of Mumblehard, the spam daemon component on these systems will still receive instructions from the C &amp; C server, even if the backdoor C &amp; C servers are already inactive. <br><br>  <b>Connection with Yellsoft</b> <br><br>  The IP addresses of the managers of C &amp; C servers that are hardcoded into the malware code are in the range of addresses from 194.54.81.162 to 194.54.81.164. <br><br><img src="https://habrastorage.org/files/eee/1be/46b/eee1be46b5404bb8bb608370feb5057e.png"><br><br>  If you check the following two IP addresses, 194.54.81.165 and 194.54.81.166, you will find out that both of them are name servers yellsoft.net.  In addition, the yellsoft.net web server is also located at 194.54.81.166.  These IP addresses are located close to the Mumblehard C &amp; C servers listed in the table.  Further verification shows that the five IP addresses from 162 to 166 have identical NS and SOA DNS records, despite the fact that in fact this address range is served by the rx-name.com domain.  This fact indicates that all five addresses are located on one server. <br><br><img src="https://habrastorage.org/files/75f/fe9/83f/75ffe983f3974447967bd4e95aa08f47.png"><br><br>  The company itself specializes in the sale of special software for the mass distribution of e-mails called DirectMailer.  According to the description on the company's website, this software is written in Perl and is designed to run on systems like UNIX.  Mumblehard scripts are also written in Perl. <br><br><img src="https://habrastorage.org/files/04b/620/e2c/04b620e2c37842c5970f4830ff78ac49.png"><br>  Fig.  Yellsoft home page. <br><br>  The company's home page states that it does not support copies of its software, which are downloaded by the user from the web page of another site called softexp.narod.ru. <br><br><img src="https://habrastorage.org/files/bc1/dee/d3f/bc1deed3ffff447ea24b229de9dead68.png"><br>  Fig.  Download DirectMailer on softexp.narod.ru webpage as of 2014 <br><br>  Today, this software is not available for download from softexp.narod.ru and is detected by ESET AV products as malicious.  The archive with this software does not contain a Perl script, but an executable ELF file called dm.pl.  An interesting fact is that this ELF file is packaged by the same packer that was used for the Mumblehard malware.  An analysis of the Perl script shows that a function called bdrp is called before the main program is launched directly.  This function has another dropper, which, after decryption, generates another ELF file.  The file is a packed Perl script containing the Mumblehard backdoor.  The script is reset to the file system directory and run using the task scheduler every 15 minutes.  Such a mechanism has already been described above for Mumblehard malware. <br><br><img src="https://habrastorage.org/files/e40/64b/aa2/e4064baa26a54d7087238515a20260be.png"><br>  Fig.  Function code bdrp with comments. <br><br>  The dm.pl program fork () to create a new process and starts listening for incoming TCP connections.  After this, the script code sends a message to the C &amp; C server that it is ready to accept proxy connections.  This code fragment, like its capabilities, is identical to the proxy mechanism of the Mumblehard spam component.  Such ‚Äúcracked‚Äù copies of DirectMailer provide backdoor operators with the ability to create a channel on a compromised computer to pass traffic through it, for example, to send spam. <br><br>  <b>Conclusion</b> <br><br>  Malicious software for systems running Linux and BSD is becoming increasingly complex.  The fact that the authors used their own wrapper to hide the source of Perl scripts inside the executable file adds a certain level of complexity to Mumblehard.  However, this malware is not as sophisticated as the Windigo malware we previously <a href="http://mirror2.esetnod32.ru/company/virlab/analytics/2014-04-01-windigo-pr.pdf">described</a> . <br><br>  <b>Compromise Indicators (IOCs)</b> <br><br>  UDP traffic to: <br><ul><li>  IP address 194.54.81.162, port 53 </li></ul><br>  TCP connections on: <br><ul><li>  IP address 194.54.81.163, port 80 (backdoor) </li><li>  IP address 194.54.81.163, port 54321 (proxy) </li><li>  IP address 194.54.81.163, port 25 (spam component) </li><li>  IP address 194.54.81.164, port 25 (spam component) </li></ul><br>  HTTP requests with the next line User Agent. <br><ul><li>  Mozilla / 5.0 (Windows NT 6.1; rv: 7.0.1) Gecko / &lt;1_or_more_digit&gt;. &lt;1_or_more_digit&gt;. &lt;1_or_e_digger&gt; Firefox / 7.0.1 </li></ul><br><br>  <b>YARA rules</b> <br><br>  mumblehard_packer.yara <br><br><img src="https://habrastorage.org/files/567/979/440/5679794402c54f5ea9c99a05e7ba356c.png"><br><br>  <b>Malware Samples</b> <br><br>  SHA-1: 65a2dc362556b55cf2dbe3a10a2b337541eea4eb (ELF) <br>  Linux / Mumblehard.K.Gen (spam component) <br><br>  SHA-1: 331ca10a5d1c5a5f3045511f7b66340488909339 (ELF) <br>  Linux / Mumblehard.E.Gen (spam component) <br><br>  SHA-1: 2f2e5776fb7405996feb1953b8f6dbca209c816a (ELF) <br>  Linux / Mumblehard.D.Gen (backdoor) <br><br>  SHA-1: 95aed86918568b122712bdbbebdd77661e0e6068 (ELF) <br>  Linux / Mumblehard.J.Gen (backdoor) <br><br>  SHA-1: c83042491efade4a4a46f437bee5212033c168ee (ZIP) <br>  Linux / Mumblehard.E.Gen (pirated copy of the DirectMailer archive with the dm.pl Mumblehard script) <br><br>  SHA-1: e62c7c253f18ec7777fdd57e4ae500ad740183fb (ELF) <br>  Linux / Mumblehard.E.Gen (pirated copy of DirectMailer with dm.pl Mumblehard script) <br><br>  SHA-1: 58d4f901390b2ecb165eb455501f37ef8595389a (ZIP) <br>  Linux / Mumblehard.M.Gen (pirated copy of DirectMailer 1.5 archive with dm.cgi script, which specializes in opening proxies) <br><br>  SHA-1: 4ae33caebfd9f1e3481458747c6a0ef3dee05e49 (ELF) <br>  Linux / Mumblehard.M.Gen (pirated copy of DirectMailer 1.5 with dm.cgi script that specializes in opening proxies) </div><p>Source: <a href="https://habr.com/ru/post/257293/">https://habr.com/ru/post/257293/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257281/index.html">We spread PHP</a></li>
<li><a href="../257283/index.html">What prepares us for C # 7 (Part 2. Pattern matching)</a></li>
<li><a href="../257285/index.html">Cards, money, two stars</a></li>
<li><a href="../257287/index.html">Head Unit - as a target for a hacker</a></li>
<li><a href="../257291/index.html">Fix corrupted MySQL tables with myisamchk</a></li>
<li><a href="../257295/index.html">Just about corporate IaaS: what it is, for whom, and how it is paid</a></li>
<li><a href="../257297/index.html">Centralized collection and processing of Windows print logs</a></li>
<li><a href="../257299/index.html">How clouds have changed the architecture of data centers</a></li>
<li><a href="../257301/index.html">2.5 million views - did you work well? Time to go on</a></li>
<li><a href="../257303/index.html">Processing and display of signals at the conversion frequency of the ADC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>