<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DevOps: send metrics and sleep well</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suddenly, at night the bell rings and we will find out that our application is not working. There are 2 hours for his resuscitation ... 


 Yes, we re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DevOps: send metrics and sleep well</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/f7b/a6e/614/f7ba6e61460e4238ae66af472a4428d4.jpg"><br><br>  Suddenly, at night the bell rings and we will find out that our application is not working.  There are 2 hours for his resuscitation ... <br><a name="habracut"></a><br><br>  Yes, we regularly sent logs to Elasticsearch, inspired by the ideas from the article <a href="http://habrahabr.ru/post/267009/">‚ÄúPublishing logs to Elasticsearch - life without regular expressions and without logstash‚Äù</a> .  But to investigate the true cause of the ‚Äúcrash‚Äù of the application, we clearly do not have enough data from the jmx bins jvm, jmx of the connection pool with the database, data on the number of file descriptors opened by our process, etc. How could we forget about them !?  Late to drink Borjomi ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Of course, we can take process data from nagios, zabbix, collectd or proprietary monitoring systems, but it would be more convenient to have all this data at once in Elasticsearch.  This would allow to visualize in <a href="https://www.elastic.co/products/kibana">kibana</a> and <a href="https://www.elastic.co/products/watcher">receive alerts</a> based on a single source of events from multiple processes on different nodes in the network.  Elasticsearch allows you to index, perform full-text search and horizontally scale data storage by adding new search server processes. <br><br>  Okay, this time we will dig up the application logs, examine the history of the metrics in our miraculous proprietary monitoring and think up on the basis of this the reason for the fall of the application more plausible.  Next time, we will try to collect more information about the operation of our application in a more convenient way to analyze and find out the true reason based on the metrics and events of the application. <br><br>  I will share with you a recipe how to sleep more at night: <br><ul><li>  Cooking Elasticsearch and kibana </li><li>  Send metrics from jvm to Elasticsearch </li><li>  But what about the application logs? </li><li>  How to deal with already running jvm processes and where is groovy? </li></ul><br><br><h2>  Cooking Elasticsearch and kibana </h2><br>  Let's start with where we will collect metrics.  Launch Elasticsearch (ES) server.  For example, <a href="https://github.com/igor-suhorukov/elasticsearch-server-example">Elasticsearch in the simplest configuration</a> , which immediately sets the default template for all new indices, so that you can search in kibana using the ready-made Logstash Dashboard.  Runs as <i>mvn package</i> .  Server nodes find each other using multicast UDP packets and cluster into a matching clusterName.  It is clear that the lack of unicast addresses simplifies development life, but in industrial operation it is not worth setting up a cluster like this! <br><div class="spoiler">  <b class="spoiler_title">For this example, you can run Elasticsearch using the groovy script ...</b> <div class="spoiler_text"><blockquote>  java -jar <a href="">groovy-grape-aether-2.4.5.1.jar</a> <a href="https://raw.githubusercontent.com/igor-suhorukov/elasticsearch-server-example/master/elasticsearch-server.groovy">elasticsearch-server.groovy</a> </blockquote><br>  Script elasticsearch-server.groovy: <br><pre><code class="hljs pgsql">@Grab(<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>=<span class="hljs-string"><span class="hljs-string">'org.elasticsearch'</span></span>, module=<span class="hljs-string"><span class="hljs-string">'elasticsearch'</span></span>, version=<span class="hljs-string"><span class="hljs-string">'1.1.1'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.elasticsearch.common.settings.ImmutableSettings; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.elasticsearch.node.Node; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.elasticsearch.node.NodeBuilder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.InputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.URL; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.TimeUnit; <span class="hljs-type"><span class="hljs-type">int</span></span> durationInSeconds = args.length == <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-number"><span class="hljs-number">3600</span></span> : <span class="hljs-type"><span class="hljs-type">Integer</span></span>.parseInt(this.args[<span class="hljs-number"><span class="hljs-number">0</span></span>]); String <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>; InputStream templateStream = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> URL("https://raw.githubusercontent.com/logstash-plugins/logstash-output-elasticsearch/master/lib/logstash/outputs/elasticsearch/elasticsearch-template.json").openStream() try{ template = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> String(sun.misc.IOUtils.readFully(templateStream, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); } finally{ templateStream.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>() } Node elasticsearchServer = NodeBuilder.nodeBuilder().settings(ImmutableSettings.settingsBuilder().put("http.cors.enabled","true")).clusterName("elasticsearchServer").data(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).build(); Node node = elasticsearchServer.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(); node.client().<span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>().indices().preparePutTemplate("logstash").setSource(<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("ES STARTED"); Thread.sleep(TimeUnit.SECONDS.toMillis(durationInSeconds));</code> </pre> <br></div></div><br>  We have a storage for metrics.  Now we <a href="https://www.elastic.co/downloads/past-releases/kibana-3-1-3">‚Äôll</a> connect to it using the <a href="https://www.elastic.co/downloads/past-releases/kibana-3-1-3">Kibana</a> web application and don‚Äôt see anything, since no one has yet sent metrics there.  You can view the status of the Elasticsearch cluster and connected clients using <a href="https://github.com/royrusso/elasticsearch-HQ">elasticsearch-HQ</a> , but there are many options for administration consoles and the choice will be to your taste. <br><br>  A few words about the kibana configuration for this example.  In the file kibana-3.1.3 / config.js, you need to replace the property: elasticsearch: " <a href="http://127.0.0.1/">127.0.0.1</a> : 9200".  After that, the web interface will be able to connect to the elasticsearch server running on the same host by the elasticsearch-server.groovy script or the mvn package command. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/xVRlpGeilyg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  Send metrics from jvm to Elasticsearch </h2><br>  All the magic will be done using the <a href="https://github.com/igor-suhorukov/aspectj-scripting">AspectJ-Scripting</a> agent.  The agent has been modified so that it can be easily inserted into the process using AttachAPI and that it receives the configuration through the agent parameter.  Now the agent can be used with a configuration without aspects and it is possible to describe periodically executed tasks. <br><br>  AspectJ-Scripting will allow us, without recompiling and repacking the application, using the jar file with the <a href="">aspectj-scripting-1.3-agent.jar agent</a> , the configuration file in the file system (or on the web server) and one additional parameter -javaagent at the start of the JVM, send metrics from all application processes in Elasticsearch. <br><br>  In the java agent configuration, we will use <a href="https://github.com/igor-suhorukov/jvm-metrics">com.github.igor-suhorukov: jvm-metrics: 1.2</a> and ‚Äúunder the hood‚Äù of this library work: <br><ul><li>  <a href="https://jolokia.org/">Jolokia</a> to get jmx metrics with connection either to a local mbean server or via JSR160 (RMI) </li><li>  jvmstat performance counters - metrics are available if we work under the OpenJDK / Oracle JVM </li><li>  <a href="https://support.hyperic.com/display/SIGAR/Home">SIGAR</a> for getting metrics from OS and io.kamon: sigar-loader to simplify loading of its native library. </li></ul><br><br>  So, all that does the work we need to collect and send metrics is in the file log.metrics.xml <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">globalContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span>com.github.igor-suhorukov:jvm-metrics:1.2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>SigarCollect<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.github.suhorukov.SigarCollect<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>JmxCollect<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.github.suhorukov.JmxCollect<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span>org.elasticsearch:elasticsearch:1.1.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>NodeBuilder<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.elasticsearch.node.NodeBuilder<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">init</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> SigarCollect sigar = new SigarCollect(); JmxCollect jmxCollect = new JmxCollect(); reportHost = java.net.InetAddress.getLocalHost().getHostName(); pid = java.lang.management.ManagementFactory.getRuntimeMXBean().getName().split("@")[0]; Thread.currentThread().setContextClassLoader(NodeBuilder.class.getClassLoader()); client = NodeBuilder.nodeBuilder().clusterName("elasticsearchServer").data(false).client(true).build().start().client(); additionalRecords = new java.util.HashMap(); additionalRecords.put("Host", reportHost); additionalRecords.put("Pid", pid); <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">init</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timerTasks</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">delay</span></span></span><span class="hljs-tag">&gt;</span></span>500<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">delay</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">period</span></span></span><span class="hljs-tag">&gt;</span></span>2000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">period</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">jobExpression</span></span></span><span class="hljs-tag">&gt;</span></span> import java.text.SimpleDateFormat; import java.util.TimeZone; logstashFormat = new SimpleDateFormat("yyyy.MM.dd"); logstashFormat.setTimeZone(TimeZone.getTimeZone("UTC")); timestamp = new java.util.Date(); index = "logstash-" + logstashFormat.format(timestamp); jmxInfo = jmxCollect.getJsonJmxInfo("java.lang:type=Memory", timestamp, additionalRecords); nativeInfo = sigar.getJsonProcessInfo(additionalRecords); client.index(client.prepareIndex(index, "logs").setSource(jmxInfo).request()).actionGet(); client.index(client.prepareIndex(index, "logs").setSource(nativeInfo).request()).actionGet(); <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">jobExpression</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timerTasks</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">globalContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  In this configuration, we create instances of the SigarCollect and JmxCollect classes that are loaded from the com.github.igor-suhorukov library: jvm-metrics: 1.2 during the start of the agent. <br><br>  SigarCollect - allows you to collect data on the process and operating system, many of which are not in jxm, and converts metrics to json format.  JmxCollect - allows you to request data from the jmx of the virtual machine and the application, also converting it into a json document.  We have limited the information from JmxCollect to the ‚Äújava.lang: type = Memory‚Äù filter, but you will definitely need more information from the jxm bins. <br><br>  Add reportHost to additionalRecords - the name of the host on which the application is running and the pid process ID <br><br>  In the client, we save the client for elasticsearch, which joins the servers with the Elasticsearch name of the cluster ‚ÄúelasticsearchServer‚Äù, which we will use to send the metrics. <br><br>  Our task of sending metrics will be performed every 2 seconds and write metrics in an index with an appropriate date, for example logstash-2015.11.25.  In this task, the metrics from JmxCollect and SigarCollect are returned as json objects in a format that can visualize kibana.  Metrics using the Elasticsearch client are sent to the cluster and indexed. <br><br>  As you can see, the configuration turned out to be quite familiar to the developers of the Java-like syntax of the MVEL language. <br><br>  In the script to start our application, add the -javaagent: /? PATH? / <a href="">Aspectj-scripting-1.3-agent.jar</a> = config: file: /? PATH? / <a href="">Log.metrics.xml</a> <br>  We start all application processes on all nodes and watch how metrics flow into the Elasticsearch cluster <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/wNjIKh2R1Pw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  But what about the application logs? </h2><br>  We already send metrics to Elasticsearch, but there is not enough other information from the application.  When using the approach from the article <a href="http://habrahabr.ru/post/267009/">‚ÄúPublishing logs in Elasticsearch - life without regular expressions and without logstash‚Äù, the</a> parsing of log files will not be necessary.  When changing the format of logging or the appearance of new messages, it is not necessary to support a large set of regulators.  In this approach, I suggest intercepting calls to the error, warn, info, debug, trace logger methods and send the data immediately to elasticsearch. <br><a name="attach"></a><br><h2>  How to deal with already running jvm processes and where is groovy? </h2><br>  The Groovy script will allow us to deploy an agent even to an application already running in jvm, indicating only the process identifier and the path to the configuration.  And even jvm tools.jar is not needed to embed an agent into a running process using AttachAPI.  This was made possible thanks to the <a href="https://github.com/igor-suhorukov/attach-vm">com.github.igor-suhorukov library: attach-vm: 1.0</a> , based on classes from JMockit / OpenJDK. <br><br>  To run this script, we need a specially prepared groove <a href="">groovy-grape-aether-2.4.5.1.jar</a> .  About the possibilities of which I <a href="http://habrahabr.ru/post/270145/">recently spoke</a> . <br><blockquote>  java -jar <a href="">groovy-grape-aether-2.4.5.1.jar</a> <a href="https://raw.githubusercontent.com/igor-suhorukov/elasticsearch-server-example/master/attachjvm.groovy">attachjvm.groovy</a> <i>JVM_PID</i> config: file <i>:? PATH?</i>  / <a href="">log.metrics.xml</a> </blockquote><br>  The attachjvm.groovy script downloads aspectj-scripting: jar: agent from the maven repository and using AttachAPI connects to jvm with the process number <i>JVM_PID</i> , loading into this jvm aspectj-scripting agent with a log.metrics.xml configuration <br><pre> <code class="hljs scala"><span class="hljs-meta"><span class="hljs-meta">@Grab</span></span>(group=<span class="hljs-symbol"><span class="hljs-symbol">'com</span></span>.github.igor-suhorukov', module=<span class="hljs-symbol"><span class="hljs-symbol">'attach</span></span>-vm', version=<span class="hljs-symbol"><span class="hljs-symbol">'1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>') <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.github.igorsuhorukov.jvmattachapi.<span class="hljs-type"><span class="hljs-type">VirtualMachineUtils</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.tools.attach.<span class="hljs-type"><span class="hljs-type">VirtualMachine</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.github.igorsuhorukov.smreed.dropship.<span class="hljs-type"><span class="hljs-type">MavenClassLoader</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aspectJScriptingFile</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">MavenClassLoader</span></span>.forMavenCoordinates(<span class="hljs-string"><span class="hljs-string">"com.github.igor-suhorukov:aspectj-scripting:jar:agent:1.3"</span></span>).getURLs().getAt(<span class="hljs-number"><span class="hljs-number">0</span></span>).getFile() println aspectJScriptingFile <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processId</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.args.getAt(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//CliBuilder def configPath = this.args.getAt(1) VirtualMachine virtualMachine = VirtualMachineUtils.connectToVirtualMachine(processId) try { virtualMachine.loadAgent(aspectJScriptingFile, configPath) } finally { virtualMachine.detach() }</span></span></code> </pre><br>  If it is necessary to diagnose the system or change the logging level, then we <a href="http://habrahabr.ru/post/265741/">build a cross-platform ssh server into the java application</a> .  Which we can embed in an already running java process: <br><blockquote>  java -jar <a href="">groovy-grape-aether-2.4.5.1.jar</a> <a href="https://raw.githubusercontent.com/igor-suhorukov/elasticsearch-server-example/master/attachjvm.groovy">attachjvm.groovy</a> <i>JVM_PID</i> config: file <i>:? PATH?</i>  / <a href="">CRaSHub_ssh.xml</a> </blockquote><br><div class="spoiler">  <b class="spoiler_title">With the following configuration CRaSHub_ssh.xml ...</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">globalContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span>org.crashub:crash.connectors.ssh:1.3.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>Bootstrap<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.crsh.standalone.Bootstrap<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>Builder<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.crsh.vfs.FS$Builder<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>ClassPathMountFactory<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.crsh.vfs.spi.url.ClassPathMountFactory<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>FileMountFactory<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.crsh.vfs.spi.file.FileMountFactory<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">init</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> import java.util.concurrent.TimeUnit; otherCmd = new FileMountFactory(new java.io.File(System.getProperty("user.dir"))); classLoader = otherCmd.getClass().getClassLoader(); classpathDriver = new ClassPathMountFactory(classLoader); cmdFS = new Builder().register("classpath", classpathDriver).register("file", otherCmd).mount("classpath:/crash/commands/").build(); confFS = new Builder().register("classpath", classpathDriver).mount("classpath:/crash/").build(); bootstrap = new Bootstrap(classLoader, confFS, cmdFS); config = new java.util.Properties(); config.put("crash.ssh.port", "2000"); config.put("crash.ssh.auth_timeout", "300000"); config.put("crash.ssh.idle_timeout", "300000"); config.put("crash.auth", "simple"); config.put("crash.auth.simple.username", "admin"); config.put("crash.auth.simple.password", "admin"); bootstrap.setConfig(config); bootstrap.bootstrap(); Thread.sleep(TimeUnit.MINUTES.toMillis(30)); bootstrap.shutdown(); <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">init</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">globalContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><iframe width="560" height="315" src="https://www.youtube.com/embed/lEx2JLf58Q4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  findings </h2><br>  To sleep well, you need to pay no less attention to the tasks associated with the operation of the application. <br><br>  Now we have a working cluster Elasticsearch, the data from the indices of which we can analyze in kibana.  Applications with metrics from JMX beans, jvm process metrics and the operating system come to Elasticsearch from applications.  Here we <a href="http://habrahabr.ru/post/267009/">already know how</a> to write application logs.  We set up notifications and, in the case of notifications, quickly find out the cause of problems in our application and promptly fix problems.  Moreover, we <a href="http://habrahabr.ru/post/265741/">build a cross-platform ssh server into the java application</a> and we can already diagnose even a running application without restarting.  This includes switching the level of logging in it using CRaSH. <br><br>  I wish your application a stable job, and you quickly search for the causes of problems, if they still arose! </div><p>Source: <a href="https://habr.com/ru/post/269793/">https://habr.com/ru/post/269793/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269783/index.html">DDoS analytics</a></li>
<li><a href="../269785/index.html">Ghost Methods in Ruby (translation)</a></li>
<li><a href="../269787/index.html">How to keep outdated programming language</a></li>
<li><a href="../269789/index.html">Once again about the seven main development methodologies</a></li>
<li><a href="../269791/index.html">Janusjs: concept of the system, where the client and server are conjoined twins</a></li>
<li><a href="../269795/index.html">Who is more successful in the market, why users remove applications - and other news of the week for a mobile developer</a></li>
<li><a href="../269797/index.html">November 10-17, we invite you to take part in the action for mobile developers and users - Russian AppFest</a></li>
<li><a href="../269799/index.html">Cloud Cloud Jobs: Odin VDI and IBS</a></li>
<li><a href="../269803/index.html">‚ÄúMany people choose Agile because they can't do anything else‚Äù - an interview with Dmitry Zavalishin from DZ Systems</a></li>
<li><a href="../269805/index.html">How we opened an IT-school on the basis of the technical support department: hold the cable and blow to the fields</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>