<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[NES] Writing level editor for Prince of Persia. Epilogue. Dungeon</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chapter One , Chapter Two , Chapter Three , Chapter Four , Chapter Five , Epilogue 

 Disclaimer 
 ‚ÄúTime after time, going through my favorite games, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[NES] Writing level editor for Prince of Persia. Epilogue. Dungeon</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/post/187876/">Chapter One</a> , <a href="http://habrahabr.ru/post/191880/">Chapter Two</a> , <a href="http://habrahabr.ru/post/192028/">Chapter Three</a> , <a href="http://habrahabr.ru/post/192546/">Chapter Four</a> , <a href="http://habrahabr.ru/post/192832/">Chapter Five</a> , <b>Epilogue</b> <br><br><h5>  Disclaimer </h5><br>  ‚ÄúTime after time, going through my favorite games, far and wide, finding all the possible secrets, I wanted to play them again and again, but with new levels, new secrets and new features, <a href="http://habrahabr.ru/post/187876/">‚Äù</a> I <a href="http://habrahabr.ru/post/187876/">wrote</a> .  Naturally, passing the same game in the "normal" mode, began the search for something that is hidden behind the scenes.  If the game has hidden levels, rooms, receptions, or a password system, then it would be necessary all day and half the night past the blue screen to try to find it, and to crack the passwords.  PoP was no exception.  And although I didn‚Äôt find the password generation algorithm, I could still find a couple of methods that allow you to create the correct password from the existing one.  It is true to say where the new password leads, until the moment it was used, I could not. <br><a name="habracut"></a><br><br><h5>  Dungeon </h5><br>  The password system of PoP for NES is now described in more than detail: there are methods for changing the existing password, as well as a description of the algorithm itself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is short, so I will give it in the first language that came to hand: <div class="spoiler">  <b class="spoiler_title">Bash password generator</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash PLEVEL=$1 PTIME=$2 if ! [[ ${PLEVEL} =~ ^[0-9]{1,2}$ ]] ; then echo "Invalid level" &gt;&amp;2 ; exit 1 ; fi if ! [[ ${PTIME} =~ ^[0-9]{1,2}$ ]] ; then echo "Invalid time" &gt;&amp;2 ; exit 1 ; fi if [ "0" == ${PLEVEL} ] ; then echo "Level must be great than 0" &gt;&amp;2 ; exit 1 ; fi PLEVEL=$[PLEVEL-1] R1=$[RANDOM % 10] R2=$[RANDOM % 10] PASS0=$[((PTIME / 10)+R1) % 10] PASS3=$[((PTIME % 10)+R2) % 10] PASS1=$[((PLEVEL &amp; 3)+R1) % 10] PASS7=$[((PLEVEL / 4)+R2) % 10] PASS2=$R1 PASS5=$R2 SUM=$[PASS0+PASS1+PASS2+PASS3] SUM=$[SUM+(SUM % 10)+PASS5] SUM=$[SUM+(SUM / 10)+PASS7] PASS4=$[SUM % 10] PASS6=$[SUM / 10] echo "${PASS0}${PASS1}${PASS2}${PASS3}${PASS4}${PASS5}${PASS6}${PASS7}${PASS8}${PASS9}"</span></span></code> </pre> <br></div></div><br><br>  And now, going through the passwords (then on dendy, when the emulators in their current form and in the project were not), I got into strange places that were not explicitly provided by the developers: <br><img src="http://habrastorage.org/storage3/6ce/07b/9f6/6ce07b9f668890485d340bebb4d40402.png"><br>  or <br><img src="https://habrastorage.org/storage3/fcb/25e/9ba/fcb25e9ba456eb426ebd6b8e8dea8eeb.png"><br><br>  Management in these "levels" works only partially, the appearance is strange, and you cannot get there from the main game. <br>  Now, looking at how the engine stores data levels, I was even convinced that more than 14 levels in the game is simply not provided.  Where do these passwords lead? <br><br><h5>  Overflow </h5><br>  As it turned out, there are no overflow checks in the game.  For example, placing in the editor more than the current active blocks in the room, you can get a frozen game, or other interesting artifacts in the form of a double appeared or something else interesting. <br><br>  The lack of verification also applies to the procedure for compiling passwords, the algorithm of which provides for level numbers from 0 to 15. The developers, apparently, to save development time, decided that since the game does not constitute passwords that have levels 14 and 15 (in the indexing from 0), then no one will enter them.  Yeah. <br><br>  We know that in our three tables of pointers, of which the final level is built, only 14 elements and 15 from 16 are not provided there.  Consequently, the level is constructed from garbage that comes across when interpreting the data following the existing tables into pointers.  But why there can not fully manage the character? <br><br><h5>  Remember the theory </h5><br>  The level is based on three types of data, each of which has its own table of pointers: <br><ul><li>  The blocks from which rooms are built are 0x1EB4A; </li><li>  The level header is 0x1EB66; </li><li>  Level geometry - 0x1EB82. </li></ul><br><br>  Also, there is auxiliary data: <br><ul><li>  Type of level; </li><li>  Palette; </li><li>  Type of guard; </li><li>  Amount of health; </li><li>  Other data that does not significantly affect the appearance. </li></ul><br><br>  Tables with pointers are exactly 28 bytes apart.  In other words, they follow each other.  And if so, then the pointers are not taken from the desired table, but from the next one.  Since the data referenced by these pointers are also intermixed, going into 15 or 16 ‚Äúlevels‚Äù, we fall somewhere in the middle of that data array.  Moreover, the data of one sense will be interpreted as data of another sense. <br><br>  Let's try to visualize the view, say, 15 "level".  Take the offset 0x1EB66 (header), add 28, and look at the pointer: <br> <code>D9 82 61 86 91 89 F1 8C 06 90 85 92 0D 96 61 99 F3 9C CD 9F 2C A3 9B A6 5B A8 AC A9 &gt;&gt; 79 82 &lt;&lt; ...</code> <br>  $ 8279 is even earlier than the first-level heading [$ 82D9].  It is clear that we get to the data that describe the geometry of the first level.  But they will now be interpreted differently: <br> <code>05 00 00 02 06 03 01 00 02 09 00 00 13 0E 14 00 15 01 00 06 08 02 05 00 ...</code> <br>  * 05 - we start in the 5th room; <br>  * 00 00 - we start at position 00 and look to the right; <br>  * The remaining data tells us that the guard will be located in each room somewhere in the upper left corner, with a few exceptions. <br><br>  0x1EB4A + 28 = 0x1EB66: $ 82D9.  The level will be based on the data that was once the first level header.  But we will start from the fifth room, therefore, starting from $ 82D9, we need to skip 4 rooms according to the rule: +30 bytes, if the first byte is not #FF, otherwise +1 byte: <br>  $ 82D9 = # 01.  We add +30. <br>  $ 82F7 = # 05.  We add +30. <br>  $ 8315 = # 08.  We add +30. <br>  $ 8333 = # 20.  We add +30. <br>  $ 8351: <code>20 00 00 14 01 03 21 03 14 14 20 00 00 14 14 14 14...</code> <br>  Judging by the nature of the data, we got somewhere in the middle of a second-level room.  The second level starts at $ 8331, therefore, it is somewhere inside the second room, which looks like this: <br><img src="http://habrastorage.org/storage3/109/52e/6e2/10952e6e24d912befa9ad0d527e6452b.png">  . <br>  The guard should be located in the upper left corner, based on the presented header. <br><br>  Now look at the level geometry. <br>  0x1EB82 + 28 = 0x1EBA0: <code>0C 03 C0 30 0C 03...</code> That is, it will be somewhere around the $ 030C address in RAM (not in ROM!).  The data on these addresses is obviously more than 24, which means that it will not be possible to go to the next room with all the desire. <br><br>  Compare: <br><img src="http://habrastorage.org/storage3/6ce/07b/9f6/6ce07b9f668890485d340bebb4d40402.png"><br>  Since the border of this ‚Äúroom‚Äù does not coincide with the border of the second room of the second level, some displacement of the ‚Äúarchitecture‚Äù to the left is seen.  Also on the left is a break, which corresponds to the next room, but it does not, according to the incorrect level geometry. <br><br><h5>  Set in motion </h5><br>  Now I propose to see how the information about the guards in the level is used. <br><pre> <code class="hljs mel">$F284:<span class="hljs-number"><span class="hljs-number">20</span></span> DA C0 JSR $C0DA $F287:B1 <span class="hljs-number"><span class="hljs-number">6</span></span>D LDA ($6D),Y @ $9FC7 = #$1E $F289:<span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>F AND #$1F $F28B:C9 <span class="hljs-number"><span class="hljs-number">1</span></span>E CMP #$1E $F28D:B0 <span class="hljs-number"><span class="hljs-number">0</span></span>E BCS $F29D $F28F:A6 <span class="hljs-number"><span class="hljs-number">17</span></span> LDX $0017 = #$00 $F291:<span class="hljs-number"><span class="hljs-number">9</span></span>D <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> STA $0711,X @ $0723 = #$00 $F294:A5 <span class="hljs-number"><span class="hljs-number">18</span></span> LDA $0018 = #$00 $F296:<span class="hljs-number"><span class="hljs-number">9</span></span>D <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> STA $0710,X @ $0722 = #$00 $F299:E6 <span class="hljs-number"><span class="hljs-number">17</span></span> INC $0017 = #$00 $F29B:E6 <span class="hljs-number"><span class="hljs-number">17</span></span> INC $0017 = #$00 $F29D:E6 <span class="hljs-number"><span class="hljs-number">18</span></span> INC $0018 = #$00 $F29F:A5 <span class="hljs-number"><span class="hljs-number">18</span></span> LDA $0018 = #$00 $F2A1:C9 <span class="hljs-number"><span class="hljs-number">19</span></span> CMP #$19 $F2A3:D0 D9 BNE $F27E $F2A5:A6 <span class="hljs-number"><span class="hljs-number">17</span></span> LDX $0017 = #$00 $F2A7:A9 FF LDA #$FF $F2A9:<span class="hljs-number"><span class="hljs-number">9</span></span>D <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> STA $0710,X @ $0722 = #$00 $F2AC:<span class="hljs-number"><span class="hljs-number">60</span></span> RTS</code> </pre><br><br>  The procedure $ C0DA, as we remember, retrieves a pointer to the level header and places it at the addresses $ 6D: $ 6E, in register Y we have offset # 03, since the information about the guards is stored after the first three bytes, which are responsible for the prince‚Äôs position the beginning of the level.  Further, it can be seen that if the first 5 bits add up to the number # 1E, then the iteration is skipped, otherwise the following structure is written to the addresses starting at $ 0710: &lt;room number&gt;: &lt;guard coordinate&gt; - two bytes per structure.  If we have all the rooms filled with guards, then the last address where we can put the data will be $ 0740, after which, at the address $ 0742, the #FF marker will be placed.  But addresses, starting from $ 0735, are used for another purpose - this is evident in the normal operation of the game, which means that in this situation a classic buffer overflow occurs. <br>  At $ 0735, we have a flag stored, which is responsible for managing from the gamepad.  If there is 0, then the management is standard, if not 0, then it is considered that we are in the starting room, where management is limited.  Now, in this ‚Äúlevel‚Äù, due to the fact that the coordinates of the guards have overwritten important data, in the $ 0735 cell is not zero, and if we put 0 in it, then we will be able to fully manage the prince.  True, we will not be able to escape beyond this room, since the level geometry is broken. <br><br>  The same applies to the 16 "level".  17 and above ‚Äúlevels‚Äù, if at the moment of typing the password of $ 70 to put down the desired number, get on the frank garbage and simply are not displayed. <br><br><h5>  Epilogue in the epilogue </h5><br>  In this article I tried to tell you that the common myth of the "secret" levels is not true.  In principle, when analyzing the code of the game, and this was seen in previous articles, there are no secrets in the game at all: hidden rooms, levels or something like that.  ‚ÄúSecret levels‚Äù is the banal absence of the necessary verification condition in the procedure for reading passwords. <br><br>  As a result of the whole study, I can say the following: the game is extremely simple within the framework of the second mapper, and moreover, it was developed, most likely, in a hurry.  One can see a pretty good base of the engine, but at the end it was clearly finished on crutches: the implementation of a twin or non-standard transitions between levels is just a hardcode, which is inserted in the middle of a smooth code.  This is where the NES versions differ from the rest of the ports: the little things just didn‚Äôt comb at the end, although a couple of simple procedures were enough to bring to mind.  If you add this in the form of a trivial patch to the engine, then you can achieve almost full compliance with the original version, and then, as it seems to me, the version on the NES will even win compared to the DOS version.  At least the presence of music, a system of passwords and a darker atmosphere. <br><br>  The series of articles on the reverse of the NES is over.  Now the plans are to descend to the level below - the level of iron, as I want to play the new game on the real Dendy.  This will be a couple of articles. </div><p>Source: <a href="https://habr.com/ru/post/193406/">https://habr.com/ru/post/193406/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193392/index.html">MultiFon - VoIP-dialer for MegaFon subscribers</a></li>
<li><a href="../193394/index.html">Reports and charts for travis-ci and drone.io</a></li>
<li><a href="../193396/index.html">Working with relational databases in Scala</a></li>
<li><a href="../193398/index.html">Plugin for Smarty - Combine</a></li>
<li><a href="../193402/index.html">Steam officially announced the appearance of the "sharing" games</a></li>
<li><a href="../193412/index.html">Ten sensors and one grandmother in the service of progress</a></li>
<li><a href="../193414/index.html">Source codes of two versions of COIBs are available.</a></li>
<li><a href="../193416/index.html">Notebook ASUS X200CA</a></li>
<li><a href="../193422/index.html">Humble Indie Bundle 9</a></li>
<li><a href="../193424/index.html">Supervised by the NSA: how to stay protected (Recommendations by Bruce Schneier)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>