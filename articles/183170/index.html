<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pure-FTPD with user storage in the MYSQL database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Previously, it was not once to set up an FTP server (for several minutes), and as it has historically happened, ProFtpd was the undisputed candidate. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pure-FTPD with user storage in the MYSQL database</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/bde/8d3/fa4/bde8d3fa4dffd71af6beb64e3a05ac5f.jpg" alt="image" align="left"><br>  Previously, it was not once to set up an FTP server (for several minutes), and as it has historically happened, <a href="http://www.proftpd.org/">ProFtpd</a> was the undisputed candidate.  Since, in terms of security, this comrade had problems recently, he decided to try something else, and did not regret <br><a name="habracut"></a><br>  My choice was a wonderful FTP server <a href="http://www.pureftpd.org/project/pure-ftpd">Pure-FTPd</a> . <br>  After installation you will receive the following set of functions: <br><br><ul><li>  Speed ‚Äã‚Äãcontrol Download and Upload for each user </li><li>  Select UID and GUID for user </li><li>  Availability of ftp for a user from specified ip addresses only </li><li>  Enable or disable user accounts </li></ul><br><br>  <a href="http://freebsd.org/">FreeBSD is</a> used as the OS.  And so let's go!  It is assumed that you have installed and configured MySql DBMS.  Install Pure-FTPd from ports (after upgrading them) <br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/ports/ftp/pure-ftpd make install clean</code> </pre> <br>  I selected the following options <br><img src="https://habrastorage.org/storage2/52f/7cc/6ab/52f7cc6ab4a5f8584ce6bb64a954fff4.png"><br>  After installation create configs from default files <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/ cp pureftpd-mysql.conf.sample pureftpd-mysql.conf cp pure-ftpd.conf.sample pure-ftpd.conf</code> </pre><br>  Editing the main configuration file <br><div class="spoiler">  <b class="spoiler_title">pure-ftpd.conf</b> <div class="spoiler_text">  # Chroot`it all users in their folders <br>  ChrootEveryone yes 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      # If ‚Äúno‚Äù was selected in the previous option, then members of the next <br>  # groups will not be chroot.  All the rest - will be.  If you do not want <br>  # chroot`it all, then just unzip the ChrootEveryone and TrustedGID. <br>  # TrustedGID 100 <br><br>  # Enable compatibility features for client curves <br>  BrokenClientsCompatibility no <br><br>  # Maximum number of simultaneous users <br>  MaxClientsNumber 50 <br><br>  # Work in the background (daemon) <br>  Daemonize yes <br><br>  # Maximum number of simultaneous connections from one IP <br>  MaxClientsPerIP 8 <br><br>  # If you want to log all client teams, then this <br>  # paragraph must be "yes".  If you need to log also <br>  # server responses, then simply duplicate this item. <br>  Verboselog no <br><br>  # Show or not files starting with a dot, even when a client <br>  # obviously does not say that this should be done, option "-a". <br>  DisplayDotFiles yes <br><br>  # Do not allow authenticated users - this FTP <br>  # for anonymous clients only. <br>  AnonymousOnly no <br><br>  # Disable anonymously - FTP current for registered users. <br>  NoAnonymous no <br><br>  # Syslog tools (auth, authpriv, daemon, ftp, security, user, local *) <br>  # Default - "ftp".  ‚ÄúNone‚Äù - disables logging. <br>  Syslogfacility ftp <br><br>  # Show any cookies?  (Display fortune cookies) <br>  # FortunesFile / usr / share / fortune / zippy <br><br>  # Do not resolve hostnames in logs.  Logs become less informative, <br>  # but less resources are required.  "Yes" - it makes sense to put on a very <br>  # loaded servers, or when DNS is down. <br>  DontResolve yes <br><br>  # Maximum idle time (at the end of the connection breaks), in minutes <br>  # (default = 15 minutes) <br>  MaxIdleTime 15 <br><br>  # LDAP configuration file (see README.LDAP) <br>  # LDAPConfigFile /etc/pureftpd-ldap.conf <br><br>  # MySQL configuration file (see README.MySQL) <br>  MySQLConfigFile /usr/local/etc/pureftpd-mysql.conf <br><br>  # Postgres configuration file (see README.PGSQL) <br>  # PGSQLConfigFile /etc/pureftpd-pgsql.conf <br><br>  # database of PureDB users (see README.Virtual-Users) <br>  # PureDB /etc/pureftpd.pdb <br><br>  #path to pure-authd socket (see README.Authentication-Modules) <br>  # ExtAuth /var/run/ftpd.sock <br><br>  # If you need to enable PAM authentication, uncomment <br>  # next line <br>  # PAMAuthentication yes <br><br>  # If you need system, Unix authentication (/ etc / passwd), <br>  # uncomment the next line <br>  # UnixAuthentication yes <br><br>  # Please note that LDAPConfigFile, MySQLConfigFile, <br>  # PAMAuthentication and UnixAuthentication can only be used <br>  # once, but they can be used together.  For example, if you <br>  # use MySQLConfigFile, then UnixAuthentication, then there is a request <br>  # to MySQL.  If the user is not found in the database, then try <br>  # system user in / etc / passwd and / etc / shadow.  If SQL <br>  # authentication fails due to incorrect password, something happens <br>  # stop further search user.  Authentication Methods <br>  # will be used in the order they are set <br><br>  # Limits of recursion of the 'ls' command.  The first argument is the maximum number of files <br>  # that will be shown.  The second is the maximum number of subdirectories. <br>  LimitRecursion 10,000 8 <br><br>  # Do anonymos have the right to create new directories? <br>  AnonymousCanCreateDirs no <br><br>  # If the system is loaded more than the value specified here, then <br>  # anonymos can not download anything <br>  MaxLoad 4 <br><br>  # Port range for passive connection.  If you have a firewall chopping <br>  # standard range <br>  # PassivePortRange 30000 50,000 <br><br>  # Forced IP address in PASV / EPSV / SPSV responses.  - for NAT. <br>  # Symbolic hostnames are also taken for dynamic IP gateways <br>  # ForcePassiveIP 192.168.0.1 <br><br>  # Upload / download ratio for anonymous. <br>  # AnonymousRatio 1 10 <br><br>  # Upload / download ratio for all users. <br>  # This directive does not override the previous one. <br>  # UserRatio 1 10 <br><br>  # Forbid download files which are owned by ‚Äúftp‚Äù, i.e. <br>  # Files have been uploaded but not approved by the local (local) admin. <br>  AntiWarez yes <br><br>  # IP address / port on which we are listening (default = all IP and port 21). <br>  #Bind 192.168.254.254,21 <br><br>  # Maximum speed for anonymos in KB / s <br>  # AnonymousBandwidth 8 <br><br>  # Maximum speed for all users (including anonymous users) in KB / s <br>  # Use AnonymousBandwidth or UserBandwidth, use both, <br>  # does not make sense. <br>  # UserBandwidth 8 <br><br>  # Mask for created files.  &lt;umask for files&gt;: &lt;umask for directories&gt;. <br>  # 177: 077 - if you are paranoid :) <br>  # umask is such a number, when subtracting which from the maximum (777) and <br>  # get the right mask.  those.  for the case below, the masks will be, respectively: <br>  # 644 for files, and 755 for directories <br>  Umask 133: 022 <br><br>  # Minimum UID with which the user will be started. <br>  # (In the native version there was 100. I put the tyschschu) <br>  MinUID 1000 <br><br>  # Enable FXP transfer for authorized users. <br>  AllowUserFXP no <br><br>  # Allow FXP transmission for anonymous and non-anonymous. <br>  AllowAnonymousFXP no <br><br>  # Users cannot delete and modify files starting with a dot ('.') <br>  # even if they are their owners.  If TrustedGID is enabled, this group has <br>  # access to these files. <br>  ProhibitDotFilesWrite no <br><br>  # Disable reading of files starting with a dot <br>  ProhibitDotFilesRead no <br><br>  # Never overwrite files.  When the name for the uploaded file is already <br>  # exists, it will be automatically renamed to file.1, file.2, file.3, ... <br>  Autorename no <br><br>  # Prevent anonymous users from uploading new files (no = upload allowed) <br>  AnonymousCantUpload no <br><br>  # Only connections to this IP address may not be anonymous.  You <br>  # can use this directive to use multiple IPs <br>  # for anonymous FTP, and leave a private, secure IP for <br>  # remote administration.  also you can allow non-usable <br>  # local IP (type 10.xxx) for authentication and leave public <br>  # (for anonymous) FTP server on a different IP. <br>  #TrustedIP 10.1.1.1 <br><br>  # If you want the PID to be added to each log line, <br>  # then open the next line. <br>  #LogPID yes <br><br>  # Create an additional log file with a log in a format like ‚Äúapache‚Äù: <br>  # fw.c9x.org - jedi [13 / Dec / 1975: 19: 36: 39] "GET /icap.tar.bz2" 200 21808 <br>  # This log file can be processed by programs for <br>  # analysis of the Apache logs. <br>  # AltLog clf: /var/log/pureftpd.log <br><br>  # Create an additional log file in a format that is optimized for <br>  # statistical reports (hz how it is. It will be necessary to look) <br>  # AltLog stats: /var/log/pureftpd.log <br><br>  # Create another log with the transferred files in the W3C standard <br>  # (compatible with many commercial analyzers) <br>  # AltLog w3c: /var/log/pureftpd.log <br><br>  # Disable the chmod command.  Users will not be able to change permissions <br>  # on files. <br>  #NoChmod yes <br><br>  # Allow users to upload but not delete files. <br>  #KeepAllFiles yes <br><br>  # Automatically create a user's home directory, <br>  # if she is missing <br>  #CreateHomeDir yes <br><br>  # Enable virtual quota.  The first number is the maximum number of files. <br>  # The second number is the maximum size, in megabytes. <br>  # So 1000: 10 limits each user 1000 files and 10 megs. <br>  #Quota 1000: 10 <br><br>  # If pure-ftpd is compiled with support for standalone mode, you can change <br>  # pid file location.  The default position is /var/run/pure-ftpd.pid <br>  #PIDFile /var/run/pure-ftpd.pid <br><br>  # If pure-ftpd is compiled with pure-uploadscript support, <br>  # this item allows you to write information about the new loaded <br>  # files in /var/run/pure-ftpd.upload.pipe so that pure-uploadscript can <br>  # read them and process the downloaded file. <br>  #CallUploadScript yes <br><br>  # This option is useful on servers where apload is allowed for anonymous. <br>  # If / var / ftp is in a separate / var section, this allows <br>  # save free space and protect log files.  When the percentage <br>  # fill more than specified here, apload automatic machine is prohibited. <br>  MaxDiskUsage 99 <br><br>  # Set 'yes' in this option if you want to allow users <br>  # rename files. <br>  #NoRename yes <br><br>  # Include 'customer proof': some kind of error, like 'chmod 0 public_html', <br>  # when working together, chtol ... In short, this is not a bug but a feature ... :) And so that <br>  # stupid clients didn‚Äôt bother your support, you need to put 'yes' in this <br>  # paragraph.  If clients have some knowledge of Unix, then this feature <br>  # useless.  If you have a hosting - turn it on. <br>  # (the translation is almost verbatim - but I did not understand what I was talking about ...) <br>  CustomerProof yes <br><br>  # Number of parallel processes.  Running current if the server was <br>  # is compiled with the option '--with-peruserlimits' (there‚Äôs something about the fact that <br>  # in most binary distributions it is). <br>  # Format: &lt;maximum sessions per user&gt;: &lt;maximum anonymos sessions&gt; <br>  # For example, 3:20 means that an authenticated user can have three <br>  # active sessions.  And for all anonymous - a maximum of 20 sessions. <br>  #PerUserLimits 3:20 <br><br>  # When a file is uploaded to the server, and there is a previous version (with the same name), <br>  # then the old file will not be deleted or truncated.  Download will be made <br>  # in a temporary file and at the end of the download will be produced atomic <br>  # Switch to the new version of the file.  For example, when loading large PHP <br>  # script, apache will work with the old version until full download <br>  # and immediately switch to a new one as current will be fully transmitted <br>  # This option is incompatible with virtual quotas. <br>  #NoTruncate yes <br><br>  # This option can take three values: <br>  # 0 - disable SSL / TLS encryption (by default). <br>  # 1 - accept both encrypted and regular connections. <br>  # 2 - reject connections that do not use SSL / TLS, <br>  # including anonymous connections. <br>  # Do not uncomment this blindly.  Check that: <br>  # 1) Server compiled with SSL / TLS support (--with-tls), <br>  # 2) Put a valid certificate <br>  # 3) Only compatible customers will login. <br>  # Tls 1 <br><br>  # List of ciphers to be accepted for SSL / TLS connections <br>  # Prefix -S: to completely disable SSL, but not TLS. <br>  # TLSCipherSuite HIGH: MEDIUM: + TLSv1:! SSLv2: + SSLv3 <br><br>  # Listen to the current IPv4 address in standalone mode (i.e. IPv6 is disabled) <br>  # By default, IPv4 and IPv6 are included. <br>  IPV4Only yes <br><br>  # Listen to the current IPv6 address in standalone mode (i.e. IPv4 is disabled) <br>  # By default, IPv4 and IPv6 are included. <br>  # IPV6Only yes <br><br>  # UTF-8 support for file names (RFC 2640) <br>  # Determine the encoding for the server's file system and, optionally, <br>  # Default encoding for non-UTF-8 clients. <br>  # Runs current if pure-ftpd is compiled with '--with-rfc2640' <br>  FileSystemCharset utf-8 <br>  ClientCharset cp1251 <br></div></div><br>  as well as the config for Pure-FTPd to work with MySql database <br><div class="spoiler">  <b class="spoiler_title">pure-ftpd.conf</b> <div class="spoiler_text">  # MySQL config for pureftpd <br><br>  # Optional: Name or IP of the MySQL server.  Don't ask this <br>  # item if a local unix socket is used. <br>  #MYSQLServer 127.0.0.1 <br><br>  # Optional: The port on which MySQL hangs.  Don't ask this <br>  # item if a local unix socket is used. <br>  #MYSQLPort 3306 <br><br>  # Optional: Sets the socket name mysql.sock if MySQL is on the same host. <br>  MYSQLSocket /tmp/mysql.sock <br><br>  # Required: user who climb in the database. <br>  MYSQLUser pure-ftpd <br><br>  # Required: the password of the user from whom we climb in MySQL. <br>  MYSQLPassword pure-ftpd <br><br>  # Required: DB we work with. <br>  MYSQLDatabase pureftpd <br><br>  # Required: how to save the password in the database <br>  # Possible values: "cleartext", "crypt", "md5" and "password" <br>  # ("Password" = MySQL password () function) <br>  # You can use "any" to try "crypt", "md5" and "password" <br>  MYSQLCrypt cleartext <br><br>  # In the following directives, parts of the lines are replaced, up to <br>  # query execution: <br>  # <br>  # \ L is replaced by the username that logs in. <br>  # \ I is replaced by the IP address of the server on which the user climbs <br>  # \ P is replaced by the port number with which the user connected. <br>  # \ R is replaced by the user‚Äôs IP address. <br>  # \ D is replaced by the IP address of the user, in the form of a long decimal number <br>  # (e.g. 192.168.254.1 == 3232300545) <br>  # <br>  # You can set up relatively complex database checks using <br>  # this set of variables.  If you use one database on multiple servers, <br>  # then "\ I" allows you to determine whether the user is breaking the server. <br><br>  # Get a password from the database: <br>  MYSQLGetPW SELECT `password` FROM` users` WHERE `user` =" \ L "AND` active` = '1' <br><br>  # Get a username or UID <br>  MYSQLGetUID SELECT `uid` FROM` users` WHERE `user` =" \ L " <br><br>  # Optional: default UID - instead of checking for its extraction MYSQLGetUID <br>  #MYSQLDefaultUID 1000 <br><br>  # Request to the database to get the name of the group or gid <br>  MYSQLGetGID SELECT `gid` FROM` users` WHERE `user` =" \ L " <br><br>  # Optional: default GID - instead of the query MYSQLGetGID <br>  #MYSQLDefaultGID 1000 <br><br>  # Request a hamster <br>  MYSQLGetDir SELECT `home` FROM` users` WHERE `user` =" \ L " <br><br>  # Optional: Request for the maximum number of files from the user <br>  # (I wonder - what is the deep meaning in it? To inode on <br>  # server did not chase chol?  :)) <br>  # Must be compiled with `virtual quotas support`. <br>  MySQLGetQTAFS SELECT `QuotaFiles` FROM` users` WHERE `user` =" \ L " <br><br>  # Optional: request for quota (disk usage) <br>  # Number in megabytes. <br>  # Pure-FTPd should be compiled with `virtual quotas support`. <br>  MySQLGetQTASZ SELECT `QuotaSize FROM` users` WHERE `user` =" \ L " <br><br>  # Optional: Relationships.  Requests for download / upload ratio. <br>  # Dol;  It is compiled with this function. <br>  MySQLGetRatio SELECT `ULRatio` FROM` users` WHERE `user` =" \ L " <br>  MySQLGetRatioDL SELECT `DLRatio` FROM` users` WHERE `user` =" \ L " <br><br>  # Optional: Channel width for user.  Server must be <br>  # compiled with this option.  The value in KB / s. <br>  MySQLGetBandwidthULULECT SELECT `ULBandwidth` FROM `users` WHERE` user` = "\ L" <br>  MySQLGetBandwidthDL SELECT `DLBandwidth` FROM users WHERE` user` = "\ L" <br><br>  # Release user from hamster (~).  Never do this if: <br>  # 1) You know exactly what you are doing. <br>  # 2) Real and virtual users match. <br>  #MySQLForceTildeExpansion 1 <br><br>  # If you updated the tables to transactional (Gemini, <br>  # BerkeleyDB, Innobase ...), you can enable SQL transactions <br>  # Leave locked out if using MyISAM databases, <br>  # or the old version of MySQL (&lt;3.23.x). <br>  #MySQLTransactions On <br></div></div><br>  Next, create the database itself ( <i>pureftpd</i> ) and a table with users ( <i>users</i> ) <br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`users`</span></span> ( <span class="hljs-string"><span class="hljs-string">`User`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`Password`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`Uid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'10000'</span></span>, <span class="hljs-string"><span class="hljs-string">`Gid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'10000'</span></span>, <span class="hljs-string"><span class="hljs-string">`Dir`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">`QuotaFiles`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`QuotaSize`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`ULRatio`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`DLRation`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ULBandwidth`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`DLBandwidth`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`Comment`</span></span> tinytext, <span class="hljs-string"><span class="hljs-string">`active`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`User`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre><br>  Add to <i>/etc/rc.conf</i> <br><pre> <code class="bash hljs">pureftpd_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre><br>  and run our FTP server <br><pre> <code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/rc.d/pure-ftpd start Starting pureftpd. Running: /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/pure-ftpd -g/var/run/pure-ftpd.pid -A -c50 -B -C10 -D -fftp -I15 -lmysql:/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/pureftpd-mysql.conf -L10000:8 -m4 -s -U133:022 -u80 -k99 -Z -8utf-8 -9cp1251</code> </pre><br>  It would seem that everything.  It remains to get the user to the users table (specify login, password, home directory) and try to connect.  But I was not bothered by the issue of restricting access to the user by his IP address.  In the classic case, the ip field is added to the user table, and the sql query for MYSQLGetPW in pureftpd-mysql.conf takes the following form <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Password</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>=<span class="hljs-string"><span class="hljs-string">'\L'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ip=<span class="hljs-string"><span class="hljs-string">'\R'</span></span></code> </pre><br>  But he does not suit me.  Firstly, for each user you need to set the IP address from which he will connect, and secondly, you can set only one single IP.  In real life, only certain users need to bind to IP's, and the ability to specify the n-th number of IP addresses for one user. <br><br>  MySql syntax includes program flow control functions, among which we need the <a href="http://www.mysql.ru/docs/man/Control_flow_functions.html">IF</a> function <br><br>  Create an IP table <br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`ip`</span></span> ( <span class="hljs-string"><span class="hljs-string">`user`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ip`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre><br>  We give the sql query for MYSQLGetPW to the following form: <br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> COUNT(`<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>`) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ip <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=<span class="hljs-string"><span class="hljs-string">'\L'</span></span>)=<span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Password</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> users <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>=<span class="hljs-string"><span class="hljs-string">'\L'</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> users.<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> users,ip <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> users.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>=<span class="hljs-string"><span class="hljs-string">'\L'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ip.ip=<span class="hljs-string"><span class="hljs-string">'\R'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ip.<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=<span class="hljs-string"><span class="hljs-string">'\L'</span></span>))</code> </pre><br>  In the end result, all users for whom no entries in the IP table will be authenticated without checking for an IP address, and for those users who are registered in the IP table, they will check what IP address they are trying to connect to, and you can set unlimited number of IP addresses for one login </div><p>Source: <a href="https://habr.com/ru/post/183170/">https://habr.com/ru/post/183170/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../183154/index.html">Infrastructure of fail-safe data center class TIER-III</a></li>
<li><a href="../183158/index.html">IBM promotes Linux in the corporate segment</a></li>
<li><a href="../183164/index.html">My job is to wait for IT disasters</a></li>
<li><a href="../183166/index.html">Acoustic Surveillance Systems</a></li>
<li><a href="../183168/index.html">Cloud computing threats and methods to protect them</a></li>
<li><a href="../183172/index.html">Download Youtube playlist in mp3 format with one bash-script</a></li>
<li><a href="../183176/index.html">IPv6 practice</a></li>
<li><a href="../183182/index.html">Yandex on the draft law on arbitrary blocking of sites: continued</a></li>
<li><a href="../183184/index.html">USB support in KolibriOS: what's inside? Part 2: Basics of working with host controllers</a></li>
<li><a href="../183186/index.html">Free course of 11 lectures on marketing, sales and customer service in a web-studio / agency</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>