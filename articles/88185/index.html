<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Everyone knows that "++ i + ++ i" is bad, but what is behind the screen?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Undoubtedly, all programmers know that using expressions like the one in the title of the post is not something that is undesirable, but strictly cont...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Everyone knows that "++ i + ++ i" is bad, but what is behind the screen?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/7df/5b3/66d/7df5b366d55af1aff25a92cd162992af.jpg" alt="Bug peeking out from behind a screen at you o_O" align="right">  Undoubtedly, all programmers know that using expressions like the one in the title of the post is not something that is undesirable, but strictly contraindicated.  Such constructs, the behavior of the compiler in which is not defined, can bring many subtle errors and undesirable consequences.  But I am sure that many novice programmers would like to understand this problem more deeply and, looking behind the compiler screen, to find out exactly what is happening in such cases.  I dedicate this post to the study of one of the examples of such code.  Welcome under the cat :) <br><a name="habracut"></a><br><h4>  Object of study </h4><br>  For example, I will analyze the work of the expression " <code>++i + ++i</code> " in two different languages: C and C #.  The first, as you know, is compiled into native processor code, and the second, if roughly, works on the basis of a virtual stack machine.  And so, consider the examples themselves: <br><br><h5>  Source code in C: </h5><ol><li>  <font color="black">#include &lt;stdio.h&gt;</font> </li><li></li><li>  <font color="black"><font color="#0000ff">void</font> main ()</font> </li><li>  <font color="black">{</font> </li><li>  <font color="black"><font color="#0000ff">int</font> i = 5;</font> </li><li>  <font color="black">i = ++ i + ++ i;</font> </li><li>  <font color="black">printf ( <font color="#A31515">"% d \ n"</font> , i);</font> </li><li>  <font color="black">}</font> </li></ol><br><h5>  And the source code in C #: </h5><ol><li>  <font color="black"><font color="#0000ff">using</font> System;</font> </li><li></li><li>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> Test</font> </li><li>  <font color="black">{</font> </li><li>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Main ()</font> </li><li>  <font color="black">{</font> </li><li>  <font color="black"><font color="#0000ff">int</font> i = 5;</font> </li><li>  <font color="black">i = ++ i + ++ i;</font> </li><li>  <font color="black"><font color="#2B91AF">Console</font> .WriteLine (i);</font> </li><li>  <font color="black">}</font> </li><li>  <font color="black">}</font> </li></ol><br><h4>  Behind the Screen C </h4><br>  Using the disassembler, let's see something the same as generated by the C compiler: <br><br><pre> # A # 5: int i = 5;                        
   cs: 0295 BE0500 mov si, 0005  
 # A # 6: i = ++ i + ++ i;                    
   cs: 0298 46 inc si       
   cs: 0299 ‚Äã‚Äã46 inc si       
   cs: 029A 8BC6 mov ax, si    
   cs: 029C 03C6 add ax, si    
   cs: 029E 8BF0 mov si, ax    
 # A # 7: printf ("% d \ n", i);                 
   cs: 02A0 56 push si       
   cs: 02A1 B8AA00 mov ax, 00AA  
   cs: 02A4 50 push ax       
   cs: 02A5 E8330C call _printf  
</pre><br>  As can be seen from the listing, the compiler has mapped the variable <code>i</code> to the <code>SI</code> register of the <code>x86</code> .  After that, double-incrementing this register, I added it to myself through the <code>AX</code> battery.  As a result, the variable <code>i</code> becomes equal to 14. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Behind the screen C # </h4><br>  With the help of <a href="http://msdn.microsoft.com/en-us/library/f7dy01k1%2528VS.80%2529.aspx">Ildasm,</a> let's see what lies behind C #: <br><br><pre> .method public hidebysig static void Main () cil managed
 {
   .entrypoint
   // Code size 21 (0x15)
   .maxstack 3
   .locals init (int32 V_0)
   IL_0000: ldc.i4.5 // push 5 5
   IL_0001: stloc.0 // i: = pop () null
   IL_0002: ldloc.0 // push ii
   IL_0003: ldc.i4.1 // push 1 i, 1
   IL_0004: add // push (pop () + pop ()) (i + 1)  6
   IL_0005: dup // copy top of stack 6, 6
   IL_0006: stloc.0 // i: = pop () // i: = 6 6
   IL_0007: ldloc.0 // push i 6, i
   IL_0008: ldc.i4.1 // push 1 6, i, 1
   IL_0009: add // push (pop () + pop ()) 6, (i + 1) i.e.  7
   IL_000a: dup // copy tops of stack 6, 7, 7
   IL_000b: stloc.0 // i: = pop () // i: = 7 6, 7
   IL_000c: add // push (pop () + pop ()) 13
   IL_000d: stloc.0 // i: = pop () null
   IL_000e: ldloc.0 // push ii
   IL_000f: call void [mscorlib] System.Console :: WriteLine (int32)
   IL_0014: ret
 } // end of method Test :: Main
</pre><br>  For clarity, I added comments to the assembler of the virtual stack machine.  Looking at the listing, you can see that for the increment of the variable <code>i</code> , the variable itself and the unit are pushed onto the stack.  Then the addition command is executed which, taking two values ‚Äã‚Äãfrom the stack and adding, pushes the result back onto the stack.  Then duplication of the top of the stack occurs and the value is written back to the variable.  Thus, <code>5 + 1</code> remains in the stack, i.e.  6. Next, the cycle repeats for another increment: the variable is pushed onto the stack, followed by the unit, the addition, duplication of the vertex occurs, and the result of the second increment is written back into the variable.  Now <code>i</code> will be 7, and 6 from the first case and 7 from the second will remain in the stack.  Then the command of addition is executed and the result, now equal to 13, is entered into the variable. <br><br><h4>  Results </h4><br>  Here it is, it looks the same, the code is executed completely differently in different conditions.  Avoid such code in your programs. <br><br>  If the topic seemed interesting to you - let me know, and I will write a couple more interesting moments from the world of compilation;) <br><br>  <b>UPD</b> .  The comments suggest that in <a href="http://habrahabr.ru/blogs/crazydev/88185/">PHP</a> , <a href="http://habrahabr.ru/blogs/crazydev/88185/">Java</a> , <a href="http://habrahabr.ru/blogs/crazydev/88185/">Actionscript 3</a> , <a href="http://habrahabr.ru/blogs/crazydev/88185/">JavaScript</a> and <a href="http://habrahabr.ru/blogs/crazydev/88185/">TCL, the</a> result is also 13, but in <a href="http://habrahabr.ru/blogs/crazydev/88185/">Perl</a> , <a href="http://habrahabr.ru/blogs/crazydev/88185/">K ++</a> and <a href="http://habrahabr.ru/blogs/crazydev/88185/">C GCC</a> - 14 (but the result of GCC may depend on the optimizer settings) :) <br><br>  <a href="http://habrahabr.ru/blogs/crazydev/88185/">PL / SQL</a> and <a href="http://habrahabr.ru/blogs/crazydev/88185/">Python</a> distinguished themselves - 10 (as KO suggests, due to the lack of increments in the language), however <a href="http://habrahabr.ru/blogs/crazydev/88185/">Bash</a> - 12. <br><br>  There are also compilers that do not allow writing such code.  For example <a href="http://habrahabr.ru/blogs/crazydev/88185/">Ruby</a> (or like <a href="http://habrahabr.ru/blogs/crazydev/88185/">this</a> ). <br><br>  And what will be the result in your,% username%, compiler? <br><br>  <b>UPD2</b> .  Related links: <a href="http://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25BE%25D1%2587%25D0%25BA%25D0%25B0_%25D1%2581%25D0%25BB%25D0%25B5%25D0%25B4%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F">Wikipedia</a> follow points, <a href="http://alenacpp.blogspot.com/2005/11/sequence-points.html">Alena C ++</a> . </div><p>Source: <a href="https://habr.com/ru/post/88185/">https://habr.com/ru/post/88185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../88178/index.html">Chef 0.8.8 Release</a></li>
<li><a href="../88179/index.html">Writing posts in Google Buzz from Jabber</a></li>
<li><a href="../88180/index.html">Twitter broadcast</a></li>
<li><a href="../88182/index.html">Differences between Silverlight on Windows and Windows Phone</a></li>
<li><a href="../88183/index.html">LegalCamp: video and how it was</a></li>
<li><a href="../88188/index.html">On demand functions</a></li>
<li><a href="../88189/index.html">Amazon Kindle for Mac 1.0</a></li>
<li><a href="../88190/index.html">The offender was calculated by the dog's DNA</a></li>
<li><a href="../88193/index.html">We learn the PC to talk</a></li>
<li><a href="../88194/index.html">Giant pliers in the sky on google street view</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>