<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How the heartbeat sounds: the transfer of a paper cardiogram to WAV-format</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many have repeatedly had to deal with the examination of the heart in medical institutions using a cardiograph. This unit measures the bioelectric act...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How the heartbeat sounds: the transfer of a paper cardiogram to WAV-format</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/vd/8i/cs/vd8icsdtkcxv6x3i-djvtgs6hrs.jpeg"><br>  Many have repeatedly had to deal with the examination of the heart in medical institutions using a cardiograph.  This unit measures the bioelectric activity of the heart by recording the result on a paper tape.  Modern cardiographs record the measurement result not on paper, but in digital memory.  However, paper tape is often used as the final carrier of recorded information.  Visually, it is a long millimeter paper of small width, which is twisted into a roll.  On paper, in addition to the millimeter grid, a certain graph is drawn full-length, which reflects the law of change of the measured value in time.  The measured quantity, as I understand it, is the potential difference between the leads.  Most often, several diagrams are represented on one tape at once, since potential differences between multiple leads are recorded.  However, without going into details of medicine, in the future we will consider one of the first main graphs.  In addition to the graphs, there is additional textual information on the tape: horizontal scale (mm / s), vertical (mm / mV), measured heart rate (beats / min) and so on. <br><br>  The idea arose to convert this graphic into audio format, reproduce the result and listen to how it will sound. <br><a name="habracut"></a><br>  According to preliminary analysis, we can conclude that the frequency composition of such a wave is not very saturated.  In fact, these are low frequencies, including infrasound, which is not supposed to be heard.  However, it will be possible to see how the woofer diffuser will repeat the vibrations, similar to the "vibrations" of the heart.  In fact, due to the presence of capacitive differentiating circuits in the path of the signal from the PC sound card to the LF amplifier, the oscillations of the dynamic head will not exactly repeat the oscillations shown on the cardiogram.  And this is on condition that no filters are installed anywhere that cut ultra-low frequencies.  In addition, nonlinear distortions will be present, accompanied by multiple high-frequency harmonics.  However, without taking into account the above analysis, we set the task as follows: convert the graph on paper to WAV format, so that when opening this file in the audio editor, the wave view coincides with the paper version and, moreover, the time scale corresponds. <br><br>  First you need to estimate the quantization depth (vertical audio resolution of digital audio).  I consider one of the standard: 8 or 16 bits.  The second variant (16 bits) is 65536 samples vertically, which will correspond to 65536 pixels of a picture, which is a scan or photo of a cardiogram.  This is a lot, and there is no point in it.  If you take 8 bits - this is 256 samples, or 256 pixels of a picture.  Now this is a more suitable option.  In this case, the dynamic range of audio will be 6 * 8 = 48 dB.  I do not know what the dynamic range of the cardiogram, but I think that no more.  In the apparatus itself, it is naturally more, but the error is inevitable when the cardiogram is put on paper, especially when it comes to direct pen drawing.  By the way, about the latter.  I will not take into account the old patterns, which are drawn by a ‚Äúradial‚Äù pen.  Millimeter paper tape for such cardiograms is specific: vertical arcs of circles are applied instead of straight lines.  As for the horizontal scale - the sampling rate - will be calculated based on the scale of the ECG and image size.  The speed of reproduction will depend on this parameter, and it should correspond to the real ‚Äúcardiogram speed‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Cardiogram paper should be scanned in b / w with shades of gray in sufficient resolution.  Then you need to resize the image so that the desired cardiogram fits into a 256 pixel wide strip.  I found on the Internet a lot of images with cardiograms.  As an example, consider two of them. <br><br><img src="https://habrastorage.org/webt/6a/ao/ve/6aaoveakfnrluqr-m-hybxevcly.jpeg"><br><br>  The first image, one can say, is almost ready.  The image height is 431. Width is 1023. A wave in width completely fills the entire drawing.  But the height must be left 256, cutting off the image above and below so that the wave is located approximately in the center. <br><br><img src="https://habrastorage.org/webt/1y/pl/9b/1ypl9b8u33wmyo2xa6cdkhbx9n0.png"><br><br>  The second image shows several cardiograms at once.  Take the very first.  After cropping, a 508 by 61 picture was obtained. <br><br><img src="https://habrastorage.org/webt/od/sr/nc/odsrncybq1ghgyy1tmf-x7rxmh4.png"><br><br>  Without stretching the image vertically, we will make a picture at a height of 256, filling the created area with a white void.  The wave should also be located approximately in the center.  When cutting, I chose width 508 so as to leave as many as possible whole millimeter cells, which are also visible in the image. <br><br>  Both images need to be converted to a view in which only a black graph is visible on a white background and nothing else.  This is done elementary.  Due to the fact that the graph is drawn much fatter than the millimeter grid, the desired result can be achieved in the graphical editor with the help of ‚Äúbrightness, contrast, saturation‚Äù adjustments.  If the ideal transformation does not work, the excess ‚Äúgarbage‚Äù over the chart should be erased with the eraser tool.  All images must be saved in monochrome BMP format.  Thus, in the picture, only white and black colors will definitely remain. <br><br>  Before proceeding to the description of the algorithm for converting images to WAV, it is worthwhile to stipulate some nuances that will simplify programming.  The resulting images must be rotated 90 degrees counterclockwise (the width and height of the image will swap places).  This is necessary in order to orient the beginning of the cardiogram with the beginning of the BMP file.  It is known that the color data of each pixel of a BMP file is written to the file in order, line by line, starting from the bottom left corner.  Then you need to open the pictures in the MS Paint editor (I have Windows XP) and save to 8-bit BMP (256 colors).  Of course, there will be a "redefinition of information", but in this format, each pixel of the image corresponds to one byte, which is very convenient when programming.  Byte "0" is a black pixel, and byte "255" is white.  As a result, you should get something like the following (here two pictures are connected and halved). <br><br><img src="https://habrastorage.org/webt/vr/cc/nh/vrccnhi1qkyegtfpanecxls5c40.jpeg"><br><br>  As for the output format, we will not output to the standard WAV file, but to the RAW data (PCM) file.  It also simplifies programming, because when outputting to WAV, you still need to take care of the 44-byte header.  In the popular audio editor "Adobe Audition 1.5" PCM file opens without problems.  Moreover, you can even output decimal PCM data to a text file in a column, having previously formed a specific text header.  Oddly enough, Adobe Audition also opens such files. <br><br>  We describe the conversion algorithm.  And the algorithm is very simple: you need to analyze each line of the BMP file from the bottom up.  The analysis will consist in counting white pixels in a row from left to right until black is encountered.  The resulting non-negative integer values ‚Äã‚Äãmust be written to the output PCM file in binary form.  The size of the output file will be exactly the same as the height of the processed image.  The quantization depth of 8 bits of PCM audio data format implies encoding of samples according to the same principle.  The value ‚Äú0‚Äù is the maximum negative value of the audio sample, the value ‚Äú255‚Äù is the maximum positive, and ‚Äú128‚Äù is the zero value (in the middle).  For example, the PCM audio data file of silence will contain the same byte value "128".  It is necessary to stipulate that in the line there may be several consecutive black pixels, depending on the thickness of the line of the cardiogram.  But the described algorithm "catches" the upper envelope, which is quite enough.  Moreover, the sharp peaks of the cardiogram, directed upwards, will be better grasped in this way. <br><br>  Now you can start writing the text of the program.  The program written in C is very simple and does not need detailed comments. <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; // ,  ; int main(){ //  ; FILE *in,*out; //   ; unsigned long int h,i; //    ; unsigned char px,s; //     ; in=fopen("1.bmp","rb"); //   ; out=fopen("1.pcm","wb"); //   ; fseek(in,22,SEEK_SET); //    ,     fread(&amp;h,4,1,in); //   (4 ); for(i=0;i&lt;h;i++){ // -   ; fseek(in,0x436+i*256,SEEK_SET); //   i-  s=0; //  ( ); do{ //  ; fread(&amp;px,1,1,in); //  ; s+=1; //   ; }while(px); // ,     ; fwrite(&amp;s,1,1,out); //     ; } fclose(in); //  ; fclose(out); //  ; return 0; //  ; }</span></span></span></span></code> </pre> <br><br>  After the program is executed on the file "1.bmp" a file "1.pcm" will be created in the same directory with the program.  When you try to open a file in Adobe Audition, the following window should pop up. <br><br><img src="https://habrastorage.org/webt/sw/lj/pg/swljpg5dphpocfdbnvsartz0k-8.png"><br><br>  It is necessary to select ‚ÄúMono‚Äù, ‚Äú8-bit‚Äù and type the sampling rate in the input field based on the calculation: f = h / (s / v), where h is the height of the image (it is also the number of samples in the audio), s - cardiogram length in millimeters, v - cardiogram scale in mm / sec.  The last parameter is written on the cardiogram.  On the first cardiogram nothing is written, but the scale, as a rule, is often 25 mm / sec.  Calculations of sample rates in Excel for our examples are shown in the figure below. <br><br><img src="https://habrastorage.org/webt/tl/vw/jp/tlvwjpkgjgxsh2z5bwrgkmzjuy8.png"><br><br>  As mentioned above, we enter in the appropriate field the necessary sampling rates for each of the examples.  You can even enter decimals, anyway, then there will be an automatic rounding to the whole. <br><br><img src="https://habrastorage.org/webt/ha/tr/jt/hatrjtjokkoinjcox4ed9ushjiw.png"><br><br>  When you click ‚ÄúOK‚Äù, we agree that we work with ‚ÄúUnsigned 8 bit‚Äù samples (there will be another window), after which the waveform of our file will unfold in the main field of the sound editor.  Note that this view will be presented ‚Äúupside down‚Äù, and for full compliance with the paper version, you should invert the wave in the corresponding menu.  As a result, it will look like this. <br><br><img src="https://habrastorage.org/webt/ru/pf/zj/rupfzjhna9czkxh3xifzjuzhubu.png"><br><br>  The second cardiogram looks "quieter", as it was initially not very large in size. <br><br><img src="https://habrastorage.org/webt/-u/fl/vz/-uflvzhf_iswthnmhrwsdd3xvl4.png"><br><br>  Unfortunately, not all sound cards allow you to play audio at an arbitrary sampling rate, more precisely, the vast majority are not able to.  In order to correctly play the file, you must perform the function "Convert a sample type."  We will convert to the nearest standard value of 8000 Hz, at the same time we will increase the resolution in amplitude to 16 bits.  The latter is necessary for accuracy at the interpolation stage when upsampling.  If you leave 8 bits, the remaining spectrum will be filled with quantization noise.  Incidentally, this procedure could be performed programmatically at the BMP-PCM conversion stage, even using interpolation.  But one of the goals was the simplicity of the program code. <br><br>  After the upsampling operation, you can listen and enjoy the result.  You can save the result in a standard wav or mp3 file.  It sounds exactly the same as I expected initially. <br><br>  Using <a href="https://cloud.mail.ru/public/FwSY/Tx3h2zdpi">this</a> link you can download the rar-archive, which contains two wave files with the result. </div><p>Source: <a href="https://habr.com/ru/post/419527/">https://habr.com/ru/post/419527/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419511/index.html">typeof (T) vs. TypeOf‚ü®T‚ü©</a></li>
<li><a href="../419513/index.html">Setting a password security policy in Zimbra</a></li>
<li><a href="../419519/index.html">Tips for launching a mobile game: Part 1, Soft launch</a></li>
<li><a href="../419523/index.html">PVS-Studio team is open-minded when writing articles</a></li>
<li><a href="../419525/index.html">From API first on Swagger to Single contract on RAML</a></li>
<li><a href="../419531/index.html">We select the perfect match for your ears: ten practical tips</a></li>
<li><a href="../419535/index.html">Toaster Update</a></li>
<li><a href="../419537/index.html">Cyberdemona: artificial intelligence DOOM 2016</a></li>
<li><a href="../419545/index.html">Material 2.0 for developers. Overview of new components</a></li>
<li><a href="../419547/index.html">Organizing regular digest logs with python and ansible using asterisk as an example</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>