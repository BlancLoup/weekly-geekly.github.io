<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compressing DFM resources in Delphi programs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I wanted to somehow try to compress the resources of the dfm forms of my application, the advantages are quite controversial (complex forms can contai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compressing DFM resources in Delphi programs</h1><div class="post__text post__text-html js-mediator-article">  I wanted to somehow try to compress the resources of the dfm forms of my application, the advantages are quite controversial (complex forms can contain many graphic resources that are stored in the dfm file as a buffer with bmp, which can be quite well compressed, as well as protection from viewing and editing form resources) but there are several programs that allow you to do this, so someone needs it. <br><br>  We write the application DFMCompressor, which will extract dfm resources from the exe file, compress them and write back replacing the originals. <br><a name="habracut"></a><br><h4>  Compressor operation algorithm </h4><br>  The compressor finds dfm resources and compresses them.  All his work can be decomposed into steps: <br><ul><li>  Extract all DFM application resources </li><li>  Compress them </li><li>  Remove found resources from application </li><li>  Write compressed resources to the application </li></ul><br>  For consistency of the following code for the implementation of these steps, we introduce a special type, a dictionary that will contain the name of the resource and its body: <br><br><pre><code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-comment"><span class="hljs-comment">//   DFM     TDFMByNameDict = TObjectDictionary&lt;string, TMemoryStream&gt;;</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Most of the compressor is tied to work with resources exe file.  The Windows API <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ff468902(v%3Dvs.85).aspx">contains functions for working with resources</a> ; we will need two main functions: <br><ul><li>  EnumResourceNames - getting resource names </li><li>  UpdateResource - add / delete resources </li></ul><br>  Since we will work with resources only in the context of Delphi DFM resources, in order to simplify the code, we will make the following assumptions: <br><ul><li>  All operations relate only to resources of type RT_RCDATA </li><li>  LangId resources are always used as 0, since this is exactly the LangId of dfm forms </li></ul><br><h4>  DFM resource lookup </h4><br>  The algorithm is simple, go through all the resources from RT_RCDATA, and check if they are DFM resources. <br><br>  DFM resources have a signature, the first 4 bytes contain the string 'TPF0', we write a function to check: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsDfmResource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Stream: TStream)</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FilerSignature: <span class="hljs-keyword"><span class="hljs-keyword">array</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>..<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> AnsiChar = AnsiString(<span class="hljs-string"><span class="hljs-string">'TPF0'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Signature: LongInt; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Stream.Position := <span class="hljs-number"><span class="hljs-number">0</span></span>; stream.<span class="hljs-keyword"><span class="hljs-keyword">Read</span></span>(Signature, SizeOf(Signature)); Result := Signature = LongInt(FilerSignature); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  Now, being able to distinguish DFM resources from the rest, we will write the function of getting them: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadDFMs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> FileName: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> TDFMByNameDict; <span class="hljs-comment"><span class="hljs-comment">//Callback-     //       function EnumResNameProc(Module: THandle; ResType, ResName: PChar; lParam: TDFMByNameDict): BOOL; stdcall; var ResStream: TResourceStream; begin Result := True; //  ResStream := TResourceStream.Create(Module, ResName, ResType); try //   DFM  if not IsDfmResource(ResStream) then Exit; // DFM ,        lParam.Add(ResName, TMemoryStream.Create); lParam[ResName].CopyFrom(ResStream, 0); finally FreeAndNil(ResStream); end; end; var DllHandle: THandle; begin Result := TDFMByNameDict.Create([doOwnsValues]); try DllHandle := LoadLibraryEx(PChar(FileName), 0, LOAD_LIBRARY_AS_DATAFILE); Win32Check(DllHandle &lt;&gt; 0); try EnumResourceNamesW(DllHandle, RT_RCDATA, @EnumResNameProc, Integer(Result)); finally FreeLibrary(DllHandle); end; except FreeAndNil(Result); raise; end; end;</span></span></code> </pre><br><h4>  Compress the contents of the resources found </h4><br>  We‚Äôll reap with Zlib, so this function compresses TMemoryStream: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ZCompressStream</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Source: TMemoryStream)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pOut: Pointer; outSize: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ZCompress(Source.Memory, Source.Size, pOut, outSize, zcMax); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> Source.Size := outSize; Move(pOut^, Source.Memory^, outSize); Source.Position := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> FreeMem(pOut); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  Now it is easy to write a procedure that will compress all resources from our list: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompressDFMs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DFMs: TDFMByNameDict)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Stream: TMemoryStream; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Stream <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DFMs.Values <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ZCompressStream(Stream); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><h4>  Deleting resources </h4><br>  To delete a resource, call the <b>UpdateResource</b> function and pass a null pointer to the data into it.  But the thing is that the removal of resources is implemented in such a way that it does not reduce the exe file, Windows simply deletes the resource record from the resource table, while the place that occupied the resource remains and is not redistributed.  Our goal is not just to encrypt dfm'ki, but also to reduce the overall size of the program on their compression, so the Win API will not help.  Fortunately, there is a solution, the madBasic library from <a href="http://www.madshi.net/">madCollection</a> contains the <a href="http://www.madshi.net/">madRes.pas</a> module, which implements functions for working with resources, including deleting resources, and the authors tried and made the function call syntax-compatible with the Windows API, for which a special thank you. <br><br>  Knowing all this, the procedure for deleting resources was as follows: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteDFMs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> FileName: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">; DFMs: TDFMByNameDict)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ResName: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; Handle: THandle; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Handle := MadRes.BeginUpdateResourceW(PChar(FileName), False); Win32Check(Handle &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ResName <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DFMs.Keys <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Win32Check(MadRes.UpdateResourceW(Handle, RT_RCDATA, PChar(ResName), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> Win32Check(MadRes.EndUpdateResourceW(Handle, False)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br><h4>  Add resources to the application </h4><br>  Adding resources is no more difficult than deleting, here's the code: <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//   EXE  procedure AddDFMs(const FileName: string; DFMs: TDFMByNameDict); var Handle: THandle; Item: TPair&lt;string, TMemoryStream&gt;; begin Handle := BeginUpdateResource(PChar(FileName), False); Win32Check(Handle &lt;&gt; 0); try for Item in DFMs do Win32Check(UpdateResource(Handle, RT_RCDATA, PChar(Item.Key), 0, Item.Value.Memory, Int64Rec(Item.Value.Size).Lo)); finally Win32Check(EndUpdateResource(Handle, False)); end; end;</span></span></code> </pre> <br>  I think the code questions will not cause.  We disassembled and wrote the code for all steps of our algorithm, it's time to build an application that implements the necessary functionality. <br><br><h4>  Compressor Finishing Touches </h4><br>  We will write the main procedure that will implement all the above steps together: <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//   procedure ExecuteApplication(const FileName: string); var DFMs: TDFMByNameDict; begin //  DFM    DFMs := LoadDFMs(FileName); try //   ,  if DFMs.Count = 0 then Exit; //   CompressDFMs(DFMs); //     DeleteDFMs(FileName, DFMs); //   ,  AddDFMs(FileName, DFMs); finally FreeAndNil(DFMs); end; end;</span></span></code> </pre> <br>  Actually, it is quite possible to assemble the application.  Create a new console application project in Delphi, save it with the name dfmcompressor.dpr and make the program: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">program</span></span> dfmcompressor; <span class="hljs-meta"><span class="hljs-meta">{$APPTYPE CONSOLE}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> Windows, SysUtils, Classes, Generics.Collections, ZLib, madRes; <span class="hljs-comment"><span class="hljs-comment">// //       // begin try ExecuteApplication(ParamStr(1)); Writeln('Done.') except on E: Exception do Writeln(E.ClassName, ': ', E.Message); end; end.</span></span></code> </pre> <br>  We collect, set on a thread vcl application, and it works! <br><br>  Resources are compressed, but the program now crashes, no wonder, because vcl does not know that resources are now compressed. <br><br><h4>  We learn the program to use resources compressed DFM </h4><br>  It's time to create a test application on which to conduct the experiments.  Let's create a new empty VCL project, in the project properties we will write so that after compilation it will be processed by dfmcompressor, so that you can debug modules delphi, you need to enable the use of debug dcu in the project properties. <br><br>  We start, we die with an exception, and we can study how the control reached the form loading. <br><br>  Actually, the stack shows that the classes.InternalReadComponentRes procedure was called in which the resources are loaded: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InternalReadComponentRes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ResName: UnicodeString; HInst: THandle; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Instance: TComponent)</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">overload</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HRsrc: THandle; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-comment"><span class="hljs-comment">{ avoid possible EResNotFound exception }</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> HInst = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> HInst := HInstance; HRsrc := FindResourceW(HInst, PWideChar(ResName), PWideChar(RT_RCDATA)); Result := HRsrc &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> Result <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> TResourceStream.Create(HInst, ResName, RT_RCDATA) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> Instance := ReadComponent(Instance); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; Result := True; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><br>  Well, let's try to make changes.  To do this, copy classes.pas to the directory with our test application (so that the modified file is picked up when compiling), and modify the specified procedure so that the file is unpacked: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InternalReadComponentRes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ResName: UnicodeString; HInst: THandle; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Instance: TComponent)</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">overload</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Signature: Longint; ResStream: TResourceStream; DecompressStream: TDecompressionStream; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := True; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> HInst = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> HInst := HInstance; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FindResource(HInst, PChar(ResName), PChar(RT_RCDATA)) = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>(False); ResStream := TResourceStream.Create(HInst, ResName, RT_RCDATA); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-comment"><span class="hljs-comment">//,    //   DFM ,     ResStream.Read(Signature, SizeOf(Signature)); //  ResStream.Position := 0; //  ,       if Signature = Longint(FilerSignature) then Instance := ResStream.ReadComponent(Instance) else begin //    ,   DFM DecompressStream := TDecompressionStream.Create(ResStream); try Instance := DecompressStream.ReadComponent(Instance); finally FreeAndNil(DecompressStream); end; end; finally FreeAndNil(ResStream); end; end;</span></span></code> </pre> <br>  You also need to remember to add the Zlib module to the uses section of the implementation section <br>  We collect, we start - everything works! <br><br><h4>  Develop the idea </h4><br>  It seems everything works - but to drag with the application the modified classes.pas is an extreme measure, we will try to do something.  Ideally, put a hook on the InternalReadComponentRes function and redirect its call to its implementation. <br><br>  A hook is done very simply by forming a long jump command on its function, and inserting it into the beginning of the InternalReadComponentRes.  Yes, with this approach, vcl will not be able to call its InternalReadComponentRes, but we don‚Äôt need this.  We write the interception setting function: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> PJump = ^TJump; TJump = <span class="hljs-keyword"><span class="hljs-keyword">packed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">record</span></span> OpCode: Byte; Distance: Pointer; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReplaceProcedure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ASource, ADestination: Pointer)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> NewJump: PJump; OldProtect: Cardinal; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> VirtualProtect(ASource, SizeOf(TJump), PAGE_EXECUTE_READWRITE, @OldProtect) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> NewJump := PJump(ASource); NewJump.OpCode := $E9; NewJump.Distance := Pointer(Integer(ADestination) - Integer(ASource) - <span class="hljs-number"><span class="hljs-number">5</span></span>); FlushInstructionCache(GetCurrentProcess, ASource, SizeOf(TJump)); <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> VirtualProtect(ASource, SizeOf(TJump), OldProtect, @OldProtect); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> <br>  But it does not work out this way, because the definition of the procedure InternalReadComponentRes is absent in the interface section, which means we cannot recognize the pointer to it. <br><br>  Returning to the form loading stack and examining it, you can see that InternalReadComponentRes is called from InitInheritedComponent, which is a public function and can be intercepted.  It also plays into the hands of the fact that InitInheritedComponent does not call any private functions from classes.pas (of course, except for the one we are changing), which means duplication of the code will be minimal. <br><br>  We implement everything in the module, connecting which the program learns to read compressed resources to the project: <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">{     DFM    }</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> DFMCompressorSupportUnit; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> Windows, SysUtils, Classes, ZLib; <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-comment"><span class="hljs-comment">//  classes.pas FilerSignature: array[1..4] of AnsiChar = AnsiString('TPF0'); // //     ReplaceProcedure  //   InternalReadComponentRes // //  classes.pas function InitInheritedComponent(Instance: TComponent; RootAncestor: TClass): Boolean; function InitComponent(ClassType: TClass): Boolean; begin Result := False; if (ClassType = TComponent) or (ClassType = RootAncestor) then Exit; Result := InitComponent(ClassType.ClassParent); Result := InternalReadComponentRes(ClassType.ClassName, FindResourceHInstance(FindClassHInstance(ClassType)), Instance) or Result; end; var LocalizeLoading: Boolean; begin GlobalNameSpace.BeginWrite; // hold lock across all ancestor loads (performance) try LocalizeLoading := (Instance.ComponentState * [csInline, csLoading]) = []; if LocalizeLoading then BeginGlobalLoading; // push new loadlist onto stack try Result := InitComponent(Instance.ClassType); if LocalizeLoading then NotifyGlobalLoading; // call Loaded finally if LocalizeLoading then EndGlobalLoading; // pop loadlist off stack end; finally GlobalNameSpace.EndWrite; end; end; initialization ReplaceProcedure(@Classes.InitInheritedComponent, @InitInheritedComponent); end.</span></span></code> </pre> <br><h4>  Conclusion </h4><br>  All this works and was tested on Delphi 2010, I will not know how it will work on other versions, but I think having this guide to adapt will not be a problem. </div><p>Source: <a href="https://habr.com/ru/post/238961/">https://habr.com/ru/post/238961/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238951/index.html">IB in American. Part 2. Is it possible to learn more about NIST 800-53 and where does risk management go?</a></li>
<li><a href="../238953/index.html">Nanodegrees after online training are recognized by large IT companies</a></li>
<li><a href="../238955/index.html">IBM has improved nanotube manufacturing for Racetrack Memory</a></li>
<li><a href="../238957/index.html">11 basic principles of effective landing</a></li>
<li><a href="../238959/index.html">Restarting the Golden Site - the oldest competition of Internet projects Runet</a></li>
<li><a href="../238967/index.html">Health through the ass: smart pillow out on Kickstarter</a></li>
<li><a href="../238969/index.html">Monetization of children's applications, depending on age. Reasoning</a></li>
<li><a href="../238971/index.html">Watch the Microsoft broadcast from the Game Developer Conference.</a></li>
<li><a href="../238973/index.html">Results of the first round of the Russian AI Cup</a></li>
<li><a href="../238975/index.html">HTC One M8 Max: 5.5 inch display, Snapdragon 805 and Android L</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>