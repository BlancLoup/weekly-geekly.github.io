<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>One day programmer ambedder. To write a driver for the humidity sensor HTS221 from STM - is it very simple?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I assess the reasonableness of the user interface of specialized microchips from STMicroelectronics, I am sometimes surprised by the fact that th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>One day programmer ambedder. To write a driver for the humidity sensor HTS221 from STM - is it very simple?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/3c2/8f0/d01/3c28f0d01bf94da9be8beaf36a010732.png" align="left" alt="image"><br>  <i>When I assess the reasonableness of the user interface of specialized microchips from STMicroelectronics, I am sometimes surprised by the fact that they are able to work at all.</i>  <i>But they work the same.</i>  <i>And they do not just work, but have a bunch of chips and an extremely low price.</i>  <i>As a result, you have to choose them again and again ...</i> <br><br>  The next day promised to be as simple and enjoyable <s>as possible when once again you save the ‚Äúburning‚Äù project</s> .  According to the plan, it was necessary to revive the integrated combined temperature and humidity sensor until the evening.  The tiny size of the board, the small number of legs and the absence of discrete components of the ‚Äústrapping‚Äù allowed us to hope that you are dealing with the latest development, and modern sensors, despite their small size, are distinguished by intelligence and ingenuity.  They give out the finished result without any extra questions.  Often they do not just perform measurements, but produce very complex signal processing, have internal buffers for storing data, interrupt outputs <s>in order to wake up the microcontroller</s> and many other pleasant features.  All this greatly simplifies the task of writing code and reduces the resource requirements of the controlling microcontroller ... It is easy and pleasant to communicate with them.  True, sometimes you have to tinker with a lot of settings.  However, today it did not threaten me, because before me is just a banal capacitive moisture meter with temperature measurement function. <br><a name="habracut"></a><br>  ‚ÄúA couple of hours for screwing the interface, a couple more for the configuration of registers and half a day ahead are free,‚Äù I thought.  It will be possible to have lunch in the forest, if not on shish kebabs, then at least for a modest picnic. <br><br>  The only thing that gave me a vague feeling of alarm was the manufacturer: STMicroelectronics.  But discarding the memories of dances with a tambourine around their microcircuits for an electric meter, a PLC modem, an advanced inertial sensor ... I set to work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Tying acquaintance </h3><br>  A quick acquaintance with the datasheet and the circuit showed that this time neither the circuit designer nor the tracer ‚Äúnakosyachili‚Äù (of course, the blocking capacitor next to the case would have to be supplied and the power dissipated slightly differently, but this will affect the accuracy of measurements, and not performance).  The exchange interface between the microcontroller and the I2C sensor was suspiciously similar to the standard one. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7cc/5ef/107/7cc5ef1078f348a58cddfde71093a961.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/30e/9b1/7f8/30e9b17f86344dce94fe4f3ee130783c.png"></div><br>  I will not describe in detail the standard I2C, decipher only the basic terms from the datasheet, which will be needed a little later. <br><br><h3>  Agree on terms.  For mutual understanding </h3><br>  <b>ST</b> - start condition; <br>  <b>SR</b> is the reset operation of the start condition, it serves to solve the read conflict from the register.  We cannot perform a clean read operation ‚Äî we first need to pass the register number that we read to the instrument; <br>  <b>SAD</b> is the address of the slave device - our sensor (the low bit in it occupies the sign of the operation - ‚Äù+ W: or 0 for writing,‚Äú + R ‚Äùor 1 for reading. Thus,‚Äú SAD + W ‚Äù= 0xBE‚Äú SAD + R ‚Äù= 0xBF; <br>  <b>SAC</b> is a confirmation bit ‚Äúsent‚Äù by the slave, in our case the sensor; <br>  <b>MAK</b> - a confirmation bit from the microcontroller, which it sets in response to the fact that NMAK reads its absence, which is characterized by the last byte; <br>  <b>SUB</b> is the actual address of the register <br>  <b>DATA</b> - the actual data <br>  <b>SP</b> - stop condition <br><br>  Verification is done by closing the SDA bus to ground <br><br>  It is hard to believe that STM inventors at this time refused to innovate, but suddenly they change their policy.  Well, we begin to check. <br><br><h3>  The first steps.  First problems </h3><br>  Nothing foreshadowed the difficulties when looking at this picture.  In total, the business is to count a couple of 16 bit registers! <br><br><img src="https://habrastorage.org/files/bc1/514/d04/bc1514d0449d4dda8f02d044e4302ce9.png"><br><br>  I am finalizing my I2C exchange pattern and after an hour to attempt to write to the register, the chip briskly responds with acknowledgment bits.  Well, to teach the microcontroller to read data from the registers a little more difficult.  Where are the registers in which the measurement results are stored?  Yes, here they are, but give solid zeros.  Well, you have to read more about the configuration.  Half an hour behind the monitor screen and a cup of tea show that by default the chip is in an inactive state, but you can remove it from the stupor by changing just one byte in the configuration register.  At the same time, we will push a couple more so that the measurements take place cyclically, the benefit of which is to avoid the severe energy saving in this project. <br><br><pre><code class="cpp hljs">CTRL_REG1=<span class="hljs-number"><span class="hljs-number">0x86</span></span>;</code> </pre> <br>  Hooray, data appeared in 16-bit registers of temperature and humidity, but somehow they look strange.  In the case of temperature and humidity, both bytes are equal to each other.  This is at least suspicious.  Need to understand.  Hour is spent looking for errors in the exchange protocol and checking for delays.  Nothing helps, you have to go back to the datasheet.  Bah ... yes, I was not mistaken.  Well, the developers from STM could not not prepare a gift for the programmer.  There are few registers in the sensor and one byte is enough to address them in excess.  When you read or write one byte everything is fine.  But according to the I2C specification, you can both read and write a few bytes at a time and I actively use this feature in my program.  The main thing is, in the first case, after each byte, send a confirmation bit, and in the second, check whether the sensor returned it.  But STM engineers have introduced their know-how. <br><br>  It turns out that after reading or writing one byte the counter is incremented by one and passed to the next byte, you need to set the most significant bit to 1 in the register address byte (SUB)!  Otherwise, you will work until the blue side to interact with the same register.  Brilliant, and most importantly, how incomprehensible.  Why is this? <br>  Add a crutch to the standard protocol. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ByteCount&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>) SUB[<span class="hljs-number"><span class="hljs-number">1</span></span>]|=<span class="hljs-number"><span class="hljs-number">0x80</span></span>;</code> </pre> <br><h3>  No defeats no wins </h3><br>  The read data starts to delight with its diversity, only in what parrots do they measure them?  It looks very strange read values.  It looks like until you read this datasheet from cover to cover, you won't cook porridge with this sensor. <br><br>  This is an ambush!  It turns out that in order to get a tangible result in degrees and percents, you must still do the calculations.  Retrieve calibration data from specific registers and use the piecewise linear approximation to calculate the values.  Not that it is difficult to write a piece of code in C, but it is impossible to avoid a careful study of the datasheet.  The amount of code increases, and as a result, I have drawn another problem - the memory of the microcontroller is running out.  The circuit designer initially laid a stone with only sixteen kilobytes of FLASH, and polling the humidity sensor only a small fraction of the tasks assigned to it.  Since the microcontroller is 32 bit, we have a total of 4K words for code and constants.  Even with the fact that I do not use the heavy HALovskie firewood of this monstrously small.  I was promised to buy a new version of microcontrollers with memory twice as large.  How are you?  I call the project manager.  New stones have already arrived, but they are not soldered to the boards.  It turns out they are waiting for me when I report that no errors were found in the board.  Well, I report and get an answer - by the end of the week, maybe you will make a stone flower for you.  Of course, the board is not complicated, you could solder it yourself, although the chips are very small and require painstaking soldering with a hair dryer.  However, there are people who are specially trained in the project, why should they be left without work, especially since my schedule is very tight and I don‚Äôt have anything to do with the time spent. <br><br>  In the current situation without debugging, do not move forward.  We have to comment out a part of the code that has already been written to make room for calculations. <br><br>  The problem of linear approximation does not look too complicated, <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0a6/054/dd7/0a6054dd742e42e5ae451755641c9c5f.png"></div><br>  but knowing the magicians of STM is better to look for a ready-made solution.  10 minutes of surfing leads me to <a href="http://www.st.com/content/ccc/resource/technical/document/technical_note/group0/82/97/c8/ab/c6/da/41/ed/DM00208001/files/DM00208001.pdf/jcr:content/translations/en.DM00208001.pdf">Application with a description of the calculation method and even pieces of C code</a> . <br><br><h3>  Why just do something that can be difficult? </h3><br>  I copy into my program.  Here it is lunch time.  With anguish I look at the strip of woods on the horizon, it seems not so much that kebabs, but even a picnic in nature is canceled today.  Lunch is a little uplifting and forces emerge for a detailed study of the application.  I understand the registers with calibration values.  At first, their organization puzzles me, then it makes me laugh, almost hysterical.  Even for STM products, brute force is felt.  At this point, I want to stop in more detail. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cde/d6a/5ea/cded6a5ea2024590bd15e573746b7ed6.png"></div><br><br>  We look at the picture and try to evaluate the flight of thought.  In the first column of the table is the address in HEX format, in the second name, in the third data type, then the bit-by-bit description. <br><br>  With the values ‚Äã‚Äãmarked as s16, everything is clear - 16-bit signed, presented in a standard additional format. <br><br>  With those that at addresses 30 and 31 all the fun.  They are eight-bit.  But in order to use them in the calculations it is necessary to divide their value into two.  The low bit is insignificant.  Was it really difficult to simply put the meaningful 7 bits into the register, and leave the high one at zero? <br><br>  But it was still flowers.  The berries went with 8-bit values ‚Äã‚Äãat addresses 32 and 33. It turns out that they lack two more bits - the ninth and tenth.  For some reason they are stored in the register with the address 35. It contains 2 high-order bits from one register with the number 32 and two bits from the other with the number 33. Why?  Isn't it simpler to allocate two bytes for each of them and calmly write down the values, because the register with address 35 is still empty! <br><br>  But that's not all.  As a result of the manipulations, we get 10 bit registers, but it turns out that we need only the older seven bits for computation.  Therefore, the three low-order bits must be folded, the <s>value must be divided by 8,</s> and only then substituted into the formulas. <br><br>  In other words, we only need seven bits for calculations.  Why all these manipulations were asked, when they would easily fit into an eight-bit register! <br><br>  Really some kind of brain rupture.  Information in registers with addresses 30-31 could look like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a09/ed4/f61/a09ed4f616f44362a3b9cd1c0511e516.PNG"></div><br><br>  To extract information would not have to do unimaginable somersaults, but in the memory of registers also an extra bit remains. <br><br><h3>  Journey to Mercury </h3><br><img src="https://habrastorage.org/files/bbc/a0c/17a/bbca0c17aecc45d7b5314c72b58c6bfa.png"><br><br>  All right, I check the program given in aplikeyshine.  It seems everything is very similar to the description.  However, the penultimate line pleases: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d14/26d/ae8/d1426dae8ec94bf28907e959800054d4.png"></div><br>  If the relative humidity is more than 1000 percent, we take it for 1000 percent. <br><br>  The class. <br><br>  As a result, it does not pass even two hours, as I finally check the measurement result in practice.  He scares me.  The sensor shows that the weather conditions in my room are very close to the depression at the bottom of the imaginary Mercury ocean.  The temperature is above 500 degrees Celsius, and the humidity is around 1000 percent.  Looks like I was completely working and it's time to turn on the air conditioning. <br><br>  When it turns out that the sensor readings and it affects weakly, I begin to check the code.  I could not refrain from refining coarsely written template from ST, suddenly nakosyachil?  A half-hour check does not give results.  Again I go deep into datasheets in order to understand where this ‚Äú10‚Äù odd multipliers come from in calculations using the linear interpolation method.  Half an hour of careful reading gave the result - it turns out it was a move aimed at improving the accuracy of integer division.  True, at the output we got the results not in percents, but in ppm for humidity and in Celsius degrees multiplied by 10 for temperature. <br><br>  I try to throw them out of the code and suddenly move back to the middle lane - 29 degrees and 58 percent humidity.  I press the sensor with my finger and very quickly the temperature reading rises to 34. Hurray, finally you can wrap up. <br><br>  But it is already getting dark outside the window and the poor fellows are returning from work on Moscow electric trains on the sidewalks.  Well, I will go at least to the park, take a walk, prepare mentally for tomorrow morning's conversation with the general from Kazan.  Their firm decided to try their luck in import substitution for a couple with Bashneft, you need to think what they hope to get from me and how I can actually help them. <br><br><h3>  Dry residue </h3><br>  In the end, we have - ST did everything so that our brother, the developer, even for writing a simple driver, read the manual from cover to cover and with the appliqu√© also suffered: <br><br><ul><li>  When writing or reading a few bytes, you must change the address of the register; </li><li>  The actual values ‚Äã‚Äãof the measured values ‚Äã‚Äãmust be calculated using calibration values; </li><li>  The calibration values ‚Äã‚Äãthemselves are located in a very strange way in memory, and they need to be collected from there by pieces conducting circus manipulations with bits; </li><li>  The program text from the application file contains errors; </li><li>  Gauge and reserve registers are open for free writing.  Accidental recording of new values ‚Äã‚Äãin them will lead to a distortion of the results during the calculation; </li><li>  Relative humidity can easily go off scale for 100 percent and it doesn‚Äôt bother the manufacturer at all; </li></ul><br>  The above problems I encountered in the process of writing the simplest driver took away more than half of the working day from me, and a beginner could be provided with a solution for several days. <br><br>  What can we say about creating a driver for some kind of PLC modem, when circuit faults, hardware problems, nuances of exchange protocols, quality of communication lines are added to the oddities of the chip and inaccuracies of the description.  When the microcontroller has to read and encode / decode data on the fly and it is necessary to use the mechanism of interrupts and direct access to the memory at full speed  Moreover, the code should be executed in the ‚Äúshadow mode‚Äù and have a minimal impact on the course of the main program. <br><br>  I'm not talking about the fact that some of the not very pleasant nuances of manufacturers sometimes deliberately silent, or provide not very reliable information. <br><br>  In such conditions, without experience, good knowledge of circuit design and physics of the device, the developer is very difficult. <br><br><h3>  It's time to report on the results </h3><br>  Well, finally, I will try to make life easier for those who decide to use this sensor in their developments.  I publish below the code of the corresponding program modules.  Immediately, I‚Äôll make a reservation that it does not include low-level I2C data exchange functions, since it strongly depends on the specific implementation - the microcontroller used for polling, the exchange bus and even the numbers of the connected ports. <br><br>  Data exchange with the sensor is carried out via the I2C interface.  Two functions supporting the standard protocol are used, you will have to write them yourself or search them in standard libraries. <br><br><h3>  One for recording data according to the protocol shown in the figure below. </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7cc/5ef/107/7cc5ef1078f348a58cddfde71093a961.png"></div><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WRsubAddr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SAD,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SUB, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteCount)</span></span></span></span>;</code> </pre> <br><h5>  The second to read data </h5><br><div style="text-align:center;"><img src="https://habrastorage.org/files/30e/9b1/7f8/30e9b17f86344dce94fe4f3ee130783c.png"></div><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RDsubAddr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SAD,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SUB, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ByteCount)</span></span></span></span>;</code> </pre> <br>  <b>data</b> - <b>data</b> buffer <br>  <b>ByteCount</b> - number of bytes read or written. <br>  The program code is very simple and richly supplied with comments.  When the sensor driver is initialized, constants for calculations are read from it and placed in a separate structure.  Measurements read and converted to a readable form are placed in it. <br>  This program code has been modified after a hectic two-day discussion process.  I tried to improve the accuracy of conversions by using the lower bits of the registers H0_rH_x2, H1_rH_x2, H0_T0_OUT, H1_T0_OUT.  In the case of calculating the temperature, this did not greatly affect the result; in the case of humidity, it led to inadequate results.  Significantly bring the readings to real ones by applying the type float for calculations.  For 32-bit microcontrollers, the calculation of floating-point numbers is not a very resource-intensive task, and a high calculation speed is not required when working with this sensor.  I offer our readers the program in this version. <br>  I express my gratitude to all users who took part in the discussion, especially I would like to note <a href="https://habrahabr.ru/users/mdn-tech/" class="user_link">mdn-tech</a> , <a href="https://habrahabr.ru/users/olartamonov/" class="user_link">olartamonov</a> and <a href="https://habrahabr.ru/users/lorc/" class="user_link">lorc</a> .  In addition, I express my gratitude to the Habra team for not including the possibility of editing articles after writing them among the innovations.  This allows you to change the content of the discussion in the comments.  I try to use this opportunity - I correct errors and sometimes add interesting information.  After several iterations, the article becomes more interesting, more fully reflects the topic and most importantly does not contain errors. <br><br><h3>  Header File Code </h3><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> HTS221_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HTS221_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i2c.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//       #define adr_H_OUT 0x28 #define adr_T_OUT 0x2A //    #define adr_H0_rH_x2 0x30 #define adr_H1_rH_x2 0x31 #define adr_T0_degC_x8 0x32 #define adr_degC_x8 0x33 #define T1_T0_msb 0x35 #define adr_H0_T0_OUT 0x36 #define adr_H1_T0_OUT 0x3A #define adr_T0_OUT 0x3C #define adr_T1_OUT 0x3E //    #define adr_WHO_AM_I 0x0F #define adr_AV_CONF 0x10 #define adr_CTRL_REG1 0x20 #define adr_CTRL_REG2 0x21 #define adr_CTRL_REG3 0x22 #define adr_STATUS_REG 0x27 //  HTS221   I2C #define addr_HTS221 0x5F typedef struct { //        HTS221 //   float H_OUT;//   //    float H0_rH; float H1_rH; float H0_T0_OUT; float H1_T0_OUT; float T_OUT;//   //    float T0_degC; float T1_degC; float T0_OUT; float T1_OUT; float Humidity; float Temperature; } THTS221str; THTS221str HTS221str; unsigned char DevCodeRead(void); unsigned int InitHTS221CalibrTab(void); int HTS221_Get_Humidity(void); int HTS221_Get_Temp(void); #endif</span></span></span></span></code> </pre><br><h3>  SI program code </h3><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"HTS221.h"</span></span></span><span class="hljs-meta"> int WRHTS221reg(unsigned char addrREG, unsigned char *data,unsigned char ByteCount) {</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// count     if (ByteCount&gt;1) addrREG|=0x80;//        return WRsubAddr(addr_HTS221,addrREG,data,ByteCount); } int RDHTS221regs(unsigned char addrREG, unsigned char *data,unsigned int ByteCount) {//         addrREG if (ByteCount&gt;1) addrREG|=0x80;//        return RDsubAddr(addr_HTS221,addrREG,data,ByteCount); } unsigned char DevCodeRead(void) {//  ,       1   unsigned char Code[2]; if (!RDHTS221regs(0xF,Code,1)) return 0; if (Code[0]==0xBC) return 1; else return 0; } unsigned int InitHTS221CalibrTab(void) { unsigned char buffer[4]; short tmpi; buffer[0]=0x86;//power down OFF, 1 HZ read if (!WRHTS221reg(adr_CTRL_REG1,buffer,1)) return 0; if (!DevCodeRead()) return 0; // 1. Read H0_rH and H1_rH coefficients if (!RDHTS221regs(adr_H0_rH_x2,buffer,2)) return 0; HTS221str.H0_rH = (buffer[0]/2); HTS221str.H1_rH = (buffer[1]/2); //2. Read H0_T0_OUT if (!RDHTS221regs(adr_H0_T0_OUT,(unsigned char*)(&amp;tmpi),2)) return 0; HTS221str.H0_T0_OUT=tmpi; //3. Read H1_T0_OUT if (!RDHTS221regs(adr_H1_T0_OUT,(unsigned char*)(&amp;tmpi),2)) return 0; HTS221str.H1_T0_OUT=tmpi; // 1. Read from 0x32 &amp; 0x33 registers the value of coefficients T0_d egC_x8 and T1_de gC_x8 // 2. Read from 0x35 register the value of the MSB bits of T1_deg C and T0_deg C if (!RDHTS221regs(adr_T0_degC_x8,buffer,4)) return 0; HTS221str.T0_degC = (buffer[0]&gt;&gt;3)+(0x60&amp;(buffer[3]&lt;&lt;5)); HTS221str.T1_degC = (buffer[1]&gt;&gt;3)+(0x60&amp;(buffer[3]&lt;&lt;3)); //3. Read from 0x3C &amp; 0x3D registers the value of T0_OUT if (!RDHTS221regs(adr_T0_OUT,(unsigned char*)(&amp;tmpi),2)) return 0; HTS221str.T0_OUT=tmpi; //4. Read from 0x3E &amp; 0x3F registers the value of T1_OUT if (!RDHTS221regs(adr_T1_OUT,(unsigned char*)(&amp;tmpi),2)) return 0; HTS221str.T1_OUT=tmpi; return 1; } int HTS221_Get_Humidity(void) { short tmp; //4. Read H_T_OUT if (!RDHTS221regs(adr_H_OUT,(unsigned char*)(&amp;tmp),2)) return 0; /*5. Compute the RH [%] value by linea r interpolation */ HTS221str.H_OUT=tmp; HTS221str.Humidity = ((HTS221str.H_OUT - HTS221str.H0_T0_OUT) * (HTS221str.H1_rH - HTS221str.H0_rH))/(HTS221str.H1_T0_OUT - HTS221str.H0_T0_OUT) + HTS221str.H0_rH; /* Saturation condition*/ if (HTS221str.Humidity&gt;100) HTS221str.Humidity =100; return 1; } int HTS221_Get_Temp(void) { short tmp; //4. Read H_T_OUT if (!RDHTS221regs(adr_T_OUT,(unsigned char*)(&amp;tmp),2)) return 0; /*5. Compute the RH [%] value by linea r interpolation */ HTS221str.T_OUT=tmp; HTS221str.Temperature = ((HTS221str.T_OUT - HTS221str.T0_OUT) * (HTS221str.T1_degC - HTS221str.T0_degC))/(HTS221str.T1_OUT - HTS221str.T0_OUT)+ HTS221str.T0_degC; return 1; }</span></span></span></span></code> </pre><br><br><h3>  Useful materials </h3><br>  <a href="http://www.st.com/content/st_com/en/products/mems-and-sensors/humidity-sensors/hts221.html">The link to the sensor page at the manufacturer</a> <br><br><h3>  Final survey </h3><br>  The manufacturer stated that the sensor contains a digital signal processor for processing the results.  Then why it was impossible to implement the simplest calculations to provide data in a user-friendly form.  Well, well, he is too busy, but why not at least the calibration registers are not located in a normal way?  Why does the simplest demo code contain errors?  And still a lot of why. </div><p>Source: <a href="https://habr.com/ru/post/307962/">https://habr.com/ru/post/307962/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307946/index.html">Overview: SAP F & R today and tomorrow is the future of sales forecasting</a></li>
<li><a href="../307948/index.html">Published data from the elite cyber grouping Equation Group were not a joke</a></li>
<li><a href="../307950/index.html">We invite you to email show September 9-11</a></li>
<li><a href="../307952/index.html">The best game engine according to users of Habr</a></li>
<li><a href="../307958/index.html">SysV, Upstart, systemd as a Debian / Ubuntu rake assortment</a></li>
<li><a href="../307964/index.html">Founder of Group-IB: ‚ÄúThere are only two limited resources left in the world - time and health‚Äù</a></li>
<li><a href="../307966/index.html">Asterisk Conference on August 27th. In Moscow and Online</a></li>
<li><a href="../307968/index.html">The most used hypervisor? Xen</a></li>
<li><a href="../307972/index.html">HolyJS in Moscow: first reports and CallForPapers</a></li>
<li><a href="../307974/index.html">The future of mobile security, or what Pokemon can teach us</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>