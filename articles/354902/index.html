<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As I wrote a graphic bot and what it turned into</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will analyze the experience of writing a tool that allows, with a minimum of effort and time, to automate a wide range of routine ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As I wrote a graphic bot and what it turned into</h1><div class="post__text post__text-html js-mediator-article">  In this article, we will analyze the experience of writing a tool that allows, with a minimum of effort and time, to automate a wide range of routine tasks. <br><br><h2>  <b>Foreword</b> </h2><br>  It took me a bot to perform several tasks demanding on logic and speed of reaction.  I didn't want to go into the API and pick the program binaries.  It was decided to go through visual automation.  I found several bots, but none of them came up to my requirements, being either too slow, or the script part was severely curtailed or there was insufficient functionality to work with the visual component.  Since I had a successful experience of using a visual bot in the past (albeit slow and severely curtailed in the script part), I decided to make my implementation. <br><br>  <b>Required at the beginning of the functional</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The following features were needed: <br><br><ul><li>  Clicking the mouse, moving the cursor, pressing the buttons. </li><li>  Simulate keyboard keystrokes. </li><li>  The ability to search on the screen for a previously prepared piece of a picture, for example, an icon or a letter, and if it finds one, let it do anything with this information. </li><li>  A script interpreter so that you can simply describe the algorithm of actions and do not need to be compiled time after time. </li></ul><br>  <b>Existing analogues</b> <br><br>  There are a number of analogues, but each of them has its own advantages and disadvantages.  Consider the most functional: <br><a name="habracut"></a><br><br>  Sikuli - has a huge set of useful features, a convenient scripting Python language and syntax, cross-platform with some reservations, <br>  However, the initial task required exactly the reaction rate, which he could not provide for the most part due to Tesseract. <br>  The second problem is binding to Java 1.6, which will not allow translating it without dancing with a tambourine to 1.7 or 1.8, for example. <br>  The older version of Jython is also not particularly happy, although 2.5.2 is not so much outdated. <br><br>  The rest of Sikuli is a great tool, I advise everyone! <br><br>  AutoIt - uses Basic for scripting. <br><br>  Kulibins on the forums made it possible to look for pictures on the screen, unfortunately this function did not meet my requirements due to unnecessary simplifications and a lot of restrictions. <br>  It works only under Windows, requires installation. <br><br>  Requires compiling for use on other machines, there is no way to quickly correct the script, if AutoIt is not installed. <br><br>  AutoHotKey - uses its syntax for writing scripts, which still need to be studied for a long time, it would be more correct to call it ‚Äúhorrible‚Äù.  It is difficult to do anything with really extensive logic without proper habit.  The search for pictures on the screen is too curtailed and did not fit my needs. <br><br>  It has several ports for Linux / Unix systems, requires installation <br><br>  Clickermann - uses its own language to write scripts that still need to be learned.  Due to simplifications, functionality has been reduced, for example, the same http requests. <br><br>  There is no search for pictures on the screen, although there is a primitive search for pixels. <br><br>  UOPilot - attached to the processes that did not suit me, there are diseases like Clickermann.  No cross-platform, large scripts are not convenient to write. <br><br>  There were also many macros, most of which worked on the ‚Äúrepeat after me‚Äù principle by memorizing and repeating user actions, which, in turn, does not allow creating anything with an extensive algorithm of actions with a bunch of if and while. <br><br>  And the rest were banal, there was no search function for any icons on the screen. <br><br>  <b>Analogs on Habr√©</b> <br><br>  I read the <a href="https://habrahabr.ru/post/201136/">article</a> , the author made a bot to get a discount for laser vision correction.  The article describes many of the problems encountered in the course of writing.  Most of these problems arose precisely because of understandable simplifications and the crutch was solved by a new crutch, I advise an article to read. <br><br>  <b>Choosing technology for your own bike</b> <br><br>  From the outset, it was decided to use Java SE to write the kernel itself, which in turn saved time, as I use Java most often.  In addition, he was familiar with the Robot class, which allows simulating mouse and keyboard controls in a convenient form. <br><br>  When adding a script interpreter, Python was chosen as fairly simple and popular.  For Java, there is a Jython implementation that runs on the JVM and does not require installation.  In addition, they will allow working with Java classes and objects directly from a script, which significantly expands the possibilities of scripting, without limiting what is inherent in the bot's kernel. <br><br>  Subsequently I added image search on the screen through GPGPU using OpenCL, for Java there was a JOCL implementation, but more on that later. <br><br>  Swing graphical user interface, simple and at the same time functional component, available on any JRE right out of the box. <br><br><h2>  <b>The first steps</b> </h2><br>  In Java, there is a class Robot, which allows you to simulate keyboard presses, mouse movements, and clicks; there were no special problems with it.  So I just expanded some functionality using mouseClick (x, y) using mouseMove + mousePress + mouseRelease, adding Thread.sleep (ms) between these actions, and then adding a few more methods with different arguments by overloading.  The same Drag &amp; Drop in the form of a single method. <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouseClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AWTException </span></span>{ mouseClick(x, y, InputEvent.BUTTON1_MASK, mouseDelay); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouseClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> button_mask)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AWTException </span></span>{ mouseClick(x, y, button_mask, mouseDelay); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouseClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> button_mask, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sleepTime)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AWTException </span></span>{ bot.mouseMove(x, y); bot.mousePress(button_mask); sleep(sleepTime); bot.mouseRelease(button_mask); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouseClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MatrixPosition mp)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AWTException </span></span>{ mouseClick(mp.x, mp.y); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouseClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MatrixPosition mp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> button_mask)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AWTException </span></span>{ mouseClick(mp.x, mp.y, button_mask); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouseClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MatrixPosition mp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> button_mask, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sleepTime)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AWTException </span></span>{ mouseClick(mp.x, mp.y, button_mask, sleepTime); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MatrixPosition </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mousePos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MatrixPosition(MouseInfo.getPointerInfo().getLocation()); }</code> </pre> <br>  KeyClick () methods were added in the same way. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keyPress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key_mask)</span></span></span><span class="hljs-function"> </span></span>{ bot.keyPress(key_mask); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keyPress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">... keys)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> key : keys) bot.keyPress(key); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keyRelease</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key_mask)</span></span></span><span class="hljs-function"> </span></span>{ bot.keyRelease(key_mask); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keyRelease</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">... keys)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> key : keys) bot.keyRelease(key); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keyClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key_mask)</span></span></span><span class="hljs-function"> </span></span>{ bot.keyPress(key_mask); sleep(keyboardDelay); bot.keyRelease(key_mask); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keyClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">... keys)</span></span></span><span class="hljs-function"> </span></span>{ keyPress(keys); sleep(keyboardDelay); keyRelease(keys); }</code> </pre> <br>  All this was necessary to facilitate the writing of actions in the script.  Raise the level of scripting to a more abstract "You need it and you do it." <br><br>  Fuh, have read ... Rested?  And now let's go further! <br><br>  <b>Eyes of the nucleus</b> <br><br>  The next step is the most difficult and took the most time - adding the ability to take a screenshot of the screen and find a pre-prepared icon on it. <br><br>  First, how to take a screenshot of the screen and how to store it? <br>  Secondly, how to search for a pattern (icon)? <br>  Thirdly, where to get this pattern (icon)? <br><br>  If the creation of a screenshot is not so difficult <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">grab</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ image = robot.createScreenCapture(screenRect); }</code> </pre> <br>  Then there were certain problems with the search, where to get the pattern for the search?  Create, and how? <br>  To create the first pattern, the good old Paint was used, with the help of PrintScreen I threw a screenshot of the screen into the editor and cut a small piece out of the screenshot, saving it in a separate .bmp file of the format. <br><br>  Well, the pattern itself is there, loaded it from the code into the BufferedImage.  A screenshot is also created in BufferedImage, now the search algorithm has to be done.  I came across an option to go brutally in the network - take the first pixel of the small picture, the first pixel of the big picture and compare them, if the pixels have the same color code, check the remaining pixels relative to that point.  If all the pixels match - it means that the desired image was found.  If it does not match, then we take the next pixel from the big picture and repeat the action again. <br><br>  It does not sound very much, but it works. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; screenshot.getHeight() - fragment.getHeight(); y++) { __columnscan: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; screenshot.getWidth() - fragment.getWidth(); x++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (screenshot.getRGB(x, y) != fragment.getRGB(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yy = <span class="hljs-number"><span class="hljs-number">0</span></span>; yy &lt; fragment.getHeight(); yy++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xx = <span class="hljs-number"><span class="hljs-number">0</span></span>; xx &lt; fragment.getWidth(); xx++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (screenshot.getRGB(x + xx, y + yy) != fragment.getRGB(xx, yy)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> __columnscan; } } System.out.println(‚Äúfound!‚Äù); } }</code> </pre> <br>  Run, and ... It works!  Found one coincidence!  However, rather slowly, which is completely unacceptable for us.  Time was spent on the fact that every time getRGB () methods are called, the processor's cache is used extremely inefficiently, but for us this can be said - a pure search in the matrix.  Pixel matrix!  Therefore, I decided to translate a BufferedImage object that stores a screenshot of the screen into an int [] [] matrix, and the search fragment was also transferred to an int [] [] matrix, correcting our cycles for working with the matrix.  Run and ... Does not find. <br><br>  After an active search for answers in search engines - it became clear that the reason for this is all ARGB / RGBA / RGB format in which BufferedImage data is stored.  The screenshot had an ARGB file with a BGR fragment. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/91b/007/b76/91b007b764cf620228fa3a12ed57759f.png" alt="image"><br><br>  I had to bring everything to the same format, namely the ARGB screenshot format, since it‚Äôs faster to bring the fragments once to the format of the screenshot than every time the screenshot to the format of the fragments.  We bring less to a larger format, which took quite a long time, but eventually it worked, the patterns started to be successfully in the screenshot much faster, almost twice as fast! <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// USED FOR BMP/PNG BUFFERED_IMAGE private int[][] loadFromFile(BufferedImage image) { final byte[] pixels = ((DataBufferByte) image.getData().getDataBuffer()) .getData(); final int width = image.getWidth(); if (rgbData == null) rgbData = new int[image.getHeight()][width]; for (int pixel = 0, row = 0; pixel &lt; pixels.length; row++) for (int col = 0; col &lt; width; col++, pixel += 3) rgbData[row][col] = -16777216 + ((int) pixels[pixel] &amp; 0xFF) + (((int) pixels[pixel + 1] &amp; 0xFF) &lt;&lt; 8) + (((int) pixels[pixel + 2] &amp; 0xFF) &lt;&lt; 16); // 255 // alpha, r // gb; return rgbData; }</span></span></code> </pre> <br><br>  Then it was left to a small optimization like caching a row of the matrix, if conditions, which also added the speed of obtaining the search result. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MatrixPosition </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findIn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Frag b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x_start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y_start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x_stop, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y_stop)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// precalculate all frequently used data final int[][] small = this.rgbData; final int[][] big = b.rgbData; final int small_height = small.length; final int small_width = small[0].length; final int small_height_minus_1 = small_height - 1; final int small_width_minus_1 = small_width - 1; final int first_pixel = small[0][0]; final int last_pixel = small[small_height_minus_1][small_width_minus_1]; int[] row_cache_big = null; int[] row_cache_big2 = null; int[] row_cache_small = null; for (int y = y_start; y &lt; y_stop; y++) { row_cache_big = big[y]; __columnscan: for (int x = x_start; x &lt; x_stop; x++) { if (row_cache_big[x] != first_pixel || big[y + small_height_minus_1][x + small_width_minus_1] != last_pixel) // if (row_cache_big[x] != first_pixel) continue __columnscan; // No first match // There is a match for the first element in small // Check if all the elements in small matches those in big for (int yy = 0; yy &lt; small_height; yy++) { row_cache_big2 = big[y + yy]; row_cache_small = small[yy]; for (int xx = 0; xx &lt; small_width; xx++) { // If there is at least one difference, there is no // match if (row_cache_big2[x + xx] != row_cache_small[xx]) { continue __columnscan; } } } // If arrived here, then the small matches a region of big return new MatrixPosition(x, y); } } return null; }</span></span></code> </pre> <br>  I tried to play with the matrix type, long vs int and the best result was still with the int [] [] matrix with both configurations of the 64 / 32bit JVM on i7 4790. <br><br><h2>  <b>Bot brains</b> </h2><br>  Namely, the script part, it should be convenient, the syntax is clear without further explanation.  Ideally, any popular language that can be built into the bot's core and has rich documentation will do.  Using the kernel API should be simple and easy to remember. <br><br>  The choice fell on Python, is popular, easy to learn, well documented, has many ready-made libraries, and most importantly, the script is easy to edit in any text editor!  In addition, I have long wanted to study it. <br><br>  For Java, there is an embedded Python implementation called Jython.  It runs on the JVM and does not require anything extra to get started, it allows you to use literally all classes, Java libraries, as well as .jar packs!  In turn, this only strengthened confidence in the correctness of the choice. <br><br>  We connect Jython to the project, create an interpreter object and run our script file. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JythonVM</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isJythonVMLoaded = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Object jythonLoad = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PythonInterpreter pi = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">JythonVM</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// TODO Auto-generated constructor stub } void load() { System.out.println("CORE: Loading JythonVM..."); pi = new PythonInterpreter(); isJythonVMLoaded = true; System.out.println("CORE: JythonVM loaded."); synchronized (jythonLoad) { jythonLoad.notify(); } } void run(String script) throws Exception { System.out.println("CODE: Waiting for JythonVM to load"); if (!isJythonVMLoaded) synchronized (jythonLoad) { jythonLoad.wait(); } System.out.println("CORE: Running " + script + "...\n\n"); pi.execfile(script); System.out.println("CORE: Script execution finished."); } }</span></span></code> </pre> <br>  Now look at the script. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- print("hello")</span></span></code> </pre> <br>  From the script we load the necessary classes of our kernel and simply create their objects.  Thus, you can pull class methods, which means that you can use the kernel API to perform the actions we need! <br><br>  These classes are Action and MatrixPosition; Exception classes of the FragmentNotLoadedException and ScreenNotGrabbedException classes were later added. <br><br>  Action - used as the main class for calls to kernel functionality.  It contains useful methods designed to simplify the process of writing a script, to reduce the number of extra lines required to solve any problem.  The same mouseClick, keyClick, find fragments in the screenshot, grab to create the screenshots themselves, and so on. <br><br>  In addition, you can create many objects of this class, and accordingly use them independently in several threads at once! <br><br>  Let's add our script to a couple of lines to use the kernel API <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- from bot.penguee import Action a = Action() #      API  print("hello") #    ,     a.mouseMove(1000, 500) #       x 1000, y 500</span></span></code> </pre> <br>  MatrixPosition - used as a wrapper for coordinates on the screen.  In this format, the bot API returns the coordinates.  Of course, I recall the already finished Point class, which already has the necessary functionality.  However, not everything is so simple, the X and Y fields are accessible only through the pos.getX pos.getY methods, which causes a lot of inconvenience during script writing.  It is much more convenient to access the fields via pos.x pos.y.  In addition, practice has shown that positions should also have their own names, which turned out to be necessary for some tasks such as sorting positions among themselves (processing numbers from the screen alphabetically). <br><br>  The possibilities are also expanded with the help of the methods add, sub, which allow you to create a new position relative to the coordinates of the current object. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- from bot.penguee import MatrixPosition, Action a = Action() print("hello") mp = MatrixPosition(1000, 500) print(mp.x, mp.y) a.mouseMove(mp)</span></span></code> </pre> <br><h3>  <b>Subsequent improvements</b> </h3><br>  <b>Pattern coordinate cache</b> <br><br>  According to the statistics of the search, it became clear that it was necessary to find mostly static images that do not change their position on the screen.  For this, a cache with coordinates has been added.  If the image is in the cache, it will first check for the presence of the image in the cached coordinates, if not found, then search the rest of the screen.  This little detail has greatly increased the speed of execution of scripts. <br><br>  <b>GPGPU into service</b> <br><br>  I always wanted to make quick the process of finding patterns on the big screen, the optimization of the algorithm has its limitations.  Prior to this, the entire search process took place on a processor, dividing it into separate threads would not give a real gain in speed, but would increase the problems with the load by an order of magnitude.  Having experience in writing kernel code for GPGPU, I loaded the OpenCL library and threw the same search algorithm that was used on the processor (not the best solution for video cards), with some changes to adapt to the kernel program features. <br><br>  For comparison, the intel i7 4790 with a screen resolution of 1920 * 1080 processor search spent 0-12ms in the worst case (the farthest corner of the screen), then the Intel HD 4600 0-2ms is stable.  However, you have to pay more for the process of creating the screenshot itself, since it is required to load the screenshot matrix into the memory of the video card, which takes time.  At the same time, this is compensated for by the fact that you can search for many different pictures on the same screenshot, which ultimately gives a performance gain over the processor search. <br><br>  <b>Thread safety</b> <br><br>  It is especially important to make it possible to use streams and look for any fragments independently of each other, so that the buffers, objects were made local, so that when writing a script, there are no bugs. <br><br>  <b>Cross platform</b> <br><br>  The scripts work the same on any platform, the only exception is text that is printed to the console, different encodings on different operating systems, so this is a separate problem.  JVM allows you to run a bot on any platform without the need for installation.  "Took and run." <br><br><h2>  <b>Final result</b> </h2><br>  The number of kernel methods that can be called from the script has more than 70 pieces and their number is constantly growing. <br><br>  This tool is suitable for testing software and graphical interfaces.  It helps in cases when it is necessary to automate something, but there is no desire or enough knowledge to pick binaries (Good for enikeev). <br><br>  <b>Real examples of use</b> <br><br>  For obvious reasons, I don‚Äôt provide titles or source code. <br><br><ul><li>  A trading bot for an online MMO game auction, the bot analyzes real-time figures for the cost of goods and the possible profit from resale, then with the help of overlay layers it writes the possible profit figures directly on the user's screen. </li><li>  A passive macro for a single-player game, improves buildings automatically, passively watching for the presence of upgrade buttons and taking control for a moment, clicking on the necessary buttons in a very short time. <br></li><li>  When you receive a new message in Skype - opens the program and the window of the desired dialogue. <br></li><li>  Office calculation of the work done by the names of employees, the data are visually taken from the interface of an obsolete program that does not have an API or easy access to the database. <br></li><li>  Office counting products from 1C, eniky can not work with the API and the database directly, used this bot. <br></li></ul><br>  GUI bot overview <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/UKQe19j0rrY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  We write a simple script for parsing <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ctXy8Mnzbbw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  YouTube playlist <br><iframe width="560" height="315" src="https://www.youtube.com/embed/videoseries" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><div class="spoiler">  <b class="spoiler_title">Script from video</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- from bot.penguee import MatrixPosition, Action from java.awt.event import InputEvent, KeyEvent a = Action() p1 = MatrixPosition(630, 230) p2 = MatrixPosition(1230, 780) while True: a.grab(p1, p2) a.searchRect(630, 230, 1230, 780) #  if a.find("verstak.gui"): a.searchRect(760, 320, 960, 500) # emptyCells = a.findAllPos("cell_empty") a.searchRect(700, 520, 1220, 770) #  if a.findClick("coal.item"): coalRecentPos = a.recentPos() print(coalRecentPos.name) for i in range(len(emptyCells)): a.mouseClick(emptyCells[i], InputEvent.BUTTON3_MASK) a.sleep(50) a.mouseClick(coalRecentPos) a.searchRect(630, 230, 1230, 780) #  result = a.findPos("verstak.arrow").relative(70, 0) a.keyPress(KeyEvent.VK_SHIFT) a.sleep(100) a.mouseClick(result) a.sleep(100) a.keyRelease(KeyEvent.VK_SHIFT) elif a.find("pech.gui"): if a.find("pech.off"): a.searchRect(700, 520, 1220, 770) #  if a.findClick("coal.block"): coalBlockRecentPos = a.recentPos() a.searchRect(630, 230, 1230, 780) #  a.mouseClick(a.findPos("pech.off"), InputEvent.BUTTON3_MASK) a.mouseClick(coalBlockRecentPos) result = a.findPos("verstak.arrow").relative(70, 0) a.keyPress(KeyEvent.VK_SHIFT) a.sleep(100) a.mouseClick(result) a.sleep(100) a.keyRelease(KeyEvent.VK_SHIFT) if a.find("pech.empty"): a.searchRect(700, 520, 1220, 770) #  if a.findClick("gold.ore"): a.searchRect(630, 230, 1230, 780) #  a.mouseClick(a.findPos("pech.empty")) a.sleep(6000)</span></span></code> </pre><br></div></div><br><br>  <a href="https://github.com/1Ridav/PengueeBot">Github Link</a> <br>  <a href="https://1ridav.github.io/PengueeBot/">API reference</a> <br><br>  UPD: 02.28.2019 Added playlist, updated links </div><p>Source: <a href="https://habr.com/ru/post/354902/">https://habr.com/ru/post/354902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354890/index.html">We optimize the web with Vitaly Friedman, - compression, images, fonts, HTTP / 2 features and Resource Hints</a></li>
<li><a href="../354892/index.html">Commenting code: good, bad, evil</a></li>
<li><a href="../354894/index.html">MIT course "Computer Systems Security". Lecture 1: "Introduction: threat models", part 2</a></li>
<li><a href="../354896/index.html">MIT course "Computer Systems Security". Lecture 1: "Introduction: threat models", part 3</a></li>
<li><a href="../354898/index.html">Fractal manifold method in Data Science problems</a></li>
<li><a href="../354906/index.html">Distribution of programs on Go. Part 1</a></li>
<li><a href="../354910/index.html">By the Day of Radio. Oh connection, you are the world</a></li>
<li><a href="../354912/index.html">PyTorch Tour</a></li>
<li><a href="../354914/index.html">Setting security for applications on the SAP Cloud Platform cloud platform</a></li>
<li><a href="../354916/index.html">Experience using Mikrotik CHR for organizing virtual routing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>