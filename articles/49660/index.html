<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make friends with Java and C ++. Part one</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 As you probably already guessed, it will be about JNI. For those who do not know what it is, I explain: JNI (or the java native interface) i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make friends with Java and C ++. Part one</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  As you probably already guessed, it will be about JNI.  For those who do not know what it is, I explain: JNI (or the java native interface) is such a thing that allows you to make calls to native code from a java machine and vice versa. <br><br>  Why this may be required?  There are several reasons: the need to use code that is already written for the native platform, the need to implement something that cannot be done with a single JVM (for example, working with some specific pieces of hardware), and of accelerating the execution of critical pieces of code (though This is a very controversial point.) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><h1>  How JNI works </h1> Suppose we have some java class from which we need to call a method written in c ++ and located in a dynamically linked library (for example, in windows it will be a dll).  What should we do for this? <br><br>  To begin with, we declare a method of some class as native.  This will mean that the JVM, when calling this method, will transfer control to the native code. <br><br>  Then, we need to load the native library.  To do this, you can call <code>System.loadLibrary(String)</code> , which takes the name of the library as a parameter.  After this call, the library will be loaded into the JVM address space. <br><br>  Now, imagine that we have the following java class: <blockquote>  <font color="#000000">package</font> <font color="#006699">my.mega.pack</font> ; <br><br>  <font color="#000000">public</font> <font color="#000000">class</font> NativeCallsClass <br>  <font color="#009900">{</font> <br>  <font color="#000000">static</font> <br>  <font color="#009900">{</font> <br>  <font color="#003399">System</font> .  <font color="#006633">loadLibrary</font> <font color="#009900">(</font> <font color="#0000ff">"megalib"</font> <font color="#009900">)</font> ; <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">native</font> <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000066">void</font> printOne <font color="#009900">(</font> <font color="#009900">)</font> ; <br>  <font color="#000000">native</font> <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000066">void</font> printTwo <font color="#009900">(</font> <font color="#009900">)</font> ; <br>  <font color="#009900">}</font> </blockquote>  Here we, for convenience, carried <code>loadLibrary()</code> in static area of ‚Äã‚Äãa class. <br><br>  Suppose now that we call <code>NativeCallsClass.printOne()</code> .  Then the JVM will search the libraries for a method with the following name: <code>Java_my_mega_pack_NativeCallsClass_printOne(...)</code> . <br><br><h1>  JNI function declaration in C ++ </h1>  We wrote a class in java, which has methods that are marked as native.  Now we need to create headers with declarations of C ++ functions that we want to call. <br><br>  Of course, you can write them manually.  But there is a more convenient method: <br><br><pre> javac -d bin / src / my / mega / pack / NativeCallsClass.java
 cd bin
 javah my.mega.pack.NativeCallsClass
</pre><br>  We compile the class, and then use the javah utility.  After that, we will have a file called my_mega_pack_NativeCallsClass.h.  This is our header.  It looks like this: <blockquote>  <font color="#ff0000">/ * DO NOT EDIT THIS FILE - it is machine generated * /</font> <br>  <font color="#339900">#include &lt;jni.h&gt;</font> <br>  <font color="#ff0000">/ * Header for class my_mega_pack_NativeCallsClass * /</font> <br><br>  <font color="#339900">#ifndef _Included_my_mega_pack_NativeCallsClass</font> <br>  <font color="#339900">#define _Included_my_mega_pack_NativeCallsClass</font> <br>  <font color="#339900">#ifdef __cplusplus</font> <br>  <font color="#0000ff">extern</font> <font color="#FF0000">"C"</font> <font color="#008000">{</font> <br>  <font color="#339900">#endif</font> <br>  <font color="#ff0000">/ *</font> <font color="#ff0000"><br></font>  <font color="#ff0000">* Class: my_mega_pack_NativeCallsClass</font> <font color="#ff0000"><br></font>  <font color="#ff0000">* Method: printOne</font> <font color="#ff0000"><br></font>  <font color="#ff0000">* Signature: () V</font> <font color="#ff0000"><br></font>  <font color="#ff0000">* /</font> <br>  JNIEXPORT <font color="#0000ff">void</font> JNICALL Java_my_mega_pack_NativeCallsClass_printOne <br>  <font color="#008000">(</font> JNIEnv <font color="#000040">*</font> , jclass <font color="#008000">)</font> ; <br><br>  <font color="#ff0000">/ *</font> <font color="#ff0000"><br></font>  <font color="#ff0000">* Class: my_mega_pack_NativeCallsClass</font> <font color="#ff0000"><br></font>  <font color="#ff0000">* Method: printTwo</font> <font color="#ff0000"><br></font>  <font color="#ff0000">* Signature: () V</font> <font color="#ff0000"><br></font>  <font color="#ff0000">* /</font> <br>  JNIEXPORT <font color="#0000ff">void</font> JNICALL Java_my_mega_pack_NativeCallsClass_printTwo <br>  <font color="#008000">(</font> JNIEnv <font color="#000040">*</font> , jclass <font color="#008000">)</font> ; <br><br>  <font color="#339900">#ifdef __cplusplus</font> <br>  <font color="#008000">}</font> <br>  <font color="#339900">#endif</font> <br>  <font color="#339900">#endif</font> </blockquote>  The most important thing here is the signatures of 2 functions: <code>Java_my_mega_pack_NativeCallsClass_printOne(JNIEnv *env, jclass myclass)</code> and <code>Java_my_mega_pack_NativeCallsClass_printTwo(JNIEnv *env, jclass myclass)</code> . <br><br>  We need to implement them.  First, let's deal with their signatures.  env is an interface to the virtual machine.  All operations with JVM are performed using it.  Later we will analyze this in more detail.  myclass is an identifier of a java class that has a native method identified with this function, that is, in our case, this is <code>NativeCallsClass</code> .  Note that the jclass as the second parameter is passed when the method is declared as static.  If it were an ordinary method, then a jobject would be passed to us, which would identify the object whose method we called (in fact, this is an analogue of this). <br><br>  We can only implement these functions: <blockquote>  <font color="#339900">#include &lt;iostream&gt;</font> <br>  <font color="#339900">#include "my_mega_pack_NativeCallsClass.h"</font> <br><br><br>  JNIEXPORT <font color="#0000ff">void</font> JNICALL Java_my_mega_pack_NativeCallsClass_printOne <font color="#008000">(</font> JNIEnv <font color="#000040">*</font> env, jclass myclass <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  std <font color="#008080">::</font> <font color="#0000dd">cout</font> <font color="#000080">&lt;&lt;</font> <font color="#FF0000">"One"</font> <font color="#000080">&lt;&lt;</font> std <font color="#008080">::</font> <font color="#007788">endl</font> ; <br>  <font color="#008000">}</font> <br><br>  JNIEXPORT <font color="#0000ff">void</font> JNICALL Java_my_mega_pack_NativeCallsClass_printTwo <font color="#008000">(</font> JNIEnv <font color="#000040">*</font> env, jclass myclass <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  std <font color="#008080">::</font> <font color="#0000dd">cout</font> <font color="#000080">&lt;&lt;</font> <font color="#FF0000">"Two"</font> <font color="#000080">&lt;&lt;</font> std <font color="#008080">::</font> <font color="#007788">endl</font> ; <br>  <font color="#008000">}</font> </blockquote><br><h1>  We transfer data to the native code and back </h1>  Let's now implement more complex behavior.  Let us have 2 methods: inputInt and outputInt.  One of them will read the number from the console, and the second will output.  Our java class will look like this: <blockquote>  <font color="#000000">package</font> <font color="#006699">my.mega.pack</font> ; <br><br>  <font color="#000000">public</font> <font color="#000000">class</font> NativeCallsClass <br>  <font color="#009900">{</font> <br>  <font color="#000000">static</font> <br>  <font color="#009900">{</font> <br>  <font color="#003399">System</font> .  <font color="#006633">loadLibrary</font> <font color="#009900">(</font> <font color="#0000ff">"megalib"</font> <font color="#009900">)</font> ; <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">native</font> <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000066">int</font> inputInt <font color="#009900">(</font> <font color="#009900">)</font> ; <br>  <font color="#000000">native</font> <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000066">void</font> outputInt <font color="#009900">(</font> <font color="#000066">int</font> v <font color="#009900">)</font> ; <br>  <font color="#009900">}</font> </blockquote>  Run javah and see that the method signatures have changed a bit.  Now they are: <blockquote>  JNICALL Java_my_mega_pack_NativeCallsClass_inputInt <font color="#008000">(</font> JNIEnv <font color="#000040">*</font> , jclass <font color="#008000">)</font> ; <br>  JNIEXPORT <font color="#0000ff">void</font> JNICALL Java_my_mega_pack_NativeCallsClass_outputInt <font color="#008000">(</font> JNIEnv <font color="#000040">*</font> , jclass, jint <font color="#008000">)</font> ; </blockquote>  jint is typedef.  In fact, it denotes some primitive type (for example, int), which corresponds to an int in java.  As you can see, the task was not much more complicated than the previous one :) Our functions will look like this: <blockquote>  <font color="#339900">#include &lt;iostream&gt;</font> <br>  <font color="#339900">#include "my_mega_pack_NativeCallsClass.h"</font> <br><br>  JNIEXPORT jint JNICALL Java_my_mega_pack_NativeCallsClass_inputInt <font color="#008000">(</font> JNIEnv <font color="#000040">*</font> env, jclass myclass <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  <font color="#0000ff">int</font> ret; <br><br>  std <font color="#008080">::</font> <font color="#0000dd">cin</font> <font color="#000080">&gt;&gt;</font> ret; <br><br>  <font color="#0000ff">return</font> ret; <br>  <font color="#008000">}</font> <br><br>  JNIEXPORT <font color="#0000ff">void</font> JNICALL Java_my_mega_pack_NativeCallsClass_outputInt <font color="#008000">(</font> JNIEnv <font color="#000040">*</font> env, jclass myclass, jint v <font color="#008000">)</font> <br>  <font color="#008000">{</font> <br>  std <font color="#008080">::</font> <font color="#0000dd">cout</font> <font color="#000080">&lt;&lt;</font> v <font color="#000080">&lt;&lt;</font> std <font color="#008080">::</font> <font color="#007788">endl</font> ; <br>  <font color="#008000">}</font> </blockquote><br><h1>  Summarize </h1>  So, in the first part, we looked at how JNI works, how to write java classes, with which you can make native calls when and how to write C ++ functions called via JNI.  In the next part (or parts), we will look at interacting with JVM from C ++ code, working with classes, objects, fields and methods, creating java proxy classes that represent C ++ classes, and running JVM from C ++ code. <br><br>  Naturally, the continuation will be only if it is interesting to someone :) <br><br></div><p>Source: <a href="https://habr.com/ru/post/49660/">https://habr.com/ru/post/49660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../49651/index.html">The Chinese government will force all MMORPG players to register.</a></li>
<li><a href="../49652/index.html">iPhone in the Apple keyboard. Concept</a></li>
<li><a href="../49656/index.html">"Virtual Dad" for soldier children</a></li>
<li><a href="../49657/index.html">Be careful with your requests.</a></li>
<li><a href="../49659/index.html">YouTubeTV is now on Wii and PS3</a></li>
<li><a href="../49662/index.html">95% of all downloaded music from the Internet - pirated</a></li>
<li><a href="../49664/index.html">The easiest way to learn how to type blindly</a></li>
<li><a href="../49665/index.html">Sendmail stub for linux</a></li>
<li><a href="../49668/index.html">Arrange tree comments to articles using JavaScript</a></li>
<li><a href="../49670/index.html">Booting Windows 7 from VHD Image</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>