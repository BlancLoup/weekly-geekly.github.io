<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use of controllers to keep ErlyBank afloat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the fourth article in the series ‚ÄúIntroduction to OTP‚Äù . If you have just joined us, I recommend starting with the first part , which speaks a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use of controllers to keep ErlyBank afloat</h1><div class="post__text post__text-html js-mediator-article">  This is the fourth article in the <a href="http://habrahabr.ru/tag/otp%2520introduction/">series ‚ÄúIntroduction to OTP‚Äù</a> .  If you have just joined us, I recommend <a href="http://habrahabr.ru/blogs/erlang/55708/">starting with the first part</a> , which speaks about gen_server and lays the foundation of our banking system.  If you are a capable student, you can take a look at the modules that are currently ready: <a href="http://spawnlink.com/otp-intro-2-gen-fsm-eb-server-authorization/index.html">eb_server.erl</a> , <a href="http://spawnlink.com/otp-intro-4-supervisors-eb-event-manager/index.html">eb_event_manager.erl</a> , <a href="http://spawnlink.com/otp-intro-4-supervisor-eb-withdrawal-handler/index.html">eb_withdrawal_handler.erl</a> and <a href="http://spawnlink.com/otp-intro-2-gen-fsm-eb-atm-cancel/index.html">eb_atm.erl</a> . <br><br>  <b>Scenario</b> : The moment we like at banks and ATMs is that they are always in the same place.  Using an ATM, we can withdraw or deposit money whenever we want, 24 hours a day.  Or go to any branch of the bank when it is open, knowing that we will have full access to our finances.  To guarantee this, you need to be sure that our ErlyBank automation system always remains working: processes must be running all the time.  ErlyBank instructed us to realize this goal.  100% uptime!  (Or as close as we can provide) <br><br>  <b>Result</b> : Using the <i>supervisor</i> OTP, we will create a process whose duty is to monitor the running processes and make sure that they are active. <br><a name="habracut"></a><br><h4>  What is a <i>controller</i> ? </h4><br>  A controller is a process that keeps track of what are called child processes.  If the child process is ‚Äúblown away‚Äù, the controller uses the <i>restart strategy of</i> this child to restart.  This method can ensure the eternal performance of Erlang systems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A controller is part of what is called a control <i>tree</i> .  A well-written Erlang / OTP application starts, starting with the root controller, which monitors the child controllers, which, in turn, monitor additional controllers or processes.  The idea is that if the controller crashes, the parent controller restarts it, and so on up to the root controller.  In the Erlang runtime environment, there is an excellent mode in which the entire system is monitored and restarted if the root controller dies.  Thus, the control tree will always work. <br><br>  The controller has only <b>one feedback method</b> : <i>init / 1</i> .  His task is to return a list of child processes and restart strategies for each process, so that the controller knows what to follow and what to do if something goes wrong. <br><br><h4>  Separate eb_server and event manager </h4><br>  One of the things that I implemented in a previous article on gen_events was to explicitly start the event manager process in the initialization method of the eb_server module.  Then it was the only opportunity that I had, if I really wanted to easily start the server with this dependency.  But now, since we are going to implement start and stop using the controller, we have the opportunity to start the event manager in the control tree.  So let's remove the launch of eb_event_manager from the server code. <br><br>  To do this, simply remove line 84, which starts the event manager, from the eb_server module.  I also added the <i>add_handler</i> call to this place to connect the <i>eb_withdrawal_handler</i> handler to the event <i>manager</i> ( <i>if you consistently read and implement the translations described in this translation cycle, including the addendum to the previous article, then you do not need to add anything, because we have already done so ; after excluding the launch of the event manager, your initialization method code should look like the following - comment of the translator</i> ).  Now the <i>init</i> method of the eb_server module should look like this: <br><br> <code>init([]) -&gt; <br> eb_event_manager:add_handler(eb_withdrawal_handler), <br> {ok, dict:new()}. <br></code> <br>  <a href="http://spawnlink.com/otp-intro-4-supervisors-eb-server-event/index.html">Click here</a> to see eb_server.erl after the changes are made. <br><br><h4>  Inspector's frame </h4><br>  The main framework for writing the controller can be seen <a href="http://spawnlink.com/otp-intro-4-supervisors-eb-sup-skeleton/index.html">here</a> .  As you can see, it contains a startup method and a basic initialization method, which currently returns a restart strategy and non-existent descendant specs.  Restart strategies and <i>restraints</i> ( <i>child specifications</i> ) are <i>covered</i> in the following sections of this article. <br><br>  Save the framework as eb_sup.erl.  Naming this file is another convention.  The controller of a particular group always has the suffix " <i>_sup</i> ."  This is not a mandatory requirement, but is standard practice. <br><br><h4>  Restart strategies </h4><br>  The controller has a unified restart strategy, which it uses in conjunction with the descendants specifications to determine actions in case one of its descendants dies.  The following list contains possible restart strategies: <br><br><ul><li>  <i>one_for_one</i> - When one of the child processes dies, the controller restarts it.  Other descendants do not touch. </li><li>  <i>one_for_all</i> - When one of the child processes dies, all other descendants stop and then restart. </li><li>  <i>rest_for_one</i> - When one of the child processes dies, the ‚Äúremainder‚Äù of the descendants defined in the list of descendants after the deceased is complete, after which they all start again. </li></ul><br>  The restart strategy is specified in the following format: <br><br> <code>{RestartStrategy, MaxRetries, MaxTime} <br></code> <br>  It is very easy to understand by speaking in Russian: If the child is restarted more often than <i>MaxRetries</i> once in <i>MaxTime</i> seconds, then the controller terminates all child processes and then stops working itself.  This is done to prevent an infinite loop of restarts of the child. <br><br><h4>  Syntax and basic descriptions of descendants </h4><br>  The <i>init</i> method of the controller is responsible for returning a list of descendant specifications.  These specifications tell the controller what processes to run and how to do it.  The controller starts the processes in the order of "left to right" (from the beginning of the list to its end).  The restart strategy is a tuple with the following format: <br><br> <code>{Id, StartFunc, Restart, Shutdown, Type, Modules} <br> <br> : <br> Id = term() <br> StartFunc = {M,F,A} <br> M = F = atom() <br> A = [term()] <br> Restart = permanent | transient | temporary <br> Shutdown = brutal_kill | int()&gt;=0 | infinity <br> Type = worker | supervisor <br> Modules = [Module] | dynamic <br> Module = atom() <br></code> <br><br>  <i>Id is</i> used only inside the controller to store the specification of the descendants, but the general agreement implies the use of the module name as the ID, unless you run multiple instances of the module;  in the latter case, add to the ID number. <br><br>  <i>StartFunc</i> is a tuple in the format <i>{Module, Function, Args}</i> , which indicates the function whose call starts the process.  <b>VERY IMPORTANT</b> : the launch function <i>must</i> start the process and link (link) to it and must return <i>{ok, Pid}</i> , <i>{ok, Pid, ‚Äã‚ÄãOther}</i> or <i>{error, Reason}</i> .  The usual OTP start_link methods follow this rule.  But if you implement a module that runs its own processes, make sure you use <i>spawn_link to</i> run <i>them</i> . <br><br>  <i>Restart</i> is one of the three atoms ( <i>atom</i> ) described in the code block above.  If the " <i>permanent</i> " atom is used as a <i>restart</i> , the process is always restarted.  If the value is " <i>temporary</i> ", the process never starts again.  And if this value is equal to " <i>transient</i> ", then the process is restarted only in case of unexpected completion. <br><br>  <i>Shutdown</i> explains to the controller how to terminate child processes.  The atom " <i>brutal_kull</i> " completes the child without calling its completion method.  Any integer number above zero implies a timeout for correct completion.  The atom " <i>infinity</i> " politely completes the process and will wait for it to stop forever. <br><br>  <i>Type</i> tells the controller what the descendant is: another controller or any other process.  If it is a controller, use the supervisor atom, otherwise use the worker atom. <br><br>  <i>Modules</i> is either a list of modules that are affected by this process, or the atom ‚Äúdynamic‚Äù.  In 95% of the cases in the list, you will use a single OTP feedback module for this value.  ‚ÄúDynamic‚Äù is used if the process is a gen_event, since its effect on the modules is dynamic (various handlers that cannot be determined immediately).  This list is used only for release management and is not important in the context of this article, but will be used in a future release management article. <br><br>  Wow!  So much information to learn in such a short time.  It took me quite a lot of time to memorize the format of the descendants' specifications and different restart strategies, so don‚Äôt worry if you can‚Äôt do it right away.  You can always refresh information in the <a href="http://www.erlang.org/doc/man/supervisor.html">manual for supervisors</a> . <br><br><h4>  <i>Speck of a descendant</i> event manager </h4><br>  The first thing you need to start is the event manager, because the server depends on it.  The child specification looks something like this: <br><br> <code>EventManager = {eb_event_manager,{eb_event_manager, start_link,[]}, <br> permanent,2000,worker,dynamic}. <br></code> <br>  After reading the section on descendant specification syntax, this piece of code should be fairly simple.  You may need to go back and check the description to understand the effect of each parameter, and this is absolutely normal!  It is better to linger and figure out the code than to leave your head and forget everything in a couple of minutes.  I suppose that one ‚Äústrange‚Äù thing in the specification description would be to specify the list of modules as ‚Äúdynamic‚Äù ( <i>dynamic; in this case, an atom - comment of the translator</i> ).  This is done because it is a gen_event, and the list of modules used in it is dynamic, since  handlers are connected to it (the <i>number of which may vary during the work - note of the translator</i> ).  In other cases, you must list all the modules that the process uses. <br><br>  Here is the initialization method after the inclusion of specs of descendants into it: <br><br> <code>init([]) -&gt; <br> EventManager = {eb_event_manager,{eb_event_manager, start_link,[]}, <br> permanent,2000,worker,dynamic}, <br> {ok,{{one_for_one,5,10}, [EventManager]}}. <br></code> <br>  I prefer to assign each variable to a descendant of a variable, and then use the contents of these variables to return, rather than put the specs directly in the return value.  One of the largest corns of Erlang appears at the moment when the programmer embeds lists and tuples so deeply that you cannot see where one ends and the other begins, therefore I recommend that you assign each variable to it. <br><br>  If you compile and run the controller now (I think it's worth it!), Then after launching the start_link method belonging to the controller, enter <i>whereis (eb_event_manager)</i> and the command should return the <i>pid</i> of the event manager process.  Then, if you kill the controller by executing <i>exit (whereis (eb_sup), kill)</i> , and then try to get the identifier eb_event_manager again, you should receive a message in response that it is not defined, because the process was killed. <br><br>  Also, for fun, kill eb_event_manager while working under the control of the controller.  Wait a few seconds and check the process.  He must recover! <br><br><h4>  Server and ATM </h4><br>  With help on the specification of descendants and the example above, you should know enough to start the server and the bank.  So if you feel this challenge is tempting, do it now.  If not, then I gave the specifications for the one and the other below: <br><br> <code>Server = {eb_server, {eb_server, start_link, []}, <br> permanent,2000,worker,[eb_server]}, <br> ATM = {eb_atm, {eb_atm, start_link, []}, <br> permanent,2000,worker,[eb_atm]}, <br></code> <br><br>  After creating these specifications, add them to the list returned by the initialization method.  Be sure to post them after the event manager. <br><br>  You can see the complete eb_sup.erl <a href="http://spawnlink.com/otp-intro-4-supervisors-eb-sup-completed/index.html">by clicking here</a> . <br><br><h4>  Adding and removing children at runtime </h4><br>  Unfortunately, I could not come up with a witty script that allows you to insert this mechanism into ErlyBank, but I felt it was important to note the ability to dynamically add and delete descendants' specifications into the already started controller process using the <i><a href="http://www.erlang.org/doc/man/supervisor.html">start_child</a></i> and <i><a href="http://www.erlang.org/doc/man/supervisor.html">delete_child methods</a></i> . <br><br>  They are fairly simple, so I will not repeat here the guide to which I referred;  You can go directly to him and become familiar with these methods. <br><br><h4>  Conclusion </h4><br>  In this article on controllers, I introduced concepts such as the control tree, restart strategies, descendant specifications, and the dynamic addition and deletion of descendants. <br><br>  This concludes the fourth article from the ‚ÄúIntroduction to Erlang / OTP‚Äù series.  The fifth article is ready, scheduled for publication in the next few days and will provide <a href="http://www.erlang.org/doc/man/application.html">applications</a> ( <i>applications</i> ). <br><br><hr><br><h5>  Articles from the series </h5><br>  4. <font color="lightgray">Use of controllers to keep ErlyBank afloat (current article)</font> <br>  3. <a href="http://habrahabr.ru/blogs/erlang/129136/">Introduction to gen_event: Account Change Notifications</a> <br><br>  Translation by <a href="https://habrahabr.ru/users/tiesto/" class="user_link">tiesto</a> : <br>  2. <a href="http://habrahabr.ru/blogs/erlang/56196/">Introduction to gen_fsm: ErlyBank ATM</a> <br>  1. <a href="http://habrahabr.ru/blogs/erlang/55708/">Introduction to gen_server: ‚ÄúErlyBank‚Äù</a> <br>  0. <a href="http://habrahabr.ru/blogs/erlang/55657/">Introduction to the Open Telecom Platform / Open Telecommunication Platform (OTP / OTP)</a> <br>  -one.  <a href="http://habrahabr.ru/blogs/erlang/55651/">Prehistory</a> </div><p>Source: <a href="https://habr.com/ru/post/129277/">https://habr.com/ru/post/129277/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129266/index.html">Ubuntu opens portal for application developers</a></li>
<li><a href="../129269/index.html">Droider Chart. Issue 71 Space</a></li>
<li><a href="../129271/index.html">Administration for the smallest (Part 1: restore order)</a></li>
<li><a href="../129275/index.html">Blitz overview of Windows 8</a></li>
<li><a href="../129276/index.html">Electric and two cars</a></li>
<li><a href="../129279/index.html">The prototype of the national OS will be developed for 5 million rubles and 16 days</a></li>
<li><a href="../129280/index.html">The Big Kinescope Theory</a></li>
<li><a href="../129282/index.html">Motorola Droid 3 - review of the thinnest dual-core qwerty slider</a></li>
<li><a href="../129283/index.html">Dispose pattern</a></li>
<li><a href="../129284/index.html">Notes on Whale Rider</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>