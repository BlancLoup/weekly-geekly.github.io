<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write in C / C ++ in Windows under KolibriOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="KolibriOS is a miniature operating system, the kernel and most of the programs of which are written in assembly language. This, of course, does not me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write in C / C ++ in Windows under KolibriOS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/75f/ed4/4f9/75fed44f93a20fff0e6db06381cd1717.jpg" alt="image" align="left"><br>  KolibriOS is a miniature operating system, the kernel and most of the programs of which are written in assembly language.  This, of course, does not mean that for other programming languages, the path in KolibriOS is closed.  For example, during the evolution of this operating system, there have been several attempts to develop tools or adapt libraries to create C / C ++ applications.  The KolibriOS repository still has working examples that use early adaptations of C / C ++ code, for example (root) / programs / games / kosilka or (root) / programs / system / shell, using different C / Asm wrappers and approaches. <br><br>  For the current time, the most promising of the existing libraries, in my opinion, is newlib.  It consists of an adapted libc, C-wrapper over core coreI functions and a toolchain for building. <br><br>  Unfortunately, the native C / C ++ compiler does not exist in KolibriOS, the current toolchain involves building applications in Windows or Linux. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This article is a guide to setting up newlib for Windows. <br><br><a name="habracut"></a><br>  <b>Install toolchain</b> <br><br>  ‚Ä¢ The archive with the current toolchain is located at <br>  <a href="http://ftp.kolibrios.org/users/Serge/new/Toolchain">ftp.KolibriOS.org/users/Serge/new/Toolchain</a> <br>  Windows version of the archive, msys-kos32-xxx7z <br>  ‚Ä¢ To install the toolchain, you need mingw / msys; to do this, <a href="http://www.mingw.org/">go</a> to <a href="http://www.mingw.org/">www.mingw.org</a> via the downloads link and download and run the file mingw-get-setup.exe <br>  In the window that appears, after clicking the ‚Äúinstall‚Äù button, you need to select the installation path, leave the checkboxes next to ".. support for graphics user interface" and click "Continue". <br>  Attention, this article assumes that the installation of mingw is made in c: \ MinGW <br>  In the window that appears, you need to note mingw32-base and msys-base and start the installation. <br>  ‚Ä¢ After installation, go to the c: \ MinGW \ msys \ 1.0 folder and create the home \ autobuild \ tools folder tree in it <br>  ‚Ä¢ Unpack msys-kos32-xxx7z to c: \ MinGW \ msys \ 1.0 \ home \ autobuild \ tools <br>  (if everything is done correctly, the kos32-gcc.exe file should be located along the path c: \ MinGW \ msys \ 1.0 \ home \ autobuild \ tools \ win32 \ bin \ kos32-gcc.exe) <br>  ‚Ä¢ You can test the toolchain by running c: \ MinGW \ msys \ 1.0 \ msys.bat <br>  in the command line type <br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span>:/home/autobuild/tools/win32/bin kos32-gcc ‚Äìv</code> </pre> <br>  The configuration and version information of kos32-gcc should appear on the screen. <br><br>  <b>Libc install</b> <br><br>  ‚Ä¢ Actual libc components are in the KolibriOS svn repository, path (root) / contrib / sdk / sources / newlib <br>  You can also use the KolibriOS.org web interface in the <a href="http://websvn.kolibrios.org/listing.php%3Frepname%3DKolibri%2BOS">SVN</a> section and download the corresponding archive. <br>  Attention, in this article it is assumed that the installation of newlib is made in d: \ kolibri \ contrib \ sdk \ sources \ newlib <br>  ‚Ä¢ After installation, go to the d: \ kolibri \ contrib \ sdk folder and create the bin and lib folders in it <br>  ‚Ä¢ Run c: \ MinGW \ msys \ 1.0 \ msys.bat <br>  ‚Ä¢ on the command line type <br><pre> <code class="bash hljs"> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> d:/kolibri/contrib/sdk/sources/newlib/libc <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span>:/home/autobuild/tools/win32/bin make shared make install</code> </pre><br>  ‚Ä¢ As a result, the file libc.dll should appear in the folder d: \ kolibri \ contrib \ sdk \ bin <br>  in the folder d: \ kolibri \ contrib \ sdk \ lib - libapp.a, libc.dll, a, libdll.a <br><br>  <b>Install Qemu</b> <br><br>  Qemu is an emulation (and virtualization) system for a computer that supports various architectures.  The Qemu installation files are located at <a href="http://qemu.weilnetz.de/">qemu.weilnetz.de</a> <br><br>  ‚Ä¢ To work with Qemu, you need to download the "LiveCD bootable CD" image of KolibriOS at <a href="http://kolibrios.org/ru/download">KolibriOS.org/ru/download</a> <br>  Attention, in this article it is assumed that the image of KolibriOS is located along the path d: /kolibri/dist/kolibri.iso <br>  ‚Ä¢ After installation, in the working folder (for example, d: \ work) create the file qemu.bat <br><br>  File d: /work/qemu.bat <br><pre> <code class="dos hljs"> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> QEMU_PATH="c:/Program Files/qemu/" <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">PATH</span></span>=<span class="hljs-variable"><span class="hljs-variable">%PATH%</span></span>;<span class="hljs-variable"><span class="hljs-variable">%QEMU_PATH%</span></span> qemu-system-i386.exe -L . -m <span class="hljs-number"><span class="hljs-number">128</span></span> -cdrom d:/kolibri/dist/kolibri.iso -boot d -localtime -vga vmware -<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> nic,model=rtl8139 -<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> user -soundhw ac97 -usb -usbdevice tablet</code> </pre><br>  ‚Ä¢ You can read more about the KolibriOS startup keys on Qemu at <a href="http://wiki.kolibrios.org/wiki/Setting_up_QEMU">wiki.KolibriOS.org/wiki/Setting_up_QEMU</a> <br><br>  <b>Create application</b> <br><br>  You can test the performance of newlib by putting a simple application that displays ‚Äúhello, world!‚Äù To the window and ‚Äúhello, board!‚Äù To the debug panel. <br><br>  File d: /work/simple.c <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stdlib.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stdio.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"string.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"kos32sys.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//--------------------------------------------------------------- static const char *WND_HEADER_STR = "window header"; static const char *HELLO_WORLD_STR = "hello, world!"; static const char *HELLO_BOARD_STR = "hello, board!\n"; static const uint32_t CUSTOM_BUTTON_ID = 100; //--------------------------------------------------------------- static void RenderWindow(void); static void BoardPuts(const char *c); static void SetMaskForEvents(unsigned int mask); //--------------------------------------------------------------- void RenderWindow() { const uint32_t WND_STYLE = 3; // (window type III, skinned window) const int WND_X = 100; const int WND_Y = 100; const int WND_W = 320; const int WND_H = 320; const color_t WND_COLOR = 0xffffff; const int BUTTON_W = 24; const int BUTTON_H = 24; const int BUTTON_X = WND_W / 2 - BUTTON_W - 8; const int BUTTON_Y = (WND_H - BUTTON_H) / 2; const color_t BUTTON_COLOR = 0x9e9e9e; const color_t TEXT_COLOR = 0xff0000; BeginDraw(); DrawWindow(WND_X, WND_Y, WND_W, WND_H, WND_HEADER_STR, WND_COLOR, WND_STYLE); draw_text_sys(HELLO_WORLD_STR, WND_W / 2, WND_H / 2, strlen(HELLO_WORLD_STR), TEXT_COLOR); DefineButton(65536 * BUTTON_X + BUTTON_W, 65536 * BUTTON_Y + BUTTON_H, CUSTOM_BUTTON_ID, BUTTON_COLOR); EndDraw(); } //--------------------------------------------------------------- // coreAPI #63 asm function call example void BoardPuts(const char *s) { unsigned int i = 0; while(*(s + i)) { asm volatile ("int $0x40"::"a"(63), "b"(1), "c"(*(s + i))); i++; } } //--------------------------------------------------------------- // coreAPI #40 set event mask void SetMaskForEvents(unsigned int mask) { asm volatile ("int $0x40"::"a"(40), "b"(mask)); } //--------------------------------------------------------------- int main() { enum SysEventTypes { REDRAW_EVENT = 1, GUI_BUTTON_EVENT = 3 }; // enabling only REDRAW_EVENT and GUI_BUTTON_EVENT, 0000000000000101b SetMaskForEvents(0x5); // open BOARD application and check for a text message BoardPuts(HELLO_BOARD_STR); RenderWindow(); for(;;) { const uint32_t e = get_os_event(); switch(e) { case REDRAW_EVENT: { RenderWindow(); } break; case GUI_BUTTON_EVENT: { const uint32_t bt = get_os_button(); if(bt == CUSTOM_BUTTON_ID || bt == 1) // 1 -- [x] window button id { return 0; } } break; } } return 0; } //---------------------------------------------------------------</span></span></span></span></code> </pre><br>  File d: / work / Makefile <br><pre> <code class="bash hljs">EXEC = simple CC = kos32-gcc LD = kos32-ld OBJCOPY = kos32-objcopy SDK_DIR:= /d/kolibri/contrib/sdk LDFLAGS = -static -S -nostdlib -T$(SDK_DIR)/sources/newlib/app.lds -Map $(EXEC).map --image-base 0 CFLAGS = -c -O2 -fomit-frame-pointer -U__WIN32__ -U_Win32 -U_WIN32 -U__MINGW32__ -UWIN32 INCLUDES= -I$(SDK_DIR)/sources/newlib/libc/include LIBPATH:= -L$(SDK_DIR)/lib -L/home/autobuild/tools/win32/mingw32/lib <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span>:/home/autobuild/tools/win32/bin:/MinGW/bin default: $(EXEC) $(EXEC):$(EXEC).o makefile $(LD) $(LDFLAGS) $(LIBPATH) -o $(EXEC) *.o -lgcc -lapp -lc.dll $(OBJCOPY) $(EXEC) -O binary %.o : %.c makefile $(CC) $(CFLAGS) $(INCLUDES) -o <span class="hljs-variable"><span class="hljs-variable">$@</span></span> $&lt;</code> </pre><br>  To build the application, you need to run c: \ MinGW \ msys \ 1.0 \ msys.bat <br>  in the command line type <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> d:/work make</code> </pre><br>  The result of the execution will be an executable file in KolibriOS <br><br>  <b>It is important</b> : <br>  To build a c ++ project, you need to use the kos32-gcc compiler, the order in which the libraries are specified for the linker is: libgcc last, libc after libsupc ++ and gcc_eh. <br><br>  Example <br> <code>$(LD) $(LDFLAGS) $(LIBPATH) -o $(EXEC) *.o -lapp -lsupc++ -lgcc_eh -lc.dll -lgcc</code> <br> <br>  <b>Transferring files between Windows and KolibriOS</b> <br><br>  The easiest way to transfer files between Windows and KolibriOS is a flash-usb drive. <br>  Another way to use Qemu is to create a disk image and mount it as hdd.  In this case, qemu.bat is supplemented by another key, -hda d: \ work \ c100.img, where c100.img is the name of the image.  The image should be already formatted, so it is better not to create it, but remove it from a small flash-usb drive using <a href="http://sourceforge.net/projects/win32diskimager">Win32DiskImager.exe</a> utility <br>  You can edit the image using <a href="http://www.winimage.com/winimage.htm">WinImage</a> . <br><br>  If when loading KolibriOS the contents of the / hd0 / 1 disk are empty, you need to reboot the system and in the offered boot menu select the item "[b] Add disks visible through BIOS" and enable this option (1) <br><br>  <b>Known Issues</b> <br><br>  By default, applications built with newlib require the /KolibriOS/lib/libc.dll file in KolibriOS. <br>  When using Qemu, this may cause problems with the ‚Äúminimal‚Äù version of kolibri.img. <br>  There are two solutions to this problem: <br><br>  ‚Ä¢ Use the iso version (LiveCD boot CD) <br>  If the ‚Äúsimple‚Äù application generates an error at startup, most likely the old version of libc.dll is most likely on the image.  Usually on the ftp.KolibriOS.org/users/Serge/new/Toolchain already mentioned above you can find the latest libraries in the sdk.zip archive.  A simple way to update the libraries on the image is to use the <a href="http://www.magiciso.com/">MagicISO</a> utility. <br><br>  ‚Ä¢ Use the built-in functionality of KolibriOS "searchapp": <br>  - copy the kolibri.lbl from d: \ kolibri \ dist \ kolibri.iso to the root of the disk (flash-usb drive, disk image * .img) <br>  (kolibri.iso can be unpacked with the 7z archiver or winrar, kolibri.lbl is in the root) <br>  - in the root of the same disk drive create a folder tree kolibrios / lib <br>  - copy the executable file (‚Äúsimple‚Äù) to the / kolibrios folder <br>  - copy libc.dll from d: \ kolibri \ contrib \ sdk \ bin to the folder / kolibrios / lib <br><br>  <b>useful links</b> <br><br>  All header-files of wrappers and adapted libraries are in (kolibri) \ contrib \ sdk \ sources \ newlib \ libc \ include <br><br>  <a href="http://wiki.kolibrios.org/wiki/Ru/api/kernel">Description of system functions</a> <br>  (example of working with coreAPI in the example simple.c, function board_puts) <br><br>  <a href="http://board.kolibrios.org/viewtopic.php%3Ff%3D24%26t%3D1587">Newlib forum thread</a> <br><br>  <a href="">File archive for this article</a> <br>  ‚Ä¢ the _kos folder contains ready-made files for launch in KolibriOS <br>  ‚Ä¢ the _win32 folder contains image / c100.img (disk image for Qemu with compiled ‚Äúsimple‚Äù), makefile, qemu.bat, simple.c <br><br>  PS <br>  I express <a href="http://habrahabr.ru/users/sourcerer">my deep</a> gratitude to mentor <a href="http://habrahabr.ru/users/sourcerer">Sourcerer</a> for their patience, help and advice! <br><br><img src="https://lh3.googleusercontent.com/-jowqA5ufY_0/U82B6Qi8FlI/AAAAAAAAE_k/cpBQcWzuRsg/w728-h581-no/result.png" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/229231/">https://habr.com/ru/post/229231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229215/index.html">Completion of Livolo light load switches</a></li>
<li><a href="../229217/index.html">Sports technologization: smart devices for professionals and amateurs</a></li>
<li><a href="../229225/index.html">AngularJS: how I abandoned ng-include and linked the states of two controllers</a></li>
<li><a href="../229227/index.html">Behavioral factors and a comprehensive assessment of the effectiveness of the interaction of advertising with Central Asia (part 2: assessment criteria)</a></li>
<li><a href="../229229/index.html">A serious loss of Blizzard, adding to the team Oculus Rift and the new publisher of the game Boom Beach - the main mobile news of the week</a></li>
<li><a href="../229235/index.html">My web-interface management smart apartment</a></li>
<li><a href="../229237/index.html">How-to: How to buy shares of technology companies on the example of "Yandex"</a></li>
<li><a href="../229239/index.html">Samsung launches new SSD-drive based on 3D technology V-NAND</a></li>
<li><a href="../229243/index.html">We broadcast a video stream from an IP camera using WebRTC</a></li>
<li><a href="../229245/index.html">The native has died. Long live the native!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>