<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Software Internet gateway for a small company (Shorewall, OpenVPN, OSPF). Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present while two articles focused on the "continuing" system administrators, for experienced I hardly open something new. 
 In these articles, we w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Software Internet gateway for a small company (Shorewall, OpenVPN, OSPF). Part 1</h1><div class="post__text post__text-html js-mediator-article">  I present while two articles focused on the "continuing" system administrators, for experienced I hardly open something new. <br>  In these articles, we will look at building an Internet gateway on linux, allowing you to link several company offices, and provide limited access to the network, traffic prioritization (QoS) and simple load balancing with redundancy between two providers. <br>  Specifically in this part: <br><ul><li>  The simplest setting is Shorewall </li><li>  Awfully tricky dnsmasq setup </li><li>  No less complicated setting OpenVPN </li><li>  And for many continuing admins atypical, dynamic routing, for example, OSPF </li></ul><br>  And <a href="http://habrahabr.ru/post/274677/">in the second</a> part will be considered: <br><ul><li>  More detailed setting Shorewall </li><li>  Terrible and not clear QoS </li><li>  Load balancing and redundancy </li></ul><br>  <a href="https://habrahabr.ru/post/277983/">In the third part</a> : <br><ul><li>  Full QoS in Shorewall </li><li>  More detailed setting Shorewall </li><li>  Channel traffic scaling according to protocols </li><li>  Crutches, without them, nowhere </li></ul><br>  <a href="https://habrahabr.ru/post/274765/">In the fourth part</a> : <br><ul><li>  Automatic events </li><li>  Macros </li></ul><br><a name="habracut"></a><br>  Everything described below is valid for CentOS 7.1 (and above, the 6th series is also suitable, but with some minor features) <br><br>  We presume that we have: <br><ul><li>  Lokalka first branch: 172.16.0.0/23 </li><li>  OpenVPN subnet of the first branch: 172.16.3.0/25 </li><li>  The second branch respectively: 172.16.8.0/23 and 172.16.11.0/25 </li></ul><br>  In general, my ip plan meant reservation / 21 networks for each branch from the range of 172.16.0.0/12.  Each band / 21 is cut into subnets for different needs (more details in the next article). <br><br><h1>  The simplest setting is Shorewall </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For those who have not heard before, Shorewall is an add-on to the iptables utility for configuring NetFilter in the Linux kernel.  By itself, iptables is not too complicated, but when the gateway configuration becomes large and difficult because of this, it is not easy to understand this amount of iptables commands. <br>  Various self-made scripts or, for a long time not self-made, systems similar to Shorewall come to the rescue in such situations. <br><br>  In Shorewall, everything revolves around the concept of "zone".  Hosts are included in the zone (by specifying interfaces or directly networks and / or individual addresses). <br><div class="spoiler">  <b class="spoiler_title">Let's look in the zones file</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/zones # # For information about this file, type "man shorewall-zones" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-zones.html # ############################################################################### #ZONE TYPE OPTIONS IN OUT # OPTIONS OPTIONS fw firewall red ipv4 grn ipv4 tun ipv4</span></span></code> </pre> <br></div></div><br>  Here I identified three zones (for the ipv4 protocol), in addition to the special ‚Äúfw‚Äù zone, which embodies the gateway itself. <br><ul><li>  red - internet zone </li><li>  grn - local area network </li><li>  tun - zone for our tunnels </li></ul><br>  The time has come to put interfaces into these zones (we will not use individual hosts yet), but before that we will make some changes to the file: <br><div class="spoiler">  <b class="spoiler_title">params</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/params # # Assign any variables that you need here. # # It is suggested that variable names begin with an upper case letter # to distinguish them from variables used internally within the # Shorewall programs # # Example: # # NET_IF=eth0 # NET_BCAST=130.252.100.255 # NET_OPTIONS=routefilter,norfc1918 # # Example (/etc/shorewall/interfaces record): # # net $NET_IF $NET_BCAST $NET_OPTIONS # # The result will be the same as if the record had been written # # net eth0 130.252.100.255 routefilter,norfc1918 # ############################################################################### IF_RED1=eth0 IF_GRN=eth1 NET_GRN=172.16.0.0/23 IF_TUN=tap+ #LAST LINE -- DO NOT REMOVE</span></span></code> </pre><br></div></div><br>  In this file, you can set different variables, which we will later use in other files, and which help to make the config more portable between systems.  Now we have our physical interfaces and local branch subnet here.  Note that tap + talks about using a mask, under which any tapX falls (except for just ‚Äútap‚Äù). <br>  And now the file: <br><div class="spoiler">  <b class="spoiler_title">interfaces</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/interfaces # # For information about entries in this file, type "man shorewall-interfaces" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-interfaces.html # ############################################################################### ?FORMAT 2 ############################################################################### #ZONE INTERFACE OPTIONS red $IF_RED1 dhcp,routeback,optional grn $IF_GRN dhcp,routeback,optional tun $IF_TUN dhcp,routeback,optional</span></span></code> </pre><br></div></div><br>  Here, too, nothing particularly difficult, the options tell us that: <br><ul><li>  dhcp - the DHCP protocol can work on the interface (both client and server) </li><li>  routeback - useful in the future, forcing you to return responses through the same interface where requests came from </li><li>  optional - says that you do not need to panic if the interface is not active (if Shorewall does not find the required interface, then it will not start entirely) </li></ul><br>  Let's make a few changes to the file ‚Äúshorewall.conf‚Äù, it is quite large, I will give its truncated view (only changed values): <br><div class="spoiler">  <b class="spoiler_title">shorewall.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">############################################################################### # # Shorewall Version 5 -- /etc/shorewall/shorewall.conf # # For information about the settings in this file, type "man shorewall.conf" # # Manpage also online at http://www.shorewall.net/manpages/shorewall.conf.html ############################################################################### # STARTUPENABLED ############################################################################### STARTUP_ENABLED=Yes ############################################################################### # FIREWALL OPTIONS ############################################################################### BLACKLIST="ALL" CLAMPMSS=Yes IP_FORWARDING=Yes ################################################################################ # PACKETMARKLAYOUT ################################################################################ TC_BITS=14 PROVIDER_BITS=8 PROVIDER_OFFSET=16 MASK_BITS=16 ZONE_BITS=0</span></span></code> </pre><br></div></div><br>  All parameters are quite understandable, but the ‚ÄúPACKET MARK LAYOUT‚Äù section will be discussed in the following sections, ‚ÄúBLACKLIST‚Äù specifies the type of blocked packets (all) for banned addresses, also for the future. <br>  It's time to create default policies: <br><div class="spoiler">  <b class="spoiler_title">policy</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/policy # # For information about entries in this file, type "man shorewall-policy" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-policy.html # ############################################################################### #SOURCE DEST POLICY LOG LIMIT: CONNLIMIT: # LEVEL BURST MASK $FW all ACCEPT grn all ACCEPT red all DROP tun grn ACCEPT tun red REJECT tun $FW ACCEPT</span></span></code> </pre><br></div></div><br>  Keywords mean the following: <br><ul><li>  ACCEPT - accept (including forward) packets </li><li>  REJECT - Discard the package, and inform the sender that we are not expecting letters from him. </li><li>  DROP - Drop the package, and mysteriously looking around, do not tell anyone </li></ul><br>  In the third column, you can register several more parameters, one of which is info, will set the logging of this policy (it makes sense for DROP and REJECT, and then ACCEPT will fill you up with logs). <br><br>  The given policy is primitive and not suitable for serious projects, it corresponds to the setting of most home routers, but for the very start it will suit us. <br>  It remains a little bit, namely to set up masquerading (which in the IPv6 era will not be necessary): <br><div class="spoiler">  <b class="spoiler_title">masq</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/masq # # For information about entries in this file, type "man shorewall-masq" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-masq.html # ################################################################################################################################### #INTERFACE:DEST SOURCE ADDRESS PROTO PORT(S) IPSEC MARK USER/ SWITCH ORIGINAL PROBABILITY # GROUP DEST $IF_RED1 $NET_GRN</span></span></code> </pre><br></div></div><br>  Obviously, everything that goes towards the interface $ IF_RED1 from the $ NET_GRN network needs to be masked.  The third column ADDRESS is used for SNAT. <br><br>  For tracking and a corresponding change in the firewall rules, in response to enabling / disabling the interface, a small script will help us: <br><div class="spoiler">  <b class="spoiler_title">/etc/NetworkManager/dispatcher.d/30-shorewall.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash IF=$1 #   ,     STATUS=$2 #     case $STATUS in up) #      shorewall enable $IF shorewall6 enable $IF ;; down) #      shorewall disable $IF shorewall6 disable $IF ;; esac</span></span></code> </pre><br></div></div><br>  Having given the command ‚Äúsystemctl enable shorewall.service &amp;&amp; systemctl restart shorewall.service‚Äù, we will use our firewall settings, and nothing will work (well, almost), we do not have enough smallness: there is no caching DNS AND DHCP servers (let's not we customize all client machines). <br><br><h1>  The simplest setting is dnsmasq </h1><br><br>  This service does its job very well, and the network / 23 is not a problem for it, and the simplicity and flexibility of the settings makes it very suitable for our situation. <br>  Since the configuration file is large, I will bring it in a reduced form too: <br><div class="spoiler">  <b class="spoiler_title">/etc/dnsmasq.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Configuration file for dnsmasq. # # Format is one option per line, legal options are the same # as the long options legal on the command line. See # "/usr/sbin/dnsmasq --help" or "man 8 dnsmasq" for details. # If you want dnsmasq to listen for DHCP and DNS requests only on # specified interfaces (and the loopback) give the name of the # interface (eg eth0) here. # Repeat the line for more than one interface. interface=eth1 # Set the domain for dnsmasq. this is optional, but if it is set, it # does the following things. # 1) Allows DHCP hosts to have fully qualified domain names, as long # as the domain part matches this setting. # 2) Sets the "domain" DHCP option thereby potentially setting the # domain of all systems configured by DHCP # 3) Provides the domain part for "expand-hosts" domain=domain.local # This is an example of a DHCP range where the netmask is given. This # is needed for networks we reach the dnsmasq DHCP server via a relay # agent. If you don't know what a DHCP relay agent is, you probably # don't need to worry about this. dhcp-range=172.16.0.50,172.16.0.150,255.255.254.0,12h # Set the DHCP server to authoritative mode. In this mode it will barge in # and take over the lease for any client which broadcasts on the network, # whether it has a record of the lease or not. This avoids long timeouts # when a machine wakes up on a new network. DO NOT enable this if there's # the slightest chance that you might end up accidentally configuring a DHCP # server for your campus/company accidentally. The ISC server uses # the same option, and this URL provides more information: # http://www.isc.org/files/auth.html dhcp-authoritative</span></span></code> </pre><br></div></div><br><br>  I think it‚Äôs not necessary to explain anything here, set the interface on which to service DNS and DHCP requests, set the range of addresses to be distributed, set some parameters passed to DHCP, and set the authoritarian mode of operation. <br>  Now, after ‚Äúsystemctl enable dnsmasq.service &amp;&amp; systemctl restart dnsmasq.service‚Äù, we will have access to the Internet from internal clients (as soon as they receive a DHCP lease). <br><br><h1>  OpenVPN setup </h1><br><br>  I think this part will not be difficult for anyone at all, but we will give these steps: <br><ol><li>  Install packages from epel: openvpn easy-rsa </li><li>  Copy the / usr / share / easy-rsa folder into / etc / openvpn and rename it to easy-rsa </li><li>  Go to / etc / openvpn / easy-rsa and, if necessary, edit the vars file </li><li>  Run: ". ./Vars &amp;&amp; ./clean-all &amp;&amp; ./build-dh &amp;&amp; openvpn --genkey --secret ./keys/ta.key &amp;&amp;. / Build-ca &amp;&amp; ./build-key-server server # Hi from Gentushnik (how to install Gentoo in one team, and this is possible)! </li></ol><br>  We also need a server configuration file: <br><div class="spoiler">  <b class="spoiler_title">/etc/openvpn/inter-lan.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">port 1194 proto udp topology subnet dev tap0 ca ./easy-rsa/keys/ca.crt cert ./easy-rsa/keys/server.crt key ./easy-rsa/keys/server.key dh ./easy-rsa/keys/dh1024.pem client-config-dir ./ccd/inter-lan/ client-to-client keepalive 10 120 tls-server tls-auth ./easy-rsa/keys/ta.key 0 cipher AES-256-OFB comp-lzo no auth SHA256 status /var/run/openvpn/inter-lan.status sndbuf 393216 rcvbuf 393216 push <span class="hljs-string"><span class="hljs-string">"sndbuf 393216"</span></span> push <span class="hljs-string"><span class="hljs-string">"rcvbuf 393216"</span></span> mode server push <span class="hljs-string"><span class="hljs-string">"topology subnet"</span></span> ifconfig 172.16.3.1 255.255.255.128 ifconfig-pool 172.16.3.2 172.16.3.126 255.255.255.128 ifconfig-pool-persist /var/run/openvpn/inter-lan.db 3600 verb 1</code> </pre><br></div></div><br>  The default parameters file passed to OpenVPN for the client: <br><div class="spoiler">  <b class="spoiler_title">/ etc / openvpn / ccd / inter-lan / DEFAULT</b> <div class="spoiler_text"><pre> <code class="bash hljs">push <span class="hljs-string"><span class="hljs-string">"comp-lzo no"</span></span></code> </pre><br></div></div><br>  Client configuration template file: <br><div class="spoiler">  <b class="spoiler_title">/etc/openvpn/easy-rsa/templates/inter-lan.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">client port 1194 dev tap4 proto udp remote &lt;   &gt; 1194 tls-client ns-cert-type server cipher AES-256-OFB auth SHA256 verb 1 comp-lzo no &lt;ca&gt; -----CERTIFICATE-CA----- &lt;/ca&gt; &lt;cert&gt; -----CERTIFICATE----- &lt;/cert&gt; &lt;key&gt; -----KEY----- &lt;/key&gt; key-direction 1 &lt;tls-auth&gt; -----TLS----- &lt;/tls-auth&gt;</code> </pre><br></div></div><br>  And auxiliary samopinsky script: <br><div class="spoiler">  <b class="spoiler_title">/etc/openvpn/easy-rsa/build-ovpn.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # $2 -        [ "$2" == "-r" ] &amp;&amp; ./build-key $1 CWD=$(pwd) RUN=$(dirname $0) cd "$RUN" mkdir -p ../ovpn/$1 for i in $(ls -1 ./templates/); do TEMPLATE=$(basename $i .conf) sed -e '/-----CERTIFICATE-CA-----/{r /etc/openvpn/easy-rsa/keys/ca.crt' -e 'd}' ./templates/${TEMPLATE}.conf | \ sed -e '/-----CERTIFICATE-----/{r /etc/openvpn/easy-rsa/keys/'"$1.crt"'' -e 'd}' | \ sed -e '/-----KEY-----/{r /etc/openvpn/easy-rsa/keys/'"$1.key"'' -e 'd}' | \ sed -e '/-----TLS-----/{r /etc/openvpn/easy-rsa/keys/ta.key' -e 'd}' &gt; ../ovpn/$1/${TEMPLATE}-$1.ovpn done cd "$CWD"</span></span></code> </pre><br></div></div><br>  I use the tap interface, because tun is routed by the OpenVPN core, and this is configured using the iroute directive.  And the sadness is, if behind one server there is another one to which we need a route, we need to explicitly register this route in ccd, the same iroute directive, which, apart from the usual routes, will create unnecessary difficulties (what difficulties I say, write in the OSPF section). <br><br>  Now we will generate a configuration for the client: <br>  ./build-ovpn.sh &lt;client name&gt; -r <br>  Create a ccd file for the client: <br><div class="spoiler">  <b class="spoiler_title">/ etc / openvpn / ccd / inter-lan / &lt;client name&gt;</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    ,       :),   ,   DEFAULT</span></span></code> </pre><br></div></div><br>  Then you need to copy the file from the / etc / openvpn / ovpn / &lt;client name&gt; / &lt;client name&gt; .ovpn directory to the client computer (gateway) and place it in / etc / openvpn / with the extension ".conf" <br>  Run openvpn on the client and server: <br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> openvpn@&lt; conf    conf&gt;.service &amp;&amp; systemctl start openvpn@&lt; conf    conf&gt;.service</code> </pre><br>  And the result is only on the server!  The client is in trouble.  Shorewall is to blame for everything, or rather our policy, we did not allow connections from the Internet (red zone)! <br>  Let's add the allowing rule to the file: <br><div class="spoiler">  <b class="spoiler_title">/ etc / shorewall / rules</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/rules # # For information on the settings in this file, type "man shorewall-rules" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-rules.html # ###################################################################################################################################################################################################### #ACTION SOURCE DEST PROTO DEST SOURCE ORIGINAL RATE USER/ MARK CONNLIMIT TIME HEADERS SWITCH HELPER # PORT(S) PORT(S) DEST LIMIT GROUP ?SECTION ALL ?SECTION ESTABLISHED ?SECTION RELATED ?SECTION INVALID ?SECTION UNTRACKED ?SECTION NEW #    : /usr/share/shorewall/macro.OpenVPN #  ,     /etc/shorewall,      OpenVPN(ACCEPT) red $FW # ,      : #ACCEPT red $FW udp 1194</span></span></code> </pre><br></div></div><br>  We execute "shorewall restart" and see that the client has successfully connected. <br>  Let's try to ping client ip issued by OpenVPN, all Ok.  Now the network behind the client (172.16.8.0/23), and again a bummer, ip in the tunnel is pinged, but the network is not, since there are no routes, OSPF will provide them to us. <br><br><h1>  Configure OSPF Dynamic Routing Protocol in quagga </h1><br><br>  Here on Habr√© there is a series of large articles devoted to dynamic routing, how it works, etc., right there I will give some practical squeeze out of them and the setting itself. <br><br>  I came to the use of OSPF after the company in which I work, acquired almost a dozen branch offices and representative offices, and the tunnels between them were built not only with a star, but were also direct between individual branches (so that the most actively interacting went in a straight line, and not in the central node).  When I got a little swollen by the number of routes and their settings, built a bicycle (a script that rebuilt static configs of routes using a prescribed map), the bicycle was beautiful, hexagonal wheels, ten pedals, and you ride it for a ride, while walking next to it ... in the swamp, I thought, and quickly found out about OSPF and began the implementation. <br><br>  We will need the quagga package, after installation, copy the initial configuration file and start the service: <br><pre> <code class="bash hljs">cp /usr/share/doc/quagga-0.99.22.4/ospfd.conf.sample /etc/quagga/ospfd.conf &amp;&amp; chown quagga. /etc/quagga/ospfd.conf systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> ospfd.service &amp;&amp; systemctl start ospfd.service</code> </pre><br>  Now we need to configure the ip address on the loopback interface, which among other things (you will find the meaning in other articles) will play the role of router-id. <br>  Add the following lines to the / etc / sysconfig / network-scripts / ifcfg-lo file: <br><pre> <code class="bash hljs">IPADDR2=172.16.248.1 NETMASK2=255.255.255.255</code> </pre><br>  And re-raise the interface: ifup lo <br>  Now let's connect to the ospfd service and configure it: <br><pre> <code class="bash hljs">telnet localhost ospfd <span class="hljs-comment"><span class="hljs-comment">#   zebra ospfd# enable #    ospfd# configure terminal #    ospfd(config)# password &lt;&gt; #     ospfd(config)# hostname &lt; &gt; #  ,     ospfd(config)# log syslog #      ospfd(config)# interface &lt;   tap0&gt; #  ospfd(config-if)# ip ospf network point-to-multipoint #  tap    (    ,        ) ospfd(config-if)# exit #    ospfd(config)# router ospf #   ospf ospfd(config-router)# router-id 172.16.248.1 #   ospfd(config-router)# passive-interface default # OSPF    ospfd(config-router)# no passive-interface &lt; &gt; #    ,        ospf (     tap0) ospfd(config-router)# network 172.16.0.0/12 area 0.0.0.0 # ,     ,   ,     .    /12    ,        ospfd(config-router)# write memory #    </span></span></code> </pre><br>  Summary configuration file: <br><div class="spoiler">  <b class="spoiler_title">/etc/quagga/ospfd.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">! ! Zebra configuration saved from vty ! 2016/01/05 14:20:08 ! hostname ospfd password zebra <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> stdout <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> syslog ! ! ! interface eth0 ! interface eth1 ! interface lo ! interface tap0 ip ospf network point-to-multipoint ip ospf cost 3 ! router ospf ospf router-id 172.16.248.1 passive-interface default no passive-interface tap0 network 172.16.0.0/12 area 0.0.0.0 ! line vty !</code> </pre><br>  You may notice that the file reflects the configuration commands that we entered into the console.  Is it possible that you can see ‚Äúip ospf cost 3‚Äù, with which I have indicated the cost of the interface (again for the future, when there will be different routes to one point). <br></div></div><br>  By copying this file to another gateway (which is associated with this by OpenVPN) and making the appropriate edits, we will get a working configuration between the two gateways (the ospfd service on the second gateway also needs to be started). <br>  Now the ‚Äúip route list‚Äù command should show us something like this: <br><pre> <code class="bash hljs">default via 192.168.10.1 dev eth0 proto static metric 100 172.16.0.0/23 dev eth1 proto kernel scope link src 172.16.0.1 metric 100 172.16.3.0/25 dev tap0 proto kernel scope link src 172.16.3.1 172.16.3.1 dev tap0 proto zebra 172.16.8.0/23 via 172.16.3.2 dev tap0 proto zebra metric 13 172.16.11.1 via 172.16.3.2 dev tap0 proto zebra metric 3 172.16.12.129 via 172.16.3.2 dev tap0 proto zebra metric 3 172.16.248.2 via 172.16.3.2 dev tap0 proto zebra metric 13 192.168.10.0/24 dev eth0 proto kernel scope link src 192.168.10.37 metric 100 192.168.10.1 dev eth0 scope link src 192.168.10.37</code> </pre><br>  Routes with ‚Äúproto zebra‚Äù are just added using OSPF. <br><br>  I recommend to everyone, use dynamic routing, even if you have only two branches.  When they become more, you will not be difficult to add another node to the network. <br>  And of course, the proposed OSPF configuration is rather primitive, wait for the more complicated options with examples in the next article (or read the articles of more competent comrades, in fact, I have not studied OSPF deeply enough). </div><p>Source: <a href="https://habr.com/ru/post/274639/">https://habr.com/ru/post/274639/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274629/index.html">The first build of Vivaldi 1.0.365.3 in the coming year</a></li>
<li><a href="../274631/index.html">Pagekit: Symfony Modular CMS Review</a></li>
<li><a href="../274633/index.html">Rodent Hunt for Linux</a></li>
<li><a href="../274635/index.html">Use android.os.Binder to organize asynchronous interaction in Android</a></li>
<li><a href="../274637/index.html">Ember.js - goodbye MVC (part 1)</a></li>
<li><a href="../274641/index.html">Yandex.Meteum - a new development or marketing ploy?</a></li>
<li><a href="../274645/index.html">"Other" logic and reversible calculations</a></li>
<li><a href="../274649/index.html">Interview: Cryptocurrency DASH - current and future</a></li>
<li><a href="../274651/index.html">How via composer it is convenient to replace the system package with an alternative version</a></li>
<li><a href="../274655/index.html">Putting together a simple MariontteJS + ES6 application using Brunch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>