<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>It is dangerous to use EDS in Kazakhstan</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, the state is trying to transfer all state services to electronic format as much as possible. Address certificates are actively issued, and o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>It is dangerous to use EDS in Kazakhstan</h1><div class="post__text post__text-html js-mediator-article"><p>  Recently, the state is trying to transfer all state services to electronic format as much as possible.  Address certificates are actively issued, and other certificates are issued through the e-government portal.  You can even <del>  register marriage </del>  marry through the portal.  In fact, very convenient.  Of course there are minuses, mostly organizational. <del>  regulatory </del>  at the level of laws, at the level of implementation.  But this is another question, the main thing is very good initiatives.  It's all good, but the post is not about that. </p><br><p>  Obviously, to use public services, you need to somehow confirm your identity.  For this, once a long time ago, the use of electronic signature was fixed by law.  The basic formulation of the use of EDS such - EDS equates to a handwritten signature.  Many do not know, but for the transfer of EDS keys (hereinafter I will use the term - EDS keys. Everyone calls simply EDS, and in fact these are two pairs of keys - for authentication and signature).  For the transfer to third parties even have some responsibility.  It is obvious that many people do not care, do not understand all the seriousness. </p><br><p>  In general, the theme of the post about NCALayer, the layer between the browser and EDS keys.  Security is a vulnerable mechanism for using EDS. </p><a name="habracut"></a><br><h3 id="chto-takoe-ncalayer">  What is NCALayer </h3><br><p>  Since the main implementation of a crypto-provider in Java and in the latest versions of browsers is not possible to use applets, the NUC has come up with an original solution for using EDS in browsers.  This solution is called - NCALayer.  NCALayer - an intermediary between the browser, cryptographic provider and EDS keys. </p><br><p>  NCALayer is installed locally on the user's computer.  NCALayer works as follows - a web server is opened on a specific port where different requests are sent. </p><br><p>  Omitting all the details of the connection, we‚Äôll consider two requests so far to get a general idea of ‚Äã‚Äãhow NCALayer works: </p><br><ol><li>  Select the key on the file system. </li></ol><br><pre><code class="hljs cs">{ <span class="hljs-string"><span class="hljs-string">'method'</span></span>: <span class="hljs-string"><span class="hljs-string">"browseKeyStore"</span></span>, <span class="hljs-string"><span class="hljs-string">'args'</span></span>: [<span class="hljs-string"><span class="hljs-string">'PKCS12'</span></span>, <span class="hljs-string"><span class="hljs-string">'P12'</span></span>, <span class="hljs-string"><span class="hljs-string">'/home/user'</span></span>] }</code> </pre> <br><p>  After sending the request, on the machine where the NCALayer is located, a dialog box opens that offers to select the EDS key file. </p><br><p>  Accordingly, after selecting the key, we get the following answer through the socket. </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"result"</span></span>:<span class="hljs-string"><span class="hljs-string">"/home/user/AUTH_RSA.p12"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"errorCode"</span></span>:<span class="hljs-string"><span class="hljs-string">"NONE"</span></span>} {<span class="hljs-attr"><span class="hljs-attr">"errorCode"</span></span>:<span class="hljs-string"><span class="hljs-string">"NONE"</span></span>}</code> </pre> <br><p>  <strong>Attention: when using NCALayer, you get the real path to the file on the client machine.</strong> </p><br><ol><li>  If you have a path to the keystore, then for future work you must provide a password for this store.  Usually the site somehow takes this password through the form.  Here is an example of how to sign or put an EDS on any data. </li></ol><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"signXml"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"args"</span></span>: [ 'PKCS12', '/home/user/AUTH_RSA.p12', '<span class="hljs-number"><span class="hljs-number">1874</span></span>abcef234', '!!!', '&lt;login&gt;&lt;timeTicket&gt;<span class="hljs-number"><span class="hljs-number">1517997213006</span></span>&lt;/timeTicket&gt;&lt;/login&gt;' ] }</code> </pre> <br><p>  I will not publish the answer, but it contains the signed part of the xml, which was in the request. <br>  Again, get a password from the EDS keystore, falls on the shoulders of the site.  That is, the <strong>site always knows where the user's keys and password are</strong> , otherwise it is impossible to work. </p><br><h3 id="minusy-realizacii-tekuschego-varianta-ncalayer">  Cons of the current version of NCALayer </h3><br><ol><li>  Here is one big minus - the path to the file and password is available to any site developer using EDS.  Even using all sorts of tokens, when using NCALayer, the password from the device-token is also transmitted to the site.  At the very least, the current implementation allows this. </li><li>  Keeping paths to keys and password each site can store in its database.  May not store.  In general, to store or not to store paths and passwords - again, all this lies on the conscience of site developers. </li><li>  Any site can sign data for you without your knowledge in the background if it knows about the path where the keys and password are stored.  Again, if you have ever used a digital signature on a site, then the site already knows the path to the file and password.  If the site is an attacker, then it is guaranteed to save the password somewhere at home. </li><li>  I want to note that direct access to the carrier with the keys is not available.  Access is limited to NCALayer features only. </li></ol><br><h3 id="realnyy-primer-kak-poluchit-dostup-k-egovkz-esli-ty-ne-vladeesh-ecp-cheloveka">  A real example of how to access egov.kz, if you do not own a person‚Äôs EDS </h3><br><p>  I will not go deep into technical details and implementation.  I will describe how to do it. <br>  Now, in order to exploit this vulnerability, it is necessary to understand how the entry mechanism for egov.kz works through EDS.  To login to egov.kz, xml from egov.kz is signed by the user and transmitted to the server, where it is checked.  If the signature is valid, then log in.  From the NCALayer side, the login process consists of the following steps: </p><br><p><img src="https://habrastorage.org/webt/ba/5y/kh/ba5ykhvvvtwcsocrhgq16sfejfa.png"></p><br><p>  The portal requests the following data from NCALayer - loadSlotList (here you can answer with an error), getKeys, getSubjectDN, getNotBefore, getNotAfter, and signXml.  If NCALayer correctly substitutes this data from another user, then accordingly we will successfully log in.  Here it is very important to get only the subjectDN and xml for the signature from NCALayer. <br>  Now how to access egov.kz from another person, the mechanism: </p><br><ol><li>  On your computer, extract the xml string that you need to sign to enter egov.kz.  This is done so, just in the developer console on idp.egov.kz, you need to request the following data - <code>document.getElementById('xmlToSign').value</code> . </li><li>  You send the xml string to the signature of the right person who is sitting on the malicious site.  He is on his computer, in the background, he signs the necessary xml string.  Additionally, you get subjectDN. </li><li>  SubjectDN and signed xml are now available. </li><li>  Now the most interesting thing is that on your computer you emulate the work of NCALayer, which gives the necessary data. </li></ol><br><h3 id="nekotorye-utverzhdeniya">  Some statements </h3><br><ol><li>  The post is not designed for a wide audience, more on techies who understand the principles of web development. </li><li>  Vulnerable ALL resources that use NCALayer. </li><li>  Knowledge of cryptography is not needed. </li><li>  To exploit this vulnerability, you do not need to receive the SDK from the NUC.  Accordingly, the NCA is not able to identify malicious sites. </li><li>  The developers of NCALayer cannot guarantee that attackers will not be able to use such a mechanism.  It will be stupid to answer for everyone.  Technically, there is a possibility. </li><li>  Vulnerable keys are not only on the file system, but also on tokens. </li><li>  You are guaranteed to have lit the password from the digital signature key carrier, even from tokens.  It is enough to log in only once on egov.kz.  How to use the password on the site, it is on the conscience of the developers. </li><li>  As I heard, there are already systems that store the path to EDS keys and password in the settings. </li><li>  There are no vulnerabilities on the sites, just the scheme of using EDS through NCALayer is unsafe. </li></ol><br><p>  Update: </p><br><h3 id="chto-mozhno-sdelat">  What can be done </h3><br><ol><li>  It will be inconvenient - but at every use of keys, to request at least a password. </li><li>  Promote web crypto api </li><li>  ... </li></ol><br><hr><br><p>  <a href="https://github.com/maratkalibek/digisign-layer-emulator">Emulator NCALayer</a> <br>  <a href="https://github.com/maratkalibek/background-signer">An application</a> that, without the knowledge of the user, in the background signs data </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348348/">https://habr.com/ru/post/348348/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348336/index.html">Animations in Android on the shelves (Part 2. Complex animations)</a></li>
<li><a href="../348338/index.html">Implementing a parallel quick sort using ForkJoinPool</a></li>
<li><a href="../348340/index.html">29% of websites are vulnerable to a DOS attack even by one machine (CVE-2018-6389)</a></li>
<li><a href="../348344/index.html">Leakpocalypse: Rust can surprise unpleasantly</a></li>
<li><a href="../348346/index.html">New industry requirements: Certification Centers stop issuing 3-year SSL certificates from March 1, 2018</a></li>
<li><a href="../348350/index.html">Updating strings on the fly in mobile apps: part 2</a></li>
<li><a href="../348352/index.html">How to work with Jira plugin from ScriptRunner or how to avoid code duplication</a></li>
<li><a href="../348354/index.html">How ZFS Stores Data</a></li>
<li><a href="../348356/index.html">Transition from AngularJS to Angular: goals, plans and rules for transferring elements (1/3)</a></li>
<li><a href="../348358/index.html">10 Gigabit Ethernet: Newbie Tips</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>