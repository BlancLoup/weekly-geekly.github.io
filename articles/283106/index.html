<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Swift and compile time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The post is based on the article medium.com/@RobertGummesson/regarding-swift-build-time-optimizations-fc92cdd91e31 + small changes / additions, that i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Swift and compile time</h1><div class="post__text post__text-html js-mediator-article">  <i>The post is based on the article <a href="https://medium.com/%40RobertGummesson/regarding-swift-build-time-optimizations-fc92cdd91e31">medium.com/@RobertGummesson/regarding-swift-build-time-optimizations-fc92cdd91e31</a> + small changes / additions, that is, the text comes from my face, not the third.</i> <br><br>  Everyone is familiar with the situation after changing the file (s) or simply reopening the project: <br><br><img src="https://habrastorage.org/files/f03/59f/0da/f0359f0da7164f68a05f6579d17c0c36.png"><br><img src="https://habrastorage.org/files/8bb/ef2/a26/8bbef2a26f8d4ef1aec58d212ee5d4e4.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/99b/674/332/99b67433262c4a57b0f7a0aa60211ce5.jpeg"><br><br>  It must be said that I did not notice any particular problem with compilation when I wrote on Objective-C, but everything changed with the advent of the swift to the masses.  I was partially responsible for the CI server for building iOS projects.  So, swift projects were going unbearably slow.  Even developers like to drag pods (cocoapods dependencies) on each sneeze into their swift projects, sometimes in insane amounts.  So, the compilation of all this mixture could take several minutes, although the project itself consisted of literally a couple of dozen classes.  Well, as it is clear, the language is new, at the compilation stage much more checks occur than in the ObjC, it‚Äôs foolish to expect it to work faster (yes, swift is a strongly typed language and everything should be explicitly declared as much as possible (as in Java, for example), in contrast to ObjC, where everything is not so strict).  With each release, swift developers promise x times faster compilation speeds.  Well, it seems, indeed, build 2.0, and only then 2.2 it began to work faster, but now the 3.0 version is already on the nose (end of year). <br><br>  The compiler is a compiler, but it turns out that the time to build a project can be drastically increased with just a few lines of code.  Some examples are taken from the above article, some are self-written (I didn‚Äôt believe the author and wanted to check it out myself).  Time measured through <br><br><pre><code class="bash hljs">time swiftc -Onone file.swift</code> </pre> <br><a name="habracut"></a><cut text="   "><br><h2>  A list of things that can slow down your compiler. </h2><br><br><h3>  Careless use of Nil Coalescing Operator </h3><br><br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defIfNil</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">: String?)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">String</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ?? <span class="hljs-string"><span class="hljs-string">"default value"</span></span> }</code> </pre><br><br>  Operator <b>??</b>  expands <i>Optional</i> , if there is something there, then returns a value otherwise the expression is executed after <b>??</b>  .  If we connect several of these operators in succession, we can get an increase in compile time by an order of magnitude (not mistaken, an order of magnitude :)). <br><br><pre> <code class="hljs bash">//     0,09  func fn() -&gt; Int { <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> a: Int? = nil <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> b: Int? = nil <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> c: Int? = nil var res: Int = 999 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> a = a { res += a } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> b = b { res += b } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> c = c { res += c } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> res }</code> </pre><br><br><pre> <code class="hljs pgsql">//   <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">65</span></span>  func fn() -&gt; <span class="hljs-type"><span class="hljs-type">Int</span></span> { let a: <span class="hljs-type"><span class="hljs-type">Int</span></span>? = nil let b: <span class="hljs-type"><span class="hljs-type">Int</span></span>? = nil let c: <span class="hljs-type"><span class="hljs-type">Int</span></span>? = nil <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">999</span></span> + (a ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) + (b ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) + (c ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) }</code> </pre><br><br>  Yes, 40 times :).  But my observations have shown that the problem occurs only if you use more than two such operators in the same expression, that is: <br><br><pre> <code class="hljs lisp">return <span class="hljs-number"><span class="hljs-number">999</span></span> + (<span class="hljs-name"><span class="hljs-name">a</span></span> ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) + (<span class="hljs-name"><span class="hljs-name">b</span></span> ?? <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br>  will already be ok. <br><br><h3>  Array combining </h3><br><br>  I sometimes write scripts in Ruby, chop up a terrific language, where a large number of operations can be put in a couple of lines of code, without losing readability.  Especially like working with arrays.  That is, it is quite a common code for Ruby for me: <br><br><pre> <code class="ruby hljs">res = ar1.filter { ... } + ar2.map { ... } + ar3.flatMap { ... }</code> </pre><br><br>  If in this style we write swift, then it can spoil the compilation time very much, although the language constructs allow writing this way.  Well, as if everyone is now only talking about immobility, therefore creating a mutable array is not comme il faut and generally bad form, pff.  But what do we get if we write like that? <br><br><pre> <code class="hljs pgsql">//  <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>  func fn() -&gt; [<span class="hljs-type"><span class="hljs-type">Int</span></span>] { let ar1 = (<span class="hljs-number"><span class="hljs-number">1.</span></span>.<span class="hljs-number"><span class="hljs-number">.50</span></span>).map { <span class="hljs-meta"><span class="hljs-meta">$0</span></span> }.<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-meta"><span class="hljs-meta">$0</span></span> % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> } let ar2 = [<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>].map { <span class="hljs-meta"><span class="hljs-meta">$0</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> } var ar3 = (<span class="hljs-number"><span class="hljs-number">1.</span></span>.&lt;<span class="hljs-number"><span class="hljs-number">20</span></span>).map { <span class="hljs-meta"><span class="hljs-meta">$0</span></span> } ar3.appendContentsOf(ar1) ar3.appendContentsOf(ar2) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ar3 }</code> </pre><br><br><pre> <code class="hljs pgsql">//  <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">86</span></span>  func fn() -&gt; [<span class="hljs-type"><span class="hljs-type">Int</span></span>] { let ar1 = (<span class="hljs-number"><span class="hljs-number">1.</span></span>.<span class="hljs-number"><span class="hljs-number">.50</span></span>).map { <span class="hljs-meta"><span class="hljs-meta">$0</span></span> } let ar2 = [<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-number"><span class="hljs-number">1.</span></span>.&lt;<span class="hljs-number"><span class="hljs-number">20</span></span>).map { <span class="hljs-meta"><span class="hljs-meta">$0</span></span> } + ar1.<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-meta"><span class="hljs-meta">$0</span></span> % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> } + ar2.map { <span class="hljs-meta"><span class="hljs-meta">$0</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> } }</code> </pre><br><br>  The difference is almost 20 times.  But with arrays we work in every second method.  But It is worth noting that I got this compiler behavior if I summarize more than two arrays in one expression, that is: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ar1.<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-meta"><span class="hljs-meta">$0</span></span> % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> } + ar2.map { <span class="hljs-meta"><span class="hljs-meta">$0</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> }</code> </pre><br>  already ok <br><br><h3>  Ternary operator </h3><br><br>  The author of the original post gives an example, from which it follows that you should not use complex expressions with the ternary operator: <br><br><pre> <code class="hljs pgsql">// Build <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>  let labelNames = <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> ? (<span class="hljs-number"><span class="hljs-number">1.</span></span>.<span class="hljs-number"><span class="hljs-number">.5</span></span>).map{type0ToString(<span class="hljs-meta"><span class="hljs-meta">$0</span></span>)} : (<span class="hljs-number"><span class="hljs-number">0.</span></span>.<span class="hljs-number"><span class="hljs-number">.2</span></span>).map{type1ToString(<span class="hljs-meta"><span class="hljs-meta">$0</span></span>)} // Build <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">017</span></span>  var labelNames: [String] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> { labelNames = (<span class="hljs-number"><span class="hljs-number">1.</span></span>.<span class="hljs-number"><span class="hljs-number">.5</span></span>).map{type0ToString(<span class="hljs-meta"><span class="hljs-meta">$0</span></span>)} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { labelNames = (<span class="hljs-number"><span class="hljs-number">0.</span></span>.<span class="hljs-number"><span class="hljs-number">.2</span></span>).map{type1ToString(<span class="hljs-meta"><span class="hljs-meta">$0</span></span>)} }</code> </pre><br><br><h3>  Excess caste </h3><br><br>  Here the author simply removed the extra castes in <i>CGFloat</i> and gained significant speed in compiling the file: <br><br><pre> <code class="hljs pgsql">// Build <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">43</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CGFloat(M_PI) * (CGFloat((hour + hourDelta + CGFloat(minute + minuteDelta) / <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">5</span></span>) - <span class="hljs-number"><span class="hljs-number">15</span></span>) * unit / <span class="hljs-number"><span class="hljs-number">180</span></span> // Build <span class="hljs-type"><span class="hljs-type">time</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">003</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CGFloat(M_PI) * ((hour + hourDelta + (minute + minuteDelta) / <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">5</span></span> - <span class="hljs-number"><span class="hljs-number">15</span></span>) * unit / <span class="hljs-number"><span class="hljs-number">180</span></span></code> </pre><br><br><h3>  Complex expressions </h3><br><br>  Here the author means, a mixture of local variables, class variables and class instances along with functions: <br><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">// Build time: 1,43  let expansion = a - b - c + round(d * 0.66) + e // Build time: 0,035  let expansion = a - b - c + d * 0.66 + e</span></span></code> </pre><br><br>  True, the author of the original post did not understand why. <br><br><hr><br><br>  In general, we can summarize that using complex features / language constructs is great, but it is worth remembering that all this syntactic sugar can significantly affect both the compile time and runtime itself.  They say, if you write on a rock under the android, then due to all this syntactic sugar, you can very quickly rest against the limit of the number of methods and you will need to resort to extra gestures. <br><br>  ps <br><br>  One of the developers of the swift language gave a small answer to the original author for this post, that in swift 3 many improvements were made in this direction: <br><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-0" style="position: static; visibility: visible; display: block; transform: rotate(0deg); max-width: 100%; width: 500px; min-width: 220px; margin-top: 10px; margin-bottom: 10px;" data-tweet-id="728584734754754560"></twitter-widget><script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script></cut></div><p>Source: <a href="https://habr.com/ru/post/283106/">https://habr.com/ru/post/283106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283092/index.html">When we wrote the 100th API, we understood ...</a></li>
<li><a href="../283096/index.html">Talk about MVC and web application architecture</a></li>
<li><a href="../283100/index.html">The future is here: Will robots push out financial analysts from Wall Street</a></li>
<li><a href="../283102/index.html">Creating a continuous deployment system: the Instagram experience</a></li>
<li><a href="../283104/index.html">Various experiments with the reception and transmission of radio signals in the FPGA</a></li>
<li><a href="../283108/index.html">Playing with keywords in javascript</a></li>
<li><a href="../283112/index.html">We use undocumented site API captionbot.ai</a></li>
<li><a href="../283116/index.html">DNS disorder Vkontakte and other companies</a></li>
<li><a href="../283118/index.html">Victor Gamov on In-Memory Data Grids and Hazelcast on jug.msk.ru</a></li>
<li><a href="../283122/index.html">Slit survey: implementation on bash (ffmpeg + imagemagick)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>