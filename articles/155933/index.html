<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Defragmentation indices with the collection of statistics MS SQL 2008 R2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the first tasks that occurs before a DBA after a new database is deployed is setting up maintenance plans. Often, the task of defragmenting ind...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Defragmentation indices with the collection of statistics MS SQL 2008 R2</h1><div class="post__text post__text-html js-mediator-article">  One of the first tasks that occurs before a DBA after a new database is deployed is setting up maintenance plans.  Often, the task of defragmenting indexes is included in the maintenance plan.  I like it when I know not only that the defragmentation was performed at night from Sunday to Monday, but also how it went, how much was performed, which indices were rebuilt and in what condition they remained after defragmentation. <br><br><a name="habracut"></a>  To collect such statistics, I wrote a small scriptbook, which collects information about the work performed, and also gives the most detailed description <br>  about the state of the indices before and after the procedure. <br><br>  But let's start with a simple, create a table for storing these same data (I created a separate database where I put the tables, which I use when servicing the server databases): <br><table><tbody><tr><th>  Column </th><th>  Type of </th><th>  Comment </th></tr><tr><td>  proc_id </td><td>  int </td><td>  The sequence number of the procedure for identification </td></tr><tr><td>  start_time </td><td>  datetime </td><td>  Starting the ALTER INDEX query </td></tr><tr><td>  end_time </td><td>  datetime </td><td>  Completion of the ALTER INDEX query </td></tr><tr><td>  database_id </td><td>  smallint </td><td>  Database ID </td></tr><tr><td>  object_id </td><td>  Int </td><td>  Table ID </td></tr><tr><td>  table_name </td><td>  varchar (50) </td><td>  Table name </td></tr><tr><td>  index_id </td><td>  Int </td><td>  Index ID </td></tr><tr><td>  index_name </td><td>  varchar (50) </td><td>  Index name </td></tr><tr><td>  avg_frag_percent_before </td><td>  float </td><td>  The percentage of index fragmentation before running ALTER INDEX </td></tr><tr><td>  fragment_count_before </td><td>  bigint </td><td>  The number of fragments before defragmentation </td></tr><tr><td>  pages_count_before </td><td>  bigint </td><td>  Number of index pages before defragmentation </td></tr><tr><td>  fill_factor </td><td>  tinyint </td><td>  Index page fill level </td></tr><tr><td>  partition_num </td><td>  int </td><td>  Section number </td></tr><tr><td>  avg_frag_percent_after </td><td>  float </td><td>  The percentage of index fragmentation after ALTER INDEX </td></tr><tr><td>  fragment_count_after </td><td>  bigint </td><td>  The number of fragments after defragmentation </td></tr><tr><td>  pages_count_after </td><td>  bigint </td><td>  Number of index pages after defragmentation </td></tr><tr><td>  action </td><td>  varchar (10) </td><td>  Action performed </td></tr></tbody></table><br>  The whole defragmentation procedure will take data from this table, which means you need to fill it in: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @currentProcID <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ‚Äì-    ‚Äì-  ,     <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @currentProcID = <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(proc_id), <span class="hljs-number"><span class="hljs-number">0</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dba_tasks.dbo.index_defrag_statistic <span class="hljs-comment"><span class="hljs-comment">--       INSERT INTO dba_tasks.dbo.index_defrag_statistic ( proc_id, database_id, [object_id], table_name, index_id, index_name, avg_frag_percent_before, fragment_count_before, pages_count_before, fill_factor, partition_num) SELECT @currentProcID, dm.database_id, dm.[object_id], tbl.name, dm.index_id, idx.name, dm.avg_fragmentation_in_percent, dm.fragment_count, dm.page_count, idx.fill_factor, dm.partition_number FROM sys.dm_db_index_physical_stats(DB_ID(), null, null, null, null) dm INNER JOIN sys.tables tbl ON dm.object_id = tbl.object_id INNER JOIN sys.indexes idx ON dm.object_id = idx.object_id AND dm.index_id = idx.index_id WHERE page_count &gt; 8 AND avg_fragmentation_in_percent &gt; 10 AND dm.index_id &gt; 0</span></span></code> </pre> <br>  Selection conditions: <br>  <b>page_count&gt; 8</b> - I think that rebuilding indexes with a small number of pages does not make sense, because  it will not get better, and the time spent on the procedure is very valuable, especially if the base is working around the clock and is constantly under high load.  (After the remark <a href="http://habrahabr.ru/users/unfilled/">unfilled</a> raised the bar to 8 pages) <br>  <b>avg_fragmentation_in_percent&gt; 10</b> - Also a very subjective figure, almost all documentation suggests not to touch the index, if its fragmentation is 10 percent or less, with which I agree, if you are different, we change it. <br>  <b>dm.index_id&gt; 0</b> - 0 is a bunch 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After the table is full, we know what indexes need to be served. <br>  Let's do business: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   DECLARE @partitioncount INT --  DECLARE @action VARCHAR(10) --,       DECLARE @start_time DATETIME --   ALTER INDEX DECLARE @end_time DATETIME --   ALTER INDEX --   DECLARE @object_id INT DECLARE @index_id INT DECLARE @tableName VARCHAR(250) DECLARE @indexName VARCHAR(250) DECLARE @defrag FLOAT DECLARE @partition_num INT DECLARE @fill_factor INT -- ,    ,   MAX,      ,      ,    . DECLARE @sql NVARCHAR(MAX) --   DECLARE defragCur CURSOR FOR SELECT [object_id], index_id, table_name, index_name, avg_frag_percent_before, fill_factor, partition_num FROM dba_tasks.dbo.index_defrag_statistic WHERE proc_id = @currentProcID ORDER BY [object_id], index_id DESC --    OPEN defragCur FETCH NEXT FROM defragCur INTO @object_id, @index_id, @tableName, @indexName, @defrag, @fill_factor, @partition_num WHILE @@FETCH_STATUS=0 BEGIN SET @sql = N'ALTER INDEX ' + @indexName + ' ON ' + @tableName SELECT @partitioncount = count (*) FROM sys.partitions WHERE object_id = @object_id AND index_id = @index_id; --  ,       , ,       ,           IF (@fill_factor != 80) BEGIN @sql = @sql + N' REBUILD WITH (FILLFACTOR = 80)' SET @action = 'rebuild80' END ELSE BEGIN --  ,    MS IF (@defrag &gt; 30) --   30%,  REBUILD BEGIN SET @sql = @sql + N' REBUILD' SET @action = 'rebuild' END ELSE --   REORGINIZE BEGIN SET @sql = @sql + N' REORGANIZE' SET @action = 'reorginize' END END --    IF @partitioncount &gt; 1 SET @sql = @sql + N' PARTITION=' + CAST(@partition_num AS nvarchar(5)) print @sql --   --   SET @start_time = GETDATE() EXEC sp_executesql @sql --   SET @end_time = GETDATE() --    UPDATE dba_tasks.dbo.index_defrag_statistic SET start_time = @start_time, end_time = @end_time, [action] = @action WHERE proc_id = @currentProcID AND [object_id] = @object_id AND index_id = @index_id FETCH NEXT FROM defragCur INTO @object_id, @index_id, @tableName, @indexName, @defrag, @fill_factor, @partition_num END CLOSE defragCur DEALLOCATE defragCur</span></span></code> </pre><br><br>  And lastly, we will collect information about the indexes after the defragmentation procedure: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> dba <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> dba.avg_frag_percent_after = dm.avg_fragmentation_in_percent, dba.fragment_count_after = dm.fragment_count, dba.pages_count_after = dm.page_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_db_index_physical_stats(DB_ID(), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>) dm <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dba_tasks.dbo.index_defrag_statistic dba <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dm.[object_id] = dba.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dm.index_id = dba.index_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> dba.proc_id = @currentProcID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dm.index_id &gt; <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br>  After executing such a script, you can get and count a lot of useful information.  For example, the service time of all indices and each separately.  Understand how this is related to the size of the index, see the effectiveness of this operation.  By collecting such information for several times, you can slightly change the procedure, for sure some indexes are fragmented more and faster.  In this case, their maintenance should be performed more often.  How to use the information received, decide for yourself.  As for me, after analyzing each such procedure, I change the service plans, if the situation requires.  My bases work under high load around the clock.  Therefore, I can constantly rebuild all indexes and for 1-2 hours I cannot reduce server performance.  If your database also works around the clock, <a href="http://msdn.microsoft.com/ru-ru/library/bb933866.aspx">Resource Governor</a> should be configured to perform such things. <br><br>  I also want to note that there are detailed scripts in the internet, but be careful, many of them use outdated commands. <br><br>  In more detail about system views used by me it is possible to read in msdn: <br><br>  <a href="http://msdn.microsoft.com/ru-ru/library/ms190283(v%3Dsql.105).aspx">sys.sysindexes</a> <br>  <a href="http://msdn.microsoft.com/ru-ru/library/ms187406(v%3Dsql.105).aspx">sys.tables</a> <br>  <a href="http://msdn.microsoft.com/ru-ru/library/ms188917(v%3Dsql.105).aspx">sys.dm_db_index_physical_stats</a> <br></div><p>Source: <a href="https://habr.com/ru/post/155933/">https://habr.com/ru/post/155933/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155921/index.html">Complete Guide: Tools and Methods for Data Migration to Windows Azure SQL Database</a></li>
<li><a href="../155923/index.html">Programs as works of art‚ÄΩ</a></li>
<li><a href="../155925/index.html">How peaceful reverse engineering helped slightly improve the Yandex.Money application</a></li>
<li><a href="../155927/index.html">Working with static pages in Yii</a></li>
<li><a href="../155929/index.html">VPN for iPhone</a></li>
<li><a href="../155935/index.html">Do you need a button for sites (like) that will remind the user about the event (thereby returning the audience and increasing the conversion)?</a></li>
<li><a href="../155937/index.html">Your flashlight can send SMS: one more reason to upgrade your device to iOS 6</a></li>
<li><a href="../155941/index.html">2GIS - Hotel Expert</a></li>
<li><a href="../155943/index.html">SHORT'Y - the release of short news from October 24</a></li>
<li><a href="../155945/index.html">IDCEE 2012 - the second day</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>