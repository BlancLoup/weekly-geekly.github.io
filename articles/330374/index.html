<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with peripherals from JavaScript: from theory to practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The work of a bank employee is dangerous and difficult. In the Unified Frontal System, we try to help the bank employee and automate his work. One of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with peripherals from JavaScript: from theory to practice</h1><div class="post__text post__text-html js-mediator-article">  The work of a bank employee is dangerous and difficult.  In the Unified Frontal System, we try to help the bank employee and automate his work.  One of the many tasks that we need to solve is to refine the thin client in order to be able to work with peripheral banking equipment.  But this is not so easy to do.  In this article, we will describe how we tried to solve the problem, and what it led to. <br><br>  The article will be useful to architects and experienced front-end developers of systems of scale enterprises, faced with the problem of access to peripheral equipment from a thin client of their system. <br><br> <a href="https://habrahabr.ru/company/efs/blog/330374/"><img src="https://habrastorage.org/web/cd5/b59/f00/cd5b59f0039d46eba3419c36753c76a8.jpg"></a> <br><a name="habracut"></a><br>  And yes, let's say at once, the task is complicated by the fact that the standard approaches using ActiveX, Java Applet, browser plug-in do not suit us for reasons of security, universality and complexity with controllability and maintainability. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Imagine a modest (by Chinese standards) bank, which has more than 100 thousand operators in its branches.  They have workplaces where they serve customers, and various peripheral devices are connected to the workplaces: <br><br><ol><li>  Network / local printer. <br></li><li>  Receipt printer (Epson-M950 or Olivetti). <br></li><li>  POS terminal (Verifone VX820). <br></li><li>  A device for reading "tablets" (touch memory with EDS). <br></li><li>  Scanners of different types (for barcodes, passports or just documents). <br></li><li>  Webcam (take pictures of potential borrowers). <br></li><li>  Specific banking equipment - cash dispenser / receiver, etc. <br></li></ol><br>  An impressive list, isn't it?  And with all this you need to interact from the react-application running in the browser. <br><br>  Work with devices at a low level is carried out through the hardware manufacturers or the native internal development library.  Installation and updating of drivers and other software at workplaces are carried out centrally.  Workplaces are Windows and Internet Explorer 11 or 8. The possibility of switching to Linux and Chrome / Firefox is discussed.  Hence the requirement of cross-platform and cross-browser. <br><br>  The problem of heterogeneity of devices and their failures is more or less solved, but monitoring of the operation of devices is required, including the ability to take logs from the workplace.  Centralized management of peripheral settings is also required. <br><br>  Security requirements are to control the integrity of the code running on the client, limiting access to the periphery (access should be only from the local workplace) and a number of specific requirements for working with touch memory. <br><br>  A separate question is the work of the tablet with the periphery.  The idea is to replace computers with mobile devices, transferring to them all the functionality of the operator, including banking operations.  In this article, we will not talk in detail about the tablets, we will definitely tell about this in another article, we‚Äôll simply indicate that here there are issues of connecting the tablet to the internal banking network via wi-fi, and issues of working with devices connected directly to the tablet , for example, mPOS-terminals. <br><br><h2>  How we tried to tame it all, why it didn‚Äôt happen right away </h2><br>  From the conditions of operation should work with peripherals: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a85/6b9/3a7/a856b93a7e8b2e73b975ac7f2d078e39.png">  We tried to find a solution to the problem and worked out several options. <br><br><h3>  HTML5 </h3><br>  Although it potentially has work with peripheral devices, current implementations are sharpened for mobile devices or audio / video, and are not suitable for our tasks from the word "absolutely." <br><br><h3>  Webusb </h3><br>  <a href="https://wicg.github.io/webusb/">https://wicg.github.io/webusb/</a> - firstly, not all devices are connected via USB.  Secondly, WebUSB support is currently not available anywhere except for the <a href="https://www.chromestatus.com/feature/5651917954875392">experimental feature</a> in Chrome.  So, too, does not suit us. <br><br><h3>  ActiveX </h3><br>  The method is old-fashioned and proven - wrappers are made over drivers, installed as local OCX or DLL, accessed through ActiveXObject: <br><br><pre><code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> printer = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"LocalPrinterComponent.Printer"</span></span>); printer.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(data + <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>);</code> </pre> <br>  But it only works in IE and Windows.  Despite attempts to make ActiveX technology portable, Microsoft <a href="http://www.computerworld.com/article/2920892/web-browsers/microsoft-nixes-activex-add-on-technology-in-new-edge-browser.html">abandoned</a> ActiveX development in favor of plugin technology. <br><br><h3>  Browser Plugins </h3><br>  It also does not suit us, is not targeted, binds to the browser and limits the versatility. <br><br><h3>  Java native components </h3><br>  A service is placed on localhost, which is accessible from JavaScript.  From this, too, decided to refuse, because  implementation is more time consuming, you need to use a web server or write your own. <br><br><h3>  Applet </h3><br>  Not targeted, there are problems with permissions on the local device. <br><br><h2>  And what to do? </h2><br>  As a result, we stopped at the following peripheral architecture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d5a/370/209/d5a37020952e40d59f8336f3b1d0f160.png"><br><br>  The client application in JavaScript accesses the local service through the module working with the peripheral API, which is the binding on the client part of <a href="https://socket.io/">socket.io</a> . <br><br>  The jobs are set <a href="https://nodejs.org/en/">node.js</a> , which runs under the service account at the start of the OS.  In node.js, our bootstrap module works, which is responsible for loading npm modules for working with peripheral devices from the server to the local file system.  The client code generates an event, the code and the version of the module that works with the device, the method being called and its parameters are passed as attributes: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Test hello.socket.io<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"socket.io.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> socket = io.connect(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'http://localhost:8055'</span></span></span><span class="javascript">); socket.on(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'eSACExec'</span></span></span><span class="javascript">, </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">data</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> newLi = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.createElement(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'li'</span></span></span><span class="javascript">); newLi.style.color = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"green"</span></span></span><span class="javascript">; newLi.innerHTML = data.data + </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">' from '</span></span></span><span class="javascript"> + data.from; </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"list"</span></span></span><span class="javascript">).appendChild(newLi); </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(data.data); }); socket.on(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'eSACOnError'</span></span></span><span class="javascript">, </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">data</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> newLi = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.createElement(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'li'</span></span></span><span class="javascript">); newLi.style.color = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"red"</span></span></span><span class="javascript">; newLi.innerHTML = data.message; </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"list"</span></span></span><span class="javascript">).appendChild(newLi); </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(data.error); }); </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">sendHello</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ socket.emit(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'eSASExec'</span></span></span><span class="javascript">, {</span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">module</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'api.system.win.window'</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">version</span></span></span><span class="javascript">:</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'0.0.1'</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">repoURL</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'git+https://github.com/Gromatchikov/'</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">method</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'sayHello'</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">params</span></span></span><span class="javascript">: {</span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">hello</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'Server API'</span></span></span><span class="javascript">}}); } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ol</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"list"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ol</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sendHello()"</span></span></span><span class="hljs-tag">&gt;</span></span>send<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Also bootstrap is responsible for working with platform services (downloading logs from the workplace at the request of the administrator, etc.) <br><br>  For each peripheral device there is a module for working with it, which is executed in node.js.  Bootstrap proxies the call to the module method: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sio = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bootstrapSA = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./bootstrap.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SAServer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">instanceof</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SAServer</span></span></span><span class="hljs-function">)) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SAServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">app</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">http</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">createServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sioApp</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sio</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">listen</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">.app</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sioApp</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sockets</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">on</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'connection'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (client</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">client</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">on</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'eSASExec'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (data</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">try</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">console</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">info</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'SAserver event eSASExec:'</span></span></span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">console</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">info</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bootstrapSA</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">demandModuleProperty</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">modules, data.repoURL, data.</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, data.version, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">module</span></span></span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fullModuleName</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bootstrapSA</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getFullName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data.</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, data.version</span></span></span><span class="hljs-function">) </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">api</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">modules</span></span></span><span class="hljs-function">[</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fullModuleName</span></span></span><span class="hljs-function">]; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">api != </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">undefined</span></span></span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">var</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">api</span></span></span><span class="hljs-function">[</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method</span></span></span><span class="hljs-function">](</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data.params</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">console</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">info</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Result eSASExec'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, result</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">client</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'eSACExec'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, {data: result || </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">: fullModuleName}</span></span></span><span class="hljs-function">); } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">else</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">console</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'['</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Error '</span></span></span></span><span class="hljs-function"><span class="hljs-params">, fullModuleName, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'] is '</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">undefined</span></span></span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">client</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'eSACOnError'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, { message: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Error define api module'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> + fullModuleName}</span></span></span><span class="hljs-function">); } }); } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">catch</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_error</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">console</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'['</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Error eSASExec'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, ( _error.code ? _error.code : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span></span><span class="hljs-function">), ']', </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_error</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">client</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'eSACOnError'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, { message: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Error :('</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error: _error.stack || </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">}</span></span></span><span class="hljs-function">); } }); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">client</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">on</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'disconnect'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, (</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'User disconnected'</span></span>); }); client.on(<span class="hljs-string"><span class="hljs-string">'eSASStop'</span></span>, () =&gt; { process.exit(<span class="hljs-number"><span class="hljs-number">0</span></span>); }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info(<span class="hljs-string"><span class="hljs-string">'User connected'</span></span>); }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info(<span class="hljs-string"><span class="hljs-string">'System API server loaded'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">//  SAServer.prototype.start = function startSAServer(port) { //   this.currentPort = port; if (this.currentPort == undefined) { this.currentPort = process.env.npm_package_config_port; } this.app.listen(this.currentPort); console.log('System API server running at http://127.0.0.1:'+ this.currentPort); bootstrapSA.inspect('parent object', modules); }; module.exports = SAServer;</span></span></code> </pre><br>  The module works with the low-level API of the operating system or driver via the npm node.js "ffi" module: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    JavaScript (UTF-8)  UTF-16 function TEXT(text){ return new Buffer(text, 'ucs2').toString('binary'); } var FFI = require('ffi'); //   user32.dll var user32 = new FFI.Library('user32', { 'MessageBoxW': [ 'int32', [ 'int32', 'string', 'string', 'int32' ] ] }); function WindowSA() { if (!(this instanceof WindowSA)) { return new WindowSA(); } console.log('Window system API module loaded'); } WindowSA.prototype.sayHello = function sayHello(params) { //   var OK_or_Cancel = user32.MessageBoxW(0, TEXT(', "' + params.hello + '"!'), TEXT(' '), 1); }; module.exports = WindowSA;</span></span></code> </pre><br>  When the client application accesses bootstrap, passing the module and version, bootstrap checks the local storage.  If the required module is not in the local storage, it is pumped from the server.  Thus, only drivers and node.js with bootstrap are installed centrally, and npm modules for working with devices are downloaded in runtime.  But this function is unlikely to be used in the industrial configuration, so we assume that when remotely installing device drivers on employees' workplaces, the corresponding npm peripheral API module will be installed, which is a JS bundle. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loadModule = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj, repoURL, name, version, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mod; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//todo mod = require(fullModuleName);    major.minor   fix console.log('System API module "%s" require...', getFullName(name, version)); mod = new require(name)(); return mod; } catch (err){ errFlag = true; console.error('Error require', err.code, err); if (err.code == 'MODULE_NOT_FOUND') { installModule(obj, repoURL, name, version, callback); } } } //   ,      //todo       name@version (fullModuleName) var demandModuleProperty = function (obj, repoURL, name, version, callback) { var fullModuleName = getFullName(name, version); var errFlag = false; if (!obj.hasOwnProperty(fullModuleName)) { console.log('System API module "%s" defining', fullModuleName); var mod = loadModule(obj, repoURL, name, version, callback); if (mod == undefined){ return; } Object.defineProperty(obj, fullModuleName, { configurable: true, enumerable: true, get: function () { Object.defineProperty(obj, fullModuleName, { configurable: false, enumerable: true, value: mod }); console.log('System API module "%s" defined', fullModuleName); inspect('parent object', obj); inspect(fullModuleName, obj[fullModuleName]); } }); } if (!errFlag) { console.log('Callback for "%s"', fullModuleName); callback(obj[fullModuleName]); } }; //    //todo       name@version,   major.minor   fix var installModule = function(obj, repoURL, name, version, callback){ console.log('Installing module %s version %s', name, version); var fullURL = getFullURL(repoURL, name, version); npm.load({progress: true, '--save-optional': true, '--force': true, '--ignore-scripts': true},function(err) { // handle errors // install module npm.commands.install([fullURL], function(er, data) { // log errors or data if (!er){ console.info('System API module "%s" installed', name); //    demandModuleProperty(obj, repoURL, name, version, callback); } else { console.error('Error NPM Install', er.code, er); } }); npm.on('log', function(message) { // log installation progress console.log('NPM logs:' + message); }); }); };</span></span></code> </pre> <br>  The solution has not yet been implemented, we are working on it and will definitely tell you about the results in another article.  In the meantime, we want to ask you what you think about the chosen approach?  What pitfalls await us?  We invite everyone to take part in the discussion in the comments. </div><p>Source: <a href="https://habr.com/ru/post/330374/">https://habr.com/ru/post/330374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330364/index.html">On the road with clouds. Relational databases in a new technological context</a></li>
<li><a href="../330366/index.html">We are building the development process and the CI pipeline, or How can a developer become DevOps for QA</a></li>
<li><a href="../330368/index.html">‚ÄúBreak the vote on RHS ++‚Äù. Give us 1,000,000 RPS</a></li>
<li><a href="../330370/index.html">What is exclusive blockchains?</a></li>
<li><a href="../330372/index.html">Implementing Lean tools in the Service Desk command</a></li>
<li><a href="../330376/index.html">Smart Integration Plugs</a></li>
<li><a href="../330382/index.html">Huginn: a simple integration platform</a></li>
<li><a href="../330384/index.html">A few words about "our" microcontroller</a></li>
<li><a href="../330386/index.html">MySQL 8, Postgres NoSQL, Tarantool Vinyl, CockroachDB, ClickHouse, and yet, why did Uber leave Postgresql?</a></li>
<li><a href="../330394/index.html">Notepad ++: code verification five years later</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>