<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Add-on to Avito. Startup or architecture example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 To be honest, I have never bought used items on bulletin boards before. But when another economic crisis happened and the need made, I ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Add-on to Avito. Startup or architecture example</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/dcf/f2e/c8c/dcff2ec8c0494a65bb304539d963f495.png"><br><br><h1>  Prehistory </h1><br>  To be honest, I have never bought used items on bulletin boards before.  But when another economic crisis happened and the need made, I had to turn my attention to Avito. <br><br>  When looking at the offers, it immediately caught my eye that some of the ads look dubious for a number of signs: a low price, an inaccurate description, etc., according to which it seemed that they were selling something other than what they were selling, or they did not know what they were selling.  An image from the past, a flea market of the 90s, from which it was possible to return with both purchases and empty pockets or a cut bag, immediately appeared in my memory. <br><a name="habracut"></a><br>  As you know, Avito does not provide information about other ads of the seller, so the ad text often uses keywords or hashtags that the buyer can use to search.  But it should be noted that the Avito administration does not welcome the presence in the ad text of any information that is not relevant to the sale item, as stated in the placement rules.  If the placement rules are violated, Avito can block both the ad and the merchant account. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The search engine gave me a few sites, parasitizing on Avito and other bulletin boards, mainly related to used cars.  Most of them offer to search ads by phone number of the seller in the database of pre-downloaded ads.  All of them have shortcomings that are not important for me: an intricate interface, a paid service, an update with a certain lag. <br><br>  Sharing Steven Levy‚Äôs opinion on free access to information, it was decided to analyze Avito to develop its own sravnito.ru service with blackjack and all the tasks, namely, with a simple interface and free access. <br><br>  Based on the analysis, the main attributes of the ad were identified: <br><br><ul><li>  title </li><li>  publication date </li><li>  price </li><li>  location </li><li>  phone number (either a number image, or a hash from it, or a recognized OCR value) </li></ul><br><h1>  Architecture </h1><br>  Now directly about the architecture of the software package, on which the search service of all the ads of the seller is based: <br><br><img src="https://habrastorage.org/files/e39/734/f4c/e39734f4cb204564ace29b8af175dacb.png"><br><br><h2>  Storage </h2><br>  MySQL (Maria DB) with the InnoDB engine is used as storage for storing ads and their screenshots. <br><br>  DB1 stores ads with basic attributes.  To reduce the amount of memory occupied by the data, the VARCHAR type is used for text fields, as their length varies from ad to ad.  About half a million lines are added every day, among which are the ads themselves, as well as logs and service information.  With this dynamic, the storage can rightfully be attributed to Big Data.  Of the features of the settings, you can select the following parameters: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">max_heap_table_size</span></span> = <span class="hljs-number"><span class="hljs-number">512M</span></span> innodb_buffer_pool_size = <span class="hljs-number"><span class="hljs-number">3G</span></span></code> </pre> <br>  The tables in the heap are used to optimize queries from several large tables when first the data is selected in a temporary table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> _temp_table <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> = i_key <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> i_limit);</code> </pre><br>  which then connects with another: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> _temp_table <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> table.field = _temp_table.field;</code> </pre><br>  The DB2 screenshots of the ads are stored as they appear to the browser user.  Before recording, the screenshots are compressed in JPEG with quality = 5, which provides an image file size of approximately 20Kb.  It is believed that with a BLOB size of no more than 200Kb, the storage performance of files in MySQL is not inferior to NoSQL-storage, which allows you to remain in the comfort zone of a relational database with all its advantages.  Such a compressed screenshot, despite the minimal image quality, allows the user to make sure that the specified ad actually existed, and to see at least a schematic image of the product. <br><br>  All logic is implemented in stored procedures to encapsulate code-dependent code in the DBMS itself.  Thus, DBMS clients have authority only to access stored procedures that are idempotent.  As an additional plus, we get the lack of the ability to implement SQL injections. <br><br><h2>  Storage API </h2><br>  The M1 server is implemented as a golang microservice and provides a RESTful API for saving announcements, screenshots, and also for reading data displayed on the advertisement search service page.  There is no reason to use any frameworks or external libraries to implement RESTful on golang, so only standard libraries are used, except for one: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"database/sql"</span></span> <span class="hljs-string"><span class="hljs-string">"encoding/json"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> _ <span class="hljs-string"><span class="hljs-string">"github.com/go-sql-driver/mysql"</span></span> )</code> </pre><br>  GET and POST requests from clients are processed and the corresponding stored procedures of DB1, DB2 are called. <br><br><h2>  Ad loaders </h2><br>  Ads are downloaded from the Avito website by the S (1) -S (N) downloaders, written in Java using the Selenium WebDriver library.  After receiving the ad attributes and a screenshot from Avito, the loader contacts the M1 server for data transfer.  Also, feedback is implemented to control the bootloaders, who periodically poll the server M1 for commands, such as ‚Äústop‚Äù, ‚Äústart‚Äù. <br><br><h2>  Captcha </h2><br>  To solve the captcha that Avito sometimes requests, there is a C1 server, similar to the M1 server implemented in golang and providing a RESTful API.  Solving captcha is carried out in two ways: <br><br><ul><li>  using the service rucaptcha.com </li><li>  manually in the application for Android </li></ul><br>  To communicate with rucaptcha.com, their API is used.  For manual guessing, an Android application written in Java is used, which displays the image and accepts the answer.  The C1 server decides whether to redirect captcha to rucaptcha.com or to the Android application, depending on the number of requests that have accumulated in the queue.  Having received a captcha solution, the C1 server sends the response to the loader that has requested it. <br><br><h2>  Monitoring </h2><br>  Similar to the Android application for solving a captcha, there is an application for monitoring.  The Android application for monitoring accesses the server M1, which in turn refers to the database where the logs are aggregated, on the basis of which one can judge the number of downloaded ads, malfunctions, etc. <br><br><h2>  Conclusion </h2><br>  Further development of the service may be as follows: <br><br><ul><li>  Creation of loaders for other bulletin boards, which will allow you to cross-search all the ads of one seller </li><li>  Using the complex to process other data, for example, downloading from social networks to search for all posts by account name </li></ul><br>  In this and in another case, only loaders that are easily integrated with servers M1 and C1 are subject to development.  Refinement of other parts of the system is not required. <br><br>  If you make the API of servers M1, C1 public with authorization and add a key field to the database structure for dividing by clients, you can provide a service for storing data and processing captcha as SaaS.  Client data can be stored in the BLOB in the form of JSON, while finalizing the database with stored procedures and the API. <br><br>  What can be said about the selected technologies: <br><br><ul><li>  MySQL - a classic of the genre, no comment </li><li>  Java - loaders can run on coffee makers and refrigerators </li><li>  golang - microservices are developed very quickly, easily deployed by copying a single binary to the server </li></ul><br>  I would appreciate comments and discussion. </div><p>Source: <a href="https://habr.com/ru/post/317598/">https://habr.com/ru/post/317598/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317578/index.html">Modularization in JavaSE without OSGI and Jigsaw</a></li>
<li><a href="../317580/index.html">Android and the ‚ÄúInternet of Things‚Äù are closer to each other</a></li>
<li><a href="../317584/index.html">How IT professionals work. Konstantin Osipov, developer and founder of the Tarantool project</a></li>
<li><a href="../317588/index.html">The Tale of Lost Time</a></li>
<li><a href="../317596/index.html">Mitap TechTalks from EXANTE and HSE</a></li>
<li><a href="../317602/index.html">Many to many link and upsert in Ecto 2.1</a></li>
<li><a href="../317610/index.html">Test task as a means of collecting ideas</a></li>
<li><a href="../317612/index.html">Exporting tabular data from applications written under .NET in C #</a></li>
<li><a href="../317618/index.html">These companies are luring digital professionals from all the rest.</a></li>
<li><a href="../317620/index.html">DotNext - Moscow 2016. How it was</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>