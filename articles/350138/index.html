<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to whale eat java application and not choke</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear habravchane! Today I would like to tell you how to feed a Java application to a docker, how to do it better, and what not to do. I have be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to whale eat java application and not choke</h1><div class="post__text post__text-html js-mediator-article">  Hello, dear habravchane!  Today I would like to tell you how to feed a Java application to a docker, how to do it better, and what not to do.  I have been working on Java for over 10 years, and spent the last three years in close contact with Docker, so I have a certain idea that it can and cannot.  But hypotheses need to be tested in practice, aren‚Äôt they? <br><br>  I presented the whole process as a good old computer game with a warm tube pixel art. <br><br>  We begin, as befits any game, with a briefing.  As an introduction, take a little docker advertising. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On the <a href="https://www.docker.com/what-docker">docker's</a> website, you can familiarize yourself with a number of advertising promises - namely, with the promise to increase the speed of development and deployment as much as <i><b>13</b></i> times and increase portability in development (in particular, get rid of the sacramental ‚Äúworks on my machine‚Äù).  But does this correspond to reality? <br><br>  Now we will try to prove / disprove these statements. <br><a name="habracut"></a><br><h2>  Level 1 </h2><br>  Since we are in the game, we will begin, as it should be, from the simplest level. <br><br>  What is our mission on the first level?  Probably, for many, this is something very trivial and understandable: we must ‚Äúwrap‚Äù the most primitive Java application in Docker. <br><br><img src="https://habrastorage.org/webt/_x/ao/0k/_xao0koddjuoacueu4lzaefsusi.jpeg"><br><br>  To do this, we need a simple Java class that displays the sacramental <i>Hello JavaMeetup!</i>  Also, in order to create a docker image, we need a <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> .  Syntax is extremely simple - use <b>java: 8</b> as the base image, add our Java class ( <b>ADD</b> command), compile it (using the <b>RUN</b> command) and specify the command that will run when the container is started ( <b>CMD</b> command). <br><br>  <b>HelloWorld.java</b> <b><br></b> <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloWorld</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>); } }</code> </pre> <br>  <b>Dockerfile</b> <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> java:<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> HelloWorld.java . RUN javac HelloWorld.java CMD ["java", "HelloWorld"]</code> </pre> <br>  <b>Docker commands:</b> <br><br><pre> <code class="bash hljs">$ docker build -t java-app:demo . $ docker images $ docker run java-app:demo</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cd/hc/y7/cdhcy7kehjw5v5jqq2ny5cdq3qe.jpeg"></div><br>  In order to build this whole business, we need, in fact, one team - this is <b>docker build</b> .  When building, we specify the name of our image and the tag that we assign to it (this way we will be able to version various assemblies of our application).  Next, make sure that we have compiled the image by running the <b>docker images command</b> .  In order to run our application, <b>run the docker run command</b> . <br><br>  Hooray, everything went fine, and we are great ... Or not? <br><br><img src="https://habrastorage.org/webt/zh/av/ti/zhavti4nethgwliap0fgykpsa9s.jpeg"><br><br>  Yes, we have completed the mission.  But we have to score points for anything.  For what, you ask, and how to avoid such blunders next time? <br><br><ul><li>  The basic image of the docker that we used is declared deprecated and is not supported by <a href="https://hub.docker.com/_/java/">the docker community</a> .  Even at <a href="https://www.youtube.com/watch%3Fv%3DyHLAaA4gPxw">DockerCon17,</a> many of the Java EE world friends Arun Gupta recommended using openjdk as a base image (which is also hinted at by the description and update dates of the images <a href="https://hub.docker.com/_/openjdk/">https://hub.docker.com/_/openjdk/</a> ). </li><li>  To reduce the size, it is better to use images based on Alpine - images based on this distribution are the most lightweight. </li><li>  We compile using the jdk image, run it using jre (save disk space, we still need it). </li></ul><br>  Now, we can assume that the first level has been completed successfully.  We rise to the second. <br><br>  <i><a href="https://www.tutorialkart.com/docker/docker-Java-application-example/">Useful link for passing the first level</a></i> <br><br><h2>  Level 2 </h2><br><img src="https://habrastorage.org/webt/bu/fx/od/bufxodoweeqlybgrpb6zbqcvv_s.jpeg"><br><br>  When dealing with Java, we will most likely use Maven or Gradle.  Therefore, it would be convenient to somehow integrate our build systems with Docker in order to have a unified environment for building the project and docker images. <br><br>  Fortunately for us, most plugins are already written ‚Äî for both Maven and Gradle. <br><br><img src="https://habrastorage.org/webt/0f/fy/co/0ffyco83v_94rxkw7qdnrs7iulm.jpeg"><br><br>  The most popular Maven plugins for Docker <a href="https://github.com/fabric8io/docker-maven-plugin">fabric8io</a> and <a href="https://github.com/spotify/docker-maven-plugin">spotify</a> .  For Gradle, we can use the plugin Benjamin Mushko - one of the developers of Gradle and the author of the book "Gradle in Action". <br><br>  To connect the docker to the application's build system, in the gradle configuration it is enough to create several tasks that will collect and run our containers, as well as indicate some general information from the discharge ‚Äî which image to use as the baseline and what name to give to the assembled image. <br><br>  Let's not be verbose: take the <a href="https://github.com/bmuschko/gradle-docker-plugin">bmuschko / gradle-docker-plugin</a> and Gradle <a href="https://github.com/bmuschko/gradle-docker-plugin">plugin</a> (Maven fans and XML fans, wait a bit!). <br><br>  Perform our first task, but now with the help of this plugin.  The main parts of build.gradle that we need: <br><br><pre> <code class="hljs scala">docker { javaApplication { baseImage = <span class="hljs-symbol"><span class="hljs-symbol">'openjdk</span></span>:latest' tag = <span class="hljs-symbol"><span class="hljs-symbol">'java</span></span>-app:gradle' } } task createContainer(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">DockerCreateContainer</span></span>) { dependsOn dockerBuildImage targetImageId { dockerBuildImage.getImageId() } } task startContainer(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">DockerStartContainer</span></span>) { dependsOn createContainer targetContainerId { createContainer.getContainerId() } }</code> </pre> <br>  We start the <b>gradle startContainer command</b> and see the build of our image and even the launch of the container.  But instead of the desired message ‚ÄúHello JavaMeetup!‚Äù We receive a notification of a successful build! <br><br><img src="https://habrastorage.org/webt/k8/as/vj/k8asvjctijxdt_ow2rq1ccowjrs.jpeg"><br><br>  Did we make a mistake somewhere?  Not really, just need to redirect the output of our container to the console: <br><br><pre> <code class="hljs scala">task logContainer(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">DockerLogsContainer</span></span>, dependsOn: startContainer) { targetContainerId { startContainer.getContainerId() } follow = <span class="hljs-literal"><span class="hljs-literal">true</span></span> tailAll = <span class="hljs-literal"><span class="hljs-literal">true</span></span> onNext { message -&gt; logger.quiet message.toString() } }</code> </pre> <br>  Run the command <b>gradle logContainer</b> and ... Hurray, the cherished message and the level passed. <br><br><img src="https://habrastorage.org/webt/o7/5g/ud/o75gudnq6gv1sosyvepcypryswo.jpeg"><br><br>  Here, strictly speaking, that's all.  We don‚Äôt even need a Dockerfile (but it won‚Äôt be superfluous - you never know, Gradle will not be at hand). <br><br>  Moving on! <br><br><h2>  Level 3 </h2><br><img src="https://habrastorage.org/webt/1v/ln/if/1vlnifiqi_1t_i5n-e0tkpmfv2i.jpeg"><br><br>  Most likely, in real life, our application will do something more cunning than displaying the Hello World screen.  Therefore, at the next level, we will learn how to run a complex application - the Spring web application, which will bring us some records from the database. <br><br>  In order to raise the base and the application itself, we will use the <a href="https://docs.docker.com/compose/overview/">Docker Compose</a> .  To begin with, we will create a new file (the next new configuration file, will you breathe, but won't it stop us?) - <b>docker-compose.yml</b> .  In it, we simply prescribe services to raise the image of the base and the image of the application.  Docker Compose will find the yml-file in the current directory and pick up or collect the containers and images we need. <br><br><img src="https://habrastorage.org/webt/z4/io/uf/z4ioufytl9o-v13tujnyo_1lmga.jpeg"><br><br>  In order for the whole business to start, we will pre-assemble the image.  In <a href="https://github.com/alexff91/java-meetup-2018/tree/master/lvl3">this example</a> , the maven plug-in for Docker (hooray, XML!) From fabric8io is used - so, first, run the <b>mvn install</b> command: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>io.fabric8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>docker-maven-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>0.20.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">images</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">image</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>app<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dockerFileDir</span></span></span><span class="hljs-tag">&gt;</span></span>${project.basedir}/src/main/docker<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dockerFileDir</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">assembly</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mode</span></span></span><span class="hljs-tag">&gt;</span></span>dir<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mode</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">targetDir</span></span></span><span class="hljs-tag">&gt;</span></span>/app<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">targetDir</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">descriptor</span></span></span><span class="hljs-tag">&gt;</span></span>${project.basedir}/src/main/docker/assembly.xml<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">descriptor</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">assembly</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">image</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">images</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>build<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phase</span></span></span><span class="hljs-tag">&gt;</span></span>install<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">phase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span>build<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goal</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">goals</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">execution</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">executions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/k5/ua/wl/k5uawl1xpanc6r64gh6b3fl3wag.jpeg"></div><br>  Let's wait until our project and image of the docker get together, move to the directory with the yml file and run the command <b>docker-compose up -d</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qv/jb/wb/qvjbwbhrkpvsf9d9cihl9kc3r4e.jpeg"></div><br>  Verify that both our containers are started by running the <b>docker ps command</b> . <br><br>  In order to make sure that our web application works and gets something from the database, we can directly change something in the database, then go to <a href="http://localhost:8080/">http: // localhost: 8080 /</a> and see the desired data. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vk/pi/51/vkpi51qysdax4ntkez49cbibaek.jpeg"></div><br>  All this may seem complicated, but in reality it is extremely simple.  The third level is passed.  Almost. <br><br>  We still have a bonus level.  On it, we will play a little (quite a bit) in Docker Swarm - or to be exact, in <a href="https://habrahabr.ru/company/redmadrobot/blog/318866/">Docker Swarm Mode</a> . <br><br><h2>  Bonus Level </h2><br><img src="https://habrastorage.org/webt/5h/ti/28/5hti28bp5co4nf6anh6fenpizda.jpeg"><br><br>  Docker Swarm Mode is not particularly complicated - it is just a cluster of machines on which Docker stands.  For a user, this cluster looks like one machine, and all commands work almost as if the Docker Swarm did not exist. <br><br>  In swarm mode, you can run multiple instances of our application - for load balancing, for example.  Also here appears such an abstraction as a stack: with the help of Docker Swarm, we can deploy a whole bunch of applications as a whole.  And, like normal scaling, we can deploy multiple <a href="https://docs.docker.com/engine/swarm/stack-deploy/">stack</a> replicas. <br><br>  Docker commands in swarm mode: <br><br><pre> <code class="bash hljs">$ docker service create --name japp --publish 8080:80 --replicas 3 java-app:demo $ docker stack deploy -c docker-compose.yml javahelloworld</code> </pre> <br>  In essence, the command syntax is extremely simple and resembles the creation of ordinary containers. <br>  We can also use docker compose: <br><br><pre> <code class="bash hljs">$ docker-compose scale jm-app=3</code> </pre> <br>  Well, for the last three levels, we seem to have achieved the portability of java applications.  It is time to go to the last level and try to confirm or deny the statement that Docker makes the phrase ‚Äúworks on my machine‚Äù no longer relevant. <br><br><h2>  Final level </h2><br><img src="https://habrastorage.org/webt/ha/x9/ak/hax9aka1jxhfvzcqxljqqvc9ohi.jpeg"><br><br>  Imagine that we have a heavy application.  Or a large number of microservices that can be on the same machine.  In this case, the Java application (to be exact, the JVM) will surely grapple with our little blue whale in the fight for the resources of the host machine.  By the way, this is well described in <a href="https://habrahabr.ru/company/ruvds/blog/324756/">this article</a> . <br><br><img src="https://habrastorage.org/webt/so/k7/yg/sok7ygpf4-f-bcrmiilorjqwcji.jpeg"><br><br>  At this level, there will be the least number of code examples, but there will be different configurations of launching the docker container.  The main tools for isolating processes and resources used by Docker are <a href="https://en.wikipedia.org/wiki/Cgroups">cgroups</a> and <a href="https://en.wikipedia.org/wiki/Linux_namespaces">namespaces</a> .  But the main problem lies in the fact that Java is all on the drum a little.  We have a voracious and a bit greedy, sees that resources are actually more, even if we set memory limits when creating a container with a java-application using the - memory flag.  This can be seen simply by running the free command inside the container.  From here follows a rather general recommendation for Java 8 to set the ‚ÄìXmx parameter, and the ‚Äìmemory parameter to be at least twice as large as ‚ÄìXmx.  Good news from the Java 9 fields - they added cgroups support. <br><br><img src="https://habrastorage.org/webt/b0/j4/7w/b0j47w4ln8sccg5g1o_ei8ut3y8.jpeg"><br><br>  It is quite simple to simulate a memory leak in Java.  We‚Äôll just take the <b>valentinomiazzo / jvm-memory-test</b> image that‚Äôs already completed and run it with different heap size options and - memory for the docker. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pd/9o/vz/pd9ovzaq5nvyohee-emhfwnmbg4.jpeg"></div><br>  In the first case, the container has been given out less than the java application, and we get a vague error.  And I would like to get OutOfMemoryException.  If you inspect the "dead" container, you can see that it was killed by <a href="https://linux-mm.org/OOM_Killer">OOMKiller</a> , and this can lead to unpredictable consequences, java-process hang, incorrect closing of resources and all other offensive things (I have even met kernel-panic).  Not the most pleasant thing that can happen. <br><br>  Raise the stakes, give more memory to the container.  This time, we can catch the OutOfMemoryException and, after inspecting, make sure that our container did not touch OOMKiller, and we are spared from all the above mentioned troubles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ee/kd/fd/eekdfd_yt9ab-yzjqar7rvq6cd4.jpeg"></div><br>  The last level is passed, let's try to summarize. <br><br><h2>  Resume </h2><br>  So, what did we get as a result, having passed all the levels of our game?  What about Docker promises to move us mountains? <br><br>  Portability is not as good as we would like, but Java 9 seems to promise to solve these problems.  With increasing flexibility, everything is more pleasant: with the docker, we get a reproducible environment configuration in the code, and not far from the main code.  It‚Äôs easier to keep track of such things, rather than who, what and when you corrected, replaced or spoiled something under the root.  On the whole, it is possible to achieve a good reduction in resources due to the possibility of running multiple containers on one machine ‚Äî this can be critical when testing. <br><br>  That is, I would say that the docker is ideal for testing and / or development.  But when working in production you need to be careful, because the load in this case can be much higher.  And getting a docker‚Äôs fault is really quite unpleasant. <br><br>  And finally - the very flags that are needed in order to make Java 9 friends with the docker! <br><br><img src="https://habrastorage.org/webt/e6/1u/wn/e61uwnfbhujmlj4iogx7r5ihvms.jpeg"><br><br><h2>  Game over </h2><br>  <i>Useful links for passing the last level:</i> <br><br>  <a href="https://hackernoon.com/crafting-perfect-Java-docker-build-flow-740f71638d63">https://hackernoon.com/crafting-perfect-Java-docker-build-flow-740f71638d63</a> <br>  <a href="https://jaxenter.com/nobody-puts-Java-container-139373.html">https://jaxenter.com/nobody-puts-Java-container-139373.html</a> <br>  <a href="https://github.com/valentinomiazzo/docker-jvm-memory-test">https://github.com/valentinomiazzo/docker-jvm-memory-test</a> <br><br>  <b>PS</b> All the examples mentioned above can be found here: <br>  <a href="https://github.com/alexff91/Java-meetup-2018">github.com/alexff91/Java-meetup-2018</a> </div><p>Source: <a href="https://habr.com/ru/post/350138/">https://habr.com/ru/post/350138/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350128/index.html">Instruction: what to do if you do not have time to deadline</a></li>
<li><a href="../350130/index.html">Open Data Day in Moscow 2018</a></li>
<li><a href="../350132/index.html">GObject: Inheritance and Interfaces</a></li>
<li><a href="../350134/index.html">DoctrineSolrBundle - Search by Solct-based Doctrine entity on Symfony2 / 3</a></li>
<li><a href="../350136/index.html">Random evolutionary strategies in machine learning</a></li>
<li><a href="../350140/index.html">Asynchronous work with PostgreSQL in C</a></li>
<li><a href="../350142/index.html">Development of an external battery on four LiFePO4 batteries</a></li>
<li><a href="../350144/index.html">Richard Hamming: Chapter 29. You get what you measure</a></li>
<li><a href="../350148/index.html">Flask Mega-Tutorial, Part XIII: I18n and L10n (Edition 2018)</a></li>
<li><a href="../350152/index.html">We are testing the array of OceanStor Dorado V3: so ordinary that right at all</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>