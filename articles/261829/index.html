<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cackle Reviews full text search feedback system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Not so long ago, we implemented a full-text search for the Cackle Reviews review system . It turned out great, now any moderator in a few milli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cackle Reviews full text search feedback system</h1><div class="post__text post__text-html js-mediator-article">  <b>Hello!</b>  Not so long ago, we implemented a full-text search for the <a href="http://cackle.ru/reviews">Cackle Reviews</a> review <a href="http://cackle.ru/reviews">system</a> .  It turned out great, now any moderator in a few milliseconds can find his comments of interest on a word or sentence with support for stemming (fuzzy search by part of a word or its word forms).  All this works on Sphinx - full-text search system. <br><br>  There are many articles on Sphinx on the Internet, but, unfortunately, some of them are outdated, some others do not claim to be complete and accurate how to.  So in this post we tried to outline all the steps - installation, configuration, indexing and support for the delta index. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/73a/f7b/afe/73af7bafe5d9a24e5bfd77d30d260ffa.png" alt="feedback system Cackle Reviews with full text search"></div><br><a name="habracut"></a><br><h2>  <font color="#144269">1. Install Sphinx</font> </h2><br>  As already mentioned, <a href="https://ru.wikipedia.org/wiki/Sphinx_(%25D0%25BF%25D0%25BE%25D0%25B8%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25BC%25D0%25B0%25D1%2588%25D0%25B8%25D0%25BD%25D0%25B0)">Sphinx</a> is a full-text search system.  The choice on Sphinx was not accidental, the fact is that this system is the fastest based on some <a href="http://lib.custis.ru/%25D0%25A1%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BD%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B4%25D0%25B2%25D0%25B8%25D0%25B6%25D0%25BA%25D0%25BE%25D0%25B2_%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25BE%25D1%2582%25D0%25B5%25D0%25BA%25D1%2581%25D1%2582%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B3%25D0%25BE_%25D0%25BF%25D0%25BE%25D0%25B8%25D1%2581%25D0%25BA%25D0%25B0">tests comparing the speed and capabilities of the</a> engines of such systems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Installation documentation is not so good.  So, to interact with Sphinx, we need a MySQL client (for working with the Sphinx API) and Sphinx itself.  Below is the command to install all the necessary libraries for Linux (the example uses Linux Debian 8 64bit). <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    MySQL  apt-get     /etc/apt/sources.list deb http://repo.mysql.com/apt/debian/ wheezy mysql-5.6 deb-src http://repo.mysql.com/apt/debian/ wheezy mysql-5.6 #   MySQL apt-get install mysql-client unixodbc libpq5 libmysqlclient18 #    Sphinx (    2.2.9) wget http://sphinxsearch.com/files/sphinxsearch_2.2.9-release-1~wheezy_amd64.deb #  dpkg -i sphinxsearch_2.2.9-release-1~wheezy_amd64.deb</span></span></code> </pre> <br><br><h2>  <font color="#144269">2. Configure Sphinx</font> </h2><br>  If the installation was normal, then the sphinxsearch daemon should appear in Linux, which you can stop for now ( <code>/etc/init.d/sphinxsearch stop</code> ).  Next you need to create a directory structure for storing indexes, in our case there will be two - the main and delta index.  The main stores all data, delta only for today to speed up indexing. <br><br><pre> <code class="bash hljs">mkdir /opt/sphinx mkdir /opt/sphinx/data <span class="hljs-comment"><span class="hljs-comment">#   mkdir /opt/sphinx/data/review #   mkdir /opt/sphinx/data/review_delta #  mkdir /opt/sphinx/log/</span></span></code> </pre><br>  Edit the Sphinx configuration (default /etc/sphinxsearch/sphinx.conf).  It is necessary to clarify that all reviews are stored in the review table and the fields are indexed: <br><br><ul><li>  id - revocation identifier; </li><li>  site_id - ID of the site where the review is located; </li><li>  status - revocation status (Approved, Moderated, Spam, Deleted); </li><li>  pros - virtues; </li><li>  cons - flaws; </li><li>  comment - a comment. </li></ul><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,    ( PostgreSQL) source base { type = pgsql sql_host = 162.198.0.3 sql_user = postgres_login sql_pass = postgres_password sql_db = cackle sql_port = 5179 } #    index base { #  charset_type = utf-8 #        morphology = stem_enru #     2  min_word_len = 2 } #  review     source review : base { #     search_fulltext #      id   review ( id  search_fulltext    ) sql_query_pre = DELETE FROM search_fulltext WHERE type = 'review' sql_query_pre = INSERT INTO search_fulltext SELECT 'review', MAX(id) FROM review #   id, site_id, status, pros, cons, comment   review sql_query = SELECT id, site_id, status, pros, cons, comment FROM review #      sql_attr_uint = site_id #      (,  , , ) sql_attr_uint = status } #  review         review #    /opt/sphinx/data/review index review : base { source = review path = /opt/sphinx/data/review } #     review source review_delta : review { #    ,   sql_query_pre     review #    -   SQL (SELECT 1) sql_query_pre = SELECT 1 #       ,   id,    id   search_fulltext sql_query = SELECT id, site_id, status, pros, cons, comment FROM review WHERE id &gt; (SELECT id FROM search_fulltext WHERE type = 'review') } #   index review_delta : review { source = review_delta path = /opt/sphinx/data/review_delta } #   searchd #    mysql (mysql_version_string = 5.5.21)        searchd { listen = localhost:9306:mysql41 mysql_version_string = 5.5.21 log = /opt/sphinx/log/searchd.log query_log = /opt/sphinx/log/query.log pid_file = /opt/sphinx/log/searchd.pid }</span></span></code> </pre><br><br><h2>  <font color="#144269">3. Launch</font> </h2><br>  Everything is ready, you can start the searchd daemon (/etc/init.d/sphinxsearch start) and start indexing review (main index): <br> <code>indexer --config /etc/sphinxsearch/sphinx.conf review</code> <br> <br><div style="text-align:center;"> <a href="http://cackle.ru/reviews"><img src="https://habrastorage.org/getpro/habr/post_images/57f/a75/ef1/57fa75ef1f3893d2f3fb97ecc85960f5.png" alt="full text search reviews Cackle Reviews"></a> </div><br>  So, all 730422 reviews were indexed in 84 seconds.  Now you can connect to Sphinx via MySQL (mysql: // localhost: 9306) and try searching through SQL commands: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">#  id      1   '',   id,   0  15 SELECT id FROM review WHERE site_id = 1 AND MATCH('') ORDER BY id DESC LIMIT 0,15 #  id      1, 2, 738, 35302   1 (), 3 () SELECT id FROM review WHERE site in (1, 2, 738, 35302) AND status in (1, 3) AND MATCH(' ') ORDER BY id DESC LIMIT 0, 15</span></span></code> </pre><br>  Within a few milliseconds, we get id reviews, which can then be sampled from the main database from the review table and returned to the client. <br><br><h2>  <font color="#144269">4. Configure the delta index</font> </h2><br>  As already mentioned, the delta index is needed for quick indexing of small data size.  In our case, this is all new reviews accumulated for the current day.  For this setting we create 2 Jobs in the crown: <br><br><pre> <code class="sql hljs">crontab -e <span class="hljs-comment"><span class="hljs-comment">#  5    review_delta (  id    id   search_fulltext) */5 * * * * indexer --rotate --quiet --config /etc/sphinxsearch/sphinx.conf review_delta #    (  )   review_update.sh 0 1 * * * /opt/sphinx/review_update.sh</span></span></code> </pre><br>  The review_update.sh script starts the review_delta indexing, updates the maximum id in the search_fulltext table and shows the result of the review and review_delta indexes. <br><br><pre> <code class="sql hljs">PGPASSWORD=postgres_password; export PGPASSWORD; indexer <span class="hljs-comment"><span class="hljs-comment">--rotate --quiet --config /etc/sphinxsearch/sphinx.conf review_delta; psql --host 162.198.0.3 --port 5179 --username "postgres_login" -c "UPDATE search_fulltext SET id = (SELECT MAX(id) FROM review) WHERE type = 'review'" "cackle"; indexer --merge review review_delta --rotate --quiet --config /etc/sphinxsearch/sphinx.conf;</span></span></code> </pre><br>  After that, you can add the review_delta table to the SQL search queries and then the sample will be from 2 indices at once - the main and delta. <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">#  id      1   '',   id,   0  15 SELECT id FROM review, review_delta WHERE site_id = 1 AND MATCH('') ORDER BY id DESC LIMIT 0,15 #  id      1, 2, 738, 35302   1 (), 3 () SELECT id FROM review, review_delta WHERE site in (1, 2, 738, 35302) AND status in (1, 3) AND MATCH(' ') ORDER BY id DESC LIMIT 0, 15</span></span></code> </pre><br>  This implementation took only a day of work, with the result we created a stable full-text search, which has been working for several months without a single failure.  By the way, adding a similar configuration and the job (review is replaced with comment) for the commenting system <a href="http://cackle.ru/comments">Cackle Comments</a> , the search for comments was implemented. <br><br>  Questions are welcome.  Thanks for attention.  Successes to all! </div><p>Source: <a href="https://habr.com/ru/post/261829/">https://habr.com/ru/post/261829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261813/index.html">Ford recalls almost 500 thousand cars because of a bug in software</a></li>
<li><a href="../261817/index.html">Creating a Worker from another domain</a></li>
<li><a href="../261819/index.html">Unpleasant aspects of working with Images.xcassets: size and memory</a></li>
<li><a href="../261823/index.html">STM32, C ++ and FreeRTOS. Development from scratch. Part 2</a></li>
<li><a href="../261827/index.html">DIY Robot Vacuum Cleaner</a></li>
<li><a href="../261831/index.html">How to mount an image fsa</a></li>
<li><a href="../261833/index.html">The digest of interesting materials for the mobile # 110 developer (June 29-July 5)</a></li>
<li><a href="../261835/index.html">Polymorphic bonds for the smallest</a></li>
<li><a href="../261837/index.html">STM32, C ++ and FreeRTOS. Development from scratch. Part 3 (LCD and Screens)</a></li>
<li><a href="../261847/index.html">Adaptive carousel on AngularJS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>