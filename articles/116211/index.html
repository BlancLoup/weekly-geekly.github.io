<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Load Testing: Node.JS vs phpDaemon</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When working on one of the projects, we were faced with the task of implementing correspondence between registered users. At its core - it should be a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Load Testing: Node.JS vs phpDaemon</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/05/2d/052d212eaad4b8cb4bcca1bf100839f9.jpg" align="left">  When working on one of the projects, we were faced with the task of implementing correspondence between registered users.  At its core - it should be a chat, but at the same time you can communicate with it only with one person. <br><br>  The potential load that such a chat should handle is about 10,000 simultaneous keep-alive connections.  Each new message should be recorded in the main database, as well as in the "fast", the task of which is to keep only the actual part of correspondence between users, that is, to serve as a kind of "temporary" repository from which messages will be immediately delivered to the addressee. <br><a name="habracut"></a><br>  <b>MongoDB</b> is well suited for this task.  Since the replication process is well established in it, we can periodically poll the local.oplog. $ Main table with a separate daemon for the presence of new messages in it, and, if any, immediately deliver them to the address in JSON format.  For steady work under load, there will be several such demons, several thousand copyists will be connected to each of them. <br><br>  And here we faced the choice of what to use as a ‚Äúfast server‚Äù on which the demons will be placed?  For this, we tested two solutions: based on <b>phpDaemon</b> and based on <b>Node.JS.</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, for starters, the complete chat architecture: <br><br><img src="https://habrastorage.org/storage/habraeffect/30/92/30925509d5bf6d5c94868019f1d99ccc.jpg" alt="Full chat structure"><br>  <i>Fig.</i>  <i>1. Full chat structure</i> <br><ol><li>  Each new client entering into correspondence establishes a connection with one of the ‚Äúfast‚Äù servers ( <b>phpDaemon</b> or <b>Node.js</b> ) and will receive messages from it. </li><li>  When sending a new message to the main server, it is recorded in a permanent database ( <b>MySQL</b> ), as well as in a kind of ‚Äúfast‚Äù database (in this case <b>MongoDB</b> ), where only current correspondence will be stored, for example, in the last 24 hours. </li><li>  Master MongoDB writes changes to the <b>local.oplog. $ Main</b> collection for replication. </li><li>  The ‚Äúfast servers‚Äù at this time are polling the ‚Äúfast‚Äù database for new messages in it, and, if they exist, send them to the client to whom they are addressed. </li></ol><br>  In our test version there will be no permanent database, as well as user authorization.  There will be only one ‚Äúfast server‚Äù that will pick up new messages from the collection and send to all active clients at the moment (Figure 2). <br><br><img src="https://habrastorage.org/storage/habraeffect/10/98/109894c70df2a5b1510d7483829dc673.jpg" alt="Simplified chat structure"><br>  <i>Fig.</i>  <i>2. Simplified chat structure</i> <br><br>  The composition of the teams playing today: <br><br>  <b><i>Node.js command</i></b> <br><ol><li>  Node.js ( <a href="http://nodejs.org/">http://nodejs.org</a> ) </li><li>  The Socket.IO library for establishing connections between the client and Node.js ( <a href="http://socket.io/">http://socket.io</a> ) </li><li>  The christkv Node-mongo-native library for working with MongoDB from Node.js ( <a href="https://github.com/christkv/node-mongodb-native">https://github.com/christkv/node-mongodb-native</a> ) </li><li>  Well, the oplog.js file from the same library for polling MongoDB for new messages ( <a href="">https://github.com/christkv/node-mongodb-native/blob/master/examples/oplog.js</a> ) </li></ol><br>  <b><i>PhpDaemon command</i></b> <br><ol><li>  phpDaemon ( <a href="http://phpdaemon.net/">http://phpdaemon.net</a> ) </li><li>  PhpDaemon scripts to establish a connection between the client and the server ( <a href="https://github.com/kakserpom/phpdaemon/tree/master/clientside-connectors/websocket">https://github.com/kakserpom/phpdaemon/tree/master/clientside-connectors/websocket</a> ) </li><li>  To work with MongoDB we will also use the built-in features of phpDaemon </li><li>  To poll the database, we will use the MongoNode application that we modified a little ( <a href="https://github.com/kakserpom/phpdaemon/blob/master/app-servers/MongoNode.php">https://github.com/kakserpom/phpdaemon/blob/master/app-servers/MongoNode.php</a> ), which does not write changes to Memcache, but sends them to all connected users. </li></ol><br>  <b>Apache Benchmark</b> meeting judge. <br><br>  So, we launch one of the demons that polling MongoDB is running, and also ‚Äúcommunicates‚Äù with incoming customers.  Using the Apache Benchmark utility from another machine, we connect several <b>keep-alive</b> clients (testing time is 20 seconds).  At this time, a third-party form is starting to write messages to MongoDB.  For each daemon and each number of keep-alive connections, we do <b>5 iterations</b> , then we average the data and see the result. <br><br><table cellspacing="1" cellpadding="5"><tbody><tr><th>  Demon <br></th><th>  Complete requests <br></th><th>  Requests per second <br></th><th>  Time per request, ms <br>  (across all concurrent requests) <br></th><th>  Min <br>  request, ms <br></th><th>  Max Request, ms <br></th></tr><tr><th colspan="6">  <b><i><font color="#3d75ba">10 keep-alive connections</font></i></b> <br></th></tr><tr><td>  <b>phpDaemon</b> <br></td><td>  1147 <br></td><td>  54.36 <br></td><td>  18.440 <br></td><td>  21 <br></td><td>  <font color="#e2040a">7116</font> <br></td></tr><tr><td>  <b>Node.JS</b> <br></td><td>  <font color="#e2040a">1285</font> <br></td><td>  <font color="#e2040a">64</font> <br></td><td>  <font color="#e2040a">15.618</font> <br></td><td>  <font color="#e2040a">sixteen</font> <br></td><td>  9064 <br></td></tr><tr><th colspan="6">  <b><i><font color="#3d75ba">100 keep-alive connections</font></i></b> <br></th></tr><tr><td>  <b>phpDaemon</b> <br></td><td>  <font color="#e2040a">1543</font> <br></td><td>  <font color="#e2040a">75.15</font> <br></td><td>  <font color="#e2040a">13.313</font> <br></td><td>  22 <br></td><td>  <font color="#e2040a">12889</font> <br></td></tr><tr><td>  <b>Node.JS</b> <br></td><td>  1284 <br></td><td>  64.12 <br></td><td>  15.765 <br></td><td>  <font color="#e2040a">17</font> <br></td><td>  13347 <br></td></tr><tr><th colspan="6">  <b><i><font color="#3d75ba">500 keep-alive connections</font></i></b> <br></th></tr><tr><td>  <b>phpDaemon</b> <br></td><td>  <font color="#e2040a">1365</font> <br></td><td>  <font color="#e2040a">67.73</font> <br></td><td>  <font color="#e2040a">14.824</font> <br></td><td>  <font color="#e2040a">15</font> <br></td><td>  <font color="#e2040a">15174</font> <br></td></tr><tr><td>  <b>Node.JS</b> <br></td><td>  1236 <br></td><td>  61.71 <br></td><td>  16.611 <br></td><td>  23 <br></td><td>  16078 <br></td></tr><tr><th colspan="6">  <b><i><font color="#3d75ba">1000 keep-alive connections</font></i></b> <br></th></tr><tr><td>  <b>phpDaemon</b> <br></td><td>  1159 <br></td><td>  56.99 <br></td><td>  17.680 <br></td><td>  nineteen <br></td><td>  <font color="#e2040a">13103</font> <br></td></tr><tr><td>  <b>Node.JS</b> <br></td><td>  <font color="#e2040a">1528</font> <br></td><td>  <font color="#e2040a">75.02</font> <br></td><td>  <font color="#e2040a">13.354</font> <br></td><td>  <font color="#e2040a">17</font> <br></td><td>  16785 <br></td></tr></tbody></table><br>  <font color="#e2040a">Red</font> marks ‚Äúbest performance‚Äù <br><br>  As we can see, on a small number of simultaneous connections (10), Node.JS based chat works better.  A larger number of requests are processed, respectively, the time for processing one request is reduced.  True, phpDaemon has a shorter duration of the longest request, which, however, is not very important. <br><br>  With an increase in the number of compounds to 100, and then 500, the picture changed.  PhpDaemon has already come forward in terms of performance. <br><br>  And with 1000 keep-alive connections, phpDaemona's indicators dropped, and Node.JS, on the contrary, increased, which resulted in a rather strong gap. </div><p>Source: <a href="https://habr.com/ru/post/116211/">https://habr.com/ru/post/116211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116204/index.html">Sony Ericsson is preparing an update for the Android Xperia X10</a></li>
<li><a href="../116205/index.html">Where ATM - search for ATMs in Ukraine now on the iPhone</a></li>
<li><a href="../116207/index.html">Canobuvosti, 84th edition</a></li>
<li><a href="../116209/index.html">Toshiba showed the first samples of the new Satellite R800 series at the presentation of the latest generation of processors Intel Core</a></li>
<li><a href="../116210/index.html">IPad 2 Video Review (Part 3 and 4)</a></li>
<li><a href="../116212/index.html">Second shift</a></li>
<li><a href="../116214/index.html">SSH tunnel home without having to leave the home PC on</a></li>
<li><a href="../116216/index.html">March update for Windows Phone 7</a></li>
<li><a href="../116217/index.html">How to choose VPS hosting</a></li>
<li><a href="../116218/index.html">Yahoo! presented an analogue of Google instant</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>