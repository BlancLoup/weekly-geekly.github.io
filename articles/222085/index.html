<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Turning a conventional electric convector into a wireless</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 My private house is heated with electric convectors. Everything is good in them: both ease of installation and automatic temperature cont...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Turning a conventional electric convector into a wireless</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  My private house is heated with electric convectors.  Everything is good in them: both ease of installation and automatic temperature control and day / night mode and 50% power mode.  But there is also a minus - the air temperature sensor is fixed directly on the body of the convector, therefore it heats up and cools with it.  Because of this, the convector is turned on / off much more often than desired, it is impossible to set the desired air temperature in the room, since  the real one will be lower by 5 degrees, and the reliability of the permanent switching of the relay has a negative effect.  It was possible, of course, to lengthen the temperature sensor and take it away, but this is not our method.  Since  I have been doing wireless technology for a long time and I have some experience, I decided to equip the convector with a wireless temperature sensor.  This will place it anywhere in the room, do not pull the wires, and if necessary, use not one but several sensors and calculate the average room temperature.  (Pictures under the cut) <br><a name="habracut"></a><br><h4>  Rework </h4><br>  As I have already said, I am deeply involved in wireless and have on this subject developments.  ZigBee is the best solution for monitoring various sensors, and for a long time I have been using Jennic's JN5148 (purchased by NXP) as a ZigBee microcontroller.  For the rapid production of layouts, I made myself several modules with this microcontroller. <br><img src="https://habrastorage.org/getpro/habr/post_images/9fd/407/d48/9fd407d4878c417a9d92085a53a47228.png"><br><br>  Module scheme (clickable): <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/6ed/440/498/6ed4404984160222ef2f7819415f59e9.png" alt="image"></a> <br>  The microcontroller itself is included in the module circuit, an external program memory for it (a mandatory component for JN5148), quartz, power supply capacitors, an RF part with an antenna.  For a quick start, you only need a programming connector and power supply 3.3 V. Shawls are ordered from seeedstudio, cheaply and angrily.  In order to quickly something pile perfectly fit. <br>  The temperature sensor was also made in advance and was waiting in the wings. <br><img src="https://habrastorage.org/getpro/habr/post_images/f3d/6b4/8c1/f3d6b48c1763db47519526154c5c11b4.png"><br><br>  Sensor circuit (clickable): <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b2b/712/85b/b2b71285bb511640d056843fac754c37.png"></a> <br>  A TMP102 chip from Texas Instruments was used as a temperature meter.  The microcircuit is quite inexpensive, measures temperature with an accuracy of 0.5 degrees in the range of -25 .. + 85, has a current consumption of 10 ŒºA in active mode and 1 ŒºA in the sleeper, is very compact, and also works in the range of supply voltages from 1.4 to 3.6 V, which important when powered by a single lithium battery.  Otherwise, the sensor circuit differs from the module circuit in the presence of a battery, a divider for measuring its voltage, a power switch and a programming connector. <br>  To finish with the iron and go to the actual alteration, run forward and say that at first I just wanted to measure the temperature, transfer it to the convector and somehow slip it to the microcontroller instead of its native sensor.  Subsequently, the idea to set the temperature threshold as remotely, from a PC.  For this, I used a USB whistle with the same JN5148. <br><img src="https://habrastorage.org/getpro/habr/post_images/2e6/f16/863/2e6f16863aff8c763588a374b9b1dcc3.png"><br>  Scheme (also clickable): <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/76c/cc0/9b7/76ccc09b798f1d4a3f35d34fc62e6d28.png"></a> <br>  The whistle circuit includes the circuit of the module discussed above and the USB-UART converter on the FT232R microcircuit, which is also a programmer for the microcontroller. <br>  We now turn to reverse engineering.  A 1000 W Ballu convector with an electronic control system was used as the test subject.  Having examined the convector, I found 2 boards: power and control board. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Power Board: <br><img src="https://habrastorage.org/getpro/habr/post_images/208/3ac/a11/2083aca1150941a09157fce5a8de668a.jpg"><br><br>  Management fee: <br><img src="https://habrastorage.org/getpro/habr/post_images/316/d45/275/316d45275afa05f2f32c57f1a98adf99.png"><br><br>  On the power board there is a network power supply, voltage regulator + 5V for L7805, 2 relays, which include either a 500W (50%) load or 1000W (100%) and a buzzer.  Separately located thermal fuse and air ionizer.  A microcontroller, buttons and a seven-segment temperature indicator are located on the control board. <br>  Inspection showed that a semiconductor diode is used to measure the temperature, which, as is well known, has a fairly linear dependence of the direct voltage drop on temperature.  The diode is connected to the upper arm of the supply voltage divider, and the voltage from the divider is fed to the input of the microcontroller's ADC. <br><img src="https://habrastorage.org/getpro/habr/post_images/a64/f04/8bc/a64f048bcd5dd09b9f8020ce15dcc369.png"><br>  Based on this measurement scheme, the easiest way to emulate a temperature sensor is to apply a voltage from the DAC to the ADC of the convector, which is on board the JN5148.  Since  the supply voltage (and at the same time the reference ADC) of the controller in the convector is 5 V, and the reference voltage at the DAC is 2.4; it is necessary to increase the voltage from the DAC using an opamp approximately 2 times.  Based on this, we draw a scheme of the temperature sensor emulator (clickable). <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d54/702/084/d54702084e238f20a87ad336d772d6b4.png"></a> <br><br>  In addition to the module, it includes an opamp amplifier, a 5 V - 3.3 V converter for powering the JN5148 and a programming connector.  Next, we make the board: iron, grass, drill, pound, solder. <br><img src="https://habrastorage.org/getpro/habr/post_images/ba3/8e1/92e/ba38e192e4d5cc58c4b52d859f67a83d.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/95f/2ca/afa/95f2caafa7af5605979ebdc541bf8029.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/b56/2c4/43e/b562c443e40152190bfc59ff323ca246.png"><br><br>  We install the board into place and start coding.  By the way, the fact that the control board is disconnected from the power board turned out to be very convenient.  It is enough to submit +5 V to it and it can work completely autonomously, so I installed it in the convector after the system was fully debugged. <br><br><h4>  Programming </h4><br>  Experimentally, I removed the dependence of the temperature measured by the convector on the voltage at the input of the ADC. <br><img src="https://habrastorage.org/getpro/habr/post_images/e94/6e0/e37/e946e0e377d3a7112541f4f35d631747.png"><br>  It can be seen that in the middle of the range the difference between the real and ideal characteristics is about 1 degree, so I decided to write the corresponding DAC codes to the array and depending on the temperature, take the necessary code from the array and send the DAC. <br><br>  As a basis for programming, I used a Jennic template - JN-AN-1123-ZBPro-Application-Template, which can be downloaded <a href="http://www.jennic.com/support/support_files/jn-an-1123_zbpro_application_template">here</a> .  It implements all the basic functionality of the ZigBee network, which works on the basis of the operating system JenOS, developed by Jennic for its microcontrollers.  To whom it is interesting, they can download the template and see, but I will give here only the most important code. <br>  This system presents all types of ZigBee network devices: a coordinator (convector), a router (USB whistle) and a sleeping terminal (sensor).  Let's start with the simplest - with a USB whistle.  He is committed to scanning UART for the appearance of a byte from the computer and sends the received byte to the coordinator. <br>  The scan function is an operating system task that runs once every 50 ms.  It checks whether the command has come and issues all incoming commands to the message queue, which is processed by the main task. <br><pre><code class="cpp hljs">OS_TASK(APP_CommandScan) { APP_tsEvent sCommandEvent; int16 word; <span class="hljs-comment"><span class="hljs-comment">//    word=i16Serial_RxChar(E_AHI_UART_0); //  if(word != -1) { //      sCommandEvent.eType = APP_E_EVENT_COMMAND; sCommandEvent.sCommand.u8Value = (uint8)word; OS_ePostMessage(APP_CommandEvent, &amp;sCommandEvent); } //   OS_eContinueSWTimer(APP_tmrCommandScan, APP_TIME_MS(50), NULL); }</span></span></code> </pre> <br>  In the main loop, all incoming commands are sent to the coordinator. <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//        if (APP_E_EVENT_COMMAND == sAppEvent.eType) { //  APDU PRIVATE PDUM_thAPduInstance s_hAPduInst = PDUM_INVALID_HANDLE; // APDU    s_hAPduInst = PDUM_hAPduAllocateAPduInstance(apduCommand); //  APDU    PDUM_u16APduInstanceWriteNBO(s_hAPduInst, 0, //    "b", // ,    (b) sAppEvent.sCommand.u8Value); //  APDU  1  PDUM_eAPduInstanceSetPayloadSize(s_hAPduInst, 1); // ,   ,      u8Status = ZPS_eAplAfUnicastDataReq(s_hAPduInst, MYPROFILE_MYCLUSTER_CLUSTER_ID, USBSTICK_MYENDPOINT_ENDPOINT, THERMOSTAT_MYENDPOINT_ENDPOINT, 0x0000, //  (   ) ZPS_E_APL_AF_UNSECURE, 0, &amp;u8SeqNum); }</span></span></code> </pre><br>  The temperature sensor wakes up once per second (the time, of course, is adjusted), measures the temperature and voltage of the battery, sends everything to the convector, and then falls asleep again. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">PRIVATE </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vSendSensorData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ uint8 u8Status; uint8 u8SeqNum; <span class="hljs-comment"><span class="hljs-comment">//     SensorData NewSensorData; //     NewSensorData.TempValue = TempMeasurement(); NewSensorData.BattValue = BatVoltageMeasurment(); //       //   ,      uint32 MacH, MacL; MacH = MacAddr.u32H; MacL = MacAddr.u32L; //  APDU PRIVATE PDUM_thAPduInstance s_hAPduInst = PDUM_INVALID_HANDLE; // APDU    s_hAPduInst = PDUM_hAPduAllocateAPduInstance(apduTemperature); //  APDU    PDUM_u16APduInstanceWriteNBO( s_hAPduInst, 0, //    "wwbh", //  (    //   32-  (ww) // 8- (b)   16- (h) MacH, MacL, NewSensorData.TempValue, NewSensorData.BattValue); //      11  PDUM_eAPduInstanceSetPayloadSize(s_hAPduInst, 11); //           u8Status = ZPS_eAplAfBroadcastDataReq(s_hAPduInst, MYPROFILE_TEMPERATURE_CLUSTER_ID, TEMPSENSOR_TEMPSENSORENDPOINT_ENDPOINT, 0xFF, ZPS_E_BROADCAST_ZC_ZR, ZPS_E_APL_AF_UNSECURE, 0 , &amp;u8SeqNum); }</span></span></code> </pre><br>  The coordinator, in turn, determines from whom the data came from and if it is temperature, then sets the corresponding voltage at the DAC output, and if it is a command from the computer, it sends pulses to the temperature setting buttons (emulates pressing). <br>  Temperature setting function: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetTemp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int8 temp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//,       if(temp &gt; 33) temp = 33; else if(temp &lt; 0) temp = 0; //  ,    vAHI_DacOutput(E_AHI_AP_DAC_1, temp_levels[temp]); }</span></span></code> </pre><br>  Receive data: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      if(MYPROFILE_TEMPERATURE_CLUSTER_ID == sStackEvent.uEvent.sApsDataIndEvent.u16ClusterId) { // PDUM_u16APduInstanceReadNBO(sStackEvent.uEvent.sApsDataIndEvent.hAPduInst, 8, "bh", &amp;ReceivedTempSensorData); //  SetTemp(ReceivedTempSensorData.TempValue); } else //   USB  { // PDUM_u16APduInstanceReadNBO(sStackEvent.uEvent.sApsDataIndEvent.hAPduInst, 0, "b", &amp;Command); // ,       if(Command== '+') { vAHI_DioSetOutput(0, (1 &lt;&lt; PLUS)); vDelay(50); vAHI_DioSetOutput((1 &lt;&lt; PLUS), 0); } if(Command== '-') { vAHI_DioSetOutput(0, (1 &lt;&lt; MINUS)); vDelay(50); vAHI_DioSetOutput((1 &lt;&lt; MINUS), 0); } }</span></span></code> </pre><br><br>  And finally, the video of the system: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/3FmngGDmw4Y%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700253,15700256&amp;usg=ALkJrhg4IqOc9MX2ed7TiZ8O6lN9i4PI0Q" frameborder="0" allowfullscreen=""></iframe><br><br>  Useful links: <br>  <a href="http://www.jennic.com/support/user_guides/jn-ug-3075_jenos_user_guide">Description of the operating system JenOS</a> <br>  <a href="http://www.jennic.com/support/user_guides/jn-ug-3048_zigbee_pro_user_guide">ZigBee Pro Stack Description</a> <br>  <a href="http://ftp.jennic.com/support/user_guides/jn-ug-3066_jn51xx_integrated_peripherals_api">Description of functions for working with JN5148 peripherals</a> <br>  <a href="">Archive with the project</a> <br>  <a href="">Schema Archive</a> <br><br>  And yet, the article was published on May 7, so that everyone with the day of Radio! </div><p>Source: <a href="https://habr.com/ru/post/222085/">https://habr.com/ru/post/222085/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222065/index.html">Light controllers with AngularJS</a></li>
<li><a href="../222067/index.html">Own impressions and review NAS Synology DS214</a></li>
<li><a href="../222077/index.html">Java 8, Spring, Hibernate, SSP - we start playing</a></li>
<li><a href="../222079/index.html">Caching all HTML and connecting JS ‚Äúon the go‚Äù</a></li>
<li><a href="../222083/index.html">Down with the shackles of MongoDB</a></li>
<li><a href="../222089/index.html">Investigation of manipulations with the control panel. Part 2</a></li>
<li><a href="../222099/index.html">Clean sheet problem</a></li>
<li><a href="../222101/index.html">Mirrorless cameras and the law of computer power</a></li>
<li><a href="../222103/index.html">Each marsonavtu - on the bouquet from NASA. The test for the survival of ordinary plants on Mars</a></li>
<li><a href="../222111/index.html">Mink: 3D Makeup Printer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>