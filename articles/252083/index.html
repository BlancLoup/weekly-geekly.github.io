<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GoogleFit API - start and see the result</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habrahabr! Modern gadgets and wearable electronics allow you to not only go on the Internet from your heart's content, fumble and like content, bu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GoogleFit API - start and see the result</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habrahabr!  Modern gadgets and wearable electronics allow you to not only go on the Internet from your heart's content, fumble and like content, but also monitor health, take into account sporting achievements, and just lead a healthy lifestyle. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ac/31c/b84/7ac31cb84d65ccb2781a2e928e80b06d.png"><br><br>  Today we will talk about the main features of the GoogleFit API on the Android platform and try to put the information into practice: learn how to read data from sensors available in the system, save them to the cloud and read the history of records.  We will also create a project that implements these tasks, and consider the general prospects for using the GoogleFit API in real-world development. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>Thanks to <a href="http://habrahabr.ru/users/constantinemars/" class="user_link">ConstantineMars</a> for help in preparing the article.</i> <br><a name="habracut"></a><br><h1>  What is what </h1><br>  <b>GoogleFit</b> is a fairly small and well-documented platform.  The information necessary for working with it can be viewed on our Google Developers portal, there is an entire <a href="https://developers.google.com/fit/android/">section</a> devoted to interaction with Fit.  For those who don‚Äôt want to dive into API descriptions, but it‚Äôs interesting to know about the main features of the platform in order, the video Lisa Wray, the official Google Developer Advocate, is an excellent start. <br><br>  You can start exploring the Fit platform with this tutorial: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/jwaQaWGLlTo%3Ffeature%3Doembed&amp;xid=17259,1500008,15700022,15700186,15700191,15700253&amp;usg=ALkJrhiiXrz3rS-e-hfSbik3_wQiWUhL0A" frameborder="0" allowfullscreen=""></iframe><br><br>  GoogleFit allows you to receive fitness data from various sources (sensors installed on phones, smart watches, fitness bracelets), save them to the cloud storage and read them as a history of ‚Äúfitness measurements‚Äù or a set of sessions / workouts. <br><br>  To access the data, you can use both Android native APIs and REST APIs for writing a web client. <br><br>  The most important role in the GoogleFit ecosystem is played by wearable gadgets, on which great bets are made.  In addition to the ‚Äúclassic‚Äù smart watches, the system supports data from specialized Nike + and Jawbone Up fitness bracelets or Bluetooth sensors.  As we have said, data is stored in the cloud and allows you to view statistics, freely combining information from different sources. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/820/25c/a2e/82025ca2e1949397cf77271b18abfbb7.png"><br><br>  Fit API is part of <b>Google Play Services</b> .  As many of you already know, it‚Äôs not so important to have the latest Android OS version on your device, like updated Play Services.  Due to the removal of similar API in the part updated by Google, and not by manufacturers of smartphones, users of your applications around the world can use completely different generations of systems.  In particular, the Fit API is available to anyone who has Android version 2.3 or higher (Gingerbread, API level 9) on the smartphone. <br><br>  To avoid any unnecessary questions, let's designate the key concepts of the Fit API: <br><ul><li>  <b>Data Sources</b> - data sources, i.e. sensors.  They can be both hardware and software (created artificially, for example, by aggregating indicators of several hardware sensors). <br></li><li>  <b>Data Types</b> - data types: speed, number of steps or pulse.  The data type can be complex, containing several fields, for example, location {latitude, longitude, and accuracy}. <br></li><li>  <b>Data Points</b> are fitness measurement marks that contain data binding at the time of measurement. <br></li><li>  <b>Datasets</b> - sets of points (data points) belonging to a specific data source (sensor).  Sets are used to work with the data warehouse, in particular, to receive data in response to queries. <br></li><li>  <b>Sessions</b> are sessions that group user activity into logical units, such as running or training.  A session may contain several segments (Segment). <br></li><li>  <b>GATT (Generic Attribute Profile)</b> is a protocol that provides structured <a href="https://developer.bluetooth.org/TechnologyOverview/Pages/BLE.aspx">data</a> exchange <a href="https://developer.bluetooth.org/TechnologyOverview/Pages/BLE.aspx">between BLE devices</a> . <br></li></ul><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7b9/7c5/d29/7b97c5d294054744419de7ebfe856aee.png"><br><br>  The Google Fitness API itself consists of the following modules: <br><ul><li>  <b>Sensors API</b> - provides access to sensors (sensors) and reading the live data stream from them. <br></li><li>  <b>Recording API</b> - is responsible for the automatic recording of data in the repository, using the mechanism of "subscriptions". <br></li><li>  <b>History API</b> - provides group operations of reading, inserting, importing and deleting data in Google Fit. <br></li><li>  <b>Sessions API</b> - allows you to save fitness data in the form of sessions and segments. <br></li><li>  <b>Bluetooth Low Energy API</b> - provides access to Bluetooth Low Energy sensors in GoogleFit.  Using this API, we can find available BLE devices and retrieve data from them for storage in the cloud. <br></li></ul><br><br><h1>  GoogleFitResearch demo </h1><br>  To demonstrate the capabilities of GoogleFit, we have created a special project that will allow you to work with the API without bothering to write some basis on which everything will work.  The source code of GoogleFit Research demo can be <a href="https://bitbucket.org/c-mars/googlefitresearch">picked</a> up at <a href="https://bitbucket.org/c-mars/googlefitresearch">BitBucket</a> . <br><br>  Let's start with the simplest: try to get the data from the sensors live, using the Sensors API for this. <br><br>  First of all, it is necessary to decide which sensors will take the initial data.  The Sensors API has a special method for this, which allows you to get a list of available information sources, and we can choose from this list one, several, or at least all sensors. <br><br>  As an example, we will try to read the pulse rate, the number of steps, and the change in user coordinates.  It should be noted that, although we are turning to the pulse meter, we still will not receive data from it: the pulse meter is available in smart watches and fitness trackers, but not in the smartphone itself, we agree that at the time of writing the code there are neither watches nor sensors we do not have a pulse - as there is no data from them either.  So we will be able to evaluate how the system responds to the ‚Äúnegatvny test‚Äù, i.e.  a case where instead of the expected data we get zeroes at best, and at worst a system error message. <br><br><h1>  Up to all night to get started </h1><br>  All you need to work with an example is your Google account.  We don‚Äôt need to create a database or write our own server - the GoogleFit API has already taken care of everything. <br><br>  As an official example, you can use the sources from Google Developers, available on <a href="https://github.com/googlesamples/android-fit">GitHub</a> . <br><br><h1>  Project preparation </h1><br><ol><li>  First you will need to log in to your Google account (if for some improbable reasons you still don‚Äôt have one, you can correct this misunderstanding at the following link: <a href="https://accounts.google.com/SignUp">https://accounts.google.com/SignUp</a> ); <br></li><li>  Logged in?  Go to the <a href="https://console.developers.google.com/">Google Developer Console</a> and create a new project.  The main thing is to remember to include the Fitness API for it; <br></li></ol><br><br><img src="https://habrastorage.org/getpro/habr/post_images/0fd/a71/43b/0fda7143b1ffa9f2981f1636b307f6d9.png"><br><br><ol><li>  Now you need to add the SHA1-key from the project to the console.  To do this, use the keytool utility.  How to do this is perfectly described in the <a href="https://developers.google.com/fit/android/get-started">Google Fit</a> tutorial.  We are updating Play Services to the latest version: they are needed for the API to work, first of all, for access to the cloud data storage. <br></li></ol><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ab2/478/425/ab24784255eff37f544db61865d6b80b.png"><br><br><ol><li>  Add a dependency on Play Services to the build.gradle project: <br></li></ol><br><br>  <i>dependencies {</i> <i><br></i>  <i>compile 'com.google.android.gms: play-services: 6.5. +'</i> <i><br></i>  <i>}</i> <i><br></i> <br><br><h1>  Authorization </h1><br>  With the preparation of the project more or less figured out, now proceed directly to the authorization code. <br><br>  Connect with services will be using <b>GoogleApiClient.</b>  The following code creates a client object that requests <b>Fitness.API</b> from services, adds us read access (SCOPE_LOCATION_READ) and write (SCOPE_BODY_READ_WRITE) and sets the Listeners that will handle the data and errors from Fitness.API.  After that, this code snippet tries to connect to Google Play Services with the specified settings: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="java hljs">client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GoogleApiClient.Builder(activity) .addApi(Fitness.API) .addScope(Fitness.SCOPE_LOCATION_READ) .addScope(Fitness.SCOPE_ACTIVITY_READ) .addScope(Fitness.SCOPE_BODY_READ_WRITE) .addConnectionCallbacks( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GoogleApiClient.ConnectionCallbacks() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onConnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle bundle)</span></span></span><span class="hljs-function"> </span></span>{ display.show(<span class="hljs-string"><span class="hljs-string">"Connected"</span></span>); connection.onConnected(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onConnectionSuspended</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i)</span></span></span><span class="hljs-function"> </span></span>{ display.show(<span class="hljs-string"><span class="hljs-string">"Connection suspended"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i == GoogleApiClient.ConnectionCallbacks.CAUSE_NETWORK_LOST) { display.show(<span class="hljs-string"><span class="hljs-string">"Connection lost. Cause: Network Lost."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i == GoogleApiClient.ConnectionCallbacks.CAUSE_SERVICE_DISCONNECTED) { display.show(<span class="hljs-string"><span class="hljs-string">"Connection lost. Reason: Service Disconnected"</span></span>); } } } ) .addOnConnectionFailedListener( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GoogleApiClient.OnConnectionFailedListener() { <span class="hljs-comment"><span class="hljs-comment">// Called whenever the API client fails to connect. @Override public void onConnectionFailed(ConnectionResult result) { display.log("Connection failed. Cause: " + result.toString()); if (!result.hasResolution()) { GooglePlayServicesUtil.getErrorDialog(result.getErrorCode(), activity, 0).show(); return; } if (!authInProgress) { try { display.show("Attempting to resolve failed connection"); authInProgress = true; result.startResolutionForResult(activity, REQUEST_OAUTH); } catch (IntentSender.SendIntentException e) { display.show("Exception while starting resolution activity: " + e.getMessage()); } } } } ) .build(); lient.connect();</span></span></code> </pre> <br></div></div><br><br>  <b>GoogleApiClient.ConnectionCallbacks</b> - provides processing of successful (onConnected) or unsuccessful (onConnectionSuspended) connection. <br>  <b>GoogleApiClient.OnConnectionFailedListener</b> - handles connection errors and the most important situation - authorization error when you first access the GoogleFit API, thus giving the user a web form of OAuth authorization (result.startResolutionForResult): <br><br>  Authorization is performed using a standard web form: <br><br><img src="https://habrastorage.org/files/f29/1d0/eb8/f291d0eb805e4697b137b2235cca90b7.png"><br><br>  The result of the correction of the authorization error that was started by calling startResolutionForResult is processed in onActivityResult: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onActivityResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestCode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Intent data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestCode == REQUEST_OAUTH) { display.log(<span class="hljs-string"><span class="hljs-string">"onActivityResult: REQUEST_OAUTH"</span></span>); authInProgress = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resultCode == Activity.RESULT_OK) { <span class="hljs-comment"><span class="hljs-comment">// Make sure the app is not already connected or attempting to connect if (!client.isConnecting() &amp;&amp; !client.isConnected()) { display.log("onActivityResult: client.connect()"); client.connect(); } } } }</span></span></code> </pre></div></div><br>  We use the authInProgress variable to prevent the authorization procedure from re-running and the request ID REQUEST_OAUTH.  If successful, connect the client by calling mClient.connect ().  This is the challenge that we have already tried to implement onCreate, and to which we received an error during the very first authorization. <br><br><h1>  Sensors API </h1><br>  <b>Sensors API</b> provides live data from sensors at a specified time interval or event. <br><br>  To demonstrate the operation of individual APIs in our example, we added wrappers that leave only generalized code to be called from MainActivity.  For example, for the SensorsAPI in the onConnected () client callback, we call: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs">display.show(<span class="hljs-string"><span class="hljs-string">"client connected"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// we can call specific api only after GoogleApiClient connection succeeded initSensors(); display.show("list datasources"); sensors.listDatasources();</span></span></code> </pre></div></div><br>  Inside, work directly with the Sensors API: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs">Fitness.SensorsApi.findDataSources(client, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataSourcesRequest.Builder() .setDataTypes( DataType.TYPE_LOCATION_SAMPLE, DataType.TYPE_STEP_COUNT_DELTA, DataType.TYPE_DISTANCE_DELTA, DataType.TYPE_HEART_RATE_BPM ) .setDataSourceTypes(DataSource.TYPE_RAW, DataSource.TYPE_DERIVED) .build()) .setResultCallback(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ResultCallback&lt;DataSourcesResult&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataSourcesResult dataSourcesResult)</span></span></span><span class="hljs-function"> </span></span>{ datasources.clear(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (DataSource dataSource : dataSourcesResult.getDataSources()) { Device device = dataSource.getDevice(); String fields = dataSource.getDataType().getFields().toString(); datasources.add(device.getManufacturer() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + device.getModel() + <span class="hljs-string"><span class="hljs-string">" ["</span></span> + dataSource.getDataType().getName() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + fields + <span class="hljs-string"><span class="hljs-string">"]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DataType dataType = dataSource.getDataType(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( dataType.equals(DataType.TYPE_LOCATION_SAMPLE) || dataType.equals(DataType.TYPE_STEP_COUNT_DELTA) || dataType.equals(DataType.TYPE_DISTANCE_DELTA) || dataType.equals(DataType.TYPE_HEART_RATE_BPM)) { Fitness.SensorsApi.add(client, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SensorRequest.Builder() .setDataSource(dataSource) .setDataType(dataSource.getDataType()) .setSamplingRate(<span class="hljs-number"><span class="hljs-number">5</span></span>, TimeUnit.SECONDS) .build(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnDataPointListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDataPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataPoint dataPoint)</span></span></span><span class="hljs-function"> </span></span>{ String msg = <span class="hljs-string"><span class="hljs-string">"onDataPoint: "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Field field : dataPoint.getDataType().getFields()) { Value value = dataPoint.getValue(field); msg += <span class="hljs-string"><span class="hljs-string">"onDataPoint: "</span></span> + field + <span class="hljs-string"><span class="hljs-string">"="</span></span> + value + <span class="hljs-string"><span class="hljs-string">", "</span></span>; } display.show(msg); } }) .setResultCallback(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ResultCallback&lt;Status&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Status status)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status.isSuccess()) { display.show(<span class="hljs-string"><span class="hljs-string">"Listener for "</span></span> + dataType.getName() + <span class="hljs-string"><span class="hljs-string">" registered"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { display.show(<span class="hljs-string"><span class="hljs-string">"Failed to register listener for "</span></span> + dataType.getName()); } } }); } } datasourcesListener.onDatasourcesListed(); } });</code> </pre></div></div><br>  <b>Fitness.SensorsApi.findDataSources</b> queries the list of available data sources (which we display in the Datasources fragment). <br><br>  <b>DataSourcesRequest</b> should include type filters for which we want to get sources, for example <b>DataType.TYPE_STEP_COUNT_DELTA</b> . <br><br>  As a result of the query, we get DataSourcesResult, from which you can get the details of each data source (device, brand, data type, data type fields): <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (DataSource dataSource : dataSourcesResult.getDataSources()) { Device device = dataSource.getDevice(); String fields = dataSource.getDataType().getFields().toString(); datasources.add(device.getManufacturer() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + device.getModel() + <span class="hljs-string"><span class="hljs-string">" ["</span></span> + dataSource.getDataType().getName() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + fields + <span class="hljs-string"><span class="hljs-string">"]"</span></span>);</code> </pre></div></div><br>  The list of data sources obtained by us may look like this: <br><br><img src="https://habrastorage.org/files/1c4/ec4/1a0/1c4ec41a07434dce8ed40ba01f110b0d.png"><br><br>  In our example, we have simplified the task and subscribe to updates from each source that fits our criteria.  In real life, it makes sense to choose one source, narrowing down the criteria so as not to get redundant data that litters traffic.  By subscribing to messages from the data source, we can also set the data reading interval (SamplingRate): <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs">Fitness.SensorsApi.add(client, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SensorRequest.Builder() .setDataSource(dataSource) .setDataType(dataSource.getDataType()) .setSamplingRate(<span class="hljs-number"><span class="hljs-number">5</span></span>, TimeUnit.SECONDS) .build(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnDataPointListener() { ‚Ä¶ }</code> </pre></div></div><br>  DataPoint - sensor readings.  Naturally, the sensors are different, and their description is the so-called "fields" (fields), which can be considered from the data type, along with the values: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnDataPointListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDataPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataPoint dataPoint)</span></span></span><span class="hljs-function"> </span></span>{ String msg = <span class="hljs-string"><span class="hljs-string">"onDataPoint: "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Field field : dataPoint.getDataType().getFields()) { Value value = dataPoint.getValue(field); msg += <span class="hljs-string"><span class="hljs-string">"onDataPoint: "</span></span> + field + <span class="hljs-string"><span class="hljs-string">"="</span></span> + value + <span class="hljs-string"><span class="hljs-string">", "</span></span>; } display.show(msg); } })</code> </pre></div></div><br>  For example, the step counter (delta) gives us a new entry for each step (or rather, what the sensor perceives as a step, because in this case it was possible to get along with the usual shaking the phone to generate new entries :-p). <br><br><img src="https://habrastorage.org/files/6ff/f53/035/6fff530350824f438f26ad3c3c621718.png"><br><br><h1>  Recording API </h1><br>  Records do not give visual results, but their work can be traced through the History API in the form of data stored in the cloud.  Actually, all that can be done using the Recording API is to subscribe to events (so that the system automatically keeps records for us, unsubscribe from them and search for existing subscriptions): <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs">Fitness.RecordingApi.subscribe(client, DataType.TYPE_STEP_COUNT_DELTA) .setResultCallback(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ResultCallback&lt;Status&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Status status)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status.isSuccess()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status.getStatusCode() == FitnessStatusCodes.SUCCESS_ALREADY_SUBSCRIBED) { display.show(<span class="hljs-string"><span class="hljs-string">"Existing subscription for activity detected."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { display.show(<span class="hljs-string"><span class="hljs-string">"Successfully subscribed!"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { display.show(<span class="hljs-string"><span class="hljs-string">"There was a problem subscribing."</span></span>); } } });</code> </pre></div></div><br>  Here we subscribe to DataType.TYPE_STEP_COUNT_DELTA.  If you wish to collect other types of data, it is enough to repeat the call for a different data type. <br><br>  Listing of existing subscriptions is done as follows: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs">Fitness.RecordingApi.listSubscriptions(client, DataType.TYPE_STEP_COUNT_DELTA).setResultCallback(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ResultCallback&lt;ListSubscriptionsResult&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ListSubscriptionsResult listSubscriptionsResult)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Subscription sc : listSubscriptionsResult.getSubscriptions()) { DataType dt = sc.getDataType(); display.show(<span class="hljs-string"><span class="hljs-string">"found subscription for data type: "</span></span> + dt.getName()); } } });</code> </pre></div></div><br><br>  The logs of the Recordings tab look like this: <br><img src="https://habrastorage.org/files/47a/70f/b00/47a70fb00d694f3d9d93f4e04947fdbe.png"><br><br><h1>  History API </h1><br>  The History API provides work with data packages that can be saved and loaded from the cloud.  This includes reading data at specific time intervals, saving previously read data (as opposed to the Recording API, this is a data packet, not a live stream), deleting records made from the same application. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs">DataReadRequest readRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataReadRequest.Builder() .aggregate(DataType.TYPE_STEP_COUNT_DELTA, DataType.AGGREGATE_STEP_COUNT_DELTA) .bucketByTime(<span class="hljs-number"><span class="hljs-number">1</span></span>, TimeUnit.DAYS) .setTimeRange(start, end, TimeUnit.MILLISECONDS) .build();</code> </pre></div></div><br>  When forming a query (DataReadRequest), we can specify aggregation operations, for example, combine TYPE_STEP_COUNT_DELTA into AGGREGATE_STEP_COUNT_DELTA, representing the total number of steps for a selected period of time;  specify the sampling interval (.bucketByTime), set the time interval for which we need data (.setTimeRange). <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs">Fitness.HistoryApi.readData(client, readRequest).setResultCallback(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ResultCallback&lt;DataReadResult&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataReadResult dataReadResult)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dataReadResult.getBuckets().size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { display.show(<span class="hljs-string"><span class="hljs-string">"DataSet.size(): "</span></span> + dataReadResult.getBuckets().size()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Bucket bucket : dataReadResult.getBuckets()) { List&lt;DataSet&gt; dataSets = bucket.getDataSets(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (DataSet dataSet : dataSets) { display.show(<span class="hljs-string"><span class="hljs-string">"dataSet.dataType: "</span></span> + dataSet.getDataType().getName()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (DataPoint dp : dataSet.getDataPoints()) { describeDataPoint(dp, dateFormat); } } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dataReadResult.getDataSets().size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { display.show(<span class="hljs-string"><span class="hljs-string">"dataSet.size(): "</span></span> + dataReadResult.getDataSets().size()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (DataSet dataSet : dataReadResult.getDataSets()) { display.show(<span class="hljs-string"><span class="hljs-string">"dataType: "</span></span> + dataSet.getDataType().getName()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (DataPoint dp : dataSet.getDataPoints()) { describeDataPoint(dp, dateFormat); } } } } });</code> </pre></div></div><br>  Depending on the type of request, we can get either buckets dataReadResult.getBuckets () or DataSets dataReadResult.getDataSets (). <br>  In essence, the bucket is just a DataSets collection, and the API gives us a choice: if there are no buckets in the API response, we can directly work with the DataSets collection from the dataResult. <br>  Reading DataPoints can be done, for example, like this: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">describeDataPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataPoint dp, DateFormat dateFormat)</span></span></span><span class="hljs-function"> </span></span>{ String msg = <span class="hljs-string"><span class="hljs-string">"dataPoint: "</span></span> + <span class="hljs-string"><span class="hljs-string">"type: "</span></span> + dp.getDataType().getName() +<span class="hljs-string"><span class="hljs-string">"\n"</span></span> + <span class="hljs-string"><span class="hljs-string">", range: ["</span></span> + dateFormat.format(dp.getStartTime(TimeUnit.MILLISECONDS)) + <span class="hljs-string"><span class="hljs-string">"-"</span></span> + dateFormat.format(dp.getEndTime(TimeUnit.MILLISECONDS)) + <span class="hljs-string"><span class="hljs-string">"]\n"</span></span> + <span class="hljs-string"><span class="hljs-string">", fields: ["</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(Field field : dp.getDataType().getFields()) { msg += field.getName() + <span class="hljs-string"><span class="hljs-string">"="</span></span> + dp.getValue(field) + <span class="hljs-string"><span class="hljs-string">" "</span></span>; } msg += <span class="hljs-string"><span class="hljs-string">"]"</span></span>; display.show(msg); }</code> </pre></div></div><br>  Our logs will be filled with information from previous sessions recorded via Recording and what the official GoogleFit has collected for us (it also activates the Recording API, using which it counts, for example, the number of steps and the activity time per day). <br><br><img src="https://habrastorage.org/files/d4f/c63/bd6/d4fc63bd625b4bec8a3104c4896fb30b.png"><br><br><h1>  What's next? </h1><br>  So, we looked at the possibilities of reading data directly from sensors (Sensors API), automated recording of sensors' indicators in GoogleFit (Recording API), and working with history (History API).  This is the basic functionality of a fitness tracker, which is enough for a full-fledged application. <br><br>  Then there are two more interesting APIs provided by GoogleFit - Sessions and Bluetooth.  The first allows you to group activities in sessions and segments for more <a href="https://developers.google.com/fit/android/using-sessions">structured work with fitness data</a> .  The second allows you to search and connect to <a href="https://developers.google.com/fit/android/ble-sensors">Bluetooth sensors</a> that are within range, such as heart rate monitors, sensors in shoes / clothes, etc. <br><br>  You can also create software sensors and thus work with devices that do not implement the necessary protocols, but provide data (implemented using the FitnessSensorService).  These features are not necessary, but they add quite good opportunities to get your own data types (aggregated from data from other sensors or generated programmatically) and can be used if necessary. <br><br>  Of course, if you start working with the GoogleFit API, you will want to make the application beautiful and enjoyable to use.  Two more components may be needed for this: displaying graphs similar to what GoogleFit draws (for which there are many external libraries, for example, <a href="https://bitbucket.org/danielnadeau/holographlibrary/wiki/Home">Bitbucket</a> , and almost certainly <a href="https://developer.android.com/training/building-wearables.html">AndroidWear</a> , which, in particular, provides an API for interacting with the read sensor pulse in smartwatch <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9f0/70a/042/9f070a0425e4b2adda6c5e1b87081d93.png"><img src="https://habrastorage.org/getpro/habr/post_images/4d8/0f2/9c5/4d80f29c56d1f37ff6491668f3005a92.png"><img src="https://habrastorage.org/getpro/habr/post_images/498/755/0f5/4987550f5bd278e322df178615725dae.png"><br><br>  <b>Good luck and success in sports!</b> <br><br><img src="https://habrastorage.org/files/56d/d58/1b2/56dd581b2c43436786d92ebb9115ba3d.png"></div><p>Source: <a href="https://habr.com/ru/post/252083/">https://habr.com/ru/post/252083/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252069/index.html">Testing flash storage. EMC XtremIO</a></li>
<li><a href="../252073/index.html">11 cool sites for iOS developers</a></li>
<li><a href="../252075/index.html">An interesting and at the same time simple slider on pure CSS3</a></li>
<li><a href="../252077/index.html">Discrete structures: matan for IT professionals</a></li>
<li><a href="../252079/index.html">DuoCode: we translate C # in JavaScript</a></li>
<li><a href="../252085/index.html">Course young fighter. Practical course on Cisco Packet Tracer</a></li>
<li><a href="../252091/index.html">Internet security: are users ready to counter cyber threats?</a></li>
<li><a href="../252095/index.html">The vulnerability of the "thumb": I hack your finger on the photo</a></li>
<li><a href="../252099/index.html">?.: when properties in C # can be null</a></li>
<li><a href="../252101/index.html">Documenting code efficiently with Doxygen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>