<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Determine the ripeness of watermelon with the help of Keras: a full cycle, from idea to program on Google Play</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How it all began 
 It all started with the Apple Market - I found that they have a program to determine the ripeness of watermelon. The program ... st...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Determine the ripeness of watermelon with the help of Keras: a full cycle, from idea to program on Google Play</h1><div class="post__text post__text-html js-mediator-article"><h3>  How it all began </h3><br>  It all started with the Apple Market - I found that they have a program to determine the ripeness of watermelon.  The program ... strange.  What is worth, at least, the proposal to knock on the watermelon is not knuckles, and ... the phone!  Nevertheless, I wanted to repeat this achievement on a more familiar Android platform. <br><a name="habracut"></a><br><h3>  Selection of tools </h3><br>  Our task is solved in several ways, and to be honest, I had to make a lot of effort not to go the ‚Äúsimple‚Äù way.  That is, take the Fourier transform, wavelets and signal editor.  However, I wanted to get experience with neural networks, so let the network and analyze the data. <br><br>  Keras was chosen as a library for creating and training neural networks - a Google add-on over TensorFlow and Theano.  In general, if you are just starting to work with networks of deep learning, you will not find a better tool.  On the one hand, Keras is a powerful tool optimized for speed, memory and hardware (yes, he can work on video cards and their clusters).  On the other hand, everything that can be ‚Äúhidden‚Äù from the user is hidden there, so you don‚Äôt have to wrestle with connecting neural network layers, for example.  Very comfortably. <br><br>  Both Keras and neural networks in general require the knowledge of Python - this language, like a snake wrapped around ... sorry, it has become painful.  In short, without Python in modern Deep Learning is not worth it.  Fortunately, the Python can be studied in two weeks, at most - in a month. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For Python, you will need some more libraries, but these are trifles - I mean, if you have already coped with Python itself.  You will need an acquaintance (very superficial) with NumPy, PyPlot, and possibly another pair of libraries, from which we will take literally a couple of functions.  Not difficult.  True. <br><br>  Well, in conclusion, I note that we will not need the clusters of video cards mentioned above - our task is normally solved with the help of a computer CPU - slowly, but not critical, slowly. <br><br><h3>  Work plan </h3><br>  First you need to create a neural network - on Python and Keras, under Ubuntu.  You can - on the emulator Ubunt.  You can - under Vindouz, but the extra time spent will be enough for you to study the mentioned Ubuntu, and then work under it. <br><br>  The next step is to write the program.  I plan to do this in Java for Android.  It will be a prototype of the program, in the sense that it will have a user interface, but there is no neural network yet. <br><br>  What is the meaning of writing "dummy", you ask.  But this is what: any task related to data analysis, sooner or later rests on data retrieval - for training our program.  In fact, how many watermelons need to be tapped and tasted so that the neural network can build a reliable model on this data?  A hundred?  More? <br><br>  Here our program will help us: fill it up on Google Play, distribute (okay, force, twisting hands) all friends who are not lucky to have a phone with Android, and the data, with a tiny stream, begin to flow ... and by the way, where? <br><br>  The next step is to write a server program that receives data from our android client.  True, this server program is very simple, I finished everything in about twenty minutes.  But, nevertheless, this is a separate stage. <br><br>  Finally, there is enough data.  We teach neural network. <br><br>  We port the neural network to Java and release an update of our program. <br><br>  Profit  Although not.  The program was free.  Only experience and stuffed bumps. <br><br><h3>  Creating a neural network </h3><br>  Working with audio, which, of course, is tapping on the watermelon, it is either recurrent neural networks, or the so-called one-dimensional convolutional network.  Moreover, in recent times, convolutional networks are unambiguously leading, displacing recurrent networks.  The idea of ‚Äã‚Äãa convolutional network is that the data array - the graphics "intersivnost sound - time" - slides the window, and instead of analyzing hundreds of thousands of samples, we work only with what falls into the window.  The following layers combine and analyze the results of the work of this layer. <br><br>  To make it clearer, imagine that you need to find a seagull in the photo of the sea landscape.  You are scanning a picture - the ‚Äúwindow‚Äù of your attention moves along imaginary rows and columns, in search of a white check mark.  This is how a convolutional 2D network works, one-dimensional scans along one coordinate ‚Äî the optimal choice if we are dealing with an audio signal. <br><br>  I note, however, that it is not necessary to dwell on 1D networks.  As an exercise, I plotted the sound and analyzed the resulting bitmap as a picture using a 2d convolutional network.  To my surprise, the result was no worse than in the analysis of "raw one-dimensional" data. <br><br>  The network used had the following structure: <br><br><pre><code class="python hljs">model = Sequential() model.add(Conv1D(filters=<span class="hljs-number"><span class="hljs-number">32</span></span>, kernel_size=<span class="hljs-number"><span class="hljs-number">512</span></span>, strides=<span class="hljs-number"><span class="hljs-number">3</span></span>, padding=<span class="hljs-string"><span class="hljs-string">'valid'</span></span>, use_bias=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, input_shape=(nSampleSize, <span class="hljs-number"><span class="hljs-number">1</span></span>), name=<span class="hljs-string"><span class="hljs-string">'c1d'</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(Activation(<span class="hljs-string"><span class="hljs-string">'relu'</span></span>, input_shape=(nSampleSize, <span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(MaxPooling1D(pool_size=(<span class="hljs-number"><span class="hljs-number">2</span></span>))) model.add(Conv1D(<span class="hljs-number"><span class="hljs-number">32</span></span>, (<span class="hljs-number"><span class="hljs-number">3</span></span>))) model.add(Activation(<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(MaxPooling1D(pool_size=(<span class="hljs-number"><span class="hljs-number">2</span></span>))) model.add(Conv1D(<span class="hljs-number"><span class="hljs-number">64</span></span>, (<span class="hljs-number"><span class="hljs-number">3</span></span>))) model.add(Activation(<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(MaxPooling1D(pool_size=(<span class="hljs-number"><span class="hljs-number">2</span></span>))) model.add(Flatten()) model.add(Dense(<span class="hljs-number"><span class="hljs-number">64</span></span>)) model.add(Activation(<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(Dropout(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) model.add(Dense(nNumOfOutputs)) <span class="hljs-comment"><span class="hljs-comment">#1)) model.add(Activation('sigmoid')) model.compile(loss='mean_squared_error', optimizer='adam', metrics=['accuracy'])</span></span></code> </pre> <br>  This network has two output values ‚Äã‚Äã(it predicts two values): sweetness and ripeness.  Sweetness is 0 (unsweetened), 1 (normal) and 2 (excellent), and ripeness, respectively, 0 is too hard, 1 is what is needed, and 2 is over-ripe, like cotton wool with sand. <br><br>  Estimates for the test sample are set by the person exactly how - we'll talk in the section on the program for Android.  The task of a neural network is to predict what kind of assessment a person will give for a given watermelon (by recording a tap). <br><br><h3>  Writing a program </h3><br>  I have already mentioned that the program should come out as two versions.  The first, preliminary, honestly warns the user that her predictions are complete nonsense.  But it allows the user to record a knock on the watermelon, set an assessment of the taste of this watermelon and send it over the Internet to the author of the program.  That is, the first version simply collects data. <br><br>  Here is the <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.snowcron.cortex.melonaire">program page</a> on Google Play, of course, the program is free. <br><br>  What is she doing: <br><br>  1. Press the button with the microphone and the recording begins.  You have five seconds to hit the watermelon three times - tap-tap-tap.  The button with a watermelon makes a "prediction", and we do not touch it yet. <br><br>  Note - if on Google the old version, the recording and prediction are combined in the button with the watermelon, and there are no buttons with the microphone. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/534/298/569/534298569949fd9bf2ac74a5a6ed51f4.png" alt="image"><br><br>  2. The saved file is temporary and will be overwritten the next time you press the record button.  This allows you to repeat the tapping, if someone says arm in arm (you can‚Äôt imagine how difficult it is to make others shut up for five seconds!) Or the water is just noisy - the dishes are ringing - the neighbor drills ... <br><br>  But the watermelon is selected and purchased.  You brought it home, recorded the sound and cut it.  Now you are ready to evaluate its taste.  Select the Save tab. <br><br>  On this tab, we see two combo boxes for grading - sweetness and ripeness (sweetness and ripeness, translation work is underway).  Evaluated - click Save. <br><br>  Attention!  Save can be clicked only once.  So, first set a rating.  By pressing a button, the sound file is renamed, and now it will not be erased during the next recording. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a2d/45d/54f/a2d45d54f0a21680a342db630b59d09d.png" alt="image"><br><br>  3. Finally, having written down (and therefore, having eaten) about a dozen watermelons, you returned from the dacha, where you did not have the Internet.  Now the Internet is.  Open the Submit tab and click the button.  Package (with a dozen watermelons) goes to the server developer. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d5c/c5f/d41/d5cc5fd41549ca66036c8b49a0645c34.png" alt="image"><br><br><h3>  Writing a server program </h3><br>  Everything is simple, so I'd rather put the full code of this script.  The program ‚Äúcatches‚Äù files, gives them unique names and puts them in a directory accessible only by the site owner. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_uploaded_file($_FILES[<span class="hljs-string"><span class="hljs-string">'file'</span></span>][<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>])) { $uploads_dir = <span class="hljs-string"><span class="hljs-string">'./melonaire/'</span></span>; $tmp_name = $_FILES[<span class="hljs-string"><span class="hljs-string">'file'</span></span>][<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>]; $pic_name = $_FILES[<span class="hljs-string"><span class="hljs-string">'file'</span></span>][<span class="hljs-string"><span class="hljs-string">'name'</span></span>]; $filename = md5(date(<span class="hljs-string"><span class="hljs-string">'Ymd H:i:s:u'</span></span>)); move_uploaded_file($tmp_name, $uploads_dir.$filename); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"File not uploaded successfully."</span></span>; } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><h3>  Neural network training </h3><br>  The data are divided into training and test, 70 and 30 percent, respectively.  Neural network - converges.  There are no surprises here, however, for beginners: do not forget to normalize the input data, it will save you a lot of nerves.  Something like this: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.listdir(path): nSweetness, nRipeness, arr_loaded = loadData(file_name) arr_data.append(arr_loaded / max(abs(arr_loaded))) <span class="hljs-comment"><span class="hljs-comment"># 2 stands for num. of inputs of a combo box - 1 arr_labels.append([nSweetness / 2.0, nRipeness / 2.0])</span></span></code> </pre><br><h3>  Porting neural network </h3><br>  There are several ways to port a network from Python to Java.  Recently, Google has made this process more convenient, so that you will read the textbooks - make sure that they are not outdated.  Here's how I did it: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Model <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> load_model <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.layers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tensorflow <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tf <span class="hljs-comment"><span class="hljs-comment"># ------------------- def print_graph_nodes(filename): g = tf.GraphDef() g.ParseFromString(open(filename, 'rb').read()) print() print(filename) print("=======================INPUT=========================") print([n for n in g.node if n.name.find('input') != -1]) print("=======================OUTPUT========================") print([n for n in g.node if n.name.find('output') != -1]) print("===================KERAS_LEARNING=====================") print([n for n in g.node if n.name.find('keras_learning_phase') != -1]) print("======================================================") print() # ------------------- def get_script_path(): return os.path.dirname(os.path.realpath(sys.argv[0])) # ------------------- def keras_to_tensorflow(keras_model, output_dir, model_name,out_prefix="output_", log_tensorboard=True): if os.path.exists(output_dir) == False: os.mkdir(output_dir) out_nodes = [] for i in range(len(keras_model.outputs)): out_nodes.append(out_prefix + str(i + 1)) tf.identity(keras_model.output[i], out_prefix + str(i + 1)) sess = K.get_session() from tensorflow.python.framework import graph_util, graph_io init_graph = sess.graph.as_graph_def() main_graph = graph_util.convert_variables_to_constants(sess, init_graph, out_nodes) graph_io.write_graph(main_graph, output_dir, name=model_name, as_text=False) if log_tensorboard: from tensorflow.python.tools import import_pb_to_tensorboard import_pb_to_tensorboard.import_to_tensorboard( os.path.join(output_dir, model_name), output_dir) model = load_model(get_script_path() + "/models/model.h5") #keras_to_tensorflow(model, output_dir=get_script_path() + "/models/model.h5", # model_name=get_script_path() + "/models/converted.pb") print_graph_nodes(get_script_path() + "/models/converted.pb")</span></span></code> </pre><br>  Pay attention to the last line: in Java code you will need to specify the names of the input and output of the network.  This ‚Äúprint‚Äù just prints them. <br><br>  So, we put the resulting concerted.pb file in the assets directory of the Android Studio, we connect (see <a href="https://medium.com/capital-one-developers/using-a-pre-trained-tensorflow-model-on-android-part-2-153ebdd4c465">here</a> , or <a href="https://medium.com/%40thepulkitagarwal/deploying-a-keras-model-on-android-3a8bb83d75ca">here</a> , or better, <a href="https://github.com/OmarAflak/Keras-Android-XOR">here</a> ) the tensorflowinferenceinterface library, that's all. <br><br>  Everything.  When I did this for the first time, I expected it would be difficult, but ... it worked on the first attempt. <br><br>  Here is the call to the neural network from Java code: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Void </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Void... params)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//Pass input into the tensorflow tf.feed(INPUT_NAME, m_arrInput, 1, // batch ? m_arrInput.length, 1); // channels ? //compute predictions tf.run(new String[]{OUTPUT_NAME}); //copy the output into the PREDICTIONS array tf.fetch(OUTPUT_NAME, m_arrPrediction); } catch (Exception e) { e.getMessage(); } return null; }</span></span></code> </pre><br>  Here m_arrInput is an array with two elements, containing - ta-da!  - our prediction, normalized from zero to one. <br><br><h3>  Conclusion </h3><br>  Here, like, it is necessary to thank for attention, and to express hope that it was interesting.  Instead, I note that Google is the first version of the program.  The second is completely ready, but there is little data.  So, if you like watermelons - please put a program on your Android.  The more data you send, the better the second version will work ... <br><br>  Of course, it will be free. <br><br>  Good luck, and yes: thank you for your attention.  I hope it was interesting. <br><br>  Important update: a new version has been released with improved analysis.  Thanks to everyone who sent watermelons, and please send more! </div><p>Source: <a href="https://habr.com/ru/post/424099/">https://habr.com/ru/post/424099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424087/index.html">The machine on the Arduino, controlled by an Android device via Bluetooth, is a full cycle (part 1)</a></li>
<li><a href="../424089/index.html">Conference for evil. Or good?</a></li>
<li><a href="../424091/index.html">WiX.Py: we assemble MSI package ‚Äúin three lines‚Äù</a></li>
<li><a href="../424093/index.html">From antique radio to DIY speakers: 12 channels on YouTube about acoustics devices</a></li>
<li><a href="../424095/index.html">By 2024, a cellular network for officials and security officials will appear in the Russian Federation</a></li>
<li><a href="../424103/index.html">Silicon Valley "unforgivable" refers to its employees since the 1970s</a></li>
<li><a href="../424105/index.html">NASA knows how to make Mars green again.</a></li>
<li><a href="../424107/index.html">Already a year, as in the WD My Cloud's home network storage, gaping hole</a></li>
<li><a href="../424109/index.html">VSCE # 2: a podcast about media entrepreneurs</a></li>
<li><a href="../424111/index.html">Smart Contracts Waves. First experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>