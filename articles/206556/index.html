<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering flashing LED</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cheap electronic "candles" lately seem to be everywhere. I did not pay much attention to them until I noticed that in fact they used a special LED - w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering flashing LED</h1><div class="post__text post__text-html js-mediator-article">  Cheap electronic "candles" lately seem to be everywhere.  I did not pay much attention to them until I noticed that in fact they used a special LED - with a built-in blinker controller.  Now it is a completely different matter: who does not like the mysterious LEDs?  Half an hour later, I had already gathered an armful of twinkling Chinese-made LEDs. <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/gVOMf-XXAJk%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253&amp;usg=ALkJrhiwPa9ckIMk0oAtwYAcL7kmBp65GA" frameborder="0" allowfullscreen=""></iframe><br><br>  Of course, the most interesting question is how do they work?  Given that they cost literally a few cents apiece, there cannot be any expensive electronics inside.  In this regard, another question arises: is it true that these LEDs are worse than numerous ‚Äúcandles‚Äù on microcontrollers, whose <a href="https://www.google.com/search%3Fq%3Dcandle%2Bflicker%2Bmicrocontroller">circuits are full on the Internet?</a> <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/ff0/3bc/516/ff03bc51680d82700f0b302fc264ef59.jpg"><br>  The device is relatively simple.  The standard 5-millimeter case contains an LED crystal and a microcircuit, which is slightly larger than the first in size.  The controller circuit is connected to both positive and negative terminals.  The third jumper to it is connected to the anode of the LED, while the cathode "sits" on the negative terminal. <br><br>  The <a href="http://www.evilmadscientist.com/2011/does-this-led-sound-funny-to-you/">Evil Mad Scientist</a> blog recently had a story about similar LEDs.  It showed how they ‚Äúsing‚Äù, if you transform changes in brightness into sound.  And also - how to use them to control a more powerful diode.  Such tricks are based on the fact that the LED consumes more current in those moments when the controller lights it up brighter.  A conventional LED, connected in series with flickering, shows very similar changes in brightness.  In other words, the voltage drop across the resistor varies in proportion to the brightness. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/42d/cce/e5d/42dccee5dcdbbcf1ce50f1bf0f0a6e41.png"><br>  This is what I used to extract the control signal from the controller and bring it to the logic analyzer (see the diagram above).  By adjusting the variable resistor, I ensured that the analyzer perceived current surges as ‚Äúzeroes‚Äù and ‚Äúones‚Äù, while the LED worked normally. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/da7/cbc/841/da7cbc841cb252602e5079974645919c.png"><br>  The diagram above shows changes in diode brightness over about a minute, recorded at a sampling rate of 1 MHz.  The intervals when the LED is continuously on, and the periods when its brightness is somehow modulated, are noticeable.  The LED never turns off for a long time.  This is reasonable, because a real candle also shines brightly most of the time, reducing the brightness for short periods of flicker. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/019/c4f/6a9/019c4f6a928411d2ac890492e9b5bde0.png"><br>  A closer look indicates that the signal has a pulse width modulation.  This means that we have a digital circuit, without any analog tricks. <br><br>  It is curious that the frequency of the signal is approximately 440 Hz, as in a standard tuning fork ( <i>note of the first octave - <b>approx. Transl.</b></i> ).  Coincidence?  Or did the developer simply take a generator from some kind of musical scheme?  So there is some truth in the stories about the "musicality" of these LEDs.  Each ‚Äúframe‚Äù of constant brightness is exactly 32 cycles and lasts about 72 ms.  This corresponds to 13-14 frames per second. <br><br>  I wrote a small program to determine the brightness in each frame by the fill factor of the PWM signal.  The program reads a stream of samples from the logic analyzer and displays a series of real numbers, one for each frame. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f5c/db0/36d/f5cdb036d8db7d7319c5164f4301184b.png"><br>  The graph of brightness versus time suggests some thoughts: changes in brightness are random, discrete, and have an uneven distribution.  There seem to be 16 levels of brightness, the lowest 4 of which are used very rarely.  Only 13 of the 3,600 counts correspond to them. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/997/787/c7d/997787c7dde575d64617dc7cc0a3124c.png"><br>  The construction of the histogram opens up the whole picture: only 12 levels of brightness are actually used.  Exactly half of the frames has a maximum brightness, the remaining values ‚Äã‚Äãare distributed approximately equally. <br><br>  How can this be implemented at the hardware level?  It is likely that a generator of uniformly distributed random numbers is used, which are passed through a simple shaper function.  For the distribution that we are observing, at least 12x2 = 24 discrete levels are required.  Half of them are displayed in one.  This is quite curious, since the generator most likely produces binary numbers.  The most logical would be the digit capacity of 5 bits, and these are 32 states.  Displaying a 32-level discrete random variable of 24 levels without changing the distribution is not as simple as it seems.  Do not forget also that this is not a critical scheme at all, and the developer probably did not have much time for a beautiful solution.  Therefore, he used the simplest, a kind of hack. <br><br>  The only simple way that comes to mind is to simply drop the wrong values ‚Äã‚Äãand take the next random number.  Unwanted values ‚Äã‚Äãcan be easily separated by a bit mask.  Since the scheme is synchronous, there is only a finite number of attempts until the next frame begins.  If the controller does not meet the specified number of attempts, it will get stuck on the ‚Äúwrong‚Äù value.  Remember the rare emissions on the brightness graph? <br><br>  An ANSI-C implementation would look like this: <br><pre><code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">char</span></span> attempts=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">char</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(attempts++&lt;MAX_ATTEMPTS) { <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>=RAND()&amp;<span class="hljs-number"><span class="hljs-number">0x1f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>&amp;<span class="hljs-number"><span class="hljs-number">0x0c</span></span>)!=<span class="hljs-number"><span class="hljs-number">0</span></span>) break; //  ,   <span class="hljs-number"><span class="hljs-number">2</span></span>-  <span class="hljs-number"><span class="hljs-number">3</span></span>-   } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>&gt;<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>=<span class="hljs-number"><span class="hljs-number">15</span></span>; //      </code> </pre> <br><br>  You can find out how many attempts are made?  According to statistics, the proportion of <i>a = 0.25 of</i> all numbers must be discarded and re-generated.  The probability that in <i>n</i> attempts the ‚Äúcorrect‚Äù number is not chosen is equal to <i>a <sup>n</sup></i> . <br><pre> <code class="hljs"> n=1 0,25 n=2 0,0625 n=3 0,015625 n=4 0,003906</code> </pre><br><br>  The proportion of anomalously low brightness levels is <i>13/3600 = 0.0036</i> , which coincides well with the option <i>n = 4</i> .  Thus, <i>MAX_ATTEMPTS == 4</i> . <br><br>  Note that a simpler solution would be to simply use the value from the previous frame if an invalid number was encountered.  This option could be excluded on the basis of autocorrelation (see below).  Probably the simplest solution ‚Äî to change the PWM scheme ‚Äî was not used here. <br><br>  The last piece of the puzzle is the random number generator itself.  A typical method for generating random sequences in digital circuits is to use <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25B3%25D0%25B8%25D1%2581%25D1%2582%25D1%2580_%25D1%2581%25D0%25B4%25D0%25B2%25D0%25B8%25D0%25B3%25D0%25B0_%25D1%2581_%25D0%25BB%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25B9%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D1%2582%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2581%25D0%25B2%25D1%258F%25D0%25B7%25D1%258C%25D1%258E">linear feedback shift registers</a> .  Such a register produces a pseudo-random bit sequence, which will repeat no later than <i>2 <sup>x</sup> -1</i> clock cycles, where <i>x</i> is the digit capacity of the register.  One of the features of such sequences (and good pseudo-random sequences as a whole) is that their <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BA%25D0%25BE%25D1%2580%25D1%2580%25D0%25B5%25D0%25BB%25D1%258F%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2584%25D1%2583%25D0%25BD%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F">autocorrelation function</a> is equal to one only at point 0 and in coordinates that are multiple to the length of the sequence.  In all other intervals it is zero. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e7/b96/b9a/7e7b96b9adea371167912ba1fe72c48c.png"><br>  I calculated the autocorrelation of the entire sequence of values.  Self-similarity was not found up to 3,500 frames (only 1200 is shown in the graph above), which means the flicker is unique for at least 4 minutes.  <i>It is unclear whether further repetition of the sequence was observed, or whether the author‚Äôs logical analyzer simply did not allow writing longer - <b>ca.</b></i>  <i><b>trans.</b></i>  Since each frame requires at least 5 bits of random data (and given the mechanism for discarding unwanted numbers ‚Äî even more), the pseudo-random sequence has a length of at least 17,500 bits.  This will require a register of at least 17 bits, or a real hardware random number generator.  In any case, it is interesting how much attention was paid during the development to ensure that the flicker pattern did not repeat. <br><br>  In conclusion, we will answer the questions asked at the beginning of the article.  The flickering LED turned out to be much more complicated than I expected (I also did not expect to spend 4 hours on it).  Many candle microcontroller implementations simply feed the bits from the pseudo-random number generator to the PWM output.  Purchased LED uses a more cunning algorithm to change the brightness.  Of course, some attention was paid to the development of the algorithm, and at the same time a crystal of almost the minimum possible area was used.  Share cent spent not in vain. <br><br>  What is the best flicker algorithm?  Is it possible to improve this? <br><br>  Update: I finally found the time to write an emulator.  An ANSI-C program that emulates the behavior of this LED is <a href="">here</a> .  The code is written under AVR, but it is easy to port it to any other controller.  <a href="https://github.com/cpldcpu/CandleLEDhack">The Github repository</a> contains all the data and source codes used in the process of reverse engineering of the LED. </div><p>Source: <a href="https://habr.com/ru/post/206556/">https://habr.com/ru/post/206556/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206544/index.html">How to write an automatic test for algorithmic complexity?</a></li>
<li><a href="../206546/index.html">SendVoice, or how to hear your visitor</a></li>
<li><a href="../206548/index.html">Eversync - when the right links are always at hand</a></li>
<li><a href="../206550/index.html">Payoneer ‚ÄúLooking Back at 2013‚Äù ‚Äã‚ÄãContest</a></li>
<li><a href="../206554/index.html">Global almost real-time wind map</a></li>
<li><a href="../206558/index.html">Flying over titanium methane lakes: video from NASA</a></li>
<li><a href="../206564/index.html">Odesk Announces Merger With Elance</a></li>
<li><a href="../206566/index.html">Remote code execution on EBay</a></li>
<li><a href="../206568/index.html">One forecast given 15 years ago</a></li>
<li><a href="../206570/index.html">Course work: "The legal aspects of the development of an open operating system ReactOS"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>