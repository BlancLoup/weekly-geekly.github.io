<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Erlang for web development (1) -> Introduction;</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The continuation of the database and Deploy in the second article . 

 I am starting to publish a series of articles on web development on Erlang. Man...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Erlang for web development (1) -> Introduction;</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ab9/08a/eb3/ab908aeb3c9c4422ab0de8abe4b4a361.png" align="right"><br>  <i>The continuation of the database and Deploy in the <a href="http://habrahabr.ru/post/274107/">second article</a></i> . <br><br>  I am starting to publish a series of articles on web development on Erlang.  Many people want to try Erlang, but they face the problem that introductory courses mainly concern Erlang as a functional language and are far from real projects ( <a href="http://learnyousomeerlang.com/">Learn a</a> good and detailed book).  On the other hand, all web development training materials imply that the reader already knows Erlang well. <br><br>  This series of articles is designed for developers who have experience in web development (PHP, Ruby, Java), but do not have experience developing on Erlang. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The task will be to make a blog.  The code from the articles <a href="https://github.com/denys-potapov/n2o-blog-example">https://github.com/denys-potapov/n2o-blog-example</a> , the finished project can be viewed at <a href="http://46.101.118.21:8001/">http://46.101.118.21:8001/</a> .  Features of the project: <br><ul><li>  update comments in real time; </li><li>  Facebook authorization; </li><li>  data stored in mnesia. </li></ul><br>  At the heart of the project is the <a href="https://github.com/synrc/n2o">n2o framework</a> .  The choice is rather subjective, but from living <a href="https://github.com/ChicagoBoss/ChicagoBoss/wiki/comparison-of-erlang-web-frameworks">Erlang frameworks</a> , n2o seemed to me the most “erlang-like”, at the same time ChicagoBoss is more like MVC frameworks in other languages. <br><a name="habracut"></a><br><h2>  Customize the environment </h2><br>  I will configure the environment in Ubuntu, but it should work in other ways in a similar way.  Download and install the current version of Erlang <a href="https://www.erlang-solutions.com/resources/download.html">www.erlang-solutions.com/resources/download.html</a> . <br><br><h3>  Dependency manager </h3><br>  The standard dependency manager in Erlang is <a href="https://github.com/rebar/rebar">rebar</a> .  But, in this article we will use mad from the creators of n2o, which is compatible with the rebar configuration, works faster and allows you to track changes in the templates. <br><pre><code class="bash hljs">curl -fsSL https://raw.github.com/synrc/mad/master/mad &gt; mad chmod +x mad sudo cp mad /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/</code> </pre> <br>  To track changes to mad files, you need to install inotify-tools: <br><pre> <code class="bash hljs">sudo apt-get install inotify-tools</code> </pre><br>  We generate the backbone of the application and run it: <br><pre> <code class="bash hljs"> mad app <span class="hljs-string"><span class="hljs-string">"blog"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> blog mad deps compile plan repl</code> </pre><br>  At <a href="http://localhost:8001/">http: // localhost: 8001 /,</a> a chat opens, which is updated via a web socket in real time, and you can correspond with yourself from different windows. <br><br><img src="https://habrastorage.org/files/3e7/7b7/0dd/3e77b70dd4814b4f8950812a48c79df0.png"><br><br>  The mad parameters are responsible for getting dependencies and running the application: <br><ul><li>  deps - get dependencies; </li><li>  compile - compile the application; </li><li>  plan - create a launch plan; </li><li>  repl - start the console. </li></ul><br><br><h3>  Project structure </h3><br>  The file structure of our project is standard for Erlang applications: <br><pre> Apps── apps
     Re── rebar.config
     Sample── sample
         E── ebin
         │ ├── ...
         Priv── priv
         │ ├── static
         │ │ ...
         │ └── templates
         │ └── index.html
         Re── rebar.config
         S── src
             Index── index.erl
             Routes── routes.erl
             Sample── sample.app.src
             Sample── sample.erl
 De── deps
 Re── rebar.config
 S── sys.config
</pre><br>  Details on the structure can be read in the <a href="http://www.erlang.org/doc/design_principles/applications.html">official documentation</a> . <br>  Later we will get acquainted with almost all the files and folders, but for now we need to know that the Erlang application usually consists of several applications that lie in the apps folder.  We have one sample application in which: <br><ul><li>  src - source code; </li><li>  ebin - compiled files; </li><li>  priv - the rest of the project files, in this case templates and statics; </li><li>  index.erl - the title page. </li></ul><br><br><h2>  First code </h2><br>  Delete unnecessary files: <br><pre> <code class="bash hljs">rm -r apps/sample/priv/static/</code> </pre><br>  For templates, we use ErlyDTL, the implementation of the Django Template Language in Erlang.  Therefore, the syntax will be clear to those familiar with Django-like templating systems (Django, Twig, Mustache). <br><br><div class="spoiler">  <b class="spoiler_title">apps / sample / priv / templates / base.html</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"X-UA-Compatible"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IE=edge"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width=device-width, initial-scale=1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>{% block title %}Erlang blog example{% endblock %}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Bootstrap --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- WARNING: Respond.js doesn't work if you view the page via file:// --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--[if lt IE 9]&gt; &lt;script src="//oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"&gt;&lt;/script&gt; &lt;script src="//oss.maxcdn.com/respond/1.4.2/respond.min.js"&gt;&lt;/script&gt; &lt;![endif]--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.container</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">max-width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">40em</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> {% block content %}{% endblock %} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><br>  <b>apps / sample / priv / templates / index.html</b> <br><pre> <code class="html hljs xml">{% extends "base.html" %} {% block title %}Latest posts{% endblock %} {% block content %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Latest posts<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> {{ posts }} {% endblock %}</code> </pre><br>  Now open index.erl and replace the code with this: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(index)</span></span>. -compile(export_all). -include_lib(<span class="hljs-string"><span class="hljs-string">"n2o/include/wf.hrl"</span></span>). -include_lib(<span class="hljs-string"><span class="hljs-string">"nitro/include/nitro.hrl"</span></span>). main() -&gt; #dtl{file=<span class="hljs-string"><span class="hljs-string">"index"</span></span>}.</code> </pre><br>  In the header of the file, we declare the module, indicate that we export all the functions from this module, and include two header files. <br><br>  The function <b>main / 1</b> is called when the main page is opened.  Functions can return either immediately HTML or DSL Erlang records, which we will discuss later.  For now, we simply return the rendered index template.  <i>In the Erlang documentation, functions are always written as a <b>name / multiplicity</b> , where multiplicity is the number of arguments</i> . <br><br><h2>  Meet the syntax </h2><br>  Now is the time to get acquainted with the basics of syntax, it is the quickest to do at <a href="http://www.tryerlang.org/">www.tryerlang.org</a> .  We will display on the main page all posts.  While we will not use the database, and we will store the posts directly in the code. <br><br>  In the header file /apps/sample/include/records.hrl we describe an entry for storing posts: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-record</span></span><span class="hljs-params"><span class="hljs-params">(post, {id, title, text, author})</span></span>.</code> </pre><br>  Create a module /apps/sample/src/posts.erl to store posts.  The module exports two functions: <b>get / 0</b> - returns all posts, and <b>get / 1</b> - returns post by Id: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(posts)</span></span>. -export([get/<span class="hljs-number"><span class="hljs-number">0</span></span>, get/<span class="hljs-number"><span class="hljs-number">1</span></span>]). -include(<span class="hljs-string"><span class="hljs-string">"records.hrl"</span></span>). get() -&gt; [ #post{id=<span class="hljs-number"><span class="hljs-number">1</span></span>, title=<span class="hljs-string"><span class="hljs-string">"first post"</span></span>, text=<span class="hljs-string"><span class="hljs-string">"interesting text"</span></span>}, #post{id=<span class="hljs-number"><span class="hljs-number">2</span></span>, title=<span class="hljs-string"><span class="hljs-string">"second post"</span></span>, text=<span class="hljs-string"><span class="hljs-string">"not interesting text"</span></span>}, #post{id=<span class="hljs-number"><span class="hljs-number">3</span></span>, title=<span class="hljs-string"><span class="hljs-string">"third post"</span></span>, text=<span class="hljs-string"><span class="hljs-string">"very interesting text"</span></span>} ]. get(Id) -&gt; lists:keyfind(Id, #post.id, ?MODULE:get()).</code> </pre><br><br>  Entries in Erlang are syntactic sugar, the compiler replaces entries with tuples, and fields with indices.  For example, # post.id will be replaced with 0. <br><br><h2>  DSL </h2><br>  I wrote above that functions can return Erlang entries that are converted to HTML.  Change our index.erl so that the list of all posts is displayed on the page: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(index)</span></span>. -compile(export_all). -include_lib(<span class="hljs-string"><span class="hljs-string">"n2o/include/wf.hrl"</span></span>). -include_lib(<span class="hljs-string"><span class="hljs-string">"nitro/include/nitro.hrl"</span></span>). -include_lib(<span class="hljs-string"><span class="hljs-string">"records.hrl"</span></span>). posts() -&gt; [ #panel{body=[ #h2{body = #link{body = P#post.title, url = <span class="hljs-string"><span class="hljs-string">"/post?id="</span></span> ++ wf:to_list(P#post.id)}}, #p{body = P#post.text} ]} || P &lt;- posts:get()]. main() -&gt; #dtl{file=<span class="hljs-string"><span class="hljs-string">"index"</span></span>, bindings=[{posts, posts()}]}.</code> </pre><br>  To create a post page, we in /apps/sample/src/routes.erl specify which module will handle our path: <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">route</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&lt;&lt;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"post"</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;&gt;)</span></span></span><span class="hljs-function"> -&gt;</span></span> post;</code> </pre><br>  The apps / sample / src / post.erl module simply displays a template with post data: <br>  module <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(post)</span></span>. -compile(export_all). -include_lib(<span class="hljs-string"><span class="hljs-string">"n2o/include/wf.hrl"</span></span>). -include_lib(<span class="hljs-string"><span class="hljs-string">"records.hrl"</span></span>). main() -&gt; {Id, _} = string:to_integer(binary_to_list(wf:q(&lt;&lt;<span class="hljs-string"><span class="hljs-string">"id"</span></span>&gt;&gt;))), Post = posts:get(Id), #dtl{file=<span class="hljs-string"><span class="hljs-string">"post"</span></span>, bindings=[{title, Post#post.title}, {text, Post#post.text}]}.</code> </pre><br>  Template: <br><pre> <code class="html hljs xml">{% extends "base.html" %} {% block title %}{{ title }}{% endblock %} {% block content %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>{{ title }}<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">small</span></span></span><span class="hljs-tag">&gt;</span></span>by {{ author }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">small</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{ text }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>Comments<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> {{ comments }} {% endblock %}</code> </pre><br><br><h2>  Web sockets </h2><br>  Now we come to the most interesting, namely, the connection of the browser with the server via a web socket.  We will make comments to the post, which will be updated in real time.  To do this, add the n2o initialization library to the base template: <br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined">{{script}}</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/n2o/protocols/bert.js'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/n2o/protocols/client.js'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/n2o/protocols/nitrogen.js'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/n2o/validation.js'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/n2o/bullet.js'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/n2o/utf8.js'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/n2o/template.js'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/n2o/n2o.js'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined">protos = [ $bert, $client ]; N2O_start();</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  And in the post.erl module, add an event handler and code to display comments: <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> Id = wf:to_integer(wf:q(&lt;&lt;<span class="hljs-string"><span class="hljs-string">"id"</span></span>&gt;&gt;)), Post = posts:get(Id), #dtl{file=<span class="hljs-string"><span class="hljs-string">"post"</span></span>, bindings=[{title, Post#post.title}, {text, Post#post.text}, {comments, comments()}]}. comments() -&gt; [#textarea{id=comment, class=[<span class="hljs-string"><span class="hljs-string">"form-control"</span></span>], rows=<span class="hljs-number"><span class="hljs-number">3</span></span>}, #button{id=send, class=[<span class="hljs-string"><span class="hljs-string">"btn"</span></span>, <span class="hljs-string"><span class="hljs-string">"btn-default"</span></span>], body=<span class="hljs-string"><span class="hljs-string">"Post comment"</span></span>,postback=comment,source=[comment]} ]. event(comment) -&gt; wf:insert_bottom(comments, #blockquote{body = #p{body = wf:html_encode(wf:q(comment))}}).</code> </pre><br>  When displaying the button, we indicate which event will be triggered (postback) and which parameters should be transmitted to the server (source).  In the event (comment) function, we send the client code to add a comment at the bottom of the list.  While this comment does not reach other customers, but now we will fix it: <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(init)</span></span></span><span class="hljs-function"> -&gt;</span></span> wf:reg({post, post_id()}); event(comment) -&gt; wf:send({post, post_id()}, {client, wf:q(comment)}); event({client, Text}) -&gt; wf:insert_bottom(comments, #blockquote{body = #p{body = wf:html_encode(Text)}}).</code> </pre><br>  The init event is triggered when the page is loaded, and we register our process that it will receive messages from the {post, post_id ()} pool. <br><br>  Instead of displaying a comment in the event event (comment), we send a message with a new comment to the pool.  And we do output the comment in the event handler ({client, Text}).  Now we can have fun chatting in the chat under the post, and almost repeat the code that generated mad as the backbone of the application. <br><br>  In the next article, we will store posts and comments in the database, and add authorization through Facebook. </div><p>Source: <a href="https://habr.com/ru/post/273979/">https://habr.com/ru/post/273979/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273965/index.html">FactRuEval - a competition to select named entities and extract facts</a></li>
<li><a href="../273967/index.html">Using JMeter for distributed load organization</a></li>
<li><a href="../273971/index.html">Configuring Grandstream UCM 61xx series and its integration with 1C</a></li>
<li><a href="../273973/index.html">Overview of the office DECT-phone Unify OpenStage wl3 plus</a></li>
<li><a href="../273977/index.html">Lost art proof security. Part 2 of 2</a></li>
<li><a href="../273981/index.html">9 Tips for Localizing Audio</a></li>
<li><a href="../273983/index.html">12 Fractured Apps and Docker</a></li>
<li><a href="../273985/index.html">As we did on Unity, a game for adults and got an audience of "up to 10 years"</a></li>
<li><a href="../273987/index.html">Content Delivery Network: can not wait to download</a></li>
<li><a href="../273991/index.html">Open a new version of IDE CodinGame</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>