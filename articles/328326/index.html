<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android + Gradle + CI + CD or How to set up a cat feeder</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello dear reader. If you are unfamiliar with the concepts of Continuous Integration (CI), Continuous Delivery (CD) or you have no idea how and why th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android + Gradle + CI + CD or How to set up a cat feeder</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/482/5bd/f9e/4825bdf9e2e54ae4a259c6e656a2088e.png"><br><br>  Hello dear reader.  If you are unfamiliar with the concepts of Continuous Integration (CI), Continuous Delivery (CD) or you have no idea how and why they should be used, then I ask for a cat, where you can find a small description of how to configure these services in your Android project, as well as bonuses will be received in the end. <br><a name="habracut"></a><br>  <b>Introduction</b> <br><br>  Dear reader, if you think that there will be a lot of code in this article, then you are mistaken.  The code just we will have the minimum, but it will allow to show some possibilities of CI.  The main part of the article is how to configure bundles of services.  I hope for Junior / Middle developers this article will be very interesting and useful. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Prehistory</b> <br><br>  It all started with a startup.  We had quite good funding and plans for the next two years.  Two people worked on the android project.  Our methodology was similar to agile using gitflow.  After two months of development, the code was partially covered with tests, and the process for our small project seemed to be streamlined, but something did not give rest. <br><br>  I have an assumption that if you do not work in a large company, but work in a startup (of which there are countless), then you do not even think about the benefits of using CI CD services.  However, they will help you save time. <br><br>  I am a developer, so I will describe what is happening from this position. <br>  I think a situation in which a cat approaches you (by this word I understand absolutely any position of non-developers in your team who are asking for a product for QA) and asks to install the latest build on his phone.  At first, this is not perceived as a serious difficult task.  However, this creates the following problems: <br><br><ul><li>  Perhaps the most important thing is that you break away from the current task. </li><li>  Are you looking for the latest compiled apk </li><li>  Your latest compiled apk is your dev build, and you can't show it. </li><li>  You connect the cat's mobile phone through a cable and install the assembly </li><li>  And what if there are not zakomichichny changes in our current branch?  (commit -a \ stash to help, but still this time) </li><li>  You spend time returning to the task you performed. </li></ul><br>  This is just the tip of the iceberg.  And what if you have a lot of different cats?  You are starting to spend more and more time completing secondary tasks. <br><br>  Let's try to figure out a small example of how to save your and other people's time. <br><br>  Running a little ahead, I‚Äôll say that now, if it takes me more than one month to develop a project, I still set up Ci + Cd, which further leads to customer involvement and you will immediately receive feedback on development. <br><br>  <b>Goals</b> <br><br>  I was interested to build this article on the example of a queue of actions that we need to do to get the result.  And each goal is to allocate a separate commit.  I think it will be more interesting and easier to understand what is happening. <br><br>  So far, I see three main stages of ToDo: <br><br><ol><li>  Create project </li><li>  Configure CI </li><li>  Customize CD </li></ol><br>  Premature optimization is the root of all evil.  (Premature optimization. D. Knuth) <br><br>  <b>Create project</b> <br><br>  I think this stage will be the easiest.  Create a new <a href="https://github.com/vacxe/HabrCiCdCat">repository</a> on VCS (Github / Bitbucket).  I personally choose GitHub - just a matter of habit.  You can track all further changes by commits. <br><br>  Next, do the <a href="https://github.com/vacxe/HabrCiCdCat/commit/4358b7f8499313cc269c8a9e177815847808aa8b">first commit</a> <br><br>  Even if now we begin to do the development of a new fitch, and the cat comes up to us and asks for the latest build, we will have to roll back to the master head.  In general, we come to the problem. <br><br>  <b>Customize Ci</b> <br><br>  To send something to someone, you need to collect something somewhere.  And preferably with minimal abstraction from the main task of development. <br><br>  As a Ci service, I prefer <a href="http://circleci.com/">CircleCI</a> .  There are also <a href="https://travis-ci.org/">alternatives</a> and nobody forbids you to use more than one Ci service in your project. <br><br>  Our goal is to move in small steps, so we set ourselves a goal to simply run the build of the repository on Ci <br><br>  Let's start step by step: <br><br>  1. Log in to CiCircle via GitHub <br><br>  2. In the sidebar we find Project and go to our new project (if you click on the Build project, then the build will fail due to a non-customized project) <br><br><img src="https://habrastorage.org/web/b2f/3dd/83c/b2f3dd83c1164b12b2daf8692f3c905b.png"><br><br>  3. Go to the repository settings on GitHub in the Integrations &amp; services category and click Add Service <br><br>  4. Looking ahead, in the project settings on CiCircle I recommend to enable monitoring Pull request (PR), this will allow your colleagues not to merge non-working code into the master.  (Perhaps this is another one of my troubles, but I believe that the master branch should always be collected) <br><br><img src="https://habrastorage.org/web/8a0/e24/2cb/8a0e242cb83b4844afb3a94543883529.png"><br><br>  5. Perhaps the most important part on setting up Ci is setting up in your project. <br>  We need to make changes to build.gradle, add cicircle.gradle (essentially a template) and some circleci.yml (which carries the basic CI setting).  I am a supporter of making any changes to the master branch only through PR, so we create a branch with Ci presets and do PR. <br>  If everything was done correctly, then under PR we will see something similar <br><br><img src="https://habrastorage.org/web/f6a/c7f/8fd/f6ac7f8fd4da4725998793e2f7cd574f.png"><br><br>  And if we go to Ci, then we will see how our project is going <br>  After some time (usually the assembly takes no more than 5 minutes, we will most likely see a positive result) <br><br><img src="https://habrastorage.org/web/3a5/961/95e/3a596195e29940e5a0dd2cbbaa36987d.png"><br><br>  So you can continue, and feel free to click Merge!  (And on Ci, the master branch build will start) <br><br>  What are the advantages for ourselves? <br><br><ul><li>  Assembly occurs independently of us in the cloud </li><li>  Now, every time we do a PR, we know for sure if we will have an assembly.  This eliminates the opportunity to throw yourself problems with non-working builds from the wizard. </li><li>  It is possible to run tests </li></ul><br>  <b>Great, working on!</b> <br><br>  Once the build occurs in the cloud, it is logical to assume that there are some artifacts in the form of apk. <br><br>  It seems to me that a good goal for this iteration is to get apk, which could be put on the market.  Thus, at each assembly of the master branch (not PR), we get a ready-made product. <br><br>  1. To collect release.apk - we need to generate a signature key.  This is done once through Android Studio. <br><br>  2. Next, make changes to build.gradle <br><br><pre><code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">signingConfigs</span></span> { <span class="hljs-section"><span class="hljs-section">release</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">def</span></span> signFile = project.rootProject.file(<span class="hljs-string"><span class="hljs-string">'./release.keystore'</span></span>) if (signFile.exists()) { <span class="hljs-attribute"><span class="hljs-attribute">storeFile</span></span> signFile storePassword <span class="hljs-string"><span class="hljs-string">"qweqwe"</span></span> keyAlias <span class="hljs-string"><span class="hljs-string">"habrcicdcat"</span></span> keyPassword <span class="hljs-string"><span class="hljs-string">"qweqwe"</span></span> } } } buildTypes { <span class="hljs-section"><span class="hljs-section">release</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">minifyEnabled</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> proguardFiles getDefaultProguardFile(<span class="hljs-string"><span class="hljs-string">'proguard-android.txt'</span></span>), <span class="hljs-string"><span class="hljs-string">'proguard-rules.pro'</span></span> signingConfig signingConfigs.release } }</code> </pre> <br><br>  The release.keystore file is in the project folder. <br><br>  3. Create a bash script that will be responsible for transferring the collected file to the artifact directory <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#/bin/bash GRADLE="./gradlew" $GRADLE assembleRelease RELEASEFILE="${CIRCLE_ARTIFACTS}/habrcicdcat-release-${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1}.apk" cp ./app/build/outputs/apk/app-release.apk ${RELEASEFILE}</span></span></code> </pre> <br>  Constant data available by default. <br>  CIRCLE_BUILD_NUM - build number <br>  CIRCLE_SHA1 - commit key <br><br>  CIRCLE_ARTIFACTS - we install it in cicircle.yml <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">general:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">artifacts:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/home/ubuntu</span></span><span class="hljs-regexp"><span class="hljs-regexp">/HabrCiCdCat/app</span></span><span class="hljs-regexp"><span class="hljs-regexp">/build/outputs</span></span><span class="hljs-regexp"><span class="hljs-regexp">/apk/</span></span></code> </pre> <br>  4. Add to cicircle.yml the part responsible for deploymet <br><br><pre> <code class="hljs matlab">deployment: <span class="hljs-built_in"><span class="hljs-built_in">beta</span></span>: branch: master commands: - cd scripts &amp;&amp; ./build.sh</code> </pre><br>  Just run our script when the master branch changes <br><br>  5. We do PR in the master branch, we wait that everything gathers successfully, we execute merge.  If we go to the Ci console, we can see how the master branch started to assemble. <br><br><img src="https://habrastorage.org/web/176/0bd/d83/1760bdd837e3407cbf7521eaf383e79c.png"><br><br>  After some time, you will see that the build was successful.  Through the console in Ci, you can see the collected APK <br><br><img src="https://habrastorage.org/web/5aa/c07/f41/5aac07f413d34ce4a334ecc3d3fa3153.png"><br><br>  In fact, on this you can close the creation of apk.  We can download and immediately download the apk to the market or send it to our cats.  But something is still not enough.  The main goal of the article was not implemented, and we will still be detached from the current task.  A CD comes to the rescue. <br><br>  <b>Fabric Beta Setup</b> <br><br>  As a CD service, I will consider <a href="https://docs.fabric.io/apple/beta/overview.html">Beta</a> from Fabric.  Again, I note that there are many <a href="http://hockeyapp.net/">alternatives</a> , but the essence of the article is not in holivars but in the description of the process. <br><br>  So.  When the food for our cats is ready, it remains to bring it to them.  This helps us beta testing services. <br><br>  Start the setup: <br><br>  1. To begin, our project must register with Fabric, there are several ways, including adding a Fabric Plugin to Android Studio.  You need <a href="https://fabric.io/kits/android/crashlytics/install">to make</a> changes to the build.gra files.  After performing these operations in your console, a new application will appear in crashlitics. <br><br><img src="https://habrastorage.org/web/bfc/d9a/61e/bfcd9a61e7214e899a7dfbd4292305e5.png"><br><br>  2. In the Fabric account settings, you need to create a new organization, and get apiSecret and apiKey from it <br><br>  3. Start setting up the Beta service from Fabric <br><br>  First we need to create a group of testers and add at least ourselves and <br>  Here the main thing to remember Alias: habrcicdcat <br><br><img src="https://habrastorage.org/web/9b4/0e1/0a1/9b40e10a1e614e7a8fadc9ac19bd7266.png"><br><br>  and make a bunch of organizations and a group of testers <br><br><img src="https://habrastorage.org/web/30e/b17/107/30eb171078774cf9992171bb81445ea7.png"><br><br>  All testers from the group will receive a notification email that needs to be opened from the phone, and follow the link inside the letter to download or verify the Beta application. <br><br><img src="https://habrastorage.org/web/37d/352/801/37d352801d974edc8d870c548653c438.jpg"><br><br>  Next, we will start setting up the service and application bundles. <br><br>  Add Alias ‚Äã‚Äãto buildTypes <br><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">buildTypes</span></span> { <span class="hljs-section"><span class="hljs-section">release</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">minifyEnabled</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> proguardFiles getDefaultProguardFile(<span class="hljs-string"><span class="hljs-string">'proguard-android.txt'</span></span>), <span class="hljs-string"><span class="hljs-string">'proguard-rules.pro'</span></span> signingConfig signingConfigs.release ext.betaDistributionGroupAliases = <span class="hljs-string"><span class="hljs-string">"habrcicdcat"</span></span> } }</code> </pre> <br>  Add the fabric.properties to the app folder as follows (constants from p.2) <br><br> <code>apiSecret=23167a9cd00cb83f9dab952b47e7350e19dd7693071ceb2abe2d56dbfc6e1318 <br> apiKey=3915c7e9ffe661c44a4db3935d34a5a8da525b9c <br></code> <br><br>  Further, you can create a PR and watch the assembly master.  If everything went well then you will receive a notification in the Beta application, and you can download and install it. <br><br><img src="https://habrastorage.org/web/977/f26/eee/977f26eee169425baa27d4d16839994b.jpg"><br><br>  <b>Ultimate goal achieved</b> <br><br>  The goals set at the beginning of the article are fulfilled.  Now, with any change in the master branch, the application will be assembled, I send the apk to the group of cats.  And we always have at hand an assembly for publication. <br><br>  Now, when you will be torn from the workflow, you can always answer: ‚ÄúThe latest build is always available in Beta‚Äù - and as a side effect, you can safely continue to work on the current task. <br><br>  What is behind the scenes: <br><br><ul><li>  Build flavors (to show an example how to feed several cats) </li><li>  Possible problems when creating assemblies </li></ul><br>  In this article I wanted to show that setting up CI and CD is not so terrible, but extremely useful thing.  I do not consider it a problem to spend an hour to set up this system for freelancing projects because the benefit from it after 2 weeks will exceed this hour.  I hope this article will bring in your project CI and CD, or at least you would be interested. <br><br>  <a href="https://github.com/vacxe/HabrCiCdCat">Link to the GitHub project</a> where each iteration from this article is described step by step. </div><p>Source: <a href="https://habr.com/ru/post/328326/">https://habr.com/ru/post/328326/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328316/index.html">Ten examples of how not to write PAC files</a></li>
<li><a href="../328318/index.html">One company - one site?</a></li>
<li><a href="../328320/index.html">Java 9 exit postponed again</a></li>
<li><a href="../328322/index.html">How to get an offer on the day of the interview and not wait a hundred years</a></li>
<li><a href="../328324/index.html">Results of cyber activity in Q1 2017</a></li>
<li><a href="../328328/index.html">In Germany, hackers stole money from users' bank accounts using SS7 vulnerabilities</a></li>
<li><a href="../328330/index.html">Gameplay design: how it works in ‚Äúbig‚Äù games, and how to repeat it in indie terms</a></li>
<li><a href="../328332/index.html">Promotion of mobile games and applications in South Korea</a></li>
<li><a href="../328334/index.html">Precision timestamp</a></li>
<li><a href="../328336/index.html">A caring look at IT jobs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>