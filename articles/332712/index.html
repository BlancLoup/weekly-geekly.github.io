<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GitLab CI for continuous integration and delivery in production. Part 1: our pipeline</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, GitLab CI : what else can you tell about it? On Habr√© there are already articles about installation, about setting up runners, about command use, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GitLab CI for continuous integration and delivery in production. Part 1: our pipeline</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/ca1/fce/04e/ca1fce04e3314111ac634a3b5d8b8dec.png"><br><br>  So, <a href="https://docs.gitlab.com/ce/ci/">GitLab CI</a> : what else can you tell about it?  On Habr√© there are already articles about installation, about setting up runners, about command use, about GitLab Flow.  Perhaps, there are not enough descriptions of how GitLab CI is used in a real project, where several teams are involved.  And in the modern world of software development, this is true: there are (at least) developers, testers, DevOps and release engineers.  With a similar division into teams, we have been working for several years.  In this article, I will talk about how, using and improving the capabilities of GitLab CI, we have implemented and used in production for a team of several teams continuous integration processes (CI) and, in part, application delivery (CD). <a name="habracut"></a><br><br><h2>  Our pipeline </h2><br>  If you came across CI systems earlier, then the notion of pipeline is familiar to you - this is the sequence of performing the stages <i>(here and further in the article for the stage, I use the translation ‚Äústage‚Äù)</i> , each of which includes several tasks <i>(here and further in the article job - ‚Äú task ")</i> .  From the moment changes are made to the code to rollback into production, the application takes turns in the hands of various teams - similar to how it happens on the pipeline.  Hence the term pipeline <i>(‚Äúconveyor‚Äù is one of the literal translation options)</i> .  In our case, it looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/410/cb1/bbc/410cb1bbce304920b37c1d932d69f829.png"><br><br>  A brief explanation of the stages used: <br><br><ul><li>  <b>build</b> - build the application; </li><li>  <b>testing</b> - autotests; </li><li>  <b>staging</b> - application deployment for developers, DevOps, testers; </li><li>  <b>pre-production</b> - deployment to ‚Äúpre-production‚Äù for a team of testers; </li><li>  <b>approve</b> - ‚Äúfuse‚Äù, due to which the release engineer of the customer can refuse to deploy a certain tag in production; </li><li>  <b>production</b> - deployment to production. </li></ul><br>  <i><b>Note</b> : There is nothing completely universal, so this pipeline is probably not suitable for your particular case: it is either redundant or simple.</i>  <i>However, the purpose of the article is not to describe the only correct option suitable for everyone.</i>  <i>The goal is to give <b>an example</b> of how you can work in GitLab CI with several teams and what opportunities there are to implement such a pipeline.</i>  <i>Based on this information, you can develop your own GitLab CI configuration.</i> <br><br><h3>  How is it used? </h3><br>  I'll start with the story of the pipeline from the point of view of its use - what can be called a user story.  Here it turns out that in fact we have even two pipelines: shortened for branches and full for tags.  And this is what these sequences look like: <br><br><ol><li>  Developers put the application code in branches with the prefix <i>feature_</i> , and DevOps engineers put the infrastructure code in the branches with the prefix <i>infra_</i> .  Each git push to these branches starts the application build process ( <b>build</b> stage) and automated tests ( <b>testing</b> stage). </li><li>  Tasks at the next stages are not called automatically, but are defined as tasks with manual start (manual). </li><li>  At the <b>staging</b> stage, you can start a task and roll out a compiled and tested application to a simplified environment.  This can be done by developers, DevOps engineers, testers.  At the same time, in order to roll out on the environment of testers, all tests must be passed. </li><li>  After successfully passing the tests and rollout to one of the staging environments, you can roll out the application in <b>pre-production</b> - this is done only by testers, DevOps engineers, or release engineers. </li><li>  With the accumulation of successfully tested features, the release engineer prepares a new version and creates a <b>tag</b> in the repository.  A pipeline for a tag differs from a pipeline for a branch in two additional stages. </li><li>  After successful assembly, tests and roll-out in pre-production, additional manual tests of the new version, showing to the customer and other ‚Äúbullying‚Äù over the application are carried out.  If everything went well, the release engineer launches the <i><b>approve</b></i> task.  If something went wrong, the release engineer starts the task <i><b>not approve</b></i> . </li><li>  Rolling out the application in <b>production</b> is possible only after a successful rollout in the pre-production and the completion of the <i>approve</i> task.  A rollout on production can be launched by a release engineer or a DevOps engineer. </li></ol><br><img src="https://habrastorage.org/web/c95/20a/c29/c9520ac292814961a9e51480f99556b0.png"><br>  <i>The role of the release engineer in pipeline</i> <br><br><h3>  Pipeline and stages in detail </h3><br>  Tasks at the <b>build</b> stage <b>build the</b> application.  To do this, we use our own development - the Open Source- <a href="https://github.com/flant/dapp">dapp</a> utility <i>(read about its main features and see <a href="https://habrahabr.ru/company/flant/blog/324274/">this article + video</a> )</i> , which speeds up the incremental build well.  Therefore, the build starts automatically for branches with the prefixes <i>feature_</i> (application code), <i>infra_</i> (infrastructure code) and tags, and not just for several traditionally ‚Äúmaster‚Äù branches (master / develop / production / release). <br><br>  The next stage, <b>staging,</b> is a set of environments for developers, DevOps engineers, and testers.  Here, several tasks are announced that deploy applications from branches with the prefixes <i>feature_</i> and <i>infra_</i> in trimmed environments for quick testing of new functionality or infrastructure changes (the application build code is stored in the application repository). <br><br>  The <b>pre-production</b> and <b>production</b> stages are available only for tags.  Typically, the tag hangs after release engineers receive several merge requests from the tested branches.  In general, we can say that we use <a href="https://habrahabr.ru/company/softmart/blog/316686/">GitLab Flow</a> with the only difference that there is no <i>automatic</i> deployment to production and therefore there are no separate branches, but tags are used. <br><br>  The <b>approve</b> stage is two tasks: <i>approve</i> and <i>not approve</i> .  The first includes the ability to deploy to production, the second - off.  These tasks are to ensure that in case of problems in production it was clear that the deployment did not just happen, but with the consent of the release engineer.  However, the point is not in depriving someone of a premium, but in the fact that the release itself is often not carried out directly by the release engineer, but by the DevOps team.  The release engineer, running the <i>approve</i> task, thereby resolves to ‚Äúpush the button‚Äù of the <i>deploy to production</i> command to the DevOps team.  It can be said that this stage brings to the surface that which could remain in the postal correspondence or orally. <br><br>  Such an interaction scheme showed itself well in the work, but had to work hard to implement it.  As it turned out, GitLab CI does not support some of the necessary things out of the box ... <br><br><h2>  Development of .gitlab-ci.yml </h2><br>  After reviewing the documentation and various articles, you can quickly jot down <a href="">this version of .gitlab-ci.yml</a> , corresponding to the described stages of the pipeline: <br><br><pre><code class="hljs vhdl">stages: - build - testing - staging - preprod - approve - production ## build stage build: stage: build tags: [deploy] script: - echo <span class="hljs-string"><span class="hljs-string">"Build"</span></span> ## testing stage test unit: stage: testing tags: [deploy] script: - echo <span class="hljs-string"><span class="hljs-string">"test unit"</span></span> test integration: stage: testing tags: [deploy] script: - echo <span class="hljs-string"><span class="hljs-string">"test integration"</span></span> test selenium: stage: testing tags: [deploy] script: - echo <span class="hljs-string"><span class="hljs-string">"test selenium"</span></span> ## staging stage .staging-deploy: &amp;staging-deploy tags: [deploy] stage: staging <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: manual script: - echo $CI_BUILD_NAME deploy <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> dev-<span class="hljs-number"><span class="hljs-number">1</span></span>: &lt;&lt;: *staging-deploy deploy <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> dev-<span class="hljs-number"><span class="hljs-number">2</span></span>: &lt;&lt;: *staging-deploy deploy <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> devops-<span class="hljs-number"><span class="hljs-number">1</span></span>: &lt;&lt;: *staging-deploy deploy <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> devops-<span class="hljs-number"><span class="hljs-number">2</span></span>: &lt;&lt;: *staging-deploy deploy <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> qa-<span class="hljs-number"><span class="hljs-number">1</span></span>: &lt;&lt;: *staging-deploy deploy <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> qa-<span class="hljs-number"><span class="hljs-number">2</span></span>: &lt;&lt;: *staging-deploy ## preprod stage deploy <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> preprod: stage: preprod tags: [deploy] <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: manual script: - echo <span class="hljs-string"><span class="hljs-string">"deploy to preprod"</span></span> ## approve stage approve: stage: approve tags: [deploy] <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: manual script: - echo <span class="hljs-string"><span class="hljs-string">"APPROVED"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> approve: stage: approve tags: [deploy] <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: manual script: - echo <span class="hljs-string"><span class="hljs-string">"NOT APPROVED"</span></span> ## production stage deploy <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> production: stage: production tags: [deploy] <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: manual script: - echo <span class="hljs-string"><span class="hljs-string">"deploy to production!"</span></span></code> </pre> <br>  Everything is quite simple and most likely understandable.  The following directives are used for each task: <br><br><ul><li>  <code>stage</code> - defines the stage to which the task belongs; </li><li>  <code>script</code> - actions that will be performed when the task starts; </li><li>  <code>when</code> - type of the task ( <code>manual</code> means that the task will be launched from the pipeline manually); </li><li>  <code>tags</code> are tags that, in turn, determine on which runner the task will be launched. </li></ul><br>  <i><b>Note</b> : Runner is part of the GitLab CI, similar to other CI systems, i.e.</i>  <i>an agent that receives tasks from GitLab and executes their <code>script</code> .</i> <br><img src="https://habrastorage.org/web/547/647/3ac/5476473ac7674034a27196e7a6bf5ae3.png"><br>  <i>Slide Pro Runners from the <a href="http://www.slidedeck.io/codethebuild/slides">Coding the Next Build</a> Presentation (‚ìí 2016 Niek Palm)</i> <br><br>  By the way, have you noticed <a href="">this block</a> ? <br><br><pre> <code class="hljs perl">.staging-deploy: &amp;staging-deploy tags: [deploy] stage: staging <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: manual script: - echo $CI_BUILD_NAME</code> </pre> <br>  It demonstrates the ability of the YAML format to define common blocks and connect them to the right place at the right level.  See the <a href="https://docs.gitlab.com/ce/ci/yaml/README.html">documentation for</a> details. <br><br>  In the description of the pipeline, it was said that the <b>approve</b> and <b>production</b> stages are available only for tags.  In <code>.gitlab-ci.yml</code> this can be done using the <code>only</code> directive.  It defines the branches for which the pipeline will be created, and using the <code>tags</code> keyword you can allow the creation of a pipeline for tags.  Unfortunately, the <code>only</code> directive is only for tasks - it cannot be specified when describing the stage. <br><br>  Thus, tasks at the stages of <b>build</b> , <b>testing</b> , <b>staging</b> , <b>pre-production</b> , which should be available for the <i>infra_</i> , <i>feature_</i> branches and tags, take the following form: <br><br><pre> <code class="hljs mel">test <span class="hljs-keyword"><span class="hljs-keyword">unit</span></span>: stage: testing tags: [deploy] script: - echo <span class="hljs-string"><span class="hljs-string">"test unit"</span></span> only: - tags - /^infra_.*$/ - /^feature_.*$/</code> </pre> <br>  And the tasks in the <b>approve</b> and <b>production</b> stages, which are available only for tags, have the following form: <br><br><pre> <code class="hljs pgsql">deploy <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> production: stage: production tags: [deploy] script: - echo "deploy to production!" <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>: - tags</code> </pre> <br>  In the full version, the <code>only</code> directive is passed to the general block (an example of such <code>.gitlab-ci.yml</code> is available <a href="">here</a> ). <br><br><h2>  What's next? </h2><br>  On this, the creation of <code>.gitlab-ci.yml</code> for the described pipeline is inhibited because  GitLab CI does not provide directives, firstly, to separate tasks by users, and secondly, to describe the dependencies of performing tasks on the status of performing other tasks.  I would also like to allow only individual users to change <code>.gitlab-ci.yml</code> . <br><br>  Full implementation of the conceived became possible only thanks to several patches to GitLab and the use of task artifacts.  Read more about this in the next part of the article: ‚Äú <a href="https://habrahabr.ru/company/flant/blog/332842/"><b>GitLab CI for continuous integration and delivery in production.</b></a>  <a href="https://habrahabr.ru/company/flant/blog/332842/"><b>Part 2: Overcoming Difficulties</b></a> . ‚Äù </div><p>Source: <a href="https://habr.com/ru/post/332712/">https://habr.com/ru/post/332712/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332700/index.html">Quotes program data collection</a></li>
<li><a href="../332704/index.html">Announcement Heisenbag 2017 Moscow: Double the Benefit</a></li>
<li><a href="../332706/index.html">Translation of the Appium Essentials book. Chapter 4</a></li>
<li><a href="../332708/index.html">How does JVM allocate objects?</a></li>
<li><a href="../332710/index.html">Quick removal of spaces from lines on ARM processors</a></li>
<li><a href="../332714/index.html">Cipher Hila. Detailed analysis</a></li>
<li><a href="../332718/index.html">Android Architecture Components. Part 2. Lifecycle</a></li>
<li><a href="../332722/index.html">PLC from manufacturers Aries, Segnetics and Schneider Electric for HVAC</a></li>
<li><a href="../332724/index.html">Cost of quality in software development</a></li>
<li><a href="../332726/index.html">University or technical school: where to enter in order to successfully find a job and earn good money?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>