<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>EJTAG: an attraction for hackers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The black swift nanocomputer promotion campaign is in full swing (see also the publication on habrahabr ). black swift is based on SoC Atheros AR9331 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>EJTAG: an attraction for hackers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/21a/c34/40e/21ac3440e27a45ddbf7cec0de83fc104.jpg"><br><br>  The black swift nanocomputer promotion campaign is <a href="https://www.kickstarter.com/projects/1133560316/black-swift-tiny-wireless-computer">in full swing</a> (see also the <a href="http://habrahabr.ru/company/blackswift/blog/246673/">publication on habrahabr</a> ).  black swift is based on <a href="https://wikidevi.com/wiki/Atheros_AR9331">SoC Atheros AR9331</a> , which made it on the one hand tiny, inexpensive, and low-consuming, and on the other hand, the user has the MIPS 24Kc core operating at 400 MHz. <br>  Recently <a href="http://www.black-swift.ru/forum/suggestions/25-ispolzovanie-jtag-v-ustrojstve">a question was asked on the forum black-swift.ru</a> <br><blockquote>  There is a need for documentation on the use of the JTAG interface in the device.  Can we expect anything in this direction? <br></blockquote><br>  In this publication, I will <s>insert my five cents.</s> I‚Äôll give you a specific simple scenario of using the Atheros AR9331 SoT JTAG interface for debugging software. <br>  The publication may be of interest not only to software developers for the AR9331, but also to all those interested in in-circuit debugging on processors with MIPS architecture using free software. <br><a name="habracut"></a><br>  There is no black swift card in the public domain at the time of this writing, however, ready-made devices based on SoC Atheros AR9331 are available;  For the demonstration, I will use the <a href="http://www.tp-linkru.com/products/details/%3Fmodel%3DTL-MR3020">TP-Link MR3020</a> . <br>  The difference between the MR3020 and the black swift is minimal, moreover, the transition to the black swift who has mastered working with the MR3020 may even seem to be a relief: connecting to the external interfaces of the SoC will be easier, and there will be fewer software obstacles. <br>  Demonstration plan: we will stop the processor immediately after the start and launch on it, instead of the U-Boot boot loader installed in the ROM, another boot loader - <a href="http://www.barebox.org/">barebox</a> . <br>  What benefits (as applied to the MR3020) can be derived from using an EJTAG? <br><ul><li>  TP-Link guys put restrictions on making changes to the device firmware (although they didn‚Äôt try very hard) - the ability to use the EJTAG removes these restrictions; </li><li>  the ability to use the EJTAG immediately after the processor starts greatly simplifies debugging the initial stage of the barebox loader (indeed, it is much more comfortable to use the EJTAG than to bother with flashing the boot ROM on the programmer); </li><li>  EJTAG allows you to restore the device after ‚Äúscaling‚Äù as a result of damage to the contents of the boot ROM. </li></ul><br>  In order not to reach the presentation level ‚Äúdo it once, do two, press the button - you will get the result‚Äù I will try to give minimal explanations.  You should start by explaining what an EJTAG is. <br><br><h2>  EJTAG in MIPS architecture processors </h2><br>  Development of any software product does not do without a debugging stage, and happiness for a programmer if he has an intelligent debugger at his disposal. <br>  Software developers for * nix or Windows can use advanced debugging tools - you can run your program step by step, see the values ‚Äã‚Äãof variables at one time or another, set breakpoints. <br>  But how to be a software developer for an embedded system?  Such software can work outside the environment of any OS, and the embedded system itself is a little like a PC - as a rule, there is neither a keyboard nor a monitor. <br>  In order to somehow simplify life in the described situation, in-circuit debugging technology (in-circuit debugging) was invented, which is as follows: a special block is introduced into the processor (let's call it ‚Äúdebugging unit‚Äù), which monitors the process of executing instructions and able to influence him.  This block does not act by itself, but by the user's commands (which is the programmer who debugs the software).  The JTAG interface is often used for external control of this debugging unit. <br><blockquote>  Why choose JTAG?  JTAG is a serial bus (it is possible to use only 4 signals), allowing you to connect dozens of devices (possibly very different devices!) In a chain, and, as necessary, send commands to each of the devices.  JTAG is widely used for testing connections in printed circuit boards - currently, LSIs for any more or less non-trivial boards are connected in a JTAG chain.  It is quite reasonable to use JTAG not only for checking connections, but also for delivering debug control commands to the processor. <br></blockquote><br>  For MIPS processors, the standard is a set of hardware and software for in-circuit debugging called EJTAG.  The EJTAG is standardized in the MIPS EJTAG Specification;  there are several versions of this specification at once;  for example, the 24Kc processor core includes a debugging unit conforming to the EJTAG 2.60 specification. <br><blockquote>  Thus, do not mix JTAG and EJTAG: JTAG is a data interface;  EJTAG is a standard way for MIPS to perform in-circuit debugging using JTAG. <br></blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  What do you need to work with EJTAG? </h2><br><ol><li>  MIPS processor with EJTAG support (target English or target processor); </li><li>  Instrumental computer with which we will manage the target processor; </li><li>  A device that provides a computer connection to the JTAG interface (English dongle); </li><li>  Software that runs on an instrumental computer receives instructions from the user to control the target processor, and through the dongle sends the necessary commands to the target processor. </li></ol><br>  Immediately, we note that the user does not need in-depth knowledge of the organization of the EJTAG, instructions for controlling the target processor are completely abstract, for example: <br><ul><li>  stop the execution of instructions by the processor; </li><li>  start the execution of instructions from the address of such and such; </li><li>  execute one instruction and stop; </li><li>  view the contents of the processor registers. </li></ul><br>  For our demonstration, we will use: <br><ol><li>  EJTAG processor - MIPS 24Kc from SoC Atheros AR9331; </li><li>  instrumental computer - PC with x86 / amd64 processor running Debian Linux OS (although other Linux OSs will work too); </li><li>  JTAG dongle - breadboard with FT2232H microcircuit (namely, <a href="http://microsin.net/adminstuff/hardware/ft2232h-board.html">microsin.net/adminstuff/hardware/ft2232h-board.html</a> ) (hereinafter simply a layout); </li><li> Management software for AR9331 via EJTAG - <code>openocd</code> (http://openocd.sourceforge.net/). </li></ol><br>  In addition, it is very desirable to connect also to the UART AR9331 interface, it is useful for interacting with programs running on the processor (without connecting to the UART, the demonstration would be rather boring).  To send and receive symbols in the UART AR9331, use the <code>minicom</code> program. <br>  Layout FT2232H provides connectivity immediately to both the UART and JTAG. <br><blockquote>  A command line interface will be used to interact with the instrumental computer, so prepare your terminals. <br></blockquote><br><br><h2>  Connecting the FT2232H layout to the MR3020 </h2><br>  Here is the wiring diagram (see also the <a href="https://wikidevi.com/wiki/TP-LINK_TL-MR3020">article on wikidevi.com</a> ): <br><br><img src="https://habrastorage.org/files/5f3/dd4/74f/5f3dd474f11d4696892a85bf2a73e7c7.png"><br><br><blockquote>  Someone such a connection scheme JTAG seem barbaric, but in our simple situation, it is quite justified. <br></blockquote><br>  Appearance of the MR3020 with the FT2232H breadboard connected: <br><img src="https://habrastorage.org/files/de6/6a7/9b4/de66a79b429e4d8c95c8b858816b1fb0.jpg"><br><br><h2>  Connect to UART </h2><br>  The output of the UART interface from the MR3020 is not a problem: the board already has holes for soldering pins. <br><br><img src="https://habrastorage.org/files/786/f15/79e/786f1579e47044b28362e1b6e8a35400.jpg"><br><br>  The TX and RX designations in the photograph are from the point of view of AR9331, i.e.  TX AR9331 (pin 1 on board) must be connected to the RX FT2232 (BDBUS1). <br>  I recommend to connect the UART MR3020 to the breadboard, and the breadboard itself to the instrumental computer, and then, turning on the power of the MR3020, to observe the messages of the regular U-Boot loader using <code>minicom</code> . <br>  This is what you need to do in a number of steps. <br><br><h3>  Checking the connection of the layout to the instrumental computer </h3><br>  Connect the UART MR3020 to the breadboard;  connect the FT2232H breadboard to the instrumental computer via USB;  on the instrumental computer in the command line, run dmesg - make sure that messages like <br><pre> <code class="hljs pgsql">[<span class="hljs-number"><span class="hljs-number">1573965.608101</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> high-speed USB device number <span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ehci-pci [<span class="hljs-number"><span class="hljs-number">1573965.740851</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> USB device <span class="hljs-built_in"><span class="hljs-built_in">found</span></span>, idVendor=<span class="hljs-number"><span class="hljs-number">0403</span></span>, idProduct=<span class="hljs-number"><span class="hljs-number">6010</span></span> [<span class="hljs-number"><span class="hljs-number">1573965.740862</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> USB device strings: Mfr=<span class="hljs-number"><span class="hljs-number">1</span></span>, Product=<span class="hljs-number"><span class="hljs-number">2</span></span>, SerialNumber=<span class="hljs-number"><span class="hljs-number">0</span></span> [<span class="hljs-number"><span class="hljs-number">1573965.740868</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Product: Dual RS232-HS [<span class="hljs-number"><span class="hljs-number">1573965.740874</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Manufacturer: FTDI [<span class="hljs-number"><span class="hljs-number">1573965.741737</span></span>] ftdi_sio <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>:<span class="hljs-number"><span class="hljs-number">1.0</span></span>: FTDI USB <span class="hljs-type"><span class="hljs-type">Serial</span></span> Device converter detected [<span class="hljs-number"><span class="hljs-number">1573965.741938</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Detected FT2232H [<span class="hljs-number"><span class="hljs-number">1573965.741948</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> endpoints <span class="hljs-number"><span class="hljs-number">2</span></span> [<span class="hljs-number"><span class="hljs-number">1573965.741957</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Endpoint <span class="hljs-number"><span class="hljs-number">1</span></span> MaxPacketSize <span class="hljs-number"><span class="hljs-number">512</span></span> [<span class="hljs-number"><span class="hljs-number">1573965.741966</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Endpoint <span class="hljs-number"><span class="hljs-number">2</span></span> MaxPacketSize <span class="hljs-number"><span class="hljs-number">512</span></span> [<span class="hljs-number"><span class="hljs-number">1573965.741974</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Setting MaxPacketSize <span class="hljs-number"><span class="hljs-number">512</span></span> [<span class="hljs-number"><span class="hljs-number">1573965.742920</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: FTDI USB <span class="hljs-type"><span class="hljs-type">Serial</span></span> Device converter now attached <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ttyUSB0 [<span class="hljs-number"><span class="hljs-number">1573965.743493</span></span>] ftdi_sio <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>:<span class="hljs-number"><span class="hljs-number">1.1</span></span>: FTDI USB <span class="hljs-type"><span class="hljs-type">Serial</span></span> Device converter detected [<span class="hljs-number"><span class="hljs-number">1573965.743662</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Detected FT2232H [<span class="hljs-number"><span class="hljs-number">1573965.743672</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> endpoints <span class="hljs-number"><span class="hljs-number">2</span></span> [<span class="hljs-number"><span class="hljs-number">1573965.743681</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Endpoint <span class="hljs-number"><span class="hljs-number">1</span></span> MaxPacketSize <span class="hljs-number"><span class="hljs-number">512</span></span> [<span class="hljs-number"><span class="hljs-number">1573965.743690</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Endpoint <span class="hljs-number"><span class="hljs-number">2</span></span> MaxPacketSize <span class="hljs-number"><span class="hljs-number">512</span></span> [<span class="hljs-number"><span class="hljs-number">1573965.743699</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: Setting MaxPacketSize <span class="hljs-number"><span class="hljs-number">512</span></span> [<span class="hljs-number"><span class="hljs-number">1573965.744669</span></span>] usb <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span>: FTDI USB <span class="hljs-type"><span class="hljs-type">Serial</span></span> Device converter now attached <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ttyUSB1</code> </pre><br>  From this message, it follows that two new serial interfaces <code>/dev/ttyUSB0</code> and <code>/dev/ttyUSB1</code> have appeared on the instrumental computer.  In accordance with the connection scheme to the UART MR3020, the second of the two interfaces is connected, that is <code>/dev/ttyUSB1</code> . <br><br><h3>  Install and configure <code>minicom</code> </h3><br>  Installing the <code>minicom</code> program on Debian-based distributions is very simple: <br><pre> <code class="bash hljs">$ sudo apt-get install minicom</code> </pre><br><br>  The <code>minicom</code> program is very kind to the beginner - all settings can be made through the menu, however this kindness has a downside - it is rather inconvenient to explain exactly how to set the necessary settings. <br>  In order not to get involved with the <code>minicom</code> menu system, we will proceed more easily - we will make the settings using the configuration file.  For simplicity, we will create a global configuration file, for this we will execute as root: <br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># cat </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt;EOF &gt;</span></span></span><span class="hljs-meta"> /etc/minicom/minirc.USB1 pu port /dev/ttyUSB1 pu baudrate 115200 pu escape-key ^B pu rtscts No EOF</span></span></code> </pre><br><blockquote>  Note to non-Debian distribution users: the <code>minicom</code> configuration files may be located in a location other than <code>/etc/minicom/</code> . <br></blockquote><br>  The specified configuration file tells <code>minicom</code> 'y that deviations from the default settings are as follows: <br><ol><li>  port / dev / ttyUSB1 is used; </li><li>  configure port speed 115200; </li><li>  Minicom command start key - ctrl-b;  for example, to call the main menu, press ctrl-b, then z; </li><li>  hardware flow control is disabled (indeed, for the connection we used only the RX and TX lines, which hardware flow control is already there). </li></ol><br><h3>  Launch <code>minicom</code> </h3><br>  For simplicity, run <code>minicom</code> as root; <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># minicom USB1</span></span></code> </pre><br>  At the same time, <code>minicom</code> uses the settings from the <code>/etc/minicom/minirc.USB1</code> file (unless the <code>~/.minirc.USB1</code> file exists). <br><blockquote>  Of course, it is more competent to add your user to the dialout group ...;  but let's not complicate things. <br></blockquote><br>  Now we turn on the power of the MR3020 and see in the <code>minicom</code> messages from the U-Boot: <br><pre> <code class="hljs go">U-Boot <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> (Aug <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span> - <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>) AP121 (ar9330) U-boot DRAM: <span class="hljs-number"><span class="hljs-number">32</span></span> MB led turning on <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">1s</span></span>... id read <span class="hljs-number"><span class="hljs-number">0x100000ff</span></span> flash size <span class="hljs-number"><span class="hljs-number">4194304</span></span>, sector count = <span class="hljs-number"><span class="hljs-number">64</span></span> Flash: <span class="hljs-number"><span class="hljs-number">4</span></span> MB Using <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> environment</code> </pre><br>  Next will be given messages about loading linux, but they are not very interesting to us;  If any reasonable output from the UART arrives, then you can proceed to connecting the JTAG. <br><br><h2>  Connect to JTAG </h2><br>  Connecting to JTAG is not trivial, but possible.  See the <a href="https://wikidevi.com/wiki/TP-LINK_TL-MR3020">article on wikidevi.com</a> . <br>  In addition to the four lines of JTAG, you must also ensure that the boot ROM is turned off;  In an article on wikidevi.com for this, it is proposed to break the ChipSelect line with a jumper (jumper).  The fact is that the regular U-boot bootloader, located in the ROM, almost immediately after the start blocks the operation of JTAG. <br>  In the case of the start of the processor with a non-working ROM, nothing terrible will happen, the processor will perform ‚Äúgarbage‚Äù instead of the program from the ROM.  The processor will fall into a difficult situation, but the EJTAG will remain available. <br>  After all the JTAG lines have been connected to the corresponding FT2232H pins, and the boot ROM is disabled, you can try scanning the JTAG chain using <code>openocd</code> .  But before you start <code>openocd</code> , you have to install and configure it ... <br>  Installing the <code>openocd</code> program is as <code>openocd</code> installing <code>minicom</code> : <br><pre> <code class="bash hljs">$ sudo apt-get install openocd</code> </pre><br><br><h2>  openocd: initial setup </h2><br>  <code>openocd</code> has a built-in tcl language, all scripts and configuration files are written on it.  However, for our simplest case, the configuration file will be quite simple. <br>  Create a file <code>ft2232h-scan.cfg</code> , in which we indicate <code>openocd</code> that we will use an FT2232H-based dongle to access the JTAG: <br><pre> <code class="hljs kotlin">$ cat &lt;&lt;EOF &gt; ft2232h-scan.cfg <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ftdi</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ftdi_vid_pid</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x0403</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x6010</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ftdi_layout_init</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x0018</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x05fb</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">adapter_khz</span></span></span><span class="hljs-class"> 100 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shutdown</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EOF</span></span></span></span></code> </pre><br><br>  In this file, we indicate that to connect to the JTAG we will use the ftdi ‚Äúdriver‚Äù, which serves all the numerous dongles based on the FT2232H.  The ftdi_vid_pid option specifies the Vendor ID and Device ID of the FT2232H chip on the USB bus (by default, this is just 0x0403 0x6010; these IDs were in the <code>dmesg</code> output, you can view them at any time using the <code>lsusb</code> program).  The ftdi_layout_init option specifies the settings for the GPIO outputs of the FT2232H.  The adapter_khz option specifies the maximum JTAG clock frequency;  100 kHz (low frequency) is well suited for scanning. <br>  The shutdown directive will force <code>openocd</code> to shut down immediately after a JTAG scan. <br>  Let's run <code>openocd</code> as root (Warning: <code>openocd</code> should be <code>openocd</code> after powering on the MR3020, and the SW2 button on the MR3020 must be pressed at the time of power-on; also remember to lock the boot ROM): <br><pre> <code class="hljs pgsql"># openocd -f ft2232h-scan.cfg <span class="hljs-keyword"><span class="hljs-keyword">Open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">On</span></span>-Chip Debugger <span class="hljs-number"><span class="hljs-number">0.8</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> (<span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-20</span></span><span class="hljs-number"><span class="hljs-number">-22</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>) Licensed under GNU GPL v2 <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> bug reports, <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> http://openocd.sourceforge.net/doc/doxygen/bugs.html <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> one transport <span class="hljs-keyword"><span class="hljs-keyword">option</span></span>; autoselect <span class="hljs-string"><span class="hljs-string">'jtag'</span></span> adapter speed: <span class="hljs-number"><span class="hljs-number">100</span></span> kHz shutdown command invoked <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : clock speed <span class="hljs-number"><span class="hljs-number">100</span></span> kHz Warn : There are <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> enabled taps. AUTO PROBING MIGHT <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WORK</span></span>!! Warn : AUTO auto0.tap - use "jtag newtap auto0 tap -expected-id 0x00000001 ..." Warn : AUTO auto0.tap - use "... -irlen 5" Warn : gdb services need one <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more targets defined</code> </pre><br>  In this conclusion, the lines containing <code>AUTO auto0.tap</code> deserve the most attention - they contain information about the JTAG subscribers found (tap controllers), and an example of the line that should be entered into the <code>openocd</code> configuration file to work with a freshly detected tap controller is immediately given. <br>  We use these lines and create a configuration file for <code>openocd</code> , which will ensure that the <code>openocd</code> image is loaded into RAM. <br>  But before loading the image of a barebox, you need to take it somewhere;  and since there are no ready-made suitable images anywhere, it will collect the image independently from the source code. <br><br><h3>  Build barebox </h3><br>  The AR9331 barebox image should consist of MIPS32 processor instructions, and our instrumental computer is almost certainly built on the basis of a processor with the x86 or amd64 command system (as they are called Debian, anyway). <br>  In order to generate MIPS32 instructions using an x86 / amd64 processor, we need a cross-compiler (that is, a compiler that runs on a computer with one instruction architecture, and generates code for a computer with another instruction set). <br>  Building a cross-compiler with the required properties is not a trivial task at all, and to facilitate it, many different tools have been created that are known for the keywords buildroot, openwrt, crosstool-ng. <br>  However, in this demonstration we will go easy - download the ready-made cross-compiler from MentorGraphics. <br>  So, download and unpack the ready-made cross-compiler in / opt: <br><pre> <code class="bash hljs">$ wget http://sourcery.mentor.com/public/gnu_toolchain/mips-linux-gnu/mips-2014.11-22-mips-linux-gnu-i686-pc-linux-gnu.tar.bz2 $ sudo tar fx mips-2014.11-22-mips-linux-gnu-i686-pc-linux-gnu.tar.bz2 -C /opt</code> </pre><br>  As a result, for example, the path to the C cross-compiler will be: / <code>/opt/mips-2014.11/bin/mips-linux-gnu-gcc</code> / <code>/opt/mips-2014.11/bin/mips-linux-gnu-gcc</code> / <code>/opt/mips-2014.11/bin/mips-linux-gnu-gcc</code> / <code>/opt/mips-2014.11/bin/mips-linux-gnu-gcc</code> / <code>/opt/mips-2014.11/bin/mips-linux-gnu-gcc</code> . <br>  Now download and unpack the source files of the barebox loader: <br><pre> <code class="bash hljs">$ wget http://barebox.org/download/barebox-2015.01.0.tar.bz2 $ tar fx barebox-2015.01.0.tar.bz2</code> </pre><br>  Build the barebox: <br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> barebox-2015.01.0 $ make ARCH=mips tplink-mr3020_defconfig $ make ARCH=mips CROSS_COMPILE=/opt/mips-2014.11/bin/mips-linux-gnu- $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ..</code> </pre><br>  If everything went well, we will get the file <code>barebox-2015.01.0/barebox.bin</code> . <br><br><h2>  openocd: more complete setup </h2><br>  Now we have what we can load in the RAM MR3020;  paradoxically, but we do not have the RAM itself! <br>  The fact is that when we have disabled the boot ROM with it, we have disabled the initial initialization of the AR9331 hardware, including the initialization of the RAM controller and the UART controller, in order to preserve the efficiency of the EJTAG. <br>  Fortunately, the <a href="https://wikidevi.com/wiki/TP-LINK_TL-MR3020">sequence of entries in the registers for the initialization of the equipment is</a> already known. <br>  Finally, the file <code>ft2232h-mr3020.cfg</code> , which will connect the AR9331 debug unit, initialize the hardware, load the <code>barebox.bin</code> image <code>barebox.bin</code> RAM at <code>0xa0100000</code> and launch it for execution: <br><pre> <code class="hljs sql">interface ftdi ftdi_vid_pid 0x0403 0x6010 ftdi_layout_init 0x0018 0x05fb adapter_khz 600 jtag newtap auto0 tap -expected-id 0x00000001 -irlen 5 target <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> auto0.tap mips_m4k -<span class="hljs-keyword"><span class="hljs-keyword">endian</span></span> <span class="hljs-keyword"><span class="hljs-keyword">big</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">position</span></span> auto0.tap init halt <span class="hljs-comment"><span class="hljs-comment"># pll initialization mww 0xb8050008 0x00018004 mww 0xb8050004 0x00000352 mww 0xb8050000 0x40818000 mww 0xb8050010 0x001003e8 mww 0xb8050000 0x00818000 mww 0xb8050008 0x00008000 sleep 1 # Setup DDR1 config and flash mapping mww 0xb8000000 0x7fbc8cd0 mww 0xb8000004 0x9dd0e6a8 mww 0xb8000010 0x8 mww 0xb8000008 0x133 mww 0xb8000010 0x1 mww 0xb800000c 0x2 mww 0xb8000010 0x2 mww 0xb8000010 0x8 mww 0xb8000008 0x33 mww 0xb8000010 0x1 mww 0xb8000014 0x4186 mww 0xb800001c 0x8 mww 0xb8000020 0x9 mww 0xb8000018 0xff # UART mww 0xb8020004 0x4388 mww 0xb8020008 0xc2000 # GPIO mww 0xb8040028 0x48002 load_image barebox-2015.01.0/barebox.bin 0xa0100000 bin resume 0xa0100000 shutdown</span></span></code> </pre><br><blockquote>  In openocd, a fairly reasonable practice is adopted, in which the description of the dongl, the description of the target processor, and the current debugging script are usually placed in different files, but in this publication we will not do this to simplify the presentation. <br></blockquote><br><br><h2>  openocd: loading barebox </h2><br>  So, load and run barebox (Do not forget about the ROM shutdown jumper. Also, do not forget to hold down the SW2 button while turning on the power of the MR3020! Be patient - loading takes more than 100 seconds): <br><pre> <code class="hljs pgsql"># openocd -f ft2232h-mr3020.cfg <span class="hljs-keyword"><span class="hljs-keyword">Open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">On</span></span>-Chip Debugger <span class="hljs-number"><span class="hljs-number">0.8</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> (<span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-20</span></span><span class="hljs-number"><span class="hljs-number">-22</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>) Licensed under GNU GPL v2 <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> bug reports, <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> http://openocd.sourceforge.net/doc/doxygen/bugs.html <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> one transport <span class="hljs-keyword"><span class="hljs-keyword">option</span></span>; autoselect <span class="hljs-string"><span class="hljs-string">'jtag'</span></span> adapter speed: <span class="hljs-number"><span class="hljs-number">600</span></span> kHz <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : clock speed <span class="hljs-number"><span class="hljs-number">600</span></span> kHz <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> : JTAG tap: auto0.tap tap/device <span class="hljs-built_in"><span class="hljs-built_in">found</span></span>: <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> (mfg: <span class="hljs-number"><span class="hljs-number">0x000</span></span>, part: <span class="hljs-number"><span class="hljs-number">0x0000</span></span>, ver: <span class="hljs-number"><span class="hljs-number">0x0</span></span>) target state: halted target halted <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MIPS32 mode due <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>-request, pc: <span class="hljs-number"><span class="hljs-number">0xb0ddd068</span></span> Error: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> working memory available. Specify -<span class="hljs-keyword"><span class="hljs-keyword">work</span></span>-area-phys <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> target. Warn : <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> enough working area available(requested <span class="hljs-number"><span class="hljs-number">128</span></span>) Error: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> working area available Warn : Falling back <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> non-bulk <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-number"><span class="hljs-number">185568</span></span> bytes written at address <span class="hljs-number"><span class="hljs-number">0xa0100000</span></span> downloaded <span class="hljs-number"><span class="hljs-number">185568</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">102.970634</span></span>s (<span class="hljs-number"><span class="hljs-number">1.760</span></span> KiB/s) shutdown command invoked</code> </pre><br>  After the <code>openocd</code> working in the <code>minicom</code> window, we can observe messages about the start of the barebox: <br><pre> <code class="hljs mel">barebox <span class="hljs-number"><span class="hljs-number">2015.01</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> #<span class="hljs-number"><span class="hljs-number">1</span></span> Thu Jan <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span> MSK <span class="hljs-number"><span class="hljs-number">2015</span></span> Board: TP-LINK MR3020 m25p80 m25p80@00: unrecognized JEDEC id <span class="hljs-number"><span class="hljs-number">900040</span></span> m25p80 m25p80@00: probe failed: No such device malloc space: <span class="hljs-number"><span class="hljs-number">0xa0400000</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">0xa07fffff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> MiB) environment load /dev/env0: No such <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> or directory running /<span class="hljs-keyword"><span class="hljs-keyword">env</span></span>/bin/init... /<span class="hljs-keyword"><span class="hljs-keyword">env</span></span>/bin/init not found barebox:/</code> </pre><br>  Then anyone can play with the barebox commands, the list of which opens with the help command. <br>  Pay attention to the <code>probe failed: No such device</code> error message, it appeared due to the fact that barebox tried to ‚Äúgrope‚Äù the boot ROM on the SPI bus.  But since the boot ROM was disabled to revive the EJTAG, an attempt by barebox to find anything was doomed to failure. <br>  If you manage to put on a jumper that disconnects the boot ROM when the barebox is loaded into memory, you can instead <br><pre> <code class="hljs objectivec">m25p80 m25p80@<span class="hljs-number"><span class="hljs-number">00</span></span>: unrecognized JEDEC <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-number"><span class="hljs-number">900040</span></span></code> </pre><br>  observe more optimistic <br><pre> <code class="hljs perl">m25p8<span class="hljs-number"><span class="hljs-number">0</span></span> m25p8<span class="hljs-number"><span class="hljs-number">0</span></span>@00: s25sl032p (<span class="hljs-number"><span class="hljs-number">4096</span></span> Kbytes)</code> </pre><br><br>  Although barebox-2015.01.0 supports SoC AR9331 hardware in the minimum amount (USB and Ethernet interfaces are not supported), but barebox can read and write the boot ROM. <br><br><h3>  What's next?  (instead of epilogue) </h3><br>  Loading data into RAM is not the limit of EJTAG capabilities.  But it is impossible to grasp the immensity - the publication does not cover the issues of debugging itself - this material remains for future publications. <br>  Legal indignation causes a low data transfer rate - less than 2 KB in a second, this moment should also be tried to be corrected. <br><br><h3>  Thanks </h3><br>  The author is grateful to the people, without whose participation this publication would hardly have been possible: <br><ul><li>  Alexey Rempel, who mastered connecting to the JTAG MR3020 and <a href="https://wikidevi.com/wiki/TP-LINK_TL-MR3020">published his notes</a> ; <br></li><li>  Alexei Sokolov, who absolutely perfectly soldered the wires to the board resistors of my copy of the MR3020; <br></li><li>  Petr Mamonov, for explaining to me the details of the work of the EJTAG and the various dongles. <br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/375995/">https://habr.com/ru/post/375995/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../375979/index.html">Intellectual Toys: Instructions for Parents</a></li>
<li><a href="../375985/index.html">Unreal Engine 4 achieved photorealism</a></li>
<li><a href="../375987/index.html">Amazon launches enterprise service that will compete with Microsoft and Google</a></li>
<li><a href="../375989/index.html">Mechanical hand will teach you to draw</a></li>
<li><a href="../375991/index.html">Cyanogen received $ 70 million from Microsoft, one of the goals is to reduce Google‚Äôs control over Android</a></li>
<li><a href="../375997/index.html">Cult of Razer: Kraken headsets</a></li>
<li><a href="../375999/index.html">Lenovo announces price cuts for budget smartphones in Russia</a></li>
<li><a href="../376001/index.html">Samsung has registered a patent for the automatic update of the phone book</a></li>
<li><a href="../376003/index.html">How 3D printing is embedded in the production process</a></li>
<li><a href="../376005/index.html">Introducing the new generation of Intel SSD for data centers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>