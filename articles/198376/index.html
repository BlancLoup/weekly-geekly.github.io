<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to stop being afraid and fall in love with frequent releases</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I must say that, in principle, developers tend not to pay attention to such trifles as tests and warmth. And the situation in the picture below is not...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to stop being afraid and fall in love with frequent releases</h1><div class="post__text post__text-html js-mediator-article">  I must say that, in principle, developers tend not to pay attention to such trifles as tests and warmth.  And the situation in the picture below is not even a joke, but the situation is witnesses, I think there were many. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/53b/842/279/53b842279b4ae1bee1c748e9c90f11f5.jpg" alt="image"><br><br>  I'll tell you a little about the development at my current place of work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  We use a flexible development methodology ( <a href="http://ru.wikipedia.org/wiki/%25D0%2593%25D0%25B8%25D0%25B1%25D0%25BA%25D0%25B0%25D1%258F_%25D0%25BC%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D1%258F_%25D1%2580%25D0%25B0%25D0%25B7%25D1%2580%25D0%25B0%25D0%25B1%25D0%25BE%25D1%2582%25D0%25BA%25D0%25B8">Agile</a> ), and at first we practiced <a href="http://ru.wikipedia.org/wiki/Scrum">Scrum</a> , and now we are working on <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B0%25D0%25BD%25D0%25B1%25D0%25B0%25D0%25BD">Kanban</a> .  Initially, I myself was quite skeptical about such an event, but literally after a couple of weeks I was convinced that it was working. <br><br>  The description of such development processes is a topic of a big post, maybe even not one, besides, there is a large amount of literature on the net, so I will not tell here what it is, I will limit myself to the fact that these methodologies require frequent releases, in case of a scram release occurs after the iteration is completed (the iteration time is selected by the team itself and usually takes 1 to 3 weeks), in the case of kanban, the feature is launched into production immediately after it has been done (well, tested, of course). <br><br>  Frequent releases are not just good, they are great: a streamlined and frequent release process saves the developer from the fear of updates, and the customer sees progress. <br><br>  This development process superimposes perfectly on Continuous Integration.  Books are also written about him and long articles, in brief, this is the execution of frequent automated project builds for the early detection and solution of integration problems ( <a href="http://ru.wikipedia.org/wiki/%25D0%259D%25D0%25B5%25D0%25BF%25D1%2580%25D0%25B5%25D1%2580%25D1%258B%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D0%25B3%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">wikipedia</a> ). <br><br>  We develop a distributed system, we use perl as our backend (API), client code is written in javascript, and <a href="http://jenkins-ci.org/">jenkins ci</a> is <a href="http://jenkins-ci.org/">used</a> as a continuous integration server. <br><br>  For those who are not familiar with it, I will explain on fingers what jenkins is: this is a service with a web interface where tasks for building are configured.  The task is a step-by-step instruction that the server must execute to build any package, in our case it is rpm.  For example, it usually happens like this: <br><br><ul><li>  checkout from VCS (version control systems); </li><li>  run tests; </li><li>  compile and build the necessary file structure; </li><li>  pack into an rpm file; </li><li>  put in repository. </li></ul><br>  Creating an rpm package requires writing a <a href="http://www.rpm.org/max-rpm/s1-rpm-build-creating-spec-file.html">spec file</a> , which is also a set of instructions for building and installing the package on the target machine. <br><br>  So: there is a CI server on which the rpm package is built, the package then goes to the yum repository, and there is a destination server or cluster of servers on which this package is installed. <br><br>  In our project we use modules with CPAN - code reuse is good, but it entails some overhead, for which many people dislike perl. <br><br><h5>  Dependencies </h5><br>  Consider an example: we needed to use a certain hash algorithm, a rather trivial task, take the module on the CPAN and set it in our developer environment: <br><br><pre><code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">cpanm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Some</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::CPAN</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::Module</span></span></code> </pre> <br>  after which we write the code: <br><br><pre> <code class="perl hljs"> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Some::CPAN::Module; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encrypt</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $string = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Some::CPAN::Module::mkHash($string); }</code> </pre><br>  and cover it with dough: <br><br><pre> <code class="perl hljs"> ok(encrypt(<span class="hljs-string"><span class="hljs-string">"test"</span></span>) eq Some::CPAN::Module::mkHash(<span class="hljs-string"><span class="hljs-string">"test"</span></span>), <span class="hljs-string"><span class="hljs-string">"encrypt function"</span></span>);</code> </pre><br>  the code works, is covered with dough, we are very happy with ourselves.  We commit it and tries to assemble the package.  The build is tuned in our minds: at the assembly stage of the package, unit-tests are run, which is very convenient: if they do not pass tests, it means bad code, there is no sense to assemble further. <br><br>  And then the trouble: the test fails - on the assembly server there is no necessary module. <br><br>  Or another situation: we do not have tests, and this code leaves the package in the repository and we get a non-starting service, but already on the production server, where the error is much more difficult to catch. <br><br>  To build and pass tests, add a dependency to the spec file: <br><br><pre> <code class="hljs pgsql"> BuildRequires: perl-<span class="hljs-keyword"><span class="hljs-keyword">Some</span></span>-CPAN-Module</code> </pre><br>  To deploy to the destination server, add: <br><br><pre> <code class="hljs pgsql"> Requires: perl-<span class="hljs-keyword"><span class="hljs-keyword">Some</span></span>-CPAN-Module</code> </pre><br>  If you are lucky, then the desired rpm is already in the yum repository, if not, you need to build the package and place it in the yum repository. <br><br>  So, the package in the repository is placed on the build / production server, but one problem, it has a different version: during the time we wrote the code and tests, the author of the module fixed the critical vulnerability in his module and released a new version, which suddenly for some reason became incompatible with the previous one, the test still fails, the assembly failits, the service does not start. <br><br>  Solution: find out the version of the module with which our code works, collect rpm with this version and specify the exact version of the module in the special file. <br><br><pre> <code class="hljs pgsql"> BuildRequires: perl-<span class="hljs-keyword"><span class="hljs-keyword">Some</span></span>-CPAN-Module = <span class="hljs-number"><span class="hljs-number">1.41</span></span> Requires: perl-<span class="hljs-keyword"><span class="hljs-keyword">Some</span></span>-CPAN-Module = <span class="hljs-number"><span class="hljs-number">1.41</span></span></code> </pre><br>  Another problem may occur if the module with CPAN has its own dependencies, for example, Some :: CPAN :: Module depends on Other :: CPAN :: Module, as a result on the developer environment and on the build server after the package installation packages are installed again parted and fayl test, the service still does not start.  And there may be more than a dozen such modules in a real project.  In narrow circles this is called <i>dependency jellyfish.</i> <br><br>  Solution: you can also track dependencies on dependencies and specify all of them in a spec file, but this solution requires a lot of time and effort for tracking and subsequent assembly.  Which is limited by our development methodology. <br><br>  An alternative solution is possible: raising your own CPAN mirror, for example, using <a href="http://search.cpan.org/dist/Pinto/">pinto</a> , but this is not the topic of this article. <br><br>  There is another solution. <br><br>  The main problem of CPAN is that it was invented a long time ago and everyone who at least once laid out his module on CPAN understands what I am writing about.  Fortunately, modern tools have recently begun to appear for perl. <br><br><h5>  Carton </h5><br>  I want to tell you about a tool called <a href="https://github.com/miyagawa/carton">Carton</a> .  Its author, Tatsuhiko Miyagawa, is also the author of a bunch of useful utilities, including <a href="http://search.cpan.org/perldoc%3FStarman">starman</a> and cpanm. <br><br>  What is a carton?  This is the dependency manager for pearl-barley modules.  It was written under the impression of the Bundler for Ruby. <br><br>  Its essence boils down to the fact that a file is created in the project directory in which the dependencies are declared - <a href="https://github.com/miyagawa/cpanfile">cpanfile</a> .  In this file, the developer lists the list of required modules and their versions: <br><br><pre> <code class="hljs java"> <span class="hljs-keyword"><span class="hljs-keyword">requires</span></span> <span class="hljs-string"><span class="hljs-string">'Some::CPAN::Module'</span></span>, <span class="hljs-string"><span class="hljs-string">'1.45'</span></span>;</code> </pre><br>  then the command is run: <br><br><pre> <code class="hljs sql"> carton <span class="hljs-keyword"><span class="hljs-keyword">install</span></span></code> </pre><br>  and the necessary module is placed in the local / lib directory and a cpanfile.snapshot is also created, which stores information about the modules installed with CPAN.  This file must also be added to the VCS, so that later on the build server when starting carton install dependencies from snapshots arrive, thereby guaranteeing the identity of the environment. <br><br>  All you need to do now is add the local / lib directory to <code>@INC</code> . <br><br>  You can specify the exact version that is needed or the valid range of versions: <br><br><pre> <code class="hljs java"> <span class="hljs-keyword"><span class="hljs-keyword">requires</span></span> <span class="hljs-string"><span class="hljs-string">'Some::CPAN::Module'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;= 1.41, &lt; 1.46'</span></span>;</code> </pre><br>  Moreover, you can specify modules that are specific to different environments, for example: <br><br><pre> <code class="hljs perl"> osname <span class="hljs-string"><span class="hljs-string">'MSWin32'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{ requires <span class="hljs-string"><span class="hljs-string">'Win32::File'</span></span>; }; on <span class="hljs-string"><span class="hljs-string">'test'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{ requires <span class="hljs-string"><span class="hljs-string">'Test::More'</span></span>, <span class="hljs-string"><span class="hljs-string">'&gt;= 0.96, &lt; 2.0'</span></span>; recommends <span class="hljs-string"><span class="hljs-string">'Test::TCP'</span></span>, <span class="hljs-string"><span class="hljs-string">'1.12'</span></span>; }; on <span class="hljs-string"><span class="hljs-string">'develop'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span></span>{ recommends <span class="hljs-string"><span class="hljs-string">'Devel::NYTProf'</span></span>; };</code> </pre><br>  Carton works in harness with cpanm, another useful utility from the same author, we can be grateful to her for directly installing the modules. <br><br>  Now that we have all the dependencies in the cpanfile, the snapshot of the development environment in cpanfile.snapshot and all of this is placed in the VCS in the spec file before running the tests, you can add the carton install command. <br><br>  The same command can also be added to the installation stage when the package is deployed to the server for which the rpm package is intended. <br><br>  But we went further. <br><img src="https://habrastorage.org/getpro/habr/comment_images/1a3/381/d37/1a3381d37536c9a785643c1ae78d3345.jpg" alt="image"><br>  The author of Carton has the following vision of his utility: Carton is placed on all the necessary servers, then the <a href="https://github.com/capistrano/capistrano">capistrano</a> utility executes the command immediately on all the necessary remote machines: <br><br><pre> <code class="hljs objectivec"> <span class="hljs-meta"><span class="hljs-meta"># cap carton install</span></span></code> </pre><br>  A bit strange, you need to download a whole heap of dependencies from the Internet or from a local CPAN mirror, and this can take quite a long time, but what if at that moment there were any network problems? <br><br>  There is a more consistent way, we can install the modules at the stage of building an rpm package.  And we decided to create a √ºber-rpm-package, in which we put all the dependencies at once.  This package is declared to be a package dependency with a code, and it can be delivered both on the build server for passing tests during the build and in the production. <br><br>  Such an approach is popular for projects, for example, on scala - a √ºber-jar is created in which all dependencies of the project + code go to go even further - they create a √ºber-binary in which all dependencies are already compiled. <br><br>  Now that we have set up and automated the build process, we may not be afraid of releases and jellyfish dependencies, but focus on the algorithms and the product that we produce :) </div><p>Source: <a href="https://habr.com/ru/post/198376/">https://habr.com/ru/post/198376/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198366/index.html">Migrate from mysql to postgresql</a></li>
<li><a href="../198368/index.html">About project MyEducationPath. What will be the higher education of the future and why do you need MyEducationPath</a></li>
<li><a href="../198370/index.html">Motion control in games</a></li>
<li><a href="../198372/index.html">Javascript console API</a></li>
<li><a href="../198374/index.html">The ‚ÄúInsider Law‚Äù gave the right to the Bank of Russia without a court to require disclosure and correspondence, and negotiations, and all such</a></li>
<li><a href="../198378/index.html">PSUX therapy</a></li>
<li><a href="../198380/index.html">SQL Server 2014 CTP2 released</a></li>
<li><a href="../198384/index.html">Alternative development environment for Arduino</a></li>
<li><a href="../198386/index.html">Yandex launches metrics for applications</a></li>
<li><a href="../198388/index.html">Tips for novice iOS developers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>