<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Watch vBulletin or attempt to cache dynamic content</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are several VPS in my charge, on which it is spinning ... in general, it is not my area of ‚Äã‚Äãresponsibility, and therefore it is spinning there,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Watch vBulletin or attempt to cache dynamic content</h1><div class="post__text post__text-html js-mediator-article">  There are several VPS in my charge, on which it is spinning ... in general, it is not my area of ‚Äã‚Äãresponsibility, and therefore it is spinning there, which is spinning, moderately slowing down, moderately working.  And it turned out that some forum was spinning on one of them, and began to slow down the forum.  And I wanted to figure it out ... <br><a name="habracut"></a><br><h5>  Ixd </h5><br><ul><li>  Forum under vBulletin 3.8.x </li><li>  Rendered to the subdomain forum.domain.com </li><li>  Nginx 1.1.13, php 5.3.x (fpm) </li><li>  In addition to the forum on this server, nothing is spinning.  ( <u>this is important</u> ). </li><li>  Mysql on a separate server, communication via TCP / IP. </li></ul><br><br><h5>  Prehistory </h5><br>  I lived a forum for myself, did not hurt it, showed <b>xm top</b> load in the region of 30-40 percent.  And then the hour "X" came and the load jumped to a flat shelf 90 percent with peaks higher, which, in general, is not gud.  DDOS suspicion was not confirmed.  The logs were observed normal workload.  Well, before stupidly increasing resources, the idea arose to understand what is happening and try to cache everything that is possible. <br><br><h5>  Investigation.  Part One - What Does <s>a</s> Visitor <s>Woman</s> Want? </h5><br>  Since I was not familiar with the ideology and features of this software, I began to study the problem of analyzing the logs and traffic between visitors and the server.  First of all, I was surprised to find that <u>attachments</u> to messages in the forum are given exclusively by the <u>attachment.php</u> script, while the files themselves can be stored in the database, can be on a local disk, but the return is only through a script.  And nothing else.  That is, we get 8-10 extra twitching php-interpreter on the message branch with 8-10 photos.  And this is for every visitor.  Since this forum does not require registration to view attachments, attachments can be cached, for example, for a couple of days.  Like this: <br><pre><code class="perl hljs">location = <span class="hljs-regexp"><span class="hljs-regexp">/attachment.php { expires max; limit_req zone=lim_req_1s_zone burst=5; fastcgi_pass forum__php_cluster; include /etc</span></span><span class="hljs-regexp"><span class="hljs-regexp">/nginx/fastcgi</span></span>_params; include /etc/nginx/fastcgi_params_php-fpm; fastcgi_cache forum_att__cache; fastcgi_ignore_headers Cache-Control Expires Set-Cookie; fastcgi_hide_header Set-Cookie; fastcgi_hide_header Pragma; fastcgi_cache_key <span class="hljs-string"><span class="hljs-string">"$request_method:$http_if_modified_since:$http_if_none_match:$host:$request_uri:"</span></span>; fastcgi_cache_use_stale updating error timeout invalid_header http_50<span class="hljs-number"><span class="hljs-number">0</span></span>; fastcgi_cache_lock on; fastcgi_cache_lock_timeout <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-keyword"><span class="hljs-keyword">m</span></span>; fastcgi_cache_valid <span class="hljs-number"><span class="hljs-number">2</span></span>d; }  -  http-  forum_att__cache: fastcgi_cache_path /var/cache/nginx/att levels=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span> keys_zone=forum_att__cache:<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-keyword"><span class="hljs-keyword">m</span></span> max_size=<span class="hljs-number"><span class="hljs-number">2</span></span>g inactive=<span class="hljs-number"><span class="hljs-number">2</span></span>d;</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The second ‚Äúrevelation‚Äù for me was that there are archives on the forum, and they do not just exist, but almost half of the requests fall on them.  The appearance of the pages also allows you to cache their contents: <br><pre> <code class="perl hljs">location /archive/ { expires <span class="hljs-number"><span class="hljs-number">10</span></span>d; limit_req zone=lim_req_1s_zone burst=<span class="hljs-number"><span class="hljs-number">2</span></span>; location ~ \.css$ { expires max; } fastcgi_pass forum__php_cluster; fastcgi_index index.php; include /etc/nginx/fastcgi_params; include /etc/nginx/fastcgi_params_php-fpm; fastcgi_param SCRIPT_FILENAME $document_root/archive/index.php; fastcgi_param SCRIPT_NAME $fastcgi_script_name; fastcgi_cache forum_arc__cache; fastcgi_hide_header Set-Cookie; fastcgi_ignore_headers Cache-Control Expires Set-Cookie; fastcgi_cache_key <span class="hljs-string"><span class="hljs-string">"$request_method:$http_if_modified_since:$http_if_none_match:$host:$request_uri:"</span></span>; fastcgi_cache_use_stale updating error timeout invalid_header http_50<span class="hljs-number"><span class="hljs-number">0</span></span>; fastcgi_cache_valid <span class="hljs-number"><span class="hljs-number">2</span></span>d; }   http-: fastcgi_cache_path /var/cache/nginx/arc levels=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span> keys_zone=forum_arc__cache:<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-keyword"><span class="hljs-keyword">m</span></span> max_size=<span class="hljs-number"><span class="hljs-number">2</span></span>g inactive=<span class="hljs-number"><span class="hljs-number">2</span></span>d;    DDOS-: limit_req_zone <span class="hljs-string"><span class="hljs-string">"$psUID"</span></span> zone=lim_req_1s_zone:<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-keyword"><span class="hljs-keyword">m</span></span> rate=<span class="hljs-number"><span class="hljs-number">1</span></span>r/<span class="hljs-keyword"><span class="hljs-keyword">s</span></span>;</code> </pre><br>  On the formation of the key "$ psUID" I will tell further. <br><br><h5>  Investigation.  Part Two - Authorization in vBulletin </h5><br>  From the point of view of the visitor of the forum, the visitor can be either a registered user or a guest.  But the situation is completely different if we observe the situation ‚Äúcame, walked, logged in, walked, logged off, walked‚Äù in terms of the appearance and disappearance of cookies in the browser.  So, we clear cookies for the domain and its subdomains, open <a href="httpfox/">HTTPfox</a> and see what happens: <br><pre> <code class="perl hljs">HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK Set-Cookie: PHPSESSID=cdme9rrptft67tbo97p4t1cua5; expires=Wed, <span class="hljs-number"><span class="hljs-number">22</span></span>-Feb-<span class="hljs-number"><span class="hljs-number">2012</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span> GMT; path=<span class="hljs-regexp"><span class="hljs-regexp">/; domain=.domain.com Set-Cookie: bblastvisit=1329059052; expires=Mon, 11-Feb-2013 15:04:12 GMT; path=/</span></span>; domain=.domain.com Set-Cookie: bblastactivity=<span class="hljs-number"><span class="hljs-number">0</span></span>; expires=Mon, <span class="hljs-number"><span class="hljs-number">11</span></span>-Feb-<span class="hljs-number"><span class="hljs-number">2013</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span> GMT; path=<span class="hljs-regexp"><span class="hljs-regexp">/; domain=.domain.com Set-Cookie: uid=XCuiGU831OyC8VLqAx/</span></span>QAg==; expires=Thu, <span class="hljs-number"><span class="hljs-number">31</span></span>-Dec-<span class="hljs-number"><span class="hljs-number">37</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span> GMT; domain=.domain.com; path=<span class="hljs-regexp"><span class="hljs-regexp">/</span></span></code> </pre><br>  <b>Everything</b> is clear with <b>uid</b> and <b>PHPSESSID</b> - these are the intrigues of nginx and the php interpreter with the <u>session.auto_start</u> option set, and the rest are the witnesses for forum activity.  But the main session cookie vBulletin is not yet observed.  Looking ahead, I will say that vBulletin does not use the standard php session (or, more precisely, ALMOST does not use), but maintains its own, which identifier stores in the bbsessionhash <b>cookie</b> .  So, the user has logged in, but there is no session - that is, he is an anonymous user without a session.  In this case, links to the forum can then be of two kinds (meaning all the links on the page, and not one way, and the other): <br>  <a href="http://forum.domain.com/forumdisplay.php%3Fs%3D12b66e447be52ebc84ab16d3f39626fb%26f%3D69">forum.domain.com/forumdisplay.php?s=12b66e447be52ebc84ab16d3f39626fb&amp;f=69</a> <br>  <a href="http://forum.domain.com/forumdisplay.php%3Ff%3D69">forum.domain.com/forumdisplay.php?f=69</a> <br>  And if you follow the link of the first type, then the next answer from the forum will come in a session cookie, and if the link of the second type is not.  If you didn‚Äôt come across the forum with the second answer from the session, then you can wander around the forum unsessionally and restless until you come across a link of the first type (the pattern of their appearance didn‚Äôt come out), or you want to login.  With a successful login Cook session will come in any way.  If the guest was anonymous-with-session before login, then the session will be replaced.  It looks like this: <br><pre> <code class="perl hljs">HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK Set-Cookie: bbsessionhash=<span class="hljs-number"><span class="hljs-number">85745</span></span>bc6110db5221e159087bf037f24; path=<span class="hljs-regexp"><span class="hljs-regexp">/; domain=.domain.com; HttpOnly</span></span></code> </pre><br>  After login, the session is ‚Äústable‚Äù and there is no link messaging.  The logout procedure is not different by originality - all existing forum cookies are deleted (even those that have not been registered) and a new ("anonymous") session is written: <br><pre> <code class="perl hljs">HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK Set-Cookie: bbsessionhash=deleted; expires=Thu, <span class="hljs-number"><span class="hljs-number">01</span></span>-Jan-<span class="hljs-number"><span class="hljs-number">1970</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> GMT; path=<span class="hljs-regexp"><span class="hljs-regexp">/; domain=.domain.com Set-Cookie: bblastvisit=deleted; expires=Thu, 01-Jan-1970 00:00:01 GMT; path=/</span></span>; domain=.domain.com Set-Cookie: bblastactivity=deleted; expires=Thu, <span class="hljs-number"><span class="hljs-number">01</span></span>-Jan-<span class="hljs-number"><span class="hljs-number">1970</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> GMT; path=<span class="hljs-regexp"><span class="hljs-regexp">/; domain=.domain.com Set-Cookie: bbthread_lastview=deleted; expires=Thu, 01-Jan-1970 00:00:01 GMT; path=/</span></span>; domain=.domain.com Set-Cookie: bbreferrerid=deleted; expires=Thu, <span class="hljs-number"><span class="hljs-number">01</span></span>-Jan-<span class="hljs-number"><span class="hljs-number">1970</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> GMT; path=<span class="hljs-regexp"><span class="hljs-regexp">/; domain=.domain.com Set-Cookie: bbuserid=deleted; expires=Thu, 01-Jan-1970 00:00:01 GMT; path=/</span></span>; domain=.domain.com Set-Cookie: bbpassword=deleted; expires=Thu, <span class="hljs-number"><span class="hljs-number">01</span></span>-Jan-<span class="hljs-number"><span class="hljs-number">1970</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> GMT; path=<span class="hljs-regexp"><span class="hljs-regexp">/; domain=.domain.com Set-Cookie: bbthreadedmode=deleted; expires=Thu, 01-Jan-1970 00:00:01 GMT; path=/</span></span>; domain=.domain.com Set-Cookie: bbstyleid=deleted; expires=Thu, <span class="hljs-number"><span class="hljs-number">01</span></span>-Jan-<span class="hljs-number"><span class="hljs-number">1970</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> GMT; path=<span class="hljs-regexp"><span class="hljs-regexp">/; domain=.domain.com Set-Cookie: bblanguageid=deleted; expires=Thu, 01-Jan-1970 00:00:01 GMT; path=/</span></span>; domain=.domain.com Set-Cookie: bbsessionhash=<span class="hljs-number"><span class="hljs-number">3</span></span>d0bdc5dbe8dabae361deebe8f6048d2; path=<span class="hljs-regexp"><span class="hljs-regexp">/; domain=.domain.com; HttpOnly</span></span></code> </pre><br>  That is, at the output we get an anonymous user (guest), but one hundred percent having a session. <br>  As a result, from the point of view of forum software <b>and</b> HTTP headers, we have three types of users: a <u>guest without a session</u> , a <u>guest with a session</u> , a <u>logged in visitor</u> .  And at the level of nginx'a to distinguish the second from the third extremely problematic. <br><br>  Now, by understanding what cookies and how to ply between the visitor and the server, you can approach the issue of caching dynamic content.  As is known, the caching functionality for fastcgi-backend responses in nginx is built into the <a href="http_fastcgi_module.html">ngx_http_fastcgi_module</a> module.  To do this, you need to register globally in the http-section a caching zone, and in the correct location'e - the key.  And if for conditionally static content (images, archives) the key for caching could be considered a URI with minor additions, then for caching the dynamics it is necessary to take into account the user as well.  It seemed to be a type rule <br><pre> <code class="perl hljs">fastcgi_cache_key <span class="hljs-string"><span class="hljs-string">"$request_method:$http_if_modified_since:$http_if_none_match:$host:$request_uri:$cookie_bbsessionhash:"</span></span>;</code> </pre><br>  could satisfy both guests and logged in users; however, in practice, visitors began to receive the contents of someone else's cache.  Caching the "true" dynamics had to be turned off.  I hope the sentence is not final. <br><br>  However, this information is not useless.  Based on it, we can generate a key to limit the frequency of requests based not only on the visitor‚Äôs IP address, but also on its status. <br><pre> <code class="perl hljs">set $psUID <span class="hljs-string"><span class="hljs-string">"anon"</span></span>; set $psUCL <span class="hljs-string"><span class="hljs-string">"anon"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($cookie_bbsessionhash) { set $psUID <span class="hljs-string"><span class="hljs-string">"$cookie_bbsessionhash"</span></span>; set $psUCL <span class="hljs-string"><span class="hljs-string">"user"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($psUCL = <span class="hljs-string"><span class="hljs-string">"anon"</span></span>) { set $psUID <span class="hljs-string"><span class="hljs-string">"anon:$remote_addr"</span></span>; }</code> </pre><br>  This config fragment is placed in the server section of the nginx config file to describe all the locations.  As a result, we get the original key for a user with a session and a key based on the IP address for session visitors who do not (for example, a search crawler). <br><br><h5>  results </h5><br>  As a result of the efforts made, the total load on the virtual machine dropped from the shelf by 90 percent to 40% with a surge to 80 percent. </div><p>Source: <a href="https://habr.com/ru/post/138057/">https://habr.com/ru/post/138057/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138051/index.html">Studying Skype - edit quotes</a></li>
<li><a href="../138053/index.html">Vim + Python. For beginners</a></li>
<li><a href="../138054/index.html">We write MVC application on Ext JS 4 with the possibility of offline work</a></li>
<li><a href="../138055/index.html">Embedded custom blog engines for Ruby on Rails</a></li>
<li><a href="../138056/index.html">The authors of the amendments to the Civil Code of the Russian Federation finally decided to destroy Linux, Wikipedia, OpenStreetMap, Firefox, Chromium and LibreOffice?</a></li>
<li><a href="../138058/index.html">Freelance vs business</a></li>
<li><a href="../138059/index.html">Cheap RFID printed on paper</a></li>
<li><a href="../138060/index.html">A couple of questions on multiple screens. (.NET)</a></li>
<li><a href="../138062/index.html">How JavaScript Timers Work</a></li>
<li><a href="../138063/index.html">Automatic quality check of Java code (iteration 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>