<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring Squid 3 + QuintoLabs Content Security 1.4 and Integration with Active Directory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I will not tell you about Squid , but I‚Äôll tell you about the features of QCS. 

 What can do QuintoLabs Content Security 
 * Removes annoying ads 
 *...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring Squid 3 + QuintoLabs Content Security 1.4 and Integration with Active Directory</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage2/466/632/ec0/466632ec048f7d4417d82d009df6617e.gif"><br>  I will not tell you about <a href="http://www.squid-cache.org/">Squid</a> , but I‚Äôll tell you about the features of QCS. <br><br>  What can do QuintoLabs Content Security <br>  * Removes annoying ads <br>  * Ban on file uploads <br>  * Group control <br>  * Exclusion of any domain, subnet, ip from the filter <br>  * High performance <br>  * Easy setup and maintenance <br>  * Support for RedHat, CentOS, Fedora, Debian, Ubuntu distributions <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To configure the bundle, we have a pre-configured <br>  1) dc.example.lan [192.168.28.20] - Win2K2008 with DNS and Active Direcory <br>  2) 192.168.28.2 - Gateway <br>  3) DNS [192.168.28.20] <br>  3) example.lan - Domain <br>  4) proxy.example.lan - Our CentOS 6 Server <br>  5) client.example.lan - Win7 client <br><br>  Next, we will configure the proxy server (CentOS), taking into account that the server on Win2K2008 with the services we need is configured <br><br>  Configuring static ip in / etc / sysconfig / network-scripts / ifcfg-eth0: <br> <code>BOOTPROTO=static <br> NETMASK=255.255.255.0 <br> IPADDR=192.168.28.21 <br> ONBOOT=yes</code> <br>  We set the gateway / etc / sysconfig / network: <br> <code>GATEWAY=192.168.28.2</code> <br>  Specify dns in /etc/resolv.conf: <br> <code>nameserver 192.168.28.20</code> <br>  Restart Network Interfaces <br> <code>/etc/init.d/network restart</code> <br>  Pinging: <br> <code>$ping -c 3 192.168.28.2</code> <br> <br>  If all is well.  then you can move on <br>  Updating: <br> <code>yum update</code> <br>  and after we put additional packages: <br> <code>yum install bind-utils</code> <br>  install ntp <br> <code>yum install ntp</code> <br>  add to startup <br> <code>chkconfig ntpd on</code> <br>  Open /etc/ntp.conf and add to the domain controller in the config <br><img src="https://habrastorage.org/storage2/dfd/937/99c/dfd93799cde59edb3164d196af8074e8.png"><br><br>  Stop the service: <br> <code>service ntpd stop</code> <br>  Synchronize with our dc: <br> <code>ntpdate -b dc.example.lan</code> <br>  and start the ntp service back: <br> <code>service ntpd start</code> <br>  Install kerberos: <br> <code>yum install krb5-workstation krb5-libs</code> <br>  We give the configuration of /etc/krb5.conf to a similar form: <br> <code>[logging] <br> default = FILE:/var/log/krb5libs.log <br> kdc = FILE:/var/log/krb5kdc.log <br> admin_server = FILE:/var/log/kadmind.log <br> <br> [libdefaults] <br> default_realm = EXAMPLE.LAN <br> dns_lookup_realm = false <br> dns_lookup_kdc = false <br> ticket_lifetime = 24h <br> renew_lifetime = 7d <br> forwardable = true <br> default_tgs_enctypes = rc4-hmac <br> default_tkt_enctypes = rc4-hmac <br> permitted_enctypes = rc4-hmac <br> <br> [realms] <br> EXAMPLE.LAN = { <br> kdc = dc.example.lan <br> admin_server = dc.example.lan <br> default_domain = example.lan <br> } <br> <br> [domain_realm] <br> .example.lan = EXAMPLE.LAN <br> example.lan = EXAMPLE.LAN</code> <br> <br>  We are trying to get a ticket: <br> <code>kinit Administrator@EXAMPLE.LAN</code> <br>  If everything passed without any problems, then we check the ticket issued to us: <br> <code>klist</code> <br>  and see: <br> <code>Ticket cache: FILE:/tmp/krb5cc_0 <br> Default principal: Administrator@EXAMPLE.LAN <br> Valid starting Expires Service principal <br> 12/07/11 11:07:58 12/07/11 21:08:00 krbtgt/EXAMPLE.LAN@EXAMPLE.LAN <br> renew until 12/14/11 11:07:58</code> <br>  Reboot: <br> <code>shutdown -r now</code> <br>  Install sabma and get our server to the domain <br> <code>yum install samba</code> <br>  add to load: <br> <code>chkconfig smb on</code> <br>  Open the samba config /etc/samba/smb.conf and bring it to this form: <br> <code>[global] <br> workgroup = EXAMPLE <br> realm = EXAMPLE.LAN <br> server string = Samba Server Version %v <br> security = ADS <br> log file = /var/log/samba/log.%m <br> max log size = 50 <br> cups options = raw <br> <br> [homes] <br> comment = Home Directories <br> read only = No <br> browseable = No <br> <br> [printers] <br> comment = All Printers <br> path = /var/spool/samba <br> printable = Yes <br> browseable = No</code> <br> <br>  Restart the samba: <br> <code>service smb restart</code> <br>  Initialize kerberos: <br> <code>kinit Administrator@EXAMPLE.LAN <br> klist <br> <br> net ads join -S dc.example.lan -U Administrator%P@ssw0rd</code> <br> <img src="https://habrastorage.org/storage2/6ef/eda/066/6efeda06669a62630cb33da0812cfd27.png"><br><br>  Open the AD snap-in and check if our proxy server appeared in the Computers OU <br><img src="https://habrastorage.org/storage2/c3a/8e0/c6e/c3a8e0c6e42ac2e5aba2658d5a5f74b5.png"><br><br>  We see a positive result and again a reboot: <br> <code>shutdown -r now</code> <br>  Install Squid: <br> <code>yum install squid</code> <br>  Open /etc/squid/squid.conf, find the lines we need and replace them: <br> <code>visible_hostname proxy.example.lan <br> http_access allow localnet and acl localnet src 192.168.28.0/24</code> <br>  Add to autoload: <br> <code>chkconfig squid on</code> <br>  Restart the service: <br> <code>service squid start</code> <br>  Add a default entry to the /etc/krb5.keytab file <br> <code>net ads keytab add HTTP -U administrator <br> Processing principals to add... <br> Enter administrator's password:</code> <br> <img src="https://habrastorage.org/storage2/4db/898/2a1/4db8982a1bdcec5e45eb22d462136644.png"><br><br>  Change the owner of the file: <br> <code>chown squid:squid /etc/krb5.keytab</code> <br>  and set chmod: <br> <code>chmod 400 /etc/krb5.keytab</code> <br>  Change the contents of the config in /etc/squid/squid.conf: <br> <code>auth_param negotiate program /usr/lib/squid/negotiate_kerb_auth -s HTTP/proxy <br> auth_param negotiate children 10 <br> auth_param negotiate keep_alive on <br> <br> acl auth proxy_auth REQUIRED <br> <br> http_access deny !auth <br> http_access allow auth <br> <br> http_access deny all</code> <br>  After that, we reboot our server, and on the client car, open ie and check the authentication.  If everything went well then in the logs /var/log/squid/*.log we will see our user <br><br>  Next, install apache <br> <code>yum install httpd php mod_wsgi</code> <br>  Add to startup <br> <code>chkconfig httpd on</code> <br>  Run apache: <br> <code>service httpd start</code> <br>  Go to the final part, install QuintoLabs Content Security 1.4.2 <br><br>  Download: <br> <code><a href=""></a> curl quintolabs.com/qlproxy/binaries/1.4.2/qlproxy-1.4.2-32d12.i386.rpm &gt; qlproxy-1.4.2-32d12.i386.rpm</code> <br>  Install: <br> <code>rpm --install qlproxy-1.4.2-32d12.i386.rpm</code> <br>  To block ads, simply uncomment the subscription we need in the /opt/quintolabs/qlproxy/etc/adblock.conf file. <br>  Optionally, you can improve the filter heuristics for online games in the /opt/quintolabs/qlproxy/etc/adultblock.conf file <br>  Looking for the string: <br> <code>heuristics_level = normal</code> <br>  and normal change to high: <br> <code>heuristics_level = high</code> <br>  In the /opt/quintolabs/qlproxy/etc/exceptions.conf config, you can configure parental controls that support filtering html pages for prohibited words and phrases. <br>  And in the config /opt/quintolabs/qlproxy/etc/httpblock.conf, you can configure protection against Trojans and viruses that often send requests over IP: <br> <code>http://\d+\.\d+\.\d+\.\d+/.*</code> <br>  After all changes, restart the daemon: <br> <code>/etc/init.d/qlproxy restart</code> <br>  Open the squid config /etc/squid/squid.conf and make changes to interact with our filter: <br> <code>icap_enable on <br> icap_preview_enable on <br> icap_preview_size 4096 <br> icap_persistent_connections on <br> icap_send_client_ip on <br> icap_send_client_username on <br> icap_service qlproxy1 reqmod_precache bypass=0 icap://127.0.0.1:1344/reqmod <br> icap_service qlproxy2 respmod_precache bypass=0 icap://127.0.0.1:1344/respmod <br> adaptation_access qlproxy1 allow all <br> adaptation_access qlproxy2 allow all</code> <br>  Overload the squid service: <br> <code>service squid restart</code> <br>  Next, edit the apache /etc/httpd/httpd.conf config and add: <br> <code>WSGIScriptAlias /qlproxy.cgi /var/opt/quintolabs/qlproxy/www/data/qlproxy.wsgi <br> &lt;Directory /var/opt/quintolabs/qlproxy/www/data&gt; <br> WSGIApplicationGroup %{GLOBAL} <br> Order deny,allow <br> Allow from all <br></code> <code>Alias /qlproxy /var/opt/quintolabs/qlproxy/www <br> &lt;Directory /var/opt/quintolabs/qlproxy/www&gt; <br> Options FollowSymLinks <br> AllowOverride None <br></code> <br>  Reload apache <br> <code>service httpd restart</code> <br> <br>  And accordingly we check all server work and filtering including. <br>  Few links <br><ul><li>  <a href="http://www.centos.org/">www.centos.org</a> </li><li>  <a href="http://docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/index.html">docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/index.html</a> </li><li>  <a href="http://www.squid-cache.org/">www.squid-cache.org</a> </li><li>  <a href="http://acksyn.org/diary/%3Fp%3D460">acksyn.org/diary/?p=460</a> </li><li>  <a href="http://www.quintolabs.com/qlicap_info.php">www.quintolabs.com/qlicap_info.php</a> </li><li>  <a href="http://issues.quintolabs.com/trac/quintolabs_qlicap/wiki/QlicapDocs">issues.quintolabs.com/trac/quintolabs_qlicap/wiki/QlicapDocs</a> </li></ul><br><br>  PS If you find ochemyatku, write to the drug, I will fix :) </div><p>Source: <a href="https://habr.com/ru/post/136205/">https://habr.com/ru/post/136205/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136197/index.html">CES 2012 // Fujifilm X-Pro1</a></li>
<li><a href="../136199/index.html">Oatmeal - The Pros and Cons of the Pros and Cons Lists</a></li>
<li><a href="../136201/index.html">CES 2012 // Fujitsu Arrows X</a></li>
<li><a href="../136202/index.html">Unexpected need for data versioning</a></li>
<li><a href="../136203/index.html">WAW - Words do not need to be conveyed by the senses</a></li>
<li><a href="../136206/index.html">At first they don't notice you, then they laugh at you, then they fight with you. And then you win. Mahatma Gandhi</a></li>
<li><a href="../136209/index.html">CyberPlat has closed acceptance of credit cards from abroad</a></li>
<li><a href="../136210/index.html">Why C is faster than Java (from the perspective of a Java developer)</a></li>
<li><a href="../136213/index.html">We are 1 year old!</a></li>
<li><a href="../136214/index.html">[archlinux testing news] / usr support on a separate section</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>