<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shell Extensions Development for Windows Explorer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To enhance the convenience of the products being developed, we try to ensure the maximum level of integration of the functionality into the operating ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shell Extensions Development for Windows Explorer</h1><div class="post__text post__text-html js-mediator-article">  To enhance the convenience of the products being developed, we try to ensure the maximum level of integration of the functionality into the operating system, so that the user is comfortable using the full potential of the application.  This article will discuss the theoretical and practical aspects of developing Shell Extensions, components that allow integration into the shell of the Windows operating system.  As an example, consider the expansion of the context menu list for files, as well as review the existing solutions in this area. <br><br><a name="habracut"></a><br>  Generally speaking, there are a huge variety of options for integrating the components of the Windows operating system shell, for example: control panel applets, screen savers, and so on, but in this article I would like to dwell in more detail on the possibilities of expanding Windows Explorer, an OS component that I had to expand more than others. due to its functional load. <br><br>  Windows Explorer allows you to extend yourself by using specialized COM objects.  The Windows API contains interfaces and structures describing how such COM objects should work, which methods should be exported.  After the COM object that implements the necessary functionality is developed, it is registered along a specific path in the Windows registry, so that Windows Explorer, when performing the described functionality, accesses the corresponding COM object. <br>  So, let's start the development of a COM object allowing us to expand the list of the context menu for files. <br>  We will develop using the .net framework. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Add the following directives to Assembly.cs that allow using our assembly as a COM object: <br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Setting ComVisible to false makes the types in this assembly not visible // to COM components. If you need to access a type in this assembly from // COM, set the ComVisible attribute to true on that type. [assembly: ComVisible(true)] // The following GUID is for the ID of the typelib if this project is exposed to COM [assembly: Guid("345F4DC2-A9BF-11E2-AA47-CC986188709B")]</span></span></code> </pre> <br>  We need to import some of the Windows API functions. <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"shell32"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">uint</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DragQueryFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hDrop,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> iFile, StringBuilder buffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cch</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"user32"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">uint</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatePopupMenu</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"user32"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InsertMenuItem</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hmenu, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uposition, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uflags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MENUITEMINFO mii</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"user32.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetMenuItemBitmaps</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hMenu, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uPosition, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uFlags, IntPtr hBitmapUnchecked, IntPtr hBitmapChecked</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"Shell32.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SHChangeNotify</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wEventId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uFlags, IntPtr dwItem1, IntPtr dwItem2</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SHCNE_ASSOCCHANGED = <span class="hljs-number"><span class="hljs-number">0x08000000</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"user32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PostMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hWnd, [MarshalAs(UnmanagedType.U4</span></span></span><span class="hljs-function">)] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">uint</span></span></span><span class="hljs-function"> Msg, IntPtr wParam, IntPtr lParam)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"user32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lpClassName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lpWindowName</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br>  The DragQueryFile function will allow us to get a list of files selected in the directory, SHChangeNotify notify the operating system that the shell has been changed. <br><br>  Since we are developing a COM object that extends the context menu, we need to implement the IShellExtInit interface.  In the Initialize method, we get the basic information about the directory in which we run. <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">ComImport(), InterfaceType(ComInterfaceType.InterfaceIsIUnknown), GuidAttribute(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"000214e8-0000-0000-c000-000000000046"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IShellExtInit</span></span> { [PreserveSig()] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr pidlFolder, IntPtr lpdobj, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*HKEY*/</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hKeyProgID</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  It is also necessary to describe and implement the IContextMenu COM interface.  A value of the PreserveSig field, which is equal to true, triggers a direct conversion of unmanaged signatures with HRESULT or retval values, and a value of false causes the automatic conversion of HRESULT or retval values ‚Äã‚Äãto exceptions.  The default value for the PreserveSig field is true. <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">ComImport(), InterfaceType(ComInterfaceType.InterfaceIsIUnknown), GuidAttribute(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"000214e4-0000-0000-c000-000000000046"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IContextMenu</span></span> { <span class="hljs-comment"><span class="hljs-comment">// IContextMenu methods [PreserveSig()] int QueryContextMenu(uint hmenu, uint iMenu, int idCmdFirst, int idCmdLast, uint uFlags); [PreserveSig()] void InvokeCommand (IntPtr pici); [PreserveSig()] void GetCommandString(int idCmd, uint uFlags, int pwReserved, [Out, MarshalAs(UnmanagedType.LPArray, SizeParamIndex = 4)] byte[] pszName, uint cchMax); }</span></span></code> </pre><br>  The QueryContextMenu method will be called when the context menu is called, in it we will need to implement the functionality of adding a menu item, GetCommandString will return some details on this command, its description and so on.  InvokeCommand will be called when you select the menu item that we add. <br><br>  For a COM object, you also need to implement the install and delete functions. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">System.Runtime.InteropServices.ComRegisterFunctionAttribute()</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterServer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.Type type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> approved = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> contextMenu = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; RegistryKey root; RegistryKey rk; root = Registry.LocalMachine; rk = root.OpenSubKey(Resources.ApprovedReg, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); rk.SetValue(type.GUID.ToString(<span class="hljs-string"><span class="hljs-string">"B"</span></span>), Resources.Extension); approved = rk.ToString(); rk.Flush(); rk.Close(); root = Registry.ClassesRoot; rk = root.CreateSubKey(Resources.ExShellReg); rk.Flush(); rk.SetValue(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, type.GUID.ToString(<span class="hljs-string"><span class="hljs-string">"B"</span></span>)); contextMenu = rk.ToString(); rk.Flush(); rk.Close(); EventLog.WriteEntry(<span class="hljs-string"><span class="hljs-string">"Application"</span></span>, <span class="hljs-string"><span class="hljs-string">"Example ShellExt Registration Complete.\r\n"</span></span> + approved + <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span> + contextMenu, EventLogEntryType.Information); RestartExplorer(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception e) { EventLog.WriteEntry(<span class="hljs-string"><span class="hljs-string">"Application"</span></span>, <span class="hljs-string"><span class="hljs-string">"Example ShellExt Registration error.\r\n"</span></span> + e.ToString(), EventLogEntryType.Error); } }</code> </pre><br>  In this function, we register our component in the registry, since we have a component that extends the context menu, we register in the ContextMenuHandlers section (* \\ shellex \\ ContextMenuHandlers \ ExShell).  After registration, we restart the explorer.exe process so that our changes take effect immediately. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">System.Runtime.InteropServices.ComUnregisterFunctionAttribute()</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnregisterServer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.Type type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> approved = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> contextMenu = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; RegistryKey root; RegistryKey rk; <span class="hljs-comment"><span class="hljs-comment">// Remove ShellExtenstions registration root = Registry.LocalMachine; rk = root.OpenSubKey(Resources.ApprovedReg, true); approved = rk.ToString(); rk.DeleteValue(type.GUID.ToString("B")); rk.Close(); // Delete regkey root = Registry.ClassesRoot; contextMenu = Resources.ExShellReg; root.DeleteSubKey(Resources.ExShellReg); EventLog.WriteEntry("Application", "Example ShellExt Unregister Complete.\r\n" + approved + "\r\n" + contextMenu, EventLogEntryType.Information); Helpers.SHChangeNotify(0x08000000, 0, IntPtr.Zero, IntPtr.Zero); } catch(Exception e) { EventLog.WriteEntry("Application", "Example ShellExt Unregister error.\r\n" + e.ToString(), EventLogEntryType.Error); } }</span></span></code> </pre><br>  The function of deleting a component, clears the registry from the keys created earlier. <br>  Next, go to the process of implementing interface functions. We implement the interfaces IShellExtInit, IContextMenu.  I will not describe in detail all the code of this class, I will dwell on the implementation of the functions of these interfaces. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IShellExtInit.Initialize (IntPtr pidlFolder, IntPtr lpdobj, <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> hKeyProgID) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lpdobj != (IntPtr)<span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Get info about the directory IDataObject dataObject = (IDataObject)Marshal.GetObjectForIUnknown(lpdobj); FORMATETC fmt = new FORMATETC(); fmt.cfFormat = CLIPFORMAT.CF_HDROP; fmt.ptd = 0; fmt.dwAspect = DVASPECT.DVASPECT_CONTENT; fmt.lindex = -1; fmt.tymed = TYMED.TYMED_HGLOBAL; STGMEDIUM medium = new STGMEDIUM(); dataObject.GetData(ref fmt, ref medium); m_hDrop = medium.hGlobal; } } catch(Exception) { } return 0; }</span></span></code> </pre><br>  The component initialization function starts when a directory or any other object is opened, in the context of which a context menu may be located.  We use the IDataObject interface to get data about the current object, in particular, we are interested in hGlobal.  This Handle identifies the current object within which our execution takes place. <br><br>  Next, we consider the function that is called when the context menu is dropped. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IContextMenu.QueryContextMenu(<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> hMenu, <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iMenu, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idCmdFirst, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idCmdLast, <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> uFlags) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( (uFlags &amp; <span class="hljs-number"><span class="hljs-number">0xf</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> || (uFlags &amp; (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)CMF.CMF_EXPLORE) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> nselected = Helpers.DragQueryFile(m_hDrop, <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nselected &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nselected; i++) { StringBuilder sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-number"><span class="hljs-number">1024</span></span>); Helpers.DragQueryFile(m_hDrop, i, sb, sb.Capacity + <span class="hljs-number"><span class="hljs-number">1</span></span>); fileNames.Add(sb.ToString()); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br>  In this section of the code, we check that we are running in the right context and are trying to query the number of files selected in the directory, as well as save the list of these files.  Also note that when iFile = 0xffffffff is passed to the DragQueryFile function, it will return the number of files in the directory. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Add the popup to the context menu MENUITEMINFO mii = new MENUITEMINFO(); mii.cbSize = 48; mii.fMask = (uint) MIIM.ID | (uint)MIIM.TYPE | (uint) MIIM.STATE; mii.wID = idCmdFirst; mii.fType = (uint) MF.STRING; mii.dwTypeData = Resources.MenuItem; mii.fState = (uint) MF.ENABLED; Helpers.InsertMenuItem(hMenu, (uint)iMenu, (uint)MF.BYPOSITION | (uint)MF.STRING, ref mii); commands.Add(idCmdFirst); System.Reflection.Assembly myAssembly = System.Reflection.Assembly.GetExecutingAssembly(); Stream myStream = myAssembly.GetManifestResourceStream(Resources.BitmapName); Bitmap image = new Bitmap(myStream); Color backColor = image.GetPixel(1, 1); image.MakeTransparent(backColor); Helpers.SetMenuItemBitmaps((IntPtr)hMenu, (uint)iMenu, (uint)MF.BYPOSITION, image.GetHbitmap(), image.GetHbitmap()); // Add a separator MENUITEMINFO sep = new MENUITEMINFO(); sep.cbSize = 48; sep.fMask = (uint )MIIM.TYPE; sep.fType = (uint) MF.SEPARATOR; Helpers.InsertMenuItem(hMenu, iMenu + 1, 1, ref sep); } return 1; }</span></span></code> </pre><br>  Here we add a new menu item by calling the InsertMenuItem function, then we prepare and add an icon to this menu item, as well as a dividing line for aesthetic beauty.  The MENUITEMINFO structure describes our menu item, namely its type (ftype), the contained data (dwTypeData), state (fState), menu item identifier (wID).  The variable hMenu identifies the current drop-down menu, the iMenu position at which we are added.  In order to get more complete information, you can contact MSDN. <br><br>  Next, consider the GetCommandString function. <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IContextMenu.GetCommandString(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idCmd, <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> uFlags, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pwReserved, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] pszName, <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> cchMax) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> commandString = String.Empty; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(uFlags) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)GCS.VERB: commandString = <span class="hljs-string"><span class="hljs-string">"test"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)GCS.HELPTEXTW: commandString = <span class="hljs-string"><span class="hljs-string">"test"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buf = Encoding.Unicode.GetBytes(commandString); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cch = Math.Min(buf.Length, pszName.Length - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cch &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Array.Copy(buf, <span class="hljs-number"><span class="hljs-number">0</span></span>, pszName, <span class="hljs-number"><span class="hljs-number">0</span></span>, cch); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">// null terminate the buffer pszName[0] = 0; } }</span></span></code> </pre><br>  This function returns a language-independent description of the command, as well as a brief hint in the form of helptext, respectively. <br><br>  Well, the last function that will be called when you select our menu item: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IContextMenu.InvokeCommand (IntPtr pici) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { System.Windows.Forms.MessageBox.Show(<span class="hljs-string"><span class="hljs-string">"Test code"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception exe) { EventLog.WriteEntry(<span class="hljs-string"><span class="hljs-string">"Application"</span></span>, exe.ToString()); } }</code> </pre><br>  It's all quite transparent. <br><br>  Since our COM object runs in the context of Windows Explorer, in order to debug it, we need to connect to the explorer.exe process.  To register and delete a component, you can use the bat files supplied with the sources for this article.  For registration, we use the RegAsm.exe utility, which allows COM clients to use the .net class as if it were COM, and also GacUtil to place the assembly in the GAC.  After registration, the explorer.exe process will be restarted. <br>  I would also like to draw your attention to the utility that allows you to view and, if necessary, edit all the Windows Explorer extensions installed in the system.  The utility is called ShellExView; you can download it on the <a href="http://www.nirsoft.net/">Nirsoft</a> manufacturer‚Äôs <a href="http://www.nirsoft.net/">website</a> or in the annex to the article. <br><br>  This is what our component looks like in ShellExView: <br><img src="http://habrastorage.org/storage2/4fd/6bd/b30/4fd6bdb30d5445a302381f229ddb7329.png"><br><br>  So it looks when the context menu is opened: <br><img src="http://habrastorage.org/storage2/65a/2eb/c80/65a2ebc802bf06e3d347114c5436c113.png"><br><br>  So, we looked at an example of developing a component of the expanding Windows Explorer, but this type of extension is far from the only thing that we can change and influence. <br>  Having an understanding of how such components function, you can look at what has already been developed by the community and can be used to facilitate the execution of such operations. <br>  For example, the <a href="http://sharpshell.codeplex.com/">SharpShell</a> library <a href="http://sharpshell.codeplex.com/">allows</a> you to perform a fairly large amount of modifications, as well as well described in the <a href="http://www.codeproject.com/Articles/512956/NET-Shell-Extensions-Shell-Context-Menus">.NET Shell Extensions</a> series of articles on CodeProject.  As an analogue, you can also use the <a href="http://wsf.codeplex.com/">Windows Shell Framework</a> library or the library for the ATL + C ++ <a href="http://msf.codeplex.com/">Mini Shell Extension Framework</a> . <br><br>  I would also like to draw your attention to the warning from Microsoft regarding the development of such extensions: ‚ÄúIt is not recommended to write shell extensions in .NET languages, since only one CLR runtime is used for one process, so there may be a conflict between two shell extensions using different CLR versions.  However, .Net Framework 4 supports side-by-side technology for .Net Framework 2.0, 3.0, 3.5 versions and allows using the old CLR 2 and the new CLR 4 in the same process. ‚Äù <br>  You can read more about limitations of using .net when developing Shell Extensions here: <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd758089%2528v%3Dvs.85%2529.aspx">Guidance for Implementing In-Process Extensions</a> <br><br>  <b>Another look:</b> <br>  <a href="http://www.codeproject.com/Articles/3747/Explorer-column-handler-shell-extension-in-C">Explorer column handler shell extension in C #</a> <br>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/cc144067%2528v%3Dvs.85%2529.aspx">Creating Shell Extension Handlers</a> <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/cc144067%2528v%3Dvs.85%2529.aspx"><br></a> <br><br>  Sources and utilities: <a href="">ExampleShell.rar</a> <br><br>  PS The extension did not test on Windows 8, judging by the reviews, to work correctly in the registry, in the HKEY_CLASSES_ROOT \ CLSID \ {component guid} \ InprocServer32 section, set the following value to ThreadingModel = Apartment. <br><br>  Thanks for attention! <br></div><p>Source: <a href="https://habr.com/ru/post/177469/">https://habr.com/ru/post/177469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177453/index.html">IPSEC daemon overview StrongSwan</a></li>
<li><a href="../177457/index.html">Unobvious Genemu TinyMCE configuration options for symfony2</a></li>
<li><a href="../177461/index.html">Experimenting Experimental Data</a></li>
<li><a href="../177465/index.html">Create npm-package</a></li>
<li><a href="../177467/index.html">GameDev and candelabrum</a></li>
<li><a href="../177473/index.html">06 - DreamWorks and HP: Creation of the Croods Family</a></li>
<li><a href="../177477/index.html">"Sparkling daggers" or as we did the Arab project</a></li>
<li><a href="../177489/index.html">Meet VMware vCloud Director</a></li>
<li><a href="../177491/index.html">Another home video surveillance</a></li>
<li><a href="../177493/index.html">Phishing emails for Russian Standard Bank</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>