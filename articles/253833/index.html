<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Exception Analyzer based on Roslyn</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have long wanted to deal with analyzers based on Roslin. Moreover, I already had the experience of creating plugins for Resharper ( R # Contract Edi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Exception Analyzer based on Roslyn</h1><div class="post__text post__text-html js-mediator-article">  I have long wanted to deal with analyzers based on Roslin.  Moreover, I already had the experience of creating plugins for Resharper ( <a href="https://github.com/SergeyTeplyakov/ReSharperContractExtensions">R # Contract Editor Extension</a> ), so I wanted to compare different infrastructures and usability.  There is an idea to rewrite this plugin using Roslyn analyzers, but I decided to start with something simpler. <br><br>  <b>The purpose of the weekly project was</b> to make a simple analyzer that will show typical exception handling errors.  The most painful from my point of view are: <br><br><ul><li>  Repeatedly generate exceptions with <b>throw ex;</b> <br></li><li>  ‚ÄúSwallowing‚Äù all exceptions with empty <b>catch {}</b> or <b>catch (Exception) {}</b> blocks. <br></li><li>  "Swallowing" exceptions in certain branches of the <b>catch block</b> . <br></li><li>  Saving in the logs only messages <b>ex.Message</b> , while losing potentially important information about the place of occurrence of the exception. <br></li><li>  Incorrect forwarding of new exceptions from the <strong>catch block</strong> . </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h4>  Beginning of work </h4><br>  To begin analyzer development, you need to install <a href="http://blogs.msdn.com/b/visualstudio/archive/2015/02/23/visual-studio-2015-ctp-6-and-team-foundation-server-2015-ctp-released.aspx">VS2015 CTP</a> (the easiest way is to take the <a href="http://blogs.msdn.com/b/visualstudioalm/archive/2014/06/04/visual-studio-14-ctp-now-available-in-the-virtual-machine-azure-gallery.aspx">finished virtual machine</a> ), then you need to install <a href="https://www.visualstudio.com/en-us/downloads/visual-studio-2015-downloads-vs">VS 2015 SDK</a> , <a href="https://visualstudiogallery.msdn.microsoft.com/ecefb773-36a6-4316-98db-4a87ed8cf5dc">.NET Compiler Platform SDK Templates</a> and <a href="https://visualstudiogallery.msdn.microsoft.com/0f18f8c3-ec79-468a-968f-a1a0ee65b388">.NET Compiler Platform Syntax Visualizer</a> .  The visualizer will be indispensable for understanding how syntax trees look, how to analyze them correctly and how to generate new trees in fixes.  Most importantly, you need to install the correct versions of the tools (for CTP6, all VSIX packages must be for CTP6).  On the <a href="https://github.com/dotnet/roslyn">main page of the Roslyn project</a> there will always be the current installation instructions. <br><br>  The development team has done a great job to make the creation of analyzers as simple and convenient as possible.  It is enough to create a new project, select the Extensibility -&gt; Diagnostics with Code Fix template (Nuget + VSIX), enter the name of the analyzer and that's it.  As a result, three projects will be created: the analyzer itself, a project with unit tests and a project with an installer (VSIX).  By default, a sample analyzer is added to the project, which shows a warning on the type names with lowercase letters. <br><br>  After that, you can run tests, or select a VSIX-project as a start, and press F5.  Then another instance of Visual Studio will be launched with the installed analyzer, which will issue a warning to all types with lowercase letters: <br><br><img src="https://habrastorage.org/files/83c/176/ffc/83c176ffcfd74869a0619db38125856e.png"><br><br><h5>  Ways to install analyzers </h5><br><br>  There are three ways to install the analyzer: <br><br>  ¬∑ Using the VSIX package, which can be downloaded from <a href="https://visualstudiogallery.msdn.microsoft.com/ef473182-2549-439c-9bf9-8582e4bdcebe">Visual Studio Gallary</a> directly, or through ‚ÄúExtensions and Updates‚Äù. <br>  ¬∑ Manually install an analyzer for each project: <br><img src="https://habrastorage.org/files/7cc/9b2/f6c/7cc9b2f6c6f749e1869bb3a3b313158f.png"><br><br>  ¬∑ Analyzers can also be distributed via NuGet along with the library, or simply installed via Managed NuGet Packages: <br><img src="https://habrastorage.org/files/ecc/86e/c53/ecc86ec537aa4474845a05243370b0e5.jpg"><br><br>  In this case, the link to the package will be registered in the source control, which will allow all project participants to use one set of analyzers. <br><br><h5>  Testability </h5><br>  When developing a plug-in for ReSharper, most of all I lacked simple unit tests.  The JetBrains team has developed a serious testing infrastructure, but all tests are integration tests.  In R #, there are no abstract tests, they all fall into one of the categories: testing the availability of a context action, testing the result of a ‚Äúfix‚Äù, etc.  In this case, the test must necessarily slip the cs-file with the code, which will be used to run the analyzer and another file to compare the results.  Check your business logic in isolation is impossible! <br>  In Roslin went a simpler way.  Analyzers work with syntactic and semantic trees (Syntax Tree and Semantic Tree), which are easy to create in tests from a file or from a string.  As a result, in the test you can check the analyzer itself, or you can check your business model by passing fragments of the syntax tree to it: <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SimpleTestWarningOnEmptyBlockThatCatchesException</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> test = <span class="hljs-string"><span class="hljs-string">@" using System; namespace ConsoleApplication1 { class TypeName { public static void Foo() { try { Console.WriteLine(); } {on}catch(System.Exception) {} } } }"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> warningPosition = test.IndexOf(<span class="hljs-string"><span class="hljs-string">"{on}"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> diagnostic = GetSortedDiagnostics(test.Replace(<span class="hljs-string"><span class="hljs-string">"{on}"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)).Single(); Assert.AreEqual(EmptyCatchBlockAnalyzer.DiagnosticId, diagnostic.Id); Assert.AreEqual(<span class="hljs-string"><span class="hljs-string">"'catch(System.Exception)' block is empty. Do you really know what the app state is?"</span></span>, diagnostic.GetMessage()); Assert.AreEqual(warningPosition, diagnostic.Location.SourceSpan.Start); }</code> </pre> <br><br>  Also very pleased that the tests run quickly, because despite the several million lines of code in the project Roslyn, it is well structured and do not have to load dozens of extra assemblies. <br><br><h5>  Opportunities </h5><br>  So what can the resulting analyzer get?  At the moment, it supports six basic rules: <br><br><img src="https://habrastorage.org/files/929/0db/ee5/9290dbee5c6a47d5afdea43d72fefa9e.png"><br><br>  Each of these is easiest to demonstrate with an example.  Some examples are shown using animation, which is far from ideal.  VS2015 is installed on a virtual machine and image capturing is a bit messy.  But the essence will be clear. <br><br>  <b>1. Empty catch block considered harmful</b> <b>!</b> <br><br>  The most serious code smell when dealing with exceptions is the complete suppression of all exceptions with an empty <b>catch</b> or <b>catch (Exception) block</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f5/60b/11f/7f560b11fb2b470418b09a83f605fd53.gif" alt="image"><br><br>  <b>2. Swallow exceptions considered harmful</b> <br>  A special place on the boiler must be prepared for those who intercept all exceptions using the <b>catch {}</b> block.  The fix in this case is very simple: adding <b>throw;</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf7/fbc/7f3/bf7fbc7f3ec1d3551784ef568f0348e9.png" alt="image"><br><br>  <b>3. Catch block swallows an exception</b> <br><br>  Another analyzer that warns about the suppression of exceptions.  The catch block may not be empty, but it may still ‚Äúswallow‚Äù exceptions.  In this case, it is quite hard to come up with the correct fix, especially when suppressing an exception occurs only in one of the branches of the catch block: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/546/40c/7e4/54640c7e4cf30163912c987cdcc6e99a.jpg" alt="image"><br><br>  Yes, an attempt to make such an analyzer without Roslin would lead to months of work and still, he would have been crooked into the board.  Roslin has built-in support for analysis of the execution flow (control flow analysis), on the basis of which it was not difficult to make this analyzer. <br><br>  <b>4. Rethrow exception properly</b> <br><br>  This is one of the most common errors when throwing an exception with <b>throw ex;</b>  rather than using <b>throw</b> <b>.</b>  Just in case, let me remind you that in the first case, the stack trace of the original exception will be lost and there will be an impression that the catch block is the source. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fe6/7f0/ca6/fe67f0ca67f400c307ce4122bc3b9b9b.gif" alt="image"><br><br>  <b>5. Tracing ex.Message considered harmful</b> <br><br>  Another typical exception handling error when only <b>ex.Message</b> and <b>ex.StackTrace are</b> saved to the console or log.  Since exceptions very often form an exception tree, a top-level message may contain nothing useful at all! <br><br>  This analysis issues a warning if the catch block uses (‚Äúobserves‚Äù) the <b>Message</b> property, but is not interested in the details of the exclusions inside. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/313/026/2b1/3130262b113f94f4335660dcd0096002.gif" alt="image"><br><br>  It was because of such a beautiful model of exception tracing that I had to go to work on the first of January and fill in a hotfix on the prod, which would make it clear what‚Äôs going on with the system.  Never log just <b>ex.Message</b> !  NEVER! <br><br>  <strong>6. Add catched exception as inner exception</strong> <br><br>  The <strong>catch block</strong> may throw an exception, but even in this case, information about the original exception may be lost.  To avoid this, a new exception must contain the original exception as a nested one. <br>  This analyzer checks the code for generating a new exception and if the original exception is not used, it suggests adding it as a nested one (of course, for this, the generated exception must have a constructor that takes a pair of parameters - <strong>string</strong> and <strong>Exception</strong> ): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8d1/ff2/844/8d1ff2844b8b19fcac2d90a2c8f64401.gif" alt="image"><br><br><h5>  Instead of conclusion </h5><br><br>  I do not want to dwell in detail on the development of the analyzer itself, at least not in this post.  There are some pretty good examples on the web (links at the end of the article), and besides, I do not consider myself an expert in this matter.  The meaning of this post is to show the ease of creating an analyzer with your own hands, since Roslin will do all the hard work for you.  So if suddenly you have some typical problem with the code in the team and you want to formalize a certain coding standard, then writing your own analyzer will be a good idea. <br><br><h5>  Additional links </h5><br><br><ul><li>  <a href="https://github.com/SergeyTeplyakov/ExceptionAnalyzer">Exception Analyzer on github</a> <br></li><li>  <a href="https://www.nuget.org/packages/ExceptionAnalyzer/">Exception Analyzer on Nuget.org</a> (available via the Add NuGet Package, only nuget.org should be used as the feed, not api.nuget.org) <br></li><li>  <a href="https://visualstudiogallery.msdn.microsoft.com/ef473182-2549-439c-9bf9-8582e4bdcebe">Exception Analyzer at Visual Studio Gallery</a> </li></ul><br><br>  A couple of introductory articles in MSDN Magazine about creating analyzers: <br><ul><li>  <a href="https://msdn.microsoft.com/en-us/magazine/dn879356.aspx">Use Roslyn for Your API</a> <br></li><li>  <a href="https://msdn.microsoft.com/en-us/magazine/dn904670.aspx">Adding a Code Fix to Your Roslyn Analyzer</a> </li></ul><br><br>  ZY  If you have any wishes for the exception analyzer, then whistle, I will gladly add them. </div><p>Source: <a href="https://habr.com/ru/post/253833/">https://habr.com/ru/post/253833/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253821/index.html">Tool Preview and SDK for Windows 10 Application Development</a></li>
<li><a href="../253823/index.html">Mystical data center</a></li>
<li><a href="../253825/index.html">Release DBMS InterSystems Cach√© 2015.1</a></li>
<li><a href="../253827/index.html">We do our job in Xcode a little more efficiently.</a></li>
<li><a href="../253831/index.html">Press release: ‚ÄúStartup SketchBuilder is entering the international market‚Äù</a></li>
<li><a href="../253835/index.html">Not quite well-known solutions for the protection of IT business infrastructure</a></li>
<li><a href="../253839/index.html">Automation of stock trading on the MICEX on the example of the terminal from Alfa Bank</a></li>
<li><a href="../253841/index.html">20 years of building and maintaining a satellite network</a></li>
<li><a href="../253845/index.html">Overview of the practical side of Bitcoin</a></li>
<li><a href="../253847/index.html">Data center construction boom starts in Iceland</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>