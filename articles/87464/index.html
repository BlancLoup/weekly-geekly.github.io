<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Extension authors, browser hackers, meet js-ctypes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is (you may ask) js-ctypes? Let's say you write an extension in javascript, and it needs to refer to the native code. For example, weave-crypto h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Extension authors, browser hackers, meet js-ctypes</h1><div class="post__text post__text-html js-mediator-article">  What is (you may ask) js-ctypes?  Let's say you write an extension in javascript, and it needs to refer to the <i>native code.</i>  For example, weave-crypto has to access the NSS library.  And your extension may wish, for example, to call directly NSPR, libc, or Win32 functions.  Right now there are two options: either use scripted XPCOM interfaces (provided by libxul), or write and implement your own XPCOM interfaces, that is, supply binary code in its extension.  If the first option is no good, only the second remains, but then it becomes much more difficult to deliver the extension: you have to separately compile the binary code for each of the supported platforms in order to pack it inside your cross-platform xpi. <br><br>  The answer to this difficulty will therefore be the js-ctypes library: it allows javascript to call local code (written in C) and manipulate sishnyh data types without using XPCOM, and there is no need to compile any line of code.  This means that you do not have to define XPCOM interfaces, and that you can use <i>shared libraries,</i> like libc, directly.  There is also a side benefit: we mostly eliminate XPConnect data type conversion losses, so code execution can become faster.  (I'll compare the speed in one of the subsequent blog posts.) The js-ctypes library will be shipped with Gecko 1.9.3, and this platform (if the version numbers do not change) will become the foundation for Firefox 3.7. <br><br>  You may ask: "But how ...?".  And here are some examples (they were tested on x86 32-bit linux and contain <nobr>non-cross-platform parts):</nobr> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  <b>1) Opening the library.</b> <blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//    ctypes.</font> <br> Components.utils.import( <font color="#A31515">"resource://gre/modules/ctypes.jsm"</font> ); <br> <br> <font color="#008000">//  libc.</font> <br> let library = ctypes.open( <font color="#A31515">"libc.so.6"</font> ); <br> <br> <font color="#008000">//   fopen,   -:</font> <br> <font color="#008000">//  FILE* fopen(const char* name, const char* mode);</font> <br> let fopen = library.declare( <font color="#A31515">"fopen"</font> , <font color="#008000">//  </font> <br> ctypes.default_abi, <font color="#008000">//   cdecl</font> <br> ctypes.PointerType( <font color="#A31515">"FILE*"</font> ), <font color="#008000">//    (FILE*)</font> <br> ctypes. <font color="#0000ff">char</font> .ptr, <font color="#008000">//   (const char*)</font> <br> ctypes. <font color="#0000ff">char</font> .ptr); <font color="#008000">//   (const char*)</font> <br> <br> <font color="#008000">//  ,     FILE*.</font> <br> let file = fopen( <font color="#A31515">"hello world.txt"</font> , <font color="#A31515">"w"</font> ); <br> <br> <font color="#008000">//   'file'?</font> <br> file.toString(); <br> <font color="#008000">//  "ctypes.PointerType("FILE*")(ctypes.UInt64("0x9781b38"))" ( )</font> <br> <br> // ...      ...</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  <b>2) Definition and use of structural types <i>(struct)</i> and arrays.</b> <blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//  struct   'hostent',   ,</font> <br> <font color="#008000">//      .</font> <br> <font color="#008000">//     :</font> <br> <font color="#008000">//  struct hostent {</font> <br> <font color="#008000">//     char* h_name;      //  </font> <br> <font color="#008000">//     char** h_aliases;  //  ,   </font> <br> <font color="#008000">//     int h_addrtype;     //    IPv4  IPv6</font> <br> <font color="#008000">//     int h_length;      //  ( ) IP-</font> <br> <font color="#008000">//     char** h_addr_list; //  IP- ( )</font> <br> <font color="#008000">//  };</font> <br> let hostent = ctypes.StructType( <font color="#A31515">"hostent"</font> , <br> [{ h_name     : ctypes. <font color="#0000ff">char</font> .ptr                 }, <br> { h_aliases  : ctypes. <font color="#0000ff">char</font> .ptr.ptr             }, <br> { h_addrtype : ctypes. <font color="#0000ff">int</font> }, <br> { h_length    : ctypes. <font color="#0000ff">int</font> }, <br> { h_addr_list : ctypes.uint8_t.array(4).ptr.ptr }]); <br> <br> <font color="#008000">//   'gethostbyname',   -:</font> <br> <font color="#008000">//  struct hostent* gethostbyname(const char* name);</font> <br> let gethostbyname = library.declare( <font color="#A31515">"gethostbyname"</font> , <br> ctypes.default_abi, <br> hostent.ptr, <font color="#008000">//    'hostent'</font> <br> ctypes. <font color="#0000ff">char</font> .ptr); <br> <br> <font color="#008000">//      .</font> <br> let google = gethostbyname( <font color="#A31515">"mail.google.com"</font> ); <br> <br> <font color="#008000">//     struct  'hostent',</font> <br> <font color="#008000">//     'h_name',    </font> <br> <font color="#008000">// .        :</font> <br> <font color="#008000">//  printf("%s", google-&gt;h_name);</font> <br> google.contents.h_name.readString(); <br> <font color="#008000">//  "googlemail.l.google.com"</font> <br> <br> <font color="#008000">//       'h_addr_list',</font> <br> <font color="#008000">//    ,    </font> <br> <font color="#008000">//     IPv4- .</font> <br> <font color="#008000">//   -:</font> <br> <font color="#008000">//  printf("%u.%u.%u.%u", (int) h_addr_list[0][0], (int) h_addr_list[0][1],</font> <br> <font color="#008000">//         (int) h_addr_list[0][2], (int) h_addr_list[0][3]);</font> <br> google.contents.h_addr_list.contents.contents.toString(); <br> <font color="#008000">//  <font color="#A31515">"ctypes.uint8_t.array(4)([74, 125, 19, 17])"</font> ,   74.125.19.17</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  <b>3) Creating C-like pointers to functions pointing to javascript functions.</b> <br><br>  (Note that this part of the library is not ready yet, but we are working on a patch.) <blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//    ,    </font> <br> <font color="#008000">//  ,   :</font> <br> <font color="#008000">// -1,  i &lt; j;</font> <br> <font color="#008000">// 0,  i == j;</font> <br> <font color="#008000">// 1,  i &gt; j.</font> <br> <font color="#008000">//  - :</font> <br> <font color="#008000">//  typedef int (comparator_t*)(const int8_t* i, const int8_t* j);</font> <br> let comparator_t = ctypes.FunctionType(ctypes.default_abi, ctypes. <font color="#0000ff">int</font> , <br> ctypes.int8_t.ptr, ctypes.int8_t.ptr); <br> <br> <font color="#008000">//  - 'comparator_t'?</font> <br> comparator_t.name; <br> <font color="#008000">//  "int (*)(int8_t*,int8_t*)"</font> <br> <br> <font color="#008000">//   'qsort',    ,</font> <br> <font color="#008000">//   ,   .</font> <br> <font color="#008000">//  void qsort(void* array, size_t length, size_t elemsize, comparator_t comp);</font> <br> let qsort = library.declare( <font color="#A31515">"qsort"</font> , ctypes.default_abi, ctypes.void_t, <br> ctypes.voidptr_t, ctypes.size_t, ctypes.size_t, comparator_t); <br> <br> <font color="#008000">//   ,    'comparator_t'.</font> <br> function reverse(i, j) { <font color="#0000ff">return</font> j.contents - i.contents; } <br> <br> <font color="#008000">//     ,     .</font> <br> let reverse_ptr = comparator_t(reverse); <br> <br> <font color="#008000">//   'reverse_ptr'?</font> <br> reverse_ptr.toString(); <br> <font color="#008000">//  "ctypes.FunctionType(ctypes.default_abi, ctypes.int, ctypes.int8_t.ptr,</font> <br> <font color="#008000">//                             ctypes.int8_t.ptr)(ctypes.UInt64("0x81a430cb"))"</font> <br> <br> <font color="#008000">//      'qsort'.</font> <br> let array_t = ctypes.int8_t.array(); <br> let ints = array_t([3, 1, 5, 6, 4, 2]); <br> qsort(ints.address(), ints.length, array_t.elementType.size, reverse_ptr); <br> <br> <font color="#008000">// !</font> <br> ints.toString(); <br> <font color="#008000">//  <font color="#A31515">"ctypes.int8_t.array(6)([6, 5, 4, 3, 2, 1])"</font></font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  So, if you're the author of the extension, <nobr>or writing</nobr> code <nobr>for the browser,</nobr> <nobr>keep in mind</nobr> <nobr>js-ctypes ‚Äî</nobr> <nobr>and let us know</nobr> <nobr>how things are going!</nobr> </div><p>Source: <a href="https://habr.com/ru/post/87464/">https://habr.com/ru/post/87464/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../87455/index.html">Pi day!</a></li>
<li><a href="../87459/index.html">Default search on iPad?</a></li>
<li><a href="../87460/index.html">Deployment your software for OS Inferno</a></li>
<li><a href="../87461/index.html">Aviary is available in Google Apps</a></li>
<li><a href="../87462/index.html">Comparing video quality via HTML5 and Flash using YouTube as an example using Chrome 5.0.342.3 dev and Win 7 browser</a></li>
<li><a href="../87467/index.html">HabrTree - minimizing script</a></li>
<li><a href="../87471/index.html">Improving notify-send. Adding a new message to the previous one</a></li>
<li><a href="../87472/index.html">network testing in Linux</a></li>
<li><a href="../87473/index.html">All by post</a></li>
<li><a href="../87474/index.html">Yii 1.1.1 and 1.0.12</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>