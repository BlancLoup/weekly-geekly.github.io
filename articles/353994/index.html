<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Operating systems from scratch; level 3 (younger half)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this lab, we will implement the ability to run custom programs. Those. processes and all dependent infrastructure. In the beginning we will figure ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Operating systems from scratch; level 3 (younger half)</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vk/l6/-w/vkl6-wspjbnrgwtxygyme0nyobu.gif"></div><br><p>  In this lab, we will implement the ability to run custom programs.  Those.  processes and all dependent infrastructure.  In the beginning we will figure out how to switch from privileged code, how to switch process contexts.  Then we implement a simple round-robin scheduler, system calls and virtual memory management.  In the end, we will derive our shell from kernel space to user space. </p><br><p>  <a href="https://web.stanford.edu/class/cs140e/assignments/3-spawn/">original</a> </p><br><p>  <a href="https://habrahabr.ru/post/349248/">Null lab</a> </p><br><p>  First Laba: the <a href="https://habrahabr.ru/post/351082/">younger half</a> and the <a href="https://habrahabr.ru/post/351774/">older half</a> </p><br><p>  The second laba: the <a href="https://habrahabr.ru/post/352414/">younger half</a> and the <a href="https://habrahabr.ru/post/353024/">older half</a> </p><a name="habracut"></a><br><h2 id="poleznosti">  Utility </h2><br><ul><li>  <a href="https://doc.rust-lang.org/book/second-edition/">Book of Rust v2</a> .  All the necessary info for Rust, required in this course. </li><li>  <a href="https://doc.rust-lang.org/nightly/std/">Rust Standard Library Documentation</a> </li><li>  <a href="https://web.stanford.edu/class/cs140e/docs/BCM2837-ARM-Peripherals.pdf">BCM2837 documentation</a> .  Our modified version of the BCM2835 documentation with fixes for the BCM2837. </li><li>  <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ARMv8 Reference Manual</a> .  ARMv8 Architecture Reference Guide  This is a complete guide covering the entire architecture.  For a specific implementation of the architecture, see the ARM Cortex A53 Manual. </li><li>  <a href="https://web.stanford.edu/class/cs140e/docs/ARM-Cortex-A53-Manual.pdf">ARM Cortex-A53 Manual</a> .  Guide for a specific implementation of the ARMv8 architecture (v8.0-A).  This is what is used in the malinka. </li><li>  <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-A-Programmer-Guide.pdf">Programmer's Guide ARMv8-A</a> .  ARMv8-A High Level Programming Manual. </li><li>  <a href="https://web.stanford.edu/class/cs140e/docs/AArch64-Procedure-Call-Standard.pdf">AArch64 Procedural Call Standard</a> <br>  The standard standard procedure for the AArch64 architecture. </li><li>  <a href="https://web.stanford.edu/class/cs140e/docs/AArch64-ISA-Cheat-Sheet.pdf">ARMv8 ISA Cheat Sheet</a> .  A brief description of the ARMv8 assembly instructions presented in this lab.  For authorship Griffin Dietz. </li></ul><br><h2 id="faza-0-nachalo-raboty">  Phase 0: Getting Started </h2><br><p>  As in the previous parts, for guaranteed work it is required: </p><br><ul><li>  Machine with a modern Unix: Linux, BSD or macOS. </li><li>  64-bit OS. </li><li>  USB port available. </li><li>  Installed software from previous releases. </li></ul><br><h3 id="poluchenie-koda">  Getting the code </h3><br><p> In the <code>3-spawn</code> turnip, there is nothing but questions, but no one interferes with stealing: </p><br><pre> <code class="hljs ruby">git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/web.stanford.edu/class</span></span><span class="hljs-regexp"><span class="hljs-regexp">/cs140e/assignments</span></span><span class="hljs-regexp"><span class="hljs-regexp">/3-spawn/skeleton</span></span>.git <span class="hljs-number"><span class="hljs-number">3</span></span>-spawn</code> </pre> <br><p>  After that, when it‚Äôs useless, the directory structure should look something like this: </p><br><pre> <code class="hljs dos">cs140e ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">0</span></span>-blinky ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">1</span></span>-shell ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">2</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">fs</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">3</span></span>-spawn ‚îî‚îÄ‚îÄ os</code> </pre> <br><p>  But inside the <code>os</code> -repy it will still be necessary to switch to the <code>3-spawn</code> branch: </p><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> os git fetch git checkout <span class="hljs-number"><span class="hljs-number">3</span></span>-spawn git merge <span class="hljs-number"><span class="hljs-number">2</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">fs</span></span></code> </pre> <br><p>  Most likely you will again see merge conflicts.  Something like this: </p><br><pre> <code class="hljs pgsql">Auto-merging kernel/src/kmain.rs <span class="hljs-keyword"><span class="hljs-keyword">CONFLICT</span></span> (content): Merge <span class="hljs-keyword"><span class="hljs-keyword">conflict</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> kernel/src/kmain.rs Automatic merge failed; fix conflicts <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> the result.</code> </pre><br><p>  Conflicts of merge need to be resolved manually by changing the file <code>kmain.rs</code> .  In doing so, you need to make sure that you saved all your changes from labs 2. After the conflicts have been resolved, add the <code>git add</code> files and commit it all.  In order to get more information on this topic - see the <a href="https://githowto.com/ru/resolving_conflicts">tutorial on githowto.com</a> . </p><br><h3 id="dokumentaciya-arm">  ARM Documentation </h3><br><p>  In this task, we will constantly refer to three official documents on ARM.  These three: </p><br><ol><li>  <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ARMv8 Reference Manual</a> <br>  This is the official ARMv8 architecture reference manual.  A complete guide that covers the entire architecture.  For the concrete implementation of this architecture in the process, we will need manual # 2.  We will refer to sections of this large manual on ARMv8 by means of notes of the form ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : C5.2).  In this case, this means that you need to look at the <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ARMv8 Reference Manual</a> in section C5.2. </li><li>  <a href="https://web.stanford.edu/class/cs140e/docs/ARM-Cortex-A53-Manual.pdf">ARM Cortex-A53 Manual</a> <br>  This is a manual for a very specific implementation of ARMv8 (v8.0-A), which is used in Malinka.  This manual will be referred to as notes of the form ( <a href="https://web.stanford.edu/class/cs140e/docs/ARM-Cortex-A53-Manual.pdf">A53</a> : 4.3.30). </li><li>  <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-A-Programmer-Guide.pdf">ARMv8-A Programmer Guide</a> <br>  Now we have a fairly high-level programming manual ARMv8-A.  We will refer to it as notes ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-A-Programmer-Guide.pdf">guide</a> : 10.1) </li></ol><br><p>  I highly recommend that you download these manuals to your disk.  So it will be easier to open them every time.  Especially the first because it is very, very large.  By the way about this. </p><br><p>  How do you even read this?  We do not need to read it completely.  Therefore, it is extremely important to start to know what we want to find in this manual.  This manual has a good fit structure.  It is divided into several parts.  We are interested in AArch64 and are not interested in too deep immersion (we are not processor manufacturers).  So we are not interested in many chapters from the word at all.  In fact, parts of A, B and some information from C and D are enough for us. In the first two parts, the general concepts are described as applied to architecture and to AArch64 in particular.  Part C describes the instruction set.  We will use this part as reference for the most basic instructions and registers (for example, SIMD does not interest us now).  Part D describes some details of the AArch64.  In particular, about interrupts and all that. </p><br><h2 id="faza-1-arm-and-a-leg-ruka-i-noga">  Phase 1: ARM and a Leg (Hand and foot) </h2><br><p>  In this phase, we will study the ARMv8 architecture, switch to a less privileged level, tweak processor exception vectors, handle timer interrupts and breakpoints interrupt.  Examine the exception levels in the ARM architecture.  We are mainly interested in how to catch these exceptions and interrupts. </p><br><h3 id="subfaza-a-obzor-armv8">  Subphase A: ARMv8 Overview </h3><br><p>  In this subphase, we will study the architecture of ARMv8.  Here we will not write any code, but there are questions for self-examination. </p><br><p>  ARM (Acron RISC Machine) is a microprocessor architecture with more than 30 years of history.  Currently there are eight versions of this architecture.  The latest ARMv8 was introduced in 2011.  The Broadcom BCM2837 chip contains the ARM Cortex-A53 cores, which are ARMv8.0 based cores.  Cortex-A53 (and the like) is an <em>implementation of the</em> architecture.  And this is the realization that we will study in this whole part. </p><br><blockquote>  <strong>ARM microprocessors dominate the mobile market.</strong> <br><br>  ARM is approximately 95% of the global smartphone market and 100% of the flagship smartphones.  Including Apple iPhone or Google Pixel. </blockquote><p>  So far, we have tried to avoid issues related to the processor architecture.  Rust did everything for us.  In order to work with us in usspaces, we will need to carry out a certain amount of work at a low level.  Programming directly proceeds will require familiarization with the assembler of this architecture and with all related concepts around it.  We'll start with an overview of the architecture and deal with the most basic assembler instructions. </p><br><h4 id="registry">  Registers </h4><br><p>  The ARMv8 architecture has the following registers ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : D1.2.1): </p><br><ul><li>  <code>r0</code> ... <code>r30</code> - 64-bit general purpose registers.  Access to registers is carried out by pseudonyms (aliases).  The registers <code>x0</code> ... <code>x30</code> are aliases for the 64-bit version (ie, full).  There are aliases <code>w0</code> ... <code>w30</code> .  The latter access the lower 32 bits of the register. </li><li>  <code>lr</code> - 64-bit reference register.  Alias ‚Äã‚Äãfor <code>x30</code> .  Used to store a jump address.  The <code>bl &lt;addr&gt;</code> instruction saves the current command counter (PC) to <code>lr</code> and goes to the address <code>addr</code> .  The <code>ret</code> work will be done by the <code>ret</code> instruction.  She will take the address from <code>lr</code> and assign it to the PC. </li><li>  <code>sp</code> - stack pointer.  The lower 32 bits are available by <code>wsp</code> .  The stack pointer should always be aligned by 16 bytes. </li><li>  <code>pc</code> - program counter.  This register can not be written directly, but can be read.  It is updated on the transition instructions, when calling interrupts, when returning. </li><li>  <code>v0</code> ... <code>v31</code> - 128-bit SIMD and FP registers.  These are used for SIMD vector operations and for floating point operations.  These registers are available by alias.  <code>q0</code> ... <code>q31</code> - aliases for all 128 bits of the register.  Registers <code>d0</code> ... <code>d31</code> are the lower 64 bits.  Besides, there are aliases for the lower 32, 16 and 8 bits in the prefixes <code>s</code> , <code>h</code> and <code>b</code> respectively. </li><li>  <code>xzr</code> is a null case.  This is a pseudo-register, which may or may not be a hardware register.  Always contains <code>0</code> .  This register can only be read. </li></ul><br><p>  There are <em>many</em> more <em>special-purpose registers</em> .  We will talk about them a bit later. </p><br><h4 id="pstate">  PSTATE </h4><br><p>  At any time, the percent ARMv8 allows you to access the program status through a pseudo-register named PSTATE ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : D1.7).  This is not an ordinary case.  It cannot be read or written to it directly.  Instead, there are several special-purpose registers that can be used to operate on parts of the PSTATE pseudo-register.  On ARMv8.0 this is: </p><br><ul><li>  <code>NZCV</code> status flags </li><li>  <code>DAIF</code> - bit mask of exceptions, which is used to enable and disable these exceptions. </li><li>  <code>CurrentEL</code> - the current level of exceptions (to be described later) </li><li>  <code>SPSel</code> - stack pointer selector (there are actually several) </li></ul><br><p>  Similar registers belong to the class of system or special registers ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : C5.2).  Regular registers can be read from RAM with <code>ldr</code> or written to memory with <code>str</code> .  System registers cannot be used this way.  Instead, you need to use special commands <code>mrs</code> and <code>msr</code> ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : C6.2.162 - C6.2.164).  For example, in order to read the <code>NZCV</code> in <code>x1</code> we should use the following entry: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mrs</span></span> x1, NZCV</code> </pre> <br><h4 id="sostoyanie-vypolneniya">  Execution status </h4><br><p>  At any point in time, ARMv8 percent is executed with a certain execution state.  In total, there are exactly two such states.  AArch32 - compatibility mode with 32-bit ARMv7.  And AArch64 - 64-bit ARMv8 mode ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-A-Programmer-Guide.pdf">guide</a> : 3.1).  We will only work with AArch64. </p><br><h4 id="bezopasnyy-rezhim">  Safe mode </h4><br><p>  At any given time, our percents are executed with a certain security state (guide: 3).  This garbage can also be searched for in security mode or security world.  Only two states: <em>secure</em> and <em>non-secure</em> .  Those.  safe and ordinary.  We will work entirely as usual. </p><br><h4 id="urovni-isklyucheniy">  Exception levels </h4><br><p>  Besides, there are also exception levels ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-A-Programmer-Guide.pdf">guide</a> : 3).  Each level of exceptions corresponds to a certain level of privilege.  The higher the level of exceptions, the more privileges the program starts at this level.  There are 4 levels in total: </p><br><ul><li>  <strong>EL0 (user)</strong> - Usually used to run custom prog. </li><li>  <strong>EL1 (kernel)</strong> - Privileged mode.  Usually the kernel of the operating system starts here. </li><li>  <strong>EL2 (hypervisor)</strong> - Usually used to start virtual machine hypervisors. </li><li>  <strong>EL3 (monitor)</strong> - Usually used for low-level firmware. </li></ul><br><p>  The Raspberry Pi processor is loaded into EL3.  At this stage, the firmware is launched, provided by the Raspberry Pi foundation.  The firmware switches the processor to EL2 and runs our kernel8.img <code>kernel8.img</code> .  Thus, our core starts from EL2.  A little later, we will switch from EL2 to EL1, so that our core works at the appropriate level of exceptions. </p><br><h4 id="registry-elx">  ELx registers </h4><br><p>  A number of system registers, such as <code>ELR</code> , <code>SPSR</code> and <code>SP</code> , are duplicated for each exception level.  At the same time, the suffix <code>_ELn</code> is put to their names, where <code>n</code> is the level of exceptions to which this register belongs.  For example, <code>ELR_EL1</code> is the <em>exception reference register</em> for EL1, and <code>ELR_EL2</code> is the same, but for EL2. </p><br><p>  We will use the <code>x</code> suffix (for example in <code>ELR_ELx</code> ) when we need to refer to a register from the target exception level <code>x</code> .  The target exception level is the exception level to which the CPU switches (if necessary) when the exception vector is triggered. </p><br><p>  We will use the suffix <code>s</code> (for example, in <code>SP_ELs</code> , when you need to refer to the register in the original exception level <code>s</code> . The original exception level is the exception level at which the CPU was executed before the exception occurred. </p><br><h4 id="pereklyuchenie-mezhdu-urovnyami-isklyucheniy">  Switch between exception levels </h4><br><p>  There is exactly one mechanism for increasing the level of exclusion and exactly one mechanism for reducing the level of exclusion. </p><br><p>  To switch from a higher level to a lower level (privilege reduction), the running program must perform a <em>return</em> (return) from this level of elimination using the <code>eret</code> ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : D1.11).  When executing the <code>eret</code> for an <code>ELx</code> processor level: </p><br><ul><li>  Set the PC to the value from the special register <code>ELR_ELx</code> . </li><li>  Set PSTATE to value from special register <code>SPSR_ELx</code> . </li></ul><br><p>  The <code>SPSR_ELx</code> register ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : C5.2.18), besides, contains the level of exceptions to which it is necessary to go.  In addition, you should pay attention to the following additional effects of changing the levels of exceptions: </p><br><ul><li>  When returning to <code>ELs</code> , <code>sp</code> set to <code>SP_ELs</code> if <code>SPSR_ELx[0] == 1</code> or to <code>SP_EL0</code> if <code>SPSR_ELx[0] == 0</code> . </li></ul><br><p>  The transition from a lower level to a higher one occurs only as a result of an exception ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-A-Programmer-Guide.pdf">guide</a> : 10).  If not configured otherwise, the percents will intercept the exceptions for the next level.  For example, if an interrupt is received while running in EL0, then the percent will switch to EL1 to handle the exception.  When switching to <code>ELx</code> percent will do the following: </p><br><ul><li>  <code>PSTATE.DAIF = 0b1111</code> off (disguises) all exceptions and interrupts: <code>PSTATE.DAIF = 0b1111</code> . </li><li>  <code>PSTATE</code> save <code>PSTATE</code> and any in <code>SPSR_ELx</code> . </li><li>  Store the return address in <code>ELR_ELx</code> ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : D1.10.1). </li><li>  Set <code>sp</code> to <code>SP_ELx</code> if <code>SPSel</code> is <code>1</code> . </li><li>  Set the exception syndrome (we describe this later) in <code>ESR_ELx</code> ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : D1.10.4). </li><li>  Set <code>pc</code> to the address corresponding to the exception vector (we will describe it a bit later). </li></ul><br><p>  Please note that the exception syndrome register is valid only for <em>synchronous</em> exceptions.  All general registers and SIMD / FP registers will contain the values ‚Äã‚Äãthat they had when an exception occurred. </p><br><h4 id="vektory-isklyucheniy">  Exception vectors </h4><br><p>  When exceptions occur, the CPU transfers control to the place where the exception vector is located ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : D1.10.2).  There are 4 types of exceptions, each of which contains 4 possible sources of exceptions.  Those.  total 16 exception vectors.  Here are four types of exceptions: </p><br><ul><li>  <strong>Synchronous</strong> - exceptions caused by instructions like <code>svc</code> or <code>brk</code> .  Well, in general, for any events in which the programmer is guilty. </li><li>  <strong>IRQ</strong> - asynchronous interrupts from external sources. </li><li>  <strong>FIQ</strong> - asynchronous interrupts from external sources.  Version for quick processing. </li><li>  <strong>SError</strong> - system error interrupts. </li></ul><br><p>  Here are four interrupt sources: </p><br><ul><li>  Current exception level with <code>SP = SP_EL0</code> </li><li>  The current level of exceptions when <code>SP = SP_ELx</code> </li><li>  Lower level exceptions at which AArch64 is running </li><li>  Lower level exceptions at which AArch32 is running </li></ul><br><p>  From the description of the manual ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-A-Programmer-Guide.pdf">guide</a> : 10.4): </p><br><blockquote>  When an exception occurs, the processor must execute the handler code that corresponds to the exception.  The memory location where the handler [exceptions] is stored is called the exception vector.  In the ARM architecture, exception vectors are stored in a table called the exception vector table.  Each exception level has its own vector table, that is, for each of EL3, EL2, and EL1.  The table contains instructions for execution, not a set of addresses [as in x86].  Each record in the vector table has a size of 16 instructions.  Vectors for individual exceptions are arranged with fixed offsets from the beginning of the table.  The virtual address of each table is based on the [special] vector address registers <code>VBAR_EL3</code> , <code>VBAR_EL2</code> and <code>VBAR_EL1</code> . </blockquote><p>  These vectors are physically located in memory as follows: </p><br><p>  Current exception level with <code>SP = SP_EL0</code> </p><br><table><thead><tr><th>  Offset from <code>VBAR_ELx</code> </th><th>  An exception </th></tr></thead><tbody><tr><td>  0x000 </td><td>  Synchronized exception </td></tr><tr><td>  0x080 </td><td>  IRQ </td></tr><tr><td>  0x100 </td><td>  FIQ </td></tr><tr><td>  0x180 </td><td>  Seror </td></tr></tbody></table><br><p>  The current level of exceptions when <code>SP = SP_ELx</code> </p><br><table><thead><tr><th>  Offset from <code>VBAR_ELx</code> </th><th>  An exception </th></tr></thead><tbody><tr><td>  0x200 </td><td>  Synchronized exception </td></tr><tr><td>  0x280 </td><td>  IRQ </td></tr><tr><td>  0x300 </td><td>  FIQ </td></tr><tr><td>  0x380 </td><td>  Seror </td></tr></tbody></table><br><p>  Lower level exceptions at which AArch64 is running </p><br><table><thead><tr><th>  Offset from <code>VBAR_ELx</code> </th><th>  An exception </th></tr></thead><tbody><tr><td>  0x400 </td><td>  Synchronized exception </td></tr><tr><td>  0x480 </td><td>  IRQ </td></tr><tr><td>  0x500 </td><td>  FIQ </td></tr><tr><td>  0x580 </td><td>  Seror </td></tr></tbody></table><br><p>  Lower level exceptions at which AArch32 is running </p><br><table><thead><tr><th>  Offset from <code>VBAR_ELx</code> </th><th>  An exception </th></tr></thead><tbody><tr><td>  0x600 </td><td>  Synchronized exception </td></tr><tr><td>  0x680 </td><td>  IRQ </td></tr><tr><td>  0x700 </td><td>  FIQ </td></tr><tr><td>  0x780 </td><td>  Seror </td></tr></tbody></table><br><h4 id="rezyume">  Summary </h4><br><p>  Currently, this is all we need to know about the ARMv8 architecture.  Before continuing, try to answer these questions.  For self test. </p><br><blockquote>  <strong>What are the aliases for register <code>x30</code> ?</strong>  [arm-x30] <br><br>  If we write <code>0xFFFF</code> to the <code>x30</code> register, what other two names of this register can we use to retrieve this value? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <strong>How can I change the PC value to a specific address?</strong>  [arm-pc] <br><br>  How can I set the PC to address <code>A</code> using the <code>ret</code> instruction?  How to set PC to address <code>A</code> using <code>eret</code> instruction?  Specify which registers you will change in order to achieve this. <br><br>  <strong>How can I determine the current level of exceptions?</strong>  [arm-el] <br><br>  What specific instructions would you follow to determine the current level of exclusion? <br><br>  <strong>How would you change the stack pointer to return an exception?</strong>  [arm-sp-el] <br><br>  The stack pointer of the running program is <code>A</code> at the time the exception occurred.  After processing the exception, you want to go back to where the program was running, but you want to change the stack pointer to <code>B</code>  How do you do this? <br><br>  <strong>Which vector is used for system calls from a lower EL?</strong>  [arm-svc] <br><br>  The user process is performed on EL0.  This process calls <code>svc</code> .  What address will be transferred to management? <br><br>  <strong>Which vector is used for interrupts from a lower EL?</strong>  [arm-int] <br><br>  The user process is performed on EL0.  At this point, a timer interrupt occurs.  What address will be transferred to management? <br><br>  <strong>How can I enable IRQ exception handling?</strong>  [arm-mask] <br><br>  In which register, what values ‚Äã‚Äãneed to be written in order to unlock IRQ interrupts? <br><br>  <strong>How would you use <code>eret</code> to enable AArch32 mode?</strong>  [arm-aarch32] <br><br>  The source of the exception is AArch64.  The handler for this exception is also on AArch64.  What values ‚Äã‚Äãin which registers would you change so that when returning from an exception via <code>eret</code> percent switches to the AArch32 execution mode? <br>  <strong>Hint</strong> : Watch ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-A-Programmer-Guide.pdf">guide</a> : 10.1) </blockquote><br><h3 id="subfaza-b-instrukcii-assemblera">  Subphase B: Assembly instructions </h3><br><img align="right" width="350" title="This art itself appeared here.  I have nothing to do with it." src="https://habrastorage.org/webt/qo/za/ja/qozajatws7f4x-lsbbgdmc1i4ke.png"><br><p>  In this subphase, we will explore the most basic commands from the ARMv8 command set.  We will not write the code right now, but there are a couple of questions for self-testing. </p><br><h4 id="dostup-k-pamyati">  Memory access </h4><br><p>  ARMv8 is a set of RISC download / storage instructions (a computer with a reduced instruction set).  The defining feature of such a set of commands can be called the small fact that memory access can only be done through clearly defined instructions.  In particular, the memory can only be read by reading into the register by the loading instruction, and it can only be written by the save instruction. </p><br><p>  There are many instructions for loading / unloading (load / store) in different variations (for the most part they are of the same type).  Let's start with the simplest form: </p><br><ul><li>  <code>ldr &lt;ra&gt;, [&lt;rb&gt;]</code> : loads the value from the <code>&lt;rb&gt;</code> address into <code>&lt;ra&gt;</code> . </li><li>  <code>str &lt;ra&gt;, [&lt;rb&gt;]</code> : saves the value of <code>&lt;ra&gt;</code> to an address from <code>&lt;rb&gt;</code> . </li></ul><br><p>  The <code>&lt;rb&gt;</code> <em>register</em> is called the <em>base register</em> .  For example, if <code>r3 = 0x1234</code> , then: </p><br><pre> <code class="hljs markdown">ldr r0, [r3] // r0 = <span class="hljs-emphasis"><span class="hljs-emphasis">*r3 ( , r0 = *</span></span>(0x1234)) str r0, [r3] // <span class="hljs-emphasis"><span class="hljs-emphasis">*r3 = r0 ( , *</span></span>(0x1234) = r0)</code> </pre> <br><p>  In addition, you can add an offset from the interval <code>[-256, 255]</code> : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ldr</span></span> r0, [r3, <span class="hljs-comment"><span class="hljs-comment">#64] // r0 = *(r3 + 64) str r0, [r3, #-12] // *(r3 - 12) = r0</span></span></code> </pre> <br><p>  You can also specify a post index that changes the value in the base register <em>after</em> applying the load or saving: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ldr</span></span> r0, [r3], <span class="hljs-comment"><span class="hljs-comment">#30 // r0 = *r3; r3 += 30 str r0, [r3], #-12 // *r3 = r0; r3 -= 12</span></span></code> </pre> <br><p>  Or pre-index, which will change the value in the base register <em>before</em> applying the load or save: </p><br><pre> <code class="hljs erlang-repl">ldr r0, [r3, #<span class="hljs-number"><span class="hljs-number">30</span></span>]! // r3 += <span class="hljs-number"><span class="hljs-number">30</span></span>; r0 = *r3 str r0, [r3, #-<span class="hljs-number"><span class="hljs-number">12</span></span>]! // r3 -= <span class="hljs-number"><span class="hljs-number">12</span></span>; *r3 = r0</code> </pre> <br><p>  Offset, post-index and pre-index, they are known as <em>addressing modes</em> . </p><br><p>  In addition, there is another command that can load / unload two registers at once.  <code>ldp</code> and <code>stp</code> instructions (load pair, store pair).  These instructions can be used with the same addressing modes as <code>ldr</code> and <code>str</code> . </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/  `x0`  `x1`  .     : /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |------| &lt;x ( SP) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | x1 | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |------| /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | x0 | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |------| &lt;- SP /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ stp x0, x1, [SP, #-16]! /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  `x0`  `x1`  .     : /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |------| &lt;- SP /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | x1 | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |------| /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | x0 | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |------| &lt;x (original SP) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ldp x0, x1, [SP], #16 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       ,     sub SP, SP, #16 stp x0, x1, [SP] ldp x0, x1, [SP] add SP, SP, #16 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   ,      x0, x1, x2,  x3. sub SP, SP, #32 stp x0, x1, [SP] stp x2, x3, [SP, #16] ldp x0, x1, [SP] ldp x2, x3, [SP, #16] add SP, SP, #32</span></span></code> </pre> <br><h4 id="neposredstvennaya-zagruzka-znacheniy">  Direct loading of values </h4><br><p>  The immediate (immediate) value is another name for an integer whose value is known without any computation.  In order to load (for example) the 16-bit immediate into the register, optionally moving it a certain number of bits to the left, we need the command <code>mov</code> (move).  In order to load the same 16 bits with a shift, but without replacing the other bits, we need <code>movk</code> (move / keep).  Here is an example of using all of this: </p><br><pre> <code class="hljs delphi">mov x0, <span class="hljs-string"><span class="hljs-string">#0</span></span>xABCD, LSL <span class="hljs-string"><span class="hljs-string">#32</span></span> <span class="hljs-comment"><span class="hljs-comment">// x0 = 0xABCD00000000 mov x0, #0x1234, LSL #16 // x0 = 0x12340000 mov x1, #0xBEEF // x1 = 0xBEEF movk x1, #0xDEAD, LSL #16 // x1 = 0xDEADBEEF movk x1, #0xF00D, LSL #32 // x1 = 0xF00DDEADBEEF movk x1, #0xFEED, LSL #48 // x1 = 0xFEEDF00DDEADBEEF</span></span></code> </pre> <br><p>  Please note that the values ‚Äã‚Äãthemselves are prefixed with <code>#</code> .  <code>LSL</code> at the same time means a shift to the left. </p><br><p>  Only 16 bits can be loaded into the register with an optional offset.  By the way, the assembler can in many cases determine the necessary shift itself.    <code>mov x12, #(1 &lt;&lt; 21)</code>  <code>mov x12, 0x20, LSL #16</code> . </p><br><h4 id="zagruzka-adresov-iz-metok">     </h4><br><p>         <code>&lt;label&gt;:</code> : </p><br><pre> <code class="hljs cs">add_30: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> x1, x1, <span class="hljs-meta"><span class="hljs-meta">#10 add x1, x1, #20</span></span></code> </pre> <br><p>  ,       ,    <code>adr</code>  <code>ldr</code> : </p><br><pre> <code class="hljs objectivec">adr x0, add_30 <span class="hljs-comment"><span class="hljs-comment">// x0 =     add_30 ldr x0, =add_30 // x0 =     add_30</span></span></code> </pre> <br><p>  <em></em>  <code>ldr</code>         .      <code>adr</code> . </p><br><h4 id="peremeschenie-dannyh-mezhdu-registrami">     </h4><br><p>  ,     ,       <code>mov</code> : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mov</span></span> x13, <span class="hljs-comment"><span class="hljs-comment">#23 // x13 = 23 mov sp, x13 // sp = 23, x13 = 23</span></span></code> </pre> <br><h4 id="rabota-so-specialnymi-registrami">     </h4><br><p>      <code>ELR_EL1</code>   /           <code>mrs</code>  <code>msr</code> . </p><br><p>  ,    -   <code>msr</code> : </p><br><pre> <code class="hljs objectivec">msr ELR_EL1, x1 <span class="hljs-comment"><span class="hljs-comment">// ELR_EL1 = x1</span></span></code> </pre> <br><p>    -  <code>mrs</code> : </p><br><pre> <code class="hljs objectivec">mrs x0, CurrentEL <span class="hljs-comment"><span class="hljs-comment">// x0 = CurrentEL</span></span></code> </pre> <br><h4 id="arifmetika">  </h4><br><p>            <code>add</code>  <code>sub</code> : </p><br><pre> <code class="hljs xml">add <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span> // dest = a + b sub <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span> // dest = a - b</code> </pre> <br><p>  For example: </p><br><pre> <code class="hljs delphi">mov x2, <span class="hljs-string"><span class="hljs-string">#24</span></span> mov x3, <span class="hljs-string"><span class="hljs-string">#36</span></span> add x1, x2, x3 <span class="hljs-comment"><span class="hljs-comment">// x1 = 24 + 36 = 60 sub x4, x3, x2 // x4 = 36 - 24 = 12</span></span></code> </pre> <br><p>     <code>&lt;b&gt;</code>    : </p><br><pre> <code class="hljs pgsql">sub sp, sp, #<span class="hljs-number"><span class="hljs-number">120</span></span> // sp -= <span class="hljs-number"><span class="hljs-number">120</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> x3, x1, #<span class="hljs-number"><span class="hljs-number">120</span></span> // x3 = x1 + <span class="hljs-number"><span class="hljs-number">120</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> x3, x3, #<span class="hljs-number"><span class="hljs-number">88</span></span> // x3 += <span class="hljs-number"><span class="hljs-number">88</span></span></code> </pre> <br><h4 id="logicheskie-instrukcii">   </h4><br><p>  <code>and</code>  <code>orr</code>     <code>AND</code>  <code>OR</code> .  <code>add</code>  <code>sub</code> : </p><br><pre> <code class="hljs ruby">mov x1, 0b11001 mov x2, 0b10101 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x3, x1, x2 /<span class="hljs-regexp"><span class="hljs-regexp">/ x3 = x1 &amp; x2 = 0b10001 orr x3, x1, x2 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ x3 = x1 | x2 = 0b11101 orr x1, x1, x2 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ x1 |= x2 and x2, x2, x1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ x2 &amp;= x1 and x1, x1, #0b110 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ x1 &amp;= 0b110 orr x1, x1, #0b101 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ x1 |= 0b101</span></span></code> </pre> <br><h4 id="vetvlenie">  </h4><br><p>  (Branching) ‚Äî       .   PC       .  ,           <code>b</code> : </p><br><pre> <code class="hljs vhdl">b <span class="hljs-keyword"><span class="hljs-keyword">label</span></span> // jump <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">label</span></span></code> </pre> <br><p>            ( <code>lr</code> ),  <code>bl</code> .  <code>ret</code>     <code>lr</code> : </p><br><pre> <code class="hljs delphi">my_function: add x0, x0, x1 ret mov x0, <span class="hljs-string"><span class="hljs-string">#4</span></span> mov x1, <span class="hljs-string"><span class="hljs-string">#30</span></span> bl my_function <span class="hljs-comment"><span class="hljs-comment">// lr =   `mov x3, x0` mov x3, x0 // x3 = x0 = 4 + 30 = 34</span></span></code> </pre> <br><p>  <code>br</code>  <code>blr</code>  <code>b</code>  <code>bl</code> ,    ,   : </p><br><pre> <code class="hljs dos">ldr x0, =<span class="hljs-built_in"><span class="hljs-built_in">label</span></span> blr x0 //  bl <span class="hljs-built_in"><span class="hljs-built_in">label</span></span> br x0 //  b <span class="hljs-built_in"><span class="hljs-built_in">label</span></span></code> </pre> <br><h4 id="uslovnoe-vetvlenie">   </h4><br><p>  <code>cmp</code>          .          ,  <code>bne</code> (branch not equal), <code>beq</code> (branch if equal), <code>blt</code> (branch if less than)  .. ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : C1.2.4) </p><br><pre> <code class="hljs perl">//  <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">x</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>   ,      x1, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-string"><span class="hljs-string">`function_when_eq`</span></span>,   not_equal: add <span class="hljs-keyword"><span class="hljs-keyword">x</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">x</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">#1 cmp x0, x1 bne not_equal bl function_when_eq exit: ... //   x0 == x1 function_when_eq: ret</span></span></code> </pre> <br><p>  : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">cmp</span></span> x1, <span class="hljs-comment"><span class="hljs-comment">#0 beq x1_is_eq_to_zero</span></span></code> </pre> <br><p>  :    ,       . </p><br><h4 id="obobschenie">  </h4><br><p>    ARMv8    .           ,       .    ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : C1.2.4).       .  <a href="https://web.stanford.edu/class/cs140e/docs/AArch64-ISA-Cheat-Sheet.pdf">ISA-</a>  Griffin Dietz.   ,       : </p><br><blockquote> <strong>     <code>memcpy</code>   ARMv8?</strong> [arm-memcpy] <br><br> ,      <code>x0</code> ,  ,    <code>x1</code> ,     <code>x2</code> (      8 ).      <code>memcpy</code> ? ,     <code>ret</code> <br> <strong></strong> :      6-7   . <br><br> <strong>     <code>0xABCDE</code>  <code>ELR_EL1</code> ?</strong> [arm-movk] <br><br> ,     <code>EL1</code> ,      <code>0xABCDE</code>   <code>ELR_EL1</code>    ARMv8? <br> <strong></strong> :   . <br><br> <strong>   <code>cbz</code> ?</strong> [arm-cbz] <br><br>     <code>cbz</code> ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : C6.2.36).    ?     ? <br><br> <strong>  <code>init.S</code> ?</strong> [asm-init] <br><br>  <code>os/kernel/ext/init.S</code> ‚Äî   ,     .    <code>_start</code>     <code>0x80000</code>     .        ,     EL1    . <br><br>   <code>os/kernel/ext/init.S</code>   <code>context_save</code> .      ,   ,  - , ,    .      (‚Äúread cpu affinity‚Äù, ‚Äúcore affinity != 0‚Äù)    - : <br><br>     <code>MPIDR_EL1</code> ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : D7.2.74)  ( <code>Aff0</code> ),     ,       .      ‚Äî   <code>setup</code> .        <code>wfe</code>   . <br> <strong></strong> :       / ,      . </blockquote><br><h3 id="subfaza-c-pereklyuchenie-v-el1">  C:   EL1 </h3><br><p>            EL2  EL1.      <code>os/kernel/ext/init.S</code>  <code>os/kernel/src/kmain.rs</code> .        ,       . </p><br><h4 id="tekuschiy-uroven-isklyucheniy">    </h4><br><p>        <code>aarch64</code> ( <code>os/kernel/src/aarch64.rs</code> ),     <a href="https://doc.rust-lang.org/unstable-book/language-features/asm.html"> </a>       .   <code>sp()</code>         .   <code>current_el()</code> ,     .   ,      EL2   .    ,   <code>kmain()</code>   .  ,    <code>current_el()</code>  <code>unsafe</code> .    ,  ,      EL1. </p><br><h4 id="pereklyuchenie">  Switching </h4><br><p>    ,    EL1.      <code>os/kernel/ext/init.S</code> : </p><br><pre> <code class="hljs pgsql">// FIXME: <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> EL1 at `set_stack`.</code> </pre> <br><p>       : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mov</span></span> x2, <span class="hljs-comment"><span class="hljs-comment">#0x3c5 msr SPSR_EL2, x2</span></span></code> </pre> <br><p>      ,   .  ,   ,      <code>SPSR_EL2</code>        <code>eret</code> . </p><br><p>   ,  <code>FIXME</code>   . ,      EL1 CPU    <code>set_stack</code> ,     .        . ,       ‚Äî  <code>eret</code> .   ,  <code>current_el()</code>   <code>1</code> . </p><br><blockquote> <strong></strong> :      PC    ? </blockquote><br><h3 id="subfaza-d-vektory-isklyucheniy">  D:   </h3><br><p>              .      ,         .       ,   ,      <code>brk #n</code> .     <code>kernel/ext/init.S</code>   <code>kernel/src/traps</code> . </p><br><h4 id="obzor">  Overview </h4><br><p> ,       16 ,         16 .     <code>init.S</code>       <code>_vectors</code>   .     ,    16   ,      <code>handle_exception</code> Rust  <code>kernel/src/traps/mod.rs</code>       .       <code>handle_exception</code> .  ,   ,           . </p><br><h4 id="soglasheniya-o-vyzovah">    </h4><br><p>     <code>handle_exception</code> ,   Rust,   ,    .  ,   ,          <code>info</code> , <code>esr</code>  <code>tf</code> ,              . </p><br><p>         ,      (   2  C  Rust).  ,  ,       ,      .        ‚Äî   ,   : </p><br><ul><li> <strong>   .</strong>  AArch64  8     <code>r0</code> ‚Ä¶ <code>r7</code>     . </li><li> <strong>    .</strong>  AArch64  8      <code>r0</code> ‚Ä¶ <code>r7</code> . </li><li> <strong>  (,   ..)   .</strong> <br>     <em>caller-saved</em>  <em>callee-saved</em> . <br> <em>caller-saved</em> ‚Äî       .  ,  caller     ,        . <br>  . <em>callee-saved</em> ‚Äî     .  Those.              ,      . <br>         . <br>  AArch64  <code>r19</code> ... <code>r29</code>  <code>SP</code> ‚Äî <em>callee-saved</em> .  ‚Äî <em>caller-saved</em> .  ,  <code>lr</code> ( <code>x30</code> )   . SIMD/FP       .      ,    <em>caller-saved</em> . </li><li> <strong>   .</strong>  AArch64   <code>lr</code> ,      .  <code>ret</code>     <code>lr</code> . </li></ul><br><p>  AArch64          ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-A-Programmer-Guide.pdf">guide</a> : 9)   <a href="https://web.stanford.edu/class/cs140e/docs/AArch64-Procedure-Call-Standard.pdf">procedure call standard</a> .    <br> Rust- <code>handle_exception</code>  ,   ,      . </p><br><blockquote> <strong> Rust ,   ?</strong> <br><br>      ,         .      Rust           .  ,   Rust       ,      <code>extern</code> .    <code>handle_exception</code>  <code>extern</code>     ,  Rust    . </blockquote><br><h4 id="tablica-vektorov">   </h4><br><p>  ,      ,    <del>  with </del> <code>HANDLER(source, kind)</code> ,             .  <code>HANDLER(a, b)</code>   "",     ,    <code>#define</code> .  Those.   : </p><br><pre> <code class="hljs pgsql">_vectors: <span class="hljs-keyword"><span class="hljs-keyword">HANDLER</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>)</code> </pre> <br><p>   : </p><br><pre> <code class="hljs css">_<span class="hljs-selector-tag"><span class="hljs-selector-tag">vectors</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.align</span></span> 7 <span class="hljs-selector-tag"><span class="hljs-selector-tag">stp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lr</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">x0</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[SP, #-16]</span></span>! <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">x0</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#32</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movk</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">x0</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#39</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">LSL</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#16</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">context_save</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lr</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">x0</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[SP]</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#16</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eret</span></span></code> </pre> <br><p>    <code>lr</code>  <code>x0</code>      <code>x0</code> 32-   16   <code>source</code>  16   <code>kind</code> .   <code>context_save</code> ,   <code>_vectors</code> .  ,    , <code>lr</code>  <code>x0</code>          . </p><br><p>  <code>context_save</code>      .    <code>ret</code>  <code>context_restore</code> .     <code>context_save</code>  ,       Rust. </p><br><h4 id="syndrome"> Syndrome </h4><br><p>   <em></em>  (,      ),       ( <code>ESR_ELx</code> )      ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : D1.10.4).         <code>kernel/src/traps/syndrome.rs</code> .            <code>Syndrome</code> -.      ,    <code>ESR_ELx</code>  Rust   <code>esr</code> .   <code>Sydnrome::from(esr)</code>   ,  ,    . </p><br><h4 id="info"> Info </h4><br><p>  <code>handle_exception</code>       <code>Info</code> .       16 : <code>source</code>  <code>kind</code> .    ,  32- ,   <code>HANDLE</code>   <code>x0</code> .    ,     <code>HANDLE</code> -   ,   <code>Info</code>   . </p><br><h4 id="realizaciya">  Implementation </h4><br><p>        .  ,     ‚Äî <code>brk</code> , ..  .    ,     ,          . </p><br><p>      <code>brk</code>  <code>kmain</code> .  <a href="https://doc.rust-lang.org/unstable-book/language-features/asm.html"> </a>  : </p><br><pre> <code class="hljs objectivec">unsafe { <span class="hljs-keyword"><span class="hljs-keyword">asm</span></span>!(<span class="hljs-string"><span class="hljs-string">"brk 2"</span></span> :::: <span class="hljs-string"><span class="hljs-string">"volatile"</span></span>); }</code> </pre> <br><p>    : </p><br><ol><li> <strong>  <code>_vectors</code>    <code>HANDLE</code> .</strong> ,        <code>Info</code> . </li><li> <strong> <code>handle_exception</code>  <code>context_save</code></strong> . <br> ,  /  caller-saved        .     5  9 .      <code>0</code>   <code>tf</code> .      . <br>  . AArch64 ,  <code>SP</code>    16   ,     /. ,    . </li><li> <strong>  <code>VBAR</code> ,    :</strong> <br><pre> <code class="hljs sql">// FIXME: <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-string"><span class="hljs-string">`_vectors`</span></span> addr <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> appropriate <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> (guide: <span class="hljs-number"><span class="hljs-number">10.4</span></span>)</code> </pre> </li><li> <strong>   <code>handle_exception</code>    ,   .</strong> <br>  <code>handle_exception</code>    <code>info</code>  <code>esr</code>  ,    ,   .    .  ,  ,     ,    <code>aarch64::nop()</code> .            ,           .      . </li><li> <strong>  <code>Syndrome::from()</code>  <code>Fault::from()</code> .</strong> <br>       .      ( <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : D1.10.4, <a href="https://web.stanford.edu/class/cs140e/docs/ARMv8-Reference-Manual.pdf">ref</a> : Table D1-8)  ,    .   ‚ÄúISS encoding description‚Äù    ,    ,       .    ,    <code>brk 12</code>   <code>Syndrome::Brk(12)</code> ,   <code>svc 77</code>   <code>Syndrome::Svc(77)</code> .  ,    32-      ,   ,      . </li><li> <strong>     <code>brk</code> .</strong> <br>   <code>Syndrome::from()</code>  <code>handle_exception</code>  ,    <code>brk</code> .    ,  .          .  ,        <code>Syndrome::from()</code> .     <code>ESR_ELx</code>     . <br>            <code>exit</code> .     <code>exit</code> ,       .        <code>brk</code> .          <code>shell()</code>  <code>kmain</code>  <code>loop { }</code>  ,    . </li></ol><br><p>    ,  <code>brk 2</code>  <code>kmain</code>      <code>Brk(2)</code> , source,  <code>CurrentSpElx</code>  kind  <code>Synchronous</code> .       .     <code>exit</code> ,            . </p><br><p>   ,   ,       .      ,  ,   <code>svc 3</code> .          ,        . </p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As soon as everything works as you expected, you are ready to move on to the next stage. </font></font></p><br><img title="With the third versions, always some happenings happen." src="https://habrastorage.org/webt/17/vt/-a/17vt-a0kou2f4xiwuxjjukx3of0.jpeg"><br><p> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : the </font></font><a href="https://habr.com/post/354784/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">next part</font></font></a> </p></div><p>Source: <a href="https://habr.com/ru/post/353994/">https://habr.com/ru/post/353994/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353984/index.html">Personal experience: speeches and webinars of VAS Experts on SCAT, CG-NAT and DPI systems</a></li>
<li><a href="../353986/index.html">We map the entire Internet using the Hilbert curves.</a></li>
<li><a href="../353988/index.html">Why Sweden refuses the idea of ‚Äã‚Äãfull transition to non-cash payments</a></li>
<li><a href="../353990/index.html">Walk through a fast, secure and almost complete web service on Rust</a></li>
<li><a href="../353992/index.html">How IaaS helps freelance programmers: 1cloud experience</a></li>
<li><a href="../353996/index.html">Export to Excel from JS</a></li>
<li><a href="../353998/index.html">Features of the analysis of CRM systems in the restaurant business</a></li>
<li><a href="../354002/index.html">Future single B2B market or technology game?</a></li>
<li><a href="../354004/index.html">What happens to the bitten apple? That's right - it spoils</a></li>
<li><a href="../354008/index.html">10,000 likes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>