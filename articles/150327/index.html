<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Newbie Compiler Manual</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="David Drysdale , Beginner's guide to linkers ( http://www.lurklurk.org/linkers/linkers.html ). 

 The purpose of this article is to help C and C ++ pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Newbie Compiler Manual</h1><div class="post__text post__text-html js-mediator-article">  <b>David Drysdale</b> , <i>Beginner's guide to linkers</i> ( <a href="http://www.lurklurk.org/linkers/linkers.html">http://www.lurklurk.org/linkers/linkers.html</a> ). <br><br>  The purpose of this article is to help C and C ++ programmers understand the essence of what the linker does.  Over the past few years, I explained this to a large number of colleagues and finally decided that it was time to transfer this material to paper so that it became more accessible (and so I did not have to explain it again).  [Update in March 2009: added additional information about layout features in Windows, as well as a more detailed rule for one definition (one-definition rule). <br><br>  A typical example of why people turned to me for help is the following layout error: <br><pre><code class="bash hljs">g++ -o test1 test1a.o test1b.o test1a.o(.text+0x18): In <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> `main<span class="hljs-string"><span class="hljs-string">': : undefined reference to `findmax(int, int)'</span></span> collect2: ld returned 1 <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> status</code> </pre> <br>  If your reaction is 'surely forgot extern "C"', then you most likely know everything that is given in this article. <br><a name="habracut"></a><br><h2>  Content </h2><br><ul><li>  <a href="https://habr.com/ru/post/150327/">Definitions: what is in the C file?</a> </li><li>  <a href="https://habr.com/ru/post/150327/">What makes the C compiler</a> </li><li>  <a href="https://habr.com/ru/post/150327/">What the linker does: part 1</a> </li><li>  <a href="https://habr.com/ru/post/150327/">What does the operating system do</a> </li><li>  <a href="https://habr.com/ru/post/150327/">What the linker does: part 2</a> </li><li>  <a href="https://habr.com/ru/post/150327/">C ++ to complete the picture</a> </li><li>  <a href="https://habr.com/ru/post/150327/">Dynamically loadable libraries</a> </li><li>  <a href="https://habr.com/ru/post/150327/">Additionally</a> </li></ul><br><a name="cfile"></a><h2>  Definitions: what is in the C file? </h2><br>  This chapter is a brief reminder of the various components of a C file.  If everything in the <a href="https://habr.com/ru/post/150327/">listing below</a> makes sense to you, then most likely you can skip this chapter and go straight to the <a href="https://habr.com/ru/post/150327/">next one</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First you need to understand the difference between the declaration and the definition. <a name="definition"></a>  <i>The definition</i> associates a name with an implementation, which can be either code or data: <br><ul><li>  Defining a variable causes the compiler to reserve a certain area of ‚Äã‚Äãmemory, possibly setting it to some specific value. <br></li><li>  The function definition causes the compiler to generate code for this function. <br></li></ul><br><a name="declaration"></a>  <i>The declaration</i> tells the compiler that the definition of a function or variable (with a specific name) exists elsewhere in the program, probably in another C file.  (Note that the definition is also an ad ‚Äî in fact, this is an ad in which the ‚Äúother place‚Äù of the program coincides with the current one). <br><br>  For variables, there are two kinds of definitions: <br><ul><li>  <i>global variables</i> that exist throughout the program‚Äôs life cycle (‚Äústatic allocation‚Äù) and which are available in various functions; <br></li><li>  <i>local variables</i> that exist only within a certain executable function (‚Äúlocal location‚Äù) and which are available only within that function itself. <br></li></ul><br>  In this case, the term ‚Äúavailable‚Äù means ‚Äúyou can refer to the name associated with the variable at the moment of definition‚Äù. <br><br>  There are a couple of special cases that from the first time do not seem obvious: <br><ul><li>  static local variables are actually global because they exist throughout the life of the program, even if they are visible only within a single function. <br></li><li>  static global variables are also global with the only difference that they are available only within the same file where they are defined. <br></li></ul><br>  It is worth noting that, by defining a static function, the number of places from which this function can be accessed by name is simply reduced. <br><br>  For global and local variables, we can distinguish between a variable initialized or not, i.e.  whether the space allocated for a variable in memory will be filled with a specific value. <br><br>  Finally, we can store information in memory that is dynamically allocated by <code>malloc</code> or <code>new</code> .  In this case, it is not possible to refer to the allocated memory by name, so you must use pointers - named variables that contain the address of the unnamed memory area.  This area of ‚Äã‚Äãmemory can also be freed with <code>free</code> or <code>delete</code> .  In this case, we are dealing with a ‚Äúdynamic allocation‚Äù. <br><br>  Summing up: <br><a name="ctable"></a><table border="1" cellpadding="2" cellspacing="2"><tbody><tr><td></td><td>  Code </td><td colspan="5" align="center">  Data </td></tr><tr><td></td><td></td><td colspan="2" align="center">  Global </td><td colspan="2" align="center">  Local </td><td align="center">  Dynamic </td></tr><tr><td></td><td></td><td>  Initiate <br>  lisor <br>  the bathrooms </td><td>  Noninitiate <br>  lisor <br>  the bathrooms </td><td>  Initiate <br>  lisor <br>  the bathrooms </td><td>  Noninitiate <br>  lisor <br>  the bathrooms </td><td></td></tr><tr><td>  Announce <br>  perception </td><td> <code>int fn(int x);</code> </td> <td> <code>extern int x;</code> </td> <td> <code>extern int x;</code> </td> <td>  N / A </td><td>  N / A </td><td>  N / A </td></tr><tr><td>  Define <br>  perception </td><td> <code>int fn(int x) { ... }</code> </td> <td> <code>int x = 1;</code> <br>  (scope <br>  - file) </td><td> <code>int x;</code> <br>  (scope - file) </td><td> <code>int x = 1;</code> <br>  (scope is a function) </td><td> <code>int x;</code> <br>  (scope is a function) </td><td> <code>int* p = malloc(sizeof(int));</code> </td> </tr></tbody></table><br><a name="cfilelisting"></a>  Probably the easier way to learn is to simply look at the sample program. <br><pre> <code class="hljs cs"><span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x_global_uninit; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x_global_init = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    ,   *         C  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y_global_uninit; <span class="hljs-comment"><span class="hljs-comment">/*    ,   *         C  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y_global_init = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   ,   - *     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z_global; <span class="hljs-comment"><span class="hljs-comment">/*  ,   -   *  (    "extern",   * ) */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fn_a</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*  .     static,   *        C . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fn_b</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x+<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*  . */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fn_c</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x_local</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y_local_uninit; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y_local_init = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ,       , *      */</span></span> x_global_uninit = fn_a(x_local, x_global_init); y_local_uninit = fn_a(x_local, y_local_init); y_local_uninit += fn_b(z_global); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (x_global_uninit + y_local_uninit); }</code> </pre><br><br><a name="ccompiler"></a><h2>  What makes the C compiler </h2><br>  The C compiler‚Äôs job is to convert text that is (usually) human-readable to something the computer understands.  At the output, the compiler produces an <i>object file</i> .  On UNIX platforms, these files usually have the suffix .o;  on Windows, the .obj suffix.  The contents of the object file are essentially two things: <br><ul><li>  <i>code</i> corresponding to the <a href="https://habr.com/ru/post/150327/">definition of the</a> function in the C file </li><li>  <i>data</i> corresponding to the <a href="https://habr.com/ru/post/150327/">definition of</a> <b>global</b> variables in the C file (for initialized global variables, the initial value of the variable must also be stored in the object file). </li></ul><br>  The code and data, in this case, will have names associated with them ‚Äî the names of the functions or variables with which they are associated. <br><br>  Object code is a sequence of (appropriately composed) machine instructions that correspond to C instructions written by a programmer: all these <code>if</code> and <code>while</code> and even <code>goto</code> .  These spells have to manipulate information of a certain kind, and the information must be located somewhere - for this we need variables.  The code can also refer to other code (in particular, to other C functions in the program). <br><br>  No matter where the code refers to a variable or function, the compiler allows this only if it has seen the <a href="https://habr.com/ru/post/150327/">declaration of</a> this variable or function before.  An announcement is a promise that a definition exists somewhere else in the program. <br><br>  Job linker check these promises.  However, what does the compiler do with all these promises when it generates an object file? <br><br>  Essentially, the compiler leaves empty spaces.  An empty space (link) has a name, but the value corresponding to this name is not yet known. <br><br>  Given this, we can portray the object file corresponding to the <a href="https://habr.com/ru/post/150327/">program above</a> , as follows: <br><a name="objpng"></a><img src="https://habrastorage.org/getpro/habr/post_images/11c/c83/2de/11cc832de82c2619607e4cd54b21b4be.png" alt="Object File Diagram"><br><br><a name="objfile"></a><h3>  Analyzing the object file </h3><br>  So far we have considered everything at a high level.  However, it is useful to see how this works in practice.  The main tool for us will be the <b><code>nm</code></b> command, which provides information about the symbols of the object file on the UNIX platform.  For Windows, <a href="http://support.microsoft.com/kb/177429"><b><code>dumpbin</code></b></a> with the <code>/symbols</code> option is an approximate equivalent.  There are also <a href="http://www.gnu.org/software/binutils">GNU binutils</a> tools <a href="http://sourceforge.net/project/showfiles.php%3Fgroup_id%3D2435%26package_id%3D11290">ported to Windows</a> , which include <code>nm.exe</code> . <br><br>  Let's see what gives <code>nm</code> for the object file obtained from <a href="https://habr.com/ru/post/150327/">our example above</a> : <br><pre> <code class="hljs ruby">Symbols from c_parts.<span class="hljs-symbol"><span class="hljs-symbol">o:</span></span> Name Value Class Type Size Line Section fn_a <span class="hljs-params"><span class="hljs-params">| |</span></span> U <span class="hljs-params"><span class="hljs-params">| NOTYPE|</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>*UND* z_global <span class="hljs-params"><span class="hljs-params">| |</span></span> U <span class="hljs-params"><span class="hljs-params">| NOTYPE|</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>*UND* fn_b <span class="hljs-params"><span class="hljs-params">|00000000|</span></span> t <span class="hljs-params"><span class="hljs-params">| FUNC|</span></span><span class="hljs-number"><span class="hljs-number">0000000</span></span>9<span class="hljs-params"><span class="hljs-params">| |</span></span>.text x_global_init <span class="hljs-params"><span class="hljs-params">|00000000|</span></span> D <span class="hljs-params"><span class="hljs-params">| OBJECT|</span></span><span class="hljs-number"><span class="hljs-number">00000004</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span>.data y_global_uninit <span class="hljs-params"><span class="hljs-params">|00000000|</span></span> b <span class="hljs-params"><span class="hljs-params">| OBJECT|</span></span><span class="hljs-number"><span class="hljs-number">00000004</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span>.bss x_global_uninit <span class="hljs-params"><span class="hljs-params">|00000004|</span></span> C <span class="hljs-params"><span class="hljs-params">| OBJECT|</span></span><span class="hljs-number"><span class="hljs-number">00000004</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span>*COM* y_global_init <span class="hljs-params"><span class="hljs-params">|00000004|</span></span> d <span class="hljs-params"><span class="hljs-params">| OBJECT|</span></span><span class="hljs-number"><span class="hljs-number">00000004</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span>.data fn_c <span class="hljs-params"><span class="hljs-params">|00000009|</span></span> T <span class="hljs-params"><span class="hljs-params">| FUNC|</span></span><span class="hljs-number"><span class="hljs-number">00000055</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span>.text</code> </pre><br>  The result may look slightly different on different platforms (refer to <code>man</code> 's to get the relevant information), but the key information is the class of each character and its size (if present).  A class may have different meanings: <br><ul><li>  The class <b>U</b> denotes the undefined references, the very ‚Äúempty spaces‚Äù mentioned above.  There are two objects for this class: <code>fn_a</code> and <code>z_global</code> .  (Some versions of <code>nm</code> can output a <i>section</i> that would be <b><code>*UND*</code></b> or <b><code>UNDEF</code></b> in this case.) </li><li>  Classes <b>t</b> and <b>T</b> indicate the code that is defined;  the difference between <b>t</b> and <b>t</b> is whether the function is local ( <b>t</b> ) in the file or not ( <b>t</b> ), i.e.  Whether the function was declared <code>static</code> .  Again, on some systems, a section may be displayed, for example <b><code>.text</code></b> . <br></li><li>  Classes <b>d</b> and <b>D</b> contain initialized global variables.  At the same time static variables belong to the class <b>d</b> .  If section information is present, it will be <b>.data</b> . <br></li><li>  For uninitialized global variables, we get <b>b</b> if they are static and <b>B</b> or <b>C</b> otherwise.  The section in this case will most likely be <b>.bss</b> or <b>* COM *</b> . <br></li></ul><br>  You can also see characters that are not part of the original C code.  We will not focus our attention on this, since this is usually part of the internal compiler mechanism, so that your program can still be put together. <br><br><a name="linker1"></a><h2>  What the linker does: part 1 </h2><br>  Earlier, we mentioned that the declaration of a function or variable is a promise to the compiler, that somewhere else in the program there is a definition of this function or variable, and that the work of the linker is to fulfill this promise.  Looking at <a href="https://habr.com/ru/post/150327/">the object file diagram</a> , we can describe this process as ‚Äúfilling in empty places‚Äù. <br><br>  We illustrate this with an example, considering another C file in addition to what <a href="https://habr.com/ru/post/150327/">was mentioned above</a> . <br><pre> <code class="hljs cs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z_global = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*      y_global_init,    static */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y_global_init = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x_global_init; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fn_a</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(x+y); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argv</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *message = <span class="hljs-string"><span class="hljs-string">"Hello, world"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fn_a(<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); }</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/2fe/d9b/7fb/2fed9b7fb910c65e30df22d6e66caa16.png" alt="Schematic diagram of object file"><br><br>  From both diagrams, we can see that all points can be connected (if not, the linker would give an error message).  Every thing has its place, and every place has its own thing.  Also, the linker can fill all empty spaces as shown here (on UNIX systems, the linking process is usually called with the <b><code>ld</code></b> command). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8a5/f0b/8fc/8a5f0b8fcdb2bbe6456e434f97a91248.png" alt="Schematic diagram of object file"><br><br>  As with <a href="https://habr.com/ru/post/150327/">object files</a> , we can use <code>nm</code> to examine the final executable file. <br><pre> <code class="hljs ruby">Symbols from sample1.<span class="hljs-symbol"><span class="hljs-symbol">exe:</span></span> Name Value Class Type Size Line Section _Jv_RegisterClasses <span class="hljs-params"><span class="hljs-params">| |</span></span> w <span class="hljs-params"><span class="hljs-params">| NOTYPE|</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>*UND* __gmon_start_<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> w <span class="hljs-params"><span class="hljs-params">| NOTYPE|</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>*UND* __libc_start_main@@GLIBC_2.<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| U |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">|000001ad|</span></span> <span class="hljs-params"><span class="hljs-params">|*UND* _init |</span></span>08048254<span class="hljs-params"><span class="hljs-params">| T |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.init _start |</span></span>080482c<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| T |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.text __do_global_dtors_aux|</span></span>080482f<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| t |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.text frame_dummy |</span></span>0804832<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| t |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.text fn_b |</span></span>08048348<span class="hljs-params"><span class="hljs-params">| t |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">|00000009|</span></span> <span class="hljs-params"><span class="hljs-params">|.text fn_c |</span></span>08048351<span class="hljs-params"><span class="hljs-params">| T |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">|00000055|</span></span> <span class="hljs-params"><span class="hljs-params">|.text fn_a |</span></span>080483a8<span class="hljs-params"><span class="hljs-params">| T |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">|0000000b|</span></span> <span class="hljs-params"><span class="hljs-params">|.text main |</span></span>080483b3<span class="hljs-params"><span class="hljs-params">| T |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">|0000002c|</span></span> <span class="hljs-params"><span class="hljs-params">|.text __libc_csu_fini |</span></span>080483e<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| T |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">|00000005|</span></span> <span class="hljs-params"><span class="hljs-params">|.text __libc_csu_init |</span></span>080483f<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| T |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">|00000055|</span></span> <span class="hljs-params"><span class="hljs-params">|.text __do_global_ctors_aux|</span></span>0804845<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| t |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.text _fini |</span></span>08048478<span class="hljs-params"><span class="hljs-params">| T |</span></span> FUNC<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.fini _fp_hw |</span></span>08048494<span class="hljs-params"><span class="hljs-params">| R |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">|00000004|</span></span> <span class="hljs-params"><span class="hljs-params">|.rodata _IO_stdin_used |</span></span>08048498<span class="hljs-params"><span class="hljs-params">| R |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">|00000004|</span></span> <span class="hljs-params"><span class="hljs-params">|.rodata __FRAME_END__ |</span></span>080484ac<span class="hljs-params"><span class="hljs-params">| r |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.eh_frame __CTOR_LIST__ |</span></span>080494b<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.ctors __init_array_end |</span></span>080494b<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| d |</span></span> NOTYPE<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.ctors __init_array_start |</span></span>080494b<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| d |</span></span> NOTYPE<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.ctors __CTOR_END__ |</span></span>080494b4<span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.ctors __DTOR_LIST__ |</span></span>080494b8<span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.dtors __DTOR_END__ |</span></span>080494bc<span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.dtors __JCR_END__ |</span></span>080494c<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.jcr __JCR_LIST__ |</span></span>080494c<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.jcr _DYNAMIC |</span></span>080494c4<span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.dynamic _GLOBAL_OFFSET_TABLE_|</span></span>08049598<span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.got.plt __data_start |</span></span>080495ac<span class="hljs-params"><span class="hljs-params">| D |</span></span> NOTYPE<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.data data_start |</span></span>080495ac<span class="hljs-params"><span class="hljs-params">| W |</span></span> NOTYPE<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.data __dso_handle |</span></span>080495b<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| D |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.data p.5826 |</span></span>080495b4<span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|.data x_global_init |</span></span>080495b8<span class="hljs-params"><span class="hljs-params">| D |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">|00000004|</span></span> <span class="hljs-params"><span class="hljs-params">|.data y_global_init |</span></span>080495bc<span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">|00000004|</span></span> <span class="hljs-params"><span class="hljs-params">|.data z_global |</span></span>080495c<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| D |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">|00000004|</span></span> <span class="hljs-params"><span class="hljs-params">|.data y_global_init |</span></span>080495c4<span class="hljs-params"><span class="hljs-params">| d |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">|00000004|</span></span> <span class="hljs-params"><span class="hljs-params">|.data __bss_start |</span></span>080495c8<span class="hljs-params"><span class="hljs-params">| A |</span></span> NOTYPE<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|*ABS* _edata |</span></span>080495c8<span class="hljs-params"><span class="hljs-params">| A |</span></span> NOTYPE<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|*ABS* completed.5828 |</span></span>080495c8<span class="hljs-params"><span class="hljs-params">| b |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">|00000001|</span></span> <span class="hljs-params"><span class="hljs-params">|.bss y_global_uninit |</span></span>080495cc<span class="hljs-params"><span class="hljs-params">| b |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">|00000004|</span></span> <span class="hljs-params"><span class="hljs-params">|.bss x_global_uninit |</span></span>080495d<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| B |</span></span> OBJECT<span class="hljs-params"><span class="hljs-params">|00000004|</span></span> <span class="hljs-params"><span class="hljs-params">|.bss _end |</span></span>080495d4<span class="hljs-params"><span class="hljs-params">| A |</span></span> NOTYPE<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|*ABS*</span></span></code> </pre><br>  It contains the characters of both object files and all undefined links have disappeared.  The characters are reordered so that similar types are found together.  There are also a few add-ons to help the OS deal with such a thing as an executable file. <br><br>  There is a sufficient number of complex parts that obstruct the conclusion, but if you drop everything that begins with an underscore, it will become much easier. <br><br><a name="dups"></a><h3>  Duplicate characters </h3><br>  In the previous chapter, it was mentioned that the linker gives an error message if it cannot find a definition for the character to which the link was found.  And what happens if <i>two</i> definitions are found for a symbol at the time of composition? <br><br>  In C ++, the solution is straightforward.  A language has a limitation known as the <i>rule of one definition</i> , which states that there must be only one definition for each character occurring at the time of composition, no more, no less.  (The corresponding chapter of the C ++ standard is 3.2, which also mentions some exceptions, which we will discuss a <a href="https://habr.com/ru/post/150327/">little later</a> .) <br><br>  For C, things are less obvious.  There must be exactly one definition for any function and an initialized global variable, but the definition of a non-initialized variable can be interpreted as a <i>preliminary definition</i> .  The C language thus allows (or at least does not prohibit) different source files to contain a preliminary definition of the same object. <br><br>  However, linkers should be able to manage with other languages ‚Äã‚Äãbesides C and C ++, for which the rule of one definition is not necessarily followed.  For example, it is normal for Fortran to have a copy of each global variable in each file that references it.  The linker then needs to remove duplicates by selecting one copy (the largest representative, if they differ in size) and discard all the others.  This model is sometimes called the ‚Äúgeneric layout‚Äù model because of the COMMON (generic) Fortran language. <br><br>  As a result, it is quite common for UNIX compilers not to swear for the presence of duplicate characters, at least if they are duplicate characters of uninitialized global variables (this layout model is sometimes called a ‚Äúweak link model‚Äù) <i>.</i> def model. More successful suggestions are welcome]).  If this worries you (probably should be worried), refer to the documentation of your linker to find the - <code>---</code> option that pacifies its behavior.  For example, in the GNU toolchain, the <code>-fno-common</code> compiler option forces you to place an uninitialized variable in the BBS segment instead of generating common (COMMON) blocks. <br><br><a name="os"></a><h2>  What does the operating system do </h2><br>  Now that the linker has made an executable file, assigning a suitable definition to each symbol reference, you can make a short pause to understand what the operating system does when you start the program for execution. <br><br>  Running the program of course entails the execution of machine code, i.e.  The OS should obviously transfer the machine code of the executable file from the hard disk to the operational memory, from where the CPU can pick it up.  These portions are called a code segment (code segment or text segment). <br><br>  Code without data is useless by itself.  Therefore, all global variables also need a place in the computer's memory.  However, there is a difference between initialized and uninitialized global variables.  Initialized variables have certain starting values ‚Äã‚Äãthat must also be stored in object and executable files.  When the program is launched at the start, the OS copies these values ‚Äã‚Äãinto the virtual space of the program, into a data segment. <br><br>  For uninitialized OS variables, it can be assumed that they all have 0 as the initial value, i.e.  There is no need to copy any values.  A chunk of memory that is initialized with zeros is known as the bss segment. <br><br>  This means that space for global variables can be allotted in an executable file stored on disk;  for initialized variables, their initial values ‚Äã‚Äãshould be saved, but for uninitialized ones, you only need to keep their size. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/75c/f76/999/75cf76999094f5e8207ecaf63ab93f20.png"><br><br>  As you can see, so far in all the arguments about object files and linker, we have only been talking about global variables;  however, we did not mention local variables and dynamically occupied memory <a href="https://habr.com/ru/post/150327/">mentioned earlier</a> . <br><br>  This data does not require the intervention of the linker, because the time of their life begins and ends during the execution of the program - much later than the linker has already done his job.  However, for the sake of completeness, we briefly indicate that: <br><ul><li>  Local variables are located in a memory area called the <i>stack</i> , which grows and shrinks as you call and execute various functions. <br></li><li>  dynamically allocated memory is taken from a memory area known as a <i>heap</i> , and the malloc function controls access to free space in that area. <br></li></ul><br>  For completeness, it is worth adding what the memory space of the process being performed looks like.  Since the heap and the stack can change their sizes dynamically, the fact that the stack grows in one direction is quite common, and the heap is reversed.  Thus, the program will generate an error of lack of free memory only if the stack and the heap meet somewhere in the middle (in this case, the memory space of the program will really be filled). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/63d/6f8/bd4/63d6f8bd4439f147af583f6a9bf7cb56.png"><br><br><a name="linker2"></a><h2>  What the linker does;  part 2 </h2><br>  Now that we‚Äôve covered the <a href="https://habr.com/ru/post/150327/">basics</a> of what the linker does, we can dive into the description of more complex parts ‚Äî roughly in the chronological order they were added to the linker. <br><br>  The main observation that affects the linker‚Äôs functions is the following: if a number of different programs do about the same things (output to the screen, read files from a hard disk, etc.), then obviously it makes sense to isolate this code in a certain place and give it to others programs use it. <br><br>  One possible solution would be to use the same object files, but it would be much more convenient to keep the entire collection of ... object files in one easily accessible place: a <i>library</i> . <br><br><a name="relocation"></a>  Technical digression: This chapter completely omits the important property of the linker: relocation.  Different programs have different sizes, i.e.  if the shared library is mapped into the address space of various programs, it will have different addresses.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This in turn means that all functions and variables in the library will be in different places. </font><font style="vertical-align: inherit;">Now, if all references to addresses are relative (‚Äúvalue +1020 bytes from here‚Äù) rather than absolute (‚Äúvalue in 0x102218BF‚Äù), then this is not a problem, but this is not always the case. </font><font style="vertical-align: inherit;">In such cases, all absolute addresses need to add a suitable offset - this is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">relocation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I‚Äôm not going to return to this topic again, but I‚Äôll add that since it‚Äôs almost always hidden from a C / C ++ programmer, it‚Äôs very rare for layout problems to be caused by redirection difficulties.</font></font><br><br><a name="staticlibs"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Static libraries </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The simplest embodiment of the library is the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library. In the previous chapter it was mentioned that you can share (share) the code simply by reusing the object files; this is the essence of static libraries. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On UNIX systems, the command to build a static library is usually </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the library file, which is obtained, has the extension * .a. Also, these files usually have the prefix ‚Äúlib‚Äù in their name and they are passed to the linker with the "-l" option followed by the library name without the prefix and extension (i.e., "-lfred" will pick up the file "libfred.a"). </font></font><br> <font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(In the past, a program called </font></font><code>ranlib</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">was also needed for static libraries to generate a list of characters at the beginning of the library. Nowadays, tools</font></font><code>ar</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">they do it themselves.)</font></font><br></font> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In Windows, static libraries have an extension </font></font><code>.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and are built with LIB tools, but this fact can be misleading, since the same extension is used for the ‚Äúimport library‚Äù, which contains only the list of what is in the DLL - see </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Windows DLL chapter</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As the linker iterates over the collection of object files to merge them together, it maintains a list of characters that cannot be implemented yet. Once all the explicitly specified object files are processed, the linker now has a new place to search for characters that remain in the list ‚Äî in the library. If an unrealized character is defined in one of the library objects, then the object is added, just as if it were added to the list of object files by the user, and the layout continues. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pay attention to the granularity of what is added from the library: if you need to define a certain character, then the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whole object</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">containing the definition of the character will be included. This means that this process can be either a step forward or a step back ‚Äî a newly added object can either resolve an undefined link or bring in a whole collection of new unresolved links. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another important detail is the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">order of</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> events; libraries are attracted only when the normal layout is complete, and they are processed in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">order</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from left to right. This means that if the object retrieved from the library last requires a symbol from the library that was previously in the line of the build command, then the linker will not find it automatically. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We give an example to clarify the situation; suppose we have the following object files and a build command line that contains</font></font><code>ao, bo, -lx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>-ly</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><a name="samplelibs"></a><table border="1"><tbody><tr><td>  File </td><td> <code>ao</code> </td> <td> <code>bo</code> </td> <td colspan="3" align="center"> <code>libx.a</code> </td> <td colspan="3" align="center"> <code>liby.a</code> </td> </tr><tr><td>  An object </td><td> <code>ao</code> </td> <td> <code>bo</code> </td> <td> <code>x1.o</code> </td> <td> <code>x2.o</code> </td> <td> <code>x3.o</code> </td> <td> <code>y1.o</code> </td> <td> <code>y2.o</code> </td> <td> <code>y3.o</code> </td> </tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oprede- </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lenia</font></font></td><td> <code>a1, a2, a3</code> </td> <td> <code>b1, b2</code> </td> <td> <code>x11, x12, x13</code> </td> <td> <code>x21, x22, x23</code> </td> <td> <code>x31, x32</code> </td> <td> <code>y11, y12</code> </td> <td> <code>y21, y22</code> </td> <td> <code>y31, y32</code> </td> </tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unsolvable </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shonnye</font></font><br>  links </td><td> <code>b2, x12</code> </td> <td> <code>a3, y22</code> </td> <td> <code>x23, y12</code> </td> <td> <code>y11</code> </td> <td></td><td> <code>y21</code> </td> <td></td><td> <code>x31</code> </td> </tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Once the linker has processed </font></font><code>ao</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>bo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linked </font></font><code>b2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>a3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be allowed, while </font></font><code>x12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>y22</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are still unresolved. At this point, the linker checks the first library </font></font><code>libx.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for missing characters and finds what it can include </font></font><code>x1.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to compensate for the link to </font></font><code>x12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; however, by doing this, </font></font><code>x23</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">they </font></font><code>y12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are added to the list of undefined links (now the list looks like </font></font><code>y22, x23, y12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linker is still dealing with </font></font><code>libx.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so the link to is </font></font><code>x23</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">easily compensated, including </font></font><code>x2.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from </font></font><code>libx.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. However, this adds </font></font><code>y11</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the list of uncertain (which has become </font></font><code>y22, y12, y11</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). None of these links can be resolved using</font></font><code>libx.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so the linker is taken for </font></font><code>liby.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is about the same and linker includes </font></font><code>y1.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>y2.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The first object adds a link to </font></font><code>y21</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but since it </font></font><code>y2.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will still be included, this link is resolved simply. The result of this process is that all undefined references are allowed, and some (but not all) library objects are included in the final executable file. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notice that the situation changes somewhat, if we </font></font><code>bo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">also have a link to </font></font><code>y32</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If this were the case, the layout </font></font><code>libx.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">would also occur, but the processing </font></font><code>liby.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">would entail inclusion </font></font><code>y3.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. By including this object we will add</font></font><code>x31</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the list of unresolved symbols and this link will remain unresolved - at this stage the linker has already completed processing </font></font><code>libx.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and therefore will not find the definition of this symbol (c </font></font><code>x3.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(By the way, this example has a cyclical dependency between libraries </font></font><code>libx.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>liby.a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; usually this is bad </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">especially under Windows</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font><br><br><a name="sharedlibs"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dynamic shared libraries </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For popular libraries such as the standard C library (usually </font></font><code>libc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) being a static library has an obvious disadvantage - each executable program will have a copy of the same code. Indeed, if each executable file will have a copy </font></font><code>printf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>fopen</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the like, there will be an unnecessarily large amount of disk space. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A less obvious drawback is that in a statically linked program, the code is fixed forever. If someone finds and corrects a bug in </font></font><code>printf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then each program will need to be rebuilt to get the corrected code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To get rid of these and other problems, dynamically shared libraries were presented (usually they have an extension </font></font><code>.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in Windows and</font></font><code>.dylib</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on Mac OS X). For this type of library, the linker does not necessarily connect all points. Instead, the linker issues an IOU coupon (I owe you = I owe you) and postpones the cashout of that coupon until the program starts. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All this boils down to the fact that if the linker detects that the definition of a particular symbol is in a shared library, then it does not include this definition in the final executable file. Instead, the linker records the name of the symbol and the library from which the symbol is supposed to appear. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When a program is called for execution, the OS takes care that the remaining parts of the build process are completed on time before the program starts. Before a function is called </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a small version of the linker (often called</font></font><code>ld.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) goes through the list of promises and performs the last act of linking right on the spot - puts the library code and connects all points. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This means that no executable file contains a copy of the code </font></font><code>printf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If the new version </font></font><code>printf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is available, then it can be used simply by changing it </font></font><code>libc.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the next time the program starts, a new one will be </font></font><code>printf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">called. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is another big difference between how dynamic libraries work compared to static libraries and this is manifested in the granularity of the layout. If a particular symbol is taken from a specific dynamic library (say </font></font><code>printf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from</font></font><code>libc.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), then the entire contents of the library is placed in the address space of the program. This is the main difference from static libraries, where only specific objects related to an undefined symbol are added. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We formulate differently, shared libraries themselves are obtained as the result of the linker's work (and not as the formation of a large heap of objects, as it does </font></font><code>ar</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), containing links between objects in the library itself. I will repeat it again </font></font><code>nm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- a useful tool to illustrate what is happening: for the </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example above,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it will produce multiple outcomes for each object file separately, if this tool is run on a static version of a library, but for a shared version of a library it </font></font><code>liby.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has only one undefined symbol</font></font><code>x31</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Also in the example of the order of libraries included in the end of </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the previous chapter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , too, no problems will not be: add links to </font></font><code>y32</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the </font></font><code>bc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will not entail any changes, because all the contents </font></font><code>y3.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>x3.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it was involved. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So by the way, another useful tool is this </font></font><code>ldd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; on the Unix platform, it shows all shared libraries on which the executable binary depends (or another shared library), along with an indication of where these libraries can be found. In order for the program to start successfully, the loader needs to find all these libraries along with all their dependencies. (Usually the loader searches for libraries in the list of directories specified in the environment variable </font></font><code>LD_LIBRARY_PATH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.)</font></font><br><pre> <code class="bash hljs">/usr/bin:ldd xeyes linux-gate.so.1 =&gt; (0xb7efa000) libXext.so.6 =&gt; /usr/lib/libXext.so.6 (0xb7edb000) libXmu.so.6 =&gt; /usr/lib/libXmu.so.6 (0xb7ec6000) libXt.so.6 =&gt; /usr/lib/libXt.so.6 (0xb7e77000) libX11.so.6 =&gt; /usr/lib/libX11.so.6 (0xb7d93000) libSM.so.6 =&gt; /usr/lib/libSM.so.6 (0xb7d8b000) libICE.so.6 =&gt; /usr/lib/libICE.so.6 (0xb7d74000) libm.so.6 =&gt; /lib/libm.so.6 (0xb7d4e000) libc.so.6 =&gt; /lib/libc.so.6 (0xb7c05000) libXau.so.6 =&gt; /usr/lib/libXau.so.6 (0xb7c01000) libxcb-xlib.so.0 =&gt; /usr/lib/libxcb-xlib.so.0 (0xb7bff000) libxcb.so.1 =&gt; /usr/lib/libxcb.so.1 (0xb7be8000) libdl.so.2 =&gt; /lib/libdl.so.2 (0xb7be4000) /lib/ld-linux.so.2 (0xb7efb000) libXdmcp.so.6 =&gt; /usr/lib/libXdmcp.so.6 (0xb7bdf000)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The reason for the greater granularity is that modern operating systems are intelligent enough to allow you to do more than just save duplicate items on disk than static libraries suffer. </font><font style="vertical-align: inherit;">Different executable processes that use the same shared library can also share a code segment (but not a data segment or bss segment ‚Äî for example, two different processes can be found in different places when used, say, </font></font><code>strtok</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">To achieve this, the entire library must be addressed in one fell swoop so that all internal links are built in one-to-one manner. </font><font style="vertical-align: inherit;">Indeed, if one process picks up </font></font><code>ao</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>co</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the other </font></font><code>bo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>co</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then the OS will not be able to use any matches.</font></font><br><br><a name="windowsdlls"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Windows dll </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Despite the fact that the general principles of shared libraries are about the same on both Unix and Windows platforms, there are still a few details that beginners can get. </font></font><br><br><a name="winexport"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Exported characters </font></font></h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The biggest difference is that symbols are not </font><font style="vertical-align: inherit;">automatically </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exported to</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Windows libraries </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In Unix, all characters of all object files that have been authenticated to a shared library are visible to the user of this library. </font><font style="vertical-align: inherit;">In Windows, the programmer must explicitly make some characters visible, i.e. </font><font style="vertical-align: inherit;">export them. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are three ways to export the symbol and the Windows DLL (and all these three methods can be mixed in the same library).</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the source code, </font></font><a href="http://msdn.microsoft.com/ru-ru/library/3y1sfaz2.aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">declare a symbol as</font></font><code>__declspec(dllexport)</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><a href="http://msdn.microsoft.com/ru-ru/library/3y1sfaz2.aspx"><font style="vertical-align: inherit;">like</font></a><font style="vertical-align: inherit;"> this:</font></font><br><pre> <code class="bash hljs">__declspec(dllexport) int my_exported_function(int x, double y)</code> </pre> <br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When executing a linker command, use the </font></font><a href="http://msdn.microsoft.com/ru-ru/library/y0zzbyt4.aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">option</font></font><code>LINK.EXE</code></a> <code>export:</code> <i><code>symbol_to_export</code></i> <br><pre> <code class="bash hljs">LINK.EXE /dll /<span class="hljs-built_in"><span class="hljs-built_in">export</span></span>:my_exported_function</code> </pre> <br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Feed the </font></font><a href="http://msdn.microsoft.com/ru-ru/library/28d6s79h.aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">module definition file (DEF) to the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> linker </font><font style="vertical-align: inherit;">(using the option </font></font><code>/DEF:</code> <i><code>def_file</code></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) by including a section in this file </font></font><code>EXPORT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that contains the characters to be exported.</font></font><br><pre> <code class="bash hljs">EXPORTS my_exported_function my_other_exported_function</code> </pre><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As soon as C ++ is connected to this jumble, the first of these options becomes the simplest, since in this case the compiler undertakes to take care of </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decorating the names</font></font></a> <br><br><a name="winlibfiles"></a><h4> <code>.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and other library related files </font></font></h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We come to the second difficulty with the Windows libraries: information about exported symbols that the linker must associate with other symbols is not contained in itself </font></font><code>DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Instead, this information is contained in the corresponding </font></font><code>.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file. </font></font><br><br> <code>.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The file associated with </font></font><code>DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">describes which (exported) characters are located </font></font><code>DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">along with their location. Any binary that uses </font></font><code>DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">must access the </font></font><code>.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file in order to bind the characters correctly. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To make it even more confusing, the extension is </font></font><code>.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">also used for static libraries. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, there are a number of different files that can relate in any way to the Windows libraries. As well as</font></font><code>.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file, as well as (optional) </font></font><code>.DEF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file you can see all the files listed below associated with your Windows library.</font></font><br><ul><li><font style="vertical-align: inherit;"><a href="http://msdn.microsoft.com/en-us/library/37b80k4a.aspx"><font style="vertical-align: inherit;">Layout output</font></a><font style="vertical-align: inherit;"> files</font></font><a href="http://msdn.microsoft.com/en-us/library/37b80k4a.aspx"><font style="vertical-align: inherit;"></font></a> <br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">library</font></font></i> <code>.DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : the actual library code; </font><font style="vertical-align: inherit;">This file is needed (at runtime) by any binary using the library.</font></font><br></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">library</font></font></i> <code>.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : a ‚Äúlibrary import‚Äù file that describes where and which character is in the resulting one </font></font><code>DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This file is generated only if it </font></font><code>DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exports some of its characters. </font><font style="vertical-align: inherit;">If the characters are not exported, then there is no sense in the </font></font><code>.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file. </font><font style="vertical-align: inherit;">This file is needed at build time.</font></font><br></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">library</font></font></i> <code>.EXP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ‚ÄúExport file‚Äù of the compiled library, which is needed if there is an </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arrangement of binaries with circular dependency</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br></li><li> <i>library</i> <code>.ILK</code> :   <code>/INCREMENTAL</code>     ,    ,         .         . <br></li><li> <i>library</i> <code>.PDB</code> :   <code>/DEBUG</code>     ,     <i>  </i> ,     . <br></li><li> <i>library</i> <code>.MAP</code> :   <code>/MAP</code>     ,        . <br></li></ul><br></li><li>   <a href="http://msdn.microsoft.com/en-us/library/hcce369f.aspx"> </a> : <br><ul><li> <i>library</i> <code>.LIB</code> :  ¬´ ¬ª,          <code>DLL</code> ,    . <br></li><li> <i>library</i> <code>.LIB</code> :  ,    ,   .       <code>.LIB</code> <br></li><li> <i>library</i> <code>.DEF</code> :  ¬´¬ª,       ,  <a href="https://habr.com/ru/post/150327/"> </a> . <br></li><li> <i>library</i> <code>.EXP</code> :    ,   ,    <code>LIB.EXE</code>    <code>.LIB</code>  .    <a href="https://habr.com/ru/post/150327/">    </a> . <br></li><li> <i>library</i> <code>.ILK</code> :    ; . . <br></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">library</font></font></i> <code>.RES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : A resource file that contains information about the various GUI widgets used by the executable file. </font><font style="vertical-align: inherit;">These resources are included in the final binary.</font></font><br></li></ul><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This is a big difference to Unix, where almost all the information contained in these all additional files is simply added to the library itself. </font></font><br><br><a name="winimport"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Imported characters </font></font></h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Along with the requirement for the DLL to explicitly declare </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exported characters</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Windows also allows binaries that use library code to explicitly declare characters to be imported. </font><font style="vertical-align: inherit;">This is not mandatory, but gives some speed optimization, caused by the </font></font><a href="http://support.microsoft.com/kb/132044"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">historical properties of 16-bit windows</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To do this, </font></font><a href="http://msdn.microsoft.com/en-us/library/8fskxacy.aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">declare the symbol as __declspec (dllimport)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the source code like this:</font></font><br><pre> <code class="bash hljs">__declspec(dllimport) int function_from_some_dll(int x, double y); __declspec(dllimport) extern int global_var_from_some_dll;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the same time, an individual declaration of functions or global variables in one header file is a good programming tone in C. This leads to some rebus: the code in the DLL containing the definition of the function / variable must </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">export the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> character, but any other code using the DLL must </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">import the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> character. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The standard way out of this situation is to use preprocessor macros.</font></font><br><pre> <code class="hljs lisp">#ifdef EXPORTING_XYZ_DLL_SYMS #define XYZ_LINKAGE __declspec(<span class="hljs-name"><span class="hljs-name">dllexport</span></span>) #else #define XYZ_LINKAGE __declspec(<span class="hljs-name"><span class="hljs-name">dllimport</span></span>) #endif XYZ_LINKAGE int xyz_exported_function(<span class="hljs-name"><span class="hljs-name">int</span></span> x)<span class="hljs-comment"><span class="hljs-comment">; XYZ_LINKAGE extern int xyz_exported_variable;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The source file in the DLL that defines the function and variable ensures that the preprocessor variable is </font></font><code>EXPORTING_XYZ_DLL_SYMS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">defined (by means </font></font><code>#define</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) before including the corresponding header file and thus exports the symbol. </font><font style="vertical-align: inherit;">Any other code that includes this header file does not define this character and thus imports it.</font></font><br><br><a name="wincircular"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cyclic dependencies </font></font></h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another difficulty associated with using a DLL is the fact that Windows is stricter with the requirement that each character must be resolved at link time. </font><font style="vertical-align: inherit;">In Unix, it is quite possible to build a shared library that contains unresolved characters, i.e. </font><font style="vertical-align: inherit;">symbols, whose definition is unknown to the linker In this situation, any other code using this shared library will have to provide a definition of unresolved symbols, otherwise the program will not run. </font><font style="vertical-align: inherit;">Windows does not allow such licentiousness.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For most systems, this is not a problem. Executable files depend on high-level libraries, high-level libraries depend on low-level libraries, and everything is arranged in reverse order ‚Äî first low-level libraries, then high, and then the executable file, which depends on all the others. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, if there is a cyclic relationship between the binaries then everything gets a bit more complicated. If it </font></font><code>X.DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">needs a symbol from </font></font><code>Y.DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but </font></font><code>Y.DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">needs a symbol from </font></font><code>X.DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then it is necessary to solve the problem about the chicken and the egg: whatever library would be combined first, it will not be able to find a resolution to all the characters. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows provided a </font></font><a href="http://msdn.microsoft.com/en-us/library/kkt2hd12.aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">workaround</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> similar to the following.</font></font><br><ul><li>     X.  <code>LIB.EXE</code> ( <b></b> <code>LINK.EXE</code> ),    <code>X.LIB</code>   ,      <code>LINK.EXE</code> .   <code>X.DLL</code>   ,       <code>X.EXP</code> . <br></li><li>   <code>Y</code>  ,  <code>X.LIB</code> ,    ,      <code>Y.DLL</code>   <code>Y.LIB</code> . <br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the end, we are compiling the library </font></font><code>X</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">now fully. </font><font style="vertical-align: inherit;">This happens almost as usual, using additionally the file </font></font><code>X.EXP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtained in the first step. </font><font style="vertical-align: inherit;">The usual thing in this step is what the linker uses </font></font><code>Y.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and produces </font></font><code>X.DLL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Unusual - the linker skips the creation step </font></font><code>X.LIB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, since this file was already created in the first step, as indicated by the presence of the </font></font><code>.EXP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file.</font></font><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> But it is undoubtedly better to reorganize the libraries in such a way as to avoid any cyclic dependencies ... </font></font><br><br><a name="cppcompiler"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C ++ to complete the picture </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++ offers a number of additional features beyond what is available in C, and some of these features affect the work of the linker. </font><font style="vertical-align: inherit;">This was not always the case - the first C ++ implementations appeared as an external interface to the C compiler, so there was no need for compatibility of the linker‚Äôs work. </font><font style="vertical-align: inherit;">Over time, however, more advanced features of the language were added, so that the linker already had to be changed to support them.</font></font><br><br><a name="namemangling"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Function overloading and name decoration </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first difference in C ++ is that functions can be overloaded, that is, functions with the same name can exist at the same time, but with different types accepted (with different </font><font style="vertical-align: inherit;">function </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">signatures</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br><a name="maxfns"></a><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">max</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x&gt;y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">max</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x&gt;y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">max</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x&gt;y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This state of affairs definitely makes the linker‚Äôs work harder: if any code accesses a function </font></font><code>max</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which one was meant? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The solution to this problem is called name </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decoration</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (name mangling), because all the information about the signature of the function is translated (to mangle = distort, deform, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) in a text form that becomes the actual symbol name from the layout perspective. </font><font style="vertical-align: inherit;">Different signatures are translated into different names. </font><font style="vertical-align: inherit;">Thus, the problem of uniqueness of names is solved. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I'm not going to go into the details of the decorating schemes used (which also differ from platform to platform), but a quick glance at the object file corresponding to the code above will give an idea of ‚Äã‚Äãhow to understand all this (remember</font></font><code>nm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Your friend!): </font></font><br><pre> <code class="hljs ruby">Symbols from fn_overload.<span class="hljs-symbol"><span class="hljs-symbol">o:</span></span> Name Value Class Type Size Line Section __gxx_personality_v<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span> U <span class="hljs-params"><span class="hljs-params">| NOTYPE|</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>*UND* _Z3maxii <span class="hljs-params"><span class="hljs-params">|00000000|</span></span> T <span class="hljs-params"><span class="hljs-params">| FUNC|</span></span><span class="hljs-number"><span class="hljs-number">00000021</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span>.text _Z3maxff <span class="hljs-params"><span class="hljs-params">|00000022|</span></span> T <span class="hljs-params"><span class="hljs-params">| FUNC|</span></span><span class="hljs-number"><span class="hljs-number">0000002</span></span>9<span class="hljs-params"><span class="hljs-params">| |</span></span>.text _Z3maxdd <span class="hljs-params"><span class="hljs-params">|0000004c|</span></span> T <span class="hljs-params"><span class="hljs-params">| FUNC|</span></span><span class="hljs-number"><span class="hljs-number">00000041</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span>.text</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we see three functions </font></font><code>max</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, each of which received a different name in the object file, and we can be smart and assume that the next two letters after ‚Äúmax‚Äù denote the types of input parameters - ‚Äúi‚Äù as </font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ‚Äúf‚Äù as </font></font><code>float</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">well </font><font style="vertical-align: inherit;">as </font><font style="vertical-align: inherit;">‚Äúd‚Äù as </font></font><code>double</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(however, things get more complicated if classes, namespaces, templates, and overloaded operators come into play!). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is also worth noting that there is usually a way to convert between names visible to the programmer and names visible to the linker. It can be a separate program (for example, </font></font><code>c++filt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) or an option on the command line (for example </font></font><code>--demangle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for GNU nm), which gives something similar to this:</font></font><br><pre> <code class="hljs pgsql">Symbols <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> fn_overload.o: <span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> Size <span class="hljs-type"><span class="hljs-type">Line</span></span> Section __gxx_personality_v0| | U | NOTYPE| | |*UND* max(<span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span>) |<span class="hljs-number"><span class="hljs-number">00000000</span></span>| T | FUNC|<span class="hljs-number"><span class="hljs-number">00000021</span></span>| |.text max(<span class="hljs-type"><span class="hljs-type">float</span></span>, <span class="hljs-type"><span class="hljs-type">float</span></span>) |<span class="hljs-number"><span class="hljs-number">00000022</span></span>| T | FUNC|<span class="hljs-number"><span class="hljs-number">00000029</span></span>| |.text max(<span class="hljs-type"><span class="hljs-type">double</span></span>, <span class="hljs-type"><span class="hljs-type">double</span></span>) |<span class="hljs-number"><span class="hljs-number">0000004</span></span>c| T | FUNC|<span class="hljs-number"><span class="hljs-number">00000041</span></span>| |.text</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The area where decoration schemes are most often made to err is located at the intersection of C and C ++. All characters produced by the C ++ compiler are decorated; all the characters produced by the C compiler look the same as in the source code. To get around this, the C ++ language allows you to put </font></font><b><code>extern "C"</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">around declarations and function definitions. In essence, we tell C ++ to the compiler that a particular name should not be decorated - either because it is the definition of the C ++ function that will be called by C code, or later that it is the definition of the C function, which will be called by C ++ code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Returning to the example at the very beginning of the article, you can easily notice that there is a rather high probability that someone forgot to use </font></font><code>extern "C"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">when composing C and C ++ objects.</font></font><br><pre> <code class="bash hljs">g++ -o test1 test1a.o test1b.o test1a.o(.text+0x18): In <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> `main<span class="hljs-string"><span class="hljs-string">': : undefined reference to `findmax(int, int)'</span></span> collect2: ld returned 1 <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> status</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The great clue is that the error message contains the signature of the function - it is not just a message that was </font></font><code>findmax</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not found. </font><font style="vertical-align: inherit;">In other words, C ++ code looks for something like </font></font><code>"_Z7findmaxii"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but only finds </font></font><code>"findmax"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Therefore, a layout error occurs. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, notice that the declaration is </font></font><code>extern "C"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ignored for class member functions (¬ß7.5.4 of the C ++ standard)</font></font><br><br><a name="staticinit"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Initialization of static objects </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next C ++ property that goes beyond C, which affects the operation of the linker, is the existence </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object </font><i><font style="vertical-align: inherit;">constructors</font></i><font style="vertical-align: inherit;"> . A constructor is a piece of code that sets the initial state of an object. In essence, his work is conceptually equivalent to initializing the value of a variable, but with the important difference that we are talking about arbitrary code fragments. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recall from the </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first chapter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that global variables can begin their existence already with a certain value. In C, the construction of the initial value of such a global variable is a simple matter: a certain value is simply </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">copied from the data segment of the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> executable file to the appropriate place in the program's memory that is about to be executed.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In C ++, the initialization process can be much more complicated than just copying fixed values; all code in various constructors across the entire class hierarchy must be executed before the program itself actually starts. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To cope with this, the compiler places some additional information in the object file for each C ++ file; namely, this is a list of constructors that should be called for a specific file. During linking, the linker merges all of these lists into one large list, and also places the code that passes through the entire list, invoking the constructors of all global objects. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">order</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in which constructors of global objects are called not defined - it is completely at the mercy of what the linker intends to do. </font><font style="vertical-align: inherit;">(See Scott Myers Effective C ++ for further details - note 47 in the </font></font><a href="http://www.amazon.com/gp/product/0201924889"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">second edition</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , note 4 </font></font><a href="http://www.amazon.com/gp/product/0321334876"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the third edition</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can follow these lists, again by resorting to help </font></font><code>nm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Consider the following C ++ file:</font></font><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Fred</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Fred() : x(<span class="hljs-number"><span class="hljs-number">1</span></span>), y(<span class="hljs-number"><span class="hljs-number">2</span></span>) {} Fred(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z): x(z), y(<span class="hljs-number"><span class="hljs-number">3</span></span>) {} }; Fred theFred; <span class="hljs-function"><span class="hljs-function">Fred </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">theOtherFred</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">55</span></span></span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For this code ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> decorated) the output </font></font><code>nm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">looks like this:</font></font><br><pre> <code class="hljs ruby">Symbols from global_obj.<span class="hljs-symbol"><span class="hljs-symbol">o:</span></span> Name Value Class Type Size Line Section __gxx_personality_v<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span> U <span class="hljs-params"><span class="hljs-params">| NOTYPE|</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>*UND* __static_initialization_and_destruction_<span class="hljs-number"><span class="hljs-number">0</span></span>(int, int) <span class="hljs-params"><span class="hljs-params">|00000000|</span></span> t <span class="hljs-params"><span class="hljs-params">| FUNC|</span></span><span class="hljs-number"><span class="hljs-number">0000003</span></span>9<span class="hljs-params"><span class="hljs-params">| |</span></span>.text Fred::Fred(int) <span class="hljs-params"><span class="hljs-params">|00000000|</span></span> W <span class="hljs-params"><span class="hljs-params">| FUNC|</span></span><span class="hljs-number"><span class="hljs-number">00000017</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span>.text._ZN4FredC1Ei Fred::Fred() <span class="hljs-params"><span class="hljs-params">|00000000|</span></span> W <span class="hljs-params"><span class="hljs-params">| FUNC|</span></span><span class="hljs-number"><span class="hljs-number">0000001</span></span>8<span class="hljs-params"><span class="hljs-params">| |</span></span>.text._ZN4FredC1Ev theFred <span class="hljs-params"><span class="hljs-params">|00000000|</span></span> B <span class="hljs-params"><span class="hljs-params">| OBJECT|</span></span><span class="hljs-number"><span class="hljs-number">0000000</span></span>8<span class="hljs-params"><span class="hljs-params">| |</span></span>.bss theOtherFred <span class="hljs-params"><span class="hljs-params">|00000008|</span></span> B <span class="hljs-params"><span class="hljs-params">| OBJECT|</span></span><span class="hljs-number"><span class="hljs-number">0000000</span></span>8<span class="hljs-params"><span class="hljs-params">| |</span></span>.bss global constructors keyed to theFred <span class="hljs-params"><span class="hljs-params">|0000003a|</span></span> t <span class="hljs-params"><span class="hljs-params">| FUNC|</span></span><span class="hljs-number"><span class="hljs-number">0000001</span></span>a<span class="hljs-params"><span class="hljs-params">| |</span></span>.text</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As usual, we can see a bunch of different things here, but one of them is most interesting for us are records with class </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (which means ‚Äúweak‚Äù symbol) and also records with the name of a section like ".gnu.linkonce. t. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stuff</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". These are markers for constructors of global objects and we see that the corresponding ‚ÄúName‚Äù field shows what we actually could expect there - each of the two designers is involved.</font></font><br><br><a name="templates"></a><h3>  Templates </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Earlier, we gave </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an example</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with three different implementations of a function </font></font><code>max</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, each of which took arguments of different types. </font><font style="vertical-align: inherit;">However, we see that the code of the function body is identical in all three cases. </font><font style="vertical-align: inherit;">And we know that duplicating the same code is a bad programming tone. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++ introduces the concept of a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">template</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (templates), which allows you to use the code below for all cases at once. </font><font style="vertical-align: inherit;">We can create a header file </font></font><code>max_template.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with only one copy of the function code </font></font><code>max</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><pre> <code class="hljs kotlin">template &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span></span>(T x, T y) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x&gt;y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and include this file in the source file to try out the template function: </font></font><br><pre> <code class="hljs mel">#include <span class="hljs-string"><span class="hljs-string">"max_template.h"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main() { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b=<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c; c = <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(a,b); <span class="hljs-comment"><span class="hljs-comment">//   ,    max&lt;int&gt;(int,int) double x = 1.1; float y = 2.2; double z; z = max&lt;double&gt;(x,y); //    ,   max&lt;double&gt;(double,double) return 0; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This C ++ code uses </font></font><code>max&lt;int&gt;(int,int)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>max&lt;double&gt;(double,double)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. However, some other code could use other instances of this pattern. Well, let's say, </font></font><code>max&lt;float&gt;(float,float)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or even </font></font><code>max&lt;MyFloatingPointClass&gt;(MyFloatingPointClass,MyFloatingPointClass)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each of these different instances generates a different machine code. Thus, at the time when the program is finalized, the compiler and the linker must ensure that the code of each instance of the template used is included in the program (and no unused instance of the template is included, so as not to exaggerate the size of the program). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How is this done? There are usually two ways of doing things: either thinning out the repetitive instances or postponing the instances to the build stage (I usually call these approaches the reasonable way and the Sun way).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method of thinning repetitive instances implies that each object file contains the code of all the patterns encountered. </font><font style="vertical-align: inherit;">For example, for the file above, the contents of the object file look like this:</font></font><br><pre> <code class="hljs pgsql">Symbols <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> max_template.o: <span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> Size <span class="hljs-type"><span class="hljs-type">Line</span></span> Section __gxx_personality_v0 | | U | NOTYPE| | |*UND* <span class="hljs-type"><span class="hljs-type">double</span></span> max&lt;<span class="hljs-type"><span class="hljs-type">double</span></span>&gt;(<span class="hljs-type"><span class="hljs-type">double</span></span>, <span class="hljs-type"><span class="hljs-type">double</span></span>) |<span class="hljs-number"><span class="hljs-number">00000000</span></span>| W | FUNC|<span class="hljs-number"><span class="hljs-number">00000041</span></span>| |.text _Z3maxIdET_S0_S0_ <span class="hljs-type"><span class="hljs-type">int</span></span> max&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;(<span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span>) |<span class="hljs-number"><span class="hljs-number">00000000</span></span>| W | FUNC|<span class="hljs-number"><span class="hljs-number">00000021</span></span>| |.text._Z3maxIiET_S0_S0_ main |<span class="hljs-number"><span class="hljs-number">00000000</span></span>| T | FUNC|<span class="hljs-number"><span class="hljs-number">00000073</span></span>| |.text</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And we see the presence of both instances </font></font><code>max&lt;int&gt;(int,int)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>max&lt;double&gt;(double,double)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Both definitions are marked as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weak characters</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which means that the linker, when creating the final executable file, can throw out all the repeated instances of the same template and leave only one (and if it considers it necessary, then it can check whether all the repeated instances of the template are displayed in the same code). </font><font style="vertical-align: inherit;">The biggest disadvantage in this approach is the increase in the size of each individual object file.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another approach (which is used in Solaris C ++) is not to include template definitions in object files in general, but to mark them as undefined characters. </font><font style="vertical-align: inherit;">When it comes to the build stage, the linker can collect all the undefined characters that actually belong to the template instances, and then generate the machine code for each of them. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This definitely reduces the size of each object file, but the disadvantage of this approach is that the linker should keep track of where the source code is and should be able to run the C ++ compiler during linking (which can slow down the whole process)</font></font><br><br><a name="dlopen"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dynamically loadable libraries </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last feature we discuss here is the dynamic loading of shared libraries. In the </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previous chapter,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we saw how the use of shared libraries postpones the final layout until the program itself starts. In modern operating systems, this is even possible at later stages. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is done by a pair of system calls </font></font><code>dlopen</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>dlsym</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(approximate equivalents in Windows, respectively, are called </font></font><code>LoadLibrary</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>GetProcAddress</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). The first one takes the name of the shared library and loads it into the address space of the running process. Of course, this library may also have unresolved characters, so a call </font></font><code>dlopen</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">may entail loading other shared libraries.</font></font><br><br> <code>dlopen</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It offers the choice of either eliminating all unresolved issues as soon as the library is loaded, ( </font></font><code>RTLD_NOW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) or resolving characters as necessary ( </font></font><code>RTLD_LAZY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). The first method means that the call </font></font><code>dlopen</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">may take enough time, however, the second method lays a certain risk that during the execution of the program an undefined link will be found that cannot be resolved - at this point the program will be completed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, characters from a dynamically loaded library cannot have a name. However, this is simply solved, as well as other programmer problems are solved by adding an additional level of workarounds. In this case, a pointer to the character space is used. Call</font></font><code>dlsym</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">takes a literal parameter that gives the name of the character to be found and returns a pointer to its location (or </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, if the character is not found).</font></font><br><br><a name="dlopencpp"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interacting with C ++ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The dynamic loading process is fairly straightforward, but how does it interact with various C ++ features that affect the entire behavior of the linker? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first observation concerns the decoration of names. When called </font></font><code>dlsym</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the name of the character to be found is transmitted. So this should be the version of the name visible to the linker, i.e. decorated name. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the decorating process can vary from platform to platform and from compiler to compiler, this means that it is almost impossible to dynamically find a C ++ symbol by a universal method. Even if you work with only one compiler and delve into its inner world, there are other problems - besides simple C-like functions, there are a lot of other things (virtual method tables and the like) that need to be taken care of.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summarizing the above, we note the following: it is usually better to have one prisoner at the </font></font><code>extern "C"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">point of entry that can be found </font></font><code>dlsym</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This entry point can be a factory method that returns pointers to all instances of a C ++ class, allowing access to all the advantages of C ++. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The compiler can easily deal with the constructors of global objects in the library being loaded </font></font><code>dlopen</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, as there are a couple of special characters that can be added to the library and that will be called by the linker (no matter during loading or execution) if the library is dynamically loaded or unloaded - that is, necessary calls to constructors or destructors can occur here. In Unix, these are functions </font></font><code>_init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>_fini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, or for newer systems using the GNU toolkit, there are functions labeled as </font></font><code>__attribute__((constructor))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>__attribute__((destructor))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In Windows, the corresponding function is </font></font><code>DllMain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the parameter </font></font><code>DWORD fdwReason</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">equal to </font></font><code>DLL_PROCESS_ATTACH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>DLL_PROCESS_DETACH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And in conclusion, we add that dynamic loading copes well with the ‚Äúthinning out of repeated instances‚Äù, if we are talking about instantiating templates; and everything looks ambiguous with ‚Äúpostponing instantiation‚Äù, since the ‚Äúbuild stage‚Äù comes after the program is already running (and quite likely on another machine that does not store the source code). Refer to the compiler and linker documentation to find a way out of this situation.</font></font><br><br><a name="moredetails"></a><h2>  Additionally </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this article, many details were intentionally omitted on how the linker works, because I believe that the content of the written covers 95% of the everyday problems that the programmer has to deal with when building his program. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want to know more, you can read the information from the links below:</font></font><br><ul><li> <a href="http://www.amazon.com/exec/obidos/tg/detail/-/1558604960"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">John Levine, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkers and Loaders</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : contains a huge amount of information about the intricacies of the linker and the loader, including all the </font></font><a href="https://habr.com/ru/post/150327/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">things missed</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in this article. </font><font style="vertical-align: inherit;">There is also an online version of this book (or its draft) </font></font><a href="http://www.iecc.com/linker"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br></li><li> <a href="http://0xfe.blogspot.com/2006/03/how-os-x-executes-applications.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An excellent link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the description of the Mach-O format for binaries on Mac OS X.</font></font><br></li><li> <a href="http://www.amazon.com/exec/obidos/tg/detail/-/0131774298/">Peter Van Der Linden, <i>Expert C Programming</i></a> :  ,     ,  ,   C, <a href="https://habr.com/ru/post/150327/">   </a> ,      C,  . <br></li><li> <a href="http://www.amazon.com/exec/obidos/tg/detail/-/020163371X">Scott Meyers, <i>More Effective C++</i></a> :  34  ,     C  C++    (    ) <br></li><li> <a href="http://www.amazon.com/exec/obidos/tg/detail/-/0201543303/">Bjarne Stroustrup, <i>The Design and Evolution of C++</i></a> :   11.3  <a href="https://habr.com/ru/post/150327/">  C++</a>    . <br></li><li> <a href="http://www.amazon.com/exec/obidos/tg/detail/-/0201514591/">Margaret A. Ellis &amp; Bjarne Stroustrup, <i>The Annotated C++ Reference Manual</i></a> :  7.2c   <a href="https://habr.com/ru/post/150327/">  </a> <br></li><li> <a href="http://www.skyfree.org/linux/references/ELF_Format.pdf">ELF format reference [PDF]</a> <br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Two interesting articles about </font></font><a href="http://www.muppetlabs.com/~breadbox/software/tiny/teensy.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">creating lightweight executable files in Linux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the </font></font><a href="http://blog.ksplice.com/2010/03/libc-free-world/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">minimum Hello World</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in particular.</font></font><br></li><li> <a href="http://www.akkadia.org/drepper/dsohowto.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The How To Write Shared Libraries [PDF] of the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> notorious </font></font><a href="http://www.akkadia.org/drepper/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ulrich Drepper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains more details about ELF and redirection.</font></font><br></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Many thanks to Mike Capp and Ed Wilson for useful suggestions about this page. </font></font><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copyright ¬© 2004-2005,2009-2010 David Drysdale </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permission is given by the Free Software Foundation; </font><font style="vertical-align: inherit;">Front Cover Texts, with Back Cover Texts. </font><font style="vertical-align: inherit;">A copy of the license is available </font></font><a href="http://www.gnu.org/copyleft/fdl.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div><p>Source: <a href="https://habr.com/ru/post/150327/">https://habr.com/ru/post/150327/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150322/index.html">Free VPN from ThePirateBay</a></li>
<li><a href="../150323/index.html">Digital Era Declaration</a></li>
<li><a href="../150324/index.html">Amazon Glacier: Perl client with multi-thread / multipart download</a></li>
<li><a href="../150325/index.html">Chinese browser UCWeb goes to the West (in Asia already 200 million users)</a></li>
<li><a href="../150326/index.html">Firefox 15 release</a></li>
<li><a href="../150328/index.html">Notification that the browser is outdated</a></li>
<li><a href="../150329/index.html">Qt Coding Style</a></li>
<li><a href="../150331/index.html">New 0day exploit for Java. Now in Metasploit</a></li>
<li><a href="../150332/index.html">LG Optimus Vu II will receive infrared</a></li>
<li><a href="../150333/index.html">Flat lens creates the perfect image.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>