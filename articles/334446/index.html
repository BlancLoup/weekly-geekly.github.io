<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gentlemen's Doctrine 2 for Symfony 3.3.6: Creating Entities, Associations, and Recursive Links</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, reader! 

 What we will do with you in the course of reading the article 


- Create simple entities 
- Let's talk a little about ORM annota...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gentlemen's Doctrine 2 for Symfony 3.3.6: Creating Entities, Associations, and Recursive Links</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/0c8/14d/ea6/0c814dea68094b53be644740de1d3419.jpg"><br><br>  Good day, reader! <br><br><h3>  What we will do with you in the course of reading the article </h3><br><ul><li>  Create simple entities </li><li>  Let's talk a little about ORM annotations </li><li>  We realize associations: <br><ol><li>  Bidirectional communications One to One </li><li>  Bidirectional communications One to Many </li><li>  Bidirectional connections Many to Many </li><li>  Recursive communications </li></ol><br></li><li>  Let's play with these entities using fixtures </li></ul><br><a name="habracut"></a><br><h3>  Who will be interested in the article: </h3><br>  It will be interesting to the reader if he is already well-versed in symfony - at least one simple project has already been made.  I also met interest in this information from advanced developers, so that they can also walk along the diagonal.  The article itself is written as an answer to the frequent questions of the guys I work with.  Now I can just throw them a link to this article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Create entity </h3><br>  <b>All console commands will be written in a manner as if Composer is not installed in the system.</b> <br><br>  Install symfony to start: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#             . php composer.phar create-project symfony/framework-standard-edition ./gentlemans_set "v3.3.6" #       cd gentlemans_set/ #     php bin/console doctrine:database:create</span></span></code> </pre> <br><br>  Some people are used to it, but I don‚Äôt like to write a lot of code with my own hand.  If there is an opportunity to use autogeneration of something in symfony, then I use it and advise you, since it is minimization of the human factor, and just unloads your mind.  Let's generate two simple entities via symfony console commands: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   User php bin/console doctrine:generate:entity --entity=AppBundle:User --fields="username:string(127) password:string(127)" -q #   Product php bin/console doctrine:generate:entity --entity=AppBundle:Product --fields="name:string(127) description:text" -q</span></span></code> </pre><br>  As a result, we have created two classes of entities: <br><ul><li>  src / AppBundle / Entity / Product.php </li><li>  src / AppBundle / Entity / User.php </li></ul><br><br>  And two classes of repositories for relevant entities: <br><ul><li>  src / AppBundle / Repository / ProductRepository.php </li><li>  src / AppBundle / Repository / UserRepository.php </li></ul><br><br>  Before we proceed to the creation of a database structure for these entities, consider the entities themselves.  Namely annotations in them.  I believe that most of my readers already understand this topic well, but, nevertheless, I will go through a couple of moments. <br><br><div class="spoiler">  <b class="spoiler_title">Entity src / AppBundle / Entity / Product.php immediately after generation:</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ... /** * Product * * @ORM\Table(name="product") * @ORM\Entity(repositoryClass="AppBundle\Repository\ProductRepository") */ class Product { /** * @var int * * @ORM\Column(name="id", type="integer") * @ORM\Id * @ORM\GeneratedValue(strategy="AUTO") */ private $id; /** * @var string * * @ORM\Column(name="name", type="string", length=127) */ private $name; // ...</span></span></code> </pre><br><br>  Check what SQL query will be created to create the database structure: <br><pre> <code class="bash hljs">php bin/console doctrine:schema:create --dump-sql CREATE TABLE user (id INT AUTO_INCREMENT NOT NULL, username VARCHAR(127) NOT NULL, password VARCHAR(127) NOT NULL, PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB; CREATE TABLE product (id INT AUTO_INCREMENT NOT NULL, name VARCHAR(127) NOT NULL, description LONGTEXT NOT NULL, PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB;</code> </pre><br></div></div><br><br>  As a result of the generation of the entity, redundant annotations are created and at this stage the entity will have exactly the same behavior if we reduce the annotations to the variant: <br><br><div class="spoiler">  <b class="spoiler_title">Cleaned version</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/AppBundle/Entity/Product.php // ... /** * @ORM\Entity(repositoryClass="AppBundle\Repository\ProductRepository") */ class Product { /** * @var int * * @ORM\Column(type="integer") * @ORM\Id * @ORM\GeneratedValue(strategy="AUTO") */ private $id; /** * @var string * * @ORM\Column(type="string", length=127) */ private $name; // ...</span></span></code> </pre><br>  Check what SQL query will be created to create the database structure and see exactly the same result: <br><pre> <code class="bash hljs">php bin/console doctrine:schema:create --dump-sql CREATE TABLE user (id INT AUTO_INCREMENT NOT NULL, username VARCHAR(127) NOT NULL, password VARCHAR(127) NOT NULL, PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB; CREATE TABLE product (id INT AUTO_INCREMENT NOT NULL, name VARCHAR(127) NOT NULL, description LONGTEXT NOT NULL, PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE = InnoDB;</code> </pre><br></div></div><br><br>  What I would like to draw attention to such an example?  Overwhelmingly <br>  In most cases, we create the database structure automatically using the entity as a model.  I deleted all parts of the annotations, where it was explicitly stated how to name the table for this entity and how to name each of the fields.  This configuration data is needed only when we are working with an already existing database and, by some coincidence, the field names do not correspond to the name of the properties in essence.  If they are not specified, then Doctrine will name the table according to the name of the entity class, and call the fields according to the name of the entity properties.  And this is the right approach, since this is development along the path of least surprise - the names of the fields in the database coincide with the properties of the entity and there is no third party that influences and can ‚Äúsurprise‚Äù. <br><br>  But you will say that we then lose the level of abstraction and with each refactoring of the entity we will have to update the database structure.  The answer to this will be: no matter how cool you are, but the uncorrected discrepancy between the names of entity properties and fields in the database as a result of refactoring is an extra point to the <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D1%2585%25D0%25BD%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B4%25D0%25BE%25D0%25BB%25D0%25B3">technical debt of the project</a> . <br><br>  I am exaggerating the situation: after a couple of years, when your project has grown to a global scale and you have already smashed the database across a whole cloud of servers, to cope with unbearable workload, you can find in the database a table with the name 'this_may_work' and the fields: 'id' , 'foo', 'bar' and 'some_field_2'.  The justification that names have a deeper meaning in the juxtaposed entity will prove to be unimportant. <br><br>  We start the generation of the database structure: <br><br><pre> <code class="bash hljs">php bin/console doctrine:schema:create</code> </pre><br><br>  Now we have two entities mapped to the created tables in the database.  We can create instances of them, save them in a database, and then fetch them from a database.  To demonstrate the creation of instances of entities in this article, I decided to use fixtures, and I will demonstrate the sample in the methods of entity repositories.  We already have an entity repository, but we don‚Äôt yet have a mechanism for working with fixture data. <br><br><h3>  Install fixtures </h3><br><br>  We add the doctrine / doctrine-fixtures-bundle dependency to our project: <br><pre> <code class="bash hljs">php composer.phar require --dev doctrine/doctrine-fixtures-bundle</code> </pre><br><br>  We connect dependency bundle in symfony core: <br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">// app/AppKernel.php // ... if (in_array($this-&gt;getEnvironment(), array('dev', 'test'))) { // ... $bundles[] = new Doctrine\Bundle\FixturesBundle\DoctrineFixturesBundle(); } // ...</span></span></code> </pre><br><br>  Now we are ready to write fixtures.  Create a directory for them: <br><br><pre> <code class="bash hljs">mkdir -p src/AppBundle/DataFixtures/ORM</code> </pre><br><br>  And the initial view of the fixture data: <br><br><div class="spoiler">  <b class="spoiler_title">src / AppBundle / DataFixtures / ORM / LoadCommonData.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">DataFixtures</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Product</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">DataFixtures</span></span>\<span class="hljs-title"><span class="hljs-title">FixtureInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Persistence</span></span>\<span class="hljs-title"><span class="hljs-title">ObjectManager</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadCommonData</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FixtureInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjectManager $manager)</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); $user -&gt;setPassword(<span class="hljs-string"><span class="hljs-string">'some_password'</span></span>) -&gt;setUsername(<span class="hljs-string"><span class="hljs-string">''</span></span>); $manager-&gt;persist($user); $product = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product(); $product -&gt;setName(<span class="hljs-string"><span class="hljs-string">'  '</span></span>) -&gt;setDescription(<span class="hljs-string"><span class="hljs-string">'   .        .'</span></span>); $manager-&gt;persist($product); $manager-&gt;flush(); } }</code> </pre><br></div></div><br><br>  Now with this command we can load this fixture data into the database: <br><br><pre> <code class="bash hljs">php bin/console doctrine:fixtures:load</code> </pre><br><br><h3>  One-to-one bidirectional communication </h3><br><br>  Above, we got an application with two unrelated entities.  What, in fact, makes this application absolutely meaningless.  Most data in real-world applications is somehow related to other data.  Every your thumbs up, every comment on a social networking page is related to the user's essence, otherwise they are useless. <br><br>  One-to-one connection - in projects I find it even less often than a many-to-many connection.  What is natural, if you follow the <a href="https://ru.wikipedia.org/wiki/%25D0%259D%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0">normal forms</a> .  But to know how it is implemented is necessary. <br><br>  For example, let's create the Seller entity, which will be connected one-to-one with the User entity, if this user is a seller: <br><br><pre> <code class="bash hljs">php bin/console doctrine:generate:entity --entity=AppBundle:Seller --fields=<span class="hljs-string"><span class="hljs-string">"company:string(127) contacts:text"</span></span> -q</code> </pre><br><br>  Then we change the user‚Äôs essence to create a connection with the seller‚Äôs essence: <br><div class="spoiler">  <b class="spoiler_title">src / AppBundle / Entity / User.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... class User { // ... /** * @ORM\OneToOne(targetEntity="Seller") */ private $seller; // ... }</span></span></code> </pre><br></div></div><br><br>  We change the essence of the seller by adding a link with the user's essence: <br><div class="spoiler">  <b class="spoiler_title">src / AppBundle / Entity / Seller.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... class Seller { // ... /** * @ORM\OneToOne(targetEntity="User", mappedBy="seller") */ private $user; // ... }</span></span></code> </pre><br></div></div><br><br>  Note that I immediately gave an example of <u>bidirectional communication</u> ... in general, I see no reason to make unidirectional communication.  The database does not change the bidirectional connection, and in the program code provides great convenience.  In my opinion, perhaps subjective, even unidirectional communication does not give anything in terms of optimization in speed and use of RAM.  (Disclaimer: in the last section of the article, where I talk about recursive communication, I give the only known successful example of unidirectional communication to me.) <br><br>  Also note that I <u>dropped the annotations again</u> .  This time the @JoinColumn annotations.  These annotations are needed exactly for the same thing that I also needed the annotations I deleted earlier - to specify with what name a field will be created in the database and for which field a foreign key will be created in the database.  All this will be done without this annotation at its best. <br><br>  We start autogeneration of getter / setter methods in all entities of our bundle.  These methods are created for new entity properties: <br><pre> <code class="bash hljs">php bin/console doctrine:generate:entities AppBundle</code> </pre><br><br>  We also need to bring the database structure in line with our entities: <br><pre> <code class="bash hljs">php bin/console doctrine:schema:update --force</code> </pre><br><br>  The last command should be used with caution if there is any data in the database that you do not want to lose.  On the production server, this command should not be used at all.  Learn on your own what <a href="https://symfony.com/doc/master/bundles/DoctrineMigrationsBundle/index.html">migration database is</a> . <br><br>  Well and in fixtures we will create one more user who will be already connected with essence of the seller. <br><div class="spoiler">  <b class="spoiler_title">src / AppBundle / DataFixtures / ORM / LoadCommonData.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">DataFixtures</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Product</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Seller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">DataFixtures</span></span>\<span class="hljs-title"><span class="hljs-title">FixtureInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Persistence</span></span>\<span class="hljs-title"><span class="hljs-title">ObjectManager</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadCommonData</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FixtureInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjectManager $manager)</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); $user -&gt;setPassword(<span class="hljs-string"><span class="hljs-string">'some_password'</span></span>) -&gt;setUsername(<span class="hljs-string"><span class="hljs-string">''</span></span>); $manager-&gt;persist($user); $seller = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Seller(); $seller -&gt;setCompany(<span class="hljs-string"><span class="hljs-string">"  "</span></span>) -&gt;setContacts(<span class="hljs-string"><span class="hljs-string">" "</span></span>); $manager-&gt;persist($seller); $seller_user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); $seller_user -&gt;setPassword(<span class="hljs-string"><span class="hljs-string">'some_password'</span></span>) -&gt;setUsername(<span class="hljs-string"><span class="hljs-string">''</span></span>) -&gt;setSeller($seller); $manager-&gt;persist($seller_user); $product = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product(); $product -&gt;setName(<span class="hljs-string"><span class="hljs-string">'  '</span></span>) -&gt;setDescription(<span class="hljs-string"><span class="hljs-string">'   .        .'</span></span>); $manager-&gt;persist($product); $manager-&gt;flush(); } }</code> </pre><br></div></div><br><br>  We start loading fixture data and in the database we can admire the records created. <br><br>  If you have trouble understanding how these annotations have created a connection between entities, and if the official documentation of Doctrine 2 did not help you, then look at the picture: <br><br><img src="https://habrastorage.org/web/4c3/fe1/93e/4c3fe193e65c43b68073b26c2d83e547.png"><br><br>  Here, the arrows indicate where it came from, to be entered in the annotation. <br><br>  It should be noted that the annotations in both entities turned out to be very similar.  Syntactically, they differ only in the <b>mappedBy</b> and <b>inversedBy attributes</b> .  But this is a fundamental difference.  The entity from which the attribute is inversedBy is usually considered a subordinate entity, which has the attribute mappedBy.  It turns out that the User entity is subordinate to the Seller entity.  This is expressed in the fact that in the database it is the user table that contains the foreign key on the seller table, and not vice versa.  It also affects the code that we wrote in the fixture data - notice that we assigned the seller to the user by the setSeller method, and not the user to the seller.  The last option is simply not displayed in any way in the database.  That is, we must understand that it is the object of the subordinate entity that is indicated with whom it is associated. <br><br><h3>  Bidirectional one-to-many communication </h3><br><br>  The most common form of communication.  Therefore, you need to be able to realize it even while intoxicated without the Internet, somewhere on tropical islands being littered with a system of communicating caves without a computer, without hands, without a head.  In general, by your own existence, you must carry the one-to-many connection to projects on symfony. <br><br>  As it was above, we will write an example of a bidirectional connection.  To do this, link the already existing entities: Product and Seller. <br><br>  We answer the question: who will be in this connection a lot, and who will be alone.  It usually turns out that a lot of products from one seller.  Thus, the new Seller entity property will have the <code>@ORM\OneToMany</code> , and the Product entity properties will have <code>@ORM\ManyToOne</code> .  Otherwise, everything is the same as the type of communication "one to one."  However, it is no longer possible to swap the mappedBy and inversedBy attributes freely, since the entity from the ‚Äúmany‚Äù relationship always submits to the entity from the ‚Äúone‚Äù side.  Accordingly, the foreign keys in the database will always be only for products.  Continuing the logic: it is the product, as a subordinate entity, that sellers will be assigned by the setSeller method, which we will write below in order for this assignment to be stored in the database. <br><br>  We change the essence of the seller, to create a connection with the essence of the product: <br><div class="spoiler">  <b class="spoiler_title">src / AppBundle / Entity / Seller.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... class Seller { // ... /** * @ORM\OneToMany(targetEntity="Product", mappedBy="seller") */ private $products; // ... }</span></span></code> </pre><br></div></div><br><br>  We change the essence of the product by adding a link with the essence of the seller: <br><div class="spoiler">  <b class="spoiler_title">src / AppBundle / Entity / Product.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... class Product { // ... /** * @ORM\ManyToOne(targetEntity="Seller", inversedBy="product") */ private $seller; // ... }</span></span></code> </pre><br></div></div><br><br>  Run the autogeneration of getter / setter methods again in all entities of our bundle. <br>  Again, run the command to update the database structure.  (See above, if you do not remember the command). <br><br>  We assign the seller to a product that is already being created in our fixture data: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/AppBundle/DataFixtures/ORM/LoadCommonData.php // ... $product = new Product(); $product -&gt;setSeller($seller) -&gt;setName('  ') -&gt;setDescription('   .        .'); // ...</span></span></code> </pre><br><br>  We start loading fixture data and in the database we can admire the fact that the product record 'Pillow for a programmer' has acquired a value in the field seller_id.  This is what we wanted - now in our product each seller can have a lot of goods. <br><br>  The code to check in any action of any controller: <br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">// ... $product = $this-&gt;getDoctrine() -&gt;getRepository("AppBundle:Product") -&gt;find(6); dump($product-&gt;getSeller()-&gt;getCompany()); // ...</span></span></code> </pre><br><br>  6 - this is the id of my product at the time of writing this article (when you start loading fixture data, the old entries in the database tables are deleted, but the auto-increment of the primary key is not reset).  Here we got the product from the repository by the value of its primary key (id field), and got the merchant essence associated with it by the getSeller method.  At the output we get: <br>  "Horns and hooves" <br><br>  Now let's try to find all the products of the seller.  In the example code for any action of any controller: <br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">// ... $seller = $this-&gt;getDoctrine() -&gt;getRepository("AppBundle:Seller") -&gt;find(5); $names = []; foreach($seller-&gt;getProducts() as $product) { $names[] = $product-&gt;getName(); } dump($names); // ...</span></span></code> </pre><br><br>  Output dump function: <br> <code>array:1 [‚ñº <br> 0 =&gt; "  " <br> ] <br></code> <br><br>  As for me, the result is achieved. <br><br><h3>  Bidirectional many-to-many communication </h3><br><br>  It is very useful to know how such a relationship is organized, although it is much less common one-to-many.  I guess you should already know that the many-to-many relationship in the database is organized by linking two tables through a third, pivot table.  We don‚Äôt need to create an entity for this third table - Doctrine will create this table for us when we run the command to create or update the database structure. <br><br>  In our growing project, we will create a Category entity and associate its many-to-many with the Product.  Thus, we will create the opportunity for a single product to be in several categories at once.  The ‚Äúmany-to-many‚Äù relationship here is revealed simply: many products may lie in one category, one product may lie in many categories ‚Äî that from the product side, that from the category side there is a ‚Äúmany‚Äù sign, it means that a ‚Äúmany-to-many‚Äù link is needed. <br><br>  Create an entity category: <br><pre> <code class="bash hljs">php bin/console doctrine:generate:entity --entity=AppBundle:Category --fields=<span class="hljs-string"><span class="hljs-string">"name:string(127)"</span></span> -q</code> </pre><br><br>  Modify the category entity to create a relationship with the product entity: <br><div class="spoiler">  <b class="spoiler_title">src / AppBundle / Entity / Category.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... class Category { // ... /** * @ORM\ManyToMany(targetEntity="Product", mappedBy="categories") */ private $products; // ... }</span></span></code> </pre><br></div></div><br><br>  We change the essence of the product by adding a link with the category essence: <br><div class="spoiler">  <b class="spoiler_title">src / AppBundle / Entity / Product.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... class Product { // ... /** * @ORM\ManyToMany(targetEntity="Category", inversedBy="products") */ private $categories; // ... }</span></span></code> </pre><br></div></div><br><br>  We start autogeneration of getter / setter methods in all entities of our bundle.  Again, run the command to update the database structure.  (See above, if you do not remember the command). <br><br>  Fixtures are complemented by the creation of two categories, create another product and assign categories to products.  It turned out that all products are in all categories.  God forgive us God of Marketing, but this was done just for clarity. <br><br><div class="spoiler">  <b class="spoiler_title">src / AppBundle / DataFixtures / ORM / LoadCommonData.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">DataFixtures</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Category</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Product</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Seller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">AppBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">DataFixtures</span></span>\<span class="hljs-title"><span class="hljs-title">FixtureInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Persistence</span></span>\<span class="hljs-title"><span class="hljs-title">ObjectManager</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadCommonData</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FixtureInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjectManager $manager)</span></span></span><span class="hljs-function"> </span></span>{ $user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); $user -&gt;setPassword(<span class="hljs-string"><span class="hljs-string">'some_password'</span></span>) -&gt;setUsername(<span class="hljs-string"><span class="hljs-string">''</span></span>); $manager-&gt;persist($user); $seller = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Seller(); $seller -&gt;setCompany(<span class="hljs-string"><span class="hljs-string">"  "</span></span>) -&gt;setContacts(<span class="hljs-string"><span class="hljs-string">" "</span></span>); $manager-&gt;persist($seller); $seller_user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); $seller_user -&gt;setPassword(<span class="hljs-string"><span class="hljs-string">'some_password'</span></span>) -&gt;setUsername(<span class="hljs-string"><span class="hljs-string">''</span></span>) -&gt;setSeller($seller); $manager-&gt;persist($seller_user); $category = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Category(); $category-&gt;setName(<span class="hljs-string"><span class="hljs-string">''</span></span>); $manager-&gt;persist($category); $category2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Category(); $category2-&gt;setName(<span class="hljs-string"><span class="hljs-string">''</span></span>); $manager-&gt;persist($category2); $product = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product(); $product -&gt;setSeller($seller) -&gt;setName(<span class="hljs-string"><span class="hljs-string">'  '</span></span>) -&gt;setDescription(<span class="hljs-string"><span class="hljs-string">'   .        .'</span></span>); $manager-&gt;persist($product); $product2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product(); $product2 -&gt;setSeller($seller) -&gt;setName(<span class="hljs-string"><span class="hljs-string">'  '</span></span>) -&gt;setDescription(<span class="hljs-string"><span class="hljs-string">',      64 ,   - 64 ,    16 '</span></span>); $manager-&gt;persist($product2); $product-&gt;addCategory($category); $product-&gt;addCategory($category2); $product2-&gt;addCategory($category); $product2-&gt;addCategory($category2); $manager-&gt;flush(); } }</code> </pre><br></div></div><br><br>  It is important to note here that in spite of the equality of the entities involved in the connection, <u>we still need to use the mappedBy and inversedBy attributes</u> .  And this is unexpected, but the behavior that we observed when creating the one-to-many relationship is preserved here - the entity object, on the side of which the mappedBy attribute was specified, should be assigned to the entity object, on the side of which the inversedBy attribute is specified.  Otherwise, entries in the pivot table will not appear.  It turns out that, willy-nilly, we have to select and keep in mind which of the entities in this connection is subordinate and it is to its objects to assign objects of the second entity.  In this case, the subordinate entity - Product and we assign objects to the objects of the Category entity to its objects.  If anyone knows how to get around this without crutches, changing only the annotations - <b>write in the comments</b> .  I usually get away with a small modification of the setter of the main entity (as I recently discovered, <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/association-mapping.html">the same solution for the problem is</a> described in the official Doctrine2 documentation): <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">// ... /** * Add product * * @param \AppBundle\Entity\Product $product * * @return Category */ public function addProduct(\AppBundle\Entity\Product $product) { $product-&gt;addCategory($this); //     ,      ,     $this-&gt;products[] = $product; return $this; } // ...</span></span></code> </pre><br><br>  We start loading the fixture data into the database, check the database and see that the product_category summary table contains 4 records, each of which establishes a connection between a certain category and a specific product: <br><br><img src="https://habrastorage.org/web/39c/9aa/970/39c9aa97045b480395aea7a4155a3580.png"><br><br><h3>  Recursive communications </h3><br>  A recursive connection is called if it is built with an entity with itself.  And this relationship can be one-to-one, one-to-many, and many-to-many.  There is where to roam.  Let us first consider an option that is not mentioned in the official documentation - a <u>one-to</u> - <u>one recursive ‚Äúmany-to-many‚Äù relationship</u> . <br><br>  We change the user‚Äôs essence by adding the many-to-many relationship to itself: <br><div class="spoiler">  <b class="spoiler_title">src / AppBundle / Entity / User.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... class User { // ... /** * @ORM\ManyToMany(targetEntity="User") */ private $friends; // ... }</span></span></code> </pre><br></div></div><br><br>  This is an example of the successful use of a unidirectional connection, since a comparison of an entity occurs to itself on the primary key using a pivot table - hence, bidirectionality is not required.  Run the entity generation for the bundle, update the data structure and you can add our fixtures with strings: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ... public function load(ObjectManager $manager) { // ... $user-&gt;addFriend($seller_user); $seller_user-&gt;addFriend($user); $manager-&gt;flush(); } // ...</span></span></code> </pre><br><br>  Now each user can have as many user-friends as we want.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a great example of a non-hierarchical structure when there is no master / subordinate, parent / descendant relationship as in a tree structure. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now we analyze the tree structure by creating a recursive connection. </font><font style="vertical-align: inherit;">We change the category essence by adding a one-to-many relationship with itself:</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">src / AppBundle / Entity / Category.php</font></font></b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... class Category { // ... /** * @ORM\OneToMany(targetEntity="Category", mappedBy="parent") */ private $children; /** * @ORM\ManyToOne(targetEntity="Category", inversedBy="children") */ private $parent; // ... }</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think that everything is so obvious here - the category has a parent and descendants. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After updating the database structure and generating getter / setter methods, add the fixture data with an indication of who is the parent and who is a descendant:</font></font><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ... public function load(ObjectManager $manager) { // ... $category2-&gt;setParent($category); $category-&gt;addChild($category2); $manager-&gt;flush(); } // ...</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will not analyze the recursive ‚Äúone-to-one‚Äù relationship - if this is required, then using the analogy method, I think, it‚Äôs not a problem to write it yourself. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The construction of a hierarchical non-treelike structure, where parents, like descendants, can be more than one, is done using the same analogy method, I think, there is no problem either.</font></font><br><br><h3>  Helpful </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use the symfony toolbar that appears at the bottom of the page when you launch your application in the developer‚Äôs environment: </font></font><br><br><img src="https://habrastorage.org/web/719/7be/65a/7197be65a0e741838b034c01510e9680.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you mess up with annotations in entities, Doctrine will likely notice this and give you an error here. </font><font style="vertical-align: inherit;">Click on this icon and be able to read in detail about the error, which should take you out of difficulties.</font></font><br><br><h3>  On the road </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">He planned to touch upon the topics of polymorphic links with the Signle Table Inheritance, but the article had already grown prohibitively. </font><font style="vertical-align: inherit;">So leave it all in reserve. </font><font style="vertical-align: inherit;">Write in the comments, if I got it wrong where, with such a volume of the text, my eyes will wash much. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The project, resulting from the writing of the article, will be posted here: </font><font style="vertical-align: inherit;">But for those who are just studying the topic of relationships between entities, I advise you to do all the work yourself, and not to take the project ready - this is a good exercise. </font><font style="vertical-align: inherit;">The article has everything to make a project from scratch.</font></font><br> <a href="https://bitbucket.org/felix010volodya/habrahabr-symfony-gentlemans-set"><img src="https://habrastorage.org/web/d07/e9e/d86/d07e9ed867ea43e1a8211020ab25e964.png"></a> <br><br><font style="vertical-align: inherit;"></font></div><p>Source: <a href="https://habr.com/ru/post/334446/">https://habr.com/ru/post/334446/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334434/index.html">We write a snake game using JavaScript + Canvas</a></li>
<li><a href="../334436/index.html">The digest of interesting materials for the mobile # 214 developer (July 24 - 30)</a></li>
<li><a href="../334440/index.html">GlusterFS snapshots</a></li>
<li><a href="../334442/index.html">Interviews, labor market and other in the city of Moscow arr. summer 7525</a></li>
<li><a href="../334444/index.html">PostgreSQL Evangelist Memo: Expropriate Expropriators</a></li>
<li><a href="../334448/index.html">Reverse side of spring</a></li>
<li><a href="../334450/index.html">Camp game "Mafia" for 50+ people</a></li>
<li><a href="../334458/index.html">Team web studio: growth system, certification and motivation</a></li>
<li><a href="../334460/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ273 (July 24 - 30, 2017)</a></li>
<li><a href="../334462/index.html">PHP Digest number 113 - the latest news, materials and tools (July 16 - 30, 2017)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>