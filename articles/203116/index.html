<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Children's launcher 2.x and a single premium account</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What's new 
 After the publication of the first version of the application, we received a large number of reviews. By putting together the wishes of u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Children's launcher 2.x and a single premium account</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/46b/a6e/366/46ba6e36670176efd573000d803036f1.png"><br><br><h4>  What's new </h4><br>  After the publication of the first version of the application, we received a large number of reviews.  By putting together the wishes of users and our own ideas, we began work on the second version.  After two months of hard work, the updated <a href="http://bit.ly/1cgVeXX">Children's Launcher</a> and <a href="http://bit.ly/16zwjHe">Parental Control</a> applications are available for download on Google Play. <a name="habracut"></a><br><br><h5>  Six-digit pin </h5><br>  Pleasantly surprised by young users of the application, who easily picked up a PIN code.  I had to increase it to 6 characters. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  The ability to change the wallpaper </h5><br>  One of the most frequent requests was to include the ability to change the wallpaper.  We went a little further and decided to provide this opportunity not only to parents, but also to children - now we can make the child install the wallpaper himself.  If necessary, this option is disabled. <br><br><h5>  Schedule, weekdays and weekends </h5><br>  What if a child plays at night or during lessons?  How to set the time limits so that you can play longer on Sunday than on Monday?  Obviously, an extended time limit setting is required with creating your own schedule. <br>  In the new version, you can set the time period when you can run an application or category of applications.  For example: applications of the ‚ÄúGames‚Äù category can be run from 15:00 to 20:00. <br><br>  It also became possible to set time limits for weekdays and weekends separately, and the user himself determines which days of the week are weekends: Saturday and Sunday, or only Sunday, or some other days. <br><br>  In addition to individual applications and categories, you can configure time limits for the entire device.  For example: the device can be started on weekdays from 3:00 pm to 8:00 pm, the allowed working time is 2 hours;  on weekends - from 13:00 to 21:00, the allowed working time is 4 hours.  In this case, the allowed running time is the cumulative running time of any applications.  Upon expiration of the allowed time of work, or outside the permitted time interval, it is prohibited to launch any applications, except for calls and SMS. <br><br>  This feature is only available with a premium account. <br><br><h5>  The history of the child </h5><br>  If before it was possible to see the current location of the child, now the application shows the history of movements in the last 12 hours.  As before, the coordinates are updated every 15 minutes, the point is fixed on the map.  Information about the movements of the child can be useful even without using the Parental Control application ‚Äî for example, parents can take the child‚Äôs device in the ‚ÄúTracking‚Äù section to see where and at what time it was located. <br><br>  This feature is also premium.  Tracking the current location of the child is still free. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a8/d72/4fc/4a8d724fc95f99e166655060c557debc.png"><br><br><h4>  Premium subscription </h4><br>  To monetize the application, we decided to use a premium account that opens functions that are inaccessible to the simple user.  Premium functionality purchased through subscriptions in Google Play In-App Billing.  Consider briefly what constitutes a subscription, and what are its limitations. <br><br><h5>  Introduction </h5><br>  When a subscription is made, the user periodically deducts a certain amount of money - the price of the subscription.  It is limited to a minimum price of 30 rubles and a maximum of 6,000 rubles and the same size in dollar terms.  Google allows you to set only 2 types of frequency: monthly subscription and annual.  It is possible to add a trial period from 7 to 999 days.  As for the cancellation of the subscription, the user can cancel it at any time, but the money for the current period will not be returned to him.  After canceling the subscription, the user can use all the premium features until the end of the paid period.  When you delete an application with a subscription, the subscription is not canceled, but Google Play notifies you that the application was deleted, but you will still be withdrawing money until you cancel the subscription. <br><br><h5>  Single premium for different applications </h5><br>  In our case, the standard subscription option offered by Google is not enough, because we have two applications, and when buying a premium in one of them, it should appear in the second.  In addition, children tend not to be in a single copy, and the user may have several children's devices on which the Children's Launcher is installed.  In this case, the premium should be included on all children's devices at once.  It binds all these devices to each other Google account, respectively, the premium must be tied to the account under which the user is authorized in the application. <br><br>  Another criterion for developing a mechanism for buying a premium was the ability to give users premiums for free (for advertising purposes or for helping to create and develop a project).  Now, when launching a new version, we want to distribute a premium to some of our users who helped to identify bugs. <br><br><h5>  Implementation </h5><br>  To purchase a subscription on a client, we used classes from TrivialDrive.  TrivialDrive is a <s>classic in-app mobile</s> sample <s>application</s> that comes with the Google Play Billing Library.  We will not describe in detail how and what to do for in-app purchases, but the part we touch will be in terms of utility classes from TrivialDrive. <br><br><h6>  Authorization check </h6><br>  The first time we check if the premium is active during authorization, and if it is active and its time has not expired, then we turn on the premium functionality on the client.  This is the easiest option. <br><br><h6>  Buying a Premium Subscription </h6><br>  Another option is that the user does not have a premium when authorizing. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f8/4ac/e72/7f84ace7213aeeb3da06227d43e5ddeb.png"><br><br>  Step 1. <br>  When you click on the ‚ÄúBuy Premium‚Äù button, a request is sent to the server to find out if the premium was purchased on another device of the same user.  If the premium was purchased earlier and has not ended, turn on the premium functionality on the client. <br><br>  Step 2. <br>  If the premium was not purchased, then start the process of buying a subscription through IabHelper.launchPurchaseFlow.  In addition to other parameters, payload is passed to the function.  Payload is a string defined by the developer and uniquely associating the user with this purchase.  We pass the user account name to this parameter. <br><br>  Then google services take over the management and upon completion of the purchase, successful or not, our callback causes.  Now we will consider a lucky coincidence of circumstances when the user has not bought a premium before and no errors have occurred.  In this case, the Purchase object is returned to the callback, which contains the required fields: payload, purchaseTime, productId, orderId, and purchaseToken.  All this data, as well as the device ID, we send to the server part (Step 3) to verify the purchase. <br><br>  Step 3. <br>  The server, represented by Parse, uses the Google Play Developer API to get data about the subscription just purchased.  To use the Google Play Developer API, you need to create an application in the Google Cloud Console, enable the Google Play Developer API and get an access_token (which, unfortunately, is not permanent, but more on that later).  You can find out the subscription information by sending a GET request to the https address of the form: " <a href="https://www.googleapis.com/androidpublisher/v1/applications/">www.googleapis.com/androidpublisher/v1/applications</a> {packageName} / subscriptions / {productId} / purchases / {purchaseToken}? AccessToken = {accessToken}" <br>  In response, JSON comes with information about the dates of the beginning and end of the subscription, as well as whether the subscription will automatically last when the time runs out (apparently, if the user canceled the subscription or not - we did not need this field).  Documentation for requests is small, because there is nothing special to write there - <a href="https://developers.google.com/android-publisher/v1/purchases">developers.google.com/android-publisher/v1/purchases</a> <br><br>  If the API returns the correct data and the end time of the subscription is more than the current time, then the user paid for the premium, and we can enable it with premium functionality.  We only need to remember the subscription end time to know when to check the subscription next time. <br><br>  Step 4. <br>  Subscription information is returned to the device.  We consider the situation when no problems arise, and the user actually bought the subscription, and its validity period could not end, i.e.  The client receives data about the activated premium account and the expiry date. <br><br>  You can use the Children's Launcher in offline mode, which means you need to be able to verify a premium account without the Internet.  To do this, we store data about the premium account (expiration date, subscription ID, etc.) locally in the SharedPreference in an encrypted form.  Check the status of the premium account every time you enter parent mode.  If there is Internet, then after a successful local verification, we ask Parse for confirmation;  If Parse confirms a premium account, then we overwrite the local data (it is possible that the subscription end time has been updated).  If there is no connection to the network, then we do nothing and consider premium as active, because  local verification confirms the purchase of a premium account.  The fact of renewing a subscription without connecting to the network cannot be verified, therefore, even if the locally stored subscription time has expired, the premium account remains activated. <br><br><h6>  Possible situations </h6><br><img src="https://habrastorage.org/getpro/habr/post_images/fc3/e8e/130/fc3e8e1302f82a863178343a3da33bc9.png"><br><br>  Update token. <br>  The third step uses the application in the Google Cloud Console with the included Google Play Developer API.  About creating an application and getting tokens (access_token and refresh_token) you can read here - <a href="https://developers.google.com/android-publisher/authorization">developers.google.com/android-publisher/authorization</a> .  Let me just say that access_token is used for all API calls, but it is not eternal and dies pretty quickly.  As soon as the access_token time expires, the API will return a 401 error, and using refresh_token we will be able to get a new access_token.  Those.  step 3 may take a bit of a stretch if the access_token expires. <br><br>  Premium subscription renewal. <br>  At the stage of authorization or at the stage of checking the premium, a situation may arise that the user activated the premium earlier, but the subscription end time saved on the server has passed;  in this case, the server again calls on the Google Play Developer API to obtain new subscription data ‚Äî see if the subscription has been extended or not.  If the subscription is extended, the server overwrites the subscription‚Äôs expiration time and sends it to the device.  If the subscription is canceled, the server also reports this to the device, and the device overwrites the subscription information in the SharedPreference. <br><br>  Subscription already purchased. <br>  At the stage of buying a subscription, it may arise that the user has already purchased this subscription.  Tell us about this Google Services through a callback passed to the IabHelper.launchPurchaseFlow function.  An error with the code BILLING_RESPONSE_RESULT_ITEM_ALREADY_OWNED will return to this callback, in which case you will need to contact Google Services again for a list of all purchased internal purchases / subscriptions.  This is done through the IabHelper.queryInventoryAsync function, to which the next callback is passed.  From the received list of all made purchases (Inventory) we get the subscription we need by the identifier and we look at its payload;  if the payload does not match the current user‚Äôs account (and there should not be any other situations, if our mechanism works correctly), then we inform the user that the subscription has already been purchased from him, but for a different account.  If, however, the payload coincides with the current user account (no, well, what if?), Then in the google service we perform all the same actions as with a regular purchase, but with Purchase, which had previously returned to the callback. <br><br><h4>  What's next </h4><br><ul><li>  Intervals of rest. </li><li>  Create your own application categories. </li><li>  Filter incoming, outgoing calls and SMS. </li></ul><br>  Further more.  We are waiting for your comments and suggestions.  Thank. <br><br>  PS Article is written in conjunction with belozerow <a href="http://habrahabr.ru/users/belozerow/" class="user_link">habraiser</a> </div><p>Source: <a href="https://habr.com/ru/post/203116/">https://habr.com/ru/post/203116/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203100/index.html">Selling design online store. Part 1. Analytics</a></li>
<li><a href="../203106/index.html">Clear, bold and affordable. Highscreen Alpha R Review</a></li>
<li><a href="../203108/index.html">[Product Overview] Monitoring Infrastructure Changes with Netwrix Auditor 5.0</a></li>
<li><a href="../203110/index.html">Photoshop CC + Lightroom 5 for 299 rubles a month: be careful and careful</a></li>
<li><a href="../203112/index.html">We invite developers to visit!</a></li>
<li><a href="../203120/index.html">Quantcast File System and its small overview</a></li>
<li><a href="../203122/index.html">Vulnerable SCADA-system could make world leaders languish in traffic jams</a></li>
<li><a href="../203124/index.html">Alternative controller for robots</a></li>
<li><a href="../203126/index.html">Netwrix Auditor: we know what you did last night</a></li>
<li><a href="../203134/index.html">Updates to the Nokia Imaging SDK and Nokia Music API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>