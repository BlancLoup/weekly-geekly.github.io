<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Auto Photo Studio, Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A year and a half ago, I was browsing the blog of one of the successful Russian portrait photographers with a recognizable style, and a thought crept ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Auto Photo Studio, Part 1</h1><div class="post__text post__text-html js-mediator-article"><p>  A year and a half ago, I was browsing the blog of one of the successful Russian portrait photographers with a recognizable style, and a thought crept into my head, so why not just put the camera on a tripod, put a light in the studio once, set all the camera settings and do automatic processing of photos with a given profile?  Photos in the blog were great, but very similar to each other. </p><br><p><img src="https://habrastorage.org/webt/0r/bv/dr/0rbvdr3qqwzvlftmkcttiqlrf7q.jpeg"></p><a name="habracut"></a><br><p>  Since I relate to people who do not know how to take pictures on the phone and love cameras, I really liked the idea.  Yes, I saw all kinds of photo booths and photo stands, but the developers of these devices did not even master making normal colors.  I decided that this was due to the fact that the developers did not understand the photos. </p><br><p>  So that this idea does not happen the same as with the others (which did not budge or stalled at the initial stage).  I decided that the most important thing is to make everything work as a whole, and not to polish to any one separate component.  And since I have very little time to develop, after the main full-time work, the forces remain for 1-2 hours maximum, and a little more on weekends, you should try not to learn anything new, to maximize the use of existing knowledge. </p><br><p>  I want to tell in this article what problems I had on the way and how I solved them. </p><br><p>  A small explanation of the conditions of shooting and equipment: I considered only cameras with an APS-C matrix minimum and professional studio flashes, this is the only way to ensure high quality of images at any time of the day or night. </p><br><h1 id="vse-lyudi-raznogo-rosta">  All people of different heights </h1><br><p>  The first thing I was surprised to find when I put the camera on a tripod is that it‚Äôs not so easy to get into the frame and even so that there is a good composition.  When you move from the camera and to it, then the whole composition also deteriorates, if you put it correctly for a particular person standing at a certain point.  Yes, you can put a chair and say that you need to sit on a chair, but it will not be very interesting.  You can still crop the photos, but then the quality will deteriorate.  Well, the last way I chose was to make the camera automatically steer. </p><br><p>  There are also 2 options.  The correct one is that the optical axis is always horizontal, the camera is shifted up and down and more simple to implement is to adjust the position of the camera by tilting.  In this case, there will be perspective distortions, but they are quite well corrected during processing if you memorize the angle of inclination of the camera. </p><br><p>  Since I practically had no experience in manufacturing any iron devices, I tried to find something as ready as possible for use.  I found several devices for panoramic shooting in the range of $ 1000, all allowed to manually control the bends and turns, as well as automatically shoot panoramas.  But they could not be controlled from the computer.  There are also quite a few devices for controlling video cameras, for shooting from camera cranes, for example.  Good devices that have hints of digital control are very expensive, and it‚Äôs completely unclear if there is any accessible API.  In the end, I found this device on a popular site: </p><br><p><img src="https://habrastorage.org/webt/m2/if/bo/m2ifboapdgi7iill_bsxkjnefr4.jpeg"></p><br><p>  There is nothing from electronics.  A year ago, only the version with collector engines (with integrated gearboxes) was available, and I bought it.  It was necessary to somehow manage this thing from the computer.  At the forum of our institute suggested that the most affordable way - is to use the Arduino.  So I did.  I bought another motor shield, since the engines there are powered by 12 volts.  After I tried to turn it on, I felt all the pain that collector engines could cause a person ‚Äî not only could they not be turned to a given angle, it was also not easy to just ‚Äúturn a little‚Äù.  My first thought was to put a stepping motor there.  I have been looking for a stepping motor for a very long time, which will fit into this platform instead of the one that was standing there, but I did not find it.  Then he began to think over how to screw the servo there, even bought it, but also could not think of anything reliable.  The next thought was to fasten an accelerometer to the platform and gradually rotate the platform to a predetermined angle.  I screwed up the accelerometer with a gyroscope and a compass, but it was very buggy and I also refused this idea (a month later I realized that the Chinese power supply for the camera, which was not weak, was to blame for the accelerometer glitches).  And then I accidentally read how the servo is arranged.  I liked the idea of ‚Äã‚Äãfastening a resistor to measure the angle, but I had to somehow connect it with a pulley.  I had to learn FreeCAD and for the first time in my life use the 3D printing service.  In short, after processing with a file, everything was collected. </p><br><p><img src="https://habrastorage.org/webt/ty/a7/qm/tya7qme2ubxtwlvhvwqefkfcpbw.jpeg"></p><br><p>  With the program for arduino to install a given angle had to torment, since the camera on the platform has a large moment of inertia and it does not immediately stop.  But in the end it turned out to set the angle with an accuracy of about 1 degree. </p><br><p>  Now, about automatic guidance - the idea is simple to make the face at the top of the frame.  So you just need to find a face on each picture from liveview and adjust the platform.  I didn‚Äôt know anything about the definition of faces then, so I used the tutorial method using the Haar signs (haar cascades).  I found out that this method does not work for individuals.  It finds a bunch of garbage on each frame in addition to what it needs and consumes a lot of CPU time.  Then I found another example of how to use neural networks through OpenCV.  Neural networks work just fine!  But I was happy until I started processing photos in parallel.  And Linux somehow became ill between the platform management thread and the photo processing processes to allocate processor time.  I took the path of least resistance - began to make the definition of persons on a video card.  Everything began to work fine. </p><br><p>  Despite the fact that I didn‚Äôt want to go into details, I still did a little test.  And I also bought Intel Neural Compute Stick 2 - I tried to count on it instead of a video card.  The results I have about (figures - processing time of one image size of 800x533) - </p><br><ul><li>  Core i5 9400F - 59 </li><li>  Core i7 7500U - 108 </li><li>  Core i7 3770 - 110 </li><li>  GeForce GTX 1060 6Gb - 154 </li><li>  GeForce GTX 1050 2Gb - 199 </li><li>  Core i7 3770, ubuntu 18.04 with opencv from OpenVINO - 67 </li><li>  Intel Neural Compute Stick 2, ubuntu 18.04 with opencv from OpenVINO - 349 </li></ul><br><p>  It turned out that it is enough to process images with a size of 300 on the smaller side, so that the face of a person standing tall in a frame would be reliably located.  On such images works faster.  Now I am using GeForce GTX 1050. I am sure that it can be greatly improved, but now there is a much more serious problem. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/780ZNws3xek" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h1 id="ekspoziciya">  Exposition </h1><br><p>  It is no secret that the photo must be properly exposed.  In my case, this is even more important, since there is no retouching.  To skin defects were less noticeable, the photo should be as bright as possible, on the verge of overexposure, but without overexposure. </p><br><p>  The brightness of the final flash image depends on the following parameters: </p><br><ul><li>  Flash power </li><li>  The distance from the flash to the subject </li><li>  Diaphragm </li><li>  ISO value </li><li>  Parameters when converting from RAW </li></ul><br><p>  After the frame is taken, we can only change the last parameter.  But to change it over wide limits is not very good, since with a large positive correction of the exposure of a dark frame there will be noise, and in the opposite case there can be clipping in light areas. </p><br><p>  TTL (Through The Lens) is used to automatically determine the exposure during flash photography.  Works as follows: </p><br><ol><li>  The flash makes a series of small flashes. </li><li>  At this time, the camera measures the exposure, focuses and measures the distance to the object of focus. </li><li>  Based on this data, it calculates the required flash output. </li><li>  The flash fires again, and at this time the shutter opens, a picture is taken. </li></ol><br><p> This system works great when it is possible to manually correct images after shooting.  But to get the finished result, it works unsatisfactory.  If that - tried Profoto flashes for&gt; 100t.r. </p><br><p>  I have known conditions, flashes should always be in one place.  So you can simply calculate the exposure on the position of man in space.  There is a problem - how to determine the position of a person? </p><br><p>  The first idea was simply to take the distance to the focusing object from EXIF ‚Äã‚Äãand for the first frame to make a large exposure compensation in the equalizer and for the next one to adjust the flash power or aperture.  It is very likely that a person will take a lot of frames, standing in one place.  But it turned out that the distance in EXIF ‚Äã‚Äãis written strongly discretely, the farther the object - the more step.  Moreover, for different lenses the distance to the object takes different sets of values, and some do not measure it at all. </p><br><p>  The next idea is to use an ultrasonic rangefinder.  This device measures the distance fairly accurately, but only up to a meter and only if the person is not wearing something that absorbs sound waves.  If you put a range finder on a servo and twist it like a radar, it becomes a little better - it measures already up to 1.5 meters, which is also very small (people are best obtained if you shoot them from a distance of 2 meters). </p><br><p>  Of course, I knew that even inexpensive phones already build depth maps and blur the background selectively.  But so did not want to get involved in it.  Unfortunately, there is no choice left.  At first I wanted to buy 2 webcams, merge them and read the displacement map using OpenCV.  But, fortunately, I found many depth cameras that already do this within themselves.  I chose Intel D435 (if someone wants to buy one, it is not supported in Linux in the main branch of the kernel. There are patches for debian and ubuntu in the librealsense repository. For fedora I had to edit them). </p><br><p><img src="https://habrastorage.org/webt/vn/aj/us/vnajusrbvur1soilielzggtbfnk.jpeg"></p><br><p>  Once everything is connected, I wrote a test program that measures the distance to a small square in the center.  So this code still works.  And it works pretty well.  Of course, it is necessary to search for a face in the picture from the RGB camera and calculate the distance from the flash to this face.  But these are plans for the future. </p><br><p>  According to the position of the person in space, it is necessary to calculate the correction to the exposure.  First, I came up with some kind of formula that worked only for a point source of light in a vacuum (in fact, it was the absence of reflective walls and ceilings that mattered).  But then I just made a series of shots with a constant flash output and corrected the exposure by eye in the equalizer converter, it turned out that the correction almost linearly depends on the distance.  I use the Rembrandt lighting scheme, the flash with the softbox is in the plane of the camera. </p><br><p>  But with the correction of the exposure is also something to do.  Ideally, I need to change the flash power, but as long as my aperture and additives are changing &lt;1 / 6Ev - in a RAV converter.  The synchronizer of my flashes can be controlled via bluetooth using a phone application.  So in the future I plan to figure out how the protocol works there and change the power of the flashes. </p><br><p>  Here is a comparison of constant flash power with TTL and my method.  TTL works much more stable and more precisely: </p><br><p><img src="https://habrastorage.org/webt/xu/bm/zx/xubmzxg6khtlsatd5h89el3ntv0.jpeg"></p><br><h1 id="raznoobrazie">  Diversity </h1><br><p>  When a girl (or even a guy) comes to a photo session with a photographer, she (or he) usually wants a photo of a different plan, larger, where there is only a face and more general - in full growth or waist-high.  Not everyone knows, but the plan best of all changes by changing the focal length of the lens.  That is, a person always stands at a distance of say 2 meters, if we need to shoot to full height - we wind a 35mm lens, if only the face is 135mm, and if it is waist-deep, then 50mm or 85mm.  Well, or do not change lenses and set the lens with a zoom.  To offer the user to rotate the zoom on the camera, which is on a mobile platform, breaking through a bundle of wires - sounds like something not very good.  So I bought a pack of spare parts for aliexpress, picked up a servo which was not useful to me to control the platform and did this: </p><br><p><img src="https://habrastorage.org/webt/aw/3v/9b/aw3v9bi7wh77k2vzpxrwoaz8fh4.jpeg"></p><br><p>  And this is how it works: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/oNCFHLUPTYo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  The results of the first test in the photo studio, first of all I wanted to see how diverse it would be to take pictures, did not move anything and did not reconfigure during the shooting: </p><br><p><img src="https://habrastorage.org/webt/cw/bf/6f/cwbf6fwso80_qlfou26tit5gkaa.jpeg"></p><br><p>  Process video: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/YzeVP0ef4ag" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h1 id="rezultat">  Result </h1><br><p>  Here are some of the best shots that you can do: </p><br><p><img src="https://habrastorage.org/webt/dm/rj/74/dmrj74690z5rd7gjpkkwbdnvngu.jpeg"><br>  <em>like everyone asked permission to publish, if you know yourself and want to remove the photo - write me</em> </p><br><p>  Why did I do this?  This is a thing that has not yet been, at least I have not found anything like it.  Potentially useful - now there are a lot of specialists, such as psychologists, business coaches, sports coaches, hairdressers sell their services through blogs, they need a lot of photos, and exactly in the form they want, and not the photographer.  Some people simply don‚Äôt like being seen by a stranger (photographer) when shooting.  Well, the simplest is great entertainment for corporate events, exhibitions and other events. </p><br><p>  I did not describe the software part, how the photos are processed and about user interaction, since there is already so much text, I will write the second part later.  These moments are already pretty well worked out so that the system can be used by people not familiar with programming. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/460605/">https://habr.com/ru/post/460605/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460591/index.html">Getting root on the router Tenda Nova MW6</a></li>
<li><a href="../460593/index.html">"Universal" in the development team: good or harm?</a></li>
<li><a href="../460599/index.html">News from the world of OpenStreetMap ‚Ññ 468 (07/02/2019-08.07.2019)</a></li>
<li><a href="../4606/index.html">Mozilla started creating Firefox 3.0</a></li>
<li><a href="../46060/index.html">Netbook - the most popular gift for the New Year</a></li>
<li><a href="../460607/index.html">App Store with hacking tools from Offensive Security on Android</a></li>
<li><a href="../46061/index.html">Terrorism can stop the growth of the Indian economy</a></li>
<li><a href="../460611/index.html">Failover: perfectionism is ruining us and ... laziness</a></li>
<li><a href="../460615/index.html">In the wake of Industrial Ninja: how PLCs were cracked at Positive Hack Days 9</a></li>
<li><a href="../46062/index.html">Startup: "Startup Cemetery"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>