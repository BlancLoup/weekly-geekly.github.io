<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>UE4 | Inventory for multiplayer # 5 | Information transfer between Server and Client</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="List of articles 

 UE4 | Inventory for Multiplayer # 1 | Data Store on DataAsset 
 UE4 | Inventory for Multiplayer # 2 | Connect Blueprint to C ++ 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>UE4 | Inventory for multiplayer # 5 | Information transfer between Server and Client</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">List of articles</b> <div class="spoiler_text"><p>  <a href="https://habr.com/post/418913/">UE4 |</a>  <a href="https://habr.com/post/418913/">Inventory for Multiplayer # 1 |</a>  <a href="https://habr.com/post/418913/">Data Store on DataAsset</a> <br>  <a href="https://habr.com/post/418951/">UE4 |</a>  <a href="https://habr.com/post/418951/">Inventory for Multiplayer # 2 |</a>  <a href="https://habr.com/post/418951/">Connect Blueprint to C ++</a> <br>  <a href="https://habr.com/post/419347/">UE4 |</a>  <a href="https://habr.com/post/419347/">Inventory for Multiplayer # 3 |</a>  <a href="https://habr.com/post/419347/">Interaction structure</a> <br>  <a href="https://habr.com/post/420115/">UE4 |</a>  <a href="https://habr.com/post/420115/">Inventory for Multiplayer # 4 |</a>  <a href="https://habr.com/post/420115/">Creating and connecting a container</a> <br>  <a href="https://habr.com/post/420233/">UE4 |</a>  <a href="https://habr.com/post/420233/">Inventory for multiplayer # 5 |</a>  <a href="https://habr.com/post/420233/">Information transfer between Server and Client</a> </p></div></div><br><p><img src="https://habrastorage.org/webt/_m/wk/ww/_mwkwwvinzy5kttn72wk519pddc.jpeg" title="UE4 logo" align="left">  In this article we will look at the data transfer between the Server and Client in the <strong><em>Unreal Engine 4</em></strong> implemented in <em>C ++</em> .  At the very beginning, for a person who does not have a profile education, this seems to be something incomprehensibly difficult.  Despite the large number of examples and analyzes, I personally found it very difficult to put together a complete picture of this process.  But, when the critical amount of information obtained from reading and tests made was reached, it came to an understanding of how this all works. <a name="habracut"></a></p><br><hr><br><p>  First of all, you need to clearly understand that all objects in the game (with rare exceptions) may have several copies.  The original object is located on the server.  The original is always there.  Copies can exist on Clients, but not necessarily, i.e.  they may not be.  All significant events occur on the Server, and it is he who decides who needs to know about it, and who does not. </p><table><tbody><tr><td>  Everything that happens on the Client is not known to anyone except the Client. </td></tr></tbody></table><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><p>  We start the game with two clients.  On stage cube. The original of this cube is located on the server.  He is the most important.  The first copy will be on the first Client, and the second - on the second Client.  If we do something with a copy of the object on any of their clients, the original <em>will not suffer</em> .  The change will be strictly local, only for this Client.  If you change the original, then there are 2 main scenarios: </p><br><ol><li>  Copies of clients will remain unchanged. </li><li>  Copies of clients will be synchronized with the original. </li></ol></div></div><br><hr><br><p>  Now that the basic rules of the game are clear, we can consider which options for transferring information between the Server and the Client are available to us.  I know 3 ways, but we will consider only the first two, because  the third allows you to transfer anything at all and anywhere, and applies only if you have rested against the limitations of the first two. </p><br><ol><li>  Replication </li><li>  RPC ( <em>Remote Procedure Calls</em> ). </li><li>  TCP. <br><hr><br><h4 id="replikaciya">  Replication </h4></li></ol><br><p>  The first thing is to unconditionally accept: </p><table><tbody><tr><td>  Replication is a one-way road, and works only from Server to Client. </td></tr></tbody></table>  The second thing you need to know: <table><tbody><tr><td>  Only objects or class variables can be replicated. </td></tr></tbody></table>  And third, an important condition: <table><tbody><tr><td>  Replication occurs only when a change has occurred on the server. </td></tr></tbody></table><br>  If in <em>Blueprint</em> we just put checkmarks in the right places, then <em>C ++</em> is not much more complicated.  The main <em>thing is</em> not to forget to connect <em>#include "UnrealNetwork.h"</em> . <br><p>  First consider the replication of objects. <br>  In the constructor we write: </p><br><pre><code class="cpp hljs">bReplicates = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre> <br><p>  If you want to replicate the movement: </p><br><pre> <code class="cpp hljs">bReplicateMovement = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre> <br><p>  If you need to replicate the connected component: </p><br><pre> <code class="cpp hljs">Component-&gt;SetReplicates(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre> <br><p>  A full description can be found <a href="https://wiki.unrealengine.com/Replication">here</a> . </p><br><p>  With variable replication, things are a little more interesting. <br>  Let's start with the header file <em>.h</em> . <br>  You can simply replicate the variable: </p><br><pre> <code class="cpp hljs">UPROPERTY(Replicated) <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> bMyReplicatedVariable;</code> </pre> <br><p>  And you can run any function on the side of the Client, if the variable has been replicated.  It doesn't matter what kind of value the variable took.  What is important is the fact of its change. </p><br><pre> <code class="cpp hljs">UPROPERTY(ReplicatedUsing = OnRep_MySomeFunction) TArray&lt;<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>&gt; MyReplicatedArray; UFUNCTION() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnRep_MySomeFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br><p>  The launch of the function is nothing more than one of the ways to send commands from the Server.  It is very important to know that the replication of arrays does not occur entirely, but only the changed part.  Thus, using just one variable, you can transfer multiple commands from the server, parsing the array into elements, and elements into bits. </p><br><p>  We now turn to <em>.cpp</em> <br>  We register replication conditions: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AMySuperActor::GetLifetimeReplicatedProps(TArray&lt;FLifetimeProperty&gt;&amp; OutLifetimeProps) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Super::GetLifetimeReplicatedProps(OutLifetimeProps); DOREPLIFETIME(AMySuperActor, bMyReplicatedVariable); DOREPLIFETIME_CONDITION(AMySuperActor, MyReplicatedArray, COND_OwnerOnly); }</code> </pre> <br><p>  The first <em>bMyReplicatedVariable</em> variable was replicated without any condition to all Clients at once, whereas the second, <em>MyReplicatedArray</em> , was updated only for the Client of the owner of the <em>AMySuperActor</em> object, if, of course, it was announced. </p><br><p>  A full list of possible conditions can be found <a href="https://api.unrealengine.com/INT/API/Runtime/CoreUObject/UObject/ELifetimeCondition/index.html">here</a> . </p><br><hr><br><h4 id="rpc-remote-procedure-calls">  RPC ( <em>Remote Procedure Calls</em> ) </h4><br><p>  <a href="https://docs.unrealengine.com/en-us/Gameplay/Networking/Actors/RPCs">This method</a> of data transfer, in contrast to replication, works both ways, but is more expensive.  To use it, you just need to include <em>#include "UnrealNetwork.h"</em> . </p><table><tbody><tr><td>  An important feature is that the <strong><em>RPC</em></strong> method can transfer variables. </td></tr></tbody></table>  First you need to say that RPCs come with confirmation of receipt of the <em>package</em> <em>Reliable</em> and without such <em>Unreliable</em> .  If in the first case the Sender does not calm down until he is convinced that the package has been delivered (and will send it again and again, if there is no response news), then in the second, the Sender doesn‚Äôt care if someone received his package or not.  Sent and forgot. <br>  Where it is possible - we use <em>Unreliable</em> .  Usually this method is suitable for not very important information, or for frequently updated data.  Where it is impossible, in the case of sending from the Server to the Client, we try to do replication with the function call, as shown above. <br><p>  So, to send our parcel from the Client to the Server, you need to register three functions: </p><br><pre> <code class="cpp hljs">UFUNCTION(Reliable, Server, WithValidation) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServerTestFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MyVariable)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServerTestFunction_Implementation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MyVariable)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServerTestFunction_Validate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MyVariable)</span></span></span></span>;</code> </pre> <br><p>  <strong><em>Reliable</em></strong> - parcel with confirmation of receipt. <br>  <strong><em>Server</em></strong> - sending from Client to Server. <br>  <strong><em>WithValidation</em></strong> - the parcel is opened by the recipient only under the conditions described in the <em>bool ServerTestFunction_Validate (float MyVariable) function</em> .  That is, if the function returns <em>true</em> .  This parameter is required only for functions that run on the Server. <br>  <strong><em>ServerTestFunction (float MyVariable)</em></strong> - this function is called by the client, if it wants, to send something to the server.  In general, it is not even required to describe it in <em>.cpp</em> . <br>  <strong><em>ServerTestFunction_Implementation (float MyVariable)</em></strong> - this function will be called directly on the Server only if ... <br>  <strong><em>ServerTestFunction_Validate (float MyVariable)</em></strong> - this function is executed on the Server, and if <em>true is</em> returned, <em>ServerTestFunction_Implementation (float MyVariable)</em> will be called. </p><br><p>  To send a parcel from the Server to the Client, if we are absolutely not satisfied with the use of replication, in fact only the <em>Server</em> changes to the <em>Client</em> : </p><br><pre> <code class="cpp hljs">UFUNCTION(Reliable, Client, WithValidation)</code> </pre> <br><p>  Names of functions, in principle, can be any, but usually they should reflect exactly where the package is going.  For our convenience. </p><br><pre> <code class="cpp hljs">UFUNCTION(Reliable, Client, WithValidation) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClientTestFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MyVariable)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClientTestFunction_Implementation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MyVariable)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClientTestFunction_Validate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MyVariable)</span></span></span></span>;</code> </pre> <br><p>  Otherwise, it works in the same way as in the previous example, taking into account the fact that this time the package goes from the Server to the Client. </p><br><p>  There is another option to send from the Server, when the package goes to all clients at once. </p><br><pre> <code class="cpp hljs">UFUNCTION(Reliable, NetMulticast, WithValidation) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NetMulticastTestFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NetMulticastTestFunction_Implementation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NetMulticastTestFunction_Validate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br><p>  Do not abuse this option.  Think, perhaps you will manage replication. </p><table><tbody><tr><td>  For <strong><em>Client</em></strong> and <strong><em>NetMulticast,</em></strong> validation is optional </td></tr></tbody></table><br><hr><br><div class="spoiler">  <b class="spoiler_title">An example of a request to the server</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/*       ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ADreampaxActor::DoSomethingWithOtherActor(ADreampaxOtherActor * SomeOtherActor) { <span class="hljs-comment"><span class="hljs-comment">/*  ,      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Role &lt; ROLE_Authority) { <span class="hljs-comment"><span class="hljs-comment">/*    ,    ,      */</span></span> ServerDoSomethingWithOtherActor(SomeOtherActor); <span class="hljs-comment"><span class="hljs-comment">/*   ,        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*         */</span></span> SomeOtherActor-&gt;Destroy(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/*      ,    ServerDoSomethingWithOtherActor(SomeOtherActor)     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ADreampaxCharacter::ServerDoSomethingWithOtherActor_Implementation(ADreampaxOtherActor * SomeOtherActor) { <span class="hljs-comment"><span class="hljs-comment">/*   ,       */</span></span> DoSomethingWithOtherActor(SomeOtherActor); } <span class="hljs-comment"><span class="hljs-comment">/*     ,    ServerDoSomethingWithOtherActor_Implementation(ADreampaxOtherActor * SomeOtherActor) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> ADreampaxCharacter::ServerDoSomethingWithOtherActor_Validate(ADreampaxOtherActor * SomeOtherActor) { <span class="hljs-comment"><span class="hljs-comment">/*      true,   ,   -    fasle.       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> </div></div><br><p>  And finally, a link to the manual, which must be read. <br>  <a href="http://cedric-neukirchen.net/Downloads/Compendium/UE4_Network_Compendium_by_Cedric_eXi_Neukirchen_BW.pdf">'Unreal Engine 4' Network Compendium</a> </p><br><p>  That's all you need to know about communication between the Server and the Client in order to proceed to the next section, where we will register the replication of the inventory and consider how to make changes to it correctly. </p><br><p>  PS If you notice any inaccuracies or errors, please write in the comments. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/420233/">https://habr.com/ru/post/420233/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420221/index.html">Attackers hacked thousands of D-link routers and redirected their owners to malicious resources</a></li>
<li><a href="../420223/index.html">A few simple tips: how to prevent a drone from crashing</a></li>
<li><a href="../420225/index.html">Infinite algorithmic melody based on prime numbers</a></li>
<li><a href="../420227/index.html">Turkish President announced a ban on the import of electronics from the US</a></li>
<li><a href="../420229/index.html">Can children in villages become programmers if they are taught only to railway workers? Talk with "Circle"</a></li>
<li><a href="../420235/index.html">Zenject: How an IoC container can kill Dependency Injection on your project</a></li>
<li><a href="../420237/index.html">Qt wrapper around gRPC framework in C ++</a></li>
<li><a href="../420239/index.html">Mobile development. Swift: the mystery of the protocols</a></li>
<li><a href="../420243/index.html">Breakthrough Philanthropy: Breakthrough projects on a scale of Humanity</a></li>
<li><a href="../420245/index.html">How to prevent memory overruns when using Java collections</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>