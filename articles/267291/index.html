<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Router reservation using VRRP protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We launched a new service: redundancy of the router using the VRRP protocol (abroad it is known as failover IP. As far as we know, nobody in Russia ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Router reservation using VRRP protocol</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/12a/506/d56/12a506d56229ebf7ffc4786899fb4913.png" alt="VRRP" width="100%" height="100%"><br><br>  We launched a new service: redundancy of the router using the VRRP protocol (abroad it is known as failover IP. As far as we know, nobody in Russia has done anything like this before. The service will be interesting first of all for those who would like to ensure constant availability of business -significant Internet resources, but it does not have sufficient technical capabilities for this: it has neither its own autonomous system, nor a block of IP addresses, nor connections to providers via BGP protocol. <br>  On the features of its technical implementation, we describe in detail in this article. <br><a name="habracut"></a><br><br><h2>  Choosing a reservation scheme </h2><br>  Let us imagine that we have an Internet resource, which is critically important for a business, and which should always be accessible to a large number of users.  This resource <a href="http://www.mysite.ru/">www.mysite.ru</a> has an IP address 12.34.56.78, issued by the provider in the block 12.34.56.72/29. <br>  The network resource settings (address, mask, and default gateway) look like this: <br><pre>  ifconfig eth0 address 12.34.56.78 mask 255.255.255.248 gw 12.34.56.73
</pre><br>  If .78 is the address of the host, then .73 is the default gateway address.  This address is the responsibility zone of the operator, and if the host is located in the data center, then the data center responsibility zone.  Graphically, this scheme can be represented as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/a6f/395/0cc/a6f3950ccfa916bef1194df879e92fb6.png" alt="vrrp-1" width="100%" height="100%"><br><br>  On the destination host, the address is 12.34.56.78, on the router - .73, and between them a single L2-domain is organized (as a rule, this is a separate VLAN): <br><br><img src="https://habrastorage.org/files/d74/51e/16a/d7451e16a17842a8bc552a10980b1bea.png" alt="vrrp-2" width="100%" height="100%"><br><br>  To increase the availability of the end host, network infrastructure reservations are required. <br>  For redundancy at the L2 level, in the simplest case, Virtual Chassis / Fabric / MC-LAG is used.  Then the end host connects to the data center network using a LAG (Etherchannel): <br><br><img src="https://habrastorage.org/files/8b2/da4/3f2/8b2da43f256a47b2874853e8fff7370e.png" alt="vrrp-3" width="100%" height="100%"><br><br>  Possible points of failure are the end host itself and the router. <br><br>  Reservation of the final host is the responsibility of the customer.  It is very desirable that the final and backup host be located in different data centers.  This will avoid many problems (with the network structure, with the availability of a specific physical server, with power supply and cooling at individual sites). <br>  You can organize the transfer of an IP address between the main and backup hosts in different ways. Within the same L2 segment, this can be done using the CARP / HSRP / VRRP protocols and their analogues: <br><br><img src="https://habrastorage.org/files/4e1/be4/cda/4e1be4cdaf414eb0a5d43746b28a9377.png" alt="vrrp-4" width="100%" height="100%"><br><br>  A full reservation at the data center level can only be discussed if all service components are reserved and they do not have a single point of failure. <br><br>  The ideal backup scheme can be represented as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2e0/2a5/39d/2e02a539d2c4aa36eb65303b2cfbafbd.png" alt="vrrp-5" width="100%" height="100%"><br><br>  The final and backup customer hosts are located in different data centers.  Routers owned by the operator are also located in different data centers.  Data centers can be connected by several communication channels. <br>  If a malfunction occurs in one of the data centers, the end host will still be available.  The described approach can be used for redundancy in both L2 and L3 schemes. <br><h2>  Router Backup </h2><br>  An example of redundancy at the L3 level is anycast routing and the use of BGP with a higher-level operator.  Each of the hosts announces a 12.34.56.72/29 network with a different priority to the routers of the carrier.  In this case, each host connects to the routers of the carrier by a separate subnet, a separate VLAN: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/29f/4c6/2a9/29f4c62a9e6e502f5ed8c1a61f36e400.png" alt="vrrp-6" width="100%" height="100%"><br><br>  This scheme has the following advantages: <br><ul><li>  It is widely used on the Internet (BGP); </li><li>  scaling is carried out not on two, but on several data centers; </li></ul><br>  It is not without flaws, among which should be called: <br><ul><li>  low speed (default BGP convergence rate - from 1.5 minutes); </li><li>  complexity of setting; </li><li>  the need to allocate separate subnets for connection in each data center. </li></ul><br>  The speed of switching to the backup host can be accelerated if you use not BGP, but another protocol - <a href="http://xgu.ru/wiki/OSPF" rel="nofollow">OSPF</a> or <a href="http://xgu.ru/wiki/IS-IS" rel="nofollow">IS-IS</a> .  The difficulty here lies in the fact that not every telecom operator will make it possible to use these protocols: they usually transfer service data (for example, MPLS tags or service addresses), and there are no full-fledged possibilities for limiting it. <br><br>  When using L2-scheme, the operator organizes a single L2-domain between the primary and backup hosts.  A VXLAN or MPLS tunnel is established between routers: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ac2/741/06a/ac274106a9cd22d7487dfc70defd98f4.png" alt="vrrp-7" width="100%" height="100%"><br><br>  VXLAN / MPLS helps to organize redundancy using multiple communication channels between the provider's routers. <br><br>  The final and backup hosts among themselves use VRRP or its analogs.  Thus, the IP address 12.34.56.78 is on the currently active host (if both hosts are active, then on the configured master host).  The destination host receives an IP address from this network - 12.34.56.77, the backup host receives an address from the same network - 12.34.56.76.  If the hosts are running Windows, then instead of VRRP, you can use NLB clustering. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a4a/c9d/2cd/a4ac9d2cd5991087a6fed6140741646b.png" alt="vrrp-8" width="100%" height="100%"><br><br>  A similar scheme is built by the operator.  Both routers participate in the same VRRP domain and share the default gateway address ‚Äî 12.34.56.73 / 29.  Router 1 is a pre-configured master with a physical IP address of 12.34.56.73, and router 2 is a backup router with a physical address of 12.34.56.74;  The address 12.34.56.73 for it is virtual and active only when the router 1 is unavailable. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/391/1ed/299/3911ed299f3e4579828ac9c7a7260292.png" alt="vrrp-9" width="100%" height="100%"><br><br>  The undoubted advantages of such a scheme are: <br><ul><li>  use of standard protocols (VRRP); </li><li>  simplicity of setup, both from the customer, and from the operator; </li><li>  high speed; </li></ul><br>  There is only one drawback: it is inconvenient to scale the scheme into more than two data centers. <br><h2>  If a malfunction happens: how it works </h2><br>  In a normal situation, both routers and both customer's hosts work.  One of the routers at the stage of constructing the circuit is assigned as the master (master) and responds to the address 12.34.56.73.  The situation is similar with hosts: one of them is the main one and responds to requests to the address 12.34.56.78.  The second router and the second host are redundant. <br><br>  Requests from the Internet go through router 1 and go to the primary end host.  On the routers, there is an ARP entry of 12.34.56.78 with the MAC address 0000: 5E00: 01xx pointing towards the main host.  The primary host responds to hosts on the Internet by routing through Router 1 (default gateway 12.34.56.73 is specified for hosts).  To reduce network latency, the main router is located in the same data center as the main host. <br><br>  What happens when one of the hosts is unavailable?  VRRP on the backup host determines that the primary host stops responding to keep-alive requests, and the backup host is set to the IP address 12.34.56.78: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6c2/412/b5d/6c2412b5d0e49cb523aadabf0ad24eed.png" alt="vrrp-11" width="100%" height="100%"><br><br>  requests from the Internet go to router 1;  in its ARP table, it sees the MAC address corresponding to the IP address 12.34.56.78 from the side of Router 2 and sends traffic to the backup host.  The backup host sends return traffic to the default gateway 12.34.56.73, i.e.  through the router 1. With this scheme, the network delay increases between the hosts on the Internet and the reserved host. <br>  After troubleshooting, the IP address 12.34.56.78 becomes available again on the primary host, and the circuit is operating normally. <br><br>  Similarly, this scheme works in case of a failure of the network infrastructure between the router and the end host: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/528/b39/027/528b3902754d6ff53bde730eb1ba2280.png" alt="vrrp-12" width="100%" height="100%"><br><br>  When the intermediate switch fails, the primary host is still the carrier of the 12.34.56.78 address, but it does not have a network connection to the router and it does not participate in processing requests from the Internet.  The backup host, having lost connectivity with the primary one, becomes responsible for the address 12.34.56.78. <br><br>  If router 1 or the entire data center 1 as a whole becomes unavailable, then the scheme works exclusively through router 2 and the backup host: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3b8/3b1/ded/3b83b1ded95f3f7458922450f97d6679.png" alt="vrrp-13" width="100%" height="100%"><br><br>  After the restoration of infrastructure, the scheme goes into operation in normal mode.  Virtually no faults in the data center 2 do not affect the availability of the end host. <br><br>  This solution allows the installation and maintenance of high-available resources, their full reservation and separation into separate data centers. <br><br><h2>  Conclusion </h2><br><br>  In this article, we looked at network connection reservation technologies using VRRP.  The corresponding service can be ordered in our <a href="https://support.selectel.ru/order/ip/">control panel</a> . <br>  If you have questions, welcome to comments.  Readers who for one reason or another cannot post comments here are invited to our <a href="https://blog.selectel.ru/rezervirovanie-marshrutizatora-s-ispolzovaniem-protokola-vrrp/">blog</a> . </div><p>Source: <a href="https://habr.com/ru/post/267291/">https://habr.com/ru/post/267291/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267277/index.html">How to write test code</a></li>
<li><a href="../267279/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 177 (September 14 - 20, 2015)</a></li>
<li><a href="../267281/index.html">PHP Digest number 70 - interesting news, materials and tools (September 6 - 20, 2015)</a></li>
<li><a href="../267283/index.html">We count working days from Moment.js</a></li>
<li><a href="../267289/index.html">Overview of opportunities for working with Microsoft for startups</a></li>
<li><a href="../267293/index.html">Mikrotik RouterOS + PHP script on the site. Empowerment</a></li>
<li><a href="../267295/index.html">RC5 encryption algorithm and its implementation in python</a></li>
<li><a href="../267297/index.html">Free Firebird large database seminar</a></li>
<li><a href="../267301/index.html">Automate Java EE Testing Web Services with SoapUI and Arquillian</a></li>
<li><a href="../267305/index.html">Modifiers private and private [this] in Scala</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>