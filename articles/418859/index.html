<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Some features of PowerShell when working with user accounts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I thought I was pretty good at powershell, but I never had to work with user credentials. However, now I‚Äôm looking for a job and at one of the intervi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Some features of PowerShell when working with user accounts</h1><div class="post__text post__text-html js-mediator-article">  I thought I was pretty good at powershell, but I never had to work with user credentials.  However, now I‚Äôm looking for a job and at one of the interviews I was given a test task to write a script, which should: <br><br><ol><li>  Check availability and status (enabled / disabled) of user account. </li><li>  Check whether the account is included in the group "Administrators" </li><li>  If there is no account, then create an account and add it to the administrators group, set the flags ‚ÄúPrevent the user from changing the password‚Äù and ‚ÄúThe password does not expire‚Äù </li><li>  If the account exists, but is disabled or not in the ‚ÄúAdministrators‚Äù group, then enable the account and add it to the ‚ÄúAdministrators‚Äù group, set the ‚ÄúPrevent a user from changing the password‚Äù flags and ‚ÄúThe password will not expire‚Äù </li><li>  The script should not depend on the language of the operating system. </li></ol><br><a name="habracut"></a><br>  I thought that nothing complicated and the first thing I decided to check is the Admin user on my computer.  Without thinking, I hammered the command: <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">User</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span></code> </pre> <br>  And immediately got an error 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <font color="#ff0000"><code>Get-User :  "Get-User"     , ,     .</code></font> <br> <br>  A little taken aback by the fact that such a useful command did not recognize I googled and found that the <b>Get-User</b> command only works in the Powershell console for Exchange.  To work with local users, you must use <b>Get-Localuser</b> , and for domain <b>Get-Aduser</b> .  Realizing my mistake, I hammered: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-Localuser <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span></code> </pre> <br>  And got an answer <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">Name</span></span> Enabled Description <span class="hljs-comment"><span class="hljs-comment">---- ------- ----------- Admin True     /</span></span></code> </pre> <br>  Well, now check whether there is a user or not, it will not be a big deal, however, another trick was waiting for me here.  It was not so easy to do this through the if else conditional operator. <br><br>  The fact is that if the user is in the system, then the output is not true, but a whole data set, with the name, description of the user, whether this account is enabled or not.  And if there is no user, then powershell gives an error.  After wandering through the expanses of the Internet, I found that for these purposes it is better to use the <b>try catch</b> operator. <br><br><pre> <code class="hljs php">$user = <span class="hljs-string"><span class="hljs-string">'admin'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Get-LocalUser $user -ErrorAction Stop | Out-<span class="hljs-keyword"><span class="hljs-keyword">Null</span></span> write-host  $user  -foregroundcolor Green } <span class="hljs-keyword"><span class="hljs-keyword">Catch</span></span> { write-host  $user  -foregroundcolor Red }</code> </pre> <br>  I added the $ user variable to make it easier to change usernames throughout the script.  ErrorAction Stop is required so that the script does not stop at this step due to an error.  Sign |  separates the pipeline steps, and Out-Null will hide the error text output.  I also added a text output with highlighting, for the convenience of checking the script. <br><br>  Next, I wanted to check whether the account is enabled or disabled.  As I said before, the Get-LocalUser command issues a whole set of data and for testing, I only needed to select one parameter Enabled with a value of true or false.  To do this, I used the following command: <br><br><pre> <code class="hljs perl">(Get-LocalUser $user).enabled</code> </pre> <br>  After making sure that it works, I did the following check and added a command to enable the user. <br><br><pre> <code class="hljs perl">$user = <span class="hljs-string"><span class="hljs-string">'admin'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((Get-LocalUser $user).enabled -eq <span class="hljs-string"><span class="hljs-string">"True"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host    -foregroundcolor Green } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host    -foregroundcolor Red Enable-LocalUser $user <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host    -foregroundcolor Green }</code> </pre> <br>  To enable the user, it is naturally necessary to run the console as an administrator. <br><br>  In the second paragraph of the task, it was necessary to determine whether the user is in the group of administrators.  To check for the presence of a user in a particular group, there is a Get-LocalGroupMember command.  However, the name of the administrators group changes with the language of the operating system.  So I had to use the standard SID S-1-5-32-544.  I also made a check through try watch. <br><br><pre> <code class="hljs perl">$user = <span class="hljs-string"><span class="hljs-string">'admin'</span></span> try { Get-LocalGroupMember -SID S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-number"><span class="hljs-number">544</span></span> -Member $user -ErrorAction Stop | Out-Null <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host  $user     -foregroundcolor Green } Catch { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host  $user      -foregroundcolor Red Add-LocalGroupMember -SID S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-number"><span class="hljs-number">544</span></span> -Member $user <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host  $user     -foregroundcolor Green }</code> </pre> <br>  If the user is not in the group, administrators will be added to it. <br>  At the next stage, I had the task to determine whether the user‚Äôs password change setting is disabled or not.  Then I came across another pitfalls.  The fact is that if a user has a password expiration date unlimited, then the PasswordExpires parameter does not display any values.  And if this checkbox is disabled, then different users will have different date of password change.  I came up with a way out of this situation: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((Get-LocalUser $user).PasswordExpires -eq $null) { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host      -foregroundcolor Green } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host     -foregroundcolor Red set-LocalUser $user -PasswordNeverExpires:$true <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host      -foregroundcolor Green }</code> </pre> <br>  Then I needed to create a user.  I did not expect that a trick might be waiting for me here too.  When creating a user team <br><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-<span class="hljs-type"><span class="hljs-type">LocalUser</span></span> -<span class="hljs-type"><span class="hljs-type">User</span></span> $user -password <span class="hljs-type"><span class="hljs-type">P</span></span><span class="hljs-meta"><span class="hljs-meta">@ssW</span></span>0rD!</code> </pre> <br>  An error is returned: <br><br> <font color="#ff0000"><code>    "Password".     "P@ssW0rD!"  "System.String"   "System.Security.SecureString".</code></font> <br> <br>  The fact is that the -password parameter should use SecureString, instead of a plain text string.  For this, I made the $ password variable and converted it to a securestring. <br><br><pre> <code class="hljs perl">$password = convertto-securestring <span class="hljs-string"><span class="hljs-string">"P@ssW0rD!"</span></span> -asplaintext -force</code> </pre> <br>  And the script itself to create a user and add it to the group of administrators <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-LocalUser -User $user -password $password -PasswordNeverExpires:$true -AccountNeverExpires:$true Add-LocalGroupMember -SID S<span class="hljs-number"><span class="hljs-number">-1</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span><span class="hljs-number"><span class="hljs-number">-32</span></span><span class="hljs-number"><span class="hljs-number">-544</span></span> -Member $user</code> </pre> <br>  A ready script that takes into account all the conditions I have turned out this way: <br><br><pre> <code class="hljs perl">$user = <span class="hljs-string"><span class="hljs-string">'admin'</span></span> $password = convertto-securestring <span class="hljs-string"><span class="hljs-string">"P@ssW0rD!"</span></span> -asplaintext -force try { Get-LocalUser $user -ErrorAction Stop | Out-Null cls <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host  $user  -foregroundcolor Green <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((Get-LocalUser $user).enabled -eq <span class="hljs-string"><span class="hljs-string">"True"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host    -foregroundcolor Green } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host    -foregroundcolor Red Enable-LocalUser $user <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host    -foregroundcolor Green } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((Get-LocalUser $user).PasswordExpires -eq $null) { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host      -foregroundcolor Green } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host     -foregroundcolor Red set-LocalUser $user -PasswordNeverExpires:$true <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host      -foregroundcolor Green } try { Get-LocalGroupMember -SID S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-number"><span class="hljs-number">544</span></span> -Member $user -ErrorAction Stop | Out-Null <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host  $user     -foregroundcolor Green } Catch { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host  $user      -foregroundcolor Red Add-LocalGroupMember -SID S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-number"><span class="hljs-number">544</span></span> -Member $user <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host  $user     -foregroundcolor Green } } Catch { cls <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host  $user  -foregroundcolor Red new-LocalUser -User $user -password $password -PasswordNeverExpires:$true -AccountNeverExpires:$true Add-LocalGroupMember -SID S-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-number"><span class="hljs-number">32</span></span>-<span class="hljs-number"><span class="hljs-number">544</span></span> -Member $user <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>-host  $user       -foregroundcolor Green }</code> </pre> <br>  Post Scriptum <br><br>  However, storing the administrator password in a script is not the best practice in terms of security.  To do this, you can use the password hash, not the password itself. <br><br><pre> <code class="hljs php">$user = <span class="hljs-string"><span class="hljs-string">'admin1'</span></span> $hash = <span class="hljs-string"><span class="hljs-string">"01000000d08c9ddf0115d1118c7a00c04fc297eb0100000048baf1b47a72d845b4eeda8659da9fd70000000002000000000010660000000100002000000004d2a3bf03aac92c2e172dc002d1fe8759da4655850462aface5c25f52921e05000000000e8000000002000020000000bfa652b6f7cc6845e3cee1831b54ab93dc272d0b2203024c3de8bc4789a2698a10000000923fb50dcf01125913534d0c1ba6d827400000002757df7d8a8b39c8e84b81323acff1d72419580a0022cf610926e5f081a2e895320088d482eb407f8157aad82f091abee7427b357e871d12238a8f74131238e7"</span></span> $hash $password = ConvertTo-SecureString -String $hash $password <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-LocalUser -User $user -password $password -PasswordNeverExpires:$true -AccountNeverExpires:$true Add-LocalGroupMember -SID S<span class="hljs-number"><span class="hljs-number">-1</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span><span class="hljs-number"><span class="hljs-number">-32</span></span><span class="hljs-number"><span class="hljs-number">-544</span></span> -Member $user</code> </pre><br>  To get a password hash, you can use the following script <br><br><pre> <code class="hljs perl">$Secure = Read-Host -AsSecureString $Secure $hash = ConvertFrom-SecureString -SecureString $Secure $hash</code> </pre> <br>  Which will ask for a password from the keyboard. <br><br>  And a small bonus for displaying all disabled entries. <br><br><pre> <code class="hljs perl">Get-LocalUser | Where-Object {$_.enabled -eq $false}</code> </pre> <br>  I hope my time will help someone in their work.  Yes, and for yourself it will be useful not to forget this invaluable experience. </div><p>Source: <a href="https://habr.com/ru/post/418859/">https://habr.com/ru/post/418859/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418849/index.html">Event digest for HR-specialists in IT in August 2018</a></li>
<li><a href="../418851/index.html">How to buy the illusion of security in the form of children's smart watches</a></li>
<li><a href="../418853/index.html">Details on the update of Segregated Witness and the consequences of its adoption in Bitcoin</a></li>
<li><a href="../418855/index.html">Open webinar ‚ÄúCreating an application on Webpack + React + Express‚Äù</a></li>
<li><a href="../418857/index.html">Preparing SSL Certificates for Installation</a></li>
<li><a href="../418863/index.html">Understand Render Props with an example</a></li>
<li><a href="../418867/index.html">Dynamic programming in olympiad problems</a></li>
<li><a href="../418869/index.html">Easier than it seems. Chapters 9-10</a></li>
<li><a href="../418871/index.html">Kegel‚Äôs Elvie Smart Trainer for Strengthening Intimate Muscles - Why You Need It</a></li>
<li><a href="../418873/index.html">Just about the complicated. Part 3, we continue to create a wireless "smart home". Based on Z-Wave technology and MajorDoMo software</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>