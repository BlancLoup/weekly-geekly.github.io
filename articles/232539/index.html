<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why we chose MongoDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article came into being after reading the material ‚ÄúWhy you should never use MongoDB . ‚Äù Below is a story about how we gradually abandoned MySQL ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why we chose MongoDB</h1><div class="post__text post__text-html js-mediator-article">  This article came into being after reading the material <a href="http://habrahabr.ru/post/231213/">‚ÄúWhy you should never use MongoDB</a> . <a href="http://habrahabr.ru/post/231213/">‚Äù</a>  Below is a story about how we gradually abandoned MySQL and came to using MongoDB as the main data repository. <br><br><img src="https://habrastorage.org/files/edb/653/713/edb653713d754a0d9934eccb8c187294.jpg"><br><br>  It all started somewhere in 2008, when it was decided to write a second version of our site.  For some time, we wanted to create a multilingual version of the database of games, near-game companies, characters, etc., since the existing solution seemed to be outdated. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first step was formulated: <br><a name="habracut"></a><br><h1>  Requirements </h1><br>  These are mainly database requirements. <br>  Of the significant can be identified: <br><br><h2>  Requirement 1. Multilingual fields </h2><br>  Each entry can have one or more multilingual fields containing both relatively short titles and long descriptions.  Thought over different options: <br><br><h3>  Option 1. Two tables for the entire database </h3><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, object_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, lang <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> description ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, object_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, description <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, lang <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, )</code> </pre> <br>  Accordingly, if the game (table game) has a multilingual name, an alternate name alt_name, and a description of desc, then you would have, in addition to the game itself, three more entries per language. <br><br>  An example of entries in the name table: <br><pre> <code class="bash hljs">id | table | field | object_id | name | lang ---|-------|----------|-----------------------|----- 1 | game | name | <span class="hljs-variable"><span class="hljs-variable">$game_id</span></span> | <span class="hljs-variable"><span class="hljs-variable">$name</span></span> | en 2 | game | alt_name | <span class="hljs-variable"><span class="hljs-variable">$game_id</span></span> | <span class="hljs-variable"><span class="hljs-variable">$alt_name</span></span> | en</code> </pre><br><br>  An example entry in the description table: <br><pre> <code class="bash hljs">id | table | field | object_id | description | lang ---|-------|-------|-----------|-------------|----- 1 | game | desc | <span class="hljs-variable"><span class="hljs-variable">$game_id</span></span> | <span class="hljs-variable"><span class="hljs-variable">$desc</span></span> | en</code> </pre><br><br>  The same tables could be combined into one, using the type text for storing names, but I did not like this solution;  why - I do not remember. <br><br><h3>  Option 2. For each main table - its own multilingual </h3><br>  For the same table of games you get about the following: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> game_i18n ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, game_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, alt_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, description <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, lang <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> )</code> </pre><br>  Record example: <br><pre> <code class="bash hljs">id | game_id | name | alt_name | desc | lang ---|----------|----------|--------------|----------|----- 1 | <span class="hljs-variable"><span class="hljs-variable">$game_id</span></span> | <span class="hljs-variable"><span class="hljs-variable">$name</span></span> | <span class="hljs-variable"><span class="hljs-variable">$alt_name</span></span> | <span class="hljs-variable"><span class="hljs-variable">$desc</span></span> | en 2 | <span class="hljs-variable"><span class="hljs-variable">$game_id</span></span> | <span class="hljs-variable"><span class="hljs-variable">$name_ru</span></span> | <span class="hljs-variable"><span class="hljs-variable">$alt_name_ru</span></span> | <span class="hljs-variable"><span class="hljs-variable">$desc_ru</span></span> | ru</code> </pre><br><br><h3>  Option 3. Save multilanguage fields as a json-array in a separate field of the main table </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> game ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, ..., i18n <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> )</code> </pre><br>  Record example: <br><pre> <code class="bash hljs">id | i18n ---|-------------------------------- 1 | {<span class="hljs-string"><span class="hljs-string">'name'</span></span>:[{<span class="hljs-string"><span class="hljs-string">'lang'</span></span>:<span class="hljs-string"><span class="hljs-string">'en'</span></span>,<span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-variable"><span class="hljs-variable">$name</span></span>}, {<span class="hljs-string"><span class="hljs-string">'lang'</span></span>:<span class="hljs-string"><span class="hljs-string">'ru'</span></span>,<span class="hljs-string"><span class="hljs-string">'value'</span></span>:<span class="hljs-variable"><span class="hljs-variable">$name_ru</span></span>}], <span class="hljs-string"><span class="hljs-string">'alt_name'</span></span>: [...], <span class="hljs-string"><span class="hljs-string">'desc'</span></span>: [...]}</code> </pre><br>  The third option is the most flexible, but almost immediately was abandoned, since sorting and filtering by name were needed, and you would still have to do something similar to option 1 or 2. Plus, if you need to, say, delete the English name in several games, it will be difficult to do with the tools of SQL itself. <br><br>  As a result, we stopped at option 2. Against the first option, multilingual fields could have their own additional fields.  For example, in games you need the ability to mark one of the names as the main thing, other objects may have their own set of additional fields, by which it is quite possible that you will also need to filter / sort.  I didn‚Äôt want to come to the following when choosing the first option in a couple of years: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, object_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, lang <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, field1 <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, field2 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>), ..., field9 datetime )</code> </pre><br>  And then in the code to remember - what field3 is at the table of companies.  In addition, somehow uncomfortable when creating the next table with five entries, dump the translations into a table with a million entries.  However, the last in all its glory appeared here: <br><br><h2>  Requirement 2. Links </h2><br>  There was a desire to be able to associate any object from any table with any other object while maintaining the direction of communication. <br>  The options are about the same as in the first requirement: <br><br><h3>  Option 1. One table for all links of the base </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, table1 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, object1_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, table2 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, object2_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> )</code> </pre><br>  Sample entries: <br><pre> <code class="bash hljs">id | table1 | object1_id | table2 | obect2_id | ---|---------|------------|--------|-----------| 1 | game | <span class="hljs-variable"><span class="hljs-variable">$game_id</span></span> | genre | <span class="hljs-variable"><span class="hljs-variable">$genre_id</span></span> | 2 | game | <span class="hljs-variable"><span class="hljs-variable">$game_id</span></span> | game | <span class="hljs-variable"><span class="hljs-variable">$game2_id</span></span> | 3 | game | <span class="hljs-variable"><span class="hljs-variable">$game2_id</span></span> | game | <span class="hljs-variable"><span class="hljs-variable">$game_id</span></span> |</code> </pre><br>  Entries # 2 and # 3 implement bidirectional communication, entry # 1 - unidirectional from game to genre. <br><br><h3>  Option 2. For each type of connection has its own table </h3><br>  For example, the connection between similar games would have turned out like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> similar_games_link ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, game1_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, game2_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> )</code> </pre><br>  and so on for each type of connection. <br><br><h3>  Option 3. Store the connection in the object itself in text form </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> game ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, ..., links <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> )</code> </pre><br>  Example: <br><pre> <code class="bash hljs">id | links | ---|----------------------------------| 1 | <span class="hljs-comment"><span class="hljs-comment">#game:$game2_id#genre:$genre_id# |</span></span></code> </pre><br>  Then you can look for something like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> game <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> links <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%#game:$game2_id#%'</span></span></code> </pre><br><br><h3>  Option 4. Analogue of option 3, but store json </h3><br>  Example: <br><pre> <code class="bash hljs">id | links | ---|------------------------------------------------------------------------------------------| 1 | [{<span class="hljs-string"><span class="hljs-string">'table'</span></span>:<span class="hljs-string"><span class="hljs-string">'game'</span></span>, <span class="hljs-string"><span class="hljs-string">'object_id'</span></span>: <span class="hljs-variable"><span class="hljs-variable">$game2_id</span></span>}, {<span class="hljs-string"><span class="hljs-string">'table'</span></span>: <span class="hljs-string"><span class="hljs-string">'genre'</span></span>, <span class="hljs-string"><span class="hljs-string">'object_id'</span></span>: <span class="hljs-variable"><span class="hljs-variable">$genre_id</span></span>}] |</code> </pre><br><br><h3>  Options 5 and 6. For each type of connection its own field. </h3><br>  A variation of options 3 and 4, but the links are spread across different fields. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> game ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, ..., similar <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, genres <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> )</code> </pre><br>  As a result, we decided to store everything in one table (conveniently), plus, in some cases, it would be possible to duplicate information about the connections in the fields of the object itself (options three through six).  I did not want to produce my own table for each type of connection, and the third option could help.  Of course, doing links like '% # game: $ game2_id #%' is terrible, but I would survive.  This option was abandoned because deleting records turned into a non-trivial task.  The fourth and sixth options themselves are generally useless. <br><br><h2>  Requirement 3. Objects with a different set of fields in the same table </h2><br>  For example, news, articles and videos you want to store in one table, because, first, they need to be shown on the site in a common tape in chronological order, and second, there is a lot in common between these types of records (name, date of creation / change, text).  But there are differences between the posts, let's call them metadata.  For example, for reviews (one of the subtypes of articles), you can specify estimates by which it would be nice to be able to sort, the video indicates the resolution of the original video, the duration, whether or not the gameplay is shown, etc.  Depending on the type of post changes and display on the site. <br><br>  The solutions to how to store metadata are the same as above.  One table is created in which the fields for all types of records will be common.  And then a few options.  You can store all the metadata directly in the text of the post (or in a separate text field) with special tags, as done in Wikipedia, and when saved, scatter over linked supporting tables.  You can immediately create auxiliary tables for each of the post types and save the metadata there (we chose this option, especially since for different types of posts all the same different editing forms were created in the admin area).  You can store metadata in the form of json or any other serialized form (the problems are also the same - the difficulty of changing such serialized data using SQL tools, plus sorting / filtering). <br><br><h2>  Requirement 4. Complex objects </h2><br>  The game can be released on different platforms and can have different editions for each platform.  The release on the platform and the publication has a set of fields that coincides with the game itself.  An example of such a field is ‚ÄúName‚Äù, since, for example, the name of a publication for a specific platform may differ from the canonical name of a game.  Also, the platform and the publication have a set of fields that are not in the game itself, for example, for the platform it will be the platform itself, the publication has the date of its release.  How to store all this?  In the form of three separate tables?  By analogy with how storage of objects with a different set of fields is solved in requirement 3?  Or store the game itself as a single record, and all platforms and editions - as json in a separate field of this record?  And how to edit such joy?  Do three different forms?  At the same Pac-Man 27 platforms and more than 30 editions, editing such a monster can turn into torture.  And how to show it?  For example, to show the publication, you have to load the platform and the game for it, because, for example, the publication may not have its name.  Then you need to watch the general name of the game on the platform, and if it is not there, then watch the name of the game itself.  In this case, prescribe to all publications the same title - is also not great. <br><br>  Previously, I stopped almost on the same version as in requirement 3 - one table for games.  But, since there were only three record types, it was decided to store the distinct fields in the same table and not produce tables for metadata. <br><br><h1>  Mysql </h1><br>  Having decided on the requirements and preliminary versions of their solution, we began to develop the admin panel.  And then (as always) problems started.  For example, a company may have a name and description.  Create one company_i18n table with name and description fields.  So far, so good.  In edit form <br><br>  HTML form: <br><pre> <code class="bash hljs">  en: Bad Pixel [x] ru:      [x] ru:  ‚Äú ‚Äù [x] [ ] [ ]</code> </pre><br>  Separately, its own set of names in different languages ‚Äã‚Äãand its own set of descriptions are indicated, but this is not a problem - the names and descriptions are saved by language, and for each language, one record is created in the company_i18n. <br><br>  Entries in company_i18n after saving: <br><pre> <code class="bash hljs">id | lang | name | description ---|------|------------------|-------------------------------- 1 | en | Bad Pixel | NULL 2 | ru |  ‚Äú ‚Äù |     </code> </pre><br>  Then it turned out that there can be several descriptions in one language, and the name should be strictly one for the language, and we come to something like: <br><pre> <code class="bash hljs">id | lang | name | description ---|------|------------------|------------ 1 | en | Bad Pixel | NULL 2 | ru |  ‚Äú ‚Äù |  1 3 | ru | NULL |  2</code> </pre><br>  It does not look very good already, especially if you need to delete ‚ÄúDescription 2‚Äù using SQL - you need to look at whether there is a name in the name field, and if it is, update the record, and if not, delete it.  Then the company‚Äôs main flag appears, the field for corporate names appears, which may be several in the same language (for different periods of time), and comes the understanding that it seems you will have to store names and descriptions in different tables. <br><br>  The connections between the objects almost immediately appeared the power of communication.  This was not a problem, problems began when a different set of additional fields appeared for different types of links.  For example, genres can be associated with other genres and be their subgenres, and the connection should be bidirectional: in tags, some tags are characters from another tag-universe, and games have the same company can be both a developer and a publisher.  Although the problem can be solved by adding new fields to the link table, it would be more correct to create separate auxiliary tables for individual types of links. <br><br>  Of course, I understand that life is a pain, and the developer (in particular) must not forget to suffer, so the development continued slowly but surely, and the auxiliary tables appeared with enviable regularity.  Nevertheless, I wanted to somehow automate the processes of creating such auxiliary tables and assembling a complete object from them.  With such thoughts in early 2010, I came across an article ‚Äú <a href="http://habrahabr.ru/post/87147/">How FriendFeed uses MySQL to store data without a schema</a> ‚Äù. <br><br><h1>  MySQL and data without schema </h1><br>  The idea to make NoSQL over MySQL does not look so crazy even now.  At that time, MySQL had been developing for years and was a reliable solution for production, and specialized NoSQL solutions only started to appear, and did not want to, making a choice in favor of one thing, after a couple of years, be alone with an unsupported product.  I think those who, like me at one time, made a bet on prototype.js, will understand me. <br><br>  At that time, we did not even consider MongoDB for various reasons, in particular, it was not yet recommended for production (the first production ready release was at the end of the first quarter of 2010).  I still advocate such an approach: use relatively well-established solutions for projects and at the minimum involve handwritten counterparts.  But then there were no well-established solutions (or it seemed that they did not exist), and for one of my third-party projects, I wrote something similar to what FriendFeed had.  Understand me correctly: I am not proud of it - the idea of ‚Äã‚Äãdoing something of your own can be tempting exactly until you have to maintain it, fix bugs, optimize, develop functionality, adapt to new versions of the language / libraries / used services.  The only thing I regret is - then it was necessary to download and feel the "mongu", this is a matter of half an hour, maximum of an hour, and good for years.  Actually, this applies to all new technologies: they do not appear for a reason, and knowledge of current trends allows us to simply expand our horizons. <br><br>  So, the library was written to work with data without a scheme and storing all of this in MySQL. <br><br><div class="spoiler">  <b class="spoiler_title">A brief description of what happened.</b> <div class="spoiler_text">  The objects were stored in a serialized form in the blob field of the entity table.  An additional category field was introduced (analogous to tables in MySQL and collections in MongoDB) so that you can separate objects, such as games, companies, etc.  (from the option when, for example, all messages are stored in the subject object, we almost immediately refused - for the messages have their own category, for the subject is their own), plus two fields - the time for creating and updating the object.  Since everything was written in Perl, the Storable library was used to serialize data structures (usually a combination of hashes and arrays) from the internal representation to the binary view and back.  First of all, it was done because of the speed, in json the data was converted an order of magnitude slower.  In the second - due to a more compact representation compared to json. <br><br>  The id used was uuid, 16 bytes of which were encoded using base 64 into a text string 22 bytes long. <br><br>  For any changes to the object, it was possible to hang ‚Äútriggers‚Äù - functions that changed both the object itself and other objects associated with the current one.  For example, when writing a comment, the trigger can change the total number of comments in the topic object. <br><br>  Since no queries could be done on the entity table (except for the primary key and category), indexes were introduced ‚Äî regular MySQL tables that were created based on the fields of the object being saved. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`index_platform`</span></span> ( <span class="hljs-string"><span class="hljs-string">`generation`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`path_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`entity_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">binary</span></span>(<span class="hljs-number"><span class="hljs-number">22</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`generation`</span></span> (<span class="hljs-string"><span class="hljs-string">`generation`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre><br>  It was written in the config: <br><pre> <code class="perl hljs">$db-&gt;<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>( <span class="hljs-string"><span class="hljs-string">'table'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'index_platform'</span></span>, <span class="hljs-string"><span class="hljs-string">'properties'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'generation'</span></span>, <span class="hljs-string"><span class="hljs-string">'path_id'</span></span>], <span class="hljs-string"><span class="hljs-string">'shard_on'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'entity_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'categories'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'platform'</span></span>], ));</code> </pre><br>  Then when saving the object: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $uuid = $db-&gt;put({ <span class="hljs-string"><span class="hljs-string">'generation'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'path_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'pc'</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; [ {<span class="hljs-string"><span class="hljs-string">'lang'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'en'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'PC'</span></span>} ] });</code> </pre><br>  In index_platform, an entry was created automatically: <br><pre> <code class="bash hljs">generation | path_id | entity_id -----------|---------|---------- 0 | pc | <span class="hljs-variable"><span class="hljs-variable">$uuid</span></span></code> </pre><br><br>  For these indices it was already possible to make selections: <br><pre> <code class="perl hljs">$db-&gt;resultset(<span class="hljs-string"><span class="hljs-string">'index_platform'</span></span>)-&gt;search({ <span class="hljs-string"><span class="hljs-string">path_id =&gt;</span></span> {<span class="hljs-string"><span class="hljs-string">'in'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'pc'</span></span>, <span class="hljs-string"><span class="hljs-string">'xbox'</span></span>]}, <span class="hljs-string"><span class="hljs-string">generation =&gt;</span></span> {<span class="hljs-string"><span class="hljs-string">'in'</span></span> =&gt; [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>]} }, { <span class="hljs-string"><span class="hljs-string">order_by =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'generation desc'</span></span>, <span class="hljs-string"><span class="hljs-string">limit =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">page =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">join =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">#    ,      entity,   ,     })-&gt;all();</span></span></code> </pre><br><br>  Alternative variant of the same request: <br><pre> <code class="perl hljs">$db-&gt;resultset(<span class="hljs-string"><span class="hljs-string">'index_platform'</span></span>)-&gt;search({ <span class="hljs-string"><span class="hljs-string">path_id =&gt;</span></span> {<span class="hljs-string"><span class="hljs-string">'in'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'pc'</span></span>, <span class="hljs-string"><span class="hljs-string">'xbox'</span></span>]}, <span class="hljs-string"><span class="hljs-string">generation =&gt;</span></span> {<span class="hljs-string"><span class="hljs-string">'in'</span></span> =&gt; [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>]} })-&gt;order_by(<span class="hljs-string"><span class="hljs-string">'generation desc'</span></span>)-&gt;limit(<span class="hljs-number"><span class="hljs-number">10</span></span>)-&gt;page(<span class="hljs-number"><span class="hljs-number">2</span></span>)-&gt;<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)-&gt;all();</code> </pre><br><br>  There were only two types of interaction with the database: this is the change of the objects themselves in the entity table (including deletion) and queries to indexes as in the example above.  JOIN is software only. <br><br>  When deleting an object, it was only marked as deleted, without being physically deleted from the entity table. <br></div></div><br><br>  Around the middle of 2010, we tried to switch to this method of data storage. <br><br>  Objects can now be saved in this form: <br><pre> <code class="perl hljs">$company = { <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; [ {<span class="hljs-string"><span class="hljs-string">'lang'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' ‚Äú ‚Äù'</span></span>, <span class="hljs-string"><span class="hljs-string">'is_primary'</span></span> =&gt; true}, {<span class="hljs-string"><span class="hljs-string">'lang'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'en'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Bad Pixel'</span></span>}, ], <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; [ {<span class="hljs-string"><span class="hljs-string">'lang'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'    ‚Äù'</span></span>}, ], <span class="hljs-string"><span class="hljs-string">'link'</span></span> =&gt; [ {<span class="hljs-string"><span class="hljs-string">'category'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'tags'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; $tag_uuid, <span class="hljs-string"><span class="hljs-string">'degree'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>}, {<span class="hljs-string"><span class="hljs-string">'category'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'game'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; $game_uuid, <span class="hljs-string"><span class="hljs-string">'role'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'developer'</span></span>}, ] };</code> </pre><br>  In the name and link fields, records were automatically created in the index_name index_name and index_link tables.  Objects could be of any complexity and nesting, with a different set of fields for an object from the same category.  It was necessary to create index tables as before, but it became much easier.  If there was not enough of a field, it was enough to change the code, and if it was necessary to make selections for this field, an additional index table was created or an existing index changed.  If some index did not suit, you could just delete it and build a new one.  In perspective, I wanted to make the creation of such index tables automatically by describing their structure in code. <br><br>  Such data storage (storage), along with advantages, had significant drawbacks. <br>  Of the benefits could be identified: <br><ul><li>  the availability of transactions (although for me it was not so important) </li><li>  the existence of a <a href="http://yoshinorimatsunobu.blogspot.ru/2010/10/using-mysql-as-nosql-story-for.html">patch</a> for mysql, which allowed to process up to 750 thousand readings per second using a primary key </li><li>  scalability - the architecture did not interfere with the shardit of data on the primary key, while for the application working with the storage, nothing changed </li><li>  since uuid was used as the primary key, it was possible to merge painlessly as many databases without collisions on the primary key as possible </li><li>  generation of index tables on the fly </li></ul><br>  The main disadvantages: <br><ul><li>  you need to independently develop and maintain the repository code itself </li><li>  lack of support for different languages </li><li>  lack of atomic operations on data;  to make $ company -&gt; {'link'} -&gt; [0] -&gt; {'degree'} ++, you need to load the object into the application, change and save it back to the database </li><li>  it is impossible to change several records with a single request, only through a map function in a third-party application </li><li>  transactions, scalability, generation of index tables needed to be implemented </li><li>  lack of console </li></ul><br><br>  During the operation, various ‚Äúbugs‚Äù of the storehouse itself emerged, of the most unpleasant - the dependence of the object serialization algorithm in the Storable library on the operating system.  This was decided by moving to the storage of objects in the form of json with compression using gzip.  By the way, it was precisely during the correction of this ‚Äúbug‚Äù that I clearly realized that it does not matter how the objects themselves are stored.  This may be a separate table in the database, or you can save it stupidly as json files, calling them by the primary key and scattering them in subfolders (however, this deprives the application itself of scalability, problems will arise due to race condition, etc. although, on the other hand, it would be possible to try Hadoop, but, frankly, it would be superfluous).  The main thing is to be able to create indexes for objects, as is done, for example, in the Sphinx search engine.  Why not take MySQL in much the same way as Sphinx?  Why not store the data in the form of key-value storage, but for searching, sorting and outputting various lists to the user, create suitable indices for this in suitable services?  Of course, if billing is created, then this approach, to put it mildly, is not very justified, but web applications for the most part are less demanding of having the same ACID, and you have to suffer almost as much as billing. <br><br>  However, gradually the disadvantages when using samopisny storage began to outweigh, and also for each object it was necessary to draw its form in the admin panel, in a word - there was not that universality that I wanted.  Plus, at AG, in 2012, there were a number of rather political events, such as a change in the site owner, management and management, and it was decided to write a second version in Python, since the programmers at the new company wrote in this language.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There were two options - either to issue the current storage as a standalone service, or use any existing key-value storage. </font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MongoDB </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How would you feel if once it turned out that someone created an analogue of your library (or, vice versa, you created an analogue of an already existing library without knowing it), and this analogue, while preserving the essential advantages of your solution, is not yet possessed of his minuses? Personally, I was glad. Gorgeous console with full support for Javascript, atomic operations, sharding, automatic creation of indices for selected fields, libraries for main programming languages ‚Äã‚Äã... At that time, there were already Python frameworks that supported MongoDB or were written specifically for it. And all this did not need to be supported or developed. Yes, in addition, api was also similar to api repositories.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result, starting from scratch (already as Riot Pixels) development in Python in 2013, we, having correctly chosen the tools (one of which was MongoDB), did more for the quarter than we did in two years before. </font><font style="vertical-align: inherit;">Another, as it seems to me, correct choice was the choice of the admin panel, which allowed editing objects of any nesting - because of this, there was almost no time wasted on its development. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I would like to finish with this. </font><font style="vertical-align: inherit;">It is probably wrong to oppose MongoDB and MySQL, because they are suitable for different tasks differently, and it just so happened that in this project we were more suited to MongoDB. </font><font style="vertical-align: inherit;">If suddenly this happens and the MongoDB speed or functionality is not enough, then nothing will prevent MySQL from being used as a caching layer / index for data ‚Äî once set up and forgotten.</font></font></div><p>Source: <a href="https://habr.com/ru/post/232539/">https://habr.com/ru/post/232539/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../232527/index.html">Efficient backup scripts</a></li>
<li><a href="../232531/index.html">Hack mobile online game? Easy!.</a></li>
<li><a href="../232533/index.html">The second meeting of the community JUG.EKB</a></li>
<li><a href="../232535/index.html">Looking for an ergonomic workplace</a></li>
<li><a href="../232537/index.html">How we nontrivially chose a place for coworking in Moscow and how we arranged everything inside</a></li>
<li><a href="../232543/index.html">How we designed and made True Image for Mac</a></li>
<li><a href="../232545/index.html">Free CryptoLocker file decryption</a></li>
<li><a href="../232547/index.html">Kabam invested $ 120 million, Tango focuses on games and a new mobile hit from the Japanese - the main mobile news of the week</a></li>
<li><a href="../232549/index.html">Some OpenSSL vulnerabilities</a></li>
<li><a href="../232551/index.html">WAE BTP02 - Hercules Mobile Wireless Speaker</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>