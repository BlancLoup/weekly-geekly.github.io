<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up a Source Source Server for Linux, Part 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- Statistics Server HLstatsX Installation Mysql setup Configuring the HLstatsX daemon Web server setup Broadcast logs Patch First start Server registr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up a Source Source Server for Linux, Part 4</h1><div class="post__text post__text-html js-mediator-article"><ul><li>  Statistics Server HLstatsX <br><ul><li>  Installation </li><li>  Mysql setup </li><li>  Configuring the HLstatsX daemon </li><li>  Web server setup </li><li>  Broadcast logs </li><li>  Patch </li><li>  First start </li><li>  Server registration </li><li>  Initial setup </li><li>  Errors </li><li>  Heat maps </li><li>  Auto start </li><li>  Tuning <br><ul><li>  Fonts </li><li>  Card preview </li><li>  Separate accounting statistics </li><li>  Disable statistics </li><li>  Access limitation </li><li>  New weapon </li><li>  Password recovery </li></ul></li></ul></li></ul><a name="habracut"></a><br><h1 id="server-statistiki-hlstatsx">  Statistics Server HLstatsX </h1><br><p>  It would be unfair not to catch a glimpse of the HLstatsX Community Edition (HLstatsX: CE) statistics server.  The project is currently developing not very actively, the last stable version is 1.6.19 from 2014.  You can install it, or you can install the current version, at the time of writing, which is not fundamentally edited.  You still have to finish. </p><br><p>  We still need a sql server (mysql / mariadb), a web server (nginx), perl and php with some modules.  Also on our game servers MetaMod and SourceMod should already be installed. </p><br><h2 id="ustanovka">  Installation </h2><br><p>  The current repository is <a href="https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/">https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/</a> </p><br><p>  Download the current version: </p><br><pre><code class="bash hljs">$ wget https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/get/master.tar.bz2 $ mkdir ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span> $ tar -jxvf master.tar.bz2 -C ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span> --strip 1</code> </pre> <br><p>  HLstatsX consists of three logical parts - a SourceMod plugin that broadcasts game events, receives a daemon, and displays a web part. </p><br><p>  Statistics will be collected as follows: </p><br><ul><li>  Game servers with special SourceMod plugins broadcast on udp extended game logs to 192.0.2.0:27500 (server No 1) and 192.0.2.0:27501 (server No 2) </li><li>  Demon HLstatsX receives logs, listening to the specified addresses and writes information into a common sql database. </li><li>  The HLstatsX web interface on its basis draws beautiful (or not so) statistics. </li></ul><br><p>  Go to the ~ / stat directory.  There we see subdirectories </p><br><p>  <code>amxmodx</code> - plug-ins for AMX Mod X <br>  <code>heatmaps</code> - scripts for building heat maps <br>  <code>scripts</code> - demon scripts <br>  <code>sourcemod</code> - <code>sourcemod</code> plugins <br>  <code>sql</code> - script to create sql database <br>  <code>web</code> - web interface. </p><br><p>  The amxmodx and sourcemod subdirectories contain plug-ins for AMX Mod X and SourceMod, respectively.  Since we do not use AMX Mod X, the contents of amxmodx are not relevant to us, unlike sourcemod, which contains statistics plugins in source codes (sourcemod / scripting) and in compiled form (sourcemod / plugins).  Theoretically, there may be problems when the version of SourceMod installed here is very different from the one under which the plugin is compiled, so we will copy the source code for the plug-ins hlstatsx.sp and superlogs-tf2.sp to the scripting directory of the first server and recompile them: </p><br><pre> <code class="bash hljs"> $ cp ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/sourcemod/scripting/{hlstatsx.sp,superlogs-tf2.sp} ~/tf2/tf/addons/sourcemod1/scripting $ cp ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/sourcemod/scripting/include/* ~/tf2/tf/addons/sourcemod1/scripting/include $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/tf2/tf/addons/sourcemod1/scripting</code> </pre> <br><p>  To avoid compilation errors, correct the file: </p><br><pre> <code class="bash hljs"> $ sed -i -es/char/char1/g ~/tf2/tf/addons/sourcemod1/scripting/hlstatsx.sp</code> </pre> <br><p>  Compile and decompose directories: </p><br><pre> <code class="bash hljs"> $ ./compile.sh hlstatsx.sp superlogs-tf2.sp $ cp compiled/hlstatsx.smx compiled/superlogs-tf2.smx ~/tf2/tf/addons/sourcemod1/plugins $ mv compiled/hlstatsx.smx compiled/superlogs-tf2.smx ~/tf2/tf/addons/sourcemod2/plugins</code> </pre> <br><p>  If the game servers are already running, then enter their consoles (commands are indicated by angle brackets): </p><br><pre> <code class="hljs css"> &gt;&gt;&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">sm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">plugins</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refresh</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[SM]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">The</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">plugin</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">list</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">has</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">been</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refreshed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">and</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">reloaded</span></span>. &gt;&gt;&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">sm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">plugins</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">list</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[SM]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Listing</span></span> 19 <span class="hljs-selector-tag"><span class="hljs-selector-tag">plugins</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[...]</span></span> 18 "<span class="hljs-selector-tag"><span class="hljs-selector-tag">SuperLogs</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">TF2</span></span>" (2<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.32</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">by</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Thomas</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmptrWz</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">Berezansky</span></span> &amp; <span class="hljs-selector-tag"><span class="hljs-selector-tag">psychonic</span></span> 19 "<span class="hljs-selector-tag"><span class="hljs-selector-tag">HLstatsX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Ingame</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Plugin</span></span>" (1<span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.19</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">by</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">psychonic</span></span></code> </pre> <br><p>  Good.  In principle, players can already call the HLstatsX plugin by typing "hlx_menu" in the chat window.  True so far without much effect.  Settings for these plug-ins (and not only these) are made through their console variables - ConVars, usually by writing in the server configuration files, or a specific card.  Their list is usually in the documentation, but if you want you can see for yourself: </p><br><pre> <code class="bash hljs"> $ grep CreateConVar ~/tf2/tf/addons/sourcemod1/scripting/hlstatsx.sp $ grep CreateConVar ~/tf2/tf/addons/sourcemod1/scripting/superlogs-tf2.sp</code> </pre> <br><p>  We find out that superlogs_headshots is off by default.  If you need to register headshots, then add "superlogs_headshots 1" to any configuration file, and for an already running server, execute the same command in the console. </p><br><h2 id="nastroyka-mysql">  Mysql setup </h2><br><p>  The mysql server (mariadb) is already installed, configured and running, so we immediately proceed to create a database for the statistics server.  Go to ~ / stat / sql (where install.sql should be), remember the administrator password for mysql, start the client: </p><br><pre> <code class="bash hljs"> $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/sql $ mysql --user=root mysql --password</code> </pre> <br><p>  Create a database and a user with a password: </p><br><pre> <code class="hljs pgsql"> Enter <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: Welcome <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the MariaDB monitor. Commands <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> \g. Your MariaDB <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">1513</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-number"><span class="hljs-number">5.5</span></span><span class="hljs-number"><span class="hljs-number">.47</span></span>-MariaDB-<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> MariaDB <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> Copyright (c) <span class="hljs-number"><span class="hljs-number">2000</span></span>, <span class="hljs-number"><span class="hljs-number">2015</span></span>, Oracle, MariaDB Corporation Ab <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> others. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-string"><span class="hljs-string">'help;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">'\h'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> help. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-string"><span class="hljs-string">'\c'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> clear the <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span>. MariaDB [mysql]&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> hlx_db; Query OK, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> affected (<span class="hljs-number"><span class="hljs-number">0.02</span></span> sec) MariaDB [mysql]&gt; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> hlx_db.* <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> hlx_user@localhost IDENTIFIED <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">'hlx_password'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span>; Query OK, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> affected (<span class="hljs-number"><span class="hljs-number">0.00</span></span> sec) MariaDB [mysql]&gt; FLUSH <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span>; Query OK, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> affected (<span class="hljs-number"><span class="hljs-number">0.00</span></span> sec) MariaDB [mysql]&gt; QUIT; Bye</code> </pre> <br><p>  The database has been created, now we delete ~ / .mysql_history, with an immodestly fixed password from hlx_user, run the script that creates the necessary tables.  When prompted, enter the password from our database - 'hlx_password'. </p><br><pre> <code class="bash hljs"> $ rm -f ~/.mysql_history $ mysql --user=hlx_user hlx_db --password &lt; ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/sql/install.sql</code> </pre> <br><pre> <code class="hljs pgsql"> Enter <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Table</span></span> Op Msg_type Msg_text hlx_db.hlstats_Ranks optimize status OK</code> </pre> <br><p>  Everything, the database is created </p><br><blockquote>  In the process of setting up, <a href="http://www.adminer.org/">Adminer</a> , a compact but powerful web-based control panel consisting of just one php script, can be useful for surfing through sql tables, analyzing problems and deleting unsuccessful experiments.  If you do not have phpMyAdmin installed or something else, then this Adminer is a great option. </blockquote><br><h2 id="nastroyka-hlstatsx-demona">  Configuring the HLstatsX daemon </h2><br><p>  The ~ / stat / scripts directory contains the main scripts of the statistics server daemon.  Edit the settings file ~ / stat / scripts / hlstats.conf, set the parameters for connecting to the sql server: </p><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">DBHost</span></span> <span class="hljs-string"><span class="hljs-string">"localhost"</span></span> DBUsername <span class="hljs-string"><span class="hljs-string">"hlx_user"</span></span> DBPassword <span class="hljs-string"><span class="hljs-string">"hlx_password"</span></span> DBName <span class="hljs-string"><span class="hljs-string">"hlx_db"</span></span></code> </pre> <br><p>  In the UDP Socket Settings section, we don‚Äôt touch anything.  If we had one game server, then there they would register the address and port specified in logaddress_add in server.cfg.  But since we are setting up two servers, we leave the BindIP parameter empty, and the port numbers will be specified on the command line when the daemon is started. </p><br><p>  In the file ~ / stat / scripts / run_hlstats we fix the directory for the logs: </p><br><pre> <code class="hljs ruby"> LOGDIR=<span class="hljs-regexp"><span class="hljs-regexp">/home/game</span></span><span class="hljs-regexp"><span class="hljs-regexp">/log/hlstats</span></span></code> </pre> <br><p>  Install the GeoIP database.  It is useful both for displaying messages like "A player such and such from a country such and such" during a game, and for displaying statistics on a site.  Run the <code>cal</code> program, check what the first day of the week is.  The locale is en_US everywhere, so cal shows Sunday.  Go to the ~ / stat / scripts / GeoLiteCity directory and edit the GeoLite_Import.sh file: </p><br><pre> <code class="hljs pgsql"> # <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you are running Gentoo linux, <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> other linux distro # <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> the "cal" command outputs <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> Sunday <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> the first day <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> every <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>! LINUX_OTHER="0" # <span class="hljs-keyword"><span class="hljs-keyword">Login</span></span> information <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> your MySQL <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> DBHOST="localhost" DBNAME="hlx_db" DBUSER="hlx_user" DBPASS="hlx_password"</code> </pre> <br><p>  Make the GeoLite_Import.sh script executable and run it.  GeoIP database is downloaded and imported into the sql database.  With a successful import, something of the form is issued: </p><br><pre> <code class="hljs css"> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[...]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hlx_db</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.geoLiteCity_Blocks</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Records</span></span>: 2359593 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Deleted</span></span>: 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Skipped</span></span>: 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Warnings</span></span>: 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">hlx_db</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.geoLiteCity_Location</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Records</span></span>: 793056 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Deleted</span></span>: 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Skipped</span></span>: 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Warnings</span></span>: 793056</code> </pre> <br><p>  Alternatively, you can store the GeoIP data in a separate file (this is done using the install_binary.sh script - but then you need to install (if not) perl module Geo :: IP :: PurePerl - <code>perl -MCPAN -e 'install Geo::IP::PurePerl</code> . But we will store GeoIP data inside our sql database. Not so much of a load on it is expected. </p><br><h2 id="nastroyka-veb-servera">  Web server setup </h2><br><p>  We will have a statistics server at <a href="http://stat.example.org/">http://stat.example.org/</a> .  As in the case of setting Fast Download, create a separate directory /var/www/stat.example.org.  The access_log and error.log logs will also be rendered into separate files and allow the game user to read them. </p><br><p>  Statistics Server will serve both of our game servers.  From root, we create directories, transfer the ~ / stat / web directory, set the owner and permissions.  Create logs.  You can also make symbolic links for convenience. </p><br><pre> <code class="dos hljs"> # <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> -p /var/www/stat.example.org/{htdocs,log} # mv /home/game/stat/web/* /var/www/stat.example.org/htdocs # chown -R game. /var/www/stat.example.org/htdocs # touch /var/www/stat.example.org/log/{access,error}.log # chmod <span class="hljs-number"><span class="hljs-number">644</span></span> /var/www/stat.example.org/log/*.log # ln -s /var/www/stat.example.org/log /home/game/log/www-stat</code> </pre> <br><p>  Currently, HLstatsX is developing to put it mildly, not so actively, so frequent updates are not predicted, and there is not much point in giving the nginx user full access to his files for the built-in auto-update function. </p><br><p>  In order to reduce the load, the statistics server creates a small cache in the hlstatsimg / progress folder - it stores game server download schedules and Player Trend schedules (visible on the players' pages), so the web server should be allowed to write to this directory: </p><br><pre> <code class="dos hljs"> # chown nginx. /var/www/stat.example.org/htdocs/hlstatsimg/progress</code> </pre> <br><p>  Go to /var/www/stat.example.org/htdocs, edit the config.php, after making <code>dos2unix config.php</code> : </p><br><pre> <code class="hljs objectivec"> define(<span class="hljs-string"><span class="hljs-string">"DB_ADDR"</span></span>, <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>); define(<span class="hljs-string"><span class="hljs-string">"DB_USER"</span></span>, <span class="hljs-string"><span class="hljs-string">"hlx_user"</span></span>); define(<span class="hljs-string"><span class="hljs-string">"DB_PASS"</span></span>, <span class="hljs-string"><span class="hljs-string">"hlx_password"</span></span>); define(<span class="hljs-string"><span class="hljs-string">"DB_NAME"</span></span>, <span class="hljs-string"><span class="hljs-string">"hlx_db"</span></span>);</code> </pre> <br><p>  Other options do not touch yet. </p><br><p>  While we are still root, we are creating the configuration file /etc/nginx/conf.d/stat.example.org.conf our web server for this subdomain. </p><br><div class="spoiler">  <b class="spoiler_title">stat.example.org.conf</b> <div class="spoiler_text"><pre> <code class="hljs mel">server { server_name stat.example.org; listen <span class="hljs-number"><span class="hljs-number">80</span></span>; root /var/www/stat.example.org/htdocs; #  rewrite   ,   rewrite sig-(.*)-(.*).png$ /sig.php?player_id=$1&amp;background=$2 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; location / { try_files $uri $uri/ /index.php$request_uri; } #  .htaccess ,     pages, pages/admintasks, pages/ingame location ~ /\.ht { deny all; } #      php location ~ ^.+\.php(?:/.*)?$ { include /etc/nginx/php.conf; fastcgi_pass unix:/var/run/php5-fpm.sock; } access_log /var/www/stat.example.org/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/access.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> main; error_log /var/www/stat.example.org/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> warn; }</code> </pre> </div></div><br><p>  Above, we gave the game user access to read the logs of the web server, but only until their first rotation.  We fix this too.  Based on /etc/logrotate.d/nginx we create the srcds-nginx file, set the path to the logs and fix the access rights mask from 640 to 644 in the <code>create 640 nginx adm</code> : </p><br><div class="spoiler">  <b class="spoiler_title">srcds-nginx</b> <div class="spoiler_text"><pre> <code class="hljs lua">#/etc/logrotate.d/srcds-nginx /var/www/stat.example.org/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/*.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> /var/www/fastdl.example.org/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/*.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> /var/www/replay.example.org/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/*.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> { daily missingok rotate <span class="hljs-number"><span class="hljs-number">52</span></span> compress delaycompress notifempty <span class="hljs-built_in"><span class="hljs-built_in">create</span></span> <span class="hljs-number"><span class="hljs-number">644</span></span> nginx adm sharedscripts postrotate <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f /var/run/nginx.pid ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> kill -USR1 `cat /var/run/nginx.pid` fi endscript }</code> </pre> </div></div><br><p>  Here we are in the paths for rotation at the same time indicated directories with logs from servers with records and Fast Download. </p><br><p>  We check the correctness of the configuration and restart the web server. </p><br><pre> <code class="dos hljs"> # nginx -t # systemctl reload nginx</code> </pre> <br><p>  Further we continue as the user of game. </p><br><h2 id="translyaciya-logov">  Broadcast logs </h2><br><p>  We had to enable logging as early as the configuration stage, in the configuration files of our servers.  Just in case, we check for the presence of the "log on" and "logaddress_add &lt;...&gt;" parameters in them. </p><br><h2 id="patch">  Patch </h2><br><p>  Before running the scripts we will have to fix them a bit.  The fact is that since 2014, a new version of the Steam ID record has been used.  The previous, second, was of the form STEAM_0: 1: 12345678, and the current third was [U: 1: 12345678].  But the current version of HLstatsX (1.6.19) does not understand the new version of the identifier, which adds curvature to the statistics.  To prevent this, we will make several changes to the scripts that will convert the new version of steamid3 into the old one, steamid2.  The patch is taken from <a href="https://forums.alliedmods.net/showthread.php%3Ft%3D246712">forums.alliedmods.net</a> .  Save the following to the file and run. </p><br><div class="spoiler">  <b class="spoiler_title">idpatch.sh</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">#!/bin/sh uudecode -o ~/idpatch &lt;&lt; EOF <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>-base64 <span class="hljs-number"><span class="hljs-number">664</span></span> idpatch ZGlmZiAtTmF1cnAgc2NyaXB0cy9ITHN0YXRzX0V2ZW50SGFuZGxlcnMucGxp YiBzY3JpcHRzLmZpeGVkL0hMc3RhdHNfRXZlbnRIYW5kbGVycy5wbGliCi0t LSBzY3JpcHRzL0hMc3RhdHNfRXZlbnRIYW5kbGVycy5wbGliCTIwMTYtMDct MzAgMDI6NTE6NDUuMDAwMDAwMDAwICswNTAwCisrKyBzY3JpcHRzLmZpeGVk L0hMc3RhdHNfRXZlbnRIYW5kbGVycy5wbGliCTIwMTYtMTAtMTIgMTc6MDg6 MjcuNDM0NDA0MzczICswNTAwCkBAIC0xNTk0LDYgKzE1OTQsNyBAQCBzdWIg ZG9FdmVudF9QbGF5ZXJBY3Rpb24KIAkJCQlteSAkb3duZXJzdHJpbmcgPSAi IjsKIAkJCQlpZiAoZGVmaW5lZCgkcHJvcGVydGllc3tvYmplY3Rvd25lcn0p KSB7CiAJCQkJCW15ICRvd25lciA9ICRwcm9wZXJ0aWVze29iamVjdG93bmVy fTsKKwkJCQkJJG93bmVyID1+IHMhXFtVOjE6KFxkKylcXSEnU1RFQU1fMDon LigkMSAlIDIpLic6Jy5pbnQoJDEgLyAyKSFlZzsKIAkJCQkJJG93bmVyID1+ IC8uKz88U1RFQU1fWzAtOV0rOihbMC05XSs6WzAtOV0rKT4uKi87CiAJCQkJ CSRvd25lciA9ICQxOwogCQkJCQlpZiAoJG93bmVyIGVxICRwbGF5ZXItPnt1 bmlxdWVpZH0pIHsKZGlmZiAtTmF1cnAgc2NyaXB0cy9obHN0YXRzLnBsIHNj cmlwdHMuZml4ZWQvaGxzdGF0cy5wbAotLS0gc2NyaXB0cy9obHN0YXRzLnBs CTIwMTYtMDctMzAgMDI6NTE6NDUuMDAwMDAwMDAwICswNTAwCisrKyBzY3Jp cHRzLmZpeGVkL2hsc3RhdHMucGwJMjAxNi0xMC0xMiAxNzowOTowNS4wODA4 ODc1MDkgKzA1MDAKQEAgLTEwNjEsNiArMTA2MSw3IEBAIHN1YiBnZXRQbGF5 ZXJJbmZvCiAJCW15ICRoYXZlcGxheWVyICA9IDA7CiAJCQogCQkkcGxhaW51 bmlxdWVpZCA9ICR1bmlxdWVpZDsKKwkJJHVuaXF1ZWlkID1+IHMhXFtVOjE6 KFxkKylcXSEnU1RFQU1fMDonLigkMSAlIDIpLic6Jy5pbnQoJDEgLyAyKSFl ZzsKIAkJJHVuaXF1ZWlkID1+IHMvXlNURUFNX1swLTldKz9cOi8vOwogCQkK IAkJaWYgKCgkdW5pcXVlaWQgZXEgIkNvbnNvbGUiKSAmJiAoJHRlYW0gZXEg IkNvbnNvbGUiKSkgewpkaWZmIC1OYXVycCBzY3JpcHRzL1RSY29uLnBtIHNj cmlwdHMuZml4ZWQvVFJjb24ucG0KLS0tIHNjcmlwdHMvVFJjb24ucG0JMjAx Ni0wNy0zMCAwMjo1MTo0NS4wMDAwMDAwMDAgKzA1MDAKKysrIHNjcmlwdHMu Zml4ZWQvVFJjb24ucG0JMjAxNi0xMC0xMiAxNzowOTozMC42OTk4NTUzMTkg KzA1MDAKQEAgLTMzOCw2ICszMzgsNyBAQCBzdWIgZ2V0UGxheWVycwogICAg ICAgbXkgJGFkZHJlc3MgID0gJDg7CiAgICAgICBteSAkcG9ydCAgICAgPSAk OTsKIAorCSAgJHVuaXF1ZWlkID1+IHMhXFtVOjE6KFxkKylcXSEoJDEgJSAy KS4nOicuaW50KCQxIC8gMikhZWc7CiAJICAkdW5pcXVlaWQgPX4gcy9eU1RF QU1fWzAtOV0rP1w6Ly9pOwogCSAgCiAgICAgICAjICY6OnByaW50RXZlbnQo IkRFQlVHIiwgIlVTRVJJRDogJyR1c2VyaWQnLCBOQU1FOiAnJG5hbWUnLCBV TklRVUVJRDogJyR1bmlxdWVpZCcsIFRJTUU6ICckdGltZScsIFBJTkc6ICck cGluZycsIExPU1M6ICckbG9zcycsIFNUQVRFOiAnJHN0YXRlJywgQUREUkVT UzonJGFkZHJlc3MnLCBDTElfUE9SVDogJyRwb3J0JyIsIDEpOwo= ==== EOF patch <span class="hljs-comment"><span class="hljs-comment">--backup --directory ~/stat/scripts &lt; ~/idpatch rm -f ~/idpatch</span></span></code> </pre> </div></div><br><p>  Well, either pens on the article from the forum. </p><br><h2 id="pervyy-zapusk">  First start </h2><br><p>  So, we must have everything ready: </p><br><ul><li>  nginx is running (and if corrected configuration files, then restarted) </li><li>  mysql is running (database and tables are created) </li><li>  the HLstatsX daemon is configured (~ / stat / scripts / hlstats.conf) but not running </li><li>  web interface prepared (/var/www/stat.example.org/htdocs/config.php) </li><li>  necessary perl / php modules installed </li><li>  GeoIP database imported. </li></ul><br><p>  It remains to configure the launch of the demon.  Return to ~ / stat.  In principle, there you can delete already unnecessary directories amxmodx, sourcemod, sql, web.  Leave only the heatmaps and scripts.  In the ~ / stat / scripts directory, the <code>*.pl</code> and <code>run_*</code> files must be with the "executable" attribute: </p><br><pre> <code class="bash hljs"> $ chmod +x ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/scripts/*.pl ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/scripts/run_*</code> </pre> <br><p>  We start both game servers (if not started earlier). </p><br><p>  The ~ / stat / scripts / run_hlstats file is a daemon that receives statistics from game servers and writes it to the sql database.  Running it without parameters shows valid start parameters - start, stop, restart and others.  For our configuration, its launch parameters are as follows: <code>run_hlstats start &lt; &gt; &lt; &gt; &lt;   &gt;</code> - this is why in the settings of our game servers, in the logaddress_add parameters, the port numbers must go in series - 27500 for the first server and 27501 for the second .  We start. </p><br><pre> <code class="bash hljs"> $ ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/scripts/run_hlstats start 2 27500 1</code> </pre> <br><p>  Something like this should appear on the screen: </p><br><pre> <code class="hljs coffeescript"> HLstatsX:CE daemon control http:<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>www.hlxce.com --------------------------- Attempting to start HLstatsX:CE daemon <span class="hljs-literal"><span class="hljs-literal">on</span></span> port <span class="hljs-number"><span class="hljs-number">27500.</span></span>.. Daemon successfully started <span class="hljs-literal"><span class="hljs-literal">on</span></span> port <span class="hljs-number"><span class="hljs-number">27500</span></span> Attempting to start HLstatsX:CE daemon <span class="hljs-literal"><span class="hljs-literal">on</span></span> port <span class="hljs-number"><span class="hljs-number">27501.</span></span>.. Daemon successfully started <span class="hljs-literal"><span class="hljs-literal">on</span></span> port <span class="hljs-number"><span class="hljs-number">27501</span></span></code> </pre> <br><p>  And in the ~ / log / hlstats directory there were two files with logs (for each daemon its own).  We look at the first log: </p><br><pre> <code class="hljs sql"> 2014-01-24 14:24:16: - MYSQL: Connecting to MySQL database 'hlx_db' on 'localhost' as user 'hlx_user' ... connected ok 2014-01-24 14:24:16: - CONFIG: Reading database config... 2014-01-24 14:24:16: - CONFIG: I have found the following server configs in database: 2014-01-24 14:24:16: - ERROR: GeoIP method <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-built_in"><span class="hljs-built_in">binary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> lookup but .//GeoLiteCity/GeoLiteCity.dat <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>: - HLSTATSX: HLstatsX:CE <span class="hljs-number"><span class="hljs-number">1.6</span></span><span class="hljs-number"><span class="hljs-number">.19</span></span> starting... <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>: - UDP: Opening UDP listen socket <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> port <span class="hljs-number"><span class="hljs-number">27500</span></span> ... ok <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>: - HLSTATSX: Maximum Skill <span class="hljs-keyword"><span class="hljs-keyword">Change</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> all servers <span class="hljs-keyword"><span class="hljs-keyword">are</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> points <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>: - HLSTATSX: <span class="hljs-keyword"><span class="hljs-keyword">Tracking</span></span> Trend <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the stats <span class="hljs-keyword"><span class="hljs-keyword">are</span></span> enabled <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>: - HLSTATSX: <span class="hljs-keyword"><span class="hljs-keyword">Minimum</span></span> Skill <span class="hljs-keyword"><span class="hljs-keyword">Change</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> all servers <span class="hljs-keyword"><span class="hljs-keyword">are</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> points <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>: - HLSTATSX: <span class="hljs-keyword"><span class="hljs-keyword">Minimum</span></span> Players Kills <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> all servers <span class="hljs-keyword"><span class="hljs-keyword">are</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> kills <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>: - HLSTATSX: Players chat <span class="hljs-keyword"><span class="hljs-keyword">logging</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> enabled <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>: - HLSTATSX: Broadcasting <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> chat <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> disabled <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>: - HLSTATSX: <span class="hljs-keyword"><span class="hljs-keyword">Event</span></span> queue <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>: - HLSTATSX: HLstatsX:CE <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span> running (<span class="hljs-keyword"><span class="hljs-keyword">Normal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mode</span></span>, debug <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  Swearing about GeoIP is normal, later we will tell the statistics server that the information is stored in the database, and not in an external file. </p><br><p>  Now it is necessary to provide some kind of motion on our game servers - so that something is written to the logs.  The easiest way to join the server.  If at the same time in the logs all the same every two minutes begins to appear </p><br><pre> <code class="hljs css"> 2014<span class="hljs-selector-tag"><span class="hljs-selector-tag">-01-24</span></span> 15<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:21</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:33</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">HLSTATSX</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">No</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">since</span></span> 120 <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span> 2014<span class="hljs-selector-tag"><span class="hljs-selector-tag">-01-24</span></span> 15<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:23</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:33</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">HLSTATSX</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">No</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">since</span></span> 120 <span class="hljs-selector-tag"><span class="hljs-selector-tag">seconds</span></span></code> </pre> <br><p>  either the game server is not running (or running but not this or not) or something with settings ‚Äî first of all ip: port (if you specified ip 127.0.0.1 in the server settings, logaddress_add, then try to fix it with an external ), secondly, whether our logs are included at all, if so, where they are transmitted.  Well, we can not exclude the influence of evil forces - the same firewall.  With the correct settings, running <code>netstat -lpn | grep perl</code>  <code>netstat -lpn | grep perl</code> should output something like: </p><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">udp</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.0:27500</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span>:* <span class="hljs-number"><span class="hljs-number">15855</span></span>/perl udp <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.0:27501</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span>:* <span class="hljs-number"><span class="hljs-number">15861</span></span>/perl</code> </pre> <br><p>  If after connecting to the server, the lines in the log ran: </p><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - E997: <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> ALLOWED <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>:  <span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>/<span class="hljs-number"><span class="hljs-number">2014</span></span> - <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>: "Ich&lt;4&gt;&lt;[U:1:123456789]&gt;&lt;&gt;" connected, address "198.51.100.0:44098" <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - E997: <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> ALLOWED <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>:  <span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>/<span class="hljs-number"><span class="hljs-number">2014</span></span> - <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>: "Ich&lt;4&gt;&lt;[U:1:123456789]&gt;&lt;&gt;" STEAM USERID validated</code> </pre> <br><p>  That is good.  HLstatsX receives logs from the server, but since we have not yet configured the statistics server itself - in particular, we have not registered our game server there, it does not recognize it. </p><br><p>  In case of errors like "Can't setup UDP socket on port 27500: Address already in use", use the <code>netstat -lpn</code> utility to determine the culprit <code>netstat -lpn</code> </p><br><p>  So, we‚Äôve finished with the most interesting, now let's move on to setting up the statistics server. </p><br><h2 id="registraciya-serverov">  Server registration </h2><br><p>  Open our server in the browser - <a href="http://stat.example.org/">http://stat.example.org/</a> </p><br><p>  On the screen a warning about checking for updates, click on the link <a href="http://stat.example.org/hlstats.php%3Fmode%3Dupdater">HLX: CE Database Updater</a> , we see a notification that "Your database is up to date (78)", delete the updater folder: </p><br><pre> <code class="bash hljs"> $ rm -rf /var/www/stat.example.org/htdocs/updater</code> </pre> <br><p>  Again, go to <a href="http://stat.example.org/">http://stat.example.org/</a> , see the Google Map and at the very bottom of the page click on the link "[Admin]", enter the default login and password, admin: 123456. First of all, go to General Settings -&gt; Admin Users .  We change the administrator password and, optionally, his login.  [Apply].  Then we start slowly setting up. </p><br><p>  We register our servers.  Go to Game Settings -&gt; Team Fortress 2 (tf) -&gt; Add Server, enter the data for the first server: </p><br><p> <code>Server IP Address:</code> <br>  Our server IP is 192.0.2.0 <br> <code>Server Port:</code> <br>  server port - 27015 - the '-port' parameter from the srcds_run command line <br> <code>Server Name:</code> <br>  can be left blank, will determine <br> <code>Rcon Password:</code> <br>  specify the same as in rcon_password in the settings of the first server <br> <code>Public Address:</code> <br>  leave blank - it matches the Server IP Address <br> <code>Admin Mod:</code> <br>  we only have SourceMod installed, and choose it. </p><br><p>  Next [Add Server], [Apply].  Restart the daemon - go to the proposed <a href="http://stat.example.org/hlstats.php%3Fmode%3Dadmin%26task%3Dtools_perlcontrol">link</a> , specify the port number - for the first server 27500, for the second 27501, click 'Execute'. </p><br><p>  See the result: </p><br><pre> <code class="hljs vhdl"> HLstatsX: CE Daemon Control Sending Command <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> HLstatsX: CE Daemon at localhost:<span class="hljs-number"><span class="hljs-number">27500</span></span> ‚Äî <span class="hljs-number"><span class="hljs-number">50</span></span> bytes OK Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Backend Answer...recieving <span class="hljs-number"><span class="hljs-number">29</span></span> bytes <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> packets...OK Backend Answer: OK, EXECUTING COMMAND: RELOAD Closing connection <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> backend...OK <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Administration Center</code> </pre> <br><p>  If everything is done correctly, then the first daemon <code>~/log/hlstats/hlstats_27500&lt;...&gt;</code> log will be updated: </p><br><pre> <code class="hljs sql"> 2016-10-12 21:43:48: - PROXY, Reload request from 127.0.0.1:43992: 2016-10-12 21:43:49: - CONTROL: Command received: RELOAD 2016-10-12 21:43:49: 127.0.0.1:43992 - CONTROL: Sent 29 bytes to frontend at '127.0.0.1:43992' 2016-10-12 21:43:49: 127.0.0.1:43992 - CONTROL: Re-Reading Configuration by request from Frontend... 2016-10-12 21:43:49: 127.0.0.1:43992 - CONFIG: Reading database config... 2016-10-12 21:43:49: 127.0.0.1:43992 - CONFIG: I have found the following server configs in database: 2016-10-12 21:43:49: 127.0.0.1:43992 - S_CONFIG: 192.0.2.0:27015 2016-10-12 21:43:49: 127.0.0.1:43992 - ERROR: GeoIP method <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-built_in"><span class="hljs-built_in">binary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> lookup but .//GeoLiteCity/GeoLiteCity.dat <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>: - HLSTATSX: <span class="hljs-keyword"><span class="hljs-keyword">Insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> trend <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>: - HLSTATSX: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> since <span class="hljs-number"><span class="hljs-number">120</span></span> seconds <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>: Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> rcon <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> ... ok <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - TRCON: Trying <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> rcon <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> (auth) <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - TRCON: Junk packet <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Source</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Engine</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - TRCON: Rcon <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> accepted <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> running <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>: cp_granary <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>: Ingame-<span class="hljs-keyword"><span class="hljs-keyword">URL</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">http</span></span>://stat.example.org <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Query</span></span> results will displayed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> valve browser <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>: Showing stats <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> enabled <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>: <span class="hljs-number"><span class="hljs-number">192.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">27015</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>: Broadcasting Live-<span class="hljs-keyword"><span class="hljs-keyword">Events</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-string"><span class="hljs-string">"hlx_sm_psay"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> enabled</code> </pre> <br><p>  Everything, the first server is recognized as native, the rcon password is correct, the connection is established. </p><br><p>  Similarly, we write the second server. </p><br><p> <code>Server IP Address:</code> <br>  192.0.2.0 <br> <code>Server Port:</code> <br>  27016 (!) <br> <code>Server Name:</code> <br>  is empty <br> <code>Rcon Password:</code> <br>  specify the same as in rcon_password in the settings of the second server <br> <code>Public Address:</code> <br>  is empty <br> <code>Admin Mod:</code> <br>  Sourcemod </p><br><p>  Next [Add Server], check the details. </p><br><p>  A small moment that we can apply to the second server.  During the period of trial operation, to check the operation of the statistics server, its further configuration and the search for possible problems, it is desirable that data be accumulated.  Since it is hardly worth expecting that 24 players will fly to our fresh server like flies, and they will immediately start generating statistics on us, then you will have to do with improvised material - bots.  How to populate the map with young, energetic bots is described in the "Bots" section, but for now when registering the second server, in the window before the final "[Apply]" we look for the "IgnoreBots" parameter and change its value to "0".  Then, for the second game server, bots will be counted as real players and statistics will be kept on them (nothing, but just to be).  Subsequently, before launching into production, we will reset all statistics of the second server and start life from scratch.  In the meantime, we will assume that on the second server we have a koth_sawmill map, on which bots run. </p><br><p>  If the moral core inside does not allow to descend to this, then you can change another parameter on the same server registration page, "MinPlayers", by setting it to "1".  By default, the rating of the players begins to be considered when there are at least four people on the map.  This was done to reduce markups on empty cards, but now we reduce the threshold to one - ourselves. </p><br><blockquote>  Then, when you need to return everything back, we can get to this window through the Game Settings section - Team Fortress 2 (tf) - Edit Servers - (select the server you need) - CONFIGURE - &gt;&gt; Server Details, return as it was.  Then [Apply] and do not forget to restart the daemon. </blockquote><p>  Now restart the HLstatsX daemon to apply the settings for registering the second server.  It is possible through the web interface, not forgetting to specify another port - 27501, but you can use handles: </p><br><pre> <code class="bash hljs"> $ ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/scripts/run_hlstats reload</code> </pre> <br><pre> <code class="hljs mel"> HLstatsX:CE daemon <span class="hljs-keyword"><span class="hljs-keyword">control</span></span> http:<span class="hljs-comment"><span class="hljs-comment">//www.hlxce.com --------------------------- Successfully reloaded daemon running on port 27500 Successfully reloaded daemon running on port 27501</span></span></code> </pre> <br><p>  In the browser we update the page <a href="http://stat.example.org/">http://stat.example.org/</a> , we see on the main page both our servers.  We are happy. </p><br><p>  We enter the game, join our server.  In the chat window ("y") enter "hlx_menu".  A menu appears.  You can learn :-) </p><br><h2 id="nachalnaya-nastroyka">  Initial setup </h2><br><p>      .       General Settings -&gt; HLstatsX:CE Settings: </p><br><p> <code>Site Name</code> <br>     ‚Äî HLstatsX at example.org </p><br><p> <code>Site URL</code> <br> URL  ,         ‚Äî <a href="http://stat.example.org/">http://stat.example.org/</a> </p><br><p> <code>Contact URL</code> <br>  , e-mail  url ‚Äî game@example.org </p><br><p> <code>Use modrewrite to make forum signature image...</code> <br>    Disabled,           <a href="http://stat.example.org/sig.php%3Fplayer_id%3D1%26amp%3Bbackground%3Drandom">http://stat.example.org/sig.php?player_id=1&amp;background=random</a> .     url  ,     Enabled    <code>rewrite sig-(.*)-(.*).png$ /sig.php?player_id=$1&amp;background=$2 break;</code>    nginx    (       -).    url  <a href="">http://stat.example.org/sig-1-random.png</a> . </p><br><p> <code>Choose whether to use GeoCityLite data...</code> <br>   GeoIP .            sql ,    "GeoIP lookup via database".    run_hlstats. </p><br><p> <code>Map Download URL...</code> <br>   ,      .   Fast Download,   -  <a href="">http://fastdl.example.org/maps/%MAP%.bsp.bz2</a> .    ,       Maps -&gt; <code>&lt; &gt;</code> ,        "Download this map...",     ,     url (    ).       .    .   Fast Download   -  ,       "",   referer. </p><br><p> ?   [Apply], ,     GeoIP ,    . </p><br><p>    HLstatsX,        ,      ~/stat/scripts/logs,    hlstats.conf  "DebugLevel"   "0". </p><br><h2 id="oshibki">  Errors </h2><br><p>         - ‚Äî ~/log/www-stat/error.log.  : </p><br><pre> <code class="hljs vbscript"> PHP Fatal <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> undefined <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> imagecreatetruecolor() <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;...&gt;/show_graph.php <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> line <span class="hljs-number"><span class="hljs-number">194</span></span></code> </pre> <br><p>    php-gd   php,  -. </p><br><pre> <code class="hljs vbscript"> PHP Fatal <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> undefined <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> imageftbbox() <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;...&gt;/pChart.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> line <span class="hljs-number"><span class="hljs-number">556</span></span></code> </pre> <br><p> ,   freetype. </p><br><pre> <code class="hljs pgsql"> PHP <span class="hljs-built_in"><span class="hljs-built_in">Warning</span></span>: imagepng(./hlstatsimg/progress/trend_123_4567890987.png): failed <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> stream: Permission denied <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /var/www/stat.example.org/htdocs/includes/pChart/pChart.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span></code> </pre> <br><p>  -     hlstatsimg/progress. </p><br><pre> <code class="hljs pgsql"> PHP <span class="hljs-built_in"><span class="hljs-built_in">Warning</span></span>: session_start(): <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(/var/lib/php/<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>/sess_m5ekot332e5k97au3a21hpqto6, O_RDWR) failed: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> such file <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> directory (<span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br><p>    /var/lib/php/session,    "php_value[session.save_path]"  /etc/php-fpm.d/www.conf ‚Äî   php-fpm, ,     , - root: </p><br><pre> <code class="dos hljs"> # <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> /var/lib/php/session # chown nginx. /var/lib/php/session # chmod -R <span class="hljs-number"><span class="hljs-number">700</span></span> /var/lib/php/session</code> </pre> <br><h2 id="teplovye-karty">   </h2><br><p>     .    <a href="https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/downloads">https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/downloads</a>   dev / HLstatsX Community Edition / extras / HeatmapPack /  heatmap-src_3.zip </p><br><pre> <code class="bash hljs"> $ wget https://bitbucket.org/Maverick_of_UC/hlstatsx-community-edition/raw/0577b45e5f33df4e2a6122077fa44902073a8844/extras/HeatmapPack/heatmap-src_3.zip $ unzip heatmap-src_3.zip tf/*.jpg -d ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/heatmaps/src</code> </pre> <br><p>  ~/stat/heatmaps/src   tf   .jpg  ‚Äî    .  65 , 32    Team Fortress 2 (   ),  33 ‚Äî   .  ,    .   ,      . </p><br><p>   ~/stat/heatmaps,   config.inc.php.   DB_      ,  HLXCE_WEB     -  ‚Äî     hlstatsimg.  ,  OUTPUT_SIZE       "large".  DB_PREFIX  ! , - : </p><br><pre> <code class="hljs scala"> define(<span class="hljs-symbol"><span class="hljs-symbol">'DB_HOS</span></span>T', <span class="hljs-symbol"><span class="hljs-symbol">'localhos</span></span>t'); define(<span class="hljs-symbol"><span class="hljs-symbol">'DB_USE</span></span>R', <span class="hljs-symbol"><span class="hljs-symbol">'hlx_use</span></span>r'); define(<span class="hljs-symbol"><span class="hljs-symbol">'DB_PAS</span></span>S', <span class="hljs-symbol"><span class="hljs-symbol">'hlx_passwor</span></span>d'); define(<span class="hljs-symbol"><span class="hljs-symbol">'DB_NAM</span></span>E', <span class="hljs-symbol"><span class="hljs-symbol">'hlx_d</span></span>b'); define(<span class="hljs-symbol"><span class="hljs-symbol">'HLXCE_WE</span></span>B', '/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/stat.example.org/htdocs'); define(<span class="hljs-symbol"><span class="hljs-symbol">'HUD_UR</span></span>L', <span class="hljs-symbol"><span class="hljs-symbol">'http</span></span>:<span class="hljs-comment"><span class="hljs-comment">//stat.example.org');</span></span></code> </pre> <br><p>   cache/tf ‚Äî    </p><br><pre> <code class="bash hljs"> $ mkdir -p ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/heatmaps/cache/tf</code> </pre> <br><p>    ,    /var/www/stat.example.org/htdocs/hlstatsimg/games/tf  game (    ). </p><br><p>   heatmap.class.php       : </p><br><pre> <code class="bash hljs"> $ sed -i -es<span class="hljs-comment"><span class="hljs-comment">#"m/d/y"#"d M Y"#g ~/stat/heatmaps/heatmap.class.php $ sed -i -es#"Ymd H:i:s"#"d MYH:i:s P"#g ~/stat/heatmaps/heatmap.class.php</span></span></code> </pre> <br><p>  Run: </p><br><pre> <code class="bash hljs"> $ ~/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/heatmaps/generate.php</code> </pre> <br><p>    ,            koth_sawmill  .         (  ): </p><br><pre> <code class="hljs vhdl"> <span class="hljs-number"><span class="hljs-number">25</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> DB: Connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> hlx_db as hlx_user@localhost <span class="hljs-number"><span class="hljs-number">25</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span> IGNORE: Game: tf, <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span>: cp_warpath_v3, Kills: <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> few kills) <span class="hljs-number"><span class="hljs-number">25</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span> IGNORE: Game: tf, <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span>: cp_wolf2_b1, Kills: <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> few kills) <span class="hljs-number"><span class="hljs-number">25</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span> IGNORE: Game: tf, <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span>: koth_nucleus, Kills: <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> few kills) <span class="hljs-number"><span class="hljs-number">25</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span> CREATE: Game: tf, <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span>: koth_sawmill, Kills: <span class="hljs-number"><span class="hljs-number">2014</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span> IGNORE: Game: tf, <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span>: koth_viaduct, Kills: <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> few kills) <span class="hljs-number"><span class="hljs-number">25</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span> CREATE: Heatmap creation done.</code> </pre> <br><p>    /var/www/stat.example.org/htdocs/hlstatsimg/games/tf/heatmaps     ‚Äî koth_sawmill-kill.jpg  koth_sawmill-kill-thumb.jpg. </p><br><p>    ,  ,  ,            .        Maps,     koth_sawmill,       ,          TOTAL KILLS: </p><br><p><img src="https://habrastorage.org/files/0a4/31d/dda/0a431dddaaf84ba38c11b664421a1961.jpg" alt=" "></p><br><p>         .     <code>$timescope = (time() - 60*60*24*$mapinfo[$code][$map]['days']);</code>  heatmap.class.php, ,   ,  "days"  sql  hlstats_Heatmap_Config,      "30". </p><br><p>     ,      ,     ,     .jpg     .        hlstats_Heatmap_Config  sql . </p><br><h2 id="avtomaticheskiy-zapusk">   </h2><br><p>     HLstatsX.     : </p><br><p> <code>run_hlstats</code> <br>  ,    ; </p><br><p> <code>hlstats-awards.pl</code> <br>  ,  ,       sql  ; </p><br><p> <code>hlstats-resolve.pl</code> <br>   ip-    ; </p><br><p> <code>GeoLite_Import.sh</code> <br>    geoip ; </p><br><p> <code>generate.php</code> <br>   . </p><br><p>      -  game,       crontab  (       ),                   .  <code>crontab -e</code> , : </p><br><div class="spoiler"> <b class="spoiler_title">crontab</b> <div class="spoiler_text"><pre> <code class="hljs bash">*/5 * * * * <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/scripts &amp;&amp; ./run_hlstats start 2 27500 1 1 0 * * * <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/scripts &amp;&amp; ./hlstats-awards.pl 5 4 * * * <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/scripts &amp;&amp; ./hlstats-resolve.pl 20 2 12 * * <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/scripts/GeoLiteCity/ &amp;&amp; ./GeoLite_Import.sh 30 2 12 * * <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/scripts &amp;&amp; ./hlstats-awards.pl --geoip 40 3 14 * * <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/scripts &amp;&amp; ./hlstats-awards.pl --optimize 15 * * * * <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/<span class="hljs-built_in"><span class="hljs-built_in">stat</span></span>/heatmaps &amp;&amp; ./generate.php</code> </pre> </div></div><br><p>   ‚Äî      run_hlstats      .   -,     .     . </p><br><p>   ‚Äî      hlstats-awards.pl,       --inactive --awards --ribbons --prune      . </p><br><p>   ‚Äî      hlstats-resolve.pl,   ip           ,  Tools -&gt; Host Statistics    .        ‚Äî      ,    ip   . </p><br><p>   ‚Äî      GeoIP. </p><br><p>   ‚Äî   GeoIP,  ip-           . </p><br><p>   ‚Äî      sql  . </p><br><p>  ‚Äî       . </p><br><p>    cron  ,   game    "" </p><br><h2 id="tyuning">  Tuning </h2><br><h3 id="shrifty">  Fonts </h3><br><p>    ,    ,   DejaVu Sans,    ,        Unicode,       ,   ,    -  .     <a href="https://en.wikipedia.org/wiki/Bitstream_Cyberbit">Bitstream Cyberbit</a>             . </p><br><pre> <code class="bash hljs"> $ wget http://ftp.netscape.com/pub/communicator/extras/fonts/windows/Cyberbit.ZIP $ unzip Cyberbit.ZIP -d /var/www/stat.example.org/htdocs/hlstatsimg/sig/font/</code> </pre> <br><p>  DejaVuSans.ttf    .php ,    Cyberbit.ttf  DejaVuSans.ttf,   : </p><br><pre> <code class="bash hljs"> $ sed -i -e <span class="hljs-string"><span class="hljs-string">'s/DejaVuSans.ttf/Cyberbit.ttf/g'</span></span> /var/www/stat.example.org/htdocs/*.php</code> </pre> <br><p>     : </p><br><p><img src="https://habrastorage.org/files/52d/7b5/7ae/52d7b57aedd9474aa59d0cc6f927744c.png" alt="  "></p><br><h3 id="prevyu-karty">  Card preview </h3><br><p>        Maps -&gt; &lt; &gt;,          .             ,    ( !)   , ,    218x164     &lt; &gt;.jpg   /var/www/stat.example.org/htdocs/hlstatsimg/games/tf/maps.     cp_orange_x3     cp_orange_x3.jpg   : </p><br><p><img src="https://habrastorage.org/files/e3d/cc0/187/e3dcc01877f64481b19c172ad55b2ddd.png" alt="Card preview"></p><br><h3 id="razdelnyy-uchyot-statistiki">  Separate accounting statistics </h3><br><p>   ,      (Team Fortress 2),       ,             ,         .     ,    , Tools -&gt; Duplicate Game settings     "tf ‚Äî Team Fortress 2"  .    -     hlstatsimg/games: <code>chmod o+w /var/www/stat.example.org/htdocs/hlstatsimg/games</code> .     ,   Game Settings         . </p><br><h3 id="otklyuchenie-statistiki">  Disable statistics </h3><br><p>       -       ‚Äî   ,     achievement         ‚Ä¶ ,   ~/cfg   &lt; &gt;.cfg (       ~/tf2/tf/cfg/)  : </p><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">echo</span></span> <span class="hljs-string"><span class="hljs-string">"*** &lt; &gt;.cfg"</span></span> logaddress_delall</code> </pre> <br><p>                  (   ~/log/server2/   ).     ,          ~/cfg/server2.cfg,    .     "hlx_protect_address"    ,        . </p><br><h3 id="ogranichenie-dostupa">   </h3><br><p>           HTTP Basic Authentication  -,     ,              motd ,    "/hlx".         ingame.php   .png, .gif, .css </p><br><h3 id="novoe-oruzhie">  New weapon </h3><br><p>          Game Settings, Team Fortress 2 (tf),  Actions  Weapons.        ,    ,      HLstatsX. </p><br><h3 id="vosstanovlenie-parolya">  Password recovery </h3><br><p>          HLstatsX,       (admin:123456),   ,    .     ~/stat/sql/install.sql,     </p><br><pre> <code class="hljs sql"> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`hlstats_Users`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'admin'</span></span>,<span class="hljs-string"><span class="hljs-string">'e10adc3949ba59abbe56e057f20f883e'</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><p>  -     ,  reset_pwd.sql     sql : </p><br><pre> <code class="bash hljs"> $ mysql --user=hlx_user hlx_db --password &lt; reset_pwd.sql</code> </pre> <br><p>         -   (admin:123456)   General Settings -&gt; Admin Users   . </p><br><ul><li> <a href="https://habrahabr.ru/post/312922/"> 1</a> ‚Äî   Steam   Team Fortress 2,  ,  </li><li> <a href="https://habrahabr.ru/post/312928/"> 2</a> ‚Äî  (Replay), SourceTV, Fast Download,  </li><li> <a href="https://habrahabr.ru/post/312934/"> 3</a> ‚Äî  MetaMod  SourceMod,  , ,  Steam  <del>  Quickplay </del></li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/312936/">https://habr.com/ru/post/312936/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312926/index.html">Launch i2pd in the Docker container on CentOS 7</a></li>
<li><a href="../312928/index.html">Setting up a dedicated Source server for Linux, part 2</a></li>
<li><a href="../312930/index.html">What is new in licensing Windows Server 2016 and how can you avoid unnecessary expenses?</a></li>
<li><a href="../312932/index.html">Algorithm of reading books on programming</a></li>
<li><a href="../312934/index.html">Setting up a dedicated Source server for Linux, part 3</a></li>
<li><a href="../312940/index.html">Free courses, books and other development materials</a></li>
<li><a href="../312942/index.html">What's new in Swift 3?</a></li>
<li><a href="../312948/index.html">How I created seamless Wi-Fi</a></li>
<li><a href="../312950/index.html">Simplicity criteria</a></li>
<li><a href="../312952/index.html">Entertaining task ‚ÄúUnlucky Ticket‚Äù (Elixir edition)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>