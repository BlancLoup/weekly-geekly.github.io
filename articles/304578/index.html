<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automation in JunOS: writing scripts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the life of every system administrator, there are times when it becomes necessary to automate the execution of some operations, or, for example, on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automation in JunOS: writing scripts</h1><div class="post__text post__text-html js-mediator-article">  In the life of every system administrator, there are times when it becomes necessary to automate the execution of some operations, or, for example, one has to delegate part of his authority to subordinates.  Moreover, it is desirable to do it safely, and minimize the ability to mow.  Well, if we are talking about a server running * NIX-systems - there are a great many tools designed for this.  But not always so lucky ... <a name="habracut"></a><br><br>  It would seem that a rather trivial task is to enable the junior technical staff to hang and remove the blackhole community on routers running JunOS in the simplest way possible.  Everything would be fine, but bash + ssh + expect didn't suit me very much, perl + Net :: OpenSSH / Net :: SSH / etc - too.  In the process of thinking about the task, I remembered Tcl in IOS, and it turned out that JunOS also has its own similar automation tools, elegant and really powerful, and, as for me, more convenient than Tcl.  And the most surprising thing is that for some reason I did not find Google in runet. <br><br>  Well, let me try to fill this gap, at least for general education, in a volume that allows one to appreciate the "beauty of the game."  So, JunOS has a built-in ability to write your own scripts and then use them as usual commands, like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> / * Create a new entry establishing the blackhole community * /
 user @ junosbox&gt; op blackhole set 10.0.0.1 </pre><br>  Agree, it is much more convenient than to enter configuration mode, manually create routes, hang community on them and commit the changes.  To err in the case of performing these actions using a script is much less likely.  In addition, in the script, you can perform all the necessary checks so that the operator does not perform anything unnecessary. <br><br>  This feature is provided by the JunOS Automation Tool Kit, which allows you to use the JunOS XML built-in capabilities, which is a standard JunOS component and, accordingly, is present on any device running JunOS.  The main tool for this is the XSLT scripting language.  And this, I think, is bad news - writing on it is, of course, more convenient than on Brainfuck, but still somewhat peculiar.  But there is news and good: to simplify the life of administrators, the guys from Juniper Networks also implemented support for SLAX.  In JunOS up to version 11, SLAX 1.0 is supported, in the newer ones - 1.1.  The documentation mentions that its syntax somewhat resembles perl.  This statement seems somewhat controversial to me, but definitely, there is some distant similarity, so leave this point on the conscience of the authors of the documentation. <br><br>  JunOS has several script classes: <br><br><ul><li>  <b>commit</b> - used to automate the process of commit ‚Äî for example, to check whether changes in the configuration correspond to some rules and output messages and interrupt commit if any problems are detected;  when you call commit, all active commit scripts are executed in turn; </li><li>  <b>op</b> - scripts in the usual understanding of the system administrator - are used to perform the standard sequence of actions, change the format of the output of commands, etc .; </li><li>  <b>event</b> - scripts triggered by the occurrence of some events; </li><li>  <b>SNMP</b> - scripts called when accessing an SNMP agent system </li></ul><br>  Obviously, op-scripts are the most popular, although others can also be used. <br><br>  To install the script in the system, copy it to the appropriate subdirectory of the <b>/ var / db / scripts</b> directory, then execute the command <b>edit system scripts <i>type</i> file <i>filename</i></b> to activate it.  After activating the script, it can be invoked like any other command allowed by the user in operation mode: <b>op <i>filename arguments</i></b> .  It's nice that the valid parameters of the activated CLI script by pressing "?"  Shows exactly the same as for built-in system commands.  Help is displayed in the same way, if it is provided for: <br><br><pre>  user @ junosbox&gt; op blackhole?
 Possible completions:
   &lt;[Enter]&gt; Execute this command
   &lt;name&gt; Argument name
   detail display detailed output
   set set blackhole community for ip address
   |  Pipe through a command </pre><br>  Of course, the institution of the user and empowering him with the rights necessary to run the script is the task of the administrator.  But she, as a matter of fact, is well documented and every one has come across it at least once. <br><br>  So up to this point, everything seems to be quite simple.  The nuances begin with the writing of the script: the examples from the documentation are somewhat useless, since they implement things that are no less conveniently performed by the built-in commands.  Therefore, let me draw your attention to some points to which the authors of the documentation have paid insufficient attention, but in real life they matter: <br><br><ol><li>  Remember, JunOS is XML.  The most necessary command when writing scripts is <b>show configuration ... |</b>  <b>display xml</b> .  This is the only way to understand which templates and parameters should be used to build a new configuration or make changes to the existing one; </li><li>  Documentation is not always true.  For example, in SLAX 1.0 it.  JunOS did not succeed in declaring a function by using &lt;func: function&gt;, since the interpreter cursed all references to ‚Äúvar‚Äù, ‚Äúparam‚Äù, etc. within it.  At the same time, a similar result was obtained by using custom templates, about which nothing is written in the documentation of Juniper Networks (see example); </li><li>  In functions, the order of the arguments is important;  in templates it does not matter - here their name is important (again, see example); </li><li>  In XSLT and SLAX it is very bad with variable reuse - the value of a variable, once assigned, cannot change in the general case.  Theoretically, this question is removed using mvar (mutable var) instead of var to declare variables, but in some situations their behavior becomes strange (the assigned values ‚Äã‚Äãare lost).  Therefore, since the documentation says that a lot of variables are normal and you just need to take note of this nuance of the syntax, you should probably do so. </li></ol><br>  Well, and finally: <br><br><div class="spoiler">  <b class="spoiler_title">Example - op / blackhole.slax</b> <div class="spoiler_text"><pre> version 1.0;

 ns junos = "http://xml.juniper.net/junos/*/junos";
 ns xnm = "http://xml.juniper.net/xnm/1.1/xnm";
 ns jcs = "http://xml.juniper.net/junos/commit-scripts/1.0";
 ns ext = "http://xmlsoft.org/XSLT/namespace";
 import "../import/junos.xsl";

 var $ arguments = {
   &lt;argument&gt; {
     &lt;name&gt; "set";
     &lt;description&gt; "Set blackhole community for IP address";
   }
 }
 param $ set;

 match / {
   &lt;op-script-results&gt; {
     var $ instance = "INSTANCE";
     var $ community = "65535: 666";
     if ($ set) {
       var $ addr = jcs: parse-ip ($ set);
       var $ ip = $ addr [1] _ "/ 32";
       var $ connection = jcs: open ();
       call set_community ($ connection, $ ip, $ instance, $ community);
       var $ close-results = jcs: close ($ connection);
       if ($ close-results) {expr jcs: output ($ close-results);  }
     }
     else {
       call show_community ($ community);
     }
   }
 }

 template set_community ($ connection, $ ip, $ instance, $ community) {
   var $ configuration = &lt;configuration&gt; {
     &lt;routing-instances&gt; {
       &lt;instance&gt; {
         &lt;name&gt; $ instance;
         &lt;routing-options&gt; {
           &lt;static&gt; {
             &lt;route&gt; {
               &lt;name&gt; $ ip;
               &lt;discard&gt;;
               &lt;community&gt; {&lt;name&gt; $ community;  }
             }
           }
         }
       }
     }
   }
   var $ commit-options: = {&lt;commit-options&gt; {&lt;log&gt; "setting blackhole community for" _ $ ip;  }}
   var $ results: = {call jcs: load-configuration ($ connection, $ configuration, $ commit-options);  }
   copy-of $ results;
 }

 template show_community ($ community) {
   var $ command = {&lt;command&gt; "show route community" _ $ community;  }
   var $ results = jcs: invoke ($ command);
   copy-of $ results;
 }
</pre></div></div><br>  References: <br><br><ul><li>  The SLAX Language - <a href="http://www.libslax.org/the-slax-language">www.libslax.org/the-slax-language</a> ; </li><li>  Automation Scripting Feature Guide - <a href="http://www.juniper.net/techpubs/en_US/junos15.1/information-products/pathway-pages/config-guide-automation/config-guide-automation.html">www.juniper.net/techpubs/en_US/junos15.1/information-products/pathway-pages/config-guide-automation/config-guide-automation.html</a> ; </li><li>  JunOS Automation Reference For SLAX 1.0 - <a href="http://www.hiphop-resistance.com/juniperdayone/TW_Junos%2520Auto%2520Reference.pdf">www.hiphop-resistance.com/juniperdayone/TW_Junos%20Auto%20Reference.pdf</a> ; </li><li>  SLAX Syntax Coloring For Vim - <a href="https://github.com/scottdware/vim-slax">github.com/scottdware/vim-slax</a> . </li></ul></div><p>Source: <a href="https://habr.com/ru/post/304578/">https://habr.com/ru/post/304578/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../304568/index.html">6 reasons to explain to a child the basics of information security</a></li>
<li><a href="../304570/index.html">Spark Summit 2016: review and experience</a></li>
<li><a href="../304572/index.html">SuggestBundle or drop-down ajax lists in symfony</a></li>
<li><a href="../304574/index.html">NW.js or Electron?</a></li>
<li><a href="../304576/index.html">Standardization of records</a></li>
<li><a href="../304580/index.html">Security Week 26: Dumping data through a fan, iOS core decrypted, crypto-password on password archives</a></li>
<li><a href="../304582/index.html">The optimal solution for the organization of corporate cloud "turnkey"</a></li>
<li><a href="../304584/index.html">The official HTTP client for Yii 2 has been released</a></li>
<li><a href="../304586/index.html">Core Data + Swift for the smallest: minimum necessary (part 3)</a></li>
<li><a href="../304590/index.html">Optimization of the web service tips for postal addresses and name</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>