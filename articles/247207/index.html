<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Disadvantages when working with translations in Qt and ways to deal with them</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I would like to talk about some of the inconveniences that I encountered when working with the translation system in Qt, and also to s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Disadvantages when working with translations in Qt and ways to deal with them</h1><div class="post__text post__text-html js-mediator-article">  In this article I would like to talk about some of the inconveniences that I encountered when working with the translation system in Qt, and also to share ways to combat these inconveniences. <br><br>  First, let me briefly remind you how the translation system in Qt works. <br><a name="habracut"></a><br>  First of all, the developer, while writing the code, wraps the string that should be translated into different languages ‚Äã‚Äãinto one of the special functions: <br><br><pre><code class="cpp hljs">tr(<span class="hljs-string"><span class="hljs-string">"Push me"</span></span>, <span class="hljs-string"><span class="hljs-string">"button text"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  - . QCoreApplication::translate("console", "Enter a number"); //  - .</span></span></code> </pre> <br>  Further, in the project file, the files are indicated, in which the translator will perform, in fact, the translation itself: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs objectivec">TRANSLATIONS += translations/myapp_ru.ts <span class="hljs-comment"><span class="hljs-comment">//         .</span></span></code> </pre><br>  Then, the <i>lupdate</i> utility is <i>launched</i> , which creates (or updates) the source files of the translations (regular XML files), after which the translator can work with them with the help of a special tool - Qt Linguist.  The lines wrapped in the <i>tr</i> and <i>translate</i> functions will be processed by the utility and added to the .ts files. <br><br>  Finally, when all strings are translated, the <i>lrelease</i> utility is <i>launched</i> , turning the source translation files (.ts) into .qm files that have a special binary format.  Now it remains only to add the following code to the application: <br><br><pre> <code class="cpp hljs">QTranslator *t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QTranslator; t-&gt;load(<span class="hljs-string"><span class="hljs-string">"/path/to/translations/myapp_ru.qm"</span></span>); QApplication::installTranslator(t);</code> </pre><br>  Everything, our lines will be displayed in the desired language. <br><br><h4>  Inconvenience 1: storage of translations </h4><br>  So, well, we translated the string, when the application was launched, we downloaded the translation file, in our text field (or somewhere else) the text appeared in the desired language.  Indeed, in such a trivial case, more is not needed.  However, consider the following example.  Suppose we have a console application that implements the processing of user-entered commands.  New commands can be added by installing a handler function, for example, like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*HandlerFunction)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QStringList &amp;arguments)</span></span></span></span>; QMap&lt;QString, HandlerFunction&gt; handlerMap; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">installHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;command, HandlerFunction f)</span></span></span><span class="hljs-function"> </span></span>{ handlerMap.insert(command, f); }</code> </pre><br>  Everything is fine, but it would be nice if you type, say ¬´help <i>command</i> ¬ª to issue information on the corresponding command <i>command</i> .  We will do: <br><br><pre> <code class="cpp hljs">QMap&lt;QString, QString&gt; helpMap; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">installHelp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;command, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;help)</span></span></span><span class="hljs-function"> </span></span>{ helpMap.insert(command, help); }</code> </pre><br>  Feel trick?  Yes, at first everything will be fine: <br><br><pre> <code class="cpp hljs">installHelp(<span class="hljs-string"><span class="hljs-string">"mycommand"</span></span>, tr(<span class="hljs-string"><span class="hljs-string">"Does some cool stuff"</span></span>));</code> </pre><br>  If QTranslator was set in advance, then we get the translated string.  But what if the user decides to change the language (in other words, another translation file will be loaded)?  The line will remain the same. <br><br>  This problem has several solutions.  I will give a few, including the one that seems to me the most natural and comfortable. <br><br><h5>  Solution 1: Factory </h5><br>  You can replace the string with a factory function that will return the string: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*HelpFactoryFunction)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; QMap&lt;QString, HelpFactoryFunction&gt; helpMap; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">installHelp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;command, HelpFactoryFunction f)</span></span></span><span class="hljs-function"> </span></span>{ helpMap.insert(command, f); }</code> </pre><br>  The factory function and its application may look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">QString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myHelpFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tr(<span class="hljs-string"><span class="hljs-string">"Does some cool stuff"</span></span>); } installHelp(<span class="hljs-string"><span class="hljs-string">"mycommand"</span></span>, &amp;myHelpFactory);</code> </pre><br>  Does this solve the problem?  Yes, the translation will be made every time the help is called, so when the language changes, the help will be shown translated into this new language.  Is this a beautiful solution?  Everyone thinks differently, but I think not. <br><br><h5>  Solution 2: QT_TRANSLATE_NOOP3 </h5><br>  The <i>&lt;QtGlobal&gt;</i> header file contains such a macro, <a href="http://doc.qt.io/qt-5/qtglobal.html">QT_TRANSLATE_NOOP3</a> .  It marks the string wrapped in it to the translation and returns an anonymous structure (struct) containing this string (in untranslated form), as well as a comment.  In the future, the created structure can be used in the functions <i>tr</i> and <i>translate</i> . <br><br>  Do I have to say that the code is cumbersome and ugly?  I think not.  In addition, difficulties arise with the transfer of such a structure as a parameter of the function.  Code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *source; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *comment; } TranslateNoop3; QMap&lt;QString, TranslateNoop3&gt; helpMap; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">installHelp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;command, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> TranslateNoop3 &amp;t)</span></span></span><span class="hljs-function"> </span></span>{ helpMap.insert(command, t); }</code> </pre><br>  Using: <br><br><pre> <code class="cpp hljs">installHelp(<span class="hljs-string"><span class="hljs-string">"mycommand"</span></span>, QT_TRANSLATE_NOOP3(<span class="hljs-string"><span class="hljs-string">"context"</span></span>, <span class="hljs-string"><span class="hljs-string">"Does some cool stuff"</span></span>, <span class="hljs-string"><span class="hljs-string">"help"</span></span>));</code> </pre><br>  That another macro (and another structure), <a href="http://doc.qt.io/qt-5/qtglobal.html">QT_TRANSLATE_NOOP,</a> is used for translation without a comment ‚Äî I am completely silent.  But you would have to fence <i>installHelp</i> overload and turn one structure into another.  Disgusting.  Let's leave it to the conscience of the Qt developers. <br><br><h5>  Solution 3: self-written class wrapper </h5><br>  In a sense, my solution is an improved version of <i>QT_TRANSLATE_NOOP3</i> .  I suggest looking at the code right away: <br><div class="spoiler">  <b class="spoiler_title">translation.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Translation</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: QString context; QString disambiguation; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n; QString sourceText; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Translation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; Translation(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Translation &amp;other); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Translation </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">translate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *sourceText, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *disambiguation = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-function">QString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">translate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Translation &amp;<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> =(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Translation &amp;other); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">operator</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">operator</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QVariant</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> QDataStream &amp;<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &lt;&lt;(QDataStream &amp;stream, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Translation &amp;t); <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> QDataStream &amp;<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &gt;&gt;(QDataStream &amp;stream, Translation &amp;t); }; Q_DECLARE_METATYPE(Translation)</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">translation.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs">Translation::Translation() { n = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } Translation::Translation(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Translation &amp;other) { *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> = other; } Translation Translation::translate(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *context, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *sourceText, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *disambiguation, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) n = <span class="hljs-number"><span class="hljs-number">-1</span></span>; Translation t; t.context = context; t.sourceText = sourceText; t.disambiguation = disambiguation; tn = n; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t; } QString Translation::translate() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QCoreApplication::translate(context.toUtf8().constData(), sourceText.toUtf8().constData(), disambiguation.toUtf8().constData(), n); } Translation &amp;Translation::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> =(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Translation &amp;other) { context = other.context; sourceText = other.sourceText; disambiguation = other.disambiguation; n = other.n; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } Translation::<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">operator</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> translate(); } Translation::<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">operator</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QVariant</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QVariant::fromValue(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } QDataStream &amp;<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &lt;&lt;(QDataStream &amp;stream, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Translation &amp;t) { QVariantMap m; m.insert(<span class="hljs-string"><span class="hljs-string">"context"</span></span>, t.context); m.insert(<span class="hljs-string"><span class="hljs-string">"source_text"</span></span>, t.sourceText); m.insert(<span class="hljs-string"><span class="hljs-string">"disambiguation"</span></span>, t.disambiguation); m.insert(<span class="hljs-string"><span class="hljs-string">"n"</span></span>, tn); stream &lt;&lt; m; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stream; } QDataStream &amp;<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &gt;&gt;(QDataStream &amp;stream, Translation &amp;t) { QVariantMap m; stream &gt;&gt; m; t.context = m.value(<span class="hljs-string"><span class="hljs-string">"context"</span></span>).toString(); t.sourceText = m.value(<span class="hljs-string"><span class="hljs-string">"source_text"</span></span>).toString(); t.disambiguation = m.value(<span class="hljs-string"><span class="hljs-string">"disambiguation"</span></span>).toString(); tn = m.value(<span class="hljs-string"><span class="hljs-string">"n"</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>).toInt(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stream; }</code> </pre><br></div></div><br>  I used the interesting property of <i>lupdate</i> : it does not matter in which namespace the <i>translate</i> function is located, the main thing is that it has exactly such a name, and also that the order of the arguments and their type are as in <i>QCoreApplication :: translate</i> .  In this case, lines wrapped in any <i>translate</i> function will be marked with the translation and added to the .ts file. <br><br>  Then it remains for the small: we implement our static <i>translate</i> method so that it creates an instance of the <i>Translation</i> class, which is in fact a more convenient analogue of the anonymous structure that <i>QT_TRANSLATE_NOOP3</i> returns.  We also add another <i>translate</i> method, but no longer static.  It simply calls inside <i>QCoreApplication :: translate</i> , passing as parameters the context, the source string, and the comment that was specified when calling the static <i>Translation :: translate</i> method.  We add methods for copying and (de) serializing, and we get a convenient container for storing translations.  I will not describe the rest of the class methods, since they are not directly related to the problem being solved and are trivial for developers familiar with C ++ and Qt, for whom this article is intended. <br><br>  Here is how an example would look like with help using <i>Translation</i> : <br><br><pre> <code class="cpp hljs">QMap&lt;QString, Translation&gt; helpMap; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">installHelp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;command, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Translation &amp;help)</span></span></span><span class="hljs-function"> </span></span>{ helpMap.insert(command, help); } installHelp(<span class="hljs-string"><span class="hljs-string">"mycommand"</span></span>, Translation::translate(<span class="hljs-string"><span class="hljs-string">"context"</span></span>, <span class="hljs-string"><span class="hljs-string">"Do some cool stuff"</span></span>));</code> </pre><br>  It looks more natural than a factory, and more beautiful than <i>QT_TRANSLATE_NOOP3</i> , isn't it? <br><br><h4>  Disadvantage 2: translation without inheritance </h4><br>  The second disadvantage I encountered in Qt is the impossibility of dynamically translating an interface without inheriting at least one class.  Consider immediately an example: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **argv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">QApplication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(argc, argv)</span></span></span></span>; QTranslator *t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QTranslator; t-&gt;load(<span class="hljs-string"><span class="hljs-string">"/path/to/translations/myapp_ru.qm"</span></span>); QApplication::installTranslator(t); QWidget *w = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QWidget; w-&gt;setWindowTitle(QApplication::translate(<span class="hljs-string"><span class="hljs-string">"main"</span></span>, <span class="hljs-string"><span class="hljs-string">"Cool widget"</span></span>)); w-&gt;show(); LanguageSettingsWidget *lw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LanguageSettingsWidget; lw-&gt;show(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = app.exec(); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> w; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }</code> </pre><br>  As you can see from the example, we load the translation file, create a <i>QWidget</i> and set its name.  But suddenly the user decided to use <i>LanguageSettingsWidget</i> and chose another language.  The name of <i>QWidget</i> should change, but for this we need to take some additional actions.  Again, there are several options. <br><br><h5>  Solution 1: Inheritance </h5><br>  You can inherit from <i>QWidget</i> and override one of the virtual methods: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyWidget</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QWidget { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QEvent *e)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e-&gt;type() != QEvent::LanguageChange) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; setWindowTitle(tr(<span class="hljs-string"><span class="hljs-string">"Cool widget"</span></span>)); } };</code> </pre><br>  In this case, when installing a new <i>QTranslator, the changeEvent</i> method will be called, and, in our case, <i>setWindowTitle</i> .  Simply?  Enough.  Conveniently?  I believe that it is not always (in particular, when it is only for the sake of transfers that you have to make such a garden). <br><br><h5>  Solution 2: external translation </h5><br>  You can also pass a pointer to this class to another class, which is already inherited from <i>QWidget</i> , and call the appropriate method there.  I will not give the code - it is obvious and differs little from the previous example.  Let me just say that this is definitely a bad way - the less classes know about each other, the better. <br><br><h5>  Solution 3: <s>one</s> more <s>bike</s> another wrapper </h5><br>  The idea is simple: let us use Qt, such a convenient tool, as a <a href="http://qt-project.org/doc/qt-4.8/metaobjects.html">meta-object system</a> (it is understood that the signals and slots belong here).  Let's write a class to which we will pass a pointer to the target object, as well as the translation object from the first part of the article - <i>Translator</i> .  In addition, we indicate which property to write the translation in, or to which <a href="http://qt-project.org/doc/qt-4.8/signalsandslots.html">slot to</a> pass as an argument.  So fewer words, more deeds: <br><div class="spoiler">  <b class="spoiler_title">dynamictranslator.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DynamicTranslator</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QObject { Q_OBJECT <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: QByteArray targetPropertyName; QByteArray targetSlotName; Translation translation; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DynamicTranslator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QObject *parent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QByteArray &amp;targetPropertyName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Translation &amp;t)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DynamicTranslator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QObject *parent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Translation &amp;t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QByteArray &amp;targetSlotName)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QEvent *e)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: Q_DISABLE_COPY(DynamicTranslator) };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">dynamictranslator.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs">DynamicTranslator::DynamicTranslator(QObject *parent, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QByteArray &amp;targetPropertyName, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Translation &amp;t) : QObject(parent) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;targetPropertyName = targetPropertyName; translation = t; } DynamicTranslator::DynamicTranslator(QObject *parent, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Translation &amp;t, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QByteArray &amp;targetSlotName) : QObject(parent) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;targetSlotName = targetSlotName; translation = t; } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> DynamicTranslator::event(QEvent *e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e-&gt;type() != QEvent::LanguageChange) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; QObject *target = parent(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!target) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!targetPropertyName.isEmpty()) target-&gt;setProperty(targetPropertyName.constData(), translation.translate()); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!targetSlotName.isEmpty()) QMetaObject::invokeMethod(target, targetSlotName.constData(), Q_ARG(QString, translation.translate())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br></div></div><br>  What is going on here?  When creating an instance of the <i>DynamicTranslator</i> class <i>,</i> we specify the target object, the translation, and also the name of the slot (for example, <i>setWindowTitle</i> ) or the name of the property ( <i>windowTitle</i> ).  Our <i>DynamicTranslator,</i> with each change of language, either calls the corresponding slot using <a href="">QMetaObject</a> , or sets the desired property using <a href="http://qt-project.org/doc/qt-4.8/qobject.html">setProperty</a> .  Here is how it looks in practice: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **argv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">QApplication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(argc, argv)</span></span></span></span>; QTranslator *t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QTranslator; t-&gt;load(<span class="hljs-string"><span class="hljs-string">"/path/to/translations/myapp_ru.qm"</span></span>); QApplication::installTranslator(t); QWidget *w = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QWidget; Translation t = Translation::translate(<span class="hljs-string"><span class="hljs-string">"main"</span></span>, <span class="hljs-string"><span class="hljs-string">"Cool widget"</span></span>); w-&gt;setWindowTitle(t); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DynamicTranslator(w, <span class="hljs-string"><span class="hljs-string">"windowTitle"</span></span>, t); w-&gt;show(); LanguageSettingsWidget *lw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LanguageSettingsWidget; lw-&gt;show(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = app.exec(); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> w; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }</code> </pre><br>  Due to the fact that the widget <i>w</i> is the parent of our <i>DynamicTranslator</i> , there is no need to worry about deleting it - <i>DynamicTranslator</i> will be removed along with <i>QWidget</i> . <br><br><h4>  Instead of conclusion </h4><br>  Of course, the considered ways of dealing with the inconvenience of translations are not the only, and even more so - the only true ones.  For example, in large enough applications, third-party translation tools can be used instead of those provided by Qt (for example, all texts can be stored in files, and only identifiers can be specified in the code).  Again, in large applications, a couple dozen extra lines (in the case of inheritance or writing a factory function) will not make the weather.  Nevertheless, the solutions given here can save a little time and lines of code, and also make this code more natural. <br><br>  Criticism and alternative solutions are always welcome - let's write more correct, beautiful and clear code together.  Thank you for attention. </div><p>Source: <a href="https://habr.com/ru/post/247207/">https://habr.com/ru/post/247207/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247193/index.html">Little New Year's surprise. Meet, RAM-disk and PXE-boot over the network</a></li>
<li><a href="../247197/index.html">Fifth annual new year at the computer</a></li>
<li><a href="../247199/index.html">Local accounts in Microsoft Azure Mobile Services</a></li>
<li><a href="../247201/index.html">Reflection.Emit: array initialization</a></li>
<li><a href="../247205/index.html">Sound Mixing in Cubian</a></li>
<li><a href="../247209/index.html">New parameter to describe distribution & x.do = in magnet link for FlylinkDC ++. Factors of the choice by the user of a file-sharing network</a></li>
<li><a href="../247211/index.html">Express Specialist</a></li>
<li><a href="../247213/index.html">How lazy calculations work</a></li>
<li><a href="../247219/index.html">Pillow 2.7 - Significant improvement in quality and performance</a></li>
<li><a href="../247221/index.html">PROSPECTOR inside</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>