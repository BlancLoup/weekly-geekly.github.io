<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unity, ECS and all-all-all</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How many have been already manuals "How to make a game on Unity in 3 hours", "Making Counter-Strike in the evening", etc.? Low entry threshold is undo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unity, ECS and all-all-all</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/dz/lj/fb/dzljfbjutdc3sdyfv438igz_ive.jpeg"></p><br><p>  How many have been already manuals "How to make a game on Unity in 3 hours", "Making Counter-Strike in the evening", etc.?  Low entry threshold is undoubtedly the main plus and minus of Unity.  Indeed, it is possible to distribute ‚Äúassets‚Äù, add a few simple ‚Äúscripts‚Äù, wrap with blue electrical tape and it will even work somehow.  But when the project is cluttered with game mechanics, a complex logic of behavior, the problems with this approach increase like a snowball.  For the introduction of new mechanics, rewriting of the code in many places, constant checking and reworking of prefabs due to beaten references to logic components, not to mention optimization and testing of all this, is required.  Of course, the architecture can be thought out initially, but in practice this is always an unattainable goal - the design document changes quite often, some parts are thrown away, completely new ones are added and not connected with the old logic of behavior.  Components in Unity is a step in the right direction in the form of code decomposition into isolated blocks, but the implementation features do not allow to achieve the necessary flexibility and, most importantly, performance.  Developers come up with their own frameworks and bicycles, but most often stop at ECS (Entity Component System).  ECS is one of the solutions that continues the idea of ‚Äã‚Äãthe Unity component model, but gives it even more flexibility and greatly simplifies refactoring and further expanding the application with new functionality without major changes in the current code. </p><a name="habracut"></a><br><h1 id="chto-takoe-ecs">  What is ECS </h1><br><p>  ECS is the Entity Component System design pattern (Entity Component System, not to be confused with Elastic Cloud Storage :).  If in a very simple way, that is, ‚Äú <strong>Entities</strong> ‚Äù (Entity) are container objects that do not have properties, but act as repositories for ‚ÄúComponents‚Äù.  ‚Äú <strong>Components</strong> ‚Äù are data blocks that define the various properties of any game objects or events.  All this data, grouped in containers, is processed by logic that exists exclusively in the form of ‚Äú <strong>Systems</strong> ‚Äù - ‚Äúpure‚Äù classes with certain methods to perform.  This pattern is independent of any ‚Äúengine‚Äù and can be implemented in many ways.  All ‚Äúentities‚Äù, ‚Äúsystems‚Äù and ‚Äúcomponents‚Äù should be stored somewhere and initialized in some way - all of these are implementation features of each ECS solution for a specific ‚Äúengine‚Äù. </p><br><p>  Wait, you say, but that‚Äôs true of Unity!  Indeed, in Unity, <em>‚Äú <strong>Entity</strong> ‚Äù</em> is a <strong><em>GameObject</em></strong> , and <em>‚Äú <strong>Component</strong> ‚Äù</em> and <em>‚Äú <strong>System</strong> ‚Äù</em> are <strong><em>MonoBehaviour's</em></strong> heirs.  But this is the main difference between the Unity component system and ECS - the <em>logic in ECS must be separated from the data</em> .  This allows you to change the logic very flexibly (even delete / add it) without breaking the data.  Another bonus is that the data is processed by the ‚Äústream‚Äù in each system and regardless of the implementation in the ‚Äúengine‚Äù, in the case of MonoBehaviour there is quite a lot of interaction with the ‚ÄúNative‚Äù part, which eats up part of the performance.  You can read about the features of the internal method of calling methods from the heirs of MonoBehaviour in the official Unity blog: <a href="https://blogs.unity3d.com/ru/2015/12/23/1k-update-calls/">10,000 Update () calls</a> </p><br><h1 id="primer-raboty-ecs">  ECS Example </h1><br><p>  The task of the designer: ‚Äúit is necessary to make the player move and load the next level, when he reaches the point X‚Äù. <br>  We divide the task into several subtasks, one by one into the ‚Äúsystem‚Äù: </p><br><ul><li>  <em>UserInputSystem</em> - user input. </li><li>  <em>MovePlayerSystem</em> - move player based on input. </li><li>  <em>CheckPointSystem</em> - check the achievement of a player. </li><li>  <em>LoadLevelSystem</em> - load the level at the right time. </li></ul><br><p>  Define the components: </p><br><ul><li>  <em>UserInputEvent</em> - event of the presence of user input with data about it.  Yes, events are also components! </li><li>  <em>Player</em> - storage of the current position of the player and his speed. </li><li>  <em>CheckPoint</em> - point of interaction on the map. </li><li>  <em>LoadLevelEvent</em> - event about the need to load a new level. </li></ul><br><p>  And this is how it all works: </p><br><ul><li>  The scene is loaded and all systems are initialized in the above sequence.  Yes, the order of processing systems can be controlled without complex gestures - this is another nice bonus. </li><li>  Entities of the player are created (with the addition of the <em>Player</em> component to it) and a checkpoint entity (with the addition of the <em>CheckPoint</em> component to it). </li><li>  This is where the main system processing loop starts - essentially an analogue of the <em>MonoBehaviour.Update</em> method. </li><li>  <em>UserInputSystem</em> validates user input through standard Unity-api and creates a new entity with a <em>UserInputEvent</em> component and input data (if any). </li><li>  <em>MovePlayerSystem</em> checks if there are any entities with a <em>UserInputEvent</em> component and if there are any entities with a <em>Player</em> component.  If user input is present, we process all the found ‚Äúplayers‚Äù (even if it is one) with the received data, and delete the entity with the <em>UserInputEvent</em> component completely.  Yes, it works very quickly, does not cause the work of the garbage collector - everything goes into the internal pool for later reuse. </li><li>  <em>CheckPointSystem</em> checks if there are entities with the <em>CheckPoint</em> component and if there are entities with the <em>Player</em> component.  If there is both that and that - in a cycle checks distances between each player and a point.  If one of the ‚Äúplayers‚Äù is close enough to trigger, it creates a new entity with the <em>LoadLevelEvent</em> component. </li><li>  <em>LoadLevelSystem</em> checks if there are any entities with the <em>LoadLevelEvent</em> component and loads the new scene, if any.  All entities with such a component are deleted before this. </li><li>  Repeat the main loop processing systems. </li></ul><br><p>  <strong>UPD:</strong> josinSbazin <a href="https://github.com/josinSbazin/UnityLeoEcsImplementation">made the implementation of</a> this test task. </p><br><p>  It looks like an excessive complication of the code compared to one ‚ÄúMonoBehaviour‚Äù class in a dozen lines, but initially: </p><br><ul><li>  Allows you to separate input from the rest of the logic.  We can change the input model from the keyboard to the mouse, the controller, the touchscreen and the rest of the code will not break. </li><li>  Allows you to expand the behavior of the player in new ways without breaking the current.  For example, we can add slowdown / acceleration zones on the map by adding another one or more systems and changing the speed parameter in the <em>Player</em> component for certain entities. </li><li>  Allows you to have any number of control points on the map, and not just one, as requested by the designer. </li><li>  Allows you to even have multiple players, controlled in one way.  It can also be part of game mechanics, as in BinaryLand: </li></ul><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mBj-0BCsNaE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h1 id="osobennosti-ecs">  ECS Features </h1><br><p>  Based on the example above, you can deduce the main features of ECS with respect to the Unity component model. </p><br><p>  <u><strong>pros</strong></u> </p><br><ul><li>  Flexibility and scalability (adding new, removing old systems and components). </li><li>  Efficient use of memory (implementation feature, we can reuse instances of ‚Äúclean‚Äù C # -classes somehow, unlike ‚ÄúMonoBehaviour‚Äù). </li><li>  Simple access to objects (sampling (filtering) of entities with certain components is performed by the ECS core without losing speed and memory allocations - this is exactly what the Unity component system lacks). </li><li>  Clear separation of logic and data. </li><li>  Easier to test (easy to reproduce the test environment). </li><li>  Ability to use logic on a server without Unity (no dependencies on the ‚Äúengine‚Äù itself). </li></ul><br><p>  <u><strong>Minuses</strong></u> </p><br><ul><li>  More code </li><li>  For the events of Unity itself, it is necessary in some way to forward them to the ECS environment via the ‚ÄúMonoBehaviour‚Äù wrapper. </li></ul><br><p>  For many who have worked with Unity for a long time and have never used ECS, it will be difficult at first to get used to this approach.  But soon, you start ‚Äúthinking‚Äù with components / systems and everything is assembled faster and easier than with strongly connected components based on ‚ÄúMonoBehaviour‚Äù. </p><br><h1 id="vstroennoe-ecs-reshenie-v-unity">  Embedded ECS Solution in Unity </h1><br><p>  Now even the Unity developers themselves realized that it was time to change something in their component system in order to improve application performance.  Somewhere a year ago it was announced that the development of its own ECS and C # Job system is underway.  And now, in the 2018.1 version, we can already roughly imagine what it will be in the future, <a href="https://forum.unity.com/forums/entity-component-system-and-c-job-system.147/">even in the <em>Preview</em> status</a> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/kwnb9Clh2Is" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  With regular Unity ECS, nothing is clear yet.  Developers do not write anywhere that it is suitable only for a limited range of tasks, but when questions arise as a result of rewriting from other ECS solutions, they respond in the style of ‚Äúyou misuse ECS‚Äù.  Those.  in fact, this is not a ‚Äúmultipurpose‚Äù solution, which is rather strange.  There was no release, they can still change several times, there are problems with the transfer of reference types (for example, string), so I can not recommend doing something big on a regular ECS in its current state. </p><br><h1 id="alternativnye-ecs-resheniya-dlya-unity">  Alternative ECS Solutions for Unity </h1><br><p>  The ECS pattern was not invented yesterday, and on <a href="https://github.com/">https://github.com</a> you can find many of its implementations, including versions for Unity.  Relatively fresh and updated: </p><br><ul><li>  <a href="https://github.com/sschmid/Entitas-CSharp">Entitas</a> </li><li>  <a href="https://github.com/Leopotam/ecs">LeoECS</a> </li><li>  <a href="https://github.com/Spy-Shifty/BrokenBricksECS">BrokenBricksECS</a> </li><li>  <a href="">Svelto.ECS</a> </li></ul><br><p>  I dealt with only the first two options. </p><br><p> <strong>Entitas</strong> is the most popular and supported by a large community solution (because it was the first).  It is quite fast, there is integration with the Unity-editor for visualizing ECS ‚Äã‚Äãobjects, there is code generation for creating wrappers with a convenient api on top of custom components.  Over the past year, the code generator has separated into an independent project and has become paid, so this is rather a minus.  Another rather significant disadvantage (especially for mobile platforms) is that memory is allocated for all possible components on each entity, which is not very good.  But in general, it is good, well documented and ready for use on real projects.  Size: 0.5mb + 3mb support editor. <br>  <a href="https://github.com/sschmid/Entitas-CSharp/wiki/Made-With-Entitas">There</a> are a lot of <a href="https://github.com/sschmid/Entitas-CSharp/wiki/Made-With-Entitas">examples using Entitas</a> , but there is <a href="https://www.youtube.com/watch%3Fv%3D1wvMXur19M4">also a</a> project for a long time.  From examples with source codes it is possible to <a href="https://github.com/sschmid/Match-One">look at Match 1</a> . <br>  Entitas‚Äôs overall performance is estimated like this: <br><img src="https://habrastorage.org/webt/vk/cs/rz/vkcsrzdktgjhdoh5hrdjegnwvo0.jpeg"></p><br><p>  With <strong>LeoECS,</strong> I know better, because I'm doing a new game on it.  It is compact, does not contain private code in the form of external assemblies, supports assembly definitions from Unity 2017, is more optimized for memory usage, almost zero GC (only on the primary set of pools), no dependencies, C # v3.5 with optional inline support for FW4.6.  From the nice things: DI through markup attributes, integration with the Unity-editor for visualization of ECS-objects and ready binding for uGUI events.  Size: 18kb + 16kb editor support. <br>  As a ready-made example with the source code you can <a href="https://github.com/Leopotam/ecs-snake">see the classic game "Snake"</a> . <br>  <a href="https://github.com/echeg/unityecs_speedtest">Speed ‚Äã‚Äãcomparison of Entitas and LeoECS</a> : the results are quite close with a slight margin on both sides. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  I am not an expert in this matter (only recently I started using Unity in conjunction with ECS), so I decided to share my observations and thoughts first of all with those who "collect" games on Unity from assets with a bunch of scripts on each.  Yes it works.  Himself such was.  But if you are not doing a prototype or any one-time game without the need for its support and further development, then think 10 times - then you will have to figure it out and redo it all. </p><br><p>  Using ECS, I even get pleasure from the refactoring process :) New features are easily added to the game, old features change - and all this without pain or conflict with the designer, who decided to add a new furious mechanics or remove old ones, playing around with them. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/358108/">https://habr.com/ru/post/358108/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358096/index.html">Dive into pyTorch</a></li>
<li><a href="../358100/index.html">How to write on Habrahabr and Geektimes</a></li>
<li><a href="../358102/index.html">The book "Swift. Basics of developing applications for iOS and macOS. 4th ed. supplemented and revised "</a></li>
<li><a href="../358104/index.html">Your A / B tests are broken.</a></li>
<li><a href="../358106/index.html">3CX IP phone auto configuration options</a></li>
<li><a href="../358110/index.html">Chinese hackers are behind numerous hacks of international companies</a></li>
<li><a href="../358112/index.html">The transition to domestic software, installation "megasiens" and attracting leading foreign scientists: a plan for breakthrough development of the Russian Federation</a></li>
<li><a href="../358114/index.html">We invite you to Android-meetup SuperJob</a></li>
<li><a href="../358116/index.html">Monitoring network traffic on servers in the cloud</a></li>
<li><a href="../358118/index.html">AI, practical course. Foreword</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>