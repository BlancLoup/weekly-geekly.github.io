<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Combat rebuilding cache with RED</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Description of the problem 
 Imagine the average high-loaded site. Usually on such sites between the backend'om and DB put a cache layer. With the inc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Combat rebuilding cache with RED</h1><div class="post__text post__text-html js-mediator-article"><h2>  Description of the problem </h2><br>  Imagine the average high-loaded site.  Usually on such sites between the backend'om and DB put a cache layer.  With the increase in the number of visitors, the likelihood that several users simultaneously stumble upon a "rotten" cache increases.  If this happens, the load on the backend and DB increases, which in turn increases the processing time of the request and increases the likelihood of such a situation.  Here is such a system with positive feedback: <img src="http://img17.imageshack.us/img17/6543/apcthunderingherdpatch.png">  Small red humps are ‚Äúdull‚Äù requests on a multiple cache update.  This article will describe one of the approaches to solving the problem with the example ( <code>patch attached</code> ) <code>PHP</code> / <code>APC</code> bundles, but the theoretical framework is applicable to any language and caching system. <a name="habracut"></a><br><br><h2>  Solutions to the problem </h2><br>  There may be several approaches to solving the problem.  The method proposed below is exactly workaround.  The correct approach, IMHO, is to use busy lock'ov, which would allow only one process to update the cache, while the rest would give outdated data.  However, this solution is not trivial enough and in most cases (with a uniform distribution of requests) the described workaround should be more than enough. <br><br>  Also, in my case, it was decided to implement RED at the level of the cache itself, but the same could be implemented in the class / wrapper inside the application code.  This method was chosen because it was too lazy to go into PHP code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  RED </h2><br>  <code>RED</code> , also known as <code>random early detection</code> , <code>random early discard</code> or <code>random early drop</code> is an algorithm for managing queues encountered in routers and shapers.  Its physical meaning is approximately as follows: instead of waiting for the queue to fill up and you have to drop everything (taildrop), a certain threshold is entered, after which we start to drop packets with a certain probability, the probability itself is directly proportional to the free space in the buffer.  Hence the <code>Random Early Drop</code> . <br><br>  In our case, we will enter a certain threshold for the write cache <code>drop_threshold</code> ( <code>drop_threshold</code> ), after which we start with some probability <code>p</code> to issue <code>cache miss</code> read requests from the cache, which will force the application to put a fresh version of the data in the cache.  Thereby, we will reduce the number of competitive cache updates in inverse proportion to <code>p</code> . <br><br><h2>  Materiel </h2><br>  Mathematics is at the third grade level here, so I‚Äôll just give a picture and a formula: <a href="https://www.xkcd.com/833/"><img title="Suddenly, but the flot from the box does not know how to hang labels on the axis." src="http://img4.imageshack.us/img4/3916/cfded8641e44.png"></a> <img title="p (t) = \ begin {cases} 0 &amp; t <= drop \ _threshold \\ \ frac {(\ frac {time -creation \ _time} {ttl}) - drop \ _threshold} {1 - drop \ _threshold} &amp; drop \ _threshold <t <ttl \\ 1 &amp; t> = ttl \ end {cases}" src="http://img88.imageshack.us/img88/5425/201112031837491366x768s.png"><br><br><h2>  Disclaimer </h2><br>  PHP I do not know.  On C, I write like cattle. <br><br><h2>  APC patch </h2><br>  The code is written more like PoC than for production use.  A value of <code>75%</code> was taken from the ceiling.  In real conditions, <code>drop_threshold</code> should be rendered to the config. <br><blockquote>  Index: apc_cache.c <br>  ================================================= ================= <br>  <font color="#888822">--- apc_cache.c <font>(</font> revision <font>320057</font> <font>)</font></font> <br>  <font color="#888822">+++ apc_cache.c <font>(</font> working copy <font>)</font></font> <br>  <font color="#440088">@@ - <font>705</font> , <font>6</font> + <font>705</font> , <font>13</font> @@</font> <br>  volatile apc_cache_entry_t * value = NULL; <br>  unsigned long h; <br><br>  <font color="#00b000">+ / * APC-RED PATCH * /</font> <br>  <font color="#00b000">+ const int drop_threshold = <font>75</font> ;</font> <br>  <font color="#00b000">+ unsigned int probability = <font>0</font> ;</font> <br>  <font color="#00b000">+ int red_cf = <font>0</font> ;</font> <br>  <font color="#00b000">+ short drop = <font>0</font> ;</font> <br>  <font color="#00b000">+ / * END OF APC-RED PATCH * /</font> <br>  <font color="#00b000">+</font> <br>  if <font>(</font> apc_cache_busy <font>(</font> cache <font>)</font> <font>)</font> <br>  <font>{</font> <br>  / * cache cleanup in progress * / <br>  <font color="#440088">@@ - <font>720</font> , <font>8</font> + <font>727</font> , <font>25</font> @@</font> <br>  while <font>(</font> * slot <font>)</font> <font>{</font> <br>  if <font>(</font> <font>(</font> h == <font>(</font> * slot <font>)</font> -&gt; key.h <font>)</font> &amp;&amp; <br>  ! memcmp <font>(</font> <font>(</font> * slot <font>)</font> -&gt; key.data.user.identifier, strkey, keylen <font>)</font> <font>)</font> <font>{</font> <br>  <font color="#00b000">+ / * APC-RED PATCH * /</font> <br>  <font color="#00b000">+ if <font>(</font> <font>(</font> * slot <font>)</font> -&gt; value-&gt; data.user.ttl <font>)</font> <font>{</font></font> <br>  <font color="#00b000">+ red_cf = <font>(</font> t - <font>(</font> * slot <font>)</font> -&gt; creation_time <font>)</font> * <font>100</font> /</font> <br>  <font color="#00b000">+ <font>(</font> * slot <font>)</font> -&gt; value-&gt; data.user.ttl;</font> <br>  <font color="#00b000">+ if <font>(</font> red_cf&gt; = <font>100</font> <font>)</font> <font>{</font></font> <br>  <font color="#00b000">+ drop = <font>1</font> ;</font> <br>  <font color="#00b000">+ <font>}</font></font> <br>  <font color="#00b000">+ else if <font>(</font> red_cf &lt;= drop_threshold <font>)</font> <font>{</font></font> <br>  <font color="#00b000">+ drop = <font>0</font> ;</font> <br>  <font color="#00b000">+ <font>}</font></font> <br>  <font color="#00b000">+ else <font>{</font></font> <br>  <font color="#00b000">+ probability = <font>(</font> red_cf - drop_threshold <font>)</font> * <font>100</font> / <font>(</font> <font>100</font> - drop_threshold <font>)</font> ;</font> <br>  <font color="#00b000">+ drop = <font>(</font> arc4random <font>(</font> <font>)</font> % <font>100</font> <font>)</font> &lt;probability?</font>  <font color="#00b000"><font>1</font> : <font>0</font> ;</font> <br>  <font color="#00b000">+ <font>}</font></font> <br>  <font color="#00b000">+ <font>}</font></font> <br>  <font color="#00b000">+ / * END OF APC-RED PATCH * /</font> <br>  <font color="#00b000">+</font> <br>  / * Check to make sure this entry is expired by a hard TTL * / <br>  <font color="#991111">- if <font>(</font> <font>(</font> * slot <font>)</font> -&gt; value-&gt; data.user.ttl &amp;&amp; <font>(</font> time_t <font>)</font> <font>(</font> <font>(</font> * slot <font>)</font> -&gt; creation_time + <font>(</font> * slot <font>)</font> -&gt; value-&gt; data.user.ttl <font>)</font> &lt;t <font>)</font> <font>{</font></font> <br>  <font color="#00b000">+ if <font>(</font> <font>(</font> <font>(</font> * slot <font>)</font> -&gt; value-&gt; data.user.ttl &amp;&amp; <font>(</font> time_t <font>)</font> <font>(</font> <font>(</font> * slot <font>)</font> -&gt; creation_time + <font>(</font> * slot <font>)</font> -&gt; value-&gt; data.user.ttl <font>)</font> &lt;t <font>)</font> | | drop <font>)</font> <font>{</font></font> <br>  #if <font>(</font> USE_READ_LOCKS == <font>0</font> <font>)</font> <br>  If you have a write-lock <br>  * might be right-away.  Otherwise an insert </blockquote><br>  Considering how many parsers this patch went through before getting to Habr, it probably will not apply, so it‚Äôs better to leave a link to gist here: <a href="https://gist.github.com/1425476">patch-apc_red.patch</a> <br><br><h2>  Reflections on the beautiful </h2><br>  It would also be worthwhile to add support for the RCU (for example via <a href="http://lttng.org/urcu">liburcu</a> ) to the APC code, because under heavy loads it is not so difficult to rest against rwlock (by the way, <a href="http://svn.php.net/viewvc%3Fview%3Drevision%26revision%3D306005">relatively recently</a> added to APC).  APC itself has long been worth building in PHP. <br><br>  You can also think about how to adaptively set <code>drop_threshold</code> for some global structure like <code>board_config</code> , in which phpbb stores all of the global settings and which twitches on every request by all users, it makes sense to set the threshold to 50%, and vice versa , it is necessary to disable the feature, setting the threshold to 100%.  If you think about this topic, you can again look at the network analogs, for example, <a href="https://en.wikipedia.org/wiki/Random_early_detection">Adaptive / Active RED (ARED)</a> . <br><br>  You can also read the long-standing, but still current report by Andrei Smirnov ( <a href="https://habrahabr.ru/users/smira/" class="user_link">smira</a> ) on Highload 2008: <a href="http://www.highload.ru/2008/abstracts/7158.html">Web, caching and memcached</a> </div><p>Source: <a href="https://habr.com/ru/post/133910/">https://habr.com/ru/post/133910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133900/index.html">Symbian Web Runtime: easy mobile application development</a></li>
<li><a href="../133903/index.html">Optimization of code execution speed</a></li>
<li><a href="../133906/index.html">Anti-rootkit hypervisor: how it works</a></li>
<li><a href="../133907/index.html">Binary compatibility in the examples and not only</a></li>
<li><a href="../133909/index.html">Upgrade viola jones</a></li>
<li><a href="../133911/index.html">Model-oriented design, or continue taming the Cortex M3 with Matlab / Simulink</a></li>
<li><a href="../133912/index.html">How to make a combined user script for the site?</a></li>
<li><a href="../133914/index.html">Anti-piracy</a></li>
<li><a href="../133915/index.html">Restoring a messed up SSD</a></li>
<li><a href="../133917/index.html">1 minute for good</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>