<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We stamp windows: automated deployment of Windows virtual machines to Hyper-V using Vagrant (part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sooner or later, any growing IT company faces the challenge of optimizing resources, which from the point of view of system administration necessarily...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We stamp windows: automated deployment of Windows virtual machines to Hyper-V using Vagrant (part 1)</h1><div class="post__text post__text-html js-mediator-article">  Sooner or later, any growing IT company faces the challenge of optimizing resources, which from the point of view of system administration necessarily implies maximum automation of all processes.  This is necessary for many reasons: reduction of time costs, minimization of the human factor, increase due to this scalability and reliability of the systems as a whole. <br><br>  Our company Wild Apricot is developing software (SaaS) that runs on ASP and .NET, and uses MS SQL Server as its database.  Therefore, the lion‚Äôs share of the infrastructure is running under Windows, mainly Server 2012 R2.  Accordingly, the sysop department periodically has to raise new machines with it, and sometimes deploy entire farms, both on a live environment and on a test one.  Currently, we have about 20 hypervisors and, accordingly, more than a hundred different machines, of which the absolute majority are VMs with Windows.  Now it is planned to install another half-dozen developer environments, each of which consists of a dozen components that are desirable to isolate from each other.  To solve such problems, we conceived the automation of the entire process.  I made the description of the whole way quite detailed, so the article expanded and so I decided to divide it into three parts.  In this part I will try to touch upon general questions, explain the choice of tools and tell you how to prepare the environment for further work. <br><a name="habracut"></a><br><h4>  Why Windows, why Hyper-V? </h4><br>  Historically, all new VMs are under the control of the Microsoft Hyper-V hypervisor. <div class="spoiler">  <b class="spoiler_title">There are several reasons for this:</b> <div class="spoiler_text"><ul><li>  In recent years, it has developed quite strongly and, in general, has sufficient functionality for our tasks.  The most important thing is that he began to support Vagrant in human terms, which I will discuss in more detail a bit later.  There is also support for many Linux distributions, which allows, with some reservations, to host a zoo of different machines on Hyper-V, in case several OSes are used (and is someone wrong?); </li><li>  It is convenient to manage with the help of native tools (MMC tools and Powershell), built-in both server and client operating systems from Microsoft; </li><li>  The role of Hyper-V is very easy to add to the server, and in general the installation is available to a wider range of administrators (rather than, say, in the case of KVM or ESXi), there is a lot of documentation, guides, virtual labs and so on, much of this is available in Russian language.  This makes it easy to install it not only to administrators, but also to developers or testers (who also often need to quickly raise the environment for their own purposes), which expands the range of possible applications; <br>  Migration of physical machines to virtual is very easy and fast with the help of a simple utility Disk2VHD - it uses the snapshots mechanism and due to this it allows you to make a VHD image of even a working system running in a live environment.  This helped a lot when we virtualized our infrastructure.  In the same way we migrated VMWare hosts. </li><li>  Microsoft Hyper-V Server does not need to buy, it is <a href="http://www.microsoft.com/ru-ru/softmicrosoft/hyperv2012r2.aspx">free</a> .  For us, this was not very relevant, but this is a great opportunity to ‚Äúplay around‚Äù with it without any additional costs. </li><li>  From Hyper-V, later, if you wish, you can easily migrate to the Azure cloud platform, while continuing to manage it using the same tools. </li></ul></div></div><br><h4>  Goals </h4><br>  I had the task of automating the creation of new virtual machines.  It is necessary to quickly raise on the hypervisor an operating system with all the necessary software and settings.  All this is essentially the first step towards a full-fledged continuous deployment system with a configuration management system, which we plan to implement.  This is much beyond the scope of this article, but there is enough material on this topic, and I am going to continue the story about all the nuances of working in the world of Microsoft products in the next article if this material turns out to be interesting and useful.  As a result, the task was successfully solved using a fairly traditional set of tools, many of which have long been known in the world of open source software, but it was not so easy to use them fully in the Windows world because of the abundance of various kinds of pitfalls.  As a result, we stopped at the following ‚Äútulkite‚Äù: <br><ul><li>  Chocolatey; </li><li>  Vagrant; </li><li>  Boxstarter; </li><li>  Chef. </li></ul><br>  In this article we will talk about the first three points of the list. <br><br><h4>  Why Vagrant and Chef, Chocolatey and Boxstarter? </h4><br>  So what do they do and why were they chosen? <br><ul><li>  <i>Chocolatey</i> is a package manager for Windows.  Of course, Microsoft announced that Windows Server 10 will have its own, integrated package manager, but until its introduction into our production is still far and so far quite successfully, you can use chocolatier.  It allows you to automate the installation of the necessary software along with all dependencies.  For this, NuGet packages are used, which can be quite successfully created by yourself, which is very convenient when you need to install your own server software. </li><li>  <i>Vagrant</i> allows you to create and use a sample box of a virtual machine to subsequently automatically deploy one (or several or several dozen) virtual machines from it, configure the necessary parameters, and also perform the so-called provisioning ‚Äî the process of installing and configuring the necessary software.  For example, IIS and Chef-client can be installed there, latest Windows updates can be installed, folders can be customized (so that file extensions and hidden files can be seen), ports on the firewall can be opened, user accounts can be configured, and so on - all without direct participation. administrator, with automatic restarts if necessary, according to the previously described scenario. <br>  Of the analogues immediately comes to mind System Center, which also allows you to create a template and roll out of it several virtual machines.  However, for many reasons, I preferred Vagrant - it is lighter, does not require a heavy central server, and the disk of the new virtual machine does not become dependent on the disk of the original template.  In addition, Vagrant works from the usual command line, which makes it easy to use on hypervisors without a GUI. <br>  The article will have quite a lot of references to various pitfalls - I want to immediately say that the latest version at the moment is considered - 1.7.2, respectively, in subsequent versions (I hope) many problems will be fixed and unnecessary crutches will fall off.  But for sure they will add new bugs, which will allow me to make a whole series of articles. </li><li>  <i>Boxstarter</i> is a set of useful scripts that make it possible to greatly simplify the configuration of both finished machines and those just raised.  It works quite closely with Chocolatey and allows you to configure the final system with a single command, downloading the script from a website or network folder.  In addition, under it there are ready-made recipes for Chef from the author. </li><li>  <i>Chef is</i> used to centrally manage configurations in the broadest sense, including both initial initialization and keeping them up to date.  Instead, you can use other systems, but I settled on it because of its prevalence, powerful community and active development: for example, quite recently a new, significantly improved version of the Kupbook community for IIS appeared.  And, of course, influenced by the fact that with him already had a little experience before. </li></ul><br>  Using this tool allows you to get all the magic of Continuous Delivery in one bottle for a familiar system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  The main stages of deployment </h4><br>  Well, let's get down to the most interesting, to the applied technical part of the deployment. <br><br><h5>  Install Hyper-V and Management Software </h5><br>  First you need to prepare the host - the system on which virtual machines will be deployed.  If they are needed for local tests and everything will spin on the same computer where you are sitting - everything is simple and transparent.  However, it often happens that virtual users are needed as a result in a completely different place - in a data center on a live environment, on a neighboring server or on a grandmother's netbook.  The fact is that out of the box, Vagrant scripts do all operations on local storage.  In principle, no one bothers to first deploy it, set up-play, and then migrate to a distant hypervisor, but it turns out that it takes a decent amount of time even when the server is in the same network segment with you.  In the case when you need to deploy through a VPN in a data center on the other side of the earth, this can take more than an hour for each instance, and you may need to take extra steps: export-import in my case, plus reconfiguration of the network, if virtual switches are called differently. <br>  Therefore, for myself, I chose the best solution for raising Vagrant on all hypervisors, where its frequent use is planned.  This speeds up the process (even for one machine - because the box weighs significantly less than the VHD file of the deployed image), but adds extra software to the server.  Fortunately, Chocolatey and Vagrant do not require a GUI, so you can easily install them even on the free Hyper-V Server. <br>  This task is generally rather trivial: <br><ul><li>  Installing the Hyper-V role in Windows 8 or Server 2012 requires a reboot and is done through the Server Manager for GUI lovers (there is a link in the materials at the end of the article) or using PowerShell with administrative privileges: <br><blockquote>  Install-WindowsFeature ‚ÄìName Hyper-V -IncludeManagementTools </blockquote></li><li> Chocolatier is put from Powershell with one command: <br><blockquote>  iex ((new-object net.webclient). DownloadString ('https://chocolatey.org/install.ps1')) </blockquote></li><li>  Well, Vagrant rises already from Chocolatey: <br><blockquote>  choco install vagrant </blockquote></li></ul><br>  In general, if you do not like to clog servers with unnecessary programs or prefer to always use the latest versions (it should be understood that, despite the fact that the latest version is usually in the repository - it does not appear there instantly) - you can completely do without Chocolatier by installing Vagrant manually from the distribution.  It comes in the form of an msi-package, so there should be no problems with the installation from the console.  But personally, I prefer the first option not only because I love chocolate - I just used to put all the software at all, even on a home laptop. <br>  At this moment we are faced with the first pitfall (I have already warned that the path will be thorny?).  The fact is that our vagabond (and that is how ‚Äúvagrant‚Äù is translated) from version to version puts itself in different directories, and in the latest release for the moment, it again began to be installed directly into the root of the system disk in the C: \ HashiCorp \ Vagrant folder .  Everything would be fine, but he periodically forgets to prescribe the path to his folder in the environment variable, so the system may not find it, if not enter the full path to the binary.  It is treated with a simple command in Powershell: <br><blockquote>  $ env: Path + = ‚Äù; C: \ HashiCorp \ Vagrant \ bin‚Äù </blockquote><br>  For the command line, use the setx command with the / M key.  For example, if you need to change the location of the folder where it will store the boxes (by default it stores them on its folder on drive C, which might not really like it when there is a bit of space on the system drive): <br><blockquote>  setx VAGRANT_HOME "X: / your / path" / M </blockquote><br>  This completes the preparation of the host.  How to make a basic box for deployment and how to work with it further - I will tell in the following sections ( <a href="http://habrahabr.ru/post/251873/">part 2</a> ).  There will also be a separate chapter with a list of useful materials and links. </div><p>Source: <a href="https://habr.com/ru/post/251435/">https://habr.com/ru/post/251435/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251423/index.html">Intel IoT Meet-up in Nizhny Novgorod</a></li>
<li><a href="../251425/index.html">Patterns Don't Stop at Design - Be a Pattern-Driven Team</a></li>
<li><a href="../251427/index.html">Getting to know GStreamer: items and containers</a></li>
<li><a href="../251431/index.html">How to recognize the manipulation and quickly neutralize them</a></li>
<li><a href="../251433/index.html">Started voting for the new features of the browser Vivaldi</a></li>
<li><a href="../251437/index.html">Creating a convenient export of photos in VK. Part 1. iPhoto</a></li>
<li><a href="../251439/index.html">The output temperature, traffic jams and exchange rates on the LED matrix Raspberry Pi</a></li>
<li><a href="../251441/index.html">Few obscure frontend tricks</a></li>
<li><a href="../251443/index.html">Visual Studio 2015 CTP6 released</a></li>
<li><a href="../251445/index.html">Vulnerability in WP-Slimstat plugin 3.9.5 and below for WordPress</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>