<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Everything you need to know about partitioning (Part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 2 

 Good evening / day / morning dear habra people! We continue to develop and complement the blog about my favorite open source rdbms Postgresq...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Everything you need to know about partitioning (Part 1)</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/blogs/postgresql/75906/">Part 2</a> <br><br>  Good evening / day / morning dear habra people!  We continue to develop and complement the blog about my favorite open source rdbms Postgresql.  Miraculously, it so happened that the topic of today's topic has never been raised here.  I must say that the partitioning in postgresql is very well <a href="http://www.postgresql.org/docs/8.4/interactive/ddl-partitioning.html">described in the documentation</a> , but will it really stop me?). <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  In general, sectioning is generally understood not as some kind of technology, but rather as an approach to database design, which appeared long before the DBMS started supporting so-called.  partitioned tables.  The idea is very simple - to divide the table into several smaller parts.  There are two subspecies - horizontal and vertical sectioning. <br><br><h5>  Horizontal partitioning </h5><br>  Parts of a table contain different rows of it.  Suppose we have a table of logs of some abstract application - LOGS.  We can break it apart - one for logs for January 2009, another for February 2009, and so on. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Vertical partitioning </h5><br>  Parts of a table contain different columns.  Finding an application for vertical partitioning (when it is really justified) is somewhat more difficult than for horizontal one.  As a spherical horse, I propose to consider this option: the NEWS table has the columns ID, SHORTTEXT, LONGTEXT, and let the LONGTEXT field be used much less frequently than the first two.  In this case, it makes sense to split the NEWS table into columns (create two tables for SHORTTEXT and LONGTEXT, respectively, connected by primary keys + create view NEWS containing both columns).  Thus, when we only need a description of the news, the DBMS will not have to read the entire text of the news from the disk. <br><br><h5>  Sectioning support in modern DBMS </h5><br>  Most modern DBMSs support partitioning of tables in one form or another. <br><ul><li>  <b>Oracle</b> - supports partitioning starting with version 8.  Working with sections on the one hand is very simple (in general, you can not think about them, you work like with a regular table *), and on the other hand everything is very flexible.  Sections can be divided into "subpartitions", delete, divide, transfer.  Various options for indexing a partitioned table are supported (global index, partitioned index).  <a href="http://download.oracle.com/docs/cd/E11882_01/server.112/e10837/partition.htm">A reference to the volumetric description.</a> <br></li><li>  <b>Microsoft SQL Server</b> - support for partitioning appeared recently (in 2005).  The first impression of use is ‚ÄúWell, finally !! :)‚Äù, the second is ‚ÄúIt works, everything seems to be ok.‚Äù  <a href="http://msdn.microsoft.com/en-us/library/ms345146(SQL.90).aspx">Msdn documentation</a> <br></li><li>  <b>MySQL</b> - supports starting with version 5.1.  <a href="http://habrahabr.ru/blogs/webdev/66151/">Very good description on Habr√©</a> <br></li><li>  And so on‚Ä¶ <br></li></ul><br>  * - Of course, there is a standard set of difficulties - create a new section in time, throw out an old one, etc., but somehow everything is simple and clear. <br><br><h4>  Postgresql partitioning </h4><br>  The partitioning of tables in postgresql is slightly different in implementation from other databases.  The basis for partitioning is the inheritance of tables (a thing exclusively inherent in postgresql).  That is, we should have a main table (master table), and its sections will be successor tables.  We will consider sectioning on the example of a task close to reality. <br><br><h5>  Formulation of the problem </h5><br>  The database is used to collect and analyze data about site visitors / sites.  The data volumes are large enough to reflect on partitioning.  In the analysis, in most cases, data for the last day is used. <br>  1. Create the main table: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> analytics.events <br> ( <br> event_id BIGINT <font color="#0000ff">DEFAULT</font> nextval( <font color="#A31515">'analytics.seq_events'</font> ) <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , <br> user_id UUID <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> event_type_id <font color="#0000ff">SMALLINT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> event_time <font color="#0000ff">TIMESTAMP</font> <font color="#0000ff">DEFAULT</font> now() <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> url <font color="#0000ff">VARCHAR</font> (1024) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , <br> referrer <font color="#0000ff">VARCHAR</font> (1024), <br> ip INET <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <br> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  2. We will partition by day across the event_time field.  Every day we will create a new section.  Name the sections by the rule: analytics.events_DDMMYYYY.  Here is an example section for the 1st of January 2010. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> analytics.events_01012010 <br> ( <br> event_id BIGINT <font color="#0000ff">DEFAULT</font> nextval( <font color="#A31515">'analytics.seq_events'</font> ) <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , <br> <font color="#0000ff">CHECK</font> ( event_time &gt;= <font color="#0000ff">TIMESTAMP</font> <font color="#A31515">'2010-01-01 00:00:00'</font> <font color="#0000ff">AND</font> event_time &lt; <font color="#0000ff">TIMESTAMP</font> <font color="#A31515">'2010-01-02 00:00:00'</font> ) <br> ) INHERITS (analytics.events);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  When creating a section, we explicitly set the event_id field (PRIMARY KEY is not inherited) and create a CHECK CONSTRAINT on the event_time field so as not to insert too much. <br><br>  3. Create an index on the event_time field.  When splitting the table into sections, we mean that most queries to the table events will use the condition on the event_time field, so an index on this field will help us a lot. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">INDEX</font> events_01012010_event_time_idx <font color="#0000ff">ON</font> analytics.events_01012010 <font color="#0000ff">USING</font> btree(event_time);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  4. We want to ensure that when inserted into the main table, the data will be in the section intended for them.  To do this, do the next trick - create a trigger that will control the data flow. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">OR</font> REPLACE <font color="#0000ff">FUNCTION</font> analytics.events_insert_trigger() <br> <font color="#0000ff">RETURNS</font> <font color="#0000ff">TRIGGER</font> <font color="#0000ff">AS</font> $$ <br> <font color="#0000ff">BEGIN</font> <br> <font color="#0000ff">IF</font> ( <font color="#0000ff">NEW</font> .event_time &gt;= <font color="#0000ff">TIMESTAMP</font> <font color="#A31515">'2010-01-01 00:00:00'</font> <font color="#0000ff">AND</font> <br> <font color="#0000ff">NEW</font> .event_time &lt; <font color="#0000ff">TIMESTAMP</font> <font color="#A31515">'2010-01-02 00:00:00'</font> ) <font color="#0000ff">THEN</font> <br> <font color="#0000ff">INSERT</font> <font color="#0000ff">INTO</font> analytics.events_01012010 <font color="#0000ff">VALUES</font> ( <font color="#0000ff">NEW</font> .*); <br> <font color="#0000ff">ELSE</font> <br> RAISE <font color="#0000ff">EXCEPTION</font> <font color="#A31515">'Date % is out of range. Fix analytics.events_insert_trigger'</font> , <font color="#0000ff">NEW</font> .event_time; <br> <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <br> <font color="#0000ff">RETURN</font> <font color="#0000ff">NULL</font> ; <br> <font color="#0000ff">END</font> ; <br> $$ <br> <font color="#0000ff">LANGUAGE</font> plpgsql;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TRIGGER</font> events_before_insert <br> <font color="#0000ff">BEFORE</font> <font color="#0000ff">INSERT</font> <font color="#0000ff">ON</font> analytics.events <br> <font color="#0000ff">FOR</font> <font color="#0000ff">EACH</font> <font color="#0000ff">ROW</font> <font color="#0000ff">EXECUTE</font> <font color="#0000ff">PROCEDURE</font> analytics.events_insert_trigger();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  5. Everything is ready, we now have a partitioned analytics.events table.  We can begin to violently analyze its data.  By the way, we created CHECK constraints not only to protect sections from incorrect data.  Postgresql can use them when scheduling a query (though with a live index on event_time, this will give a minimal gain), just use the constraint_exclusion directive: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">SET</font> constraint_exclusion = <font color="#0000ff">on</font> ; <br> <font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> analytics.events <font color="#0000ff">WHERE</font> event_time &gt; <font color="#0000ff">CURRENT_DATE</font> ;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h5>  The end of the first part </h5><br>  So what do we have?  Let the points: <br>  1. Table events, divided into sections, analysis of available data for the last day becomes easier and faster. <br>  2. The horror of realizing that all this needs to be somehow supported, to create sections on time, not forgetting to change the trigger accordingly. <br><br>  In the second part I will talk about how easy and carefree to work with partitioned tables. <br><br>  <b>UPD1: Replaced Partitioning for Partitioning</b> <br>  <b>UPD2:</b> <b><br></b>  <b>Based on the comments of one of the readers who, unfortunately, does not have an account on Habr√©:</b> <b><br></b>  <b>With inheritance associated with a few points that should be considered when designing.</b>  <b>Sections do not inherit the primary key and foreign keys on their columns.</b>  <b>That is, when creating a section, you need to explicitly create PRIMARY KEY and FOREIGN KEYs on the section columns.</b>  <b>From myself, I note that creating FOREIGN KEY on columns of a partitioned table is not the best way.</b>  <b>In most cases, a partitioned table is a ‚Äúfact table‚Äù and itself refers to the ‚Äúdimension‚Äù of the table.</b> <b><br></b> </div><p>Source: <a href="https://habr.com/ru/post/74984/">https://habr.com/ru/post/74984/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../74975/index.html">Another distribution of invites to the wave</a></li>
<li><a href="../74976/index.html">Google wave invitations</a></li>
<li><a href="../74977/index.html">Dear UFO!</a></li>
<li><a href="../74978/index.html">Yeti USB Mic - the world's first THX certified microphone</a></li>
<li><a href="../74983/index.html">One step from love to hate, or the whole truth about the ‚ÄúRunet Prize‚Äù</a></li>
<li><a href="../74986/index.html">Collision of bullets at one million frames per second</a></li>
<li><a href="../74988/index.html">Creating a bootable USB Flash with Windows 7 from under Ubuntu</a></li>
<li><a href="../74989/index.html">Geek life</a></li>
<li><a href="../74990/index.html">% username%, and you know Vladimir Shahidzhanyan?</a></li>
<li><a href="../74991/index.html">Due to torrents may cancel the continuation of Zombieland</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>