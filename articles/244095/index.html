<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How does decompilation in .Net or Java using the example .Net</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today I would like to talk about application decompilation (all applied to the same Java, and to any language with some assumptions and limitations, b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How does decompilation in .Net or Java using the example .Net</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/8e8/7df/680/8e87df680c444867b0506ab60e4a61db.png"></div><br>  Today I would like to talk about application decompilation (all applied to the same Java, and to any language with some assumptions and limitations, but since I myself am a .Net developer, the examples will be quite a bit MSILovised :)). <br><br>  For an introductory, I‚Äôll list the current decompilation tools in the .Net world: <br><ul><li>  <a href="https://www.jetbrains.com/decompiler/">JetBrains dotPeek</a> (support R # hotkeys, character server) </li><li>  <a href="http://www.telerik.com/products/decompiler.aspx">Telerik JustDecompile</a> (also not bad, many hot keys) </li><li>  <a href="http://www.red-gate.com/products/dotnet-development/reflector/">RedGate Reflector</a> (dotPeek analog, but paid. Initially, it was the main one in the .Net world, but so far has been free) </li><li>  <a href="http://ilspy.net/">icsharpcode ILSpy</a> (good, opensource. Useful when you write code using Mono.Cecil yourself, because This will give a better understanding of its work) </li><li>  <a href="http://www.9rays.net/Category/54-spicesnet-decompiler.aspx">9rays Spices .Net Decompiler</a> </li><li>  <a href="http://www.netdecompiler.com/">Dis #</a> with inplace editor function </li></ul><br>  For software decompilation: <br><ul><li>  <a href="https://github.com/jbevain/cecil">Mono.Cecil</a> (the main, coolest decompiler in the .Net world. At the output, you get an object "mirror" of the assembly contents. Ie Maximum simplified, without frills such as converting an IL into DOM array) </li><li>  <a href="https://github.com/icsharpcode/ILSpy/tree/master/ICSharpCode.Decompiler">ICSharpCode.Decompiler</a> (add-on mono.cecil, which translates the array [MSIL] into a DOM where there are loops, switches and if'y. It is part of SharpDevelop / ILSpy) </li><li>  <a href="https://github.com/mumusan/harmony">Harmony Core</a> (similar to me, but retaining information about the characters. In average condition, not ready for sales, help is welcome). </li></ul><br><br>  And now, I would like to describe how they work (you also wonder how the JetBrains machine works?).  To at least understand how difficult it is: write your .Net decompiler assembly back into C # code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href="http://habrahabr.ru/company/luxoft/blog/246665/"><img src="https://habrastorage.org/files/7a4/07b/46e/7a407b46e6d14bdf99d72dc4c90d2226.png"></a> <br><div class="spoiler">  <b class="spoiler_title">To begin with, the full list of articles posted on this cycle in Habr√©</b> <div class="spoiler_text"> <a href="http://habrahabr.ru/company/luxoft/blog/247491/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247491/">We make shipped assemblies: we interact between domains without marshalling</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/219619/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/219619/">Getting a pointer to a .Net object</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/238947/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/238947/">Manual stream cloning.</a>  <a href="http://habrahabr.ru/company/luxoft/blog/238947/">When Assembler + C # or Java = Love</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/239005/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/239005/">Changing the code of system assemblies or "leak". Net Framework 5.0</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/244095/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/244095/">How does decompilation in .Net or Java using the example .Net</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/247433/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247433/">Continuing to shred CLR: .Net object pool outside SOH / LOH heaps</a> <br> <a href="http://habrahabr.ru/company/luxoft/blog/247447/"><img src="https://habrastorage.org/files/7d1/9d7/8ab/7d19d78ab896445fb5573b5f5e807ba0.png"></a>  <a href="http://habrahabr.ru/company/luxoft/blog/247447/">Remove objects dump from .Net application memory</a> <br></div></div><br><a name="habracut"></a><br>  To begin with, we will lay down a set of requirements in our decompiler: <br><ol><li>  Must accept any assembly as input: from CLR 1. * to 4. * </li><li>  It is obliged to support not only C # output, but also MSIL, VB.NET and in general - that‚Äôs enough fantasy and need. </li><li>  The ability to choose between different versions of the language (for example, C #), while not having duplication in the implementation. </li></ol><br><br>  And now that the requirements are defined, let's think about how MSIL works, and how it will help us to quickly decompile the application. <br><br>  Unlike the language of the processor, which makes for us some difficulties in the process of decompiling (registers, optimizations, the ability to do one action in several ways), in MSIL everything is as simple as possible.  If you need to write something to a local variable, then there is only one command for this.  Another way to write to a variable value will not work.  This property endows the final compiler (JITter) with ease of implementation on the one hand ... And on the other hand gives the implementation simplicity of the decompiling side. <br><br>  The second property that MSIL possesses is the computation on the stack.  There are no registers.  And the only memory through which all calculations go is the stack.  This does not mean at all that the final processor also calculates everything through the stack.  Not.  This means that for simplification, this model uses the description of all calculations and calls on MSIL.  What does this mean for us?  This means that you can add two numbers with only one command, which is one, regardless of the parameters.  This command, pulling data for addition from the stack, adds them and saves the result not somewhere, but back to the stack.  This is important because for us, as for people writing a decompiler, this will not produce a huge branch of code. <br><br>  Now we come to the most important thing: how is the process of decompiling. <br><br>  So that after <br><pre><code class="hljs pgsql">Ldc_i4 <span class="hljs-number"><span class="hljs-number">5</span></span> Ldc_i4 <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span> Stloc<span class="hljs-number"><span class="hljs-number">.1</span></span></code> </pre> <br>  Receive <br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">Sum</span></span> = <span class="hljs-number"><span class="hljs-number">5</span></span> + <span class="hljs-number"><span class="hljs-number">4</span></span>;</code> </pre><br>  The first difficulty that comes to mind: the position of the instructions may be different.  That is, for example, for the code to be executed, it is not at all necessary that there will be no other instructions between ldind_i4 and add.  For example, the following code is completely valid: <br><pre> <code class="hljs objectivec"> Ldc_i4 <span class="hljs-number"><span class="hljs-number">5</span></span> Ldc_i4 <span class="hljs-number"><span class="hljs-number">4</span></span> Ldc_i4 <span class="hljs-number"><span class="hljs-number">10</span></span> Stloc<span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-comment"><span class="hljs-comment">// sum2 Add Stloc.1 // sum1</span></span></code> </pre><br>  What should be decompiled, for example, as follows: <br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">Sum2</span></span> = <span class="hljs-number"><span class="hljs-number">10</span></span> Sum1 = <span class="hljs-number"><span class="hljs-number">5</span></span> + <span class="hljs-number"><span class="hljs-number">4</span></span>;</code> </pre><br>  Secondly, the names of variables in the release may be absent.  Those.  no impurities, the code will be: <br><pre> <code class="hljs"> = 10 = 5 + 4;</code> </pre><br>  Thirdly, what is the most difficult, if-else, while, do-while, switch implementations may differ.  This concerns, in particular, lambdas, yields, async / awaits and other language gadgets that are optional and are actually implemented on top of the usual functions of the language.  How to take all this into account?  In fact, both issues are solved in two ways. <br><br><h1>  Stack decompiling model </h1><br>  For decompiling, a certain interpreter of the code is written on MSIL, which has its own stack and command interpretation cycle.  At each iteration of the loop, the next command not considered is taken: <br><ol><li>  If this is not a transition instruction, then we look at how many values ‚Äã‚Äãon the stack are required by the command being examined.  Next, we pull out from the stack two computational nodes, which we put there, as the results of the calculations of the previous commands, and create a new node, the branches of which are nodes taken from the stack.  For the example above, it will look like this: <br><img src="https://habrastorage.org/files/2a2/f21/4c2/2a2f214c2d564a40b00ef152e4cd953d.png"><br>  Those.  First we have 4 teams in the input.  The first two do not take anything at the entrance, but only give - a number.  Accordingly, we put them on the stack (ldind_i4 4, ldind_i4 5).  Then we take the next command - Add.  It takes on input two values ‚Äã‚Äãfrom the stack.  Therefore, we read two nodes from our stack and, having guarded them as parameters of this command, we save the command itself onto the stack, since the command has a result.  And any result is stored on the stack. <br><br>  Then the result can be transferred to the method, or to participate in other arithmetic operations, or returned using the ret instruction. <br><br>  Accordingly, if the expression would be more complicated: <br><pre> <code class="hljs pgsql"> Ldc_i4 <span class="hljs-number"><span class="hljs-number">5</span></span> Ldc_i4 <span class="hljs-number"><span class="hljs-number">4</span></span> Ldc_i4 <span class="hljs-number"><span class="hljs-number">10</span></span> Mul <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span> Stloc<span class="hljs-number"><span class="hljs-number">.1</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-number"><span class="hljs-number">5</span></span> + (<span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">10</span></span>)</code> </pre><br><br>  That process of creating a DOM would look like this: <br><br><img src="https://habrastorage.org/files/c4e/03a/e4d/c4e03ae4dc11477a8f9d8c96ebfff7d2.png"><br><br>  Then the final assembly of the tree is carried out: <br><br><img src="https://habrastorage.org/files/939/29d/9b5/93929d9b573b49998101860c5a8cbba2.png"><br><br>  Method calls are constructed in the same way.  Only in the case of methods, the required number of parameters will be taken from the stack and stored in the class of the method call node.  If the method returns a value, the method call node will be folded onto the stack.  If not, added to the group of ready-made expressions. <br><br></li><li>  If a transition instruction (conditional or unconditional) is encountered, a grouping node is created that contains the node for calculating the transition condition and the nodes that will be executed if this condition is met and not met.  At this stage, we will look at how these templates look ‚Äúfrom a bird's eye view‚Äù: <br><img src="https://habrastorage.org/files/d12/946/def/d12946def0614094bc8489d71de808de.png"><br></li></ol><br><br><h1>  Wood assembly </h1><br>  These were all preparatory stages.  Further, for modularity, classes are created that recognize any one construct in the tree and translate it into another.  For example, if it is an if-else, then the presence of a conditional transition such that the transition is carried forward is matched.  Then the node is converted to an if-else node, the code behind the transition is marked as an else (negative if) node, and the code between the condition and the other node is marked as a positive if node.  If it matches as a conditional transition with a transition to previous instructions, then it matches as a while loop and the tree is also rebuilt.  Accordingly, depending on the purity of the executioners of the matchers, we will get the converted tree for a specific programming language.  Further, for each of the programming languages, we ask a lot of matchmen that suit him.  For example, cycles and conditions will suit everyone, because they will be present in almost all packages.  And here, for example, async / await - it is only for C #.  Therefore, there will be only in his package. <br><br>  For clarity of the picture, how are collected if-else and while / do-while, consider examples: <br><br><h2>  Assembly IF-ELSE block </h2><br><img src="https://habrastorage.org/files/ad7/0cf/af7/ad70cfaf7517471c9d8a64e1ffaa81ad.png"><br><br><h3>  Assembly WHILE block </h3><br><img src="https://habrastorage.org/files/707/db9/7e3/707db97e3093420b833e268faed3bbea.png"><br><br><h1>  Code generation </h1><br>  The last stage of the match is code generation for the tree.  There should not be any difficulties.  Ideally, of course, it would be cool to suck in rules from R # or StyleCop.  Fortunately, they are in XML.  But in the simplest case, we write a generator that accepts a class description tree as input.  He is first obliged to check the entire tree: does it contain unsupported node types.  If everything is all right, then the whole tree is bypassed and for each node the corresponding method is called using the Visitor design pattern, to which the StringBuilder and the corresponding node are passed.  Additionally, it is necessary to count the number of spaces that must be retreated from the beginning of each line.  At this stage, everything is quite simple. <br><br><h1>  Variable name generation </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cc9/23f/fd4/cc923ffd447f418f8551d3b9dd34f1a5.png"></div><br>  Before generating code, it is necessary to generate the names of all variables that were rubbed during the compilation process.  Matching algorithms are also written for this.  To generate variable names are: <br><ul><li>  Names of methods that are not generated by the compiler, in the calculations or results of calculations of which they are used.  Example: var ???  = this.Counterparty;  -&gt; ???  = counterparty. </li><li>  The data on whether a variable is a loop variable.  Those.  Is it considered only in the body of the cycle.  If it is integer, then the candidates for the name are index, i, j. </li><li>  If the variable in the foreach loop is an element from the collection being iterated, then you can call it [collectionName] Item or just item. </li></ul><br>  For the implementation of these and many other algorithms, matchers are used, which are similar to the matcher, rebuilding the tree for a specific programming language. <br><br><h1>  What's next? </h1><br>  Next, I will analyze specific decompilers.  dotPeek dotPeek, Cecil and your own.  But it is - a little later =) </div><p>Source: <a href="https://habr.com/ru/post/244095/">https://habr.com/ru/post/244095/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244085/index.html">How we implement Open source in state-owned companies and large-scale commerce in Russia</a></li>
<li><a href="../244087/index.html">NaviGuild your own navigator</a></li>
<li><a href="../244089/index.html">.NEXT 2014 Moscow: we break up the hall reports together</a></li>
<li><a href="../244091/index.html">Testing components in the Unity Engine</a></li>
<li><a href="../244093/index.html">LinkMeUp. Issue number 21. Network monitoring and management systems</a></li>
<li><a href="../244097/index.html">Miranda NG Project Receives Wild Signs Award (Part One)</a></li>
<li><a href="../244099/index.html">Byrobot: quadrocopter for Chuck Norris and 6d thinking</a></li>
<li><a href="../244101/index.html">WUD 2014 - World Usability Day</a></li>
<li><a href="../244103/index.html">A revolution in computer simulation of the human body in motion</a></li>
<li><a href="../244105/index.html">DD-WRT and SSL certificates</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>