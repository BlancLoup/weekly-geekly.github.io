<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Combining two local area networks with the same network numbers on a Linux gateway</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When creating a local network, not every administrator is responsible for choosing a range of addresses. Or maybe not everyone guesses about the prese...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Combining two local area networks with the same network numbers on a Linux gateway</h1><div class="post__text post__text-html js-mediator-article">  When creating a local network, not every administrator is responsible for choosing a range of addresses.  Or maybe not everyone guesses about the presence of private ranges except for 192.168.0.0/24.  And over time, such a time bomb can make itself felt.  Local networks are combined, there is a need for communication between the hosts of different networks.  And here it turns out that the numbers of the networks are the same.  And to change them for some reason is problematic or impossible. <br><a name="habracut"></a><br>  In this case, the server routing the packets between the networks is left to pretend that the network numbers are different and wishful thinking.  In the rich arsenal of Linux there are tools for such manipulations: iptables with NETMAP and the ip utility. <br><br><h4>  purpose </h4><br>  From LAN1 we want to send a packet to LAN2.  But we can not send it to the network, the number of which is the same with ours.  In the most frequent case, 192.168.0.0/24.  If such a package appears in LAN1, he will not know what LAN2 is, he will look for such a machine in LAN1.  These are the default routing rules. <br>  So, you need to send packets with other addresses that will go to the router. <br><br>  <i>How it should look for the observer from LAN1</i> <br>  For example, the user of the LAN1 network will see the LAN2 network as 10.8.1.0/24.  There is already no intersection of addresses.  LAN1 satisfied. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>What it looks like on both sides</i> <br>  A packet arrives from LAN1 with the sender address 192.168.0.100 and the destination address 10.8.1.200.  From the router from the LAN2 interface comes the same packet with the source address 10.8.1.100 and the destination address 192.168.0.200.  The package passes to the destination address and sends it in response to the sender's address with its address.  The package goes to the router.  In it, the inverse transform occurs and the user LAN1 receives a response from the address to which he sent the packet. <br><img src="https://habrastorage.org/getpro/habr/post_images/833/251/b64/833251b643105fcaeddc893df42754c4.png" alt="image"><br><br><h4>  Theory.  Path package in the core of the router: netfilter </h4><br>  Here I will try to talk about the journey of transit traffic through our Linux router.  For a complete understanding of the package travel process, it is better to see the scheme of its passage from Wikipedia through netfilter chains. <br><img src="https://habrastorage.org/getpro/habr/post_images/598/6b6/d1c/5986b6d1cdbefcbd744431d1f2c73021.png" alt="image"><br>  Our package with [source | destination] [192.168.0.100 | 10.8.1.200] falls on the network interface of the router and its first chain is PREROUTING. <br><br><h5>  PREROUTING </h5><br>  Passing through the chain, it enters the PREROUTING mangle table.  In which, using iptables, we define the interface from which it came, and the source address.  If this is our patient, we mark him with a MARK. <br>  After that the package [192.168.0.100 | 10.8.1.200 | (marked)] falls into the nat table.  This table is for address translation.  Since there is no real address 10.8.1.200, at the next stage of routing the packet will be dropped or left in an unknown direction.  Therefore, we replace his destination address with the one to which he really should go exactly here: [192.168.0.100 | 192.168.0.200 | (marked)].  This is done by the action NETMAP, which replaces the network number by mask. <br><br><h5>  ROUTING </h5><br>  Our package enters the decision-making stage, where it should go further.  It is marked, so we can send it to a special routing table that we created for this case.  It decides that the package is not intended for the local computer and must go to LAN2. <br><br>  The package successfully passes the FORWARDING chain.  Falls back to the routing stage.  If in FORWARDING nothing happened to him, but in theory it should not have been.  He goes the same way.  Then it gets into POSTROUTING. <br><br><h5>  POSTROUTING </h5><br>  Unchanged reaching the table nat.  We need to change the source address.  After all, the answer to the packet [192.168.0.100 | 192.168.0.200] will be sent to the local network, and not to the router.  So that he got back to the router, change the source address to a nonexistent [10.8.1.100 | 192.168.0.200].  Again NETMAP.  After that, the package goes to LAN2. <br>  With the return package, we perform the reverse procedure so that it reaches the original source. <br><br><h4>  Implementation </h4><br><pre><code class="bash hljs">iptables -t mangle -A PREROUTING -i tun0 -d 10.8.1.0/24 -j MARK --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-mark 8</code> </pre> <br>  We mark incoming packets on our non-existent network for further identification in netfilter.  You can do without tags, use the source address, the input interface and the destination address as criteria, but in the case of complex routing with individual routing tables, deciding where to send the packet will be easiest for the label. <br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -m mark --mark 8 -j NETMAP --to 192.168.0.0/24</code> </pre> <br>  We recognize the packet by the label and the action NETMAP in the PREROUTING table replaces the network number. <br><pre> <code class="bash hljs">iptables -t nat -A POSTROUTING -m mark --mark 8 -j NETMAP --to 10.8.2.0/24</code> </pre> <br>  In POSTROUTING, NETMAP replaces the source address. <br>  After that, all calls to the subnet 10.8.1.0/24 will look inside LAN2, like calls from the subnet 10.8.2.0/24. <br><br><h5>  ROUTING </h5><br>  To route packets by tag, you need to create your own routing table. Let's edit / etc / iproute2 / rt_tables, adding a unique number and the name of the new table. <br> <code>256 netmap</code> <br>  Next, you need to add a rule according to which packets for routing will be sent to this table. <br><pre> <code class="bash hljs">ip ru add fwmark 8 lookup netmap</code> </pre> <br>  Now marked packets will go to the routing netmap table. <br><br>  And the last step is to determine the routes in the netmap table. <br><pre> <code class="bash hljs">ip route add default dev eth1 table netmap</code> </pre> <br>  Or you can specify in a special case a separate gateway, if traffic to the network from the router goes through it.  Something in the spirit of: <br><pre> <code class="bash hljs">ip route add default via 192.168.1.254 dev eth1 table netmap</code> </pre> <br>  It is too early to rejoice, the answer will come to us from LAN2 [192.168.0.100 | 10.8.2.200]. <br>  We must do the same thing, but only convert back.  Alas, netfilter itself does not.  All actions have already been described, I will give only a sequence of commands for converting addresses into one and in the opposite direction.  (In the first routing table there is no need in this case, but in other circumstances it may be necessary.) <br><pre> <code class="bash hljs">ip rule add fwmark 8 lookup netmap ip route add 192.168.0.0/24 dev eth1 table netmap iptables -t mangle -A PREROUTING -i tun0 -d 10.8.1.0/24 -j MARK --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-mark 8 iptables -t nat -A PREROUTING -m mark --mark 8 -j NETMAP --to 192.168.0.0/24 iptables -t nat -A POSTROUTING -m mark --mark 8 -j NETMAP --to 10.8.2.0/24 <span class="hljs-comment"><span class="hljs-comment">#    ip rule add fwmark 9 lookup netmap2 ip route add 192.168.0.0/24 dev tun0 table netmap2 iptables -t mangle -A PREROUTING -i eth1 -d 10.8.2.0/24 -j MARK --set-mark 9 iptables -t nat -A PREROUTING -m mark --mark 9 -j NETMAP --to 192.168.0.0/24 iptables -t nat -A POSTROUTING -m mark --mark 9 -j NETMAP --to 10.8.1.0/24</span></span></code> </pre> <br><br><h4>  results </h4><br>  Here is what tcpdump writes (first example with vnc, second with ping): <br><pre> <code class="bash hljs">tcpdump -i any port 5900</code> </pre> <br> <code>12:46:46.358969 IP 192.168.0.100.41930 &gt; 10.8.1.200.5900: Flags [P.], seq 647:657, ack 261127, win 1213, options [nop,nop,TS val 460624 ecr 171318], length 10 <br> 12:46:46.358978 IP 10.8.2.100.41930 &gt; 192.168.0.200.5900: Flags [P.], seq 647:657, ack 261127, win 1213, options [nop,nop,TS val 460624 ecr 171318], length 10 <br> 12:46:46.505847 IP 192.168.0.200.5900 &gt; 10.8.2.100.41930: Flags [.], ack 657, win 64879, options [nop,nop,TS val 171320 ecr 460624], length 0 <br> 12:46:46.505861 IP 10.8.1.200.5900 &gt; 192.168.0.100.41930: Flags [.], ack 657, win 64879, options [nop,nop,TS val 171320 ecr 460624], length 0</code> <br> <br><pre> <code class="bash hljs">tcpdump -i any icmp</code> </pre> <br> <code>12:47:46.363905 IP 192.168.0.100 &gt; 10.8.1.200: ICMP echo request, id 2111, seq 1, length 64 <br> 12:47:46.363922 IP 10.8.2.100 &gt; 192.168.0.200: ICMP echo request, id 2111, seq 1, length 64 <br> 12:47:46.364049 IP 192.168.0.200 &gt; 10.8.2.100: ICMP echo reply, id 2111, seq 1, length 64 <br> 12:47:46.364054 IP 10.8.1.200 &gt; 192.168.0.100: ICMP echo reply, id 2111, seq 1, length 64</code> <br> <br>  Tcpdump perfectly demonstrates how addresses are transformed at the input to one interface and at the output to the other and in the opposite direction. <br><br>  Other services, such as Samba and its equivalent on Windows, also work fine. <br><br><h5>  Note </h5><br>  If the connection between the networks is organized through the OpenVPN tunnel, then in order to correctly route from the client side, an additional route through the tunnel must be added to the server config. <br> <code>push "route 10.8.1.0 255.255.255.0"</code> <br> <br><h5>  Warning! </h5><br>  When debugging a configuration, do not try to connect to the server on which the gateway is.  Connect to the machines behind him in LAN2. <br>  And that's why.  The rules are calculated that the packet will pass through the gateway, ie <br>  <i>PREROUTING -&gt; Routing -&gt; FORWARD -&gt; Routing -&gt; POSTROUTING</i> <br>  If the packets are addressed to 10.8.2.1 (to the server), then as a result of routing they will go to the INPUT chain and the source address will not be converted to POSTROUTING. <br>  <i>PREROUTING -&gt; Routing -&gt; INPUT -&gt; Application</i> <br>  Accordingly, the source address will not be changed and the response will be sent not to 10.8.2.xy, but to 192.168.0.xy - to the default route for this range, that is, to LAN2, and not to LAN1. </div><p>Source: <a href="https://habr.com/ru/post/117320/">https://habr.com/ru/post/117320/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../117314/index.html">Something about the initiatives</a></li>
<li><a href="../117315/index.html">Nginx 1.0 released</a></li>
<li><a href="../117316/index.html">Do you use optical discs?</a></li>
<li><a href="../117317/index.html">Droider Chart 47. Hit parade of Android applications</a></li>
<li><a href="../117318/index.html">The inscription "like" sometimes hurts the eyes</a></li>
<li><a href="../117321/index.html">As I explained to my wife what REST is</a></li>
<li><a href="../117324/index.html">Cars 2. Report</a></li>
<li><a href="../117325/index.html">Now there is a possibility of ‚Äúalmost‚Äù official unlock Iphone4 from any operator (including AT & T)</a></li>
<li><a href="../117326/index.html">The most useful java-class of all time</a></li>
<li><a href="../117327/index.html">Dual-core smartphone HTC Sensation officially presented</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>