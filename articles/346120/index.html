<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ok google get me a car</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The future is getting closer. 10 years ago I could not have imagined that I would start the car with the help of a voice command! 

 In recent years, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ok google get me a car</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/t-/n2/nt/t-n2ntklcrvx6zzidgzdgxdhg0u.png"><br><br>  The future is getting closer.  10 years ago I could not have imagined that I would start the car with the help of a voice command! <br><br>  In recent years, I have watched with interest the rapid development of voice assistants.  After the release of the Google Home Mini, I decided that it was already time for me to try, since the price had become more or less adequate for the ‚Äútoy‚Äù.  The first project is the integration of the voice assistant with the StarLine GSM module for autorun, control of coordinates, battery voltage and other parameters given by the car alarm system.  So, let's go? <br><a name="habracut"></a><br>  The presence of Google Home is not necessary, everything described below will work with the Google Assistant application on the phone.  I have installed a GSM / GPS module StarLine M31, but should work with all GSM alarms from StarLine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  The general scheme of the application for Google Assistant </h2><br><img src="https://habrastorage.org/webt/q0/hi/fn/q0hifnx5uvhsjjf8n-e2z3nfof8.png"><br><br><ul><li>  Google Home / Google Assistant is responsible for converting voice to text and vice versa + interaction with standard Google services.  When calling our application, Action in the terminology of Google, requests are transmitted to DialogFlow (API.AI in the diagram). </li><li>  DialogFlow is responsible for defining the dialog scheme, processing text requests in natural language, highlighting entities, forming responses and interacting with the outside world by calling WebHook if necessary. </li><li>  WebHook - WEB-service for interaction with the outside world.  At the input is the dialogue branch (Intent) + parameters extracted from the request (Entities).  At the exit - the answer to the user. </li></ul><br><h2>  1. DialogFlow.com </h2><br>  First we need to create an application (agent) at the dialogflow (former API.AI). <br>  We register with a Google account to which we will have Google Home attached. <br>  Unfortunately, the Russian language is not yet available for Google Assistant, we choose English. <br><br><img src="https://habrastorage.org/webt/qk/un/lc/qkunlcbnykt8ugqfv8wjzemctpq.png"><br><br>  Next we need to create Intents.  Intent in the terminology DialogFlow - one of the branches of the dialogue responsible for a particular action.  In our case it will be: GetBattery, GetTemperature, StartEngine, StopEngine.  There is also a Default Intent that works at the very beginning, usually a greeting and a short story about what you can do with the help of this application. <br>  In each Intent we need to specify examples of voice commands (User says), preferably 5-10 different options. <br><br><img src="https://habrastorage.org/webt/qm/ks/yp/qmksyp2ohimjdiawuhrppxvau30.png"><br><br>  In all Intents, except the default one, we need to send requests to our script (WebHook), therefore we put Fulfillment - Use webhook. <br><br><img src="https://habrastorage.org/webt/go/hj/sw/gohjsw1521igccwywagylag5uku.png"><br><br><h2>  2. WebHook to interact with the Starline server </h2><br>  We need a script that receives an Intent from a DialogFlow request and jerks the Starline commands.  The quickest way I managed to implement it in Python + Flask. <br><br>  Interaction with StarLine is taken <a href="https://habrahabr.ru/post/315782/">from here</a> + checked for relevance by the sniffer <a href="https://starline-online.ru/">in the browser</a> . <br>  To run on the server, I used gunicorn <br><br><pre><code class="bash hljs">gunicorn -b :3333 flask.starline:app</code> </pre> <br>  + nginx as reverse proxy. <br>  Note HTTPS is required! <br><br><div class="spoiler">  <b class="spoiler_title">starline.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask, request <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask_restful <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> reqparse, Resource, Api, abort <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging DEVICE_ID = <span class="hljs-number"><span class="hljs-number">1234567</span></span> <span class="hljs-comment"><span class="hljs-comment"># Use HTTPS sniffer to find your DEVICE_ID in https://starline-online.ru/ traffic LOGIN = 'YOUR_STARLINE_EMAIL' PASS = 'YOUR_STARLINE_PASSWORD' logging.basicConfig(level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s') header = { 'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:28.0) Gecko/20100101 Firefox/28.0', 'Accept': 'application/json, text/javascript, */*; q=0.01', 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8', 'X-Requested-With': 'XMLHttpRequest'} def start_engine(): with requests.Session() as session: t = session.get('https://starline-online.ru/', headers=header) login = session.post('https://starline-online.ru/user/login', { 'LoginForm[login]': LOGIN, 'LoginForm[pass]': PASS, 'LoginForm[rememberMe]': 'off'}, headers=header) logging.debug(login.content) r0 = session.get('https://starline-online.ru/device', headers=header) logging.debug(r0.content) r = session.post('https://starline-online.ru/device/{0}/executeCommand'.format(DEVICE_ID), { 'value': '1', 'action': 'ign', 'password': ''}, headers=header, timeout=1) logging.debug(r.status_code) logging.debug(r.content) logout = session.post('https://starline-online.ru/user/logout', { '': ''}, ) return ('Engine started!') def stop_engine(): with requests.Session() as session: t = session.get('https://starline-online.ru/', headers=header) login = session.post('https://starline-online.ru/user/login', { 'LoginForm[login]': LOGIN, 'LoginForm[pass]': PASS, 'LoginForm[rememberMe]': 'off'}, headers=header) logging.debug(login.content) r0 = session.get('https://starline-online.ru/device', headers=header) logging.debug(r0.content) r = session.post('https://starline-online.ru/device/{0}/executeCommand'.format(DEVICE_ID), { 'value': '0', 'action': 'ign', 'password': ''}, headers=header) logging.debug(r.status_code) logging.debug(r.content) logout = session.post('https://starline-online.ru/user/logout', { '': ''}, ) return ('Engine stopped!') def get_params(): with requests.Session() as session: t = session.get('https://starline-online.ru/', headers=header) login = session.post('https://starline-online.ru/user/login', { 'LoginForm[login]': LOGIN, 'LoginForm[pass]': PASS, 'LoginForm[rememberMe]': 'off'}, headers=header) logging.debug(login.content) r0 = session.get('https://starline-online.ru/device', headers=header) logging.debug(r0.content) res_dict = r0.json()['answer']['devices'][0] logout = session.post('https://starline-online.ru/user/logout', { '': ''}, ) return {'battery': res_dict['battery'], 'temperature': res_dict['ctemp']} def get_battery_text(): return ("Battery voltage {0} volts.".format(get_params()['battery'])) def get_temperature_text(): return ("Temperature: {0} degrees.".format(get_params()['temperature'])) app = Flask(__name__) app.config['BUNDLE_ERRORS'] = True api = Api(app) class ProccessGoogleRequest(Resource): def get(self): return {"status": "OK"} def post(self): req = request.get_json() logging.debug(request.get_json()) response = '' if req['result']['metadata']['intentName'] == 'GetBattery': response = get_battery_text() if req['result']['metadata']['intentName'] == 'GetTemperature': response = get_temperature_text() if req['result']['metadata']['intentName'] == 'StartEngine': response = start_engine() if req['result']['metadata']['intentName'] == 'StopEngine': response = stop_engine() if response == '': abort(400, message='Intent not detected') return {"speech": response, "displayText": response} api.add_resource(ProccessGoogleRequest, '/starline/') if __name__ == '__main__': app.run(debug=False)</span></span></code> </pre><br></div></div><br>  Yes, taking this opportunity, I want to contact the <b>StarLine</b> team - guys, why not make a normal API with documentation?  Looking and integration with third-party products would be many times more? <br><br><h2>  3. We test in the simulator and on the real device </h2><br>  For testing in <b>DialogFlow,</b> go to <b>Integrations -&gt; Google Assistant -&gt; INTEGRATION SETTINGS -&gt; Test</b> and get into the simulator Actions on Google <br><br><img src="https://habrastorage.org/webt/a5/z1/j0/a5z1j0xwwxmbqxslpocziemul_q.png"><br><br>  And here is the test result in the real world <br><iframe width="560" height="315" src="https://www.youtube.com/embed/8vv-YgORVLw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  The only cant, in this version, it answers ‚ÄúEngine started‚Äù before the real engine start, since it does not have time to wait for a response from Starline. <br><br>  <b>Ideas:</b> <br><br>  1. Request location from Google Assistant, sounding the distance to the car (Starline can give coordinates).  It is not yet clear how for Python WebHook to request the location of Google Home. <br><br>  2. Simplify Google's &lt;-&gt; Starline integration, then there will be no need to hardcode your password.  Without participation from Starline, as I understand it, this is not possible. <br><br>  <b>Known issues:</b> <br><br>  1. Google Assistant does not have time to wait for the Starline server to respond to the status of the engine start <br><br>  2. While testing, you can use only the default application name (Invocation) - Hey Google, talk to <b>my test app</b> . <br><br>  <b>Useful links:</b> <br><br>  1. <a href="https://www.youtube.com/playlist%3Flist%3DPLOU2XLYxmsIKgPTizdYWPPYEpU96FCJrQ">Video from Google</a> <br><br>  2. <a href="https://rominirani.com/hands-on-with-api-ai-google-assistant-writing-your-first-conversation-agent-a6a7dcdaba27">An example using Entities</a> </div><p>Source: <a href="https://habr.com/ru/post/346120/">https://habr.com/ru/post/346120/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346110/index.html">How to build a geographic dashboard with real-time data</a></li>
<li><a href="../346112/index.html">Telegram-bot as a gift</a></li>
<li><a href="../346114/index.html">Meltdown: not only affects performance</a></li>
<li><a href="../346116/index.html">Restate - or how to turn a Redux log into a tree</a></li>
<li><a href="../346118/index.html">MPS 2017.3 released</a></li>
<li><a href="../346126/index.html">Tachometer or speedometer: The flow of thoughts about measuring the frequency in the Arduino</a></li>
<li><a href="../346128/index.html">February 31</a></li>
<li><a href="../346130/index.html">So why aren't you participating in the development of open source software?</a></li>
<li><a href="../346132/index.html">Stimulus 1.0: a modest JavaScript HTML framework that you already have</a></li>
<li><a href="../346134/index.html">Genetic algorithm for constructing algorithms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>