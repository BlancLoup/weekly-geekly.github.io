<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PVS-Studio rummaged through the guts of Linux (3.18.1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Coauthor: Svyatoslav Razmyslov SvyatoslavMC . 

 For promotional purposes, we decided to try to test the Linux kernel using our static code analyzer. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PVS-Studio rummaged through the guts of Linux (3.18.1)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/1ed/616/6bc/1ed6166bcb6e65e873c7a37b5443185f.png" alt="Linux and PVS-Studio" align="left"><br>  Coauthor: Svyatoslav Razmyslov <a href="https://habrahabr.ru/users/svyatoslavmc/" class="user_link">SvyatoslavMC</a> . <br><br>  For promotional purposes, we decided to try to test the Linux kernel using our static code analyzer.  This task is interesting for its complexity.  Source code Linux than just not checked and verified.  Therefore, to find at least something new, a very difficult task.  But if it works, it will be a good promotional note about the capabilities of the PVS-Studio analyzer. <br><a name="habracut"></a><br><h2>  What we tested </h2><br>  The Linux kernel was taken from <a href="https://www.kernel.org/">The Linux Kernel Archives</a> .  Checked <a href="">Latest Stable Kernel 3.18.1</a> . <br><br>  By the time I write this article, the kernel 3.19-rc1 has already appeared.  Unfortunately, checking a project and writing an article takes a lot of time.  Therefore, we will be content to check not the latest version. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To those who say that we should have checked the latest version, I want to answer the following. <ol><li>  We regularly <a href="http://www.viva64.com/ru/a/0084/">check a large number of projects</a> .  In addition to free verification of projects, we have many other tasks.  And so there is no way to start all over again, just because a new version has appeared.  So we can never publish anything :). </li><li>  99% of the errors found remained in its place.  So this article can be safely used to slightly improve the Linux kernel code. </li><li>  The purpose of the article is to advertise PVS-Studio.  If we can find errors in the draft version of X, then we can find something in version Y. Our checks are quite superficial (we are not familiar with the project) and their goal is to write such articles.  The project benefits from the acquisition of a license for PVS-Studio and its regular use. </li></ol><br><h2>  As we tested </h2><br>  To check the kernel, we used the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> static code analyzer version 5.21. <br><br>  To test the Linux Kernel, the Ubuntu-14.04 distribution was used, for which there were many detailed instructions for configuring and building the kernel.  The analyzer checks <a href="http://www.viva64.com/ru/t/0076/">preprocessed files</a> that are better to get for successfully compiled files, so the project build is one of the most important stages of the check. <br><br>  Next, a small C ++ utility was written, which for each running process of the compiler saved the command line, the current directory and environment variables.  Readers familiar with PVS-Studio products should immediately recall the <a href="http://www.viva64.com/ru/b/0243/">PVS-Studio Standalone</a> utility, which allows you to test any project under Windows.  There, WinAPI is used to access processes, so for Linux this monitoring mechanism was rewritten, the rest of the code associated with running preprocessing and testing was completely transferred, and testing the Linux kernel was only a matter of time. <br><br><h2>  At the beginning about safety </h2><br>  Somehow it happened that the PVS-Studio analyzer is perceived solely as a tool for finding errors.  But no one pays attention that PVS-Studio can detect a number of vulnerabilities.  Of course, we are to blame for this ourselves.  It is necessary to straighten the situation a bit. <br><br>  You can perceive the messages that PVS-Studio gives out in different ways.  For example, on the one hand it is a typo, and on the other there may be a vulnerability.  It all depends on the point of view. <br><br>  I would like to suggest considering several warnings that PVS-Studio issued when analyzing Linux.  I'm not saying that the analyzer found a vulnerability in Linux.  But the warnings in question could easily do that. <br><br><h3>  Dangerous use of the memcmp () function </h3><br><pre><code class="cpp">static unsigned char eprom_try_esi(
  struct atm_dev *dev, unsigned short cmd,
  int offset, int swap)
{
  unsigned char buf[ZEPROM_SIZE];
  struct zatm_dev *zatm_dev;
  int i;

  zatm_dev = ZATM_DEV(dev);
  for (i = 0; i &lt; ZEPROM_SIZE; i += 2) {
    eprom_set(zatm_dev,ZEPROM_CS,cmd); /* select EPROM */
    eprom_put_bits(zatm_dev,ZEPROM_CMD_READ,ZEPROM_CMD_LEN,cmd);
    eprom_put_bits(zatm_dev,i &gt;&gt; 1,ZEPROM_ADDR_LEN,cmd);
    eprom_get_byte(zatm_dev,buf+i+swap,cmd);
    eprom_get_byte(zatm_dev,buf+i+1-swap,cmd);
    eprom_set(zatm_dev,0,cmd); /* deselect EPROM */
  }
  memcpy(dev-&gt;esi,buf+offset,ESI_LEN);
  return memcmp(dev-&gt;esi,"\0\0\0\0\0",ESI_LEN);
}</code></pre><br>
 PVS-Studio: V642 Saving the 'memcmp' function result inside the 'unsigned char' type variable is inappropriate. The significant bits could be lost breaking the program's logic. zatm.c 1168<br>
<br>
    'return'     .<br>
<br>
 'memcmp'     'int':<ul>
<li>&lt; 0 ‚Äî buf1 less than buf2;</li>
<li>0 ‚Äî buf1 identical to buf2;</li>
<li>&gt; 0 ‚Äî buf1 greater than buf2;</li>
</ul><br>
 :<ul>
<li>"&gt; 0",   ,    1;</li>
<li>"&lt; 0",    -1.</li>
</ul>   : -100, 2, 3, 100, 256, 1024, 5555   .  ,        'unsigned char' ( ,   ).<br>
<br>
         ,       .<br>
<br>
      ,              . ,      32-     64-.<br>
<br>
  ? ,    -,   EPROM. , ,     ?<br>
<br>
 ,   V642    !  ? ,     MySQL/MariaDB.<br>
<pre><code class="cpp">typedef char my_bool;
...
my_bool check(...) {
  return memcmp(...);
}</code></pre><br>
 PVS-Studio   .   .<br>
<br>
       MySQL/MariaDB   5.1.61, 5.2.11, 5.3.5, 5.5.22.   ,     MySQL /MariaDB   (SHA    ),       'memcmp'.          [-128..127].  ,  1   256          'true',   .  ,    bash        MySQL,      .       'sql/password.c',  .        : <a href="http://seclists.org/oss-sec/2012/q2/493">Security vulnerability in MySQL/MariaDB</a>.<br>
<br>
   Linux.      :<br>
<pre><code class="cpp">void sci_controller_power_control_queue_insert(....)
{
  ....
  for (i = 0; i &lt; SCI_MAX_PHYS; i++) {
    u8 other;
    current_phy = &amp;ihost-&gt;phys[i];
  
    other = memcmp(current_phy-&gt;frame_rcvd.iaf.sas_addr,
                   iphy-&gt;frame_rcvd.iaf.sas_addr,
                   sizeof(current_phy-&gt;frame_rcvd.iaf.sas_addr));

    if (current_phy-&gt;sm.current_state_id == SCI_PHY_READY &amp;&amp;
        current_phy-&gt;protocol == SAS_PROTOCOL_SSP &amp;&amp;
        other == 0) {
      sci_phy_consume_power_handler(iphy);
      break;
    }
  }
  ....
}</code></pre><br>
 PVS-Studio: V642 Saving the 'memcmp' function result inside the 'unsigned char' type variable is inappropriate. The significant bits could be lost breaking the program's logic. host.c 1846<br>
<br>
   memcmp()    other,   unsigned char.  ,   - ,   SCSI   .<br>
<br>
      :<ul>
<li>V642 Saving the 'memcmp' function result inside the 'unsigned char' type variable is inappropriate. The significant bits could be lost breaking the program's logic. zatm.c 1168</li>
<li>V642 Saving the 'memcmp' function result inside the 'unsigned char' type variable is inappropriate. The significant bits could be lost breaking the program's logic. host.c 1789</li>
</ul> <br>
<h3>   memset()</h3> <br>
   .     ,  ¬´¬ª    .     .  ,      .       .          : "<a href="http://www.viva64.com/ru/k/0041/">  ‚Äî ?</a>".<br>
<br>
   :<br>
<pre><code class="cpp">static int crypt_iv_tcw_whitening(....)
{
  ....
  u8 buf[TCW_WHITENING_SIZE];
  ....
  out:
  memset(buf, 0, sizeof(buf));
  return r;
}</code></pre><br>
 PVS-Studio: V597 The compiler could delete the 'memset' function call, which is used to flush 'buf' buffer. The RtlSecureZeroMemory() function should be used to erase the private data. dm-crypt.c 708<br>
<br>
    .  crypt_iv_tcw_whitening()     , - ,            memset(). ,   ,   memset()     .     C/C++       .      .<br>
<br>
 ,     .  - .         ( Debug-     memset).<br>
<br>
   .   ¬´-  ¬ª,    .      memset().         <a href="http://www.viva64.com/ru/d/0208/">V597</a>.<br>
<br>
PVS-Studio     RtlSecureZeroMemory(),     Windows.  Linux  , , .    ,       .<br>
<br>
  :<br>
<pre><code class="cpp">static int sha384_ssse3_final(struct shash_desc *desc, u8 *hash)
{
  u8 D[SHA512_DIGEST_SIZE];

  sha512_ssse3_final(desc, D);

  memcpy(hash, D, SHA384_DIGEST_SIZE);
  memset(D, 0, SHA512_DIGEST_SIZE);

  return 0;
}</code></pre><br>
 PVS-Studio: V597 The compiler could delete the 'memset' function call, which is used to flush 'D' buffer. The RtlSecureZeroMemory() function should be used to erase the private data. sha512_ssse3_glue.c 222<br>
<br>
  ,       4 : keydvt_out, keydvt_in, ccm_n, mic.     security.c ( 525 ‚Äî 528).<br>
<pre><code class="cpp">int wusb_dev_4way_handshake(....)
{
  ....
  struct aes_ccm_nonce ccm_n;
  u8 mic[8];
  struct wusb_keydvt_in keydvt_in;
  struct wusb_keydvt_out keydvt_out;
  ....
error_dev_update_address:
error_wusbhc_set_gtk:
error_wusbhc_set_ptk:
error_hs3:
error_hs2:
error_hs1:
  memset(hs, 0, 3*sizeof(hs[0]));
  memset(&amp;keydvt_out, 0, sizeof(keydvt_out));
  memset(&amp;keydvt_in, 0, sizeof(keydvt_in));
  memset(&amp;ccm_n, 0, sizeof(ccm_n));
  memset(mic, 0, sizeof(mic));
  if (result &lt; 0)
    wusb_dev_set_encryption(usb_dev, 0);
error_dev_set_encryption:
  kfree(hs);
error_kzalloc:
  return result;
  ....
}</code></pre><br>
  ,     ¬´¬ª - :<br>
<pre><code class="cpp">int
E_md4hash(const unsigned char *passwd, unsigned char *p16,
  const struct nls_table *codepage)
{
  int rc;
  int len;
  __le16 wpwd[129];

  /* Password cannot be longer than 128 characters */
  if (passwd) /* Password must be converted to NT unicode */
    len = cifs_strtoUTF16(wpwd, passwd, 128, codepage);
  else {
    len = 0;
    *wpwd = 0; /* Ensure string is null terminated */
  }

  rc = mdfour(p16, (unsigned char *) wpwd, len * sizeof(__le16));
  memset(wpwd, 0, 129 * sizeof(__le16));

  return rc;
}</code></pre><br>
 PVS-Studio: V597 The compiler could delete the 'memset' function call, which is used to flush 'wpwd' buffer. The RtlSecureZeroMemory() function should be used to erase the private data. smbencrypt.c 224<br>
<br>
  .  3  memset()   :<ul>
<li>sha256_ssse3_glue.c 214</li>
<li>dev-sysfs.c 104</li>
<li>qp.c 143</li>
</ul> <br>
<h3> </h3> <br>
  PVS-Studio   V595,   ,     ,      NULL.        .    :<br>
<pre><code class="cpp">static int tc_ctl_action(struct sk_buff *skb, struct nlmsghdr *n)
{
  struct net *net = sock_net(skb-&gt;sk);
  struct nlattr *tca[TCA_ACT_MAX + 1];
  u32 portid = skb ? NETLINK_CB(skb).portid : 0;
  ....
}</code></pre><br>
 PVS-Studio: V595 The 'skb' pointer was utilized before it was verified against nullptr. Check lines: 949, 951. act_api.c 949<br>
<br>
  .   'skb'   ,   .     .<br>
<br>
 ,     ,     .       .         0. ,   - .<br>
<br>
  . PVS-Studio   ,   ,    .   ,  ,      0.     .<br>
<br>
    .      .<br>
<br>
     ,   ,   .<br>
<pre><code class="cpp">static int podhd_try_init(struct usb_interface *interface,
        struct usb_line6_podhd *podhd)
{
  int err;
  struct usb_line6 *line6 = &amp;podhd-&gt;line6;

  if ((interface == NULL) || (podhd == NULL))
    return -ENODEV;
  ....
}</code></pre><br>
 PVS-Studio: V595 The 'podhd' pointer was utilized before it was verified against nullptr. Check lines: 96, 98. podhd.c 96<br>
<br>
  ,  ,     ,   .   .<br>
<br>
  podhd  NULL.    &amp;podhd-&gt;line6.   .     .       . ,   'line6' .   ¬´ ¬ª.      .   ,   ?        'podhd',     .  'line6'   ,        .<br>
<br>
,   !     .      .<br>
<br>
    .    : podhd-&gt;line6. ,    .       . ,  .<br>
<br>
   :<br>
<pre><code class="cpp">if ((interface == NULL) || (podhd == NULL))
  return -ENODEV;</code></pre><br>
  .  ,   'podhd'   .     :<br>
<pre><code class="cpp">if ((interface == NULL))
  return -ENODEV;</code></pre><br>
     memset()    ,        Debug() .     .<br>
<br>
 ,      ,      (-ENODEV),    .    .<br>
<br>
 .          . ..  ,   ,   .   ,      .  ,    - . ,   ,        . <br>
<br>
   :<br>
<pre><code class="cpp">int wpa_set_keys(struct vnt_private *pDevice, void *ctx,
     bool fcpfkernel) __must_hold(&amp;pDevice-&gt;lock)
{
  ....
  if (is_broadcast_ether_addr(&amp;param-&gt;addr[0]) ||
      (param-&gt;addr == NULL)) {
  ....
}</code></pre><br>
 PVS-Studio: V713 The pointer param-&gt;addr was utilized in the logical expression before it was verified against nullptr in the same logical expression. wpactl.c 333<br>
<br>
      :<br>
<pre><code class="cpp">if (is_broadcast_ether_addr(&amp;param-&gt;addr[0]))</code></pre><br>
 Linux .    V595    200 .   ,           .       -  .    : <a href="http://www.viva64.com/external-pictures/txt/Linux-V595.txt">Linux-V595.txt</a>.<br>
<br>
,         .        .   ,    .        .<br>
<br>
<h2>  </h2> <br>
,    ,   ,   . ,         .<br>
 <br>
<h3>  </h3> <br>
<pre><code class="cpp">void b43legacy_phy_set_antenna_diversity(....)
{
  ....
  if (phy-&gt;rev &gt;= 2) {
    b43legacy_phy_write(
      dev, 0x0461, b43legacy_phy_read(dev, 0x0461) | 0x0010);
    ....
  } else if (phy-&gt;rev &gt;= 6)
    b43legacy_phy_write(dev, 0x049B, 0x00DC);
  ....
}</code></pre><br>
 PVS-Studio: V695 Range intersections are possible within conditional expressions. Example: if (A &lt; 5) {‚Ä¶ } else if (A &lt; 2) {‚Ä¶ }. Check lines: 2147, 2162. phy.c 2162<br>
<br>
    .    :<br>
<pre><code class="cpp">if ( A &gt;= 2)
  X();
else if ( A &gt;= 6)
  Y();</code></pre><br>
 ,       'A',      Y().<br>
<br>
   .     .<br>
<pre><code class="cpp">static int __init scsi_debug_init(void)
{
  ....
  if (scsi_debug_dev_size_mb &gt;= 16)
    sdebug_heads = 32;
  else if (scsi_debug_dev_size_mb &gt;= 256)
   sdebug_heads = 64;
  ....
}</code></pre><br>
 PVS-Studio: V695 Range intersections are possible within conditional expressions. Example: if (A &lt; 5) {‚Ä¶ } else if (A &lt; 2) {‚Ä¶ }. Check lines: 3858, 3860. scsi_debug.c 3860<br>
<br>
<pre><code class="cpp">static ssize_t ad5933_store(....)
{
  ....
  /* 2x, 4x handling, see datasheet */
  if (val &gt; 511)
    val = (val &gt;&gt; 1) | (1 &lt;&lt; 9);
  else if (val &gt; 1022)
    val = (val &gt;&gt; 2) | (3 &lt;&lt; 9);
  ....
}</code></pre><br>
 PVS-Studio: V695 Range intersections are possible within conditional expressions. Example: if (A &lt; 5) {‚Ä¶ } else if (A &lt; 2) {‚Ä¶ }. Check lines: 439, 441. ad5933.c 441<br>
<br>
    ,    ,      :<ul>
<li>V695 Range intersections are possible within conditional expressions. Example: if (A &lt; 5) {‚Ä¶ } else if (A &lt; 2) {‚Ä¶ }. Check lines: 1417, 1422. bnx2i_hwi.c 1422</li>
<li>V695 Range intersections are possible within conditional expressions. Example: if (A &lt; 5) {‚Ä¶ } else if (A &lt; 2) {‚Ä¶ }. Check lines: 4815, 4831. stv090x.c 4831</li>
</ul>     .<br>
<pre><code class="cpp">static int dgap_parsefile(char **in)
{
  ....
  int module_type = 0;
  ....
  module_type = dgap_gettok(in);
  if (module_type == 0 || module_type != PORTS ||
      module_type != MODEM) {
    pr_err("failed to set a type of module");
    return -1;
  }
  ....
}</code></pre><br>
 PVS-Studio: V590 Consider inspecting the 'module_type == 0 || module_type != 68' expression. The expression is excessive or contains a misprint. dgap.c 6733<br>
<br>
         ,     .    .     : <ul>
<li>V590 Consider inspecting the 'conc_type == 0 || conc_type != 65' expression. The expression is excessive or contains a misprint. dgap.c 6692</li>
</ul> <br>
<h3>¬´ ¬ª</h3> <br>
        name_msi_vectors().    ,      . ,       .<br>
<pre><code class="cpp">static void name_msi_vectors(struct ipr_ioa_cfg *ioa_cfg)
{
  int vec_idx, n = sizeof(ioa_cfg-&gt;vectors_info[0].desc) - 1;

  for (vec_idx = 0; vec_idx &lt; ioa_cfg-&gt;nvectors; vec_idx++) {
    snprintf(ioa_cfg-&gt;vectors_info[vec_idx].desc, n,
       "host%d-%d", ioa_cfg-&gt;host-&gt;host_no, vec_idx);
    ioa_cfg-&gt;vectors_info[vec_idx].
      desc[strlen(ioa_cfg-&gt;vectors_info[vec_idx].desc)] = 0;
  }
}</code></pre><br>
: V692 An inappropriate attempt to append a null character to a string. To determine the length of a string by 'strlen' function correctly, a string ending with a null terminator should be used in the first place. ipr.c 9409<br>
<br>
   :<br>
<pre><code class="cpp">ioa_cfg-&gt;vectors_info[vec_idx].
  desc[strlen(ioa_cfg-&gt;vectors_info[vec_idx].desc)] = 0;</code></pre><br>
       ,   -  :<br>
<pre><code class="cpp">S[strlen(S)] = 0;</code></pre><br>
     .    ,    .  ,    - .<br>
<br>
<h3> </h3> <br>
<pre><code class="cpp">static int ql_wait_for_drvr_lock(struct ql3_adapter *qdev)
{
  int i = 0;

  while (i &lt; 10) {
    if (i)
      ssleep(1);

    if (ql_sem_lock(qdev,
        QL_DRVR_SEM_MASK,
        (QL_RESOURCE_BITS_BASE_CODE | (qdev-&gt;mac_index)
         * 2) &lt;&lt; 1)) {
      netdev_printk(KERN_DEBUG, qdev-&gt;ndev,
              "driver lock acquired\n");
      return 1;
    }
  }

  netdev_err(qdev-&gt;ndev,
             "Timed out waiting for driver lock...\n");
  return 0;
}</code></pre><br>
 PVS-Studio: V654 The condition 'i &lt; 10' of loop is always true. qla3xxx.c 149<br>
<br>
   .    ,   1    .     10 .<br>
<br>
,   ,    .   ,   'i'   .<br>
<br>
<h3>   </h3> <br>
<pre><code class="cpp">static int find_boot_record(struct NFTLrecord *nftl)
{
  ....
  if ((ret = nftl_read_oob(mtd, block * nftl-&gt;EraseSize +
                           SECTORSIZE + 8, 8, &amp;retlen,
                           (char *)&amp;h1) &lt; 0) ) {
    printk(KERN_WARNING "ANAND header found at 0x%x in mtd%d, "
           "but OOB data read failed (err %d)\n",
           block * nftl-&gt;EraseSize, nftl-&gt;mbd.mtd-&gt;index, ret);
    continue;
  ....
}</code></pre><br>
 PVS-Studio: V593 Consider reviewing the expression of the 'A = B &lt; C' kind. The expression is calculated as following: 'A = (B &lt; C)'. nftlmount.c 92<br>
<br>
  ,      .        . ,   ,   (err 0)  (err 1),     .<br>
<br>
 ‚Äî     .         nftl_read_oob()   'ret'.        0.  (ret &lt; 0),      .<br>
<br>
  ,    .      nftl_read_oob()   0.     0  1.       'ret'.<br>
<br>
 ,   nftl_read_oob()   ,  ret == 1.   ,  .<br>
<br>
  ,    . ,           'if'      .  ,       ‚Äî       .   : <br>
<pre><code class="cpp">if ((ret = nftl_read_oob(mtd, block * nftl-&gt;EraseSize +
                         SECTORSIZE + 8, 8, &amp;retlen,
                         (char *)&amp;h1)) &lt; 0 ) {</code></pre> <br>
<h3>  </h3> <br>
<pre><code class="cpp">int wl12xx_acx_config_hangover(struct wl1271 *wl)
{
  ....
  acx-&gt;recover_time = cpu_to_le32(conf-&gt;recover_time);
  acx-&gt;hangover_period = conf-&gt;hangover_period;
  acx-&gt;dynamic_mode = conf-&gt;dynamic_mode;
  acx-&gt;early_termination_mode = conf-&gt;early_termination_mode;
  acx-&gt;max_period = conf-&gt;max_period;
  acx-&gt;min_period = conf-&gt;min_period;
  acx-&gt;increase_delta = conf-&gt;increase_delta;
  acx-&gt;decrease_delta = conf-&gt;decrease_delta;
  acx-&gt;quiet_time = conf-&gt;quiet_time;
  acx-&gt;increase_time = conf-&gt;increase_time;
  acx-&gt;window_size = acx-&gt;window_size;         &lt;&lt;&lt;---
  ....
}</code></pre><br>
 PVS-Studio: V570 The 'acx-&gt;window_size' variable is assigned to itself. acx.c 1728<br>
<br>
        .       :<br>
<pre><code class="cpp">acx-&gt;window_size = acx-&gt;window_size;</code></pre><br>
 ?    ?     .<br>
<br>
<h3>  </h3> <br>
<pre><code class="cpp">static const struct XGI330_LCDDataDesStruct2  XGI_LVDSNoScalingDesData[] = {
  {0,  648,  448,  405,  96, 2}, /* 00 (320x200,320x400,
                                        640x200,640x400) */
  {0,  648,  448,  355,  96, 2}, /* 01 (320x350,640x350) */
  {0,  648,  448,  405,  96, 2}, /* 02 (360x400,720x400) */
  {0,  648,  448,  355,  96, 2}, /* 03 (720x350) */
  {0,  648,    1,  483,  96, 2}, /* 04 (640x480x60Hz) */
  {0,  840,  627,  600, 128, 4}, /* 05 (800x600x60Hz) */
  {0, 1048,  805,  770, 136, 6}, /* 06 (1024x768x60Hz) */
  {0, 1328,    0, 1025, 112, 3}, /* 07 (1280x1024x60Hz) */
  {0, 1438,    0, 1051, 112, 3}, /* 08 (1400x1050x60Hz)*/
  {0, 1664,    0, 1201, 192, 3}, /* 09 (1600x1200x60Hz) */
  {0, 1328,    0, 0771, 112, 6}  /* 0A (1280x768x60Hz) */
                  ^^^^
                  ^^^^
};</code></pre><br>
 PVS-Studio: V536 Be advised that the utilized constant value is represented by an octal form. Oct: 0771, Dec: 505. vb_table.h 1379<br>
<br>
        .      : 0771.   .   .<br>
<br>
 ,      ,    .      .<br>
<br>
<h3> </h3> <br>
<pre><code class="cpp">static void sig_ind(PLCI *plci)
{
  ....
  byte SS_Ind[] =
    "\x05\x02\x00\x02\x00\x00"; /* Hold_Ind struct*/
  byte CF_Ind[] =
    "\x09\x02\x00\x06\x00\x00\x00\x00\x00\x00";
  byte Interr_Err_Ind[] =
    "\x0a\x02\x00\x07\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";
  byte CONF_Ind[] =
    "\x09\x16\x00\x06\x00\x00\0x00\0x00\0x00\0x00";
                              ^^^^^^^^^^^^^^^^^^^
  ....
}</code></pre><br>
 PVS-Studio: V638 A terminal null is present inside a string. The '\0x00' characters were encountered. Probably meant: '\x00'. message.c 4883<br>
<br>
     .     CONF_Ind[].        ¬´x00¬ª.  ,   ,   ,    :<br>
<pre><code class="cpp">byte CONF_Ind[] =
  "\x09\x16\x00\x06\x00\x00\x00\x00\x00\x00";</code></pre><br>
.. '0'  'x'    .   ¬´x00¬ª   ,     .<br>
<br>
<h3>  </h3> <br>
<pre><code class="cpp">static int grip_xt_read_packet(....)
{
  ....
  if ((u ^ v) &amp; 1) {
    buf = (buf &lt;&lt; 1) | (u &gt;&gt; 1);
    t = strobe;
    i++;
  } else

  if ((((u ^ v) &amp; (v ^ w)) &gt;&gt; 1) &amp; ~(u | v | w) &amp; 1) {
  ....
}</code></pre><br>
 PVS-Studio: V705 It is possible that 'else' block was forgotten or commented out, thus altering the program's operation logics. grip.c 152<br>
<br>
  ,    .     .      .    .<br>
<br>
<h3>    </h3> <br>
<pre><code class="cpp">static s32 snto32(__u32 value, unsigned n)
{
  switch (n) {
  case 8:  return ((__s8)value);
  case 16: return ((__s16)value);
  case 32: return ((__s32)value);
  }
  return value &amp; (1 &lt;&lt; (n - 1)) ? value | (-1 &lt;&lt; n) : value;
}</code></pre><br>
 PVS-Studio: V610 Undefined behavior. Check the shift operator '&lt;&lt;. The left operand '-1' is negative. hid-core.c 1016<br>
<br>
      .             . ,       ,     "<a href="http://www.viva64.com/ru/b/0142/">  ,    .   ( )</a>".<br>
<br>
   : ¬´  !¬ª.   . ,  ,  Linux    ,      .   .<br>
<br>
   ,       : <a href="http://www.viva64.com/external-pictures/txt/Linux-V610.txt">Linux-V610.txt</a>.<br>
<br>
<h3>  enum</h3> <br>
    enum:<br>
<pre><code class="cpp">enum iscsi_param {
  ....
  ISCSI_PARAM_CONN_PORT,
  ISCSI_PARAM_CONN_ADDRESS,        &lt;&lt;&lt;&lt;----
  ....
};

enum iscsi_host_param {
  ISCSI_HOST_PARAM_HWADDRESS,
  ISCSI_HOST_PARAM_INITIATOR_NAME,
  ISCSI_HOST_PARAM_NETDEV_NAME,
  ISCSI_HOST_PARAM_IPADDRESS,       &lt;&lt;&lt;&lt;----
  ISCSI_HOST_PARAM_PORT_STATE,
  ISCSI_HOST_PARAM_PORT_SPEED,
  ISCSI_HOST_PARAM_MAX,
};</code></pre><br>
    ISCSI_PARAM_CONN_ADDRESS  ISCSI_HOST_PARAM_IPADDRESS.   . ,     .<br>
<br>
  :<br>
<pre><code class="cpp">int iscsi_conn_get_addr_param(
  struct sockaddr_storage *addr,
  enum iscsi_param param, char *buf)
{
  ....
  switch (param) {
  case ISCSI_PARAM_CONN_ADDRESS:
  case ISCSI_HOST_PARAM_IPADDRESS:        &lt;&lt;&lt;&lt;----
  ....
  case ISCSI_PARAM_CONN_PORT:
  case ISCSI_PARAM_LOCAL_PORT:
  ....
  default:
    return -EINVAL;
  }

  return len;
}</code></pre><br>
 PVS-Studio: V556 The values of different enum types are compared: switch(ENUM_TYPE_A) { case ENUM_TYPE_B:‚Ä¶ }. libiscsi.c 3501<br>
<br>
 ISCSI_HOST_PARAM_IPADDRESS    enum iscsi_param.    ,     ISCSI_PARAM_CONN_ADDRESS.<br>
<br>
  PVS-Studio:<ul>
<li>V556 The values of different enum types are compared: switch(ENUM_TYPE_A) { case ENUM_TYPE_B:‚Ä¶ }. svm.c 1360</li>
<li>V556 The values of different enum types are compared: switch(ENUM_TYPE_A) { case ENUM_TYPE_B:‚Ä¶ }. vmx.c 2690</li>
<li>V556 The values of different enum types are compared: switch(ENUM_TYPE_A) { case ENUM_TYPE_B:‚Ä¶ }. request.c 2842</li>
<li>V556 The values of different enum types are compared: switch(ENUM_TYPE_A) { case ENUM_TYPE_B:‚Ä¶ }. request.c 2868</li>
</ul> <br>
<h3> </h3> <br>
      .  ,    ,      .    .<br>
<pre><code class="cpp">void pvr2_encoder_cmd ()
{
  do {
    ....
    if (A) break;
    ....
    if (B) break;
    ....
    if (C) continue;
    ....
    if (E) break;
    ....
  } while(0);
}</code></pre><br>
  1 .  ,      ,     goto.  -   ,   'break',    ,   .<br>
<br>
 ,       'continue',   'break'.     'continue',  'break'. .<br>
<br>
   :<br>
<br>
¬ß6.6.2 in the standard: ¬´The continue statement (...) causes control to pass to the loop-continuation portion of the smallest enclosing iteration-statement, that is, to the end of the loop.¬ª (Not to the beginning.)<br>
<br>
 ,    'continue'    (0),       .<br>
<br>
 2 .<ol>
<li> .  'continue'   .         'break',     ,        .</li>
<li> 'continue'      .       .</li>
</ol> <br>
<h3>Copy-Paste </h3> <br>
<pre><code class="cpp">void dm_change_dynamic_initgain_thresh(
  struct net_device *dev, u32 dm_type, u32 dm_value)
{
  ....
  if (dm_type == DIG_TYPE_THRESH_HIGH)
  {
    dm_digtable.rssi_high_thresh = dm_value;
  }
  else if (dm_type == DIG_TYPE_THRESH_LOW)
  {
    dm_digtable.rssi_low_thresh = dm_value;
  }
  else if (dm_type == DIG_TYPE_THRESH_HIGHPWR_HIGH)      &lt;&lt;--
  {                                                      &lt;&lt;--
    dm_digtable.rssi_high_power_highthresh = dm_value;   &lt;&lt;--
  }                                                      &lt;&lt;--
  else if (dm_type == DIG_TYPE_THRESH_HIGHPWR_HIGH)      &lt;&lt;--
  {                                                      &lt;&lt;--
    dm_digtable.rssi_high_power_highthresh = dm_value;   &lt;&lt;--
  }                                                      &lt;&lt;--
  ....
}</code></pre><br>
 PVS-Studio: V517 The use of 'if (A) {...} else if (A) {...}' pattern was detected. There is a probability of logical error presence. Check lines: 1755, 1759. r8192U_dm.c 1755<br>
<br>
    Copy-Paste       :<ul>
<li>DIG_TYPE_THRESH_HIGHPWR_HIGH  DIG_TYPE_THRESH_HIGHPWR_LOW</li>
<li>rssi_high_power_highthresh  rssi_high_power_lowthresh</li>
</ul>    :<ul>
<li>V517 The use of 'if (A) {...} else if (A) {...}' pattern was detected. There is a probability of logical error presence. Check lines: 1670, 1672. rtl_dm.c 1670</li>
<li>V517 The use of 'if (A) {...} else if (A) {...}' pattern was detected. There is a probability of logical error presence. Check lines: 530, 533. ioctl.c 530</li>
</ul> <br>
<h3> </h3> <br>
  ,        . ,     .<br>
<pre><code class="cpp">static int saa7164_vbi_fmt(struct file *file, void *priv,
                           struct v4l2_format *f)
{
  /* ntsc */
  f-&gt;fmt.vbi.samples_per_line = 1600;           &lt;&lt;&lt;&lt;----
  f-&gt;fmt.vbi.samples_per_line = 1440;           &lt;&lt;&lt;&lt;----
  f-&gt;fmt.vbi.sampling_rate = 27000000;
  f-&gt;fmt.vbi.sample_format = V4L2_PIX_FMT_GREY;
  f-&gt;fmt.vbi.offset = 0;
  f-&gt;fmt.vbi.flags = 0;
  f-&gt;fmt.vbi.start[0] = 10;
  f-&gt;fmt.vbi.count[0] = 18;
  f-&gt;fmt.vbi.start[1] = 263 + 10 + 1;
  f-&gt;fmt.vbi.count[1] = 18;
  return 0;
}</code></pre><br>
 PVS-Studio: V519 The 'f-&gt;fmt.vbi.samples_per_line' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 1001, 1002. saa7164-vbi.c 1002<br>
<pre><code class="cpp">static int saa7164_vbi_buffers_alloc(struct saa7164_port *port)
{
  ....
  /* Init and establish defaults */
  params-&gt;samplesperline = 1440;
  params-&gt;numberoflines = 12;                           &lt;&lt;&lt;&lt;----
  params-&gt;numberoflines = 18;                           &lt;&lt;&lt;&lt;----
  params-&gt;pitch = 1600;                                 &lt;&lt;&lt;&lt;----
  params-&gt;pitch = 1440;                                 &lt;&lt;&lt;&lt;----
  params-&gt;numpagetables = 2 +
    ((params-&gt;numberoflines * params-&gt;pitch) / PAGE_SIZE);
  params-&gt;bitspersample = 8;
   ....
}</code></pre><br>
:<ul>
<li>V519 The 'params-&gt;numberoflines' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 118, 119. saa7164-vbi.c 119</li>
<li>V519 The 'params-&gt;pitch' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 120, 121. saa7164-vbi.c 121</li>
</ul> <br>
<br>
<h2></h2> <br>
      - .  Linux   . ,          . ,       ,     .<br>
<br>
   ,     ,         .         !<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/11e/0ae/95c/11e0ae95c1a1ac907ec2dd4d46671efe.png" alt="Linux and PVS-Studio"><br>
<br>
    <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a>   .     Windows.  -       Linux ,  <a href="http://www.viva64.com/ru/about-feedback/"> </a>,          PVS-Studio     .<br>
<br>
<h2>   </h2><br>
       ,      : Andrey Karpov. <a href="http://www.viva64.com/en/b/0299/">PVS-Studio dives into Linux insides (3.18.1)</a>.<br>
<br>
<div class="spoiler"><b class="spoiler_title">    ?</b><div class="spoiler_text">         .      : <a href="http://www.viva64.com/ru/a/0085/">      PVS-Studio  CppCat,  2014</a>. ,   .<br>
</div></div></div><p>Source: <a href="https://habr.com/ru/post/247271/">https://habr.com/ru/post/247271/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247261/index.html">Integration of PayPal to the site as a payment system and the problem with https</a></li>
<li><a href="../247263/index.html">Dagaz: Factorial is easy!</a></li>
<li><a href="../247265/index.html">Evolution of Zeus. Part III</a></li>
<li><a href="../247267/index.html">Win32 / Virlock - the first self-propagating extortionist</a></li>
<li><a href="../247269/index.html">Interesting on .Net hub for 2014</a></li>
<li><a href="../247273/index.html">Exploring Hyper-V internal mechanisms: Part 2</a></li>
<li><a href="../247275/index.html">Debugger for a penny: do ST-Link from Maple Mini</a></li>
<li><a href="../247277/index.html">SageMathCloud - a dream for fans of Python, math and Linux</a></li>
<li><a href="../247279/index.html">Large collection of hashing functions on Github</a></li>
<li><a href="../247283/index.html">Tutorial AngularJS: A Comprehensive Guide, Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>