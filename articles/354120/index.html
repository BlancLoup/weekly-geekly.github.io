<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking the source code of the free graphical editor Krita 4.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, the release of a new version of the free graphic editor Krita 4.0. It's time to test this project with PVS-Studio. 





 Introductio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking the source code of the free graphical editor Krita 4.0</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, the release of a new version of the free graphic editor Krita 4.0.  It's time to test this project with PVS-Studio. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/171/f9c/f50/171f9cf507083bd8ca56b5f6025489f3.png" alt="Picture 1"></div><br><a name="habracut"></a><br><h2>  Introduction </h2><br>  It is noteworthy that the developers have already used PVS-Studio in the distant 2015 on the <a href="https://krita.org/en/item/krita-2-9-2-released/">Krita 2.9.2</a> version and successfully fixed the <a href="https://github.com/KDE/krita/search%3Fq%3Dpvs-studio%26amp%3Btype%3DCommits">errors</a> with it.  However, apparently, the analyzer has not been used since.  In all our articles, we say that regular checks are important, because if the developers continued to use PVS-Studio, the errors that I will discuss in this article would simply not be released. <br><br><h2>  Useless range-based for </h2><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v714/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v714/">V714</a> Variable row is not passed <a href="https://www.viva64.com/ru/w/v714/">through</a> the loop.  kis_algebra_2d.cpp 532 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs">DecomposedMatix::DecomposedMatix(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QTransform &amp;t0) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!qFuzzyCompare(t.m33(), <span class="hljs-number"><span class="hljs-number">1.0</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> qreal invM33 = <span class="hljs-number"><span class="hljs-number">1.0</span></span> / t.m33(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> row : rows) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= row *= invM33; } } .... }</span></span></code> </pre> <br>  In this example, the programmer obviously wanted to multiply each element of the <i>rows</i> container by <i>invM33</i> , however, this will not happen.  At each iteration of the loop, a new variable is created with the name <i>row</i> , which is then simply destroyed.  To correct the error, you must create a link to the element stored in the container: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp;row : rows) { row *= invM33; }</code> </pre> <br><h2>  Incorrect conditions </h2><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v547/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v547/">V547</a> Expression 'j == 0' is always false.  KoColorSpace.cpp 218 <br><br><pre> <code class="cpp hljs">QPolygonF KoColorSpace::estimatedTRCXYY() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">5</span></span>; j&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>; j--) { channelValuesF.fill(<span class="hljs-number"><span class="hljs-number">0.0</span></span>); channelValuesF[i] = ((max / <span class="hljs-number"><span class="hljs-number">4</span></span>)*(<span class="hljs-number"><span class="hljs-number">5</span></span> - j)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (colorModelId().id() != <span class="hljs-string"><span class="hljs-string">"XYZA"</span></span>) { fromNormalisedChannelsValue(data, channelValuesF); convertPixelsTo(....); xyzColorSpace-&gt;normalisedChannelsValue(....); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (j == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= colorantY = channelValuesF[1]; if (d-&gt;colorants.size()&lt;2) { d-&gt;colorants.resize(3 * colorChannelCount()); d-&gt;colorants[i] = .... d-&gt;colorants[i + 1] = .... d-&gt;colorants[i + 2] = .... } } } .... }</span></span></code> </pre> <br>  The program will never enter the block under the condition <i>j == 0</i> , since this condition is always false due to the fact that the restriction <i>j&gt; 0 is</i> imposed above in the <i>for</i> loop. <br><br>  Similar analyzer warnings: <br><br><ul><li>  V547 Expression 'x &lt;0' is always false.  kis_selection_filters.cpp 334 </li><li>  V547 Expression 'y &lt;0' is always false.  kis_selection_filters.cpp 342 </li></ul><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v560/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v560/">V560</a> A part of conditional expression is always true.  KoTextLayoutArea.cpp 1622 <br><br><pre> <code class="cpp hljs">qreal KoTextLayoutArea::addLine(QTextLine &amp;line, FrameIterator *cursor, KoTextBlockData &amp;blockData) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!d-&gt;documentLayout-&gt;changeTracker() || !d-&gt;documentLayout-&gt;changeTracker()-&gt;displayChanges() <span class="hljs-comment"><span class="hljs-comment">// &lt;= || !d-&gt;documentLayout-&gt;changeTracker()-&gt;... || !d-&gt;documentLayout-&gt;changeTracker()-&gt;... || !d-&gt;documentLayout-&gt;changeTracker()-&gt;elementById(....) || !d-&gt;documentLayout-&gt;changeTracker()-&gt;elementById(....) || .... || d-&gt;documentLayout-&gt;changeTracker()-&gt;displayChanges()) { // &lt;= .... } }</span></span></code> </pre> <br>  If you look closely, you will notice that inside this complex condition there is a check of the form <i>(! A || a)</i> : <br><br><pre> <code class="cpp hljs">d-&gt;documentLayout-&gt;changeTracker()-&gt;displayChanges() || !d-&gt;documentLayout-&gt;changeTracker()-&gt;displayChanges()</code> </pre> <br>  Such a condition is always true, because of which all this big test becomes meaningless, and the analyzer reports. <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v547/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v547/">V547</a> Expression 'n == 128' is always false.  compression.cpp 110 <br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v547/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v547/">V547</a> Expression 'n&gt; 128' is always false.  compression.cpp 112 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">quint32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode_packbits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* dst, quint16 packed_len, quint32 unpacked_len)</span></span></span><span class="hljs-function"> </span></span>{ qint32 n; .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (unpack_left &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; pack_left &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { n = *src; src++; pack_left--; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n == <span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= continue; else if (n &gt; 128) // &lt;= n -= 256; .... } .... }</span></span></code> </pre> <br>  In this example, the value of the type <i>const char</i> , obtained by de-referencing the <i>src</i> pointer <i>, is</i> written to the <i>n-</i> type variable <i>qint32</i> <i>,</i> so the range of valid values ‚Äã‚Äãfor the variable <i>n</i> : [-128;  127].  Then the variable <i>n is</i> compared with the number 128, although it is clear that the result of such a test is always <i>false</i> . <br><br>  Note: The project is built without <i>-funsigned-char</i> . <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v590/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v590/">V590</a> Consider inspecting the 'state == (- 3) ||  state! = 0 'expression.  The expression is misprint.  psd_pixel_utils.cpp 335 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">psd_status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">psd_unzip_without_prediction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(psd_uchar *src_buf, psd_int src_len, psd_uchar *dst_buf, psd_int dst_len)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { state = inflate(&amp;stream, Z_PARTIAL_FLUSH); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(state == Z_STREAM_END) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(state == Z_DATA_ERROR || state != Z_OK) <span class="hljs-comment"><span class="hljs-comment">// &lt;= break; } while (stream.avail_out &gt; 0); }</span></span></code> </pre> <br>  Here they were too smart with the second condition, because of which it became redundant.  I will assume that the correct version is as follows: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { state = inflate(&amp;stream, Z_PARTIAL_FLUSH); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(state != Z_OK) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (stream.avail_out &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v547/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v547/">V547</a> Expression is always false.  SvgTextEditor.cpp 472 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SvgTextEditor::setTextWeightDemi() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_textEditorWidget.richTextEdit-&gt;textCursor() .charFormat().fontWeight() &gt; QFont::Normal &amp;&amp; m_textEditorWidget.richTextEdit-&gt;textCursor() .charFormat().fontWeight() &lt; QFont::Normal) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= setTextBold(QFont::Normal); } else { setTextBold(QFont::DemiBold); } }</span></span></code> </pre> <br>  The analyzer detected a condition of the form <i>(a&gt; b &amp;&amp; a &lt;b)</i> , which, obviously, is always false.  It is difficult to say exactly what the author wanted to write, however, this code is clearly erroneous and needs to be corrected. <br><br><h2>  Ochepyatki </h2><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v547/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v547/">V547</a> Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  KoResourceItemChooser.cpp 408 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> KoResourceItemChooser::updatePreview(KoResource *resource) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (image.format() != QImage::Format_RGB32 || <span class="hljs-comment"><span class="hljs-comment">// &lt;= image.format() != QImage::Format_ARGB32 || // &lt;= image.format() != QImage::Format_ARGB32_Premultiplied) { image = image.convertToFormat(....); } .... }</span></span></code> </pre> <br>  The programmer made a mistake and instead of the operator <i>&amp;&amp;</i> wrote the operator <i>||</i>  , because of what all his condition became meaningless, because  the condition of the form turned out: <i>a! = const_1 ||</i>  <i>a! = const_2,</i> which is always true. <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v547/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v547/">V547</a> Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  KoSvgTextShapeMarkupConverter.cpp 1000 <br><br><pre> <code class="cpp hljs">QString KoSvgTextShapeMarkupConverter::style(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (format.underlineStyle() != QTextCharFormat::NoUnderline || format.underlineStyle() != QTextCharFormat::SpellCheckUnderline) { .... } .... }</code> </pre> <br>  The case is similar to the previous one: mixed up the logical operator and instead of <i>&amp;&amp;</i> wrote <i>||</i>  . <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v501/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v501/">V501</a> There are identical sub-expressions 'sensor (FUZZY_PER_DAB, true)'  operator.  kis_pressure_size_option.cpp 43 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> KisPressureSizeOption::lodLimitations(....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor(FUZZY_PER_DAB, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) || sensor(FUZZY_PER_DAB, <span class="hljs-literal"><span class="hljs-literal">true</span></span>)) { l-&gt;limitations &lt;&lt; KoID(<span class="hljs-string"><span class="hljs-string">"size-fade"</span></span>, i18nc(<span class="hljs-string"><span class="hljs-string">"...."</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor(FADE, <span class="hljs-literal"><span class="hljs-literal">true</span></span>)) { l-&gt;blockers &lt;&lt; KoID(<span class="hljs-string"><span class="hljs-string">"...."</span></span>)); } }</code> </pre> <br>  The analyzer detected a situation where, to the left and right of the operator <i>||</i>  there are identical expressions.  If you look at the <i>DynamicSensorType</i> enumeration: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> DynamicSensorType { FUZZY_PER_DAB, FUZZY_PER_STROKE, SPEED, FADE, .... UNKNOWN = <span class="hljs-number"><span class="hljs-number">255</span></span> };</code> </pre> <br>  it becomes clear that, on the right, most likely they wanted to write <i>FUZZY_PER_STROKE</i> , and not <i>FUZZY_PER_DAB</i> . <br><br>  Static analyzers do well in finding such errors, but they are easy to overlook in code review, especially when you need to view a large number of changes. <br><br><h2>  Copy-Paste errors </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ce6/3ec/b23/ce63ecb2333a75d3299148e6dac9d652.png" alt="Picture 6"></p><br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v583/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v583/">V583</a> The '?:' Operator, regardless of its conditional expression, always returns the same value: d-&gt; paragraphStylesDotXmlStyles.values ‚Äã‚Äã().  KoTextSharedLoadingData.cpp 594 <br><br><pre> <code class="cpp hljs">QList&lt;KoParagraphStyle *&gt; KoTextSharedLoadingData::paragraphStyles(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> stylesDotXml) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stylesDotXml ? d-&gt;paragraphStylesDotXmlStyles.values() : d-&gt;paragraphStylesDotXmlStyles.values(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= }</span></span></code> </pre> <br>  Here, most likely, they copied the <i>then</i> block in the ternary operator and forgot to change the name of the method being called, which is why, regardless of the condition, one value will always be returned. <br><br>  Judging by the previous method: <br><br><pre> <code class="cpp hljs">KoParagraphStyle * KoTextSharedLoadingData::paragraphStyle(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;name, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> stylesDotXml) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stylesDotXml ? d-&gt;paragraphStylesDotXmlStyles.value(name) : d-&gt;paragraphContentDotXmlStyles.value(name); }</code> </pre> <br>  in the <i>else</i> block, you need to write <i>paragraphContentDotXmlStyles</i> , instead of <i>paragraphStylesDotXmlStyles</i> . <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v583/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v583/">V583</a> The '?:' Operator, regardless of its conditional expression, qFloor (axis).  kis_transform_worker.cc 456 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mirror_impl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(KisPaintDeviceSP dev, qreal axis, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isHorizontal)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> leftCenterPoint = qFloor(axis) &lt; axis ? qFloor(axis) : qFloor(axis); <span class="hljs-comment"><span class="hljs-comment">// &lt;= int leftEnd = qMin(leftCenterPoint, rightEnd); int rightCenterPoint = qFloor(axis) &lt; axis ? qCeil(axis) : qFloor(axis); int rightStart = qMax(rightCenterPoint, leftStart); .... }</span></span></code> </pre> <br>  Another trigger, very similar to the previous one.  Perhaps, in the then block of the first ternary operator, they wanted to write <i>qCeil (axis)</i> , not <i>qFloor (axis)</i> , or else the condition here is superfluous. <br><br>  <b>PVS-Studio Warning:</b> <a href="https://www.viva64.com/ru/w/v656/">V656</a> Variables 'vx', 'vy' are initialized.  It's probably not an error or un-optimized code.  Check lines: 218, 219. KarbonSimplifyPath.cpp 219 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> KarbonSimplifyPath::isSufficentlyFlat(QPointF curve[<span class="hljs-number"><span class="hljs-number">4</span></span>]) { qreal ux = <span class="hljs-number"><span class="hljs-number">3</span></span> * curve[<span class="hljs-number"><span class="hljs-number">1</span></span>].x() - <span class="hljs-number"><span class="hljs-number">2</span></span> * curve[<span class="hljs-number"><span class="hljs-number">0</span></span>].x() - curve[<span class="hljs-number"><span class="hljs-number">3</span></span>].x(); qreal uy = <span class="hljs-number"><span class="hljs-number">3</span></span> * curve[<span class="hljs-number"><span class="hljs-number">1</span></span>].y() - <span class="hljs-number"><span class="hljs-number">2</span></span> * curve[<span class="hljs-number"><span class="hljs-number">0</span></span>].y() - curve[<span class="hljs-number"><span class="hljs-number">3</span></span>].y(); qreal vx = <span class="hljs-number"><span class="hljs-number">3</span></span> * curve[<span class="hljs-number"><span class="hljs-number">2</span></span>].x() - <span class="hljs-number"><span class="hljs-number">2</span></span> * curve[<span class="hljs-number"><span class="hljs-number">3</span></span>].x() - curve[<span class="hljs-number"><span class="hljs-number">0</span></span>].x(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= qreal vy = 3 * curve[2].x() - 2 * curve[3].x() - curve[0].x(); // &lt;= .... }</span></span></code> </pre> <br>  This code looks very suspicious, because, most likely, when writing a formula for <i>vy, they</i> copied the previous line, but forgot to change the <i>x ()</i> calls to <i>y ()</i> .  In case there is no error here, it is better to rewrite the code like this: <br><br><pre> <code class="cpp hljs">qreal vx = <span class="hljs-number"><span class="hljs-number">3</span></span> * curve[<span class="hljs-number"><span class="hljs-number">2</span></span>].x() - <span class="hljs-number"><span class="hljs-number">2</span></span> * curve[<span class="hljs-number"><span class="hljs-number">3</span></span>].x() - curve[<span class="hljs-number"><span class="hljs-number">0</span></span>].x(); qreal vy = vx;</code> </pre> <br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v581/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v581/">V581</a> The statement expressions of the "if" statements stand alongside each other are identical.  Check lines: 675, 679. KoTableCellStyle.cpp 679 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> KoTableCellStyle::loadOdfProperties( KoShapeLoadingContext &amp;context, KoStyleStack &amp;styleStack) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (styleStack.hasProperty(KoXmlNS::style, <span class="hljs-string"><span class="hljs-string">"print-content"</span></span>)) { setPrintContent(styleStack.property(KoXmlNS::style, <span class="hljs-string"><span class="hljs-string">"print-content"</span></span>) == <span class="hljs-string"><span class="hljs-string">"true"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (styleStack.hasProperty(KoXmlNS::style, <span class="hljs-string"><span class="hljs-string">"repeat-content"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { setRepeatContent(styleStack.property(KoXmlNS::style, "repeat-content") == "true"); } if (styleStack.hasProperty(KoXmlNS::style, "repeat-content")) // &lt;= { setRepeatContent(styleStack.property(KoXmlNS::style, "repeat-content") == "true"); } .... }</span></span></code> </pre> <br>  The same test is performed twice.  In this method, either copied too much, or something mixed up.  If there is no error, then it is worth removing the duplicate code. <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v523/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v523/">V523</a> The 'then' statement is equivalent to the 'else' statement.  kis_processing_applicator.cpp 227 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> KisProcessingApplicator::applyVisitorAllFrames(....) { KisLayerUtils::FrameJobs jobs; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_flags.testFlag(RECURSIVE)) { KisLayerUtils::updateFrameJobsRecursive(&amp;jobs, m_node); <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else { KisLayerUtils::updateFrameJobsRecursive(&amp;jobs, m_node); // &lt;= } .... }</span></span></code> </pre> <br>  Most likely, here we copied the code from the <i>then</i> block into the <i>else</i> block and forgot to change the called method.  Judging by the project code, in the <i>else</i> branch, they probably wanted to write <i>KisLayerUtils :: updateFrameJobs</i> . <br><br><h2>  Duplicate condition (error in condition) </h2><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v517/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v517/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 255, 269. KoInlineTextObjectManager.cpp 255 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> KoInlineTextObjectManager::documentInformationUpdated( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;info, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;data) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-string"><span class="hljs-string">"title"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= setProperty(KoInlineObject::Title, data); else if (info == "description") setProperty(KoInlineObject::Description, data); else if (info == "abstract") setProperty(KoInlineObject::Comments, data); else if (info == "subject") setProperty(KoInlineObject::Subject, data); else if (info == "keyword") setProperty(KoInlineObject::Keywords, data); else if (info == "creator") setProperty(KoInlineObject::AuthorName, data); else if (info == "initial") setProperty(KoInlineObject::AuthorInitials, data); else if (info == "title") // &lt;= setProperty(KoInlineObject::SenderTitle, data); else if (info == "email") setProperty(KoInlineObject::SenderEmail, data); .... }</span></span></code> </pre> <br>  Here the same check is performed twice.  Most likely, in the second case, it was necessary to write something like <i>"sender-title"</i> . <br><br><h2>  Errors when working with constants from enumeration </h2><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v768/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v768/">V768</a> The enumeration constant 'BatchMode' is used as a variable of a Boolean-type.  KisMainWindow.cpp 811 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> KisMainWindow::openDocument(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QUrl &amp;url, OpenFlags flags) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!QFile(url.toLocalFile()).exists()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!flags &amp;&amp; BatchMode) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= QMessageBox::critical(0, i18nc("....", "Krita"), i18n("....", url.url())); } .... } .... }</span></span></code> </pre> <br>  <i>BatchMode</i> is an <i>OpenFlag</i> enumeration <i>element</i> with a value of <i>0x2</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> OpenFlag { None = <span class="hljs-number"><span class="hljs-number">0</span></span>, Import = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, BatchMode = <span class="hljs-number"><span class="hljs-number">0x2</span></span>, RecoveryFile = <span class="hljs-number"><span class="hljs-number">0x4</span></span> };</code> </pre> <br>  However, in this example, it is treated as if it were a variable.  The result is that part of the condition is always true. <br><br>  In this case, in the code above, <i>BatchMode</i> works correctly: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flags &amp; BatchMode) { newdoc-&gt;setFileBatchMode(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  From this we can conclude that they wanted to write something like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> KisMainWindow::openDocument(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QUrl &amp;url, OpenFlags flags) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!QFile(url.toLocalFile()).exists()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(flags &amp; BatchMode)) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= QMessageBox::critical(0, i18nc("....", "Krita"), i18n("....", url.url())); } .... } .... }</span></span></code> </pre> <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v768/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v768/">V768</a> The enumeration constant 'State_Active' is used as a variable of a Boolean-type.  KisOpenPane.cpp 104 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">paint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> override </span></span>{ QStyledItemDelegate::paint(painter, option, index); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!(option.state &amp; (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(QStyle::State_Active &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">// &lt;= QStyle::State_Enabled))) // &lt;= { .... } }</span></span></code> </pre> <br>  In this case, apparently, they mixed up the operators and instead of <i>|</i>  inside the mask used the operator <i>&amp;&amp;</i> .  I think that the corrected version should look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">paint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> override </span></span>{ QStyledItemDelegate::paint(painter, option, index); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!(option.state &amp; (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(QStyle::State_Active | QStyle::State_Enabled))) { .... } }</code> </pre> <br><h2>  Suspicious reassignments </h2><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v519/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v519/">V519</a> The 'value' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 61, 66. kis_draggable_tool_button.cpp 66 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> KisDraggableToolButton::continueDrag(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QPoint &amp;pos) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_orientation == Qt::Horizontal) { value = diff.x(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else { value = -diff.y(); // &lt;= } value = diff.x() - diff.y(); // &lt;= return value; }</span></span></code> </pre> <br>  The <i>value is</i> assigned some value inside the condition, however, then this value is immediately overwritten.  Most likely, there is some kind of mistake. <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v519/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v519/">V519</a> The 'uf.f' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 263, 265. lut.h 265 <br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v519/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v519/">V519</a> The 'uf.f' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 271, 273. lut.h 273 <br><br><pre> <code class="cpp hljs">LutKey&lt;<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> min, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> max, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> precision) : m_min(min), m_max(max), m_precision(precision) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(m_min &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; m_max &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { uf.f = m_min; <span class="hljs-comment"><span class="hljs-comment">// &lt;= m_tMin_p = uf.i &gt;&gt; m_shift; uf.f = m_max; // &lt;= m_tMax_p = uf.i &gt;&gt; m_shift; m_tMin_n = m_tMax_p; m_tMax_n = m_tMax_p; } else if( m_max &lt; 0) { uf.f = m_min; // &lt;= m_tMax_n = uf.i &gt;&gt; m_shift; uf.f = m_max; // &lt;= m_tMin_n = uf.i &gt;&gt; m_shift; m_tMin_p = m_tMax_n; m_tMax_p = m_tMax_n; } .... }</span></span></code> </pre> <br>  The variable <i>uf.f is assigned</i> two different times in a row.  This is suspicious, and it is possible that they wanted to assign a value to some other variable. <br><br><h2>  Maybe skipped else </h2><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v646/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v646/">V646</a> Consider inspecting the application's logic.  It's possible that 'else' keyword is missing.  SvgStyleWriter.cpp 82 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SvgStyleWriter::saveSvgBasicStyle(KoShape *shape, SvgSavingContext &amp;context) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!shape-&gt;isVisible(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)) { .... } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shape-&gt;transparency() &gt; <span class="hljs-number"><span class="hljs-number">0.0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... } }</span></span></code> </pre> <br>  Here, you may have forgotten the keyword <i>else</i> .  Even if there is no error, you should correct the formatting of the code so as not to embarrass the analyzer and other programmers. <br><br>  Similar warning: <ul><li>  V646 Consider inspecting the application's logic.  It's possible that 'else' keyword is missing.  transform_stroke_strategy.cpp 166 </li></ul><br><h2>  Problems with null pointers </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b2a/044/422/b2a0444226768211c56e83094e78f8b3.png" alt="Picture 3"></p><br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v595/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v595/">V595</a> The 'l' pointer was used before it was verified against nullptr.  Check lines: 428, 429. kis_node_manager.cpp 428 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> KisNodeManager::moveNodeAt(....) { .... KisLayer *l = qobject_cast&lt;KisLayer*&gt;(parent.data()); KisSelectionMaskSP selMask = l-&gt;selectionMask(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= if (m &amp;&amp; m-&gt;active() &amp;&amp; l &amp;&amp; l-&gt;selectionMask()) // &lt;= selMask-&gt;setActive(false); .... }</span></span></code> </pre> <br>  Here, the pointer <i>l is</i> first dereferenced and only then checked for <i>nullptr</i> . <br><br>  Similar analyzer warnings: <br><br><ul><li>  V595 'ient ient ient pointer pointer pointer pointer pointer  Check lines: 164, 166. kis_gradient_chooser.cc 164 </li><li>  V595 The 'm_currentShape' pointer was used before it was verified against nullptr.  Check lines: 316, 325. ArtisticTextTool.cpp 316 </li><li>  V595 The 'painter ()' pointer was used before it was verified against nullptr.  Check lines: 87, 89. kis_grid_paintop.cpp 87 </li><li>  V595 The 'm_optionsWidget' pointer was used before it was verified against nullptr.  Check lines: 193, 202. kis_tool_move.cc 193 </li><li>  .... </li></ul><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v1004/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v1004/">V1004</a> The 'sb' pointer was used unsafely after it was verified against nullptr.  Check lines: 665, 670. KisView.cpp 670 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> KisView::slotSavingStatusMessage(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;text, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> timeout, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isAutoSaving) { QStatusBar *sb = statusBar(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sb) <span class="hljs-comment"><span class="hljs-comment">// &lt;= sb-&gt;showMessage(text, timeout); KisConfig cfg; if (sb-&gt;isHidden() || // &lt;= (!isAutoSaving &amp;&amp; cfg.forceShowSaveMessages()) || (cfg.forceShowAutosaveMessages() &amp;&amp; isAutoSaving)) { viewManager()-&gt;showFloatingMessage(text, QIcon()); } }</span></span></code> </pre> <br>  The analyzer considers such use of the <i>sb</i> pointer to be unsafe after checking it for <i>nullptr</i> .  Indeed, in case the pointer is zero (and this is allowed, since such a condition is written above), then when calling <i>sb-&gt; isHidden () a</i> dereferencing of the zero pointer may occur.  As a correction, you can add a check for <i>nullptr</i> and in the second condition, or else somehow handle this situation. <br><br>  Similar analyzer warning: <br><br><ul><li>  V1004 The 'd-&gt; viewManager' pointer was used unsafely after it was verified against nullptr.  Check lines: 338, 365. KisView.cpp 365 </li></ul><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v522/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v522/">V522</a> Dereferencing of the null pointer 'slot' might take place.  kis_spriter_export.cpp 568 <br><br><pre> <code class="cpp hljs">KisImportExportFilter::ConversionStatus KisSpriterExport::convert( KisDocument *document, QIODevice *io, KisPropertiesConfigurationSP <span class="hljs-comment"><span class="hljs-comment">/*configuration*/</span></span>) { .... SpriterSlot *slot = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= // layer.name format: "base_name bone(bone_name) slot(slot_name)" if (file.layerName.contains("slot(")) { int start = file.layerName.indexOf("slot(") + 5; int end = file.layerName.indexOf(')', start); slot-&gt;name = file.layerName.mid(start, end - start); // &lt;= slot-&gt;defaultAttachmentFlag = .... // &lt;= } .... }</span></span></code> </pre> <br>  In this example, a null <i>slot</i> pointer is guaranteed to dereference, which in turn leads to undefined program behavior. <br><br><h2>  Memory leaks </h2><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v773/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v773/">V773</a> The function was exited without releasing the 'svgSymbol' pointer.  A memory leak is possible.  SvgParser.cpp 681 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> SvgParser::parseSymbol(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> KoXmlElement &amp;e) { .... KoSvgSymbol *svgSymbol = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KoSvgSymbol(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= // ensure that the clip path is loaded in local coordinates system m_context.pushGraphicsContext(e, false); m_context.currentGC()-&gt;matrix = QTransform(); m_context.currentGC()-&gt;currentBoundingBox = QRectF(0.0, 0.0, 1.0, 1.0); QString title = e.firstChildElement("title").toElement().text(); KoShape *symbolShape = parseGroup(e); m_context.popGraphicsContext(); if (!symbolShape) return false; // &lt;= .... }</span></span></code> </pre> <br>  In this example, when exiting the method, they forgot to free up the memory allocated for <i>svgSymbol</i> .  This is a memory leak.  There are many similar leaks in the project, but they are of the same type, so I will not dwell on them. <br><br>  Similar analyzer warnings: <br><br><ul><li>  V773 The function of the ppmFlow pointer.  A memory leak is possible.  kis_ppm_import.cpp 249 </li><li>  V773 The keyShortcut 'pointer.  A memory leak is possible.  kis_input_manager_p.cpp 443 </li><li>  V773 The function was exorted without releasing the 'layer Record' pointer.  A memory leak is possible.  psd_layer_section.cpp 109 </li><li>  V773 The function of the filterStack 'pointer.  A memory leak is possible.  FilterEffectResource.cpp 139 </li><li>  .... </li></ul><br><h2>  Checks for nullptr after new </h2><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v668/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v668/">V668</a> against S S S S S S S S S.  The exception will be generated in the case of memory allocation error.  CharacterGeneral.cpp 153 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> KoPathShape::separate(QList&lt;KoPathShape*&gt; &amp; separatedPaths) { .... Q_FOREACH (KoSubpath* subpath, d-&gt;subpaths) { KoPathShape *shape = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KoPathShape(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! shape) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... } }</span></span></code> </pre> <br>  This column in our articles, it seems, has already become permanent.  It <i>makes no sense</i> to check the pointer to <i>nullptr</i> if the memory has been allocated using the <i>new</i> operator.  If memory cannot be allocated, the new operator throws an exception <i>std :: bad_alloc ()</i> , and does not return <i>nullptr</i> .  To fix this code, you can add an exception handler, or use <i>new (std :: nothrow)</i> . <br><br>  Similar analyzer warnings: <br><br><ul><li>  V668 allocated allocated using factory  The exception will be generated in the case of memory allocation error.  TestKoShapeFactory.cpp 36 </li><li>  V668 using S S S S allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated  The exception will be generated in the case of memory allocation error.  ParagraphGeneral.cpp 199 </li><li>  V668 has been defined as the "new" operator.  The exception will be generated in the case of memory allocation error.  multi_bspline_create.cpp 460 </li><li>  The m_currentStrategy 'has been defined using the' new 'operator.  The exception will be generated in the case of memory allocation error.  ConnectionTool.cpp 333 </li><li>  .... </li></ul><br><h2>  Refactoring </h2><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v728/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v728/">V728 Alert</a> can be simplified.  The '||'  operator juxgler 'and' nodeJuggler '.  kis_node_manager.cpp 809 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!nodeJuggler || <span class="hljs-comment"><span class="hljs-comment">// &lt;= (nodeJuggler &amp;&amp; // &lt;= (nodeJuggler-&gt;isEnded() || !nodeJuggler-&gt;canMergeAction(actionName)))) { .... }</span></span></code> </pre> <br>  This check can be simplified: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!nodeJuggler || (nodeJuggler-&gt;isEnded() || !nodeJuggler-&gt;canMergeAction(actionName))) { .... }</code> </pre> <br>  Similar analyzer warning: <br><br><ul><li>  V728 Anonymous check can be simplified.  The '||'  operator is surrounded by opposite expressions '! m_currentFilterConfigWidget' and 'm_currentFilterConfigWidget'.  kis_filter_option.cpp 111 </li></ul><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v501/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v501/">V501 operator:!</a> Iterator.atEnd () &amp;&amp;! Iterator.atEnd () KoTextDebug.cpp 867 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> KoTextDebug::dumpFrame(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QTextFrame *frame, QTextStream &amp;out) { .... QTextFrame::iterator iterator = frame-&gt;begin(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; !iterator.atEnd() &amp;&amp; !iterator.atEnd(); ++iterator) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... } .... }</span></span></code> </pre> <br>  It is worth checking the condition of the for loop for errors.  If there are no errors, it is worth removing the duplicate check. <br><br>  Similar analyzer warning: <br><br><ul><li>  V501 Operator:! Iterator.atEnd () &amp;&amp;! Iterator.atEnd () KoTextDebug.cpp 909 </li></ul><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v799/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v799/">V799</a> The 'cmd' variable is not used after it has been allocated.  Consider checking the use of this variable.  kis_all_filter_test.cpp 154 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(KisFilterSP f)</span></span></span><span class="hljs-function"> </span></span>{ .... KisTransaction * cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KisTransaction(kundo2_noi18n(f-&gt;name()), dev); <span class="hljs-comment"><span class="hljs-comment">// &lt;= // Get the predefined configuration from a file KisFilterConfigurationSP kfc = f-&gt;defaultConfiguration(); QFile file(QString(FILES_DATA_DIR) + QDir::separator() + f-&gt;id() + ".cfg"); if (!file.open(QIODevice::ReadOnly | QIODevice::Text)) { //dbgKrita &lt;&lt; "creating new file for " &lt;&lt; f-&gt;id(); file.open(QIODevice::WriteOnly | QIODevice::Text); QTextStream out(&amp;file); out.setCodec("UTF-8"); out &lt;&lt; kfc-&gt;toXML(); } else { QString s; QTextStream in(&amp;file); in.setCodec("UTF-8"); s = in.readAll(); //dbgKrita &lt;&lt; "Read for " &lt;&lt; f-&gt;id() &lt;&lt; "\n" &lt;&lt; s; kfc-&gt;fromXML(s); } dbgKrita &lt;&lt; f-&gt;id();// &lt;&lt; "\n" &lt;&lt; kfc-&gt;toXML() &lt;&lt; "\n"; f-&gt;process(dev, QRect(QPoint(0,0), qimage.size()), kfc); QPoint errpoint; delete cmd; // &lt;= .... }</span></span></code> </pre> <br>  Here they allocated and freed up memory for the <i>cmd</i> object, but never used it. <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v732/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v732/">V732</a> Unary minus operator doesn‚Äôt modify a bool type value.  Consider using the '!'  operator.  kis_equalizer_slider.cpp 75 <br><br><pre> <code class="cpp hljs">QRect KisEqualizerSlider::Private::boundingRect() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { QRect bounds = q-&gt;rect().adjusted(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, -isRightmost, <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bounds; }</code> </pre> <br>  In this example, the variable <i>isRightmost</i> is of type <i>bool</i> .  Using the unary minus, the variable is implicitly converted to the type <i>int</i> and the resulting number is passed to the <i>adjusted ()</i> method.  Such code complicates understanding.  Explicit is better than implicit, so I think it's worth rewriting this fragment like this: <br><br><pre> <code class="cpp hljs">QRect KisEqualizerSlider::Private::boundingRect() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { QRect bounds = q-&gt;rect().adjusted(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, isRightmost ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bounds; }</code> </pre> <br>  Similar analyzer warnings: <br><br><ul><li>  V732 Unary minus operator value  Consider using the '!'  operator.  kis_equalizer_button.cpp 66 </li><li>  V732 Unary minus operator value  Consider using the '!'  operator.  kis_duplicateop.cpp 222 </li></ul><br><h2>  Conclusion </h2><br>  In conclusion, I would like to contact the developers of Krita and offer them to resume <a href="https://www.viva64.com/ru/b/0457/">using</a> our analyzer free of charge. <br><br>  Since the last time developers used PVS-Studio, we had versions for Linux and MacOS (I checked this project in Linux myself), and the analysis also improved significantly. <br><br>  In addition, I invite everyone to download and try <a href="https://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> on the code of their project. <br><br><p> <a href="https://www.viva64.com/en/b/0569/"><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Egor Bredikhin.  <a href="https://www.viva64.com/en/b/0569/">Check out the Krita 4.0 Free Source Code Graphics Editor</a> <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="https://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/354120/">https://habr.com/ru/post/354120/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354110/index.html">Urgent Relocation from Amazon Web Services - Two Customer Stories</a></li>
<li><a href="../354112/index.html">Own Goal We are testing DDoS protection.</a></li>
<li><a href="../354114/index.html">Java 10 migration notes</a></li>
<li><a href="../354116/index.html">Inventions for smugglers and pharmacists + training your research institute</a></li>
<li><a href="../354118/index.html">True XP / TDD in Pivotal from the inside: how does it look and is it possible?</a></li>
<li><a href="../354122/index.html">The million question</a></li>
<li><a href="../354124/index.html">Review of materials on machine learning ‚Ññ 3 (April 16 - 23, 2018)</a></li>
<li><a href="../354126/index.html">And if we do not design a system for managing the production of IT products. Part 1. Analysis of box solutions</a></li>
<li><a href="../354128/index.html">Moving from the CIS to the Czech Republic, own experience</a></li>
<li><a href="../354130/index.html">HoleyBeep: explanation and exploit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>