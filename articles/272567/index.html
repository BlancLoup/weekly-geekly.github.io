<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of key performance indicators - part 3, the last, about system and service metrics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are finishing the publication of the test and performance analysis translation from the Patterns & Practices team on what key performance indicator...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of key performance indicators - part 3, the last, about system and service metrics</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <em>We are finishing the publication of the test and performance analysis translation from the Patterns &amp; Practices team on what key performance indicators are needed with.</em>  <em>For the translation, thanks to Igor Shcheglovitov from Kaspersky Lab.</em>  <em>The rest of our articles on testing can be found on the tag <a href="http://habrahabr.ru/search/%3Fq%3D%255Bmstesting%255D%26target_type%3Dposts">mstesting</a></em> </blockquote><br>  In the <a href="http://habrahabr.ru/company/microsoft/blog/271547/">first article of the</a> cycle on the analysis of key performance indicators, we set the context, now turn to specific things.  In the second, we looked at the analysis of user, business indicators / metrics and indicators required for analysis within the application.  In this, the final - about system and service (including dependent services) metrics. <br>  So, <br><br><h3>  System metrics ... </h3><a name="habracut"></a><br>  System metrics allow you to determine which system resources are used and where resource conflicts may occur.  These metrics are aimed at tracking machine-level resources such as memory, network, processor, and disk utilization.  These metrics can provide insights into the internal conflicts underlying the computer. <br>  You can also track these metrics to determine aspects of performance ‚Äî you need to understand if there is a relationship between system metrics and application load.  You may need additional hardware resources (virtual or real).  If the constant load increases the values ‚Äã‚Äãof these metrics, then this may be due to external factors - background tasks, regularly-running tasks, network activity or device I / O. <br><br>  <b>How to collect</b> <br>  You can use <a href="https://msdn.microsoft.com/library/azure/gg433048.aspx">Azure Diagnostics</a> to collect diagnostic data for debugging and troubleshooting, measuring performance, monitoring resource usage, analyzing traffic, scheduling required resources, and auditing.  After collecting the diagnostics, you can transfer it to Microsoft Azure Storage for further processing. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Another way to collect and analyze diagnostic data is to use <a href="https://www.microsoft.com/en-us/download/details.aspx%3Fid%3D28567">PerfView</a> .  This tool allows you to explore the following aspects: <br><br><ul><li>  <b>CPU utilization</b> .  PerfView, using Sampling Tracing technology, periodically (in millisecond intervals) requests the stack of currently executing code and returns the complete stream frame.  Next, PerfView aggregates the collected spectra of various threads together, and you can use the stack viewer utility to see what your code does (and for what processor time), and also remove or correct code that is executed incorrectly. </li><li>  <b>Managed memory</b> .  PerfView can do Managed Heap snapshots, which are controlled by the .net garbage collector.  These snapshots are converted into object graphs, allowing you to analyze the lifetime of objects. </li><li>  <b>Unmanaged memory</b> .  PerfView can capture events when the operating system allocates or frees blocks of memory.  You can use this information to track how your application works with unmanaged memory. </li><li>  <b>Timing and blockages</b> .  PerfView can track and visualize information about when threads fall asleep and wake up.  You can use this information to search for various locks in your application.  This analysis is especially useful when performance issues are observed with low CPU usage. </li></ul><br><br>  Initially, PerfView was designed to run locally, but now it can be used to collect data from the Web and Worker roles of Azure cloud services.  You can use the <a href="https://www.nuget.org/packages/AzureRemotePerfView">AzureRemotePerfView</a> NuGet package to install and run PerfView remotely on role servers, and then download and analyze the data locally. <br>  Windows Azure Diagnostics and PerfView are useful for analyzing the ex post facto resources used.  However, when using practices such as DevOps, you need to monitor ‚Äúlive‚Äù performance data to detect possible performance problems before they even occur.  APM tools can provide such information.  For example, the Troubleshooting tools for web applications on the Azure portal can display various graphs showing memory, processor, and network utilization. <br><br><img src="https://habrastorage.org/files/27a/98c/f07/27a98cf07d0044bbab03bf800d40f7fc.png"><br><br>  The Azure portal has a ‚Äúhealth dashboard‚Äù showing common system metrics. <br><br><img src="https://habrastorage.org/files/582/5c8/f6b/5825c8f6beca4ae3ae741037aa4bc12c.png"><br><br>  Similarly, the Diagnostic panel allows you to track a pre-configured set of commonly used performance counters.  Here you can define special rules under which the operator will receive special notifications, for example, when the value of the counter greatly exceeds a certain value. <br><br><img src="https://habrastorage.org/files/893/087/f36/893087f361534fd5a37ef3740c5c291f.png"><br><br>  Azure web portal can display performance data for 7 days.  If you need to access data for a longer period, then you need to upload performance data directly to Azure Storage. <br>  Websites Process Explorer allows you to view details of individual processes running on a website, as well as track correlations between the use of various system resources. <br><br><img src="https://habrastorage.org/files/9ea/6f2/3ce/9ea6f23ce4bc4b26a7a7605f8c99b1b2.png"><br><br>  New Relic and many other APM have similar functions.  Below are a few examples. <br><br>  Monitoring system resources is divided into categories that cover memory utilization (physical and manageable), network bandwidth, processor performance, and disk input / output (I / O) operations.  The following sections describe what to look for. <br><br>  <b>Physical memory usage</b> <br><br>  All processes running in Windows use virtual memory, which is projected onto the physical by the operating system.  The virtual memory of the process is divided into reserved (reserved) and allocated (commited): <br><ul><li>  Reserved memory is not associated with physical or paged memory stored in the paging file.  It simply describes the amount of memory reserved for the process, and is recorded in a virtual address descriptor (VAD) for the process.  This memory is not associated with physical storage and can be ignored during performance monitoring. </li><li>  The allocated memory is associated with the allocation of physical memory and / or paged file memory.  The use of allocated memory must be monitored. </li></ul><br><br>  You can monitor the disposal of allocated memory to determine if your cloud services or sites have enough memory allocated to support the required business load and handle sudden surges in user activity.  Monitor the following performance counters: <br><ul><li>  Memory \ Commit Limit shows the maximum amount of memory that can be allocated by the system.  Usually this is a fixed value, which is determined by the operating system (more <a href="https://support.microsoft.com/kb/2860880">info for 64-bit versions of Windows</a> ) For example, on a machine with 8Gb of memory, this figure will be about 11Gb. </li><li>  Process \ Private Bytes shows the amount of memory allocated for the process.  If the sum of all private bytes for all processes exceeds the memory limit described above, this means that there is a shortage of memory in the system and applications will fail. </li><li>  Memory \% Committed Bytes in Use is the ratio of Memory / Committed Bytes to Memory \ Commit Limit.  A high value for this counter indicates that there is a large memory load on the system. </li></ul><br><br>  <b>Note:</b> Windows has a Process \ Virtual Bytes counter.  This counter shows the total amount of virtual memory that the process uses, but it should be treated very carefully, because  in fact, it shows the sum of the reserved and allocated process memory.  For example, exploring the Process / Virtual Bytes and .NET CLR Memory \ # total reserved bytes counters when starting the w3wp process, this counter can show 18 GB, although its total memory is 185 MB. <br>  Reserved memory can be expanded with dynamic RAM and processes can convert this memory into physical. <br><br>  There are two main causes of an OutOfMemory error ‚Äî a process exceeds the virtual memory space allocated for it, or the operating system is unable to allocate additional physical memory for the process.  The second case is the most common. <br><br>  You can use the performance counters described below to estimate memory load: <br><br><ul><li> Memory \ Available Mbytes.  Ideally, the value of this counter should exceed 10% of the amount of physical memory installed on the machine.  If the amount of available memory is too small, then there is a chance that the system will begin to use the paging file for active processes.  If the system does not have enough physical memory, then the result may be significant delays and / or a complete system hang. </li><li>  Memory \% Committed Bytes In Use.  The limit of allocated memory will increase if the total amount of allocated memory approaches 90% of the limit value - if the value reaches 95%, the limit will probably stop growing and the likelihood of an OutOfMemory error will appear.  As soon as the amount of allocated memory reaches the limit, the system will no longer be able to allocate memory for processes.  Most of the processes will not cope with this behavior of the system and will stop their execution.  Therefore, it is very important to monitor this counter. </li><li>  Memory \ Pages / sec.  This counter shows how much the system uses the page file.  You can determine the effect a paging has on physical memory ‚Äî to do this, multiply the value of this counter by the value of the Physical Disk \ Avg.Disk sec / Transfer counter.  The result of this operation will be between 0 and 1, and will characterize the proportion of disk access time spent on reading and writing virtual pages to the paging file.  A value of 0.1 means that the system spends more than 10% of the total access time to the disk to work with the paging file.  If this value is constant, then it may indicate physical memory problems. </li></ul><br><br>  It should also be noted that large amounts of memory can lead to fragmentation (when there is not enough free physical memory in neighboring blocks), so a system that shows that it has enough free memory may not be able to allocate this memory for a particular process. <br><br>  Many APM tools provide information on the use of system memory by processes without the need for a deep understanding of how memory works.  The graph below shows the bandwidth (left axis) and response time (right axis) for an application under constant load.  After about 6 minutes, the performance suddenly drops, and the response time starts to ‚Äújump,‚Äù after a few minutes, the indicators appear. <br><br><img src="https://habrastorage.org/files/b52/31e/a1c/b5231ea1c74c4c35ab823d08b527bdb3.png"><br>  Results of load testing of the application <br><br>  Telemetry recorded using New Relic shows redundant memory allocation, which causes the operation to fail and be restored.  Memory usage grows at the expense of the paging file.  This behavior is a classic symptom of memory leakage. <br><br><img src="https://habrastorage.org/files/5af/bdd/3cc/5afbdd3cce7d4020846032eed6d8f90f.png"><br>  Telemetry showing excess memory allocation <br><br>  <b>Note:</b> <a href="http://blogs.msdn.com/b/visualstudioalm/archive/2013/12/20/investigating-memory-leaks-in-azure-web-sites-with-visual-studio-2013.aspx">Investigating Memory Leaks in Azure Web Sites with Visual Studio 2013</a> contains instructions on how to use Visual Studio and Azure Diagnostics to monitor memory usage in a web application in Azure. <br><br>  <b>Managed memory usage</b> <br><br>  .NET applications use managed memory, which is controlled by the CLR (Common Language Runtime).  The CLR projects the managed memory onto the physical.  Applications query the CLR for managed memory, and the CLR is responsible for allocating the required memory and freeing unused memory.  Moving data structures across blocks, CLR provides a layout for this type of memory, thereby reducing fragmentation. <br><br>  Managed applications have an additional set of performance counters.  The <a href="https://msdn.microsoft.com/magazine/cc163528.aspx">Investigating Memory Issues</a> article contains a detailed description of the key counters.  The most important performance counters are described below: <br><br><ul><li>  .NET CLR Memory # Total Committed Bytes A process memory that relies on physical memory and paged disk space.  This counter displays the amount of process memory allocated and should be very similar to the value of the Process / Private Bytes counter. </li><li>  .NET CLR Memory # Total Reserved Bytes indicates the amount of reserved memory for the process.  It should be approximately equal to the value of the Process \ Virtual Bytes counter and less than the Process \ Private Bytes value. </li><li>  .NET CLR Memory \ Allocated Bytes / sec, indicates the variability of a managed heap.  The value of this counter can be positive or negative, depending on whether the application creates or destroys objects.  This counter is updated after each garbage collection cycle.  A permanently positive value for this counter may indicate a memory leak. </li><li>  .NET CLR Memory # Bytes in all Heaps indicates the total size of the managed heap for the process. </li><li>  .NET CLR Memory \% Time in GC is the percentage of time that was spent on executing the last garbage collection cycle.  A good indicator of this counter is &lt;10%. </li></ul><br><br>  <b>Network latency on web server</b> <br><br>  Network performance is especially important for cloud applications, since  it is a conductor through which all information passes.  Network problems can lead to poor performance, which will cause displeasure to users, as network delays lead to an increase in the duration of queries.  Currently, Windows does not provide performance counters for measuring the latency of requests for individual applications.  However, there is Resource Monitor, which is an excellent tool for analyzing network traffic on a local machine (you can configure Remote Desktop during the deployment of your cloud services and log in to the server of your Web or Worker roles).  Resource Monitor provides information about lost packets or information about the total delay of active TCP / IP sessions.  Packet loss gives an idea of ‚Äã‚Äãthe quality of the connection.  The delay indicates the time required to complete the route of the TCP / IP packet.  The figure shows the Network tab in the Resource Monitor. <br><br><img src="https://habrastorage.org/files/901/c58/abd/901c58abde014c048807291c96a00ee8.png"><br>  Resource Monitor showing local network activity <br><br>  <b>Network usage on a web server</b> <br><br>  You can obtain the following performance counters by connecting directly to the web server from the Performance Monitor (if you need real-time information) or set up Azure Diagnostics to save data to Azure Storage. <br><ul><li>  Network Adapter \ Bytes Sent / sec and Network Adapter \ Bytes Received / sec shows the speed at which the network adapter transmits and receives data </li><li>  Network Adapter \ Current Bandwidth is used to estimate the allowable bandwidth (in bytes per second) of the network adapter. </li><li>  % Network utilization for Bytes Sent = ((Bytes Sent / sec * 8) / Current Bandwidth) * 100 </li><li>  % Network utilization for Bytes Received = ((Bytes Received / sec * 8) / Current Bandwidth) * 100 </li></ul><br><br>  If these values ‚Äã‚Äãturn out to be about 100%, then this may indicate a network overload.  In this case, you may need to distribute network traffic to multiple instances of the cloud application. <br><br>  The Azure portal can show network utilization by all instances of the cloud service, as well as a specific role instance.  The portal has Network In and Network Out counters that provide information on the number of bytes received and sent per second. <br><br><img src="https://habrastorage.org/files/ec1/c82/09c/ec1c8209cd73420eac871e7f765664b0.png"><br>  Monitoring Network Usage in the Azure Management Portal <br><br>  If the network latency is very high, but the utilization is low, the network is hardly a bottleneck.  High CPU utilization of application instances may mean that more power is required, and the load should be parallelized between several instances.  If the utilization of the CPU is low, then this may be due to the influence of external services.  For example, complex queries sent to an Azure SQL database can take a long time to execute.  In this situation, the distribution of network traffic between instances may exacerbate performance problems due to database server overload, which will further increase the latency.  You must be prepared to track the use of external services. <br><br>  Note: For more information on network latency and channel width, we recommend that you familiarize yourself with the Windows Sysinternals <a href="https://technet.microsoft.com/sysinternals/jj729731.aspx">PsPing</a> tool. <br><br>  <b>Network traffic</b> <br><br>  Another common cause of delays is a large amount of network traffic.  You must investigate the volume of traffic to external services.  Many APM-tools allow you to track traffic directed towards cloud services and web applications.  The figure shows an example taken from New Relic, which shows the incoming and outgoing network traffic of the Web API service.  A large amount of total traffic (~ 200 MB / sec) results in high latency for clients. <br><br><img src="https://habrastorage.org/files/afa/68d/1da/afa68d1da06b4a00982c7a4b3d8bad32.png"><br><br>  The Azure Management Portal also contains tools for viewing the utilization of external services, such as the Azure SQL Database and Azure Storage. <br><br>  <b>Network overheads and client locations</b> <br><br>  High network delays can be associated with overhead such as protocol interaction, packet loss, and routing effects.  Latency and bandwidth can be highly dependent on the location of clients and the services they work with.  If clients are located in different regions, then the issue of distribution of service instances across regions should be considered, making sure that there will be enough capacity in each region to handle the required load. <br><br>  The graphs below show how geographic distribution of users can affect throughput and latency.  A constant flow of requests within three minutes was sent to the service.  This scenario was used for two tests - in the first one the clients and the server were located in one region, and in the second - in different ones.  In both graphs, the left axis shows the performance in operations per second, and the right axis shows the response time in seconds. <br><br><img src="https://habrastorage.org/files/2dd/3fe/81b/2dd3fe81b1b14e9bbfdb9c6e0e50d56d.png"><br><img src="https://habrastorage.org/files/e35/56a/04c/e3556a04cd3948f69cb698dd3137a8bc.png"><br><br>  In the first graph, the average throughput is several times higher than in the second, and the response time is about ¬º of the response time of the second graph. <br><br>  <b>The size of the payload of the message passing through the network</b> <br><br>  The size of the request and response body can have a significant impact on throughput.  XML requests can be significantly larger than their JSON equivalents.  Binary serialized data may be more compact, but less flexible.  In addition to bandwidth consumption, large requests lead to additional CPU load spent on parsing or deserialization of data. <br><br>  The following graphs illustrate the effect of different sizes of requests for bandwidth and response time.  As before, the same test service was used on both graphs.  Customers and service are located in the same region. <br><br><img src="https://habrastorage.org/files/7c2/5bf/d93/7c25bfd937064b51bf6a733dda28ff68.png"><br><img src="https://habrastorage.org/files/4b9/e4c/834/4b9e4c834f7f48d2b9bacee713a88e4c.png"><br><br>  Here you can see that increasing the size of a message 10 times led to a decrease in throughput and an increase in response time.  It should be noted that this is an artificial test focused on the demonstration of network traffic.  It does not take into account additional processes required for processing requests, and there is also no influence of third-party network traffic generated by other clients or services. <br><br>  <b>"Talkative" in the network</b> <br><br>  Chattiness is another common cause of network latency.  Chatty refers to the frequency of network sessions that are required to complete a business transaction. <br><br>  To detect ‚Äútalkativeness,‚Äù all operations must include telemetry, recording the frequency of the call, and by whom and when they were called.  Telemetry should include the size of the network requests at the input and output of the operation.  A large number of relatively small requests in a short period of time, sent by the same client, may indicate the need to optimize the system by combining these requests into one or several.  As an example, the figure shows the telemetry of the test Web API service.  One or more requests to Azure SQL occur per API call.  During monitoring, the average throughput was 13,900 requests per minute.  The figures also show the telemetry of the database, which shows that during this period of time the service made more than 250000 queries to the database.  These numbers indicate that each time the Web API is called, an average of 18 calls to the database occur. <br><br><img src="https://habrastorage.org/files/b74/0a1/d61/b740a1d61ee74ae682d526282f4b046c.png"><br><img src="https://habrastorage.org/files/804/fd1/c21/804fd1c211ef4b75ac5eafd6e9fb357a.png"><br><br>  <b>Calls to the database that occur when requests to the application</b> <br><br>  CPU usage at server and instance level <br>  CPU utilization (utilization) is a measure that measures the amount of machine work, and the ‚Äúavailability‚Äù of a CPU indicates the amount of spare processor capacity that the machine has to handle the additional load.  Using APM, you can get this information for a specific server running a web service or a cloud application.  The figure shows the statistics of New Relic. <br><br><img src="https://habrastorage.org/files/8ab/225/bb9/8ab225bb9e4041c8898ba67817894798.png"><br><br>  The Azure web portal allows you to view CPU data for each service instance. <br><br><img src="https://habrastorage.org/files/86e/5ca/1be/86e5ca1be4eb4cce941a4de0cc451404.png"><br>  Using CPUs for service instances in the Azure portal <br><br>  High utilization of the CPU can be the result of a large number of exceptions, the generation of which overloads the processor. <br><br>  You can track the frequency of exceptions using the approaches described earlier in the corresponding sections.  Excessive processor utilization may be due to applications in which large garbage collection occurs frequently.  You must examine the CLR Garbage Collections counters as described in the ‚ÄúManaged Memory Usage‚Äù section to evaluate the impact of the garbage collector (GC) on total processor utilization.  You should also make sure that the garbage collection policy is configured correctly on your system (for more, see the <a href="https://msdn.microsoft.com/library/ee787088.aspx">Fundamentals of Garbage Collection</a> ). <br><br>  Low utilization of the CPU in conjunction with high latency can be associated with various locks, which may indicate problems in the code, such as improper use of locks or waiting for synchronous I / O operations (see the <a href="https://github.com/mspnp/performance-optimization/tree/master/SynchronousIO">Synchronous I / O antipattern</a> ). <br><br>  The affinity processor property (binding the process to a specific processor) may cause the processor or processor core to be a bottleneck.  This situation can occur in a cloud application in Azure with a Worker role.  Requests from Web roles can always be sent to a specific Worker role bypassing the load balancer. <br><br>  <b>Using CPU on a specific server</b> <br><br>  The processor operates in two modes: user and privileged.  In user mode, the processor executes the instructions that make up the business logic of the application.  In privileged mode, the processor performs kernel-level operations of the operating system, such as file operations, memory allocation, swapping, thread management, context switching between processes.  To track processor load, monitor the following performance counters: <br><ul><li>  Processor \% Privileged Time the amount of time the processor spends working in privileged mode.  The constant high value of this counter indicates that the system spends considerable time performing the functions of the operating system and may be caused by large amounts of I / O operations, permanent locks of processes or threads, excessive pumping or overhead in managing memory (for example, garbage collection) . </li><li>  Processor \% User Time, the time that the processor spends on executing application code, not system functions. </li><li>  Processor \% Processor Time total CPU usage (in user and privileged modes).  Usually, processor load varies between high and low values, but a constantly high level (over 80%) means that the processor may be a bottleneck.  For example, the <a href="https://github.com/mspnp/performance-optimization/tree/master/BusyFrontEnd">Busy Front End anti-pattern</a> shows a situation where the load is initially focused on a single Web role, and also shows how to improve the response time when using a queue to transfer data processing to individual worker roles. </li></ul><br><br>  <b>CPU-intensive processes</b> <br><br>  You can investigate the possible causes of high process load in a test environment during load testing.  Such an approach should help eliminate the influence of external factors.  Many APM tools support thread profiling to analyze how the processor performs stack operations.  The figure shows an example of profiling in New Relic. <br><br><img src="https://habrastorage.org/files/619/8c6/90a/6198c690ade2431aac8238c8f685a547.png"><br><br>  <b>Profiling in New Relic</b> <br><br>  After profiling for a certain period of time, New Relic allows you to analyze this information and investigate operations that spend the most CPU time.  The received information can be a signal for code optimization. <br>  This technique is a very powerful tool, but it can have a significant impact on the performance of real users.  Thus, when conducting this process on a real environment, you must immediately turn off the profiler after collecting data. <br><br>  <b>Disk usage</b> <br><br>  High frequency input / output (I / O) operations are usually caused by tasks such as business intelligence or image processing.  In addition, many data storage services (for example, Azure SQL Database, Azure Storage, and Azure DocumentDB) make extensive use of disk resources.  If you create virtual machines to start your services, then you may need to monitor disk access.  This is to make sure that you select the correct disk configuration to ensure good performance. <br><br>  Memory-intensive applications can also trigger significant disk activity.  Memory overflow can lead to an increase in size and, as a result, a decrease in performance.  In this case, it may be necessary to scale the role horizontally to redistribute the load across several instances, but before that you should analyze your application for proper memory usage (the cause may be a banal leak). <br><br>  In Azure, virtual disks (used in virtual machines) are created in Azure Storage.       Azure Storage:   Premium.        -  ,       . IOPS (  / ‚Äì  . Input/Output Operations Per Second) ‚Äì       .      500  -      60 /. Premium-   SSD-       5000  -      200 /. <br><br>  RAID-        ,        I/O        .  . <a href="https://azure.microsoft.com/documentation/articles/virtual-machines-size-specs/">Sizes for Virtual Machines</a> . <br><br> <b>:</b> IOPS        I/O-. ,      ,  ,     IOPS     . ,      ,           IOPS.         I/O    . <br><br>       ()  <a href="http://www.microsoft.com/download/details.aspx%3Fid%3D20163">SQLIO Disk Subsystem Benchmark Tool</a> .  ,          ,     : <br><br><img src="https://habrastorage.org/files/72f/f7e/efa/72ff7eefac134cb0b532af57405dfeea.png"><br>  I/O       <br><br> ,  ,   ,    500   .   ,   RAID-,   4-  (      Azure Storage)   . <br><br><img src="https://habrastorage.org/files/9de/1ef/273/9de1ef273c3b4d0a9bf27d2f392e0ccf.png"><br>  I/O  striped- <br><br>      1400 IOPS.      Premium-,     80000 IOPS     . <br>  ,    ()      Azure.   ,     IOPS    Premium- (5000 IOPS)        (  RAID)     .   ,      () I/O      IOPS            .  . Premium Storage: High-Performance Storage for Azure Virtual Machine Workloads. <br><br>  Azure      I/O   .   APM-      .      ,   New Relic.     I/O-,   ,     .  , ,     100%,   IOPS   1500.       RAID`  4-  ( ): <br><br><img src="https://habrastorage.org/files/b77/536/99e/b7753699e0ae4bc7b01d363f8517e187.png"><br><br>      ,     ( Physical Disc): <br><ul><li> Avg. Disk sec/Read  Avg. Disk sec/Write.    ( )    .           ,        .   (payload)   64       15     .  -   I/O     ,   ,             . </li><li> Disk Transfers/sec.        .  ,      ,     ,     IOPS.        I/O-  .       ,         .                . ,   ,    100       10 ,          50     20   .        (,     ).                 . </li><li> Disk Bytes/Sec, Disk Read Bytes/sec  Disk Writes Bytes/sec.        ,      .    1 MB  256      4 ,       .   ,        15 ,      I/O ,   Avg. Disk Bytes/Read  Avg. Disk Bytes/Write </li><li> Avg. Disk Queue Length, Avg. Disk Read Queue Length, and Avg. Disk Write Queue Length.      I/O ,   ( ).     : </li><li> Avg. Disk Queue Length = (Disk Transfers/sec) * ( Disk sec/Transfer) <br>          , ..           . </li><li> % Idle Time.       .     .     ,  .     1  ,  %idle time    0.   ,      ,     ,      (      ). </li></ul><br><br><h3> <b> </b> </h3><br>      Azure       ,   ,    .         ,      . <br><br>  ,    ,     (backend pressure).  ,  ,       ,     .           .  ,             . <br><br> <b> ?</b> <br><br>  Azure      Azure (Storage, SQL DB, Service Bus  ..).         APM. <br><br>          .              .        ,       ,     .        ,            . <br><br> <b> ?</b> <br><br>   ,    -,        SLA.       .      -   Azure.  ,         , ..      . <br><br> <b> Azure Storage</b> <br><br>            Azure Storage. ,       -. C (end-to-end)    Azure Storage    ,    . <br>  Azure   Azure Storage,            -.           ,          . <br><br><img src="https://habrastorage.org/files/0eb/88d/496/0eb88d496e014c4c85f9305ea3f0c99d.png"><br>     Azure <br><br> <b>     Azure Storage</b> <br><br>         . Azure Storage      .       (Premium     ).           ,     .  ,       ,        . <br>              Azure.  ,        .               . <br><br><img src="https://habrastorage.org/files/570/4ed/b66/5704edb6617d4f84891fc1b884287308.png"><br>      ,      Azure <br><br> <b>   Azure SQL</b> <br><br>      ,  Azure SQL Database,  ,     -       .         Azure   . <br><br><img src="https://habrastorage.org/files/7a8/eb3/ae3/7a8eb3ae3f214671aed59f73b13ea741.png"><br>      Azure <br><br> Azure SQL Database  Microsoft. Microsoft   SLA,      99.9%. ,      (     )      . <br><br>    ,          ,      ,       (,     ).         APM,         .     New Relic         .          ,         -. <br><br><img src="https://habrastorage.org/files/c91/ac7/b59/c91ac7b59ebe45fd88026b6b44d3cdd7.png"><br><br> <b>      New Relic</b> <br><br>         ,      .       .        ,        (,    ,    ).        Azure. <br><br> <b>Azure SQL Database DTU</b> <br><br>     AZURE SQL database   Database Throughput Units,  DTU. DTU  ,     ,   I/O .     SQL Azure,    .       DTUs ( 5 DTU      1750   Premium/P11).        DTU,     ,      .   ,     DTU  ,   Azure.   ,           . <br><br><img src="https://habrastorage.org/files/4e1/086/c93/4e1086c93e3d4e33871e93c744fd905f.png"><br>  DTU   Azure <br><br> <b>  Azure SQL</b> <br><br>        ,    ,     ,       ,       .               .          CPU, Data I/O, Log I/O,  , ,   ,    .      ,            (  ). <br><br>    Dynamic SQL      ,    ,        .           sys.dm_db_resource_stats,    ,            ( ,          80%). <br><br><pre><code class="sql hljs">(COUNT(end_time) - SUM(CASE WHEN avg_cpu_percent &gt; 80 THEN 1 ELSE 0 <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) * <span class="hljs-number"><span class="hljs-number">1.0</span></span>) / <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(end_time) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'CPU Fit Percent'</span></span> ,(<span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(end_time) - <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> avg_log_write_percent &gt; <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) * <span class="hljs-number"><span class="hljs-number">1.0</span></span>) / <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(end_time) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Log Write Fit Percent'</span></span> ,(<span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(end_time) - <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> avg_data_io_percent &gt; <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) * <span class="hljs-number"><span class="hljs-number">1.0</span></span>) / <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(end_time) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'Physical Data Read Fit Percent'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_db_resource_stats<span class="hljs-string"><span class="hljs-string">``</span></span><span class="hljs-string"><span class="hljs-string">`</span></span></code> </pre> <br><br>  If this query for any of the 3 requested metrics returns a value less than 99.9%, then you should consider switching to a higher level of database performance or optimize to reduce the load on the database. <br>  This information is also available on the Azure portal: <br><br><img src="https://habrastorage.org/files/afe/7e4/177/afe7e4177505466bb81cf3dd17b0da56.png"><br>  Azure SQL statistics on the Azure portal <br><br>  <b>Query performance</b> <br><br>  Inefficient database queries can significantly affect latency and throughput, and can also cause excessive resource consumption.  You can retrieve information about queries from dynamic views and visualize this data in the Azure SQL portal. The Query Performance page displays cumulative statistical data on completed queries for the last hour, including processor utilization and I / O operations for each query: <br><br><img src="https://habrastorage.org/files/e86/64f/92e/e8664f92e7f84d248c7f267e656e7d06.png"><br>  Query performance on the Azure SQL portal <br><br>  You can drill down on the most difficult queries by looking at plans to fulfill them.  This data can help determine the reasons for long-running queries, as well as optimize them. <br><br><img src="https://habrastorage.org/files/013/0ff/f90/0130fff901174446b4e407a0b3524548.png"><br>  Query execution plan for the Azure SQL portal <br><br>  <b>A large number of queries to the database</b> <br><br>  Large amounts of traffic between the application and the database may indicate a lack of caching.  You need to analyze retrieved data, i.e., for example, when your application constantly requests and updates the same data, cache it locally in the application or in a shared distributed cache.  The Query Performance page in the Azure SQL portal provides useful information in the form of an execution graph, as well as the number of executions (Run Count) for each query. <br><br><img src="https://habrastorage.org/files/576/b3f/74c/576b3f74c0e4468f95c6710418c8ec21.png"><br>  Query frequency monitoring on the Azure SQL portal <br><br>  Queries that are executed very often (have a high Run Count) do not necessarily return the same data (some queries are parameterized by a special optimizer), but can serve as a starting point for determining candidates for caching. <br><br>  <b>Deadlocks in Azure SQL</b> <br><br>  In some non-optimal transactions, deadlocks may occur.  When a deadlock occurs, it is necessary to roll back the transaction (rollback) and re-execute it later.  Frequent deadlocks can cause significant performance degradation.  You can track deadlocks in the Azure SQL portal, and if they occur, analyze the application‚Äôs trace in runtime to determine the cause. <br><br>  <b>Latency Service Bus</b> <br><br>  High levels of latency when accessing the Service Bus (hearing bus, then SB) may be a performance bottleneck.  They can be due to a number of reasons, including network (for example, loss of packets related to the remoteness of the SB namespace from the client), competition within the SB (topics, queues, subscriptions, event hubs, and access errors. The Azure portal provides a limited set of performance metrics SB for queues, topics and event hubs. However, you can get more detailed information about performance (latency of send and receive operations, connection errors, etc.) by adding a collection of Microsoft Az counters to your application code.  ure Service Bus Client Side Performance Counters (https://www.nuget.org/packages/WindowsAzure.ServiceBus.PerformanceCounters) <br><br>  <b>Denial of connection to the Service Bus and throttling</b> <br><br>  SB queues, topics and subscriptions have quotas that can limit their bandwidth.  For example, these include the maximum size of a queue or topic, the number of simultaneous connections and simultaneous requests.  If these quotas are exceeded, the SB will reject further requests.  For more information, see <a href="https://azure.microsoft.com/documentation/articles/service-bus-quotas/">azure.microsoft.com/documentation/articles/service-bus-quotas</a> .  You can control the amount of traffic passing through the queues and topics SB, on the portal portal Azure. <br><br>  The volume of the event hub is determined in bandwidth units and is set at creation.  One bandwidth unit equals 1 MB / s for incoming traffic (ingress) and 2 MB / s for outgoing traffic (egress).  If the application exceeds the set number of bandwidth units, the speed of receiving and sending data will be cut.  As with queues and tops, you can control the speed of the event hub in the Azure portal.  It should be noted that the quotas for incoming and outgoing traffic are applied separately. <br><br>  <b>Failed Requests and Poison Message in Service Bus</b> <br><br>  Monitor the frequency of message processing errors and the total amount of poison messages for which the maximum number of processings has been exceeded.  Depending on the design of the application, even one error message can slow down the entire system.  Analyze failed requests and poison messages. <br><br>  <b>Event Hub Quota Exceptions</b> <br><br>  Cloud applications can use Azure Event Hub as storage for aggregating large amounts of data (in the form of asynchronous events) received from the client.  Event Hub supports high speed inbound events with low latency and high availability, and is used in conjunction with other services to which it sends events for further processing. <br><br>  The capacity of the event hub is controlled by the number of units of bandwidth that are set at the time of purchase.  One unit supports: <br><br>  * <b>Ingress</b> : up to 1MB of data per second or 1000 events per second. <br>  * <b>Egress</b> : up to 2MB per second. <br><br>  Inbound traffic is governed by the number of available bandwidth units.  If exceeded, exceptions "quota exceeded" occur.  When exceeding outgoing traffic exceptions do not occur, but the speed is limited by the volume of units of bandwidth (in the base case, 2 MB per second). <br><br>  You can control the operation of the event hub by viewing the dashboard in the Azure portal: <br><br><img src="https://habrastorage.org/files/acc/e09/2a7/acce092a773f468baddc5b5b087a2c9d.png"><br>  Monitoring Event Hubs on the Azure portal <br><br>  If you see exceptions related to the number of publications or do not see the expected outgoing traffic, check the number of units of bandwidth set for your project in the Azure portal on the Scale page. <br><br><img src="https://habrastorage.org/files/066/142/8cd/0661428cd83546c38fd9d5b1310357fa.png"><br>  Bandwidth Allocation for Event Hub <br><br>  <b>Mistakes with Event Hub leasing</b> <br><br>  An application can use the __EventProcessorHost_ object to distribute the workload across the consumers of an event.  The __EventProcessorHost_ object creates an Azure Storage blob lock for each event concentrator section and uses these blobs to manage the sections (receiving and sending events).  Each _EventProcessorHost_ instance performs two functions: <br><br>  1. Extension of locks: the lock is currently owned by the instance and periodically extended if necessary <br>  2. Creating locks: each instance continuously checks all existing locks for expiration and, if they are, it locks <br><br>  You should monitor the frequency of repetitive message processing and blob blocking. <br><br>  <b>Using dependent services</b> <br><br>  In addition to Storage, SQL Database and Service Bus, there are a large number of Azure services, and their number is constantly growing.  It is not possible to cover every service, but you must be prepared to control the key aspects that each of the services you use provides.  As an example, if you use Azure Redis Cache to implement a shared cache, you can determine its effectiveness by analyzing the following issues: <br><br>  * How much data gets into and misses the cache every second? <br><br>  This information is available on the Azure portal: <br><br><img src="https://habrastorage.org/files/57e/e9a/ae1/57ee9aae19e14d84ae2af86a56af9c41.png"><br>  Monitor Azure Redis Cache on the Azure portal <br><br>  After the system has reached a fully operational state, and at the same time the caching rate is low, then you may need to adjust the caching strategy. <br><br>  <b>How many clients connect to the distributed cache?</b> <br><br>  You can control the number of connected clients using the Azure portal. <br>  The limit of simultaneous connections is 10,000. When this limit is reached, subsequent connection attempts fail.  If your application constantly reaches this limit, then you should consider distributing the cache between users. <br><br>  <b>How many operations (receive and write) occur in a cache cluster every second?</b> <br>  You can view the Gets and Sets counters in the Azure portal. <br><br>  <b>How much data is stored in the cache cluster?</b> <br>  The Used Memory counter in the Azure portal shows the cache size.  The total allowed cache size is set at creation time. <br><br>  <b>What is the level of delays in accessing the cache?</b> <br><br>  You can track the Cache Read and Cache Write counters in the Azure portal to determine the speed of reading and writing the cache (measured in KB / s). <br><br>  <b>How busy is the cache server?</b> <br>  Monitor the Server Load counter in the Azure portal.  This counter shows the percentage of time that the Redis Cache server is busy processing requests.  If this counter reaches 100%, it means that the Redis Cache server CPU time has reached its maximum, and the server will not be able to work faster.  If you observe sustained high server load, then probably some requests will fall in timeout.  In this case, you should consider increasing cache resources or partitioning data across multiple caches. <br><br>  <b>Summarizing</b> <br><br><ul><li>  Use telemetry to obtain performance data: </li><li>  Business transactions  Monitor all external API calls.  Special attention should be paid to critical business operations. </li><li>  Browser metrics.  Capture information about new and returning users, as well as their browser types </li><li>  Monitor incoming and outgoing network traffic </li><li>  Monitor the memory used and how it relates to the business load </li><li>  CPU utilization and thread utilization </li><li>  The length of the queues and the waiting time for requests in the queue </li><li>  External services.  Their latency and bandwidth, as well as errors. </li><li>  Use telemetry to create an alert to monitor business exceptions and SLA violations. </li><li>  Monitoring and collecting telemetry should not be used only to solve performance problems (reactive approach).  Be active in using this information, because it can give you a picture of how your current server capacity will later relate to the growth of business load or how unexpected user behavior will affect the normal functioning of your system. </li><li>  Performance analysis is a cyclical research process involving observation, measurement, and verification.  Not every approach gives positive results.  This should be budgeted for.  This is a continuous, continuous process that lasts throughout the life cycle of the system. </li><li>  Do not focus on low-level details.  Assess engineering skills in the context of a specific task.  You do not need to understand in detail in each performance counter.  Instead, you need to focus on how they relate to the business activity of users and analyze the impact of the latter on them. </li><li>  Provide opportunities to enable and disable telemetry (as well as changes to its level of detail), as it can have a significant impact on the daily operation of the system.  For example, profiling should not work all the time, but it should be turned on when the operator tries to identify performance problems.  If possible, use the settings of your application to selectively enable telemetry. </li><li>  Using operating system tools, rather than external APMs, is the preferred approach. </li></ul><br><br>  Thank you all for your attention! <br><br>  Parts of the article: <br>  <a href="http://habrahabr.ru/company/microsoft/blog/271547/">Key Performance Indicator Analysis - Part 1</a> <br>  <a href="http://habrahabr.ru/company/microsoft/blog/272467/">Analysis of key performance indicators - Part 2, analysis of user, business and application metrics</a> <br>  <a href="http://habrahabr.ru/company/microsoft/blog/272567/">Analysis of key performance indicators - part 3, the last, about system and service metrics.</a> </div><p>Source: <a href="https://habr.com/ru/post/272567/">https://habr.com/ru/post/272567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272555/index.html">Next, in search of palindromes 2</a></li>
<li><a href="../272557/index.html">We are again on Habr√©</a></li>
<li><a href="../272559/index.html">Django: How to quickly get unnecessary duplicates in a simple QuerySet</a></li>
<li><a href="../272563/index.html">Some new settings in Linux Mint Release 17.3 LTS 12/04/2015</a></li>
<li><a href="../272565/index.html">How to improve the analysis and management of network traffic by watching the DNS</a></li>
<li><a href="../272569/index.html">Software design for beginners using the snowflake method</a></li>
<li><a href="../272571/index.html">Call event handlers thread-safe without extra assignment in C # 6</a></li>
<li><a href="../272573/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 21. "Master Splyntr"</a></li>
<li><a href="../272575/index.html">Minimum font size and default encoding in Vivaldi 1.0.344.5</a></li>
<li><a href="../272577/index.html">How to copy Skype and Google Chrome and Mozilla Firefox settings profiles from one / home to another</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>