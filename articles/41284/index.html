<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Install Windows in QEMU under FreeBSD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The installation process of QEMU is covered in the network rather vaguely. All more or less detailed articles that I managed to find have unpleasant f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Install Windows in QEMU under FreeBSD</h1><div class="post__text post__text-html js-mediator-article">  The installation process of QEMU is covered in the network rather vaguely.  All more or less detailed articles that I managed to find have unpleasant features: <br><br>  First, these articles are outdated.  For example, to raise the network bridge in the new 7th FreeBSD, instead of the outdated bridge, use if_bridge. <br><br>  Secondly, the authors of these articles somehow casually miss some important points, without which the step-by-step implementation of the described procedures has no effect.  For example, there is no clear indication that to run QEMU you need either root privileges or configured sudo. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Third, the articles set forth some extra procedures that are not directly related to the case.  For example, it describes how to export the QEMU window installed on the server to the local Windows. <br><br>  Simply put, these articles do not work.  So I decided to write my article, with blackjack and whores. <br><br><a name="habracut"></a>  Go. <br><br>  1) Install QEMU <br><blockquote><code><b># cd /usr/ports/emulator/qemu <br> # make -DWITH_KQEMU <br> # make install</b></code> </blockquote> <br>  QEMU is easy to install from the ports; you just need to remember to assemble it with the support of the KQEMU acceleration module.  In principle, this module is not mandatory, but QEMU works with it much faster. <br><br>  2) load the acceleration module <br><blockquote> <code><b># kldload kqemu</b></code> </blockquote> <br>  In order for the module to load when loaded, you need to add a line to the /boot/loader.conf configuration file: <br><blockquote> <code>kqemu_load="YES"</code> </blockquote> <br>  3) We load the asynchronous I / O module <br><blockquote> <code><b># kldload aio</b></code> </blockquote> <br>  In order for the module to load when loaded, you need to add a line to the /boot/loader.conf configuration file: <br><blockquote> <code>aio_load="YES"</code> </blockquote> <br>  4) Create a hard disk image, on which we will install Windows <br><blockquote> <code><b>$ mkdir /home/user/qemu <br> $ qemu-img create /home/user/qemu/windows.img 4096M</b></code> </blockquote> <br>  Place the image in the home directory.  However, this is not significant, you can place anywhere.  The image size is 4 gigabytes (for Windows itself and a couple of installed programs, this is enough; if needed, you can do more). <br><br>  5) Install Windows <br><blockquote> <code><b>$ qemu -localtime -m 512 -boot d -cdrom /home/user/windows_install.iso -hda /home/user/qemu/windows.img -name "Windows"</b></code> </blockquote> <br>  In this case, Windows is installed from the CD image.  If you are installing Windows from a real CD, then instead of the /home/user/windows_install.iso image, you must specify the device / dev / acd0. <br><br>  What does all this garbage mean: <br><br>  -localtime sets the time in Windows to equal FreeBSD time <br>  -m sets the size of memory in megabytes to be allocated for Windows. <br>  -boot tells QEMU where to boot from (d - CD, c - hard disk) <br>  -cdrom specifies the path to the CD <br>  -hda specify the path to the hard disk <br>  -name displays the name of the operating system running in it in the QEMU window header (optional, purely for beauty) <br><br>  6) Start Windows <br><blockquote> <code><b>$ qemu -localtime -m 512 -boot c /home/user/qemu/windows.img -name "Windows"</b></code> </blockquote> <br>  Please note - Windows boots from a hard disk image (-boot c option). <br><br>  On this, in fact, everything.  Windows is running QEMU running FreeBSD. <br><br>  And now - blackjack and whores. <br><br>  Windows running in QEMU does not have access to the network.  In order for Windows to go online, you need to make some effort. <br><br>  Imagine that we have two computers, one of which is connected to the network.  We want the second computer, which does not have its own access to the network, however, could also go online.  To do this, we are a computer that does not have a network, connect to the computer on which the network is.  And we set up the computer on which there is a network so that it passes all packets that it sends to the second computer through itself to the network.  Thus, the first computer becomes a kind of ‚Äúbridge‚Äù for the second company, through which the network-free computer can enter the network. <br><br>  This connection is called a ‚Äúnetwork bridge‚Äù. <br><br>  In our case, FreeBSD, which has access to the network, acts as the first computer, and Windows, running QEMU, as the second company that does not have access to the network.  Accordingly, our task is to connect Windows to FreeBSD, and FreeBSD, in turn, to configure it so that it passes packets sent from Windows to itself through the network. <br><br>  The network bridge in FreeBSD 7.0 is created using the if_bridge module.  The network bridge if_bridge was ported from NetBSD and, starting with version 7 of FreeBSD, replaced the outdated network bridge. <br><br>  0) Find out what is the name of the real physical interface through which the network works in FreeBSD <br><br>  I have it called em0, your name may be different, for example, rl0. <br><br>  1) Create a virtual network interface to which Windows will be connected. <br><blockquote> <code><b># ifconfig tap0 create</b></code> </blockquote> <br>  2) Create a virtual network interface that will act as a bridge <br><blockquote> <code><b># ifconfig bridge0 create</b></code> </blockquote> <br>  3) We integrate interfaces into a bridge <br><blockquote> <code><b># ifconfig bridge0 addm em0 addm tap0 up</b></code> </blockquote> <br>  In order for the bridge to be created at boot time, you need to add two lines to the /etc/rc.conf configuration file: <br><blockquote> <code>cloned_interfaces="tap0 bridge0" <br> ifconfig_bridge0="addm em0 addm tap0 up"</code> </blockquote> <br>  This completes the creation of a network bridge.  ifconfig should show something like this: <br><blockquote> <code><b>$ ifconfig</b> <br> em0: flags=8943&lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500 <br> options=198&lt;VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,TSO4&gt; <br> ether 00:1c:c0:2a:25:3d <br> inet 192.168.216.10 netmask 0xffffff00 broadcast 192.168.216.255 <br> media: Ethernet autoselect (100baseTX &lt;full-duplex&gt;) <br> status: active <br> tap0: flags=8902&lt;BROADCAST,PROMISC,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500 <br> ether 00:bd:f3:19:00:00 <br> bridge0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500 <br> ether 5e:54:49:fc:f9:f0 <br> id 00:00:00:00:00:00 priority 32768 hellotime 2 fwddelay 15 <br> maxage 20 holdcnt 6 proto rstp maxaddr 100 timeout 1200 <br> root id 00:00:00:00:00:00 priority 32768 ifcost 0 port 0 <br> member: tap0 flags=143&lt;LEARNING,DISCOVER,AUTOEDGE,AUTOPTP&gt; <br> member: em0 flags=143&lt;LEARNING,DISCOVER,AUTOEDGE,AUTOPTP&gt;</code> </blockquote> <br>  As you can see, here we have a real physical interface em0, a virtual interface tap0 and a bridge bridge0.  Pay attention: inside bridge0 there are two members - these are em0 and tap0 interfaces connected by a bridge. <br><br>  Now you need to connect Windows to FreeBSD. <br><br>  4) Turn on automatic tap0 interface lifting <br><blockquote> <code><b># sysctl net.link.tap.up_on_open=1</b></code> </blockquote> <br>  In order for this variable to be initialized when loading, you need to add a line to the configuration file /etc/sysctl.conf: <br><blockquote> <code>net.link.tap.up_on_open=1</code> </blockquote> <br>  5) Allow unprivileged user to connect to tap0 interface <br><blockquote> <code><b># sysctl net.link.tap.user_open=1</b></code> </blockquote> <br>  In order for this variable to be initialized when loading, you need to add a line to the configuration file /etc/sysctl.conf: <br><blockquote> <code>net.link.tap.user_open=1</code> </blockquote> <br>  6) Allow an unprivileged user to open the device / dev / tap0 <br><blockquote> <code><b># chmod 666 /dev/tap0</b></code> </blockquote> <br>  Here is a delicate moment - device files are re-created every time the system is booted, so access rights to the file after rebooting will return to their original state (600).  Therefore, you should set the permissions to the device not through chmod, but through the devfs rules.  To do this, add a line to the configuration file /etc/devfs.conf: <br><blockquote> <code>perm tap0 0666</code> </blockquote> <br>  And finally, run Windows. <br><br>  7) Run Windows with network support <br><blockquote> <code><b>$ qemu -localtime -m 512 -boot c /home/user/windows.img -name "Windows" -net nic -net tap,ifname=tap0</b></code> </blockquote> <br>  As you can see, two -net parameters have been added to the normal startup parameters. <br><br>  The first -net with a value of nic creates a QEMU network card ‚Äúinside‚Äù that Windows will see and use next. <br><br>  The second -net with a tap value connects this network card to the virtual interface tap0.  The option ifname = tap0, separated by a comma, means that you need to connect to the tap0 interface.  In principle, this is not a mandatory option, but sometimes, for whatever reasons, QEMU tries to connect not with default tap0, but, say, to tap1 or tap4.  In this case, you can explicitly specify the desired interface by adding this option. <br><br>  All booted, Windows will detect the network card and will go to the network through it. <br><br>  Original article: <br><br>  <a href="http://m-ivanov.livejournal.com/3384.html">m-ivanov.livejournal.com/3384.html</a> <br><br>  Additional materials about QEMU: <br><br>  <a href="http://www.ibm.com/developerworks/ru/library/l-qemu/index.html">www.ibm.com/developerworks/ru/library/l-qemu/index.html</a> <br>  <a href="http://community.livejournal.com/ru_root/710103.html">community.livejournal.com/ru_root/710103.html</a> <br>  <a href="http://www.opennet.ru/base/sys/qemu_win.txt.html">www.opennet.ru/base/sys/qemu_win.txt.html</a> <br>  <a href="http://ru.gentoo-wiki.com/%25D0%259F%25D0%25BE%25D0%25B4%25D0%25BA%25D0%25BB%25D1%258E%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%2592%25D0%259C_qemu_%25D0%25B2_%25D0%25BB%25D0%25BE%25D0%25BA%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%2583%25D1%258E_%25D1%2581%25D0%25B5%25D1%2582%25D1%258C">ru.gentoo-wiki.com/%D0%9F%D0%BE%D0%B4%D0%BA%D0%BB%D1% 8E%D1%87% D0% B5% D0% BD% D0% B8% D0 % B5_% D0% 92% D0% 9C_qemu_% D0% B2_% D0% BB% D0% BE% D0% BA% D0% B0% D0% BB% D1% 8C% D0% BD% D1% 83% D1% 8E_ % D1% 81% D0% B5% D1% 82% D1% 8C</a> <br>  <a href="http://www.michurin.com.ru/qemu.shtml">www.michurin.com.ru/qemu.shtml</a> <br><br>  And also about setting up a network bridge: <br><br>  <a href="http://www.opennet.ru/base/net/net_bridge.txt.html">www.opennet.ru/base/net/net_bridge.txt.html</a> <br>  <a href="http://www.bsdportal.ru/viewtopic.php%3Fp%3D93244%26sid%3D915bbd7f20ecd5765f078824486bb6c3">www.bsdportal.ru/viewtopic.php?p=93244&amp;sid=915bbd7f20ecd5765f078824486bb6c3</a> </div><p>Source: <a href="https://habr.com/ru/post/41284/">https://habr.com/ru/post/41284/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../41278/index.html">Do not call yourself Westwood!</a></li>
<li><a href="../41279/index.html">GPRS - Theory and Practice of Application</a></li>
<li><a href="../41280/index.html">Songsterr - tablature that you can listen to. Continuation</a></li>
<li><a href="../41282/index.html">Match task. Move 2 ch. To get 4 identical squares.</a></li>
<li><a href="../41283/index.html">If now the book ‚ÄúAccelerate your site‚Äù based on webo.in appeared in the store, then ...</a></li>
<li><a href="../41287/index.html">Business bricks</a></li>
<li><a href="../41291/index.html">Google Workshop in Crimea</a></li>
<li><a href="../41293/index.html">iPhone - DIY</a></li>
<li><a href="../41296/index.html">Cheat Sheet for Designers</a></li>
<li><a href="../41297/index.html">New geographic domain to be?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>