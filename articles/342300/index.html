<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How not to put thousands of servers using centralized configuration management using the example of CFEngine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! My name is Dmitry Samsonov, I work as a leading system administrator at Odnoklassniki. My main areas of expertise are Zabbix, CFEngine and L...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How not to put thousands of servers using centralized configuration management using the example of CFEngine</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/fu/tp/yv/futpyvkzrmedc--nzrvz5fbgiii.gif"></p><br><p>  Hi, Habr!  My name is Dmitry Samsonov, I work as a leading system administrator at Odnoklassniki.  My main areas of expertise are Zabbix, CFEngine and Linux Optimization.  We have more than 8 thousand servers and 200 applications, which in various configurations form 700 different clusters.  The topic of this article is exhaustively described in the title. </p><br><p>  Just want to make a reservation: </p><br><ul><li>  I will be biased because I participated in the implementation of CFEngine in Odnoklassniki. </li><li>  I used CFEngine only versions 3.3-3.4. </li><li>  I have no illusions about CFEngine, this is a significant player, but not a market leader and not an outsider.  The article will not compare CFEngine with other systems. </li><li>  From configuration systems, I have experience using only CFEngine and Ansible. </li></ul><a name="habracut"></a><br><h2 id="klassicheskie-sredstva-konfiguracii">  Classic Configuration Tools </h2><br><p>  First, let's talk about the classic systems that you are familiar with: ssh, scp, mstsc, winexe - all of them are good, but not suitable for configuring a large number of servers and managing them. </p><br><p>  When we had more than a couple dozen servers in the project, we wrote our shell over the dssh-command + dscp + dwinexe-command utilities, which in the beginning have the letter d - distributed.  They can do everything the same, but on a large number of servers at the same time. </p><br><p>  Another tool in our arsenal is the image of the operating system.  If we needed to change any config in the OS, we would use dssh to go through the entire production, and then change the operating system image so that the new servers could immediately get this config, and considered the work done. </p><br><p>  First of all, I want to dwell on the dssh-command utility, because initially it contained absolutely no protection: what she was told to do was what she would do, no additional checks. </p><br><pre><code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># cqn feeds-portlet-cdb | dssh-command -t 300 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"date"</span></span></span></span></code> </pre> <br><p>  Cqn is a CLI command that allows you to get a list of servers from the CMDB.  We receive the list, give it to the standard input <code>dssh-command</code> and ask to execute the <code>date</code> command on these servers.  The <code>-t 300</code> operator is a timeout for which both the running command and all the commands generated by it are killed. </p><br><p>  Why do you need it?  There was an interesting incident, the server worked, worked, then - bang!  - on it the application fell.  They began to investigate: at this moment, none of the system administrators interacted with the server, but some time before the connection was made, the administrator launched the <code>lsof</code> command without any parameters, and in this case, it starts scanning absolutely all file descriptors, that is, connections , files and so on.  Moreover, one of the running applications required a huge number of threads and opened many connections.  As a result, one <code>lsof</code> team <code>lsof</code> lot of gigabytes of memory, after which OOM Killer was launched and killed everyone. </p><br><p>  Then you need to confirm the input command.  Most of these tools usually ask only ‚ÄúYes / No‚Äù, and ‚ÄúYes‚Äù is often the default choice.  So, in essence, such protection does not save us from problems.  But here, as a confirmation, you need to enter the correct result of a mathematical operation: </p><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">How</span></span> much <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> + <span class="hljs-number"><span class="hljs-number">8</span></span> =</code> </pre> <br><p>  We have a chance to think again whether we really want to do exactly what we wrote on the command line.  Moreover, this calculator appears not once, but with each double increase in the volume of servers. </p><br><p>  We entered the correct answer, the command starts to run. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Correct</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">srvd1352</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:O</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Fri</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Oct</span></span> 14 13<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:17</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:52</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MSK</span></span> 2016 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Executing</span></span>: "<span class="hljs-selector-tag"><span class="hljs-selector-tag">date</span></span>"</code> </pre> <br><p>  But it is also not executed on all servers at once.  First on one.  The fact is that the team may simply be wrong.  If it is an oneliner, then it is very easy to make a mistake, so we‚Äôll make sure on one server that exactly what is needed is entered into the command line, and the expected result is obtained. </p><br><p>  Further, the command will be executed on one data center.  All production is located in several data centers, all of which are independent of each other.  We can lose thousands of servers in one data center - and users will not notice. </p><br><p>  Nevertheless, no one wants to lose the whole DC.  To prevent this from happening, in addition to the mentioned protection mechanisms, the command will be executed simultaneously on a maximum of 50 servers. </p><br><p>  Next, the user is asked if he wants to continue on the next DC, and so on until all servers are covered.  At the end, you can see the execution log, standard output, standard error, exit status, and so on. </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> you want <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> the command <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> servers <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DL? [Yes/<span class="hljs-keyword"><span class="hljs-keyword">No</span></span>]: Yes srvd1353:O:<span class="hljs-number"><span class="hljs-number">0</span></span>:Fri <span class="hljs-keyword"><span class="hljs-keyword">Oct</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> MSK <span class="hljs-number"><span class="hljs-number">2016</span></span> Executing: <span class="hljs-string"><span class="hljs-string">"date"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> you want <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> the command <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> servers <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> M100? [Yes/<span class="hljs-keyword"><span class="hljs-keyword">No</span></span>]: Yes srve1993:O:<span class="hljs-number"><span class="hljs-number">0</span></span>:Fri <span class="hljs-keyword"><span class="hljs-keyword">Oct</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span> MSK <span class="hljs-number"><span class="hljs-number">2016</span></span> srve2765:O:<span class="hljs-number"><span class="hljs-number">0</span></span>:Fri <span class="hljs-keyword"><span class="hljs-keyword">Oct</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span> MSK <span class="hljs-number"><span class="hljs-number">2016</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">Full</span></span> <span class="hljs-keyword"><span class="hljs-keyword">output</span></span> saved <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /tmp/dsshFullOutput_29606_2016<span class="hljs-number"><span class="hljs-number">-10</span></span><span class="hljs-number"><span class="hljs-number">-14</span></span>_13<span class="hljs-number"><span class="hljs-number">-17.</span></span><span class="hljs-keyword"><span class="hljs-keyword">log</span></span> file.</code> </pre> <br><p>  However, all this does not give any guarantee that our servers are configured correctly.  The most trivial example: the server is currently turned off, because it just reboots - or administrators change the failed memory, disks.  There are a million reasons why these changes may not reach the server.  And so that this did not happen, configuration management systems were invented. </p><br><h2 id="vybor-sistemy">  System selection </h2><br><p>  In 2012, we decided that it was time to implement some of these systems, and first wrote a list of criteria: </p><br><ul><li>  CMDB integration; </li><li>  package installation; </li><li>  work with files (copy / edit / attributes); </li><li>  file control (content / attributes); </li><li>  management of processes and services; </li><li>  manual launch of policies / recipes / manifestos; </li><li>  version control, change logging, reports; </li><li>  scaling, backup; </li><li>  Linux and Windows support; </li><li>  checking for servers without a working CM. </li></ul><br><p>  But as a result, we chose only three main criteria. </p><br><p>  The first is <strong>performance</strong> .  Here is a graph of the load on the CFEngine-hub, which serves 3000 servers: </p><br><p><img src="https://habrastorage.org/webt/vi/kp/1t/vikp1thef-kpq0eptw4ppum7efo.jpeg"></p><br><p>  There is still a lot of free CPU time, one server can safely serve tens of thousands of clients.  Memory is the same. </p><br><p>  The next criterion is <strong>maturity</strong> .  This is the scale of the emergence of modern configuration management tools. </p><br><p><img src="https://habrastorage.org/webt/ll/q0/tk/llq0tkjycpzrrzqiep2opk46vpo.jpeg"></p><br><p>  As you can see, CFEngine is at least 10 years older than all existing systems today, and this gives some confidence in its capabilities and reliability.  By the way, two other popular products, Puppet and Chef, appeared like this: Puppet developer used CFEngine, but he didn‚Äôt like it, so he did Puppet;  then another developer didn‚Äôt like Puppet, and he did Chef. </p><br><p>  The last criterion is <strong>popularity</strong> .  CFEngine is not at all common in Russia, but outside of its borders it was used by such large companies as NASA, IBM, LinkedIn.  Let's look at the historical data in Google Trends. </p><br><p><img src="https://habrastorage.org/webt/zr/rz/pt/zrrzptknkyjowtq2zub8tzxxd4q.jpeg"></p><br><p>  CFEngine was incredibly popular, remained a market leader for a long time, when other configuration management systems were still not very common.  In 2012, CFEngine best met all our requirements.  Many demonize this tool because of the specificity of its capabilities, logic and organization of the language.  But you can bring it into a state where it will be enough just to use it. </p><br><h2 id="cfengine-v-odnoklassnikah">  CFEngine in Odnoklassniki </h2><br><p>  Here is an example of a typical application configuration policy in production. </p><br><pre> <code class="hljs php"><span class="hljs-string"><span class="hljs-string">"app_ok_feed"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> =&gt; {<span class="hljs-string"><span class="hljs-string">"cmdb_group_feeds_proxy"</span></span>, ‚Äúcmdb_group_feeds_cache}; ... bundle agent app_ok_feed { vars: <span class="hljs-string"><span class="hljs-string">"application"</span></span> string =&gt; <span class="hljs-string"><span class="hljs-string">"ok-feed"</span></span>; methods: <span class="hljs-string"><span class="hljs-string">"app_ok"</span></span> usebundle =&gt; app_ok(<span class="hljs-string"><span class="hljs-string">"$(application)"</span></span>); }</code> </pre> <br><p>  The name of the policy is <code>app_ok_feed</code> , it is applied to two groups of servers ‚Äî <code>feeds_proxy</code> and <code>feeds_cache</code> , it contains the name of the application and the <code>app_ok</code> method being <code>app_ok</code> .  Even if you do not know the syntax of CFEngine, difficulties with understanding will not arise. </p><br><p>  Let's move on to the next level of abstraction - directly the <code>app_ok</code> method <code>app_ok</code> . </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">bundle agent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app_ok</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">application</span></span></span><span class="hljs-function">)</span></span> { vars: <span class="hljs-string"><span class="hljs-string">"file[/ok/bin/$(application)][policy]"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"copy"</span></span>; <span class="hljs-string"><span class="hljs-string">"file[/ok/bin/$(application)][mode]"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"0755"</span></span>; <span class="hljs-string"><span class="hljs-string">"file[/ok/conf/$(application).conf][policy]"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"copy"</span></span>; <span class="hljs-string"><span class="hljs-string">"file[/root/ok/ok.properties][policy]"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"edit"</span></span>; <span class="hljs-string"><span class="hljs-string">"file[/root/ok/ok.properties][suffix]"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"$(application)"</span></span>; <span class="hljs-string"><span class="hljs-string">"file[/root/ok/ok.properties][type]"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"file"</span></span>; methods: <span class="hljs-string"><span class="hljs-string">"files"</span></span> usebundle =&gt; files_manage(<span class="hljs-string"><span class="hljs-string">"$(this.bundle).file"</span></span>); }</code> </pre> <br><p>  Here we take the name of the application, copy some configs, expose them the necessary permissions and proceed to the next level of abstraction: call the <code>files_manage</code> method.  That is, CFEngine makes it easy to create levels of abstraction. </p><br><p>  A few more very short examples: </p><br><ul><li>  Add user: <code>"user[git][policy]" string =&gt; "add";</code> </li><li>  Start the service: <code>"service[mysql][policy]" string =&gt; "start";</code> </li><li>  Add cron: <code>"cron[do_well][cron]" string =&gt; "* * * * * do_well";</code> </li><li>  Install package: <code>"package[rsyslog][policy]" string =&gt; "add";</code> </li></ul><br><p>  Distribution by type of our policies: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/91/q8/uo/91q8uof_ebf_clbkfw3plodohmc.png"></div><br><p>  There are about 1500 of them in total, the largest policy is 27 Kb - oddly enough, this is the Zabbix server configuration policy.  It describes absolutely all aspects, you can take a bare server and run the policy, as a result, the database and the front-end with all the necessary patches will be configured. </p><br><p>  A few more examples of specific things that configuration systems often do not configure: </p><br><ul><li>  IP routes; </li><li>  cache records HW RAID; </li><li>  SELinux; </li><li>  IPMI SOL; </li><li>  kernel modules; </li><li>  RSS / RPS / RFS. </li></ul><br><p>  We have it all automated with CFEngine.  Suffice to say which mode you want and on which server, and the system will do the rest. </p><br><h2 id="nedostatki">  disadvantages </h2><br><p>  However, CFEngine has drawbacks.  First of all, it is a <strong>high threshold of entry</strong> .  The biggest pain for new employees and those who train them is the explanation of all internal logic.  Of course, there are high levels of abstraction.  Nevertheless, the system administrator who wants to work with it is important to understand how the tool works under the hood. </p><br><p>  The next problem - CFEngine <strong>lags far behind competitors</strong> .  I have no illusions, I know the capabilities of modern systems, and CFEngine is far from them. </p><br><p>  CFEngine <strong>does not have the ability to extend functionality</strong> .  It is written in C. Other popular systems basically have plugins that are written in simpler languages ‚Äã‚Äãlike Python. </p><br><p>  <strong>Bad templates</strong> .  They are weak in capabilities, specific things cannot be done in them, you have to create several different files. </p><br><h2 id="4-aprelya">  April, 4 </h2><br><p>  What is remarkable April 4?  This is the day of the web developer.  But not only.  In 2013, on April 4, the project Odnoklassniki became unavailable for all users, and we tried to fix it for three days.  The problem was complex, all servers were inaccessible to users and system administrators, and the reboot did not help.  This case entered the world history of downtime.  You can read more in the post ‚Äú <a href="https://habrahabr.ru/company/odnoklassniki/blog/268413/">Three days that shook us in 2013</a> ‚Äù. </p><br><p>  Could this have been avoided?  Naturally, we worked remedies: </p><br><ul><li>  syntax checking; </li><li>  test environments; </li><li>  review; </li><li>  monitoring. </li></ul><br><p>  Nevertheless, the devil is in the details.  The same review though existed, but was optional.  As for the commit that broke everything, he went through the review, at least two administrators watched it - and that did not save.  In the commit, several symbols were added to the config, and a tragic coincidence happened: the bug of one system superimposed on the bug of another, and everything collapsed. </p><br><p>  When several thousand servers stopped working due to CFEngine, we stopped it first.  We had to sit down and very seriously think about how to continue to exist, whether system administrators will use some kind of configuration system, and if so, how.  In addition, it was necessary to eliminate the human factor as much as possible, physically limiting the possibility of a repetition of the disaster. </p><br><p>  First of all, I would like to note that in the end we left CFEngine.  Moreover, it still <strong>runs once every five minutes on each server</strong> .  This is important because configuration management systems primarily ensure that the server is configured exactly the way you want it.  And this is true for all of our servers.  They have the configs that we want, everything is done absolutely exactly, I don‚Äôt need to check it - CFEngine or any other configuration management system does it for me. </p><br><p>  I want to note that CFEngine does not participate in the deployment of Java applications at all.  We use it more likely to prepare for deployment, which our separate self-written system makes.  We roll out the server, CFEngine brings it to the ready state, and another system can easily install the main Java application. </p><br><h2 id="kakie-my-predprinyali-mery-chtoby-podobnaya-situaciya-ne-povtorilas">  What measures have we taken to prevent this situation from happening again? </h2><br><p>  The first level of protection is <strong>git</strong> .  There are hooks, and all CFEngine-politician source codes are in git.  In git-hooks, the syntax is checked and the style is corrected automatically, the autocomplete and the commit message is checked.  The latter is not entirely related to security, but in case of any problems, you can quickly find all the commits that belong to them by the task number or the name of the data center.  When creating a commit, the admin writes the ticket number and the comment itself at the beginning, and the hook analyzes which files have changed and adds the affected environments to the message.  As a result, a typical commit message looks like a ‚ÄúTask number: [list of environments] comment‚Äù.  For example: </p><br><pre> <code class="hljs pgsql">ADMODKL<span class="hljs-number"><span class="hljs-number">-54581</span></span>: [D,E,G,K,P] <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> cloud-minion-ec <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stable</span></span></code> </pre> <br><p>  The next defense step is to <strong>check in the test environment</strong> .  The test environment consists of several parts.  The first part is unstable, these are virtual machines that anyone can use, can break them in any way he can, we absolutely do not feel sorry for them.  They are updated every five minutes.  Next comes the testing environment - testing on physical servers (some policies on physical servers run differently).  And unlike virtuallok, we have physical servers in CMDB, there, too, policies can be applied differently.  Nevertheless, this layer can also be completely lost, it is updated every five minutes. </p><br><p>  The next protection is <strong>checking for parts of production servers with automated load control</strong> .  These are real working servers, databases, frontends, etc., where real users sit.  We take one server from each new cluster that we install in production if it is fault tolerant and add it to the stable environment.  Thus, there are absolutely all types of hardware (RAID controllers, motherboards, network cards, etc.), all types of applications, their various configurations.  Everything that is possible in our production. </p><br><p>  Since  only one server from the cluster gets into stable and only if this server can be lost without an effect for the user, even a fatal error in the stable environment policies does not lead to an effect for users, they will continue to use the portal without any interruptions. </p><br><p>  In stable, all system administrators can commit and they can break it, but here the policies are updated not in five minutes, but in an hour.  Still, no one wants to once again repair hundreds of servers, so we smoothly update them within an hour. </p><br><p>  Also for production-servers the load is automatically controlled.  Naturally, we have monitoring of everything, but specifically for these servers, we additionally monitor for at least two hours that they do not appear anomalies.  There may be a banal memory leak.  If this is immediately given to production, then the consequences could be the worst.  With major changes, policies are kept in a stable day. </p><br><p>  The next defense mechanism is a <strong>review</strong> .  We check the style (something that was not automatically corrected by the git-hook), the use of the latest versions of the methods, the ‚Äúadequacy‚Äù of the code. </p><br><p><img src="https://habrastorage.org/webt/bc/4w/_y/bc4w_yn3j2ateyf0zfcnomeancs.jpeg"></p><br><p>  But before the politicians go to production, the reviewer must make sure that they do not cause any errors on all previous environments, that there are no load anomalies and that at least two hours have passed.  Only after this the reviewer sends a commit to production. </p><br><p>  Naturally, there are problems that need to be quickly resolved, and for this you can bypass the protection mechanisms.  This we also provided.  If, say, on five servers you need to quickly commit, then you can go to five servers and update by hand.  But on all servers you will not do that.  To work with a large number of servers, there are special tools with their own protection mechanisms. </p><br><p>  At first, only 3 administrators were involved in the review, who implemented CFEngine, understood it best and had the most experience. </p><br><p>  Then we introduced a two-level review.  Zarejuvit could any admin.  This greatly accelerated the work, it was not necessary to wait for several people.  It was possible to go to his neighbor, he was revising, but the post-inspection was already carried out by the senior system administrator. </p><br><p>  Now all admins have gained a sufficient level of competence, and we have canceled a re-review for everyone who has worked in the company for a long time. </p><br><p>  And the last level of protection is <strong>protection against distribution of production policies</strong> .  This is the so-called "darts". </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wo/ch/xl/wochxljly_uhzfkk0pvcp94hfe4.jpeg"></div><br><p>  Letters - abbreviations of our DC.  Datacenter Data Line with the letter D, it is updated three times a day: from 9 to 10, from 13 to 14 and from 17 to 18. Data centers are independent, thanks to this scheme we have time to notice problems.  If the policies are updated on DC and DC begins to fall, then we will see it in time, and the rest DC will remain unaffected.  And even if we did not have time to notice for a whole hour, that is, at least another three hours before the fall of the entire production. </p><br><p>  If we say that the ‚Äúgreen‚Äù Data Line starts updating at 9 am, this does not mean that 100% of its servers have immediately been pumped out by new policies.  This is done gradually.  We don‚Äôt want to lose the whole DC at one time, so the policies will be updated at once on a limited number of servers, this is the standard CFEngine functionality - the splay class.  Do not need to do anything with your hands, everything is automated. </p><br><p>  Additional protection is that the policies are updated only from 8 to 20. No one wants surprises at night, and working time is enough for all things. </p><br><p>  If the error rolls over the entire Data Line, then the procedure depends on how serious the problem is.  If you need to fix it here and now, then we can still interfere with our hands through the already familiar dssh or the usual ssh.  Whatever happens if there is a conflict with CFEngine, we have mechanisms to temporarily disable CFEngine for individual policies or even for individual files.  Forget about these temporary changes also fail, because  after the timeout expires (3 days), all changes that are not in CFEngine will be rolled back. </p><br><p>  If the problem occurs on a large number of servers, then here you can act differently, depending on the severity of the situation.  In general, we try to do nothing in manual mode.  If the problem can wait, then we will act according to the standard procedure: commit, then stable, review - and within four hours the fix will crawl to these servers.  If everything is bad and there are noticeable problems in the service, then we quickly roll back the commit. </p><br><p>  So, we have five levels of protection when politicians prepare and go to production.  But we decided that this is not enough.  What to do if bad politics still broke into production? </p><br><p><img src="https://habrastorage.org/webt/1s/0w/3j/1s0w3jdl4yqhilnknngcfqqf5hw.jpeg"></p><br><p>  We have a plan B. This is another git-repository, which also has policies, but they are very simple, there are very few of them, and we rarely make changes there.  If everything is broken, CFEngine switches to an alternative set of policies, and this allows you to first of all keep the CFEngine itself as our main tool.  And after switching, we can use it to repair something more serious. </p><br><p><img src="https://habrastorage.org/webt/xd/51/ld/xd51ldikr9cbicx1gq69vqmif9k.jpeg" align="left">  But even that seemed to us a little, so we wrote a small script that allows, very quickly, to stop CFEngine in all production in tens of seconds.  Since 2013, we have never used this tool!  But periodically check its performance </p><br><p>  Why there is no automatic rollback of changes?  Because in CFEngine there are no transactions and logs.  Naturally, configs can be backed up, and we do it.  But we cannot know the entire scope of work that led to this problem.  Maybe it was a config.  Maybe a package upgrade.  Maybe a restart of the service.  Maybe a combination of actions or their sequence.  And to roll them back, you need to know what exactly was done.  This can be viewed on the log, but it is not an automatic operation. </p><br><p> ,         ,    ,      .     ,  ,     ,       :  ,  , ,    ,         . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dt/gn/4i/dtgn4i7xepeomreqe3n-2-fzxqg.jpeg"></div><br><p>          ,    .        ,       ,      : 50, 100, 200, 400  . . </p><br><h2 id="kratkie-itogi">  Brief summary </h2><br><p>  ‚Äî   ,     .        : </p><br><ul><li>       , </li><li>    - ,      </li></ul><br><p>    .     production,        ,       production       .        ‚Äî         ,   ,     . </p><br><p> <em>    <a href="http://www.highload.ru/2016/abstracts/2329.html">   Highload++ 2016</a> .</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/342300/">https://habr.com/ru/post/342300/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342286/index.html">Bible movements doom. Part 2</a></li>
<li><a href="../342288/index.html">SparrowHub Plugin Overview</a></li>
<li><a href="../342290/index.html">November 29, Kharkiv: Report "Analytics in a Gaming Company: Big Data Architecture and Tools"</a></li>
<li><a href="../342292/index.html">Introduction to Seneca.JS</a></li>
<li><a href="../342298/index.html">Andrei Karpov believes that the code for the Manticore project is better than the code for the Sphinx project</a></li>
<li><a href="../342302/index.html">Design Template ‚ÄúMini Scenario with Contradiction Check‚Äù</a></li>
<li><a href="../342304/index.html">Interesting logical puzzles for interviews</a></li>
<li><a href="../342306/index.html">How we played with neural networks</a></li>
<li><a href="../342308/index.html">Future of wikipedia</a></li>
<li><a href="../342310/index.html">Installing Proxmox VE on Debian Stretch using Ansible</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>