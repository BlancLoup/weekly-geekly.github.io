<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart cards for the smallest</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since the article is introductory and overview, the simplest variety of smart cards - SIM cards will be considered, I suppose that such cards are the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart cards for the smallest</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/fc3/d13/176/fc3d13176ac41844094c50b4b418b801.jpg" height="313" width="300" align="right">  Since the article is introductory and overview, the simplest variety of smart cards - SIM cards will be considered, I suppose that such cards are the most on the planet right now. <br>  By today's standards, the SIM standard looks archaic, but it is ideal for a first acquaintance with the world of smart cards, mastering the principles that are the basis of this standard, will facilitate further immersion in the subject. <br>  If you are a ‚Äúcard‚Äù, you are unlikely to learn something new for yourself, unless some not very clear moments will decompose on the shelves, or maybe you will decompose what the author misunderstood (but, I remind, we keep within SIM!). <br><br><a name="habracut"></a><br><br>  A smart card is a software and hardware complex, in fact - a miniature computer, which includes at least: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  CPU; </li><li>  RAM; </li><li>  data storage subsystem; </li><li>  operating system. </li></ul><br><br>  Often, but not always, a Java VM is included in the map.  The OS, as such, is not visible to the end user. <br><br><h1>  APDU </h1><br>  The role of the API performs data exchange with the card through so-called.  <abbr title="Application Protocol Data Unit">APDU</abbr> . <br>  Many different <abbr title="Application Protocol Data Unit">APDUs</abbr> are a set of commands, each of which has the following structure (according to <a href="http://ru.wikipedia.org/wiki/ISO/IEC_7816">ISO7816-4</a> ): <br><table><tbody><tr><th>  Element </th><th>  Size (bytes) </th><th>  Description </th></tr><tr><td>  CLA </td><td>  one </td><td>  team class </td></tr><tr><td>  INS </td><td>  one </td><td>  instruction code </td></tr><tr><td>  P1 </td><td>  one </td><td>  parameter number 1 </td></tr><tr><td>  P2 </td><td>  one </td><td>  parameter number 2 </td></tr><tr><td>  L </td><td>  one </td><td>  the length of the data transmitted to the card. </td></tr><tr><td>  Data </td><td>  L </td><td>  data </td></tr></tbody></table><br>  <abbr title="Application Protocol Data Unit">APDUs are</abbr> usually written as a set of hexadecimal digits, like this: <br><br> <code>A0 A4 00 00 02 3F00</code> <br> <br>  For GSM SIM cards, CLA = <code>A0</code> . <br>  I will give several instruction codes: <br><table><tbody><tr><th>  Instruction </th><th>  Description </th></tr><tr><td>  A4 </td><td>  SELECT FILE </td></tr><tr><td> <code>B0</code> </td> <td>  READ BINARY </td></tr><tr><td> <code>B2</code> </td> <td>  READ RECORD </td></tr><tr><td> <code>C0</code> </td> <td>  GET RESPONSE </td></tr><tr><td> <code>20</code> </td> <td>  VERIFY CODE </td></tr><tr><td> <code>D6</code> </td> <td>  UPDATE BINARY </td></tr><tr><td> <code>DC</code> </td> <td>  UPDATE RECORD </td></tr></tbody></table><br>  In response to an <abbr title="Application Protocol Data Unit">APDU, the</abbr> card always returns at least 2 bytes, i.e.  Status Word (SW), <br>  with the first and second bytes, respectively, called SW1 and SW2.  SW can determine the execution status of a command, with SW1 usually providing basic information, and SW2 providing additional information.  In the case of SIM cards, the status of execution will be 90 00 and 9F xx (here xx is a hexadecimal digit, the length of the additional information, which is described below). <br>  In addition to the SW card can return data.  There are also commands, after which it is possible to obtain additional information. <br>  To do this, use the command: <br><br> <code>GET RESPONSE</code> <br> <br>  In order to use the ‚Äúservices‚Äù of this instruction, you need to keep in mind that it must be called <u>immediately</u> after the command whose result you want to request.  If you call any instruction other than GET RESPONSE, the context of the previous command will be lost. <br>  If any instruction allows you to use GET RESPONSE after its call, then in SW2 it returns the amount of data in bytes that the GET RESPONSE command will return. <br>  One of the bright applications of GET RESPONSE is its use after the SELECT command - it gives you the opportunity to get useful information about the selected file system object. <br><br><h1>  Storage subsystem </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/bad/ec7/4f4/badec74f4f5afef1bbe8b9e1f14d6603.jpg" align="right"><br>  By the way, it's time to recall the file system of the card.  This system is hierarchical, there is a root folder (Master File, MF), regular folders (Dedicated File, DF) and, in fact, files (Elementary File, EF).  Each file system object has an identifier (File ID, FID), which, in the simplest case, consists of four hexadecimal digits and which replaces it with a name.  For example, the <abbr title="Master File (root folder)">MF is</abbr> always identifier <code>3F00</code> .  Within each card standard, there is a list of reserved file identifiers, for example, the address book file on the SIM has the identifier 6F3A, and the file for storing the SMS is 6F3C.  Standard files also have pronounced names (solely for the convenience of the person, the API does not use them), for the above files they are: <br>  <abbr title="Abbreveated Dialling Numbers">EF ADN</abbr> for <code>6F3A</code> ; <br>  EF SMS for <code>6F3</code> . <br><br>  In the case of SIM cards, standard usage scenarios do not provide for modification of the file structure, i.e.  Unable to create <abbr title="Elementary File (regular file)">EF</abbr> or <abbr title="Dedicated File (regular folder)">DF</abbr> . <br>  It is only possible to modify the contents of the files.  Of course, life dictates non-standard scenarios, but now we will not consider them. <br><br><h3>  File types </h3><br>  The smart card API provides manipulations with three types of files: <br><br><ol><li>  <b>Transparent</b> <br><br>  analogue of the usual binary file of any file system. <br>  Tools for working with such files are a pair of <code>READ BINARY/UPDATE BINARY</code> . <br><br></li><li>  <b>Linear fixed</b> <br><br>  A file consisting of a fixed number of records, with all the records of the same length, the length of the record is set when the file is created. <br>  There can be no more than 255 records, each record cannot be longer than 255 bytes. <br>  The work tool is the READ RECORD / UPDATE RECORD pair. <br>  You can use both absolute (by record number) and relative addressing (next / previous, but without cyclicity). <br>  Example of use - a notebook on the SIM-card. <br><br></li><li>  <b>Cyclic</b> <br><br>  In general - the same as Linear Fixed, but with the following additional functionality: <br>  When reading: closure - when using relative addressing, moving from the last to the next record we get to the first, moving from the first to the previous record, we get to the last. <br>  When writing: only relative addressing is allowed with reference only to the previous record.  There is even a special command, only for cyclic files, which updates the oldest record of the file (after that it becomes the newest) - INCREASE. <br>  The first entry always stores the most recent data, and the last one keeps the oldest. <br>  Example of use - a list of previously dialed numbers.  In general, files of this type are used much less frequently than files of other types. <br><br></li></ol><br>  In the API, it is not possible to request a list of all files / folders for <abbr title="Master File (root folder)">MF</abbr> or <abbr title="Dedicated File (regular folder)">DF</abbr> , respectively, in order to check the presence of a file in a given path, you must try to select this file with the SELECT command and analyze the SW. <br>  The types of generalized file operations are presented in this table: <br><table><tbody><tr><th>  Generalized type of operation </th><th>  Command Examples </th></tr><tr><td>  Read </td><td> <code>READ BINARY, READ RECORD</code> </td> </tr><tr><td>  Update </td><td> <code>UPDATE RECORD, UPDATE RECORD, INCREASE</code> </td> </tr><tr><td>  Invalidate </td><td> <code>INVALIDATE</code> </td> </tr><tr><td>  Rehabilitate </td><td> <code>REHABILITATE</code> </td> </tr></tbody></table><br><br>  Briefly explain the last two teams: <br><ol><li>  <b><code>INVALIDATE</code></b> - reversibly changes the state of the file so that: <br><ul><li>  a special flag is set for it, i.e.  we can learn that the file is invalid. </li><li>  depending on the settings of the invalid file, read and write operations may become impossible. </li></ul><br></li><li>  <b><code>REHABILITATE</code></b> ‚Äî Returns a previously <b><code>REHABILITATE</code></b> file to its normal state, with possible restrictions imposed by invalidation being removed. </li></ol><br>  An example of use is the mechanism for activating the fixed dialing mode (when only subscribers from a special phone book can call) is built on the invalidation of the file of the main phone book of the SIM card.  About other applications of this mechanism is unknown to me. <br>  Having defined the generalized types of file operations, we can proceed to become familiar with the principles of access control. <br><br><h1>  Access Control </h1><br>  These principles are based on the following concepts: <br><ol><li>  Access Condition (AC) - the state of the card, within the current session, in which a certain type of operation is possible for a specific file. </li><li>  Access conditions, the most famous of which is the presentation of a PIN code. </li></ol><br>  Possible access conditions: <br><table><tbody><tr><th>  Access condition </th><th>  Explanation </th></tr><tr><td>  Never </td><td>  Operation is prohibited </td></tr><tr><td>  Always </td><td>  Operation is always allowed. </td></tr><tr><td>  PIN1 (also known as <abbr title="Card Holder Verification">CHV</abbr> 1) </td><td>  To perform the operation, you must present a PIN1 card </td></tr><tr><td>  PIN2 ( <abbr title="Card Holder Verification">CHV</abbr> 2) </td><td>  To perform the operation, you must present a PIN2 card </td></tr><tr><td>  <abbr title="administrative code">ADM</abbr> </td><td>  To perform the operation, it is required to present the administrative code to the card. </td></tr></tbody></table><br>  Both PIN codes are presented to the card with the VERIFY CODE command.  <abbr title="administrative code">The ADM is</abbr> presented by the proprietary team (which team the manufacturer wants, this is what he uses, since it is not regulated by the standard). <br>  The presentation of the code is a scale operation of the session of working with the card, if you presented the PIN or <abbr title="administrative code">ADM</abbr> once, you can perform operations with all files that require the corresponding code until the session is completed. <br>  For each file and each operation, the map stores a mapping: a generalized operation is an access condition. <br>  For example, for an <abbr title="FID: 2FE2">EF ICCID</abbr> file that stores a <a href="http://ru.wikipedia.org/wiki/SIM-%25D0%25BA%25D0%25B0%25D1%2580%25D1%2582%25D0%25B0">unique serial number of the card</a> (not to be confused with the mobile subscriber number), the <abbr title="Access Conditions">AC</abbr> will look like this: <br><table><tbody><tr><th>  Read </th><th>  Update </th><th>  Invalidate / Rehabilitate </th></tr><tr><td>  Always </td><td>  Never </td><td>  Never </td></tr></tbody></table><br>  For the main phone book: <br><table><tbody><tr><th>  Read </th><th>  Update </th><th>  Invalidate / Rehabilitate </th></tr><tr><td>  PIN1 </td><td>  PIN1 </td><td>  PIN2 </td></tr></tbody></table><br>  If the presentation of a specific code is disabled, as operators often do with PIN1 now, this code is considered to be presented from the beginning of the card session. <br><br>  For the SELECT operation, all <abbr title="Access Conditions">ACs</abbr> are Always.  To find out the <abbr title="Access Conditions">AC</abbr> for a specific file, you must select it (SELECT), and then execute the GET RESPONSE command. <br><br>  To folders on SIM-cards ( <abbr title="Master File (root folder)">MF</abbr> and <abbr title="Dedicated File (regular folder)">DF</abbr> ) <abbr title="Access Conditions">AC</abbr> generally not applicable.  When an unacceptable operation is performed on a file from an <abbr title="Access Conditions">AC</abbr> point of view (such as an attempt to perform an <abbr title="FID: 2FE2">EF ICCID</abbr> update), the operation will be refused and an error code will be provided in SW. <br><br>  Of course, what I described here is not a real file system - as a rule, behind this abstraction, at the OS level, the familiar FAT is hidden. <br><br>  In conclusion, I just have to give an example of using this API in real life. <br>  I think many have already guessed (or knew?) That the most famous and popular device using this API constantly and intensively is an ordinary mobile terminal. <br><br>  <i>PS:</i> <i><br></i>  <i>In the next article I plan to talk about how you can apply the knowledge gained now, working with the map programmatically.</i> <i><br><br></i>  <i>PPS: Thanks to the kind people for inviting!</i> </div><p>Source: <a href="https://habr.com/ru/post/210062/">https://habr.com/ru/post/210062/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210048/index.html">Protection system for remote banking services and electronic payments</a></li>
<li><a href="../210050/index.html">Access iFrame content from another domain</a></li>
<li><a href="../210056/index.html">Once again about Intel contests. Memo to future participants</a></li>
<li><a href="../210058/index.html">Web Components - the future of the Web</a></li>
<li><a href="../210060/index.html">Treating tree structures and unified AST</a></li>
<li><a href="../210068/index.html">MySQL engine in 5 minutes</a></li>
<li><a href="../210074/index.html">Three personalization strategies for an online store</a></li>
<li><a href="../210076/index.html">Sony creates a human genome research company</a></li>
<li><a href="../210078/index.html">Recognize it! Native Speech Competition 2014</a></li>
<li><a href="../210080/index.html">Table of Contents for Google Docs and Khabrhabra</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>