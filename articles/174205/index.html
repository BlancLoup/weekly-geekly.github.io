<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Easy setup of replication in PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There was a need to quickly and as easily as possible organize the replication of data from the database server to the backup server. There was no sim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Easy setup of replication in PostgreSQL</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/175/f04/b8a/175f04b8a4c7e4d5f9b5a986ceea44c6.jpg" alt="image"><br>  There was a need to quickly and as easily as possible organize the replication of data from the database server to the backup server.  There was no simple and understandable way in the open spaces of the Web, so I had to collect information in parts, which became this article. <br><br><h4>  Solved problem.  Initial data </h4><br>  So, we have a database server, which clients work with, and a backup server, to which it is necessary to configure replication from the main database. <br>  In my case, PostgreSQL 9.2.1 is used, which is installed on both servers and supports streaming replication.  Suppose that the database on the main server is deployed and is working, the backup server is only installed, but PostgreSQL is not configured.  For example, take the IP address 192.168.1.1 for the address of the main server, the IP address 192.168.1.2 - for the backup address. <br><a name="habracut"></a><br><h4>  We configure the main database server </h4><br>  In the ‚ÄúLogin Roles‚Äù section, through PgAdmin we create a user (role) repl with the rights ‚ÄúCan create streaming replication and backup copies‚Äù.  We add in pg_hba or through ‚ÄúServer Configuration‚Äù in PgAdmin we create a string allowing the repl user to connect to the database. <br><br> <code>host replication repl 192.168.1.2/32 trust</code> <br> <br>  The following changes were made to the postgresql.conf file: <br><table><tbody><tr><th>  Initial value </th><th>  Change the value </th><th>  Description </th></tr><tr><td>  #max_wal_senders = 1 </td><td>  max_wal_senders = 2 </td><td>  Number of backup servers that can connect to the primary server </td></tr><tr><td>  #wal_keep_segments = 32 </td><td>  wal_keep_segments = 32 (you can put 256) </td><td>  How many segments to store.  It is necessary to choose the number of such that the backup server has time to take everything and handle.  I set 256 so that the wal-files will not be erased in 24 hours. </td></tr><tr><td>  #wal_level = hot_standby </td><td>  wal_level = hot_standby </td><td>  hot_standby adds the information needed to run only read requests to the backup server </td></tr><tr><td>  #checkpoint_segments = 3 </td><td>  checkpoint_segments = 16 </td><td>  You can increase the number of segments in the WAL log </td></tr></tbody></table><br><h4>  Configuring a backup server </h4><br>  We stop the Postgresql 9.2 service on the backup server and clear the folder with the data created during the installation of PostgreSQL, for example, D: \ database.  After that, run backup from the command line: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>"C:\PostgreSQL\bin\pg_basebackup.exe" --host=192.168.1.1 --port=5432 --username=repl -D "D:\database"</code> <br> <br>  We configure postgresql.conf in D: \ database <br><table><tbody><tr><th>  Initial value </th><th>  Change the value </th><th>  Description </th></tr><tr><td>  #hot_standby = off </td><td>  hot_standby = on </td><td>  Allow read-only requests to the DBMS during the recovery process </td></tr></tbody></table><br>  Configure recovery.conf in D: \ database <br><table><tbody><tr><th>  Value </th><th>  Description </th></tr><tr><td>  standby_mode = 'on' </td><td>  Enable recovery mode and work as a backup server (slave) </td></tr><tr><td>  primary_conninfo = 'host = 192.168.1.1 port = 5432 user = repl' </td><td>  Parameters for connecting to the main server </td></tr><tr><td>  trigger_file = 'D: \\ database \\ end_trig' </td><td>  If we create a file named end_trig in the specified folder, the server will exit replication mode and become a normal server. </td></tr></tbody></table><br>  We start the Postgresql service on a reserve server.  Should start without errors.  We check replication work: we make changes in the table on the main server, and we check if they are reflected in the backup. <br><br><h4>  Setting up logging logs (if needed) </h4><br>  In the postgresql.conf file on the main server we include the following: <br><table><tbody><tr><td>  archive_mode = on </td><td>  archive_command = 'copy "% p" "e: \\ Backup \\% f"' </td></tr></tbody></table><br>  In the folder e: \ Backup archives will fall logs.  (Attention, they can clog up all the disk space, you need to configure the cleanup when overflowed) <br><br>  To use the log archives, you need to copy the logs to the folder from which we will recover and add a line to recovery.conf <br><br> <code>restore_command = 'copy "e:\\Backup\\%f" "%p"'</code> <br> <br><h4>  Failure actions </h4><br>  If the backup server is out of order, then we stop the Postgres service on it and perform all actions as in the section ‚ÄúConfiguring the backup server‚Äù. <br>  If the primary server is out of order, you need to put the backup server into normal operation: to do this, you need to create the end_trig file in the folder as indicated in recovery.conf trigger_file = 'D: \\ database \\ end_trig' b to make the vacuum and reindex databases. <br><br><h4>  Notes </h4><br>  Replications can be configured from Windows XP to Windows 7, and vice versa. <br>  For Windows 7 and Wndows XP, pg_hba has different settings, because  in XP there is no ip6 protocol, the line with it should be commented out. </div><p>Source: <a href="https://habr.com/ru/post/174205/">https://habr.com/ru/post/174205/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../174187/index.html">The digest of interesting news and materials from the world of PHP over the past two weeks, number 13 (03/12/2013 - 03/25/2013)</a></li>
<li><a href="../174189/index.html">GamePlay 3D Framework - easy start to cross-platform development of 3D games</a></li>
<li><a href="../174195/index.html">Programming ARM Controllers in Eclipse on Ubuntu: how to do it</a></li>
<li><a href="../174197/index.html">Create a convenient viewer for vk.com using Fluid.app with notification of new messages in the dock Mac OS X</a></li>
<li><a href="../174201/index.html">Sony SmartWatch, 7 dream apps</a></li>
<li><a href="../174207/index.html">Swig - JavaScript Template Engine with Django Template Syntax</a></li>
<li><a href="../174209/index.html">Report on the eighth Habrebest</a></li>
<li><a href="../174211/index.html">BYOD in a container: we virtualize Android. Part one</a></li>
<li><a href="../174213/index.html">Yandex ranking: how to put machine learning on stream (post # 1)</a></li>
<li><a href="../174221/index.html">A person among 1,500,000 users of mobile communication can be identified only by 4 points in time and space</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>