<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic configuration of Cisco voice gateways and Eltex Asterisk provisioning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the company where I work, it was decided to transport all our stores, and there are almost 500 of them, to IP telephony. The central and regional o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic configuration of Cisco voice gateways and Eltex Asterisk provisioning</h1><div class="post__text post__text-html js-mediator-article">  In the company where I work, it was decided to transport all our stores, and there are almost 500 of them, to IP telephony.  The central and regional offices have long been using Panasonic solutions for this purpose.  At the headquarters, this is the KX-NS1000, in the regional offices, mainly the KX-NS500. <br><br>  But for the transfer of stores to ip-telephony, it was decided to use Asterisk. <br><br>  If you are interested in how to implement ‚ÄúAsterisk provisioning‚Äù using bash scripts that work with mysql, how to configure Asterisk RealTime, dhcp, tftp, as well as the process of generating and signing an ssl certificate signing request for https provisioning from Cysco - welcome to the cat ! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the next article, a little about setting up the KX-NS1000 and KX-NS500 to communicate with Asterisk. <br><a name="habracut"></a><br><h3>  Terms of Reference: </h3><br><ol><li>  Automatic configuration should completely eliminate the participation of a person in the configuration of both the gateways and Asterisk itself.  The configuration process should include only ‚Äúbinding‚Äù the ports of the gateway to a specific phone number. </li><li>  Setup should be done through a single web interface. </li><li>  At any time, any gateway can be removed, the phone number is transferred from one gateway to another, or the port on the gateway is reassigned. </li><li>  Ability to expand the list of supported equipment </li></ol><br><div class="spoiler">  <b class="spoiler_title">Choice of voice gateways:</b> <div class="spoiler_text">  The main criterion when choosing a gateway was the correct operation of the automatic setup.  there will be many gateways, they need to be configured.  At any time, any gateway can fail and a new gateway will come in its place or, even worse, the gateway can move from one store to another, the internal telephone number on the gateway itself or the port number used can change. <br><br>  Naturally, we tested all gateways on test store <s>mice</s> for several months, fought with codecs, providers and qos parameters, set up our own border gateways, etc. <br><br>  We chose several gateways from Eltex, and Cisco. <br>  ** Eltex: ** <br>  Pros - I used to work with him, good gateways, a lot of things they can do, there is a wonderful OpenWRT on board, <div class="spoiler">  <b class="spoiler_title">true sense of this greatness zero</b> <div class="spoiler_text">  The manufacturer does not post the source code for the drivers as required by the OpenWRT license and, accordingly, it will not work to assemble your firmware version, as well as install some third-party package. </div></div><br>  Disadvantages: extremely inconvenient automatic configuration, for example, you cannot make one common file for all gateways and put individual settings into separate files. <br><br>  On different firmware versions, gateways request the configuration file in different ways.  somewhere poppy is written with dots, where together.  Eight port TAU-8.IP pulls the configuration file only from the server tftp root.  For this reason, a full-fledged automatic configuration for these gateways did not work out; you have to go to the gateway's WEB interface and specify the path to the tftp server.  Moreover, TAU-2M.IP perfectly understands the variables in the path to the file: <br>  <code>tftp://10.0.15.9/Eltex/$PN/config/$MA.tar.gz</code> can not be said about TAU-8.IP where you have to write the MAC address of the gateway on the way. <br><br>  In the WEB interface, autotuning added the generation of this path after configuration.  I understand perfectly well that if you specify all the parameters for 43 options in the DHCP server, then everything will work, but this option is busy with us. <br><br>  ** Cisco ** <br>  Pros - I also took off before working, great gateways, with a great automatic configuration system. <br><br>  Cons: no QOS settings. <br><br>  In the end, we decided to use the SPA112, because  we were offered a very tasty price tag plus we use equipment from Cisco almost everywhere. <br></div></div><br><h3>  The mechanism for creating configuration files </h3><br>  Asterisk takes a list of sip users in the mysql database, this mechanism is called <a href="http://asterisk.ru/knowledgebase/Asterisk%2BRealTime">Asterisk RealTime</a> .  This allows you to create / delete / edit accounts for SIP clients on the fly without forcing Asterisk to re-read sip.conf or users.conf. <br><br>  The table from which Asterisk takes sip accounts is called " <a href="https://drive.google.com/file/d/0B6tV5WxOHiNVa3NUdEQxSURDYjA/view%3Fusp%3Dsharing">sip_users</a> " and it is almost standard for Asterisk RealTime. <br><br>  The tables in which the user binds the voice gateway to the sip account are called ‚Äúredaction_gateway_and_phone‚Äù and ‚Äúgateway_and_phone_info‚Äù: <br><br><div class="spoiler">  <b class="spoiler_title">redaction_gateway_and_phone</b> <div class="spoiler_text">  <a href="https://drive.google.com/file/d/0B6tV5WxOHiNVREVVUUotRXkwaVk/view%3Fusp%3Dsharing">download in sql format</a> <br>  - ‚Äúmac‚Äù - poppy gateway address <br>  - ‚Äúname‚Äù - sip username is the same phone number <br>  - ‚Äúport_id‚Äù - physical port number on the VoIp-gateway.  i.e. the port where the analog telephone will be connected <br>  - ‚Äúactual‚Äù - a flag indicating whether it is necessary to create / rewrite the configuration file and an entry in the sip_users table <br>  And the date of adding, editing: <br>  - ‚Äúdata‚Äù - the date of record creation / editing is automatically added <br></div></div><br><div class="spoiler">  <b class="spoiler_title">gateway_and_phone_info</b> <div class="spoiler_text">  <a href="https://drive.google.com/file/d/0B6tV5WxOHiNVb0M5TDBab1ZCU28/view%3Fusp%3Dsharing">download in sql format</a> <br>  gateway_and_phone_info is needed to add information on which gateway is configured, it also indicates the region where the gateway is located, the identification number of the store and the account name from AD of the person who configured / edited. <br>  - ‚Äúregion‚Äù - for the convenience of determining which region the outgoing call is from (see below for details). <br>  - ‚Äúmodel‚Äù is the gateway model, all models are stored in the other table <br>  - ‚Äúcfu‚Äù is the identification number of the store <br>  - ‚Äúregion‚Äù is the region where the gateway is located  city, village, etc. <br>  - ‚Äúlast_modified‚Äù - Before entering the WEB interface, Apache asks for a name / pass, which then checks with the group in AD. <br>  - ‚Äúmac‚Äù - poppy <br></div></div><br>  If desired, you can combine both tables into one.  I divided them so as not to produce a bunch of records with the same fields in the same table. <br><br>  That is, the first table describes the accounts for adding sip_users to the table, and the second describes which gateway model will be configured and where it stands. <br><br>  The whole logic of setting up gateways is that the user enters the mac-address of the voice gateway, the port number used and the desired phone number in both these tables, or rather via the web interface, and the two scripts create the corresponding entry in the ‚Äúsip_users‚Äù table and generate configuration files.  Thus, at the same time, a sip account is created for Asterisk and the corresponding configuration file in the server's tftp directory for the hardware with the given mac-address. <br><br><hr><br>  The database processing logic and the configuration file creation logic are divided into two parts.  They are independent of each other and allow, by creating new scripts, to auto-tune for any other gateways / phones. <br><br>  The script <code>AutoProvision_all.sh</code> is responsible for working with the database.  First of all, the script polls the <code>gateway_and_phone</code> table for records with a unique mac-address and with the <code>No</code> flag in the <code>actual</code> field.  That is, it finds gateways / phones that are not relevant from the point of view of Asterisk, where one account will be configured for one voice gateway (or VoIp-phone).  Next, the script changes the flag from <code>No</code> to <code>Yes</code> in the <code>actual</code> field, and in turn outputs data for each record while simultaneously creating an entry in the <code>sip_users</code> table. <br><br>  Then the script polls the <code>gateway_and_phone_info</code> table for the presence of records with the <code>No</code> flag in the <code>actual</code> field and duplicate mac-addresses.  That is, it finds gateways / phones that are not relevant from the point of view of Asterisk, where several accounts will be configured for one voice gateway (or VoIp-phone).  And it also changes the flag, creates a record and displays the data. <br><br>  At the output, the script produces the lines of the form: duplication flag <b>;</b>  mac-address <b>;</b>  username <b>;</b>  port number <b>;</b>  password <br><br>  eg: <br><br> <code>duble;00da55b729e8;8888;1;2DJKjH3XTx1osjI1 <br> no_duble;00da55b729e8;8888;1;d5xfDwKG3UNdywgY</code> <br> <br>  The password is generated by a separate passGen.sh script. <br><br><div class="spoiler">  <b class="spoiler_title">AutoProvision_all.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #echo START ROOT_PATH=$(cd $(dirname $0) &amp;&amp; pwd) #  ,   . #  "sql"        . sql='mysql -uprovisioning -pxkYyNFuyc3nEKsFj -Dasterisk -e' sql_gateway='redaction_gateway_and_phone' #   ,    - sql_sip_users='sip_users' #    asterisk test="" test=no_test #          .. #    "actual"     Asterisk. #del_old_user="" #del_old_user=delete #         ################################################################################### ################################################################################### ### ### ###          : ### ### ### ################################################################################### ################################################################################### insert_update_sql () { local f_name local d_name for f_name in "$@" do #    : #      , ..    . #        #echo f_name $f_name if [ "$f_name" != "no_duble" ] &amp;&amp; [ "$f_name" != "duble" ] then #           "array_users" array_users=($($sql "SELECT mac,name,port_id FROM $sql_gateway WHERE name like '$f_name'"| awk 'NR&gt;1')) mac=${array_users[0]} name=${array_users[1]} secret=$(${ROOT_PATH}/passGen.sh) port_id=${array_users[2]} region=($($sql "SELECT region FROM gateway_and_phone_info WHERE mac like \ (SELECT mac FROM $sql_gateway WHERE name like '$name')"| awk 'NR&gt;1')) model=($($sql "SELECT model FROM gateway_and_phone_info WHERE mac like '$mac'"| awk 'NR&gt;1')) #    "no"  "yes" if [ -n "$test" ]; then $sql "UPDATE $sql_gateway SET actual = 'yes' WHERE name like '$name'" | awk 'NR&gt;1';fi #         "sip_users". #   "REPLACE INTO"   UNIQUE   "name"      . #   ,         .     . #d_name=($(echo -n $@|sed -r 's/[^0-9 ]//gi')) #echo d_name $d_name #$sql "DELETE FROM sip_users WHERE sip_users.name not in ($d_name) and sip_users.name like '${name%?}%'" | awk 'NR&gt;1' if [ -n "$test" ]; then $sql "REPLACE INTO $sql_sip_users\ (id,name,defaultuser,context,secret,region)\ VALUES\ (NULL, '$name', '$name', 'default', '$secret', '$region')" | awk 'NR&gt;1'; fi #        ,  -    . # if [ "${!#}" == "no_duble" ]; then echo no_duble\;$mac\;$name\;$port_id\;$secret; fi if [ "${!#}" == "no_duble" ]; then echo "no_duble"\;"$mac"\;"$name"\;"$port_id"\;"$secret"\;"$model"; fi # if [ "${!#}" == "duble" ]; then echo duble\;$mac\;$name\;$port_id\;$secret; fi if [ "${!#}" == "duble" ]; then echo "duble"\;"$mac"\;"$name"\;"$port_id"\;"$secret"\;"$model"; fi fi done } #################################################################################### #################################################################################### ### *** *** ### #################################################################################### #################################################################################### #        c  "no" array_no_duble_user=($($sql "SELECT name FROM $sql_gateway WHERE mac IN \ (SELECT mac FROM $sql_gateway GROUP BY mac HAVING count(*)=1) and actual like 'no'" | awk 'NR&gt;1')) #echo       - ${#array_no_duble_mac[@]} #echo       -- ${array_no_duble_mac[@]} #     insert_update_sql "${array_no_duble_user[@]}" "no_duble" #     . #   "array_duble_mac"       "no" array_duble_mac=($($sql "SELECT distinct mac FROM $sql_gateway WHERE mac IN \ (SELECT mac FROM $sql_gateway GROUP BY mac HAVING count(*)&gt;1) and actual like 'no'" | awk 'NR&gt;1')) # echo    - ${#array_duble_mac[@]} # echo    -- ${array_duble_mac[@]} #         : for (( duble_mac_num=0; $duble_mac_num&lt;${#array_duble_mac[@]}; duble_mac_num++ )) do #   "array_duble_user"      . array_duble_user=($($sql "SELECT name FROM $sql_gateway WHERE mac like '${array_duble_mac[$duble_mac_num]}'"| awk 'NR&gt;1')) # echo      - ${#array_duble_mac_user[@]} # echo      -- ${array_duble_mac_user[@]} #         "insert_update_sql". insert_update_sql "${array_duble_user[@]}" "duble" done exit 0</span></span></code> </pre></div></div><br>  The second script is called ‚Äúgen_prov.sh‚Äù.  It launches AutoProvision_all.sh, receives a list of all entries from it, and generates configuration files for SPA112, TAU2-2M.IP and TAU-8.IP.  Unfortunately for Elteks, I did not implement the configuration of individual ports.  all ports are configured on them and in the WEB interface this is checked. <br><br>  Also this script is suitable for generating files for PAP2T-na, SPA8000 and theoretically for any voice gateways from Cisco and Linksys. <br><br><div class="spoiler">  <b class="spoiler_title">gen_prov.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ROOT_PATH=$(cd $(dirname $0) &amp;&amp; pwd) #   .      , #         !!! declare -A array_duble_file_out declare -A array_duble_out_eltex declare -A array_duble_out_eltex_tau8 tmp_dir=`/bin/mktemp -d` #   "array_users"          "flag,mac,name,port,password": array_users=($(${ROOT_PATH}/AutoProvision_all.sh)) #echo array_users--- ${#array_users[@]} #echo   array_users--- ${array_users[@]} #       for (( array_users_num=0; array_users_num&lt;${#array_users[@]}; array_users_num++ )) do #   "array_user_data"    "flag;mac;name;port;password;model": array_user_data=($(echo -n ${array_users[$array_users_num]}|tr -s ';' '\ ' )) # #      : # for (( array_usersc_data_num=0; array_usersc_data_num&lt;${#array_users_data[@]}; array_usersc_data_num++ )) # do flag=${array_user_data[0]} mac=${array_user_data[1]} name=${array_user_data[2]} port=${array_user_data[3]} password=${array_user_data[4]} model=${array_user_data[5]} if [ "$model" == "TAU-2M.IP" ] then #      array_duble_out_eltex[$mac]=$(echo -n "${array_duble_out_eltex[$mac]} $name;$password ") fi ########################################################################### if [ "$model" == "TAU-8.IP" ] then #      array_duble_out_eltex_tau8[$mac]=$(echo -n "${array_duble_out_eltex_tau8[$mac]} $name;$password ") fi ########################################################################### if [ "$model" == "SPA112" ] then mac=$(echo -n ${array_user_data[1]}|sed 's/.*/\L&amp;/') rm -f /srv/tftp/Cisco/config/*$mac\* #         . array_duble_file_out[$mac]=$(echo -en "${array_duble_file_out[$mac]}\n\n&lt;Line_Enable_${port}_ ua=\"na\"&gt;Yes&lt;/Line_Enable_${port}_&gt; &lt;Display_Name_${port}_ ua=\"na\"&gt;$name&lt;/Display_Name_${port}_&gt; &lt;User_ID_${port}_&gt;$name&lt;/User_ID_${port}_&gt; &lt;Password_${port}_&gt;$password&lt;/Password_${port}_&gt;") fi ########################################################################### done #         #    TAU-8.IP for array_duble_out_key_eltex_tau8 in ${!array_duble_out_eltex_tau8[@]}; do cp -R $ROOT_PATH/template/TAU-8.IP/tmp/ $tmp_dir # echo !array_duble_out_eltex_tau8  ..  ${!array_duble_out_eltex_tau8[@]} # echo array_duble_out_eltex_tau8    ${array_duble_out_eltex_tau8[$array_duble_out_key_eltex_tau8]} # echo array_duble_out_key_eltex_tau8    $mac -- $array_duble_out_key_eltex_tau8 mac_tau8=$array_duble_out_key_eltex_tau8 array_users_eltex_tau8=($(echo ${array_duble_out_eltex_tau8[$array_duble_out_key_eltex_tau8]}|tr -s ';' '\ ' )) ######################################################### # FXS1 name_eltex_tau8_1=${array_users_eltex_tau8[0]} password_eltex_tau8_1=${array_users_eltex_tau8[1]} # FXS2 name_eltex_tau8_2=${array_users_eltex_tau8[2]} password_eltex_tau8_2=${array_users_eltex_tau8[3]} # FXS3 name_eltex_tau8_3=${array_users_eltex_tau8[4]} password_eltex_tau8_3=${array_users_eltex_tau8[5]} # FXS4 name_eltex_tau8_4=${array_users_eltex_tau8[6]} password_eltex_tau8_4=${array_users_eltex_tau8[7]} # FXS5 name_eltex_tau8_5=${array_users_eltex_tau8[8]} password_eltex_tau8_5=${array_users_eltex_tau8[9]} # FXS6 name_eltex_tau8_6=${array_users_eltex_tau8[10]} password_eltex_tau8_6=${array_users_eltex_tau8[11]} # FXS7 name_eltex_tau8_7=${array_users_eltex_tau8[12]} password_eltex_tau8_7=${array_users_eltex_tau8[13]} # FXS8 name_eltex_tau8_8=${array_users_eltex_tau8[14]} password_eltex_tau8_8=${array_users_eltex_tau8[15]} ######################################################### /bin/sed "\ # FXS_1 s/%fxs1_phone%/$name_eltex_tau8_1/g;\ s/%fxs1_username%/$name_eltex_tau8_1/g;\ s/%fxs1_auth_name%/$name_eltex_tau8_1/g;\ s/%fxs1_auth_pass%/$password_eltex_tau8_1/g;\ # FXS_2 s/%fxs2_phone%/$name_eltex_tau8_2/g;\ s/%fxs2_username%/$name_eltex_tau8_2/g;\ s/%fxs2_auth_name%/$name_eltex_tau8_2/g;\ s/%fxs2_auth_pass%/$password_eltex_tau8_2/g;\ # FXS_3 s/%fxs3_phone%/$name_eltex_tau8_3/g;\ s/%fxs3_username%/$name_eltex_tau8_3/g;\ s/%fxs3_auth_name%/$name_eltex_tau8_3/g;\ s/%fxs3_auth_pass%/$password_eltex_tau8_3/g;\ # FXS_4 s/%fxs4_phone%/$name_eltex_tau8_4/g;\ s/%fxs4_username%/$name_eltex_tau8_4/g;\ s/%fxs4_auth_name%/$name_eltex_tau8_4/g;\ s/%fxs4_auth_pass%/$password_eltex_tau8_4/g;\ # FXS_5 s/%fxs5_phone%/$name_eltex_tau8_5/g;\ s/%fxs5_username%/$name_eltex_tau8_5/g;\ s/%fxs5_auth_name%/$name_eltex_tau8_5/g;\ s/%fxs5_auth_pass%/$password_eltex_tau8_5/g;\ # FXS_6 s/%fxs6_phone%/$name_eltex_tau8_6/g;\ s/%fxs6_username%/$name_eltex_tau8_6/g;\ s/%fxs6_auth_name%/$name_eltex_tau8_6/g;\ s/%fxs6_auth_pass%/$password_eltex_tau8_6/g;\ # FXS_7 s/%fxs7_phone%/$name_eltex_tau8_7/g;\ s/%fxs7_username%/$name_eltex_tau8_7/g;\ s/%fxs7_auth_name%/$name_eltex_tau8_7/g;\ s/%fxs7_auth_pass%/$password_eltex_tau8_7/g;\ # FXS_8 s/%fxs8_phone%/$name_eltex_tau8_8/g;\ s/%fxs8_username%/$name_eltex_tau8_8/g;\ s/%fxs8_auth_name%/$name_eltex_tau8_8/g;\ s/%fxs8_auth_pass%/$password_eltex_tau8_8/g"\ $ROOT_PATH/template/TAU-8.IP/tmp/etc/config/pbx &gt; $tmp_dir/tmp/etc/config/pbx; sed "s/%mac%/$mac_tau8/g" $ROOT_PATH/template/TAU-8.IP/tmp/etc/config/system &gt; $tmp_dir/tmp/etc/config/system cd $tmp_dir/; tar zcf $mac_tau8.tar.gz tmp; rm -rf /srv/tftp/Eltex/TAU-8.IP/config/$mac_tau8.tar.gz mv $tmp_dir/$mac_tau8.tar.gz /srv/tftp/Eltex/TAU-8.IP/config/ done # end TAU-8.IP #    TAU-2M.IP for array_duble_out_key_eltex in ${!array_duble_out_eltex[@]}; do # echo array_duble_out_eltex  ..  ${!array_duble_out_eltex[@]} # echo array_duble_out_eltex    ${array_duble_out_eltex[$array_duble_out_key_eltex]} mac_tau2=$array_duble_out_key_eltex # 13  mac_tau2_now=$(echo -n $mac | sed -r 's/(..)/\1./gi ; s/.$//gi') #  14  array_users_eltex=($(echo ${array_duble_out_eltex[$array_duble_out_key_eltex]}|tr -s ';' '\ ' )) name_eltex_1=${array_users_eltex[0]} password_eltex_1=${array_users_eltex[1]} name_eltex_2=${array_users_eltex[2]} password_eltex_2=${array_users_eltex[3]} /bin/sed "\ s/%fxs0_Enable%/1/g;\ s/%fxs0_Number%/$name_eltex_1/g;\ s/%fxs0_AuthUsername%/$name_eltex_1/g;\ s/%fxs0_AuthPassword%/$password_eltex_1/g;\ s/%fxs1_Enable%/1/g;\ s/%fxs1_Number%/$name_eltex_2/g;\ s/%fxs1_AuthUsername%/$name_eltex_2/g;\ s/%fxs1_AuthPassword%/$password_eltex_2/g"\ $ROOT_PATH/template/TAU-2M.IP/cfg.yaml &gt; $tmp_dir/cfg.yaml; cd $tmp_dir tar zcf $mac_tau2.tar.gz cfg.yaml; # echo tmp tau2 $mac_tau2 $tmp_dir rm -rf /srv/tftp/Eltex/TAU-2M.IP/config/$mac_tau2.tar.gz cp $tmp_dir/$mac_tau2.tar.gz /srv/tftp/Eltex/TAU-2M.IP/config/ rm -rf /srv/tftp/Eltex/TAU-2M.IP/config/$mac_tau2_now.tar.gz cp $tmp_dir/$mac_tau2.tar.gz /srv/tftp/Eltex/TAU-2M.IP/config/$mac_tau2_now.tar.gz #echo $tmp_dir #echo $mac_tau2 #echo $mac_tau2_now #   TAU-2M.IP" done #    SPA112 for array_duble_file_out_key in ${!array_duble_file_out[@]}; do echo -e "&lt;flat-profile&gt;${array_duble_file_out[$array_duble_file_out_key]}\n\n&lt;/flat-profile&gt;" &gt; /srv/tftp/Cisco/config/spa$array_duble_file_out_key.xml done trap "rm -rf $tmp_dir" EXIT INT QUIT ABRT TERM exit 0</span></span></code> </pre></div></div><br>  It is not an elegant solution with TAU8, it is asking for a looping cycle.  As I wrote above, TAU-8.IP has to be configured with handles, prescribing the path to the configuration file.  Two-port TAU-2M.IP also have to be configured with handles, but this is due to the fact that we have 150 and 66 options configured and 43 options on the DHCP server are not configured. <br><br>  All scripts are in the directory <code>/etc/asterisk/scripts</code> , in the same place you need to create a directory " <a href="https://drive.google.com/file/d/0B6tV5WxOHiNVSjNBcWNZY004VFU/view%3Fusp%3Dsharing">template</a> " in which should be the configuration file templates for gateways, and for TAU-8.IP also the directory tree.  This gateway has several configuration files that are each in its own directory and the whole kitchen is collected into one archive. <br>  gen_prov.sh runs every 1 minute on crown. <br><br>  The SPA112 gateways out of the box try to download the configuration file from the HTTPS server, respectively, the server should have a valid ssl certificate. <br><br>  How to generate a request for an SSL certificate is well described <a href="http://www.tech-notes.net/create-ssl-certificate/">here</a> , if anyone is too lazy to read, I will describe everything here: <br><br>  1. We generate the key 1 time, save it. <br><br><pre> <code class="bash hljs">openssl genrsa -out server.key 2048</code> </pre> <br>  2. Generate the certificate request file. <br><br><pre> <code class="bash hljs">openssl req -new -key srv-shop-aster.key -out srv-shop-aster.csr -subj <span class="hljs-string"><span class="hljs-string">"/C=RU/ST=Novosibirskaya Oblast/L=Kolcovo/O=Roga_and_Kopita_Company Ltd./OU=IT Department/CN=srv-shop-aster/emailAddress=admin_user@RogKop.ru/"</span></span></code> </pre><br>  3. We take the server srv-shop-aster.csr file, you will of course have another name in general the file "server_name.csr" <br><br>  4. Go to the <a href="https://webapps.cisco.com/software/edos/home">certificate signing service.</a> Select the product, the certificate lifetime and sign it by clicking on the ‚ÄúSign Certificate Request‚Äù button, then save the already signed certificate to the disk.  By the way, you need to register on the Cisco site. <br><br>  5. Configure HTTPS in Apache, well written <a href="https">here</a> . <br><br>  I have a certificate and the key is in the <code>/etc/apache2/ssl/</code> directory in the <code>/etc/apache2/sites-enabled/default-ssl.conf</code> file, the path to the certificate and key are specified: <br><br> <code>SSLCertificateFile /etc/apache2/ssl/srv-shop-aster.crt <br> SSLCertificateKeyFile /etc/apache2/ssl/srv-shop-aster.key</code> <br> <br>  And I did not prohibit the use of the obsolete SSLv2 protocol, i.e.  # SSLProtocol all -SSLv2 <br>  Do not forget to put the key with the signed certificate in the appropriate directory and restart Apache. <br><br>       Asterisk  KX-NS1000,  WEB-    DHCP  . </div><p>Source: <a href="https://habr.com/ru/post/331214/">https://habr.com/ru/post/331214/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331204/index.html">Hackers steal money from banks more often than from their clients</a></li>
<li><a href="../331206/index.html">The API from Watson and what these tools can give to your service or application</a></li>
<li><a href="../331208/index.html">A fistful of relays. Part 4. System commands or what can fit in 8 machine instructions?</a></li>
<li><a href="../331210/index.html">Self-registration of the second factor for two-factor authentication based on the RADIUS protocol</a></li>
<li><a href="../331212/index.html">Development kit from analytics to outsourced artists</a></li>
<li><a href="../331216/index.html">HTTP / 2 Server Push is not as simple as I thought.</a></li>
<li><a href="../331220/index.html">The implementation of the algorithm A *</a></li>
<li><a href="../331222/index.html">No place to hide - how aggressive marketing services haunt you</a></li>
<li><a href="../331224/index.html">Translation of the Appium Essentials book. Chapter 1</a></li>
<li><a href="../331226/index.html">On the use of video cameras with character recognition on low-performance computing devices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>