<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Everything you didn't know about the CAP theorem</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="During my first experience with distributed systems, I was constantly confronted with a certain CAP-theorem, I had to dig a little to learn and unders...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Everything you didn't know about the CAP theorem</h1><div class="post__text post__text-html js-mediator-article">  During my first experience with distributed systems, I was constantly confronted with a certain CAP-theorem, I had to dig a little to learn and understand it from all sides.  I am not a database wizard, but I hope that my little exploration of the world of distributed systems will be useful for ordinary developers.  In the article I will talk about what CAP is, its problems and alternatives, and also consider some popular database systems through the CAP prism. <br><a name="habracut"></a><br><h2>  CAP theorem </h2><br>  This theorem was presented at a symposium on the principles of distributed computing in 2000 by Eric Brewer.  In 2002, Seth Gilbert and Nancy Lynch of MIT published a formal proof of the Brewer hypothesis, making it a theorem. <br><br>  According to Brewer, he wanted the community to start a discussion about compromises in distributed systems and after some years began to amend it and make reservations. <br><br><h3>  What is behind CAP </h3><br>  CAP states that in a distributed system it is possible to select only 2 of the 3 properties: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  C (consistency) - consistency.  Each reading will give you the most recent entry. </li><li>  A (availability) - availability.  Each node (not fallen) always successfully executes requests (for reading and writing). </li><li>  P (partition tolerance) - resistance to distribution.  Even if there is no connection between nodes, they continue to work independently of each other. </li></ul><br>  There are already sufficiently visual proofs of this theorem, therefore I will give references to <a href="http://ru.bmstu.wiki/%25D0%25A2%25D0%25B5%25D0%25BE%25D1%2580%25D0%25B5%25D0%25BC%25D0%25B0_CAP_(Consistency,_Availability_%25D0%25B8_Partition_tolerance)">Bauman University</a> and <a href="https://habrahabr.ru/post/130577/">proof in the form of the service ‚ÄúCall me, remind!‚Äù</a> . <br><br><h3>  Basically this is all a triangle. </h3><br>  Many articles boil down to such a simple triangle. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5ea/6e0/5c6/5ea6e05c6e882b2c695570a487f7f1d0.gif" width="50%" alt="image"></div><br><br><h2>  We put into practice </h2><br>  To use CAP theorems in practice, I chose the 3 most, in my opinion, suitable and quite popular database systems: Postgresql, MongoDB, Cassandra. <br><br><h3>  Let's look at Postgresql </h3><br>  The following items refer to the Postgresql abstract distributed database. <br><br><ul><li>  Master-Slave replication is one of the common solutions. </li><li>  Synchronization with Master in asynchronous / synchronous mode </li><li>  The transaction system uses a two-phase commit to ensure consistency. </li><li>  If a partition occurs, you cannot interact with the system (mostly) </li></ul><br>  Thus, the system can not continue to work in the case of a partition, but provides strong consistency and availability.  This is a CA system! <br><br><h3>  Let's look at MongoDB </h3><br>  The following items refer to the MongoDB abstract distributed DB. <br><br><ul><li>  MongoDB provides strong consistency, because it is a system with one Master node, and all entries go to it by default. </li><li>  Automatic master change, in case of separation from other nodes. </li><li>  In the event of a network split, the system will stop taking records until it can be sure that it can safely complete them. </li></ul><br>  Thus, the system can continue to work in case of network separation, but the CAP-availability of all nodes is lost.  This is a CP system! <br><br><h3>  Look at Cassandra </h3><br>  Cassandra uses the master-master replication scheme, which in effect means an AP system in which network separation leads to the self-sufficient operation of all nodes. <br><br>  It would seem that everything is simple ... But this is not so. <br><br><h2>  CAP problems </h2><br>  A lot of detailed and interesting articles are written on the topic of problems in the CAP theorem, here, on Habr√©, so I will leave the link to <a href="https://habrahabr.ru/post/258145/">CAP no longer relevant</a> and the <a href="https://habrahabr.ru/post/322276/">myths about the CAP theorem</a> .  Be sure to read them, but treat each article as a kind of new look and do not take it too close to your heart, because some are scolded, others are praised.  I myself will not go too far, but I will try to give some necessary compilation. <br><br>  So, the problems of the CAP theorem: <br><br><ul><li>  Far from the real world definitions </li><li>  As part of the development, the choice mainly lies between the CP and the AP </li><li>  Many systems - just P </li><li>  Clean AP and CP systems may not be what you expect. </li></ul><br><h3>  What is wrong with the definitions? </h3><br>  Consistency in CAP actually means linearizability (and it is really difficult to achieve).  To explain what linearity is, let's look at the following picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/847/083/7af/8470837af25517f3a26e861d8cc023fe.png" alt="image"><br><br>  In the case described, the referee finished the game, but not every client gets the same result.  To make its system linearized, we need to instantly synchronize data between the referee and other data sources so that when the referee finishes the game, each client will receive the correct information. <br><br>  Availability in CAP, based on the definition, has two serious problems.  The first is that there is no concept of partial availability, or some degree of it (percentages for example), but there is only full accessibility.  The second problem is unlimited response time to requests, i.e.  even if the system responds in an hour, it is still available. <br><br>  Resistance to distribution does not include fallen nodes, and here's why: <br><br><ol><li>  By definition.  In the availability and spelled "... every node (if not failed) always ..." </li><li>  Based on the evidence.  The proofs of the CAP theorem state that some code must be executed on the nodes. </li><li>  Well, some of my (and not only) conjectures.  In case of a node fall, the system can recover, communicate with other nodes and continue working as if nothing had happened.  In case of network separation, you will have to wait for the connection to be restored. </li></ol><br>  Therefore, you need to remember about the ability of the system to recover, but beyond the CAP theorem. <br><br><h3>  AP / CP selection </h3><br>  Communication between nodes usually occurs through an asynchronous network, which can delay or delete messages.  The Internet and all our data centers have this property, and these are not unlikely incidents, so CA systems are rarely considered as part of the development. <br><br><h3>  Many systems are just P </h3><br>  Imagine a system in which two nodes (Master, Slave) and a client.  If suddenly you have lost contact with the Master, the client can read from the Slave, but cannot write - there is no CAP-availability. <br><br>  Ok, like the CP system, but if the Master and Slave are synchronized asynchronously, then the client can request data from the Slave before successful synchronization - we lose CAP-consistency. <br><img src="https://habrastorage.org/getpro/habr/post_images/3bb/85f/2d1/3bb85f2d1241f46689cc87300f4126a0.png" alt="image"><br><br><h3>  Clean AP and CP systems </h3><br>  Pure AP systems may include just 2 number generators.  Pure CP systems may not be available at all.  I will try to come to an agreed state and will not answer us.  Go ahead, CP systems give us not the strong consistency that we expect, but eventual consistency.  We'll talk about it a little later. <br><br><h2>  How to live with it </h2><br>  In the end, it's just an attempt to classify something abstract, so you don't need to reinvent the wheel.  I recommend using the following approach when trying to work with distributed databases: <br><br><ul><li>  Remember the definitions of CAP and their limitations. </li><li>  Use the PACELC theorem instead of CAP, it allows you to look at the system from another perspective. </li><li>  Remember the principles of <a href="https://ru.wikipedia.org/wiki/ACID">ACID</a> / BASE and how they apply to your system. </li><li>  Any gestures should be done, given the project you are working on. </li></ul><br><h3>  PACELC </h3><br>  The <a href="https://en.wikipedia.org/wiki/PACELC_theorem">PACELC</a> theorem was first described and formalized by Daniel J. Abadi from Yale University in 2012.  Since the PACELC theorem is based on CAP, it also uses its definitions. <br><br>  The whole theorem reduces to IF P -&gt; (C or A), ELSE (C or L). <br><br>  Latency is the time for which the client will receive an answer and which is regulated by some level of consistency.  Latency (latency), in a sense, represents the degree of availability. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e2b/168/b6b/e2b168b6bb6ff171bae856dbc9cdccc3.png" alt="image"></div><br><br><h3>  A little bit about BASE </h3><br>  BASE is a peculiar contrast to ACID, which tells us that true coherence cannot be achieved in the real world and cannot be modeled in highly scalable systems. <br><br>  What is behind BASE: <br><br><ul><li>  Basic Availability.  The system responds to any request, but this response may contain error or inconsistent data. </li><li>  Soft-state.  System state may change over time due to changes in final consistency. </li><li>  Eventual consistency.  The system will eventually become consistent.  She will continue to accept data and will not check every transaction for consistency. </li></ul><br>  I was asked several times about what is better than ACID or BASE - it depends on your project.  For example, if your data is not critical, and the user really cares about the speed of interaction, BASE would be the best option.  If it's the other way around - ACID will help you make the system as reliable as possible in terms of data. <br><br><h2>  A fresh look </h2><br>  Now that we know about most of the pitfalls, let's try to look at the same popular database systems from the perspective of knowledge gained. <br><br><h3>  Postgresql </h3><br>  Postgresql does allow for many different system configurations, so it‚Äôs very difficult to describe them.  Let's just take the classic Master-Slave replication with implementation through Slony. <br><br><ul><li>  The system works in accordance with ACID (there are a couple of problems with a two-phase commit, but this is outside the scope of the article). </li><li>  If the connection is broken, Slony will try to switch to the new Master, and we have a new master with its consistency. </li><li>  When the system is operating normally, Slony does everything to achieve strong consistency.  In fact, ACID is the cause of the big delay in this system. </li><li>  The system classification is PC / EC (A). </li></ul><br><h3>  MongoDB </h3><br>  Let's find out something new about MongoDB: <br><br><ul><li>  This is ACID in a limited sense at the document level. </li><li>  In the case of a distributed system, it's all about that BASE. </li><li>  In the absence of network separations, the system ensures that the read and write will be consistent. </li><li>  If the master node drops or loses communication with the rest of the system, some data will not be replicated.  The system will select a new wizard to remain available for reading and writing.  (The new master and the old master are inconsistent). </li><li>  The system is considered PA / EC (A), since most of the nodes remain CAP-available in the event of a break.  Remember that CAP MongoDB is usually referred to as CP.  PACELC creator, Daniel J. Abadi, says that there are far more problems with consistency than accessibility, therefore PA. </li></ul><br><h3>  Cassandra </h3><br><ul><li>  Designed for ‚Äúhigh-speed‚Äù interaction (low-latency interactions). </li><li>  ACID at record level. </li><li>  In the case of a distributed system, it's all about that BASE. </li><li>  If a disconnect occurs, the remaining nodes continue to function. </li><li>  In the case of normal operation, the system uses consistency levels to reduce latency. </li><li>  The system is referred to as PA / EL (A). </li></ul><br><h2>  findings </h2><br><ul><li>  Compromise of distributed systems - this is what should begin the design process. </li><li>  It is rather difficult to classify an abstract system, it is much better to first form requirements based on the technical specifications, and only then correctly configure the required database system. </li><li>  Do not overwork, we are just curious developers, if there is any doubt, consult an expert. </li></ul><br>  Thanks for attention! <br><br><div class="spoiler">  <b class="spoiler_title">Useful sources</b> <div class="spoiler_text">  <a href="https://dzone.com/articles/better-explaining-cap-theorem">dzone.com/articles/better-explaining-cap-theorem</a> <br>  <a href="http://blog.thislongrun.com/2015/03/the-confusing-cap-and-acid-wording.html">blog.thislongrun.com/2015/03/the-confusing-cap-and-acid-wording.html</a> <br>  <a href="https://neo4j.com/blog/acid-vs-base-consistency-models-explained/">neo4j.com/blog/acid-vs-base-consistency-models-explained</a> <br>  <a href="http://databases.about.com/od/databasetraining/a/databasesbegin.htm">databases.about.com/od/databasetraining/a/databasesbegin.htm</a> <br>  <a href="https://brooker.co.za/blog/2014/07/16/pacelc.html">brooker.co.za/blog/2014/07/16/pacelc.html</a> <br>  <a href="https://www.postgresql.org/files/developer/transactions.pdf">www.postgresql.org/files/developer/transactions.pdf</a> <br>  <a href="https://www.airpair.com/postgresql/posts/sql-vs-nosql-ko-postgres-vs-mongo">www.airpair.com/postgresql/posts/sql-vs-nosql-ko-postgres-vs-mongo</a> <br>  <a href="http://jennyxiaozhang.com/nosql-hbase-vs-cassandra-vs-mongodb/">jennyxiaozhang.com/nosql-hbase-vs-cassandra-vs-mongodb</a> <br>  <a href="http://blog.thislongrun.com/2015/04/the-unclear-cp-vs-ca-case-in-cap.html">blog.thislongrun.com/2015/04/the-unclear-cp-vs-ca-case-in-cap.html</a> <br>  <a href="https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed">www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed</a> <br>  <a href="http://cs-www.cs.yale.edu/homes/dna/papers/abadi-pacelc.pdf">cs-www.cs.yale.edu/homes/dna/papers/abadi-pacelc.pdf</a> <br>  <a href="http://blog.thislongrun.com/2015/03/dead-nodes-dont-bite.html">blog.thislongrun.com/2015/03/dead-nodes-dont-bite.html</a> <br>  <a href="http://queue.acm.org/detail.cfm%3Fid%3D2462076">queue.acm.org/detail.cfm?id=2462076</a> </div></div></div><p>Source: <a href="https://habr.com/ru/post/328792/">https://habr.com/ru/post/328792/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328780/index.html">PDUG section on PHDays VII: how to develop applications that hackers do not hack</a></li>
<li><a href="../328782/index.html">[PHDays HackQuest 2017] Anonymizer: SSRF or what can be dangerous curl</a></li>
<li><a href="../328786/index.html">GitLab Values</a></li>
<li><a href="../328788/index.html">The best way to upload files to Ruby is with Shrine. Part 2. Loader</a></li>
<li><a href="../328790/index.html">Staff hunger is also not an aunt, or how to grow an IT specialist from a student</a></li>
<li><a href="../328794/index.html">How to protect a modern data center</a></li>
<li><a href="../328796/index.html">WannaCry 2.0: visual confirmation that you definitely need the right solution for a reliable backup</a></li>
<li><a href="../328798/index.html">CRM and telephony integration, complex product development lessons</a></li>
<li><a href="../328800/index.html">Web crawler using Python and Chrome</a></li>
<li><a href="../328804/index.html">Parse vulnerability CVE-2017-0263 for privilege escalation in Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>