<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bluetooth LE is not so scary, or How to improve user experience effortlessly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We recently invented a team and implemented the function of transferring money over the air using Bluetooth LE technology. I want to tell you how we d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bluetooth LE is not so scary, or How to improve user experience effortlessly</h1><div class="post__text post__text-html js-mediator-article">  We recently invented a team and implemented the function of transferring money over the air using Bluetooth LE technology.  I want to tell you how we did it and what Apple provides to us from the tools.  Many developers think that Bluetooth is difficult, because it is a rather low-level protocol, and there are not so many specialists on it.  But everything is not so scary, and in fact using this function is very simple!  And those features that can be implemented using Bluetooth LE, of course, are interesting and will subsequently allow you to distinguish your application from competitors. <br><br><img src="https://habrastorage.org/webt/97/vu/bb/97vubbbho3z3z4dx_fwnztumh9u.png"><br><a name="habracut"></a><br>  Let's first understand what this technology is all about and how it differs from classic Bluetooth. <br><br><h3>  What is Bluetooth LE? </h3><br>  Why did the Bluetooth developers call this technology Low Energy?  After all, with each new version of Bluetooth power consumption has already declined many times.  The answer lies in this battery. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/webt/ce/qb/65/ceqb65oxhimqzgzovufqysqvsqk.png"></div><br>  Its diameter is only 2 cm, and the capacity is about 220 mAh.  When engineers developed Bluetooth LE, they wanted the device to work with such a battery for several years.  And they did it!  Bluetooth LE devices with such a battery can work for a year.  Who among you in the old-fashioned way turns off Bluetooth on the phone to save energy, as was done in 2000?  In vain you do it - the savings will be less than 10 seconds of the phone a day.  And you disable the functionality is very large, such as Handoff, AirDrop and others. <br><br>  What did the engineers achieve by developing Bluetooth LE?  Did they improve the classic protocol?  Made it more energy efficient?  Just optimized all the processes?  Not.  They completely redesigned the Bluetooth stack architecture and achieved that now, in order to be visible to all other devices, you need less time to be on the air and to occupy the channel.  In turn, this made it possible to save well on energy consumption.  And with the new architecture, it is now possible to standardize any new device, thanks to which developers from all over the world can communicate with the device and, therefore, easily write new applications to manage it.  In addition, the architecture is based on the principle of self-discovery: when connecting to a device, you do not need to enter any PIN codes, and if your application is able to communicate with this device, the connection takes just milliseconds. <br><br><ul><li>  Less air time. </li><li>  Less power consumption. </li><li>  New architecture. </li><li>  Reduced connection time. </li></ul><br>  <b>How did the engineers manage to make such a huge leap in energy efficiency?</b> <br><br>  The frequency remains the same: 2.4 GHz, not certified and free for use in many countries.  But the connection delay was less: 15-30 ms instead of 100 ms for classic Bluetooth.  The working distance remains the same - 100 m. The transmission interval is not much, but it has changed - instead of 0.625 ms it became 3 ms. <br><br>  But because of this, energy consumption could not be reduced tenfold.  Of course, something had to suffer.  And this is the speed: instead of 24 Mbit / s it became 0.27 Mbit / s.  You will probably say that this is a ridiculous speed for 2018. <br><br><h3>  Where is Bluetooth LE used? </h3><br><img src="https://habrastorage.org/webt/bz/0r/ca/bz0rcanj9nvdu_gijz0f6ip3h18.png"><br><br>  This technology is not young, it first appeared in the iPhone 4s.  And already managed to win a lot of areas.  Bluetooth LE is used in all smart home devices and in wearable electronics.  Now there are even chips the size of coffee beans. <br><br><img src="https://habrastorage.org/webt/ex/0c/go/ex0cgowkyn9nhzx_c5vnwvn7v3g.png"><br><br>  <b>And how is this technology used in software?</b> <br><br>  Since Apple was the first to embed Bluetooth in its device and began to use it, by now they have advanced reasonably well and have integrated technology into their ecosystem.  And now you can meet this technology in such services as AirDrop, Devices quick start, Share passwords, Handoff.  And even notifications in hours are made via Bluetooth LE.  In addition, Apple has put open source documentation on how to make notifications from all applications come to your own devices.  What are the roles of devices within Bluetooth LE? <br><br><img src="https://habrastorage.org/webt/vd/gk/85/vdgk85ww_wcqq_jykxexwqidgcw.png"><br><br>  <b>Broadcaster.</b>  Sends messages to anyone nearby, this device can not connect.  This principle works iBeacons and navigation in the premises. <br><br>  <b>Observer.</b>  Listens to what's going on and only receives data from publicly available messages.  Connection does not create. <br><br>  But with <b>Central</b> and <b>Peripheral</b> more interesting.  Why didn't they just be named Server-Client?  It is logical, judging by the name.  And no. <br><br>  Because Peripheral, in fact, acts as a server.  This is a peripheral device that consumes less power and which the more powerful Central connects to.  Peripheral can notify that he is nearby and what services he has.  Only one device can connect to it, and Peripheral has some data.  A Central can scan the air in the search for devices, send connection requests, connect to any number of devices, can read, write and subscribe to data from Peripheral. <br><br>  What are we, as developers, available in the Apple ecosystem? <br><br><h3>  What is available to us? </h3><br>  <b>iOS / Mac OS:</b> <br><br><ul><li>  Peripheral and Central. </li><li>  Background mode. </li><li>  Restore condition. </li><li>  Connection interval 15 ms. </li></ul><br>  <b>watchOS / tvOS:</b> <br><br><ul><li>  watchOS 4 + / tvOS 9+. </li><li>  Only Central. </li><li>  Maximum two connections. </li><li>  Apple watch series 2+ / AppleTv 4+. </li><li>  Shutdown when switching to background mode. </li><li>  Connection interval 30 ms. </li></ul><br>  The most important difference is the connection interval.  What does it affect?  To answer this question, you first need to figure out how the Bluetooth LE protocol works and why such a small difference in absolute values ‚Äã‚Äãis very important. <br><br><h3>  How the protocol works </h3><br>  How is the process of searching and connecting? <br><br>  Peripheral announces its presence with the frequency of the advertisement interval, its package is very small and contains only a few identifiers of the services that the device provides, as well as the name of the device.  The interval can be quite large and can vary depending on the current status of the device, power saving mode and other settings.  Apple advises developers of external devices to tie the length of the interval to the accelerometer: increase the interval, if the device is not used, and when it is active, reduce to quickly find the device.  The advertisement interval does not correlate in any way with the connection interval and is determined by the device itself depending on the power consumption and its settings.  He is not available to us in the Apple ecosystem and is unknown, it is completely controlled by the system <br><br><img src="https://habrastorage.org/webt/na/_v/66/na_v662ojn9_xtvkdfma2wxyfaa.png"><br><br>  After we have found the device, we send a connection request, and here comes the connection interval - the time after which the second device can respond to the request.  But this is when connected, and what happens when reading / writing? <br><br><img src="https://habrastorage.org/webt/iq/mv/hg/iqmvhgecmnlikziagjsbda4vxe0.png"><br><br>  The connection interval also appears when reading data - its decrease by 2 times increases the data transfer rate.  But you need to understand that if both devices do not support the same interval, then the maximum one will be selected. <br><br>  Let's take a look at what a packet of information consists of that Peripheral transmits. <br><br>  The MTU (maximum transmission unit) of such a package is determined during the connection process and varies from device to device and depending on the operating system.  In the protocol version 4.0, the MTU was about 30, and the size of the payload did not exceed 20 bytes.  In version 4.2, everything has changed, now you can transfer about 520 bytes.  But, unfortunately, this version of the protocol is supported only by devices younger than IPhone 5s.  The overhead, regardless of the MTU size, is 7 bytes: this includes the ATT and L2CAP headers.  With the record, in general, a similar situation. <br><br><img src="https://habrastorage.org/webt/gp/zi/ho/gpzihocxxa6po-lfmmlqyl5e7wu.png"><br><br>  There are only two modes: with answer and without.  No reply mode significantly speeds up data transfer, since there is no timeout before the next entry.  But this mode is not always available, not on all devices and not on all systems.  Access to this recording mode may limit the system itself, because it is considered less energy efficient.  In iOS, there is a method in which you can check before recording whether such a mode is available. <br><br>  Now let's consider what the protocol consists of. <br><br><img src="https://habrastorage.org/webt/um/mh/um/ummhumgo7y_x3aeeu03wcv9shiy.png"><br><br>  The protocol consists of 5 levels.  <b>The application layer</b> is your logic described above CoreBluetooth.  <b>GATT (Generic Attributes Layer)</b> is used to share services and features that are on devices.  <b>ATT (Attributes Layer) is</b> used to manage your characteristics and transfer your data.  <b>L2CAP</b> is a low-level data exchange protocol.  <b>The controller</b> is the BT chip itself. <br><br>  <b>You probably ask what is GATT and how can we work with it?</b> <br><br>  GATT consists of features and services.  A characteristic is an object in which your data is stored, like a variable.  A service is a group in which your characteristics are located, like a namespace.  The service has a name - UUID, you choose it yourself.  A service may contain a child service. <br><br><img src="https://habrastorage.org/webt/qs/cr/8k/qscr8kzsigratdfk7boemuqz_ri.png"><br><br>  The characteristic also has its own <b>UUID</b> - in fact, the name.  <b>Value</b> (Value) characteristics - this is NSData, here you can record and store data.  <b>Descriptors</b> are a description of your characteristic, you can describe what data you are expecting in this characteristic, or what they mean.  There are many descriptors in the Bluetooth protocol, but only two are currently available on Apple systems: the human description and the data format.  There are also <b>access levels</b> (Permissions) for your characteristics: <br><br><img src="https://habrastorage.org/webt/xz/zh/kz/xzzhkzptblzhshwvso6kiiygtwe.png"><br><br><h3>  <b>Try it yourself</b> </h3><br>  We had an idea to make the possibility of transferring money over the air, without requiring anything from the recipient.  Imagine, you are puzzled over a very interesting task, writing the perfect code, and then a colleague suggests to go for coffee.  And you are so passionate about the task that you can not leave, and ask him to buy you a cup of delicious cappuccino.  He brings you coffee, and you need to give him back the money.  You can translate by phone number, it works fine.  But here is an awkward situation - you do not know his number.  Well, like this, you have been working for three years, but you have not exchanged numbers :) <br><br>  Therefore, we decided to make it possible to transfer money to those who are nearby, without entering any user data.  Like in AirDrop.  Just select a user and send the amount he needs.  Let's see what we need for this. <br><br><img src="https://habrastorage.org/webt/kp/tc/vs/kptcvsdcwhwapavwoxyq7h20nq4.png"><br><br><h3>  <b>PUSH mapping</b> </h3><br>  We need the sender to: <br><br><ol><li>  Could find all the devices that are nearby and support our service. </li><li>  Could read the details. </li><li>  And he could send a message to the recipient that he had successfully sent him the money. </li></ol><br>  The recipient, in turn, must be able to inform other senders that he has a service with the necessary data, and be able to receive messages from the sender.  I think it‚Äôs not worth describing how the process of transferring money by requisites takes place in our bank.  And now we will try to implement it. <br><br>  First you need to come up with the name of our service and features.  As I said, this is a UUID.  We simply generate them and save them on Peripheral and Central, so that both devices are the same. <br><br><img src="https://habrastorage.org/webt/xp/bd/xi/xpbdxioazo7xd4wbnnluhmncbk4.png"><br><br>  You are free to use any UUID, except those that end like this: XXXXXXXX- <b>0000-1000-8000-00805F9B34FB</b> - they are reserved for different companies.  You yourself can buy such a number and no one will use it.  It will <a href="https://www.bluetooth.com/specifications/assigned-numbers/16-bit-uuids-for-members">cost</a> $ 2500. <br><br>  Next, we will need to create managers: one for the transfer of funds, the other for receiving.  You just need to specify the delegates.  We will transmit Central, receive Peripheral.  We create both, because both the sender and the recipient can be the same person at different times. <br><br><img src="https://habrastorage.org/webt/m3/vl/ta/m3vltagqi_tzwe8r6ayu70j3wyg.png"><br><br>  Now we need to make the possibility of detecting the recipient and write down the details of the recipient in our characteristic. <br><br><img src="https://habrastorage.org/webt/ui/nf/hb/uinfhboh_hqspuyugii1xkukh1a.png"><br><br>  First, create a service.  Let's write the UUID and indicate that it is primary - that is, the service is central to this device.  A good example: a pulsomer, for which the main service will be the current state of the pulse, and the state of the battery is background information. <br><br>  Then we create two characteristics: one for reading the recipient‚Äôs details, the second for recording, so that the recipient can find out about sending money.  We register them in our service, then we add to the manager, we start detection and we specify the UUID of the service so that all devices that are nearby can learn about our service before connecting to it.  This data is placed in a packet that Central sends during the broadcast. <br><br>  The recipient is ready, proceed to the sender.  Start the search and connect. <br><br><img src="https://habrastorage.org/webt/zq/d6/6j/zqd66jsw2k8gyb-chlj778dx_u8.png"><br><br>  When you turn on the manager, we start the search for devices with our service.  When we find them, we get them in the delegate method and immediately connect.  Important: you need to keep a strong link to all Peripheral you work with, otherwise they will ‚Äúleak‚Äù. <br><br><img src="https://habrastorage.org/webt/ll/ce/nf/llcenfrfgkrgdgxxy0wh2usf9-q.png"><br><br>  After successful connection, we set up a delegate that will work with this device, and receive the service we need from the device. <br><br><img src="https://habrastorage.org/webt/j3/f0/lh/j3f0lh82sza1lncds8ujfd4yoac.png"><br><br>  We have successfully connected to the recipient, now we need to read his details. <br><br>  After connection, we have already requested all services from the device.  And after receiving them, the delegate method will be called, which will list all the services available on this device.  We find the necessary and request its characteristics.  The result can be found by the UUID in the delegate method that stores the data for translation.  We try to read them, and we get what we need again in the delegate method.  All services, features and their values ‚Äã‚Äãare cached by the system, so it is not necessary to request them later each time. <br><br><img src="https://habrastorage.org/webt/cn/e8/qh/cne8qh7dtbbir7q76abbpil4ywk.png"><br><br>  Everything, we sent money for coffee, it's time to show the recipient a beautiful notice that he was waiting for rubles in his account.  For this you need to implement the process of sending a message. <br><br>  We get the characteristic we need from the sender, in this case we took it from the saved value.  But before that you need to get it from the device, as we did before.  And then just write the data in the desired characteristics. <br><br>  After that, on the other device, we get a write request in the delegate method.  Here you can read the data that is sent to you, respond to any error, for example, there is no access, or this characteristic does not exist.  Everything will work, but only if both devices are turned on and applications are active.  And we need to work in the background! <br><br><img src="https://habrastorage.org/webt/3n/3x/4n/3n3x4no4wu9c95ej5nlmxrfc5g8.png"><br><br>  Apple allows you to use Bluetooth in the background.  To do this, you need to specify the key in info.plist, in which mode we want to use, in Peripheral or Central. <br><br><img src="https://habrastorage.org/webt/e8/sk/ns/e8skns2rwruttrhvy1wagrcoppq.png"><br><br>  Next, in the manager, you need to specify the recovery key and create a delegate method.  Now we have access to the background mode.  If the application falls asleep or is unloaded from memory, then when the necessary Peripheral is found or when Central is connected, it will wake up, and the manager will be restored with your key. <br><br><img src="https://habrastorage.org/webt/7y/lz/xd/7ylzxdqlziqkiiqyby2ppkbcfws.png"><br><br>  Everything is fine, already ready to be released.  But here designers come running to us and say: ‚ÄúWe want to insert photos of users, so that it is easier for them to find each other‚Äù.  What to do?  With us, it‚Äôs possible to record a total of some 500 bytes, and on some devices there are generally 20 :( <br><br><img src="https://habrastorage.org/webt/cu/dd/_l/cudd_lekcmzrpsmf-mz-9w7is0m.png"><br><br><h3>  <b>Go deeper</b> </h3><br>  To solve this problem, we had to go deeper. <br><br><img src="https://habrastorage.org/webt/rt/bf/8h/rtbf8hlexfy42goqfvxs8mojyig.png"><br><br>  Now we talked devices at the level of GATT / ATT.  But in iOS 11, we have access to the L2CAP protocol.  However, in this case you will have to take care of the data transfer yourself.  Packets are sent with an MTU of 2 Kb, no need to recode to anything, the usual NSStream is used.  Data transfer speeds of up to 394 kilobits / sec., According to Apple. <br><br>  Suppose you transfer any data of your service from Peripheral to Central in the form of normal characteristics.  And it took to open the channel.  You open it on Peripheral, in response you receive a PSM - this is the channel number to which you can connect, and you need to transfer it to Central using the same characteristics.  The number is dynamic, the system chooses which PSM to open at the moment.  After the transfer, you can already connect to Peripheral on entral and exchange data in a format that is convenient for you.  Let's look at how to do this. <br><br>  For starters on Peripheral open the port with encryption.  You can do without encryption, then it will speed up the transfer a bit. <br><br><img src="https://habrastorage.org/webt/ov/yd/ku/ovydkugm5hgyddaroucpcdjmaq0.png"><br><br>  Next, in the delegate method, we get the PSM and send it to another device. <br><br><img src="https://habrastorage.org/webt/tm/5g/bv/tm5gbvpsr1dbn8_x3jhg1btpth4.png"><br><br>  After connecting another device, we will call a method in which from the channel we can get the necessary NSStream for transmission. <br><br><img src="https://habrastorage.org/webt/nf/ec/kw/nfeckwjotne6tgzochcost5dr5g.png"><br><br>  With Central, it's even easier, we just connect to the channel with the desired number ... <br><br><img src="https://habrastorage.org/webt/oi/tm/hg/oitmhgdbpty9nmathmdnbhsisok.png"><br><br>  ... and after that we get the streams we need.  In them you can transfer absolutely any data of any size, and build your own protocol on top of L2CAP.  So we realized the transfer of photographs of the recipient. <br><br><img src="https://habrastorage.org/webt/fq/hq/ha/fqhqha7vfucpkksx4whppmay_du.png"><br><br>  But there are pitfalls, where do without them. <br><br><h3>  <b>Underwater rocks</b> </h3><br>  Let's look at the pitfalls when working in the background.  Since the roles of Peripheral and Central are available to you, you might think.  that in the background you can determine which devices near are in the background, and which in the active.  In theory, it should have been, but Apple imposed a restriction: phones that are in the background, be it Central or Peripheral, are not available for other phones that are also in the background.  Also, phones that are in the background are not visible from non-iOS devices.  Let's look at why this is happening. <br><br>  When your device is active, it sends a normal broadcast packet, which can contain a device name and a list of services.  which this device provides.  And overflow data - all that did not fit. <br><br><img src="https://habrastorage.org/webt/si/ca/ri/sicarigcdlr017kg1zpesa15psc.png"><br><br>  When the device goes into the background, it does not transfer the name, and the list of supported services transfers to the overflow data.  If the application is active, it reads this data when scanning from an iOS device, and ignores it when switching to the background.  Therefore, when you go to the background, you will not be able to see applications that are also in the background.  The remaining Apple operating systems always ignore overflow data, so if you search for devices that support your service, you will get an empty array.  And if you connect to each device that is nearby, and request supported services, then the list may contain your service and you can work with it. <br><br><img src="https://habrastorage.org/webt/nj/qc/s5/njqcs5ytnn4czeiumbsvwiqb3cu.png"><br><br>  Next, we were already preparing to pass on to testing, corrected minor flaws, were engaged in optimization.  And suddenly, at some point, we started getting this error in the console: <br><br><pre><code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">124</span></span></code> </pre> <br>  The worst thing was that no delegate method was called, we could not even beat this error for the user.  Just a message to the log - and silence, everything froze.  No special changes were made, so we started rolling back to the commits.  And they found that they once optimized the code and reworked the way they write data.  The problem was that not all customers were updated, so this error occurred. <br><br><pre> <code class="javascript hljs">.write != .writeWithoutResponse</code> </pre> <br>  We, happy to have corrected everything, ran more quickly to transfer to testing, and they almost immediately return to us: ‚ÄúYour fashionable photos do not work.  They all come underloaded. ‚Äù  We started to try, and the truth is, sometimes, on different devices, at different times come broken photos.  Began to look for the cause. <br><br>  And here again they saw the same mistake.  Immediately thought that it was in different versions.  But after the complete removal of the old version from all test devices, the error was still reproduced.  We felt sad ... <br><br><pre> <code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">722</span></span> CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">249</span></span> CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">312</span></span></code> </pre> <br>  Began to look for a tool for debugging.  The first thing we came across was Apple Bluetooth Explorer.  A powerful program that can do a lot of things, but for debugging the Bluetooth LE protocol there is one small tab with searching for devices and obtaining characteristics.  And we needed to analyze L2CAP. <br><br>  Then found the LightBlue Explorer.  It turned out to be quite a decent program, albeit with a design from iOS 7. It can do the same thing as Bluetooth Explorer, and can also subscribe to features.  And it works more stable.  Everything is good, but again without L2CAP. <br><br>  And then we remembered the well-known WireShark sniffer. <br><br>  It turned out he is familiar with Bluetooth LE: can read L2CAP, but only under Windows.  Although it is not scary that we will not find a Windows or something.  The biggest disadvantage is that the program works only with a specific device.  That is, it was necessary to find somewhere a device in the official store.  And you understand that in a large company they are unlikely to approve the purchase of an incomprehensible device at a flea market.  We even started browsing overseas online stores. <br><br>  But they found PacketLogger program in Additional Xcode Tools.  It allows you to watch the traffic that goes on your OS X device.  Why not rewrite our MoneyDrop under OS X?  We already had a separate library.  We just replaced the UIImage with NSImage, everything started by itself in 10 minutes. <br><br><img src="https://habrastorage.org/webt/vm/tn/z3/vmtnz3yw28-g7zsb8-cf6nldt6o.png"><br><br>  Finally, we could read the packets exchanged between the devices.  It immediately became clear that at the time of data transfer via L2CAP one of the characteristics was recorded.  And due to the fact that the channel was fully occupied by the transfer of photos, iOS ignored the recording, and the sender, after ignoring, cut off the channel.  After correcting problems with the transfer of photos was not. <br><br><img src="https://habrastorage.org/webt/ig/gw/sn/iggwsno_4bqfunmdzy0pigsn77i.png"><br><br>  That's all, thanks for reading :) <br><br><h3>  <b>useful links</b> </h3><br>  <b>WWDC / CoreBluetooth:</b> <br><br><ul><li>  <a href="https://developer.apple.com/videos/play/wwdc2017/712/">https://developer.apple.com/videos/play/wwdc2017/712/</a> </li><li>  WWDC 2012 Session 703 Core Bluetooth 101 </li><li>  WWDC 2012 Session 705 Advanced Core Bluetooth </li></ul><br>  <b>Bluetooth</b> <br><br><ul><li>  <a href="https://www.bluetooth.com/specifications/gatt">https://www.bluetooth.com/specifications/gatt</a> </li><li>  Getting Started with Bluetooth Low Energy O'Reilly </li></ul><br>  <b>YouTube</b> <br><br><ul><li>  Arrow Electronics ‚Üí Bluetooth Low Energy Series </li></ul></div><p>Source: <a href="https://habr.com/ru/post/452278/">https://habr.com/ru/post/452278/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452262/index.html">Angular: library creation and publishing</a></li>
<li><a href="../452264/index.html">How we made the site for the Mascots auto award</a></li>
<li><a href="../452266/index.html">Serverless racks</a></li>
<li><a href="../452272/index.html">Girl under the waterfall</a></li>
<li><a href="../452276/index.html">Reverse engineering client Dropbox</a></li>
<li><a href="../452280/index.html">PostgreSQL 11: The Evolution of Partitioning from Postgres 9.6 to Postgres 11</a></li>
<li><a href="../452282/index.html">Elementary, Watson: you integrate with Voximplant</a></li>
<li><a href="../452284/index.html">The classification of land cover using eo-learn. Part 1</a></li>
<li><a href="../452288/index.html">Situation: US mobile operators accused of illegal sale of subscribers geodata</a></li>
<li><a href="../45229/index.html">Classmates do not give to write about Vkontakte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>