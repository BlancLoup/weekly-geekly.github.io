<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fight for resources, part 5: Starting from scratch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to study cgroups. In Red Hat Enterprise Linux 7, they are enabled by default, because systemd is used here, and it, in turn, has already b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fight for resources, part 5: Starting from scratch</h1><div class="post__text post__text-html js-mediator-article">  We continue to study cgroups.  In Red Hat Enterprise Linux 7, they are enabled by default, because systemd is used here, and it, in turn, has already built-in cgroups.  With Red Hat, Red Hat Enterprise Linux 6 is a little different.  In fact, cgroups controllers were originally there and there, and this version came out, we recall, in January 2010, that is, a couple of centuries ago in terms of computer years. <br><br><img src="https://habrastorage.org/webt/7y/lx/mw/7ylxmwyn3vgxxrj7b6utthzftwk.png" width="100%"><br><br>  However, cgroups in Red Hat Enterprise Linux 6 and today are capable of a lot, which we will illustrate today. <br><a name="habracut"></a><br>  Let us analyze the cgroups features in Red Hat Enterprise Linux 6 on one purely hypothetical example entirely based on real events.  But for a start, according to tradition, a small digression. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      With security in IT, there have never been as many problems as now.  It is not surprising, because today not only all computers and telephones are connected to the network, but also refrigerators, vacuum cleaners and a bunch of different other things - the scope for network threats is simply immense.  And the fight against these threats, as a rule, begins immediately on all fronts.  Rapid installation of security patches?  Yes, sure!  Strengthening the protection of the system - firewalls, SELinux, competent authentication, is that all?  Of course!  Antivirus scanners on Linux machines?  Well, how to say ... <br><br>  On Linux machines, anti-virus scanners sometimes do more harm than good.  However, bezopasnik have their reasons, and they often require regularly run anti-virus checks, not really thinking about their validity from a technical point of view.  And this is the reality that you have to put up with, and with which, sooner or later, almost every IT person is confronted. <br><br>  The second point is that Red Hat Enterprise Linux 7 is certainly fashionable, advanced and cool, but many still use Red Hat Enterprise Linux 6 and don‚Äôt think of giving it up.  In fact, people therefore choose Red Hat - you can sit on the same version for years and still have all the latest patches, updates and support. <br><br>  Back to our example ... Imagine that there is a guy named Jerry.  Jerry works in a large office and is responsible for the servers of Red Hat Enterprise Linux 6. He is completely satisfied with the way they work, and he doesn‚Äôt need new problems and bumps. <br><br>  But then the guys from the security department decide that all of its servers need to put one thing called ScanIT.  And since this thing will periodically check disks and memory for viruses and other malware, it needs full root access. <br><br>  Jerry sighs, puts down his guitar and goes to put ScanIT on a test machine.  Pretty quickly it turns out that: <br><br><ul><li>  When you run antivirus scan, scanit (this is the script to start the process) eats away all the CPU time that you can reach.  And this is a very, very bad effect on the work of the test machine - once Jerry could not even reach her through ssh. </li><li>  In addition, the process scanit from time to time eats memory as not in itself.  As a result, the <a href="https://access.redhat.com/solutions/2612861">OOM Killer</a> wakes up and starts killing any processes other than the scanit itself. </li></ul><br>  In general, something must be done about it. <br><br>  Jerry picks up the guitar and, playing the Grateful Dead, begins to think.  Pretty quickly the thought comes to his mind that those very cgroups from Red Hat Enterprise Linux 7 can probably help here, about which a buddy named Alex buzzed all his ears.  Jerry again sets aside the guitar and is taken to read <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Resource_Management_Guide/ch01.html">docks</a> sent by Alex <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Resource_Management_Guide/ch01.html">on Red Hat Enterprise Linux 6</a> .  It turns out that the first thing he needs is libcgroup. <br><br>  There is no libcgroup on the test machine, so Jerry starts to install it: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-7/wt/dk/-7wtdk4uuvnhwypqp9oblrgtx60.png"></div><br><br>  In addition, Jerry includes two services that are necessary for the work of permanent (persistent) cgroups: <br><br><ul><li>  cgconfig - provides a more or less simple interface for working with cgroup trees.  Of course, Jerry could mount and configure cgroups manually, but why, if you can save time? </li><li>  cgred - this thing is a cgroup engine of rules: when starting a process, this service puts it into one or another cgroup according to the rules specified. </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/i-/4c/gai-4cqblbowiy66etcfkm9wxlc.png"></div><br><br>  By installing and configuring all this, Jerry can finally proceed directly to the problem itself.  Having thought it over well, he makes the following decision: <br><br><ul><li>  scanit and its child processes should consume no more than 20% of the CPU resources.  In fact, even less - no more than 20% of the resources of a single processor core, even on a multi-core machine.  In cgroups, this is done using CPU quotas. </li><li>  As for memory, scanit and its child processes should consume no more than 512 MB of system memory.  If they are crossing this line, the system should kill them, and not any other processes. </li></ul><br><h3>  Don't tell me what to do! </h3><br>  Jerry will have to deal with two sets of configuration files: <br><ul><li>  /etc/cgconfig.conf - automatically generated when installing libcgroup. </li><li>  /etc/cgrules.conf - contains a ruleset rule set, according to which cgred sorts start processes by cgroups groups. </li></ul><br>  Here is the default cgconfig.conf file: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jk/7-/ie/jk7-ie0pclu29d7uourgo6mjq6c.png"></div><br><br>  Jerry could have made the necessary changes directly to him, but it is better to use drop-in conf files for this.  How it works?  If you put (English drop-in - throw) into the /etc/cgconfig.d folder any file with the .conf extension, the system will process it and make the appropriate changes to the configuration.  This is convenient in that you can create drop-ins for various tasks and add or remove them from the configuration with the help of those tools that you like best (say, Ansible, well, this is still a Red Hat blog). <br><br>  First, Jerry creates a drop-in file for the CPU: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/li/w6/8u/liw68uvhsmfnz2dwet4g_9rfmhs.png"></div><br><br>  We look, that here with us and how it works. <br><br>  The group keyword simply specifies the name of the new cgroup group, in our case scanit.  Inside the curly braces, we specify the cgroup controls we want to use.  Here it is cpu.cfs_period_us and cpu.cfs_quota_us, they allow you to set the appropriate limits in Completely Fair Scheduler, the kernel scheduler that is used by default in Red Hat Enterprise Linux 6. Let's see what is written about them in the <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Resource_Management_Guide/sec-cpu.html">Red Enterprise Linux Resource Management Guide 6</a> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wr/jp/zx/wrjpzxiksqg-3eos3ammagjg_di.png"></div><br><br>  In other words, Jerry wrote in his drop-in: ‚ÄúFor every process related to cgroup called scanit, check the amount of CPU resources allocated to it once a second.  If the total processor time for all processes in this group is more than 200,000 milliseconds, then completely stop issuing processor time to these processes. ‚Äù  Well, that is, to allocate to all processes in the cgroup-group scanit, as well as their child processes, totally no more than 20% of the CPU time. <br><br>  After restarting cgconfig, the server will update the configuration, and if we get into the file system, we will see that scanit is now located in the CPU controller directory: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2u/is/z9/2uisz9gmmcpjaaqi7zjgauw-pwa.png"></div><br><br>  This, of course, is good, but we still need to somehow put the scanit itself into this cgroup.  Here crged comes in handy, by default it looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sm/-d/t5/sm-dt5oeb5xqypbyfgdytjagrci.png"></div><br><br>  Using this file is more or less easy.  True, for this we will have to directly edit the cgrules.conf file, since the drop-in mechanism is not supported here.  We specify the user or group that owns the process, as well as the name of the specific - if you want - process, as well as the custom controller and cgroup destination group. <br><br>  In our example, instead of a real anti-virus scanit scanit, we use a script, which is also called scanit, but in fact just emulates the load.  Without cgroup, it all looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rz/9e/jr/rz9ejrq2hvosc8tx6qygwtlprju.png"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zg/_q/5w/zg_q5wnmcxzrirruk73ium-l4xg.png"></div><br><br>  The CPU is fully occupied, mostly with user space and a bit of a system. <br><br>  Jerry is scratching his beard.  He launches vi and, using strictly one index finger, makes some changes and restarts the cgred daemon: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dn/sq/br/dnsqbrojxhtx0holtc3i-5f6uco.png"></div><br><br>  Then he manually launches scanit ...: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qa/o2/um/qao2umbcrsuefcn1n9m1jtrojtq.png"></div><br><br>  And - hooray!  Victory. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ik/vi/mr/ikvimrn0d_pkujdyjdaefnxzgsa.png"></div><br><br>  As you can see, our load emulation processes (child processes of scanits) now totally consume 20% of CPU resources, mainly in user space and a bit in system.  So, this damn antivirus will no longer load the car to complete insanity. <br><br><h3>  Remember what next? </h3><br>  Delighted with success, Jerry almost forgot about the memory.  But then he still remembers and starts vi again to fix his config-file. <br><br>  Now it adds two memory-related settings: <br><ul><li>  Memory.limit_in_bytes - max.  The amount of RAM that all processes in the cgroup-group scanit can use is total.  And without taking place in the swap.  Jeri limits his 256 MB </li><li>  Memory.memsw.limit_in_bytes - max.  the amount of RAM plus the space in the swap file that can be allocated to all processes in the cgroup-group scanit is total.  If this threshold is exceeded, OOM killer will kill the processes.  Jerry sets it to 512 MB. </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/d9/ey/p7/d9eyp7j01qhdzrc_xughbzsatny.png"></div><br><br>  Oh no!  What is wrong? <br><br>  Jerry looks top and sees that the child scanit processes are still running.  Since this cgroup is being used, Jerry cannot start the service.  Therefore, it kills child processes manually and restarts such services. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8t/er/fb/8terfbxnn3mp4bb-nrdmeasb1s4.png"></div><br><br>  Now a bit of editing in cgred.conf: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sr/ma/zs/srmazsl7k259dze13dcnjtij_ae.png"></div><br><br>  To check, Jerry runs several scanit tasks at once so that the OOM killer will work for sure. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mv/cf/m7/mvcfm7gxz5b_l2ylpptrp5skseo.png"></div><br><br>  Then Jerry looks at the system log and nods in satisfaction - scanit can no longer drive off the memory in any quantities with impunity. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rf/n-/gc/rfn-gcg6nk2lwjz5aelxw6lt9ue.png"></div><br><br>  Hopefully our cgroups series helped you understand what it is, how to use them in Red Hat Enterprise Linux 7, how to create them in Red Hat Enterprise Linux 6, and how to use them in your environment. <br><br><ul><li>  Part 1 - <a href="https://habr.com/company/redhatrussia/blog/423051/">habr.com/company/redhatrussia/blog/423051</a> </li><li>  Part 2 - <a href="https://habr.com/company/redhatrussia/blog/424367/">habr.com/company/redhatrussia/blog/424367</a> </li><li>  Part 3 - <a href="https://habr.com/company/redhatrussia/blog/425803/">habr.com/company/redhatrussia/blog/425803</a> </li><li>  Part 4 - <a href="https://habr.com/company/redhatrussia/blog/427413/">habr.com/company/redhatrussia/blog/427413</a> </li><li>  Part 6 - <a href="https://habr.com/company/redhatrussia/blog/430748/">habr.com/company/redhatrussia/blog/430748</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/429064/">https://habr.com/ru/post/429064/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429054/index.html">"Find N Differences." Experience testing layout Tinkoff.ru</a></li>
<li><a href="../429056/index.html">Physics, not biology, makes aging inevitable.</a></li>
<li><a href="../429058/index.html">Use Retrofit 2 in the Android application</a></li>
<li><a href="../429060/index.html">The concept of the perfect mind. Universal AI</a></li>
<li><a href="../429062/index.html">We tame multicast</a></li>
<li><a href="../429066/index.html">As the crew of the aircraft is preparing to fly</a></li>
<li><a href="../429068/index.html">Very corporate post: opening in Moscow or why November 10 and 11 are good days for buying electronics</a></li>
<li><a href="../429070/index.html">New MacBooks can't load Linux due to T2 chip</a></li>
<li><a href="../429072/index.html">Why Kodak died, and Fujifilm flourished: the story of two film makers</a></li>
<li><a href="../429074/index.html">Good deeds for Google money: a new AI Impact Challenge</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>