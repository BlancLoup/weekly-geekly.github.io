<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Microsoft Active Accessibility technology to access browser content</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Let's come up with a solution for such a simple task. 
 There is : a browser (IE, Chrome or Firefox), already launched by the user. 
 Required : write...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Microsoft Active Accessibility technology to access browser content</h1><div class="post__text post__text-html js-mediator-article">  Let's come up with a solution for such a simple task. <br>  <b>There is</b> : a browser (IE, Chrome or Firefox), already launched by the user. <br>  <b>Required</b> : write a program that will receive the URL that is currently entered in the address bar. <br><br>  Let's think about how to solve this simple problem will NOT work: <br><br>  <b>1.</b> FindWindow + GetWindowText <br><div class="spoiler">  <b class="spoiler_title">Why not work</b> <div class="spoiler_text">  The first idea is to find the browser window, there is a child window of the address bar and take the URL from there.  Practice shows that a separate child window for the address bar has only IE.  FF and Chrome are cross-platform, so they prefer to draw all their content on their own. </div></div><br>  <b>2.</b> Browser extension that will give the URL to our program (for example, through a request to localhost) <br><div class="spoiler">  <b class="spoiler_title">Why not work</b> <div class="spoiler_text">  Can.  But first, for three browsers, you will need to write 3 different extensions, and second, for FF and Chrome, we will be forced to distribute it only through their extension stores.  To write a program, the performance of which depends on whether the left heel of the moderator is combed today - no, thank you. </div></div><br>  <b>3.</b> Let's write a sniffer and see what the user opened there. <br><div class="spoiler">  <b class="spoiler_title">Why not work</b> <div class="spoiler_text">  And let's  But what next?  Even if we separate the data received by the browser and decrypt the HTTP protocol from the traffic stream, we still won‚Äôt know the <b>current</b> URL (there will be a lot of links in the stream).  In addition, HTTPS connections, HTTP / 2, links to locally open files, links to internal pages (like <a href="http://chrome//settings">chrome: // settings</a> ), etc. go straight to the garden. </div></div><br>  <b>4.</b> Let's use the <a href="http://habrahabr.ru/company/infopulse/blog/217121/">Remote Debugging Protocol</a> or some other Selenium <br><div class="spoiler">  <b class="spoiler_title">Why not work</b> <div class="spoiler_text">  Not suitable because of the limitations of the conditions of the original task: the browser is already running, we cannot launch a new instance under control, we need to interact with the existing one. </div></div><br>  <b>5.</b> Maybe <a href="http://habrahabr.ru/company/infopulse/blog/140456/">hooks</a> ? <br><div class="spoiler">  <b class="spoiler_title">Why not work</b> <div class="spoiler_text">  Well, we can penetrate into the browser.  And what to hang hooks for?  For IE, everything is clear - SetWindowText for the address bar window (but with it the simpler method # 1 passed).  And in FF and Chrome, we don‚Äôt have any clearly defined objects and interfaces that we can hook up to.  You can do something with a specific version of the browser, but there is no universal solution. </div></div><br>  <b>6.</b> Screenshot of the browser window, determining the position of the address bar, text recognition from the image! <br><div class="spoiler">  <b class="spoiler_title">Why not work</b> <div class="spoiler_text">  Already somehow starts to look like despair, right?  Let us estimate all the variants of the OS color schemes, resolutions, scales, take into account the presence of plug-ins in the browser, color schemes, non-standard layout of elements, right-to-left language locales and end the case when the address bar window is too narrow to fit the URL completely. </div></div><br>  <b>7.</b> Your option <br>  And write in the comments what other decisions you have in mind and we will think whether it will work or not. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And now one of the correct answers: we will use the already old, but very stable and supported by all browsers in all operating systems from Win95 to Win10, <a href="https://ru.wikipedia.org/wiki/Microsoft_Active_Accessibility">Microsoft Active Accessibility</a> technology, which will give us the opportunity not only to get the current URL (in the same way for all browsers), but in general, to give access to all browser content ‚Äî from the parent window itself, with its title, menu, toolbar, tabs, and up to the contents of the open web page right up to the most recent element. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  Microsoft Active Accessibility (MSAA) was invented as early as the 1997th year and made it possible to write screen magnifiers, applications for reading text from the screen and creating other programs that improve interaction with the computer of people with disabilities (eye problems , hearing, etc.).  Technology support in IE appeared a long time ago, in FF and Chrome was also added a bit later.  With the release of Vista, an improvement appeared - the Windows Automation API, however, the good old MSAA has not gone away, it works fine with the latest OS and browsers. <br><br><h4>  Code </h4><br>  In general, there is nothing difficult in the code.  The entry point for us will be the parent browser window, which can be obtained by its ClassID: <br><pre><code class="cpp hljs">FindWindow(<span class="hljs-string"><span class="hljs-string">L"IEFrame"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-comment"><span class="hljs-comment">// IE FindWindow(L"MozillaWindowClass", NULL); // Firefox FindWindow(L"Chrome_WidgetWin_1", NULL); // Chrome.    ,  -  (http://www.chromium.org/developers/design-documents/accessibility)    ,     "Chrome",  ,        .    ,       class name   .</span></span></code> </pre> <br><br>  Next you need to get a pointer to the <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/dd318466%2528v%3Dvs.85%2529.aspx">IAccessible</a> COM interface from this window. <br><pre> <code class="cpp hljs">::AccessibleObjectFromWindow(hWndChrome, OBJID_CLIENT, IID_IAccessible, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)(&amp;pAccMain));</code> </pre><br><br>  Yes, do not forget: <br><ul><li>  Include the header file #include "oleacc.h" </li><li>  Link Oleacc.lib </li><li>  Initialize COM by calling the function :: CoInitialize (NULL); <br>  It is very important not to forget!  Without this, something might start working for you, but at unexpected moments you will get strange errors.  It is also possible that there will be no errors, but you just will not get some data.  In general, a very vile and perfect error that cannot be debugged. </li></ul><br><br>  So, we have a pointer to IAccessible.  What it is?  This is the root node of the tree describing the entire browser - window, title, menu, toolbars, address bar, page content, statusbar.  How would all this be seen in a visual form?  Nothing is easier!  Microsoft provides the inspect.exe utility for this (it comes with the Windows SDK, I have it in the C: \ Program Files (x86) \ Windows Kits \ 8.0 \ bin \ x64) folder.  Chromium developers recommend the <a href="http://www.paciellogroup.com/blog/2013/03/aviewer-2013/">aViewer</a> utility. <br><br>  Let's see how the trees of the available browser elements look like: <br>  <b>IE</b> <br><img src="https://habrastorage.org/files/bd2/b22/30a/bd2b2230a17b45808882d33f464649d5.png"><br><br>  <b>Chrome</b> <br><img src="https://habrastorage.org/files/967/fbd/e7c/967fbde7c5f844fbbd7e1e4fdf90c8b7.png"><br><br>  <b>Firefox</b> <br><img src="https://habrastorage.org/files/6f5/6c8/b49/6f56c8b49f5f4b54b6d6e743c3fa5502.png"><br><br>  As we can see, the address bar is available through the IAccessible interface in all browsers.  The names of the elements, the position in the tree in different browsers are different, but in general, to access the address bar, we need only a couple of functions: the ability to get the name and value of the current element and the ability to get the children of the current tree element. <br><br>  Both are easy to write, here‚Äôs the final code that gets the current URL for Chrome. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stdafx.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;string&gt; #include &lt;iostream&gt; #include "windows.h" #include "oleacc.h" #include "atlbase.h" std::wstring GetName(IAccessible *pAcc) { CComBSTR bstrName; if (!pAcc || FAILED(pAcc-&gt;get_accName(CComVariant((int)CHILDID_SELF), &amp;bstrName)) || !bstrName.m_str) return L""; return bstrName.m_str; } HRESULT WalkTreeWithAccessibleChildren(CComPtr&lt;IAccessible&gt; pAcc) { long childCount = 0; long returnCount = 0; HRESULT hr = pAcc-&gt;get_accChildCount(&amp;childCount); if (childCount == 0) return S_OK; CComVariant* pArray = new CComVariant[childCount]; hr = ::AccessibleChildren(pAcc, 0L, childCount, pArray, &amp;returnCount); if (FAILED(hr)) return hr; for (int x = 0; x &lt; returnCount; x++) { CComVariant vtChild = pArray[x]; if (vtChild.vt != VT_DISPATCH) continue; CComPtr&lt;IDispatch&gt; pDisp = vtChild.pdispVal; CComQIPtr&lt;IAccessible&gt; pAccChild = pDisp; if (!pAccChild) continue; std::wstring name = GetName(pAccChild).data(); if (name.find(L"    ") != -1) { CComBSTR bstrValue; if (SUCCEEDED(pAccChild-&gt;get_accValue(CComVariant((int)CHILDID_SELF), &amp;bstrValue)) &amp;&amp; bstrValue.m_str) std::wcout &lt;&lt; std::wstring(bstrValue.m_str).c_str(); return S_FALSE; } if (WalkTreeWithAccessibleChildren(pAccChild) == S_FALSE) return S_FALSE; } delete[] pArray; return S_OK; } HWND hWndChrome = NULL; BOOL CALLBACK FindChromeWindowProc(HWND hwnd, LPARAM lParam) { wchar_t className[100]; if (GetClassName(hwnd, className, 100) == 0 || wcscmp(className, L"Chrome_WidgetWin_1") != 0) return TRUE; wchar_t title[1000]; if (GetWindowText(hwnd, title, 1000) == 0 || wcslen(title) == 0) return TRUE; hWndChrome = hwnd; return FALSE; } int _tmain(int argc, _TCHAR* argv[]) { ::CoInitialize(NULL); EnumWindows(FindChromeWindowProc, 0); if (hWndChrome == NULL) return 0; CComPtr&lt;IAccessible&gt; pAccMain; HRESULT hr = ::AccessibleObjectFromWindow(hWndChrome, 1, IID_IAccessible, (void**)(&amp;pAccMain)); // 1 -    CComPtr&lt;IAccessible&gt; pAccMain2; ::AccessibleObjectFromWindow(hWndChrome, OBJID_CLIENT, IID_IAccessible, (void**)(&amp;pAccMain2)); WalkTreeWithAccessibleChildren(pAccMain2); return 0; }</span></span></span></span></code> </pre><br><br>  Result of work: <br><br><img src="https://habrastorage.org/files/fd0/b35/ace/fd0b35aced914c40920aaf4657f196fc.png"><br><br>  For other browsers, everything is the same. <br><br><h4>  Small nuance </h4><br>  MSAA technology in Chrome is disabled by default.  This is related to Chrome architecture: its division into processes leads to the fact that in no one process is there any information about the entire tree of elements required by MSAA.  Chrome developers are not fools and have included the inclusion of the collection of this information and its caching in the main process.  But since this is all resource intensive, and MSAA technology is needed for a relatively small number of people, they turned it off by default.  You can enable it in two ways: <br><ul><li>  Manual: go to Chrome by chrome: // accessibility link and enable </li><li>  Program: Chrome creates a special ‚Äútrap‚Äù that can be used to send a message stating that an application using MSAA is present in the system.  You can send a message to this trap like this: <br><pre> <code class="cpp hljs">CComPtr&lt;IAccessible&gt; pAccMain; HRESULT hr = ::AccessibleObjectFromWindow(hwnd, <span class="hljs-number"><span class="hljs-number">1</span></span>, IID_IAccessible, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)(&amp;pAccMain)); <span class="hljs-comment"><span class="hljs-comment">// hwnd -   , 1 -   </span></span></code> </pre><br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/253729/">https://habr.com/ru/post/253729/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253719/index.html">Remote control of your smartphone with Node.js and Socket.io</a></li>
<li><a href="../253721/index.html">So you need a form</a></li>
<li><a href="../253723/index.html">We print stories from Medium</a></li>
<li><a href="../253725/index.html">Antifraud. Fast, cheap ... great (part 1)</a></li>
<li><a href="../253727/index.html">Pwn2Own 2015: results</a></li>
<li><a href="../253731/index.html">Antifraud. Functional and non-functional requirements (part 2)</a></li>
<li><a href="../253737/index.html">Expansion of system (and not only) tables in MODX Revolution</a></li>
<li><a href="../253739/index.html">Crowdin: anesthetic for localization</a></li>
<li><a href="../253741/index.html">Low Cost SAN Storage on LSI Syncro Part 2</a></li>
<li><a href="../253743/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ152 (March 16 - 22, 2015)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>