<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create a network sound card with preference and poetess</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Inspired by the topics one and two , I decided to build something similar. 

 In stock: 
 - One amplifier with speakers 
 - One desktop computer 
 - O...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create a network sound card with preference and poetess</h1><div class="post__text post__text-html js-mediator-article">  Inspired by the topics <a href="https://habr.com/post/158127/">one</a> and <a href="https://habr.com/post/181728/">two</a> , I decided to build something similar. <br><br>  In stock: <br>  - One amplifier with speakers <br>  - One desktop computer <br>  - One laptop <br>  - The desire to listen to Internet radio, regardless of the two preceding paragraphs and poking wires <br><br>  As a result, a plan was born to collect "audio card over ethernet".  Examining the issue of hardware compatibility, I chose the TP-link MR3020 router and USB Creative SB Play audio card. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What came out of it: <br><img src="https://habrastorage.org/getpro/habr/post_images/0cd/8eb/610/0cd8eb61000ef66aea54e1d3d8d02a2e.jpg"><br><br>  How to receive it, welcome under kat. <br><a name="habracut"></a><br>  I'll start immediately with the price.  A router can be found for 700 rubles, a sound card for 800 rubles, a USB hub for 200 rubles.  In the amount of 1700 rubles or $ 55.  And why no one else put it on the stream? <br><br>  All the flaws in the OpenWRT firmware (USB and package building) were related only to the previous version 10.03.  The last stable 12.09 is almost perfect. <br><br><h5>  We transfer the section / overlay to USB flash </h5><br>  Free space on the router about 800 kb.  So that it does not bother us, we connect to the USB flash router.  The section on the flash card is preformatted in ext4.  The instruction is already <a href="http://wiki.openwrt.org/doc/howto/extroot">there</a> , in brief: <br><blockquote>  opkg update <br>  opkg install block-mount block-hotplug block-extroot kmod-usb-core kmod-usb2 kmod-usb-ohci kmod-usb-storage kmod-fs-ext4 <br>  mkdir / mnt / sda1 <br>  mount / dev / sda1 / mnt / sda1 <br>  tar -C / overlay -cvf -.  |  tar -C / mnt / sda1 -xf - </blockquote><br><br>  We register in / etc / config / fstab <br><blockquote>  config mount <br>  option target / overlay <br>  option device / dev / sda1 <br>  option fstype ext4 <br>  option options rw, sync <br>  option enabled 1 <br>  option enabled_fsck 0 <br></blockquote><br>  Reboot the router and check: <br><blockquote>  mount |  grep sda <br>  / dev / sda1 on / overlay type ext4 (rw, sync, relatime, user_xattr, barrier = 1, data = ordered) <br></blockquote><br><br><h5>  We connect USB audio card </h5><br>  Install the necessary modules <br><blockquote>  opkg install kmod-usb audio kmod-sound-core <br></blockquote><br><br>  To USB hub'u connect the sound <s>card</s> flash drive, check: <br><blockquote>  dmesg |  grep -i audio <br>  [41.080000] usbcore: registered new interface driver snd-usb-audio <br></blockquote><br><br><h5>  Set up pulseaudio </h5><br><blockquote>  opkg install pulseaudio-daemon </blockquote><br>  Rule /etc/pulse/system.pa: <br><blockquote>  load-module module-native-protocol-unix auth-anonymous = 1 # for software running from the router itself <br>  load-module module-alsa-sink device = hw: 0.0 tsched = 0 # tsched = 0 is a dirty hack for eliminating crackles and wheezing <br>  load-module module-simple-protocol-tcp port = 4712 rate = 44100 format = s16le channels = 2 # for playing sound with windows <br>  load-module module-rtp-recv # for playing sound from linux devices over wifi <br>  load-module-module-native-protocol-tcp auth-anonymous = 1 # to play sound from linux devices over ethernet <br></blockquote><br><br>  Pulseaudio is launched from the pulse user, so we‚Äôre correcting the init script to grant write access to the /etc/init.d/pulseaudio audio devices: <br><pre><code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- pulseaudio_old 2013-06-19 12:30:18.425539419 +0400 +++ pulseaudio 2013-06-19 12:30:04.077704388 +0400 @@ -19,6 +19,9 @@ chmod 0750 /var/lib/pulse chown pulse:pulse /var/lib/pulse } + [ -d /dev/snd ] &amp;&amp; { + chown -R pulse:pulse /dev/snd + } service_start /usr/bin/pulseaudio --daemonize --system --disallow-exit --disallow-module-loading --disable-shm --exit-idle-time=-1 }</span></span></code> </pre> <br><br>  Add pulseaudio to autoload and run: <br><blockquote>  /etc/init.d/pulseaudio enable <br>  /etc/init.d/pulseaudio start <br></blockquote><br>  Add a freshly baked audio server at the sound source: <br><blockquote>  pacmd load-module-tunnel-sink server =% serverIP% <br>  pacmd set-default-sink 1 # number may differ depending on the output of pacmd list-sink <br></blockquote><br>  We try to reproduce the sound. <br><h5>  Teach MPD to work with pulseaudio </h5><br>  <b>Attention, hardcore!</b>  Compiling MPD can be easier, but I went the other way.  Download the source OpenWRT: <br><blockquote>  svn co svn: //svn.openwrt.org/openwrt/tags/attitude_adjustment_12.09/ <br></blockquote><br>  We compile the SDK (in make menuconfig, do not forget to specify your router and platform): <br><blockquote>  cd attitude_adjustment_12.09 <br>  make tools / install <br>  make toolchain / install <br></blockquote><br>  We get feeds with applications and ‚Äúinstall‚Äù them in our sandbox: <br><blockquote>  ./scripts/feeds update <br>  ./scripts/feeds install pulseaudio <br>  ./scripts/feeds install mpd <br></blockquote><br>  Dev pulseaudio package does not install all libraries, so we‚Äôre correcting package / feeds / packages / pulseaudio / Makefile: <br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- Makefile_old 2013-06-19 12:12:00.458287669 +0400 +++ Makefile 2013-06-19 12:07:43.225298052 +0400 @@ -139,7 +139,8 @@ $(INSTALL_DIR) \ $(1)/usr/lib/pkgconfig \ $(1)/usr/include/pulse \ - $(1)/usr/lib + $(1)/usr/lib \ + $(1)/usr/lib/pulseaudio $(CP) \ $(PKG_INSTALL_DIR)/usr/include/pulse/* \ $(1)/usr/include/pulse @@ -149,6 +150,9 @@ $(CP) \ $(PKG_INSTALL_DIR)/usr/lib/*.so* \ $(1)/usr/lib/ + $(CP) \ + $(PKG_INSTALL_DIR)/usr/lib/pulseaudio/*.so* \ + $(1)/usr/lib/pulseaudio/ endef define Package/pulseaudio-daemon/install</span></span></code> </pre><br>  Rules for mpd Makefile (package / feeds / packages / mpd / Makefile): <br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- Makefile_old 2013-06-18 17:47:56.277865458 +0400 +++ Makefile 2013-06-18 17:37:35.037187159 +0400 @@ -49,7 +49,7 @@ DEPENDS+= \ +AUDIO_SUPPORT:alsa-lib \ +libaudiofile +BUILD_PATENTED:libfaad2 +libffmpeg +libid3tag \ - +libmms +libogg +libshout +libsndfile +libvorbis + +libmms +libogg +libshout +libsndfile +libvorbis +pulseaudio-daemon PROVIDES:=mpd VARIANT:=full endef @@ -137,7 +137,7 @@ $(if $(CONFIG_BUILD_PATENTED),MAD_LIBS="$(TARGET_LDFLAGS) -lmad") \ TARGET_CFLAGS += -std=gnu99 -TARGET_LDFLAGS += -Wl,-rpath-link=$(STAGING_DIR)/usr/lib +TARGET_LDFLAGS += -Wl,-rpath-link=$(STAGING_DIR)/usr/lib,-rpath-link=$(STAGING_DIR)/usr/lib/pulseaudio # use gcc instead of g++ to avoid unnecessary linking against libstdc++ TARGET_CXX:=$(TARGET_CC) @@ -160,6 +160,7 @@ --enable-sndfile \ --enable-vorbis \ --enable-vorbis-encoder \ + --enable-pulse \ --with-faad="$(STAGING_DIR)/usr" \ --with-tremor=no \</span></span></code> </pre><br>  Run make menuconfig, select Sound / pulseaudio-daemon, Libraries / libffmpeg-mini, and then Sound / mpd-full <br><br>  Final Stage: <br><blockquote>  make package / mpd / compile <br>  make package / mpd / install <br></blockquote><br><br>  If everything went without errors, then we should get a ready-made package <b>bin / ar71xx / packages / mpd-full_0.16.5-2_ar71xx.ipk</b> .  If the compiler swears at something, then run <b>make package / mpd / compile V = 99</b> and see what exactly went wrong. <br><br>  Copy the package to the scp bin / ar71xx / packages / mpd-full_0.16.5-2_ar71xx.ipk tplink_ip: / tmp router and install the mpd package: <br><blockquote>  opkg update <br>  opkg install curl <br>  rm / tmp / opkg-lists / attitude_adjustment <br>  opkg install /tmp/mpd-full_0.16.5-2_ar71xx.ipk <br></blockquote><br>  Configuring MPD /etc/mpd.conf: <br><blockquote>  input { <br>  plugin "curl" <br>  } <br>  audio_output { <br>  type "pulse" <br>  name "My Device" <br>  } <br></blockquote><br>  We include in autoload and we start: <br><blockquote>  /etc/init.d/mpd enable <br>  /etc/init.d/mpd start <br></blockquote><br>  We check on linux: <br><blockquote>  mpc add <a href="http://pub4.di.fm/">pub4.di.fm</a> : 80 / di_latinhouse <br>  mpc play <br></blockquote><br><br>  Or in Windows, installing <a href="http://bitcheese.net/wiki/QMPDClient/">QMPDClient</a> (IMHO is the best multiplatform mpd client). <br><br><h5>  AAC problem </h5><br>  The standard library libfaad2 loses aac with a 100% load on the processor, since  on routers, processors do not do well with floating point computing.  For such cases, the library developers provided the FIXED_POINT option, but the OpenWRT developers did not have time to use it before the orientation_adjustment_12.09 release.  The latest version of the faf2 Makefile added the ability to compile with FIXED_POINT.  Just download the latest Makefile: <br><blockquote>  wget <a href="https://dev.openwrt.org/export/34527/packages/libs/faad2/Makefile">dev.openwrt.org/export/34527/packages/libs/faad2/Makefile</a> <br></blockquote><br>  Select in <b>make menuconfig</b> Advanced configuration options -&gt; Target options -&gt; Use software floating point by default and recompile the package: <br><blockquote>  make package / faad2 / compile <br>  make package / faad2install <br></blockquote><br>  We get the package bin / ar71xx / packages / libfaad2_2.7-2_ar71xx.ipk, install it in the same way as mpd (only in this case with the opkg upgrade command). <br>  Enjoy the warm sound of aac. <br><h5>  We connect as a sound source Windows </h5><br>  The only workable solution to broadcast audio to pulseaudio from Windows I found <a href="http://gleamynode.net/articles/2228/">here</a> .  But unfortunately for this you need to buy <b>Virtual Audio Cable</b> software. <br>  It starts with my bat'nikom: <br><blockquote>  linco.exe -B 16 -C 2 -R 44100 |  nc.exe tplink_IP 4712 <br></blockquote><br>  Yes, there are sound delays, especially over WiFi, but when watching a video it is easily treated with player settings. <br><br>  Instead of bat files, you can try running linco via srvany.  Who will succeed - please unsubscribe in the comments. <br><br><h5>  Modding </h5><br>  Those who are friends with a soldering iron and hands (if you are reading this, then surely you are friends with your hands?), Can put everything in one body.  I decided to disassemble the Chinese USB hub, unsolder the extra USB connectors from it, and the metal cases of the remaining two USB connectors.  Thus it turned out to turn the connectors themselves to 90 degrees. <br><br>  On the router itself, I soldered the contacts of the USB connector from the board, from the board itself stretched the wires to the USB hub, and already from the USB hub I ran the wires to an external USB connector.  In the case of the router I drilled two holes for Jacks and I managed to fit everything quite compactly.  Unfortunately, it is no longer possible to close the lid of the router tightly, but smart people have invented a blue electrical tape for these needs. <br><br>  What it looks like: <br><img src="https://habrastorage.org/getpro/habr/post_images/038/1aa/874/0381aa874d53bdf31125553ce41ec282.jpg"><br><br>  Workplace at 2 am: <br><img src="https://habrastorage.org/getpro/habr/post_images/a5f/a5b/c5c/a5fa5bc5c4c97108cdce176cffe19916.jpg"><br><br>  Stuck in the household irreplaceable.  There are plans to make another such in the kitchen, as well as connect an OLED display via <a href="http://wiki.openwrt.org/ru/toh/tp-link/tl-mr3020">I2C</a> , and an IR-receiver via a UART. <br><br>  PS Notes and error messages accept in PM. <br><br>  PPS Who does not want to compile, here are the assembled packages mpd and libfaad2 <br>  <a href="http://rghost.ru/46934574">rghost.ru/46934574</a> <br>  <a href="http://rghost.ru/46934558">rghost.ru/46934558</a> <br><br>  UPD: <br>  10/06/2013 - <a href="http://rghost.net/49184760">rghost.net/49184760</a> Pulseaudio 4.0 for OpenWRT </div><p>Source: <a href="https://habr.com/ru/post/184110/">https://habr.com/ru/post/184110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184096/index.html">Exception for GCC runtime libraries or why Clang still lacks OpenMP support</a></li>
<li><a href="../184100/index.html">How to remove McAfee antivirus: video tutorial with maids, masseuses and bath salt</a></li>
<li><a href="../184102/index.html">How we localize ArcheAge</a></li>
<li><a href="../184104/index.html">How to wean users add to friends when you just need to subscribe</a></li>
<li><a href="../184108/index.html">Raising money is a means, not an end in itself.</a></li>
<li><a href="../184112/index.html">Technodom - new low cost hoster</a></li>
<li><a href="../184116/index.html">Connecting fonts in your project</a></li>
<li><a href="../184118/index.html"># MBLT13: Mobile Trends from Japan</a></li>
<li><a href="../184120/index.html">Disputes about domain abbreviations</a></li>
<li><a href="../184124/index.html">Troj / JSRedir-LK Trojan and WordPress Vulnerability</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>