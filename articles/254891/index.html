<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We facilitate the support of iOS applications. Part 2 - location and network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, hrobrozhiteli, 

 Articles are devoted to how I cope with the support of applications that have not been through one version, were wri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We facilitate the support of iOS applications. Part 2 - location and network</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, hrobrozhiteli, <br><br>  Articles are devoted to how I cope with the support of applications that have not been through one version, were written at different times and by different people.  I hope they will help other iOS developers. <br><br><ol><li>  <a href="http://habrahabr.ru/post/254563/">We facilitate the support of iOS applications.</a>  <a href="http://habrahabr.ru/post/254563/">Part 1 - without looking up from Xcode</a> </li><li>  <a href="http://habrahabr.ru/post/254891/">We facilitate the support of iOS applications.</a>  <a href="http://habrahabr.ru/post/254891/">Part 2 - location and network</a> </li><li>  We facilitate the support of iOS applications.  Part 3 - Fall and Logs </li></ol><br>  In the first <a href="http://habrahabr.ru/post/254563/">article,</a> I shared my experience with hard-to-reproduce bugs.  In this article I will tell you how to deal with bugs that are associated with a network or location.  Those who are interested in this topic, please under the cat. <br><a name="habracut"></a><br>  The attentive reader of the first article could have guessed that for a long time I worked in an outsourcing business (no need to put a cross on me).  And therefore my articles describe situations where there is a customer who is far from you. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>The second type - incredible location conditions</b> </h4><h5>  "Here I have here, in Paris, the data is not so displayed" </h5>  It happens that a lot of things in the application are tied to the location, and everything is fine with you, but the client doesn‚Äôt display the data and is in Paris ... well, well, what else can I say.  And I'm in Siberia, and I have everything OK with the data, to each his own.  What to do?  Simulate location.  And so, consider our options: <br>  1) This is a simple substitution of the location in the simulator.  How to do nothing - he will put you in the right point.  ‚ÄúIOS Simulator‚Äù ‚Üí Debug ‚Üí Location. <br>  2) If the points are small, you can start to simulate the path, there are pgx files, are added to xcode through the right icon <br><img src="https://habrastorage.org/files/b7d/4d7/092/b7d4d7092e874df6a2b558dbc3cb0dc9.png"><br>  And the locations will move you along the way, but ... If my memory serves me, you can do this only by attaching the application to Xcode, and you cannot adjust the time between jumps.  What do testers do?  Sit at poppies?  Good company, if everyone bought a MAC.  And always connecting an Xcode app?  And if you need more delay, more than Xcode will do? <br>  3) This is where magic <b>runtime</b> methods unexpectedly come to the rescue, a lot has been written about them, for example <a href="http://m.habrahabr.ru/post/250955/">here</a> , but really why it can be useful ... it is not entirely clear.  However, here is an option that will help us solve the problem of changing the location or even navigating.  <a href="https://github.com/Azoft/FakeGPSUtility">FakeGPSUtility is</a> strictly not to judge, several times it was useful and played an important role, but this is still a bicycle, and here it is not to be unfounded and show you the direction.  This project fulfills its purpose - you can replace the location and jumps between them are not fixed.  Anyone can do this, even the client, Xcode is not needed and the main thing for me (for someone secondary) we do not change anything in the project code, everything is replaced when the application is launched.  That is, you attach it to the project, the project code remains the same, fix a bug / test and delete, or expose the necessary <b>#define</b> .  Voila, the useful tool is at hand, and this code will never fall into Release, only for tests. <br>  With iOS 8, the maps began to receive a location (the real location of the device), even when simulating, so if I get my hands, I finish the tool. <br>  In the meantime, she can do this with the card.  The red pin is what arrives in the delegate method <b>NSLocationManager</b> , the rest is the native behavior of the card.  The simulation was going on - the map was being conducted. <br><img src="https://habrastorage.org/files/57f/257/2eb/57f2572ebeee412f9405267b03385277.gif"><br><h4>  <b>Subspecies third - problems with http request</b> </h4>  - When the edge of the connection application does not work <br>  <s>- That is why I test it on WiFi, so why torture myself something!</s> <br>  Consider another case - the problem manifested itself due to a bad network.  In general, it is useful to simply simulate a bad internet connection and see how the application works, because while you are on WiFi, and maybe the service is on localhost, you will not understand how it behaves on 3g (and, God forbid, also on edge ).  So, for the sake of interest, go to the device in <b>Settings</b> ‚Üí <b>DeveloperNetwork Link Conditioner</b> ‚Üí <b>Enable</b> and choose how bad the connection we want.  After that, you can dramatically change the point of view about the speed of the application. <br>  And so, you can make the Internet slower, but what if you need to break down any one specific response in order to get the same problem as the client / tester?  Then you have to do another bike (tink-tink). <br>  As with FakeGPSUtility, I‚Äôm against dopilivat something inside our working classes for testing and bug-playing, the code is added exclusively around the project.  <b>NSURProtocol</b> to help us.  As for me, the 3 most likely places where a request may need to break is <b>NSURLSessionTask</b> , <b>UIWebView</b> and <b>WKWebView</b> .  There are other connections on the network, but here I will not help you - I will not advise anything good, just sit and spoil the project code for the sake of tests. <br><h5>  <b>NSURLSessionTask</b> </h5>  To break its response, we need our protocol to fall into all NSURLSessionConfiguration. To do this, override <pre><code class="hljs objectivec">- (<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *)protocolClasses</code> </pre>  And just return the array with our MyURLProtocol.  If your application uses other protocols, add them too (you can use NSClassFromString to avoid dragging the headers).  If you have even more complex logic and protocols are not everywhere and are not always used, then ... you are to blame - finish the bike in your own image and likeness. <div class="spoiler">  <b class="spoiler_title">joke, here's the code</b> <div class="spoiler_text"><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> kAssociatedObjectKey; - (<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *)protocolClasses { <span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> *result = objc_getAssociatedObject(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, &amp;kAssociatedObjectKey); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { result = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> customeProtocolsArray]; objc_setAssociatedObject(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, &amp;kAssociatedObjectKey, result, OBJC_ASSOCIATION_RETAIN_NONATOMIC); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)setProtocolClasses:(<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *)protocolClasses { <span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> *result = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> customeProtocolsArray]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (protocolClasses.count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { [result addObjectsFromArray:protocolClasses]; } objc_setAssociatedObject(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, &amp;kAssociatedObjectKey, result, OBJC_ASSOCIATION_RETAIN_NONATOMIC); } - (<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> *)customeProtocolsArray { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> arrayWithObject:[MyURLProtocol <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]; }</code> </pre></div></div>  But, for the bacgkound session, this won't work.  <a href="https://developer.apple.com/library/mac/documentation/Foundation/Reference/NSURLSessionConfiguration_class/">proof</a> <br><br><h5>  <b>UIWebView</b> </h5>  It‚Äôs still easier - just register the class.  For example: <pre> <code class="hljs objectivec">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)application:(<span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span> *)application willFinishLaunchingWithOptions:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)launchOptions { [<span class="hljs-built_in"><span class="hljs-built_in">NSURLProtocol</span></span> registerClass:[MyURLProtocol <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; }</code> </pre> <br><br><h5>  <b>WKWebView</b> </h5>  But here everything is bad, it will not be possible to replace it from the outside, you still have to stick crutches for this into the project code. <br><br><div class="spoiler">  <b class="spoiler_title">But, actually, the protocol itself</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">@implementation MyURLProtocol + (<span class="hljs-type"><span class="hljs-type">BOOL</span></span>)canInitWithRequest:(NSURLRequest *)request { #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !defined(STAGE_SERVER) || !STAGE_SERVER <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>; #endif NSString *urlString = [[request URL] absoluteString]; NSRange randge = [urlString rangeOfString:@"http://yandex.ru"]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (randge.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> YES; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>; } + (NSURLRequest *)canonicalRequestForRequest:(NSURLRequest *)request { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request; } + (<span class="hljs-type"><span class="hljs-type">BOOL</span></span>)requestIsCacheEquivalent:(NSURLRequest *)a toRequest:(NSURLRequest *)b { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>; } - (<span class="hljs-type"><span class="hljs-type">void</span></span>)startLoading { dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="hljs-number"><span class="hljs-number">2</span></span> * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{ NSError *error = [NSError errorWithDomain:@"MyErrorDomain" code:<span class="hljs-number"><span class="hljs-number">42</span></span> userInfo:@{ NSLocalizedDescriptionKey: @"We fail it!"}]; [self.client URLProtocol:self didFailWithError:error]; }); } - (<span class="hljs-type"><span class="hljs-type">void</span></span>)stopLoading { // stop request <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you can } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><br><h4>  <b>Subspecies fourth - for tests need a specific / obsolete response</b> </h4>  We are informed that yesterday the incorrect behavior was reproduced, but today it is no longer working, the service does not receive the same answer.  To say that now everything is working is wrong, since according to the law of the genre this situation will repeat on the very first day of release.  And you cannot influence the server-side team for a number of reasons: they are in another city, you do not know them, they are on vacation. <br>  In this situation, the NSURLProtocol is in a hurry to help you again.  We just need to change <nobr><b>+ (BOOL) canInitWithRequest: (NSURLRequest *) request</b></nobr> , so that with the necessary request we return the necessary data. <br>  This is how our <b>MyURLProtocol</b> might look like in order to simulate the desired response. <br><div class="spoiler">  <b class="spoiler_title">MyURLProtocol</b> <div class="spoiler_text"><pre> <code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyURLProtocol</span></span></span><span class="hljs-class"> + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">canInitWithRequest</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSURLRequest</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *urlString = [[request URL] absoluteString]; <span class="hljs-built_in"><span class="hljs-built_in">NSRange</span></span> randge = [urlString rangeOfString:<span class="hljs-string"><span class="hljs-string">@"http://localhost:1984/oldresponse"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (randge.location == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } + (<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *)canonicalRequestForRequest:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *)request { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request; } + (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)requestIsCacheEquivalent:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *)a toRequest:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *)b { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)startLoading { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *path = [[<span class="hljs-built_in"><span class="hljs-built_in">NSBundle</span></span> mainBundle] pathForResource:<span class="hljs-string"><span class="hljs-string">@"unexistd_response"</span></span> ofType:<span class="hljs-string"><span class="hljs-string">@"json"</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> *data = [<span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> dataWithContentsOfFile:path]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.client URLProtocol:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> didLoadData:data]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.client URLProtocol:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> didFailWithError:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)stopLoading { <span class="hljs-comment"><span class="hljs-comment">// stop request if you can } @end</span></span></code> </pre> </div></div><br><br>  Here we read unexistd_response.json from the file system, but no one forbids to redirect to a working machine, to pick up a small service on it and get an answer from it.  This is a great option if you have time and do not want to add strange files to a project, even if they are only for a while and for tests. <br>  Personally, I often create NSURLProtocol to work at first on a project, because often the service is only in plans and TK, but you really don't have it.  But I already want to write, as if the application works as it should, receives data, and, depending on them, shows the contents to the user.  I make myself <nobr><b>#define STAGE_SERVER 1</b></nobr> and, until they give me a working service, I work with local files.  They then save me when the developer, going home, turns off the computer, which was also a developer server (painfully funny situation, which was repeated several times). <br><br><h4>  <b>Conclusion</b> </h4><br>  Today we have examined cases where problems are very closely related to http requests or locations.  <b>NSURLProtocol</b> and <b>FakeGPSUtility are the</b> heroes of today's article, they will greatly simplify testing and reproducing the incorrect behavior of the application. </div><p>Source: <a href="https://habr.com/ru/post/254891/">https://habr.com/ru/post/254891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254881/index.html">The best icon is text.</a></li>
<li><a href="../254883/index.html">We optimize web form usability</a></li>
<li><a href="../254885/index.html">Description of digital machines on VHDL</a></li>
<li><a href="../254887/index.html">WPF: Using Attached Property and Behavior</a></li>
<li><a href="../254889/index.html">Matreshka.js 2: From simple to simple</a></li>
<li><a href="../254895/index.html">The taste and color 2 - not RGB one</a></li>
<li><a href="../254897/index.html">Lectures of the Technosphere. 1 semester Algorithms for intelligent processing of large amounts of data</a></li>
<li><a href="../254899/index.html">Encryption in NQ Vault turned out to be an ordinary XOR, and this is not the worst</a></li>
<li><a href="../254901/index.html">Universal Nixie-module on IN-12</a></li>
<li><a href="../254905/index.html">State Mandate to Kill the Universe and Counteract This (report at Bitcoin Conference Russia 2015)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>