<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Online game infrastructure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, my name is Alexander Zelenin , and I  on dude igrets  Web developer. A year and a half ago, I talked about the development of an online game . ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Online game infrastructure</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/f02/268/50b/f0226850b7a84d7999eef4bd4eb13a90.png" alt="image"></p><br><p>  Hello, my name is <a href="http://zelenin1.moikrug.ru/">Alexander Zelenin</a> , and I <del>  on dude igrets </del>  Web developer.  A year and a half ago, I <a href="https://habrahabr.ru/post/265395/">talked about the development of an online game</a> .  So, it has grown a bit ... The total volume of the source code has doubled the "War and Peace".  However, in this article I want to talk not about the code, but about the organization of the project infrastructure. </p><a name="habracut"></a><br><p>  Table of contents </p><br><ol><li>  <a href="https://habr.com/ru/post/319582/">I want to sleep well!</a> <br>  1.1.  <a href="https://habr.com/ru/post/319582/">Stable architecture planning</a> <br>  1.2.  <a href="https://habr.com/ru/post/319582/">Choosing a server / data center</a> <br>  1.3.  <a href="https://habr.com/ru/post/319582/">Load balancing</a> <br>  1.4.  <a href="https://habr.com/ru/post/319582/">Monitoring of everything and everyone</a> <br>  1.5.  <a href="https://habr.com/ru/post/319582/">Linked project - separate server</a> <br>  1.6.  <a href="https://habr.com/ru/post/319582/">Selection of support services</a> </li><li>  <a href="https://habr.com/ru/post/319582/">How to stop worrying and start developing</a> <br>  2.1.  <a href="https://habr.com/ru/post/319582/">Where to store photos?</a> <br>  2.2.  <a href="https://habr.com/ru/post/319582/">Setting up a home network</a> <br>  2.3.  <a href="https://habr.com/ru/post/319582/">Backup and backup strategy</a> <br>  2.4.  <a href="https://habr.com/ru/post/319582/">Your dropbox</a> <br>  2.5.  <a href="https://habr.com/ru/post/319582/">Virtual machines</a> <br>  2.6.  <a href="https://habr.com/ru/post/319582/">Jira - Confluence - Bitbucket - Bamboo</a> </li><li>  <a href="https://habr.com/ru/post/319582/">What is the result?</a> </li><li>  <a href="https://habr.com/ru/post/319582/">And what about the game?</a> </li></ol><br><p>  The table of contents does not reflect the chronology, although somewhere it will coincide.  This is not a how-to, not a manual and the like.  This is an overview article designed to give an idea of ‚Äã‚Äãwhat lies behind a small project. </p><br><p>  Almost every item has a rather extensive history (I deliberately cut everything down) and draws on a separate full-fledged article. </p><br><p>  In case this article turns out to be in demand, I will gradually write a cycle telling how to choose and set up certain tools. </p><br><p>  You can read in any order. </p><br><p>  Important factors in the final infrastructure were: reliability and cost of maintenance. <br>  Providing all this costs us less than 15 thousand rubles a month, most of which are eaten by <abbr title="Virtual Personal Cloud">VPC</abbr> .  And if you sacrifice the stability of the product itself and use a cheaper data center, then it would be possible to keep within 3 thousand.  These figures take into account depreciation and replacement of defective items. </p><br><br><h1 id="ya-hochu-spat-spokoyno">  I want to sleep well </h1><br><p>  After another fall of the project at 2 am and restoring work until the morning, it became clear that this could no longer continue.  And this is a story about the right side of the diagram. </p><br><p><img src="https://habrastorage.org/files/249/2a2/f09/2492a2f09c2644ebad70c1c6af71a73a.png" alt="image"></p><br><br><h2 id="planirovanie-stabilnoy-arhitektury">  Stable architecture planning </h2><br><p>  I wanted to make it so that no matter what happens, you can sleep and not worry that the project will suddenly become unavailable for any of the reasons, and then, in a relaxed atmosphere, slowly and carefully repair everything.  Along the way, I wanted to add the possibility of free horizontal scaling. </p><br><p>  The classic recipe is to run multiple instances of the application on different servers and, at the level above, direct the user to the running one.  The synchronization point is the database, so it must be as stable as the application itself. </p><br><p>  1) Database: <a href="http://mongodb.com/">MongoDB</a> <br>  Runs on at least two different physical servers.  One is the main, the rest are secondary. </p><br><p>  Since  databases and applications run on different servers and there is a chance of arbitrary inaccessibility, it is necessary to achieve full correct data synchronization when the connection is restored.  For this, MongoDB has a <a href="https://docs.mongodb.com/manual/core/replica-set-elections/">special mechanism</a> - at least 50% + 1 servers are required to select a server as the primary one.  We also want servers with applications to participate in this voting, due to the fact that initially only 2 servers are planned for the bases (50% + 1 of 2 are the same two, that is, not enough to vote).  To do this, MongoDB has a special way to run a database instance without the data itself, but only in the voting mode ( <a href="https://docs.mongodb.com/manual/core/replica-set-arbiter/">Arbiter</a> ).  Such an Arbiter is additionally placed on each server with the application. <br>  An additional Arbiter runs on a backup server located outside the data center. </p><br><p>  In total we have 2 DB servers online, and 5 arbitrators (the DB server is also one). </p><br><p>  Now, whatever the instance of the database falls off - the other becomes the primary, and the fallen off becomes read-only until the connection is restored.  After the restoration of communication and full synchronization, he again becomes the main one.  If for some reason the second server and the backup server fall off - all databases go into read-only mode. </p><br><p>  Monitoring is also needed (monitoring the performance of the cluster): that it is available, that the data is in place, that the backup is in order, and so on. </p><br><p>  2) Application <a href="http://nodejs.org/">Nodejs</a> <br>  Similar to the previous one - at least two different physical servers.  All applications are equal, because  the synchronization point is data. </p><br><p>  This can be achieved, because  the applications themselves do not store any states, so even if one user joins different instances, it will not affect anything. <br>  On each server there are at least 2 instances of the application, which are monitored and balanced using <a href="http://pm2.keymetrics.io/">pm2</a> &amp; <a href="https://nginx.org/">nginx</a> . </p><br><p>  On top of this is performance monitoring. </p>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2 id="vybor-serveradata-centra">  Choosing a server / data center </h2><br><p>  Before choosing, it is necessary to determine how many resources our application consumes. </p><br><p> Since  I use Meteor, then the choice of load testing fell on <a href="https://github.com/meteorhacks/meteor-down">MeteorDown</a> .  I will check on the home server, allocating 100% of resources for the application. </p><br><p>  Server: Intel¬Æ Xeon¬Æ CPU E5-1620 v2 @ 3.70GHz (6 cores), 32GB <abbr title="error-correcting code">ECC</abbr> DRR3 memory. </p><br><p>  It will test itself, i.e.  network is not counted.  Yes, all this gives distortions, but acceptable. </p><br><p>  User behavior scripts are written, data sets are generated.  Run!  The load is gradually increasing, but at the same time the response time to the methods is kept stable.  Thousand online, two, three, five, six.  Gradually, the response time begins to grow.  Seven - the response time exceeds half a second.  Eight - the response time becomes unacceptably long (10+ seconds).  Rested in the CPU. </p><br><p>  Six thousand - it was ten times higher than the peak online.  So, we focus on 2-4 times smaller parameters, but we lay down the scaling. </p><br><p>  1) End of closed beta test <br>  During the beta test, registration was limited, respectively, and online too.  The architecture described above was not even in the project, because  until that moment everything was quite stable.  At this time, the entire application worked on a single <abbr title="Kernel-based Virtual Machine">KVM</abbr> <abbr title="Virtual Personal Server">VPS</abbr> 'ke (4 2.2GHz cores, 4GB of memory). </p><br><p>  By the start of the beta, it was decided to move (they have the same) to the ‚ÄúFailover Server‚Äù with a cost of two and a half times higher for similar characteristics, but it seems like a bunch of guarantees that everything is super stable and cool. </p><br><p>  With the launch of an open beta test, we started accepting payments, so that our commitment increased and there was no downtime. </p><br><p>  2) MBT <br>  The launch was quite successful, and it seemed like even everything worked well.  Suddenly, a couple of weeks later, a friend calls me in the afternoon and reports that the site is unavailable.  Okay, I'm running home.  I see that VPS'ka lies entirely with the word.  Trying to restart - unsuccessfully.  I am writing to tech support - they answer me: the disk crashed, recovery after a couple of hours. </p><br><p>  SHTA?  In the fake description of the "fault-tolerant server" I was assured that they have a server and <abbr title="Storage System">storage systems</abbr> separate, everything is super duplicated and that there will be 100% availability. </p><br><p>  I clarify these points and they tell me that they will compensate (ta-da-yes) 30 rubles!  For 6 hours of downtime.  Fine. </p><br><p>  OK, suppose I was really unlucky and some extraordinary event happened.  I specify the frequency of such events and the chances of occurrence in the future - they assure that everything will be fine.  Two days later - fall at 4 am.  The disk crashed, but this time also with data loss :-) </p><br><p>  3) The first move <br>  Thanks to backups, the loss was 24 hours (at that time there was a backup once a day), and due to the transaction history at the partner, it was not difficult to recover the payments.  Urgently looking for an alternative.  I find, pay and move. </p><br><p>  Three weeks later - the <abbr title="And you are curious :-)">situation is</abbr> almost the same.  M-yes.  A very nontrivial situation was for me. </p><br><p>  4) Tier 3, <a href="https://habrahabr.ru/company/dataline/">DataLine</a> <br>  I study the subject more deeply: how do adult uncles solve such questions?  I feel, and it's time for us to grow up. </p><br><p>  I am working on the scheme above, I am looking for the most reliable hosters and I come to the conclusion that the choice in the <abbr title="was limited to Russia for a number of reasons, we take this restriction for granted">Russian Federation is</abbr> not so big.  Almost no major players are interested in working with small projects, except for DataLine with their simplified version of CloudLite. </p><br><p>  I agree with the support of the test period and unfold everything as planned.  We transfer the domain. </p><br><p><img src="https://habrastorage.org/files/c60/6dc/64b/c606dc64b7ec462e8df478a1b34f3738.png" alt="image"></p><br><p>  Fuh, it seems to work.  But somehow slowly.  Inquiries return about <abbr title="300 milliseconds = 0.3 seconds">300ms</abbr> .  But at the same time there were no load jumps, i.e.  It was a stable 300ms. </p><br><p>  It was decided to leave and watch a few days.  In general, the stability pleased, but the lethality was annoying. </p><br><p>  He began to understand what was happening and immediately it became clear that the disk was a bottleneck - we have very carefully recorded the user's activity, and there was always a write queue.  It turned out that within CloudLite only <abbr title="VMware Virtual Storage Area Network">VSAN</abbr> drives are provided and moving to <abbr title="solid-state drive">SSD</abbr> to fix the problem is not possible. </p><br><p>  The alternative was to run <a href="https://docs.mongodb.com/manual/core/inmemory/">inmemory</a> version of mongo with replication already on the disk, but there were a few but: mongo provide a full-fledged in-memory version only for the enterprise (pa-ba-ba) 15 thousand dollars a year for one server.  In my case it was completely unjustified, especially in comparison with alternative solutions for the current level (moving to SSD).  There was also a <a href="https://dzone.com/articles/how-use-mongodb-pure-memory-db">tricky version of creating a memory section in linux and deploying the database there</a> , but I'm not a fan of these kinds of hacks, and it was problematic to figure out possible problems with this approach. </p><br><p>  In general, it was necessary to move to the SSD.  In DataLine, this is only available with the conclusion of the contract and on a different platform. </p><br><p>  On it, I also provided a test period.  I deployed it all over again, this time documenting all the steps for subsequent automation.  Re-transfer domain ... Hooray!  Everything works quickly and as it should. </p><br><p>  After the fact, I want to say that I am very pleased with this move, because  there was not a single idle time due to DataLine (more than 8 months already). </p><br><p>  There was one interesting idle time due to the DNS glitch (I still hosted the master zone at the first host, since all sorts of other small projects lived there), which suddenly rolled back for several months.  Well, that is  just started DNS to return the addresses of the old server and that's it. </p><br><p>  To catch this error was very difficult, because  someone worked, but someone does not (I originally worked).  But after resetting the DNS caches on the router, everything became immediately visible. <br>  As a result, the domain was also transferred to the DataLine and so far (pah-pah!) Works without problems. </p><br><br><h2 id="balansirovka-nagruzki">  Load balancing </h2><br><p>  So, now we have several servers and even more application instances and we need to somehow evenly distribute users to them in order to achieve maximum performance. </p><br><p>  The task is divided into two steps - balancing to the server and balancing within the server. </p><br><p>  1) Balancing to server <br>  Solved at the data center level.  All servers with applications are pooled, the choice of the server itself goes by two parameters: the first is a cookie, and if not, then IP hash.  The idea is that requests from one user always go to the same server, so caching will work more efficiently. </p><br><p><img src="https://habrastorage.org/files/5ee/9c1/0ac/5ee9c10ac41d45bcac8b5d3d8ea2f48e.png" alt="image"></p><br><p>  Since  All application servers are equal, and the weight is the same.  We add check of availability of 5 seconds. <br>  Is done. </p><br><p>  Now user requests are distributed fairly well to the servers, and in case one of the servers ceases to be available, then within 5 seconds the user is transferred to the other. </p><br><p>  2) Balancing within the server <br>  There are several options.  Since  I use pm2 to run nodejs processes, then I can run the required number of application instances (by the number of cores) in <a href="http://pm2.keymetrics.io/docs/usage/cluster-mode/">cluster</a> mode, which will already be managed by the node.  The disadvantage of this approach is that the <a href="https://github.com/Unitech/pm2/issues/389">sticky sessions</a> mechanism <a href="https://github.com/Unitech/pm2/issues/389">does not work</a> , but since  we keep the socket connected, then switching to another instance of the application is possible only in case of a break.  In our case, this is not a problem. </p><br><p>  The second option is to launch applications in fork mode on different ports and proxying them through nginx.  The advantage here is that nginx can also distribute static, yes SSL certificate (SSL has not yet been connected, by the way, but hands will soon reach). <br>  Register the application ports in the config, that's it. </p><br><p>  3) Check <br>  I check the load on the servers and see that it is evenly distributed.  Fine! </p><br><br><h2 id="monitoring-vsego-i-vsya">  Monitoring of everything and everyone </h2><br><p>  As in all tasks, we first try to understand what data we want to collect: </p><br><ol><li>  Information about the health of the application, the load on it, errors and so on. </li><li>  Database health data, data size, replication, log, and so on. </li><li>  User data, input devices, screen resolutions, referral sources, and more. </li><li>  Data about the actions in the game. </li></ol><br><p>  1) <a href="http://kadira.io/">Kadira.io</a> <br>  First of all, I want to note that this service, unfortunately, will soon <a href="https://voice.kadira.io/kadira-shutting-down-7d35994db85d">cease to exist</a> - it turned out to be unprofitable.  But the developer promised to give out source codes and information on how to deploy it all at home.  So, apparently, the project infrastructure is awaiting replenishment. </p><br><p><img src="https://habrastorage.org/files/b40/7ae/e8f/b407aee8fe5243f294d496df8d37d628.png" alt="image"></p><br><p>  There is no need to reinvent the wheel when there are wonderful ready-made tools.  Integration with the application is just the installation of a module from the package and the prescription of two lines in the config.  At the output, we get resource monitoring, heavy query profiling, a current activity monitor, an error analyzer, and a whole bunch more. </p><br><p>  2) <a href="https://cloud.mongodb.com/">MongoDB Cloud</a> </p><br><p><img src="https://habrastorage.org/files/96b/b99/0eb/96bb990eb8fb4c9eb84b1cc12d1f8cc7.png" alt="image"></p><br><p>  Integration is not much harder, but is placed on the database server, and not the application, respectively.  We put the module, start the watch'er. </p><br><p>  Immediately on the spot we monitor the database server resources, we see the time of requests, replication lags, tips to update the database. </p><br><p>  Quite a cool thing here - it is instant information in case of unavailability of the database in the mail. </p><br><p>  3) <a href="http://metrika.yandex.ru/">Yandex metric</a> </p><br><p><img src="https://habrastorage.org/files/a64/499/222/a644992221804300a034e5007d898634.png" alt="image"></p><br><p>  Integration is a bit more complicated than Kadira, because  in addition to installing the module, it is necessary to modify the application so that it informs the script of the metrics about navigating through the pages (in the <abbr title="Single page application">SPA it is</abbr> not always obvious which monitors should be monitored, therefore it is done this way).  Add the desired code to the router, and ready: gender, age, transitions, visits, devices, and so on.  All in one place.  Conveniently! </p><br><p>  4) Action in the game <br>  Recorded in the application database, of course.  You can subsequently configure it to transfer old data that is necessary only for analysis to a separate server.  For like, Monga also <a href="https://docs.mongodb.com/manual/sharding/">has tools</a> . </p><br><br><h2 id="svyazannyy-proekt--otdelnyy-server">  Linked project - separate server </h2><br><p>  Over time, the project is cluttered with various additions.  For example, we had a newspaper, which was made by the users themselves.  Initially, it was created and placed somewhere in one of the players, but then it closed abruptly and the player disappeared.  It was decided to deploy an analogue on <a href="https://wordpress.org/">wordpress</a> and to give the moderators the opportunity to publish articles on the near-game topics there. </p><br><p><img src="https://habrastorage.org/files/ee7/141/57b/ee714157b1984fa0a43d23405bb445a6.png" alt="image"></p><br><p>  Of course, on an existing server, you should not run this for at least security reasons. </p><br><p>  The secondary servers were decided to stir with a cheaper provider, because  their availability is uncritical. </p><br><p>  Although the hoster was still selected, leasing capacity in shooting gallery 3 to the data center. </p><br><br><h2 id="vybor-servisa-sluzhby-podderzhki">  Selection of support services </h2><br><p>  You also need a public place to collect information about errors.  The best option was the possibility of collecting proposals from players and voting on them.  Completely optional - posting change logs right there.  The possibility of free placement for small companies or up to any limit was very desirable. </p><br><p>  I tried about three dozen systems and eventually settled on <a href="http://helprace.com/">helprace</a> . </p><br><p><img src="https://habrastorage.org/files/862/891/dc2/862891dc2cda4665ab36f991869b5c92.png" alt="image"></p><br><p>  Directly as if made a request.  In general, they have integration with external login, but only in the paid version.  Since  One of the goals was to save on the cost of maintenance, the system requires registration separately. </p><br><p>  The audience is always very happy - hundreds of error messages, mountains of suggestions and wishes.  Sometimes even slips a low-profile praise the game and developers :-) </p><br><br><h1 id="kak-perestat-bespokoitsya-i-nachat-razrabatyvat">  How to stop worrying and start developing </h1><br><p>  And this is a story about the left side of the scheme. </p><br><p><img src="https://habrastorage.org/files/853/fa0/91f/853fa091fec3490fb10044213db6c793.png" alt="image"></p><br><br><h2 id="gde-hranit-fotografii">  Where to store photos? </h2><br><p>  A slightly strange heading in the framework of this article, but this very question led to the appearance of a home server. </p><br><p>  Before the <a href="http://habrahabr.ru/post/237661/">trip to India</a> right on the last day, the devil pulled me to go clean the matrix on the Canon D350 to an authorized center.  There, the ‚Äúmaster‚Äù with a dirty fucking claw scratched the matrix in the trash.  Before the plane was less than 8 hours, so there was no time for disassembly, something must be solved.  According to the reviews, we found a good point at the station, arrived there, gave it to the masters (there‚Äôs nothing to lose).  The guys twisted, asked: ‚Äúwhat happened to the matrix :-)‚Äù? .. They cleaned it somehow slyly and it became even acceptable (photos from India were made on this camera), for which they thank. </p><br><p>  But when I came home, I was shooting a little, because  all sorts of unpleasant stains in the photographs were spoiled even very successful frames. </p><br><p>  It's time to take a new camera, but really seriously - <abbr title="The size of the matrix is ‚Äã‚Äãequivalent to 35 mm film">FullFrame</abbr> right <abbr title="The size of the matrix is ‚Äã‚Äãequivalent to 35 mm film">away</abbr> .  First, the choice fell on the Nikon D800.  37 megapixels ... Mom dear, is that how much <abbr title="digital photo format containing raw data from photomatrix">raw</abbr> will it weigh?  50-100 megabytes!  (As a result, by the way, I took the D750 with a much more pleasant weight of raw'ok.) <br>  I like to keep the archive (deleting only duplicates and completely unsuccessful frames), and over time it became clear that there was just not enough home computer.  With such a weight is 12,000 photos per terabyte.  It seems that it is a lot, but in fact it is a few years of not very active shooting.  To understand - over the past year, the archive has exceeded 50 thousand photos.  And yes, sometimes for some tasks I return to my photo archive to find the one I need. </p><br><p>  A little googling, I realized that <abbr title="Network Attached Storage network storage">NAS was</abbr> invented just for this.  Then I came across <a href="https://ru.wikipedia.org/wiki/ZFS"><abbr title="Zettabyte File System">ZFS</abbr></a> and realized that it is wonderful to detect problems that I have already had several times: </p><br><p><img src="https://habrastorage.org/files/0a4/6fb/f7d/0a46fbf7d21f40f4a17998222c8b4dc4.png" alt="image"></p><br><p>  (It‚Äôs funny that I couldn‚Äôt upload a picture with an error; I had to take a screenshot and cut it out.) </p><br><p>  Tracking down such problems is difficult.  They were still able to fly to backup and duplicate in the raid. </p><br><p>  I was also saved by the fact that NAS nifiga were not available in my city (Kaliningrad), although now the situation is a little better. </p><br><p>  After a very long analysis (in general, it took more than 200 hours to solve the problem in the header), it was decided to build your server and put <a href="http://freenas.org/">FreeNAS</a> there. </p><br><p><img src="https://habrastorage.org/files/e6c/e39/d03/e6ce39d036044d40a81891431c51a01b.png" alt="image"></p><br><p>  In general, I collected right away for a long time, and the system potentially expands to petabyte storage and half a terabyte of RAM.  At the moment there are only 12 terabytes of space and 32GB of memory.  The total cost came out comparable or cheaper than ready-made NAS solutions (from 4 drives), while the flexibility and potential are much higher. </p><br><br><h2 id="nastroyka-domashney-seti">  Setting up a home network </h2><br><p>  Immediately it became immediately obvious that the old dir-300 just wouldn't let me work comfortably with the server.  Even if I took and went to pofot a bit, took 200 frames and started to dump (200 * ~ 75) 15GB, then the copy process itself would take about 20 minutes!  Think about what speed we need?  Judging by the tests, the disks in the planned WD Red storage system give out 100-150 megabytes per second, which means that the gigabit channel will be enough for us with exclusive use.  And if just two users?  For example, someone from the family will decide to watch a movie in HD 4k (from another physical disk)?  This means that at least 2 channels should go to the server. </p><br><p>  After analyzing the market, it became clear that we should take <a href="http://www.mikrotik.com/">MikroTik</a> .  The choice fell on the <a href="https://routerboard.com/CRS109-8G-1S-2HnD-IN">CRS109-8G-1S-2HnD</a> - eight gigabit ports and an incredible configuration capability. </p><br><h3 id="nepreryvnost-dostupa">  Continuity of access </h3><br><p>  I was very frustrated when the inaccessibility of the network through the fault of the provider (Hello, Beeline!) Made it impossible for me to work.  (Well, yes, there is still a mobile Internet, but this is not even a comfortable job at all, especially since he doesn‚Äôt catch anything here and also needs a separate solution in the form of an external antenna.) </p><br><p><img src="https://habrastorage.org/files/b71/c1a/ac4/b71c1aac41df49c6977ddc92e15769e1.png" alt="image"></p><br><p>  Two providers work at our entrance - Beeline and Rostelecom.  At first it was necessary to set them up separately, from which I started. </p><br><p>  Oh, these dancing Beeline connections on microtic routers!  I managed to connect with a tambourine and dances, but I ate a lot of time and nerves.  Plus, a manual tune-up is sometimes required, since  I didn‚Äôt like the solution with the constantly running script on the router at all.  Beeline at the entrance, by the way, also distributes everything from the microtic, which was doubly surprising. </p><br><p>  And Rostelecom is pulling the fiber to the apartment (Pitchfork this marketer!), So you can't do without an additional router.  Well, the router is not connected with the microtic at all, since, in fact, it‚Äôs just a network. </p><br><p>  At Beeline for an additional fee was purchased (a long time ago) external IP, which I always used as one of the authorization tools and for access to internal resources. </p><br><p>  But in order for it all to work together and at the same time, it was necessary to tighten the knowledge of networks and packages.  For more or less simple settings and understanding of what is happening, I advise you to familiarize yourself with the presentation <a href="http://mum.mikrotik.com/presentations/US12/tomas.pdf">Bandwidth-based load-balancing with failover.</a>  <a href="http://mum.mikrotik.com/presentations/US12/tomas.pdf">The easy way.</a> </p><br><h3 id="publichnyy-dostup-k-vnutrennim-resursam">  Public access to internal resources </h3><br><p>  On the server there will be some resources available from the external network.  How to achieve this?  As mentioned above, I have an external IP.  The external IP is referenced by a generic subdomain of the form * .home.domain </p><br><p>  There are several options to settle: <a href="https://en.wikipedia.org/wiki/OSI_model">layer 7</a> or port. </p><br><p>  Initially, I set it up using layer 7 on the router, checking what was behind the asterisk and directing it to the right place, but it quickly became clear that such use very heavily loads the router's processor.  Given the fact that the resources will be used only by a small circle of people, it was decided to use cheaper port addressing. </p><br><p><img src="https://habrastorage.org/files/5a5/71f/0ae/5a571f0ae41c4339be7ff6954fc9133d.png" alt="image"></p><br><p>  We set the rule in the firewall, allowing connection to certain ports on the external IP, add the rule to the <abbr title="Network Address Translation - &quot;Network Address Translation&quot;">NAT</abbr> -connection with the internal ip and port ... It works!  (By the way, when working with two connections, it is necessary that the answer goes through the same provider to which the request came. This is called sticky connections and described in the same presentation.) </p><br><h3 id="polnyy-dostup">  Full access </h3><br><p>  Suppose we are leaving for some time in another country.  How to get full access, as if I'm inside the network?  Of course, you need a <abbr title="Virtual Private Network - Virtual Private Network">VPN</abbr> . </p><br><p>  On the router, we start the VPN server, add it to the <abbr title="Network device designed to integrate data network segments into a single network">bridge</abbr> , create a user ‚Äî that's it.  A connection is created without any additional software. </p><br><p><img src="https://habrastorage.org/files/87e/2fe/541/87e2fe54142340ca8d04daf009bf43ea.png" alt="image"></p><br><br><h2 id="strategiya-rezervnogo-kopirovaniya-i-arhivacii">  Backup and backup strategy </h2><br><p>  Let's start by dividing the value of stored information.  We distinguish three gradations: </p><br><p> 1)    (, ). <br> 2) ,    (). <br> 3) ,   ( ,  ). </p><br><p>    4      :    (media),  (photo),   (work),  (backup). </p><br><p>  : </p><br><p>       work    media. <br>       backup   . </p><br><p>   photo    ,   backup     50%.            jpg   .       ,     . </p><br><p>    media    , ..     . </p><br><p>  : </p><br><p>  <a href="https://ru.wikipedia.org/wiki/FreeBSD_Jail">jail</a> ,   read-only    backup.      <a href="https://aws.amazon.com/ru/glacier/">Amazon Glaicer</a>    work   ,     jpg'    . </p><br><p>  : </p><br><p>          ,            .     ‚Äî  .  Those.        . ,   ,      . </p><br><p>    ?    ,   .     5 : , ,    . </p><br><p>       , ..   ,   . </p><br><br><h2 id="svoy-dropbox">  dropbox </h2><br><p>   ,             .  ,    ‚Äî      . <a href="http://owncloud.com/">Owncloud</a> ‚Äî  . </p><br><p><img src="https://habrastorage.org/files/98b/80b/5f8/98b80b5f8b444832b598e4fdb29c13d9.png" alt="image"></p><br><p>  jail    .   jail         -.    owncloud   . </p><br><p>       .  .     . </p><br><br><h2 id="virtualnye-mashiny">  Virtual machines </h2><br><p>      ,  ,  . </p><br><p> <a href="https://www.virtualbox.org/">Virtualbox</a> ‚Äî       .      , ..    jail <a href="https://sourceforge.net/projects/phpvirtualbox/">phpvirtualbox</a>    FreeNAS. </p><br><p>      virtualbox ,          freenas,      ,   . </p><br><p>   ,       ,      ,    .   <a href="https://git-scm.com/">git</a> , nodejs  ,     .  , ,  .  All OK?  ,   ‚Äî     ,             . </p><br><p>      <a href="https://www.docker.com/">Docker</a> ,    -        .     ,   ,      : ¬´   Docker,   ‚Äî  ¬ª,          ,      ,       .  ‚Äî        ,     -     ,           1  :-) </p><br><br><h2 id="jira--confluence--bitbucket--bamboo"> Jira ‚Äî Confluence ‚Äî Bitbucket ‚Äî Bamboo </h2><br><p>         <a href="https://realtimeboard.com/">RealtimeBoard</a> ,     .        . </p><br><p>     <a href="https://gitlab.com/">GitLab</a> ,      .  -   ,                 . </p><br><p>   ,  Jira     -   ,              .      ,     10       10$.     60$     . </p><br><h3 id="jirahttpsruatlassiancomsoftwarejira"> <a href="https://ru.atlassian.com/software/jira">Jira</a> </h3><br><p>      ,          ‚Äî ¬´¬ª. <br>            20 . </p><br><p>  ‚Äî     ¬´ ¬ª.    , , ¬´¬ª: </p><br><p><img src="https://habrastorage.org/files/378/604/bd0/378604bd006940ac8879725f0c5807aa.png" alt="image"></p><br><p> 1)  -,   ¬´¬ª. <br> 2)  6  : ,  ,  ,  ,     (        ), . <br> 3)      : ,  , . <br> 4)     .   :   (,    ), , , , , post-.    10 . <br> 5)     :        ,     ,       ,     ‚Äî     (,     ). <br> 6)     ,        (,   ). <br> 7)    . , ¬´  dev¬ª     bitbucket,  ,        ,   dev.     ¬´ ¬ª   pull request'  bitbucket'     . <br> 8)    ‚Äî ¬´¬ª. <br> 9)   ¬´¬ª     . <br> 10)   -, , ¬´ ¬ª. <br> 11) - ¬´¬ª    -      ¬´¬ª. <br> 12)‚Ä¶ <br> 13) ??? <br> 999) Profit! </p><br><p>     .      :-)  ,  ,  .   ,     . </p><br><h3 id="confluencehttpsruatlassiancomsoftwareconfluence"> <a href="https://ru.atlassian.com/software/confluence">Confluence</a> </h3><br><p>     . ,         Jira,      . </p><br><p>       ,   Jira.           . ,     Jira           .  Conveniently! </p><br><p><img src="https://habrastorage.org/files/c5f/536/250/c5f5362503f249c392b82b2bd7adfa8a.png" alt="image"></p><br><p>      . </p><br><h3 id="bitbucket">  Bitbucket </h3><br><p> Git ,       . <br> ,   Jira,    . <br>  protected  master  dev.  force  ,       1  .       .  ,    . </p><br><p><img src="https://habrastorage.org/files/b26/5cf/bfe/b265cfbfe3e54800b1b381254befa09d.png" alt="image"></p><br><h3 id="bamboo"> Bamboo </h3><br><p>  <a href="https://about.gitlab.com/gitlab-ci/">Gitlab CI</a>     ,     Jira ‚Äî     . </p><br><p>  ,   , , ,  ,      . </p><br><p> ,                  1 ,        . </p><br><p>   :       ,    dev     stage     ,    master    , , ,   ,        .  :) </p><br><h3 id="integraciya-so-slackhttpslackcom">   <a href="http://slack.com/">Slack</a> </h3><br><p>     Slack     , ..            . </p><br><p>         . ,       ,    ‚Äî   .    ,    .  ,    ‚Üí   .  Conveniently.   ?     . </p><br><p><img src="https://habrastorage.org/files/60f/f28/4fa/60ff284fa36e4b2c846aff2777780821.png" alt="image"></p><br><p>  ,       ,            - . </p><br><br><h1 id="chto-v-itoge">  What is the result? </h1><br><p>     , ..          ,    -   ,          . </p><br><p>      .      .  ,      ,     . <br>        ,      . </p><br><p>      (, , , ),   ,       .          .    ,     ,      . </p><br><p>          ‚Äî     . </p><br><br><h1 id="a-chto-tam-s-igroy">     ? </h1><br><p> And the game is still in the open beta stage, and the gameplay itself is still far from the current plans, but we are moving towards it.  We really like what comes out.  We hope that the players too :) Now there is an active redesign, which is why some screens have gone a bit, but others are much better than what was before. </p><br><p><img src="https://habrastorage.org/files/e13/ba1/f51/e13ba1f51ea94b42b8ccfa38186114bf.png" alt="image"></p><br><p>  Honestly, I thought it would be a very small review article, and it came out like this. </p><br><p>  I repeat - absolutely every point is worthy of an article (or even a cycle) of a similar volume. </p><br><p>  As soon as there is time and a suitable mood, I will draw everything up.  I apologize for some inaccuracies - many things were written from memory, and much time has passed.  By preparing detailed articles there will already be accuracy :) </p><br><p>  Well, if you have read to the end, then you - well done.  <abbr title="This is the secret promotional code in the game.">Thanks for that</abbr> . </p></div><p>Source: <a href="https://habr.com/ru/post/319582/">https://habr.com/ru/post/319582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319570/index.html">Year without a single byte</a></li>
<li><a href="../319572/index.html">Data center infrastructure in 2016: original trends that will continue in 2017</a></li>
<li><a href="../319574/index.html">How to make money on augmented and virtual reality</a></li>
<li><a href="../319578/index.html">The digest of fresh materials from the world of the frontend for the last week No. 245 (January 9 - 15, 2017)</a></li>
<li><a href="../319580/index.html">PHP Digest number 100 - interesting news, materials and tools (January 1 - 15, 2017)</a></li>
<li><a href="../319584/index.html">7 email marketing trends for 2017</a></li>
<li><a href="../319586/index.html">VulnHub: USV 2016. CTF in Romania, what are they?</a></li>
<li><a href="../319588/index.html">Power supply without interruption</a></li>
<li><a href="../319590/index.html">HPE Synergy, real life experience</a></li>
<li><a href="../319592/index.html">Animations in iOS for beginners. Models, classes from Core Animation, blocks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>