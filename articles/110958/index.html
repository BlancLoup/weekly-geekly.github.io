<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nginx caching for anonymous users on the example of Drupal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, Drupal is an example of an extremely heavy CMS / CMF, and it is not so easy to build loaded sites on it. Since my company mainly uses Dru...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nginx caching for anonymous users on the example of Drupal</h1><div class="post__text post__text-html js-mediator-article">  As you know, Drupal is an example of an extremely heavy CMS / CMF, and it is not so easy to build loaded sites on it.  Since my company mainly uses Drupal in its development, we sometimes have to deal with performance optimization, and I would like to talk about how we cope with the load. <br><br>  In this article, I will look at one of the most effective methods to improve performance ‚Äî web caching of nginx content for anonymous users.  Thanks to this technique, requests from anonymous users do not call backend (no matter which one - apache or fastcgi).  Thus, such caching is more effective than any means of CMS. <br><a name="habracut"></a><br><br><h4>  Formulation of the problem </h4><br>  Drupal has built-in caching for anonymous users.  However, it works extremely inefficient and brings rather more problems with high attendance.  Therefore, it is reasonable to apply at least 2 measures: <br>  1. Cache content for anonymous users using nginx <br>  2. Store the cache_form and cache_filter tables in Cacherouter + APC 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Drupal </h4><br>  In order to separate anonymous users from logged in users, we will issue a cookie when logging in, and during logout - select it.  Let's write a small nginxcache module: <br><br>  nginxcache.info <br> <code>name = Nginx cache <br> description = Nginx cache for anonymous users <br> package = ISFB <br> version = VERSION <br> core = 6.x</code> <br> <br>  nginxcache.module <br> <code>&lt;?php <br> function nginxcache_user($type, &amp;$edit, &amp;$user) { <br> switch($type){ <br> case 'login' : <br> setcookie('logged', TRUE, time()+60*60*24*30, "/"); <br> break; <br> case 'logout': <br> setcookie('logged', FALSE); <br> break; <br> } <br> }</code> <br> <br>  We clear the sessions table, the cache and turn on the module. <br><br><h4>  nginx </h4><br>  I will not give the whole config, I will describe only what is relevant to the article. <br><br>  In the http section, we need to declare the zone: <br> <code>proxy_cache_path /var/nginx/cache levels=1:2 keys_zone=hrportal:10m inactive=60m;</code> <br> <br>  You must first take care of creating the / var / nginx / cache directory with the necessary permissions.  If the cache data is not accessed for inactive time, it is deleted regardless of freshness. <br><br>  In the location of the desired virtual host, we write: <br> <code>proxy_cache hrportal; <br> proxy_cache_key $host$uri?$args; <br> proxy_no_cache $cookie_logged; <br> proxy_cache_bypass $cookie_logged; <br> proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504; <br> proxy_pass_header Set-Cookie; <br> proxy_ignore_headers "Expires" "Cache-Control"; <br> proxy_cache_valid 200 301 302 304 1h;</code> <br> <br>  proxy_no_cache - the directive sets the conditions under which the response will not be stored in the cache, in our case, if the cookie is logged.  If you forget about this directive - the cache will record the answers of authorized users, who will give anonymous and other authorized users. <br>  proxy_cache_bypass - the answer will not be taken from the cache for users who have a logged cookie <br>  proxy_cache_use_stale - allows you to give an outdated cache response, if the backend is not available, it is very useful <br>  proxy_pass_header - users need to receive cookies <br>  proxy_ignore_headers - Drupal always sends these headers, we have to ignore them <br>  proxy_cache_valid - sets the caching time for responses <br><br><h4>  results </h4><br>  As you know, search engines analyze the performance of the site and do not send more users to it, which it can process.  Here is <a href="http://www.hr-portal.ru/">an example of a</a> quality site from the point of view of the PS, which lacked performance to handle traffic from the PS  As you can see from the <a href="http://www.liveinternet.ru/stat/hr-portal.ru/index.html%3Fperiod%3Dmonth">graph</a> , after the installation of this solution, the traffic began to grow. <br>  This site uses CMS Drupal and is located on our technical site on VPS. <br><br>  PS This approach is naturally applicable to any CMS. <br><br>  UPD.  Already not once heard the question, why not boost. <br>  The answer is quite complicated.  I will try to explain. <br>  To begin with, as you rightly noted, my decision is not boxed, and it should be applied when attendance is really high - and any ways to increase productivity are important. <br><br>  1. nginx-frontend can be located on a separate server from the backend - the cache will be in the same place - and be delivered much faster <br>  2. nginx in any case gives statics faster <br>  3. Drupal can stand on nginx - in this case it is necessary to redo the rewright boost - is it necessary? <br>  4. In the case of boost, the caching task is given to the backend - this can be done right on the front end. </div><p>Source: <a href="https://habr.com/ru/post/110958/">https://habr.com/ru/post/110958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110950/index.html">Geinimi: a fancy trojan for Android</a></li>
<li><a href="../110952/index.html">Please write your opinion about the idea.</a></li>
<li><a href="../110953/index.html">Kopini's New Year's Eve Report</a></li>
<li><a href="../110955/index.html">100 articles about development for Windows in Russian</a></li>
<li><a href="../110956/index.html">OpenStreetBrowser - search for cafes, ATMs, shops and much more on the free OpenStreetMap map</a></li>
<li><a href="../110959/index.html">Results of the year from the company REG.RU</a></li>
<li><a href="../110960/index.html">Asus RT-N10 and Tomato USB</a></li>
<li><a href="../110965/index.html">40th issue of Russian Full Circle Magazine</a></li>
<li><a href="../110969/index.html">Learning path: Deploying Windows to many computers (Russian materials)</a></li>
<li><a href="../110970/index.html">Citrix XenClient Testing: Work and Fun in a Virtual Environment</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>