<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Over 9000: unobvious difficulties of working with counters of social buttons (+ task)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the most popular functions of the social buttons "share" is the counter of perfect actions. A small number of likes and sherov can talk * about...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Over 9000: unobvious difficulties of working with counters of social buttons (+ task)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/6fd/6b1/f3e/6fd6b1f3e881499aa7f05f543419ce84.png"><br><br>  One of the most popular functions of the social buttons "share" is the counter of perfect actions.  A small number of likes and sherov can talk * about the "poor quality" of the material;  large numbers, on the contrary, serve as a kind of social proof and force others to share content. <br><br>  In a situation with large numbers, separate counters become relevant for each social network button icon.  However, even the simple conclusion of such a counter is not always easy to organize - from a technical and visual point of view.  <b>Simply put:</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  the counter may fall off at the most inopportune moment; </li><li>  some social services do not provide repost data in principle; </li><li>  and others are not always able to ensure the correct transmission of this information. </li></ul><br><a name="habracut"></a><br>  As developers of our own service of ready-made social buttons <a href="https://usocial.pro/">uSocial.pro,</a> we know that more than half of the users ** set up separate counters for each button.  Therefore, it was important for us to make sure that the numbers on the counters suddenly did not disappear and did not lie.  We did not find ready-made tools for solving this task, so we had to develop our own - we will tell you about it today. <br><br><h2>  1. What can go wrong with social network counters? </h2><br>  It would seem that it may be easier to show how many people shared content, liked it or added it to your favorites?  To do this, just need to analyze the list of social buttons installed on the site and send requests to each of the services, and then beautifully display the answer.  But even here a number of problems may arise, there is no simple ready-made solution. <br><br><h3>  1.1 There is simply no digit </h3><br>  First of all, there may be no counters for buttons of a certain social network at all - as decided by the social network itself.  For example, Twitter does not give data about the "share" on their buttons.  As a result, you could observe a picture with different push-button services, in which for all social buttons there are numbers, and for tweeted they are missing: <br><br><img src="https://habrastorage.org/files/73c/73a/31a/73c73a31a695445d896dea2090af8853.png"><br><br>  It looks weird. <br><br><h3>  1.2 "They fell off" </h3><br>  Social networks pride themselves on high uptime, but it is clear that the servers responsible for the operation of certain services may periodically ‚Äúfall off‚Äù.  Therefore, there may be an awkward moment when the values ‚Äã‚Äãfor several buttons may not be loaded in time.  In terms of perception - again, not good. <br><br><h3>  1.3 "My eyes" </h3><br>  So, someone got over9000 reposts in all possible tapes.  This information on the counters should be neat, understandable, and beautiful.  But if the numbers are large, they need to be reduced - and these reductions may look very strange. <br><br>  For example, the G + social network, all repost values ‚Äã‚Äãexceeding 9999, is abbreviated as&gt; 9999: <br><br><img src="https://habrastorage.org/files/0e3/1d2/a39/0e31d2a39fe34542bc72ca6d042958cf.png"><br><br>  Google‚Äôs main Russian competitor, by the way, is also not always sinless in such situations.  For example, he can cut 496 letters to 99+.  The meaning of this is not clear: the information is incorrect, and the same three characters are used to display it. <br><br><img src="https://habrastorage.org/files/cfa/7a3/997/cfa7a39970b447e396fd78283e01be59.png"><br><br><h2>  2. How we solved these problems. </h2><br>  Almost in no case did we manage to find the ‚Äúmagic pill‚Äù in other scripts and designs.  I had to work by myself.  They decided to start with the main thing - the lack of data on the number of rassharivaniy for some popular social networks. <br><br><h3>  2.1 Shares for Twitter and LJ, which were not there before </h3><br>  If a certain resource does not store statistics on the shares, or does not provide data to it through the API (as LiveJournal), then we store such information in ourselves. <br><br>  MySQL is used for this with a shared table that stores the hash of the URL and the number of shareings on Twitter and LiveJournal.  Under all conditions of work, this number is simply increased by one (incremented). <br><br>  In addition, the database has separate tables for each social network, which stores the correspondence between the URL hash and the users who share content.  In order to optimize performance and in order not to carry out additional checks, these tables contain a unique index for two columns - the URL hash and user ID.  This allows, among other things, to protect against cheaters cheers one and the same user. <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      try { $shareInsert = $share-&gt;insert([ 'url' =&gt; $urlHash, 'usocial_user' =&gt; isset($content-&gt;usocialUser) ? $content-&gt;usocialUser : "" ]); } catch (QueryException $e) { //   ,  ,    url  usocial_user  , ..   //        . if ($e-&gt;getCode() !== '23000') { throw $e; } } //     if (isset($shareInsert) &amp;&amp; $shareInsert) { $curUrlShares = SharesCount::where('url', '=', $urlMd5); //   URL   ,   if ($curUrlShares-&gt;count() === 0) { DB::table('shares_count')-&gt;insert([ 'url' =&gt; $urlHash, 'url_original' =&gt; $url, $content-&gt;provider =&gt; 1 ]); } //   URL  ,    else { $curUrlShares-&gt;increment($content-&gt;provider); } }</span></span></code> </pre> <br><br>  In uSocial, users themselves create a set of ‚ÄúLike‚Äù and ‚ÄúShare‚Äù buttons for their sites, some of which may not include the Twitter and LiveJournal buttons in the set.  In this case, we load the information only on the necessary social networks. <br><br>  And to increase the download speed, when viewing a bar with buttons on the site, we display information from the cache, and not from the database - this has a very positive effect on speed. <br><br><h3>  2.2 What to do if nothing can be done </h3><br>  But rassharivaniya in Twi and LJ turned out to be seeds in comparison with Pocket.  Its developers give data only when installing their widget on the site.  At the same time, attention (!) Is given to the frame, in which quality even its creators are not sure.  Here is their own description: <br><br><pre>  &lt;! - 
		 Please do not scrape this for the Pocket count. 
		 It is not a change. 
		 Contact us at api@getpocket.com for an official API. 
		 Thanks! 
		 -&gt; </pre><br><br>  We began to negotiate access to the API - but the guys from that side after each answer disappeared for a month.  What to do? <br><br>  They found out that the Japanese developer-enthusiast under the nickname ktty1220 <a href="https://github.com/ktty1220/ktty1220.github.io/tree/master/jquery.popn-socialbutton">implemented the method of</a> receiving data from Pocket via Yahoo Query - it really works, but its reliability under severe load is not yet clear.  So we still have Pocket only in the ‚ÄúLike‚Äù button sets: <br><br><img src="https://habrastorage.org/files/fa1/031/4e3/fa10314e3cdd4f63b9359d735277709a.png"><br><br>  And we still will solve a problem with rassharivaniye.  The Pocket guys got in touch again in August. <br><br><h3>  2.3 Everyone has 0, and Facebook has 100,500 ... </h3><br><br>  Mapping problems may arise in more popular and familiar social services.  For example, you may encounter a Facebook cache error. <br><br><img src="https://habrastorage.org/files/98e/6d7/1f7/98e6d71f72d14860823122c58ea14b26.png"><br><br>  The page was shared 0 times, and all the counters show this, except Facebook, which cached the value from the main page. <br><br>  Where does 20 come from?  It turned out that the site administrator visited a page with social network buttons that was closed to guests, a request went to Facebook, but the social network did not receive an answer about the accessibility of the page and recorded the number of reposts from the home page of the site (via redirect) to the cache. <br><br>  Subsequently, this cache is not updated for a very long time - and only self-resetting the cache through the Facebook debugger helps here.  A similar problem can occur with VK.  To make it easier for users to debug, we finally released a <a href="https://usocial.pro/debug">debugger</a> for two social networks at once. <br><br><h3>  2.4 Fighting fallen social networks </h3><br>  Since the indicators of most of the meters do not depend on our actions in any way, but are formed using the answers from social networks, we load all the counters asynchronously.  By the way, from <a href="http://help.feedbin.com/sharing-read-it-later-services/">this link,</a> you can view request formats for getting sherov of most popular social networks. <br><br>  At the same time, if we do not receive a response from the server - what happens when the same ‚ÄúVkontakte‚Äù and ‚ÄúMy World‚Äù drops, then 0 will be given as the value, and while waiting for the answer, the user will see the counter pre-decoder. <br><br><img src="https://habrastorage.org/files/a0c/3cd/f8e/a0c3cdf8eeb94d6aaa60c9b1ad5473a3.png"><br><br><h3>  2.5 Solving the problem of the counting curve and the design of native counters </h3><br>  As is clear from the example of G +, standard social services solutions are far from always appealing and simply understandable to users.  To bring the appearance of the counters to a single standard, we started optimizing the display of abbreviations. <br><br>  When a lot of people share material and the figure on the meter can go off-scale for over9000, it‚Äôs better to reduce it for beauty. <br><br>  Here is how we do it externally: <br><br><img src="https://habrastorage.org/files/643/6c5/7fa/6436c57fa56a49f1a96c7cc7456ea026.png"><br><br>  <b>And so - technically</b> .  First, we check if there is a common counter at all.  If it exists, the responses <code>arrSocCounter[id][iconName]</code> from social networks are recorded in a dynamically created object <code>arrSocCounter[id][iconName]</code> , where <code>arrSocCounter</code> is an object, and id is the URL of the page we charm, <code>iconName</code> is the name of the social network (it is the name of the icon). <br><br>  With the help of the <code>data-url</code> parameter, the required set is obtained, and by the <code>data-item</code> we will find out which social networks still remain.  Then the cycle goes through the social <code>arrSocCounter[dataUrl][dataItem]</code> icons and summarizes the necessary values ‚Äã‚Äãfrom the previously obtained <code>arrSocCounter[dataUrl][dataItem]</code> . <br><br>  And here we come to circumcising large numbers.  Before you add the result to the counter, you must translate it into a format understandable to the system ‚Äî serialize it.  Then we count the number of elements in a row to see if we are dealing with a million, a thousand or ten sherahs.  It does not make sense to check whether an integer or decimal number came in response in this case (20.5 people cannot share the article), so you can immediately proceed to counting characters in the string. <br><br>  If the number is in the range of 4 to 6 characters, inclusive, then the value is converted to a floating point and rounded to decimal: <code>parseFloat(value / 1000).toFixed(1)</code> .  In principle, this could be stopped, but then the value would be inaccurate - it does not suit us, so we convert the value to a string and cut off the last two characters, for example 1001: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> val; val = <span class="hljs-built_in"><span class="hljs-built_in">parseFloat</span></span>(<span class="hljs-number"><span class="hljs-number">1001</span></span> / <span class="hljs-number"><span class="hljs-number">1000</span></span>).toFixed(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(val)</code> </pre><br><br>  After performing these steps, we get a floating point number 1.0.  Then it should be ‚Äúovertaken‚Äù back to the line and cut off the last two characters, adding the letter ‚ÄúK‚Äù to the final result: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> valOutput; valOutput = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>(val).slice(val.lenght, <span class="hljs-number"><span class="hljs-number">-2</span></span>) + <span class="hljs-string"><span class="hljs-string">'k'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(valOutput); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> val,valOutput; val = <span class="hljs-built_in"><span class="hljs-built_in">parseFloat</span></span>(<span class="hljs-number"><span class="hljs-number">1001</span></span> / <span class="hljs-number"><span class="hljs-number">1000</span></span>).toFixed(<span class="hljs-number"><span class="hljs-number">1</span></span>); valOutput = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>(val).slice(val.lenght, <span class="hljs-number"><span class="hljs-number">-2</span></span>) + <span class="hljs-string"><span class="hljs-string">'k'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(valOutput);</code> </pre><br><h3>  Conclusion and unsolved problem </h3><br>  Even such a not very difficult at first glance task, like creating a high-quality service of social buttons, is associated with certain difficulties.  And there is a problem that we could not solve beautifully. <br><br><h5>  http = / = https </h5><br>  An interesting and non-obvious point is that social networks and their API often perceive the number of sherov for sites with http and https differently.  That is, they consider that there are two different sites in front of them - and if earlier the resource owner switched over to https, he had to mentally prepare for the number of shareings on all his past materials. <br><br>  So far we have found a way out: add a data-url = " <a href="http://site.com/">site.com</a> " and pass the URL parameter without http - if you <a href="http://site.com/">really</a> want to save the indicators. <br><br>  But perhaps the community has ideas for a more beautiful solution. <br><br><h4>  *** </h4><br><br>  That's all, thank you for your attention, and we will be happy to answer questions and discuss the problem http / https comments.  And next time we'll talk about one more hitch - working with sharing buttons for messengers and other interesting buttons like ‚Äúbookmarks‚Äù. <br><br>  * <a href="https://www.nngroup.com/articles/social-proof-ux/">Nielsen</a> 's <a href="https://www.nngroup.com/articles/social-proof-ux/">research</a> on the role of likes and shera on perception of articles. <br><br>  ** <a href="http://www.cossa.ru/149/134152/">Statistics</a> on the installation of share sets with individual counters for each icon. </div><p>Source: <a href="https://habr.com/ru/post/308504/">https://habr.com/ru/post/308504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308488/index.html">Using trigrams for correcting recognition results</a></li>
<li><a href="../308490/index.html">Unexpected behavior of the WinAPI function IsWow64Process ()</a></li>
<li><a href="../308494/index.html">How to give an adequate estimate of the time when uncertainty hits the head</a></li>
<li><a href="../308498/index.html">Air Berlin: Progressive Web App Implementation</a></li>
<li><a href="../308500/index.html">Navigator 2GIS: Extrapolation of the position of the car</a></li>
<li><a href="../308506/index.html">Building complex SCADA (bad example)</a></li>
<li><a href="../308508/index.html">Modern art on the screen of a hardware company engineer</a></li>
<li><a href="../308510/index.html">Microsoft offers free Windows Server 2016 Datacenter licenses for customers who refuse VMware</a></li>
<li><a href="../308512/index.html">Attackers use Twitter to manage malware for Android</a></li>
<li><a href="../308514/index.html">How to find out what kind of flowers to give to a girl, if only her head moves and she cannot speak?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>