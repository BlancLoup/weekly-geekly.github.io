<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Erlang for web development (2) -> DB and deploy;</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first article, we met Erlang and the n2o framework. In this part we will continue to do our blog: 


- we will add authorization through facebo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Erlang for web development (2) -> DB and deploy;</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ab9/08a/eb3/ab908aeb3c9c4422ab0de8abe4b4a361.png" align="right"><br>  In the <a href="http://habrahabr.ru/post/273979/">first article,</a> we met Erlang and the n2o framework.  In this part we will continue to do our blog: <br><ul><li>  we will add authorization through facebook, for this we will call functions on the server from the client; </li><li>  We will save comments and posts in the NoSQL database; </li><li>  Let's deploy our blog on DigitalOcean and measure performance ( <i>spoiler - 1300 requests per second</i> ). </li></ul><br><br>  The code from the articles <a href="https://github.com/denys-potapov/n2o-blog-example">https://github.com/denys-potapov/n2o-blog-example</a> , the finished project can be viewed at <a href="http://46.101.118.21:8001/">http://46.101.118.21:8001/</a> . <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Configuration files </h2><br>  For authorization, we need to store facebook_app_id somewhere, in Erlang applications, the configuration is stored in sys.config, we will add our facebook_app_id there <br><pre><code class="erlang hljs">[{n2o, [ {port,<span class="hljs-number"><span class="hljs-number">8001</span></span>}, {route,routes}, {log_modules,sample} ]}, {sample, [ {facebook_app_id, <span class="hljs-string"><span class="hljs-string">"631083680327759"</span></span>} ]} ].</code> </pre> <br>  Now we can get with the value in application: get_env (sample, facebook_app_id, "") <br><br><h2>  Calling the server code </h2><br>  For authorization via social networks in n2o projects there is an <a href="https://github.com/synrc/avz">avz</a> library that supports Twitter, Google, Facebook, Github and Microsoft authorization.  But, avz requires a certain scheme in the database, which we do not yet have, and therefore we release the authorization ourselves. <br><br>  The <b>wf: wire</b> function <b>(#api {name = login})</b> allows you to bind a call to the login function on the client to an event <br>  api_event (login, Response, Term) on the server. <br><br>  Add a login.erl file: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(login)</span></span>. -compile(export_all). -include_lib(<span class="hljs-string"><span class="hljs-string">"n2o/include/wf.hrl"</span></span>). -include_lib(<span class="hljs-string"><span class="hljs-string">"nitro/include/nitro.hrl"</span></span>). -include_lib(<span class="hljs-string"><span class="hljs-string">"records.hrl"</span></span>). main() -&gt; wf:wire(#api{name=login}), #dtl{file=<span class="hljs-string"><span class="hljs-string">"login"</span></span>, bindings=[{app_id, application:get_env(sample, facebook_app_id, <span class="hljs-string"><span class="hljs-string">""</span></span>)}]}. api_event(login, Response, Term) -&gt; {Props} = jsone:decode(list_to_binary(Response)), User = binary_to_list(proplists:get_value(&lt;&lt;<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;&gt;, Props)), wf:user(User), wf:redirect(<span class="hljs-string"><span class="hljs-string">"/"</span></span>).</code> </pre><br><br>  In the main / 0 function, we declare a login event, which we then handle in api_event.  We decode the json string, authorize the user and direct it to the main page.  In priv / templates / login.html code that is copied from the sample to facebook, in which the main magic in the <b>login</b> call <b>(response)</b> . <br><div class="spoiler">  <b class="spoiler_title">priv / templates / login.html</b> <div class="spoiler_text"><pre> <code class="html hljs xml">{% extends "base.html" %} {% block title %}Login{% endblock %} {% block content %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"status"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"login"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onLoginClick();"</span></span></span><span class="hljs-tag">&gt;</span></span> Login with facebook <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml"> // This is called with the results from from FB.getLoginStatus(). function statusChangeCallback(response) { console.log('statusChangeCallback'); if (response.status === 'connected') { // Logged into your app and Facebook. FB.api('/me', function(response) { login(response); }); } else if (response.status === 'not_authorized') { document.getElementById('status').innerHTML = 'Please log ' + 'into this app.'; } else { document.getElementById('status').innerHTML = 'Please log ' + 'into Facebook.'; } } window.fbAsyncInit = function() { FB.init({ appId : '{{ app_id }}', cookie : true, version : 'v2.2' // use version 2.2 }); FB.getLoginStatus(function(response) { statusChangeCallback(response); }); }; // Load the SDK asynchronously (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/sdk.js"; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk')); function onLoginClick() { FB.login(function(response) { statusChangeCallback(response); }, {scope: 'public_profile,email'});</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">source</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"html"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {% extends "base.html" %} {% block title %}Login{% endblock %} {% block content %} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Login</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"status"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"login"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"onLoginClick();"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> Login with facebook </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="actionscript"><span class="xml"><span class="actionscript"> </span></span><span class="hljs-comment"><span class="xml"><span class="actionscript"><span class="hljs-comment">// This is called with the results from from FB.getLoginStatus(). function statusChangeCallback(response) { console.log('statusChangeCallback'); if (response.status === 'connected') { // Logged into your app and Facebook. FB.api('/me', function(response) { login(response); }); } else if (response.status === 'not_authorized') { document.getElementById('status').innerHTML = 'Please log ' + 'into this app.'; } else { document.getElementById('status').innerHTML = 'Please log ' + 'into Facebook.'; } } window.fbAsyncInit = function() { FB.init({ appId : '{{ app_id }}', cookie : true, version : 'v2.2' // use version 2.2 }); FB.getLoginStatus(function(response) { statusChangeCallback(response); }); }; // Load the SDK asynchronously (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/sdk.js"; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk')); function onLoginClick() { FB.login(function(response) { statusChangeCallback(response); }, {scope: 'public_profile,email'}); }; </span></span></span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> {% endblock %}</code> </pre><br></div></div><br><br><h2>  Component Update on Client </h2><br>  Now we will try to update the component from the server on the client.  To do this, we will make a header on the main (index.erl), on which there will be an exit button.  The header will be updated after the session data has been cleared: <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buttons</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> wf:user() <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> undefined -&gt; #li{body=#link{body = <span class="hljs-string"><span class="hljs-string">"Login"</span></span>, url=<span class="hljs-string"><span class="hljs-string">"/login"</span></span>}}; _ -&gt; [ #p{class=[<span class="hljs-string"><span class="hljs-string">"navbar-text"</span></span>], body=<span class="hljs-string"><span class="hljs-string">"Hello, "</span></span> ++ wf:user()}, #li{body=#link{body = <span class="hljs-string"><span class="hljs-string">"New post"</span></span>, url=<span class="hljs-string"><span class="hljs-string">"/new"</span></span>}}, #li{body=#link{body = <span class="hljs-string"><span class="hljs-string">"Logout"</span></span>, postback=logout}} ] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. header() -&gt; #ul{id=header, class=[<span class="hljs-string"><span class="hljs-string">"nav"</span></span>, <span class="hljs-string"><span class="hljs-string">"navbar-nav"</span></span>, <span class="hljs-string"><span class="hljs-string">"navbar-right"</span></span>], body = buttons()}. main() -&gt; #dtl{file=<span class="hljs-string"><span class="hljs-string">"index"</span></span>, bindings=[{posts, posts()}, {header, header()}]}. event(logout) -&gt; wf:user(undefined), wf:update(header, header()).</code> </pre><br><br>  In the event (logout) event, we clear the session data and update the component. <br><br><h2>  Database and dependencies </h2><br><br>  To access the database, we will use <a href="https://github.com/synrc/kvs">kvs</a> .  kvs allows you to store linked lists and supports different backends (Mnesia, Riak, KAI, Redis, MongoDB).  Further in the example I will use <a href="http://learnyousomeerlang.com/mnesia">mnesia</a> , because it comes in the package and does not need to be customized. <br><br>  The dependencies in the Erlang projects are in the rebar.config file, we add kvs there: <br><pre> <code class="erlang hljs">{kvs, <span class="hljs-string"><span class="hljs-string">".*"</span></span>, {git, <span class="hljs-string"><span class="hljs-string">"git://github.com/synrc/kvs"</span></span>, {tag, <span class="hljs-string"><span class="hljs-string">"2.9"</span></span>} }}</code> </pre><br><br>  In sys.config, we indicate which backend and which scheme we use.  The scheme is needed only for mnesia, for other backends it is not needed. <br><pre> <code class="erlang hljs">{kvs, {dba,store_mnesia}, {schema,[sample]} ]}</code> </pre><br><br>  The schema is described by the metainfo / 0 function in sample.erl: <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">metainfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> #schema{name=sample,tables=[ #table{name=id_seq,fields=record_info(fields,id_seq),keys=[thing]}, #table{name=post,fields=record_info(fields,post)} ]}.</code> </pre><br>  We indicate that we have two tables: post, which contains entries of type post, and id_seq, in which kvs stores autoincrement values. <br><br>  Right there in sample.erl in the init / 1 function we add a connection to kvs. <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([])</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> cowboy:start_http(http,<span class="hljs-number"><span class="hljs-number">3</span></span>,port(),env()) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> {ok, _} -&gt; ok; {error,_} -&gt; halt(abort,[]) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, sup(), kvs:join().</code> </pre><br><br>  Now if we restart the applications, we should see our tables. <br><pre> <code class="erlang_repl hljs erlang-repl"><span class="hljs-meta"><span class="hljs-meta">2&gt; </span></span>kvs:dir(). [{table,post},{table,id_seq},{table,schema}]</code> </pre><br><br><h2>  Read and write </h2><br>  In the /src/new.erl module, we will have one event (post) event, which writes the post to the database with the kvs: put / 1 function: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(new)</span></span>. -compile(export_all). -include_lib(<span class="hljs-string"><span class="hljs-string">"n2o/include/wf.hrl"</span></span>). -include_lib(<span class="hljs-string"><span class="hljs-string">"nitro/include/nitro.hrl"</span></span>). -include_lib(<span class="hljs-string"><span class="hljs-string">"records.hrl"</span></span>). main() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> wf:user() <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> undefined -&gt; wf:header(&lt;&lt;<span class="hljs-string"><span class="hljs-string">"Location"</span></span>&gt;&gt;, wf:to_binary(<span class="hljs-string"><span class="hljs-string">"/login"</span></span>)), wf:state(status,<span class="hljs-number"><span class="hljs-number">302</span></span>), []; _ -&gt; #dtl{file=<span class="hljs-string"><span class="hljs-string">"new"</span></span>, bindings=[{button, #button{id=send, class=[<span class="hljs-string"><span class="hljs-string">"btn"</span></span>, <span class="hljs-string"><span class="hljs-string">"btn-primary"</span></span>], body=<span class="hljs-string"><span class="hljs-string">"Add post"</span></span>,postback=post,source=[title,text]} }]} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. event(post) -&gt; Id = kvs:next_id(<span class="hljs-string"><span class="hljs-string">"post"</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), Post = #post{id=Id,author=wf:user(),title=wf:q(title),text=wf:q(text)}, kvs:put(Post), wf:redirect(<span class="hljs-string"><span class="hljs-string">"/post?id="</span></span> ++ wf:to_list(Id)).</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">/priv/templates/new.html</b> <div class="spoiler_text"><pre> <code class="html hljs xml">{% extends "base.html" %} {% block title %}New Post{% endblock %} {% block content %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Add new post<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>Title<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"title"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-control"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>Body<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxlength</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-control"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rows</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">10</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span> {{ button }} {% endblock %}</code> </pre><br></div></div><br><br>  Now in the post.erl file we replace the function of getting the post, if the post is not found we give out a 404 error <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> kvs:get(post, post_id()) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> {ok, Post} -&gt; #dtl{file=<span class="hljs-string"><span class="hljs-string">"post"</span></span>, bindings=[ {title, wf:html_encode(Post#post.title)}, {text, wf:html_encode(Post#post.text)}, {author, wf:html_encode(Post#post.author)}, {comments, comments()}]}; _ -&gt; wf:state(status,<span class="hljs-number"><span class="hljs-number">404</span></span>), <span class="hljs-string"><span class="hljs-string">"Post not found"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre><br><br>  In the index.erl homepage module we get all posts by calling kvs: all (post): <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">posts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> [ #panel{body=[ #h2{body = #link{body = wf:html_encode(P#post.title), url = <span class="hljs-string"><span class="hljs-string">"/post?id="</span></span> ++ wf:to_list(P#post.id)}}, #p{body = wf:html_encode(P#post.text)} ]} || P &lt;- kvs:all(post)].</code> </pre><br><br><h2>  Containers and iterators </h2><br><br>  The concept of containers and iterators is used to store linked lists in kvs.  The iterator stores pointers to doubly linked lists, and the container stores pointers to the head and tail of the list. <br><br>  Update our records to records.hrl and add an iterator comment and container post: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-record</span></span><span class="hljs-params"><span class="hljs-params">(post, {?CONTAINER, title, text, author})</span></span>. -record(comment, {?ITERATOR(post), text, author}).</code> </pre><br><br>  We update the scheme: <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">metainfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> #schema{name=sample,tables=[ #table{name=id_seq,fields=record_info(fields,id_seq),keys=[thing]}, #table{name=post,container=true,fields=record_info(fields,post)}, #table{name=comment,container=post,fields=record_info(fields,comment)} ]}.</code> </pre><br><br>  Re-create the database schema: <br><pre> <code class="erlang_repl hljs erlang-repl"><span class="hljs-meta"><span class="hljs-meta">2&gt; </span></span>kvs:destroy(). ok <span class="hljs-number"><span class="hljs-number">3</span></span>&gt; kvs:join(). ok</code> </pre><br><br>  In the post.erl module, we update the comment logic: <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">comments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> wf:user() <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> undefined -&gt; #link{body = <span class="hljs-string"><span class="hljs-string">"Login to add comment"</span></span>, url=<span class="hljs-string"><span class="hljs-string">"/login"</span></span>}; _ -&gt; [ #textarea{id=comment, class=[<span class="hljs-string"><span class="hljs-string">"form-control"</span></span>], rows=<span class="hljs-number"><span class="hljs-number">3</span></span>}, #button{id=send, class=[<span class="hljs-string"><span class="hljs-string">"btn"</span></span>, <span class="hljs-string"><span class="hljs-string">"btn-default"</span></span>], body=<span class="hljs-string"><span class="hljs-string">"Post comment"</span></span>,postback=comment,source=[comment]} ] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. event(init) -&gt; [event({client,Comment}) || Comment &lt;- kvs:entries(kvs:get(post, post_id()),comment,undefined) ], wf:reg({post, post_id()}); event(comment) -&gt; Comment = #comment{id=kvs:next_id(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>),author=wf:user(),feed_id=post_id(),text=wf:q(comment)}, kvs:add(Comment), wf:send({post, post_id()}, {client, Comment}); event({client, Comment}) -&gt; wf:insert_bottom(comments, #blockquote{body = [ #p{body = wf:html_encode(Comment#comment.text)}, #footer{body = wf:html_encode(Comment#comment.author)} ]}).</code> </pre><br><br>  In the comments () function, we check whether the user has autologized.  In event (init) we select all comments that relate to this post and pass them on to the event ({client, Comment}) event, that is, comments are loaded after the page loads. <br><br>  In the event event (comment), we not only output a comment, but also save it to the database. <br><br><h2>  Creating your own items </h2><br>  For paginated navigation, we add our pagination element to DSL.  In the file /apps/sample/include/elements.hrl we add an entry in which we indicate which module is responsible for displaying this element: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-include_lib</span></span><span class="hljs-params"><span class="hljs-params">(</span><span class="hljs-string"><span class="hljs-params"><span class="hljs-string">"nitro/include/nitro.hrl"</span></span></span><span class="hljs-params">)</span></span>. -record(pagination, {?ELEMENT_BASE(element_pagination), active, count, url}).</code> </pre><br><br>  The output module element_pagination.erl itself is quite simple: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(element_pagination)</span></span>. -compile(export_all). -include_lib(<span class="hljs-string"><span class="hljs-string">"nitro/include/nitro.hrl"</span></span>). -include_lib(<span class="hljs-string"><span class="hljs-string">"elements.hrl"</span></span>). link(Class, Body, Url) -&gt; #li{class=[Class], body=#link{body=Body, url=Url}}. disabled(Body) -&gt; link(<span class="hljs-string"><span class="hljs-string">"disabled"</span></span>, Body, <span class="hljs-string"><span class="hljs-string">"#"</span></span>). left_arrow(#pagination{active = <span class="hljs-number"><span class="hljs-number">1</span></span>}) -&gt; disabled(<span class="hljs-string"><span class="hljs-string">"¬´"</span></span>); left_arrow(#pagination{active = Active, url = Url}) -&gt; link(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"¬´"</span></span>, Url ++ wf:to_list(Active - <span class="hljs-number"><span class="hljs-number">1</span></span>)). right_arrow(#pagination{active = Count, count = Count}) -&gt; disabled(<span class="hljs-string"><span class="hljs-string">"¬ª"</span></span>); right_arrow(#pagination{active = Active, url = Url}) -&gt; link(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"¬ª"</span></span>, Url ++ wf:to_list(Active + <span class="hljs-number"><span class="hljs-number">1</span></span>)). left(<span class="hljs-number"><span class="hljs-number">0</span></span>, P) -&gt; [left_arrow(P)]; left(I, P) -&gt; S = wf:to_list(I), left(I - <span class="hljs-number"><span class="hljs-number">1</span></span>, P) ++ [link(<span class="hljs-string"><span class="hljs-string">""</span></span>, S, P#pagination.url ++ S)]. right(I, P = #pagination{count = Count}) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> I &gt; Count -&gt; [right_arrow(P)]; right(I, P) -&gt; S = wf:to_list(I), [link(<span class="hljs-string"><span class="hljs-string">""</span></span>, S, P#pagination.url ++ S) | right(I + <span class="hljs-number"><span class="hljs-number">1</span></span>, P)]. render_element(P = #pagination{}) -&gt; wf:render(#nav{body=#ul{class=[<span class="hljs-string"><span class="hljs-string">"pagination"</span></span>], body=[ left(P#pagination.active - <span class="hljs-number"><span class="hljs-number">1</span></span>, P), link(<span class="hljs-string"><span class="hljs-string">"active"</span></span>, wf:to_list(P#pagination.active), <span class="hljs-string"><span class="hljs-string">"#"</span></span>), right(P#pagination.active + <span class="hljs-number"><span class="hljs-number">1</span></span>, P) ]}}).</code> </pre><br><br><h2>  How to do it </h2><br>  Kvs is designed to store linked lists, and therefore not well suited for page navigation. <br><br><div class="spoiler">  <b class="spoiler_title">A sharp comment by the author kvs about page navigation in the modern web</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/d3c/9fe/7c0/d3c9fe7c0bf34193b65077e02e5b4495.png"><br></div></div><br><br>  But, for the purity of the experiment, we will add page navigation.  Add a container feed, which will store posts <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-record</span></span><span class="hljs-params"><span class="hljs-params">(feed, {?CONTAINER})</span></span>. -record(post, {?ITERATOR(feed), title, text, author}). -record(comment, {?ITERATOR(feed), text, author}).</code> </pre><br>  And update the scheme: <br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">metainfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> -&gt;</span></span> #schema{name=sample,tables=[ #table{name=id_seq,fields=record_info(fields,id_seq),keys=[thing]}, #table{name=feed,container=true,fields=record_info(fields,feed)}, #table{name=post,container=feed,fields=record_info(fields,post)}, #table{name=comment,container=feed,fields=record_info(fields,comment)} ]}.</code> </pre><br>  Comments we will store in the feed container of the form {post, post_id ()}: <br><pre> <code class="erlang hljs">Comment = #comment{id=kvs:next_id(<span class="hljs-string"><span class="hljs-string">"comment"</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>),author=wf:user(),feed_id={post, post_id()},text=wf:q(comment)},</code> </pre><br>  And we will receive comments from this container: <br><pre> <code class="erlang hljs">[event({client,Comment}) || Comment &lt;- kvs:entries(kvs:get(feed, {post, post_id()}),comment,undefined) ];</code> </pre><br><br>  Limit the pagination on the main page.  Once again I note that kvs is poorly suited for page-by-page navigation, and this code is just a demonstration of how using inappropriate tools leads to code obfuscation: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-define</span></span><span class="hljs-params"><span class="hljs-params">(POST_PER_PAGE, </span><span class="hljs-number"><span class="hljs-params"><span class="hljs-number">3</span></span></span><span class="hljs-params">)</span></span>. page() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> wf:q(&lt;&lt;<span class="hljs-string"><span class="hljs-string">"page"</span></span>&gt;&gt;) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> undefined -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; Page -&gt; wf:to_integer(Page) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. pages() -&gt; Pages = kvs:count(post) <span class="hljs-keyword"><span class="hljs-keyword">div</span></span> ?POST_PER_PAGE, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> kvs:count(post) <span class="hljs-keyword"><span class="hljs-keyword">rem</span></span> ?POST_PER_PAGE <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> -&gt; Pages; _ -&gt; Pages + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. posts() -&gt; [ #panel{body=[ #h2{body = #link{body = wf:html_encode(P#post.title), url = <span class="hljs-string"><span class="hljs-string">"/post?id="</span></span> ++ wf:to_list(P#post.id)}}, #p{body = wf:html_encode(P#post.author)} ]} || P &lt;- lists:reverse(kvs:traversal(post, kvs:count(post) - (page() - <span class="hljs-number"><span class="hljs-number">1</span></span>) * ?POST_PER_PAGE, ?POST_PER_PAGE, #iterator.prev))].</code> </pre><br><br><h2>  Deploy and performance </h2><br>  Mad allows you to create a bundle - a single file in which the code and all the necessary files for the application (templates, statics) are stored.  Create and upload to a remote server: <br><pre> <code class="bash hljs">mad deps compile plan bundle sample scp sample root@46.101.117.36:/var/www/sample/</code> </pre><br>  Install Erlang on a remote server and run our application: <br><pre> <code class="bash hljs">wget https://packages.erlang-solutions.com/erlang/esl-erlang/FLAVOUR_1_general/esl-erlang_18.0-1~ubuntu~trusty_amd64.deb dpkg -i esl-erlang_18.0-1~ubuntu~trusty_amd64.deb escript sample</code> </pre><br><br>  To test performance, I created the smallest droplet on DigitalOcean (512 MB Memory / 20 GB Disk).  For the test, we will make 20 thousand requests, 50 in parallel: <br><br><pre> root @ ubuntu-1gb-fra1-01: ~ # ab -l -n 20000 -c 50 -g gnuplot.dat http://46.101.118.21:8001/
 ...
 Concurrency Level: 50
 Time taken for tests: 15.131 seconds
 Complete requests: 20000
 Failed requests: 0
 Total transferred: 78279988 bytes
 HTML transferred: 76399988 bytes
 Requests per second: 1321.80 [# / sec] (mean)
 Time per request: 37.827 [ms] (mean)
 Time per request: 0.757 [ms] (mean, across all concurrent requests)
 Transfer rate: 5052.26 [Kbytes / sec] received

 Connection Times (ms)
               min mean [+/- sd] median max
 Connect: 0 0 0.3 0 9
 Processing: 9 37 4.9 37 65
 Waiting: 9 37 4.9 37 65
 Total: 11 38 4.9 37 65

 Percentage of the requests served within a certain time (ms)
   50% 37
   66% 38
   75% 39
   80% 40
   90% 44
   95% 47
   98% 53
   99% 56
  100% 65 (longest request)
</pre><br><br>  The server processed about 1300 requests per second, 95% of requests were completed in less than 50 ms, which is very good for hosting for $ 5 per month.  Same as graphics: <br><br><img src="https://habrastorage.org/files/988/ca7/585/988ca7585026483a93066e8b832925d6.png"></div><p>Source: <a href="https://habr.com/ru/post/274107/">https://habr.com/ru/post/274107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274097/index.html">Receptions work in Blender. Part 2</a></li>
<li><a href="../274099/index.html">Who needs Go and why?</a></li>
<li><a href="../274101/index.html">The digest of interesting materials from the world of Drupal # 16</a></li>
<li><a href="../274103/index.html">Simple algebraic data types</a></li>
<li><a href="../274105/index.html">GOTPass: new passwordless user authentication system</a></li>
<li><a href="../274109/index.html">The digest of interesting materials for the mobile developer # 135 (December 21-27)</a></li>
<li><a href="../274117/index.html">The botnet of thousands of hacked Aethra routers was used to attack Wordpress sites</a></li>
<li><a href="../274129/index.html">I want sites to open instantly</a></li>
<li><a href="../274131/index.html">Monitoring Dynamic XML Documents</a></li>
<li><a href="../274135/index.html">Animator - what is it? Why is it needed? Why use it instead of Animation?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>