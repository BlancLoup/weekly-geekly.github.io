<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Firefox Download Panel Improvements</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It will focus on the features of the new download panel in Firefox and the Download Panel Tweaker extension, eliminating some of the unwanted features...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Firefox Download Panel Improvements</h1><div class="post__text post__text-html js-mediator-article">  It will focus on the features of the new download panel in Firefox and the <a href="https://addons.mozilla.org/firefox/addon/download-panel-tweaker/">Download Panel Tweaker</a> extension, eliminating some of the unwanted features. <br>  In particular, about the most controversial, in my opinion, innovation, due to which completed downloads disappear from the list (although they remain visible in the corresponding section of the ‚Äúlibrary‚Äù) - it just so happened that the improvement of time took most of this <strike>correction</strike> . <br>  The result looks like this (this is a ‚Äúcompact‚Äù version of the <a href="" title="Screenshot of settings in version 0.2.0">settings</a> , ‚Äúvery compact‚Äù will save a little more space): <br><img src="https://habrastorage.org/getpro/habr/post_images/fb3/ada/9ff/fb3ada9ff95a344c1821c7b4fca4973a.png" alt="Screenshot version 0.2.0" width="723" height="578"><br>  But how <a href="" title="Screenshot downloads in Firefox 27.0.1">it was originally</a> . <br>  There will also be quite a few examples of code (and where else without details?). <br><a name="habracut"></a><br><h1>  Instead of the preface, or long live the compactness! </h1>  For starters, all the items on the default download panel are huge!  Firstly, I do not have a touchscreen monitor - thanks, but I can get to the right place anyway.  And secondly, there are only three points, not more.  That is, the place is spent, but the benefits of something a little. <br>  In general, if the limitation of the apparent number of downloads could be configured with built-in tools, the extensions could not be, because the sizes <a href="https://github.com/Infocatcher/UserStyles/tree/master/Compact_downloads">can be easily configured</a> using <a href="http://forum.mozilla-russia.org/doku.php%3Fid%3Dfirefox:tips:userchrome.css">userChrome.css</a> or the <a href="https://addons.mozilla.org/addon/stylish/">Stylish</a> extension. <br>  In addition, styles alone cannot <abbr title="Or I was not diligent enough to research :)">(?)</abbr> Output download speeds - it is in the tooltip, but the pseudo-classes <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/::before">:: before</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/::after">:: after</a> do not always work in XUL (apparently, these are limitations of <a href="https://developer.mozilla.org/en-US/docs/XBL/XBL_1.0_Reference/Anonymous_Content">anonymous nodes</a> ), so this does not help: <br><pre><code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.downloadDetails</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[tooltiptext]</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::after</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">content</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">attr</span></span>(tooltiptext) <span class="hljs-meta"><span class="hljs-meta">!important</span></span>; }</code> </pre> <br><br><h1>  Increasing the number of visible downloads </h1>  As a result, the code responsible for the number of downloads in the panel was found quite quickly in the <em>chrome</em> file <em>: //browser/content/downloads/downloads.js</em> : <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DownloadsView = { <span class="hljs-comment"><span class="hljs-comment">////////////////////////////////////////////////////////////////////////////// //// Functions handling download items in the list /** * Maximum number of items shown by the list at any given time. */ kItemCountLimit: 3,</span></span></code> </pre><br>  But the changes will work only if they were made when the browser was started, that is, before the download panel was initialized. <br>  Therefore, further searches resulted in the <em>resource</em> file <em>: //app/modules/DownloadsCommon.jsm</em> and in the <em>DownloadCommon.getSummary ()</em> function: <br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Returns a reference to the DownloadsSummaryData singleton - creating one * in the process if one hasn't been instantiated yet. * * @param aWindow * The browser window which owns the download button. * @param aNumToExclude * The number of items on the top of the downloads list to exclude * from the summary. */</span></span> getSummary: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DC_getSummary</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">aWindow, aNumToExclude</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PrivateBrowsingUtils.isWindowPrivate(aWindow)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._privateSummary) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._privateSummary; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._privateSummary = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DownloadsSummaryData(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, aNumToExclude); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._summary) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._summary; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._summary = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DownloadsSummaryData(<span class="hljs-literal"><span class="hljs-literal">false</span></span>, aNumToExclude); } },</code> </pre><br>  And what is actually happening in the <em>DownloadsSummaryData</em> constructor: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * DownloadsSummaryData is a view for DownloadsData that produces a summary * of all downloads after a certain exclusion point aNumToExclude. For example, * if there were 5 downloads in progress, and a DownloadsSummaryData was * constructed with aNumToExclude equal to 3, then that DownloadsSummaryData * would produce a summary of the last 2 downloads. * * @param aIsPrivate * True if the browser window which owns the download button is a private * window. * @param aNumToExclude * The number of items to exclude from the summary, starting from the * top of the list. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DownloadsSummaryData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">aIsPrivate, aNumToExclude</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._numToExclude = aNumToExclude;</code> </pre><br>  Everything is simple - just do it like this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> itemCountLimit = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-comment"><span class="hljs-comment">//        3  5 if(DownloadsCommon._privateSummary) DownloadsCommon._privateSummary._numToExclude = itemCountLimit; if(DownloadsCommon._summary) DownloadsCommon._summary._numToExclude = itemCountLimit;</span></span></code> </pre><br>  That is, the limit is adjusted for already created regular and private copies of <em>DownloadsSummaryData</em> . <br>  The most difficult part is that the list of downloads in itself, in accordance with the new settings, is not overlooked. <br>  But here I had a head start: in the process of developing the <a href="https://addons.mozilla.org/addon/private-tab/">Private Tab</a> extension (by which, by the way, there was also an <a href="http://habrahabr.ru/post/175469/">article</a> ), the exact same question arose, because it was necessary to change the list of downloads from normal to private when switching tabs (and there was not a lot of experiments of varying degrees of success). <br>  But without a trick, as usual, it still wasn‚Äôt enough: Firefox 28 removed the function for cleaning the downloads panel, quite (before it was to switch between the old and the new download engine).  So I had to write an analogue - good, it's simple. <br>  The result can be viewed at the <a href="https://gist.github.com/Infocatcher/5387328">link</a> already provided above or <a href="">in the extension code</a> . <br>  And in the expansion there is a feature: if you just do <br><pre> <code class="javascript hljs">DownloadsView._viewItems = {}; DownloadsView._dataItems = [];</code> </pre><br>  , there will be a memory leak, because the objects will be created in the scope of the extension, so that the commonly used constructor functions came in handy: <br><pre> <code class="javascript hljs">DownloadsView._viewItems = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.Object(); DownloadsView._dataItems = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.Array();</code> </pre><br>  In this case, the <em>window</em> is the window in which <em>DownloadsView</em> is located (that is, <em>DownloadsView === window.DownloadsView</em> ). <br><br><h1>  Save downloads on exit </h1>  This turned out to be the most difficult, but not so much due to the fact that the internal implementation of downloads has changed in Firefox 26, but because of many related problems.  Many of these difficulties are reflected in the <a href="https://github.com/Infocatcher/Download_Panel_Tweaker/issues/5">corresponding issue</a> , but better everything in order. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Older versions and cleanup downloads </h2>  In Firefox 25 and older versions, downloads were forcibly cleared ( <em>resource: //app/components/DownloadsStartup.js</em> ): <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"browser-lastwindow-close-granted"</span></span>: <span class="hljs-comment"><span class="hljs-comment">// When using the panel interface, downloads that are already completed // should be removed when the last full browser window is closed. This // event is invoked only if the application is not shutting down yet. // If the Download Manager service is not initialized, we don't want to // initialize it just to clean up completed downloads, because they can // be present only in case there was a browser crash or restart. if (this._downloadsServiceInitialized &amp;&amp; !DownloadsCommon.useToolkitUI) { Services.downloads.cleanUp(); } break; ... case "quit-application": ... // When using the panel interface, downloads that are already completed // should be removed when quitting the application. if (!DownloadsCommon.useToolkitUI &amp;&amp; aData != "restart") { this._cleanupOnShutdown = true; } break; case "profile-change-teardown": // If we need to clean up, we must do it synchronously after all the // "quit-application" listeners are invoked, so that the Download // Manager service has a chance to pause or cancel in-progress downloads // before we remove completed downloads from the list. Note that, since // "quit-application" was invoked, we've already exited Private Browsing // Mode, thus we are always working on the disk database. if (this._cleanupOnShutdown) { Services.downloads.cleanUp(); }</span></span></code> </pre><br>  As a result, when the browser was closed, the <em>Services.downloads.cleanUp ()</em> function was called. <br>  (By the way, there are already traces of a new engine in the same place - check for the value of <em>browser.download.useJSTransfer</em> setting.) <br>  I had to redefine <em>Services. Downloads</em> entirely, because this <br><pre> <code class="javascript hljs">Components.classes[<span class="hljs-string"><span class="hljs-string">"@mozilla.org/download-manager;1"</span></span>] .getService(Components.interfaces.nsIDownloadManager);</code> </pre><br>  (see <em>resource: //gre/modules/Services.jsm</em> ), and the properties of services cannot be changed: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(Services.downloads, <span class="hljs-string"><span class="hljs-string">"cleanUp"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">enumerable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">writable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); <span class="hljs-comment"><span class="hljs-comment">// Exception: can't redefine non-configurable property 'cleanUp'</span></span></code> </pre><br>  If simplistic, the result is the following: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> downloads = Services.downloads; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> downloadsWrapper = { <span class="hljs-attr"><span class="hljs-attr">__proto__</span></span>: downloads, <span class="hljs-attr"><span class="hljs-attr">cleanUp</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ... } }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setProperty(Services, <span class="hljs-string"><span class="hljs-string">"downloads"</span></span>, downloadsWrapper);</code> </pre><br>  That is, our fake object contains its own implementation of the function-property <em>cleanUp</em> and inherits everything else from the present <em>Services.downloads</em> . <br>  Well, from the fake <em>Services.downloads.cleanUp ()</em> function, you can check the call stack, and if this is the very <em>DownloadStartup.js</em> , then do nothing.  This is not very reliable, but it is easily restored when the extension is disabled.  You can even <a href="">complicate the task</a> and add checks in case any other extension makes a similar wrapper. <br><br><h2>  New versions, selective saving of downloads and many hacks </h2>  Then, in Firefox 26, the new download engine was enabled by default and temporary downloads were transferred (namely, they are displayed in the download panel) to the <em>downloads.json</em> file in the profile.  In addition, instead of cleaning, filtering was done while saving: <br>  <em>resource: //gre/modules/DownloadStore.jsm</em> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DownloadStore.prototype = { ... <span class="hljs-comment"><span class="hljs-comment">/** * This function is called with a Download object as its first argument, and * should return true if the item should be saved. */</span></span> onsaveitem: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>, ... <span class="hljs-comment"><span class="hljs-comment">/** * Saves persistent downloads from the list to the file. * * If an error occurs, the previous file is not deleted. * * @return {Promise} * @resolves When the operation finished successfully. * @rejects JavaScript exception. */</span></span> save: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DS_save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.spawn(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">task_DS_save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> downloads = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.list.getAll(); ... for (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> download <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> downloads) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onsaveitem(download)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }</code> </pre><br>  Then in <em>resource: //gre/modules/DownloadIntegration.jsm, the onsaveitem</em> method <em>is</em> overridden: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DownloadIntegration = { ... initializePublicDownloadList: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">aList</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.spawn(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">task_DI_initializePublicDownloadList</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ... this._store.onsaveitem = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.shouldPersistDownload.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); ... <span class="hljs-comment"><span class="hljs-comment">/** * Determines if a Download object from the list of persistent downloads * should be saved into a file, so that it can be restored across sessions. * * This function allows filtering out downloads that the host application is * not interested in persisting across sessions, for example downloads that * finished successfully. * * @param aDownload * The Download object to be inspected. This is originally taken from * the global DownloadList object for downloads that were not started * from a private browsing window. The item may have been removed * from the list since the save operation started, though in this case * the save operation will be repeated later. * * @return True to save the download, false otherwise. */</span></span> shouldPersistDownload: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">aDownload</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// In the default implementation, we save all the downloads currently in // progress, as well as stopped downloads for which we retained partially // downloaded data. Stopped downloads for which we don't need to track the // presence of a ".part" file are only retained in the browser history. // On b2g, we keep a few days of history. //@line 319 "c:\builds\moz2_slave\m-cen-w32-ntly-000000000000000\build\toolkit\components\jsdownloads\src\DownloadIntegration.jsm" return aDownload.hasPartialData || !aDownload.stopped; //@line 321 "c:\builds\moz2_slave\m-cen-w32-ntly-000000000000000\build\toolkit\components\jsdownloads\src\DownloadIntegration.jsm" },</span></span></code> </pre><br>  Thus, there is a <em>DownloadStore.prototype.onsaveitem ()</em> function that always allows saving and is overwritten for each specific implementation of <em>new DownloadStore ()</em> . <br>  (Looking ahead, I‚Äôll add that, unfortunately, not all comments are equally useful and true.) <br>  And in the source code <a href="">DownloadIntegration.jsm</a> there is an interesting conditional comment: <br><pre> <code class="javascript hljs"> shouldPersistDownload: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">aDownload</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// In the default implementation, we save all the downloads currently in // progress, as well as stopped downloads for which we retained partially // downloaded data. Stopped downloads for which we don't need to track the // presence of a ".part" file are only retained in the browser history. // On b2g, we keep a few days of history. #ifdef MOZ_B2G let maxTime = Date.now() - Services.prefs.getIntPref("dom.downloads.max_retention_days") * 24 * 60 * 60 * 1000; return (aDownload.startTime &gt; maxTime) || aDownload.hasPartialData || !aDownload.stopped; #else return aDownload.hasPartialData || !aDownload.stopped; #endif },</span></span></code> </pre><br>  However, if you replace the <em>DownloadIntegration.shouldPersistDownload ()</em> function (and do not forget about <em>DownloadIntegration._store.onsaveitem ()</em> in case the downloads have already been initialized), by analogy with the code from this conditional comment, a whole bunch of unpleasant surprises will pop up - like, and documented, it only works correctly in its original form, when completed downloads are not saved. <br><br>  <strong>Firstly</strong> , after restarting, all completed downloads will be shown with a zero size and browser start time (although everything is correctly stored in <em>downloads.json</em> ). <br>  Invalid date caused by code from <em>resource: //app/modules/DownloadsCommon.jsm</em> : <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Represents a single item in the list of downloads. * * The endTime property is initialized to the current date and time. * * @param aDownload * The Download object with the current state. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DownloadsDataItem</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">aDownload</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._download = aDownload; ... this.endTime = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.updateFromDownload(); }</code> </pre><br>  Then this time does not change when you call <em>DownloadsDataItem.prototype.updateFromJSDownload ()</em> (Firefox 26-27) and <em>DownloadsDataItem.prototype.updateFromDownload ()</em> (Firefox 28+). <br>  Fortunately, you can <a href="">make a</a> <a href="">wrapper</a> around this function and <a href="">make the necessary edits for each call</a> . <br><br>  <strong>Secondly</strong> , the code from the conditional comment about MOZ_B2G does not actually work: completed downloads will never be deleted.  And other suitable conditional comments about MOZ_B2G could not be found (apparently, it doesn‚Äôt work there either), although I didn‚Äôt really try - it‚Äôs <a href="">easy to fix everything there</a> . <br>  Then from the same place and <strong>thirdly</strong> : a large list of completed downloads cannot be loaded - a stack overflow occurs (‚Äú <em>too much recursion</em> ‚Äù <em>error</em> ).  And the problem can be obtained already on the list of 35 downloads. <br>  Apparently, the used implementation of promises ( <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">promises</a> ) does not know how to work correctly with actually synchronous calls. <br>  For example, if in <em>DownloadStore.prototype.load ()</em> ( <em>resource: //gre/modules/DownloadStore.jsm</em> ) a little tweak and replace in <br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Loads persistent downloads from the file to the list. * * @return {Promise} * @resolves When the operation finished successfully. * @rejects JavaScript exception. */</span></span> load: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DS_load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.spawn(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">task_DS_load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> bytes; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { bytes = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> OS.File.read(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ex <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ex <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> OS.File.Error &amp;&amp; ex.becauseNoSuchFile) { <span class="hljs-comment"><span class="hljs-comment">// If the file does not exist, there are no downloads to load. return; } let storeData = JSON.parse(gTextDecoder.decode(bytes)); // Create live downloads based on the static snapshot. for (let downloadData of storeData.list) { try { let download = yield Downloads.createDownload(downloadData);</span></span></code> </pre><br>  last line on <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> {Download} = Components.utils.import(<span class="hljs-string"><span class="hljs-string">"resource://gre/modules/DownloadCore.jsm"</span></span>, {}); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> download = Download.fromSerializable(downloadData);</code> </pre><br>  , the stack overflow will not go anywhere, but it will happen with a slightly larger number of saved downloads. <br>  <strong>Fourth</strong> , somewhere else there is optimization <abbr title="Interest interest, but more often it is much more important to spend time on a specific and useful result.">(?)</abbr> , So deleting completed downloads through the interface may not start saving data in <em>downloads.json</em> (by default, they are not saved), so after rebooting everything will remain as it was. <br>  Fortunately, you can use a simple hack: <a href="">add</a> saving current downloads when the browser is shut down. <br>  <strong>Fifth</strong> , when you start the browser, if there is something in the downloads pane (even if it is a paused or completed download) there will be a notification about the start of the download. <br>  But we already have a wrapper for <em>DownloadsDataItem.prototype.updateFromDownload ()</em> , so this is <a href="">easy to fix</a> . <br>  Well, the <em>downloads.json</em> reading code, unfortunately, had to be <a href="">rewritten</a> .  This is why my opinion about promises (promises) has not improved at all - any technology should be applied wisely and only where it is really needed (and not shoved anywhere, just because it is modern and fashionable). <br>  There is also a strange problem with the download list: if the dates are almost the same, the sorting will be inverted (the new ones will be from the bottom, not the top), but if you open the downloads panel when the browser starts up, the order will be correct ( but only in this window). <br>  In addition, problems with a large list of downloads are not limited to reading ... Although even with reading there is another problem: after each addition of a new download, an update of the interface is called, synchronously.  When restoring a saved list, an addition is also added, followed by notifying all concerned.  I had to make a <a href="">couple</a> more <a href="">corrections here</a> . <br>  Here, the <a href="https://developer.mozilla.org/en-US/docs/Tools/Profiler">built-in profiler</a> (Shift + F5) provided invaluable help. Without it, it would be practically impossible to figure out the reasons for hanging up - the logic that is painfully complicated there (and <a href="https://gist.github.com/Infocatcher/9091608">the call stack</a> terrifies). <br>  Well, besides reading the full list, the list cleaning function works as a minimum, so there too can fall out into the stack overflow if the list is big enough.  This is not fixed yet.  But, in principle, this is not critical: if something should not be saved, there is always a private mode, and the piece deletion (and the added point of cleaning in general for all downloads) works. <br>  What is the most interesting, with incomplete loads of problems is much less - their recovery for some reason will not fall into recursion, even if there are quite a lot of them (I checked for 150 pieces).  Apparently, this is due to the <a href="">OS.File</a> API for working with files separated into a separate stream (and the downloads of the files put on pause just check for the presence of the file), because of it, vague errors like <br><blockquote>  Error: Win error 2 during operation open (Can not find the file specified. <br>  ) <br>  Source file: resource: //gre/modules/commonjs/sdk/core/promise.js <br>  Line: 133 <br></blockquote>  (This is if you delete the file of the paused download) <br>  In addition, after the corrections made, the automatic download began to work normally, but if you try to open the downloads panel immediately after launching the browser, it will work out some other code and, if there are a lot of downloads, it may hang. <br><br>  <strong>PS The</strong> <a href="">new version of the extension</a> is still being tested, "position in the queue: 4 out of 17".  Initially, I planned to wait (and the text, in terms of editing - and it was written more than a week ago - this is only good), but there is a limit to everything. <br>  <strong>PPS</strong> I tried to write so as not to impose my opinion on the quality of the new code in Firefox to the reader, I hope I succeeded, and let everyone make his own conclusions.  However, I repeat, in the original form, no particular problems arise. </div><p>Source: <a href="https://habr.com/ru/post/215175/">https://habr.com/ru/post/215175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215161/index.html">Design and architecture in the OP. Part 2</a></li>
<li><a href="../215163/index.html">My tool for time tracking and invoicing</a></li>
<li><a href="../215167/index.html">The Linux Foundation and EdX begin a free course on Introduction to Linux.</a></li>
<li><a href="../215171/index.html">Simple filter tapes VK for "bad" words and what he can become</a></li>
<li><a href="../215173/index.html">Statistics using javascript libraries and CDN</a></li>
<li><a href="../215177/index.html">Radio-controlled switch do it yourself. Part 3 - Switch Software</a></li>
<li><a href="../215181/index.html">How signals and slots work in Qt (part 2)</a></li>
<li><a href="../215183/index.html">The digest of interesting news and materials from the world of PHP No. 37 (February 24 - March 9, 2014)</a></li>
<li><a href="../215185/index.html">Sample Application - Phonebook on AngularJS + Bootstrap v3</a></li>
<li><a href="../215189/index.html">Python Meetup: January Meeting</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>