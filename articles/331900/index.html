<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing a new service in Android 7 | Customization of the navigation bar</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine the following situation: we are developing a product that requires very specific properties that either do not exist or are not available in t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing a new service in Android 7 | Customization of the navigation bar</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/51f/340/e4d/51f340e4d45c2613aa2553b3590ba4be.jpg" alt="image"><br><br>  Imagine the following situation: we are developing a product that requires very specific properties that either do not exist or are not available in the Android inventory.  For example, a card reader is required. <br><a name="habracut"></a><br>  Yes, I know about external readers, but we are serious developers and we decided to make it internal so that the final device looked more complete.  For example, like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/16b/f0a/91b/16bf0a91bbb9acc202e09571f842c8fe.jpg" alt="image"><br><br><br>  Such devices are likely to provide special payment processing services for third-party developers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I want to describe the process of expanding the Android API on the example of creating a new service to customize the navigation bar. <br><br><h3>  Task statement </h3><br>  We are going to develop an API that will allow customization (customization) of the navigation line by adding new elements there.  The standard navigation bar looks differently on different devices, and may even be absent on devices with <a href="https://lemberg.co.uk/services/iot-hardware-design-and-prototyping">hardware</a> navigation buttons. <br><br>  Let's take the Nexus 9: <br><img src="https://habrastorage.org/getpro/habr/post_images/c2d/880/aa1/c2d880aa1b6a3736ac2614b5c52eaa1d.png" alt="image"><br>  The navigation bar is a black box at the bottom with navigation buttons.  It is shown to the user all the time (except when an application is running in full-screen mode), so it would be nice to allow developers to put their own elements there. <br><br>  In order to make the API as flexible as possible, take the Android Remote View as the main parameter of our API.  This will allow the user (ie, another developer) to use many of the standard components for customization.  It will also provide a feedback mechanism from the elements to the application. <br><br>  As an extension point, let's take the Android SDK directly: we will make changes to the AOSP (Android Open Source Project) and build our own Android SDK.  This SDK is suitable only for devices running our modified firmware, but this restriction suits us a priori.  As a result, our services will be very easy to use and they will be immediately accessible from the Android SDK. <br><br><h3>  Release </h3><br><h4>  Download and set up your AOSP development environment. </h4><br>  All necessary information for setting up the AOSP development environment is provided <a href="https://source.android.com/source/initializing">here</a> .  Select the appropriate AOSP branch (this affects the Android version) compatible with the selected device.  In my case, this is Nexus 9 and the <b>android-7.1.1_r33 branch</b> . <br><br><h4>  Develop a new service </h4><br>  Looking ahead, the following diagram shows all the components involved in the implementation: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/61f/28a/fa3/61f28afa3fac3e7ea96a7907170d1cff.jpg" alt="image"><br><br>  The idea is to provide advanced functions for managing the navigation bar to client applications via the Android service.  The navigation bar is defined in the <b>NavigationBarInflaterView.java</b> and <b>{aosp} /frameworks/base/packages/SystemUI/res/layout/navigation_bar.xml files</b> .  But we cannot access them directly from the client application, as they are in the <b>SystemUI</b> system application while the main Android services are located in the <b>system_process</b> process. <br><br>  Thus, our goal is reduced to the connection of these components with <b>system_process</b> , where they will be available for client code. <br><br>  1. Create a proxy service (manager) that will be visible from the client application.  This is a standard Java class that delegates all functions to the service: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> android.os; <span class="hljs-comment"><span class="hljs-comment">/** * /framework/base/core/java/android/os/NavBarExServiceMgr.java * It will be available in framework through import android.os.NavBarExServiceMgr; */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Context; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.RemoteViews; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NavBarExServiceMgr</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String TAG = <span class="hljs-string"><span class="hljs-string">"NavBarExServiceMgr"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Context context; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> INavBarExService navBarExService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> NavBarExServiceMgr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (NavBarExServiceMgr) context.getSystemService(Context.NAVBAREX_SERVICE); } <span class="hljs-comment"><span class="hljs-comment">/** * Creates a new instance. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> context The current context in which to operate. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> service The backing system service. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@hide</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NavBarExServiceMgr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, INavBarExService service)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.context = context; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (service == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"service is null"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.navBarExService = service; } <span class="hljs-comment"><span class="hljs-comment">/** * Sets the UI component * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ui - ui component * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> RemoteException * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@hide</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(INavBarExServiceUI ui)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> RemoteException </span></span>{ navBarExService.setUI(ui); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> priority, RemoteViews remoteViews)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> navBarExService.addView(priority, remoteViews); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RemoteException ignored) {} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> navBarExService.removeView(id); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RemoteException ignored) {} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id, RemoteViews remoteViews)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> navBarExService.replaceView(id, remoteViews); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RemoteException e) {} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewExist</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> navBarExService.viewExist(id); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RemoteException e) {} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br></div></div><br>  This class must be registered in the static section of the SystemServiceRegistry class: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs">registerService(Context.NAVBAREX_SERVICE, NavBarExServiceMgr.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CachedServiceFetcher() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> NavBarExServiceMgr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContextImpl ctx)</span></span></span><span class="hljs-function"> </span></span>{ IBinder b = ServiceManager.getService(Context.NAVBAREX_SERVICE); INavBarExService service = INavBarExService.Stub.asInterface(b); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (service == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Log.wtf(TAG, <span class="hljs-string"><span class="hljs-string">"Failed to get INavBarExService service."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NavBarExServiceMgr(ctx, service); }});</code> </pre><br></div></div><br>  On the client side, the service may be available as follows: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs">NavBarExServiceMgr navBarExServiceMgr = (NavBarExServiceMgr) getSystemService(Context.NAVBAREX_SERVICE); <span class="hljs-comment"><span class="hljs-comment">// TODO</span></span></code> </pre><br></div></div><br>  2. Define AIDL service interface: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"> <code>/* <br> * aidl file : <br> * frameworks/base/core/java/android/os/INavBarExService.aidl <br> * This file contains definitions of functions which are <br> * exposed by service. <br> */ <br> <br> package android.os; <br> <br> import android.os.INavBarExServiceUI; <br> import android.widget.RemoteViews; <br> <br> /** */ <br> interface INavBarExService <br> { <br> /** <br> * @hide <br> */ <br> void setUI(INavBarExServiceUI ui); <br> <br> String addView(in int priority, in RemoteViews remoteViews); <br> boolean removeView(in String id); <br> boolean replaceView(in String id, in RemoteViews remoteViews); <br> boolean viewExist(in String id); <br> } <br></code> <br></div></div><br>  And implement it: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NavBarExService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">INavBarExService</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Stub</span></span></span><span class="hljs-class"> ‚Ä¶</span></span></code> </pre><br></div></div><br>  As you can see most of the methods are straightforward, only <b>setUI</b> looks weird.  This is an internal method used by the class that implements the <b>INavBarExServiceUI</b> interface to register itself with the <b>NavBarExService</b> .  All entities marked with the ‚Äú@hide‚Äù comment will be cut from the final Android SDK and thus will not be visible from the client code. <br><br>  A few comments regarding API semantics: <br><br><ul><li>  Each element is identified by a string identifier.  It is generated by the service when a new item is added.  Thus, each application that adds new elements through our service must save the returned identifier in order to be able to work with the element in the future; </li><li>  Other methods accept an identifier as a parameter that identifies the element; </li><li>  Each element also has a ‚Äúpriority‚Äù parameter which indicates where to place the element.  The higher the priority value, the more left will be the placement. </li></ul><br><br>  The implementation of the <b>setUI</b> method: <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(INavBarExServiceUI ui)</span></span></span><span class="hljs-function"> </span></span>{ Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"setUI"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ui = ui; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ui != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Pair entry : remoteViewsList.getList()) { ui.navBarExAddViewAtEnd(entry.first, entry.second); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Log.e(TAG, <span class="hljs-string"><span class="hljs-string">"Failed to configure UI"</span></span>, e); } } }</code> </pre><br></div></div><br>  Implementation of the <b>addView</b> method: <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> priority, RemoteViews remoteViews)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> RemoteException </span></span>{ String id = UUID.randomUUID().toString(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pos = remoteViewsList.add(priority, id, remoteViews); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ui != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pos == <span class="hljs-number"><span class="hljs-number">0</span></span>) ui.navBarExAddViewAtStart(id, remoteViews); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pos == remoteViewsList.size() - <span class="hljs-number"><span class="hljs-number">1</span></span>) ui.navBarExAddViewAtEnd(id, remoteViews); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">// find previous element ID Pair prevElPair = remoteViewsList.getAt(pos - 1); ui.navBarExAddViewAfter(prevElPair.first, id, remoteViews); } } return id; }</span></span></code> </pre><br></div></div><br><br>  <b>remoteViewsList is</b> used to hold created items until the UI is connected (the <b>setUI</b> method is not called).  If it is already connected (the <b>ui</b> field is not null) the new element is added directly to the UI. <br><br>  3. <b>SystemServer</b> must register our service in the system: <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { traceBeginAndSlog(<span class="hljs-string"><span class="hljs-string">"StartNavBarExService"</span></span>); ServiceManager.addService(Context.NAVBAREX_SERVICE, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NavBarExService(context)); Slog.i(TAG, <span class="hljs-string"><span class="hljs-string">"NavBarExService Started"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable e) { reportWtf(<span class="hljs-string"><span class="hljs-string">"Failure starting NavBarExService Service"</span></span>, e); } Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</code> </pre><br></div></div><br>  Adding a new service requires editing Android SEPolicy policies. <br><br>  Add a new entry to the <b>{aosp} /system/selinux/service.te file</b> : <br><br> <code>type navbarex_service, app_api_service, system_server_service, service_manager_type;</code> <br> <br>  Add a new entry to the <b>{aosp} / system / selinux / service_contexts</b> file: <br><br> <code>navbarex u:object_r:navbarex_service:s0 <br></code> <br><br>  Keep in mind that the SELinux file format for Android 7.0 is different from previous versions of Android. <br><br>  4. Add service name constants to the <b>Context</b> class so that clients can use it instead of a string value: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Use with {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> #getSystemService} to retrieve a * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> android.os.NavBarExServiceMgr} for using NavBarExService * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> #getSystemService */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String NAVBAREX_SERVICE = <span class="hljs-string"><span class="hljs-string">"navbarex"</span></span>;</code> </pre><br></div></div><br>  5. Define the <b>INavBarExServiceUI</b> interface: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"> <code>/* <br> * aidl file : <br> * frameworks/base/core/java/android/os/INavBarExServiceUI.aidl <br> * This file contains definitions of functions which are provided by UI. <br> */ <br> <br> package android.os; <br> <br> import android.widget.RemoteViews; <br> <br> /** @hide */ <br> oneway interface INavBarExServiceUI <br> { <br> void navBarExAddViewAtStart(in String id, in RemoteViews remoteViews); <br> void navBarExAddViewAtEnd(in String id, in RemoteViews remoteViews); <br> void navBarExAddViewBefore(in String targetId, in String id, in RemoteViews remoteViews); <br> void navBarExAddViewAfter(in String targetId, in String id, in RemoteViews remoteViews); <br> void navBarExRemoveView(in String id); <br> void navBarExReplaceView(in String id, in RemoteViews remoteViews); <br> } <br></code> <br></div></div><br>  Notice that it is marked with the <b>‚Äúhide‚Äù</b> attribute, which makes it invisible to clients.  Also note the <b>oneway</b> keyword.  It makes interprocess communication from system_process to SystemUI faster, since all calls will be non-blocking (this also requires an empty return value in the methods). <br><br>  6. <b>VendorServices</b> is a standard SystemUI component (it is inherited from the SystemUI class), which implements the <b>INavBarExServiceUI</b> interface: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VendorServices</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemUI</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Handler handler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> NavBarExServiceMgr navBarExServiceMgr; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> PhoneStatusBar statusBar; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> INavBarExServiceUI.Stub navBarExServiceUI = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> INavBarExServiceUI.Stub() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">navBarExAddViewAtStart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> RemoteViews remoteViews)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!initStatusBar()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; handler.post(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ statusBar.navBarExAddViewAtStart(id, remoteViews); } }); } <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ } @Override protected void onBootCompleted() { super.onBootCompleted(); navBarExServiceMgr = (NavBarExServiceMgr) mContext.getSystemService(Context.NAVBAREX_SERVICE); if (navBarExServiceMgr == null) { Log.e(TAG, "navBarExServiceMgr=null"); return; } try { navBarExServiceMgr.setUI(navBarExServiceUI); } catch (Exception e) { Log.e(TAG, "setUI exception: " + e); } } }</span></span></code> </pre><br></div></div><br>  The <b>onBootCompleted</b> method is <b>interesting</b> .  It performs self-registration (calls the <b>setUI</b> method) in the NavBarExService via the NavBarExServiceMgr.  Also note that the SystemUI process may be restarted (for example due to a crash), as a result of which several setUI calls will be made.  Of course, only the latter should be taken into account. <br><br>  7. The <b>PhoneStatusBar</b> class is the key element that links the NavBarExService and the NavigationBarInflaterView.  It contains a link to NavigationBarView, which in turn contains a link to NavigationBarInflaterView.  On the other hand, VendorServices obtains a reference to PhoneStatusBar via the SystemUI.getComponent method: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initStatusBar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (statusBar == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (initLock) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (statusBar == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { statusBar = getComponent(PhoneStatusBar.class); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (statusBar == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Log.e(TAG, <span class="hljs-string"><span class="hljs-string">"statusBar = null"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"statusBar initialized"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre><br></div></div><br>  Have you noticed the strange ‚Äúif (statusBar == null)‚Äù construct?  It is called the ‚Äú <a href="https://en.wikipedia.org/wiki/Double-checked_locking">Double Checking Locking Pattern</a> ‚Äù and pursues the following goal: to produce a thread-safe initialization of the object, but to avoid entering the synchronization section when the object is already initialized.  The changes to PhoneStatusBar and NavigationBarView are fairly simple: they simply delegate all calls to the NavigationBarInflaterView class. <br><br>  8. The <b>NavigationBarInflaterView</b> class is the final class that directly makes changes to the UI.  Here is his method navBarExAddViewAtStart: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">navBarExAddViewAtStart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id, RemoteViews remoteViews)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((mRot0 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) || (mRot90 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; ViewGroup ends0 = (ViewGroup) mRot0.findViewById(R.id.ends_group); ViewGroup ends90 = (ViewGroup) mRot90.findViewById(R.id.ends_group); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((ends0 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) || (ends90 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; navBarExAddView(<span class="hljs-number"><span class="hljs-number">0</span></span>, id, remoteViews, ends0); navBarExAddView(<span class="hljs-number"><span class="hljs-number">0</span></span>, id, remoteViews, ends90); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">navBarExAddView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, String id, RemoteViews remoteViews, ViewGroup parent)</span></span></span><span class="hljs-function"> </span></span>{ View view = remoteViews.apply(mContext, parent); view.setTag(navBarExFormatTag(id)); TransitionManager.beginDelayedTransition(parent); parent.addView(view, index); }</code> </pre><br></div></div><br>  This code relies on the existing implementation and uses the mRot0, mRot90 and also R.id.ends_group fields as a ViewGroup for custom elements.  mRot0 and mRot90 represent markup for portrait and landscape modes, so add our elements to both of them.  We also used TransitionManager to play some animation. <br><br>  9. One thing about the Android.mk file.  It should contain links to our AIDL files.  Two files in the LOCAL_SRC_FILES section: <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"> <code>LOCAL_SRC_FILES += \ <br> <br> core/java/android/os/INavBarExService.aidl \ <br> core/java/android/os/INavBarExServiceUI.aidl \ <br> <br> ... <br></code> <br></div></div><br>  and INavBarExService.aidl in the ‚Äúaidl_files‚Äù section: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"> <code>aidl_files := \ <br> <br> frameworks/base/core/java/android/os/INavBarExService.aidl \ <br> <br> ... <br></code> <br></div></div><br><h3>  Together </h3><br>  Source codes are available on <a href="https://github.com/ryanchyshyn/aosp_nav_bar_ex">GitHub</a> .  There are two files in the ‚Äúpatches‚Äù directory: frameworks_base.patch and system_sepolicy.patch.  The first patch should be applied to the ‚Äú{aosp} / frameworks / base‚Äù directory, the second to the ‚Äú{aosp} / system / sepolicy‚Äù directory. <br><br>  The NavBarExDemo directory contains a demo application for the gradle assembly system. <br><br>  To test the implementation on a real device, we need: <br><br><ol><li>  Download Android stock sources and set up a development environment; </li><li>  Apply patches; </li><li>  Build custom Android SDK; </li><li>  Assemble custom firmware and flash the device; </li><li>  Launch the demo application. </li></ol><br>  To build the Android SDK, run the following commands: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"> <code>. build/envsetup.sh <br> lunch sdk_x86-eng <br> make sdk -j16 <br></code> <br></div></div><br>  The resulting ZIP file is located in the <b>{aosp} / out / host / linux-x86 / sdk / sdk_x86 directory</b> (if running on Linux).  Keep in mind that the file name will contain your Linux username.  In order to change this behavior, define the environment variable ‚ÄúBUILD_NUMBER‚Äù and its value will be used instead of the user name.  The J parameter specifies how many tasks to run simultaneously.  Use the number of processor cores multiplied by 2. <br><br>  <a href="https://lemberg.co.uk/services/iot-development-services">Firmware</a> can be created using the following commands (for a Nexus 9 device): <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"> <code>. build/envsetup.sh <br> lunch aosp_flounder-userdebug <br> make otapackage -j16 <br></code> <br></div></div><br>  Firmware can be flashed using the command: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"> <code>fastboot -w flashall <br></code> <br></div></div><br>  The device must have an unlocked bootloader. <br><br>  To check the results, a special demonstration application was created.  It allows you to manage the elements of the navigation bar. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e59/e6f/535/e59e6f535c8ce8a72b84479c8329139e.png" alt="image"><br><br>  Clicking on the custom element will show a toast even if the demo application is not running (in fact, the system itself will start the process if needed). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/17a/1cf/7d1/17a1cf7d1ccdf18324eebdcbf3b1bb2d.png" alt="image"><br><br><h3>  Shortcomings </h3><br>  After rebooting, the device will lose all customization.  So it would be good to save her somewhere.  It would also be nice to add the ‚Äúgravity‚Äù parameter to the API for more precise control of the location of elements. <br><br><h3>  Summary </h3><br>  We have expanded the Android SDK and implemented a new service designed to customize the Android navigation bar.  We also created a custom firmware for the Nexus 9 tablet containing our service. <br><br>  In the <a href="http://blog.lemberg.co.uk/no-shake-screen-stabilization-android">previous article</a> we implemented screen stabilization for the Nexus 7. Here is the same implementation but for the Nexus 9: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/qsuvgbW9SgE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  PS In fact, I am also the author of the original English version of the article, which was published on <a href="http://blog.lemberg.co.uk/">blog.lemberg.co.uk</a> , so I can answer technical questions. </div><p>Source: <a href="https://habr.com/ru/post/331900/">https://habr.com/ru/post/331900/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331890/index.html">Digest of IT events for July</a></li>
<li><a href="../331892/index.html">PSEFABRIC - a new approach to network management and automation</a></li>
<li><a href="../331894/index.html">How does a store in a mall recognize you via Wi-Fi (more precisely, by MAC address) - based on regular hotspots</a></li>
<li><a href="../331896/index.html">"Saved": What is the result of excessive IT cuts in the store?</a></li>
<li><a href="../331898/index.html">Conferences for developers as a way to senior? And what works?</a></li>
<li><a href="../331902/index.html">Data center operation: what you need to do yourself</a></li>
<li><a href="../331904/index.html">Search for strong connectivity components: Kosarayu algorithm</a></li>
<li><a href="../331906/index.html">Fighting viruses and infrastructure, or disabling SMB v1</a></li>
<li><a href="../331908/index.html">JaCarta Authentication Server and JaCarta WebPass for OTP Authentication in Linux SSH</a></li>
<li><a href="../331910/index.html">Super Metroid Invisible Hand</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>