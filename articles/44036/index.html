<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HttpHandler for compression and compression of * .js and * .css files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Everyone knows that ‚Äúmost of the time is spent on downloading the components of the page: pictures, style sheets, scripts, flash ... Reducing the numb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HttpHandler for compression and compression of * .js and * .css files</h1><div class="post__text post__text-html js-mediator-article">  Everyone knows that ‚Äúmost of the time is spent on downloading the components of the page: pictures, style sheets, scripts, flash ... Reducing the number of these components reduces the number of requests to the server needed before the client application can render the page.‚Äù I always squeezed and merged * .js and * .css files manually, but lately it began to get me a bit, and I decided to simplify this process.  To do this, I rummaged through a bunch of things on Google and thematic forums in search of the information I needed, and then I just put everything together. <br>  For javascript compression, I used <a href="http://www.codeproject.com/KB/cs/jscompress.aspx">jscompress</a> , slightly modified for my needs. <br>  Here's what happened: <br><a name="habracut"></a><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">&lt;%@ WebHandler Language= <font color="#A31515">"C#"</font> Class= <font color="#A31515">"StaticFilesCombiner"</font> %&gt; <br> <br> <font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Net; <br> <font color="#0000ff">using</font> System.IO; <br> <font color="#0000ff">using</font> System.IO.Compression; <br> <font color="#0000ff">using</font> System.Text; <br> <font color="#0000ff">using</font> System.Web; <br> <font color="#0000ff">using</font> JSCompress; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> StaticFilesCombiner: IHttpHandler { <br> <font color="#0000ff">private</font> <font color="#0000ff">readonly</font> <font color="#0000ff">static</font> <font color="#2B91AF">TimeSpan</font> CACHE_DURATION = <font color="#2B91AF">TimeSpan</font> .FromDays(30); <br> <font color="#0000ff">private</font> <font color="#0000ff">const</font> <font color="#0000ff">string</font> JQuery = <font color="#A31515">"jquery-1.2.6.min.js"</font> ; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> ProcessRequest ( <font color="#2B91AF">HttpContext</font> context) { <br> <br> HttpRequest request = context.Request; <br> <br> <font color="#008000">//  , contentType  .</font> <br> <font color="#008000">//    </font> <br> <font color="#0000ff">string</font> setName = request[ <font color="#A31515">"s"</font> ] ?? <font color="#0000ff">string</font> .Empty; <br> <font color="#0000ff">string</font> contentType = request[ <font color="#A31515">"t"</font> ] ?? <font color="#0000ff">string</font> .Empty; <br> <font color="#0000ff">string</font> version = request[ <font color="#A31515">"v"</font> ] ?? <font color="#0000ff">string</font> .Empty; <br> <br> <font color="#0000ff">bool</font> isCompressed = CanGZip(context.Request); <br> <font color="#0000ff">bool</font> isJS = contentType.Contains( <font color="#A31515">"java"</font> ); <br> UTF8Encoding encoding = <font color="#0000ff">new</font> UTF8Encoding( <font color="#0000ff">false</font> ); <br> <br> <font color="#0000ff">if</font> (!WriteFromCache(context, setName, version, isCompressed, contentType)) <br> { <br> <font color="#0000ff">using</font> (MemoryStream memoryStream = <font color="#0000ff">new</font> MemoryStream(5000)) <br> { <br> <font color="#0000ff">using</font> ( <font color="#2B91AF">Stream</font> writer = isCompressed ? <br> ( <font color="#2B91AF">Stream</font> )( <font color="#0000ff">new</font> GZipStream(memoryStream, CompressionMode.Compress)) : <br> memoryStream) <br> { <br> <br> <font color="#008000">//    &lt;appSettings&gt;  </font> <br> <font color="#0000ff">string</font> setDefinition = <br> System.Configuration. <font color="#2B91AF">ConfigurationManager</font> .AppSettings[setName] ?? <font color="#A31515">""</font> ; <br> <font color="#0000ff">string</font> [] fileNames = setDefinition.Split( <font color="#0000ff">new</font> [] { <font color="#A31515">','</font> }, <br> StringSplitOptions.RemoveEmptyEntries); <br> <br> <font color="#0000ff">foreach</font> ( <font color="#0000ff">string</font> fileName <font color="#0000ff">in</font> fileNames) <br> { <br> <font color="#0000ff">byte</font> [] fileBytes = GetFileBytes(context, fileName.Trim(), encoding, isJS); <br> writer.Write(fileBytes, 0, fileBytes.Length); <br> } <br> <br> writer.Close(); <br> } <br> <br> <font color="#0000ff">byte</font> [] responseBytes = memoryStream.ToArray(); <br> context.Cache.Insert(GetCacheKey(setName, version, isCompressed), <br> responseBytes, <font color="#0000ff">null</font> , System.Web.Caching.Cache.NoAbsoluteExpiration, <br> CACHE_DURATION); <br> <br> WriteBytes(responseBytes, context, isCompressed, contentType); <br> } <br> } <br> } <br> <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">///  CSS.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">string</font> MinifyCss( <font color="#0000ff">string</font> body) <br> { <br> <font color="#2B91AF">StringBuilder</font> builder = <font color="#0000ff">new</font> <font color="#2B91AF">StringBuilder</font> (body); <br> builder = builder.Replace( <font color="#A31515">"  "</font> , <font color="#0000ff">string</font> .Empty); <br> builder = builder.Replace(Environment.NewLine, <font color="#0000ff">string</font> .Empty); <br> builder = builder.Replace( <font color="#A31515">"\t"</font> , <font color="#0000ff">string</font> .Empty); <br> builder = builder.Replace( <font color="#A31515">" {"</font> , <font color="#A31515">"{"</font> ); <br> builder = builder.Replace( <font color="#A31515">" :"</font> , <font color="#A31515">":"</font> ); <br> builder = builder.Replace( <font color="#A31515">": "</font> , <font color="#A31515">":"</font> ); <br> builder = builder.Replace( <font color="#A31515">", "</font> , <font color="#A31515">","</font> ); <br> builder = builder.Replace( <font color="#A31515">"; "</font> , <font color="#A31515">";"</font> ); <br> builder = builder.Replace( <font color="#A31515">";}"</font> , <font color="#A31515">"}"</font> ); <br> <br> <font color="#0000ff">return</font> builder.ToString(); <br> } <br> <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">///  js.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">string</font> MinifyJS( <font color="#0000ff">string</font> notCompressedString, <font color="#0000ff">string</font> virtualPath) <br> { <br> <font color="#008000">//   JQuery,     .</font> <br> <font color="#0000ff">if</font> (virtualPath.Contains(JQuery)) <br> { <br> <font color="#0000ff">return</font> notCompressedString; <br> } <br> JSCompressor jsCOmpressor = <font color="#0000ff">new</font> JSCompressor( <font color="#0000ff">true</font> ) <br> { <br> CompressVariableNames = <font color="#0000ff">false</font> , <br> LineFeedRemoval = <font color="#0000ff">true</font> <br> }; <br> <font color="#0000ff">return</font> jsCOmpressor.Compress(notCompressedString); <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">byte</font> [] GetFileBytes( <font color="#2B91AF">HttpContext</font> context, <font color="#0000ff">string</font> virtualPath, <font color="#2B91AF">Encoding</font> encoding, <font color="#0000ff">bool</font> isJS) <br> { <br> <font color="#0000ff">string</font> compressedString; <br> <font color="#0000ff">string</font> notCompressedString; <br> <font color="#0000ff">if</font> (virtualPath.StartsWith( <font color="#A31515">"http://"</font> , StringComparison.InvariantCultureIgnoreCase)) <br> { <br> <font color="#0000ff">using</font> (WebClient client = <font color="#0000ff">new</font> WebClient()) <br> { <br> notCompressedString = client.DownloadString(virtualPath); <br> compressedString = isJS ? MinifyJS(notCompressedString, virtualPath) : MinifyCss(notCompressedString); <br> <br> <font color="#0000ff">return</font> encoding.GetBytes(compressedString); <br> } <br> } <br> <br> <font color="#0000ff">string</font> physicalPath = context.Server.MapPath(virtualPath); <br> notCompressedString = <font color="#2B91AF">File</font> .ReadAllText(physicalPath); <br> compressedString = isJS ? MinifyJS(notCompressedString, physicalPath) : MinifyCss(notCompressedString); <br> <br> <font color="#0000ff">return</font> encoding.GetBytes(compressedString); <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">bool</font> WriteFromCache( <font color="#2B91AF">HttpContext</font> context, <font color="#0000ff">string</font> setName, <font color="#0000ff">string</font> version, <br> <font color="#0000ff">bool</font> isCompressed, <font color="#0000ff">string</font> contentType) <br> { <br> <font color="#0000ff">byte</font> [] responseBytes = context.Cache[GetCacheKey(setName, version, isCompressed)] <font color="#0000ff">as</font> <font color="#0000ff">byte</font> []; <br> <br> <font color="#0000ff">if</font> ( <font color="#0000ff">null</font> == responseBytes || 0 == responseBytes.Length) <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> <br> WriteBytes(responseBytes, context, isCompressed, contentType); <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> WriteBytes( <font color="#0000ff">byte</font> [] bytes, <font color="#2B91AF">HttpContext</font> context, <br> <font color="#0000ff">bool</font> isCompressed, <font color="#0000ff">string</font> contentType) <br> { <br> HttpResponse response = context.Response; <br> <br> response.AppendHeader( <font color="#A31515">"Content-Length"</font> , bytes.Length.ToString()); <br> response.ContentType = contentType; <br> <font color="#0000ff">if</font> (isCompressed) <br> response.AppendHeader( <font color="#A31515">"Content-Encoding"</font> , <font color="#A31515">"gzip"</font> ); <br> <br> context.Response.Cache.SetCacheability(HttpCacheability.Public); <br> context.Response.Cache.SetExpires( <font color="#2B91AF">DateTime</font> .Now.Add(CACHE_DURATION)); <br> context.Response.Cache.SetMaxAge(CACHE_DURATION); <br> context.Response.Cache.AppendCacheExtension( <font color="#A31515">"must-revalidate, proxy-revalidate"</font> ); <br> <br> response.OutputStream.Write(bytes, 0, bytes.Length); <br> response.Flush(); <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">bool</font> CanGZip(HttpRequest request) <br> { <br> <font color="#0000ff">string</font> acceptEncoding = request.Headers[ <font color="#A31515">"Accept-Encoding"</font> ]; <br> <font color="#0000ff">if</font> (! <font color="#0000ff">string</font> .IsNullOrEmpty(acceptEncoding) &amp;&amp; <br> (acceptEncoding.Contains( <font color="#A31515">"gzip"</font> ) || acceptEncoding.Contains( <font color="#A31515">"deflate"</font> ))) <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">string</font> GetCacheKey( <font color="#0000ff">string</font> setName, <font color="#0000ff">string</font> version, <font color="#0000ff">bool</font> isCompressed) <br> { <br> <font color="#0000ff">return</font> <font color="#A31515">"StaticFilesCombiner."</font> + setName + <font color="#A31515">"."</font> + version + <font color="#A31515">"."</font> + isCompressed; <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">bool</font> IsReusable <br> { <br> <font color="#0000ff">get</font> <br> { <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> } <br> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  To use it, just add a couple of lines to web.config: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">appSettings</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">add</font> <font color="#ff0000">key</font> <font color="#0000ff">="Main_Css"</font> <font color="#ff0000">value</font> <font color="#0000ff">="~/styles/styles.css"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">add</font> <font color="#ff0000">key</font> <font color="#0000ff">="Set_Css"</font> <font color="#ff0000">value</font> <font color="#0000ff">="~/styles/Compare.css,~/styles/anycss.css,~/styles/ImageGallery.css,~/styles/styles.css,~/styles/thickbox.css"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">add</font> <font color="#ff0000">key</font> <font color="#0000ff">="Set_Javascript"</font> <font color="#ff0000">value</font> <font color="#0000ff">="~/js/jquery-1.2.6.min.js,~/js/basket.js,~/js/jquery.galleria.js,~/js/thickbox-compressed.js"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">add</font> <font color="#ff0000">key</font> <font color="#0000ff">="SiteName"</font> <font color="#ff0000">value</font> <font color="#0000ff">="stirka.spb.ru"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">appSettings</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In fact, these are sets of files for combining and compressing. <br><br>  And the use itself: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">link</font> <font color="#ff0000">type</font> <font color="#0000ff">="text/css"</font> <font color="#ff0000">rel</font> <font color="#0000ff">="Stylesheet"</font> <font color="#ff0000">href</font> <font color="#0000ff">="StaticFilesCombiner.ashx?s=Main_Css&amp;t=text/css&amp;v=13"</font> <font color="#0000ff">/&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br></div><p>Source: <a href="https://habr.com/ru/post/44036/">https://habr.com/ru/post/44036/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../44028/index.html">Let's think about the future.</a></li>
<li><a href="../44030/index.html">Google office in St. Petersburg</a></li>
<li><a href="../44031/index.html">Tasks for Java Beginners</a></li>
<li><a href="../44032/index.html">Incore plans to improve the mobile payments market, and 50 million rubles were invested in Planet3.</a></li>
<li><a href="../44034/index.html">Chinese fake Nokia N95</a></li>
<li><a href="../44037/index.html">About crisis and dismissals - with humor</a></li>
<li><a href="../44038/index.html">Browser hijacking in mail.ru agent</a></li>
<li><a href="../44039/index.html">Ubuntu Release Party in Minsk</a></li>
<li><a href="../44040/index.html">Version Tree for CVS</a></li>
<li><a href="../44042/index.html">First trojan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>