<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Telemetry and software</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About 6 years ago, I participated in a project for the manufacture of hardware and software for one large North American medical company. Standing nea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Telemetry and software</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/59/ef/7d/59ef7dadd823b895798424.png"><br><br>  About 6 years ago, I participated in a project for the manufacture of hardware and software for one large North American medical company.  Standing near the test stand, in which there were several devices under load, I asked myself the question: <i>‚ÄúIf something goes wrong, how can we speed up the search and correction of the error?‚Äù</i> <br><br>  From the moment this issue arose to this day, a lot has been done, and I would like to share with you how the collection and analysis of telemetry in software and hardware has significantly reduced the time of error detection and correction in the whole spectrum of projects in which I participated. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  Telemetry comes from the ancient Greek œÑ·øÜŒªŒµ "far" + ŒºŒ≠œÑœÅŒµœâ - "measured." <br>  Everything is very simple, any measurements that a staff of various engineers and possibly scientists can invent, the target system sends to the processing center for visual and automatic control and processing. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Something like this: <br><br><img src="https://habrastorage.org/webt/59/ef/80/59ef8004b3d1e475080033.png"><br><br>  When on the server side it might look like this: <br><br> <a href=""><img src="https://habrastorage.org/webt/59/ef/87/59ef879402b08290191918.png"></a> <br><br><h2>  Prehistory </h2><br>  Somehow, watching the work of our QA engineers, I wondered why complex devices like satellites, rockets, machines have telemetry, and we, creating, in fact, the program parts of the operating rooms, robots, complex software solutions, do not even think about it direction? <br><br>  The amount of code is enormous, and there are ways to understand that something went wrong less than fingers on one hand: <br><br><ul><li>  Put a breakpoint, but for this you need to complete the quest: <br>  1) Be lucky enough and have access to the target system <br>  2) Be lucky and know how to accurately reproduce the bug or wait and wait again <br>  3) Pray that the breakpoint does not destroy the internal state of the system (if there are real-time processes inside) <br></li><li>  The client is screaming into the phone that exception in your code is not a bit ridiculous and it‚Äôs good that he was caught by his engineers on the test bench, and not when the patient is on the table, and at that time you are thinking what the exception is </li><li>  Zen option - log analysis </li><li>  Crash dump analysis </li></ul><br>  In parallel, watching the work of our QA engineers, I looked at one of the screens, which the patient's heartbeat curves, pressure, temperature and heaps of other parameters ran along and I wanted our products to be like this patient - under reliable supervision.  So that even if something goes wrong, it was possible to rewind the time and see what circumstances happened. <br><br><h2>  Bike or ride </h2><br>  As we were taught: bicycles are informative and fascinating, but first look for existing solutions, which I did. <br><br>  By good tradition, he began with the requirements: <br><br><ul><li>  Client-server architecture (in the absence of a server, the ability to save data locally) </li><li>  Open source </li><li>  Cross-platform (at least Linux + Win) </li><li>  Remote control (on / off counters to save resources) </li><li>  High performance (by the standards of C / C ++ programs) </li><li>  Reasonable memory requirements, and better ability to control this parameter </li><li>  Support at least C / C ++ / Python </li><li>  The ability to write scripts or your own code for analyzing telemetry in real-time and / or off-line modes </li><li>  Convenience of viewing in real-time and off-line modes (subjective requirement) </li></ul><br>  I searched for a long time and thoughtfully ... but alas, everything was not just bad, everything was terrible! <br><br>  At the beginning of 2011, not a single project that I found, even close, even half of the requirements, came under these requirements. <br><br>  Telemetry for software in the form of ready-made and open solutions was almost absent as a class, the big players did everything for themselves and were not in a hurry to share. <br><br>  The second surprise was the reaction of colleagues - indifference or at worst rejection, but, fortunately - it did not last long, until the first results. <br><br>  The only solution I found at that time (2011) was the P7 library located at the time on google code.  The functionality was poor, from the platforms there was only X86, it was difficult to look at the server without tears, but there were also advantages: <br><br><ul><li>  high performance </li><li>  is free </li><li>  open source </li><li>  the ability to control (on / off) the counters remotely (which was tempting in terms of saving the CPU) </li><li>  And most importantly, the author of the project was interested in our ideas for improvement. </li></ul><br>  After a series of thoughts, studying, it was decided to try to ride a bike on someone else. <br><br><h2>  First step </h2><br>  Embedding the library in our code was easy and without problems, but then the question arose: what beautiful graphics we want to see and what readings to record?  It just seems that the question is simple, in fact - it is complicated and cunning. <br><br>  At first, and without experience, we began to write a relatively insignificant amount of telemetry: <br><br><ul><li>  CPU load by cores and threads </li><li>  Number of handles, threads, objects, etc. </li><li>  Memory consumption </li><li>  Different buffers </li><li>  Several cyclograms for critical flows </li></ul><br>  Unfortunately, the screenshots of those years have not survived, and I will give the closest approximation: <br><br> <a href=""><img src="https://habrastorage.org/webt/59/ef/8d/59ef8d77ae53c044998362.png"></a> <br><br>  The very first baptism of fire gave excellent results: after a couple of days of inconspicuous work and the reproduction of several bugs, we were finally able to understand the nature of many of them: <br><br><ul><li>  Reading from the disk didn‚Äôt jam because the disk was busy - another stream was busy (it seems like it was not related to the first one).  We have already managed to give a plausible explanation to the customer, then we added telemetry ... and ... it came out inconveniently. <br><br> <a href=""><img src="https://habrastorage.org/webt/59/ef/8e/59ef8e81090a1285188687.png"></a> <br>  <i>The graph (clickable) shows that the delays in the stream reading from the HDD coincide surprisingly with the delays in another stream; after 10 minutes of peering into the code, a piece was found that caused such a dependency.</i> <br></li><li>  We saw periodic jumps in memory, just for a few seconds, followed by release, the release sometimes hung, because the memory manager tried to digest several thousand items returned back. <br><br>  It turned out that the test code from the machine of one of the engineers got into production and regularly hung up one of the threads, for half a second, for a second.  This problem was also clearly visible on the graphs - the rise of CPU, memory, the frenzied work of the memory manager, and suddenly in the middle it hung for several hundred milliseconds (sometimes up to several seconds): <br><br> <a href=""><img src="https://habrastorage.org/webt/59/ef/8d/59ef8df860961861196280.png"></a> <br></li><li>  Data processing from the disk stuck because the buffer was empty, and the buffer was empty because of the first bug, which again was clearly visible on the graph, and the coincident time marks of telemetry and logs spoke about the relationship of these events. <br></li></ul><br>  There were some corrected on the first or second day, but after years of prescription, I can no longer remember what it was. <br><br>  After we enthusiastically with our colleagues poked their fingers at the monitor and asked ‚Äú¬øQu√© pasa?‚Äù, Found the answer and were happy as children - the utility question was no longer there, we got a new toy and wanted to play further. <br><br><h2>  Go to run </h2><br>  After the first success, we began to consistently increase the number of required meters: <br><br><ul><li>  Added telemetry in the form of cyclograms on the main streams, it immediately became apparent frequency of work, small and large freezes </li><li>  Added telemetry to synchronization primitives (mutexes, semaphores, critical sections). </li><li>  Added all possible hardware sensors - ‚Äúturned out‚Äù temperature jumps correlate with a number of problems </li><li>  Added load counters for various hardware components - memory bandwidth, registers access, PCI and the world played with new colors </li><li>  Measurements of the execution time of the main functions and code blocks, and when after making changes on tests, a regression in performance was detected - interested persons received an automatic angry email, describing which counter after which code change showed regression </li><li>  Of course, in addition to these counters, engineers added heaps of others, on time and on a permanent basis. </li></ul><br>  Next, we divided the counters into 3 groups: <br><br><ul><li>  Generating the largest data flow - our software processed these counters only when there was a connection with the server and when this counter was switched on from the server by the hands of one of the engineers </li><li>  Generating the average data flow - our software processed these counters only when there was a connection with the server, if there was no connection with the server - the counter did not waste CPU cycles, but as soon as the connection appeared - the data started to be sent </li><li>  Critical - this data should have been saved anyway, if there is no connection with the server, then on the HDD </li></ul><br>  And the final step was to update the testing process and implement the practice, that the error recorded by QA should accompany not only the formal description, if possible, the playback method and log files, but also telemetry. <br><br><h2>  Conclusion </h2><br>  As a conclusion, let me present a few facts: <br><br><ul><li>  Now we are collecting an impressive amount of telemetry from the whole spectrum of software from C to C # and Python and up to iron, we collect centrally and not so much, depending on the tasks </li><li>  Telemetry analysis is divided into 3 blocks: <br><br><ol><li>  Automatic (server plugins) </li><li>  Semi-automatic - in the server it is possible to use your own Lua scripts for additional analysis, the engineer decides for himself and modifies / creates them for his own needs </li><li>  Visual (method of attentive peering) sounds ridiculous, but often it is also very effective, especially if you don‚Äôt know what to look for, and the problem is </li></ol></li><li>  Error reports from our QA engineers accompany links to telemetry </li><li>  We began to solve problems faster </li></ul><br>  This article is rather superficial and leaves behind many technical issues ‚Äúhow to get the CPU load by my stream‚Äù, ‚Äúhow to make a cyclogram of my stream‚Äù, ‚Äúhow do you make plugins‚Äù and so on and so on.  But if the topic is interesting enough, you can make separate articles on all these points. <br><br>  I would like to hope that this article will allow you to ask the same question as ‚Äúwill telemetry help our product?‚Äù, Then I can say that I wrote it for good reason, as this question rarely sounds in the software industry, there is an opinion that this is a lot of space and defense. <br><br>  Thank you for reading! <br><br>  <b>PS:</b> I deliberately did not talk about our company and I will not - this article is not about her. <br>  <b>PPS:</b> if you are interested, we use the Jenkins + Baical + P7 <a href="http://www.baical.net/">bundle</a> ( <a href="http://www.baical.net/">www.baical.net</a> ), it fits well for our needs, the author of the project has implemented, at our request, not one or two improvements, in addition, we use P7 for logging ( <a href="https://habrahabr.ru/post/313686/">https://habrahabr.ru/post/313686/</a> ) </div><p>Source: <a href="https://habr.com/ru/post/340882/">https://habr.com/ru/post/340882/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340872/index.html">Cloud Digest: about technologies, SSL certificates and IaaS provider operation</a></li>
<li><a href="../340874/index.html">‚ÄúActive Search‚Äù: how we chose the search engine for the DLP system</a></li>
<li><a href="../340876/index.html">Check whether the service pack is present on the system before installation</a></li>
<li><a href="../340878/index.html">Exantech Code Jam: Hacktoberfest 2017</a></li>
<li><a href="../340880/index.html">Bad Rabbit: a new wave of attacks using a ciphering virus</a></li>
<li><a href="../340884/index.html">There is no time to explain! or how to make friends terraform with minikube and kubernetes</a></li>
<li><a href="../340886/index.html">OpenApoc - X-Com Apocalypse Dedicated to Fans</a></li>
<li><a href="../340890/index.html">Bad Rabbit: Petya returns</a></li>
<li><a href="../340892/index.html">How to lead people who have more technical experience than you</a></li>
<li><a href="../340894/index.html">Where perspective and adequate to use Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>