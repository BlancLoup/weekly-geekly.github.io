<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>UART in ATtiny13 or How to display data from the MC for 52p</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(price for 10 pcs of Chip and Dip store at the time of publication) 

 I could never resist buying various electronic pieces, and once I had 10 very s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>UART in ATtiny13 or How to display data from the MC for 52p</h1><div class="post__text post__text-html js-mediator-article">  <i>(price for 10 pcs of Chip and Dip store at the time of publication)</i> <br><img width="300" align="left" src="https://habrastorage.org/files/384/8f9/dda/3848f9dda41340d2ae8b892325600d12.jpg"><br>  I could never resist buying various electronic pieces, and once I had 10 <i>very small</i> MK more.  I love ATtiny13 - cheap and cheerful.  When I bought them, I firmly remembered that they had <i>‚ÄúEven an ADC, not like a timer!‚Äù,</i> And I was very happy about their low price. <br>  However, when I confronted ATtiny13 with a real task, it turned out that there was no one very important thing in it, namely, <b>interfaces for data transmission</b> (of course, not counting GPIO).  <i>Well, if there is a GPIO, then you can write anything!</i>  I thought and went to google ... And I didn‚Äôt googled a beautiful ready-made solution for avr-gcc ... I‚Äôm looking for a (hopefully) such solution, this article is welcome under cat. <br><a name="habracut"></a><br>  In fact, there were about three options, but in <a href="http://habrahabr.ru/post/237543/">one they</a> write in BASIC (I didn‚Äôt even know what I could do), in the <a href="http://www.getchip.net/posts/046-programmnyjj-uart-dlya-attiny13/">other one</a> under CVAVR (hello to my first blinking LED) and in general there is a whole semantic code in a terrible assembler, but the <a href="http://we.easyelectronics.ru/AVR/uart-programmnyy-na-atiny13a.html">third</a> one It seems to be suitable ... But some very strange code ... But it earned a spolpink.  But zhiirny ... <br><blockquote>  Program Memory Usage: 508 bytes 49.6% Full </blockquote><br>  Well, okay, the main thing is working and holding, and there it is already possible to both read and refactor ... JumpStart took place - this is the main thing. <br><br><img src="https://habrastorage.org/files/bae/38e/6c3/bae38e6c38dc4c80b23b37e6de876829.JPG"><br><br>  After a thoughtful reading of the code, it becomes clear that its author deserves deep respect ... This code is similar to the code of a person who is programming VERY recently, and the task is solved quite powerful.  It works the same.  I really wanted for beginners to describe a few trivial errors, but after the third one I realized that it was very offtopic, so, alas ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://pastebin.com/NBFMq1C6">In the original</a> , the code was engaged in receiving and sending data, but in reality, my task does not require reception (especially in the main loop).  It's enough for me to just catch Pin Change Interrupt on any leg and spit out the results of A-&gt; D conversion.  According to this, in order to lose weight, it was decided to cut a technique.  This is what happened after not very long and not very thoughtful refactoring: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> F_CPU 9600000UL #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/io.h&gt; #include &lt;avr/interrupt.h&gt; #include &lt;util/delay.h&gt; uint8_t temp, count, start; volatile uint8_t c; #define BAUD_C 123 #define TxD PB4 #define T_START TCCR0B = (1 &lt;&lt; CS01) // F_CPU/8 #define T_STOP TCCR0B = 0 #define T_RESET TCNT0 = 0 ISR(TIM0_COMPA_vect){ OCR0A = BAUD_C; c = 1; T_RESET; } void send(uint8_t data) { //   "lov"? 0_ if (count &gt;= 8) { PORTB |= (1&lt;&lt;TxD); start = 0; temp = 0; c = 0; count = 0; T_STOP; OCR0A = 0; return; } if(c == 1) { if (start == 0) { temp = 0x80; start = 1; count--; } else { temp = data; temp = temp &gt;&gt; count; temp = temp &lt;&lt; 7; } switch(temp) { case 0x80 : PORTB &amp;= ~(1 &lt;&lt; TxD); break; case 0 : PORTB |= (1 &lt;&lt; TxD); break; } count++; c = 0; } } void send_ch(uint8_t data){ uint8_t f; data = ~data; T_START; for(f = 0; f &lt; 10; f++){ while(c == 0); send(data); } }</span></span></span></span></code> </pre> <br><br>  I do not want to think much, so I left the whole semantic part as it is, threw out the superfluous and corrected vyrvlazlaznye things like <i>TIMSK0 = 0x04</i> .  I really liked the spacing implementation in this code!  All hemorrhoids with the calculation of constants for baud rate are reduced to one number BAUD_C, which is chosen almost experimentally and corrected depending on the inaccuracies of quartz (the author had it equal to 115 and seemed to work quite accurately on the screenshot. Is it possible at all such a hard floating? ).  Most likely, this is not the most optimal, reliable and correct <s>bla bla bla bla</s> solution, but it seems to me very simple and beautiful! <br>  Well, what is the result? <br><blockquote>  Program Memory Usage: 304 bytes 29.7% Full </blockquote><br>  <i>‚ÄúFuh, we live.</i>  <i>There is also enough on the ADC ... ‚Äù</i> But in general, this is not the end.  Now the code is able to transfer only one character, but it is necessary to transfer lines and values ‚Äã‚Äãof registers.  So, time to rummage in old projects!  This task is no longer specific for MK without UART and has been solved repeatedly. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_str</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *text)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(*text) { send_ch(*text++); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">itoa</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s[])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { s[i++] = n % <span class="hljs-number"><span class="hljs-number">10</span></span> + <span class="hljs-string"><span class="hljs-string">'0'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((n /= <span class="hljs-number"><span class="hljs-number">10</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); s[i] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Reversing uint8_t j; char c; for (i = 0, j = strlen(s)-1; i&lt;j; i++, j--) { c = s[i]; s[i] = s[j]; s[j] = c; } } void send_num(char *text, uint16_t n){ char s[6]; itoa((uint16_t)n, s); send_str(text); send_str(s); }</span></span></code> </pre><br><br>  It is very convenient to send numbers at once with explanations of what these numbers are, therefore <i>send_num (char * text, uint16_t n)</i> . <br>  And, taking into account the example of use: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{ DDRB |= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; TxD); TIMSK0 = (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; OCIE0A); sei(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>){ _delay_ms(<span class="hljs-number"><span class="hljs-number">1</span></span>); send_num(<span class="hljs-string"><span class="hljs-string">"Habr:"</span></span>, <span class="hljs-number"><span class="hljs-number">4242</span></span>); } }</code> </pre><br><br>  Turns out <br><blockquote>  Program Memory Usage: 538 bytes 52.5% Full </blockquote><br>  Slightly more than the original.  But how much more useful! <br><img src="//habrastorage.org/files/389/36c/6fa/38936c6fa91942afb47dc16c062bf2a8.JPG"><br><br>  I want to immediately warn you that the goal to make a beautiful and popular article was not.  It was written very quickly, it was re-read very little and may contain very errors.  Please do not troll - I'll fix everything.  The main thing is that this problem ceases to exist and everyone who wants to build their sensor on ATtiny13 should have a ready solution for the interface. <br><br>  PS: At first I looked at I2C and even <a href="https://github.com/AinonLynx/twi-slave-software-emulation">found a</a> very promising repository, but did not understand why Atmel Studio says overflow.  It would be cool to write down this interface on t13 - it might even get worse ... But this is not me. <br><br>  PSS: <a href="http://www.aliexpress.com/wholesale%3FcatId%3D0%26initiative_id%3DSB_20150603074040%26SearchText%3DUSB%2BLogic%2BAnalyzer%2B24M%2B8CH%2BMCU%2BARM%2BFPGA%2BDSP">My logic analyzer</a> .  He is gorgeous! </div><p>Source: <a href="https://habr.com/ru/post/250995/">https://habr.com/ru/post/250995/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250979/index.html">CxxMock - Mock Objects in C ++</a></li>
<li><a href="../250981/index.html">HTML5 MathMl</a></li>
<li><a href="../250985/index.html">Custom PHP Project Optimization</a></li>
<li><a href="../250989/index.html">Receive radio footage and other digital transmissions using a conventional receiver and computer</a></li>
<li><a href="../250991/index.html">The Equation, Carbanak, Desert Falcons: Report with Security Analyst Summit</a></li>
<li><a href="../250997/index.html">Plotting in LaTeX / PGFPlots</a></li>
<li><a href="../250999/index.html">Recover local and domain passwords from hiberfil.sys</a></li>
<li><a href="../251001/index.html">Weekly io.js, February 13, 2015</a></li>
<li><a href="../251007/index.html">Handling large packed files on Mac and more</a></li>
<li><a href="../251011/index.html">Android users will pay for the words, Nintendo will release an application for iOS, Rovio will print a book - and other news of the week for a mobile developer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>