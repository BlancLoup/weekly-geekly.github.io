<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>React.js: build an isomorphic / universal application from scratch. Part 3: we add authorization and data exchange with API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Please login 


 This is the third and final part of the article about developing an isomorphic React.js application from scratch. Parts one and two ....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>React.js: build an isomorphic / universal application from scratch. Part 3: we add authorization and data exchange with API</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a55/496/2d2/a554962d267a41e0ab5f07767015229a.jpg"><br><p>  <em>Please login</em> </p><br><p>  This is the third and final part of the article about developing an isomorphic React.js application from scratch.  Parts <a href="https://habrahabr.ru/post/309958/">one</a> and <a href="https://habrahabr.ru/post/310284/">two</a> . </p><br><p>  In this part we: </p><br><ul><li>  add <em>redux-dev-tools</em> ; </li><li>  add requests to the API; </li><li>  we realize authorization; </li><li>  We implement the execution of API requests in the <em>Server-Side Rendering</em> process. </li></ul><a name="habracut"></a><br><h1 id="1-dobavlyaem-redux-dev-tools">  1. Add <em>redux-dev-tools</em> </h1><br><p>  This is a very handy library that simplifies the development process.  With it, you can see in real time the contents of the global state, as well as its changes.  Additionally, <em>redux-dev-tools</em> allows you to roll back the latest changes in the global state, which is convenient during testing and debugging.  To us, it will add visibility and make the learning process more interactive and transparent. </p><br><h3 id="11-ustanavlivaem-neobhodimye-pakety">  1.1.  Install the necessary packages </h3><br><pre><code class="bash hljs">npm i --save-dev redux-devtools redux-devtools-log-monitor redux-devtools-dock-monitor</code> </pre> <br><h3 id="12-realizuem-komponent-otvechayuschiy-za-rendering-paneli-redux-dev-tools">  1.2.  Implement the component responsible for rendering the <em>redux-dev-tools</em> panel </h3><br><h4 id="srccomponentsdevtoolsdevtoolsjsx">  src / components / DevTools / DevTools.jsx </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { createDevTools } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-devtools'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LogMonitor <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-devtools-log-monitor'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DockMonitor <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-devtools-dock-monitor'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> createDevTools( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DockMonitor</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">toggleVisibilityKey</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'ctrl-h'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">changePositionKey</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'ctrl-q'</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LogMonitor</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DockMonitor</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> );</code> </pre> <br><h4 id="srccomponentsdevtoolsindexjs">  src / components / DevTools / index.js </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DevTools <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./DevTools'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> DevTools;</code> </pre> <br><h3 id="13-pricheshem-rootreducer">  1.3.  "Comb" <em>rootReducer</em> </h3><br><p>  In the second part, we put the creation of the root reducer in the <em>configureStore</em> , which is not entirely correct, since this is not his area of ‚Äã‚Äãresponsibility.  Let's do a little refactoring and transfer it to <em>redux / reducers / index.js</em> . </p><br><h4 id="reduxreducersindexjs">  redux / reducers / index.js </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { combineReducers } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> counterReducer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./counterReducer'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> combineReducers({ <span class="hljs-attr"><span class="hljs-attr">counter</span></span>: counterReducer });</code> </pre> <br><p>  From the <em>redux-dev-tools</em> documentation it follows that we need to make changes to <em>configureStore</em> .  Recall that the <em>redux-dev-tools tools</em> are needed only for development, so we repeat the maneuver described earlier: </p><br><ol><li>  rename <em>configureStore.js</em> to <em>configureStore.prod.js</em> ; </li><li>  implement <em>configureStore.dev.js</em> ; </li><li>  we implement <em>configureStore.js</em> , which, depending on the system landscape, uses either <em>configureStore.prod.js</em> or <em>configureStore.dev.js</em> . </li></ol><br><pre> <code class="bash hljs">mv redux/configureStore.js redux/configureStore.prod.js</code> </pre> <br><h4 id="srcreduxconfigurestoreprodjs">  src / redux / configureStore.prod.js </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { applyMiddleware, createStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> thunk <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-thunk'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> rootReducer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./reducers'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">initialState = {}</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> createStore(rootReducer, initialState, applyMiddleware(thunk)); }</code> </pre> <br><p>  Implement <em>configureStore.dev.js</em> with <em>DevTools</em> and <a href="https://facebook.github.io/react-native/blog/2016/03/24/introducing-hot-reloading.html"><em>hot-reload</em></a> support. </p><br><h4 id="srcreduxconfigurestoredevjs">  src / redux / configureStore.dev.js </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { applyMiddleware, createStore, compose } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> thunk <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-thunk'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DevTools <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'components/DevTools'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> rootReducer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./reducers'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">initialState = {}</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = createStore(rootReducer, initialState, compose( applyMiddleware(thunk), DevTools.instrument() ) ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.hot) { <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.hot.accept(<span class="hljs-string"><span class="hljs-string">'./reducers'</span></span>, () =&gt; store.replaceReducer(<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./reducers'</span></span>).default) ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> store; }</code> </pre> <br><p>  <em>ConfigureStore</em> Entry Point </p><br><h4 id="srcreduxconfigurestorejs">  src / redux / configureStore.js </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (process.env.NODE_ENV === <span class="hljs-string"><span class="hljs-string">'production'</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./configureStore.prod'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./configureStore.dev'</span></span>); }</code> </pre> <br><p>  All is ready!  Restart the <em>webpack-dev-server</em> and <em>nodemon</em> , open the browser and see that a panel appears on the right that reflects the contents of the global state.  Now open the page with the counters and <em>click</em> on the <em>ReduxCounter</em> .  At the same time, with each click, we see how actions arrive in the <em>redux</em> queue and the global state changes.  By clicking on <em>Revert</em> , we can undo the last action, and by clicking on <em>Commit</em> - approve all actions and clear the current command queue. </p><br><p>  <em>Note:</em> after adding <em>redux-dev-tools</em> , you may see a message in the console: <em>"React attempted to be reused ..."</em> .  This means that the server and client parts of the application render different content.  This is very bad and should be avoided in your applications.  However, in this case, the culprit is <em>redux-dev-tools</em> , which we will not use in production anyway, so you can make an exception and safely ignore the problem report. </p><br><p>  <em>Update: thanks to users of <a href="https://github.com/gialdeyn">gialdeyn</a> and <a href="https://habrahabr.ru/users/lerayne/" class="user_link">Lerayne</a> , you can repair SSR with redux-dev-tools in the following way</em> </p><br><h4 id="srcserverjs">  src / server.js </h4><br><pre> <code class="javascript hljs">&lt;div id=<span class="hljs-string"><span class="hljs-string">"react-view"</span></span>&gt;${componentHTML}&lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; +++ &lt;div id="dev-tools"&gt;&lt;/</span></span>div&gt;</code> </pre> <br><h4 id="srcclientjs">  src / client.js </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DevTools <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./components/DevTools'</span></span>; ... ReactDOM.render(component, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'react-view'</span></span>)); +++ ReactDOM.render(<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DevTools</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">store</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{store}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml">, document.getElementById('dev-tools'));</span></span></code> </pre> <br><h1 id="2-dobavlyaem-novuyu-funkcionalnost">  2. Add new functionality </h1><br><p>  Implement the following script </p><br><ol><li>  The user clicks the "Request time" button. </li><li>  We show the download indicator, the button becomes inactive to avoid unwanted repeated requests. </li><li>  The application makes a request to the API. </li><li>  The application receives a response from the API and saves the received data to a global state. </li><li>  The download indicator disappears, the button becomes active again;  we display the data to the user. </li></ol><br><p>  This is a fairly voluminous task.  To focus on its individual parts, we first implement items 1, 2 and 5, and for 3 and 4 we will make a stub. </p><br><h2 id="21-dobavlyaem-deystviya">  2.1.  Add actions </h2><br><p>  After clicking on the "Request time" button, we must successively: </p><br><ol><li>  change the <em>loading</em> value from <em>false</em> to <em>true</em> ; </li><li>  make a request; </li><li>  after receiving the response, return the <em>loading</em> value from <em>true</em> to <em>false</em> back and save either the received data or error information. </li></ol><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TIME_REQUEST_STARTED = <span class="hljs-string"><span class="hljs-string">'TIME_REQUEST_STARTED'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TIME_REQUEST_FINISHED = <span class="hljs-string"><span class="hljs-string">'TIME_REQUEST_FINISHED'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TIME_REQUEST_ERROR = <span class="hljs-string"><span class="hljs-string">'TIME_REQUEST_ERROR'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timeRequestStarted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: TIME_REQUEST_STARTED }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timeRequestFinished</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">time</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: TIME_REQUEST_FINISHED, time }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timeRequestError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">errors</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: TIME_REQUEST_ERROR, errors }; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timeRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch</span></span></span><span class="hljs-function">) =&gt;</span></span> { dispatch(timeRequestStarted()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> dispatch(timeRequestFinished(<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now())), <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  network latency :) }; }</span></span></code> </pre> <br><p>  Here we <em>arrange</em> each action in the form of a small function that will change the global state, and <em>timeRequest</em> is a combination of these functions, which fully describes our script.  That is what we will call from our component. </p><br><h2 id="22-obnovlyaem-kod-stranicy-so-vremenem">  2.2.  Update the page code over time </h2><br><p>  Add the <em>react-bootstrap-button-loader button</em> with support for the download indicator on the <em>TimePage</em> page and teach it to call the <em>timeRequest</em> function by clicking. </p><br><h3 id="ustanavlivaem-paket-react-bootstrap-button-loader">  Install the <em>react-bootstrap-button-loader</em> package </h3><br><pre> <code class="bash hljs">npm i --save react-bootstrap-button-loader</code> </pre> <br><h3 id="dobavlyaem-knopku-i-obrabotchik-klikov">  Add a button and click handler </h3><br><h4 id="srccomponentstimepagetimepagejsx">  src / components / TimePage / TimePage.jsx </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, { Component, PropTypes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-redux'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PageHeader <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/lib/PageHeader'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Button <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap-button-loader'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { timeRequest } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux/actions/timeActions'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> propTypes = { <span class="hljs-attr"><span class="hljs-attr">dispatch</span></span>: PropTypes.func.isRequired }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TimePage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleClick = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleClick.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } handleClick() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.dispatch(timeRequest()); } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">PageHeader</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Timestamp</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">PageHeader</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleClick}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">!</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); } } TimePage.propTypes = propTypes; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> connect()(TimePage);</code> </pre> <br><p>  Note that we had to use <em>connect</em> from <em>react-redux</em> in order for our button to have access to the <em>dispatch</em> function to change the global state. </p><br><p>  It's time to look at the results of works: open the "Time" page in the browser, click on the "Request" button.  The interface is not doing anything yet, but in <em>redux-dev-tools</em> we now see how the <em>actions</em> that we have recently implemented are launched. </p><br><p>  It is time to revive the interface.  Start by implementing logic to update the global state. </p><br><h2 id="23-realizuem-redyuser">  2.3.  We realize a reducer </h2><br><h4 id="srcreduxreducerstimereducerjs">  src / redux / reducers / timeReducer.js </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { TIME_REQUEST_STARTED, TIME_REQUEST_FINISHED, TIME_REQUEST_ERROR } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux/actions/timeActions'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> initialState = { <span class="hljs-attr"><span class="hljs-attr">time</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">errors</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">loading</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state = initialState, action</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (action.type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> TIME_REQUEST_STARTED: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({}, state, { <span class="hljs-attr"><span class="hljs-attr">loading</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">errors</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> TIME_REQUEST_FINISHED: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">loading</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">errors</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">time</span></span>: action.time }; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> TIME_REQUEST_ERROR: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({}, state, { <span class="hljs-attr"><span class="hljs-attr">loading</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">errors</span></span>: action.errors }); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state; } }</code> </pre> <br><p>  An important point that should not be forgotten: according to the <em>redux</em> specification <em>,</em> we have no right to change the state passed to us and must return either its own or a new object.  To form a new object, I use <em>Object.assign</em> , which takes the original object and applies the changes I need to it. </p><br><p>  Ok, now let's add a new reducer to the root reducer. </p><br><h4 id="srcreduxreducersindexjs">  src / redux / reducers / index.js </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> timeReducer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./timeReducer'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> combineReducers({ <span class="hljs-attr"><span class="hljs-attr">counter</span></span>: counterReducer, +++ time: timeReducer });</code> </pre> <br><p>  Open the browser again and, after clearing the <em>redux-dev-tools</em> queue, click on the "Request" button.  The interface is still not being updated, but now our <em>actions</em> change the global state according to the code of our reducer, which means that under the hood, all the logic works as it should.  Things are easy - we will revive the interface. </p><br><h2 id="24-obnovlyaem-kod-stranicy-vremya">  2.4.  Update the code of the page "Time" </h2><br><h4 id="srccomponentstimepagetimepagejsx-1">  src / components / TimePage / TimePage.jsx </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> propTypes = { <span class="hljs-attr"><span class="hljs-attr">dispatch</span></span>: PropTypes.func.isRequired, +++ loading: PropTypes.bool.isRequired, +++ time: PropTypes.any }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TimePage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ ... render() { +++ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { loading, time } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; ... --- <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleClick}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">!</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> +++ <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">loading</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{loading}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleClick}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">!</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> +++ {time &amp;&amp; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Time: {time}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ); } } +++ function mapStateToProps(state) { +++ const { loading, time } = state.time; +++ return { loading, time }; +++ } --- export default connect()(TimePage); +++ export default connect(mapStateToProps)(TimePage);</span></span></code> </pre> <br><p>  Go to the browser, again click on the "Request" button and make sure that everything works according to our script. </p><br><p>  It is time to replace the stub with a real <em>backend</em> . </p><br><h1 id="3-dobavlyaem-vzaimodeystvie-s-backend-i-avtorizaciyu">  3. Add interaction with <em>backend</em> and authorization </h1><br><p>  <em>Note:</em> for this example, I use a very simple <em>backend</em> , developed by me on <em>rails</em> .  It is available at <em><a href="https://redux-oauth-backend.herokuapp.com/">https://redux-oauth-backend.herokuapp.com</a></em> and contains only one <em>/ test / test</em> method, which returns the server <em>timestamp</em> if the user is authorized, otherwise 401 error.  The source code for <em>backend</em> 'can be found here: <a href="https://github.com/yury-dymov/redux-oauth-backend-demo">https://github.com/yury-dymov/redux-oauth-backend-demo</a> .  There, I use <em>gem devise</em> for authentication, which is de facto the standard for solving similar problems for <em>rails</em> and <em>gem devise_token_auth</em> , which adds a <em>devise to</em> the authentication mechanism of <em>Bearer Token-based Authentication</em> .  Nowadays, this mechanism is most often used when developing secure APIs. </p><br><p>  From the client side, we have much to do: </p><br><ol><li>  From the previous article, I still have a small debt: the global state after <em>Server Side Rendering is</em> not transferred or used by the client.  We will fix it now. </li><li>  Add a <em>redux-oauth</em> library to the project, which is responsible for authorization by the <em>frontend</em> , and configure it for an isomorphic script. </li><li>  Replace the stub with the code that will actually perform requests to the API. </li><li>  Add the "Login to system" and "Logout" buttons. </li></ol><br><h2 id="31-peredaem-globalnoe-sostoyanie">  3.1.  Pass a global state </h2><br><p>  The mechanism is very simple: </p><br><ol><li>  After the server has done all the work and has generated content for the client, we call the <em>getState</em> function, which returns the current global state.  Next, we transfer the content and global state to our HTML template and give the resulting page to the client. </li><li>  Client-side <em>JavaScript</em> reads the global state directly from the global <em>window</em> object and passes it to the <em>configureStore</em> as the <em>initialState</em> . </li></ol><br><h4 id="srcserverjs-1">  src / server.js </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> state = store.getState(); --- <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.end(renderHTML(componentHTML)); +++ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.end(renderHTML(componentHTML, state)); ... --- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderHTML</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">componentHTML, initialState</span></span></span><span class="hljs-function">) </span></span>{ +++ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderHTML</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">componentHTML, initialState</span></span></span><span class="hljs-function">) </span></span>{ &lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"${assetUrl}/public/assets/styles.css"</span></span>&gt; +++ <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"application/javascript"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> +++ </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">window</span></span></span></span><span class="xml"><span class="javascript">.REDUX_INITIAL_STATE = ${</span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">JSON</span></span></span></span><span class="xml"><span class="javascript">.stringify(initialState)}; +++ </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/head&gt;</span></span></code> </pre> <br><h4 id="srcclientjs-1">  src / client.js </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> initialState = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.REDUX_INITIAL_STATE || {}; --- <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = configureStore(); +++ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = configureStore(initialState);</code> </pre> <br><p>  As you can see from the code, I pass the global state in the variable REDUX_INITIAL_STATE. </p><br><h2 id="32-dobavlyaem-avtorizaciyu">  3.2.  Add authorization </h2><br><p>  Install <em>redux-oauth</em> </p><br><p>  <em>Note:</em> we use <em>redux-oauth</em> for an isomorphic script, but it also supports <em>client-side only</em> .  Configuration examples for various cases and demos can be found on <a href="https://github.com/yury-dymov/redux-oauth">the library website</a> . </p><br><p>  <em>Note 2:</em> <em>redux-oauth</em> uses cookies for authorization, since the <em>local storage</em> mechanism is not suitable for an isomorphic scenario. </p><br><pre> <code class="bash hljs">npm i --save redux-oauth cookie-parser</code> </pre> <br><p>  Activate <em>cookieParser</em> plugin for <em>express</em> </p><br><h4 id="srcserverjs-2">  src / server.js </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cookieParser <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'cookie-parser'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = express(); +++ app.use(cookieParser());</code> </pre> <br><p>  <em>We configure redux-oauth</em> for server part of the application </p><br><h4 id="srcserverjs-3">  src / server.js </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getHeaders, initialize } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-oauth'</span></span>; app.use(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = configureStore(); +++ store.dispatch(initialize({ +++ backend: { +++ apiUrl: <span class="hljs-string"><span class="hljs-string">'https://redux-oauth-backend.herokuapp.com'</span></span>, +++ authProviderPaths: { +++ github: <span class="hljs-string"><span class="hljs-string">'/auth/github'</span></span> +++ }, +++ signOutPath: <span class="hljs-literal"><span class="hljs-literal">null</span></span> +++ }, +++ currentLocation: req.url, +++ cookies: req.cookies })).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> match({ routes, <span class="hljs-attr"><span class="hljs-attr">location</span></span>: req.url }, (error, redirectLocation, renderProps) =&gt; { ... const state = store.getState(); +++ res.cookie(<span class="hljs-string"><span class="hljs-string">'authHeaders'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(getHeaders(state)), { <span class="hljs-attr"><span class="hljs-attr">maxAge</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now() + <span class="hljs-number"><span class="hljs-number">14</span></span> * <span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.end(renderHTML(componentHTML, state)); }));</code> </pre> <br><p>  Many interesting things happen here: </p><br><ol><li>  We have to call the <em>initialize</em> function from <em>redux-oauth</em> , which will pass the current <em>URL</em> , <em>cookies</em> and configuration: the address of the API and the <em>OAuth</em> providers used. </li><li>  If an authentication <em>token</em> is found in the transmitted <em>cookies</em> , the library will check its validity at the <em>backend</em> and, if successful, save the user information in a global state.  Note that further application code will be executed only after the <em>initialize has completed</em> . </li><li>  Before sending HTML to the client, we use the <em>res.cookie</em> method.  This method tells <em>express</em> that you need to add a <em>SetCookie</em> header to the HTTP response, in which you need to send the updated authorization token.  This is a very important step: the new authorization token will be saved in the <em>browser cookie</em> immediately after it receives a response from the server.  Thus, we guarantee that authorization will not break even in cases when client-side <em>JavaScript</em> did not have time to download, initialize, or run with an error. </li></ol><br><p>  According to the documentation, we also need to add redux <em>reducer-oauth</em> to the root reducer. </p><br><h4 id="srcreduxreducersindexjs-1">  src / redux / reducers / index.js </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { authStateReducer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-oauth'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> combineReducers({ +++ auth: authStateReducer,</code> </pre> <br><h2 id="33-zamenyaem-zaglushku-v-timeactionsjs">  3.3.  Replace the stub in <em>timeActions.js</em> </h2><br><h4 id="srcreduxactionstimeactionsjs">  src / redux / actions / timeActions.js </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { fetch, parseResponse } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-oauth'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timeRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch</span></span></span><span class="hljs-function">) =&gt;</span></span> { dispatch(timeRequestStarted()); --- <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> dispatch(timeRequestFinished(<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now())), <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  network latency :) +++ return dispatch(fetch('https://redux-oauth-backend.herokuapp.com/test/test')) +++ .then(parseResponse) +++ .then(({ payload }) =&gt; dispatch(timeRequestFinished(payload.time))) +++ .catch(({ errors }) =&gt; dispatch(timeRequestError(errors))); }; }</span></span></code> </pre> <br><p>  The <em>fetch</em> function from <em>redux-oauth</em> is an extended function from the <em>isomorphic-fetch</em> package.  According to the documentation, it is necessary to call it via <em>dispatch</em> , since in this case it will have access to a global state, from which it can read the authorization token and send it along with the request.  If the <em>fetch</em> function is used for an arbitrary HTTP request, rather than a request to the API, then the authorization token will not be used, that is, the algorithm for its execution will be 100% identical to the algorithm for the <em>isomorphic-fetch</em> execution. </p><br><p>  <em>Note:</em> <a href="https://github.com/matthew-andrews/isomorphic-fetch"><em>isomorphic-fetch</em></a> is a library that can make HTTP requests from both the browser and the <em>Node</em> environment. </p><br><p>  Open the browser and once again click on the "Request" button of the "Time" page.  Well, we no longer see the current <em>timestamp</em> , but <em>redux-dev-tools</em> has information about a 401 error.  It is not surprising, because we have to be authorized in order for the API to return something to us. </p><br><h2 id="34-dobavim-knopki-voyti-i-vyyti">  3.4.  Add the "Login" and "Exit" buttons </h2><br><p>  As a rule, an authorized user has more opportunities to work with the system than a guest, otherwise what is the point of authorization? </p><br><p>  From a technical point of view, this means that many components may look and behave differently depending on whether the user has logged on or not. </p><br><p>  I am an ardent supporter of the <em>DRY</em> principle <em>(don't repeat yourself)</em> , so we will write a small helper. </p><br><h4 id="srcreduxmodelsuserjs">  src / redux / models / user.js </h4><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isUserSignedIn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.auth.getIn([<span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'isSignedIn'</span></span>]); }</code> </pre> <br><p>  Implement the button "Login" </p><br><h4 id="srccomponentsauthbuttonsoauthbuttonjsx">  src / components / AuthButtons / OAuthButton.jsx </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, { Component, PropTypes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-redux'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { oAuthSignIn } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-oauth'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Button <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap-button-loader'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { isUserSignedIn } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux/models/user'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> propTypes = { <span class="hljs-attr"><span class="hljs-attr">dispatch</span></span>: PropTypes.func.isRequired, <span class="hljs-attr"><span class="hljs-attr">loading</span></span>: PropTypes.bool.isRequired, <span class="hljs-attr"><span class="hljs-attr">provider</span></span>: PropTypes.string.isRequired, <span class="hljs-attr"><span class="hljs-attr">userSignedIn</span></span>: PropTypes.bool.isRequired }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OAuthButton</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(props) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(props); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleClick = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleClick.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } handleClick() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { dispatch, provider } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; dispatch(oAuthSignIn({ provider })); } render() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { loading, provider, userSignedIn } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userSignedIn) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">loading</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{loading}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleClick}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{provider}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } } OAuthButton.propTypes = propTypes; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapStateToProps</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, ownProps</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> loading = state.auth.getIn([<span class="hljs-string"><span class="hljs-string">'oAuthSignIn'</span></span>, ownProps.provider, <span class="hljs-string"><span class="hljs-string">'loading'</span></span>]) || <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">userSignedIn</span></span>: isUserSignedIn(state), loading }; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> connect(mapStateToProps)(OAuthButton);</code> </pre> <br><p>  This button will be displayed only if the user has not yet logged in. </p><br><p>  Implement the "Logout" button </p><br><h4 id="srccomponentsauthbuttonssignoutbuttonjsx">  src / components / AuthButtons / SignOutButton.jsx </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, { Component, PropTypes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-redux'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { signOut } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-oauth'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Button <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap-button-loader'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { isUserSignedIn } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux/models/user'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> propTypes = { <span class="hljs-attr"><span class="hljs-attr">dispatch</span></span>: PropTypes.func.isRequired, <span class="hljs-attr"><span class="hljs-attr">userSignedIn</span></span>: PropTypes.bool.isRequired }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SignOutButton</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(props) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(props); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleClick = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleClick.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } handleClick() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { dispatch } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; dispatch(signOut()); } render() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.userSignedIn) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleClick}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } } SignOutButton.propTypes = propTypes; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapStateToProps</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">userSignedIn</span></span>: isUserSignedIn(state) }; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> connect(mapStateToProps)(SignOutButton);</code> </pre> <br><p>  This button will be displayed only if the user is already logged in. </p><br><h4 id="srccomponentsauthbuttonsindexjs">  src / components / AuthButtons / index.js </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> OAuthButton <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./OAuthButton'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SignOutButton <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./SignOutButton'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> { OAuthButton, SignOutButton };</code> </pre> <br><p>  I will add authorization to the <em>HelloWorldPage</em> page. </p><br><h4 id="srccomponentshelloworldpagehelloworldpagejsx">  src / components / HelloWorldPage / HelloWorldPage.jsx </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { OAuthButton, SignOutButton } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'components/AuthButtons'</span></span>; +++ <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> +++ <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">OAuthButton</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">provider</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'github'</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> +++ </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">SignOutButton</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span></span></code> </pre> <br><p>  It is time to enjoy the results of our work.  We click on the "Login" button, use our github account for authorization and ... we are in the system!  The "Enter" button has disappeared, but the "Exit" button has appeared.  Check that the session is saved, for this we reload the page.  The "Exit" button has not disappeared, and in <em>redux-dev-tools</em> you can find user information  Fine!  While everything works.  Go to the "Time" page, click on the "Request" button and see that the <em>timestamp is</em> displayed - this is the server returned the data to us. </p><br><p>  This could be finished, but we need to "polish" our application. </p><br><h1 id="4-shlifuem-prilozhenie">  4. "Grind" the application </h1><br><p>  So what can be improved: </p><br><ol><li>  Links to the "Time" page should be displayed only for authorized users. </li><li>  If the user entered the address of the protected page in the browser, we will redirect it to the page with authorization (in our case, <em>HelloWorldPage</em> ). </li><li>  If a user is logged out, we must remove his data from the global state. </li></ol><br><h2 id="41-ubiraem-ssylki-k-nedostupnym-stranicam">  4.1.  We remove links to inaccessible pages. </h2><br><h4 id="srccomponentsappappjsx">  src / components / App / App.jsx </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-redux'</span></span>; +++ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { isUserSignedIn } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux/models/user'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> propTypes = { +++ userSignedIn: PropTypes.bool.isRequired, ... }; ... +++ {<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.userSignedIn &amp;&amp; ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LinkContainer</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'/time'</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">NavItem</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">NavItem</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LinkContainer</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> +++ )} ... +++ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapStateToProps</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">) </span></span>{ +++ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">userSignedIn</span></span>: isUserSignedIn(state) }; +++ } --- <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> App; +++ <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> connect(mapStateToProps)(App);</code> </pre><br><p>  Open the browser and see that the link to the "Time" page is still available, go to the <em>HelloWorldPage</em> page, click on the "Exit" button - and the link is gone. </p><br><h2 id="42-ogranichivaem-dostup-k-zaschischennym-stranicam">  4.2.  Restrict access to secure pages </h2><br><p>  As we remember, the <em>react-router</em> library is responsible for the correspondence between the <em>URL</em> and the page to be rendered, and the configuration of the paths is in the <em>routes.jsx</em> file.  We need to add the following logic: if the user is unauthorized and requested a secure page, then redirect him to <em>HelloWorldPage</em> . </p><br><p>  To get information about the user, we need to <em>send a</em> link to the global state storage in <em>routes.jsx</em> </p><br><h4 id="srcserverjs-4">  src / server.js </h4><br><pre> <code class="javascript hljs">--- .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> match({ routes, <span class="hljs-attr"><span class="hljs-attr">location</span></span>: req.url }, (error, redirectLocation, renderProps) =&gt; { +++ .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> match({ <span class="hljs-attr"><span class="hljs-attr">routes</span></span>: routes(store), <span class="hljs-attr"><span class="hljs-attr">location</span></span>: req.url }, (error, redirectLocation, renderProps) =&gt; {</code> </pre> <br><h4 id="srcclientjs-2">  src / client.js </h4><br><pre> <code class="javascript hljs">&lt;Router history={browserHistory}&gt; --- {routes} +++ {routes(store)} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/Router&gt;</span></span></code> </pre> <br><h4 id="srcroutesjsx">  src / routes.jsx </h4><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { isUserSignedIn } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux/models/user'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requireAuth</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">nextState, transition, cb</span></span></span><span class="hljs-function">) </span></span>{ setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isUserSignedIn(store.getState())) { transition(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); } cb(); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> store; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">routes</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">storeRef</span></span></span><span class="hljs-function">) </span></span>{ store = storeRef; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( &lt;Route component={App} path='/'&gt; &lt;IndexRoute component={HelloWorldPage} /&gt; &lt;Route component={CounterPage} path='counters' /&gt; &lt;Route component={TimePage} path='time' onEnter={requireAuth} /&gt; &lt;/Route&gt; ); }</code> </pre> <br><p>  Testing: </p><br><ol><li>  Make sure that we are logged in; </li><li>  Enter <a href="http://localhost:3001/time">http: // localhost: 3001 / time</a> into the address bar of the browser, press "Enter" and as expected we will see the "Time" page; </li><li>  Log out; </li><li>  Once again, enter <a href="http://localhost:3001/time">http: // localhost: 3001 / time</a> in the address bar of the browser and press "Enter" - this time we were redirected to the <em>"HelloWorldPage"</em> page - everything works! </li></ol><br><p>  <em>Note:</em> the <em>requireAuth</em> function uses zero delay <em>setTimeout</em> , which at first glance makes no sense.  This is done on purpose, as it allows you to bypass the bug in one of the popular browsers. </p><br><h2 id="43-ochischaem-polzovatelskie-dannye-iz-globalnogo-sostoyaniya">  4.3.  Clearing user data from global state </h2><br><h4 id="srcreduxreducerstimereducerjs-1">  src / redux / reducers / timeReducer.js </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { SIGN_OUT } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'redux-oauth'</span></span>; +++ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SIGN_OUT: +++ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> initialState; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state;</code> </pre> <br><p>  If <em>action SIGN_OUT is received</em> , then all timeReducer <em>reducer</em> data will be replaced with <em>initialState</em> , that is, with default values.  The same technique must be implemented for all other reducers that contain user data. </p><br><h1 id="5-bonus-server-side-api-requests">  5. Bonus: <em>Server-Side API Requests</em> </h1><br><p>  The <em>redux-oauth library</em> supports <em>Server Side API requests</em> , that is, during the rendering process, the server can access the API for data.  This has many advantages: </p><br><ul><li>  The server is much closer to the API, which means the user will get access to the content faster </li><li>  For low-quality mobile Internet, reducing the number of requests is crucial in terms of performance due to the large <em>latency of</em> each request; </li><li>  search engines do not know how or poorly able to <em>JavaScript</em> , which means that otherwise they will not get access to the full content. </li></ul><br><p>  <em>Note</em> : yes, search engines will not be authorized, but some API services will be able to return data for unauthorized users with some restrictions.  <em>redux-oauth is</em> suitable for such scenarios. </p><br><p>  We implement a small <em>Proof of Concept</em> . </p><br><p>    API      </p><br><h4 id="srcserverjs-5"> src/server.js </h4><br><pre> <code class="javascript hljs">+++ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { timeRequest } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./redux/actions/timeActions'</span></span>; ... return store.dispatch(initialize({ <span class="hljs-attr"><span class="hljs-attr">backend</span></span>: { <span class="hljs-attr"><span class="hljs-attr">apiUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'https://redux-oauth-backend.herokuapp.com'</span></span>, <span class="hljs-attr"><span class="hljs-attr">authProviderPaths</span></span>: { <span class="hljs-attr"><span class="hljs-attr">github</span></span>: <span class="hljs-string"><span class="hljs-string">'/auth/github'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">signOutPath</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }, <span class="hljs-attr"><span class="hljs-attr">cookies</span></span>: req.cookies, <span class="hljs-attr"><span class="hljs-attr">currentLocation</span></span>: req.url, })) +++ .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> store.dispatch(timeRequest())) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> match({ <span class="hljs-attr"><span class="hljs-attr">routes</span></span>: routes(store), <span class="hljs-attr"><span class="hljs-attr">location</span></span>: req.url }, (error, redirectLocation, renderProps) =&gt; {</code> </pre> <br><p>  ,   <em>initialize</em>  <em>redux-oauth</em>   <em>backend</em> ,        ,    <em>timeRequest</em>   .          . </p><br><p>  ,   ,    ""   F5.    <em>timestamp</em> ,   ""   .   <em>Dev Tools</em> ,  <em>Network</em>   ,   ,    API    .  ,        . </p><br><p>       :     API    ,   . </p><br><h4 id="srcreduxactionstimeactionsjs-1"> src/redux/actions/timeActions.js </h4><br><pre> <code class="javascript hljs">--- <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch</span></span></span><span class="hljs-function">) =&gt;</span></span> { +++ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch, getState</span></span></span><span class="hljs-function">) =&gt;</span></span> { +++ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isUserSignedIn(getState())) { +++ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(); +++ }</code> </pre> <br><p>   ,               <em>getState</em> ,     .      ,     . </p><br><h1 id="6-vmesto-zaklyucheniya"> 6.   </h1><br><p>         -  <em>React.js</em>  .  ,     ! </p><br><p>        ,         . </p><br><p>     github ‚Äî <a href="https://github.com/yury-dymov/habr-app/tree/v3">https://github.com/yury-dymov/habr-app/tree/v3</a> </p><br><p> Ps       , ,      .  Thank you in advance! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/310952/">https://habr.com/ru/post/310952/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310938/index.html">Laziness, impatience and self-conceit are the three main virtues of a programmer. Happy birthday, Larry Wall</a></li>
<li><a href="../310942/index.html">Ultralight BDD: Little Mechanization of Stand-Alone Tests</a></li>
<li><a href="../310944/index.html">After the biggest data theft in history on Yahoo! still ‚Äú33 misfortunes‚Äù</a></li>
<li><a href="../310946/index.html">Canvas Gauges 2.0</a></li>
<li><a href="../310950/index.html">The driver of the computer game Street Fighter V disables the built-in protection mechanism of Windows</a></li>
<li><a href="../310954/index.html">A few notes about MySQL</a></li>
<li><a href="../310956/index.html">Development of user interaction with mobile devices - key principles</a></li>
<li><a href="../310958/index.html">How to answer a maximum of questions with one report?</a></li>
<li><a href="../310960/index.html">The logic of consciousness. Part 7. Self-organization of the context space</a></li>
<li><a href="../310964/index.html">The history of one feature or why hakaton programmer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>