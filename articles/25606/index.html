<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>asp.net: dynamic image generation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Generating dynamic images is a very useful technique. Unfortunately, in asp.net there is no standard functionality that would implement the ability to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>asp.net: dynamic image generation</h1><div class="post__text post__text-html js-mediator-article">  Generating dynamic images is a very useful technique.  Unfortunately, in asp.net there is no standard functionality that would implement the ability to dynamically create images.  The purpose of this article is to show one of the ways to implement dynamic images in asp.net. <br><a name="habracut"></a><br>  First we define the task: <br>  - we need a user control that would accept a Bitmap instance and the type of the desired format (jpeg, png, bmp, gif) as input data; <br>  - the control should provide output to the page of the image defined through Bitmap. <br>  Define an enumeration with the allowed image format types: <br><blockquote>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">enum</font> DynamicImageFormat {Gif = 0, Jpeg, Bmp, Png}</font> <font color="gray">* This code was highlighted with <a href="http://poison.qsh.ru/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br>  This enumeration will be located in the body of the HTTP request handler class, which will be described below. <br>  Now I bring the text of the class that implements the functionality we need: <br><blockquote>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">partial</font> <font color="#0000ff">class</font> DynamicImageControl: System.Web.UI.UserControl { <font color="#0000ff">public</font> <font color="#2B91AF">Bitmap</font> DynamicBitmap { <font color="#0000ff">get</font> ;</font>  <font color="black"><font color="#0000ff">set</font> ;</font>  <font color="black">} <font color="#0000ff">public</font> DynamicImageHandler.DynamicImageFormat DynamicImageFormat = DynamicImageHandler.DynamicImageFormat.Png;</font>  <font color="black"><font color="#0000ff">protected</font> <font color="#0000ff">void</font> Page_Load ( <font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e) { <font color="#0000ff">if</font> (DynamicBitmap! = <font color="#0000ff">null</font> ) { <font color="#2B91AF">Guid</font> _bitmapGuid = <font color="#2B91AF">Guid</font> .NewGuid ();</font>  <font color="black">Cache [_bitmapGuid.ToString ()] = DynamicBitmap;</font>  <font color="black">img.ImageUrl = <font color="#2B91AF">String</font> .Format ( <font color="#A31515">"DynamicImageHandler.ashx? bitmap = {0} &amp; format = {1}"</font> , _bitmapGuid, ( <font color="#0000ff">int</font> ) DynamicImageFormat);</font>  <font color="black">}}}</font> <font color="gray">* This code was highlighted with <a href="http://poison.qsh.ru/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br>  It is necessary to clarify the following things: <br>  - for dynamic image generation, I use the HTTP request handler DynamicImageHandler.ashx, the implementation of which I will give below; <br>  - a reference to the Bitmap instance is transmitted to the processor through the Cache mechanism, a place where data can be stored within the application, the GUID of the saved Bitmap instance is transmitted to the processor via the query string, the type of image format is also transmitted. <br><blockquote>  Using Cache is not the best solution.  I would be happy to hear alternatives. <br></blockquote><br>  Next, I give the handler code: <br><blockquote>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> ProcessRequest ( <font color="#2B91AF">HttpContext</font> context) { <font color="#0000ff">string</font> _bitmapGuid = context.Request.QueryString [ <font color="#A31515">"bitmap"</font> ];</font>  <font color="black"><font color="#0000ff">if</font> (! <font color="#2B91AF">String</font> .IsNullOrEmpty (_bitmapGuid)) { <font color="#0000ff">if</font> (context.Cache [_bitmapGuid]! = <font color="#0000ff">null</font> ) { <font color="#2B91AF">Bitmap</font> _bitmap = ( <font color="#2B91AF">Bitmap</font> ) context.Cache [_bitmapGuid];</font>  <font color="black"><font color="#0000ff">if</font> (_bitmap! = <font color="#0000ff">null</font> ) {ImageFormat DynImageFormat = GetImgFormat (context);</font>  <font color="black">MemoryStream MemStream = <font color="#0000ff">new</font> MemoryStream ();</font>  <font color="black">_bitmap.Save (MemStream, DynImageFormat);</font>  <font color="black">MemStream.WriteTo (context.Response.OutputStream);</font>  <font color="black">MemStream.Dispose ();</font>  <font color="black">_bitmap.Dispose ();</font>  <font color="black">context.Cache.Remove (_bitmapGuid);</font>  <font color="black">}}}}</font> <font color="gray">* This source code was highlighted with <a href="http://poison.qsh.ru/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br>  Here, the handler receives and processes the parameters, loads Bitmap from Cache and, using the threading mechanism, writes an image in the required format to the context stream of the current page.  The GetImgFormat function, which helps to handle the type of image format is defined as: <br><blockquote>  <font color="black"><font color="#0000ff">private</font> ImageFormat GetImgFormat ( <font color="#2B91AF">HttpContext</font> context) {ImageFormat result = ImageFormat.Png;</font>  <font color="black"><font color="#0000ff">if</font> (! <font color="#2B91AF">String</font> .IsNullOrEmpty (context.Request.QueryString [ <font color="#A31515">"format"</font> ])) {DynamicImageFormat _imgFormat = (DynamicImageFormat) <font color="#2B91AF">Convert</font> .ToInt32 (context.Request.QueryString [ <font color="#A31515">"format"</font> ]);</font>  <font color="black"><font color="#0000ff">switch</font> (_imgFormat) { <font color="#0000ff">case</font> DynamicImageFormat.Gif: result = ImageFormat.Gif;</font>  <font color="black"><font color="#0000ff">break</font> ;</font>  <font color="black"><font color="#0000ff">case</font> DynamicImageFormat.Jpeg: result = ImageFormat.Jpeg;</font>  <font color="black"><font color="#0000ff">break</font> ;</font>  <font color="black"><font color="#0000ff">case</font> DynamicImageFormat.Bmp: result = ImageFormat.Bmp;</font>  <font color="black"><font color="#0000ff">break</font> ;</font>  <font color="black"><font color="#0000ff">case</font> DynamicImageFormat.Png: result = ImageFormat.Png;</font>  <font color="black"><font color="#0000ff">break</font> ;</font>  <font color="black"><font color="#0000ff">default</font> : result = ImageFormat.Png;</font>  <font color="black"><font color="#0000ff">break</font> ;</font>  <font color="black">}} <font color="#0000ff">return</font> result;</font>  <font color="black">}</font> <font color="gray">* This source code was highlighted with <a href="http://poison.qsh.ru/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br>  In addition, in the handler class, it is necessary to define the IsReusable boolean property, which will make it clear asp.net whether it is necessary to create a new handler instance with each request. <br><blockquote>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">bool</font> IsReusable { <font color="#0000ff">get</font> { <font color="#0000ff">return</font> <font color="#0000ff">true</font> ;</font>  <font color="black">}}</font> <font color="gray">* This source code was highlighted with <a href="http://poison.qsh.ru/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br>  If we return IsReusable = false, then asp.net will create a new instance each time and in this way will slightly increase the load on the server. <br><br>  Now I will demonstrate the use case of the obtained component and handler.  Use the control in the specified way: <br><blockquote>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">form</font> <font color="#ff0000">id</font> <font color="#0000ff">= "form1"</font> <font color="#ff0000">runat</font> <font color="#0000ff">= "server"</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">asp: Label</font> <font color="#ff0000">ID</font> <font color="#0000ff">= "Label2"</font> <font color="#ff0000">runat</font> <font color="#0000ff">= "server"</font> <font color="#ff0000">Text</font> <font color="#0000ff">= "Dynamic creation of images:‚Äû</font> <font color="#0000ff">&gt; &lt;/</font> <font color="#800000">asp: Label</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">uc1: DynamicImageControl</font> <font color="#ff0000">ID</font> <font color="#0000ff">= ‚ÄúDynamicImageControl1‚Äù</font> <font color="#ff0000">runat</font> <font color="#0000ff">= "server"</font> <font color="#0000ff">/&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">asp: Label</font> <font color="#ff0000">ID</font> <font color="#0000ff">= "Label1"</font> <font color="#ff0000">runat</font> <font color="#0000ff">= "server"</font> <font color="#ff0000">Text</font> <font color="#0000ff">= "End."</font> <font color="#0000ff">&gt; &lt;/</font> <font color="#800000">asp: Label</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;/</font> <font color="#800000">form</font> <font color="#0000ff">&gt;</font></font> <font color="gray">This source code was highlighted with <a href="http://poison.qsh.ru/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br>  In the code, we initialize the element fields.  To do this, we define the simplest function that builds a Bitmap with the simplest captcha, so well known to everyone who has ever been registered on the web. <br><blockquote>  <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">string</font> GetRandomPassword ( <font color="#0000ff">int</font> length) { <font color="#2B91AF">Random</font> rand = <font color="#0000ff">new</font> <font color="#2B91AF">Random</font> ();</font>  <font color="black"><font color="#2B91AF">StringBuilder</font> password = <font color="#0000ff">new</font> System.Text.</font>  <font color="black"><font color="#2B91AF">StringBuilder</font> (length);</font>  <font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 1; i &lt;= length; i ++) { <font color="#0000ff">int</font> charIndex;</font>  <font color="black"><font color="#0000ff">do</font> {charIndex = rand.Next (48, 123);</font>  <font color="black">} <font color="#0000ff">while</font> (! ((charIndex&gt; = 48 &amp;&amp; charIndex &lt;= 57) || (charIndex&gt; = 65 &amp;&amp; charIndex &lt;= 90) || (charIndex&gt; = 97 &amp;&amp; charIndex &lt;= 122)));</font>  <font color="black">password.Append ( <font color="#2B91AF">Convert</font> .ToChar (charIndex));</font>  <font color="black">} <font color="#0000ff">return</font> password.ToString ();</font>  <font color="black">} <font color="#0000ff">public</font> <font color="#2B91AF">Bitmap</font> DrawPassword () { <font color="#2B91AF">Bitmap</font> _bitmap = <font color="#0000ff">new</font> <font color="#2B91AF">Bitmap</font> (150, 30);</font>  <font color="black"><font color="#2B91AF">Graphics</font> _graphics = <font color="#2B91AF">Graphics</font> .FromImage (_bitmap);</font>  <font color="black"><font color="#2B91AF">SolidBrush</font> _foreColor = <font color="#0000ff">new</font> <font color="#2B91AF">SolidBrush</font> (Color.White);</font>  <font color="black"><font color="#2B91AF">SolidBrush</font> _backColor = <font color="#0000ff">new</font> <font color="#2B91AF">SolidBrush</font> (Color.FromArgb (0x73, 0x82, 0x9F));</font>  <font color="black">_graphics.FillRectangle (_backColor, 0, 0, 150, 30);</font>  <font color="black"><font color="#2B91AF">Font</font> _font = <font color="#0000ff">new</font> <font color="#2B91AF">Font</font> ( <font color="#A31515">"Verdana"</font> , 15);</font>  <font color="black"><font color="#2B91AF">Point</font> _point = <font color="#0000ff">new</font> <font color="#2B91AF">Point</font> (5, 5);</font>  <font color="black"><font color="#0000ff">string</font> _password = GetRandomPassword (10);</font>  <font color="black">_graphics.DrawString (_password, _font, _foreColor, _point);</font>  <font color="black"><font color="#0000ff">if</font> (_graphics! = <font color="#0000ff">null</font> ) _graphics.Dispose ();</font>  <font color="black"><font color="#0000ff">return</font> _bitmap;</font>  <font color="black">}</font> <font color="gray">* This source code was highlighted with <a href="http://poison.qsh.ru/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br>  Finally, the initialization of the control: <br><blockquote>  <font color="black"><font color="#0000ff">protected</font> <font color="#0000ff">void</font> Page_Load ( <font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e) {DynamicImageControl1.DynamicBitmap = DrawPassword ();</font>  <font color="black">DynamicImageControl1.DynamicImageFormat = DynamicImageHandler.DynamicImageFormat.Gif;</font>  <font color="black">}</font> <font color="gray">* This source code was highlighted with <a href="http://poison.qsh.ru/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  It's all.  As a result, we will be able to see such a picture on the screen: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://imhost.ru/out.php/i8036_dynImage.jpg"><br><br>  The source code of the project with classes and an example is here: <br>  <a href="http://ifolder.ru/6606116">ifolder.ru/6606116</a> <br><br>  PS: ‚Äúthere are no mistakes in the article!‚Äù - unfortunately, it is impossible to say this, but I will be glad if you pay attention to the error you found or suggest any improvements. <br><br>  PPS: article posted on the website <a href="http://www.gotdotnet.ru/">www.gotdotnet.ru</a> <br>  <a href="http://www.gotdotnet.ru/LearnDotNet/ASPNET/558721.aspx">www.gotdotnet.ru/LearnDotNet/ASPNET/558721.aspx</a> </div><p>Source: <a href="https://habr.com/ru/post/25606/">https://habr.com/ru/post/25606/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256049/index.html">Complete energy autonomy or how to survive with solar panels in the outback (part 5. Sun Catcher)</a></li>
<li><a href="../25605/index.html">Making Artificial Intelligence</a></li>
<li><a href="../256055/index.html">Working with the Mandrill mail service API</a></li>
<li><a href="../256057/index.html">Java 8: Master the new level of abstraction</a></li>
<li><a href="../256059/index.html">GrabDuck: a new look at bookmarks</a></li>
<li><a href="../256061/index.html">Ghostlab: Using Chrome development tools for debugging in any browser</a></li>
<li><a href="../256063/index.html">We translate using Yandex</a></li>
<li><a href="../256067/index.html">Wolfram Language (Mathematica) in Russian ... or advanced function assignment</a></li>
<li><a href="../256069/index.html">CSS of the future: distance to the eyes</a></li>
<li><a href="../25607/index.html">P2P network for iPhone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>