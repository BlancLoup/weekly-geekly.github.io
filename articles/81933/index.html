<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Google AppEngine from the start: Controller</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are moving forward with the speed of a reactive paravoz, and while the habra people read and comprehend the first and second parts of the article, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Google AppEngine from the start: Controller</h1><div class="post__text post__text-html js-mediator-article">  We are moving forward with the speed of a reactive paravoz, and while the habra people read and comprehend the <a href="http://habrahabr.ru/blogs/gae/81895/">first</a> and <a href="http://habrahabr.ru/blogs/gae/81920/">second</a> parts of the article, I write a sequel with the speed of a machine gun.  This time it will be about the heart of any web application - <br><br><h2>  Controller </h2><br>  Some time ago, we had already identified several URLs in <code>app.yaml</code> - it's time to figure out how to make the application respond correctly to them.  This is how our mappings look like: <br><br><pre> # $ Id: app.yaml 4 2010-01-25 12: 14: 48Z sigizmund $

 application: helloworld
 version: 1
 runtime: python
 api_version: 1

 handlers:
 - url: / (stats | login)
   script: main.py
   login: required

 - url:. *
   script: main.py
</pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As we can see, three types of URLs are defined - <code>/stats</code> , <code>/login</code> and ‚Äúeverything else‚Äù.  All three, which is typical, will be processed by the same <code>main.py</code> script, but the settings are different - <code>/stats</code> and <code>/login</code> require an active user session, while for the rest it is not necessary.  Let's look at the contents of the <code>main.py</code> script: <br><a name="habracut"></a><br><pre> #! / usr / bin / env python

 '' '
 $ Id: main.py 4 2010-01-25 12: 14: 48Z sigizmund $
 '' '

 import controller

 from google.appengine.ext import webapp
 from google.appengine.ext.webapp import util
 from google.appengine.api import users

 def main ():
   application = webapp.WSGIApplication ([('/', controller.DefaultRequestHandler), 
                                 ('/ stats', controller.StatsRequestController),
                                 ('/ login', controller.LoginController)],
                                        debug = True)
   util.run_wsgi_app (application)


 if __name__ == '__main__':
   main ()
</pre><br><br>  He is pretty laconic.  That is, it is extremely concise, but at the same time very important - all that it does is import the contents of the <code>controllers</code> and create the <code>webapp.WSGIApplication</code> instance that matches the request URLs and the corresponding handlers.  As a rule, it is convenient to put these handlers in a separate package in order to separate the service code from the real code, which, in fact, determines the behavior of the application.  Consider these handlers in turn. <br><br><h3>  DefaultRequestHandler - default handler </h3><br>  As can be seen from the code above, this handler will be used for all requests that came to the ‚Äúmain page‚Äù of the application - namely, ‚Äú/‚Äù.  Its code is located below: <br><br><pre> class DefaultRequestHandler (webapp.RequestHandler): 
     '' '
     Handles default requests - checks if user is logged in;  if it is - saves an information about
     his visit in the database.
     '' '

     def get (self):
         user = users.get_current_user ()

         page = None
         if not user:
             page = view.StartPage (self.request)
         else:
             page = view.WelcomePage (self.request)

         page.render (self.response.out)
</pre><br><br>  In principle, this code is no different from the <code>MainHandler</code> code in the <a href="http://habrahabr.ru/blogs/gae/81895/">first part</a> , except that it does not generate the page content on its own, but uses some auxiliary classes.  At this stage, we will not consider what they are doing - it‚Äôs enough for us to know that they generate HTML that meets our requirements - that is, it offers to log in users who have not done so and welcome those who have successfully coped with it. <br><br><h3>  Login Handler - between two pages </h3><br>  Let me remind you a picture with the structure of our application: <br><br> <a href="http://skitch.com/sgzmd/n1yds/gaehabr"><img src="http://img.skitch.com/20100125-piig8hjqa2dwx9xe524h2dpn5f.preview.jpg" alt="gaehabr"></a> <br><br>  As follows from the description of the <code>/login</code> page, the user will redirect to it automatically and also automatically redirected further to the page <code>/</code> .  What happens on this page?  For this we need to consider two classes at once. <br><br><pre> class LoggedInRequestHandler (webapp.RequestHandler):
     def currentVisitor (self):
         user = users.get_current_user ()

         # we shouldn't check user, as / login and / stats specifies 
         # login: required in app.yaml

         q = model.Visitor.all ()
         q.filter ('user =', user)

         qr = q.fetch (2)

         if len (qr) == 0:
             u = model.Visitor ()
         elif len (qr)&gt; 1:
             # something is horribly wrong here, it shouldn't happen
             # but it still could
             logging.error ("Duplicating user% s in datastore"% user.nickname ())
             raise Exception ("Duplicating user% s in datastore"% user.nickname ())
         else:
             u = qr [0]

         self.currentVisitor = u
         return u
</pre><br><br>  Perhaps this is not the best architectural solution, but for illustrative purposes, we declare the class and inherit it from <code>webapp.RequestHandler</code> .  As you can see, the described class does not define the <code>get</code> method ‚Äî that is, as an independent developer, it will be rather useless.  All it does is provide the <code>currentVisitor()</code> method, which either gets from the Datastore or creates a new <code>Visitor</code> instance and returns it.  Consider this code in more detail. <br><br>  The described approach uses the <a href="http://code.google.com/appengine/docs/python/datastore/queryclass.html">Datastore Query</a> , which begins with ‚Äúall‚Äù objects of a given type, and then gradually ‚Äúrefines‚Äù the final data set by calling <code>filter()</code> and <code>ancestor()</code> .  The example is very simple, but it shows almost everything you need to extract the necessary entry from the Datastore;  Of course, in real applications, this query will probably be much more complicated. <br><br>  Now, having such a useful class, we can easily describe our handler: <br><br><pre> class LoginController (LoggedInRequestHandler): 
     '' '
     We use this controller for the login event.
     '' '
     def get (self):
         u = self.currentVisitor ()

         u.hits = u.hits + 1
         u.put ()

         self.redirect ('/')
</pre><br>  As can be seen from the code, the handler receives the Visitor instance associated with the current user (possibly creating it), increases the number of visits by one and saves the instance.  After that, the user is redirected to the main page without unnecessary words  You no longer need to check the user, because the URL <code>/login</code> marked as requiring a mandatory login (that is, if the user tries to log in without authentication, he will be automatically redirected to the login page). <br><br><h3>  StatsRequestController - statistics on request </h3><br>  The code of the last handler is extremely simple.  It is so simple that it makes one think that there obviously should be something else: <br><br><pre> class StatsRequestController (LoggedInRequestHandler): 
     def get (self):
         u = self.currentVisitor ()
         page = view.StatsPage (self.request, u)

         page.render (self.response.out)
</pre><br>  Indeed, there is something else.  This is something called Presentation, it uses Django templates and will be described in the next part of this article ;-) <br><br>  I remind you that the full source code can be viewed in <a href="http://code.google.com/p/habr-gae-helloworld/source/browse/trunk/controller.py">SVN</a> , and I am waiting for your questions and comments! <br><br>  PS think up, please, as source codes with illumination in Habr to spread - and then I'll fill in all the pictures! </div><p>Source: <a href="https://habr.com/ru/post/81933/">https://habr.com/ru/post/81933/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../81922/index.html">ACHI - FOP replacement</a></li>
<li><a href="../81924/index.html">Master IBS Company</a></li>
<li><a href="../81926/index.html">PayPal froze Wikileaks.org assets again</a></li>
<li><a href="../81929/index.html">Tiler - rethought classic puzzle game for iPhone</a></li>
<li><a href="../81932/index.html">Electronic transmission by bike</a></li>
<li><a href="../81934/index.html">AdWords coupon for 1000r. in January Hacker</a></li>
<li><a href="../81936/index.html">Bylina about hosting</a></li>
<li><a href="../81937/index.html">Meet the Orchard Project!</a></li>
<li><a href="../81938/index.html">Microloan service - WebMoney project in social networks</a></li>
<li><a href="../81941/index.html">Oh happiness at work or ‚ÄúI‚Äù his own anti-motivator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>