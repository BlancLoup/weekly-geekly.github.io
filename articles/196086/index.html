<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Win32 / Napolar - new in-the-wild bot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, our specialists discovered a new malware that was added to the anti-virus database as Win32 / Napolar . We paid attention to it in mid-Augus...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Win32 / Napolar - new in-the-wild bot</h1><div class="post__text post__text-html js-mediator-article">  Recently, our specialists discovered a new malware that was added to the anti-virus database as <a href="http://www.virusradar.com/en/Win32_Napolar/detail">Win32 / Napolar</a> .  We paid attention to it in mid-August due to interesting anti-debugging methods and code injection.  The bot is used by attackers for several purposes: conducting DoS attacks, organizing a SOCKS proxy server, stealing data from infected systems.  Like other Trojans, Win32 / Napolar is able to inject its code into browsers in order to get data from web forms. <br><br>  We have observed Napolar activity since the end of July.  Since then, thousands of infections have been recorded, many of them in South America.  Countries such as Peru, Ecuador and Colombia account for the largest number of infections.  More information on the geography of distribution can be found at <a href="http://virusradar.com/en/Win32_Napolar/detail">virusradar</a> . <br><br><img src="https://habrastorage.org/storage3/8f2/b34/e15/8f2b34e1514dacc8a9a1d4c940b892b7.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  We were not able to witness the campaign to distribute this malicious code, but indirect evidence points to the use of the social networking site Facebook for this purpose.  Since Napolar has the ability to steal Facebook account credentials, botnet operators can reuse this data to send messages to compromised users.  Below is a list of file names that attackers used in Napolar distribution campaigns: <br><br><ul><li>  Photo_032.JPG_www.facebook.com.exe </li><li>  Photo_032.JPG_www.facebook.com.exe </li><li>  Photo_014-WWW.FACEBOOK.COM.exe </li></ul><br>  To disguise the true file extension and confuse users, double name extensions were used (for example, * .JPG.EXE, * .TXT.EXE. Our AVAST colleagues <a href="https://blog.avast.com/2013/09/25/win3264napolar-new-trojan-shines-on-the-cyber-crime-scene/">confirmed</a> these infection vectors in their analysis. <br><br>  <b>Anti-debugging tricks</b> <br><br>  The first thing we noticed was the absence of the entry point address in the PE header. <br><br><img src="https://habrastorage.org/storage3/727/519/ffd/727519ffd682bcf21f668b070f6af3d5.png"><br><br>  In such a file, the functions that will be executed by the OS when it is launched are located in <a href="https://en.wikipedia.org/wiki/Thread-local_storage">Thread Local Storage (TLS)</a> .  Dropper has two registered TLS functions.  The first one does not perform any functions.  The second is responsible for decoding the code using the RC4 algorithm and the key 0xDEADBEEF.  This decoded code is registered as the third TLS function before the previous function returns control to the OS. <br><br><img src="https://habrastorage.org/storage3/72f/c06/edc/72fc06edc4f7c24f96157999bcc9324f.png"><br><br>  The third TLS function decrypts the rest of the code before it is executed.  The malicious code uses the following tricks to complicate its analysis: <br><br><ul><li>  All addresses of imported functions in the import table are filled in the process of execution using hashes of the names of these functions. </li><li>  Dropper's interaction with the OS is mainly performed by directly calling the undocumented ntdll functions instead of using standard APIs. </li></ul><br>  To transfer control to the decryption function, Win32 / Napolar searches in memory for the opcode 0x55 (corresponds to the push ebp instruction, the expected start of the function).  If this instruction is replaced by the opxcode 0xCC (i.e., a debug breakpoint will be supplied to it), the decryption of the code will not work, since the function will not be called.  This anti-debugging mechanism allows the debugger to be detected during the dropper operation and to take the necessary actions. <br><br>  In order to complicate dynamic analysis, Win32 / Napolar creates a child process based on its image with the ability to debug it. <br><br><img src="https://habrastorage.org/storage3/a14/30d/2f0/a1430d2f054e81ad6fb8c66c7f92e671.png"><br><br>  This practice of complicating dynamic analysis was mentioned in the article <a href="https://blog.avast.com/2013/05/29/analysis-of-a-self-debugging-sirefef-cryptor/">"Analysis of a self-debugging Sirefef cryptor"</a> .  But in the case of Napolar, the ability to debug the malicious code itself is implemented in its main body, and not in the packer. <br><br>  As soon as the debugged process is launched, the Trojan program will start executing the debugging event processing loop returned by the <i>WaitForDebugEvent</i> function.  The pseudocode of this cycle is shown below in the screenshot. <br><br><img src="https://habrastorage.org/storage3/7d3/2a2/4bc/7d32a24bc02bf2d511210f1d9af748d0.png"><br><br>  The first event to be processed by this code is CREATE_PROCESS_DEBUG_EVENT.  Notification about it comes when the debugged process has been launched.  In this case, the parent (main) process will analyze the header of the image file of the running process for the presence of standard MZ and PE markers to obtain the offset and the size of the code with independent position (independent position) code.  Then a block of memory will be allocated in the process being debugged, where code injection will be performed.  Thus, through a similar operation, two copies of the same code will be created in this process. <br><br>  The next event to be handled in a loop is EXCEPTION_DEBUG_EVENT.  The processing code for this event will overwrite the first TLS function so that it redirects the execution of the code to the beginning of the executable file through the use of push / ret instructions.  Then there is a decryption of the main body of Napolar and its subsequent execution (in the context of the child process).  Further, the code from the child process is responsible for almost all the basic operations, i.e., embedding the code into processes, launching child processes and intercepting various functions to hide its presence in the system and intercept necessary information. <br><br>  The final step in the loop is to receive the EXIT_PROCESS_DEBUG_EVENT event.  In this case, the parent code stops debugging by calling <i>DebugActiveProcessStop</i> and terminates its own process using <i>NtTerminateProcess</i> . <br><br><img src="https://habrastorage.org/storage3/096/647/482/09664748251a041aa74901af472a49a0.jpg"><br><br>  One of the main features of Win32 / Napolar is its ability to steal information from forms of web pages that are displayed in the browser.  The Trojan program contains a special code for detecting the Trusteer security product, which complements the user's browser with special protection functions.  If, when listing processes running in the system, a process is found that contains ‚Äútrusteer‚Äù in its name, it will be forcibly terminated. <br><br>  <b>Networking</b> <br><br>  Win32 / Napolar uses the HTTP protocol to interact with the command C &amp; C server.  The first message sent by the bot to the server contains the following information: <br><ul><li>  Bot version </li><li>  Username from current account </li><li>  Computer name </li><li>  Bot ID </li><li>  OS version </li><li>  The type of system (x32 / x64). </li></ul><br>  Then the server responds with bot tasks that it must perform.  These commands are encrypted using RC4, with the Bot ID being used as the encryption key.  The bot supports many commands: <br><br><ul><li>  Theft of information </li><li>  SOCKS proxy </li><li>  DoS attack </li><li>  Loading additional modules </li><li>  Module execution </li><li>  Update bot. </li></ul><br>  Each command has its own unique identifier, stored as one byte, followed by the command parameters.  The following screenshot shows a part of the traffic that was used in the interaction between the bot and the managing server. <br><br><img src="https://habrastorage.org/storage3/b50/fb5/894/b50fb5894aa0925e8573a4ad0e2575e8.png"><br><br>  The following figure shows the decryption of this command using the appropriate key.  The first byte of ‚Äú0xC‚Äù is the code of the ‚Äúsleep‚Äù command for the bot.  The parameter is the string "600", meaning the number of seconds for which the bot should fall asleep. <br><br><img src="https://habrastorage.org/storage3/57d/bef/fa0/57dbeffa03704e9eec1a441cdbc6f512.png"><br><br>  We have seen at least seven different C &amp; C servers used by Win32 / Napolar.  Most of them stayed online for only a few days.  After that, the operator moved them to a new network.  Such behavior can be explained by the fact that the bot is actively used ‚Äúin the wild‚Äù, that is, it has a large number of installations on users' computers.  Below is a list of domains detected by C &amp; C servers: <br><br><ul><li>  dabakhost.be </li><li>  terra-araucania.cl </li><li>  xyz25.com </li><li>  yandafia.com </li><li>  elzbthfntr.com </li><li>  alfadente.com.br </li></ul><br><br>  Links to TOR were found in the configuration files of the malicious program.  Perhaps the attackers will use this feature later to take advantage of this anonymous network for network interaction. <br><br>  The authors of Win32 / Napolar, apparently, are very interested in selling their "product".  The website advertising the bot looks very creative and contains information for potential customers.  It can be found the full code of the bot interaction with the C &amp; C server and a PHP script working with the SQL database.  In addition, the site contains various examples of plug-ins that can be used by operators of malicious code.  The plugins themselves must be written in Delphi. <br><br><img src="https://habrastorage.org/storage3/289/184/964/2891849641ec54db326f76c78b0ebe74.png"><br><br>  The site contains information about changes that were made in different versions of the Trojan program (changelog).  Based on these data, the first change was made on July 14th, which corresponds to our assumptions, since we observed the first samples of the bot in early August.  The domain registration date for these samples also corresponds to the beginning of August. <br><br><img src="https://habrastorage.org/storage3/20c/a15/de6/20ca15de647e0d5a76d10540ce15ebdd.png"></div><p>Source: <a href="https://habr.com/ru/post/196086/">https://habr.com/ru/post/196086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196070/index.html">Online presence for small business: website or social network?</a></li>
<li><a href="../196072/index.html">New report on changes in the Apple App Store algorithm explains how even minor rating shifts affect the most popular applications.</a></li>
<li><a href="../196080/index.html">Wireless Display for Android</a></li>
<li><a href="../196082/index.html">Test drive the clouds: why do you need it and how to do it</a></li>
<li><a href="../196084/index.html">Numenta NuPIC: First Steps</a></li>
<li><a href="../196088/index.html">Derby.js TODO or not TODO</a></li>
<li><a href="../196090/index.html">Clojure Cup - the experience of participating in the hackathon on writing a web application on Clojure</a></li>
<li><a href="../196092/index.html">Why we switched to Marionette.js</a></li>
<li><a href="../196094/index.html">Former Microsoft Privacy Director now trusts only open source software.</a></li>
<li><a href="../196096/index.html">Metric # 24 - A podcast about technologies, products, and services from the IT world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>