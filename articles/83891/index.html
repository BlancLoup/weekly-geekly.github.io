<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with FBA accounts via C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In addition, MOSS 2007 supports form-based authorization (FBA), in particular, the use of an ASP.NET provider (in our example, this provider in the we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with FBA accounts via C #</h1><div class="post__text post__text-html js-mediator-article"> In addition, MOSS 2007 supports form-based authorization (FBA), in particular, the use of an ASP.NET provider (in our example, this provider in the web.config was called aspnetsqlmembershipprovider).  We initially created, modified and deleted such accounts and their profiles with a console application: when I found the time, I decided to optimize this process, and instead of the ‚ÄúGET request - parameter handler ‚Äî launching the application on the server with these parameters‚Äù, work with users through a separate web application. <br>  I want to share the pitfalls that I came across in the process, for example, deleting users. <br><a name="habracut"></a><br>  In the console application, the uninstall procedure looked very simple: <br> <code>using Microsoft.SharePoint; <br> using Microsoft.Office.Server; <br> using Microsoft.Office.Server.UserProfiles; <br> .... <br> System.Web.Security.Membership.DeleteUser(login); <br> using (SPSite site = new SPSite("http://sharepoint") <br> { <br> ServerContext context = ServerContext.GetContext(site); <br> UserProfileManager profileManager = new UserProfileManager(context); <br> string sAccount = "aspnetsqlmembershipprovider:" + login; <br> profileManager.RemoveUserProfile(sAccount); <br> }</code> <br> <br>  When the same thing is done using the simplest form method (textbox to fill in the login and the ‚ÄúDelete‚Äù button), the code - in the part where you need to delete a profile from Sharepoint - changes a lot.  First, you have to disable Form Digest Setting - otherwise the action ‚ÄúprofileManager.RemoveUserProfile (sAccount)‚Äù will crash with the error ‚ÄúSystem.Runtime.InteropServices.COMException: The security checks on this page are not allowed‚Äù, since Sharepoint will notice that the operation with profile trying to produce not from its pages.  To do this, add the following lines: <br> <code>SPWebApplication spWebApp = site.WebApplication; <br> spWebApp.FormDigestSettings.Enabled = false;</code> <br>  Secondly, it turns out that the context of the Sharepoint application, when trying to get it from a web application, does not contain several parameters, without which we get a new error: "System.NullReferenceException: The object reference is not specified in the object instance".  To avoid such excesses, add this: <br> <code>if (HttpContext.Current != null) <br> { <br> if (HttpContext.Current.Items["HttpHandlerSPWeb"] == null) <br> HttpContext.Current.Items["HttpHandlerSPWeb"] = site.OpenWeb(); <br> if (HttpContext.Current.Items["Microsoft.Office.ServerContext"] == null) <br> HttpContext.Current.Items["Microsoft.Office.ServerContext"] = context; <br> } <br></code> <br>  Oh miracle!  Our form starts to work.  But the goal is to get a username to delete from a GET request.  If in the resulting method the user‚Äôs login is filled in from Request.QueryString, .NET gives us: ‚ÄúUpdates are currently not allowed for GET requests.  To enable updates for GET requests, set the 'AllowUnsafeUpdates' property on SPWeb, which hints.  Well, let's add 2 more lines.  As a result, we get the following code: <br> <code>using (SPSite site = new SPSite("http://sharepoint")) <br> { <br> using (SPWeb web = site.OpenWeb()) <br> { <br> //     GET  <br> web.AllowUnsafeUpdates = true; <br> web.Update(); <br> ServerContext context = ServerContext.GetContext(site); <br> //   ,  Sharepoint    <br> if (HttpContext.Current != null) <br> { <br> if (HttpContext.Current.Items["HttpHandlerSPWeb"] == null) <br> HttpContext.Current.Items["HttpHandlerSPWeb"] = web; <br> if (HttpContext.Current.Items["Microsoft.Office.ServerContext"] == null) <br> HttpContext.Current.Items["Microsoft.Office.ServerContext"] = context; <br> } <br> //    Sharepoint <br> UserProfileManager profileManager = new UserProfileManager(context); <br> string sAccount = "aspnetsqlmembershipprovider:" + login; <br> //   <br> profileManager.RemoveUserProfile(sAccount); <br> //   GET  <br> web.AllowUnsafeUpdates = false; <br> web.Update(); <br> } <br> } <br> } <br></code> <br>  Yes, the earth and the sky in comparison with the console application.  But - it works!  :) <br>  Perhaps, this topic will save someone from a couple of days of annoyed googling. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/83891/">https://habr.com/ru/post/83891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../83885/index.html">Digest of 2009 in the market of web development</a></li>
<li><a href="../83886/index.html">Howto or Yota in Las Vegas</a></li>
<li><a href="../83888/index.html">StarCraft 2 beta test in February</a></li>
<li><a href="../83889/index.html">February 16 at the United States will make training cyber attack</a></li>
<li><a href="../83890/index.html">The second open international conference dedicated to Maemo in Moscow</a></li>
<li><a href="../83892/index.html">jQuery 1.3.x -> 1.4.x and JSON</a></li>
<li><a href="../83893/index.html">An interesting technique for hiding JS "virus" codes</a></li>
<li><a href="../83894/index.html">Apple in the regions</a></li>
<li><a href="../83895/index.html">GuruPlug Server - a new version of an ultra-compact Linux server the size of a charger</a></li>
<li><a href="../83896/index.html">The introduction of free software in schools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>