<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering of a binary format on the example of Korg .SNG files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We live in amazing time. There is an abundance of technology around us: phones, computers, smart watches and other gadgets. Every day, manufacturers p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering of a binary format on the example of Korg .SNG files</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ve/-p/e3/ve-pe3tgqlv4dwca26xozjh6t2s.jpeg"><br><br>  We live in amazing time.  There is an abundance of technology around us: phones, computers, smart watches and other gadgets.  Every day, manufacturers put on the market more and more new devices.  Most of them are destined to have a short and bright (or not so) life: a powerful marketing company at the time of release, 1-2 years of full-fledged support by the manufacturer, and then a slow oblivion.  Simple devices can work for years after the expiration of the official support.  With smart devices everything is more complicated.  Well if the gadget at least continues to work after disconnecting the server / services of the manufacturer.  And lucky if the next update of the OS, drivers or other software will not beat compatibility. <br><a name="habracut"></a><br>  Unfortunately, more and more events are developing in a pessimistic scenario.  And 5-10 years after the purchase, we have technically sound devices in our hands, which nevertheless cannot be used due to the lack of software support.  Of course, a broken gadget is unpleasant.  But much more unpleasant, if there is user data in a format incompatible with anything.  This data can be considered lost if the device ceases to function.  In my case, the worst has not happened yet, but the alarm bells are already ringing. <br><br>  So, there is a well-known firm Korg, which produces very high-quality musical equipment.  In 2010, I bought a synthesizer from this company for music as a hobby.  Korg microstation is a fairly advanced model.  Among other things, he has onboard a sequencer for recording his own tracks and can write data to a memory card in proprietary SNG format.  It is possible to export to the common midi format, but almost all the metadata is lost: information about the effects and filters applied, various settings of virtual instruments, etc.  The main problem for me personally is the speed of transition to the recording of musical ideas.  The muse is a capricious creation, and I often come across an interesting idea simply by improvising or playing some uncomplicated something.  The faster I press the record button without wandering around the menu, the more likely I can repeat and write down an interesting piece, which in the future may become part of a full-fledged work.  Of course, this approach is not ideal, but we are talking about a hobby.  Anyway, for almost ten years, I have accumulated about a thousand musical sketches and sketches in SNG format. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The bell rang in the form of a series of synthesizer glitches that required a flashing of the device.  And I thought about transferring all my accumulated data to Midi format, all the more so as it will make it much easier to store, organize and edit them.  Search converter in Google did not give anything.  There are many requests in various forums, the history of the issue has been going on for 20 years, if not more.  All I found was someone's ancient Windows utility, naturally incompatible with my files. <br><br>  And then I decided to try to see what is this SNG format?  Maybe somewhere inside there are normal midi data that you can easily pull out and save? <br><br><h3>  Attempt to solve the problem "in the forehead" </h3><br>  So, from the instructions for the synthesizer, you can find out that the SNG format is a container in which so-called ‚Äúsongs‚Äù are stored.  Each song contains 16 tracks of a sequencer with musical data, as well as sound and effect settings.  When exporting to the Midi format via the synthesizer menu, each ‚Äúsong‚Äù is exported to a separate .MID file, and all settings for sounds and effects are lost.  Since  I play my ideas in the simplest form and without effects, the problem is precisely the large number of SNG files and the inconvenience of the manual conversion process.  Let's see if this process cannot be accelerated or automated. <br><br>  First, remember what midi data is.  Simply put, this is a flow of musical events: pressing and releasing a key, pressing and releasing a sustain pedal, changing tempo, patch (virtual instrument) and other parameters.  Each event contains a temporary delta since the previous event and data such as intensity and pitch of a note.  The format of the midi file is very simple: there is practically nothing besides the headers and the data itself. <br><img src="https://habrastorage.org/webt/va/4r/jr/va4rjrzdye1cuhhufe1j5nvfdqk.jpeg"><br>  <i>Pink is a Note On event.</i>  <i>Pale yellow is the delta of time.</i>  <i>Blue is a Note Off event.</i> <br><br>  Let's try to find our midi data in the SNG file.  To do this, we write down a sequence of several notes on the synthesizer and export them in both formats.  Since  we don‚Äôt know where the music data is located in binary files, then we will try to repeat the process with different sequences of notes. <br><br>  Here and then I use Synalyze It! Hex-editor!  Its capabilities will be very useful in the future.  In the meantime, just use the function of comparing binary files. <br><img src="https://habrastorage.org/webt/ap/rc/um/aprcumsiubha7hfzvasa3cbsxd0.jpeg"><br>  In fact, only the name of the song coincided.  By comparing two SNG files with different sequences of notes, you can roughly guess where the music data is stored, but this will not help us so far - the data format is different.  The file itself is dozens of times larger than the Midi file, and apparently contains a lot of additional information.  You can see the KORG signature in the first four bytes and some other lines, including the name of the song and the names of the patches (voices) assigned to the tracks. <br><br><h3>  Parsing the data block structure </h3><br>  This could have been completed if, fortunately, there were no tools that would allow relatively easy to analyze and understand the structure of the data stored in binary form.  This will help us all the same program Synalaze It!, Which allows you to create and use the "grammar" for the analysis of binary files. <br><br>  A grammar is a hierarchical descriptive structure that allows you to represent binary data in a form understandable to humans.  The program allows you to download grammars for some formats.  For example, for the same midi: <br><img src="https://habrastorage.org/webt/5j/fh/f1/5jfhf1mz0twm0_8pajoitnmcvxe.jpeg"><br>  For the SNG format, the finished grammar was not expected.  Well, let's see what we can extract from the file on our own. <br><br>  Let's start with the title.  Typically, this part contains the file signature, version information, dimensions and offsets of the data blocks.  By comparing several different SNG files, we find the unchanged parts and pay more attention to those that change. <br><img src="https://habrastorage.org/webt/xp/dc/1i/xpdc1inosnksf1cl567lhuef62w.jpeg"><br>  Create a header structure in the grammar editor.  The first 4 bytes are obviously the signature of the file.  Suppose the next 4 bytes are version related.  The next few dozen bytes do not change and do not contain anything interesting - we create binaryData for them of the appropriate size.  But then the interesting begins.  You can notice some patterns in the behavior of bytes at offsets 0x13 and 0x1b.  The second seems to correspond to the number of "songs" in our file.  And the first one also grows with the increase in the amount of data in the header - it looks like it is the size, only the count is not from the beginning of the file, but from the next byte 0x14.  At this stage, we can only guess about the type of numeric data.  Suppose that the size is of type UInt32, i.e.  takes 4 bytes.  Add them to our structure.  Now we can set the size of the header structure (size + 20). <br><img src="https://habrastorage.org/webt/av/ad/kt/avadkttmovx2nj_aj1gqdlnvvsk.jpeg"><br><div class="spoiler">  <b class="spoiler_title">Grammar with added file header structure</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ol/xd/lw/olxdlwqbmnyjybfbcrsvujibxta.jpeg"><br></div></div><br>  Let's see what comes next.  If you look closely, you can see that three-letter abbreviations are scattered throughout the file: SNG1, SDK1, SGS1, and so on.  These symbols are found in all SNG files, so we can assume that these are signatures of some blocks.  In addition, our title is very well ended just before one of these signatures.  Let's compare how the 4 bytes following it behave in files of different sizes.  It can be seen that the values ‚Äã‚Äãgrow with the amount of data. <br><img src="https://habrastorage.org/webt/kb/w-/4k/kbw-4kahz2btt_qwz-wd37pb-gu.jpeg"><br>  Some more experiments, analysis and calculations, and the following picture begins to emerge: <br><br><img src="https://habrastorage.org/webt/ld/jn/iy/ldjniyrqi4s8a_n_unggs2-b0sq.jpeg"><br><br><div class="spoiler">  <b class="spoiler_title">Alternative chart view</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/gj/tn/bv/gjtnbvwnqv4yr2nz0zdrl9irupg.jpeg"><br></div></div><br>  Thus, our file consists of a fairly simple hierarchy of blocks.  There are parent blocks that can contain several child blocks.  There are blocks-leaves (in the terminology of binary trees) that do not contain other blocks. <br><br>  Then the magic begins.  <b>With just a few grammar structures, we can fully automatically parse the block structure of the file.</b> <br><br>  So, create a DataChunk template structure with the following fields (the size is indicated in square brackets): <br><br>  id: string [4] <br>  size: int [4] <br>  hierarchy: int [4] <br>  data: structure <br><br>  Now create a parentChunk structure that inherits DataChunk.  In the hierarchy property, we indicate Fixed Value 0x400 - this is a sign of the parent unit.  Be sure to check the Must match checkbox <br><br>  Similarly, create childChunk.  Hierarchy in this case will have two values: 0x240100 and 0x100 <br><br>  Add links to the parentChunk and childChunk structures in the data parentChunk structure - this is how we create the recursion. <br><br>  Finally, add a link to the parentChunk structure to the main node. <br><img src="https://habrastorage.org/webt/jj/d3/gq/jjd3gq-5q330yazk-6q8fl1naa8.jpeg"><br>  The order of the elements in the data parentChunk structure must be Variable, you also need to set the minimum and maximum number of child elements of this structure: 0 and Unlimited, respectively. <br><br>  Apply the changes, and voila - our file is beautifully parsed into the main blocks. <br><img src="https://habrastorage.org/webt/ny/qx/pz/nyqxpztkqdknd1scoh63o28ezkq.jpeg"><br>  About the data itself, we still do not know, but now we can much easier to navigate the file and focus on finding the information we need. <br><br><h3>  Parsing the block containing the "table of contents" file </h3><br>  For training, let's try to disassemble some simple block, for example, SDK1.  Apparently, it contains something like a table of contents - a list of songs and, probably, some offsets / sizes. <br><img src="https://habrastorage.org/webt/zr/-r/dq/zr-rdqiljqlnsflxebu5e2nx8q0.jpeg"><br>  Create a sdk1Chunk structure inheriting from childChunk.  Edit the ID field by specifying the signature of our block in the Fixed Values ‚Äã‚Äãfield.  Do not forget about the checkbox Must match.  In the block data one can observe a rather obvious repeating pattern: the name of the ‚Äúsong‚Äù and so far unknown data.  Note that the size of the repeating fragments is 64 bytes.  Also, by comparing versions of files with different numbers of ‚Äúsongs,‚Äù you can determine that their number is stored in the first four bytes.  By simple calculations and making several assumptions, we obtain the following version of the structure in the grammar: <br><img src="https://habrastorage.org/webt/oo/mh/p3/oomhp3mjkz5pymbcxksszwdrn8w.jpeg"><br>  Here I created a 64-byte childInfo structure and indicated the possibility of repeating numSongs times.  Here is the result of the grammar: <br><img src="https://habrastorage.org/webt/0w/bi/th/0wbithoju1jbjec30hjxmo7tiwu.jpeg"><br>  Further analysis of the file remains a trick.  I changed the general settings of the ‚Äúsong‚Äù and the parameters of individual tracks on the synthesizer.  Comparing versions of files with various changes, you can improve and refine the grammar.  After a sufficiently large number of such iterations, there are almost no unrecognized pieces of data in the file.  I got a little carried away with the process and sorted out almost all sections of the file, although this was not required for the original task. <br><br><div class="spoiler">  <b class="spoiler_title">A small part of the grammar SNG file after 8 hours of parsing</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/td/zt/2b/tdzt2btswihzm3dxjubmbztvaa0.jpeg"><br></div></div><br>  I will miss the details of this process - in the future we will focus on the analysis of the musical data itself. <br><br>  But about this - in the next part.  In the same place, we will face an interesting task of data conversion (quite suitable for interviews), try to solve it with a small script and hear a rather unusual result of a test conversion. <br><br><h3>  Preliminary results </h3><br>  The need for reverse engineering of binary files may arise unexpectedly.  For example, to analyze the firmware of devices, convert from rare data formats, analyze digital threats, or even banal modifications to save games.  Modern tools allow you to solve these problems quickly and efficiently.  About 10 years ago, I was researching laptop firmware and this process could take several weeks.  Then it was required to manually write scripts to analyze data blocks and mark out the structure.  With a new partially automated approach, I created an almost complete grammar of a file in just a couple of days. <br><br>  You can start analyzing a binary file by searching for strings ‚Äî they can give the first hooks and speed up the analysis process.  Often binaries consist of data blocks that are organized in a hierarchical or linear structure.  If you deal with this structure, then further analysis will be much easier.  The file header can give hints on the offsets / sizes of data blocks.  At the first stages, it makes sense to focus on the description of obvious structures and blocks.  The analysis task is greatly simplified by the ability to create new versions of files with different settings, parameters, data.  There are a number of difficulties associated with unknown data types and byte order in their binary representation (Endianness).  We will address these questions in the next section. <br><br><h3>  Recommended literature </h3><br>  Andreas Pehnack.  How to Approach Binary File Format Analysis </div><p>Source: <a href="https://habr.com/ru/post/442580/">https://habr.com/ru/post/442580/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442570/index.html">Sigma rules. Craft or new standard for SOC</a></li>
<li><a href="../442572/index.html">Using the Datapath Config Tool</a></li>
<li><a href="../442574/index.html">Created the basis for a generalized theory of neural networks</a></li>
<li><a href="../442576/index.html">Long live overclockers: how liquid cooling has become dominant in data centers</a></li>
<li><a href="../442578/index.html">Linux 5.0 release</a></li>
<li><a href="../442582/index.html">How we tried mobbing</a></li>
<li><a href="../442584/index.html">Documents on the building: the small joys of automation on the example of the Dark Tower</a></li>
<li><a href="../442586/index.html">Vulnerability in Telegram allows you to bypass the password local code of any length</a></li>
<li><a href="../442588/index.html">Ask a question to the author of the language Lua</a></li>
<li><a href="../442592/index.html">Using Joomla Accounts in a Django Project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>