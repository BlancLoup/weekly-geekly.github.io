<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of MMO RPG - a practical guide. Server (Part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- Game backend: what modules should it consist of? 
- Calculation of character parameters: virtual methods or addition of arrays? 
- Behavior logic: a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of MMO RPG - a practical guide. Server (Part 1)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/121/6b8/f5c/1216b8f5cbb9490d8a80af1e5d2792cf.PNG" alt="Turret annihilator" align="left"><ul><li>  Game backend: what modules should it consist of? </li><li>  Calculation of character parameters: virtual methods or addition of arrays? </li><li>  Behavior logic: at what level should it be? </li><li>  Moving characters: who should manage this? </li></ul><br>  Today we will continue to get acquainted with the development and design of online games on the example of the space MMO RPG <a href="http://starghosts.com/index.php%3Ftrsrc%3D108%26trclcl%3D1%26tringame%3D1"><b>"Star Ghosts"</b></a> .  In this article we will talk about backend'e in C ++ and it will be thoroughly technical. <br><br>  There will be a lot of references to <a href="http://starghosts.com/index.php%3Ftrsrc%3D108%26trclcl%3D1%26tringame%3D1"><b>the Star Ghost</b></a> functionality in the text, but I will try to expound the material so that you do not need to delve into (and play) our product.  However, for a better understanding of the material, it is advisable to spend a couple of minutes and see how it all looks. <br><br>  In the article we will focus precisely on architectural solutions in relation to the backend of MMO RPG in real time.  The source code will not be much and it definitely will not contain such C ++ specific things as multiple inheritance or patterns.  The task of this article is to help in designing the game server and to acquaint everyone with the specifics of the game backend. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The solutions described are quite versatile and are quite suitable for many RPGs.  As an illustration, at the end of the article I will give an example of using the described architecture in the game "about elves". <br><a name="habracut"></a><br><h3>  <b>Technology selection</b> </h3><br>  In order to implement the gameplay we had planned, a server with a permanent socket connection and a sufficiently short response time to any user action was needed - no more than 50ms, not counting ping.  The choice of technologies that allowed to meet such requirements is not so great.  At that time, our campaign already had experience in implementing C ++ backend for a non-game project, and therefore the choice was made in favor of C ++: we had both people and experience in this technology. <br><br>  Perhaps Java (or some other technology) would be the best solution, but our team did not have a strong Java developer, let alone an architect with experience in creating server solutions.  In such a situation, hiring new specialists, spending months and tens of thousands of dollars to check which is better, as well as throw out working and tested C ++ code that we could easily reuse - all this went far beyond our budget and allotted development time. <br><br>  I find it difficult to answer whatever server came out in Java (or some other technology), but in C ++ we got exactly what we needed, moreover, in reasonable terms. <br><br><h3>  <b>General scheme of the server</b> </h3><br>  The server consists of the following modules (see Figure 1). <br><br><img src="https://habrastorage.org/files/6ac/785/b51/6ac785b518dd4e19bf3666f5302f6b28.png" alt="General scheme of the server"><br><br><ul><li>  <b>Ship</b> contains data about the devices and the current parameters of the ship, as well as the calculation of these parameters in accordance with the installed devices.  This is the lowest level on which all other server modules rely. </li><li>  <b>Space</b> is a module describing the world and objects in the world.  At this level, the objects appear their coordinates, the current motion vectors, the interaction of objects is realized (processing shots, causing damage, etc.). </li><li>  <b>AI</b> is a module that implements AI mobs, as well as specific NPC skills. </li><li>  <b>Quests</b> - the implementation of the quest system. </li><li>  <b>Main</b> - contains all the functionality responsible for user interaction (sockets, streams, etc.), as well as character-specific functionality (skills, buffs, achievements, craft, etc.). </li><li>  <b>Packets</b> is an auto-generated module that contains wrappers for packages and implements an RPC client &lt;-&gt; server. </li></ul><br>  In this part of the article we will look at the architecture of the Ship and Space modules.  The architecture of the remaining modules will be discussed in the next part of this article. <br><br><h3>  <b>Ship module</b> </h3><br>  <b>Prototype items and items</b> <br>  This module operates with material objects of the type "object".  That is, with everything that can be put in the hold, thrown into space, buy in a store or transfer to another player.  Also, this module considers the basic and derived from the installed devices ship parameters. <br><br><img src="https://habrastorage.org/files/469/3fd/821/4693fd8211b245e2a48431807d900df4.png" alt="Ship module class diagram"><br><br>  In fig.  2 shows a class diagram (the diagram is simplified for greater clarity).  You see the division of classes into two parts: below are the prototypes of objects, and at the top - the objects themselves.  Prototypes are completely static and faceless - they are loaded from the database, cannot change and do not belong to anyone.  Objects of objects (all descendants from ICargo), on the contrary, can be modified and contain a unique ID that allows you to identify a specific object and determine where it is (hold, warehouse, container in space, shop, etc.) .  This approach adds flexibility and allows you to modify the functionality of objects without affecting other classes. <br><br>  In our solution, the majority of descendants of ICargo (or rather, all but TDevice and TShip) are simply proxies for their prototypes.  Then the question arises: were they really needed?  After all, is it easier to create descendants of prototypes, with the addition of a unique ID for identification, and that‚Äôs the end of it?  No, not easier.  But with this approach, firstly, we would still need two classes for the subject (prototype and descendant), and secondly, we would have mixed dynamic data with static data (after all, the prototypes are unchanged).  On top of that, of course, the memory consumption and the creation time of the item would increase, because it would be necessary to clone the prototype with all its fields.  In confirmation of this, I will give the following example: initially we did not have chips in the game, and when they appeared, all the changes were reduced to adding a pair of TMicromodule / TMicromoduleProto classes with the addition of functionality for accounting for installed chips in TDevice.  The TShip class, like all other classes, was not affected at all. <br><br>  <b>Calculation of parameters of the ship and equipment</b> <br>  In <a href="http://starghosts.com/index.php%3Ftrsrc%3D108%26trclcl%3D1%26tringame%3D1"><b>"Star Ghosts"</b></a> there are many different types of devices (turrets, rocket launchers, radar, masking system, protective field, damage amplifiers, etc.).  It would seem that for each of them it is necessary to make a class flow from TDevice and implement specific functionality for this device there.  But let's take another look at the general scheme of the server and the description of the Ship module: this module basically simply provides the final design parameters of the ship to a higher level, while it does not perform the function of objects.  Let me explain by example.  The TShip class contains the ScanningRange parameter ‚Äî the radius of the radar operation ‚Äî but it does not actually filter objects in range.  And, most importantly, at the level of the Ship module, this filtering will not work, since the objects have no coordinates in space.  It's time to ask yourself: does it make sense to create a couple of classes TRadarPrototype (as a descendant from TProtoBase) and TRadar (as a descendant from TDevice), a separate table in the database for this class and a page in the admin just for the sake of one ScanningRange field?  The answer is obvious: the meaning of all these lines of code and classes is very dubious.  That is why we created one TStaticParams class, containing <i>all the</i> parameters that <i>any</i> device in the game can have, as well as the TPrototypeMod class, which can be loaded from the TStaticParams database. <br><br>  Of course, this is overkill, but not very large: at the moment the TStaticParams class contains only 34 fields of type int.  But in return, we received several excellent buns.  First, the ease of modification.  Now you can create new types of devices and parameters without creating new classes.  Secondly, the ease of counting parameters.  Simply add all the fields of the same name of all TStaticParams in the ship to get the final parameters!  No virtual calls or downcasts ‚Äî a simple ‚Äú+ =‚Äù operation in a loop.  Thirdly, we got game design flexibility.  For example, we have a chip in the game, which can be installed in any device, and it gives HP.  Such a mechanism allows game designers to frolic as they please, without at the same time tugging at each detail of the programmers like ‚Äúchildren, add me a kaparik here so that I can set a dodge bonus in the disguise device‚Äù. <br><br>  And that is not all.  Since we have one class with parameters for any device, we very easily managed to implement parameter randomization and sharpening.  TStaticParams is an array, so when creating a device, the game designer in the admin panel can specify up to three parameters (indices in the array), and the percentage of variation in these parameters.  When creating an item, TDevice first copies the data from TPrototypeMod.TStaticParams into its TStaticParams instance.  Then he scans the scatter indices, and if they are set, rolls the die and randomizes the parameters.  The value of the cube is stored in the TDevice fields so that after loading from the database the parameters do not change.  Sharpening is done in the same way: in the admin area, game designer specifies MainParam for the device.  That is, the device knows the parameter index, which must be increased by + 10% for each successful sharpening. <br>  But there is one caveat in calculating the parameters of the weapon: they cannot simply be summed up with the parameters of the other devices.  A simple summation will lead to the fact that if you have more than one weapon installed, then you add up, including such parameters as the WeaponRange of all the guns on board, although this should not be so.  On the other hand, if it is an artifact that increases the radius of the weapon, then we <i>must</i> add it to the WeaponRange of the weapon.  We solved this problem as follows: first, TStaticParams contains two arrays ‚Äî common parameters that can always be added safely (for example, HP, ScanningRange, etc.) and so-called WeaponParams, which generally cannot be added.  And only if the device is not a weapon, its parameters must be added to the parameters of the weapon.  It looks like this: <br><br><pre><code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> TShip::Recalc() {       m_xStatic.<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>);       TDevice* dev = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>;       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(unsigned i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;m_vSlots.size();i++) {             dev = m_vSlots[i].Device();             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !dev || !dev-&gt;IsOnline() ) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>;             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( dev-&gt;IsWeapon() ) {                   m_xStatic.AddDevice( dev-&gt;Static() );// HP               } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {                   m_xStatic.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>( dev-&gt;Static() );             }       }//<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(m_pStaticModifier) m_xStatic.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>( *m_pStaticModifier );//   ,   ,          //      -      ,           <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(unsigned i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;m_vSlots.size();i++) {             dev = m_vSlots[i].Device();             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !dev || !dev-&gt;IsOnline() || !dev-&gt;IsWeapon() ) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>;             dev-&gt;SetWeapon( &amp;m_xStatic );       }//<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i }</code> </pre> <br>  In the first cycle, we summarize all the parameters to the final parameters of the ship, but for the weapon we add only the general parameters, not the weapon ones.  Then we add the parameters of skills.  And, at the very end, we give the weapon a pointer to the TStaticParams from which it should add only the weapon parameters. <br><br>  <b>Shot calculation</b> <br>  In addition to calculating device parameters and checking whether it can be installed in a slot, the TShip class performs another function ‚Äî the calculation of shot parameters.  The SFireResult TShip :: Fire (NSlotPlace slot) method does this.  This method checks the possibility of a shot (whether it is a weapon at all, whether the device‚Äôs cooldown has ended, whether there are shot cartridges), calculates the damage inflicted, the number of shots fired, and also rolls the die for acceptable shot flags (such as critical damage).  All parameters are recorded in the SFireResult structure, the device is placed in cool down, ammunition is written off, the result of the shot is returned.  At the same time, TShip cannot check either the range or the parameters of the object being fired at (for example, if the object has protection and the damage needs to be reduced).  This makes the upper level Space, which has all the necessary data. <br><br>  <b>Other classes of the Ship module</b> <br>  The TProtoBase class contains general data for any subject, such as ImageID, Name, Level, etc. <br><br>  ICargo contains a pointer to TProtoBase and proxies its data to the outside, and also provides the Factory for creating objects.  This is helped by the TDeviceHandbook singleton class, which loads all the prototypes from the database and contains pointers to them. <br><br>  The TCargoBay class is a repository of ICargo objects.  It is able to maintain its state in the database and provides a number of service functions such as: searching for the nearest free slot, searching for a compatible piece of paper (for example, cartridges to combine with other cartridges), etc.  The descendants of this class impose restrictions on the types of stored items (for example, only ships can be stored in the hangar, and all but ships are in stock), and, if necessary, limits on the number of available storage cells. <br>  The IShipNotifyReciver class is an interface and provides a link to a higher level.  For example, sending a message on the start of regeneration to the Main level so that you can send the corresponding packet to the client. <br><br><h3>  <b>Space module</b> </h3><br>  This module operates with space objects (KO), such as spacecraft, asteroids, planets, etc.  All KOs have current coordinates in space and their motion vector.  The class diagram is shown in Figure 3 (for greater clarity, the diagram is somewhat simplified). <br><br><img src="https://habrastorage.org/files/b6a/172/465/b6a1724655034202b7ba1fa64e7c1be3.png" alt="Class diagram of the Space module"><br><br>  Despite the algorithmic complexity, from an architectural point of view, this module is quite simple.  All objects in space (ships, asteroids, planets, containers, star) are descendants of a TSpaceObject and are in an object of type TSystem.  TSpaceObject has current coordinates, size and two objects that control its behavior - this is FlyCommand (descendant from ISpaceFlyTo) and Action (descendant from ISpaceAction).  FlyCommand calculates the current coordinates of the object and its current speed (at a given time).  The calculation algorithm depends on the type of command: for movement in orbit it is one, for linear movement another, for movement with smooth turns - the third.  Action is responsible for more complex algorithms for moving an object.  For example, TFollowShipAction performs the pursuit of a specified goal.  To do this, in each call Update checks if the coordinates of the target have changed and, if so, replaces the FlyCommand command in the Owner (with the specified new coordinates of the target).  Introduction of Action allowed to significantly simplify the creation of AI and avoid duplication of code, since the functionality implemented in Action is necessary for players' ships and bots. <br><br>  The presence of FlyCommand makes it easy to specify the required type of motion for any object in space and transfer this command to the client in the form of motion equation coefficients.  This allows you to significantly reduce the amount of transmitted data and simplify the implementation of new behavior on the server side. <br><br>  <b>Causing damage</b> <br>  The TSpaceObject class has two virtual methods, CorrectDamage and ApplyDamage, and the TSystem class has a DoDamage method.  When an object wants to cause damage to another object (for example, an asteroid hit another object), it reports this to the TSystem.  The system calls CorrectDamage and, if the damage is not zero (for example, the planet is immune to any kind of damage), then it sends a message about the damage ‚Äúup‚Äù (to transfer to clients) and calls ApplyDamage so that the recipient performs specific actions (for example, the ship reduces HP and if HP is zero, the ship throws containers into space). <br><br>  The TSpaceShip class contains the FireSlot method, which implements special shooting.  It checks the allowable distance, then calls TShip :: Fire and, depending on the type of ability, performs further actions.  For example, for MissileLauncher creates rockets. <br><br>  <b>Other classes of the Space module</b> <br>  The ISpaceShipNotifyReciver class is used in TSpaceShip to send messages like ‚ÄúI was attacked‚Äù, ‚ÄúI am killed‚Äù, ‚Äúready for hyperjunction‚Äù, etc. to the upper module. <br><br>  The ISpaceSystemNotifyReciver class is used in the TSystem to send upward messages about the addition / removal of space objects, new FlyCommands, and damage. <br><br>  The TGalaxy class is a singleton and contains a list of all TSystem in the Galaxy. <br><br><h3>  <b>To be continued</b> </h3><br>  In the next article of the cycle we will consider the modules AI, Quest, Main, as well as some aspects of working with the database.  And, of course, the promised adaptation for the game "about elves". </div><p>Source: <a href="https://habr.com/ru/post/257985/">https://habr.com/ru/post/257985/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257971/index.html">Books and educational resources on algorithmic trading</a></li>
<li><a href="../257975/index.html">Messaging in Microsoft Azure, or How to communicate in the clouds</a></li>
<li><a href="../257977/index.html">Wiren Board 4 - controller for automation</a></li>
<li><a href="../257979/index.html">How I started working with nRF24LE or another way to program this chip</a></li>
<li><a href="../257981/index.html">Automatically Testing JavaFX Applications</a></li>
<li><a href="../257991/index.html">Features of API development on symfony2</a></li>
<li><a href="../258003/index.html">Artificial Intelligence in Wolfram Language: Image Identification Project</a></li>
<li><a href="../258005/index.html">Development for Microsoft SQL Server (and not only): version control, continuous integration and procedures - as we do</a></li>
<li><a href="../258007/index.html">HP P2000 G3 MSA Array System Firmware Update</a></li>
<li><a href="../258009/index.html">Lock for the designer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>