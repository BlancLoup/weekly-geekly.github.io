<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to cook AR on android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are interested in developing an AR application on Android, in particular, you want to write your ‚ÄúMasks‚Äù, or any other AR application, then you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to cook AR on android</h1><div class="post__text post__text-html js-mediator-article">  If you are interested in developing an AR application on Android, in particular, you want to write your ‚ÄúMasks‚Äù, or any other AR application, then you are here.  Here I will give you a brief insight into how this can be done, I do not think that I offer the best option, it may be easier to use ready-made frameworks, but at least it‚Äôs a working one and is not difficult to implement.  In general, in this case, as it seems to me, it is not necessary to use any additional weights, in the form of libraries or frameworks or anything else, since  it only clutters up all things, and it‚Äôs enough to use standard tools.  Here I will show how to work with the camera, how to process the image, and how to apply effects, I assume that the reader already knows how to create ‚ÄúHello world‚Äù on the android.  All this is under the cut. <br><a name="habracut"></a><br>  Once you finally decided to look into the article, I will try not to disappoint, and who knows, maybe after reading this article you will have a desire to write an application that will win the hearts of users and take its rightful place in the best applications. <br><br>  But I want to warn you right away that I will not post all the finished sources, I will give only the torn pieces, since  A good article should be like a miniskirt - short enough to attract interest and long enough to cover all the most important. <br><br>  I had to break the article into several parts, in the first we should get a working product without effects, then, of course, if the article is like, I‚Äôll tell you about the examples of the application of algorithms and effects.  The plan of the current article is to get an image from the camera, display the image via GLSurfaceView. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Obtaining images from the camera </h2><br>  And so ... Let's start with the fact that we need to receive a stream of images from the camera.  Android provides us with the Camera API, a description of which you can easily find on the <a href="https://developer.android.com/guide/topics/media/camera.html">official website</a> . <br>  Unfortunately, I will show you the way of working with the old android.hardware.camera package, and my newest android.hardware.camera2 did not reach my hands, but I think it‚Äôs a minor problem to redo it. <br><br>  First, we give permission to work with the camera: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.CAMERA"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  Add to our layout preview for the camera <br><br><pre> <code class="java hljs"> &lt;trolleg.CameraView android:id=<span class="hljs-string"><span class="hljs-string">"@+id/fd_fase_surface_view"</span></span> android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span> android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span> android:alpha=<span class="hljs-string"><span class="hljs-string">"0"</span></span>/&gt;</code> </pre><br>  Please note that we hide this element through alpha = 0, since  The preview will show only the stream from the camera in its original form, and we need to impose effects on it, but we can‚Äôt even use camera preview for the camera, sort of due to security reasons, so as not to make hidden video recordings. <br><br>  Next, we need to start the camera, comments in the code below, pieces of code were torn out of the project and slightly edited, so we‚Äôll have to refactor a little to get started. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CameraView</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SurfaceView</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SurfaceHolder</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Callback</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Camera</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewCallback</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> FrameCamera frameCamera = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FrameCamera(); <span class="hljs-comment"><span class="hljs-comment">//          ,        private static final int MAGIC_TEXTURE_ID = 10; boolean cameraFacing; private byte mBuffer[]; private static final String TAG = "CameraView"; private Camera mCamera; private SurfaceTexture mSurfaceTexture; int numberOfCameras; int cameraIndex; int previewWidth; int previewHeight; int cameraWidth; int cameraHeight; public CameraView(Context context, AttributeSet attrs) { super(context, attrs); cameraIndex = 0; //      numberOfCameras = android.hardware.Camera.getNumberOfCameras(); android.hardware.Camera.CameraInfo cameraInfo = new android.hardware.Camera.CameraInfo(); //      for (int i = 0; i &lt; numberOfCameras; i++) { android.hardware.Camera.getCameraInfo(i, cameraInfo); if (cameraInfo.facing == android.hardware.Camera.CameraInfo.CAMERA_FACING_FRONT) { cameraIndex = i; } } getHolder().addCallback(this); } @Override public void surfaceCreated(SurfaceHolder holder) { } @Override public void surfaceChanged(SurfaceHolder holder, int format, int w, int h) { previewHeight = h; previewWidth = w; startCameraPreview(w , h); } private void startCameraPreview(int previewWidthLocal, int previewHeightLocal) { releaseCamera(); mCamera = Camera.open(cameraIndex); Camera.Parameters params = mCamera.getParameters(); params.setPreviewFormat(ImageFormat.NV21); //    NV21,      //           ... mCamera.setParameters(params); //     - int size = cameraWidth * cameraHeight; size = size * ImageFormat.getBitsPerPixel(params.getPreviewFormat()) / 8; mBuffer = new byte[size]; try { //       mCamera.addCallbackBuffer(mBuffer); mCamera.setPreviewCallbackWithBuffer(this); //    mCamera.setPreviewDisplay(null); mCamera.startPreview(); } catch (Exception e){ Log.d(TAG, "Error starting camera preview: " + e.getMessage()); } } @Override public void surfaceDestroyed(SurfaceHolder surfaceHolder) { releaseCamera(); } @Override public void onPreviewFrame(byte[] data, Camera camera) { synchronized (frameCamera) { //        frameCamera.cameraWidth = cameraWidth; frameCamera.cameraHeight = cameraHeight; frameCamera.facing = cameraFacing; if (frameCamera.bufferFromCamera == null || frameCamera.bufferFromCamera.length != data.length) { frameCamera.bufferFromCamera = new byte[data.length]; } System.arraycopy(data, 0, frameCamera.bufferFromCamera, 0, data.length); frameCamera.wereProcessed = false; } //         mCamera.addCallbackBuffer(mBuffer); } public void disableView() { releaseCamera(); } public void enableView() { startCameraPreview(previewWidth, previewHeight); } }</span></span></code> </pre><br>  The camera will start with the launch of our created View. <br><br><h2>  Display image via GLSurfaceView </h2><br>  Next we start OpenGL, about which you can read on <a href="https://ru.wikipedia.org/wiki/OpenGL">wikipedia</a> .  In short, this is a standard for working with graphics through shaders.  Shaders are programs that run in parallel on the GPU cores; we will use vertex and fragment shaders.  The vertex shader is usually used to transform 3d coordinates onto a plane, and the fragment shader calculates the color of each pixel on the plane by approximating the coordinate on the plane to the texture coordinate of the projected object.  Enough of boring theory, then a bit of code.  Add the corresponding element to our layout: <br><br><pre> <code class="java hljs">&lt;android.opengl.GLSurfaceView android:id=<span class="hljs-string"><span class="hljs-string">"@+id/fd_glsurface"</span></span> android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span> android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span> /&gt;</code> </pre><br>  Make the necessary settings <br><br><pre> <code class="java hljs">GLSurfaceView gLSurfaceView = findViewById(R.id.fd_glsurface); gLSurfaceView.setEGLContextClientVersion(<span class="hljs-number"><span class="hljs-number">2</span></span>); gLSurfaceView.setEGLConfigChooser(<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); gLSurfaceView.getHolder().setFormat(PixelFormat.TRANSPARENT); gLSurfaceView.setRenderer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OurRenderer()); <span class="hljs-comment"><span class="hljs-comment">//      gLSurfaceView.setRenderMode(GLSurfaceView.RENDERMODE_CONTINUOUSLY);</span></span></code> </pre><br>  Next, create a renderer class, it will spin the entire logic of creating an image. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OurRenderer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GLSurfaceView</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Renderer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> programNv21ToRgba; <span class="hljs-comment"><span class="hljs-comment">//   nv21  rgba,      int texNV21FromCamera[] = new int[2]; // id- ,  \  UV //         ByteBuffer bufferY; ByteBuffer bufferUV; private void initShaders() { int vertexShaderId = ShaderUtils.createShader(GLES20.GL_VERTEX_SHADER, FileUtils.getStringFromAsset(context.getAssets(), "shaders/vss_2d.glsl")); int fragmentShaderId = ShaderUtils.createShader(GLES20.GL_FRAGMENT_SHADER, FileUtils.getStringFromAsset(context.getAssets(), "shaders/fss_n21_to_rgba.glsl")); programNv21ToRgba = ShaderUtils.createProgram(vertexShaderId, fragmentShaderId); } public void onSurfaceCreated(GL10 gl, EGLConfig config) { initShaders(); //     GLES20.glGenTextures(2, texNV21FromCamera, 0); GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texNV21FromCamera[0]); GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_CLAMP_TO_EDGE); GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_CLAMP_TO_EDGE); GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_NEAREST); GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_NEAREST); GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texNV21FromCamera[1]); GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_S, GLES20.GL_CLAMP_TO_EDGE); GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_WRAP_T, GLES20.GL_CLAMP_TO_EDGE); GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MIN_FILTER, GLES20.GL_NEAREST); GLES20.glTexParameteri(GLES20.GL_TEXTURE_2D, GLES20.GL_TEXTURE_MAG_FILTER, GLES20.GL_NEAREST); } //            GLSurfaceView.RENDERMODE_CONTINUOUSLY public void onDrawFrame(GL10 gl) { //      ,        synchronized (frameCamera) { mCameraWidth = frameCamera.cameraWidth; mCameraHeight = frameCamera.cameraHeight; int cameraSize = mCameraWidth * mCameraHeight; if (bufferY == null) { bufferY = ByteBuffer.allocateDirect(cameraSize); bufferUV = ByteBuffer.allocateDirect(cameraSize / 2); } //     nv21    : \  UV bufferY.put(frameCamera.bufferFromCamera, 0, cameraSize); bufferY.position(0); bufferUV.put(frameCamera.bufferFromCamera, cameraSize, cameraSize / 2); bufferUV.position(0); //  \ GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texNV21FromCamera[0]); GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, 0, GLES20.GL_LUMINANCE, mCameraWidth, (int) (mCameraHeight), 0, GLES20.GL_LUMINANCE, GLES20.GL_UNSIGNED_BYTE, bufferY); GLES20.GL_LUMINANCE, GLES20.GL_UNSIGNED_BYTE, bufferY); GLES20.glFlush(); //  UV    \+ALPHA,      ,       ,       GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texNV21FromCamera[1]); GLES20.glTexImage2D(GLES20.GL_TEXTURE_2D, 0, GLES20.GL_LUMINANCE_ALPHA, mCameraWidth / 2, (int) (mCameraHeight * 0.5), 0, GLES20.GL_LUMINANCE_ALPHA, GLES20.GL_UNSIGNED_BYTE, bufferUV); GLES20.GL_LUMINANCE_ALPHA, GLES20.GL_UNSIGNED_BYTE, bufferUV); GLES20.glFlush(); } //        nv21  rgba GLES20.glBindFramebuffer(GLES20.GL_FRAMEBUFFER, 0); // buffer 0 -     GlSurfaceView,     ,      GLES20.glViewport(0, 0, widthSurf, heightSurf); GLES20.glUseProgram(programNv21ToRgba); //     int vPos = GLES20.glGetAttribLocation(programNv21ToRgba, "vPosition"); int vTex = GLES20.glGetAttribLocation(programNv21ToRgba, "vTexCoord"); GLES20.glEnableVertexAttribArray(vPos); GLES20.glEnableVertexAttribArray(vTex); int ufacing = GLES20.glGetUniformLocation(programNv21ToRgba, "u_facing"); GLES20.glUniform1i(ufacing, facing1 ? 1 : 0); GLES20.glUniform1f(GLES20.glGetUniformLocation(programNv21ToRgba, "cameraWidth"), mCameraWidth); GLES20.glUniform1f(GLES20.glGetUniformLocation(programNv21ToRgba, "cameraHeight"), mCameraHeight); GLES20.glUniform1f(GLES20.glGetUniformLocation(programNv21ToRgba, "previewWidth"), widthSurf); GLES20.glUniform1f(GLES20.glGetUniformLocation(programNv21ToRgba, "previewHeight"), heightSurf); ShaderEffectHelper.shaderEffect2dWholeScreen(new Point(0, 0), new Point(widthSurf, heightSurf), texNV21FromCamera[0], programNv21ToRgba, vPos, vTex, texNV21FromCamera[1]); }</span></span></code> </pre><br>  Here is our auxiliary method of calling a shader, it divides the texture into two triangles and applies a linear affine transformation to them, if in a simple way. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ShaderEffectHelper</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shaderEffect2dWholeScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Point center, Point center2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> texIn, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> programId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> poss, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> texx, Integer texIn2)</span></span></span><span class="hljs-function"> </span></span>{ GLES20.glUseProgram(programId); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> uColorLocation = GLES20.glGetUniformLocation(programId, <span class="hljs-string"><span class="hljs-string">"u_Color"</span></span>); GLES20.glUniform4f(uColorLocation, <span class="hljs-number"><span class="hljs-number">0.0f</span></span>, <span class="hljs-number"><span class="hljs-number">0.0f</span></span>, <span class="hljs-number"><span class="hljs-number">1.0f</span></span>, <span class="hljs-number"><span class="hljs-number">1.0f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> uCenter = GLES20.glGetUniformLocation(programId, <span class="hljs-string"><span class="hljs-string">"uCenter"</span></span>); GLES20.glUniform2f(uCenter, (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)center.x, (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)center.y); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> uCenter2 = GLES20.glGetUniformLocation(programId, <span class="hljs-string"><span class="hljs-string">"uCenter2"</span></span>); GLES20.glUniform2f(uCenter2, (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)center2.x, (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)center2.y); <span class="hljs-comment"><span class="hljs-comment">//        FloatBuffer vertexData = convertArray(new float[]{ -1, -1, -1, 1, 1, -1, 1, 1 }); //        FloatBuffer texData = convertArray(new float[] { 0, 0, 0, 1, 1, 0, 1, 1 }); GLES20.glVertexAttribPointer(poss, 2, GLES20.GL_FLOAT, false, 0, vertexData); GLES20.glVertexAttribPointer(texx, 2, GLES20.GL_FLOAT, false, 0, texData); GLES20.glActiveTexture(GLES20.GL_TEXTURE0); GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texIn); GLES20.glUniform1i(GLES20.glGetUniformLocation(programId, "sTexture"), 0); if (texIn2 != null) { GLES20.glActiveTexture(GLES20.GL_TEXTURE1); GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texIn2); GLES20.glUniform1i(GLES20.glGetUniformLocation(programId, "sTexture2"), 1); } GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, 0, 4); // ,    4       ,         GLES20.glFlush(); } ...</span></span></code> </pre><br>  You can read about the NV21 format <a href="https://en.wikipedia.org/wiki/YUV">here</a> .  In short, the image format of the NV21 is a matrix of pixels of a b \ b image, followed by a difference of colors Y and U for every four pixels of a b \ b of an image, and the total is 4 h of a byte and 2 bytes of a difference of colors, we reduce the fraction 2 to 1, i.e.  NV21. <br><br>  Here are our shaders to translate nv21 into rgba.  Vertex shader (vss_2d.glsl): <br><br><pre> <code class="java hljs">attribute vec2 vPosition; attribute vec2 vTexCoord; varying vec2 texCoord; uniform mat4 uMVP; <span class="hljs-comment"><span class="hljs-comment">// for 2d triangles varying vec2 v_TexCoordinate; varying vec2 v_TexOrigCoordinate; // simple coomon 2d shader void main() { texCoord = vTexCoord; v_TexCoordinate = vTexCoord; v_TexOrigCoordinate = vec2(vPosition.x / 2.0 + 0.5, vPosition.y / 2.0 + 0.5); gl_Position = vec4 ( vPosition.x, vPosition.y, 0.0, 1.0 ); }</span></span></code> </pre><br>  And the fragment shader (fss_n21_to_rgba.glsl), it centers, changes scale and transforms color <br><br><pre> <code class="java hljs">precision mediump <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>; uniform sampler2D sTexture; <span class="hljs-comment"><span class="hljs-comment">// y - texture uniform sampler2D sTexture2; //uv texture varying vec2 texCoord; uniform int u_facing; uniform float cameraWidth; uniform float cameraHeight; // remember, camera is rotated 90 degree uniform float previewWidth; uniform float previewHeight; const mat3 yuv2rgb = mat3( 1, 0, 1.2802, 1, -0.214821, -0.380589, 1, 2.127982, 0 ); // shader from convert NV21 to RGBA void main() { vec2 coord = vec2(texCoord.y, texCoord.x); if (u_facing == 0) coord.x = 1.0 - coord.x; // centered pic by maximum size coord.y = 1.0 - coord.y; if (previewWidth / previewHeight &gt; cameraHeight / cameraWidth) { coord.x = 0.5 - (0.5 - coord.x) * previewHeight * (cameraHeight / previewWidth) / cameraWidth;// (cameraHeight / cameraWidth) * (previewWidth / previewHeight); } else if (previewWidth / previewHeight &lt; cameraHeight / cameraWidth) { coord.y = 0.5 - (0.5 - coord.y) * previewWidth * (cameraWidth / previewHeight) / cameraHeight; } float y = texture2D(sTexture, coord).r; float u = texture2D(sTexture2, coord).a; float v = texture2D(sTexture2, coord).r; vec4 color; // another way sligthly lighter // TODO find correct way of transfromation color.r = (1.164 * (y - 0.0625)) + (1.596 * (v - 0.5)); color.g = (1.164 * (y - 0.0625)) - (0.391 * (u - 0.5)) - (0.813 * (v - 0.5)); color.b = (1.164 * (y - 0.0625)) + (2.018 * (u - 0.5)); color.a = 1.0; vec3 yuv = vec3( 1.1643 * y - 0.0627, u - 0.5, v - 0.5 ); vec3 rgb = yuv * yuv2rgb; color = vec4(rgb, 1.0); gl_FragColor = color; }</span></span></code> </pre><br>  It seems to me that the source is too much, I suggest to stop at this place. <br><br><h2>  Finally </h2>  Congratulations, you honestly got to the end or quickly scrolled down, nevertheless, let's summarize some results.  If everything is put together, it turns out that we have learned how to start the camera, get an image, transform it into a shader texture and show it on the screen of the phone.  In the next article, if you like this one, I will write how to twist the algorithm, for example, search for a face on a frame using OpenCV and impose the simplest effect. <br><br>  upd. <br>  This study is supported by the Foundation for Assistance to the Development of Small Enterprises in the Scientific and Technical Sphere under the program ‚ÄúUMNIK‚Äù on the topic ‚ÄúDeveloping a computer program for imposing objects of augmented reality ...‚Äù as part of agreement No. 10858GU2016 dated December 29, 2016 </div><p>Source: <a href="https://habr.com/ru/post/347140/">https://habr.com/ru/post/347140/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347128/index.html">JUndo - undo library for Java</a></li>
<li><a href="../347130/index.html">7 types of office loafers - part one</a></li>
<li><a href="../347132/index.html">We comprehend C deeper using assembler. Part 3</a></li>
<li><a href="../347134/index.html">16 Tons. How I saved a dying WordPress site with very superficial knowledge of this CMS</a></li>
<li><a href="../347138/index.html">Making games in Python 3 and Pygame: Part 1</a></li>
<li><a href="../347144/index.html">CoffeeMiner: hacking WiFi to embed a crypto miner in HTML pages</a></li>
<li><a href="../347146/index.html">Query Profiler in Phoenix. And a little bit about how stacktrace works in Elixir / Erlang</a></li>
<li><a href="../347148/index.html">The digest of interesting materials for the mobile # 237 developer (January 15-21)</a></li>
<li><a href="../347152/index.html">Account Manager: accounts, tokens and all-all-all. Yandex lecture</a></li>
<li><a href="../347154/index.html">Service control panel. Part 2. On the way to the frontend</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>