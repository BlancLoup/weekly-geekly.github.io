<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Receive notifications from external services, or why Hooksler was made</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, service for command communication Slack has become very popular. Out of the box, it has a considerable number of integrations with various s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Receive notifications from external services, or why Hooksler was made</h1><div class="post__text post__text-html js-mediator-article">  Recently, service for command communication <a href="https://slack.com/">Slack</a> has become very popular.  Out of the box, it has a considerable number of integrations <a href="https://slack.com/integrations">with various services</a> + a fairly convenient external API.  But with all this, free accounts have a 5 integration limit.  We hooked github, newrelic + a couple of boards with trello and that's it, the number of them ended.  You can use the universal <a href="https://api.slack.com/incoming-webhooks">Incoming WebHook</a> , but it itself has its own format and is in no way compatible with other services.  But the programmer would not be a programmer if he did not solve this problem. <br><a name="habracut"></a><br>  The solution is simple as a hammer.  We accept hooks from services ourselves, we process and throw in Slack in the form we need. <br>  Along with the integration, <a href="https://github.com/tinyspeck/hammock">hammock</a> was found in the list, which is written in PHP and has some <a href="https://github.com/tinyspeck/hammock/tree/master/plugins">set of plug-ins</a> , but this solution was not particularly liked.  Although there are ready-made integrations, but alas, there is no one that is needed, and since I am familiar with PHP at the level of reading the code and ‚Äúcorrecting something according to the directory,‚Äù I didn‚Äôt want to write my own. <br><br>  Therefore, I made decisions to write my service.  I decided to build completely on a modular basis: the core and separate modules for ‚Äúinput‚Äù and ‚Äúoutput‚Äù.  Ruby was used as a language, its dynamic nature was very helpful in the implementation of the plan. <br><br>  So, welcome 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Hooksler </h2><br>  Allows you to assemble a service with a minimum of code for receiving notifications and sending them further.  To configure using your DSL: <br><br><pre><code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'hooksler/slack'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'hooksler/newrelic'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'hooksler/trello'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'dotenv'</span></span> Dotenv.load Hooksler::Router.config <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> secret_code <span class="hljs-string"><span class="hljs-string">'very_secret_code'</span></span> host_name <span class="hljs-string"><span class="hljs-string">'http://example.com'</span></span> endpoints <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> input <span class="hljs-string"><span class="hljs-string">'simple'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:simple</span></span> input <span class="hljs-string"><span class="hljs-string">'newrelic'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:newrelic</span></span> input <span class="hljs-string"><span class="hljs-string">'trello'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:trello</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">create:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">public_key:</span></span> ENV[<span class="hljs-string"><span class="hljs-string">'TRELLO_KEY'</span></span>], <span class="hljs-symbol"><span class="hljs-symbol">member_token:</span></span> ENV[<span class="hljs-string"><span class="hljs-string">'TRELLO_TOKEN'</span></span>], <span class="hljs-symbol"><span class="hljs-symbol">board_id:</span></span> ENV[<span class="hljs-string"><span class="hljs-string">'TRELLO_ID1'</span></span>] output <span class="hljs-string"><span class="hljs-string">'black_hole'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:dummy</span></span> output <span class="hljs-string"><span class="hljs-string">'slack_out'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:slack</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">url:</span></span> ENV[<span class="hljs-string"><span class="hljs-string">'SLACK_WEBHOOK_URL'</span></span>], <span class="hljs-symbol"><span class="hljs-symbol">channel:</span></span> <span class="hljs-string"><span class="hljs-string">'#test'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> route <span class="hljs-string"><span class="hljs-string">'simple'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'slack_out'</span></span> route <span class="hljs-string"><span class="hljs-string">'trello'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'black_hole'</span></span>, <span class="hljs-string"><span class="hljs-string">'slack_out'</span></span>] route <span class="hljs-string"><span class="hljs-string">'newrelic'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'black_hole'</span></span>, <span class="hljs-string"><span class="hljs-string">'slack_out'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  At the beginning, I / O points are declared, each has its own name and type, and may also contain additional parameters for initialization.  The following are the routes.  You can specify in one form: one to one, one to many, and vice versa. <br>  Also on each route, you can hang filters that can both modify the message and filter it.  Thus, we obtain a sufficiently flexible kernel for routing messages from point A to point B. <br>  Messages inside are transmitted in the internal representation, while it is known from which service (its type) it was received + the original message.  Upon receipt, typical fields are filled in: user, text, title, link, level.  In the future, they can be used to generate a notification. <br>  Currently fully implemented, tested and covered with tests core.  Several integrations have also been implemented: trello, newrelic, slack.  Its integration is very easy to write. <br><br><h3>  Some practice </h3><br><h4>  Receive messages </h4><br>  For example, let's make a module that allows placing the body of a POST request in the message field. <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DummyInput</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extend</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hooksler::Channel::Input</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">register</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dummy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build_message</span></span></span><span class="hljs-class">({}) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  We declare a class and expand it with the appropriate module.  Then register his name.  All after that we are ready to receive and process incoming data.  Request processing is performed in the <b>load</b> method, which takes only one parameter ‚Äî an object of the class <b>Rack :: Request</b> .  We do not need any complex processing, so we immediately create a message and fill in the field.  After that, it will go further along the routes described in the configuration.  For sending, several messages can be created at once, i.e.  the <b>load</b> method returns an array.  In the future, each object is processed separately. <br><br><h4>  Sending messages </h4><br>  Just as easy to make a module for sending, which will allow us to see the messages received in the console: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DummyOutput</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extend</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hooksler::Channel::Output</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">register</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dummy</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dump</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">puts</span></span></span><span class="hljs-class"> "-- </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{message.title} : #{message.level} --" puts message.user puts message.message puts message.url end end</span></span></span></span></code> </pre><br>  Perform similar actions as for the incoming, just select the appropriate expansion module.  Sending, in our case, output to the console, is performed in the <b>dump</b> method.  The name of the method is controversial, but send was already taken, did not want to override. <br><br>  Now we will collect all this and describe the routes: <br><br><pre> <code class="ruby hljs">Hooksler::Router.config <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> secret_code <span class="hljs-string"><span class="hljs-string">'very_secret_code'</span></span> host_name <span class="hljs-string"><span class="hljs-string">'http://example.com'</span></span> endpoints <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> input <span class="hljs-string"><span class="hljs-string">'in'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:dummy</span></span> output <span class="hljs-string"><span class="hljs-string">'out'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:dummy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> route <span class="hljs-string"><span class="hljs-string">'in'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'out'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Specify the code that is used to generate the paths and the host on which our service will hang.  Run and ready.  The final paths can be viewed by contacting <a href="http://example.com/_endpoints_">http://example.com/_endpoints_</a> , the response will be JSON.  A more detailed example can be found in the DEMO application: <a href="https://github.com/hooksler/hooksler-demo">github.com/hooksler/hooksler-demo</a> <br><br>  Thus, without much effort, you can set up sending messages simultaneously to different points: receive changes from Trello, send them to Slack, or send especially important ones (for example, containing keywords or tags) to the phone via push.  You can come up with a bunch of schemes, the benefit of the foundation is flexible. <br><br><h3>  More practical example </h3><br>  The other day there was a task to automate the process of inviting users to Slack.  Manually adding each one is long and tedious, and you cannot make an open registration out of the box.  On the Internet there is a ready-made form for nodejs.  But since  I already have a working hooksler decided to do on it.  To begin with, you need to somehow get the correct mail, for this, I took the opportunity of Mandrill to wrap up incoming messages in Webhook (just what the doctor ordered).  Next, create an inbox, configure Webhook, and write our receiver: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'hashie'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hooksler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mandrill</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extend</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hooksler::Channel::Input</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">register</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mandrill</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashie::Mash</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unless</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">content_type</span></span></span><span class="hljs-class"> == '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">application</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">www</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">urlencoded</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">action</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payload</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">POST</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unless</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">action</span></span></span><span class="hljs-class"> == '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mandrill_events</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payload</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MultiJson</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payload</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payload</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">map</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">build_message</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">begin</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method_name</span></span></span><span class="hljs-class"> = "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for_</span></span></span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{event['event']}" self.send method_name, msg, event if respond_to? method_name rescue end end end end def for_inbound(msg, event) msg.message = event['msg']['text'] || event['msg']['html'] msg.title = event['msg']['subject'] msg.user = event['msg']['headers']['From'] end end end end</span></span></span></span></code> </pre><br><br>  We accept events, we wrap up in Message and helmet on.  Now we need the code that will perform inviting users: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SlackInviteOutbound</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extend</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hooksler::Channel::Output</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">register</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">slack_invite</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dump</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unless</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source</span></span></span><span class="hljs-class"> == :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mandrill</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raw</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">']['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from_email</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class"> = "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">https</span></span></span><span class="hljs-class">://</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span></span><span class="hljs-class"><span class="hljs-comment">[:team]}.slack.com/api/users.admin.invite" HTTParty.post url, body: { email: email, token: </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span></span><span class="hljs-class"><span class="hljs-comment">[:token], set_active: true } end end</span></span></span></span></code> </pre><br><br>  We accept the message, check that it came from Mandrill, receive an email, request and user invited.  At the same time, we are sure that the box is valid. <br><br>  As a final touch, routing setup: <br><br><pre> <code class="ruby hljs">endpoints <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> input <span class="hljs-string"><span class="hljs-string">'slack_invite'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:mandrill</span></span> output <span class="hljs-string"><span class="hljs-string">'slack_invite'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:slack_invite</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">team:</span></span> <span class="hljs-string"><span class="hljs-string">'myteam'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">token:</span></span> <span class="hljs-string"><span class="hljs-string">'mysupersecrettoken'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> route <span class="hljs-string"><span class="hljs-string">'slack_invite'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'slack_invite'</span></span></code> </pre><br>  Run and enjoy the process. <br><br><h4>  Finally </h4><br>  I have been using this solution for some time already, while there were no problems - everything runs steadily.  The only thing for trello is that not all cases are processed, it‚Äôs too many different types of notifications.  Also, for Slack, its own formatting modules were made, who are interested can see <a href="">an example here</a> . <br><br>  In the future, plans to expand the number of adapters for receiving and sending messages.  I hope this decision will be useful to someone else. <br><br>  Criticism and suggestions are welcome, error messages in the text in a personal. <br><br>  Hooksler itself and adapters are available on Github: <a href="https://github.com/hooksler">github.com/hooksler</a> </div><p>Source: <a href="https://habr.com/ru/post/261799/">https://habr.com/ru/post/261799/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261781/index.html">About the intricacies of privacy in the Telegram Bots API: ‚Äúthis is not a bug, this is a feature‚Äù</a></li>
<li><a href="../261783/index.html">Vim in full: Working with Git</a></li>
<li><a href="../261785/index.html">Seven amazing "features" Javascript</a></li>
<li><a href="../261787/index.html">Remote injection of Wi-Fi frames</a></li>
<li><a href="../261789/index.html">And do not you go to the clouds?</a></li>
<li><a href="../261801/index.html">Introducing Nim: writing a console 2048</a></li>
<li><a href="../261803/index.html">Magic of tensor algebra: Part 4 - Dynamics of a point in a tensor statement</a></li>
<li><a href="../261807/index.html">STM32, C ++ and FreeRTOS. Development from scratch. Part 1</a></li>
<li><a href="../261811/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ167 (June 29 - July 4, 2015)</a></li>
<li><a href="../261813/index.html">Ford recalls almost 500 thousand cars because of a bug in software</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>