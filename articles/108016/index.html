<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>5 things you did not know about multithreading</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At least few Java programmers refuse from multithreading and libraries that support it, but those who have found time to study the issue in depth are ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>5 things you did not know about multithreading</h1><div class="post__text post__text-html js-mediator-article">  At least few Java programmers refuse from multithreading and libraries that support it, but those who have found time to study the issue in depth are even less.  Instead, we learn about flows only as much as we need for a specific task, adding new tricks to our toolkit only when necessary.  So you can create and run decent applications, but you can do better.  Understanding the features of the compiler and the Java virtual machine will help you write more efficient, productive code. <br><br>  In this issue of the <a href="http://www.ibm.com/developerworks/views/java/libraryview.jsp%3Fsearch_by%3D5%2Bthings%2Byou%2Bdid">‚Äú5 Things ...‚Äù series</a> , I will introduce some of the subtle aspects of multi-threaded programming, including synchronized methods, volatile variables, and atomic classes.  It focuses specifically on how some of these constructs interact with the JVM and the Java compiler, and how various interactions can affect application performance. <a name="habracut"></a><br><br>  <b>Translator‚Äôs note:</b> I‚Äôm one of those people who didn‚Äôt know these five things about multithreaded programming, so I thought that this article was worth it to be made public here, but that‚Äôs why I could make some mistakes in translation, so the amendments are welcome with enthusiasm. <br>  <b>Translator's note2:</b> in the comments, knowledgeable people share links and information on the topic, no less interesting than the content of the article) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  1. Synchronized method or synchronized block? </h4><br>  You may have already thought about whether to declare synchronized the whole method or only that part of it that needs to be secure.  In such situations, it is useful to know that when the Java compiler converts the source code into byte code, it works with synchronized methods and synchronized blocks in very different ways. <br><br>  When the JVM executes the synchronized method, the executing thread determines that the method_info of this method has the ACC_SYNCHRONIZED flag.  Then it automatically sets a lock on the object, calls the method and removes the lock.  If an exception is thrown, the thread automatically releases the lock. <br>  On the other hand, the synchronized block bypasses the support of object locking requests and exception handling built into the JVM, so this must be explicitly described in bytecode.  If you look at the byte-code for the block, you will see a bunch of additional operations in it in comparison with the method.  Listing 1 shows a call for both. <br><br>  <b>Listing 1. Two approaches to synchronization.</b> <br><blockquote>  <font color="#000000">package</font> <font color="#006699">com.geekcap</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">class</font> SynchronizationExample <font color="#009900">{</font> <br>  <font color="#000000">private</font> <font color="#000066">int</font> i <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000000">synchronized</font> <font color="#000066">int</font> synchronizedMethodGet <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">return</font> i <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#000066">int</font> synchronizedBlockGet <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">synchronized</font> <font color="#009900">(</font> <font color="#000000">this</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">return</font> i <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> </blockquote><br>  The synchronizedMethodGet () method generates the following bytecode: <br><pre>  0: aload_0
	 1: getfield
	 2: nop
	 3: iconst_m1
	 4: ireturn </pre><br>  Here is the bytecode for the synchronizedBlockGet () method: <br><pre>  0: aload_0
	 1: dup
	 2: astore_1
	 3: monitorenter
	 4: aload_0
	 5: getfield
	 6: nop
	 7: iconst_m1
	 8: aload_1
	 9: monitorexit
	 10: ireturn
	 11: astore_2
	 12: aload_1
	 13: monitorexit
	 14: aload_2
	 15: athrow </pre><br>  Creating a synchronized block yielded 16 strings of bytecode, while the synchronized method produced only 5. <br><br><h4>  2. "Intraflow" (ThreadLocal) variables. </h4><br>  If you want to keep one instance of a variable for all instances of a class, you use static class variables.  If you want to keep an instance variable for each thread, use threading variables.  ThreadLocal variables differ from ordinary variables in that each thread has its own, individually initialized instance of a variable, which it gets access to via get () or set () methods. <br><br>  Suppose you are developing a multi-threaded code tracer whose goal is to uniquely determine the path of each stream through your code.  The problem is that you need to coordinate several methods in several classes across multiple threads.  Without ThreadLocal this would be intractable.  When a thread starts to run, it would be necessary to generate a unique marker to identify it with the tracer, and then pass this marker to each method during the trace. <br><br>  With ThreadLocal this is easier.  The thread initializes the ThreadLocal variable at the beginning of execution, and then accesses it from each method in each class, and the variable will only keep trace information for the thread that is currently executing.  When its execution is complete, the thread can pass its individual trace record to the control object responsible for maintaining all the records. <br><br>  Using ThreadLocal makes sense when you need to store instances of a variable for each thread. <br><br><h4>  3. Volatile variables. </h4><br>  I estimate that only half of all Java developers know that Java has the keyword volatile.  Of these, only about 10 percent know what it means, and even less know how to use it effectively.  In short, defining a variable with the keyword volatile (‚Äúchangeable‚Äù) means that the value of the variable will change in different threads.  To fully understand what volatile means, first, you need to understand how threads operate on regular, non-volatile, variables. <br><br>  In order to improve performance, the Java language specification allows the JRE to store a local copy of a variable in each stream that references it.  You can consider these ‚Äúintra-stream‚Äù copies of variables similar to a cache, which helps to avoid checking the main memory every time you need access to the value of a variable. <br><br>  But imagine what happens in the following case: two threads start, and the first one reads variable A as 5, while the second one reads 10. If variable A changes from 5 to 10, then the first thread will not know about the change, so it will have wrong value A. However, if variable A is marked as volatile, then at any time, when a thread accesses its value, it will receive a copy of A and read its current value. <br><br>  If the variables in your application do not change, then the intra-stream cache makes sense.  Otherwise, it‚Äôs very useful to know what the volatile keyword can do for you. <br><br><h4>  4. Volatile vs. synchronized. </h4><br>  If a variable is declared as volatile, this means that it is expected to change in several threads.  Naturally, you think that the JRE will impose some form of synchronization for volatile variables.  For better or worse, the JRE implicitly provides synchronization when accessing volatile variables, but with one very big caveat: reading volatile variables is synchronized and writing to volatile variables is synchronized, and non-atomic operations are not. <br>  Which means that the following code is not safe for threads: <br><blockquote>  myVolatileVar <font color="#339933">++;</font> </blockquote><br>  This code can also be written as follows: <br><blockquote>  <font color="#000066">int</font> temp <font color="#339933">=</font> <font color="#cc66cc">0</font> <font color="#339933">;</font> <br>  synchronize <font color="#009900">(</font> myVolatileVar <font color="#009900">)</font> <font color="#009900">{</font> <br>  temp <font color="#339933">=</font> myVolatileVar <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  temp <font color="#339933">++;</font> <br><br>  synchronize <font color="#009900">(</font> myVolatileVar <font color="#009900">)</font> <font color="#009900">{</font> <br>  myVolatileVar <font color="#339933">=</font> temp <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br></blockquote><br>  In other words, if the volatile variable is updated implicitly, that is, the value is read, changed, and then assigned as new, the result will be non-thread safe between two synchronous operations.  You can choose whether to use synchronization or rely on JRE support for automatic synchronization of volatile variables.  The best approach depends on your case: if the assigned value of a volatile variable depends on its current value (for example, during an increment operation), you need to use synchronization if you want the operation to be thread-safe. <br><br><h4>  5. Updates of atomic fields. </h4><br>  When you need a primitive type that performs increment and decrement operations, it is much better to choose it among the new atomic classes in the java.util.concurrent.atomic package than to write the synchronized block yourself.  Atomic classes guarantee that certain operations will be performed thread-safe, such as increment and decrement, update, and add (add) value operations.  The list of atomic classes includes AtomicInteger, AtomicBoolean, AtomicLong, AtomicIntegerArray, and so on. <br><br>  A peculiar challenge to the programmer in using atomic classes is that all operations of a class, including get, set, and the family of get-set operations are also atomic.  This means that read and write operations that do not change the value of an atomic variable are synchronized, and not just important read-update-write operations.  If you want more detailed control over the deployment of synchronized code, then a workaround is to use an atomic field update. <br><h5>  Using atomic update. </h5><br>  Atomic updates such as AtomicIntegerFieldUpdater, AtomicLongFieldUpdater, and AtomicReferenceFieldUpdater are essentially shells that apply to volatile fields.  Inside, Java class libraries use them.  Although they are not often used in application code, you have no reason not to start lightening your life with them. <br><br>  Listing 2 shows an example of a class that uses atomic updates to modify a book that someone is reading: <br>  <b>Listing 2. Book class.</b> <br><blockquote>  <font color="#000000">package</font> <font color="#006699">com.geeckap.atomicexample</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000000">class</font> <font color="#003399">Book</font> <br>  <font color="#009900">{</font> <br>  <font color="#000000">private</font> <font color="#003399">String</font> name <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#003399">Book</font> <font color="#009900">(</font> <font color="#009900">)</font> <br>  <font color="#009900">{</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#003399">Book</font> <font color="#009900">(</font> <font color="#003399">String</font> name <font color="#009900">)</font> <br>  <font color="#009900">{</font> <br>  <font color="#000000">this</font> .  <font color="#006633">name</font> <font color="#339933">=</font> name <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#003399">String</font> getName <font color="#009900">(</font> <font color="#009900">)</font> <br>  <font color="#009900">{</font> <br>  <font color="#000000">return</font> name <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#000066">void</font> setName <font color="#009900">(</font> <font color="#003399">String</font> name <font color="#009900">)</font> <br>  <font color="#009900">{</font> <br>  <font color="#000000">this</font> .  <font color="#006633">name</font> <font color="#339933">=</font> name <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br></blockquote><br>  The Book class is just a POJO (plain old Java object is a plain old Java object) that has only one field: name. <br><br>  <b>Listing 3. The MyObject class.</b> <br><blockquote>  <font color="#000000">package</font> <font color="#006699">com.geeckap.atomicexample</font> <font color="#339933">;</font> <br><br>  <font color="#000000">import</font> <font color="#006699">java.util.concurrent.atomic.AtomicReferenceFieldUpdater</font> <font color="#339933">;</font> <br><br>  <font color="#008000">/ **</font> <font color="#008000"><br></font>  <font color="#008000">*</font> <font color="#008000"><br></font>  <font color="#008000">* @author shaines</font> <font color="#008000"><br></font>  <font color="#008000">* /</font> <br>  <font color="#000000">public</font> <font color="#000000">class</font> MyObject <br>  <font color="#009900">{</font> <br>  <font color="#000000">private</font> <font color="#000000">volatile</font> <font color="#003399">Book</font> whatImReading <font color="#339933">;</font> <br><br>  <font color="#000000">private</font> <font color="#000000">static</font> <font color="#000000">final</font> AtomicReferenceFieldUpdater <font color="#339933">&lt;</font> MyObject, Book <font color="#339933">&gt;</font> updater <font color="#339933">=</font> <br>  AtomicReferenceFieldUpdater.  <font color="#006633">newUpdater</font> <font color="#009900">(</font> <br>  MyObject.  <font color="#000000">class</font> <font color="#003399">Book</font> .  <font color="#000000">class</font> , <font color="#0000ff">"whatImReading"</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#003399">Book</font> getWhatImReading <font color="#009900">(</font> <font color="#009900">)</font> <br>  <font color="#009900">{</font> <br>  <font color="#000000">return</font> whatImReading <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#000066">void</font> setWhatImReading <font color="#009900">(</font> <font color="#003399">Book</font> whatImReading <font color="#009900">)</font> <br>  <font color="#009900">{</font> <br>  <font color="#666666">//this.whatImReading = whatImReading;</font> <br>  updater.  <font color="#006633">compareAndSet</font> <font color="#009900">(</font> <font color="#000000">this</font> , <font color="#000000">this</font> . <font color="#006633">whatImReading</font> , whatImReading <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br></blockquote><br>  The MyObject class in Listing 3 represents, as you would expect, the get and set methods, but the set method does something else.  Instead of simply providing his internal link to the specified book (which would have been done with commented out code in Listing 3), he uses AtomicReferenceFieldUpdater. <br><br><h5>  AtomicReferenceFieldUpdater </h5><br>  Javadoc defines an AtomicReferenceFieldUpdater like this: <br><br>  A reflection-based utility that allows reference fields of designated classes.  This is a subject that is not subject to any updates. <br>  (A reflection-based utility that permits atomic updates to assigned volatile reference fields of assigned classes. This class is intended for use in atomic data structures in which several reference fields of the same record are independent subjects for atomic updates) <s>kill me, I don't know how is it normal to translate</s> <br><br>  In Listing 3, AtomicReferenceFieldUpdater is created by calling the newUpdater method, which takes three parameters. <br>  ‚Ä¢ the class of the object containing the field (in this case, MyObject) <br>  ‚Ä¢ the class of the object that will be updated atomically (in this case, Book) <br>  ‚Ä¢ field name for atomic update <br><br>  What is significant here is that the getWhatImReading method is executed without synchronization of any kind, while setWhatImReading is performed as an atomic operation. <br><br>  Listing 4 shows how to use setWhatImReading () and proves that the variable changes correctly: <br><br>  <b>Listing 4. Atomic update test case.</b> <br><blockquote>  <font color="#000000">package</font> <font color="#006699">com.geeckap.atomicexample</font> <font color="#339933">;</font> <br><br>  <font color="#000000">import</font> <font color="#006699">org.junit.Assert</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">org.junit.Before</font> <font color="#339933">;</font> <br>  <font color="#000000">import</font> <font color="#006699">org.junit.Test</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000000">class</font> AtomicExampleTest <br>  <font color="#009900">{</font> <br>  <font color="#000000">private</font> MyObject obj <font color="#339933">;</font> <br><br>  @Before <br>  <font color="#000000">public</font> <font color="#000066">void</font> setUp <font color="#009900">(</font> <font color="#009900">)</font> <br>  <font color="#009900">{</font> <br>  obj <font color="#339933">=</font> <font color="#000000">new</font> MyObject <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  obj.  <font color="#006633">setWhatImReading</font> <font color="#009900">(</font> <font color="#000000">new</font> <font color="#003399">Book</font> <font color="#009900">(</font> <font color="#0000ff">"Java 2 From Scratch"</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  @Test <br>  <font color="#000000">public</font> <font color="#000066">void</font> testUpdate <font color="#009900">(</font> <font color="#009900">)</font> <br>  <font color="#009900">{</font> <br>  obj.  <font color="#006633">setWhatImReading</font> <font color="#009900">(</font> <font color="#000000">new</font> <font color="#003399">Book</font> <font color="#009900">(</font> <br>  <font color="#0000ff">"Pro Java EE 5 Performance Management and Optimization"</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">Assert</font> .  <font color="#006633">assertEquals</font> <font color="#009900">(</font> <font color="#0000ff">"Incorrect book name"</font> , <br>  <font color="#0000ff">"Pro Java EE 5 Performance Management and Optimization"</font> , <br>  obj.  <font color="#006633">getWhatImReading</font> <font color="#009900">(</font> <font color="#009900">)</font> .  <font color="#006633">getName</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#009900">}</font> <br></blockquote><br><br><h4>  Finally. </h4><br>  Multithreaded programming is always a challenge, but since the Java platform evolved, it has gained support that simplifies some multithreaded programming tasks.  In this article, I looked at five things you might not know about writing multi-threaded applications on the Java platform, including the difference between synchronized methods and code blocks, the value of using ThreadLocal variables, the widespread misunderstanding of volatile (including the danger of relying on volatile when it is necessary to use synchronization), and a brief overview of the subtleties of the atomic classes.  Who wants to know more, see the <a href="http://www.ibm.com/developerworks/java/library/j-5things15/index.html%3Fca%3Ddrs-">Links</a> section <a href="http://www.ibm.com/developerworks/java/library/j-5things15/index.html%3Fca%3Ddrs-">(on the author‚Äôs site)</a> . </div><p>Source: <a href="https://habr.com/ru/post/108016/">https://habr.com/ru/post/108016/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../108006/index.html">OOP workshop in PHP5: Analysis of errors, advantages and disadvantages of two different implementations of impurities in PHP</a></li>
<li><a href="../108007/index.html">Share your experience. How is storage and password management organized in your studio?</a></li>
<li><a href="../108009/index.html">A couple of suggestions for Q & A</a></li>
<li><a href="../108010/index.html">Cloud Hosting Survey Results</a></li>
<li><a href="../108011/index.html">85 rubles for domain. RF</a></li>
<li><a href="../108019/index.html">VERIS website launched</a></li>
<li><a href="../108020/index.html">Create a landing page: checklist for beginners</a></li>
<li><a href="../108021/index.html">EOS, EDS, ECM, EDS and many other scary words</a></li>
<li><a href="../108022/index.html">Mittens - the mascot of the Winter Olympics in Sochi 2014 from Turbomilk</a></li>
<li><a href="../108023/index.html">226,000 .–†–§ domains per day</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>