<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Leaflet as a shell for Yandex.Maps - we display 100 thousand markers on the map</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I love Leaflet very much. With it, you can very quickly build your interactive maps. However, almost all available tile providers (layers for maps) pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Leaflet as a shell for Yandex.Maps - we display 100 thousand markers on the map</h1><div class="post__text post__text-html js-mediator-article">  I love <a href="http://leafletjs.com/">Leaflet</a> very much.  With it, you can very quickly build your interactive maps.  However, almost all available tile providers (layers for maps) provide their services for very impressive money.  There are such OpenSource projects as <a href="http://openstreetmap.ru/">OSM</a> , but not always their tiles satisfy their appearance. <br><br><h2>  purpose </h2><br>  The goal was to blind your completely free centaur.  I always liked Yandex maps, but not their API.  Therefore, I became interested in the introduction of a Yandex map, as a layer for Leaflet. <br><a name="habracut"></a><br>  <a href="https://github.com/storuky/map">An example of a</a> finished application.  <b>In the repository 48 MB dump base.</b> <br><br>  <a href="http://45.55.238.107:8080/">Working example</a>  <b>Can not survive Habraeffekt.</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Cursory study </h2><br>  Having inspected the requests of a legal Yandex card, I calculated the server of the tiles with which we are communicating. <br><br><pre><code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">'http://vec{s}.maps.yandex.net/tiles?l=map&amp;v=4.55.2&amp;z={z}&amp;x={x}&amp;y={y}&amp;scale=2&amp;lang=ru_RU'</span></span> {s} -  (subdomain),   ,              .    ,   <span class="hljs-number"><span class="hljs-number">01</span></span>, <span class="hljs-number"><span class="hljs-number">02</span></span>, <span class="hljs-number"><span class="hljs-number">03</span></span>, <span class="hljs-number"><span class="hljs-number">04</span></span> {z} -   (zoom) {x -  (latitude) {y} -  (longitude)</code> </pre> <br>  This is all the data we need to use the Yandex card tiles inside the Leaflet. <br><br><h2>  Implementation </h2><br>  For the backend, I'll use <b>Ruby on Rails</b> to slightly dispel the myth that the rails are slow.  After all, we will display <u>100 thousand markers</u> on the map! <br><br>  First, create a Marker model: <br><pre> <code class="bash hljs">rails g model marker</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Migration Content</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateMarkers</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Migration </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">change</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create_table</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">markers</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">float</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lat</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">float</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lng</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">avatar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">website</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">city</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">phone</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">about</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timestamps</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br></div></div><br><br><pre> <code class="bash hljs">rake db:create rake db:migrate</code> </pre><br><br>  I wrote a small factory that generates 100,000 markers with fake-filled fields.  I am using <b>PostgreSQL</b> .  The database dump can be found in <b>db / db.dump</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Factory</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># test/factories/markers.rb FactoryGirl.define do factory :marker do lat {Faker::Address.latitude} lng {Faker::Address.longitude} avatar {Faker::Avatar.image} name {Faker::Name.name} website {Faker::Internet.url} email {Faker::Internet.email} city {Faker::Address.city} address {Faker::Address.street_address} about {Faker::Hipster.paragraph} phone {Faker::PhoneNumber.cell_phone} end end # db/seeds.rb 100000.times do |num| FactoryGirl.create(:marker) ap "#{num}" end</span></span></code> </pre><br></div></div><br><br>  To control the Marker model, we will generate the markers controller: <br><br><pre> <code class="ruby hljs">rails g controller markers</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Controller code</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MarkersController</span></span></span><span class="hljs-class"> &lt; ApplicationController </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">before_action</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set_marker</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">only</span></span></span><span class="hljs-class">: [:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">show</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">respond_to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">format</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">format</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">html</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">format</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pluck_fields</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Marker</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pluck</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lat</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lng</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">render</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">json</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Oj</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dump</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pluck_fields</span></span></span><span class="hljs-class">) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">show</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">render</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">show</span></span></span><span class="hljs-class">", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">layout</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set_marker</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">marker</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Marker</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">find</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">]) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br></div></div><br><br>  In order not to waste time on building an AR object, I call the <b>pluck</b> method, which performs a SELECT query only on the fields I need.  This gives a significant increase in performance.  The result is an array of arrays: <br><br><pre> <code class="ruby hljs">[ [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">68.324</span></span>,-<span class="hljs-number"><span class="hljs-number">168.542</span></span>], [<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">55.522</span></span>,<span class="hljs-number"><span class="hljs-number">59.454</span></span>], [<span class="hljs-number"><span class="hljs-number">3</span></span>,-<span class="hljs-number"><span class="hljs-number">19.245</span></span>,-<span class="hljs-number"><span class="hljs-number">79.233</span></span>] ]</code> </pre><br><br>  I also use the <a href="https://github.com/ohler55/oj">Oj</a> gem to quickly generate json.  Losses on the view do not exceed 2ms for 100,000 objects. <br><br>  Do not forget to specify a new resource in routes.rb: <br><br><pre> <code class="ruby hljs">Rails.application.routes.draw <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> root <span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> <span class="hljs-string"><span class="hljs-string">"markers#index"</span></span> resources <span class="hljs-symbol"><span class="hljs-symbol">:markers</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  Getting to the card itself. <br><br>  Clustering is required for such a large number of markers.  Leaflet has a large selection of different plugins that add the functionality we need.  I stopped at <a href="https://github.com/SINTEF-9012/PruneCluster">PruneCluster</a> . <br><br>  We connect all the necessary libraries: <br><br><div class="spoiler">  <b class="spoiler_title">application.css</b> <div class="spoiler_text"><pre> <code class="css hljs"><span class="hljs-comment"><span class="hljs-comment">/* *= normalize *= require leaflet *= require prune_cluster *= require_tree . *= require_self */</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">application.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//= require jquery //= require leaflet //= require prune_cluster //= require_self //= require_tree .</span></span></code> </pre><br></div></div><br><br>  In order to draw a map, you need to make basic markup: <br><br><div class="spoiler">  <b class="spoiler_title">markers / index.html.slim</b> <div class="spoiler_text"><pre> <code class="hljs objectivec"> <span class="hljs-meta"><span class="hljs-meta">#map</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">application.css</b> <div class="spoiler_text"><pre> <code class="css hljs"><span class="hljs-selector-id"><span class="hljs-selector-id">#map</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: fixed; <span class="hljs-attribute"><span class="hljs-attribute">left</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">right</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">top</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bottom</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br></div></div><br><br>  Now we can draw a leaflet card: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> map = L.map(<span class="hljs-string"><span class="hljs-string">'map'</span></span>).setView([<span class="hljs-number"><span class="hljs-number">54.762</span></span>,<span class="hljs-number"><span class="hljs-number">37.375</span></span>], <span class="hljs-number"><span class="hljs-number">8</span></span>), <span class="hljs-comment"><span class="hljs-comment">//    #map leafletView = new PruneClusterForLeaflet(); // ,      </span></span></code> </pre><br><br>  Since the map has no layers, we will only see a gray background.  Adding a layer to the map is very simple: <br><pre> <code class="javascript hljs">L.tileLayer( <span class="hljs-string"><span class="hljs-string">'http://vec{s}.maps.yandex.net/tiles?l=map&amp;v=4.55.2&amp;z={z}&amp;x={x}&amp;y={y}&amp;scale=2&amp;lang=ru_RU'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">subdomains</span></span>: [<span class="hljs-string"><span class="hljs-string">'01'</span></span>, <span class="hljs-string"><span class="hljs-string">'02'</span></span>, <span class="hljs-string"><span class="hljs-string">'03'</span></span>, <span class="hljs-string"><span class="hljs-string">'04'</span></span>], <span class="hljs-attr"><span class="hljs-attr">attribution</span></span>: <span class="hljs-string"><span class="hljs-string">'&lt;a http="yandex.ru" target="_blank"&gt;&lt;/a&gt;'</span></span>, <span class="hljs-attr"><span class="hljs-attr">reuseTiles</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">updateWhenIdle</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> } ).addTo(map);</code> </pre><br><br>  Now the Yandex map familiar to us is displayed inside the <b>#map</b> container.  However, we need to redefine the projection of the map from the spherical mercator to the elliptical, otherwise there will be a noticeable shift in coordinates.  At the same time, we will specify where the leaflet should take default icons for the markers. <br><br><pre> <code class="javascript hljs">map.options.crs = L.CRS.EPSG3395; L.Icon.Default.imagePath = <span class="hljs-string"><span class="hljs-string">"/leaflet"</span></span>;</code> </pre><br><br>  It remains to query all the markers and draw them on the map: <br><br><pre> <code class="javascript hljs">jQuery.getJSON(<span class="hljs-string"><span class="hljs-string">"/markers.json"</span></span>, {}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">)</span></span>{ res.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ leafletView.RegisterMarker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PruneCluster.Marker(item[<span class="hljs-number"><span class="hljs-number">1</span></span>], item[<span class="hljs-number"><span class="hljs-number">2</span></span>], {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: item[<span class="hljs-number"><span class="hljs-number">0</span></span>]})); }); map.addLayer(leafletView); })</code> </pre><br><br>  Now our map does not carry any meaning, since it is impossible to get any information about the marker.  Add a popup that will be called when clicking on a marker and retrieving content from the server: <br><br><pre> <code class="javascript hljs">leafletView.PrepareLeafletMarker = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">marker, data</span></span></span><span class="hljs-function">) </span></span>{ marker.on(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ jQuery.ajax({ <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"/markers/"</span></span>+data.id }).done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (marker.getPopup()) { marker.setPopupContent(res) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { marker.bindPopup(res); marker.openPopup(); } }) }) }</code> </pre><br><br>  Create the appropriate markup for Popup: <br><div class="spoiler">  <b class="spoiler_title">markers / show.html.slim</b> <div class="spoiler_text"><pre> <code class="hljs mel">h1 | #{@marker.name} .popup__address | #{@marker.city}, #{@marker.address} .nowrap .popup__avatar img src=<span class="hljs-string"><span class="hljs-string">"#{@marker.avatar}"</span></span> width=<span class="hljs-string"><span class="hljs-string">"120"</span></span> height=<span class="hljs-string"><span class="hljs-string">"120"</span></span> .popup__contacts .popup__contact b : div | #{@marker.phone} .popup__contact b . : div a href=<span class="hljs-string"><span class="hljs-string">"mailto:#{@marker.email}"</span></span> | #{@marker.email} .popup__contact b : div a href=<span class="hljs-string"><span class="hljs-string">" #{@marker.website}"</span></span> target=<span class="hljs-string"><span class="hljs-string">"_blank"</span></span> | #{@marker.website} p | #{@marker.<span class="hljs-keyword"><span class="hljs-keyword">about</span></span>}</code> </pre><br></div></div><br><br><h2>  Total </h2><br>  We integrated Leaflet with Yandex-cards, which means that all the <a href="http://leafletjs.com/plugins.html">plug-ins for leaflet-cards</a> became available to us.  The written application not only withstands a load of 100,000 markers, but also has quite useful functionality. <br><br>  <a href="https://github.com/storuky/map">An example of a</a> finished application.  <b>In the repository 48 MB dump base.</b> </div><p>Source: <a href="https://habr.com/ru/post/283354/">https://habr.com/ru/post/283354/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283344/index.html">Theory and practice of escape from the 5 GHz band</a></li>
<li><a href="../283346/index.html">CUBA Platform Enters Free Software Market</a></li>
<li><a href="../283348/index.html">Firebird 3.0 Verification</a></li>
<li><a href="../283350/index.html">Basics of game design: 20 board games. Part one</a></li>
<li><a href="../283352/index.html">C ++ without new and delete</a></li>
<li><a href="../283356/index.html">REG.RU: Step-by-Step Guide to Creating a Company Website</a></li>
<li><a href="../283358/index.html">CDN - New Video Broadcast Standard</a></li>
<li><a href="../283360/index.html">Update fixes security issues for all tools based on IntelliJ platform</a></li>
<li><a href="../283362/index.html">Film lover's best friend: rework CBS application for Android</a></li>
<li><a href="../283364/index.html">Using python Exscript library to work with Cisco and Huawei equipment over SSH</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>