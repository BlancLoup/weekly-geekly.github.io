<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HTML5 Canvas Map - implementation of the mapping engine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As part of a large interactive web-based project (more about which is possible in another post) I am developing a cartographic engine implemented on H...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HTML5 Canvas Map - implementation of the mapping engine</h1><div class="post__text post__text-html js-mediator-article">  As part of a large interactive web-based project (more about which is possible in another post) I am developing a cartographic engine implemented on HTML5 CANVAS.  Its development has reached the beta stage and, with the approval of my leadership, there was a desire to show these cards to the public. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ba2/547/791/ba2547791037d759ae90373850f60eff.png" alt="image"><br><a name="habracut"></a><br><h3>  General information </h3><br>  The engine was developed without the use of any specialized libraries or frameworks.  The only library used is jQuery. <br><br>  Image maps - tiles - generated using our utility.  There is still something to strive for, since we have not yet been engaged in their optimization. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Everything is drawn on CANVAS, with the exception of such elements as the toolbar of additional tools and popup tags (although in the demo there is no link in the link below). <br><br><h3>  Implementation </h3><br>  The implementation is modular and consists of the following main parts, the purpose of which I think is clear from their names: CanvasDragger, CanvasEventer, CanvasImgLoader, CanvasMapper, CanvasMarker, CanvasMiniMapper, CanvasResizer, CanvasTools, CanvasZoomer. <br><br>  In order to connect the cards it is enough in the right place of html'a to write the following line: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"map2d"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Further in the JS code we perform initialization (as an example): <br><pre> <code class="javascript hljs">$(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ mWrap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MapsWrapper({ <span class="hljs-attr"><span class="hljs-attr">mapDivId</span></span>: <span class="hljs-string"><span class="hljs-string">"map2d"</span></span> <span class="hljs-comment"><span class="hljs-comment">//   ID canvas'a,      }); }); MapsWrapper = function(properties) { this.initialize(properties); }; $.extend(MapsWrapper.prototype, { v2DMapDiv : null, v2DMapComponent : null, initialize: function(prop){ this.v2DMapDiv = prop.mapDivId; this.initMap(); }, initMap: function(){ var GlobalParams = { staticMapUrl: ["http://gate.looxity.ru:8088/map.html", "http://zain.looxity.ru:8088/map.html", "http://kaph.looxity.ru:8088/map.html"], initCrd : {x: 7445, y: 9925}, initZoom : 0.25, zoomList : [1, 0.5, 0.25, 0.1, 0.05, 0.025], miniMap : true, tools : {scaler: true, polygoner: true} }; this.v2DMapComponent = new CanvasMapper (this.v2DMapDiv); this.v2DMapComponent.initialize(GlobalParams); } });</span></span></code> </pre> <br><br>  Let us dwell on the parameters: <br><ul><li>  <i>staticMapUrl</i> - hosts from which map tiles are loaded </li><li>  <i>initCrd</i> - the initial coordinates in the Gauss-Kruger projection, in this case approximately correspond to the zero kilometer of roads, which is near the Manege Square. </li><li>  <i>miniMap</i> - connect the minimap module </li><li>  <i>tools</i> - connection of the module of additional tools </li></ul><br><h3>  Internal mechanics </h3><br>  Or what is behind this or that user action.  Go through the main events. <br><br><h5>  We start </h5><br>  When initializing the maps, the number of tiles that must be shown to fully cover the canvas is calculated.  Knowing the dimensions of the canvas, with a given tile size of 256x256, we perform this operation. <br><br><h5>  Are moving </h5><br>  Further, when the card moves - dragg - we check the situation if we move the card to such a distance that we need to load a new tile.  Also check if all the tiles are in scope, if not, then the ‚Äúgarbage collector‚Äù is started: <br><pre> <code class="javascript hljs">unVisibleTilesCollector: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cnt = <span class="hljs-number"><span class="hljs-number">0</span></span>; cnt &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__TILES__.length; cnt++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__TILES__[cnt].canvX + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tileSize) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__TILES__[cnt].canvX &gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.canvas.width || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__TILES__[cnt].canvY &gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.canvas.height || (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__TILES__[cnt].canvY + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tileSize) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__TILES__.splice(cnt, <span class="hljs-number"><span class="hljs-number">1</span></span>); cnt--; } } }</code> </pre> <br><br><h5>  Scale (zoomIn, zoomOut) </h5><br>  When a mousewheel event is triggered, the following basic actions occur sequentially: <br><ul><li>  copy the current position of all tiles </li></ul><pre> <code class="javascript hljs">$.extend(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.__ANIM_TILES__, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mapper.__TILES__)</code> </pre> <br><ul><li>  by means of canvas and with the help of mathematics there is a decrease or increase in tiles (depending on how we spin the mouse wheel) from a copy made in nn1 </li></ul><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(cnt; cnt &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.animSteps; cnt++){ setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ _this.ctx.clearRect(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,_this.canvas.width,_this.canvas.height); _this.ctxMarker.clearRect(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,_this.canvas.width,_this.canvas.height); animScale += scale*stepScale; _this.drawAllAnimTiles(evt, { <span class="hljs-attr"><span class="hljs-attr">animScale</span></span>: animScale, <span class="hljs-attr"><span class="hljs-attr">stepCurrNum</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.abs(animScaleStart-animScale)/stepScale), <span class="hljs-attr"><span class="hljs-attr">stepScale</span></span>: stepScale }); }, delay*cnt); }</code> </pre> <br><ul><li>  from above, as they are loaded, new tiles are superimposed, in accordance with the new scale </li></ul><pre> <code class="javascript hljs">MapsWrapper.v2DMapComponent.update()</code> </pre> <br><br><h3>  Browser operation </h3><br>  The work was tested in FireFox, Chrome, Safari, Opera and IE of the latest versions. <br>  For those who are still not in the know once again emphasize the following.  Since canvas is used, all browsers that do not support this technology are automatically dropped, and this is IE version 8 and below and very old versions of the browsers listed above. <br><br><h3>  TODO List by card </h3><br>  1. Reducing the size of the map tiles (should give a tangible increase in the speed of work); <br>  2. Slider zoom; <br>  3. A tool for obtaining information on a point on the map (building address, coordinates, and so on); <br>  four. ??? <br><br>  <u><b>Demo</b></u> : <a href="http://share.arkada-sw.ru/canvasmap/">share.arkada-sw.ru/canvasmap</a> <br><br><h6>  <b>ps</b> all rights to the program code and cards belong to the company in which I work </h6><h6>  <b>pps</b> if this article takes interest, then my next post will be a description of an example of the actual use of these maps </h6></div><p>Source: <a href="https://habr.com/ru/post/133638/">https://habr.com/ru/post/133638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133631/index.html">World of Goo is now on Android</a></li>
<li><a href="../133632/index.html">GeoEye-1 executes the order of Rosreestr for 1.3 billion rubles</a></li>
<li><a href="../133633/index.html">and Firebird SQL Server</a></li>
<li><a href="../133634/index.html">PhpStorm 3.0 released</a></li>
<li><a href="../133637/index.html">Ukrainian Intel offered schoolchildren and students Intellectualization</a></li>
<li><a href="../133639/index.html">November 30 - HTML Camp 5 conference in St. Petersburg</a></li>
<li><a href="../133640/index.html">About CALEA in Russian</a></li>
<li><a href="../133641/index.html">How I did a fault tolerant web service</a></li>
<li><a href="../133643/index.html">HOWTO: your business in the USA from Russia</a></li>
<li><a href="../133646/index.html">Using the Maximo platform, domestic experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>