<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Perl MySQL process monitoring script</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 For more than five years I have been working as a system administrator in a hosting company, serving over a hundred servers with freebsd and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Perl MySQL process monitoring script</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  For more than five years I have been working as a system administrator in a hosting company, serving over a hundred servers with freebsd and centos.  During this time, a lot of samopisny scripts have accumulated that facilitate my life.  I want to share these scripts with the community, and it never hurts to listen to healthy criticism. <br><br>  Prehistory <br><a name="habracut"></a><br>  Many years ago, a friend of mine, having surplus money in his wallet, bought server hardware in the form of a single-unit Intel server, placed it in the cheapest data center (as it is now fashionable to call it - on a kolokheyshene), and started posting his site sites there first, then began distributing hosting to friends, friends began to post their pages, then pulled up the sites of their friends and employers.  Since a comrade poorly understood the installation and configuration of LAMP, without further ado, he set up Cpanel WHM, I also drew as a free labor force adminit all this economy, which is called ‚Äúfor food‚Äù, I also needed hosting. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Over the course of several years, many servers have taken root on the server, and the workload with which I struggled with varying success grew.  Periodically, problems began to arise with mysql.  Some users created slow queries that blocked subsequent ones, others resulted in multi-storey requests with a bunch of JOINs that, by virtue of a <a href="http://bugs.mysql.com/bug.php%3Fid%3D26339">bug</a> that was still not fixed, hung in statistics, while reaping processor resources.  In the end, mysql overeat processes and stopped responding.  There was a need for some kind of monitoring script that would look at the list of mysql processes, and sounded the alarm in case of an emergency situation. <br><br>  At first I wrote a script in bash.  Then, when by the nature of the main work I had to get acquainted with the pearl - I rewrote it in Perl. <br><br>  As practice shows, during normal operation, mysql servers simultaneously work out less than five ‚Äúslow‚Äù requests, even for heavily loaded servers, and if there are any, it is a reason to study these requests.  Of course, you need to analyze the log of slow queries periodically, but this is a topic for the next article, about a script that analyzes and even automatically builds simple indexes. <br><br>  The logic of the monitoring script is simple.  We assume that the mysql server is under threat if at the time of the scan more than ten (for example) ‚Äúslow‚Äù requests are executed simultaneously - with a duration of more than one second.  Let's call this state "critical."  If the condition is critical, then it is necessary to sound the alarm. <br><br>  Further practice has shown that it would be nice to sound the alarm if mysql is in a precritical state for some time.  That is, 10 processes at the same time are not yet, but with each minute the number of long-running queries is growing.  For the precritical state, we take the figure of, say, 5. <br><br>  Run the script once a minute.  We look at the list of processes, we consider everything that is not in the Sleep status and takes longer than one second.  If the number is greater than 10, then send a letter to the administrator along with a list of processes.  Save the resulting number to a file.  We read the values ‚Äã‚Äãfrom this file the last 5 values ‚Äã‚Äãin the last 5 minutes, and if there were 5 precritical states during this time interval, then we send a letter to the admin. <br><br>  Later, a block was inserted into the script, nailing the multi-storey queries that hung in the statistics state. <br><br>  Actually, the script. <br><br><pre><code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl #use strict; use DBI; use DBD::mysql; use POSIX; ($sysname, $hostname, $release, $version, $machine) = POSIX::uname(); my $slowtime=1; #       my $warnlevel=5; #       my $warncounter=5; #  $warncounter     my $alarmcounter=10; #     &gt;= $alarmcounter     my $socket='/tmp/mysql56.sock'; #    my $email="admin\@myemail.net"; #   my $wrkdir='/tmp/'; my $procfile=$wrkdir.'alarm.proclist'; #      my $datfile=$wrkdir.'alarm.dat'; #        my $pidfile=$wrkdir.'alarm.pid'; # pid .  mysql         if (-e "$pidfile") { printf("pid file found. Exit.\n"); exit(255); } open (PIDFILE,"&gt;$pidfile") || die "cant create $pidfile\n"; print PIDFILE "$$\n"; close PIDFILE; open (PROCFILE,"&gt;$procfile") || die "cant create $procfile\n"; my ($proc, $dbh, $sth, $totalcounter, $slowcounter, $sleepcounter, $user, $time, $state, $command, $info, $i); until ($dbh = DBI-&gt;connect("DBI:mysql:mysql_socket=$socket", "user", "password")){ unlink($pidfile); die("Can't connect: $DBI::errstr\n"); } $sth = $dbh-&gt;prepare("SHOW FULL PROCESSLIST"); $sth-&gt;execute; my @proclist=(); $totalcounter=$slowcounter=$sleepcounter=0; while (my $row = $sth-&gt;fetchrow_hashref()) { $user=$row-&gt;{'User'}; $time=$row-&gt;{'Time'}; $state=$row-&gt;{'State'}; $command=$row-&gt;{'Command'}; $info=$row-&gt;{'Info'}; $totalcounter++; next if ($user =~ m/root/); if ($command =~ m/(Sleep|Delayed|Binlog)/){ $sleepcounter++; next; }; ###      statistics if ($state =~ m/statistics/ &amp;&amp; $time &gt; 5){ $statinfo="$user: killed $mid: $dbuser | $db | $time | $state | $command | $info\n\n"; $sth2 = $dbh-&gt;prepare("kill $mid"); $sth2-&gt;execute; $sth2-&gt;finish; open (MAIL,"|/usr/sbin/sendmail -F$hostname $email"); print MAIL "To:$email\nSubject:".$subj."Hanged query in the statistics state: $hostname, user $user \n\n"; print MAIL $statinfo; close (MAIL); }; ### if ($time&gt;$slowtime) { $slowcounter++; } $info =~ s/[\r\n\t]+/ /g; push (@proclist,sprintf("%-24s | %4d | %s | %s | %s \n", $user, $time, $state, $command, $info)); printf PROCFILE ("%-24s | %4d | %s | %s | %s \n", $user, $time, $state, $command, $info); } $sth-&gt;finish; close PROCFILE; #print "--- $slowcounter slow queries from total $totalcounter ($sleepcounter are sleep) ---- \n"; my @data=(); ### read slowcounter timings from dat file open (DATFILE,"&lt;$datfile"); while(&lt;DATFILE&gt;){ my($line) = $_; chomp($line); push (@data,$line); } close(DATFILE); ### if dat file is smaller than warnlevel then fill timings by zeros if (scalar(@data)&lt;$warnlevel) { for $i ( 0 .. $warnlevel-scalar(@data) ) { push (@data,0); } } ### shift timings with last slowcounter push (@data,$slowcounter); shift(@data); ### dumping slowcounter timings to dat file open (DATFILE,"+&gt;$datfile") || die "cant create $datfile\n"; foreach (@data) { print DATFILE "$_\n"; } close(DATFILE); ### get number of bad states for last minutes my $cnt=0; foreach (@data) { if($_ &gt;= $warnlevel) { $cnt++; } } my $subj=" "; if ($slowcounter&gt;=$alarmcounter) { # very critical state $subj=" VERY "; } my $warnmessage="Critical state of $hostname! There was a $warncounter checks with at least $warnlevel long queries!\n"; if ($slowcounter&gt;=$alarmcounter) { # very critical state $warnmessage=$warnmessage."--- !!! Last check shows $slowcounter long queries!\n"; } if (($cnt &gt;= $warncounter) || $slowcounter&gt;=$alarmcounter){ open (MAIL,"|/usr/sbin/sendmail -F$hostname $email"); print MAIL "To:$email\nSubject:".$subj."Critical state of $hostname\n\n"; print MAIL $warnmessage; print MAIL "---------------------------------------------------------------------------------------------------\n"; print MAIL "--- $slowcounter slow queries from total $totalcounter ($sleepcounter are sleep) \n"; print MAIL "---------------------------------------------------------------------------------------------------\n"; foreach (@proclist) { print MAIL "$_"; } close (MAIL); } unlink($pidfile);</span></span></code> </pre> <br><br>  I apologize for the comments in Nizhny Novgorod English. <br><br>  Later, the script was introduced to the combat mysql servers in the hosting company where I work, and helped to prevent the Mysql server from being serviced many times, and simply reported that a user was wasting resources. <br><br>  The script works: <br><br>  - when spam bots attack forgotten god forums.  Under load, performance drops, forum tables begin to crash, requests are accumulating in the queue in the status "Locked".  From the script comes a very distinctive and illustrative list of processes; <br><br>  - when the user sites are attacked by benchmark type in blind SQL injections; <br><br>  - when mysql stupidly hangs, and with it under load it happens sporadically (one process runs indefinitely, all the others just hang without any status, and accumulate until the connection limit is selected) - the script works faster than the monitoring system polling the mysql port ; <br><br>  - when users have impressive tables in terms of data volume and queries that are not optimized so much that one query is executed for a few seconds, or even minutes.  The remaining requests to the table are accumulating and waiting for the queue in the Locked status.  The letter immediately shows a non-optimized query, you can quickly see the explain query and build an index if necessary.  If innodb is used, then on intensive slow queries the monitoring script also works, because their bundle is hanging in the status of ‚ÄúSending data‚Äù or ‚ÄúCopying to tmp table‚Äù.  Such requests in large quantities are very dangerous, since they greatly reduce the performance of the server as a whole; <br><br>  - when multi-story JOIN requests are hanging.  The script nails them automatically, but sometimes they are not killed - the reason to restart mysql; <br><br>  - several times the script caught mysql freezes on specific requests, further study of which eventually resulted in an update, after detecting a bug with similar requests on the bug tracker. <br><br>  Occasionally, false positives come, of course, if someone repairs, optimizes, or dumps a large table. <br><br>  I would be glad if this script is useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/145573/">https://habr.com/ru/post/145573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145564/index.html">SPDY protocol parsing by the Opera Software team</a></li>
<li><a href="../145565/index.html">Unity3d Lessons from Unity 3D Student (B09-B12)</a></li>
<li><a href="../145567/index.html">Search social networks based on the behavior of ants</a></li>
<li><a href="../145568/index.html">New design website anyway.com</a></li>
<li><a href="../145570/index.html">The development of e-justice in the arbitration system</a></li>
<li><a href="../145574/index.html">Convenient work with LocalStorage. Well, with SessionStorage at the same time</a></li>
<li><a href="../145575/index.html">Object collections in PHP. Part two</a></li>
<li><a href="../145576/index.html">Computex 2012 - the fourth day. Informal</a></li>
<li><a href="../145578/index.html">A simple phpMyAdmin replacement for geeks</a></li>
<li><a href="../145579/index.html">Interesting facts about domains from DataGenetics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>