<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Centralized collection of configurations from MikroTik by means of Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What for 

 With the growing number of network nodes and the complexity of their configuration, many probably have a question - and if the piece of ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Centralized collection of configurations from MikroTik by means of Python</h1><div class="post__text post__text-html js-mediator-article"><h4>  What for </h4><br><br>  With the growing number of network nodes and the complexity of their configuration, many probably have a question - and if the piece of hardware dies, can I quickly restore work to another?  If I can do it manually, then how long will I then catch the little things that I forgot? <br><br>  The googling process has led to an understanding of what specifically for this vendor there are no ready-made solutions of this kind.  I did not like what was found in the community - they suggested placing backup scripts on the piece of hardware itself and running them on a schedule.  In fact, this solved the problem, but if I have several dozen pieces of equipment, clicking copy-paste on each copy is not according to Feng Shui. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Fortunately, there is a little Python utility writing skill and fantasy. <br><a name="habracut"></a><br><br><h4>  Fantasy </h4><br><br>  I think in my mind what is needed - a TFTP server, where we will put our farm, * nix machine (it is easier with it than under win to do it all), Python is on board with the necessary set of libraries.  As it turned out, you can throw out the TFTP server, you will need FTP. <br><br><h5>  Attempt once </h5><br><br>  I try to solve the problem in the forehead - I use telnetlib for communication - it does not work.  Strange, because with the switches worked.  Having thought it over, I realized that telnet from MikroTik is decorated with all the colors of the rainbow, it means pouring special characters, and it is not my filter to filter them. <br><br><h5>  Attempt two </h5><br><br>  I look closely at the paramiko library and its SSHClient component - now everything works out - the connection passes, I can execute commands and get the result. <br><br>  Now we will understand how the configurations are removed from these really unusual pieces of iron.  The usual script on the network equipment is the execution of one command that can send its config to the TFTP server.  In the case of MikroTik, this option does not work - it turns out that the first thing to do is to create a backup of the config: <br><br> <code>/system backup save [name=]</code> <br> <br>  After that, the file can already be downloaded somewhere, but as it turned out, this can only be done via FTP, and via HTTP and TFTP it can only merge files.  It does not matter, we quickly raise an FTP server with a minimal configuration, which will not be difficult for dear readers to google. <br><br> <code>/tool fetch address= mode=ftp dst-path= src-path= user= password= upload=yes</code> <br> <br>  And in the end you need to clean up the trash, so as not to sail to the exhaustion of free space on the internal carrier: <br><br> <code>/file remove</code> <br> <br><h5>  Result </h5><br><br>  A couple of hours fantasy gave birth to this script: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- # for SSH from paramiko import SSHClient from paramiko import AutoAddPolicy # for versioning import datetime # for file operations import os # for sleep import time # versioning Version = datetime.date.today() #print "\n" + str(Version) # hosts array IP1, IP2, IP3 hosts = ( "1.2.3.4", "5.6.7.8" , "9.10.11.12") # username users = ( "user1", "user2", "user3") iterUser = iter(users) # userpassword passwords = ( "pass1", "pass2", "pass3" ) iterPassword = iter(passwords) # FTPD IP FtpdIP = "13.14.15.16" # ftp user account ftpUser = "ftpuser" ftpPass = "ftppass" # keep backups for 4 weeks backtime = datetime.timedelta(weeks=-4) sshCli = SSHClient() sshCli.set_missing_host_key_policy(AutoAddPolicy()) print "header done" # loop host adresses for host in hosts: print "\n" + str(host) # iterate through user-password pairs user = iterUser.next() Password = iterPassword.next() # define operations CreateLocalBckp = "system backup save name=" + str(host) + "_" + str(Version) + ".backup" UploadToFtp = "tool fetch address=" + str(FtpdIP) + " mode=ftp dst-path=" + str(host) + "_" + str(Version) + ".backup src-path=" + str(host) + "_" + str(Version)+ ".backup" + " user=" + str(ftpUser) + " password=" + str(ftpPass) + " upload=yes" RemoveLocalBckp = 'file remove "' + str(host) + "_" + str(Version) + ".backup" + '"' # try for not to fail the whole script on one error try: print "connecting.." + str(host) + "@" + str(user) + ":" + str(Password) sshCli.connect(str(host), port=2022, username=str(user), password=str(Password)) print "connected.." # creating local backup print "creating local backup.. /" + CreateLocalBckp sshCli.exec_command(CreateLocalBckp) # sleep after each command because mikrotik can not do it so fast as script executes time.sleep(2) print "local backup created.." # uloading local backup to ftp print "uploading local backup to ftp.. /" + UploadToFtp sshCli.exec_command(UploadToFtp) time.sleep(2) print "backup uploaded to remote location.." # removing local backup time.sleep(2) print "removing local backup.. /" + RemoveLocalBckp sshCli.exec_command(RemoveLocalBckp) time.sleep(2) print "local backup removed.." sshCli.close() # try delete old file (if exists) try: os.remove("/tftp/" + str(host) + "_" + str(Version + backtime) +".cfg") except: print "Error while trying to delete old backup " + "/tftp/" + str(host) + "_" + str(Version + backtime) +".cfg" except: print "Error connecting to host", host</span></span></code> </pre><br><br>  The script will store on our FTP server a set of backup configurations for the month with names like IP_YYY-MM-DD.backup <br><br>  PS: there is a similar creation for the case of 3Com switches and uploading their configurations via telnet to TFTP - if readers are interested, be sure to publish. </div><p>Source: <a href="https://habr.com/ru/post/135541/">https://habr.com/ru/post/135541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135535/index.html">For habrovchan - free test "clouds"</a></li>
<li><a href="../135536/index.html">CMS ratings in popularity and quality, CRM rating, design tools, services for workflow and bookkeeping</a></li>
<li><a href="../135537/index.html">Competition for developers of HTML5-games (prize $ 30K)</a></li>
<li><a href="../135538/index.html">About invites</a></li>
<li><a href="../135540/index.html">Charlotte, not a cake!</a></li>
<li><a href="../135542/index.html">Dictionaries for ABBYY Lingvo for Android can be bought cheaper</a></li>
<li><a href="../135543/index.html">BlackBox - miniature printer for printing sms</a></li>
<li><a href="../135545/index.html">DARPA equips ordinary beetles with spy equipment</a></li>
<li><a href="../135546/index.html">The holiday comes to us! The holiday comes to us! Celebration? To us? Is coming</a></li>
<li><a href="../135548/index.html">New Year Gift from DevExpress</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>