<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analog std :: vector from C ++ 11 on pure C89 and how I wrote it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Residential array of people. No seriously. 


 Holivary between lovers of C and its followers  bastard  son in the face of C + + began even before my ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analog std :: vector from C ++ 11 on pure C89 and how I wrote it</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="https://habrahabr.ru/post/324210/"><img src="https://habrastorage.org/files/07f/3b0/d1b/07f3b0d1b2cc4f3cad3fb0272953ac4b.png" alt="image"></a> <br>  <em>Residential array of people.</em>  <em>No seriously.</em> </p><br><p>  Holivary between lovers of C and its followers <del>  bastard </del>  son in the face of C + + began even before my birth and will end unless after the death of both these languages ‚Äã‚Äãand me at the same time. </p><br><p>  Adherents of the great creation Kernigan-Ritchie, up to the last second of the working day, are ready to prove to Stroustrup‚Äôs minions axioms about eternity Xi and its incredible flexibility. <br>  Those, in their own way, advise them to better rejoice at the working day, because it is about to be the last - the twenty-first century does not need a cross-platform assembler. <br>  Burning out, supporters of C lead millions of long-gone through their heads to embrace theses ‚Äúwhy C is better than C ++,‚Äù while each time emphasizing that the second had lost all the merits of the first while still in his father's womb, incidentally losing the face of man. <br>  The accused party is not offended and ... </p><br><p>  but wait, what am I talking about? </p><br><p> I love C, I respect C ++ and I can not stand holivars (honestly).  At the same time, I realize that C really lacks a lot, and a vivid example of this is the lack of convenient data handling.  In C ++, this problem is largely solved by the STL and properties of the language itself.  In my student's opinion, the <code>std::vector</code> is especially different.  If it became interesting how I implemented its analogue using C89 tools - I ask for cat. </p><a name="habracut"></a><br><h1 id="predystoriya">  Prehistory </h1><br><p>  In general, everyone who switches to C from a slightly higher level is surely faced with the above described problem (in my case it was FreeBASIC and Free Pascal).  The problem of the absence of the long-beloved <code>Redim</code> and <code>SetLength()</code> first solved "in the forehead with a sledgehammer" with the help of <code>realloc()</code> .  Then knowledge comes around with experience, and instead, a simple, self-written dynamic array is used. </p><br><p>  However, the need to duplicate its code for each individual data type each time causes more irritation.  There is also an alternative - the use of pointers, requiring dereferencing and type conversions.  And then the person gets into the hands of C ++ (or its equivalent) and the person sees STL (or its equivalent).  Then you can read in any gutter novel. </p><br><p>  However, they fall in love with the body, but love the soul.  If a person has been in a happy relationship with X for a long time, if projects have already appeared in them, then it is only natural for a person to want to make the object of his love better - for mutual benefit.  And a person in cultivation is always focused on something. </p><br><p>  In short, this is a story about how love for C made me add to it (her?) The notorious <code>std::vector</code> - what I liked about C ++, which (which?) I was into at one time. </p><br><h1 id="do-nas-hot-potop">  Before us even the flood </h1><br><p>  It has already been noted that the problem of the absence in C of the built-in dynamic array for arbitrary types is not new and has been solved differently many times. <br>  Here are the options for the implementation of the vector, which I found in just five minutes on Google: </p><br><p>  <a href="https://github.com/rxi/vec">https://github.com/rxi/vec</a> <br>  <a href="https://github.com/eteran/c-vector">https://github.com/eteran/c-vector</a> <br>  <a href="https://github.com/jibsen/scv">https://github.com/jibsen/scv</a> <br>  <a href="https://github.com/graphitemaster/cvec">https://github.com/graphitemaster/cvec</a> <br>  <a href="https://github.com/robertkety/dataStructures">https://github.com/robertkety/dataStructures</a> (Ctrl + F "dynamicArray") <br>  <a href="http://troydhanson.github.io/uthash/utarray.html">http://troydhanson.github.io/uthash/utarray.html</a> <br>  <a href="https://github.com/dude719/Dynamic-Array-Kernel">https://github.com/dude719/Dynamic-Array-Kernel</a> <br>  <a href="https://developer.gnome.org/glib/stable/glib-Arrays.html">https://developer.gnome.org/glib/stable/glib-Arrays.html</a> <br>  <a href="https://www.happybearsoftware.com/implementing-a-dynamic-array">https://www.happybearsoftware.com/implementing-a-dynamic-array</a> <br>  <a href="">https://github.com/nothings/stb/blob/master/stretchy_buffer.h</a> <em>(added on tip by <a href="https://habrahabr.ru/users/xop/" class="user_link">Xop</a> )</em> </p><br><p>  All of these solutions have at least one of the following <del>  fatal </del>  disadvantages: </p><br><ol><li><p>  <strong>The implementation of macros specific control functions.</strong> <br>  Using macros as inline functions is a bad idea.  This has been said many times, but are we tired of repeating? <br>  <em>First</em> , when using macro functions, it is harder to track and debug errors due to incorrect argument types. <br>  <em>Secondly</em> , the macros-functions do not know how to return anything, if you do not take into account the perversion with the transfer of the variable name as a separate argument to store the result. <br>  <em>Thirdly</em> , due to constant code substitutions from macro functions that are not very similar to inline, the size of the translation unit swells.  Hence the increase in the size of the output executable file and other pleasures of life. <br>  <em>Fourth</em> , you cannot take a pointer to a macro. </p><br></li><li><p>  <strong>Duplication of functions common to any vectors.</strong> <br>  For example, different release functions for the vector <code>int</code> 's and the vector <code>char</code> ' s.  Under the hood, they will be just a call to the function <code>free()</code> , deeply indifferent to what is stored in the buffer being destroyed, as well as to the type of pointer to it. <br>  This again provokes an increase in the volume of translation units, duplication of code, and at the same time littering of the name space. </p><br></li><li><p>  <strong>Work with values ‚Äã‚Äãthrough untyped pointers.</strong> <br>  This makes it necessary to always take a pointer to the value to add it even to a simple vector of primitive types (for example, <code>int</code> 's).  And also do not forget about casting and dereferencing.  Well, that in such a vector, you can potentially stick values ‚Äã‚Äãof <em>different types</em> , and no one will warn us about this. </p><br></li><li>  <strong>The designation of the type of vector as a structure.</strong> <br>  The biggest drawback, in the presence of one which even the complete absence of others no longer plays a role. <br>  <em>First</em> , access to the vector elements occurs through the structure field.  For a one-dimensional vector, this is already inconvenient - is it worth talking about multidimensional. <br>  <em>Secondly</em> , all fields of the structure, even technical, are freely accessible to the user. <br>  <em>Thirdly</em> , the almost complete incompatibility between vectors of different types. <br>  <em>Fourth</em> , to create and delete a vector, you need 2 <code>malloc()</code> / <code>free()</code> calls, respectively - one per structure and one per vector buffer itself.  As you might guess, for the dimension vector <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.455ex" viewBox="0 -520.7 600.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324210/&amp;xid=17259,15700002,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjaIfeoqqaV72_cxfbblqlACcfd4g#MJMATHI-6E" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-1"> n </script>  calls will be already <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>2</mn><mi>n</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.557ex" height="1.937ex" viewBox="0 -728.2 1101 834" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324210/&amp;xid=17259,15700002,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjaIfeoqqaV72_cxfbblqlACcfd4g#MJMAIN-32" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324210/&amp;xid=17259,15700002,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjaIfeoqqaV72_cxfbblqlACcfd4g#MJMATHI-6E" x="500" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>2</mn><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> 2n </script>  . <br>  <em>Fifth</em> , such a vector can be transferred to its function only by a pointer to a structure, therefore the syntax for accessing it in a function will be slightly different ( <code>-&gt;</code> instead of <code>.</code> And so on). </li></ol><br><p>  Thus, the task of creating a vector that specializes in all types of C data and has the following capabilities emerges: </p><br><ol><li>  Access to elements of a vector as to elements of a regular array, regardless of its dimension: <code>vec[k]</code> , <code>vec[i][j]</code> , etc. </li><li>  Vector control using ordinary functions that have typed arguments and a return value, as opposed to macros. </li><li>  No duplicate code due to the specialization of only those functions that accept and / or return custom type values. </li><li>  The user has no direct access to vector technical information. </li><li>  Compatibility between vectors of different types at the level of assignment of one to another. </li><li>  The ability of the user in the specialization of the vector to specify the method of transmission and return values: by value or by reference (through the pointer). </li><li>  The maximum similarity of the vector interface with that of <code>std::vector</code> from C ++ 11. </li></ol><br><h1 id="dive-into-c89">  Dive into C89 </h1><br><p>  I will answer in advance the question why C89, and not at least C99.  First, it gives support to the compiler from Visual Studio (although I don‚Äôt like it).  Secondly, I myself love C99 very much, but in this case I felt that the task at hand could be solved in more severe conditions.  After all, the publication in "abnormal programming" must be justified. </p><br><p>  When I first began to study C, writing a <em>convenient</em> vector seemed to me extremely impossible - the indexing operator in the head was associated strictly with the array, the array was associated strictly with the typed pointer, and the vector was associated with the need to store technical information in the structure.  I could not get away from the idea that access to the elements of a vector could be realized only through the field of this structure itself, and the use of this approach by the overwhelming majority of vector realizations only strengthened confidence in this. </p><br><p>  But then I came across a dynamic string library for C called <a href="https://github.com/antirez/sds">Simple Dynamic Strings</a> , written at the time for <a href="https://redis.io/">Redis</a> .  It uses a different approach: technical information about the vector is not stored in the structure together with a pointer to it, but in the form of a header right before the vector buffer itself in memory.  This allows you to operate the vector directly through a typed pointer, while the placement of technical information is always reliably known. </p><br><p><img src="https://habrastorage.org/files/c9d/2cb/44d/c9d2cb44d5c64cd58d13fc2a97b91ecd.png" alt="image"></p><br><p>  Let me remind you that a typed pointer allows you to access the elements of a vector through an indexing operator, as in a regular array.  And the arrangement of technical information right in front of the vector itself deprives the user of direct access to it - for this he will have to manipulate the pointers.  In the case of a structure, both the pointer to the vector and the technical information are its fields, access to which is the same. </p><br><p>  Thus, we have implemented the possibilities (1) and (4).  Go ahead. </p><br><p>  Since now the vector is just a typed pointer, we, it would seem, can already generalize for different types of vectors such functions as, for example, the release function, simply designating the argument ‚Äúpointer to the vector to be released‚Äù as <code>void*</code> .  It is well known that any other pointer can be implicitly converted to <code>void*</code> , as well as vice versa. </p><br><p>  However, can we do this for other functions?  Oddly enough, but yes.  We do not have functions that operate directly on the stored values ‚Äã‚Äãthemselves - they were originally supposed to specialize separately for each type of vector.  In fact, we operate only on the places where values ‚Äã‚Äãare stored, but not on the values ‚Äã‚Äãthemselves.  Therefore, it is enough for us to know only the size of one element, which can be stored in the vector‚Äôs technical information and filled in as a function of its creation by passing the corresponding argument.  Such a trick allows us to generalize all functions for different types of vectors, and to specialize on their basis only those that accept and / or return values ‚Äã‚Äãof a user-defined type. </p><br><p>  Clauses (2) and (3) are implemented.  And since there are no objects in C and any value can be reassigned to another variable literally by copying the memory, item (5) is also implemented.  We continue in the same vein. </p><br><p>  In fact, all specialized functions operate on user-defined values ‚Äã‚Äãin one of two ways: </p><br><ul><li>  assignment of the transferred value to the indicated vector elements; </li><li>  return value of the specified item. </li></ul><br><p>  It is known that a value can be passed to a function or returned from it either by value (sorry for the pun) or by reference.  For primitive types, the first option is preferable, while for complex structures the second one. <br>  Of course there are no links a la C ++ in C, but pointers will replace them. </p><br><p>  Tired of the text?  rhetorical question. <br>  Then I will give for clarity the definitions of variants of the same functions that accept / return variables by value and by reference, respectively. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">gvec_error_e </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gvec_NAME_push</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> gvec_NAME_t* phandle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> TYPE </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">) gvec_error_e </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gvec_NAME_push</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> gvec_NAME_t* phandle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> TYPE* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span></code> </pre> <br><pre> <code class="hljs lisp">TYPE gvec_NAME_front( <span class="hljs-name"><span class="hljs-name">gvec_NAME_t</span></span> handle ) TYPE* gvec_NAME_front( <span class="hljs-name"><span class="hljs-name">gvec_NAME_t</span></span> handle )</code> </pre> <br><p>  It is seen that in both cases the difference is only in one symbol. </p><br><p>  Already in C89, an assignment operator is available for <em>all</em> types, not just primitive ones.  This allows sending and returning by reference or by value in specialized functions to be indicated by arguments of the specializer macro.  True, a reasonable question arises: why not to indicate this with one argument at once for transmission and return at the same time?  It is very simple: returning by value is more convenient and faster in the case of primitive types, but the value may not be determined if there is no requested element in the vector.  When returning by reference in this case, we can simply return <code>NULL</code> .  In short, this is left to the discretion of the programmer himself. </p><br><p>  As a result, paragraph (6) is implemented.  Paragraph (7) can also be considered implemented on the basis of all the previous ones. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  The final implementation of the vector library on C89, ready for practical use, is here: </p><br><p>  <a href="https://github.com/cher-nov/genvector">https://github.com/cher-nov/genvector</a> ( <del>  MIT License </del>  now WTFPL) </p><br><p>  The simplest example of use is given in ReadMe. </p><br><p>  Of course, the article does not cover some other, less complex but equally interesting aspects of implementation, for the description of which I lacked brevity and eloquence.  Also omitted the ranting about the decisions that turned out to be unsuccessful in the end, and their rethinking.  But I am sure that the answers on the first one can be obtained from the code and ReadMe in the repository, and on the second one - from the history of commits. </p><br><p>  This is my first article on Habr√©, so please judge as much as possible.  For the impediment - especially. </p><br><p>  I hope all this will prove to someone so useful. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/324210/">https://habr.com/ru/post/324210/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324196/index.html">A brief history of javascript. Part 1</a></li>
<li><a href="../324200/index.html">MAC addresses are different</a></li>
<li><a href="../324202/index.html">Excursion to the Moscow production of components for communication networks. Part two</a></li>
<li><a href="../324204/index.html">Development of the first game for Android using Adobe AIR and Stage3D</a></li>
<li><a href="../324208/index.html">Configuring DUNDi in Asterisk, running FreePBX</a></li>
<li><a href="../324216/index.html">Configuring web form functionality in MyTaskHelper: condition actions (triggers)</a></li>
<li><a href="../324218/index.html">How to create a product in 11 days</a></li>
<li><a href="../324220/index.html">NodeJS framework with Laravel syntax (and no noodles in code)</a></li>
<li><a href="../324222/index.html">Security defects that PVS-Studio team fixed this week: release N2</a></li>
<li><a href="../324224/index.html">Information for administrators of SED "Appeals of citizens"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>