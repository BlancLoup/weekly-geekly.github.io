<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ultimate performance: C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I will share 30 practices for maximum performance of applications that require it. Then, I will tell you how I applied them to a commercial product an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ultimate performance: C #</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage2/193/c62/bbc/193c62bbc754a714a70693e6ad304615.jpg" alt="performance">  I will share 30 practices for maximum performance of applications that require it.  Then, I will tell you how I applied them to a commercial product and achieved unprecedented results! <br>  The application was written in C # for the Windows platform, working with Microsoft SQL Server.  No profilers - the content is based on an understanding of the work of various technologies, so many topics will be useful for other platforms and programming languages. <br><a name="habracut"></a><br><h4>  Foreword </h4><br>  It all started back in 2008 - then I started working on the tasks of comparing and replicating relational databases.  These types of applications primarily require high quality performance, because  data loss or corruption can be disastrous.  Secondly, database sizes can reach hundreds and thousands of gigabytes, so application performance is required. <br>  The main focus was on SQL Server, and since Microsoft had long abandoned the normal support for the <a href="http://en.wikipedia.org/wiki/ODBC">ODBC</a> driver and provided full functionality only in the <a href="http://msdn.microsoft.com/en-us/library/e80y5yhx.aspx">ADO .NET</a> provider, the application needed to be written in one of the languages ‚Äã‚Äãfor the .NET Framework.  Of course the combination of High Performance Computing and the .NET platform at least brings a smile, but do not rush to conclusions. <br>  When the product was ready, the results exceeded all expectations, and the performance was several times higher than the best solutions on the market.  In this article I want to share with you the basic principles that should be followed when writing high-performance applications. <br><br><h4>  Principles of optimization </h4><br>  All principles are grouped into categories, and their description may contain statements without explanation, but they are all based on facts and research, which can be easily found on the Internet. <br>  Each of the items contains brief information that displays the main essence.  Some details may not be covered due to the saturation of the material, and for each of the items you can write a separate article.  Therefore, I strongly recommend that you familiarize yourself with the details of each item from any available sources, before putting them into practice.  Incorrect understanding of the material presented and gaps in knowledge can lead at least to a deterioration in the performance of your application. <br>  All code examples are trivial, and demonstrate only the basic essence, and do not solve a specific problem. <br><br>  <b>Start with ...</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  1. Good algorithm. </h5>  First of all, for the problem it is necessary to choose the best algorithm for its solution.  Only after that you can engage in optimization.  If the algorithm is chosen incorrectly, no optimization will help. <br>  In-depth knowledge of the work of various technologies is the basis of all optimization techniques.  And this knowledge helps in choosing an algorithm from several possible. <br><br><h5>  2. Action Plan. </h5>  If you clearly formulate all the tasks that the algorithm performs, firstly, it will be easier for you to understand and implement the algorithm, and secondly, you will be able to construct a graph of actions - this way you will know the exact order of their execution and what actions you can perform in parallel. <br><br><h5>  3. Micro-delays. </h5>  There is a certain operation, the execution time of which takes F seconds.  If you reduce this time by just 1 microsecond, then over 100 million iterations you will get a gain of 100 seconds!  Such frequent operations are the first candidate for optimization. <br><br>  <b>Code branching</b> <br><br><h5>  4. Do not use ‚Äúif‚Äù when everything is known in advance. </h5>  Let's start with a simple example of a class in which there is a public method, and its internal implementation: <br><div class="spoiler">  <b class="spoiler_title">code example</b> <div class="spoiler_text"><pre><code class="cs">class Example
{
    public void Print(String msg)
    {
        if (msg == null)
            throw new ArgumentNullException();
        PrintInternal(msg);
    }

    private void PrintInternal(String msg)
    {
        if (msg == null)
            throw new ArgumentNullException();
        ...
    }
}
</code></pre><br>
</div></div><br>
         .     ¬´  ¬ª,   ¬´if¬ª ‚Äì      ,     .     ¬´PrintInternal¬ª     ¬´Print¬ª,    .  ,          ,      .   -     <a href="http://en.wikipedia.org/wiki/You_ain%27t_gonna_need_it"><abbr title="You Ain't Gonna Need It">YAGNI</abbr></a> ‚Äì   ,    ?<br>
   :<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">void PrintValues(IDataReader dataReader)
{
    while (dataReader.Read())
    {
        for (int i = 0; i &lt; dataReader.FieldCount; i++)
        {
            object value = dataReader.GetValue(i);
            PrintValue(value);
        }
    }
}

void PrintValue(object value)
{
    if (value is int)
        ...
    else if (value is long)
        ...
    else if (value is String)
        ...
    else if ...
}
</code></pre><br>
</div></div><br>
    <a href="http://msdn.microsoft.com/en-us/library/system.data.idatareader.aspx">IDataReader</a>       .  ,      ¬´Print¬ª,         ?     ,     <a href="http://msdn.microsoft.com/en-us/library/system.data.idatareader.getschematable.aspx">GetSchemaTable</a>.       :<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">delegate void PrintMethod(object value);

void PrintValues(IDataReader dataReader)
{
    PrintMethod[] printers = new PrintMethod[dataReader.FieldCount];
    for (int i = 0; i &lt; printers.Length; i++)
    {
        Type fieldType = dataReader.GetFieldType(i);
        if (fieldType == typeof(int))
            printers[i] = PrintInt;
        else if (fieldType == typeof(long))
            printers[i] = PrintLong;
        else ...
    }

    while (dataReader.Read())
    {
        for (int i = 0; i &lt; printers.Length; i++)
        {
            object value = dataReader.GetValue(i);
            printers[i](value);
        }
    }
}
</code></pre><br>
</div></div><br>
 ,           ,     ,      .   ,  -      ,     ,      . ,   <a href="http://msdn.microsoft.com/en-us/library/yz2be5wk.aspx">Boxing / Unboxing</a>      ,  ,     .<br>
<br>
<h5>5.     ¬´if¬ª.</h5>    ‚Äì   ¬´ ¬ª,     .  ‚Äì     ,         .<br>
<a href="http://en.wikipedia.org/wiki/Instruction_scheduling">Instruction Scheduling</a> ‚Äì    ,     .  :<br>
<pre><code class="cs">int x = a * b;
int y = c ^ d;
int z = x + y;
int w = z - y;
</code></pre><br>
,    ,            .  ,         <a href="http://en.wikipedia.org/wiki/Processor_register">  </a>,           .          ,     .<br>
   ,         ¬´if¬ª.   ,      ,           ,          ,    ,      <a href="http://en.wikipedia.org/wiki/Branch_prediction">Branch prediction</a>.<br>
  :        ¬´if¬ª?    -1, 0,  1,   : int CompareBytes(byte a, byte b)<br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="cs">int CompareBytes(byte a, byte b)
{
    unchecked
    {
        int ab = (int)a - (int)b;
        int ba = (int)b - (int)a;
        return (ab &gt;&gt; 31) | (int)((uint)ba &gt;&gt; 31);
    }
}
</code></pre><br>
</div></div><br>
      ,      ¬´if¬ª.          ,    ¬´if¬ª     (    ).   ,           .<br>
<br>
<b></b><br>
<br>
<h5>6.  .</h5><br>
<ul>
<li> ¬´foreach¬ª ‚Äì      ,    IEnumerable ( ,    16  23).</li>
<li>     IList  IEnumerable,       (.  24).   ¬´var¬ª.</li>
<li> ,   ,    List.        ,    .     ,  ¬´for¬ª <a href="http://blogs.msdn.com/b/clrcodegeneration/archive/2009/08/13/array-bounds-check-elimination-in-the-clr.aspx"> </a>: <br>
<pre><code class="cs">for (int i = 0; i &lt; a.Length; i++) {
    int e = a[i];
}
</code></pre></li>
<li>       ‚Äì  ,       <a href="http://en.wikipedia.org/wiki/Processor_register">  </a> (    ),        (   ).<br>
<div class="spoiler"><b class="spoiler_title"> ,      </b><div class="spoiler_text"><pre><code class="cs">for (int i = 0; i &lt; a.Count; i++) {
    int a = a[i];
    int b = a[i];
    int c = a[i];
}
</code></pre><br>
</div></div><br>
</li>
</ul><br>
<h5>7.  .</h5>   ‚Äì     ¬´if¬ª.    ,     ,        ,    -  (,   Copy  N  Paste).<br>
<div class="spoiler"><b class="spoiler_title"> ‚Äì    4- </b><div class="spoiler_text"><pre><code class="cs">int power4(int v)
{
    int r = 1;
    r *= v;
    r *= v;
    r *= v;
    r *= v;
    return r;
}
</code></pre><br>
</div></div><br>
   ,  -  N    K ,  N  K. ..       N/K ,    K .  ,     ,    -   K .<br>
<div class="spoiler"><b class="spoiler_title">   </b><div class="spoiler_text"><pre><code class="cs">int power(int v, int N)
{
    int r = 1;
    // Reduce the number of iterations by 4 times.
    for (int loops = N &gt;&gt; 2; loops &gt; 0; loops--)
    {
        r *= v;
        r *= v;
        r *= v;
        r *= v;
    }
    // Process the tail.
    for (int loops = N &amp; 3; loops &gt; 0; loops--)
    {
        r *= v;
    }
    return r;
} 
</code></pre><br>
</div></div><br>
         ,    .     <a href="http://en.wikipedia.org/wiki/Loop_unwinding">¬´Loop unwinding¬ª  Wikipedia</a>.<br>
<br>
<b> </b><br>
<br>
<h5>8.  .</h5>   ,    ,    ‚Äì      .   ,      <a href="http://en.wikipedia.org/wiki/Critical_section"> </a> ( <a href="http://msdn.microsoft.com/en-us/library/system.threading.monitor.aspx">Monitor</a>   <a href="http://msdn.microsoft.com/en-us/library/c5kehkcz(v%3Dvs.71).aspx">lock</a>),  (, <a href="http://msdn.microsoft.com/en-us/library/system.threading.manualresetevent.aspx">ManualResetEvent</a>),  <a href="http://msdn.microsoft.com/en-us/library/system.threading.interlocked.aspx">Interlocked</a>,        <a href="http://msdn.microsoft.com/en-us/library/x13ttww7.aspx">volatile</a>. ,   .    .<br>
      ¬´volatile¬ª, ..       .   ,     ,   -, ,  . ‚Äì    .   ,       stack‚Äô ‚Äì ..   .            ,      .  ,       . ,      ‚Äì   ,        ,       ,      ,        . ..     .<br>
 ¬´volatile¬ª ‚Äì    ,       ,       ,     ‚Äì       .        .   ,       ¬´¬ª  ,        . ,    <a href="http://msdn.microsoft.com/en-us/library/system.threading.interlocked.aspx">Interlocked</a>,       .<br>
¬´Volatile¬ª  ,      ,    ,        .         . <div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">class AsyncWorker
{
    volatile int progress;

    public int Progress
    {
        get
        {
            return progress;
        }
    }

    void DoWork()
    {
        for (this.progress = 0; this.progress &lt; Count; this.progress++)
        {
            ...
        }
    }
}
</code></pre><br>
</div></div><br>
      ,           UI.     ¬´progress¬ª    ¬´volatile¬ª,    ,                     0.          ,     ,             .<br>
<br>
<h5>9.   .</h5>     <a href="http://msdn.microsoft.com/en-us/library/system.threading.threadpool.aspx">ThreadPool</a>,    ,             ,       .    ,      ,      ‚Äì !       ,   .<br>
     2   ,      2.    3  :<br>
<ul>
<li>          </li>
<li>     ,    </li>
<li>       AES-256</li>
</ul><br>
     ,  ,       ‚Äì         ,   .   .         ,      .       ,   ,          ,      . ,       ,   ¬´¬ª  ,          .<br>
 ,      ,        . ,   - ,       .    ,           .<br>
<br>
<h5>10.  .</h5>    N ,      ,        ‚Äì      .  ,       .      F ,           S . ,  F   S,    S  F.  ,  ,        ,     ( )   ,       (N x F &lt;= N x S).    ,        ,      .<br>
  K   ¬´¬ª,       ,  ,         ,       K .    1000 ,      1000 . , ? ,    16 ,             N x F / 16.   F   S,     N x F / 16 &gt; N x S / 1000. ..      ,      16 .     :<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">void DoWork(ItemProvider provider)
{
    Batch batch = NextFreeBatch();

    while (true)
    {
        Item item = provider.GetNextItem();
        batch.AddItem(item);

        if (batch.IsFull)
        {
            EnqueueBatchForAsyncProcessing(batch);
            batch = NextFreeBatch();
        }
    }
}

void EnqueueBatchForAsyncProcessing(Batch batch)
{
    lock (this.batchQueue)
        this.batchQueue.Enqueue(batch);
}

void ThreadRoutine()
{
    while (true)
    {
        Batch batch = DequeueBatchForAsyncProcessing();

        foreach (Item item in batch)
            ProcessItem(item);

        RecycleBatch(batch);
    }
}

Batch DequeueBatchForAsyncProcessing()
{
    lock (this.batchQueue)
        return this.batchQueue.Dequeue();
}

</code></pre><br>
,  ‚Äì     .      ,     .<br>
</div></div><br>
<br>
<h5>11.  .</h5>  ,     ¬´¬ª ,      ?        (<a href="http://en.wikipedia.org/wiki/Virtual_memory"> </a>),             .       ¬´¬ª,   <a href="http://en.wikipedia.org/wiki/Context_switch"> </a> ‚Äì          ,         . ..      ,   ,     ,    ,    ,   .  ,          ,    ¬´ ¬ª.<br>
  ‚Äì   ,    -     .         ,     ,      .<br>
   ,       /.     <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.process.processoraffinity.aspx">Process.ProcessorAffinity</a> (     ),      <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.processthread.processoraffinity.aspx">ProcessThread.ProcessorAffinity</a>.<br>
        ‚Äì  <a href="http://msdn.microsoft.com/en-us/library/system.threading.thread.priority.aspx">Thread.Priority</a>.   ,        .        ‚Äì <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.process.priorityclass.aspx">Process.PriorityClass</a>.<br>
<br>
<b>   </b><br>
<br>
<h5>12.    .</h5>  ,         ,     ,       .  ,     /  ¬´¬ª,    512 .        ¬´¬ª,     .   Windows,    ‚Äì 4 KiB.  ,        1 ,       .   /     .<br>
  ,       2 KiB ,    1 KiB,      4 KiB   ,   4 KiB  .           ,           . ,     2 KiB     3 KiB,   KiB    ,   KiB      .<br>
    .    -   ,     ,        ‚Äì   . ,  ,      RAID    ,        .<br>
    /,     ,   .      FileStream,      -    4 KiB.    ,     <a href="http://msdn.microsoft.com/en-us/library/33b50d8h.aspx"> FileStream</a>    bufferSize.<br>
<div class="spoiler"><b class="spoiler_title">    </b><div class="spoiler_text"><pre><code class="cs">[DllImport("kernel32.dll", CharSet = CharSet.Unicode, SetLastError = true, EntryPoint = "GetDiskFreeSpaceW")]
static extern bool GetDiskFreeSpace(string lpRootPathName, out int lpSectorsPerCluster, out int lpBytesPerSector, out int lpNumberOfFreeClusters, out int lpTotalNumberOfClusters);

// Each partition has its own cluster size.
public static int GetClusterSize(string path) {

	int sectorsPerCluster;
	int bytesPerSector;
	int freeClusters;
	int totalClusters;
	int clusterSize = 0;
	if (GetDiskFreeSpace(Path.GetPathRoot(path), out sectorsPerCluster, out bytesPerSector, out freeClusters, out totalClusters))
		clusterSize = bytesPerSector * sectorsPerCluster;
	return clusterSize;
}
</code></pre><br>
</div></div><br>
       MTU (<a href="http://en.wikipedia.org/wiki/Maximum_transmission_unit">Maximum Transmission Unit</a>)       .          .<br>
<br>
<h5>13.  .</h5>     ,    Stream   ‚Ä¶    ?  ,   .  ,  FileStream   ,   ,   .    ,      .   ,    ? (   HDD  -.) ,   ,    .     ,    .<br>
        Stream,     ,           .         ,      (.  ‚Ññ9).  ,       .     Stream        ‚Äì     .            Stream. -,  !    ,       .     ,     .<br>
     ,        (,   <a href="http://msdn.microsoft.com/en-us/library/system.net.sockets.networkstream.aspx">NetworkStream</a>).<br>
<br>
<h5>14.  .</h5>     ( ‚Ññ13),      .           ,           .     ,      .        Stream.<br>
           .<br>
<br>
<h5>15.  .</h5>    ,   ,    ‚Äì  .       ,         .          ,     IOPS (<a href="http://en.wikipedia.org/wiki/IOPS">Input-Output Operations per Second</a>) ‚Äì   ,   .   , :<br>
<ul>
<li> /  .         .</li>
<li>  =   =  IO </li>
</ul><br>
   ,      ( )   . ,              .<br>
    ,    ,  -  LZ (<a href="http://en.wikipedia.org/wiki/Lempel%25E2%2580%2593Ziv%25E2%2580%2593Welch">Lempel-Ziv</a>),       (       ).<br>
<br>
<b> </b><br>
<br>
<h5>16. ,   .</h5>       ,     :<br>
<ul>
<li>     , ..       ,     ,     ,      .</li>
<li>   <a href="http://en.wikipedia.org/wiki/Stack-based_memory_allocation">stack‚Äô</a> (  ,  ).    stack‚Äô   : stack ‚Äì    ,         ( ,   )     stack pointer (, ..   stack‚Äô  -).     ,  ¬´¬ª    stack‚Äô       stack pointer   ,   .        ‚Äì    ,       .</li>
<li>- ,     stack‚Äô,    <a href="http://msdn.microsoft.com/en-us/library/0xy59wtx.aspx"> </a>.          <a href="http://en.wikipedia.org/wiki/Fragmentation_(computing)"> </a>.</li>
<li>,   ‚Äì  <a href="http://msdn.microsoft.com/en-us/library/s1ax56ch.aspx">value types</a>,       .<br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><pre><code class="cs">    MyStruct value;
    // Allocate memory buffer.
    byte[] buffer = new byte[Marshal.SizeOf(typeof(MyStruct))];
    fixed (byte* ptr = buffer)
    {
        // Serialize value.
        *((MyStruct*)ptr) = value;
        // Deserialize value;
        value = *((MyStruct*)ptr);
    }
</code></pre><br>
</div></div><br>
</li>
</ul><br>
 ,  <a href="http://msdn.microsoft.com/en-us/library/490f96s2.aspx">reference types</a>      ,        ¬´ref¬ª.<br>
<br>
<h5>17.  . </h5>       .NET Framework,   ,    .      ,     ‚Äì   .   (   ),       ,       (  main).          ,     ,   ,      ,    .<br>
    ,          ¬´null¬ª.     ,            ,     .<br>
        ‚Äì      ,    .<br>
<br>
<h5>18.   .</h5>    ‚Äì  ,         <a href="http://en.wikipedia.org/wiki/Fragmentation_(computing)"> </a>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/cc441804(v%3Dvs.85).aspx"> </a> . ,       ,            (    byte[], int[],  .).      ,             ‚Äì   .        ,            new   ,   .<br>
         <a href="http://en.wikipedia.org/wiki/Stack-based_memory_allocation">stack</a>.   stack‚Äô       (. <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682453(v%3Dvs.85).aspx">CreateThread</a>),     <a href="http://en.wikipedia.org/wiki/Call_stack">  </a>,    ,  ,     .<br>
    , ,       ,      ,    <a href="http://msdn.microsoft.com/en-us/library/bb348051.aspx">Array.Resize</a>.       ,          .       ,        (.  26).<br>
     ,    ¬´byte¬ª   ¬´int¬ª  :<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">internal static class ByteArrayReinterpreter
{
    private static IntPtr intArrayTypePtr;

    unsafe static ByteArrayReinterpreter()
    {
        int[] intArray = new int[1];
        fixed (int* ptr = intArray)
            intArrayTypePtr = *(IntPtr*)(((byte*)ptr) - (IntPtr.Size * 2));
        intArray = null;
    }

    public static unsafe int[] AsIntArray(this byte[] array)
    {
        if ((array.Length &amp; 3) != 0)
            throw new ArgumentException("The array length must be multiple of 4.");

        object arrayObj = array;
        int newLength = array.Length &gt;&gt; 2;

        fixed (byte* ptr = array)
        {
            *(IntPtr*)(((byte*)ptr) - (IntPtr.Size * 2)) = intArrayTypePtr;
            *(int*)(((byte*)ptr) - IntPtr.Size) = newLength;
        }

        return (int[])arrayObj;
    }
}
</code></pre><br>
     ‚Äì        ,       ,     .<br>
</div></div><br>
<br>
<b>  </b><br>
<br>
<h5>19. ¬´unsafe¬ª  .</h5>    ¬´<a href="http://msdn.microsoft.com/en-us/library/chfa2zb8(v%3Dvs.110).aspx">unsafe</a>¬ª   C#  ,       .        ‚Äì   int   Guid,      ,      ,  ..   unsafe       ,         .<br>
<br>
<h5>20.  .</h5>      ,      .       ¬´bool¬ª? 4   32-   8 ‚Äì  64-.       ¬´bool¬ª ‚Äì       .    ,    ¬´byte¬ª, ¬´ushort¬ª, ¬´uint¬ª,  ¬´ulong¬ª,        (. ¬´<a href="http://msdn.microsoft.com/en-us/library/cc138362.aspx">enum</a>¬ª).<br>
       ,     .     ¬´int¬ª,     0  10?  ¬´byte¬ª   .<br>
,   ,      20  ( 0  1048575)    ¬´int¬ª (32 ),      12    ,    .      ,   . ,    ,       (    ,   ).<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">int field;
// Decouple numeric and flags
const int NumericMask = ((1 &lt;&lt; 20) - 1);
int numeric = field &amp; NumericMask;
MyFlags flags = (MyFlags)(field &gt;&gt; 20);
// Unite numeric and flags back
field = ((int)flags &lt;&lt; 20) | numeric;
</code></pre><br>
</div></div><br>
    ,    . ,         ¬´ ¬ª            .<br>
, ,          ,          ,      .<br>
<br>
<h5>21.   .</h5>    :<br>
<pre><code class="cs">struct S
{
    byte a;
    short b;
    short c;
}
</code></pre><br>
    5 . ,     S[],      -    ¬´b¬ª. ,   ¬´new¬ª     ,       0x100000 ‚Äì     ,     , ,   ,  4  8.          ¬´b¬ª  0x100001,   ‚Äì 0x100006,  ‚Äì 0x10000B,  ..    ,            ‚Äì    ¬´ ¬ª.   x86  x86-64 (    4  8  )   ,          .<br>
 <a href="http://en.wikipedia.org/wiki/Data_structure_alignment">  </a>   padding ‚Äì   ,           .      4 ,  :<br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><pre><code class="cs">struct S
{
    // offset: 0, size: 4
    byte a;
    byte __padding_byte_1;
    byte __padding_byte_2;
    byte __padding_byte_3;
    // offset: 4, size: 4
    short b;
    byte __padding_byte_4;
    byte __padding_byte_5;
    // offset: 8, size: 4
    short c;
    byte __padding_byte_6;
    byte __padding_byte_7;
    // total size: 12
}
</code></pre><br>
</div></div><br>
     ,  .NET Framework  <a href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.structlayoutattribute.aspx">StructLayoutAttribute</a>.   ,        ‚Äì   ,     ,        .<br>
     .   ,      ,     .     ,   . ,    cache lines ‚Äì    (, 32 ),           (   ).       ¬´S¬ª  5 ,  ,         ,       6     (  -  32 ;    ,     , -  ).             -,      ‚Äì   .    <a href="http://en.wikipedia.org/wiki/CPU_cache">-</a>,         ,      .   ,       ,     .   <a href="http://stackoverflow.com/questions/6972437/pinvoke-for-getlogicalprocessorinformation-function">¬´PInvoke for GetLogicalProcessorInformation¬ª  StackOverflow</a>         .<br>
,    ,        .     <a href="http://en.wikipedia.org/wiki/Virtual_memory"> </a>,        .      ,       4 KiB,     8 KiB        .  ¬´ ¬ª?   ,   Windows      ?              .<br>
<br>
<h5>22.  x86-64.</h5>      64- ,      64-   RAX, RSP,  .. ,  ,     ¬´long¬ª  ¬´int¬ª.    ‚Äì        (   ),        .       ‚Äì   ¬´int¬ª     8-  ,     .<br>
    <a href="http://msdn.microsoft.com/en-us/library/system.guid.aspx">Guid</a>.   11  (int, 2 short,  8 byte),     16 . , Equals     :<br>
<div class="spoiler"><b class="spoiler_title">  Equals</b><div class="spoiler_text"><pre><code class="cs">bool Equals(Guid g)
{
    return g._a == this._a &amp;&amp; g._b == this._b &amp;&amp; g._c == this._c &amp;&amp; g._d == this._d
         &amp;&amp; g._e == this._e &amp;&amp; g._f == this._f &amp;&amp; g._g == this._g &amp;&amp; g._h == this._h
         &amp;&amp; g._i == this._i &amp;&amp; g._j == this._j &amp;&amp; g._k == this._k;
}
</code></pre><br>
</div></div><br>
 11 ,      4-,  ¬´unsafe¬ª:<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">unsafe bool Equals(Guid g)
{
    fixed (Guid* pg = &amp;this)
    {
        int* p1 = (int*)pg;
        int* p2 = (int*)&amp;g;
        return p1[0] == p2[0] &amp;&amp; p1[1] == p2[1] &amp;&amp; p1[2] == p2[2] &amp;&amp; p1[3] == p2[3];
    }
}
</code></pre><br>
</div></div><br>
   x86-64,        :<br>
<div class="spoiler"><b class="spoiler_title">   x64</b><div class="spoiler_text"><pre><code class="cs">unsafe bool Equals(Guid g)
{
    fixed (Guid* pg = &amp;this)
    {
        long* p1 = (long*)pg;
        long* p2 = (long*)&amp;g;
        return p1[0] == p2[0] &amp;&amp; p1[1] == p2[1];
    }
}
</code></pre><br>
</div></div><br>
   11 ‚Äì -,  !<br>
<br>
<h5>23.  .</h5>  ,     ,      ,       .    ,  ,    ,      .  .<br>
   x86    CALL  RET ( ¬´return¬ª).  CALL      ,   RET     ‚Äì   ,   CALL. ..        JMP ( ¬´jump¬ª) ‚Äì       .  ,    ,  CALL   stack      (  IP)   JMP,   RET     stack‚Äô   JMP    .<br>
,       - .      ,   stack,       .   <a href="http://en.wikipedia.org/wiki/X86_calling_conventions">  </a>.      (      ),      stack‚Äô,      .<br>
,  :<br>
<ul>
<li>     .</li>
<li>     stack‚Äô  CALL/RET.</li>
<li>      stack‚Äô.</li>
</ul>   :<br>
<ul>
<li>,     .       .</li>
<li>       IL   .</li>
<li>           (- JMP- ).</li>
</ul><br>
 1.  ,    Guid   :<br>
<pre><code class="cs">bool CompareGuids(Guid g1, Guid g2)
</code></pre><br>
 ,   Guid  16 ,       stack   32 ,    g1  g2.  ,   :<br>
<pre><code class="cs">bool CompareGuids(ref Guid g1, ref Guid g2)
</code></pre><br>
 ,        ,    ,    4   32- ,  8   64- .  ,  ,         ,   stack (    ).<br>
 2.  ,    ,  ,   :<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">int Multiply(int a, int b)
{
    return a * b;
}

void Foo()
{
    int a = 4;
    int b = 5;
    int r = Multiply(a, b);
}
</code></pre><br>
</div></div><br>
   Foo       Multiply,    a  b        .        ,      ,     !        ?    ‚Ññ3.<br>
   ,  C++    <a href="http://en.wikipedia.org/wiki/Inline_function">inline</a>,   ,        . ,   .NET Framework    4.5 -   <a href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.methodimploptions%2528v%3DVS.110%2529.aspx">inline </a> (       inline ‚Äî    ).     ,      assembler,       .     ‚Äì  Copy Paste.<br>
           ‚Äì     ,     .<br>
<br>
<h5>24.  .</h5>      ,  .         .   :<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">class X
{
    virtual void A();
    virtual void B();
}

class Y : X
{
    override void B();
}
</code></pre><br>
</div></div><br>
  : X,  Y,    X.    <a href="http://en.wikipedia.org/wiki/Virtual_method_table">  </a>,     X   : X.A  X.B,    Y     X.A  Y.B.       ( X  Y),     .<br>
 ‚Äì   ,        IntPtr[].  ,      CALL,         ,   ‚Äì  ,     .<br>
    ,      .    ‚Äì  ¬´<a href="http://msdn.microsoft.com/en-us/library/88c54tsw.aspx">sealed</a>¬ª     .  ¬´sealed¬ª   ,      ,        -.      X  Y:<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">sealed class Y : X
{
    override void B();
}

void Slow(X x)
{
    x.B();
}

void Fast(Y y)
{
    y.B();
}
</code></pre><br>
</div></div><br>
   ¬´Y¬ª   ,    ,    ¬´B¬ª  ¬´Y¬ª.   Slow      ¬´X¬ª,     ¬´B¬ª    ¬´Y¬ª       ,    ¬´X¬ª   .<br>
,   Fast  ,   ¬´Y¬ª   ,    ,      ¬´B¬ª.    ,       ,     ¬´B¬ª  ¬´Y¬ª,      . ,       ,    ,   ¬´B¬ª .          ¬´B¬ª,     .<br>
<br>
<b>  </b><br>
<br>
<h5>25. Reverse engineering.</h5>       ,       .  - ...?   , <a href="http://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqldatareader.aspx">SqlDataReader </a>  GetValue      ¬´xml¬ª      String  <a href="http://msdn.microsoft.com/en-us/library/system.xml.xmlreader.aspx">XmlReader</a>.     ,      ¬´xml¬ª    .     ‚Äì      ,     <a href="http://msdn.microsoft.com/en-us/library/system.stringcomparison.aspx">StringComparison.Oridnal</a>    .    ,     SqlDataReader,        XML      .  ,          ,  .        ,    SqlDataReader  (  <a href="http://msdn.microsoft.com/en-us/library/f7ykdhsy(v%3Dvs.110).aspx"></a>),   ¬´xml¬ª     ¬´varbinary¬ª.  ,          ,   . ,    ,     XML   , ,   ,   (    )   XmlReader    ,    XML.<br>
<br>
<h5>26.  .</h5>     - 3D  ,   ( )    ,  ,  ,         ,      .       .<br>
 3D    3D      .        ,      :       ,  3D .        ,     - .<br>
    .    -  ? ,       .   ,           - ,      ‚Äì        .   Full HD (1920x1080)   32-   ‚Äì   8 MiB!      ,   .   ,  ,        (     100  ).  ,         FPS  .<br>
    .NET Framework?   ,     ,    .        ,      .    ,      ‚Äì  new.           0  null,         0.     ,     ‚Äì   ,      ,       .   ,        ,    ‚Äì        . ..  .NET     ,        .      ,        ?<br>
     <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa366574(v%3Dvs.85).aspx">GlobalAlloc</a> (  GMEM_ZEROINIT)  <a href="http://msdn.microsoft.com/en-us/library/system.gc.addmemorypressure.aspx">GC.AddMemoryPressure</a>,           ,    0  .    ,  ,   ,     ,     .<br>
<br>
<b> </b><br>
<br>
<h5>27.  ¬´Format¬ª  ¬´ToString¬ª.</h5>                 String.Format,    .    String.Concat  StringBuilder ‚Äì  .      ,     ‚Äú{0}‚Äù      .<br>
   ,     ToString. ,      <a href="http://en.wikipedia.org/wiki/Data_manipulation_language">DML</a>  (INSERT/UPDATE/DELETE;         )           SQL Server  ,  -     String.       3 !<br>
<br>
<h5>28.  .</h5>      <a href="http://en.wikipedia.org/wiki/Lexical_analysis"></a>   T-SQL,         .      identifier  ,     .         <a href="http://msdn.microsoft.com/en-us/library/bb359438.aspx">Hashset</a>. ,       ,  :<br>
<pre><code class="cs">HashSet&lt;string&gt; keywords;
String tokenText;
bool isKeyword = keywords.Contains(tokenText.ToUpperInvariant());
</code></pre><br>
    :<br>
<ul>
<li> ¬´ToUpperInvariant¬ª    String.</li>
<li> ¬´ToUpperInvariant¬ª       .</li>
<li>   ,   .   ,  .</li>
</ul><br>
    .  ¬´keywords¬ª  Hashset&lt;int&gt;      ,   -. ,      T-SQL    String.GetHashCode  .  ,      32- .        .      T-SQL,   .   ,       , ,   , ..      ASCII.      .NET   UCS2/UTF16 ,    Unicode  127 <a href="http://en.wikipedia.org/wiki/Code_point">code points</a>    ASCII,       ToUpper  ASCII,     - ,      ¬´keyword¬ª!<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cs">bool IsKeyword(String tokenText)
{
    int hashCode = 0;

    for (int i = 0; i &lt; tokenText.Length; i++)
    {
        int c = (int)tokenText[i];

        // check upper bound
        if (c &gt; 'z')
            return false;

        // to upper case for Latin letters
        if (c &gt;= 'a')
            c ^= 0x20;

        // a keyword must be of Latin letters, numbers, and underscore
        if ( ! ((c &gt;= 'A' &amp;&amp; c &lt;= 'Z') || (c &gt;= '0' &amp;&amp; c &lt;= '9') || c == '_'))
            return false;

        // update hash code
        hashCode = hashCode &lt;op&gt; c;
    }

    return keywords.Contain(hashCode);
}
</code></pre><br>
</div></div><br>
    ,    ToUpper  code points,        ,      .          ,        .<br>
<br>
<h5>29.   !</h5>     - .   ‚Äì      -  .     ‚Äì         ?    , ,      ,     ,       .<br>
  :  T-SQL         UI   .   :       ,     ,      .  ,        ,           3    :    ,      ,     .      :<br>
<ul>
<li>   ,     ,            .</li>
<li>   text view,      ,       (    ).</li>
<li>    ,          text view.      text view,    .</li>
<li>   ,      ¬´int¬ª.              .         ,      ,       .        ,     ,   .    ,    - . ,    ‚Äì              ,         .  ,        8 : 4 ‚Äì , 4 ‚Äì .</li>
</ul><br>
       ,      .   ,   :        ,      ,            .<br>
<br>
<h5>30.  .</h5>    ,           ,        <a href="http://en.wikipedia.org/wiki/Software_design_pattern"> </a>.    ‚Äì ,   :<br>
<pre><code class="cs">class Multiplier
{
    public int a, b;
    public int Multiply() { return a * b; }
}
</code></pre><br>
-,    ¬´Multiply¬ª   ,     . -,  .   ,  ,       ,     .  ,     ,       ,     .<br>
   ,       ,     ¬´<a href="http://en.wikipedia.org/wiki/Code_smell"></a>¬ª.    ,          ,    ,    ,      - .<br>
<br>
<h4>   </h4><br>
   ,   ,      ( ,  )      ,      5 .  ,       ,       ‚Äì    .     ,         ,      .<br>
<br>
<h5>   </h5><br>
   .    ,  ,    (  )     .    :  staging ,      production; CMS  ,      ‚Äì    ,  ,       ,   ;       ;  ..<br>
       :<br>
<ol>
<li>,       (, , ,  ..;    database schema)</li>
<li>  ,     ( ,  ;    database data)</li>
</ol><br>
 ,          :    ,   ‚Äì .    ,        ,        .<br>
<br>
<h5> </h5><br>
         6  :<br>
<ol>
<li>     .  ,   ¬´¬ª ,        ,    .</li>
<li>      .  ,       ,    ,      .</li>
<li>     .       ,     Customers      Customers   ,  Products ‚Äì   Products,   .           .</li>
<li>  .  ,      ‚Äì       .        4   :<br>
 ‚Ä¢      (    )<br>
 ‚Ä¢     <br>
 ‚Ä¢   (   - )<br>
 ‚Ä¢   (    )<br>
    ( ),        ,      .</li>
<li> ,  .        ,        ,         .           ( 10  ,  5  ,  50  ,  ..)</li>
<li> .         ,  SQL ,   .        ,        .</li>
</ol><br>
<br>
<h5>  </h5><br>
   ,          (,    UI         back-end‚Äô,     ¬´  ¬ª).   ,                .<br>
           :<br>
<ul>
<li>Intel i7-2630QM (4 cores @ 2GHz, 2.9GHz in Turbo, 8 logical threads)</li>
<li>12 Gb RAM DDR3 @ 1333 MHz (9-9-9-24)</li>
<li>Intel SSD X25-M 120 Gb (250 Mb/s read, 35000 IOPS; 100Mb/s write, 8600 IOPS)</li>
<li>Microsoft SQL Server 2008 R2 Developer Edition 64-bit</li>
<li>Windows 7 Ultimate x64</li>
</ul><br>
  2  3       22  ,    .<br>
<table>
<tbody><tr>
<th> </th>
<th><nobr></nobr></th>
<th><nobr>‚ÄÉ‚ÄÉ</nobr></th>
<th><nobr> % </nobr><br>
<nobr></nobr></th>
</tr>
<tr>
<td>      (, )</td>
<td>24 </td>
<td>6 </td>
<td>4</td>
</tr>
<tr>
<td>       (, )</td>
<td>16 </td>
<td>2 </td>
<td>8</td>
</tr>
</tbody></table><br>
    , ,   -   ¬´<a href="http://msftdbprodsamples.codeplex.com/">Adventure Works</a>¬ª,   185 MiB  ,     761      .<br>
<table>
<tbody><tr>
<th>   </th>
<th><nobr></nobr></th>
<th><nobr>‚ÄÉ‚ÄÉ‚ÄÉ</nobr></th>
<th><nobr> % </nobr><br>
<nobr></nobr></th>
</tr>
<tr>
<td>     ‚Äì      (, )<br>
<i>    8     99.9% ‚Äì   ,  ,   ¬´¬ª    .  ,  75%     SqlDataReader,   25% ‚Äì   .</i></td>
<td>10 </td>
<td>2.2 </td>
<td>4.5</td>
</tr>
<tr>
<td>     ,    ‚Äì             (, ;  , MiB)</td>
<td>6 <br>
125 MiB</td>
<td>1.8 <br>
98 MiB</td>
<td>3.3<br>
-</td>
</tr>
<tr>
<td>  ,       (, ;  , MiB) <br>
<i>   ,      .             ,    .</i></td>
<td>12 <br>
36 MiB</td>
<td>2.2 <br>
24 MiB</td>
<td>5.4<br>
-</td>
</tr>
<tr>
<td>    T-SQL   ‚Äì   ,    (, ; , MiB)<br>
<i> 2   98 MiB    187 MiB   ‚Äì       SSD</i></td>
<td>21 <br>
245 MiB</td>
<td>2 <br>
187 MiB</td>
<td>10.5<br>
-</td>
</tr>
<tr>
<td> T-SQL     ,    (,   )<br>
<i>T-SQL   ,    SQL Server.  ,   SQL    SqlCommand   .</i></td>
<td>2 <br>
27 </td>
<td>1 <br>
26 </td>
<td>1.7</td>
</tr>
</tbody></table><br>
    ,  ,       ,       .  ,         ,              (   <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms644904(v%3Dvs.85).aspx">QueryPerformanceCounter</a>).        .<br>
 : ¬´    ?     ,  ?¬ª.   ,  ,  .      QA,         ,     ,     . ..      ,   .<br>
P.S.  ,      ,   ,       .<br>
<br>
<h4> </h4><br>
    ,        .     ,      ,           .NET.<br>
       .NET  ,   C++.    ,      C++  Assembler    1.5  2.5     C#.  ,       unmanaged DLL.      ,    C#     .<br>
          ,    .         ,       ,    -  .          ,      .NET,    ,      ,   .       ,     ,      .<br>
       ,        ,       ,  .   ,  ,       ,        ,       .<br>
<br>
<hr><br>
     ,   <b></b> :<br>
<ul>
<li>    C#</li>
<li>   </li>
<li>     </li>
<li>   ,   </li>
</ul><br>
     :<br>
<ul>
<li>      </li>
<li>         (  )</li>
<li>       (  ¬´¬ª,        )</li>
<li>     , ,    .</li>
<li>            </li>
</ul><br>
<hr><br>
<h4> </h4><br>
     ,           28 ( ),     ¬´¬ª.    <a href="http://msdn.microsoft.com/en-us/library/ms132151.aspx">IEqualityComparer</a>  HashSet     . ,    .    :   SQL Server      . , ¬´select¬ª  ¬´SELECT¬ª   ¬´Select¬ª.<br>
<b> GetHashCode.</b>    , .. HashSet    ,       Equals.          ¬´select¬ª  ¬´SELECT¬ª.  , String.GetHashCode    .      ‚Äî  String.ToUpperInvariant    . ,   ‚Äî   <a href="http://msdn.microsoft.com/en-us/library/system.stringcomparer.aspx">StringComparer</a>     OrdinalIgnoreCase.       GetHashCode   ,          .<br>
<b> Equals.</b>      .       .   IEqualityComparer    StringComparer.OrdinalIgnoreCase,     ¬´select¬ª  ¬´SELECT¬ª  .  ,   IEqualityComparer  HashSet   StringComparer.OrdinalIgnoreCase    .<br>
<b> ?</b><br>
1)          GetHashCode.     ‚Äî ,   : ()   -  ToUpperInvariant    ,  ()  -  <a href="http://msdn.microsoft.com/en-us/library/w129zz36.aspx">CompareInfo.GetSortKey</a>,     SortKey   ,      (?  <a href="http://www.unicode.org/reports/tr10/">Unicode Collation Algoritm</a>).<br>
2)         Equals.     -  ToUpperInvariant,      (    ¬´OrdinalIgnoreCase¬ª,  ¬´IgnoreCase¬ª     ,  ¬´Ordinal¬ª ‚Äî  ).<br>
<b>      ToUpperInvariant?</b><br>
‚Ä¢ ToUpperInvariant    ,     String  .<br>
‚Ä¢ ToUpperInvariant        ,    (2)     (  )   (1)     (    SortKey). .. 1   3-,  ToUpper (  Invariant)     (    <a href="http://www.unicode.org/versions/Unicode4.0.0/ch05.pdf">Case Mappings</a>).   ,          .<br>
‚Ä¢           (    ).<br>
<b>     ?</b><br>
‚Ä¢      ,        . ..    ¬´1¬ª,        ¬´¬ª,            (.  26 ‚Äî  ).<br>
‚Ä¢         ,     Case Mappings  Unicode.<br>
‚Ä¢       ToUpperCase ‚Äî    :  ToUpper,  GetHashCode.<br>
‚Ä¢    ,     .  Int32       .<br>
‚Ä¢          .<br>
‚Ä¢     (.  23 ‚Äî  ,  24 ‚Äî  )<br>
<b>   </b><br>
     :<br>
1) HashSet + ToUpperInvariant<br>
2) HashSet + StringComparer.OrdinalIgnoreCase   IEqualityComparer<br>
3)   ‚Äî ,      .<br>
<div class="spoiler"><b class="spoiler_title">program code</b><div class="spoiler_text"><pre><code>using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Runtime.InteropServices;

namespace ConsoleApplication1
{
    partial class Program
    {
        #region Keywords 1 - ToUpperInvariant

        static HashSet&lt;String&gt; keywords1;

        static void InitKeywords1()
        {
            keywords1 = new HashSet&lt;string&gt;();
            keywords1.Add("ABSOLUTE");
            keywords1.Add("ACTION");
            keywords1.Add("ADA");
            keywords1.Add("ADD");
            keywords1.Add("ADMIN");
            keywords1.Add("AFTER");
            keywords1.Add("AGGREGATE");
            keywords1.Add("ALIAS");
            keywords1.Add("ALL");
            keywords1.Add("ALLOCATE");
            keywords1.Add("ALTER");
            keywords1.Add("AND");
            keywords1.Add("ANY");
            keywords1.Add("ARE");
            keywords1.Add("ARRAY");
            keywords1.Add("AS");
            keywords1.Add("ASC");
            keywords1.Add("ASENSITIVE");
            keywords1.Add("ASSERTION");
            keywords1.Add("ASYMMETRIC");
            keywords1.Add("AT");
            keywords1.Add("ATOMIC");
            keywords1.Add("AUTHORIZATION");
            keywords1.Add("AVG");
            keywords1.Add("BACKUP");
            keywords1.Add("BEFORE");
            keywords1.Add("BEGIN");
            keywords1.Add("BETWEEN");
            keywords1.Add("BIGINT");
            keywords1.Add("BINARY");
            keywords1.Add("BIT");
            keywords1.Add("BIT_LENGTH");
            keywords1.Add("BLOB");
            keywords1.Add("BOOLEAN");
            keywords1.Add("BOTH");
            keywords1.Add("BREADTH");
            keywords1.Add("BREAK");
            keywords1.Add("BROWSE");
            keywords1.Add("BULK");
            keywords1.Add("BY");
            keywords1.Add("CALL");
            keywords1.Add("CALLED");
            keywords1.Add("CARDINALITY");
            keywords1.Add("CASCADE");
            keywords1.Add("CASCADED");
            keywords1.Add("CASE");
            keywords1.Add("CAST");
            keywords1.Add("CATALOG");
            keywords1.Add("CHAR");
            keywords1.Add("CHAR_LENGTH");
            keywords1.Add("CHARACTER");
            keywords1.Add("CHARACTER_LENGTH");
            keywords1.Add("CHECK");
            keywords1.Add("CHECKPOINT");
            keywords1.Add("CLASS");
            keywords1.Add("CLOB");
            keywords1.Add("CLOSE");
            keywords1.Add("CLUSTERED");
            keywords1.Add("COALESCE");
            keywords1.Add("COLLATE");
            keywords1.Add("COLLATION");
            keywords1.Add("COLLECT");
            keywords1.Add("COLUMN");
            keywords1.Add("COMMIT");
            keywords1.Add("COMPLETION");
            keywords1.Add("COMPUTE");
            keywords1.Add("CONDITION");
            keywords1.Add("CONNECT");
            keywords1.Add("CONNECTION");
            keywords1.Add("CONSTRAINT");
            keywords1.Add("CONSTRAINTS");
            keywords1.Add("CONSTRUCTOR");
            keywords1.Add("CONTAINS");
            keywords1.Add("CONTAINSTABLE");
            keywords1.Add("CONTINUE");
            keywords1.Add("CONVERT");
            keywords1.Add("CORR");
            keywords1.Add("CORRESPONDING");
            keywords1.Add("COUNT");
            keywords1.Add("COVAR_POP");
            keywords1.Add("COVAR_SAMP");
            keywords1.Add("CREATE");
            keywords1.Add("CROSS");
            keywords1.Add("CUBE");
            keywords1.Add("CUME_DIST");
            keywords1.Add("CURRENT");
            keywords1.Add("CURRENT_CATALOG");
            keywords1.Add("CURRENT_DATE");
            keywords1.Add("CURRENT_DEFAULT_TRANSFORM_GROUP");
            keywords1.Add("CURRENT_PATH");
            keywords1.Add("CURRENT_ROLE");
            keywords1.Add("CURRENT_SCHEMA");
            keywords1.Add("CURRENT_TIME");
            keywords1.Add("CURRENT_TIMESTAMP");
            keywords1.Add("CURRENT_TRANSFORM_GROUP_FOR_TYPE");
            keywords1.Add("CURRENT_USER");
            keywords1.Add("CURSOR");
            keywords1.Add("CYCLE");
            keywords1.Add("DATA");
            keywords1.Add("DATABASE");
            keywords1.Add("DATE");
            keywords1.Add("DATETIME");
            keywords1.Add("DATETIME2");
            keywords1.Add("DATETIMEOFFSET");
            keywords1.Add("DAY");
            keywords1.Add("DBCC");
            keywords1.Add("DEALLOCATE");
            keywords1.Add("DEC");
            keywords1.Add("DECIMAL");
            keywords1.Add("DECLARE");
            keywords1.Add("DEFAULT");
            keywords1.Add("DEFERRABLE");
            keywords1.Add("DEFERRED");
            keywords1.Add("DELETE");
            keywords1.Add("DENY");
            keywords1.Add("DEPTH");
            keywords1.Add("DEREF");
            keywords1.Add("DESC");
            keywords1.Add("DESCRIBE");
            keywords1.Add("DESCRIPTOR");
            keywords1.Add("DESTROY");
            keywords1.Add("DESTRUCTOR");
            keywords1.Add("DETERMINISTIC");
            keywords1.Add("DIAGNOSTICS");
            keywords1.Add("DICTIONARY");
            keywords1.Add("DISCONNECT");
            keywords1.Add("DISK");
            keywords1.Add("DISTINCT");
            keywords1.Add("DISTRIBUTED");
            keywords1.Add("DOMAIN");
            keywords1.Add("DOUBLE");
            keywords1.Add("DROP");
            keywords1.Add("DUMP");
            keywords1.Add("DYNAMIC");
            keywords1.Add("EACH");
            keywords1.Add("ELEMENT");
            keywords1.Add("ELSE");
            keywords1.Add("END");
            keywords1.Add("END-EXEC");
            keywords1.Add("EQUALS");
            keywords1.Add("ERRLVL");
            keywords1.Add("ESCAPE");
            keywords1.Add("EVERY");
            keywords1.Add("EXCEPT");
            keywords1.Add("EXCEPTION");
            keywords1.Add("EXEC");
            keywords1.Add("EXECUTE");
            keywords1.Add("EXISTS");
            keywords1.Add("EXIT");
            keywords1.Add("EXTERNAL");
            keywords1.Add("EXTRACT");
            keywords1.Add("FALSE");
            keywords1.Add("FETCH");
            keywords1.Add("FILE");
            keywords1.Add("FILLFACTOR");
            keywords1.Add("FILTER");
            keywords1.Add("FIRST");
            keywords1.Add("FLOAT");
            keywords1.Add("FOR");
            keywords1.Add("FOREIGN");
            keywords1.Add("FORTRAN");
            keywords1.Add("FOUND");
            keywords1.Add("FREE");
            keywords1.Add("FREETEXT");
            keywords1.Add("FREETEXTTABLE");
            keywords1.Add("FROM");
            keywords1.Add("FULL");
            keywords1.Add("FULLTEXTTABLE");
            keywords1.Add("FUNCTION");
            keywords1.Add("FUSION");
            keywords1.Add("GENERAL");
            keywords1.Add("GEOGRAPHY");
            keywords1.Add("GEOMETRY");
            keywords1.Add("GET");
            keywords1.Add("GLOBAL");
            keywords1.Add("GO");
            keywords1.Add("GOTO");
            keywords1.Add("GRANT");
            keywords1.Add("GROUP");
            keywords1.Add("GROUPING");
            keywords1.Add("HAVING");
            keywords1.Add("HIERACHYID");
            keywords1.Add("HOLD");
            keywords1.Add("HOLDLOCK");
            keywords1.Add("HOST");
            keywords1.Add("HOUR");
            keywords1.Add("IDENTITY");
            keywords1.Add("IDENTITY_INSERT");
            keywords1.Add("IDENTITYCOL");
            keywords1.Add("IF");
            keywords1.Add("IGNORE");
            keywords1.Add("IMAGE");
            keywords1.Add("IMMEDIATE");
            keywords1.Add("IN");
            keywords1.Add("INCLUDE");
            keywords1.Add("INDEX");
            keywords1.Add("INDICATOR");
            keywords1.Add("INITIALIZE");
            keywords1.Add("INITIALLY");
            keywords1.Add("INNER");
            keywords1.Add("INOUT");
            keywords1.Add("INPUT");
            keywords1.Add("INSENSITIVE");
            keywords1.Add("INSERT");
            keywords1.Add("INT");
            keywords1.Add("INTEGER");
            keywords1.Add("INTERSECT");
            keywords1.Add("INTERSECTION");
            keywords1.Add("INTERVAL");
            keywords1.Add("INTO");
            keywords1.Add("IS");
            keywords1.Add("ISOLATION");
            keywords1.Add("ITERATE");
            keywords1.Add("JOIN");
            keywords1.Add("KEY");
            keywords1.Add("KILL");
            keywords1.Add("LANGUAGE");
            keywords1.Add("LARGE");
            keywords1.Add("LAST");
            keywords1.Add("LATERAL");
            keywords1.Add("LEADING");
            keywords1.Add("LEFT");
            keywords1.Add("LESS");
            keywords1.Add("LEVEL");
            keywords1.Add("LIKE");
            keywords1.Add("LIKE_REGEX");
            keywords1.Add("LIMIT");
            keywords1.Add("LINENO");
            keywords1.Add("LN");
            keywords1.Add("LOAD");
            keywords1.Add("LOCAL");
            keywords1.Add("LOCALTIME");
            keywords1.Add("LOCALTIMESTAMP");
            keywords1.Add("LOCATOR");
            keywords1.Add("LOWER");
            keywords1.Add("MAP");
            keywords1.Add("MATCH");
            keywords1.Add("MAX");
            keywords1.Add("MEMBER");
            keywords1.Add("MERGE");
            keywords1.Add("METHOD");
            keywords1.Add("MIN");
            keywords1.Add("MINUTE");
            keywords1.Add("MOD");
            keywords1.Add("MODIFIES");
            keywords1.Add("MODIFY");
            keywords1.Add("MODULE");
            keywords1.Add("MONEY");
            keywords1.Add("MONTH");
            keywords1.Add("MULTISET");
            keywords1.Add("NAMES");
            keywords1.Add("NATIONAL");
            keywords1.Add("NATURAL");
            keywords1.Add("NCHAR");
            keywords1.Add("NCLOB");
            keywords1.Add("NEW");
            keywords1.Add("NEXT");
            keywords1.Add("NO");
            keywords1.Add("NOCHECK");
            keywords1.Add("NOCOUNT");
            keywords1.Add("NONCLUSTERED");
            keywords1.Add("NONE");
            keywords1.Add("NORMALIZE");
            keywords1.Add("NOT");
            keywords1.Add("NTEXT");
            keywords1.Add("NULL");
            keywords1.Add("NULLIF");
            keywords1.Add("NUMERIC");
            keywords1.Add("NVARCHAR");
            keywords1.Add("OBJECT");
            keywords1.Add("OCCURRENCES_REGEX");
            keywords1.Add("OCTET_LENGTH");
            keywords1.Add("OF");
            keywords1.Add("OFF");
            keywords1.Add("OFFSETS");
            keywords1.Add("OLD");
            keywords1.Add("ON");
            keywords1.Add("ONLY");
            keywords1.Add("OPEN");
            keywords1.Add("OPENDATASOURCE");
            keywords1.Add("OPENQUERY");
            keywords1.Add("OPENROWSET");
            keywords1.Add("OPENXML");
            keywords1.Add("OPERATION");
            keywords1.Add("OPTION");
            keywords1.Add("OR");
            keywords1.Add("ORDER");
            keywords1.Add("ORDINALITY");
            keywords1.Add("OUT");
            keywords1.Add("OUTER");
            keywords1.Add("OUTPUT");
            keywords1.Add("OVER");
            keywords1.Add("OVERLAPS");
            keywords1.Add("OVERLAY");
            keywords1.Add("PAD");
            keywords1.Add("PARAMETER");
            keywords1.Add("PARAMETERS");
            keywords1.Add("PARTIAL");
            keywords1.Add("PARTITION");
            keywords1.Add("PASCAL");
            keywords1.Add("PATH");
            keywords1.Add("PERCENT");
            keywords1.Add("PERCENT_RANK");
            keywords1.Add("PERCENTILE_CONT");
            keywords1.Add("PERCENTILE_DISC");
            keywords1.Add("PIVOT");
            keywords1.Add("PLAN");
            keywords1.Add("POSITION");
            keywords1.Add("POSITION_REGEX");
            keywords1.Add("POSTFIX");
            keywords1.Add("PRECISION");
            keywords1.Add("PREFIX");
            keywords1.Add("PREORDER");
            keywords1.Add("PREPARE");
            keywords1.Add("PRESERVE");
            keywords1.Add("PRIMARY");
            keywords1.Add("PRINT");
            keywords1.Add("PRIOR");
            keywords1.Add("PRIVILEGES");
            keywords1.Add("PROC");
            keywords1.Add("PROCEDURE");
            keywords1.Add("PUBLIC");
            keywords1.Add("RAISERROR");
            keywords1.Add("RANGE");
            keywords1.Add("READ");
            keywords1.Add("READS");
            keywords1.Add("READTEXT");
            keywords1.Add("REAL");
            keywords1.Add("RECONFIGURE");
            keywords1.Add("RECURSIVE");
            keywords1.Add("REF");
            keywords1.Add("REFERENCES");
            keywords1.Add("REFERENCING");
            keywords1.Add("REGR_AVGX");
            keywords1.Add("REGR_AVGY");
            keywords1.Add("REGR_COUNT");
            keywords1.Add("REGR_INTERCEPT");
            keywords1.Add("REGR_R2");
            keywords1.Add("REGR_SLOPE");
            keywords1.Add("REGR_SXX");
            keywords1.Add("REGR_SXY");
            keywords1.Add("REGR_SYY");
            keywords1.Add("RELATIVE");
            keywords1.Add("RELEASE");
            keywords1.Add("REPLICATION");
            keywords1.Add("RESTORE");
            keywords1.Add("RESTRICT");
            keywords1.Add("RESULT");
            keywords1.Add("RETURN");
            keywords1.Add("RETURNS");
            keywords1.Add("REVERT");
            keywords1.Add("REVOKE");
            keywords1.Add("RIGHT");
            keywords1.Add("ROLE");
            keywords1.Add("ROLLBACK");
            keywords1.Add("ROLLUP");
            keywords1.Add("ROUTINE");
            keywords1.Add("ROW");
            keywords1.Add("ROWCOUNT");
            keywords1.Add("ROWGUIDCOL");
            keywords1.Add("ROWS");
            keywords1.Add("ROWVERSION");
            keywords1.Add("RULE");
            keywords1.Add("SAVE");
            keywords1.Add("SAVEPOINT");
            keywords1.Add("SCHEMA");
            keywords1.Add("SCOPE");
            keywords1.Add("SCROLL");
            keywords1.Add("SEARCH");
            keywords1.Add("SECOND");
            keywords1.Add("SECTION");
            keywords1.Add("SECURITYAUDIT");
            keywords1.Add("SELECT");
            keywords1.Add("SENSITIVE");
            keywords1.Add("SEQUENCE");
            keywords1.Add("SESSION");
            keywords1.Add("SESSION_USER");
            keywords1.Add("SET");
            keywords1.Add("SETS");
            keywords1.Add("SETUSER");
            keywords1.Add("SHUTDOWN");
            keywords1.Add("SIMILAR");
            keywords1.Add("SIZE");
            keywords1.Add("SMALLDATETIME");
            keywords1.Add("SMALLINT");
            keywords1.Add("SMALLMONEY");
            keywords1.Add("SOME");
            keywords1.Add("SPACE");
            keywords1.Add("SPECIFIC");
            keywords1.Add("SPECIFICTYPE");
            keywords1.Add("SQL");
            keywords1.Add("SQL_VARIANT");
            keywords1.Add("SQLCA");
            keywords1.Add("SQLCODE");
            keywords1.Add("SQLERROR");
            keywords1.Add("SQLEXCEPTION");
            keywords1.Add("SQLSTATE");
            keywords1.Add("SQLWARNING");
            keywords1.Add("START");
            keywords1.Add("STATE");
            keywords1.Add("STATEMENT");
            keywords1.Add("STATIC");
            keywords1.Add("STATISTICS");
            keywords1.Add("STDDEV_POP");
            keywords1.Add("STDDEV_SAMP");
            keywords1.Add("STRUCTURE");
            keywords1.Add("SUBMULTISET");
            keywords1.Add("SUBSTRING");
            keywords1.Add("SUBSTRING_REGEX");
            keywords1.Add("SUM");
            keywords1.Add("SYMMETRIC");
            keywords1.Add("SYSNAME");
            keywords1.Add("SYSTEM");
            keywords1.Add("SYSTEM_USER");
            keywords1.Add("TABLE");
            keywords1.Add("TABLESAMPLE");
            keywords1.Add("TEMPORARY");
            keywords1.Add("TERMINATE");
            keywords1.Add("TEXT");
            keywords1.Add("TEXTSIZE");
            keywords1.Add("THAN");
            keywords1.Add("THEN");
            keywords1.Add("TIME");
            keywords1.Add("TIMESTAMP");
            keywords1.Add("TIMEZONE_HOUR");
            keywords1.Add("TIMEZONE_MINUTE");
            keywords1.Add("TINYINT");
            keywords1.Add("TO");
            keywords1.Add("TOP");
            keywords1.Add("TRAILING");
            keywords1.Add("TRAN");
            keywords1.Add("TRANSACTION");
            keywords1.Add("TRANSLATE");
            keywords1.Add("TRANSLATE_REGEX");
            keywords1.Add("TRANSLATION");
            keywords1.Add("TREAT");
            keywords1.Add("TRIGGER");
            keywords1.Add("TRIM");
            keywords1.Add("TRUE");
            keywords1.Add("TRUNCATE");
            keywords1.Add("TSEQUAL");
            keywords1.Add("UESCAPE");
            keywords1.Add("UNDER");
            keywords1.Add("UNION");
            keywords1.Add("UNIQUE");
            keywords1.Add("UNIQUEIDENTIFIER");
            keywords1.Add("UNKNOWN");
            keywords1.Add("UNNEST");
            keywords1.Add("UNPIVOT");
            keywords1.Add("UPDATE");
            keywords1.Add("UPDATETEXT");
            keywords1.Add("UPPER");
            keywords1.Add("USAGE");
            keywords1.Add("USE");
            keywords1.Add("USER");
            keywords1.Add("USING");
            keywords1.Add("VALUE");
            keywords1.Add("VALUES");
            keywords1.Add("VAR_POP");
            keywords1.Add("VAR_SAMP");
            keywords1.Add("VARBINARY");
            keywords1.Add("VARCHAR");
            keywords1.Add("VARIABLE");
            keywords1.Add("VARYING");
            keywords1.Add("VIEW");
            keywords1.Add("WAITFOR");
            keywords1.Add("WHEN");
            keywords1.Add("WHENEVER");
            keywords1.Add("WHERE");
            keywords1.Add("WHILE");
            keywords1.Add("WIDTH_BUCKET");
            keywords1.Add("WINDOW");
            keywords1.Add("WITH");
            keywords1.Add("WITHIN");
            keywords1.Add("WITHOUT");
            keywords1.Add("WORK");
            keywords1.Add("WRITE");
            keywords1.Add("WRITETEXT");
            keywords1.Add("XML");
            keywords1.Add("XMLAGG");
            keywords1.Add("XMLATTRIBUTES");
            keywords1.Add("XMLBINARY");
            keywords1.Add("XMLCAST");
            keywords1.Add("XMLCOMMENT");
            keywords1.Add("XMLCONCAT");
            keywords1.Add("XMLDOCUMENT");
            keywords1.Add("XMLELEMENT");
            keywords1.Add("XMLEXISTS");
            keywords1.Add("XMLFOREST");
            keywords1.Add("XMLITERATE");
            keywords1.Add("XMLNAMESPACES");
            keywords1.Add("XMLPARSE");
            keywords1.Add("XMLPI");
            keywords1.Add("XMLQUERY");
            keywords1.Add("XMLSERIALIZE");
            keywords1.Add("XMLTABLE");
            keywords1.Add("XMLTEXT");
            keywords1.Add("XMLVALIDATE");
            keywords1.Add("YEAR");
            keywords1.Add("ZONE");
        }

        static bool IsKeyword1(String tokenText)
        {
            return keywords1.Contains(tokenText.ToUpperInvariant());
        }

        #endregion

        #region Keywords 2 - StringComparer

        static HashSet&lt;String&gt; keywords2;

        static void InitKeywords2()
        {
            keywords2 = new HashSet&lt;string&gt;(keywords1, StringComparer.OrdinalIgnoreCase);
        }

        static bool IsKeyword2(String tokenText)
        {
            return keywords2.Contains(tokenText);
        }

        #endregion

        #region Keywords 3 - Good optimized

        static IntPtr gpCaseMapping;
        static IntPtr gpKeywords3;

        unsafe static void InitKeywords3()
        {
            gpKeywords3 = Marshal.AllocCoTaskMem(1293 * 4 * 4);
            int* pHashset3 = (int*)gpKeywords3;
            for (int i = 0; i &lt; 1293 * 4; i++)
                pHashset3[i] = 0;
            foreach (String keyword in keywords1)
            {
                fixed (char* pKeyword = keyword)
                {
                    int hashCode = keyword.GetHashCode();
                    int index = (int)(((uint)hashCode % 1293) &lt;&lt; 2);
                    if (pHashset3[index] != 0)
                        index += 2;
                    if (pHashset3[index] != 0)
                        throw new Exception("Solve the collision.");
                    pHashset3[index] = hashCode;
                    pHashset3[index + 1] = (int)pKeyword[0] | ((int)pKeyword[1] &lt;&lt; 8) | ((int)pKeyword[2] &lt;&lt; 16) | ((int)pKeyword[3] &lt;&lt; 24);
                }
            }

            gpCaseMapping = Marshal.AllocCoTaskMem(65536);
            byte* pCaseMapping = (byte*)gpCaseMapping;
            for (int i = 0; i &lt; 65536; i++)
                pCaseMapping[i] = 0;
            for (int i = 'A'; i &lt;= 'Z'; i++)
                pCaseMapping[i] = (byte)i;
            for (int i = 'a'; i &lt;= 'z'; i++)
                pCaseMapping[i] = (byte)(i ^ 0x20);
            pCaseMapping['2'] = (byte)'2';
            pCaseMapping['-'] = (byte)'-';
            pCaseMapping['_'] = (byte)'_';
        }

        unsafe static bool IsKeyword3(String tokenText)
        {
            unchecked
            {
                fixed (char* pString = tokenText)
                {
                    byte* pCaseMapping = (byte*)gpCaseMapping;

                    int num1 = 5381;
                    int num2 = num1;
                    int c1;
                    int c2;
                    char* ptr = pString;
                    int seq = 0;

                    if (tokenText.Length &gt;= 4)
                    {
                        c1 = (int)(*(ushort*)ptr);
                        c2 = (int)(*(ushort*)(ptr + 1));
                        c1 = pCaseMapping[c1];
                        c2 = pCaseMapping[c2];
                        if (c1 == 0 || c2 == 0)
                            return false;
                        seq = (c2 &lt;&lt; 8) | c1;
                        num1 = ((num1 &lt;&lt; 5) + num1 ^ c1);
                        num2 = ((num2 &lt;&lt; 5) + num2 ^ c2);
                        ptr += 2;

                        c1 = (int)(*(ushort*)ptr);
                        c2 = (int)(*(ushort*)(ptr + 1));
                        c1 = pCaseMapping[c1];
                        c2 = pCaseMapping[c2];
                        if (c1 == 0 || c2 == 0)
                            return false;
                        seq |= (c2 &lt;&lt; 24) | (c1 &lt;&lt; 16);
                        num1 = ((num1 &lt;&lt; 5) + num1 ^ c1);
                        num2 = ((num2 &lt;&lt; 5) + num2 ^ c2);
                        ptr += 2;

                        for (int loops = (tokenText.Length &gt;&gt; 1) - 2; loops &gt; 0; loops--, ptr += 2)
                        {
                            c1 = (int)(*(ushort*)ptr);
                            c2 = (int)(*(ushort*)(ptr + 1));
                            c1 = pCaseMapping[c1];
                            c2 = pCaseMapping[c2];
                            if (c1 == 0 || c2 == 0)
                                return false;
                            num1 = ((num1 &lt;&lt; 5) + num1 ^ c1);
                            num2 = ((num2 &lt;&lt; 5) + num2 ^ c2);
                        }

                        if ((tokenText.Length &amp; 1) != 0)
                        {
                            c1 = (int)(*(ushort*)ptr);
                            c1 = pCaseMapping[c1];
                            if (c1 == 0)
                                return false;
                            num1 = ((num1 &lt;&lt; 5) + num1 ^ c1);
                        }
                    }
                    else if (tokenText.Length == 3)
                    {
                        c1 = (int)(*(ushort*)ptr);
                        c2 = (int)(*(ushort*)(ptr + 1));
                        c1 = pCaseMapping[c1];
                        c2 = pCaseMapping[c2];
                        if (c1 == 0 || c2 == 0)
                            return false;
                        seq = (c2 &lt;&lt; 8) | c1;
                        num1 = ((num1 &lt;&lt; 5) + num1 ^ c1);
                        num2 = ((num2 &lt;&lt; 5) + num2 ^ c2);

                        c1 = (int)(*(ushort*)(ptr + 2));
                        c1 = pCaseMapping[c1];
                        if (c1 == 0)
                            return false;
                        seq |= (c1 &lt;&lt; 16);
                        num1 = ((num1 &lt;&lt; 5) + num1 ^ c1);
                    }
                    else if (tokenText.Length == 2)
                    {
                        c1 = (int)(*(ushort*)ptr);
                        c2 = (int)(*(ushort*)(ptr + 1));
                        c1 = pCaseMapping[c1];
                        c2 = pCaseMapping[c2];
                        if (c1 == 0 || c2 == 0)
                            return false;
                        seq = (c2 &lt;&lt; 8) | c1;
                        num1 = ((num1 &lt;&lt; 5) + num1 ^ c1);
                        num2 = ((num2 &lt;&lt; 5) + num2 ^ c2);
                        ptr += 2;
                    }
                    else
                    {
                        return false;
                    }

                    int hashCode = num1 + num2 * 1566083941;
                    int index = (int)(((uint)hashCode % 1293) &lt;&lt; 2);
                    int* pHashset3 = (int*)gpKeywords3;
                    return (pHashset3[index + 0] == hashCode &amp;&amp; pHashset3[index + 1] == seq)
                        || (pHashset3[index + 2] == hashCode &amp;&amp; pHashset3[index + 3] == seq);
                }
            }
        }

        #endregion

        #region Test Data

        static String[] TestTokens = new String[] {
"DECLARE", "@lang", "sysname",
"SELECT", "TOP", "@lang", "Alias", "FROM", "sys", "syslanguages", "WHERE", "lcid",
"IF", "@lang", "IS", "NOT", "NULL", "SET", "LANGUAGE", "@lang",
"SET", "ARITHABORT", "ANSI_PADDING", "ANSI_WARNINGS", "QUOTED_IDENTIFIER",
"NOCOUNT", "CONCAT_NULL_YIELDS_NULL", "ANSI_NULLS", "ON",
"SET", "NUMERIC_ROUNDABORT", "IMPLICIT_TRANSACTIONS", "XACT_ABORT", "OFF",
"SET", "DATEFORMAT", "dmy",
"USE", "AdventureWorks2008R2",
"GO",
"INSERT", "Sales", "SalesOrderHeader", "SalesOrderID", "RevisionNumber", "OrderDate", "DueDate", "ShipDate",
"Status", "OnlineOrderFlag", "PurchaseOrderNumber", "AccountNumber", "CustomerID", "SalesPersonID", "TerritoryID",
"BillToAddressID", "ShipToAddressID", "ShipMethodID", "CreditCardID", "CreditCardApprovalCode", "CurrencyRateID",
"SubTotal", "TaxAmt", "Freight", "Comment", "rowguid", "ModifiedDate", "VALUES",
"ALTER", "TABLE", "dbo", "DatabaseLog", "ADD", "CONSTRAINT", "PK_DatabaseLog_DatabaseLogID", "PRIMARY", "KEY", "NONCLUSTERED",
"DatabaseLogID", "ASC", "WITH", "DATA_COMPRESSION", "NONE",
"EXEC", "sp_addextendedproperty", "dbo", "DatabaseLog", "PK_DatabaseLog_DatabaseLogID",
"GO", "IF", "@@ERROR", "OR", "TRANCOUNT", "BEGIN", "IF", "@@TRANCOUNT", "ROLLBACK", "SET", "NOEXEC", "ON", "END",
"GO", "DBCC", "CHECKIDENT", "RESEED", "GO", "IF", "@@ERROR", "@@TRANCOUNT", "BEGIN", "IF", "@@TRANCOUNT", "ROLLBACK", "SET", "NOEXEC", "ON", "END", "GO"
            };

        #endregion

        #region Timing

        static long _timestamp;

        static void StartTiming()
        {
            _timestamp = Stopwatch.GetTimestamp();
        }

        static double EndTiming()
        {
            return (double)(Stopwatch.GetTimestamp() - _timestamp) / (double)Stopwatch.Frequency;
        }

        #endregion

        unsafe static void DoLexerTests()
        {
            int testCount = 100000;
            int matchCount = 0;
            double time;

            // Test 1
            InitKeywords1();
            StartTiming();
            for (int t = testCount; t &gt; 0; t--)
            {
                matchCount = 0;
                for (int i = 0; i &lt; TestTokens.Length; i++)
                {
                    String identifier = TestTokens[i];
                    if (IsKeyword1(identifier))
                        matchCount++;
                }
            }
            time = EndTiming();
            Console.WriteLine("Test 1 - ToUpper");
            Console.WriteLine("Time:    " + time);
            Console.WriteLine("Matches: " + matchCount);
            Console.WriteLine();

            // Test 2
            InitKeywords2();
            StartTiming();
            for (int t = testCount; t &gt; 0; t--)
            {
                matchCount = 0;
                for (int i = 0; i &lt; TestTokens.Length; i++)
                {
                    String identifier = TestTokens[i];
                    if (IsKeyword2(identifier))
                        matchCount++;
                }
            }
            time = EndTiming();
            Console.WriteLine("Test 2 - StringComparer");
            Console.WriteLine("Time:    " + time);
            Console.WriteLine("Matches: " + matchCount);
            Console.WriteLine();

            // Test 3
            InitKeywords3();
            StartTiming();
            for (int t = testCount; t &gt; 0; t--)
            {
                matchCount = 0;
                for (int i = 0; i &lt; TestTokens.Length; i++)
                {
                    String identifier = TestTokens[i];
                    if (IsKeyword3(identifier))
                        matchCount++;
                }
            }
            time = EndTiming();
            Console.WriteLine("Test 3 - Optimized Code");
            Console.WriteLine("Time:    " + time);
            Console.WriteLine("Matches: " + matchCount);
            Console.WriteLine();
        }
    }
}
</code></pre><br>
</div></div><br>
,        (  ):<br>
<table>
<tbody><tr>
<th> </th>
<th> </th>
</tr>
<tr>
<td>ToUpperInvariant</td>
<td>2330 </td>
</tr>
<tr>
<td>IEqualityComparer</td>
<td>661 </td>
</tr>
<tr>
<td> </td>
<td>239 </td>
</tr>
</tbody></table><br>
<b></b><br>
C ToUpperInvariant   ,     ‚Äî     ,        .              ,        .NET Framework ( Windows).<br>
       3  ,  StringComparer,     .   ,   StringComparer'   C++,   C#,      .       ,   ,      ,    400    .     :<br>
‚Ä¢  N3 ‚Äî .  ,       .   ‚Äî    400  ,        .     .     ‚Äî   10 .       10 ,       .<br>
‚Ä¢     ,    ,     .          .<br>
‚Ä¢   ,    .    ,     -,    .      ,    ,      .        ,     ¬´ ¬ª.         ,       ,    .         ,   IntelliSense.     ,   ,       ‚Ä¶<br>
‚Ä¢      ‚Äî          ?  ,           SQL Server,      .<br>
‚Ä¢   ,   :<br>
<blockquote>   ,      ,   </blockquote><br>
      ,          (  ¬´   ,   ¬ª).        ,          ‚Äî ¬´¬ª,                 ,     .</div><p>Source: <a href="https://habr.com/ru/post/165729/">https://habr.com/ru/post/165729/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165715/index.html">Implementation of morphological search on Kohana (phpMorphy library)</a></li>
<li><a href="../165719/index.html">Find an idea: the ideal object</a></li>
<li><a href="../165723/index.html">Advanced VIM Setup</a></li>
<li><a href="../165725/index.html">Like I had for the first time with Kiwi</a></li>
<li><a href="../165727/index.html">How and why we made our micro markup validator</a></li>
<li><a href="../165731/index.html">Daydream: Interactive screensaver for Android 4.2</a></li>
<li><a href="../165733/index.html">Video review of monoblock (tablet) Sony VAIO Tap 20</a></li>
<li><a href="../165735/index.html">Web Essentials extension for Visual Studio: LESS, Zen Coding, CoffeeScript, and more</a></li>
<li><a href="../165737/index.html">Zero Vulnerability in Cisco Linksys Routers</a></li>
<li><a href="../165739/index.html">Step-by-step firmware OpenWRT to TP-LINK TL-WR741ND router</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>