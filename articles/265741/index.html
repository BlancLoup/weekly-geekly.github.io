<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Habr shell: we build a cross-platform ssh server in java application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I'll tell you how to implement an ssh server into an existing java application that can output data about the best articles from habrahabr to the term...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Habr shell: we build a cross-platform ssh server in java application</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/2d8/2a6/325/2d82a63254ac4151868bd19709eb2d35.png"><br><br>  I'll tell you how to implement an ssh server into an existing java application that can output data about the best articles from habrahabr to the terminal.  This is just an example, but based on it, you can get an additional tool to administer your program and extend the behavior of any commands, without changing the source code and rebuilding the application. <br><a name="habracut"></a><br><br>  Screencast of work can be seen at the end of the article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We use <a href="http://www.crashub.org/">RaSH</a> as ssh server - this is one of the implementations of the command interpreter on java.  It allows you to create a server in the java process that executes commands via ssh / telnet protocols and includes a set of ready-made commands with the ability to write new ones on groovy.  Out of the box there are ready-made commands for working with JMX, access to the database, java streams, monitoring heap, changes in the logging level. <br><br>  Perhaps this project is familiar if you used Spring Boot, Mulesoft Enterprise Service Bus, Play Framework, Vert.x.  Now you can even embed it in corporate legacy on java! <br><br>  So, let's start with the implementation of the habr command.  The implementation is written in groovy.  For those who are familiar with java, writing a new implementation will not be difficult. <br><br>  Let's save our command for Habr in the sonarqube-5.1.2 / cmd / habrahabrShell.groovy file: <br><pre><code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.crsh.cli.Usage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.crsh.cli.Command <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.crsh.cli.Argument <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.crsh.cli.Required <span class="hljs-meta"><span class="hljs-meta">@Usage(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Example for habrahabr"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">habrahabrShell</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Usage(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Display best topics from habrahabr"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Command</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void displayBest() { def feedContent = <span class="hljs-string"><span class="hljs-string">"http://habrahabr.ru/rss/best/"</span></span>.toURL().text def rss = new XmlSlurper().parseText(feedContent) rss.channel.item.each{ <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$it</span></span></span><span class="hljs-string">.title [</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$it</span></span></span><span class="hljs-string">.link]\n"</span></span> } } <span class="hljs-meta"><span class="hljs-meta">@Usage(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Say hello"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Command</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void sayHello(<span class="hljs-meta"><span class="hljs-meta">@Required</span></span> <span class="hljs-meta"><span class="hljs-meta">@Argument</span></span> String message) { <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Hello habrahabr </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$message</span></span></span><span class="hljs-string">"</span></span> } }</code> </pre> <br><br>  Note that the command interpreter will use the command name based on the file name, not the class name.  @Usage annotations allow CRaSH to print help on the command and its parameters.  This command, which displays the Hello habrahabr console with your parameter, is not particularly useful and has a rather motivating effect and shows that writing commands is quite simple.  The displayBest command is more difficult to implement: we retrieve the contents of the rss feed using toURL (). Text, parse it with XmlSlurper (). ParseText () and output to the console a list of the best articles for the day and links to them, iterating over the elements of channel.item from the feed . <br><br>  Our experimental application for the implementation of CRaSH remains the SonarQube.  How to download it, configure it and stuff a aspectj with an agent in detail told and shown in the last <a href="http://habrahabr.ru/post/264415/">article</a> .  The configuration of -javaagent is left unchanged, and in org.aspectj.weaver.loadtime.configuration we specify the new script file config: file: /home/igor/dev/projects/sonar-demo/scripts/shell-console.xml <br><br>  Contents of the shell-console.xml file: <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">aspects</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>com.github.igorsuhorukov.rashubSsh<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>AFTER<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pointcut</span></span></span><span class="hljs-tag">&gt;</span></span>execution(* org.sonar.server.app.WebServer.start(..))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pointcut</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span>org.crashub:crash.connectors.ssh:1.3.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>Bootstrap<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.crsh.standalone.Bootstrap<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>Builder<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.crsh.vfs.FS$Builder<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>ClassPathMountFactory<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.crsh.vfs.spi.url.ClassPathMountFactory<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>FileMountFactory<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.crsh.vfs.spi.file.FileMountFactory<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">process</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> classLoader = Bootstrap.getClassLoader(); classpathDriver = new ClassPathMountFactory(classLoader); otherCmd = new FileMountFactory(new java.io.File(System.getProperty("user.dir"))); cmdFS = new Builder().register("classpath", classpathDriver).register("file", otherCmd).mount("classpath:/crash/commands/").mount("file:cmd/").build(); confFS = new Builder().register("classpath", classpathDriver).mount("classpath:/crash/").build(); bootstrap = new Bootstrap(classLoader, confFS, cmdFS); config = new java.util.Properties(); config.put("crash.ssh.port", "2000"); config.put("crash.ssh.auth_timeout", "300000"); config.put("crash.ssh.idle_timeout", "300000"); config.put("crash.auth", "simple"); config.put("crash.auth.simple.username", "admin"); config.put("crash.auth.simple.password", "admin"); bootstrap.setConfig(config); bootstrap.bootstrap(); //bootstrap.shutdown(); <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">process</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">aspects</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  This configuration allows the agent, after executing the start () method of the org.sonar.server.app.WebServer class, download from the maven repository the artifact org.crashub: crash.connectors.ssh: 1.3.1, configure the server and start it by calling bootstrap.bootstrap ()  Our server will find our command in the cmd directory, which we specified during initialization with mount (‚Äúfile: cmd /‚Äù).  Well, authentication will be using the username and password specified by us admin / admin, ssh server will listen to port 2000 - put ("crash.ssh.port", "2000") <br><br>  This is implemented on MVEL - java-like script using the <a href="https://github.com/igor-suhorukov/aspectj-scripting">AspectJ-scripting</a> agent and the appropriate configuration.  The agent is available in the central <a href="">maven repository.</a> <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/rb8f_i6LD_o%3Ffeature%3Doembed&amp;xid=17259,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhiRKdXRtxvcURIei_eqhCtW9Xa98g" frameborder="0" allowfullscreen=""></iframe><br><br>  On September 9, my open session on aspect-oriented programming will be held in Moscow.  Admission is free, after I publish report materials in Habr√©.  Register <a href="http://openevent9sept2015.questionpro.com/">openevent9sept2015.questionpro.com</a> <br><br>  All the magic of this article is implemented using <a href="http://habrahabr.ru/post/254791/">aspect-oriented programming</a> and consists only of 2 files: habrahabrShell.groovy and shell-console.xml and a parameter indicating the jvm agent.  Isn't it easy !? </div><p>Source: <a href="https://habr.com/ru/post/265741/">https://habr.com/ru/post/265741/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265729/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ174 (August 23 - 30, 2015)</a></li>
<li><a href="../265731/index.html">Sending push notifications to Go</a></li>
<li><a href="../265733/index.html">Life and graphs: a network approach to system modeling</a></li>
<li><a href="../265737/index.html">IBM will help Singapore to solve the problem of increasing sea traffic</a></li>
<li><a href="../265739/index.html">Flash to Html5 or secret api Swiffy</a></li>
<li><a href="../265743/index.html">Announcement of the fifth meeting of the Java User Group EKB</a></li>
<li><a href="../265745/index.html">RailsClub 2015: Interview with Claudio Bachchigalupo</a></li>
<li><a href="../265747/index.html">Why not everything is so simple with MongoDB</a></li>
<li><a href="../265749/index.html">Urho3D Editor (Part 1)</a></li>
<li><a href="../265751/index.html">Infobox VPS Review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>