<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We create microservice architecture together with Apache Kafka and .NET Core 2.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! Apache Kafka is a very fast distributed message broker, and today I will tell you how to ‚Äúprepare‚Äù it and implement a simple microservice ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We create microservice architecture together with Apache Kafka and .NET Core 2.0</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/24b/18c/76e/24b18c76e2394e2a90c5b53110cf78c2.jpg"></div><br>  Good day!  Apache Kafka is a very fast distributed message broker, and today I will tell you how to ‚Äúprepare‚Äù it and implement a simple microservice architecture from console applications using it.  So, anyone who wants to get acquainted with Apache Kafka and try it out in business, welcome under the cat. <a name="habracut"></a><br><br><h2>  Overview </h2><br><h3>  Introduction </h3><br>  This material does not in any way pretend to a thorough description of Apache Kafka, nor to the subtle questions of building a microservice architecture.  The only thing you need to know is how to build applications on the .NET platform.  We will use .Net Core 2.0 <br><br>  So what do we eventually create?  An application that tells you what to call your child.  For simplicity, it will give random male and female names from a pre-compiled list.  The system will consist of two console applications and one library. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The idea is to build not a ‚Äúmonolithic‚Äù, but a distributed application.  Thereby, we will provide ourselves with the groundwork for future scaling and many other advantages described, for example, <a href="https://habrahabr.ru/company/mailru/blog/320962/">here.</a> <br><br>  Here is the structure of our system: <br><br><img src="https://habrastorage.org/web/d8a/20e/b59/d8a20eb592d649a9ab0861d69596e514.png" width="400" align="left">  The 3 blue ‚Äúrectangles‚Äù on the sides are console applications.  In fact, those two below are microservices, and MainApp is a user application, through which we will request names.  NameService will be a universal service that can generate either male or female names. <br>  The orange ‚Äúrectangle‚Äù in the middle is the message broker Apache Kafka.  A message broker is what binds all parts of our system together.  In our case, we will use Apache Kafka, but with the same success could use RabbitMQ, ActiveMQ, or some other. <br><br>  And this is how MainApp interacts with Apache Kafka: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/7c9/9d7/ee3/7c99d7ee3b1e450fbae80c72165e1693.png" width="600"></div><br>  It works according to the following scheme: <br><br><ol><li>  The user requests some data (in our case, a male or female name). </li><li>  MainApp sends a message (in the diagram this is ‚ÄúCommands‚Äù) to Apache Kafka, which is automatically received by all the services we need. </li><li>  These services respond by sending another message (data in the diagram) to Apache Kafka.  MainApp receives this message from Apache Kafka (this is ‚ÄúData‚Äù in the diagram), which contains the information we need, and provides it to the user. </li></ol><br>  Each service interacts with Apache Kafka in a similar ‚Äútwo-way‚Äù scheme. <br><br>  Notice that MainApp knows nothing about NameService, and vice versa.  All interaction takes place through Apache Kafka.  But both MainApp and NameService must use the same ‚Äúcommunication channels‚Äù.  In practice, this means that, for example, the name of the topic, to which MainApp sends messages, must completely coincide with the name of the topic, from which it "listens" to NameService messages. <br><br>  As you can see, the work of Apache Kafka in our example is to transfer messages between different elements of the system.  It is this, exceptionally fast and reliable, that she does.  Of course, she has other opportunities, you can read about them on the official website <a href="https://kafka.apache.org/uses">here.</a> <br><br><h3>  What is Apache Kafka </h3><br>  Apache Kafka is a distributed message broker.  In essence, this is a system that can transmit your messages very quickly and efficiently.  Any type of data can be used as messages, since for Kafka it is just a sequence of bytes.  Apache Kafka can work both on one machine and on several machines, which together form a cluster and increase the efficiency of the entire system.  In our case, we will run Apache Kafka locally, and use the Confluent library to interact with it. <br><br>  It is important to understand how Apache Kafka works.  We can write messages to it, and we can read from it.  All messages in Kafka belong to one topic or another (topic).  A topic is like a title, and it must be defined for each message that we want to convey in Apache Kafka.  Similarly, if we are going to read messages from Kafka, we must indicate with which topic these messages will be. <br><br>  The topic is divided into sections, and we indicate their number, as a rule, on our own.  The number of sections in the topic is of great importance for performance, you can read about it <a href="https://www.confluent.io/blog/how-to-choose-the-number-of-topicspartitions-in-a-kafka-cluster/">here</a> <br><br><h2>  Practical part </h2><br><h3>  Download and run Apache Kafka 0.11 </h3><br>  At the moment, the latest version is version 0.11.  Download the archive from the official site (https://kafka.apache.org/downloads) and unpack it into any folder.  Next from the console you need to run 2 files (zookeeper-server.start and kafka-server-start) as follows. <br><br>  We open the first console (if we unpacked to the C drive, we open it on behalf of the Administrator, just in case), go to where we unpacked our archive from Kafka, and enter the command: <br>  bin \ windows \ zookeeper-server-start.bat config \ zookeeper.properties <br><br>  After that, if everything is good and this process did not stop shortly after the start, open the second console in the same way, and start the Apache Kafka itself <br>  bin \ windows \ kafka-server-start.bat config \ server.properties <br><br>  We have just launched Zookeeper and Apache Kafka with the default settings specified in zookeeper.properties and server.properties respectively.  Zookeeper is a necessary element, without it Apache Kafka does not work. <br><br>  Complete information on the launch and configuration of Kafka can be viewed on the <a href="https://kafka.apache.org/">official website.</a> <br><br><h3>  Begin to code </h3><br>  So, Kafka is running, now let's create our ‚Äúdistributed‚Äú application.  It will consist of 2 console applications and one library.  As a result, we will get a solution from 3 projects, which will look like this: <br><div style="text-align:center;"><img src="https://habrastorage.org/web/d4c/d5c/105/d4cd5c1059cf462cb6427657f220df9a.png"></div><br><br>  Our library is a ‚Äúwrapper‚Äù around the Confluent.Kafka library, we need it to interact with Apache Kafka.  In addition, it will be used by each of our console applications. <br><br>  The library is designed for the target .NET Core 2.0 platform (Although, it could have been created with the same success for the .NET Standard platform). Its code is presented below.  Please note that it is necessary to download the nuget package Confluent.Kafka. <br><br><div class="spoiler">  <b class="spoiler_title">MessageBus.cs</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Confluent.Kafka; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Confluent.Kafka.Serialization; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MessageBroker.Kafka.Lib</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageBus</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Producer&lt;Null, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; _producer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Consumer&lt;Null, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; _consumer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; _producerConfig; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; _consumerConfig; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MessageBus</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">this</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"localhost"</span></span></span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MessageBus</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> host</span></span></span><span class="hljs-function">)</span></span> { _producerConfig = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; { { <span class="hljs-string"><span class="hljs-string">"bootstrap.servers"</span></span>, host } }; _consumerConfig = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; { { <span class="hljs-string"><span class="hljs-string">"group.id"</span></span>, <span class="hljs-string"><span class="hljs-string">"custom-group"</span></span>}, { <span class="hljs-string"><span class="hljs-string">"bootstrap.servers"</span></span>, host } }; _producer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Producer&lt;Null, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(_producerConfig, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringSerializer(Encoding.UTF8)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> topic, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { _producer.ProduceAsync(topic, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, message); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SubscribeOnTopic&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> topic, Action&lt;T&gt; action, CancellationToken cancellationToken) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T: <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msgBus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageBus(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (msgBus._consumer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Consumer&lt;Null, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(_consumerConfig, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringDeserializer(Encoding.UTF8))) { msgBus._consumer.Assign(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TopicPartitionOffset&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TopicPartitionOffset(topic, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>) }); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cancellationToken.IsCancellationRequested) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; Message&lt;Null, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; msg; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msgBus._consumer.Consume(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> msg, TimeSpan.FromMilliseconds(<span class="hljs-number"><span class="hljs-number">10</span></span>))) { action(msg.Value <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> T); } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _producer?.Dispose(); _consumer?.Dispose(); } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Some explanations to the library code</b> <div class="spoiler_text">  The wrapper is created in order to simplify the entire interaction with Apache Kafka and concentrate on the moments in the interaction of the system elements with each other.  There are two methods in the library: SendMessage () and SubscribeOnTopic, as part of the tutorial, there is no need anymore.  Back in SubscribeOnTopic, we subscribe to a topic and continuously ‚Äúlisten‚Äù to messages, so in order to subscribe to several topics, it is better to run them in separate threads, which we will do next when using this library using Task.Run () constructs. <br></div></div><br>  Next, we will build the ‚Äúmain‚Äù application MainApp, and then our ‚Äúmicroservice‚Äù NameService, which we will launch later in duplicate.  Each of them will be responsible for the generation of either male or female names. <br><br>  The code for a simple console application, MainApp, for the target .NET Core 2.0 platform is shown below.  Please note that it is necessary to add a link to the library that we have just built and which is in the MessageBroker.Kafka.Lib namespace. <br><br><div class="spoiler">  <b class="spoiler_title">MainApp.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> MessageBroker.Kafka.Lib; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MainApp</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> bTopicNameCmd= <span class="hljs-string"><span class="hljs-string">"b_name_command"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> gTopicNameCmd = <span class="hljs-string"><span class="hljs-string">"g_name_command"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> bMessageReq = <span class="hljs-string"><span class="hljs-string">"get_boy_name"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> gMessageReq= <span class="hljs-string"><span class="hljs-string">"get_girl_name"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> bTopicNameResp = <span class="hljs-string"><span class="hljs-string">"b_name_response"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> gTopicNameResp= <span class="hljs-string"><span class="hljs-string">"g_name_response"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> userHelpMsg = <span class="hljs-string"><span class="hljs-string">"MainApp: Enter 'b' for a boy or 'g' for a girl, 'q' to exit"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msgBus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageBus()) { Task.Run(() =&gt; msgBus.SubscribeOnTopic&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(bTopicNameResp, msg =&gt; GetBoyNameHandler(msg), CancellationToken.None)); Task.Run(() =&gt; msgBus.SubscribeOnTopic&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(gTopicNameResp, msg =&gt; GetGirlNameHandler(msg), CancellationToken.None)); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> userInput; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { Console.WriteLine(userHelpMsg); userInput = Console.ReadLine(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (userInput) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"b"</span></span>: msgBus.SendMessage(topic: bTopicNameCmd, message: bMessageReq); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"g"</span></span>: msgBus.SendMessage(topic: gTopicNameCmd, message: gMessageReq); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"q"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Unknown command. </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{userHelpMsg}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (userInput != <span class="hljs-string"><span class="hljs-string">"q"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBoyNameHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msg</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Boy name </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{msg}</span></span></span><span class="hljs-string"> is recommended"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGirlNameHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msg</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Girl name </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{msg}</span></span></span><span class="hljs-string"> is recommended"</span></span>); } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">A bit of explanation to the MainApp code</b> <div class="spoiler_text">  Have you seen many string readonly variables at the beginning?  These are the names of all the topics and messages that we will send to them.  In other words, the title and text messages.  All the services with which our MainApp will interact should know about them, because the names of the topics must match.  For example, bTopicNameCmd is the name of the topic for the service team that we need to get a male name (gTopicNameCmd is the same).  The service must be subscribed to the eponymous topic in order to receive messages from it and then do something. <br><br>  Likewise, our MainApp is subscribed to topics to which our NameService services transmit useful information.  For example, the variable bTopicNameResp is the name of the topic, which is provided for ready-made male names that NameService generated.  The service sends the name to this topic, and MainApp receives them from there. <br></div></div><br>  The following is the code of the microservice NameService.  Please note, here, too, you need to add a link to the library we have already created in the namespace MessageBroker.Kafka.Lib <br><br><div class="spoiler">  <b class="spoiler_title">NameService.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> MessageBroker.Kafka.Lib; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">NameService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MessageBus msgBus; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> userHelpMsg = <span class="hljs-string"><span class="hljs-string">"NameService.\nEnter 'b' or 'g' to process boy or girl names respectively"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> bTopicNameCmd = <span class="hljs-string"><span class="hljs-string">"b_name_command"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> gTopicNameCmd = <span class="hljs-string"><span class="hljs-string">"g_name_command"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> bTopicNameResp = <span class="hljs-string"><span class="hljs-string">"b_name_response"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> gTopicNameResp = <span class="hljs-string"><span class="hljs-string">"g_name_response"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] _boyNames = { <span class="hljs-string"><span class="hljs-string">"Arsenii"</span></span>, <span class="hljs-string"><span class="hljs-string">"Igor"</span></span>, <span class="hljs-string"><span class="hljs-string">"Kostya"</span></span>, <span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"Dmitrii"</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] _girlNames = { <span class="hljs-string"><span class="hljs-string">"Nastya"</span></span>, <span class="hljs-string"><span class="hljs-string">"Lena"</span></span>, <span class="hljs-string"><span class="hljs-string">"Ksusha"</span></span>, <span class="hljs-string"><span class="hljs-string">"Katya"</span></span>, <span class="hljs-string"><span class="hljs-string">"Olga"</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> canceled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; Console.CancelKeyPress += (_, e) =&gt; { e.Cancel = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; canceled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (msgBus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageBus()) { Console.WriteLine(userHelpMsg); HandleUserInput(Console.ReadLine()); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!canceled) { } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleUserInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userInput</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (userInput) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"b"</span></span>: Task.Run(() =&gt; msgBus.SubscribeOnTopic&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(bTopicNameCmd, (msg) =&gt; BoyNameCommandListener(msg), CancellationToken.None)); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Processing boy names"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"g"</span></span>: Task gTask = Task.Run(() =&gt; msgBus.SubscribeOnTopic&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(gTopicNameCmd, (msg) =&gt; GirlNameCommandListener(msg), CancellationToken.None)); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Processing girl names"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Unknown command. </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{userHelpMsg}</span></span></span><span class="hljs-string">"</span></span>); HandleUserInput(Console.ReadLine()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BoyNameCommandListener</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random().Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> randName = _boyNames[r]; msgBus.SendMessage(bTopicNameResp, randName); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Sending </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{randName}</span></span></span><span class="hljs-string">"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GirlNameCommandListener</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random().Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> randName = _girlNames[r]; msgBus.SendMessage(gTopicNameResp, randName); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Sending </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{randName}</span></span></span><span class="hljs-string">"</span></span>); } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">A few explanations to the code NameService</b> <div class="spoiler_text">  The service works as follows: <br><br><ol><li>  First we decide whether the service will generate the male or female names (i.e., just choose a random name from the prepared list, in our case) </li><li>  Subscribe to the appropriate topic </li></ol><br>  In the body of the event handler method, we send a message with a prepared name to the topic to which MainApp is already subscribed.  And this event occurs every time MainApp sends a message stating that you need to get some name. <br></div></div><br><h3>  Run </h3><br>  At this stage, you, in theory, should already have a ready-made solution with all the necessary code.  Then you can proceed as follows: configure the solution so that 2 applications start at once (MainApp and NameService), and start them ( <b>Just check that you already have Apache Kafka running</b> ).  In NameService, enter 'b', or 'g', to configure the service to generate male or female names, after which, in the same way, enter 'b' or 'g' into MainApp, but to get these names.  Then in MainApp you should get some name. <br><br>  At this stage, we get the names of only one gender.  Suppose only male.  Now we want to get the names of the female.  Go to the folder where our NameService project is going, and start another service in the console using the " <b>dotnet NameService.dll</b> " <b>command</b> . <br>  We enter the 'g' command in it, and now, when we query the female name in MainApp, we get it. <br><br>  By the way, this way you can run as many NameService entities as you like, and this is one of the advantages of the microservice architecture.  For example, if one of the services ‚Äúfalls‚Äù, the whole system will not collapse, because  we have other services that do the exact same job. <br><br>  One thing: if we, for example, run 5 NameService items, then 5 names will come to MainApp, not just one.  This is due to the Apache Kafka settings that are specified in the server.properties file.  As part of the tutorial, I deliberately do not touch this, so as not to complicate the material. <br><br><h2>  Conclusion </h2><br>  In this article, I wanted to describe the principle of building a microservice architecture as simply and easily as possible and introduce the reader to the distributed message broker Apache Kafka using a live example.  I hope it worked out, and thanks for your attention :) <br><br><h3>  Links to materials used in the article </h3><br><ol><li>  <a href="https://kafka.apache.org/uses">Apache Kafka official website</a> </li><li>  <a href="https://www.confluent.io/blog/how-to-choose-the-number-of-topicspartitions-in-a-kafka-cluster/">About sections in Apache Kafka from Confluent</a> </li><li>  <a href="https://habrahabr.ru/post/249183/">Translation of Martin Fowler's article on microservices</a> </li><li>  <a href="https://blog.cloudera.com/blog/2014/09/apache-kafka-for-beginners/">Apache Kafka for beginners</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/320962/">Translation of an article from Mail.ru about microservices</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/336058/">https://habr.com/ru/post/336058/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336044/index.html">Installing and using GNU / Linux instead of Chrome OS on Toshiba Chromebook 2</a></li>
<li><a href="../336048/index.html">Omnicanality: 7 tips marketer</a></li>
<li><a href="../336052/index.html">Centralized VLAN configuration for 3CX IP phones</a></li>
<li><a href="../336054/index.html">Developing a theme manager in a UWP application</a></li>
<li><a href="../336056/index.html">35 answers to questions about online ticketing for online stores and services</a></li>
<li><a href="../336060/index.html">10 working methods in the terminal Linux, which very few people know</a></li>
<li><a href="../336062/index.html">Use PowerShell for IT security. Part II: File Access Analysis</a></li>
<li><a href="../336064/index.html">Conquering China: how to bring the application to the Chinese market</a></li>
<li><a href="../336066/index.html">Python-selvpcclient library</a></li>
<li><a href="../336068/index.html">5 fresh examples of parsing and improving the design in simple ways</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>