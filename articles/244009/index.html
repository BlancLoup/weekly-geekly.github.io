<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I tortured Selenium tests for GAE Django and what came to the end</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 Once on a project written in GAE Django, it was necessary to implement testing using Selenium. Unfortunately, it was not possible to find...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I tortured Selenium tests for GAE Django and what came to the end</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  Once on a project written in GAE Django, it was necessary to implement testing using Selenium.  Unfortunately, it was not possible to find a ready tool for this.  Searches across the expanses of the Internet have not yielded positive results. <br><a name="habracut"></a><br><h4>  Wrong turn </h4><br>  The first thing that came to mind was to run the server in setUp using <pre><code class="python hljs">subprocess.Popen</code> </pre>  and complete it in the teardown method <pre> <code class="python hljs">self.server_process.terminate()</code> </pre><br>  At first glance - a working solution.  The first question that arose: <br>  <i>How to make a running server instance and testbed use the same database and services?</i> <br><br>  When starting the server, we indicate which database to use: <br><br><pre> <code class="bash hljs">--use_sqlite --datastore_path=/full/path/to/sqlite_db</code> </pre><br>  We say testbed with which app_id and from which database the test server is launched: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="python hljs">self.testbed.setup_env(app_id=<span class="hljs-string"><span class="hljs-string">'some-app-id'</span></span>) self.testbed.init_datastore_v3_stub(use_sqlite=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, datastore_file=<span class="hljs-string"><span class="hljs-string">'/full/path/to/sqlite_db'</span></span>)</code> </pre><br>  It seems to be ready, but there is a problem due, so to speak, to the conflicts of the testbed and our server.  The server starts the services it needs, and testbed does the same.  In general, "who is the last one and daddy."  Could not get a normal working base.  As a result, after the selection of the initialization procedure, I succeeded and the first test was successful.  It seemed that victory was close, but the thought did not stop me: the further I move with these tests, the deeper I sink into the abyss of "dirty" decisions. <br><br><h4>  It is necessary to clean the base </h4><br>  In the teardown () method, testbed.deactivate () and test_server.terminate () were called. <br>  The base was not cleared.  Adding --clear_datastore to the server startup command broke everything during initialization.  Deleting all data from the database and manually clearing the cache also caused conflicts. <br><br><pre> <code class="python hljs">db.delete(db.Query()) memcache.flush_all()</code> </pre><br>  I had to add the removal of the os.remove database file, but this did not solve all the problems. <br><br>  With each solution to one problem, another arose.  Hands down, it was getting worse, from what I write.  Went to sleep. <br><br><h4>  All ingenious is simple </h4><br>  Not so simple, but simpler than the one described above.  Thanks to my colleague who suggested the idea of ‚Äã‚Äãusing <a href="https://docs.djangoproject.com/en/1.4/topics/testing/">LiveServerTestCase</a> .  It was a salvation. <br><br>  The base class, which activates the testbed and deactivates it at the end of the entire test case: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GAELiveServerTestCase</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(LiveServerTestCase)</span></span></span><span class="hljs-class">:</span></span> @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUpClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> cls.testbed = testbed.Testbed() cls.testbed.activate() cls.testbed.init_datastore_v3_stub() cls.testbed.init_memcache_stub() cls.testbed.init_channel_stub() cls.testbed.init_urlfetch_stub() cls.testbed.init_user_stub() super(GAELiveServerTestCase, cls).setUpClass() @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tearDownClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> cls.testbed.deactivate() super(GAELiveServerTestCase, cls).tearDownClass()</code> </pre><br><br>  Actually class selenium tests. <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SeleniumTestCase</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(GAELiveServerTestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.driver = webdriver.Chrome() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tearDown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.driver.close() self.driver.quit() db.delete(db.Query()) memcache.flush_all()</code> </pre><br><br>  And one important point. <br><br>  <a href="https://docs.djangoproject.com/en/1.4/topics/testing/">LiveServerTestCase</a> does not run _ah GAE instances.  Channels were needed.  Having looked in one project and having dug gae-shnyy sorts, an additional view was drawn, one can say with copied logic from gae for jsapi and connect, disconnect, poll signals: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.appengine.tools.devappserver2.channel <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _JSAPI_PATH <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">channel_stub_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, page)</span></span></span><span class="hljs-function">:</span></span> params = request.REQUEST <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> page == <span class="hljs-string"><span class="hljs-string">'jsapi'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse(content=open(_JSAPI_PATH).read(), content_type=<span class="hljs-string"><span class="hljs-string">'text/javascript'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> page == <span class="hljs-string"><span class="hljs-string">'dev'</span></span>: command = params.get(<span class="hljs-string"><span class="hljs-string">'command'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) token = params.get(<span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> command <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> token <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse(status=<span class="hljs-number"><span class="hljs-number">400</span></span>) stub = apiproxy_stub_map.apiproxy.GetStub(<span class="hljs-string"><span class="hljs-string">'channel'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: stub.connect_channel(token) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> (channel_service_stub.InvalidTokenError, channel_service_stub.TokenTimedOutError): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse(status=<span class="hljs-number"><span class="hljs-number">401</span></span>) client_id = stub.validate_token_and_extract_client_id(token) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> command == <span class="hljs-string"><span class="hljs-string">'connect'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse(content=<span class="hljs-string"><span class="hljs-string">'1'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> command == <span class="hljs-string"><span class="hljs-string">'poll'</span></span>: message = stub.pop_first_message(token) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> message <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse(content=message, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse()</code> </pre><br><br>  Made available only during tests: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> settings.TESTING: urlpatterns += patterns(<span class="hljs-string"><span class="hljs-string">''</span></span>, url(<span class="hljs-string"><span class="hljs-string">r'^_ah/channel/(?P&lt;page&gt;.*)$'</span></span>, <span class="hljs-string"><span class="hljs-string">'channel_stub_view'</span></span>), )</code> </pre><br><br>  There was one problem when the disconnect should occur (for example, the page was closed), the testbed did not understand this.  I solved the problem by initializing channel_stub every time I open the page: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SeleniumTestCase</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(GAELiveServerTestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.driver = webdriver.Chrome() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tearDown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.driver.quit() db.delete(db.Query()) memcache.flush_all() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">open_url</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url)</span></span></span><span class="hljs-function">:</span></span> self.get(urljoin(self.live_server_url, url)) self.testbed.init_channel_stub()</code> </pre><br><br>  PS Wrote a post in the hope that this decision will help someone, and he will not spend a lot of time and nerves on such a task. </div><p>Source: <a href="https://habr.com/ru/post/244009/">https://habr.com/ru/post/244009/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243997/index.html">Access to thousands of personal data of users of Beeline Wired Internet was obtained</a></li>
<li><a href="../243999/index.html">CTOcast # 3: Conversation with Sergey Chernyshev</a></li>
<li><a href="../244001/index.html">AngularJs $ parse hacks</a></li>
<li><a href="../244003/index.html">Information Project Management Methodologies</a></li>
<li><a href="../244007/index.html">Polyphasic sleep: reviews, "theory", personal experience</a></li>
<li><a href="../244011/index.html">How to increase the speed of communication and productivity: The introduction of Vim ideology in the messenger</a></li>
<li><a href="../244013/index.html">HungryBread - a startup about a lunch in a pleasant company</a></li>
<li><a href="../244015/index.html">Configuring Beans with Annotations: Solving the Inheritance Problem for Annotation Interfaces</a></li>
<li><a href="../244017/index.html">Pseudo-practical example of closures and decorators</a></li>
<li><a href="../244023/index.html">CryptSync and GnuPG - customization options and inability to use</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>