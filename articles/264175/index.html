<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Real-time stateful React components update for Browserify</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! 
 Let's talk a little about the DX (Developer Experience) or ‚ÄúExperience Development‚Äù, and more specifically, about updating the code...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Real-time stateful React components update for Browserify</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c87/23f/844/c8723f8440c4442a8738891cde859f37.jpg"><br><br>  Good day to all! <br>  Let's talk a little about the DX (Developer Experience) or ‚ÄúExperience Development‚Äù, and more specifically, about updating the code in real time while maintaining the state of the system.  If the topic is new to you, I advise you to read the following videos before reading: <br><br><div class="spoiler">  <b class="spoiler_title">A number of videos with the update code in real time without reloading the page</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/zHPtvw8c3Lc%3Ffeature%3Doembed&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjvybbWscBrhDi7qbP_ty60RICtYA" frameborder="0" allowfullscreen=""></iframe><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/100010922&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhj8LQ-7TMt-P9K5fLwQyX7KzFnsPg" width="548" height="315" frameborder="0" title="Live-editing React app without refresh" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/123513496&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhguM-30foYN5Wq61GqSTrY0iayYgQ" width="560" height="315" frameborder="0" title="Develop your web applications in real-time with Browserify + React + LiveReactload" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br></div></div><br><h2>  Introduction: How does it work? </h2><br>  First of all, it should be understood that the implementation of such functionality implies the solution of a number of tasks: <br>  - Tracking file changes <br>  - Patch calculation based on file changes <br>  - Transporting the patch to the client (in the browser, for example) <br>  - Processing and applying the patch to the existing code <br>  But first things first. <br><a name="habracut"></a><br><h2>  File change tracking </h2><br>  In my experience I tried four different implementations: <br>  - <a href="https://github.com/atom/node-pathwatcher">Solution from github</a> <br>  - Native <a href="https://nodejs.org/docs/latest/api/fs.html">fs.watch</a> <br>  - <a href="https://github.com/paulmillr/chokidar">Chokidar</a> <br>  - <a href="https://github.com/shama/gaze">gaze</a> <br>  One can argue about the advantages of one application over another, but for me personally I chose chokidar - quickly, conveniently, works well on OS X (thanks, <a href="https://habrahabr.ru/users/paulmillr/" class="user_link">paulmillr</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our task at this step is to track changes to bundle files and respond to changes in them.  However, there is one catch: browserify opens the bundle file in stream recording mode, which means that the <code>"change"</code> event can occur several times before the end of the recording (unfortunately, there is no such event).  Therefore, in order to avoid potentially problematic situations with an invalid patch, we have to include <a href="">an additional check of the validity of the code</a> (trite check for data in the file and syntax errors).  This part seems to be clear.  Well, move on? <br><br><h2>  Patch calculation based on file changes </h2><br>  We track changes only bundle files.  As soon as one of these files changes, we must calculate the patch for the old version of the file and transfer it to the client.  At the moment, livereactload is actively used for browserify when working with react-code in real-time mode, which, in my opinion, solves this problem with a wild overhead projector: every time you receive <b>a whole</b> bundle.  As for me, it is too much.  And what if my source maps bundle weighs 10MB?  Is it good to add such traffic when adding a comma?  Well, I do not‚Ä¶ <br><br>  Since browserify does not provide for the possibility of <a href="https://github.com/webpack/docs/wiki/hot-module-replacement-with-webpack">‚Äúhot-swapping modules‚Äù</a> like in a <a href="http://webpack.github.io/">webpack</a> , we cannot simply ‚Äúreplace‚Äù a piece of code in runtime.  But perhaps this is even better, we can be even more cunning! <br><br>  <a href="https://github.com/kpdecker/jsdiff">Viva jsdiff</a> !  We feed him the initial and modified versions of the file content and get the output - a real diff, which, with atomic changes (I personally press cmd + s for each) weighs about 1Kb.  And what is even more pleasant - he read!  <a href="https://youtu.be/pZGaye3STsk%3Ft%3D55s">But everything has its time</a> .  Now you need to transfer this diff to the client. <br><br><h2>  Transporting the patch to the client </h2><br>  No magic is foreseen in this section: a normal WebSocket connection with the ability to send the following messages: <br><br>  - If everything went well, diff was successfully calculated and no errors occurred, then we send a message to the client <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"bundle"</span></span>: BundleName &lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>&gt;, <span class="hljs-comment"><span class="hljs-comment">//     bundle- "patch": Patch &lt;String&gt; //     }</span></span></code> </pre><br>  - If everything went wrong, and when calculating diff, a syntax error was detected: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"bundle"</span></span>: BundleName &lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>&gt;, <span class="hljs-comment"><span class="hljs-comment">//    bundle-,    "error": Error &lt;String&gt; //    }</span></span></code> </pre><br>  - When a new client joins the session, all the ‚Äúsources‚Äù are sent to him, which we are watching: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"Connected to browserify-patch-server"</span></span>, <span class="hljs-string"><span class="hljs-string">"sources"</span></span>: sources &lt;<span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&gt;, <span class="hljs-comment"><span class="hljs-comment">//     bundle- }</span></span></code> </pre><br>  View the source <a href="https://github.com/Kureev/browserify-patch-server">here</a> . <br><br><h2>  Processing and applying a patch to an existing code </h2><br>  The main magic happens in this step.  Suppose we got a patch, it is correct and can be applied to the current code.  What's next? <br>  And then we have to make a small lyrical digression and see how browserify wraps files.  To be honest, in order to explain this in simple and understandable language, it is best to translate Ben Klinkenbird's <a href="http://benclinkinbeard.com/posts/how-browserify-works/">excellent article</a> , but instead I‚Äôll probably continue and leave the material to the reader.  The most important thing is the DI in each module's scop: <br><br><div class="spoiler">  <b class="spoiler_title">An example from the article</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-number"><span class="hljs-number">1</span></span>: [<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">require, module, exports</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-string"><span class="hljs-string">'DEP'</span></span>; }, {}], <span class="hljs-number"><span class="hljs-number">2</span></span>: [<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">require, module, exports</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./dep'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-string"><span class="hljs-string">'ENTRY'</span></span>; }, {<span class="hljs-string"><span class="hljs-string">"./dep"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}] }</code> </pre><br></div></div><br>  This is how we access the <code>require</code> function and the <code>module</code> and <code>exports</code> objects.  In our case, the usual <code>require</code> will not be enough: we need to encapsulate the logic of working with the patch (we are not going to write it with our hands in each module)!  The easiest, if not the only way to do this is to overload the <code>require</code> .  This is what I am doing <a href="">in this file</a> : <br><br><div class="spoiler">  <b class="spoiler_title">overrideRequire.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isReloadable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// @todo Replace this sketch by normal one return name.indexOf('react') === -1; } module.exports = function makeOverrideRequire(scope, req) { return function overrideRequire(name) { if (!isReloadable(name)) { if (name === 'react') { return scope.React; } else if (name === 'react-dom') { return scope.ReactDOM; } } else { scope.modules = scope.modules || {}; scope.modules[name] = req(name); return scope.modules[name]; } }; };</span></span></code> </pre><br></div></div><br>  As you probably noticed, in the code I use <code>scope</code> , which above the stack refers to <code>window</code> .  Also, the <code>makeOverrideRequire</code> function uses <code>req</code> , which is nothing but the original <code>require</code> function.  As you can see, all modules are proxied to scope.modules in order to be able to access them at any time (perhaps I will find use for this in the future. If not, I will abolish).  Also, as can be seen from the code above, I check if the <code>react</code> module is om or <code>react-dom</code> .  In this case, I simply return the link to the object from the scopa (if you use different versions of React, this will lead us to errors when working with hot-loader-api, because the service <code>getRootInstances</code> will point to another object). <br><br>  So go ahead - <a href="">work with the socket</a> : <br><br><div class="spoiler">  <b class="spoiler_title">injectWebSocket.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> moment = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'moment'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Logdown = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'logdown'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> diff = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'diff'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> system = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Logdown({ <span class="hljs-attr"><span class="hljs-attr">prefix</span></span>: <span class="hljs-string"><span class="hljs-string">'[BDS:SYSTEM]'</span></span>, }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> error = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Logdown({ <span class="hljs-attr"><span class="hljs-attr">prefix</span></span>: <span class="hljs-string"><span class="hljs-string">'[BDS:ERROR]'</span></span>, }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Logdown({ <span class="hljs-attr"><span class="hljs-attr">prefix</span></span>: <span class="hljs-string"><span class="hljs-string">'[BDS:MSG]'</span></span>, }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> size = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = <span class="hljs-number"><span class="hljs-number">8081</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> patched; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timestamp; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data; <span class="hljs-comment"><span class="hljs-comment">/** * Convert bytes to kb + round it to xx.xx mask * @param {Number} bytes * @return {Number} */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bytesToKb</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bytes</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round((bytes / <span class="hljs-number"><span class="hljs-number">1024</span></span>) * <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">100</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">injectWebSocket</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope, options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (scope.ws) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (options.port) port = options.port; scope.ws = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebSocket(<span class="hljs-string"><span class="hljs-string">'ws://localhost:'</span></span> + port); scope.ws.onmessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">) </span></span>{ timestamp = <span class="hljs-string"><span class="hljs-string">'['</span></span>+ moment().format(<span class="hljs-string"><span class="hljs-string">'HH:mm:ss'</span></span>) + <span class="hljs-string"><span class="hljs-string">']'</span></span>; data = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(res.data); <span class="hljs-comment"><span class="hljs-comment">/** * Check for errors * @param {String} data.error */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.error) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errObj = data.error.match(<span class="hljs-regexp"><span class="hljs-regexp">/console.error\("(.+)"\)/</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">': '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errType = errObj[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errFile = errObj[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errMsg = errObj[<span class="hljs-number"><span class="hljs-number">2</span></span>].match(<span class="hljs-regexp"><span class="hljs-regexp">/(.+) while parsing file/</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>]; error.error(timestamp + <span class="hljs-string"><span class="hljs-string">' Bundle *'</span></span> + data.bundle + <span class="hljs-string"><span class="hljs-string">'* is corrupted:'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n\n '</span></span> + errFile + <span class="hljs-string"><span class="hljs-string">'\n\t '</span></span> + errMsg + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * Setup initial bundles * @param {String} data.sources */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.sources) { scope.bundles = data.sources; scope.bundles.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterateBundles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bundle</span></span></span><span class="hljs-function">) </span></span>{ system.log(timestamp + <span class="hljs-string"><span class="hljs-string">' Initial bundle size: *'</span></span> + bytesToKb(bundle.content.length) + <span class="hljs-string"><span class="hljs-string">'kb*'</span></span>); }); } <span class="hljs-comment"><span class="hljs-comment">/** * Apply patch to initial bundle * @param {Diff} data.patch */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.patch) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.groupCollapsed(timestamp, <span class="hljs-string"><span class="hljs-string">'Patch for'</span></span>, data.bundle); system.log(<span class="hljs-string"><span class="hljs-string">'Received patch for *'</span></span> + data.bundle + <span class="hljs-string"><span class="hljs-string">'* ('</span></span> + bytesToKb(data.patch.length) + <span class="hljs-string"><span class="hljs-string">'kb)'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> source = scope.bundles.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filterBundle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bundle</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bundle.file === data.bundle; })[<span class="hljs-number"><span class="hljs-number">0</span></span>].content; system.log(<span class="hljs-string"><span class="hljs-string">'Patch content:\n\n'</span></span>, data.patch, <span class="hljs-string"><span class="hljs-string">'\n\n'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { patched = diff.applyPatch(source, data.patch); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> error.error(<span class="hljs-string"><span class="hljs-string">'Patch failed. Can\'t apply last patch to source: '</span></span> + e); } <span class="hljs-built_in"><span class="hljs-built_in">Function</span></span>(<span class="hljs-string"><span class="hljs-string">'return '</span></span> + patched)(); scope.bundles.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterateBundles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bundle</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bundle.file === data.bundle) { bundle.content = patched; } }); system.log(<span class="hljs-string"><span class="hljs-string">'Applied patch to *'</span></span> + data.bundle + <span class="hljs-string"><span class="hljs-string">'*'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.groupEnd(); } <span class="hljs-comment"><span class="hljs-comment">/** * Some other info messages * @param {String} data.message */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.message) { message.log(timestamp + <span class="hljs-string"><span class="hljs-string">' '</span></span> + data.message); } }; };</code> </pre><br></div></div><br>  It seems to be nothing special: except the use of <code>diff.applyPatch(source, data.patch)</code> .  As a result of calling this function, we get the patched source, which later in the code is beautifully called through <code>Function</code> . <br><br>  Last but not <a href="">least, injectReactDeps.js</a> : <br><br><div class="spoiler">  <b class="spoiler_title">injectReactDeps.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">injectReactDeps</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ scope.React = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'react'</span></span>); scope.ReactMount = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'react/lib/ReactMount'</span></span>); scope.makeHot = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'react-hot-api'</span></span>)( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRootInstances</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.ReactMount._instancesByReactRootID; } ); };</code> </pre><br></div></div><br>  Under the hood of the entire program, the heart of <code>react-hot-api</code> from <a href="https://twitter.com/dan_abramov">Daniel Abramov aka gaearon beats</a> .  This library replaces the export of our modules (read components) and when they are changed, it ‚Äúpatches‚Äù their prototypes.  It works like a clock, but with a number of limitations: in the ‚Äúpatch‚Äù process, all the variables of the loop that are detached from the react component will be lost.  There are also a number of restrictions on working with the state of the components: you cannot change the initial state of the elements - this requires a reboot. <br><br>  Well, it is impossible not to mention that all this instead of going together <a href="">transform.js</a> files, which implements the browserify transform, which allows you to put your whole idea into life by acting as a link between all the above-mentioned files. <br><br><div class="spoiler">  <b class="spoiler_title">transform.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> through = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'through2'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pjson = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../package.json'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * Resolve path to library file * @param {String} file * @return {String} */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pathTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pjson.name + <span class="hljs-string"><span class="hljs-string">'/src/'</span></span> + file; } <span class="hljs-comment"><span class="hljs-comment">/** * Initialize react live patch * @description Inject React &amp; WS, create namespace * @param {Object} options * @return {String} */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'const options = JSON.parse(\''</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(options) + <span class="hljs-string"><span class="hljs-string">'\');\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'const scope = window.__hmr = (window.__hmr || {});\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'(function() {\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'if (typeof window === \'undefined\') return;\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'if (!scope.initialized) {\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'require("'</span></span> + pathTo(<span class="hljs-string"><span class="hljs-string">'injectReactDeps'</span></span>) + <span class="hljs-string"><span class="hljs-string">'")(scope, options);\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'require("'</span></span> + pathTo(<span class="hljs-string"><span class="hljs-string">'injectWebSocket'</span></span>) + <span class="hljs-string"><span class="hljs-string">'")(scope, options);'</span></span> + <span class="hljs-string"><span class="hljs-string">'scope.initialized = true;\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'}\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'})();\n'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Override require to proxy react/component require * @return {String} */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">overrideRequire</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'require = require("'</span></span> + pathTo(<span class="hljs-string"><span class="hljs-string">'overrideRequire'</span></span>) + <span class="hljs-string"><span class="hljs-string">'")'</span></span> + <span class="hljs-string"><span class="hljs-string">'(scope, require);'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Decorate every component module by `react-hot-api` makeHot method * @return {String} */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">overrideExports</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> + <span class="hljs-string"><span class="hljs-string">';(function() {\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'if (module.exports.name || module.exports.displayName) {\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'module.exports = scope.makeHot(module.exports);\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'}\n'</span></span> + <span class="hljs-string"><span class="hljs-string">'})();\n'</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyReactHotAPI</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file, options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> content = []; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> through( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transform</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">part, enc, next</span></span></span><span class="hljs-function">) </span></span>{ content.push(part); next(); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">finish</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">done</span></span></span><span class="hljs-function">) </span></span>{ content = content.join(<span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bundle = initialize(options) + overrideRequire() + content + overrideExports(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.push(bundle); done(); } ); };</code> </pre><br></div></div><br><br><h2>  Application architecture </h2><br>  The application consists of two parts: <a href="https://github.com/Kureev/browserify-patch-server">server</a> and <a href="https://github.com/Kureev/browserify-react-live">client</a> : <br><br>  - The server acts as an observer for the bundle files and calculates the diff between the changed versions, which immediately notifies all connected clients.  A description of the server messages and its source code <a href="https://github.com/Kureev/browserify-patch-server">can be found here</a> . <br>  Of course, you can create your own live-patch program for any library / framework based on this server. <br><br>  - The client in this case is a program embedded through the transform, which connects to the server using WebSockets and processes its messages (applies the patch and reloads the bundle).  Source code and customer documentation <a href="https://github.com/Kureev/browserify-react-live">can be found here</a> . <br><br><h2>  Give touch </h2><br>  On Unix / OS X, you can use the following commands to scaffold an example: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/Kureev/browserify-react-live.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> browserify-react-live/examples/01\ -\ Basic npm i &amp;&amp; npm start</code> </pre><br>  In Windows, I believe, it is necessary to change the second line (trouble with slashes), I will be glad if someone tests and writes the correct version. <br><br>  After running these 3 commands, you should see something like in the console <br><br><img src="https://habrastorage.org/files/448/4d6/c50/4484d6c50a424d45b76fe33d7852f0ad.png"><br><br>  As soon as the console happily informs you that everything is ready, go to <a href="http://localhost:8080/">http: // localhost: 8080</a> <br><br><img src="https://habrastorage.org/files/86d/f7e/5dd/86df7e5ddbd54bebb1bcd243199ea2a3.png"><br><br>  Now it's up to you: go to browserify-react-live / examples / 01 - Basic / components / MyComponent.js and change the code. <br><br>  For example, having called a button ‚ÄúIncrease‚Äù a couple of times, I decided that +1 is for weaklings and changed in the code <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState({ <span class="hljs-attr"><span class="hljs-attr">counter</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.counter + <span class="hljs-number"><span class="hljs-number">1</span></span> });</code> </pre> <br>  on <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState({ <span class="hljs-attr"><span class="hljs-attr">counter</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.counter + <span class="hljs-number"><span class="hljs-number">2</span></span> });</code> </pre> <br>  After saving, I see in the browser the result of applying the patch: <br><br><img src="https://habrastorage.org/files/ba0/138/24a/ba013824a5724c65bd52f02c37cca4f6.jpg"><br><br>  Done!  Let's try to click ¬´Increase¬ª again - our meter has increased by 2!  Profit! <br><br><h2>  Instead of conclusion </h2><br>  - Honestly, I was hoping to the last that livereactload would work for me and I wouldn‚Äôt have to write my implementation, but after 2 attempts with a difference of several months I didn‚Äôt achieve a good result (the state system was constantly flying). <br>  - Maybe I missed something, or you have suggestions for improvement - do not hesitate to write me about it, together we can make the world a little bit better :) <br>  - Thanks to everyone who helped me with field testing </div><p>Source: <a href="https://habr.com/ru/post/264175/">https://habr.com/ru/post/264175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264165/index.html">Operation Potao: an analysis of malware for cyber espionage, part 2</a></li>
<li><a href="../264167/index.html">Using the Media Capture API in a browser</a></li>
<li><a href="../264169/index.html">‚ÄúDepth-depth, I'm not yours. Let me go, depth. ‚Äù Virtual Reality for Developers</a></li>
<li><a href="../264171/index.html">Creating an Excel file from a select with parameters using pure PL / SQL</a></li>
<li><a href="../264173/index.html">Globals are Cossack swords for data storage. Trees Part 2</a></li>
<li><a href="../264179/index.html">Writing a bot for Tox messenger</a></li>
<li><a href="../264181/index.html">RPC, Messaging, REST: Terminology</a></li>
<li><a href="../264185/index.html">Modern Adaptec RAID controllers from A to Z. Part 2</a></li>
<li><a href="../264189/index.html">Implementation of the wave algorithm for finding the shortest path to dynamically moving objects in unity3d on C # in a 2d game</a></li>
<li><a href="../264191/index.html">Interpolation of data: we connect points so that it was beautiful</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>