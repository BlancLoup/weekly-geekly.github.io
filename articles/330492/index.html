<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why you should not compress your data files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of my hottest issues is data file compression. Despite the fact that I owned the compression code when I worked at Microsoft, I did not have a cha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why you should not compress your data files</h1><div class="post__text post__text-html js-mediator-article">  One of my hottest issues is data file compression.  Despite the fact that I owned the compression code when I worked at Microsoft, I did not have a chance to rewrite it in a way that would make it more pleasant.  I really do not like compression. <br><br>  Please do not confuse transaction log compression with data file compression.  Compressing the journal is necessary if your journal has grown beyond the permissible limits, or when you get rid of excessive fragmentation of virtual journal files (see <a href="http://www.sqlskills.com/blogs/kimberly/8-steps-to-better-transaction-log-throughput/">here</a> (English) and <a href="http://www.sqlskills.com/blogs/kimberly/transaction-log-vlfs-too-many-or-too-few/">here</a> (English) you can find excellent Kimberley articles).  However, transaction log compression should be a rare operation and should never be part of any regular maintenance program that you perform. <br><br>  Compression of data files should be performed even less often, if at all.  And here's why - compressing data files causes <b>severe</b> fragmentation of indexes.  Let me demonstrate this in a simple script that you can execute yourself.  The script below will create a data file, create a ‚Äúfiller‚Äù table with a size of 10 MB at the beginning of the data file, create a ‚Äúproduction‚Äù cluster index with a size of 10 MB, and then analyze the fragmentation of the new cluster index. <br><a name="habracut"></a><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">master</span></span>]; GO IF DATABASEPROPERTYEX (N'DBMaint2008', N'Version') IS NOT NULL <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [DBMaint2008]; GO <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> DBMaint2008; GO <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [DBMaint2008]; GO <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; GO <span class="hljs-comment"><span class="hljs-comment">--  -""  10     CREATE TABLE [FillerTable] ( [c1] INT IDENTITY, [c2] CHAR (8000) DEFAULT 'filler'); GO --  - INSERT INTO [FillerTable] DEFAULT VALUES; GO 1280 --   ,   ""     CREATE TABLE [ProdTable] ( [c1] INT IDENTITY, [c2] CHAR (8000) DEFAULT 'production'); CREATE CLUSTERED INDEX [prod_cl] ON [ProdTable] ([c1]); GO INSERT INTO [ProdTable] DEFAULT VALUES; GO 1280 --     SELECT [avg_fragmentation_in_percent] FROM sys.dm_db_index_physical_stats ( DB_ID (N'DBMaint2008'), OBJECT_ID (N'ProdTable'), 1, NULL, 'LIMITED'); GO</span></span></code> </pre> <br><pre> <code class="1c hljs">avg_fragmentation_in_percent ----------------------------- <span class="hljs-number"><span class="hljs-number">0.390625</span></span></code> </pre> <br>  The logical fragmentation of the cluster index before compression is close to perfect 0.4%. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now I will delete the table-placeholder, start the compression to free up space and check the fragmentation of the cluster index again: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- -,  10        DROP TABLE [FillerTable]; GO --    DBCC SHRINKDATABASE ([DBMaint2008]); GO --     SELECT [avg_fragmentation_in_percent] FROM sys.dm_db_index_physical_stats ( DB_ID (N'DBMaint2008'), OBJECT_ID (N'ProdTable'), 1, NULL, 'LIMITED'); GO</span></span></code> </pre> <br><pre> <code class="1c hljs">DbId FileId CurrentSize MinimumSize UsedPages EstimatedPages ----- ------- ------------ ------------ ---------- --------------- <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1456</span></span> <span class="hljs-number"><span class="hljs-number">152</span></span> <span class="hljs-number"><span class="hljs-number">1448</span></span> <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-number"><span class="hljs-number">56</span></span> <span class="hljs-number"><span class="hljs-number">56</span></span> DBCC execution completed. If DBCC printed error messages, contact your system administrator. avg_fragmentation_in_percent ----------------------------- <span class="hljs-number"><span class="hljs-number">99.296875</span></span></code> </pre><br>  Wow!  After compression, logical fragmentation is almost 100%.  The compression operation <b>completely</b> fragmented the index, depriving any chance of effectively scanning ranges in this index by ensuring that all proactive I / O operations with a range scan would be single-page I / O operations. <br><br>  Why did this happen?  The data file compression operation works with one file at a time, and uses the global distribution map (GAM) (see the article <a href="http://www.sqlskills.com/blogs/paul/inside-the-storage-engine-gam-sgam-pfs-and-other-allocation-maps/">‚ÄúInside the Storage Engine: GAM, SGAM, PFS and other distribution maps‚Äù</a> , English) to find the latest page located in the file.  It then moves this page as close to the beginning of the file as possible, and repeats the operation again and again.  In the situation above, this completely reversed the cluster index order, making it from fully defragmented completely fragmented. <br><br>  The same code is used in the DBCC SHRINKFILE, DBCC SHRINKDATABASE, and autocompress commands ‚Äî they are equally bad.  And along with the fragmentation of the index, data file compression generates a large number of I / O operations, actively uses CPU time and generates a <b>large</b> number of entries in the transaction log ‚Äî since everything it does is completely logged. <br><br>  Compressing data files should never be part of regular maintenance, and you NEVER, NEVER should turn on auto-compression.  I tried to get it removed from SQL Server 2005 and SQL Server 2008 when I was in a position to achieve this ‚Äî the only reason why it is still there is to ensure backward compatibility.  Do not fall into the trap of creating a maintenance plan that rebuilds all indexes and then tries to free up the space occupied when rebuilding indexes by running compression - this is a zero-sum game, where everything you do is generate transaction log entries with zero real benefit for performance. <br><br>  So when might <b>you need to</b> run compression?  For example, if you delete most of a very large database and the database is unlikely to grow, or if you need to clean the file before deleting it? <br><br>  I recommend the following method: <br><br><ul><li>  Create a new file group </li><li>  Move all involved tables and indexes to a new filegroup using the syntax CREATE INDEX ... WITH (DROP_EXISTING = ON) ON to move tables and remove fragmentation from them at the same time. </li><li>  Delete the old filegroup that you were going to compress anyway (or compress it to the maximum if this is the primary filegroup) </li></ul><br>  In fact, you need to provide additional free space before you can compress old files, but this is a much cleaner mechanism. <br><br>  If you have absolutely no choice and you have to start the file compression operation, be prepared for the fact that you will cause the fragmentation of the indexes and you must take actions to remove it later if it causes performance problems.  The only way to remove index fragmentation without growing a data file is to use DBCC INDEXDEFRAG or ALTER INDEX ... REORGANIZE.  These commands require an additional one page of 8Kb in size, instead of the need to build a completely new index in case of a rebuild operation. <br><br>  Bottom line - try to avoid running file compression at all costs! </div><p>Source: <a href="https://habr.com/ru/post/330492/">https://habr.com/ru/post/330492/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330474/index.html">All you need to know about Windows Server 2016</a></li>
<li><a href="../330480/index.html">Extending, modifying, and creating controls on the UWP platform. Part 1</a></li>
<li><a href="../330484/index.html">The Future of MDN - Focus on Web Docs</a></li>
<li><a href="../330486/index.html">As the "Pilot" upgraded the fiscal registrar in Fujitsu CCT</a></li>
<li><a href="../330488/index.html">Firebase at I / O 2017: New Features</a></li>
<li><a href="../330498/index.html">Yii 1.1.19</a></li>
<li><a href="../330500/index.html">Brocade Ethernet Switches</a></li>
<li><a href="../330502/index.html">awless.io, mighty CLI for AWS</a></li>
<li><a href="../330504/index.html">How I participated in the Angular Attack hackathon, and what came of it</a></li>
<li><a href="../330506/index.html">TSic digital temperature sensor: addresses, passwords, turnout</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>