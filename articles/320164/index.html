<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Caution: HSTS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About HSTS on Habr√© already wrote , this mechanism is included in the generator of configs for web servers from Mozilla. I decided to write this post ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Caution: HSTS</h1><div class="post__text post__text-html js-mediator-article">  About HSTS on Habr√© already <a href="https://habrahabr.ru/search/%3Fq%3D%255BHSTS%255D%26target_type%3Dposts">wrote</a> , this mechanism is included in the <a href="https://wiki.mozilla.org/Security/Server_Side_TLS">generator of configs</a> for web servers from Mozilla.  I decided to write this post in one day when I faced the inaccessibility of two large sites at once due to HSTS. <br><br><div class="spoiler">  <b class="spoiler_title">TL; DR</b> <div class="spoiler_text">  Check the site for TLS carefully before enabling HSTS, especially if it is a large portal with a bunch of subdomains and managed by different people. </div></div><br><h2>  What is HSTS? </h2><br>  HSTS (HTTP Strict Transport Security) is a protection mechanism against downgrade attacks on TLS, which instructs the browser to always use TLS for sites with appropriate policies.  The standard is described in <a href="https://tools.ietf.org/html/rfc6797">RFC6797</a> , and there are two types of policies: <br><br><h4>  Dynamic </h4><br>  The policy is applied from the Strict-Transport-Security HTTP header when you first access the site via HTTPS, it specifies the expiration date and applicability to subdomains: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Strict</span></span>-Transport-<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>: max-age=<span class="hljs-number"><span class="hljs-number">15768000</span></span>; includeSubDomains;</code> </pre> <br><h4>  Static </h4><br>  Static policies are hard-coded to the browser and for some sites include binding to a higher-level CA that issued a certificate (for example, google.com, paypal.com, or torproject.org).  Moreover, it can act <a href="http://security.stackexchange.com/a/140193">only</a> when the site is opened via TLS, allowing an unprotected connection, but blocking MitM with a certificate substitution. <br><br>  <a href="https://cs.chromium.org/chromium/src/net/">The list</a> from Chromium is used by all popular browsers (Firefox, Safari and IE 11 + Edge) and <a href="https://hstspreload.org/">anyone</a> can add a website <a href="https://hstspreload.org/">to</a> it if the web server gives a Strict-Transport-Security header with a validity of two years and the <b>preload keyword</b> at the end: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Strict</span></span>-Transport-<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>: max-age=<span class="hljs-number"><span class="hljs-number">63072000</span></span>; includeSubDomains; preload</code> </pre> <a name="habracut"></a><br><h2>  How to shoot yourself in the leg? </h2><br>  Recently, colleagues complained about the inaccessibility of some sections of the site 1C (dist.1c.ru and partweb.1c.ru).  Support assured that everything works, my problem did not reproduce, and even colleagues opened sites from all browsers except the main Chrome.  He issued ERR_CONNECTION_TIMED_OUT 20 seconds later and for some reason persistently substituted HTTPS in the URL, even if the address was written entirely with HTTP. <br><br>  The decision came almost immediately, as they recently <a href="https://habrahabr.ru/company/cbs/blog/318592/">mentioned</a> HSTS in the context of corporate MitM.  Google by keyword with the first link prompted what to see the cache policy in <b>chrome: // net-internals / # hsts</b> and the guess was confirmed: <br><br><div class="spoiler">  <b class="spoiler_title">dynamic_sts_domain: 1c.ru</b> <div class="spoiler_text">  <b>Found</b> : <br>  static_sts_domain: <br>  static_upgrade_mode: UNKNOWN <br>  static_sts_include_subdomains: <br>  static_sts_observed: <br>  static_pkp_domain: <br>  static_pkp_include_subdomains: <br>  static_pkp_observed: <br>  static_spki_hashes: <br>  dynamic_sts_domain: 1c.ru <br>  <b>dynamic_upgrade_mode: STRICT</b> <b><br></b>  <b>dynamic_sts_include_subdomains: true</b> <br>  dynamic_sts_observed: 1485244696.197302 <br>  dynamic_pkp_domain: <br>  dynamic_pkp_include_subdomains: <br>  dynamic_pkp_observed: <br>  dynamic_spki_hashes: <br></div></div><br>  The policy included all subdomains, although many of them were available only on port 80 without TLS. <br>  After deleting it, the necessary sections began to open, according to the date of receipt (in the unix time format) in the browser history they found a page with incorrect settings and sent a bug report in 1C. <br><br>  The second site was ask.mcdonalds.ru, which opened for the first time, but Chrome still showed a warning with the familiar four-letter abbreviation and without the familiar Proceed to (unsafe) button: <br><br><div class="spoiler">  <b class="spoiler_title">ER_CERT_COMMON</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/946/4fc/872/9464fc8722444622a8ff6164c2e1eb2e.png"><br></div></div><br>  The error indicates that the certificate name is inconsistent, expires or is revoked, and the display of the button to open the site is <a href="http://security.stackexchange.com/a/111463">expressly prohibited</a> in the RFC.  At the same time, the policy for mcdonalds.ru turned out to be static, which cannot be removed from chrome: // net-internals / # hsts. <br><br>  You can bypass such a stub in Chrome by typing <b><i>thisisunsafe</i></b> (the previous magic word was <b><i>badidea</i></b> , and before it is <b><i>danger</i></b> ) or by launching a browser with the key <b>--ignore-certificate-errors</b> . <br><br>  In Firefox, click ‚ÄúForge About This Site‚Äù opposite the site in history, open about: config and create a new Integer with the name ‚Äútest.currentTimeOffsetSeconds‚Äù and value 11491200, and then open the site in a new tab. <br><br><h2>  findings </h2><br>  Do not include potentially dangerous functions without understanding the principles of their work.  You will get the ‚ÄúA‚Äù <a href="https://www.ssllabs.com/ssltest/">rating</a> in the <a href="https://www.ssllabs.com/ssltest/">test</a> from SSL Labs without HSTS, and you can enable it after checking all the functionality via TLS.  There will be no way back with a static sheet in the browser, therefore it is better to immediately purchase a certificate with a wildcard. <br><br><h4>  PS </h4><br>  Chrome and Firefox support an additional protection mechanism: <b>HTTP Public Key Pinning (HPKP)</b> , <a href="https://developers.google.com/web/updates/2015/09/HPKP-reporting-with-chrome-46">which allows you to</a> bind the certificate hash and send notification to the owner if the browser receives a certificate from a public CA for its domain with a different hash.  He helped uncover <a href="https://git.cryto.net/joepie91/ca-incidents">several incidents</a> with public CAs, but in practice it is used <a href="http-public-key-pinning-dead">very rarely</a> because of the high cost of the error. <br><br><h4><anchor>  Pps </anchor></h4><br>  The composition of <a href="https://chromium.googlesource.com/chromium/src/+/lkgr/net/">hard-core</a> policies in Chromium is interesting: in addition to the fast-food network, several Mail.ru and Yandex domains, there is only UniCredit from the <a href="http://www.banki.ru/banks/ratings/">TOP-15</a> Russian banks.  There is no trendy TKS, neither Qiwi, nor WebMoney, and dynamic policies have been enabled only by Qiwi and for the addresses of Internet banks Binbank, IBC, Otkrytie, Raiffeisen and RSHB. <br><br>  There is also no Telegram, but there is Whatsapp, and in the change <a href="https://chromium.googlesource.com/chromium/src/+log/lkgr/net/">log</a> there are requests to delete (!) Mistakenly included sites, where for some time there was a preload in the header. </div><p>Source: <a href="https://habr.com/ru/post/320164/">https://habr.com/ru/post/320164/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320150/index.html">We break Android. How deep is the rabbit hole?</a></li>
<li><a href="../320152/index.html">Multithreading (concurrency) in Swift 3. GCD and Dispatch Queues</a></li>
<li><a href="../320156/index.html">Logging VPN Connections on the Cisco ASA</a></li>
<li><a href="../320158/index.html">Areas of flexibility</a></li>
<li><a href="../320160/index.html">Vulnerable Highways and Energy Infrastructure: Recent Major Failures</a></li>
<li><a href="../320166/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ246 (January 16 - 22, 2017)</a></li>
<li><a href="../320168/index.html">Depth: how to make a quality project without millions in your pocket and why you shouldn‚Äôt be afraid of ‚Äúlong-term construction projects‚Äù</a></li>
<li><a href="../320172/index.html">JSON API My Warehouse, self-learning</a></li>
<li><a href="../320174/index.html">Local python typographer - typus Œ≤</a></li>
<li><a href="../320176/index.html">Bitcoin in a nutshell - Blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>